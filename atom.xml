<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>LuckyBoyğŸ¥</title>
  
  
  <link href="https://luckylittleboy.gitee.io/atom.xml" rel="self"/>
  
  <link href="https://luckylittleboy.gitee.io/"/>
  <updated>2023-04-04T12:46:07.943Z</updated>
  <id>https://luckylittleboy.gitee.io/</id>
  
  <author>
    <name>LuckyBoyğŸ¥</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>7.å…±äº«æ¨¡å‹ä¹‹å·¥å…·</title>
    <link href="https://luckylittleboy.gitee.io/posts/9c5b9bb4.html"/>
    <id>https://luckylittleboy.gitee.io/posts/9c5b9bb4.html</id>
    <published>2023-04-03T01:39:40.000Z</published>
    <updated>2023-04-04T12:46:07.943Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-è‡ªå®šä¹‰çº¿ç¨‹æ± ">1. è‡ªå®šä¹‰çº¿ç¨‹æ± </h2><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220311170716250.png" alt="image-20220311170716250"></p><div class="tabs" id="fec406e4-a43c-4c0d-b1cd-8434dbb940a8"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#fec406e4-a43c-4c0d-b1cd-8434dbb940a8-1"><i class="fas fa-seedling"></i>æ­¥éª¤1</button></li><li class="tab"><button type="button" data-href="#fec406e4-a43c-4c0d-b1cd-8434dbb940a8-2"><i class="fas fa-leaf"></i>æ­¥éª¤2</button></li><li class="tab"><button type="button" data-href="#fec406e4-a43c-4c0d-b1cd-8434dbb940a8-3"><i class="fab fa-apple"></i>æ­¥éª¤3</button></li><li class="tab"><button type="button" data-href="#fec406e4-a43c-4c0d-b1cd-8434dbb940a8-4"><i class="fas fa-tree"></i>æ­¥éª¤4</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="fec406e4-a43c-4c0d-b1cd-8434dbb940a8-1"><p>è‡ªå®šä¹‰æ‹’ç»ç­–ç•¥æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span> <span class="comment">//æ‹’ç»ç­–ç•¥</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">RejectPolicy</span>&lt;T&gt;&#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">reject</span><span class="params">(BlockingQueue&lt;T&gt; queue,T task)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="fec406e4-a43c-4c0d-b1cd-8434dbb940a8-2"><p>è‡ªå®šä¹‰ä»»åŠ¡é˜Ÿåˆ—</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BlockingQueue</span>&lt;T&gt;&#123;</span><br><span class="line">    <span class="comment">//é˜»å¡é˜Ÿåˆ—ï¼Œå­˜æ”¾ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">private</span> Deque&lt;T&gt; queue = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//é˜Ÿåˆ—çš„æœ€å¤§å®¹é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> capacity;</span><br><span class="line">    <span class="comment">//é”</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="comment">//ç”Ÿäº§è€…æ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">fullWaitSet</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="comment">//æ¶ˆè´¹è€…æ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">emptyWaitSet</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="comment">//æ„é€ æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BlockingQueue</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¶…æ—¶é˜»å¡è·å–</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">poll</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="comment">//å°†æ—¶é—´è½¬æ¢ä¸ºçº³ç§’</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">nanoTime</span> <span class="operator">=</span> unit.toNanos(timeout);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(queue.size() == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//ç­‰å¾…è¶…æ—¶ä¾æ—§æ²¡æœ‰è·å–ï¼Œè¿”å›null</span></span><br><span class="line">                    <span class="keyword">if</span>(nanoTime &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//è¯¥æ–¹æ³•è¿”å›çš„æ˜¯å‰©ä½™æ—¶é—´</span></span><br><span class="line">                    nanoTime = emptyWaitSet.awaitNanos(nanoTime);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> queue.pollFirst();</span><br><span class="line">            fullWaitSet.signal();</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//é˜»å¡è·å–</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">take</span><span class="params">()</span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(queue.size() == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    emptyWaitSet.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> queue.pollFirst();</span><br><span class="line">            fullWaitSet.signal();</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//é˜»å¡æ·»åŠ </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(T t)</span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (queue.size() == capacity)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().toString() + <span class="string">&quot;ç­‰å¾…åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—:&quot;</span> + t.toString());</span><br><span class="line">                    fullWaitSet.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().toString() + <span class="string">&quot;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—:&quot;</span> + t.toString());</span><br><span class="line">            queue.addLast(t);</span><br><span class="line">            emptyWaitSet.signal();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¶…æ—¶é˜»å¡æ·»åŠ </span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(T t,<span class="type">long</span> timeout,TimeUnit timeUnit)</span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">nanoTime</span> <span class="operator">=</span> timeUnit.toNanos(timeout);</span><br><span class="line">            <span class="keyword">while</span> (queue.size() == capacity)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span>(nanoTime &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;ç­‰å¾…è¶…æ—¶ï¼ŒåŠ å…¥å¤±è´¥ï¼š&quot;</span> + t);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(Thread.currentThread().toString() + <span class="string">&quot;ç­‰å¾…åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—:&quot;</span> + t.toString());</span><br><span class="line">                    nanoTime = fullWaitSet.awaitNanos(nanoTime);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().toString() + <span class="string">&quot;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—:&quot;</span> + t.toString());</span><br><span class="line">            queue.addLast(t);</span><br><span class="line">            emptyWaitSet.signal();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> queue.size();</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä»å½¢å‚æ¥æ”¶æ‹’ç»ç­–ç•¥çš„putæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tryPut</span><span class="params">(RejectPolicy&lt;T&gt; rejectPolicy,T task)</span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(queue.size() == capacity)&#123;</span><br><span class="line">                rejectPolicy.reject(<span class="built_in">this</span>,task);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼š&quot;</span> + task);</span><br><span class="line">                queue.addLast(task);</span><br><span class="line">                emptyWaitSet.signal();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="fec406e4-a43c-4c0d-b1cd-8434dbb940a8-3"><p>è‡ªå®šä¹‰çº¿ç¨‹æ± </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadPool</span>&#123;</span><br><span class="line">    <span class="comment">//é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    BlockingQueue&lt;Runnable&gt; taskQue;</span><br><span class="line">    <span class="comment">//çº¿ç¨‹é›†åˆ</span></span><br><span class="line">    HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//æ‹’ç»ç­–ç•¥</span></span><br><span class="line">    <span class="keyword">private</span> RejectPolicy&lt;Runnable&gt; rejectPolicy;</span><br><span class="line">    <span class="comment">//æ„é€ æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ThreadPool</span><span class="params">(<span class="type">int</span> coreSize,<span class="type">long</span> timeout,TimeUnit timeUnit,<span class="type">int</span> queueCapacity,RejectPolicy&lt;Runnable&gt; rejectPolicy)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.coreSize = coreSize;</span><br><span class="line">        <span class="built_in">this</span>.timeout = timeout;</span><br><span class="line">        <span class="built_in">this</span>.timeUnit = timeUnit;</span><br><span class="line">        <span class="built_in">this</span>.rejectPolicy = rejectPolicy;</span><br><span class="line">        taskQue = <span class="keyword">new</span> <span class="title class_">BlockingQueue</span>&lt;Runnable&gt;(queueCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//çº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> coreSize;</span><br><span class="line">    <span class="comment">//ä»»åŠ¡è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> timeout;</span><br><span class="line">    <span class="comment">//æ—¶é—´å•å…ƒ</span></span><br><span class="line">    <span class="keyword">private</span> TimeUnit timeUnit;</span><br><span class="line">    <span class="comment">//çº¿ç¨‹æ± çš„æ‰§è¡Œæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable task)</span>&#123;</span><br><span class="line">        <span class="comment">//å½“çº¿ç¨‹æ•°å¤§äºç­‰äºcoreSizeçš„æ—¶å€™ï¼Œå°†ä»»åŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">//å½“çº¿ç¨‹æ•°å°äºcoreSizeçš„æ—¶å€™ï¼Œæ–°å»ºä¸€ä¸ªWorkeræ”¾å…¥workers</span></span><br><span class="line">        <span class="comment">//æ³¨æ„workersç±»ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œ éœ€è¦åŠ é”</span></span><br><span class="line">        <span class="keyword">synchronized</span> (workers)&#123;</span><br><span class="line">            <span class="keyword">if</span>(workers.size() &gt;= coreSize)&#123;</span><br><span class="line"><span class="comment">//                taskQue.put(task);</span></span><br><span class="line">                <span class="comment">//æ­»ç­‰</span></span><br><span class="line">                <span class="comment">//å¸¦è¶…æ—¶ç­‰å¾…</span></span><br><span class="line">                <span class="comment">//è®©è°ƒç”¨è€…æ”¾å¼ƒæ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">                <span class="comment">//è®©è°ƒç”¨è€…æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">                <span class="comment">//è®©è°ƒç”¨è€…è‡ªå·±æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">                taskQue.tryPut(rejectPolicy,task);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">Worker</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Worker</span>(task);</span><br><span class="line">                System.out.println(Thread.currentThread().toString() + <span class="string">&quot;æ–°å¢worker:&quot;</span> + worker + <span class="string">&quot;,task:&quot;</span> + task);</span><br><span class="line">                workers.add(worker);</span><br><span class="line">                worker.start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å·¥ä½œç±»</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Runnable task;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Worker</span><span class="params">(Runnable task)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.task = task;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">//å·§å¦™çš„åˆ¤æ–­</span></span><br><span class="line">            <span class="keyword">while</span>(task != <span class="literal">null</span> || (task = taskQue.poll(timeout,timeUnit)) != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().toString() + <span class="string">&quot;æ­£åœ¨æ‰§è¡Œ:&quot;</span> + task);</span><br><span class="line">                    task.run();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">                &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                    task = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">synchronized</span> (workers)&#123;</span><br><span class="line">                System.out.println(Thread.currentThread().toString() + <span class="string">&quot;workerè¢«ç§»é™¤:&quot;</span> + <span class="built_in">this</span>.toString());</span><br><span class="line">                workers.remove(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="fec406e4-a43c-4c0d-b1cd-8434dbb940a8-4"><p>ç¼–å†™æµ‹è¯•ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestPool</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ThreadPool</span> <span class="variable">threadPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPool</span>(<span class="number">1</span>,</span><br><span class="line">                <span class="number">1000</span>, TimeUnit.MILLISECONDS, <span class="number">1</span>, (queue, task)-&gt;&#123;</span><br><span class="line">            <span class="comment">// 1. æ­»ç­‰</span></span><br><span class="line"><span class="comment">//            queue.put(task);</span></span><br><span class="line">            <span class="comment">// 2) å¸¦è¶…æ—¶ç­‰å¾…</span></span><br><span class="line"><span class="comment">//            queue.offer(task, 1500, TimeUnit.MILLISECONDS);</span></span><br><span class="line">            <span class="comment">// 3) è®©è°ƒç”¨è€…æ”¾å¼ƒä»»åŠ¡æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">//            log.debug(&quot;æ”¾å¼ƒ&#123;&#125;&quot;, task);</span></span><br><span class="line">            <span class="comment">// 4) è®©è°ƒç”¨è€…æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="comment">//            throw new RuntimeException(&quot;ä»»åŠ¡æ‰§è¡Œå¤±è´¥ &quot; + task);</span></span><br><span class="line">            <span class="comment">// 5) è®©è°ƒç”¨è€…è‡ªå·±æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">            task.run();</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i;</span><br><span class="line">            threadPool.execute(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, j);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-ThreadPoolExecutor">2. ThreadPoolExecutor</h2><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220311171237519.png" alt="image-20220311171237519"></p><p>è¯´æ˜ï¼š</p><ul><li>ScheduledThreadPoolExecutoræ˜¯å¸¦è°ƒåº¦çš„çº¿ç¨‹æ± </li><li>ThreadPoolExecutoræ˜¯ä¸å¸¦è°ƒåº¦çš„çº¿ç¨‹æ± </li></ul><h3 id="2-1-çº¿ç¨‹æ± çŠ¶æ€">2.1 çº¿ç¨‹æ± çŠ¶æ€</h3><p>ThreadPoolExecutor ä½¿ç”¨ int çš„é«˜ 3 ä½æ¥è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼Œä½ 29 ä½è¡¨ç¤ºçº¿ç¨‹æ•°é‡</p><p><code>private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));</code></p><table><thead><tr><th style="text-align:center">çŠ¶æ€å</th><th style="text-align:center">é«˜3ä½</th><th style="text-align:center">æ¥æ”¶æ–°ä»»åŠ¡</th><th style="text-align:center">å¤„ç†é˜»å¡é˜Ÿåˆ—ä»»åŠ¡</th><th style="text-align:center">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center">RUNNING</td><td style="text-align:center">111</td><td style="text-align:center">Y</td><td style="text-align:center">Y</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">SHUTDOWN</td><td style="text-align:center">000</td><td style="text-align:center">N</td><td style="text-align:center">Y</td><td style="text-align:center">ä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†ä¼šå¤„ç†é˜»å¡é˜Ÿåˆ—å‰©ä½™ ä»»åŠ¡</td></tr><tr><td style="text-align:center">STOP</td><td style="text-align:center">001</td><td style="text-align:center">N</td><td style="text-align:center">N</td><td style="text-align:center">ä¼šä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶æŠ›å¼ƒé˜»å¡é˜Ÿåˆ— ä»»åŠ¡</td></tr><tr><td style="text-align:center">TIDYING</td><td style="text-align:center">010</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">ä»»åŠ¡å…¨æ‰§è¡Œå®Œæ¯•ï¼Œæ´»åŠ¨çº¿ç¨‹ä¸º 0 å³å°†è¿›å…¥ ç»ˆç»“</td></tr><tr><td style="text-align:center">TERMINATED</td><td style="text-align:center">011</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">ç»ˆç»“çŠ¶æ€</td></tr></tbody></table><p>ä»æ•°å­—ä¸Šæ¯”è¾ƒï¼ŒTERMINATED &gt; TIDYING &gt; STOP &gt; SHUTDOWN &gt; RUNNING</p><p>è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªåŸå­å˜é‡ ctl ä¸­ï¼Œç›®çš„æ˜¯å°†çº¿ç¨‹æ± çŠ¶æ€ä¸çº¿ç¨‹ä¸ªæ•°åˆäºŒä¸ºä¸€ï¼Œè¿™æ ·å°±å¯ä»¥ç”¨ä¸€æ¬¡ cas åŸå­æ“ä½œ è¿›è¡Œèµ‹å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Packing and unpacking ctl</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">runStateOf</span><span class="params">(<span class="type">int</span> c)</span>     &#123; <span class="keyword">return</span> c &amp; ~CAPACITY; &#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">workerCountOf</span><span class="params">(<span class="type">int</span> c)</span>  &#123; <span class="keyword">return</span> c &amp; CAPACITY; &#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">ctlOf</span><span class="params">(<span class="type">int</span> rs, <span class="type">int</span> wc)</span> &#123; <span class="keyword">return</span> rs | wc; &#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-å·¥ä½œæ–¹å¼">2.2 å·¥ä½œæ–¹å¼</h3><p>åœ¨JDKä¸­çš„çº¿ç¨‹æ± ä¸­ï¼Œçº¿ç¨‹åˆ†ä¸ºä¸¤ç§ã€‚ä¸€ç§å«åšæ ¸å¿ƒçº¿ç¨‹ï¼Œä¸€ç§å«åšæ•‘æ€¥çº¿ç¨‹ã€‚ä¸€å¼€å§‹éƒ½æ˜¯æ²¡æœ‰åˆ›å»ºçš„ï¼Œéƒ½ä¸ºæ‡’æƒ°åˆ›å»ºã€‚</p><p>æ ¸å¿ƒçº¿ç¨‹æ•°+æ•‘æ€¥çº¿ç¨‹æ•°=æœ€å¤§çº¿ç¨‹æ•°</p><div class="tabs" id="6532fcb2-28ca-4ddf-bdb2-e36bd19febe0"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-1"><i class="fas fa-atom"></i>åˆå§‹çŠ¶æ€</button></li><li class="tab"><button type="button" data-href="#6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-2"><i class="far fa-sun"></i>2</button></li><li class="tab"><button type="button" data-href="#6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-3"><i class="fas fa-wind"></i>3</button></li><li class="tab"><button type="button" data-href="#6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-4"><i class="fas fa-fire-alt"></i>4</button></li><li class="tab"><button type="button" data-href="#6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-5"><i class="fas fa-horse"></i>5</button></li><li class="tab"><button type="button" data-href="#6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-6"><i class="fas fa-cat"></i>6</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-1"><p>åˆå§‹çŠ¶æ€ è™šçº¿ è¡¨ç¤ºè¿˜æœªåˆ›å»º</p><p>cï¼šcorePoolSize  æ ¸å¿ƒçº¿ç¨‹æ•°ç›® 2   mï¼šmaximumPoolSiz æœ€å¤§çº¿ç¨‹çº¿ç¨‹æ•°ç›® 3</p><p>çº¿ç¨‹æ± ä¸­åˆšå¼€å§‹æ²¡æœ‰çº¿ç¨‹ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230403133115379.png" alt="image-20230403133115379" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-2"><p>å®çº¿è¡¨ç¤ºå·²åˆ›å»ºçº¿ç¨‹</p><p>å½“ä¸€ä¸ªä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± åï¼Œçº¿ç¨‹æ± ä¼šåˆ›å»ºä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230403120601163.png" alt="image-20230403120601163" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-3"><p>å‡è®¾é˜»å¡é˜Ÿåˆ—é•¿åº¦ä¸º2ã€‚</p><p>å½“çº¿ç¨‹æ•°è¾¾åˆ° corePoolSize å¹¶æ²¡æœ‰çº¿ç¨‹ç©ºé—²ï¼Œè¿™æ—¶å†åŠ å…¥ä»»åŠ¡ï¼Œæ–°åŠ çš„ä»»åŠ¡ä¼šè¢«åŠ å…¥workQueue é˜Ÿåˆ—æ’é˜Ÿï¼Œç›´åˆ°æœ‰ç©ºé—²çš„çº¿ç¨‹ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230403120618728.png" alt="image-20230403120618728" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-4"><p>å¦‚æœé˜Ÿåˆ—é€‰æ‹©äº†æœ‰ç•Œé˜Ÿåˆ—ï¼Œé‚£ä¹ˆä»»åŠ¡è¶…è¿‡äº†é˜Ÿåˆ—å¤§å°æ—¶ï¼Œä¼šåˆ›å»º maximumPoolSize - corePoolSize æ•°ç›®çš„çº¿ç¨‹æ¥æ•‘æ€¥ã€‚</p><p>å¦‚æœçº¿ç¨‹åˆ°è¾¾ maximumPoolSize ä»ç„¶æœ‰æ–°ä»»åŠ¡è¿™æ—¶ä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚æ‹’ç»ç­–ç•¥ jdk æä¾›äº† 4 ç§å®ç°ï¼Œå…¶å®ƒè‘—åæ¡†æ¶ä¹Ÿæä¾›äº†å®ç°</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230403134809613.png" alt="image-20230403134809613"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-5"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220311174119508.png" alt="image-20220311174119508"></p><ul><li>AbortPolicy è®©è°ƒç”¨è€…æŠ›å‡º RejectedExecutionException å¼‚å¸¸ï¼Œè¿™æ˜¯é»˜è®¤ç­–ç•¥</li><li>CallerRunsPolicy è®©è°ƒç”¨è€…è¿è¡Œä»»åŠ¡</li><li>DiscardPolicy æ”¾å¼ƒæœ¬æ¬¡ä»»åŠ¡</li><li>DiscardOldestPolicy æ”¾å¼ƒé˜Ÿåˆ—ä¸­æœ€æ—©çš„ä»»åŠ¡ï¼Œæœ¬ä»»åŠ¡å–è€Œä»£ä¹‹</li><li>Dubbo çš„å®ç°ï¼Œåœ¨æŠ›å‡º RejectedExecutionException å¼‚å¸¸ä¹‹å‰ä¼šè®°å½•æ—¥å¿—ï¼Œå¹¶ dump çº¿ç¨‹æ ˆä¿¡æ¯ï¼Œæ–¹ä¾¿å®šä½é—®é¢˜</li><li>Netty çš„å®ç°ï¼Œæ˜¯åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡</li><li>ActiveMQ çš„å®ç°ï¼Œå¸¦è¶…æ—¶ç­‰å¾…ï¼ˆ60sï¼‰å°è¯•æ”¾å…¥é˜Ÿåˆ—ï¼Œç±»ä¼¼æˆ‘ä»¬ä¹‹å‰è‡ªå®šä¹‰çš„æ‹’ç»ç­–ç•¥</li><li>PinPoint çš„å®ç°ï¼Œå®ƒä½¿ç”¨äº†ä¸€ä¸ªæ‹’ç»ç­–ç•¥é“¾ï¼Œä¼šé€ä¸€å°è¯•ç­–ç•¥é“¾ä¸­æ¯ç§æ‹’ç»ç­–ç•¥</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-6"><p>å½“é«˜å³°è¿‡å»åï¼Œè¶…è¿‡corePoolSize çš„æ•‘æ€¥çº¿ç¨‹å¦‚æœä¸€æ®µæ—¶é—´æ²¡æœ‰ä»»åŠ¡åšï¼Œéœ€è¦ç»“æŸèŠ‚çœèµ„æºï¼Œè¿™ä¸ªæ—¶é—´ç”± keepAliveTime å’Œ unit æ¥æ§åˆ¶ï¼Œä¸‹æ¬¡é«˜å³°æœŸæ¥äº†æ‰ä¼šè¢«å†æ¬¡åˆ›å»ºã€‚</p><p>è€Œæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡åï¼Œä¼šè¢«ä¿ç•™åœ¨çº¿ç¨‹æ± ä¸­ï¼Œä¸ä¼šè¢«é”€æ¯ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230403135635202.png" alt="image-20230403135635202" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <h3 id="2-3-æ„é€ æ–¹æ³•">2.3 æ„é€ æ–¹æ³•</h3><p>å‚æ•°åˆ—è¡¨</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>corePoolSize</td><td>æ ¸å¿ƒçº¿ç¨‹æ•°ç›®</td></tr><tr><td>maximumPoolSize</td><td>æœ€å¤§çº¿ç¨‹æ•°ç›®</td></tr><tr><td>keepAliveTime</td><td>ç”Ÿå­˜æ—¶é—´ - é’ˆå¯¹æ•‘æ€¥çº¿ç¨‹</td></tr><tr><td>unit</td><td>æ—¶é—´å•ä½ - é’ˆå¯¹æ•‘æ€¥çº¿ç¨‹</td></tr><tr><td>workQueue</td><td>é˜»å¡é˜Ÿåˆ—</td></tr><tr><td>threadFactory</td><td>çº¿ç¨‹å·¥å‚ - å¯ä»¥ä¸ºçº¿ç¨‹åˆ›å»ºæ—¶èµ·ä¸ªå¥½åå­—</td></tr><tr><td>handler</td><td>æ‹’ç»ç­–ç•¥</td></tr></tbody></table><div class="tabs" id="c7c54ee0-9eda-42fe-9d85-de5641ea0eda"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c7c54ee0-9eda-42fe-9d85-de5641ea0eda-1"><i class="fas fa-cat"></i>newFixedThreadPool</button></li><li class="tab"><button type="button" data-href="#c7c54ee0-9eda-42fe-9d85-de5641ea0eda-2"><i class="fas fa-horse"></i>newCachedThreadPool</button></li><li class="tab"><button type="button" data-href="#c7c54ee0-9eda-42fe-9d85-de5641ea0eda-3"><i class="fas fa-dove"></i>newSingleThreadExecutor</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c7c54ee0-9eda-42fe-9d85-de5641ea0eda-1"><p>å›ºå®šå¤§å°çº¿ç¨‹æ± </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads, nThreads, <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç‰¹ç‚¹</p><ul><li>æ ¸å¿ƒçº¿ç¨‹æ•° == æœ€å¤§çº¿ç¨‹æ•°ï¼ˆæ²¡æœ‰æ•‘æ€¥çº¿ç¨‹è¢«åˆ›å»ºï¼‰ï¼Œå› æ­¤ä¹Ÿæ— éœ€è¶…æ—¶æ—¶é—´</li><li>é˜»å¡é˜Ÿåˆ—æ˜¯æ— ç•Œçš„ï¼Œå¯ä»¥æ”¾ä»»æ„æ•°é‡çš„ä»»åŠ¡</li></ul><blockquote><p>è¯„ä»· é€‚ç”¨äºä»»åŠ¡é‡å·²çŸ¥ï¼Œç›¸å¯¹è€—æ—¶çš„ä»»åŠ¡</p></blockquote><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c7c54ee0-9eda-42fe-9d85-de5641ea0eda-2"><p>å¸¦ç¼“å†²çº¿ç¨‹æ± </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newCachedThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">0</span>, Integer.MAX_VALUE, <span class="number">60L</span>, </span><br><span class="line">            TimeUnit.SECONDS, <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç‰¹ç‚¹</p><ul><li>æ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯ 0ï¼Œ æœ€å¤§çº¿ç¨‹æ•°æ˜¯ Integer.MAX_VALUEï¼Œæ•‘æ€¥çº¿ç¨‹çš„ç©ºé—²ç”Ÿå­˜æ—¶é—´æ˜¯ 60sï¼Œ<ul><li>æ„å‘³ç€å…¨éƒ¨éƒ½æ˜¯æ•‘æ€¥çº¿ç¨‹ï¼ˆ60s åå¯ä»¥å›æ”¶ï¼‰</li><li>æ•‘æ€¥çº¿ç¨‹å¯ä»¥æ— é™åˆ›å»º</li></ul></li><li>é˜Ÿåˆ—é‡‡ç”¨äº† SynchronousQueue å®ç°ç‰¹ç‚¹æ˜¯ï¼Œå®ƒæ²¡æœ‰å®¹é‡ï¼Œæ²¡æœ‰çº¿ç¨‹æ¥å–æ˜¯æ”¾ä¸è¿›å»çš„ï¼ˆä¸€æ‰‹äº¤é’±ã€ä¸€æ‰‹äº¤è´§ï¼‰</li></ul><blockquote><p><strong>è¯„ä»·</strong> æ•´ä¸ªçº¿ç¨‹æ± è¡¨ç°ä¸ºçº¿ç¨‹æ•°ä¼šæ ¹æ®ä»»åŠ¡é‡ä¸æ–­å¢é•¿ï¼Œæ²¡æœ‰ä¸Šé™ï¼Œå½“ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œç©ºé—² 1åˆ†é’Ÿåé‡Šæ”¾çº¿ ç¨‹ã€‚ é€‚åˆä»»åŠ¡æ•°æ¯”è¾ƒå¯†é›†ï¼Œä½†æ¯ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´è¾ƒçŸ­çš„æƒ…å†µ</p></blockquote><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c7c54ee0-9eda-42fe-9d85-de5641ea0eda-3"><p>å•çº¿ç¨‹çº¿ç¨‹æ± </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newSingleThreadExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FinalizableDelegatedExecutorService</span></span><br><span class="line">            (<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0L</span>,</span><br><span class="line">                    TimeUnit.MILLISECONDS, <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨åœºæ™¯ï¼š</p><p>å¸Œæœ›å¤šä¸ªä»»åŠ¡æ’é˜Ÿæ‰§è¡Œã€‚çº¿ç¨‹æ•°å›ºå®šä¸º 1ï¼Œä»»åŠ¡æ•°å¤šäº 1 æ—¶ï¼Œä¼šæ”¾å…¥æ— ç•Œé˜Ÿåˆ—æ’é˜Ÿã€‚ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè¿™å”¯ä¸€çš„çº¿ç¨‹ ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾ã€‚</p><p>åŒºåˆ«ï¼š</p><ul><li>è‡ªå·±åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœä»»åŠ¡æ‰§è¡Œå¤±è´¥è€Œç»ˆæ­¢é‚£ä¹ˆæ²¡æœ‰ä»»ä½•è¡¥æ•‘æªæ–½ï¼Œè€Œçº¿ç¨‹æ± è¿˜ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¿è¯æ± çš„æ­£å¸¸å·¥ä½œ</li><li>Executors.newSingleThreadExecutor() çº¿ç¨‹ä¸ªæ•°å§‹ç»ˆä¸º1ï¼Œä¸èƒ½ä¿®æ”¹<ul><li>FinalizableDelegatedExecutorService åº”ç”¨çš„æ˜¯è£…é¥°å™¨æ¨¡å¼ï¼Œåœ¨è°ƒç”¨æ„é€ æ–¹æ³•æ—¶å°†ThreadPoolExecutorå¯¹è±¡ä¼ ç»™äº†å†…éƒ¨çš„ExecutorServiceæ¥å£ã€‚åªå¯¹å¤–æš´éœ²äº† ExecutorService æ¥å£ï¼Œå› æ­¤ä¸èƒ½è°ƒç”¨ ThreadPoolExecutor ä¸­ç‰¹æœ‰çš„æ–¹æ³•ï¼Œä¹Ÿä¸èƒ½é‡æ–°è®¾ç½®çº¿ç¨‹æ± çš„å¤§å°ã€‚</li></ul></li><li>Executors.newFixedThreadPool(1) åˆå§‹æ—¶ä¸º1ï¼Œä»¥åè¿˜å¯ä»¥ä¿®æ”¹<ul><li>å¯¹å¤–æš´éœ²çš„æ˜¯ ThreadPoolExecutor å¯¹è±¡ï¼Œå¯ä»¥å¼ºè½¬åè°ƒç”¨ setCorePoolSize ç­‰æ–¹æ³•è¿›è¡Œä¿®æ”¹</li></ul></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-4-æäº¤ä»»åŠ¡">2.4 æäº¤ä»»åŠ¡</h3><div class="tabs" id="e70e018e-6f3d-4523-837f-b5e47b1bd059"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e70e018e-6f3d-4523-837f-b5e47b1bd059-1"><i class="fas fa-award"></i>execute</button></li><li class="tab"><button type="button" data-href="#e70e018e-6f3d-4523-837f-b5e47b1bd059-2"><i class="fas fa-baseball-ball"></i>submit</button></li><li class="tab"><button type="button" data-href="#e70e018e-6f3d-4523-837f-b5e47b1bd059-3"><i class="fas fa-bone"></i>invokeAll</button></li><li class="tab"><button type="button" data-href="#e70e018e-6f3d-4523-837f-b5e47b1bd059-4"><i class="fas fa-anchor"></i>invokeAny</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e70e018e-6f3d-4523-837f-b5e47b1bd059-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e70e018e-6f3d-4523-837f-b5e47b1bd059-2"><p>submitä¸executeåŒºåˆ«åœ¨äº submitæ¥æ”¶å‚æ•°æ˜¯ä¸€ä¸ªCallableç±»å‹çš„ä»»åŠ¡ï¼ŒCallableä¸Runableç›¸æ¯”å°±æ˜¯å¤šäº†ä¸€ä¸ªè¿”å›çš„ç»“æœï¼ŒRunnableæ— è¿”å›ç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æäº¤ä»»åŠ¡ taskï¼Œç”¨è¿”å›å€¼ Future è·å¾—ä»»åŠ¡æ‰§è¡Œç»“æœ</span></span><br><span class="line">&lt;T&gt; Future&lt;T&gt; <span class="title function_">submit</span><span class="params">(Callable&lt;T&gt; task)</span>;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•submit</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">(ExecutorService pool)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException &#123;</span><br><span class="line">    Future&lt;String&gt; future = pool.submit(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;running&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//getæ–¹æ³•å¦‚æœçº¿ç¨‹æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¸»çº¿ç¨‹ä¼šé˜»å¡</span></span><br><span class="line">    log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, future.get());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">    method1(pool);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç»“æœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">18:36:58.033 c.TestSubmit [pool-1-thread-1] - running</span><br><span class="line">18:36:59.034 c.TestSubmit [main] - ok</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e70e018e-6f3d-4523-837f-b5e47b1bd059-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡</span></span><br><span class="line">&lt;T&gt; List&lt;Future&lt;T&gt;&gt; <span class="title function_">invokeAll</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"><span class="comment">// æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå¸¦è¶…æ—¶æ—¶é—´ï¼Œæ—¶é—´è¶…æ—¶åï¼Œä¼šæ”¾å¼ƒæ‰§è¡Œåé¢çš„ä»»åŠ¡</span></span><br><span class="line">&lt;T&gt; List&lt;Future&lt;T&gt;&gt; <span class="title function_">invokeAll</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,<span class="type">long</span> timeout, TimeUnit unit)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•invokeAll</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">(ExecutorService pool)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    List&lt;Future&lt;String&gt;&gt; futures = pool.invokeAll(Arrays.asList(</span><br><span class="line">        () -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;begin&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        () -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;begin&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;2&quot;</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        () -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;begin&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;3&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    ));</span><br><span class="line"></span><br><span class="line">    futures.forEach( f -&gt;  &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, f.get());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">    method2(pool);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">13</span>:<span class="number">31.187</span> c.TestSubmit [pool-<span class="number">1</span>-thread-<span class="number">2</span>] - begin</span><br><span class="line"><span class="number">16</span>:<span class="number">13</span>:<span class="number">31.187</span> c.TestSubmit [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - begin</span><br><span class="line"><span class="number">16</span>:<span class="number">13</span>:<span class="number">31.690</span> c.TestSubmit [pool-<span class="number">1</span>-thread-<span class="number">2</span>] - begin</span><br><span class="line"><span class="number">16</span>:<span class="number">13</span>:<span class="number">33.704</span> c.TestSubmit [main] - <span class="number">1</span></span><br><span class="line"><span class="number">16</span>:<span class="number">13</span>:<span class="number">33.726</span> c.TestSubmit [main] - <span class="number">2</span></span><br><span class="line"><span class="number">16</span>:<span class="number">13</span>:<span class="number">33.726</span> c.TestSubmit [main] - <span class="number">3</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e70e018e-6f3d-4523-837f-b5e47b1bd059-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå“ªä¸ªä»»åŠ¡å…ˆæˆåŠŸæ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›æ­¤ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œå…¶å®ƒä»»åŠ¡å–æ¶ˆ</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">invokeAny</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException, ExecutionException;</span><br><span class="line"><span class="comment">// æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå“ªä¸ªä»»åŠ¡å…ˆæˆåŠŸæ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›æ­¤ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œå…¶å®ƒä»»åŠ¡å–æ¶ˆï¼Œå¸¦è¶…æ—¶æ—¶é—´</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">invokeAny</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,<span class="type">long</span> timeout, TimeUnit unit)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•invokeAny</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method3</span><span class="params">(ExecutorService pool)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> pool.invokeAny(Arrays.asList(</span><br><span class="line">        () -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;begin 1&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;end 1&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        () -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;begin 2&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;end 2&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;2&quot;</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        () -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;begin 3&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;end 3&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;3&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    ));</span><br><span class="line">    log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, result);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">//ExecutorService pool = Executors.newFixedThreadPool(1);</span></span><br><span class="line">    method3(pool);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç»“æœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">19:44:46.314 c.TestSubmit [pool-1-thread-1] - begin 1</span><br><span class="line">19:44:46.314 c.TestSubmit [pool-1-thread-3] - begin 3</span><br><span class="line">19:44:46.314 c.TestSubmit [pool-1-thread-2] - begin 2</span><br><span class="line">19:44:46.817 c.TestSubmit [pool-1-thread-2] - end 2</span><br><span class="line">19:44:46.817 c.TestSubmit [main] - 2</span><br><span class="line">//è‹¥è®¾ç½®çº¿ç¨‹æ•°ç›®ä¸º1 åˆ™ä¸ºä¸‹é¢ç»“æœ</span><br><span class="line">19:47:16.063 c.TestSubmit [pool-1-thread-1] - begin 1</span><br><span class="line">19:47:17.063 c.TestSubmit [pool-1-thread-1] - end 1</span><br><span class="line">19:47:17.063 c.TestSubmit [pool-1-thread-1] - begin 2</span><br><span class="line">19:47:17.063 c.TestSubmit [main] - 1</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <h3 id="2-5-å…³é—­çº¿ç¨‹æ± ">2.5 å…³é—­çº¿ç¨‹æ± </h3><div class="tabs" id="fc1e405d-0438-41c8-9941-d7f538926b70"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#fc1e405d-0438-41c8-9941-d7f538926b70-1"><i class="fas fa-bug"></i>shutdown</button></li><li class="tab"><button type="button" data-href="#fc1e405d-0438-41c8-9941-d7f538926b70-2"><i class="fas fa-cannabis"></i>shutdownNow</button></li><li class="tab"><button type="button" data-href="#fc1e405d-0438-41c8-9941-d7f538926b70-3"><i class="fas fa-candy-cane"></i>å…¶ä»–æ–¹æ³•</button></li><li class="tab"><button type="button" data-href="#fc1e405d-0438-41c8-9941-d7f538926b70-4"><i class="fas fa-child"></i>æµ‹è¯•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="fc1e405d-0438-41c8-9941-d7f538926b70-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">çº¿ç¨‹æ± çŠ¶æ€å˜ä¸º SHUTDOWN</span></span><br><span class="line"><span class="comment">- ä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡</span></span><br><span class="line"><span class="comment">- ä½†å·²æäº¤ä»»åŠ¡ä¼šæ‰§è¡Œå®Œ</span></span><br><span class="line"><span class="comment">- æ­¤æ–¹æ³•ä¸ä¼šé˜»å¡è°ƒç”¨çº¿ç¨‹çš„æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        <span class="comment">// ä¿®æ”¹çº¿ç¨‹æ± çŠ¶æ€</span></span><br><span class="line">        advanceRunState(SHUTDOWN);</span><br><span class="line">        <span class="comment">// ä»…ä¼šæ‰“æ–­ç©ºé—²çº¿ç¨‹</span></span><br><span class="line">        interruptIdleWorkers();</span><br><span class="line">        onShutdown(); <span class="comment">// æ‰©å±•ç‚¹ ScheduledThreadPoolExecutor</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°è¯•ç»ˆç»“(æ²¡æœ‰è¿è¡Œçš„çº¿ç¨‹å¯ä»¥ç«‹åˆ»ç»ˆç»“ï¼Œå¦‚æœè¿˜æœ‰è¿è¡Œçš„çº¿ç¨‹ä¹Ÿä¸ä¼šç­‰)</span></span><br><span class="line">    tryTerminate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="fc1e405d-0438-41c8-9941-d7f538926b70-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">çº¿ç¨‹æ± çŠ¶æ€å˜ä¸º STOP</span></span><br><span class="line"><span class="comment">- ä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡</span></span><br><span class="line"><span class="comment">- ä¼šå°†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡è¿”å›</span></span><br><span class="line"><span class="comment">- å¹¶ç”¨ interrupt çš„æ–¹å¼ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">List&lt;Runnable&gt; <span class="title function_">shutdownNow</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Runnable&gt; <span class="title function_">shutdownNow</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Runnable&gt; tasks;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        <span class="comment">// ä¿®æ”¹çº¿ç¨‹æ± çŠ¶æ€</span></span><br><span class="line">        advanceRunState(STOP);</span><br><span class="line">        <span class="comment">// æ‰“æ–­æ‰€æœ‰çº¿ç¨‹</span></span><br><span class="line">        interruptWorkers();</span><br><span class="line">        <span class="comment">// è·å–é˜Ÿåˆ—ä¸­å‰©ä½™ä»»åŠ¡</span></span><br><span class="line">        tasks = drainQueue();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°è¯•ç»ˆç»“</span></span><br><span class="line">    tryTerminate();</span><br><span class="line">    <span class="keyword">return</span> tasks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="fc1e405d-0438-41c8-9941-d7f538926b70-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸åœ¨ RUNNING çŠ¶æ€çš„çº¿ç¨‹æ± ï¼Œæ­¤æ–¹æ³•å°±è¿”å› true</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isShutdown</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">// çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦æ˜¯ TERMINATED</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isTerminated</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">// è°ƒç”¨ shutdown åï¼Œç”±äºè°ƒç”¨çº¿ç¨‹å¹¶ä¸ä¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡è¿è¡Œç»“æŸï¼Œå› æ­¤å¦‚æœå®ƒæƒ³åœ¨çº¿ç¨‹æ±  TERMINATED ååšäº›äº‹æƒ…ï¼Œå¯ä»¥åˆ©ç”¨æ­¤æ–¹æ³•ç­‰å¾…</span></span><br><span class="line"><span class="comment">// ä¸€èˆ¬taskæ˜¯Callableç±»å‹çš„æ—¶å€™ä¸ç”¨æ­¤æ–¹æ³•ï¼Œå› ä¸ºfutureTask.getæ–¹æ³•è‡ªå¸¦ç­‰å¾…åŠŸèƒ½ã€‚</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">awaitTermination</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="fc1e405d-0438-41c8-9941-d7f538926b70-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestShutDown&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestShutDown</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        Future&lt;Integer&gt; result1 = pool.submit(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task 1 running...&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;task 1 finish...&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Future&lt;Integer&gt; result2 = pool.submit(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task 2 running...&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;task 2 finish...&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Future&lt;Integer&gt; result3 = pool.submit(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task 3 running...&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;task 3 finish...&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;shutdown&quot;</span>);</span><br><span class="line">        pool.shutdown();</span><br><span class="line">        <span class="comment">//        pool.awaitTermination(3, TimeUnit.SECONDS);</span></span><br><span class="line">        <span class="comment">//        List&lt;Runnable&gt; runnables = pool.shutdownNow();</span></span><br><span class="line">        <span class="comment">//        log.debug(&quot;other.... &#123;&#125;&quot; , runnables);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç»“æœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#shutdownä¾æ—§ä¼šæ‰§è¡Œå‰©ä¸‹çš„ä»»åŠ¡</span></span><br><span class="line">20:09:13.285 c.TestShutDown [main] - shutdown</span><br><span class="line">20:09:13.285 c.TestShutDown [pool-1-thread-1] - task 1 running...</span><br><span class="line">20:09:13.285 c.TestShutDown [pool-1-thread-2] - task 2 running...</span><br><span class="line">20:09:14.293 c.TestShutDown [pool-1-thread-2] - task 2 finish...</span><br><span class="line">20:09:14.293 c.TestShutDown [pool-1-thread-1] - task 1 finish...</span><br><span class="line">20:09:14.293 c.TestShutDown [pool-1-thread-2] - task 3 running...</span><br><span class="line">20:09:15.303 c.TestShutDown [pool-1-thread-2] - task 3 finish...</span><br><span class="line"><span class="comment">#shutdownNowç«‹åˆ»åœæ­¢æ‰€æœ‰ä»»åŠ¡</span></span><br><span class="line">20:11:11.750 c.TestShutDown [main] - shutdown</span><br><span class="line">20:11:11.750 c.TestShutDown [pool-1-thread-1] - task 1 running...</span><br><span class="line">20:11:11.750 c.TestShutDown [pool-1-thread-2] - task 2 running...</span><br><span class="line">20:11:11.750 c.TestShutDown [main] - other.... [java.util.concurrent.FutureTask@66d33a]</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-6-æ¨¡å¼ä¹‹-Worker-Thread">2.6 æ¨¡å¼ä¹‹ Worker Thread</h3><h4 id="2-6-1-å®šä¹‰">2.6.1 å®šä¹‰</h4><p>è®©æœ‰é™çš„å·¥ä½œçº¿ç¨‹ï¼ˆWorker Threadï¼‰æ¥è½®æµå¼‚æ­¥å¤„ç†æ— é™å¤šçš„ä»»åŠ¡ã€‚ä¹Ÿå¯ä»¥å°†å…¶å½’ç±»ä¸ºåˆ†å·¥æ¨¡å¼ï¼Œå®ƒçš„å…¸å‹å®ç° å°±æ˜¯çº¿ç¨‹æ± ï¼Œä¹Ÿä½“ç°äº†ç»å…¸è®¾è®¡æ¨¡å¼ä¸­çš„äº«å…ƒæ¨¡å¼ã€‚</p><p>ä¾‹å¦‚ï¼Œæµ·åº•æçš„æœåŠ¡å‘˜ï¼ˆçº¿ç¨‹ï¼‰ï¼Œè½®æµå¤„ç†æ¯ä½å®¢äººçš„ç‚¹é¤ï¼ˆä»»åŠ¡ï¼‰ï¼Œå¦‚æœä¸ºæ¯ä½å®¢äººéƒ½é…ä¸€åä¸“å±çš„æœåŠ¡å‘˜ï¼Œé‚£ ä¹ˆæˆæœ¬å°±å¤ªé«˜äº†ï¼ˆå¯¹æ¯”å¦ä¸€ç§å¤šçº¿ç¨‹è®¾è®¡æ¨¡å¼ï¼šThread-Per-Messageï¼‰</p><p>æ³¨æ„ï¼Œä¸åŒä»»åŠ¡ç±»å‹åº”è¯¥ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ± ï¼Œè¿™æ ·èƒ½å¤Ÿé¿å…é¥¥é¥¿ï¼Œå¹¶èƒ½æå‡æ•ˆç‡</p><p>ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªé¤é¦†çš„å·¥äººæ—¢è¦æ‹›å‘¼å®¢äººï¼ˆä»»åŠ¡ç±»å‹Aï¼‰ï¼Œåˆè¦åˆ°åå¨åšèœï¼ˆä»»åŠ¡ç±»å‹Bï¼‰æ˜¾ç„¶æ•ˆç‡ä¸å’‹åœ°ï¼Œåˆ†æˆ æœåŠ¡å‘˜ï¼ˆçº¿ç¨‹æ± Aï¼‰ä¸å¨å¸ˆï¼ˆçº¿ç¨‹æ± Bï¼‰æ›´ä¸ºåˆç†ï¼Œå½“ç„¶ä½ èƒ½æƒ³åˆ°æ›´ç»†è‡´çš„åˆ†å·¥</p><h4 id="2-6-2-é¥¥é¥¿">2.6.2 é¥¥é¥¿</h4><p>å›ºå®šå¤§å°çº¿ç¨‹æ± ä¼šæœ‰é¥¥é¥¿ç°è±¡</p><ul><li>ä¸¤ä¸ªå·¥äººæ˜¯åŒä¸€ä¸ªçº¿ç¨‹æ± ä¸­çš„ä¸¤ä¸ªçº¿ç¨‹</li><li>ä»–ä»¬è¦åšçš„äº‹æƒ…æ˜¯ï¼šä¸ºå®¢äººç‚¹é¤å’Œåˆ°åå¨åšèœï¼Œè¿™æ˜¯ä¸¤ä¸ªé˜¶æ®µçš„å·¥ä½œ<ul><li>å®¢äººç‚¹é¤ï¼šå¿…é¡»å…ˆç‚¹å®Œé¤ï¼Œç­‰èœåšå¥½ï¼Œä¸Šèœï¼Œåœ¨æ­¤æœŸé—´å¤„ç†ç‚¹é¤çš„å·¥äººå¿…é¡»ç­‰å¾…</li><li>åå¨åšèœï¼šæ²¡å•¥è¯´çš„ï¼Œåšå°±æ˜¯äº†</li></ul></li></ul><div class="tabs" id="72098094-2c84-45c0-9581-3fc5aedc6f83"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#72098094-2c84-45c0-9581-3fc5aedc6f83-1"><i class="fas fa-seedling"></i>æ­£å¸¸æƒ…å†µ</button></li><li class="tab"><button type="button" data-href="#72098094-2c84-45c0-9581-3fc5aedc6f83-2"><i class="fas fa-leaf"></i>é¥¥é¥¿æƒ…å†µ</button></li><li class="tab"><button type="button" data-href="#72098094-2c84-45c0-9581-3fc5aedc6f83-3"><i class="fab fa-apple"></i>è§£å†³æ–¹æ³•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="72098094-2c84-45c0-9581-3fc5aedc6f83-1"><p>æ¯”å¦‚å·¥äººA å¤„ç†äº†ç‚¹é¤ä»»åŠ¡ï¼Œæ¥ä¸‹æ¥å®ƒè¦ç­‰ç€ å·¥äººB æŠŠèœåšå¥½ï¼Œç„¶åä¸Šèœï¼Œä»–ä¿©ä¹Ÿé…åˆçš„è›®å¥½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestDeadLock&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestStarvation</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; MENU = Arrays.asList(<span class="string">&quot;åœ°ä¸‰é²œ&quot;</span>, <span class="string">&quot;å®«ä¿é¸¡ä¸&quot;</span>, <span class="string">&quot;è¾£å­é¸¡ä¸&quot;</span>, <span class="string">&quot;çƒ¤é¸¡ç¿…&quot;</span>);</span><br><span class="line">    <span class="keyword">static</span> <span class="type">Random</span> <span class="variable">RANDOM</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    <span class="keyword">static</span> String <span class="title function_">cooking</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> MENU.get(RANDOM.nextInt(MENU.size()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//ä¸¤ä¸ªå·¥äºº</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">Pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">      <span class="comment">//å®¢äººä¸€</span></span><br><span class="line">        Pool.execute(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å¤„ç†ç‚¹é¤...&quot;</span>);</span><br><span class="line">            <span class="comment">//æ‰¾ä¸€ä¸ªå·¥äººåšèœ</span></span><br><span class="line">            Future&lt;String&gt; f = Pool.submit(() -&gt; &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;åšèœ&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> cooking();</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//ç­‰å¾…åšèœç»“æœ</span></span><br><span class="line">                log.debug(<span class="string">&quot;ä¸Šèœ: &#123;&#125;&quot;</span>, f.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">18</span>:<span class="number">07</span>:<span class="number">14.374</span> c.TestDeadLock [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - å¤„ç†ç‚¹é¤...</span><br><span class="line"><span class="number">18</span>:<span class="number">07</span>:<span class="number">14.379</span> c.TestDeadLock [pool-<span class="number">1</span>-thread-<span class="number">2</span>] - åšèœ</span><br><span class="line"><span class="number">18</span>:<span class="number">07</span>:<span class="number">14.380</span> c.TestDeadLock [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - ä¸Šèœ: å®«ä¿é¸¡ä¸</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="72098094-2c84-45c0-9581-3fc5aedc6f83-2"><p>ä½†ç°åœ¨åŒæ—¶æ¥äº†ä¸¤ä¸ªå®¢äººï¼Œè¿™ä¸ªæ—¶å€™å·¥äººA å’Œå·¥äººB éƒ½å»å¤„ç†ç‚¹é¤äº†ï¼Œè¿™æ—¶æ²¡äººåšé¥­äº†ï¼Œé¥¥é¥¿</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestDeadLock&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestStarvation</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; MENU = Arrays.asList(<span class="string">&quot;åœ°ä¸‰é²œ&quot;</span>, <span class="string">&quot;å®«ä¿é¸¡ä¸&quot;</span>, <span class="string">&quot;è¾£å­é¸¡ä¸&quot;</span>, <span class="string">&quot;çƒ¤é¸¡ç¿…&quot;</span>);</span><br><span class="line">    <span class="keyword">static</span> <span class="type">Random</span> <span class="variable">RANDOM</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    <span class="keyword">static</span> String <span class="title function_">cooking</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> MENU.get(RANDOM.nextInt(MENU.size()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//ä¸¤ä¸ªå·¥äºº</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">Pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">      <span class="comment">//å®¢äººä¸€</span></span><br><span class="line">        Pool.execute(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å¤„ç†ç‚¹é¤...&quot;</span>);</span><br><span class="line">            <span class="comment">//æ‰¾ä¸€ä¸ªå·¥äººåšèœ</span></span><br><span class="line">            Future&lt;String&gt; f = Pool.submit(() -&gt; &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;åšèœ&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> cooking();</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//ç­‰å¾…åšèœç»“æœ</span></span><br><span class="line">                log.debug(<span class="string">&quot;ä¸Šèœ: &#123;&#125;&quot;</span>, f.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">       <span class="comment">//å®¢äººäºŒ</span></span><br><span class="line">       Pool.execute(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å¤„ç†ç‚¹é¤...&quot;</span>);</span><br><span class="line">            <span class="comment">//æ‰¾ä¸€ä¸ªå·¥äººåšèœ</span></span><br><span class="line">            Future&lt;String&gt; f = Pool.submit(() -&gt; &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;åšèœ&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> cooking();</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//ç­‰å¾…åšèœç»“æœ</span></span><br><span class="line">                log.debug(<span class="string">&quot;ä¸Šèœ: &#123;&#125;&quot;</span>, f.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">18</span>:09:<span class="number">35.527</span> c.TestDeadLock [pool-<span class="number">1</span>-thread-<span class="number">2</span>] - å¤„ç†ç‚¹é¤...</span><br><span class="line"><span class="number">18</span>:09:<span class="number">35.527</span> c.TestDeadLock [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - å¤„ç†ç‚¹é¤...</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="72098094-2c84-45c0-9581-3fc5aedc6f83-3"><p>è§£å†³æ–¹æ³•å¯ä»¥å¢åŠ çº¿ç¨‹æ± çš„å¤§å°ï¼Œä¸è¿‡ä¸æ˜¯æ ¹æœ¬è§£å†³æ–¹æ¡ˆï¼Œè¿˜æ˜¯å‰é¢æåˆ°çš„ï¼Œ<code>ä¸åŒçš„ä»»åŠ¡ç±»å‹ï¼Œé‡‡ç”¨ä¸åŒçš„çº¿ç¨‹æ± </code>ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestStarvation</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; MENU = Arrays.asList(<span class="string">&quot;åœ°ä¸‰é²œ&quot;</span>, <span class="string">&quot;å®«ä¿é¸¡ä¸&quot;</span>, <span class="string">&quot;è¾£å­é¸¡ä¸&quot;</span>, <span class="string">&quot;çƒ¤é¸¡ç¿…&quot;</span>);</span><br><span class="line">    <span class="keyword">static</span> <span class="type">Random</span> <span class="variable">RANDOM</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    <span class="keyword">static</span> String <span class="title function_">cooking</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> MENU.get(RANDOM.nextInt(MENU.size()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//æœåŠ¡å‘˜</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">waiterPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//å¨å­</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">cookPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">        waiterPool.execute(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å¤„ç†ç‚¹é¤...&quot;</span>);</span><br><span class="line">            Future&lt;String&gt; f = cookPool.submit(() -&gt; &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;åšèœ&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> cooking();</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;ä¸Šèœ: &#123;&#125;&quot;</span>, f.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        waiterPool.execute(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å¤„ç†ç‚¹é¤...&quot;</span>);</span><br><span class="line">            Future&lt;String&gt; f = cookPool.submit(() -&gt; &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;åšèœ&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> cooking();</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;ä¸Šèœ: &#123;&#125;&quot;</span>, f.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">17:25:14.626 c.TestDeadLock [pool-1-thread-1] - å¤„ç†ç‚¹é¤... </span><br><span class="line">17:25:14.630 c.TestDeadLock [pool-2-thread-1] - åšèœ</span><br><span class="line">17:25:14.631 c.TestDeadLock [pool-1-thread-1] - ä¸Šèœ: åœ°ä¸‰é²œ</span><br><span class="line">17:25:14.632 c.TestDeadLock [pool-1-thread-1] - å¤„ç†ç‚¹é¤... </span><br><span class="line">17:25:14.632 c.TestDeadLock [pool-2-thread-1] - åšèœ</span><br><span class="line">17:25:14.632 c.TestDeadLock [pool-1-thread-1] - ä¸Šèœ: è¾£å­é¸¡ä¸</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h4 id="2-6-3-åˆ›å»ºå¤šå°‘çº¿ç¨‹æ± åˆé€‚">2.6.3 åˆ›å»ºå¤šå°‘çº¿ç¨‹æ± åˆé€‚</h4><ul><li>è¿‡å°ä¼šå¯¼è‡´ç¨‹åºä¸èƒ½å……åˆ†åœ°åˆ©ç”¨ç³»ç»Ÿèµ„æºã€å®¹æ˜“å¯¼è‡´é¥¥é¥¿</li><li>è¿‡å¤§ä¼šå¯¼è‡´æ›´å¤šçš„çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå ç”¨æ›´å¤šå†…å­˜</li></ul><p><strong>CPU å¯†é›†å‹è¿ç®—</strong></p><p>é€šå¸¸é‡‡ç”¨ <code>cpu æ ¸æ•° + 1</code> èƒ½å¤Ÿå®ç°æœ€ä¼˜çš„ CPU åˆ©ç”¨ç‡ï¼Œ+1 æ˜¯ä¿è¯å½“çº¿ç¨‹ç”±äºé¡µç¼ºå¤±æ•…éšœï¼ˆæ“ä½œç³»ç»Ÿï¼‰æˆ–å…¶å®ƒåŸå›  å¯¼è‡´æš‚åœæ—¶ï¼Œé¢å¤–çš„è¿™ä¸ªçº¿ç¨‹å°±èƒ½é¡¶ä¸Šå»ï¼Œä¿è¯ CPU æ—¶é’Ÿå‘¨æœŸä¸è¢«æµªè´¹</p><p><strong>I/O å¯†é›†å‹è¿ç®—</strong></p><p>CPU ä¸æ€»æ˜¯å¤„äºç¹å¿™çŠ¶æ€ï¼Œä¾‹å¦‚ï¼Œå½“ä½ æ‰§è¡Œä¸šåŠ¡è®¡ç®—æ—¶ï¼Œè¿™æ—¶å€™ä¼šä½¿ç”¨ CPU èµ„æºï¼Œä½†å½“ä½ æ‰§è¡Œ I/O æ“ä½œæ—¶ã€è¿œç¨‹ RPC è°ƒç”¨æ—¶ï¼ŒåŒ…æ‹¬è¿›è¡Œæ•°æ®åº“æ“ä½œæ—¶ï¼Œè¿™æ—¶å€™ CPU å°±é—²ä¸‹æ¥äº†ï¼Œä½ å¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æé«˜å®ƒçš„åˆ©ç”¨ç‡ã€‚</p><p>ç»éªŒå…¬å¼å¦‚ä¸‹</p><p><code>çº¿ç¨‹æ•° = æ ¸æ•° * æœŸæœ› CPU åˆ©ç”¨ç‡ * æ€»æ—¶é—´(CPUè®¡ç®—æ—¶é—´+ç­‰å¾…æ—¶é—´) / CPU è®¡ç®—æ—¶é—´</code></p><p>ä¾‹å¦‚ 4 æ ¸ CPU è®¡ç®—æ—¶é—´æ˜¯ 50% ï¼Œå…¶å®ƒç­‰å¾…æ—¶é—´æ˜¯ 50%ï¼ŒæœŸæœ› cpu è¢« 100% åˆ©ç”¨ï¼Œå¥—ç”¨å…¬å¼</p><p><code>4 * 100% * 100% / 50% = 8</code></p><p>ä¾‹å¦‚ 4 æ ¸ CPU è®¡ç®—æ—¶é—´æ˜¯ 10% ï¼Œå…¶å®ƒç­‰å¾…æ—¶é—´æ˜¯ 90%ï¼ŒæœŸæœ› cpu è¢« 100% åˆ©ç”¨ï¼Œå¥—ç”¨å…¬å¼</p><p><code>4 * 100% * 100% / 10% = 40</code></p><h3 id="2-7-ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± ">2.7 ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± </h3><p>æœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›ä»»åŠ¡å»¶æ—¶æ‰§è¡Œï¼Œæˆ–è€…ä»»åŠ¡åå¤è¢«æ‰§è¡Œæ¯éš”å‡ ç§’å°±æ‰§è¡Œä¸€æ¬¡ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± ã€‚</p><div class="tabs" id="48895836-bcf8-493d-93c7-10ef0f0adbf7"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#48895836-bcf8-493d-93c7-10ef0f0adbf7-1"><i class="fas fa-cat"></i>Timerå®ç°</button></li><li class="tab"><button type="button" data-href="#48895836-bcf8-493d-93c7-10ef0f0adbf7-2"><i class="fas fa-horse"></i>ScheduledExecutorServiceå®ç°</button></li><li class="tab"><button type="button" data-href="#48895836-bcf8-493d-93c7-10ef0f0adbf7-3"><i class="fas fa-dove"></i>çº¿ç¨‹æ•°å°‘æ—¶</button></li><li class="tab"><button type="button" data-href="#48895836-bcf8-493d-93c7-10ef0f0adbf7-4"><i class="fas fa-dragon"></i>å‡ºç°å¼‚å¸¸æ—¶</button></li><li class="tab"><button type="button" data-href="#48895836-bcf8-493d-93c7-10ef0f0adbf7-5"><i class="fas fa-atom"></i>å®šæ—¶æ‰§è¡Œ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="48895836-bcf8-493d-93c7-10ef0f0adbf7-1"><p>åœ¨ã€ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± ã€åŠŸèƒ½åŠ å…¥ä¹‹å‰(JDK1.3)ï¼Œå¯ä»¥ä½¿ç”¨ java.util.Timer æ¥å®ç°å®šæ—¶åŠŸèƒ½ï¼ŒTimer çš„ä¼˜ç‚¹åœ¨äºç®€å•æ˜“ç”¨ï¼Œä½†ç”±äºæ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹æ¥è°ƒåº¦ï¼Œå› æ­¤æ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œï¼Œå‰ä¸€ä¸ª ä»»åŠ¡çš„å»¶è¿Ÿæˆ–å¼‚å¸¸éƒ½å°†ä¼šå½±å“åˆ°ä¹‹åçš„ä»»åŠ¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Timer</span> <span class="variable">timer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Timer</span>();</span><br><span class="line">    <span class="type">TimerTask</span> <span class="variable">task1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task 1&quot;</span>);</span><br><span class="line">            sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">TimerTask</span> <span class="variable">task2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task 2&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ timer æ·»åŠ ä¸¤ä¸ªä»»åŠ¡ï¼Œå¸Œæœ›å®ƒä»¬éƒ½åœ¨ 1s åæ‰§è¡Œ</span></span><br><span class="line">    <span class="comment">// ä½†ç”±äº timer å†…åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥é¡ºåºæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œå› æ­¤ã€ä»»åŠ¡1ã€çš„å»¶æ—¶ï¼Œå½±å“äº†ã€ä»»åŠ¡2ã€çš„æ‰§è¡Œ</span></span><br><span class="line">    log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">    timer.schedule(task1, <span class="number">1000</span>);</span><br><span class="line">    timer.schedule(task2, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">20:46:09.444 c.TestTimer [main] - start... </span><br><span class="line">20:46:10.447 c.TestTimer [Timer-0] - task 1 </span><br><span class="line">20:46:12.448 c.TestTimer [Timer-0] - task 2 </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="48895836-bcf8-493d-93c7-10ef0f0adbf7-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ScheduledExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line"><span class="comment">// æ·»åŠ ä¸¤ä¸ªä»»åŠ¡ï¼Œå¸Œæœ›å®ƒä»¬éƒ½åœ¨ 1s åæ‰§è¡Œ</span></span><br><span class="line"><span class="comment">//ä»»åŠ¡ä¸€</span></span><br><span class="line">executor.schedule(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»»åŠ¡1ï¼Œæ‰§è¡Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">2000</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; &#125;</span><br><span class="line">&#125;, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»»åŠ¡äºŒ</span></span><br><span class="line">executor.schedule(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»»åŠ¡2ï¼Œæ‰§è¡Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">&#125;, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä»»åŠ¡1ï¼Œæ‰§è¡Œæ—¶é—´ï¼šThu Jan 03 12:45:17 CST 2019 </span><br><span class="line">ä»»åŠ¡2ï¼Œæ‰§è¡Œæ—¶é—´ï¼šThu Jan 03 12:45:17 CST 2019 </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="48895836-bcf8-493d-93c7-10ef0f0adbf7-3"><p>ä¸²è¡Œæ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ScheduledExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line"><span class="comment">// æ·»åŠ ä¸¤ä¸ªä»»åŠ¡ï¼Œå¸Œæœ›å®ƒä»¬éƒ½åœ¨ 1s åæ‰§è¡Œ</span></span><br><span class="line"><span class="comment">//ä»»åŠ¡ä¸€</span></span><br><span class="line">executor.schedule(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»»åŠ¡1ï¼Œæ‰§è¡Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">2000</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; &#125;</span><br><span class="line">&#125;, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»»åŠ¡äºŒ</span></span><br><span class="line">executor.schedule(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»»åŠ¡2ï¼Œæ‰§è¡Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">&#125;, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä»»åŠ¡<span class="number">1</span>ï¼Œæ‰§è¡Œæ—¶é—´ï¼šMon Apr <span class="number">03</span> <span class="number">18</span>:<span class="number">48</span>:<span class="number">24</span> CST <span class="number">2023</span></span><br><span class="line">ä»»åŠ¡<span class="number">2</span>ï¼Œæ‰§è¡Œæ—¶é—´ï¼šMon Apr <span class="number">03</span> <span class="number">18</span>:<span class="number">48</span>:<span class="number">26</span> CST <span class="number">2023</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="48895836-bcf8-493d-93c7-10ef0f0adbf7-4"><p>ä»»åŠ¡ä¸€ä¸­ é™¤é›¶å¼‚å¸¸</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ScheduledExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// æ·»åŠ ä¸¤ä¸ªä»»åŠ¡ï¼Œå¸Œæœ›å®ƒä»¬éƒ½åœ¨ 1s åæ‰§è¡Œ</span></span><br><span class="line"><span class="comment">//ä»»åŠ¡ä¸€</span></span><br><span class="line">executor.schedule(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»»åŠ¡1ï¼Œæ‰§è¡Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="type">int</span> i=<span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">2000</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; &#125;</span><br><span class="line">&#125;, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»»åŠ¡äºŒ</span></span><br><span class="line">executor.schedule(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»»åŠ¡2ï¼Œæ‰§è¡Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">&#125;, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä»»åŠ¡<span class="number">1</span>ï¼Œæ‰§è¡Œæ—¶é—´ï¼šMon Apr <span class="number">03</span> <span class="number">18</span>:<span class="number">50</span>:<span class="number">35</span> CST <span class="number">2023</span></span><br><span class="line">ä»»åŠ¡<span class="number">2</span>ï¼Œæ‰§è¡Œæ—¶é—´ï¼šMon Apr <span class="number">03</span> <span class="number">18</span>:<span class="number">50</span>:<span class="number">35</span> CST <span class="number">2023</span></span><br></pre></td></tr></table></figure><p>éƒ½æ‰§è¡Œï¼Œå¹¶æœªçœ‹åˆ°å¼‚å¸¸ä¿¡æ¯</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="48895836-bcf8-493d-93c7-10ef0f0adbf7-5"><p>scheduleAtFixedRateï¼šçœŸæ­£çš„é—´éš”æ—¶é—´ï¼Œæ˜¯ç”±ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å’Œè®¾ç½®çš„é—´éš”æ—¶é—´é•¿çŸ­æ¥å†³å®šçš„ï¼Œè°é•¿å–è°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»¥ä¸Šä¸€ä¸ªä»»åŠ¡å¼€å§‹çš„æ—¶é—´è®¡æ—¶ï¼Œperiodæ—¶é—´è¿‡å»åï¼Œæ£€æµ‹ä¸Šä¸€ä¸ªä»»åŠ¡æ˜¯å¦æ‰§è¡Œå®Œæ¯•ï¼Œå¦‚æœä¸Šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™å½“å‰ä»»åŠ¡ç«‹å³æ‰§è¡Œï¼Œå¦‚æœä¸Šä¸€ä¸ªä»»åŠ¡æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™éœ€è¦ç­‰ä¸Šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åç«‹å³æ‰§è¡Œã€‚<br>scheduleWithFixedDelayï¼šçœŸæ­£çš„é—´éš”æ—¶é—´ï¼Œæ˜¯ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´åŠ ä¸Šè®¾ç½®çš„é—´éš”æ—¶é—´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ˜¯ä»¥ä¸Šä¸€ä¸ªä»»åŠ¡ç»“æŸæ—¶å¼€å§‹è®¡æ—¶ï¼Œperiodæ—¶é—´è¿‡å»åï¼Œç«‹å³æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ScheduledExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line">log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">pool.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;running...&quot;</span>);</span><br><span class="line">&#125;, <span class="number">1</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">37.231</span> c.TestTimer [main] - start...</span><br><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">38.333</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running...</span><br><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">39.332</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running...</span><br><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">40.332</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running...</span><br><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">41.332</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running...</span><br><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">42.332</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running...</span><br><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">43.332</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running...</span><br><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">44.329</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running...</span><br><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">45.332</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running...</span><br><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">46.332</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running...</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ScheduledExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line">log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">pool.scheduleWithFixedDelay(()-&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;running...&quot;</span>);</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">&#125;, <span class="number">1</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">40</span>:<span class="number">55.078</span> c.TestTimer [main] - start... </span><br><span class="line"><span class="number">21</span>:<span class="number">40</span>:<span class="number">56.140</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running... </span><br><span class="line"><span class="number">21</span>:<span class="number">40</span>:<span class="number">59.143</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running... </span><br><span class="line"><span class="number">21</span>:<span class="number">41</span>:<span class="number">02.145</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running... </span><br><span class="line"><span class="number">21</span>:<span class="number">41</span>:<span class="number">05.147</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running... </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-8-æ­£ç¡®å¤„ç†æ‰§è¡Œä»»åŠ¡å¼‚å¸¸">2.8 æ­£ç¡®å¤„ç†æ‰§è¡Œä»»åŠ¡å¼‚å¸¸</h3><p>ä¸è®ºæ˜¯å“ªä¸ªçº¿ç¨‹æ± ï¼Œåœ¨çº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡å‘ç”Ÿå¼‚å¸¸åæ—¢ä¸ä¼šæŠ›å‡ºï¼Œä¹Ÿä¸ä¼šæ•è·ï¼Œè¿™æ—¶å°±éœ€è¦æˆ‘ä»¬åšä¸€å®šçš„å¤„ç†ã€‚</p><div class="tabs" id="1cbd0048-f807-4045-8580-23803459291a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#1cbd0048-f807-4045-8580-23803459291a-1"><i class="fas fa-award"></i>æ–¹æ³•1ï¼šä¸»åŠ¨æ‰å¼‚å¸¸</button></li><li class="tab"><button type="button" data-href="#1cbd0048-f807-4045-8580-23803459291a-2"><i class="fas fa-baseball-ball"></i>æ–¹æ³•2ï¼šä½¿ç”¨ Future</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="1cbd0048-f807-4045-8580-23803459291a-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">pool.submit(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;task1&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;error:&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">21:59:04.558 c.TestTimer [pool-1-thread-1] - task1 </span><br><span class="line">21:59:04.562 c.TestTimer [pool-1-thread-1] - error: </span><br><span class="line">java.lang.ArithmeticException: / by zero </span><br><span class="line"> at cn.itcast.n8.TestTimer.lambda$main<span class="variable">$0</span>(TestTimer.java:28) </span><br><span class="line"> at java.util.concurrent.Executors<span class="variable">$RunnableAdapter</span>.call(Executors.java:511) </span><br><span class="line"> at java.util.concurrent.FutureTask.run(FutureTask.java:266) </span><br><span class="line"> at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) </span><br><span class="line"> at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:624) </span><br><span class="line"> at java.lang.Thread.run(Thread.java:748) </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="1cbd0048-f807-4045-8580-23803459291a-2"><p>è¯´æ˜ï¼š</p><ul><li>lambdaè¡¨è¾¾å¼å†…è¦æœ‰è¿”å›å€¼ï¼Œç¼–è¯‘å™¨æ‰èƒ½å°†å…¶è¯†åˆ«ä¸ºCallableï¼Œå¦åˆ™å°†è¯†åˆ«ä¸ºRunnableï¼Œä¹Ÿå°±ä¸èƒ½ç”¨FutureTask</li><li>æ–¹æ³•ä¸­å¦‚æœå‡ºå¼‚å¸¸ï¼Œ<code>futuretask.get</code>ä¼šè¿”å›è¿™ä¸ªå¼‚å¸¸ï¼Œå¦è€…æ­£å¸¸è¿”å›ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">Future&lt;Boolean&gt; f = pool.submit(() -&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;task1&quot;</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br><span class="line">log.debug(<span class="string">&quot;result:&#123;&#125;&quot;</span>, f.get());</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">21:54:58.208 c.TestTimer [pool-1-thread-1] - task1 </span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;main&quot;</span> java.util.concurrent.ExecutionException: </span><br><span class="line">java.lang.ArithmeticException: / by zero </span><br><span class="line"> at java.util.concurrent.FutureTask.report(FutureTask.java:122) </span><br><span class="line"> at java.util.concurrent.FutureTask.get(FutureTask.java:192) </span><br><span class="line"> at cn.itcast.n8.TestTimer.main(TestTimer.java:31) </span><br><span class="line">Caused by: java.lang.ArithmeticException: / by zero </span><br><span class="line"> at cn.itcast.n8.TestTimer.lambda$main<span class="variable">$0</span>(TestTimer.java:28) </span><br><span class="line"> at java.util.concurrent.FutureTask.run(FutureTask.java:266) </span><br><span class="line"> at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) </span><br><span class="line"> at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:624) </span><br><span class="line"> at java.lang.Thread.run(Thread.java:748) </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <h3 id="2-9-åº”ç”¨ä¹‹å®šæ—¶ä»»åŠ¡">2.9 åº”ç”¨ä¹‹å®šæ—¶ä»»åŠ¡</h3><p>å¦‚ä½•è®©æ¯å‘¨å›› 18:00:00 å®šæ—¶æ‰§è¡Œä»»åŠ¡ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å¾—å½“å‰æ—¶é—´</span></span><br><span class="line"><span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line"><span class="comment">// è·å–æœ¬å‘¨å›› 18:00:00.000</span></span><br><span class="line"><span class="type">LocalDateTime</span> <span class="variable">thursday</span> <span class="operator">=</span> </span><br><span class="line">    now.with(DayOfWeek.THURSDAY).withHour(<span class="number">18</span>).withMinute(<span class="number">0</span>).withSecond(<span class="number">0</span>).withNano(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// å¦‚æœå½“å‰æ—¶é—´å·²ç»è¶…è¿‡ æœ¬å‘¨å›› 18:00:00.000ï¼Œ é‚£ä¹ˆæ‰¾ä¸‹å‘¨å›› 18:00:00.000</span></span><br><span class="line"><span class="keyword">if</span>(now.compareTo(thursday) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    thursday = thursday.plusWeeks(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è®¡ç®—æ—¶é—´å·®ï¼Œå³å»¶æ—¶æ‰§è¡Œæ—¶é—´</span></span><br><span class="line"><span class="type">long</span> <span class="variable">initialDelay</span> <span class="operator">=</span> Duration.between(now, thursday).toMillis();</span><br><span class="line"><span class="comment">// è®¡ç®—é—´éš”æ—¶é—´ï¼Œå³ 1 å‘¨çš„æ¯«ç§’å€¼</span></span><br><span class="line"><span class="type">long</span> <span class="variable">oneWeek</span> <span class="operator">=</span> <span class="number">7</span> * <span class="number">24</span> * <span class="number">3600</span> * <span class="number">1000</span>;</span><br><span class="line"><span class="type">ScheduledExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;å¼€å§‹æ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">executor.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;æ‰§è¡Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">&#125;, initialDelay, oneWeek, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure><h3 id="2-10-Tomcat-çº¿ç¨‹æ± ">2.10 Tomcat çº¿ç¨‹æ± </h3><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230403193219700.png" alt="image-20230403193219700" style="zoom: 33%;" /><ul><li>LimitLatch ç”¨æ¥é™æµï¼Œå¯ä»¥æ§åˆ¶æœ€å¤§è¿æ¥ä¸ªæ•°ï¼Œç±»ä¼¼ J.U.C ä¸­çš„ Semaphore åé¢å†è®²</li><li>Acceptor åªè´Ÿè´£ã€æ¥æ”¶æ–°çš„ socket è¿æ¥ã€‘</li><li>Poller åªè´Ÿè´£ç›‘å¬ socket channel æ˜¯å¦æœ‰ã€å¯è¯»çš„ I/O äº‹ä»¶ã€‘</li><li>ä¸€æ—¦å¯è¯»ï¼Œå°è£…ä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼ˆsocketProcessorï¼‰ï¼Œæäº¤ç»™ Executor çº¿ç¨‹æ± å¤„ç†</li><li>Executor çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹æœ€ç»ˆè´Ÿè´£ã€å¤„ç†è¯·æ±‚ã€‘</li></ul><blockquote><p>åˆç†çš„åˆ†å·¥æ˜¯å®ç°é«˜å¹¶å‘çš„ä¿éšœã€‚å›¾ä¸­Acceptorå’Œã€Pollerå’ŒExecutorä¸­çš„çº¿ç¨‹éƒ½æ˜¯çº¿ç¨‹ã€‚é‚£ä¸ºä»€ä¹ˆæŠŠå®ƒä»¬åˆ†æˆä¸‰å—å‘¢ï¼Ÿå®ƒä»¬æ¯ä¸€å—å¤„ç†çš„ä»»åŠ¡æ—¶ä¸ä¸€æ ·çš„ã€‚</p></blockquote><p>Tomcat çº¿ç¨‹æ± æ‰©å±•äº† ThreadPoolExecutorï¼Œè¡Œä¸ºç¨æœ‰ä¸åŒ</p><ul><li>å¦‚æœæ€»çº¿ç¨‹æ•°è¾¾åˆ° maximumPoolSize<ul><li>è¿™æ—¶ä¸ä¼šç«‹åˆ»æŠ› RejectedExecutionException å¼‚å¸¸</li><li>è€Œæ˜¯å†æ¬¡å°è¯•å°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ï¼Œå¦‚æœè¿˜å¤±è´¥ï¼Œæ‰æŠ›å‡º RejectedExecutionException å¼‚å¸¸</li></ul></li></ul><div class="tabs" id="08eb1b2a-94d2-4d0c-92b5-acf34fc46e28"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#08eb1b2a-94d2-4d0c-92b5-acf34fc46e28-1"><i class="fas fa-seedling"></i>æºç  tomcat-7.0.42</button></li><li class="tab"><button type="button" data-href="#08eb1b2a-94d2-4d0c-92b5-acf34fc46e28-2"><i class="fas fa-leaf"></i>TaskQueue.java</button></li><li class="tab"><button type="button" data-href="#08eb1b2a-94d2-4d0c-92b5-acf34fc46e28-3"><i class="fab fa-apple"></i>Connector é…ç½®</button></li><li class="tab"><button type="button" data-href="#08eb1b2a-94d2-4d0c-92b5-acf34fc46e28-4"><i class="fas fa-tree"></i>Executor çº¿ç¨‹é…ç½®</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="08eb1b2a-94d2-4d0c-92b5-acf34fc46e28-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command, <span class="type">long</span> timeout, TimeUnit unit)</span> &#123;</span><br><span class="line">    submittedCount.incrementAndGet();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.execute(command);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RejectedExecutionException rx) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">super</span>.getQueue() <span class="keyword">instanceof</span> TaskQueue) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">TaskQueue</span> <span class="variable">queue</span> <span class="operator">=</span> (TaskQueue)<span class="built_in">super</span>.getQueue();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!queue.force(command, timeout, unit)) &#123;</span><br><span class="line">                    submittedCount.decrementAndGet();</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionException</span>(<span class="string">&quot;Queue capacity is full.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException x) &#123;</span><br><span class="line">                submittedCount.decrementAndGet();</span><br><span class="line">                Thread.interrupted();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionException</span>(x);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            submittedCount.decrementAndGet();</span><br><span class="line">            <span class="keyword">throw</span> rx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="08eb1b2a-94d2-4d0c-92b5-acf34fc46e28-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">force</span><span class="params">(Runnable o, <span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">if</span> ( parent.isShutdown() ) </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionException</span>(</span><br><span class="line">        <span class="string">&quot;Executor not running, can&#x27;t force a command into the queue&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.offer(o,timeout,unit); <span class="comment">//forces the item onto the queue, to be used if the task </span></span><br><span class="line">    is rejected</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="08eb1b2a-94d2-4d0c-92b5-acf34fc46e28-3"><table><thead><tr><th style="text-align:center">é…ç½®é¡¹</th><th style="text-align:center">é»˜è®¤å€¼</th><th style="text-align:center">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center"><code>acceptorThreadCount </code></td><td style="text-align:center">1</td><td style="text-align:center">acceptor çº¿ç¨‹æ•°é‡</td></tr><tr><td style="text-align:center"><code>pollerThreadCount</code></td><td style="text-align:center">1</td><td style="text-align:center">poller çº¿ç¨‹æ•°é‡</td></tr><tr><td style="text-align:center"><code>minSpareThreads</code></td><td style="text-align:center">10</td><td style="text-align:center">æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå³ corePoolSize</td></tr><tr><td style="text-align:center"><code>maxThreads</code></td><td style="text-align:center">200</td><td style="text-align:center">æœ€å¤§çº¿ç¨‹æ•°ï¼Œå³ maximumPoolSize</td></tr><tr><td style="text-align:center"><code>executor</code></td><td style="text-align:center">-</td><td style="text-align:center"></td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="08eb1b2a-94d2-4d0c-92b5-acf34fc46e28-4"><table><thead><tr><th style="text-align:center">é…ç½®é¡¹</th><th style="text-align:center">é»˜è®¤å€¼</th><th style="text-align:center">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center"><code>threadPriority</code></td><td style="text-align:center">5</td><td style="text-align:center">çº¿ç¨‹ä¼˜å…ˆçº§</td></tr><tr><td style="text-align:center"><code>daemon</code></td><td style="text-align:center">true</td><td style="text-align:center">æ˜¯å¦å®ˆæŠ¤çº¿ç¨‹</td></tr><tr><td style="text-align:center"><code>minSpareThreads</code></td><td style="text-align:center">25</td><td style="text-align:center">æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå³corePoolSize</td></tr><tr><td style="text-align:center"><code>maxThreads</code></td><td style="text-align:center">200</td><td style="text-align:center">æœ€å¤§çº¿ç¨‹æ•°ï¼Œå³ maximumPoolSize</td></tr><tr><td style="text-align:center"><code>maxIdleTime</code></td><td style="text-align:center">60000</td><td style="text-align:center">çº¿ç¨‹ç”Ÿå­˜æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œé»˜è®¤å€¼å³ 1 åˆ†é’Ÿ</td></tr><tr><td style="text-align:center"><code>maxQueueSize</code></td><td style="text-align:center">Integer.MAX_VALUE</td><td style="text-align:center">é˜Ÿåˆ—é•¿åº¦</td></tr><tr><td style="text-align:center"><code>prestartminSpareThreads</code></td><td style="text-align:center">false</td><td style="text-align:center">æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶å¯åŠ¨</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220312104017979.png" alt="image-20220312104017979"></p><h3 id="2-11-Fork-Join">2.11 Fork/Join</h3><p>Fork/Join æ˜¯ JDK 1.7 åŠ å…¥çš„æ–°çš„çº¿ç¨‹æ± å®ç°ï¼Œå®ƒä½“ç°çš„æ˜¯ä¸€ç§åˆ†æ²»æ€æƒ³ï¼Œé€‚ç”¨äºèƒ½å¤Ÿè¿›è¡Œä»»åŠ¡æ‹†åˆ†çš„ cpu å¯†é›†å‹ è¿ç®—</p><p>æ‰€è°“çš„ä»»åŠ¡æ‹†åˆ†ï¼Œæ˜¯å°†ä¸€ä¸ªå¤§ä»»åŠ¡æ‹†åˆ†ä¸ºç®—æ³•ä¸Šç›¸åŒçš„å°ä»»åŠ¡ï¼Œç›´è‡³ä¸èƒ½æ‹†åˆ†å¯ä»¥ç›´æ¥æ±‚è§£ã€‚è·Ÿé€’å½’ç›¸å…³çš„ä¸€äº›è®¡ç®—ï¼Œå¦‚å½’å¹¶æ’åºã€æ–æ³¢é‚£å¥‘æ•°åˆ—ã€éƒ½å¯ä»¥ç”¨åˆ†æ²»æ€æƒ³è¿›è¡Œæ±‚è§£</p><p>Fork/Join åœ¨åˆ†æ²»çš„åŸºç¡€ä¸ŠåŠ å…¥äº†å¤šçº¿ç¨‹ï¼Œå¯ä»¥æŠŠæ¯ä¸ªä»»åŠ¡çš„åˆ†è§£å’Œåˆå¹¶äº¤ç»™ä¸åŒçš„çº¿ç¨‹æ¥å®Œæˆï¼Œè¿›ä¸€æ­¥æå‡äº†è¿ ç®—æ•ˆç‡</p><p>Fork/Join é»˜è®¤ä¼šåˆ›å»ºä¸ cpu æ ¸å¿ƒæ•°å¤§å°ç›¸åŒçš„çº¿ç¨‹æ± </p><p>æäº¤ç»™ Fork/Join çº¿ç¨‹æ± çš„ä»»åŠ¡éœ€è¦ç»§æ‰¿ RecursiveTaskï¼ˆæœ‰è¿”å›å€¼ï¼‰æˆ– RecursiveActionï¼ˆæ²¡æœ‰è¿”å›å€¼ï¼‰ï¼Œä¾‹å¦‚ä¸‹é¢å®šä¹‰äº†ä¸€ä¸ªå¯¹ 1~n ä¹‹é—´çš„æ•´æ•°æ±‚å’Œçš„ä»»åŠ¡</p><h2 id="3-AQS-åŸç†">3. AQS åŸç†</h2><h3 id="3-1-æ¦‚è¿°">3.1 æ¦‚è¿°</h3><p>å…¨ç§°æ˜¯ AbstractQueuedSynchronizerï¼Œæ˜¯<code>é˜»å¡å¼é”å’Œç›¸å…³çš„åŒæ­¥å™¨å·¥å…·</code>çš„æ¡†æ¶ (å…¶å®ƒçš„åŒæ­¥å™¨éƒ½æ˜¯å®ƒçš„å­ç±»)</p><p>ç‰¹ç‚¹ï¼š</p><ul><li>ç”¨ state å±æ€§æ¥è¡¨ç¤ºèµ„æºçš„çŠ¶æ€ï¼ˆåˆ†ç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼ï¼‰ï¼Œå­ç±»éœ€è¦å®šä¹‰å¦‚ä½•ç»´æŠ¤è¿™ä¸ªçŠ¶æ€ï¼Œæ§åˆ¶å¦‚ä½•è·å– é”å’Œé‡Šæ”¾é”<ul><li>getState - è·å– state çŠ¶æ€</li><li>setState - è®¾ç½® state çŠ¶æ€</li><li>compareAndSetState - cas æœºåˆ¶è®¾ç½® state çŠ¶æ€</li><li>ç‹¬å æ¨¡å¼æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®èµ„æºï¼Œè€Œå…±äº«æ¨¡å¼å¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹è®¿é—®èµ„æº</li></ul></li><li>æä¾›äº†åŸºäº FIFO çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œç±»ä¼¼äº Monitor çš„ EntryList</li><li>æ¡ä»¶å˜é‡æ¥å®ç°ç­‰å¾…ã€å”¤é†’æœºåˆ¶ï¼Œæ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡ï¼Œç±»ä¼¼äº Monitor çš„ WaitSet</li></ul><p>å­ç±»ä¸»è¦å®ç°è¿™æ ·ä¸€äº›æ–¹æ³•ï¼ˆé»˜è®¤æŠ›å‡º UnsupportedOperationExceptionï¼‰</p><ul><li>tryAcquire</li><li>tryRelease</li><li>tryAcquireShared</li><li>tryReleaseShared</li><li>isHeldExclusively</li></ul><div class="tabs" id="c3d3b843-622d-48b5-bc37-a885e1227037"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c3d3b843-622d-48b5-bc37-a885e1227037-1"><i class="fas fa-cat"></i>è·å–é”çš„å§¿åŠ¿</button></li><li class="tab"><button type="button" data-href="#c3d3b843-622d-48b5-bc37-a885e1227037-2"><i class="fas fa-horse"></i>é‡Šæ”¾é”çš„å§¿åŠ¿</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c3d3b843-622d-48b5-bc37-a885e1227037-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœè·å–é”å¤±è´¥</span></span><br><span class="line"><span class="keyword">if</span> (!tryAcquire(arg)) &#123;</span><br><span class="line">    <span class="comment">// å…¥é˜Ÿ, å¯ä»¥é€‰æ‹©é˜»å¡å½“å‰çº¿ç¨‹ park unpark</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c3d3b843-622d-48b5-bc37-a885e1227037-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœé‡Šæ”¾é”æˆåŠŸ</span></span><br><span class="line"><span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">    <span class="comment">// è®©é˜»å¡çº¿ç¨‹æ¢å¤è¿è¡Œ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="3-1-å®ç°ä¸å¯é‡å…¥é”">3.1 å®ç°ä¸å¯é‡å…¥é”</h3><div class="tabs" id="a97c740e-6af2-4303-9a7c-bbf6a3a48fce"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#a97c740e-6af2-4303-9a7c-bbf6a3a48fce-1"><i class="fas fa-atom"></i>è‡ªå®šä¹‰åŒæ­¥å™¨</button></li><li class="tab"><button type="button" data-href="#a97c740e-6af2-4303-9a7c-bbf6a3a48fce-2"><i class="far fa-sun"></i>å®šä¹‰é”</button></li><li class="tab"><button type="button" data-href="#a97c740e-6af2-4303-9a7c-bbf6a3a48fce-3"><i class="fas fa-wind"></i>æµ‹è¯•</button></li><li class="tab"><button type="button" data-href="#a97c740e-6af2-4303-9a7c-bbf6a3a48fce-4"><i class="fas fa-fire-alt"></i>è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="a97c740e-6af2-4303-9a7c-bbf6a3a48fce-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç‹¬å é”  åŒæ­¥å™¨ç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MySync</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="comment">// åŠ ä¸Šäº†é”ï¼Œå¹¶è®¾ç½® owner ä¸ºå½“å‰çº¿ç¨‹</span></span><br><span class="line">            setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">        setState(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// æ˜¯å¦æŒæœ‰ç‹¬å é”</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isHeldExclusively</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getExclusiveOwnerThread() == Thread.currentThread();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Condition <span class="title function_">newCondition</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConditionObject</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a97c740e-6af2-4303-9a7c-bbf6a3a48fce-2"><p>æœ‰äº†è‡ªå®šä¹‰åŒæ­¥å™¨ï¼Œå¾ˆå®¹æ˜“å¤ç”¨ AQS ï¼Œå®ç°ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„è‡ªå®šä¹‰é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyLock</span> <span class="keyword">implements</span> <span class="title class_">Lock</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">MySync</span> <span class="variable">sync</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MySync</span>();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// å°è¯•ï¼Œä¸æˆåŠŸï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// å°è¯•ï¼Œä¸æˆåŠŸï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œå¯æ‰“æ–­</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        sync.acquireInterruptibly(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// å°è¯•ä¸€æ¬¡ï¼Œä¸æˆåŠŸè¿”å›ï¼Œä¸è¿›å…¥é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.tryAcquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// å°è¯•ï¼Œä¸æˆåŠŸï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œæœ‰æ—¶é™</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.tryAcquireNanos(<span class="number">1</span>, unit.toNanos(time));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.release(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// ç”Ÿæˆæ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="keyword">public</span> Condition <span class="title function_">newCondition</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.newCondition();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a97c740e-6af2-4303-9a7c-bbf6a3a48fce-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MyLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyLock</span>();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;locking...&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;unlocking...&quot;</span>);</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;locking...&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;unlocking...&quot;</span>);</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a97c740e-6af2-4303-9a7c-bbf6a3a48fce-4"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">22:29:28.727 c.TestAqs [t1] - locking... </span><br><span class="line">22:29:29.732 c.TestAqs [t1] - unlocking... </span><br><span class="line">22:29:29.732 c.TestAqs [t2] - locking... </span><br><span class="line">22:29:29.732 c.TestAqs [t2] - unlocking... </span><br></pre></td></tr></table></figure><p>ä¸å¯é‡å…¥æµ‹è¯•</p><p>å¦‚æœæ”¹ä¸ºä¸‹é¢ä»£ç ï¼Œä¼šå‘ç°è‡ªå·±ä¹Ÿä¼šè¢«æŒ¡ä½ï¼ˆåªä¼šæ‰“å°ä¸€æ¬¡ lockingï¼‰</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lock.lock();</span><br><span class="line">log.debug(<span class="string">&quot;locking...&quot;</span>);</span><br><span class="line">lock.lock();</span><br><span class="line">log.debug(<span class="string">&quot;locking...&quot;</span>);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">09:<span class="number">43</span>:<span class="number">50.394</span> c.TestAqs [t1] - locking...</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <h3 id="3-2-å¿ƒå¾—">3.2 å¿ƒå¾—</h3><div class="tabs" id="cea555e2-cdb8-4c02-b789-d424b82b74d8"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#cea555e2-cdb8-4c02-b789-d424b82b74d8-1"><i class="fas fa-award"></i>èµ·æº</button></li><li class="tab"><button type="button" data-href="#cea555e2-cdb8-4c02-b789-d424b82b74d8-2"><i class="fas fa-baseball-ball"></i>ç›®æ ‡</button></li><li class="tab"><button type="button" data-href="#cea555e2-cdb8-4c02-b789-d424b82b74d8-3"><i class="fas fa-bone"></i>è®¾è®¡</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="cea555e2-cdb8-4c02-b789-d424b82b74d8-1"><p>æ—©æœŸç¨‹åºå‘˜ä¼šè‡ªå·±é€šè¿‡ä¸€ç§åŒæ­¥å™¨å»å®ç°å¦ä¸€ç§ç›¸è¿‘çš„åŒæ­¥å™¨ï¼Œä¾‹å¦‚ç”¨å¯é‡å…¥é”å»å®ç°ä¿¡å·é‡ï¼Œæˆ–åä¹‹ã€‚è¿™æ˜¾ç„¶ä¸ å¤Ÿä¼˜é›…ï¼Œäºæ˜¯åœ¨ JSR166ï¼ˆjava è§„èŒƒææ¡ˆï¼‰ä¸­åˆ›å»ºäº† AQSï¼Œæä¾›äº†è¿™ç§é€šç”¨çš„åŒæ­¥å™¨æœºåˆ¶ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cea555e2-cdb8-4c02-b789-d424b82b74d8-2"><p>AQS è¦å®ç°çš„åŠŸèƒ½ç›®æ ‡</p><ul><li>é˜»å¡ç‰ˆæœ¬è·å–é” acquire å’Œéé˜»å¡çš„ç‰ˆæœ¬å°è¯•è·å–é” tryAcquire</li><li>è·å–é”è¶…æ—¶æœºåˆ¶</li><li>é€šè¿‡æ‰“æ–­å–æ¶ˆæœºåˆ¶</li><li>ç‹¬å æœºåˆ¶åŠå…±äº«æœºåˆ¶</li><li>æ¡ä»¶ä¸æ»¡è¶³æ—¶çš„ç­‰å¾…æœºåˆ¶</li></ul><p>è¦å®ç°çš„æ€§èƒ½ç›®æ ‡</p><blockquote><p>Instead, the primary performance goal here is scalability: to predictably maintain efficiency even, or especially, when synchronizers are contended.</p></blockquote><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cea555e2-cdb8-4c02-b789-d424b82b74d8-3"><p>AQS çš„åŸºæœ¬æ€æƒ³å…¶å®å¾ˆç®€å•</p><p>è·å–é”çš„é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(state çŠ¶æ€ä¸å…è®¸è·å–) &#123;</span><br><span class="line">    <span class="keyword">if</span>(é˜Ÿåˆ—ä¸­è¿˜æ²¡æœ‰æ­¤çº¿ç¨‹) &#123;</span><br><span class="line">        å…¥é˜Ÿå¹¶é˜»å¡</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">å½“å‰çº¿ç¨‹å‡ºé˜Ÿ</span><br></pre></td></tr></table></figure><p>é‡Šæ”¾é”çš„é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(state çŠ¶æ€å…è®¸äº†) &#123;</span><br><span class="line">    æ¢å¤é˜»å¡çš„çº¿ç¨‹(s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¦ç‚¹</p><ul><li>åŸå­ç»´æŠ¤ state çŠ¶æ€</li><li>é˜»å¡åŠæ¢å¤çº¿ç¨‹</li><li>ç»´æŠ¤é˜Ÿåˆ—</li></ul><ol><li>state è®¾è®¡<ul><li>state ä½¿ç”¨ volatile é…åˆ cas ä¿è¯å…¶ä¿®æ”¹æ—¶çš„åŸå­æ€§</li><li>state ä½¿ç”¨äº† 32bit int æ¥ç»´æŠ¤åŒæ­¥çŠ¶æ€ï¼Œå› ä¸ºå½“æ—¶ä½¿ç”¨ long åœ¨å¾ˆå¤šå¹³å°ä¸‹æµ‹è¯•çš„ç»“æœå¹¶ä¸ç†æƒ³</li></ul></li></ol><ol start="2"><li>é˜»å¡æ¢å¤è®¾è®¡<ul><li>æ—©æœŸçš„æ§åˆ¶çº¿ç¨‹æš‚åœå’Œæ¢å¤çš„ api æœ‰ suspend å’Œ resumeï¼Œä½†å®ƒä»¬æ˜¯ä¸å¯ç”¨çš„ï¼Œå› ä¸ºå¦‚æœå…ˆè°ƒç”¨çš„ resume  é‚£ä¹ˆ suspend å°†æ„ŸçŸ¥ä¸åˆ°</li><li>è§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨ park &amp; unpark æ¥å®ç°çº¿ç¨‹çš„æš‚åœå’Œæ¢å¤ï¼Œå…·ä½“åŸç†åœ¨ä¹‹å‰è®²è¿‡äº†ï¼Œå…ˆ unpark å† park ä¹Ÿæ²¡ é—®é¢˜</li><li>park &amp; unpark æ˜¯é’ˆå¯¹çº¿ç¨‹çš„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹åŒæ­¥å™¨çš„ï¼Œå› æ­¤æ§åˆ¶ç²’åº¦æ›´ä¸ºç²¾ç»†</li><li>park çº¿ç¨‹è¿˜å¯ä»¥é€šè¿‡ interrupt æ‰“æ–­</li></ul></li><li>é˜Ÿåˆ—è®¾è®¡<ul><li>ä½¿ç”¨äº† FIFO å…ˆå…¥å…ˆå‡ºé˜Ÿåˆ—ï¼Œå¹¶ä¸æ”¯æŒä¼˜å…ˆçº§é˜Ÿåˆ—</li><li>è®¾è®¡æ—¶å€Ÿé‰´äº† CLH é˜Ÿåˆ—ï¼Œå®ƒæ˜¯ä¸€ç§å•å‘æ— é”é˜Ÿåˆ—</li></ul></li></ol><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220312234238685.png" alt="image-20220312234238685"></p><p>é˜Ÿåˆ—ä¸­æœ‰ head å’Œ tail ä¸¤ä¸ªæŒ‡é’ˆèŠ‚ç‚¹ï¼Œéƒ½ç”¨ volatile ä¿®é¥°é…åˆ cas ä½¿ç”¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹æœ‰ state ç»´æŠ¤èŠ‚ç‚¹çŠ¶æ€ å…¥é˜Ÿä¼ªä»£ç ï¼Œåªéœ€è¦è€ƒè™‘ tail èµ‹å€¼çš„åŸå­æ€§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment">// åŸæ¥çš„ tail</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">prev</span> <span class="operator">=</span> tail;</span><br><span class="line">    <span class="comment">// ç”¨ cas åœ¨åŸæ¥ tail çš„åŸºç¡€ä¸Šæ”¹ä¸º node</span></span><br><span class="line">&#125; <span class="keyword">while</span>(tail.compareAndSet(prev, node))</span><br></pre></td></tr></table></figure><p>å‡ºé˜Ÿä¼ªä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// prev æ˜¯ä¸Šä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">while</span>((Node prev=node.prev).state != å”¤é†’çŠ¶æ€) &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è®¾ç½®å¤´èŠ‚ç‚¹</span></span><br><span class="line">head = node;</span><br></pre></td></tr></table></figure><p>CLH å¥½å¤„ï¼š</p><ul><li>æ— é”ï¼Œä½¿ç”¨è‡ªæ—‹</li><li>å¿«é€Ÿï¼Œæ— é˜»å¡</li></ul><p>AQS åœ¨ä¸€äº›æ–¹é¢æ”¹è¿›äº† CLH</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Node <span class="title function_">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="comment">// é˜Ÿåˆ—ä¸­è¿˜æ²¡æœ‰å…ƒç´  tail ä¸º null</span></span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å°† head ä» null -&gt; dummy</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> <span class="title class_">Node</span>()))</span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å°† node çš„ prev è®¾ç½®ä¸ºåŸæ¥çš„ tail</span></span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="comment">// å°† tail ä»åŸæ¥çš„ tail è®¾ç½®ä¸º node</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                <span class="comment">// åŸæ¥ tail çš„ next è®¾ç½®ä¸º node</span></span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <p>ä¸»è¦ç”¨åˆ° AQS çš„å¹¶å‘å·¥å…·ç±»</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220312235232687.png" alt="image-20220312235232687"></p><h2 id="4-ReentrantLock-åŸç†">4. ReentrantLock åŸç†</h2><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220312235320716.png" alt="image-20220312235320716" style="zoom:50%;" /><h3 id="4-1-éå…¬å¹³é”å®ç°åŸç†">4.1 éå…¬å¹³é”å®ç°åŸç†</h3><p><strong>åŠ é”è§£é”æµç¨‹</strong></p><div class="tabs" id="ab54601b-f609-4d3b-9625-e89aec82e01c"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ab54601b-f609-4d3b-9625-e89aec82e01c-1"><i class="fas fa-bug"></i>åŠ é”æˆåŠŸ</button></li><li class="tab"><button type="button" data-href="#ab54601b-f609-4d3b-9625-e89aec82e01c-2"><i class="fas fa-cannabis"></i>åŠ é”å¤±è´¥1</button></li><li class="tab"><button type="button" data-href="#ab54601b-f609-4d3b-9625-e89aec82e01c-3"><i class="fas fa-candy-cane"></i>åŠ é”å¤±è´¥2</button></li><li class="tab"><button type="button" data-href="#ab54601b-f609-4d3b-9625-e89aec82e01c-4"><i class="fas fa-child"></i>è§£é”ç«äº‰æˆåŠŸ</button></li><li class="tab"><button type="button" data-href="#ab54601b-f609-4d3b-9625-e89aec82e01c-5"><i class="fas fa-seedling"></i>è§£é”ç«äº‰å¤±è´¥</button></li><li class="tab"><button type="button" data-href="#ab54601b-f609-4d3b-9625-e89aec82e01c-6"><i class="fas fa-leaf"></i>åŠ é”æºç </button></li><li class="tab"><button type="button" data-href="#ab54601b-f609-4d3b-9625-e89aec82e01c-7"><i class="fab fa-apple"></i>è§£é”æºç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ab54601b-f609-4d3b-9625-e89aec82e01c-1"><p>å…ˆä»æ„é€ å™¨å¼€å§‹çœ‹ï¼Œé»˜è®¤ä¸ºéå…¬å¹³é”å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantLock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync = <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NonfairSync ç»§æ‰¿è‡ª AQS</p><p>æ²¡æœ‰ç«äº‰æ—¶</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314153311208.png" alt="image-20220314153311208" style="zoom: 67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ab54601b-f609-4d3b-9625-e89aec82e01c-2"><p>ç¬¬ä¸€ä¸ªç«äº‰å‡ºç°æ—¶</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314153333551.png" alt="image-20220314153333551" style="zoom: 67%;" /><p>Thread-1 æ‰§è¡Œäº†</p><ol><li>CAS å°è¯•å°† state ç”± 0 æ”¹ä¸º 1ï¼Œç»“æœå¤±è´¥</li><li>è¿›å…¥ tryAcquire é€»è¾‘ï¼Œå†å°è¯•åŠ é”ï¼Œè¿™æ—¶ state å·²ç»æ˜¯1ï¼Œç»“æœä»ç„¶å¤±è´¥</li><li>æ¥ä¸‹æ¥è¿›å…¥ addWaiter é€»è¾‘ï¼Œæ„é€  Node é˜Ÿåˆ—<ul><li>å›¾ä¸­é»„è‰²ä¸‰è§’è¡¨ç¤ºè¯¥ Node çš„ waitStatus çŠ¶æ€ï¼Œå…¶ä¸­ 0 ä¸ºé»˜è®¤æ­£å¸¸çŠ¶æ€</li><li>Node çš„åˆ›å»ºæ˜¯æ‡’æƒ°çš„</li><li>å…¶ä¸­ç¬¬ä¸€ä¸ª Node ç§°ä¸º Dummyï¼ˆå“‘å…ƒï¼‰æˆ–å“¨å…µï¼Œç”¨æ¥å ä½ï¼Œå¹¶ä¸å…³è”çº¿ç¨‹</li></ul></li></ol><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314153434087.png" alt="image-20220314153434087" style="zoom: 67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ab54601b-f609-4d3b-9625-e89aec82e01c-3"><p>å½“å‰çº¿ç¨‹è¿›å…¥ acquireQueued é€»è¾‘</p><ol><li>acquireQueued ä¼šåœ¨ä¸€ä¸ªæ­»å¾ªç¯ä¸­ä¸æ–­å°è¯•è·å¾—é”ï¼Œå¤±è´¥åè¿›å…¥ park é˜»å¡</li><li>å¦‚æœè‡ªå·±æ˜¯ç´§é‚»ç€ headï¼ˆæ’ç¬¬äºŒä½ï¼‰ï¼Œé‚£ä¹ˆå†æ¬¡ tryAcquire å°è¯•è·å–é”ï¼Œå½“ç„¶è¿™æ—¶ state ä»ä¸º 1ï¼Œå¤±è´¥</li><li>è¿›å…¥ shouldParkAfterFailedAcquire é€»è¾‘ï¼Œå°†å‰é©± nodeï¼Œå³ head çš„ waitStatus æ”¹ä¸º -1(-1è¡¨ç¤ºä½ æœ‰è´£ä»»å”¤é†’åç»§èŠ‚ç‚¹)ï¼Œè¿™æ¬¡è¿”å› false<img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314153526384.png" alt="image-20220314153526384" style="zoom: 67%;" /></li><li>shouldParkAfterFailedAcquire æ‰§è¡Œå®Œæ¯•å›åˆ° acquireQueued ï¼Œå†æ¬¡ tryAcquire å°è¯•è·å–é”ï¼Œå½“ç„¶è¿™æ—¶ state ä»ä¸º 1ï¼Œå¤±è´¥</li><li>å½“å†æ¬¡è¿›å…¥ shouldParkAfterFailedAcquire æ—¶ï¼Œè¿™æ—¶å› ä¸ºå…¶å‰é©± node çš„ waitStatus å·²ç»æ˜¯ -1ï¼Œè¿™æ¬¡è¿”å› true</li><li>è¿›å…¥ parkAndCheckInterruptï¼Œ Thread-1 parkï¼ˆç°è‰²è¡¨ç¤ºï¼‰</li></ol><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314153708216.png" alt="image-20220314153708216" style="zoom: 67%;" /><p>å†æ¬¡æœ‰å¤šä¸ªçº¿ç¨‹ç»å†ä¸Šè¿°è¿‡ç¨‹ç«äº‰å¤±è´¥ï¼Œå˜æˆè¿™ä¸ªæ ·å­</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314154029099.png" alt="image-20220314154029099" style="zoom: 67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ab54601b-f609-4d3b-9625-e89aec82e01c-4"><p>Thread-0 é‡Šæ”¾é”ï¼Œè¿›å…¥ tryRelease æµç¨‹ï¼Œå¦‚æœæˆåŠŸ</p><ul><li>è®¾ç½® exclusiveOwnerThread ä¸º null</li><li>state = 0</li></ul><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314153831407.png" alt="image-20220314153831407" style="zoom:67%;" /><p>å½“å‰é˜Ÿåˆ—ä¸ä¸º nullï¼Œå¹¶ä¸” head çš„ waitStatus = -1ï¼Œè¿›å…¥ unparkSuccessor æµç¨‹</p><p>æ‰¾åˆ°é˜Ÿåˆ—ä¸­ç¦» head æœ€è¿‘çš„ä¸€ä¸ª Nodeï¼ˆæ²¡å–æ¶ˆçš„ï¼‰ï¼Œunpark æ¢å¤å…¶è¿è¡Œï¼Œæœ¬ä¾‹ä¸­å³ä¸º Thread-1</p><p>å›åˆ° Thread-1 çš„ acquireQueued æµç¨‹</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314153919958.png" alt="image-20220314153919958" style="zoom:67%;" /><p>å¦‚æœåŠ é”æˆåŠŸï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œä¼šè®¾ç½®</p><ul><li>exclusiveOwnerThread ä¸º Thread-1ï¼Œstate = 1</li><li>head æŒ‡å‘åˆšåˆš Thread-1 æ‰€åœ¨çš„ Nodeï¼Œè¯¥ Node æ¸…ç©º Thread</li><li>åŸæœ¬çš„ head å› ä¸ºä»é“¾è¡¨æ–­å¼€ï¼Œè€Œå¯è¢«åƒåœ¾å›æ”¶</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ab54601b-f609-4d3b-9625-e89aec82e01c-5"><p>å¦‚æœè¿™æ—¶å€™æœ‰å…¶å®ƒçº¿ç¨‹æ¥ç«äº‰ï¼ˆéå…¬å¹³çš„ä½“ç°ï¼‰ï¼Œä¾‹å¦‚è¿™æ—¶æœ‰ Thread-4 æ¥äº†</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314154048958.png" alt="image-20220314154048958" style="zoom:67%;" /><p>å¦‚æœä¸å·§åˆè¢« Thread-4 å äº†å…ˆ</p><ul><li>Thread-4 è¢«è®¾ç½®ä¸º exclusiveOwnerThreadï¼Œstate = 1</li><li>Thread-1 å†æ¬¡è¿›å…¥ acquireQueued æµç¨‹ï¼Œè·å–é”å¤±è´¥ï¼Œé‡æ–°è¿›å…¥ park é˜»å¡</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ab54601b-f609-4d3b-9625-e89aec82e01c-6"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sync ç»§æ‰¿è‡ª AQS</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">7316153563782823691L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ é”å®ç°</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// é¦–å…ˆç”¨ cas å°è¯•ï¼ˆä»…å°è¯•ä¸€æ¬¡ï¼‰å°† state ä» 0 æ”¹ä¸º 1, å¦‚æœæˆåŠŸè¡¨ç¤ºè·å¾—äº†ç‹¬å é”</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">            setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// å¦‚æœå°è¯•å¤±è´¥ï¼Œè¿›å…¥ ãˆ </span></span><br><span class="line">            acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ  AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="comment">// ãˆ¡ tryAcquire </span></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            !tryAcquire(arg) &amp;&amp;</span><br><span class="line">            <span class="comment">// å½“ tryAcquire è¿”å›ä¸º false æ—¶, å…ˆè°ƒç”¨ addWaiter ãˆ£, æ¥ç€ acquireQueued ãˆ¤</span></span><br><span class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</span><br><span class="line">        ) &#123;</span><br><span class="line">            selfInterrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¡ è¿›å…¥ ãˆ¢</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nonfairTryAcquire(acquires);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¢ Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">nonfairTryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="comment">// å¦‚æœè¿˜æ²¡æœ‰è·å¾—é”</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å°è¯•ç”¨ cas è·å¾—, è¿™é‡Œä½“ç°äº†éå…¬å¹³æ€§: ä¸å»æ£€æŸ¥ AQS é˜Ÿåˆ—</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœå·²ç»è·å¾—äº†é”, çº¿ç¨‹è¿˜æ˜¯å½“å‰çº¿ç¨‹, è¡¨ç¤ºå‘ç”Ÿäº†é”é‡å…¥</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="comment">// state++</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è·å–å¤±è´¥, å›åˆ°è°ƒç”¨å¤„</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ£ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">//å°†å½“å‰nodeåŠ å…¥ç­‰å¾…é˜Ÿåˆ—æœ«å°¾ç­‰å¾…ï¼Œå¹¶è¿”å›å½“å‰node</span></span><br><span class="line">    <span class="keyword">private</span> Node <span class="title function_">addWaiter</span><span class="params">(Node mode)</span> &#123;</span><br><span class="line">        <span class="comment">// å°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºç‹¬å æ¨¡å¼</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), mode);</span><br><span class="line">        <span class="comment">//éå…¬å¹³åŒæ­¥å™¨ä¸­æœ‰headå’Œtailä¸¤ä¸ªå¼•ç”¨åˆ†åˆ«æŒ‡å‘äº†ç­‰å¾…é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">//predæŒ‡çš„æ˜¯nodeçš„å‰é©±ï¼Œä»é˜Ÿå°¾æ’å…¥ï¼Œæ‰€ä»¥predä¸ºtail</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">pred</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="comment">// å¦‚æœ tail ä¸ä¸º null, è¯´æ˜å·²ç»æœ‰äº†ç­‰å¾…é˜Ÿåˆ—äº†ï¼Œcas å°è¯•å°† Node å¯¹è±¡åŠ å…¥ AQS é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">        <span class="keyword">if</span> (pred != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//å°†nodeçš„å‰é©±èŠ‚ç‚¹è®¾ç½®ä¸ºpred</span></span><br><span class="line">            node.prev = pred;</span><br><span class="line">            <span class="comment">//å°è¯•å°†é˜Ÿåˆ—çš„tialä»å½“å‰çš„predä¿®æ”¹ä¸ºnode</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">                <span class="comment">// åŒå‘é“¾è¡¨</span></span><br><span class="line">                pred.next = node;</span><br><span class="line">                <span class="keyword">return</span> node;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœpredä¸ºnullï¼Œè¯´æ˜ç­‰å¾…é˜Ÿåˆ—è¿˜æœªåˆ›å»ºï¼Œè°ƒç”¨enqæ–¹æ³•åˆ›å»ºé˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">// å°è¯•å°† Node åŠ å…¥ AQS, è¿›å…¥ ãˆ¥</span></span><br><span class="line">        enq(node);</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¥ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">//è¯¥æ–¹æ³•å°±æ˜¯åˆ›å»ºç­‰å¾…é˜Ÿåˆ—ï¼Œå¹¶å°†nodeæ’å…¥é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚</span></span><br><span class="line">    <span class="keyword">private</span> Node <span class="title function_">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">            <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// è¿˜æ²¡æœ‰, è®¾ç½® head ä¸ºå“¨å…µèŠ‚ç‚¹ï¼ˆä¸å¯¹åº”çº¿ç¨‹ï¼ŒçŠ¶æ€ä¸º 0ï¼‰</span></span><br><span class="line">                <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> <span class="title class_">Node</span>())) &#123;</span><br><span class="line">                    <span class="comment">//å°†headèµ‹å€¼ç»™tailï¼Œheadå’ŒtailåŒæ—¶æŒ‡å‘å“¨å…µèŠ‚ç‚¹</span></span><br><span class="line">                    tail = head;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// cas å°è¯•å°† Node å¯¹è±¡åŠ å…¥ AQS é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">                <span class="comment">//è®¾ç½®nodeçš„å‰é©±èŠ‚ç‚¹ä¸ºé˜Ÿåˆ—çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                node.prev = t;</span><br><span class="line">                <span class="comment">//å°è¯•å°†é˜Ÿåˆ—çš„å°¾éƒ¨ä»å½“å‰çš„tailè®¾ç½®ä¸ºnode</span></span><br><span class="line">                <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                    <span class="comment">//å°†nodeè®¾ä¸ºä¸Šä¸€ä¸ªtailçš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">                    t.next = node;</span><br><span class="line">                    <span class="keyword">return</span> t;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¤ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">//åœ¨é˜Ÿåˆ—ä¸­å¾ªç¯ç­‰å¾…ï¼Œåªæœ‰å½“æ’é˜Ÿæ’åˆ°ç¬¬ä¸€åå¹¶ä¸”è·å¾—äº†é”æ‰èƒ½å‡ºé˜Ÿå¹¶ä»æ–¹æ³•ä¸­é€€å‡ºã€‚</span></span><br><span class="line">    <span class="comment">//è¿”å›æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="comment">//æ‰¾åˆ°å½“å‰nodeçš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">                <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯ head, è¡¨ç¤ºè½®åˆ°è‡ªå·±ï¼ˆå½“å‰çº¿ç¨‹å¯¹åº”çš„ nodeï¼‰äº†, å°è¯•è·å–</span></span><br><span class="line">                <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                    <span class="comment">// è·å–æˆåŠŸ, è®¾ç½®è‡ªå·±ï¼ˆå½“å‰çº¿ç¨‹å¯¹åº”çš„ nodeï¼‰ä¸º head</span></span><br><span class="line">                    setHead(node);</span><br><span class="line">                    <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹ help GC</span></span><br><span class="line">                    p.next = <span class="literal">null</span>;</span><br><span class="line">                    failed = <span class="literal">false</span>;</span><br><span class="line">                    <span class="comment">// è¿”å›ä¸­æ–­æ ‡è®° false</span></span><br><span class="line">                    <span class="keyword">return</span> interrupted;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                    <span class="comment">// åˆ¤æ–­æ˜¯å¦åº”å½“ park, è¿›å…¥ ãˆ¦</span></span><br><span class="line">                    shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    <span class="comment">// park ç­‰å¾…, æ­¤æ—¶ Node çš„çŠ¶æ€è¢«ç½®ä¸º Node.SIGNAL ãˆ§</span></span><br><span class="line">                    parkAndCheckInterrupt()</span><br><span class="line">                ) &#123;</span><br><span class="line">                    interrupted = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                cancelAcquire(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¦ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">//åˆ¤æ–­acquireå¤±è´¥ä»¥åæ˜¯å¦åº”è¯¥é˜»å¡ç­‰å¾…ã€‚ä»è§„åˆ™ä¸Šæ¥è®²ï¼š</span></span><br><span class="line">    <span class="comment">//1.å¦‚æœå‰é©±èŠ‚ç‚¹éƒ½é˜»å¡äº†ï¼Œé‚£ä¹ˆå½“å‰èŠ‚ç‚¹ä¹Ÿåº”è¯¥é˜»å¡</span></span><br><span class="line">    <span class="comment">//2.å¦‚æœå‰é©±èŠ‚ç‚¹å–æ¶ˆï¼Œé‚£ä¹ˆåº”è¯¥å°†å‰é©±èŠ‚ç‚¹å‰ç§»ï¼Œç›´åˆ°å…¶çŠ¶æ€ä¸ä¸ºå–æ¶ˆä¸ºæ­¢ã€‚</span></span><br><span class="line">    <span class="comment">//3.å¦‚æœå‰ä¸¤ç§æƒ…å†µéƒ½ä¸æ˜¯ï¼Œå°è¯•å°†å‰é©±èŠ‚ç‚¹çŠ¶æ€è®¾ä¸ºSIGNALï¼Œè¿”å›falseï¼ˆä¸ç”¨é˜»å¡ï¼Œç­‰åˆ°ä¸‹æ¬¡åœ¨é˜»å¡ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> pred.waitStatus;</span><br><span class="line">        <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">            <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹éƒ½åœ¨é˜»å¡, é‚£ä¹ˆè‡ªå·±ä¹Ÿé˜»å¡å¥½äº†</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// &gt; 0 è¡¨ç¤ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹å–æ¶ˆ, é‚£ä¹ˆé‡æ„åˆ é™¤å‰é¢æ‰€æœ‰å–æ¶ˆçš„èŠ‚ç‚¹, è¿”å›åˆ°å¤–å±‚å¾ªç¯é‡è¯•</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                node.prev = pred = pred.prev;</span><br><span class="line">            &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">            pred.next = node;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è¿™æ¬¡è¿˜æ²¡æœ‰é˜»å¡</span></span><br><span class="line">            <span class="comment">// ä½†ä¸‹æ¬¡å¦‚æœé‡è¯•ä¸æˆåŠŸ, åˆ™éœ€è¦é˜»å¡ï¼Œè¿™æ—¶éœ€è¦è®¾ç½®ä¸Šä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€ä¸º Node.SIGNAL</span></span><br><span class="line">            compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ§ é˜»å¡å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">parkAndCheckInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">        LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>æ³¨æ„</strong></p><p>æ˜¯å¦éœ€è¦ unpark æ˜¯ç”±å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„ waitStatus == Node.SIGNAL æ¥å†³å®šï¼Œè€Œä¸æ˜¯æœ¬èŠ‚ç‚¹çš„ waitStatus å†³å®š</p></blockquote><p>æ€»ç»“ï¼š</p><ul><li>è°ƒç”¨<code>lock</code>ï¼Œå°è¯•å°†stateä»0ä¿®æ”¹ä¸º1<ul><li>æˆåŠŸï¼šå°†ownerè®¾ä¸ºå½“å‰çº¿ç¨‹</li><li>å¤±è´¥ï¼šè°ƒç”¨<code>acquire</code>-&gt;<code>tryAcquire</code>-&gt;<code>nonfairTryAcquire</code>ï¼Œåˆ¤æ–­state=0åˆ™è·å¾—é”ï¼Œæˆ–è€…stateä¸ä¸º0ä½†å½“å‰çº¿ç¨‹æŒæœ‰é”åˆ™é‡å…¥é”ï¼Œä»¥ä¸Šä¸¤ç§æƒ…å†µ<code>tryAcquire</code>è¿”å›trueï¼Œå‰©ä½™æƒ…å†µè¿”å›falseã€‚<ul><li>trueï¼šè·å¾—é”</li><li>falseï¼šè°ƒç”¨<code>acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</code>,å…¶ä¸­<code>addwiter</code>å°†å…³è”çº¿ç¨‹çš„èŠ‚ç‚¹æ’å…¥AQSé˜Ÿåˆ—å°¾éƒ¨ï¼Œè¿›å…¥<code>acquireQueued</code>ä¸­çš„forå¾ªç¯:<ul><li>å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œå¹¶å°è¯•è·å¾—é”æˆåŠŸï¼Œå°†å½“å‰èŠ‚ç‚¹è®¾ä¸ºå¤´èŠ‚ç‚¹ï¼Œæ¸…é™¤æ­¤èŠ‚ç‚¹ä¿¡æ¯ï¼Œè¿”å›æ‰“æ–­æ ‡è®°ã€‚</li><li>è°ƒç”¨<code>shoudParkAfterFailure</code>,ç¬¬ä¸€æ¬¡è°ƒç”¨è¿”å›falseï¼Œå¹¶å°†å‰é©±èŠ‚ç‚¹æ”¹ä¸º-1ï¼Œç¬¬äºŒæ¬¡å¾ªç¯å¦‚æœå†è¿›å…¥æ­¤æ–¹æ³•ï¼Œä¼šè¿›å…¥é˜»å¡å¹¶æ£€æŸ¥æ‰“æ–­çš„æ–¹æ³•ã€‚</li></ul></li></ul></li></ul></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ab54601b-f609-4d3b-9625-e89aec82e01c-7"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sync ç»§æ‰¿è‡ª AQS</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="comment">// è§£é”å®ç°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.release(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="comment">// å°è¯•é‡Šæ”¾é”, è¿›å…¥ ãˆ </span></span><br><span class="line">        <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">            <span class="comment">// é˜Ÿåˆ—å¤´èŠ‚ç‚¹ unpark</span></span><br><span class="line">            <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head; </span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">                <span class="comment">// é˜Ÿåˆ—ä¸ä¸º null</span></span><br><span class="line">                h != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                <span class="comment">// waitStatus == Node.SIGNAL æ‰éœ€è¦ unpark</span></span><br><span class="line">                h.waitStatus != <span class="number">0</span></span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="comment">// unpark AQS ä¸­ç­‰å¾…çš„çº¿ç¨‹, è¿›å…¥ ãˆ¡</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ  Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">        <span class="comment">// state--</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">        <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// æ”¯æŒé”é‡å…¥, åªæœ‰ state å‡ä¸º 0, æ‰é‡Šæ”¾æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            free = <span class="literal">true</span>;</span><br><span class="line">            setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        setState(c);</span><br><span class="line">        <span class="keyword">return</span> free;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¡ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unparkSuccessor</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœçŠ¶æ€ä¸º Node.SIGNAL å°è¯•é‡ç½®çŠ¶æ€ä¸º 0</span></span><br><span class="line">        <span class="comment">// ä¸æˆåŠŸä¹Ÿå¯ä»¥</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> node.waitStatus;</span><br><span class="line">        <span class="keyword">if</span> (ws &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ‰¾åˆ°éœ€è¦ unpark çš„èŠ‚ç‚¹, ä½†æœ¬èŠ‚ç‚¹ä» AQS é˜Ÿåˆ—ä¸­è„±ç¦», æ˜¯ç”±å”¤é†’èŠ‚ç‚¹å®Œæˆçš„</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">        <span class="comment">// ä¸è€ƒè™‘å·²å–æ¶ˆçš„èŠ‚ç‚¹, ä» AQS é˜Ÿåˆ—ä»åè‡³å‰æ‰¾åˆ°é˜Ÿåˆ—æœ€å‰é¢éœ€è¦ unpark çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            s = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail; t != <span class="literal">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">                <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                    s = t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (s != <span class="literal">null</span>)</span><br><span class="line">            LockSupport.unpark(s.thread);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ï¼š</p><ul><li><code>unlock</code>-&gt;<code>syn.release</code>(1)-&gt;<code>tryRelease</code>(1),å¦‚æœå½“å‰çº¿ç¨‹å¹¶ä¸æŒæœ‰é”ï¼ŒæŠ›å¼‚å¸¸ã€‚stateå‡å»1,å¦‚æœä¹‹åstateä¸º0ï¼Œè§£é”æˆåŠŸï¼Œè¿”å›trueï¼›å¦‚æœä»å¤§äº0ï¼Œè¡¨ç¤ºè§£é”ä¸å®Œå…¨ï¼Œå½“å‰çº¿ç¨‹ä¾æ—§æŒæœ‰é”ï¼Œè¿”å›falseã€‚</li><li>è¿”å›trueï¼šæ£€æŸ¥AQSé˜Ÿåˆ—ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€å›¾æ˜¯å¦ä¸º<code>SIGNAL</code>(æ„å‘³ç€æœ‰è´£ä»»å”¤é†’å…¶åè®°èŠ‚ç‚¹)ï¼Œå¦‚æœæœ‰ï¼Œè°ƒç”¨<code>unparkSuccessor</code>ã€‚<ul><li>å†<code>unparkSuccessor</code>ä¸­ï¼Œä¸è€ƒè™‘å·²å–æ¶ˆçš„èŠ‚ç‚¹, ä» AQS é˜Ÿåˆ—ä»åè‡³å‰æ‰¾åˆ°é˜Ÿåˆ—æœ€å‰é¢éœ€è¦ unpark çš„èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰ï¼Œå°†å…¶å”¤é†’ã€‚</li></ul></li><li>è¿”å›falseï¼š</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="4-2-å¯é‡å…¥åŸç†">4.2 å¯é‡å…¥åŸç†</h3><p>å½“æŒæœ‰é”çš„çº¿ç¨‹å†æ¬¡å°è¯•è·å–é”æ—¶ï¼Œä¼šå°†stateçš„å€¼åŠ 1ï¼Œstateè¡¨ç¤ºé”çš„é‡å…¥é‡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">nonfairTryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœå·²ç»è·å¾—äº†é”, çº¿ç¨‹è¿˜æ˜¯å½“å‰çº¿ç¨‹, è¡¨ç¤ºå‘ç”Ÿäº†é”é‡å…¥</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="comment">// state++</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">        <span class="comment">// state-- </span></span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">        <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// æ”¯æŒé”é‡å…¥, åªæœ‰ state å‡ä¸º 0, æ‰é‡Šæ”¾æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            free = <span class="literal">true</span>;</span><br><span class="line">            setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        setState(c);</span><br><span class="line">        <span class="keyword">return</span> free;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-3-å¯æ‰“æ–­åŸç†">4.3 å¯æ‰“æ–­åŸç†</h3><div class="tabs" id="ae13c790-a91c-4377-b4a7-12544253fdda"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ae13c790-a91c-4377-b4a7-12544253fdda-1"><i class="fas fa-cat"></i>ä¸å¯æ‰“æ–­æ¨¡å¼</button></li><li class="tab"><button type="button" data-href="#ae13c790-a91c-4377-b4a7-12544253fdda-2"><i class="fas fa-horse"></i>å¯æ‰“æ–­æ¨¡å¼</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ae13c790-a91c-4377-b4a7-12544253fdda-1"><p>åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œå³ä½¿å®ƒè¢«æ‰“æ–­ï¼Œä»ä¼šé©»ç•™åœ¨ AQS é˜Ÿåˆ—ä¸­ï¼Œå¹¶å°†æ‰“æ–­ä¿¡å·å­˜å‚¨åœ¨ä¸€ä¸ªinterruptå˜é‡ä¸­ã€‚ä¸€ç›´è¦ç­‰åˆ°è·å¾—é”åæ–¹èƒ½å¾—çŸ¥è‡ªå·±è¢«æ‰“æ–­äº†,å¹¶ä¸”è°ƒç”¨<code>selfInterrupt</code>æ–¹æ³•æ‰“æ–­è‡ªå·±ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sync ç»§æ‰¿è‡ª AQS</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">parkAndCheckInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯ true, åˆ™ park ä¼šå¤±æ•ˆ</span></span><br><span class="line">        LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">// interrupted ä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°</span></span><br><span class="line">        <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">                <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                    setHead(node);</span><br><span class="line">                    p.next = <span class="literal">null</span>;</span><br><span class="line">                    failed = <span class="literal">false</span>;</span><br><span class="line">                    <span class="comment">// è¿˜æ˜¯éœ€è¦è·å¾—é”å, æ‰èƒ½è¿”å›æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">                    <span class="keyword">return</span> interrupted;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                    shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    parkAndCheckInterrupt()</span><br><span class="line">                ) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœæ˜¯å› ä¸º interrupt è¢«å”¤é†’, è¿”å›æ‰“æ–­çŠ¶æ€ä¸º true</span></span><br><span class="line">                    interrupted = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                cancelAcquire(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            !tryAcquire(arg) &amp;&amp;</span><br><span class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ‰“æ–­çŠ¶æ€ä¸º true</span></span><br><span class="line">            selfInterrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å“åº”æ‰“æ–­æ ‡è®°ï¼Œæ‰“æ–­è‡ªå·±</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">selfInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// é‡æ–°äº§ç”Ÿä¸€æ¬¡ä¸­æ–­</span></span><br><span class="line">        Thread.currentThread().interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ae13c790-a91c-4377-b4a7-12544253fdda-2"><p>æ­¤æ¨¡å¼ä¸‹å³ä½¿çº¿ç¨‹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œä¸€æ—¦è¢«æ‰“æ–­ï¼Œå°±ä¼šç«‹åˆ»æŠ›å‡ºæ‰“æ–­å¼‚å¸¸ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰è·å¾—åˆ°é”, è¿›å…¥ ãˆ </span></span><br><span class="line">        <span class="keyword">if</span> (!tryAcquire(arg))</span><br><span class="line">            doAcquireInterruptibly(arg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ  å¯æ‰“æ–­çš„è·å–é”æµç¨‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.EXCLUSIVE);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">                <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                    setHead(node);</span><br><span class="line">                    p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    failed = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    parkAndCheckInterrupt()) &#123;</span><br><span class="line">                    <span class="comment">// åœ¨ park è¿‡ç¨‹ä¸­å¦‚æœè¢« interrupt ä¼šè¿›å…¥æ­¤</span></span><br><span class="line">                    <span class="comment">// è¿™æ—¶å€™æŠ›å‡ºå¼‚å¸¸, è€Œä¸ä¼šå†æ¬¡è¿›å…¥ for (;;)</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                cancelAcquire(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="4-4-å…¬å¹³é”å®ç°åŸç†">4.4 å…¬å¹³é”å®ç°åŸç†</h3><p>ç®€è€Œè¨€ä¹‹ï¼Œå…¬å¹³ä¸éå…¬å¹³çš„åŒºåˆ«åœ¨äºï¼Œå…¬å¹³é”ä¸­çš„tryAcquireæ–¹æ³•è¢«é‡å†™äº†ï¼Œæ–°æ¥çš„çº¿ç¨‹å³ä¾¿å¾—çŸ¥äº†é”çš„stateä¸º0ï¼Œä¹Ÿè¦å…ˆåˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—ä¸­æ˜¯å¦è¿˜æœ‰çº¿ç¨‹ç­‰å¾…ï¼Œåªæœ‰å½“é˜Ÿåˆ—æ²¡æœ‰çº¿ç¨‹ç­‰å¾…å¼ï¼Œæ‰è·å¾—é”ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">3000897897090466540L</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            !tryAcquire(arg) &amp;&amp;</span><br><span class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</span><br><span class="line">        ) &#123;</span><br><span class="line">            selfInterrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸éå…¬å¹³é”ä¸»è¦åŒºåˆ«åœ¨äº tryAcquire æ–¹æ³•çš„å®ç°</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å…ˆæ£€æŸ¥ AQS é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹, æ²¡æœ‰æ‰å»ç«äº‰</span></span><br><span class="line">            <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">                compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ  AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">//å­˜ç–‘</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">hasQueuedPredecessors</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        Node s;</span><br><span class="line">        <span class="comment">// h != t æ—¶è¡¨ç¤ºé˜Ÿåˆ—ä¸­æœ‰ Node</span></span><br><span class="line">        <span class="keyword">return</span> h != t &amp;&amp;</span><br><span class="line">            (</span><br><span class="line">            <span class="comment">// (s = h.next) == null è¡¨ç¤ºé˜Ÿåˆ—ä¸­è¿˜æœ‰æ²¡æœ‰è€äºŒ</span></span><br><span class="line">            (s = h.next) == <span class="literal">null</span> ||</span><br><span class="line">            <span class="comment">// æˆ–è€…é˜Ÿåˆ—ä¸­è€äºŒçº¿ç¨‹ä¸æ˜¯æ­¤çº¿ç¨‹</span></span><br><span class="line">            s.thread != Thread.currentThread()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-5-æ¡ä»¶å˜é‡å®ç°åŸç†">4.5 æ¡ä»¶å˜é‡å®ç°åŸç†</h3><p>æ¯ä¸ªæ¡ä»¶å˜é‡å…¶å®å°±å¯¹åº”ç€ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œå…¶å®ç°ç±»æ˜¯ ConditionObject</p><p><strong>awaitæµç¨‹</strong></p><div class="tabs" id="4b85b845-bd90-4107-aac7-bcd4f7b1d25a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#4b85b845-bd90-4107-aac7-bcd4f7b1d25a-1"><i class="fas fa-atom"></i>1</button></li><li class="tab"><button type="button" data-href="#4b85b845-bd90-4107-aac7-bcd4f7b1d25a-2"><i class="far fa-sun"></i>2</button></li><li class="tab"><button type="button" data-href="#4b85b845-bd90-4107-aac7-bcd4f7b1d25a-3"><i class="fas fa-wind"></i>3</button></li><li class="tab"><button type="button" data-href="#4b85b845-bd90-4107-aac7-bcd4f7b1d25a-4"><i class="fas fa-fire-alt"></i>4</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="4b85b845-bd90-4107-aac7-bcd4f7b1d25a-1"><p>å¼€å§‹ Thread-0 æŒæœ‰é”ï¼Œè°ƒç”¨ awaitï¼Œè¿›å…¥ ConditionObject çš„ addConditionWaiter æµç¨‹</p><p>åˆ›å»ºæ–°çš„ Node çŠ¶æ€ä¸º -2ï¼ˆNode.CONDITIONï¼‰ï¼Œå…³è” Thread-0ï¼ŒåŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314171543622.png" alt="image-20220314171543622" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4b85b845-bd90-4107-aac7-bcd4f7b1d25a-2"><p>æ¥ä¸‹æ¥è¿›å…¥ AQS çš„ fullyRelease æµç¨‹ï¼Œé‡Šæ”¾åŒæ­¥å™¨ä¸Šçš„é”</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314171600661.png" alt="image-20220314171600661" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4b85b845-bd90-4107-aac7-bcd4f7b1d25a-3"><p>unpark AQS é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç«äº‰é”ï¼Œå‡è®¾æ²¡æœ‰å…¶ä»–ç«äº‰çº¿ç¨‹ï¼Œé‚£ä¹ˆ Thread-1 ç«äº‰æˆåŠŸ</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314171619415.png" alt="image-20220314171619415" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4b85b845-bd90-4107-aac7-bcd4f7b1d25a-4"><p>park é˜»å¡ Thread-0</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314171637949.png" alt="image-20220314171637949" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <p>æ€»ç»“ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œå…³è”å½“å‰çº¿ç¨‹ï¼Œå¹¶æ’å…¥åˆ°å½“å‰Conditioné˜Ÿåˆ—çš„å°¾éƒ¨</li><li>è°ƒç”¨<code>fullRelease</code>ï¼Œå®Œå…¨é‡Šæ”¾åŒæ­¥å™¨ä¸­çš„é”ï¼Œå¹¶è®°å½•å½“å‰çº¿ç¨‹çš„é”é‡å…¥æ•°</li><li>å”¤é†’(park)AQSé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹</li><li>è°ƒç”¨parkæ–¹æ³•ï¼Œé˜»å¡å½“å‰çº¿ç¨‹ã€‚</li></ul><p><strong>signal æµç¨‹</strong></p><div class="tabs" id="32f53e83-10f0-4e18-bb38-c3ee28eb6cb2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#32f53e83-10f0-4e18-bb38-c3ee28eb6cb2-1"><i class="fas fa-award"></i>1</button></li><li class="tab"><button type="button" data-href="#32f53e83-10f0-4e18-bb38-c3ee28eb6cb2-2"><i class="fas fa-baseball-ball"></i>2</button></li><li class="tab"><button type="button" data-href="#32f53e83-10f0-4e18-bb38-c3ee28eb6cb2-3"><i class="fas fa-bone"></i>3</button></li><li class="tab"><button type="button" data-href="#32f53e83-10f0-4e18-bb38-c3ee28eb6cb2-4"><i class="fas fa-anchor"></i>æºç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="32f53e83-10f0-4e18-bb38-c3ee28eb6cb2-1"><p>å‡è®¾ Thread-1 è¦æ¥å”¤é†’ Thread-0</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314171703144.png" alt="image-20220314171703144" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="32f53e83-10f0-4e18-bb38-c3ee28eb6cb2-2"><p>è¿›å…¥ ConditionObject çš„ doSignal æµç¨‹ï¼Œå–å¾—ç­‰å¾…é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ª Nodeï¼Œå³ Thread-0 æ‰€åœ¨ Node</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314171727397.png" alt="image-20220314171727397" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="32f53e83-10f0-4e18-bb38-c3ee28eb6cb2-3"><p>æ‰§è¡Œ transferForSignal æµç¨‹ï¼Œå°†è¯¥ Node åŠ å…¥ AQS é˜Ÿåˆ—å°¾éƒ¨ï¼Œå°† Thread-0 çš„ waitStatus æ”¹ä¸º 0ï¼ŒThread-3 çš„ waitStatus æ”¹ä¸º -1</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314171749467.png" alt="image-20220314171749467" style="zoom:67%;" /><p>Thread-1 é‡Šæ”¾é”ï¼Œè¿›å…¥ unlock æµç¨‹ï¼Œç•¥</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="32f53e83-10f0-4e18-bb38-c3ee28eb6cb2-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConditionObject</span> <span class="keyword">implements</span> <span class="title class_">Condition</span>, java.io.Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1173984872572414699L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¬¬ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node firstWaiter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€åä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node lastWaiter;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConditionObject</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="comment">// ãˆ  æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> Node <span class="title function_">addConditionWaiter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> lastWaiter;</span><br><span class="line">        <span class="comment">// æ‰€æœ‰å·²å–æ¶ˆçš„ Node ä»é˜Ÿåˆ—é“¾è¡¨åˆ é™¤, è§ ãˆ¡</span></span><br><span class="line">        <span class="keyword">if</span> (t != <span class="literal">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">            unlinkCancelledWaiters();</span><br><span class="line">            t = lastWaiter;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªå…³è”å½“å‰çº¿ç¨‹çš„æ–° Node, æ·»åŠ è‡³é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), Node.CONDITION);</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>)</span><br><span class="line">            firstWaiter = node;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            t.nextWaiter = node;</span><br><span class="line">        lastWaiter = node;</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å”¤é†’ - å°†æ²¡å–æ¶ˆçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è½¬ç§»è‡³ AQS é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doSignal</span><span class="params">(Node first)</span> &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// å·²ç»æ˜¯å°¾èŠ‚ç‚¹äº†</span></span><br><span class="line">            <span class="keyword">if</span> ( (firstWaiter = first.nextWaiter) == <span class="literal">null</span>) &#123;</span><br><span class="line">                lastWaiter = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            first.nextWaiter = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span> (</span><br><span class="line">            <span class="comment">// å°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ Node è½¬ç§»è‡³ AQS é˜Ÿåˆ—, ä¸æˆåŠŸä¸”è¿˜æœ‰èŠ‚ç‚¹åˆ™ç»§ç»­å¾ªç¯ ãˆ¢</span></span><br><span class="line">            !transferForSignal(first) &amp;&amp;</span><br><span class="line">            <span class="comment">// é˜Ÿåˆ—è¿˜æœ‰èŠ‚ç‚¹</span></span><br><span class="line">            (first = firstWaiter) != <span class="literal">null</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤–éƒ¨ç±»æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">// ãˆ¢ å¦‚æœèŠ‚ç‚¹çŠ¶æ€æ˜¯å–æ¶ˆ, è¿”å› false è¡¨ç¤ºè½¬ç§»å¤±è´¥, å¦åˆ™è½¬ç§»æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">transferForSignal</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœçŠ¶æ€å·²ç»ä¸æ˜¯ Node.CONDITION, è¯´æ˜è¢«å–æ¶ˆäº†</span></span><br><span class="line">        <span class="keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// åŠ å…¥ AQS é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> enq(node);</span><br><span class="line">        <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> p.waitStatus;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹è¢«å–æ¶ˆ</span></span><br><span class="line">            ws &gt; <span class="number">0</span> ||</span><br><span class="line">            <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹ä¸èƒ½è®¾ç½®çŠ¶æ€ä¸º Node.SIGNAL</span></span><br><span class="line">            !compareAndSetWaitStatus(p, ws, Node.SIGNAL) </span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// unpark å–æ¶ˆé˜»å¡, è®©çº¿ç¨‹é‡æ–°åŒæ­¥çŠ¶æ€</span></span><br><span class="line">            LockSupport.unpark(node.thread);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…¨éƒ¨å”¤é†’ - ç­‰å¾…é˜Ÿåˆ—çš„æ‰€æœ‰èŠ‚ç‚¹è½¬ç§»è‡³ AQS é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doSignalAll</span><span class="params">(Node first)</span> &#123;</span><br><span class="line">        lastWaiter = firstWaiter = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">next</span> <span class="operator">=</span> first.nextWaiter;</span><br><span class="line">            first.nextWaiter = <span class="literal">null</span>;</span><br><span class="line">            transferForSignal(first);</span><br><span class="line">            first = next;</span><br><span class="line">        &#125; <span class="keyword">while</span> (first != <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlinkCancelledWaiters</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å”¤é†’ - å¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignal å†…æ— éœ€è€ƒè™‘åŠ é”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">signal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        <span class="type">Node</span> <span class="variable">first</span> <span class="operator">=</span> firstWaiter;</span><br><span class="line">        <span class="keyword">if</span> (first != <span class="literal">null</span>)</span><br><span class="line">            doSignal(first);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…¨éƒ¨å”¤é†’ - å¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignalAll å†…æ— éœ€è€ƒè™‘åŠ é”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">signalAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        <span class="type">Node</span> <span class="variable">first</span> <span class="operator">=</span> firstWaiter;</span><br><span class="line">        <span class="keyword">if</span> (first != <span class="literal">null</span>)</span><br><span class="line">            doSignalAll(first);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸å¯æ‰“æ–­ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">awaitUninterruptibly</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—, è§ ãˆ </span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addConditionWaiter();</span><br><span class="line">        <span class="comment">// é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”, è§ ãˆ£</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> fullyRelease(node);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜Ÿåˆ—, é˜»å¡</span></span><br><span class="line">        <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">            <span class="comment">// park é˜»å¡</span></span><br><span class="line">            LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">            <span class="comment">// å¦‚æœè¢«æ‰“æ–­, ä»…è®¾ç½®æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">            <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å”¤é†’å, å°è¯•ç«äº‰é”, å¦‚æœå¤±è´¥è¿›å…¥ AQS é˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">if</span> (acquireQueued(node, savedState) || interrupted)</span><br><span class="line">            selfInterrupt();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doSignalAll</span><span class="params">(Node first)</span> &#123;</span><br><span class="line">        lastWaiter = firstWaiter = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">next</span> <span class="operator">=</span> first.nextWaiter;</span><br><span class="line">            first.nextWaiter = <span class="literal">null</span>;</span><br><span class="line">            transferForSignal(first);</span><br><span class="line">            first = next;</span><br><span class="line">        &#125; <span class="keyword">while</span> (first != <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlinkCancelledWaiters</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å”¤é†’ - å¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignal å†…æ— éœ€è€ƒè™‘åŠ é”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">signal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        <span class="type">Node</span> <span class="variable">first</span> <span class="operator">=</span> firstWaiter;</span><br><span class="line">        <span class="keyword">if</span> (first != <span class="literal">null</span>)</span><br><span class="line">            doSignal(first);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…¨éƒ¨å”¤é†’ - å¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignalAll å†…æ— éœ€è€ƒè™‘åŠ é”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">signalAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        <span class="type">Node</span> <span class="variable">first</span> <span class="operator">=</span> firstWaiter;</span><br><span class="line">        <span class="keyword">if</span> (first != <span class="literal">null</span>)</span><br><span class="line">            doSignalAll(first);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸å¯æ‰“æ–­ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">awaitUninterruptibly</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—, è§ ãˆ </span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addConditionWaiter();</span><br><span class="line">        <span class="comment">// é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”, è§ ãˆ£</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> fullyRelease(node);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜Ÿåˆ—, é˜»å¡</span></span><br><span class="line">        <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">            <span class="comment">// park é˜»å¡</span></span><br><span class="line">            LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">            <span class="comment">// å¦‚æœè¢«æ‰“æ–­, ä»…è®¾ç½®æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">            <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å”¤é†’å, å°è¯•ç«äº‰é”, å¦‚æœå¤±è´¥è¿›å…¥ AQS é˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">if</span> (acquireQueued(node, savedState) || interrupted)</span><br><span class="line">            selfInterrupt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤–éƒ¨ç±»æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">// ãˆ£ å› ä¸ºæŸçº¿ç¨‹å¯èƒ½é‡å…¥ï¼Œéœ€è¦å°† state å…¨éƒ¨é‡Šæ”¾</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">fullyRelease</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> getState();</span><br><span class="line">            <span class="keyword">if</span> (release(savedState)) &#123;</span><br><span class="line">                failed = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">return</span> savedState;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                node.waitStatus = Node.CANCELLED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ‰“æ–­æ¨¡å¼ - åœ¨é€€å‡ºç­‰å¾…æ—¶é‡æ–°è®¾ç½®æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REINTERRUPT</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// æ‰“æ–­æ¨¡å¼ - åœ¨é€€å‡ºç­‰å¾…æ—¶æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THROW_IE</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ‰“æ–­æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">checkInterruptWhileWaiting</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Thread.interrupted() ?</span><br><span class="line">            (transferAfterCancelledWait(node) ? THROW_IE : REINTERRUPT) :</span><br><span class="line">        <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ãˆ¤ åº”ç”¨æ‰“æ–­æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reportInterruptAfterWait</span><span class="params">(<span class="type">int</span> interruptMode)</span></span><br><span class="line">        <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (interruptMode == THROW_IE)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (interruptMode == REINTERRUPT)</span><br><span class="line">            selfInterrupt();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—, è§ ãˆ </span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addConditionWaiter();</span><br><span class="line">        <span class="comment">// é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> fullyRelease(node);</span><br><span class="line">        <span class="type">int</span> <span class="variable">interruptMode</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜Ÿåˆ—, é˜»å¡</span></span><br><span class="line">        <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">            <span class="comment">// park é˜»å¡</span></span><br><span class="line">            LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">            <span class="comment">// å¦‚æœè¢«æ‰“æ–­, é€€å‡ºç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">            <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é€€å‡ºç­‰å¾…é˜Ÿåˆ—å, è¿˜éœ€è¦è·å¾— AQS é˜Ÿåˆ—çš„é”</span></span><br><span class="line">        <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">            interruptMode = REINTERRUPT;</span><br><span class="line">        <span class="comment">// æ‰€æœ‰å·²å–æ¶ˆçš„ Node ä»é˜Ÿåˆ—é“¾è¡¨åˆ é™¤, è§ ãˆ¡</span></span><br><span class="line">        <span class="keyword">if</span> (node.nextWaiter != <span class="literal">null</span>) </span><br><span class="line">            unlinkCancelledWaiters();</span><br><span class="line">        <span class="comment">// åº”ç”¨æ‰“æ–­æ¨¡å¼, è§ ãˆ¤</span></span><br><span class="line">        <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">            reportInterruptAfterWait(interruptMode);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å‘Conditionä¸­çš„ç­‰å¾…é˜Ÿåˆ—ä¸­æ–°å¢èŠ‚ç‚¹ï¼Œå¹¶å°†æ­¤èŠ‚ç‚¹è¿”å›</span></span><br><span class="line">    <span class="keyword">private</span> Node <span class="title function_">addConditionWaiter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> lastWaiter;</span><br><span class="line">        <span class="comment">// If lastWaiter is cancelled, clean out.</span></span><br><span class="line">        <span class="keyword">if</span> (t != <span class="literal">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">            unlinkCancelledWaiters();</span><br><span class="line">            t = lastWaiter;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), Node.CONDITION);</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>)</span><br><span class="line">            firstWaiter = node;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            t.nextWaiter = node;</span><br><span class="line">        lastWaiter = node;</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦åœ¨åŒæ­¥å™¨ä¸­çš„é˜Ÿåˆ—ä¸­ç­‰å¾…é”</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isOnSyncQueue</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (node.waitStatus == Node.CONDITION || node.prev == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (node.next != <span class="literal">null</span>) <span class="comment">// If has successor, it must be on queue</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * node.prev can be non-null, but not yet on queue because</span></span><br><span class="line"><span class="comment">         * the CAS to place it on queue can fail. So we have to</span></span><br><span class="line"><span class="comment">         * traverse from tail to make sure it actually made it.  It</span></span><br><span class="line"><span class="comment">         * will always be near the tail in calls to this method, and</span></span><br><span class="line"><span class="comment">         * unless the CAS failed (which is unlikely), it will be</span></span><br><span class="line"><span class="comment">         * there, so we hardly ever traverse much.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> findNodeFromTail(node);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­æˆ–è¶…æ—¶</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">long</span> <span class="title function_">awaitNanos</span><span class="params">(<span class="type">long</span> nanosTimeout)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—, è§ ãˆ </span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addConditionWaiter();</span><br><span class="line">        <span class="comment">// é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> fullyRelease(node);</span><br><span class="line">        <span class="comment">// è·å¾—æœ€åæœŸé™</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">deadline</span> <span class="operator">=</span> System.nanoTime() + nanosTimeout;</span><br><span class="line">        <span class="type">int</span> <span class="variable">interruptMode</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜Ÿåˆ—, é˜»å¡</span></span><br><span class="line">        <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">            <span class="comment">// å·²è¶…æ—¶, é€€å‡ºç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">            <span class="keyword">if</span> (nanosTimeout &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                transferAfterCancelledWait(node);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// park é˜»å¡ä¸€å®šæ—¶é—´, spinForTimeoutThreshold ä¸º 1000 ns</span></span><br><span class="line">            <span class="keyword">if</span> (nanosTimeout &gt;= spinForTimeoutThreshold)</span><br><span class="line">                LockSupport.parkNanos(<span class="built_in">this</span>, nanosTimeout);</span><br><span class="line">            <span class="comment">// å¦‚æœè¢«æ‰“æ–­, é€€å‡ºç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">            <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            nanosTimeout = deadline - System.nanoTime();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é€€å‡ºç­‰å¾…é˜Ÿåˆ—å, è¿˜éœ€è¦è·å¾— AQS é˜Ÿåˆ—çš„é”</span></span><br><span class="line">        <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">            interruptMode = REINTERRUPT;</span><br><span class="line">        <span class="comment">// æ‰€æœ‰å·²å–æ¶ˆçš„ Node ä»é˜Ÿåˆ—é“¾è¡¨åˆ é™¤, è§ ãˆ¡</span></span><br><span class="line">        <span class="keyword">if</span> (node.nextWaiter != <span class="literal">null</span>)</span><br><span class="line">            unlinkCancelledWaiters();</span><br><span class="line">        <span class="comment">// åº”ç”¨æ‰“æ–­æ¨¡å¼, è§ ãˆ¤</span></span><br><span class="line">        <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">            reportInterruptAfterWait(interruptMode);</span><br><span class="line">        <span class="keyword">return</span> deadline - System.nanoTime();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­æˆ–è¶…æ—¶, é€»è¾‘ç±»ä¼¼äº awaitNanos</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">awaitUntil</span><span class="params">(Date deadline)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­æˆ–è¶…æ—¶, é€»è¾‘ç±»ä¼¼äº awaitNanos</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">await</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å·¥å…·æ–¹æ³• çœç•¥ ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <p>æ€»ç»“ï¼š</p><ul><li>å½“å‰æŒæœ‰é”çš„çº¿ç¨‹å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ï¼Œè°ƒç”¨doSignalæˆ–doSignalAllæ–¹æ³•ï¼Œå°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªï¼ˆæˆ–å…¨éƒ¨ï¼‰èŠ‚ç‚¹æ’å…¥åˆ°AQSé˜Ÿåˆ—ä¸­çš„å°¾éƒ¨ã€‚</li><li>å°†æ’å…¥çš„èŠ‚ç‚¹çš„çŠ¶æ€ä»Conditionè®¾ç½®ä¸º0ï¼Œå°†æ’å…¥èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®ä¸º-1ï¼ˆæ„å‘³ç€è¦æ‰¿æ‹…å”¤é†’åä¸€ä¸ªèŠ‚ç‚¹çš„è´£ä»»ï¼‰</li><li>å½“å‰çº¿ç¨‹é‡Šæ”¾é”ï¼ŒparkAQSé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çº¿ç¨‹ã€‚</li></ul><h2 id="5-è¯»å†™é”">5. è¯»å†™é”</h2><h3 id="5-1-ReentrantReadWriteLock">5.1 ReentrantReadWriteLock</h3><p>å½“è¯»æ“ä½œè¿œè¿œé«˜äºå†™æ“ä½œæ—¶ï¼Œè¿™æ—¶å€™ä½¿ç”¨<code>è¯»å†™é”</code>è®©<code>è¯»-è¯»</code>å¯ä»¥å¹¶å‘ï¼Œæé«˜æ€§èƒ½ã€‚</p><p>ç±»ä¼¼äºæ•°æ®åº“ä¸­çš„<code>select ... from ... lock in share mode</code></p><blockquote><p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯è¯»é”å¯ä»¥å…±äº«ï¼Œä½†æ˜¯å†™é”å¿…é¡»ç‹¬å </p></blockquote><p>ç¤ºä¾‹ï¼šæä¾›ä¸€ä¸ª<code>æ•°æ®å®¹å™¨ç±»</code>å†…éƒ¨åˆ†åˆ«ä½¿ç”¨<code>è¯»é”</code>ä¿æŠ¤æ•°æ®çš„ read() æ–¹æ³•ï¼Œ<code>å†™é”</code>ä¿æŠ¤æ•°æ®çš„ write() æ–¹æ³•<div class="tabs" id="f35d3c3d-bc69-4924-92b2-8243c2220566"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#f35d3c3d-bc69-4924-92b2-8243c2220566-1"><i class="fas fa-bug"></i>ä»£ç </button></li><li class="tab"><button type="button" data-href="#f35d3c3d-bc69-4924-92b2-8243c2220566-2"><i class="fas fa-cannabis"></i>æµ‹è¯•è¯»é”-è¯»é”å¯ä»¥å¹¶å‘</button></li><li class="tab"><button type="button" data-href="#f35d3c3d-bc69-4924-92b2-8243c2220566-3"><i class="fas fa-candy-cane"></i>æµ‹è¯•è¯»é”-å†™é”ç›¸äº’é˜»å¡</button></li><li class="tab"><button type="button" data-href="#f35d3c3d-bc69-4924-92b2-8243c2220566-4"><i class="fas fa-child"></i>æµ‹è¯•å†™é”-å†™é”ç›¸äº’é˜»å¡</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="f35d3c3d-bc69-4924-92b2-8243c2220566-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DataContainer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">ReentrantReadWriteLock</span> <span class="variable">rw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();</span><br><span class="line">    <span class="keyword">private</span> ReentrantReadWriteLock.<span class="type">ReadLock</span> <span class="variable">r</span> <span class="operator">=</span> rw.readLock();</span><br><span class="line">    <span class="keyword">private</span> ReentrantReadWriteLock.<span class="type">WriteLock</span> <span class="variable">w</span> <span class="operator">=</span> rw.writeLock();</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">read</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;è·å–è¯»é”...&quot;</span>);</span><br><span class="line">        r.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;è¯»å–&quot;</span>);</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;é‡Šæ”¾è¯»é”...&quot;</span>);</span><br><span class="line">            r.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;è·å–å†™é”...&quot;</span>);</span><br><span class="line">        w.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å†™å…¥&quot;</span>);</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;é‡Šæ”¾å†™é”...&quot;</span>);</span><br><span class="line">            w.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f35d3c3d-bc69-4924-92b2-8243c2220566-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DataContainer</span> <span class="variable">dataContainer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataContainer</span>();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    dataContainer.read();</span><br><span class="line">&#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    dataContainer.read();</span><br><span class="line">&#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼Œä»è¿™é‡Œå¯ä»¥çœ‹åˆ° Thread-0 é”å®šæœŸé—´ï¼ŒThread-1 çš„è¯»æ“ä½œä¸å—å½±å“</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">14:05:14.341 c.DataContainer [t2] - è·å–è¯»é”... </span><br><span class="line">14:05:14.341 c.DataContainer [t1] - è·å–è¯»é”... </span><br><span class="line">14:05:14.345 c.DataContainer [t1] - è¯»å–</span><br><span class="line">14:05:14.345 c.DataContainer [t2] - è¯»å–</span><br><span class="line">14:05:15.365 c.DataContainer [t2] - é‡Šæ”¾è¯»é”... </span><br><span class="line">14:05:15.386 c.DataContainer [t1] - é‡Šæ”¾è¯»é”... </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f35d3c3d-bc69-4924-92b2-8243c2220566-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DataContainer</span> <span class="variable">dataContainer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataContainer</span>();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    dataContainer.read();</span><br><span class="line">&#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">Thread.sleep(<span class="number">100</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    dataContainer.write();</span><br><span class="line">&#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">21.838</span> c.DataContainer [t1] - è·å–è¯»é”... </span><br><span class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">21.838</span> c.DataContainer [t2] - è·å–å†™é”... </span><br><span class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">21.841</span> c.DataContainer [t2] - å†™å…¥</span><br><span class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">22.843</span> c.DataContainer [t2] - é‡Šæ”¾å†™é”... </span><br><span class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">22.843</span> c.DataContainer [t1] - è¯»å–</span><br><span class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">23.843</span> c.DataContainer [t1] - é‡Šæ”¾è¯»é”... </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f35d3c3d-bc69-4924-92b2-8243c2220566-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DataContainer</span> <span class="variable">dataContainer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataContainer</span>();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    dataContainer.write();</span><br><span class="line">&#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">Thread.sleep(<span class="number">100</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    dataContainer.write();</span><br><span class="line">&#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>:<span class="number">33</span>:<span class="number">52.665</span> c.DataContainer [t1] - è·å–å†™é”...</span><br><span class="line"><span class="number">11</span>:<span class="number">33</span>:<span class="number">52.665</span> c.DataContainer [t2] - è·å–å†™é”...</span><br><span class="line"><span class="number">11</span>:<span class="number">33</span>:<span class="number">52.667</span> c.DataContainer [t2] - å†™å…¥</span><br><span class="line"><span class="number">11</span>:<span class="number">33</span>:<span class="number">53.673</span> c.DataContainer [t2] - é‡Šæ”¾å†™é”...</span><br><span class="line"><span class="number">11</span>:<span class="number">33</span>:<span class="number">53.674</span> c.DataContainer [t1] - å†™å…¥</span><br><span class="line"><span class="number">11</span>:<span class="number">33</span>:<span class="number">54.679</span> c.DataContainer [t1] - é‡Šæ”¾å†™é”...</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></p><p><strong>æ³¨æ„äº‹é¡¹</strong></p><div class="tabs" id="9055eaa3-a964-4954-a6d8-3159462eb4fd"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#9055eaa3-a964-4954-a6d8-3159462eb4fd-1"><i class="fas fa-seedling"></i>1</button></li><li class="tab"><button type="button" data-href="#9055eaa3-a964-4954-a6d8-3159462eb4fd-2"><i class="fas fa-leaf"></i>2</button></li><li class="tab"><button type="button" data-href="#9055eaa3-a964-4954-a6d8-3159462eb4fd-3"><i class="fab fa-apple"></i>3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="9055eaa3-a964-4954-a6d8-3159462eb4fd-1"><p>è¯»é”ä¸æ”¯æŒæ¡ä»¶å˜é‡</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9055eaa3-a964-4954-a6d8-3159462eb4fd-2"><p>é‡å…¥æ—¶å‡çº§ä¸æ”¯æŒï¼šå³æŒæœ‰è¯»é”çš„æƒ…å†µä¸‹å»è·å–å†™é”ï¼Œä¼šå¯¼è‡´è·å–å†™é”æ°¸ä¹…ç­‰å¾…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">r.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    w.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">        w.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">    r.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9055eaa3-a964-4954-a6d8-3159462eb4fd-3"><p>é‡å…¥æ—¶é™çº§æ”¯æŒï¼šå³æŒæœ‰å†™é”çš„æƒ…å†µä¸‹å»è·å–è¯»é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CachedData</span> &#123;</span><br><span class="line">    Object data;</span><br><span class="line">    <span class="comment">// æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœå¤±æ•ˆï¼Œéœ€è¦é‡æ–°è®¡ç®— data</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">boolean</span> cacheValid;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantReadWriteLock</span> <span class="variable">rwl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">processCachedData</span><span class="params">()</span> &#123;</span><br><span class="line">        rwl.readLock().lock();</span><br><span class="line">        <span class="keyword">if</span> (!cacheValid) &#123;</span><br><span class="line">            <span class="comment">// è·å–å†™é”å‰å¿…é¡»é‡Šæ”¾è¯»é”</span></span><br><span class="line">            rwl.readLock().unlock();</span><br><span class="line">            rwl.writeLock().lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// åˆ¤æ–­æ˜¯å¦æœ‰å…¶å®ƒçº¿ç¨‹å·²ç»è·å–äº†å†™é”ã€æ›´æ–°äº†ç¼“å­˜, é¿å…é‡å¤æ›´æ–°</span></span><br><span class="line">                <span class="keyword">if</span> (!cacheValid) &#123;</span><br><span class="line">                    data = ...</span><br><span class="line">                        cacheValid = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// é™çº§ä¸ºè¯»é”, é‡Šæ”¾å†™é”, è¿™æ ·èƒ½å¤Ÿè®©å…¶å®ƒçº¿ç¨‹è¯»å–ç¼“å­˜</span></span><br><span class="line">                rwl.readLock().lock();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                rwl.writeLock().unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è‡ªå·±ç”¨å®Œæ•°æ®, é‡Šæ”¾è¯»é” </span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            use(data);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            rwl.readLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="5-2-è¯»å†™é”åŸç†">5.2 è¯»å†™é”åŸç†</h3><p>å›¾è§£æµç¨‹</p><div class="tabs" id="1a9249ba-6a46-4d14-b45f-183ba5c9fcba"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#1a9249ba-6a46-4d14-b45f-183ba5c9fcba-1"><i class="fas fa-cat"></i>t1 w.lockï¼Œt2 r.lock</button></li><li class="tab"><button type="button" data-href="#1a9249ba-6a46-4d14-b45f-183ba5c9fcba-2"><i class="fas fa-horse"></i>t3 r.lockï¼Œt4 w.lock</button></li><li class="tab"><button type="button" data-href="#1a9249ba-6a46-4d14-b45f-183ba5c9fcba-3"><i class="fas fa-dove"></i>t1 w.unlock</button></li><li class="tab"><button type="button" data-href="#1a9249ba-6a46-4d14-b45f-183ba5c9fcba-4"><i class="fas fa-dragon"></i>t2 r.unlockï¼Œt3 r.unlock</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="1a9249ba-6a46-4d14-b45f-183ba5c9fcba-1"><p>1ï¼‰ t1 æˆåŠŸä¸Šé”ï¼Œæµç¨‹ä¸ ReentrantLock åŠ é”ç›¸æ¯”æ²¡æœ‰ç‰¹æ®Šä¹‹å¤„ï¼Œä¸åŒæ˜¯å†™é”çŠ¶æ€å äº† state çš„ä½ 16 ä½ï¼Œè€Œè¯»é” ä½¿ç”¨çš„æ˜¯ state çš„é«˜ 16 ä½</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314191716969.png" alt="image-20220314191716969" style="zoom: 67%;" /><p>2ï¼‰t2 æ‰§è¡Œ r.lockï¼Œè¿™æ—¶è¿›å…¥è¯»é”çš„ sync.acquireShared(1) æµç¨‹ï¼Œé¦–å…ˆä¼šè¿›å…¥ tryAcquireShared æµç¨‹ã€‚å¦‚æœæœ‰å†™ é”å æ®ï¼Œé‚£ä¹ˆ tryAcquireShared è¿”å› -1 è¡¨ç¤ºå¤±è´¥</p><blockquote><p>tryAcquireShared è¿”å›å€¼è¡¨ç¤º</p><ul><li>-1 è¡¨ç¤ºå¤±è´¥</li><li>0 è¡¨ç¤ºæˆåŠŸï¼Œä½†åç»§èŠ‚ç‚¹ä¸ä¼šç»§ç»­å”¤é†’</li><li>æ­£æ•°è¡¨ç¤ºæˆåŠŸï¼Œè€Œä¸”æ•°å€¼æ˜¯è¿˜æœ‰å‡ ä¸ªåç»§èŠ‚ç‚¹éœ€è¦å”¤é†’ï¼Œè¯»å†™é”è¿”å› 1</li></ul></blockquote><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314191820931.png" alt="image-20220314191820931" style="zoom: 67%;" /><p>3ï¼‰è¿™æ—¶ä¼šè¿›å…¥ sync.doAcquireShared(1) æµç¨‹ï¼Œé¦–å…ˆä¹Ÿæ˜¯è°ƒç”¨ addWaiter æ·»åŠ èŠ‚ç‚¹ï¼Œä¸åŒä¹‹å¤„åœ¨äºèŠ‚ç‚¹è¢«è®¾ç½®ä¸º<code>Node.SHARED</code>æ¨¡å¼è€Œé <code>Node.EXCLUSIVE</code> æ¨¡å¼ï¼Œæ³¨æ„æ­¤æ—¶ t2 ä»å¤„äºæ´»è·ƒçŠ¶æ€</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314191835250.png" alt="image-20220314191835250" style="zoom:67%;" /><p>4ï¼‰t2 ä¼šçœ‹çœ‹è‡ªå·±çš„èŠ‚ç‚¹æ˜¯ä¸æ˜¯è€äºŒï¼Œå¦‚æœæ˜¯ï¼Œè¿˜ä¼šå†æ¬¡è°ƒç”¨ tryAcquireShared(1) æ¥å°è¯•è·å–é”</p><p>5ï¼‰å¦‚æœæ²¡æœ‰æˆåŠŸï¼Œåœ¨ doAcquireShared å†… for (;;) å¾ªç¯ä¸€æ¬¡ï¼ŒæŠŠå‰é©±èŠ‚ç‚¹çš„ waitStatus æ”¹ä¸º -1ï¼Œå† for (;;) å¾ªç¯ä¸€ æ¬¡å°è¯• tryAcquireShared(1) å¦‚æœè¿˜ä¸æˆåŠŸï¼Œé‚£ä¹ˆåœ¨ parkAndCheckInterrupt() å¤„ park</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314191859644.png" alt="image-20220314191859644" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="1a9249ba-6a46-4d14-b45f-183ba5c9fcba-2"><p>è¿™ç§çŠ¶æ€ä¸‹ï¼Œå‡è®¾åˆæœ‰ t3 åŠ è¯»é”å’Œ t4 åŠ å†™é”ï¼Œè¿™æœŸé—´ t1 ä»ç„¶æŒæœ‰é”ï¼Œå°±å˜æˆäº†ä¸‹é¢çš„æ ·å­</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314191927467.png" alt="image-20220314191927467" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="1a9249ba-6a46-4d14-b45f-183ba5c9fcba-3"><p>è¿™æ—¶ä¼šèµ°åˆ°å†™é”çš„ sync.release(1) æµç¨‹ï¼Œè°ƒç”¨ sync.tryRelease(1) æˆåŠŸï¼Œå˜æˆä¸‹é¢çš„æ ·å­</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314191953466.png" alt="image-20220314191953466" style="zoom:67%;" /><p>æ¥ä¸‹æ¥æ‰§è¡Œå”¤é†’æµç¨‹ sync.unparkSuccessorï¼Œå³è®©è€äºŒæ¢å¤è¿è¡Œï¼Œè¿™æ—¶ t2 åœ¨ doAcquireShared å†… parkAndCheckInterrupt() å¤„æ¢å¤è¿è¡Œ</p><p>è¿™å›å†æ¥ä¸€æ¬¡ for (;;) æ‰§è¡Œ tryAcquireShared æˆåŠŸåˆ™è®©è¯»é”è®¡æ•°åŠ ä¸€</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314192033493.png" alt="image-20220314192033493" style="zoom:67%;" /><p>è¿™æ—¶ t2 å·²ç»æ¢å¤è¿è¡Œï¼Œæ¥ä¸‹æ¥ t2 è°ƒç”¨ setHeadAndPropagate(node, 1)ï¼Œå®ƒåŸæœ¬æ‰€åœ¨èŠ‚ç‚¹è¢«ç½®ä¸ºå¤´èŠ‚ç‚¹</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314192048242.png" alt="image-20220314192048242" style="zoom:67%;" /><p>äº‹æƒ…è¿˜æ²¡å®Œï¼Œåœ¨ setHeadAndPropagate æ–¹æ³•å†…è¿˜ä¼šæ£€æŸ¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯ sharedï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨ doReleaseShared() å°† head çš„çŠ¶æ€ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’è€äºŒï¼Œè¿™æ—¶ t3 åœ¨ doAcquireShared å†… parkAndCheckInterrupt() å¤„æ¢å¤è¿è¡Œ</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314192104962.png" alt="image-20220314192104962" style="zoom:67%;" /><p>è¿™å›å†æ¥ä¸€æ¬¡ for (;;) æ‰§è¡Œ tryAcquireShared æˆåŠŸåˆ™è®©è¯»é”è®¡æ•°åŠ ä¸€</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314192123102.png" alt="image-20220314192123102" style="zoom:67%;" /><p>è¿™æ—¶ t3 å·²ç»æ¢å¤è¿è¡Œï¼Œæ¥ä¸‹æ¥ t3 è°ƒç”¨ setHeadAndPropagate(node, 1)ï¼Œå®ƒåŸæœ¬æ‰€åœ¨èŠ‚ç‚¹è¢«ç½®ä¸ºå¤´èŠ‚ç‚¹</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314192145552.png" alt="image-20220314192145552" style="zoom:67%;" /><p>ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸æ˜¯ shared äº†ï¼Œå› æ­¤ä¸ä¼šç»§ç»­å”¤é†’ t4 æ‰€åœ¨èŠ‚ç‚¹</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="1a9249ba-6a46-4d14-b45f-183ba5c9fcba-4"><p>t2 è¿›å…¥ sync.releaseShared(1) ä¸­ï¼Œè°ƒç”¨ tryReleaseShared(1) è®©è®¡æ•°å‡ä¸€ï¼Œä½†ç”±äºè®¡æ•°è¿˜ä¸ä¸ºé›¶</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314192222303.png" alt="image-20220314192222303" style="zoom:67%;" /><p>t3 è¿›å…¥ sync.releaseShared(1) ä¸­ï¼Œè°ƒç”¨ tryReleaseShared(1) è®©è®¡æ•°å‡ä¸€ï¼Œè¿™å›è®¡æ•°ä¸ºé›¶äº†ï¼Œè¿›å…¥ doReleaseShared() å°†å¤´èŠ‚ç‚¹ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’è€äºŒï¼Œå³</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314192239120.png" alt="image-20220314192239120" style="zoom: 67%;" /><p>ä¹‹å t4 åœ¨ acquireQueued ä¸­ parkAndCheckInterrupt å¤„æ¢å¤è¿è¡Œï¼Œå†æ¬¡ for (;;) è¿™æ¬¡è‡ªå·±æ˜¯è€äºŒï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»– ç«äº‰ï¼ŒtryAcquire(1) æˆåŠŸï¼Œä¿®æ”¹å¤´ç»“ç‚¹ï¼Œæµç¨‹ç»“æŸ</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314192254698.png" alt="image-20220314192254698" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="5-3-StampedLock">5.3 StampedLock</h3><p>è¯¥ç±»è‡ª JDK 8 åŠ å…¥ï¼Œæ˜¯ä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–è¯»æ€§èƒ½ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯åœ¨ä½¿ç”¨è¯»é”ã€å†™é”æ—¶éƒ½å¿…é¡»é…åˆã€æˆ³ã€‘ä½¿ç”¨ åŠ è§£è¯»é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.readLock();</span><br><span class="line">lock.unlockRead(stamp);</span><br></pre></td></tr></table></figure><p>åŠ è§£å†™é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.writeLock();</span><br><span class="line">lock.unlockWrite(stamp);</span><br></pre></td></tr></table></figure><p>ä¹è§‚è¯»ï¼ŒStampedLock æ”¯æŒ tryOptimisticRead() æ–¹æ³•ï¼ˆä¹è§‚è¯»ï¼‰ï¼Œè¯»å–å®Œæ¯•åéœ€è¦åšä¸€æ¬¡ æˆ³æ ¡éªŒ å¦‚æœæ ¡éªŒé€š è¿‡ï¼Œè¡¨ç¤ºè¿™æœŸé—´ç¡®å®æ²¡æœ‰å†™æ“ä½œï¼Œæ•°æ®å¯ä»¥å®‰å…¨ä½¿ç”¨ï¼Œå¦‚æœæ ¡éªŒæ²¡é€šè¿‡ï¼Œéœ€è¦é‡æ–°è·å–è¯»é”ï¼Œä¿è¯æ•°æ®å®‰å…¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.tryOptimisticRead();</span><br><span class="line"><span class="comment">// éªŒæˆ³</span></span><br><span class="line"><span class="keyword">if</span>(!lock.validate(stamp))&#123;</span><br><span class="line">    <span class="comment">// é”å‡çº§</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="tabs" id="5f17da48-39fe-4fb3-adb1-6b96a51c0809"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#5f17da48-39fe-4fb3-adb1-6b96a51c0809-1"><i class="fas fa-award"></i>æ•°æ®å®¹å™¨ç±»</button></li><li class="tab"><button type="button" data-href="#5f17da48-39fe-4fb3-adb1-6b96a51c0809-2"><i class="fas fa-baseball-ball"></i>æµ‹è¯•è¯»-è¯»</button></li><li class="tab"><button type="button" data-href="#5f17da48-39fe-4fb3-adb1-6b96a51c0809-3"><i class="fas fa-bone"></i>æµ‹è¯•è¯»-å†™</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="5f17da48-39fe-4fb3-adb1-6b96a51c0809-1"><p>æä¾›ä¸€ä¸ª<code>æ•°æ®å®¹å™¨ç±»</code>å†…éƒ¨åˆ†åˆ«ä½¿ç”¨è¯»é”ä¿æŠ¤æ•°æ®çš„<code>read()</code>æ–¹æ³•ï¼Œå†™é”ä¿æŠ¤æ•°æ®çš„<code>write()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DataContainerStamped</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> data;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">StampedLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StampedLock</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DataContainerStamped</span><span class="params">(<span class="type">int</span> data)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">read</span><span class="params">(<span class="type">int</span> readTime)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–æˆ³</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.tryOptimisticRead();</span><br><span class="line">        log.debug(<span class="string">&quot;optimistic read locking...&#123;&#125;&quot;</span>, stamp);</span><br><span class="line">        <span class="comment">//è¯»å–æ•°æ®</span></span><br><span class="line">        sleep(readTime);</span><br><span class="line">        <span class="comment">//è¯»å–æ•°æ®ä¹‹åå†éªŒæˆ³</span></span><br><span class="line">        <span class="keyword">if</span> (lock.validate(stamp)) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;read finish...&#123;&#125;, data:&#123;&#125;&quot;</span>, stamp, data);</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœéªŒæˆ³å¤±è´¥ï¼Œè¯´æ˜å·²ç»æ•°æ®å·²ç»è¢«ä¿®æ”¹ï¼Œéœ€è¦å‡çº§é”é‡æ–°è¯»ã€‚</span></span><br><span class="line">        <span class="comment">// é”å‡çº§ - è¯»é”</span></span><br><span class="line">        log.debug(<span class="string">&quot;updating to read lock... &#123;&#125;&quot;</span>, stamp);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stamp = lock.readLock();</span><br><span class="line">            log.debug(<span class="string">&quot;read lock &#123;&#125;&quot;</span>, stamp);</span><br><span class="line">            sleep(readTime);</span><br><span class="line">            log.debug(<span class="string">&quot;read finish...&#123;&#125;, data:&#123;&#125;&quot;</span>, stamp, data);</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;read unlock &#123;&#125;&quot;</span>, stamp);</span><br><span class="line">            lock.unlockRead(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span> newData)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.writeLock();</span><br><span class="line">        log.debug(<span class="string">&quot;write lock &#123;&#125;&quot;</span>, stamp);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sleep(<span class="number">2</span>);</span><br><span class="line">            <span class="built_in">this</span>.data = newData;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;write unlock &#123;&#125;&quot;</span>, stamp);</span><br><span class="line">            lock.unlockWrite(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5f17da48-39fe-4fb3-adb1-6b96a51c0809-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">DataContainerStamped</span> <span class="variable">dataContainer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataContainerStamped</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        dataContainer.read(<span class="number">1</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    sleep(<span class="number">0.5</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        dataContainer.read(<span class="number">0</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼Œå¯ä»¥çœ‹åˆ°å®é™…æ²¡æœ‰åŠ è¯»é”</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">15:58:50.217 c.DataContainerStamped [t1] - optimistic <span class="built_in">read</span> locking...256 </span><br><span class="line">15:58:50.717 c.DataContainerStamped [t2] - optimistic <span class="built_in">read</span> locking...256 </span><br><span class="line">15:58:50.717 c.DataContainerStamped [t2] - <span class="built_in">read</span> finish...256, data:1 </span><br><span class="line">15:58:51.220 c.DataContainerStamped [t1] - <span class="built_in">read</span> finish...256, data:1 </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5f17da48-39fe-4fb3-adb1-6b96a51c0809-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">DataContainerStamped</span> <span class="variable">dataContainer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataContainerStamped</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        dataContainer.read(<span class="number">1</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    sleep(<span class="number">0.5</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        dataContainer.write(<span class="number">100</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">15:57:00.219 c.DataContainerStamped [t1] - optimistic <span class="built_in">read</span> locking...256 </span><br><span class="line">15:57:00.717 c.DataContainerStamped [t2] - write lock 384 </span><br><span class="line">15:57:01.225 c.DataContainerStamped [t1] - updating to <span class="built_in">read</span> lock... 256 </span><br><span class="line">15:57:02.719 c.DataContainerStamped [t2] - write unlock 384 </span><br><span class="line">15:57:02.719 c.DataContainerStamped [t1] - <span class="built_in">read</span> lock 513 </span><br><span class="line">15:57:03.719 c.DataContainerStamped [t1] - <span class="built_in">read</span> finish...513, data:1000 </span><br><span class="line">15:57:03.719 c.DataContainerStamped [t1] - <span class="built_in">read</span> unlock 513 </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <blockquote><p><strong>æ³¨æ„</strong></p><ul><li>StampedLock ä¸æ”¯æŒæ¡ä»¶å˜é‡</li><li>StampedLock ä¸æ”¯æŒå¯é‡å…¥</li></ul></blockquote><h2 id="6-Semaphore">6. Semaphore</h2><h3 id="6-1-åŸºæœ¬ä½¿ç”¨">6.1 åŸºæœ¬ä½¿ç”¨</h3><p>ä¿¡å·é‡ï¼Œç”¨æ¥é™åˆ¶èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹ä¸Šé™ã€‚</p><div class="tabs" id="be1198a9-b921-40a1-b900-cc9c2f9126a0"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#be1198a9-b921-40a1-b900-cc9c2f9126a0-1"><i class="fas fa-bug"></i>ä»£ç </button></li><li class="tab"><button type="button" data-href="#be1198a9-b921-40a1-b900-cc9c2f9126a0-2"><i class="fas fa-cannabis"></i>è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="be1198a9-b921-40a1-b900-cc9c2f9126a0-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. åˆ›å»º semaphore å¯¹è±¡</span></span><br><span class="line">    <span class="type">Semaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">// 2. 10ä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œ</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// 3. è·å–è®¸å¯</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                semaphore.acquire();</span><br><span class="line">            <span class="comment">//å¯¹äºéæ‰“æ–­å¼è·å–ï¼Œå¦‚æœæ­¤è¿‡ç¨‹ä¸­è¢«æ‰“æ–­ï¼Œçº¿ç¨‹ä¾æ—§ä¼šç­‰åˆ°è·å–äº†ä¿¡å·é‡ä¹‹åæ‰è¿›å…¥catchå—ã€‚</span></span><br><span class="line">            <span class="comment">//catchå—ä¸­çš„çº¿ç¨‹ä¾æ—§æŒæœ‰ä¿¡å·é‡ï¼Œæ•è·è¯¥å¼‚å¸¸åcatchå—å¯ä»¥ä¸åšä»»ä½•å¤„ç†ã€‚</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;running...&quot;</span>);</span><br><span class="line">                sleep(<span class="number">1</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;end...&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 4. é‡Šæ”¾è®¸å¯</span></span><br><span class="line">                semaphore.release();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="be1198a9-b921-40a1-b900-cc9c2f9126a0-2"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">07:35:15.485 c.TestSemaphore [Thread-2] - running... </span><br><span class="line">07:35:15.485 c.TestSemaphore [Thread-1] - running... </span><br><span class="line">07:35:15.485 c.TestSemaphore [Thread-0] - running... </span><br><span class="line">07:35:16.490 c.TestSemaphore [Thread-2] - end... </span><br><span class="line">07:35:16.490 c.TestSemaphore [Thread-0] - end... </span><br><span class="line">07:35:16.490 c.TestSemaphore [Thread-1] - end... </span><br><span class="line">07:35:16.490 c.TestSemaphore [Thread-3] - running... </span><br><span class="line">07:35:16.490 c.TestSemaphore [Thread-5] - running... </span><br><span class="line">07:35:16.490 c.TestSemaphore [Thread-4] - running... </span><br><span class="line">07:35:17.490 c.TestSemaphore [Thread-5] - end... </span><br><span class="line">07:35:17.490 c.TestSemaphore [Thread-4] - end... </span><br><span class="line">07:35:17.490 c.TestSemaphore [Thread-3] - end... </span><br><span class="line">07:35:17.490 c.TestSemaphore [Thread-6] - running... </span><br><span class="line">07:35:17.490 c.TestSemaphore [Thread-7] - running... </span><br><span class="line">07:35:17.490 c.TestSemaphore [Thread-9] - running... </span><br><span class="line">07:35:18.491 c.TestSemaphore [Thread-6] - end... </span><br><span class="line">07:35:18.491 c.TestSemaphore [Thread-7] - end... </span><br><span class="line">07:35:18.491 c.TestSemaphore [Thread-9] - end... </span><br><span class="line">07:35:18.491 c.TestSemaphore [Thread-8] - running... </span><br><span class="line">07:35:19.492 c.TestSemaphore [Thread-8] - end... </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>è¯´æ˜ï¼š</p><ul><li>Semaphoreæœ‰ä¸¤ä¸ªæ„é€ å™¨ï¼š<code>Semaphore(int permits)</code>å’Œ<code>Semaphore(int permits,boolean fair)</code></li><li>permitsè¡¨ç¤ºå…è®¸åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹æ•°ã€‚</li><li>fairè¡¨ç¤ºå…¬å¹³ä¸å¦ï¼Œä¸ä¹‹å‰çš„ReentrantLockä¸€æ ·ã€‚</li></ul><h3 id="6-2-Semaphore-åº”ç”¨">6.2 Semaphore åº”ç”¨</h3><p>semaphore é™åˆ¶å¯¹å…±äº«èµ„æºçš„ä½¿ç”¨</p><ul><li>ä½¿ç”¨ Semaphore é™æµï¼Œåœ¨è®¿é—®é«˜å³°æœŸæ—¶ï¼Œè®©è¯·æ±‚çº¿ç¨‹é˜»å¡ï¼Œé«˜å³°æœŸè¿‡å»å†é‡Šæ”¾è®¸å¯ï¼Œå½“ç„¶å®ƒåªé€‚åˆé™åˆ¶å•æœº çº¿ç¨‹æ•°é‡ï¼Œå¹¶ä¸”ä»…æ˜¯é™åˆ¶çº¿ç¨‹æ•°ï¼Œè€Œä¸æ˜¯é™åˆ¶èµ„æºæ•°ï¼ˆä¾‹å¦‚è¿æ¥æ•°ï¼Œè¯·å¯¹æ¯” Tomcat LimitLatch çš„å®ç°ï¼‰</li><li>ç”¨ Semaphore å®ç°ç®€å•è¿æ¥æ± ï¼Œå¯¹æ¯”ã€äº«å…ƒæ¨¡å¼ã€ä¸‹çš„å®ç°ï¼ˆç”¨wait notifyï¼‰ï¼Œæ€§èƒ½å’Œå¯è¯»æ€§æ˜¾ç„¶æ›´å¥½ï¼Œ æ³¨æ„ä¸‹é¢çš„å®ç°ä¸­çº¿ç¨‹æ•°å’Œæ•°æ®åº“è¿æ¥æ•°æ˜¯ç›¸ç­‰çš„</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Pool&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pool</span> &#123;</span><br><span class="line">    <span class="comment">// 1. è¿æ¥æ± å¤§å°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> poolSize;</span><br><span class="line">    <span class="comment">// 2. è¿æ¥å¯¹è±¡æ•°ç»„</span></span><br><span class="line">    <span class="keyword">private</span> Connection[] connections;</span><br><span class="line">    <span class="comment">// 3. è¿æ¥çŠ¶æ€æ•°ç»„ 0 è¡¨ç¤ºç©ºé—²ï¼Œ 1 è¡¨ç¤ºç¹å¿™</span></span><br><span class="line">    <span class="keyword">private</span> AtomicIntegerArray states;</span><br><span class="line">    <span class="keyword">private</span> Semaphore semaphore;</span><br><span class="line">    <span class="comment">// 4. æ„é€ æ–¹æ³•åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Pool</span><span class="params">(<span class="type">int</span> poolSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.poolSize = poolSize;</span><br><span class="line">        <span class="comment">// è®©è®¸å¯æ•°ä¸èµ„æºæ•°ä¸€è‡´</span></span><br><span class="line">        <span class="built_in">this</span>.semaphore = <span class="keyword">new</span> <span class="title class_">Semaphore</span>(poolSize);</span><br><span class="line">        <span class="built_in">this</span>.connections = <span class="keyword">new</span> <span class="title class_">Connection</span>[poolSize];</span><br><span class="line">        <span class="built_in">this</span>.states = <span class="keyword">new</span> <span class="title class_">AtomicIntegerArray</span>(<span class="keyword">new</span> <span class="title class_">int</span>[poolSize]);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            connections[i] = <span class="keyword">new</span> <span class="title class_">MockConnection</span>(<span class="string">&quot;è¿æ¥&quot;</span> + (i+<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5. å€Ÿè¿æ¥</span></span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">borrow</span><span class="params">()</span> &#123;<span class="comment">// t1, t2, t3</span></span><br><span class="line">        <span class="comment">// è·å–è®¸å¯</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            semaphore.acquire(); <span class="comment">// æ²¡æœ‰è®¸å¯çš„çº¿ç¨‹ï¼Œåœ¨æ­¤ç­‰å¾…</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            <span class="comment">// è·å–ç©ºé—²è¿æ¥</span></span><br><span class="line">            <span class="keyword">if</span>(states.get(i) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (states.compareAndSet(i, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;borrow &#123;&#125;&quot;</span>, connections[i]);</span><br><span class="line">                    <span class="keyword">return</span> connections[i];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6. å½’è¿˜è¿æ¥</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">free</span><span class="params">(Connection conn)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (connections[i] == conn) &#123;</span><br><span class="line">                states.set(i, <span class="number">0</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;free &#123;&#125;&quot;</span>, conn);</span><br><span class="line">                semaphore.release();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-3-Semaphore-åŸç†">6.3 Semaphore åŸç†</h3><p><strong>åŠ é”è§£é”æµç¨‹</strong></p><div class="tabs" id="391f4b61-142c-44aa-99c6-3134e7ac1fe6"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#391f4b61-142c-44aa-99c6-3134e7ac1fe6-1"><i class="fas fa-candy-cane"></i>1</button></li><li class="tab"><button type="button" data-href="#391f4b61-142c-44aa-99c6-3134e7ac1fe6-2"><i class="fas fa-child"></i>2</button></li><li class="tab"><button type="button" data-href="#391f4b61-142c-44aa-99c6-3134e7ac1fe6-3"><i class="fab fa-apple"></i>3</button></li><li class="tab"><button type="button" data-href="#391f4b61-142c-44aa-99c6-3134e7ac1fe6-4"><i class="fas fa-tree"></i>4</button></li><li class="tab"><button type="button" data-href="#391f4b61-142c-44aa-99c6-3134e7ac1fe6-5"><i class="fas fa-leaf"></i>æºç åˆ†æ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="391f4b61-142c-44aa-99c6-3134e7ac1fe6-1"><p>Semaphoreæœ‰ç‚¹åƒä¸€ä¸ªåœè½¦åœºï¼Œpermitså°±å¥½åƒåœè½¦ä½æ•°é‡ï¼Œå½“çº¿ç¨‹è·å¾—äº†permitså°±åƒæ˜¯è·å¾—äº†åœè½¦ä½ï¼Œç„¶ååœè½¦åœºæ˜¾ç¤ºç©ºä½™è½¦ä½å‡ä¸€ã€‚</p><p>åˆšå¼€å§‹ï¼Œpermitsï¼ˆstateï¼‰ä¸º 3ï¼Œè¿™æ—¶ 5 ä¸ªçº¿ç¨‹æ¥è·å–èµ„æº</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220315211610470.png" alt="image-20220315211610470" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="391f4b61-142c-44aa-99c6-3134e7ac1fe6-2"><p>å‡è®¾å…¶ä¸­ Thread-1ï¼ŒThread-2ï¼ŒThread-4 cas ç«äº‰æˆåŠŸï¼Œè€Œ Thread-0 å’Œ Thread-3 ç«äº‰å¤±è´¥ï¼Œè¿›å…¥ AQS é˜Ÿåˆ— park é˜»å¡</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220315211646132.png" alt="image-20220315211646132" style="zoom:67%;" /><p>åŠ é”æµç¨‹æ€»ç»“ï¼š</p><ul><li><code>acquire</code>-&gt;<code>acquireSharedInterruptibly(1)</code>-&gt;<code>tryAcquireShared(1)</code>-&gt;<code>nonfairTryAcquireShared(1)</code>,å¦‚æœèµ„æºç”¨å®Œäº†ï¼Œè¿”å›è´Ÿæ•°ï¼Œ<code>tryAcquireShared</code>è¿”å›è´Ÿæ•°ï¼Œè¡¨ç¤ºå¤±è´¥ã€‚å¦åˆ™è¿”å›æ­£æ•°ï¼Œ<code>tryAcquireShared</code>è¿”å›æ­£æ•°,è¡¨ç¤ºæˆåŠŸã€‚<ul><li>å¦‚æœæˆåŠŸï¼Œè·å–ä¿¡å·é‡æˆåŠŸã€‚</li><li>å¦‚æœå¤±è´¥ï¼Œè°ƒç”¨<code>doAcquireSharedInterruptibly</code>,è¿›å…¥forå¾ªç¯ï¼š<ul><li>å¦‚æœå½“å‰é©±èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹ï¼Œè°ƒç”¨<code>tryAcquireShared</code>å°è¯•è·å–é”<ul><li>å¦‚æœç»“æœå¤§äºç­‰äº0ï¼Œè¡¨æ˜è·å–é”æˆåŠŸï¼Œè°ƒç”¨<code>setHeadAndPropagate</code>ï¼Œå°†å½“å‰èŠ‚ç‚¹è®¾ä¸ºå¤´èŠ‚ç‚¹ï¼Œä¹‹ååˆè°ƒç”¨<code>doReleaseShared</code>ï¼Œå”¤é†’åç»§èŠ‚ç‚¹ã€‚</li></ul></li><li>è°ƒç”¨<code>shoudParkAfterFailure</code>,ç¬¬ä¸€æ¬¡è°ƒç”¨è¿”å›falseï¼Œå¹¶å°†å‰é©±èŠ‚ç‚¹æ”¹ä¸º-1ï¼Œç¬¬äºŒæ¬¡å¾ªç¯å¦‚æœå†è¿›å…¥æ­¤æ–¹æ³•ï¼Œä¼šè¿›å…¥é˜»å¡å¹¶æ£€æŸ¥æ‰“æ–­çš„æ–¹æ³•ã€‚</li></ul></li></ul></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="391f4b61-142c-44aa-99c6-3134e7ac1fe6-3"><p>è¿™æ—¶ Thread-4 é‡Šæ”¾äº† permitsï¼ŒçŠ¶æ€å¦‚ä¸‹</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220315211712384.png" alt="image-20220315211712384" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="391f4b61-142c-44aa-99c6-3134e7ac1fe6-4"><p>æ¥ä¸‹æ¥ Thread-0 ç«äº‰æˆåŠŸï¼Œpermits å†æ¬¡è®¾ç½®ä¸º 0ï¼Œè®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹ï¼Œæ–­å¼€åŸæ¥çš„ head èŠ‚ç‚¹ï¼Œunpark æ¥ ä¸‹æ¥çš„ Thread-3 èŠ‚ç‚¹ï¼Œä½†ç”±äº permits æ˜¯ 0ï¼Œå› æ­¤ Thread-3 åœ¨å°è¯•ä¸æˆåŠŸåå†æ¬¡è¿›å…¥ park çŠ¶æ€</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220315211741166.png" alt="image-20220315211741166" style="zoom:67%;" /><p>è§£é”æµç¨‹æ€»ç»“ï¼š</p><ul><li><code>release</code>-&gt;<code>sync.releaseShared(1)</code>-&gt;<code>tryReleaseShared(1)</code>,åªè¦ä¸å‘ç”Ÿæ•´æ•°æº¢å‡ºï¼Œå°±è¿”å›true<ul><li>å¦‚æœè¿”å›trueï¼Œè°ƒç”¨<code>doReleaseShared</code>ï¼Œå”¤é†’åç»§èŠ‚ç‚¹ã€‚</li><li>å¦‚æœè¿”å›falseï¼Œè§£é”å¤±è´¥ã€‚</li></ul></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="391f4b61-142c-44aa-99c6-3134e7ac1fe6-5"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">2694183684443567898L</span>;</span><br><span class="line">    NonfairSync(<span class="type">int</span> <span class="keyword">permits</span>) &#123;</span><br><span class="line">        <span class="comment">// permits å³ state</span></span><br><span class="line">        <span class="built_in">super</span>(<span class="keyword">permits</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Semaphore æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        sync.acquireSharedInterruptibly(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireSharedInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span></span><br><span class="line">        <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">            doAcquireSharedInterruptibly(arg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°è¯•è·å¾—å…±äº«é”</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">tryAcquireShared</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nonfairTryAcquireShared(acquires);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">nonfairTryAcquireShared</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">available</span> <span class="operator">=</span> getState();</span><br><span class="line">            <span class="type">int</span> <span class="variable">remaining</span> <span class="operator">=</span> available - acquires; </span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">                <span class="comment">// å¦‚æœè®¸å¯å·²ç»ç”¨å®Œ, è¿”å›è´Ÿæ•°, è¡¨ç¤ºè·å–å¤±è´¥, è¿›å…¥ doAcquireSharedInterruptibly</span></span><br><span class="line">                remaining &lt; <span class="number">0</span> ||</span><br><span class="line">                <span class="comment">// å¦‚æœ cas é‡è¯•æˆåŠŸ, è¿”å›æ­£æ•°, è¡¨ç¤ºè·å–æˆåŠŸ</span></span><br><span class="line">                compareAndSetState(available, remaining)</span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="keyword">return</span> remaining;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireSharedInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.SHARED);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">                <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">                    <span class="comment">// å†æ¬¡å°è¯•è·å–è®¸å¯</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> tryAcquireShared(arg);</span><br><span class="line">                    <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// æˆåŠŸåæœ¬çº¿ç¨‹å‡ºé˜Ÿï¼ˆAQSï¼‰, æ‰€åœ¨ Nodeè®¾ç½®ä¸º head</span></span><br><span class="line">                        <span class="comment">// å¦‚æœ head.waitStatus == Node.SIGNAL ==&gt; 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark</span></span><br><span class="line">                        <span class="comment">// å¦‚æœ head.waitStatus == 0 ==&gt; Node.PROPAGATE </span></span><br><span class="line">                        <span class="comment">// r è¡¨ç¤ºå¯ç”¨èµ„æºæ•°, ä¸º 0 åˆ™ä¸ä¼šç»§ç»­ä¼ æ’­</span></span><br><span class="line">                        setHeadAndPropagate(node, r);</span><br><span class="line">                        p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                        failed = <span class="literal">false</span>;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// ä¸æˆåŠŸ, è®¾ç½®ä¸Šä¸€ä¸ªèŠ‚ç‚¹ waitStatus = Node.SIGNAL, ä¸‹è½®è¿›å…¥ park é˜»å¡</span></span><br><span class="line">                <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    parkAndCheckInterrupt())</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                cancelAcquire(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Semaphore æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.releaseShared(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">releaseShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">            doReleaseShared();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryReleaseShared</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> getState();</span><br><span class="line">            <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> current + releases;</span><br><span class="line">            <span class="keyword">if</span> (next &lt; current) <span class="comment">// overflow</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum permit count exceeded&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(current, next))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setHeadAndPropagate</span><span class="params">(Node node, <span class="type">int</span> propagate)</span> &#123;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head; <span class="comment">// Record old head for check below</span></span><br><span class="line">    <span class="comment">// è®¾ç½®è‡ªå·±ä¸º head</span></span><br><span class="line">    setHead(node);</span><br><span class="line">    <span class="comment">// propagate è¡¨ç¤ºæœ‰å…±äº«èµ„æºï¼ˆä¾‹å¦‚å…±äº«è¯»é”æˆ–ä¿¡å·é‡ï¼‰</span></span><br><span class="line">    <span class="comment">// åŸ head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATE</span></span><br><span class="line">    <span class="comment">// ç°åœ¨ head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATE</span></span><br><span class="line">    <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> || h == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span> ||</span><br><span class="line">        (h = head) == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…æ˜¯ç­‰å¾…å…±äº«è¯»é”çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span> || s.isShared()) &#123;</span><br><span class="line">            doReleaseShared();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doReleaseShared</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> h.waitStatus;</span><br><span class="line">            <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">                    <span class="keyword">continue</span>;            <span class="comment">// loop to recheck cases</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                     !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">                <span class="keyword">continue</span>;                <span class="comment">// loop on failed CAS</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (h == head)                   <span class="comment">// loop if head changed</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="7-CountdownLatch">7. CountdownLatch</h2><p>å€’è®¡æ—¶é”</p><p>ç”¨æ¥è¿›è¡Œçº¿ç¨‹åŒæ­¥åä½œï¼Œç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆå€’è®¡æ—¶ã€‚</p><p>CountDownLatchçš„ä½œç”¨å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªæˆ–è€…ä¸€ç»„çº¿ç¨‹åœ¨å¼€å§‹æ‰§è¡Œæ“ä½œä¹‹å‰ï¼Œå¿…é¡»è¦ç­‰åˆ°å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œæ‰å¯ä»¥ã€‚æˆ‘ä»¬ä¸¾ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ï¼Œåœ¨è€ƒè¯•çš„æ—¶å€™ï¼Œè€å¸ˆå¿…é¡»è¦ç­‰åˆ°æ‰€æœ‰äººäº¤äº†è¯•å·æ‰å¯ä»¥èµ°ã€‚æ­¤æ—¶è€å¸ˆå°±ç›¸å½“äºç­‰å¾…çº¿ç¨‹ï¼Œè€Œå­¦ç”Ÿå°±å¥½æ¯”æ˜¯æ‰§è¡Œçš„çº¿ç¨‹ã€‚</p><p>å…¶ä¸­æ„é€ å‚æ•°ç”¨æ¥åˆå§‹åŒ–ç­‰å¾…è®¡æ•°å€¼ï¼Œawait() ç”¨æ¥ç­‰å¾…è®¡æ•°å½’é›¶ï¼ŒcountDown() ç”¨æ¥è®©è®¡æ•°å‡ä¸€</p><div class="tabs" id="7693d943-0807-4763-9f97-316e9fc10617"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#7693d943-0807-4763-9f97-316e9fc10617-1"><i class="fas fa-cat"></i>ç¤ºä¾‹</button></li><li class="tab"><button type="button" data-href="#7693d943-0807-4763-9f97-316e9fc10617-2"><i class="fas fa-horse"></i>è¾“å‡º</button></li><li class="tab"><button type="button" data-href="#7693d943-0807-4763-9f97-316e9fc10617-3"><i class="fas fa-dove"></i>æ¯”è¾ƒ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="7693d943-0807-4763-9f97-316e9fc10617-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;begin...&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        latch.countDown();</span><br><span class="line">        log.debug(<span class="string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());</span><br><span class="line">    &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;begin...&quot;</span>);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        latch.countDown();</span><br><span class="line">        log.debug(<span class="string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());</span><br><span class="line">    &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;begin...&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1.5</span>);</span><br><span class="line">        latch.countDown();</span><br><span class="line">        log.debug(<span class="string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());</span><br><span class="line">    &#125;).start();</span><br><span class="line">    log.debug(<span class="string">&quot;waiting...&quot;</span>);</span><br><span class="line">    latch.await();</span><br><span class="line">    log.debug(<span class="string">&quot;wait end...&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="7693d943-0807-4763-9f97-316e9fc10617-2"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">18:44:00.778 c.TestCountDownLatch [main] - waiting... </span><br><span class="line">18:44:00.778 c.TestCountDownLatch [Thread-2] - begin... </span><br><span class="line">18:44:00.778 c.TestCountDownLatch [Thread-0] - begin... </span><br><span class="line">18:44:00.778 c.TestCountDownLatch [Thread-1] - begin... </span><br><span class="line">18:44:01.782 c.TestCountDownLatch [Thread-0] - end...2 </span><br><span class="line">18:44:02.283 c.TestCountDownLatch [Thread-2] - end...1 </span><br><span class="line">18:44:02.782 c.TestCountDownLatch [Thread-1] - end...0 </span><br><span class="line">18:44:02.782 c.TestCountDownLatch [main] - <span class="built_in">wait</span> end... </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="7693d943-0807-4763-9f97-316e9fc10617-3"><p>Joinå±äºæ¯”è¾ƒåº•å±‚çš„APIï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬ä¸ä¼šè‡ªå·±åˆ›å»ºçº¿ç¨‹ï¼Œè€Œæ˜¯ç”±çº¿ç¨‹æ± åˆ›å»ºã€‚</p><p>ç›¸æ¯”äºjoinï¼ŒCountDownLatchèƒ½é…åˆçº¿ç¨‹æ± ä½¿ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">3</span>);</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">4</span>);</span><br><span class="line">    service.submit(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;begin...&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        latch.countDown();</span><br><span class="line">        log.debug(<span class="string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());</span><br><span class="line">    &#125;);</span><br><span class="line">    service.submit(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;begin...&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1.5</span>);</span><br><span class="line">        latch.countDown();</span><br><span class="line">        log.debug(<span class="string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());</span><br><span class="line">    &#125;);</span><br><span class="line">    service.submit(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;begin...&quot;</span>);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        latch.countDown();</span><br><span class="line">        log.debug(<span class="string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());</span><br><span class="line">    &#125;);</span><br><span class="line">    service.submit(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;waiting...&quot;</span>);</span><br><span class="line">            latch.await();</span><br><span class="line">            log.debug(<span class="string">&quot;wait end...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="7-1-åŒæ­¥ç­‰å¾…å¤šçº¿ç¨‹å‡†å¤‡å®Œæ¯•">7.1 åŒæ­¥ç­‰å¾…å¤šçº¿ç¨‹å‡†å¤‡å®Œæ¯•</h3><p>åœ¨æ‰“ç‹è€…çš„æ—¶å€™ï¼Œåœ¨å¼€å±€å‰æ‰€æœ‰äººéƒ½å¿…é¡»è¦åŠ è½½åˆ°100%æ‰å¯ä»¥è¿›å…¥ã€‚å¦åˆ™æ‰€æœ‰ç©å®¶éƒ½ç›¸äº’ç­‰å¾…ã€‚</p><div class="tabs" id="ebba993d-4410-4763-840b-9e15257709d2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ebba993d-4410-4763-840b-9e15257709d2-1"><i class="fas fa-atom"></i>ä»£ç </button></li><li class="tab"><button type="button" data-href="#ebba993d-4410-4763-840b-9e15257709d2-2"><i class="far fa-sun"></i>è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ebba993d-4410-4763-840b-9e15257709d2-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AtomicInteger</span> <span class="variable">num</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>, (r) -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r, <span class="string">&quot;t&quot;</span> + num.getAndIncrement());</span><br><span class="line">&#125;);</span><br><span class="line"><span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">10</span>);</span><br><span class="line">String[] all = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">10</span>];</span><br><span class="line"><span class="type">Random</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">10</span>; j++) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> j;</span><br><span class="line">    service.submit(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//éšæœºä¼‘çœ ï¼Œæ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ</span></span><br><span class="line">                Thread.sleep(r.nextInt(<span class="number">100</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            all[x] = Thread.currentThread().getName() + <span class="string">&quot;(&quot;</span> + (i + <span class="string">&quot;%&quot;</span>) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">            <span class="comment">//\rå¯ä»¥è®©å½“å‰è¾“å‡ºè¦†ç›–ä¸Šä¸€æ¬¡çš„è¾“å‡ºã€‚</span></span><br><span class="line">            System.out.print(<span class="string">&quot;\r&quot;</span> + Arrays.toString(all));</span><br><span class="line">        &#125;</span><br><span class="line">        latch.countDown();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">latch.await();</span><br><span class="line">System.out.println(<span class="string">&quot;\næ¸¸æˆå¼€å§‹...&quot;</span>);</span><br><span class="line">service.shutdown();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ebba993d-4410-4763-840b-9e15257709d2-2"><p>ä¸­é—´è¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[t0(52%), t1(47%), t2(51%), t3(40%), t4(49%), t5(44%), t6(49%), t7(52%), t8(46%), t9(46%)] </span><br></pre></td></tr></table></figure><p>æœ€åè¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[t0(100%), t1(100%), t2(100%), t3(100%), t4(100%), t5(100%), t6(100%), t7(100%), t8(100%), </span><br><span class="line">t9(100%)] </span><br><span class="line">æ¸¸æˆå¼€å§‹... </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <h3 id="7-2-åŒæ­¥ç­‰å¾…å¤šä¸ªè¿œç¨‹è°ƒç”¨ç»“æŸ">7.2 åŒæ­¥ç­‰å¾…å¤šä¸ªè¿œç¨‹è°ƒç”¨ç»“æŸ</h3><div class="tabs" id="6296e3e4-7d8c-4fca-b83c-11b30da560ec"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6296e3e4-7d8c-4fca-b83c-11b30da560ec-1"><i class="fas fa-wind"></i>ä»£ç </button></li><li class="tab"><button type="button" data-href="#6296e3e4-7d8c-4fca-b83c-11b30da560ec-2"><i class="fas fa-fire-alt"></i>restè¿œç¨‹è°ƒç”¨</button></li><li class="tab"><button type="button" data-href="#6296e3e4-7d8c-4fca-b83c-11b30da560ec-3"><i class="fas fa-seedling"></i>æ‰§è¡Œç»“æœ</button></li><li class="tab"><button type="button" data-href="#6296e3e4-7d8c-4fca-b83c-11b30da560ec-4"><i class="fas fa-leaf"></i>futureæ”¹è¿›</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6296e3e4-7d8c-4fca-b83c-11b30da560ec-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCountDownlatchController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/order/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">order</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> id)</span> &#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;id&quot;</span>, id);</span><br><span class="line">        map.put(<span class="string">&quot;total&quot;</span>, <span class="string">&quot;2300.00&quot;</span>);</span><br><span class="line">        sleep(<span class="number">2000</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/product/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">product</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> id)</span> &#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (id == <span class="number">1</span>) &#123;</span><br><span class="line">            map.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;å°çˆ±éŸ³ç®±&quot;</span>);</span><br><span class="line">            map.put(<span class="string">&quot;price&quot;</span>, <span class="number">300</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (id == <span class="number">2</span>) &#123;</span><br><span class="line">            map.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;å°ç±³æ‰‹æœº&quot;</span>);</span><br><span class="line">            map.put(<span class="string">&quot;price&quot;</span>, <span class="number">2000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        map.put(<span class="string">&quot;id&quot;</span>, id);</span><br><span class="line">        sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/logistics/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">logistics</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> id)</span> &#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;id&quot;</span>, id);</span><br><span class="line">        map.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;ä¸­é€šå¿«é€’&quot;</span>);</span><br><span class="line">        sleep(<span class="number">2500</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> millis)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(millis);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6296e3e4-7d8c-4fca-b83c-11b30da560ec-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">log.debug(<span class="string">&quot;begin&quot;</span>);</span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line"><span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">4</span>);</span><br><span class="line">Future&lt;Map&lt;String,Object&gt;&gt; f1 = service.submit(() -&gt; &#123;</span><br><span class="line">    Map&lt;String, Object&gt; r =</span><br><span class="line">        restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/order/&#123;1&#125;&quot;</span>, Map.class, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;);</span><br><span class="line">Future&lt;Map&lt;String, Object&gt;&gt; f2 = service.submit(() -&gt; &#123;</span><br><span class="line">    Map&lt;String, Object&gt; r =</span><br><span class="line">        restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/product/&#123;1&#125;&quot;</span>, Map.class, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;);</span><br><span class="line">Future&lt;Map&lt;String, Object&gt;&gt; f3 = service.submit(() -&gt; &#123;</span><br><span class="line">    Map&lt;String, Object&gt; r =</span><br><span class="line">        restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/product/&#123;1&#125;&quot;</span>, Map.class, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;);</span><br><span class="line">Future&lt;Map&lt;String, Object&gt;&gt; f4 = service.submit(() -&gt; &#123;</span><br><span class="line">    Map&lt;String, Object&gt; r =</span><br><span class="line">        restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/logistics/&#123;1&#125;&quot;</span>, Map.class, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;);</span><br><span class="line">System.out.println(f1.get());</span><br><span class="line">System.out.println(f2.get());</span><br><span class="line">System.out.println(f3.get());</span><br><span class="line">System.out.println(f4.get());</span><br><span class="line">log.debug(<span class="string">&quot;æ‰§è¡Œå®Œæ¯•&quot;</span>);</span><br><span class="line">service.shutdown();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6296e3e4-7d8c-4fca-b83c-11b30da560ec-3"><p>æ‰§è¡Œç»“æœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">19:51:39.711 c.TestCountDownLatch [main] - begin </span><br><span class="line">&#123;total=2300.00, <span class="built_in">id</span>=1&#125; </span><br><span class="line">&#123;price=300, name=å°çˆ±éŸ³ç®±, <span class="built_in">id</span>=1&#125; </span><br><span class="line">&#123;price=2000, name=å°ç±³æ‰‹æœº, <span class="built_in">id</span>=2&#125; </span><br><span class="line">&#123;name=ä¸­é€šå¿«é€’, <span class="built_in">id</span>=1&#125; </span><br><span class="line">19:51:42.407 c.TestCountDownLatch [main] - æ‰§è¡Œå®Œæ¯•</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6296e3e4-7d8c-4fca-b83c-11b30da560ec-4"><p>è¿™ç§ç­‰å¾…å¤šä¸ªå¸¦æœ‰è¿”å›å€¼çš„ä»»åŠ¡çš„åœºæ™¯ï¼Œè¿˜æ˜¯ç”¨futureæ¯”è¾ƒåˆé€‚ï¼ŒCountdownLatché€‚åˆä»»åŠ¡æ²¡æœ‰è¿”å›å€¼çš„åœºæ™¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">log.debug(<span class="string">&quot;begin&quot;</span>);</span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line"><span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">4</span>);</span><br><span class="line">Future&lt;Map&lt;String,Object&gt;&gt; f1 = service.submit(() -&gt; &#123;</span><br><span class="line">    Map&lt;String, Object&gt; response = restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/order/&#123;1&#125;&quot;</span>, Map.class, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;);</span><br><span class="line">Future&lt;Map&lt;String, Object&gt;&gt; f2 = service.submit(() -&gt; &#123;</span><br><span class="line">    Map&lt;String, Object&gt; response1 = restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/product/&#123;1&#125;&quot;</span>, Map.class, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> response1;</span><br><span class="line">&#125;);</span><br><span class="line">Future&lt;Map&lt;String, Object&gt;&gt; f3 = service.submit(() -&gt; &#123;</span><br><span class="line">    Map&lt;String, Object&gt; response1 = restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/product/&#123;1&#125;&quot;</span>, Map.class, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> response1;</span><br><span class="line">&#125;);</span><br><span class="line">Future&lt;Map&lt;String, Object&gt;&gt; f4 = service.submit(() -&gt; &#123;</span><br><span class="line">    Map&lt;String, Object&gt; response3 = restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/logistics/&#123;1&#125;&quot;</span>, Map.class, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> response3;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">System.out.println(f1.get());</span><br><span class="line">System.out.println(f2.get());</span><br><span class="line">System.out.println(f3.get());</span><br><span class="line">System.out.println(f4.get());</span><br><span class="line">log.debug(<span class="string">&quot;æ‰§è¡Œå®Œæ¯•&quot;</span>);</span><br><span class="line">service.shutdown();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <h2 id="8-CyclicBarrier">8. CyclicBarrier</h2><div class="tabs" id="c8262116-9df2-473d-ab68-c09ee454370a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c8262116-9df2-473d-ab68-c09ee454370a-1"><i class="fas fa-award"></i>CountdownLatchç¼ºç‚¹</button></li><li class="tab"><button type="button" data-href="#c8262116-9df2-473d-ab68-c09ee454370a-2"><i class="fas fa-baseball-ball"></i>CyclicBarrieræ”¹è¿›</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c8262116-9df2-473d-ab68-c09ee454370a-1"><p>CountdownLatchçš„ç¼ºç‚¹åœ¨äºä¸èƒ½é‡ç”¨ï¼Œæƒ³è¦é‡å¤ä½¿ç”¨CountdownLatchè¿›è¡ŒåŒæ­¥ï¼Œå¿…é¡»åˆ›å»ºå¤šä¸ªCountDownLatchå¯¹è±¡ï¼Œè§ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">2</span>);</span><br><span class="line">        service.submit(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task1 start...&quot;</span>);</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">            latch.countDown();</span><br><span class="line">        &#125;);</span><br><span class="line">        service.submit(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task2 start...&quot;</span>);</span><br><span class="line">            sleep(<span class="number">2</span>);</span><br><span class="line">            latch.countDown();</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            latch.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;task1 task2 finish...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    service.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c8262116-9df2-473d-ab68-c09ee454370a-2"><p>å¾ªç¯æ …æ ï¼Œç”¨æ¥è¿›è¡Œçº¿ç¨‹åä½œï¼Œç­‰å¾…çº¿ç¨‹æ»¡è¶³æŸä¸ªè®¡æ•°ã€‚æ„é€ æ—¶è®¾ç½®ã€è®¡æ•°ä¸ªæ•°ã€ï¼Œæ¯ä¸ªçº¿ç¨‹æ‰§ è¡Œåˆ°æŸä¸ªéœ€è¦â€œåŒæ­¥â€çš„æ—¶åˆ»è°ƒç”¨ await() æ–¹æ³•è¿›è¡Œç­‰å¾…ï¼Œå½“ç­‰å¾…çš„çº¿ç¨‹æ•°æ»¡è¶³ã€è®¡æ•°ä¸ªæ•°ã€æ—¶ï¼Œç»§ç»­æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line"><span class="type">CyclicBarrier</span> <span class="variable">barrier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CyclicBarrier</span>(<span class="number">2</span>, ()-&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;task1, task2 finish...&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123; <span class="comment">// task1  task2  task1</span></span><br><span class="line">    service.submit(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;task1 begin...&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            barrier.await(); <span class="comment">// 2-1=1</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    service.submit(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;task2 begin...&quot;</span>);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            barrier.await(); <span class="comment">// 1-1=0</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">service.shutdown();</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼šçº¿ç¨‹ä¸ªæ•°åº”è¯¥ä¸å€’è®¡æ—¶ä¸ªæ•°ç›¸åŒï¼Œå¦‚æœçº¿ç¨‹æ± çº¿ç¨‹ä¸ªæ•°ä¸º3ï¼Œå¯èƒ½task1  task2  task1éƒ½æ‰§è¡Œï¼Œå¯èƒ½ä¸ºä¸¤ä¸ªtask1 å®Œæˆäº†å€’è®¡æ—¶</p></blockquote><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <blockquote><p><strong>æ³¨æ„</strong></p><ul><li>CyclicBarrier ä¸ CountDownLatch çš„ä¸»è¦åŒºåˆ«åœ¨äº CyclicBarrier æ˜¯å¯ä»¥é‡ç”¨çš„ CyclicBarrier å¯ä»¥è¢«æ¯” å–»ä¸ºã€äººæ»¡å‘è½¦ã€</li><li>CountDownLatchçš„è®¡æ•°å’Œé˜»å¡æ–¹æ³•æ˜¯åˆ†å¼€çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œè€ŒCyclicBarrieræ˜¯ä¸€ä¸ªæ–¹æ³•ã€‚</li><li>CyclicBarrierçš„æ„é€ å™¨è¿˜æœ‰ä¸€ä¸ªRunnableç±»å‹çš„å‚æ•°ï¼Œåœ¨è®¡æ•°ä¸º0æ—¶ä¼šæ‰§è¡Œå…¶ä¸­çš„runæ–¹æ³•ã€‚</li></ul></blockquote><h2 id="9-çº¿ç¨‹å®‰å…¨é›†åˆç±»æ¦‚è¿°">9. çº¿ç¨‹å®‰å…¨é›†åˆç±»æ¦‚è¿°</h2><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220316174115768.png" alt="image-20220316174115768"></p><p>çº¿ç¨‹å®‰å…¨é›†åˆç±»å¯ä»¥åˆ†ä¸ºä¸‰å¤§ç±»ï¼š</p><ul><li>é—ç•™çš„çº¿ç¨‹å®‰å…¨é›†åˆå¦‚<code>Hashtable</code>ï¼Œ<code>Vector</code></li><li>ä½¿ç”¨<code>Collections</code>è£…é¥°çš„çº¿ç¨‹å®‰å…¨é›†åˆï¼Œå¦‚ï¼š<ul><li><code>Collections.synchronizedCollection </code></li><li><code>Collections.synchronizedList </code></li><li><code>Collections.synchronizedMap </code></li><li><code>Collections.synchronizedSet </code></li><li><code>Collections.synchronizedNavigableMap </code></li><li><code>Collections.synchronizedNavigableSet  </code></li><li><code>Collections.synchronizedSortedMap </code></li><li><code>Collections.synchronizedSortedSet </code></li><li>è¯´æ˜ï¼šä»¥ä¸Šé›†åˆå‡é‡‡ç”¨ä¿®é¥°æ¨¡å¼è®¾è®¡ï¼Œå°†éçº¿ç¨‹å®‰å…¨çš„é›†åˆåŒ…è£…åï¼Œåœ¨è°ƒç”¨æ–¹æ³•æ—¶åŒ…è£¹äº†ä¸€å±‚synchronizedä»£ç å—ã€‚å…¶å¹¶å‘æ€§å¹¶ä¸æ¯”é—ç•™çš„å®‰å…¨é›†åˆå¥½ã€‚</li></ul></li><li>java.util.concurrent.*</li></ul><p>é‡ç‚¹ä»‹ç»<code>java.util.concurrent.* </code>ä¸‹çš„çº¿ç¨‹å®‰å…¨é›†åˆç±»ï¼Œå¯ä»¥å‘ç°å®ƒä»¬æœ‰è§„å¾‹ï¼Œé‡Œé¢åŒ…å«ä¸‰ç±»å…³é”®è¯ï¼š Blockingã€CopyOnWriteã€Concurrent</p><ul><li>Blocking å¤§éƒ¨åˆ†å®ç°åŸºäºé”ï¼Œå¹¶æä¾›ç”¨æ¥é˜»å¡çš„æ–¹æ³•</li><li>CopyOnWrite ä¹‹ç±»å®¹å™¨ä¿®æ”¹å¼€é”€ç›¸å¯¹è¾ƒé‡</li><li>Concurrent ç±»å‹çš„å®¹å™¨<ul><li>å†…éƒ¨å¾ˆå¤šæ“ä½œä½¿ç”¨ cas ä¼˜åŒ–ï¼Œä¸€èˆ¬å¯ä»¥æä¾›è¾ƒé«˜ååé‡</li><li>å¼±ä¸€è‡´æ€§<ul><li>éå†æ—¶å¼±ä¸€è‡´æ€§ï¼Œä¾‹å¦‚ï¼Œå½“åˆ©ç”¨è¿­ä»£å™¨éå†æ—¶ï¼Œå¦‚æœå®¹å™¨å‘ç”Ÿä¿®æ”¹ï¼Œè¿­ä»£å™¨ä»ç„¶å¯ä»¥ç»§ç»­è¿›è¡Œé å†ï¼Œè¿™æ—¶å†…å®¹æ˜¯æ—§çš„</li><li>æ±‚å¤§å°å¼±ä¸€è‡´æ€§ï¼Œsize æ“ä½œæœªå¿…æ˜¯ 100% å‡†ç¡®</li><li>è¯»å–å¼±ä¸€è‡´æ€§</li></ul></li></ul></li></ul><blockquote><p>éå†æ—¶å¦‚æœå‘ç”Ÿäº†ä¿®æ”¹ï¼Œå¯¹äºéå®‰å…¨å®¹å™¨æ¥è®²ï¼Œä½¿ç”¨ <strong>fail-fast</strong> æœºåˆ¶ä¹Ÿå°±æ˜¯è®©éå†ç«‹åˆ»å¤±è´¥ï¼ŒæŠ›å‡º ConcurrentModificationExceptionï¼Œä¸å†ç»§ç»­éå†</p></blockquote><h2 id="10-ConcurrentHashMap">10. ConcurrentHashMap</h2><p>å•è¯è®¡æ•°</p><p>åœ¨26ä¸ªæ–‡ä»¶ä¸­ï¼Œ26ä¸ªè‹±æ–‡å­—æ¯æ¯ä¸ªéƒ½æœ‰200ä¸ªå­˜åœ¨åœ¨è¿™26ä¸ªæ–‡ä»¶ä¸­ï¼Œä½ ç°åœ¨éœ€è¦ä»æ–‡ä»¶ä¸­ç»Ÿè®¡å‡ºæ¯ä¸ªå­—æ¯çš„ä¸ªæ•°ã€‚å¦‚æœç»Ÿè®¡æ­£ç¡®ï¼Œé‚£ä¹ˆæ¯ä¸ªå­—æ¯çš„ä¸ªæ•°è¯¥ä¸º200ä¸ªã€‚</p><div class="tabs" id="6a32eea2-e5a0-46cb-a7ed-2f2789203ef0"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6a32eea2-e5a0-46cb-a7ed-2f2789203ef0-1"><i class="fas fa-bug"></i>æµ‹è¯•ä»£ç </button></li><li class="tab"><button type="button" data-href="#6a32eea2-e5a0-46cb-a7ed-2f2789203ef0-2"><i class="fas fa-cannabis"></i>HashMapç»Ÿè®¡</button></li><li class="tab"><button type="button" data-href="#6a32eea2-e5a0-46cb-a7ed-2f2789203ef0-3"><i class="fas fa-candy-cane"></i>é”™è¯¯ä½¿ç”¨ConcurrentHashMap</button></li><li class="tab"><button type="button" data-href="#6a32eea2-e5a0-46cb-a7ed-2f2789203ef0-4"><i class="fas fa-child"></i>æ­£ç¡®ä½¿ç”¨ConcurrentHashMap</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6a32eea2-e5a0-46cb-a7ed-2f2789203ef0-1"><p>ä½ æ‰€éœ€è¦åšçš„å°±æ˜¯æä¾› Mapå’Œç»Ÿè®¡æ–¹æ³•å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;V&gt; <span class="keyword">void</span> <span class="title function_">demo</span><span class="params">(Supplier&lt;Map&lt;String, V&gt;&gt; supplier, BiConsumer&lt;Map&lt;String, V&gt;, List&lt;String&gt;&gt; consumer)</span> &#123;</span><br><span class="line">    Map&lt;String, V&gt; counterMap = supplier.get();</span><br><span class="line">    List&lt;Thread&gt; ts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">26</span>; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> i;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            List&lt;String&gt; words = readFromFile(idx);</span><br><span class="line">            consumer.accept(counterMap, words);</span><br><span class="line">        &#125;);</span><br><span class="line">        ts.add(thread);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ts.forEach(t -&gt; t.start());</span><br><span class="line">    ts.forEach(t -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            t.join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    System.out.println(counterMap);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title function_">readFromFile</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">    ArrayList&lt;String&gt; words = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;tmp/&quot;</span> + i + <span class="string">&quot;.txt&quot;</span>)))) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">word</span> <span class="operator">=</span> in.readLine();</span><br><span class="line">            <span class="keyword">if</span> (word == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            words.add(word);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> words;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6a32eea2-e5a0-46cb-a7ed-2f2789203ef0-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">demo(</span><br><span class="line">        () -&gt;<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String,Integer&gt;(),</span><br><span class="line">        (map,words)-&gt;&#123;</span><br><span class="line">            <span class="keyword">for</span>(String word :words)&#123;</span><br><span class="line"></span><br><span class="line">             <span class="type">Integer</span> <span class="variable">counter</span> <span class="operator">=</span>map.get(word);</span><br><span class="line">             <span class="type">int</span> <span class="variable">newValue</span> <span class="operator">=</span>counter==<span class="literal">null</span>?<span class="number">1</span>:counter+<span class="number">1</span>;</span><br><span class="line">             map.put(word,newValue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;a=<span class="number">189</span>, b=<span class="number">198</span>, c=<span class="number">200</span>, d=<span class="number">188</span>, e=<span class="number">198</span>, f=<span class="number">188</span>, g=<span class="number">173</span>, h=<span class="number">198</span>, i=<span class="number">183</span>, j=<span class="number">200</span>, k=<span class="number">184</span>, l=<span class="number">189</span>, m=<span class="number">162</span>, n=<span class="number">200</span>, o=<span class="number">200</span>, p=<span class="number">194</span>, q=<span class="number">200</span>, r=<span class="number">185</span>, s=<span class="number">200</span>, t=<span class="number">200</span>, u=<span class="number">97</span>, v=<span class="number">92</span>, w=<span class="number">167</span>, x=<span class="number">200</span>, y=<span class="number">198</span>, z=<span class="number">190</span>&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6a32eea2-e5a0-46cb-a7ed-2f2789203ef0-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">demo(</span><br><span class="line">        () -&gt;<span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String,Integer&gt;(),</span><br><span class="line">        (map,words)-&gt;&#123;</span><br><span class="line">            <span class="keyword">for</span>(String word :words)&#123;</span><br><span class="line">             <span class="type">Integer</span> <span class="variable">counter</span> <span class="operator">=</span>map.get(word);</span><br><span class="line">             <span class="type">int</span> <span class="variable">newValue</span> <span class="operator">=</span>counter==<span class="literal">null</span>?<span class="number">1</span>:counter+<span class="number">1</span>;</span><br><span class="line">             map.put(word,newValue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;a=<span class="number">196</span>, b=<span class="number">199</span>, c=<span class="number">141</span>, d=<span class="number">135</span>, e=<span class="number">188</span>, f=<span class="number">129</span>, g=<span class="number">183</span>, h=<span class="number">184</span>, i=<span class="number">132</span>, j=<span class="number">130</span>, k=<span class="number">169</span>, l=<span class="number">48</span>, m=<span class="number">141</span>, n=<span class="number">185</span>, o=<span class="number">197</span>, p=<span class="number">41</span>, q=<span class="number">34</span>, r=<span class="number">105</span>, s=<span class="number">199</span>, t=<span class="number">55</span>, u=<span class="number">186</span>, v=<span class="number">158</span>, w=<span class="number">67</span>, x=<span class="number">69</span>, y=<span class="number">125</span>, z=<span class="number">188</span>&#125;</span><br></pre></td></tr></table></figure><p>é”™è¯¯åŸå› ï¼š</p><ul><li>ConcurrentHashMapè™½ç„¶æ¯ä¸ªæ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯å¤šä¸ªæ–¹æ³•çš„ç»„åˆå¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6a32eea2-e5a0-46cb-a7ed-2f2789203ef0-4"><p>åŸæ¥æ˜¯å…ˆè¦æ£€æŸ¥è¿™ä¸ªkeyæœ‰æ²¡æœ‰ï¼Œæ²¡æœ‰çš„è¯è¿›è¡ŒPutï¼Œè¿™ä¸ªç»„åˆå°±ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„äº†ã€‚</p><p>computIfAbsentæ–¹æ³•çš„ä½œç”¨æ˜¯ï¼šå½“mapä¸­ä¸å­˜åœ¨ä»¥å‚æ•°1ä¸ºkeyå¯¹åº”çš„valueæ—¶ï¼Œä¼šå°†å‚æ•°2å‡½æ•°å¼æ¥å£çš„è¿”å›å€¼ä½œä¸ºvalueï¼Œputè¿›mapä¸­ï¼Œç„¶åè¿”å›è¯¥valueã€‚å¦‚æœå­˜åœ¨keyï¼Œåˆ™ç›´æ¥è¿”å›valueã€‚ä»¥ä¸Šä¸¤éƒ¨å‡æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">demo(</span><br><span class="line">        () -&gt; <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, LongAdder&gt;(<span class="number">8</span>,<span class="number">0.75f</span>,<span class="number">8</span>),</span><br><span class="line"></span><br><span class="line">        (map, words) -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (String word : words) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å¦‚æœç¼ºå°‘ä¸€ä¸ª keyï¼Œåˆ™è®¡ç®—ç”Ÿæˆä¸€ä¸ª value , ç„¶åå°†  key value æ”¾å…¥ map</span></span><br><span class="line">              <span class="comment">// ä¿è¯ get Put åŸå­æ€§</span></span><br><span class="line">                <span class="type">LongAdder</span> <span class="variable">value</span> <span class="operator">=</span> map.computeIfAbsent(word, (key) -&gt; <span class="keyword">new</span> <span class="title class_">LongAdder</span>());</span><br><span class="line">                <span class="comment">// æ‰§è¡Œç´¯åŠ </span></span><br><span class="line">              <span class="comment">// ä¿è¯ç´¯åŠ åŸå­æ€§</span></span><br><span class="line">                value.increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;a=<span class="number">200</span>, b=<span class="number">200</span>, c=<span class="number">200</span>, d=<span class="number">200</span>, e=<span class="number">200</span>, f=<span class="number">200</span>, g=<span class="number">200</span>, h=<span class="number">200</span>, i=<span class="number">200</span>, j=<span class="number">200</span>, k=<span class="number">200</span>, l=<span class="number">200</span>, m=<span class="number">200</span>, n=<span class="number">200</span>, o=<span class="number">200</span>, p=<span class="number">200</span>, q=<span class="number">200</span>, r=<span class="number">200</span>, s=<span class="number">200</span>, t=<span class="number">200</span>, u=<span class="number">200</span>, v=<span class="number">200</span>, w=<span class="number">200</span>, x=<span class="number">200</span>, y=<span class="number">200</span>, z=<span class="number">200</span>&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="10-1-ConcurrentHashMap-åŸç†">10.1 ConcurrentHashMap åŸç†</h3><h4 id="10-1-1-HashMap-å¹¶å‘æ­»é“¾">10.1.1 HashMap å¹¶å‘æ­»é“¾</h4><p>æ³¨æ„</p><ul><li>è¦åœ¨ JDK 7 ä¸‹è¿è¡Œï¼Œå¦åˆ™æ‰©å®¹æœºåˆ¶å’Œ hash çš„è®¡ç®—æ–¹æ³•éƒ½å˜äº†ï¼ˆJDK7 æ’å…¥é‡‡ç”¨å¤´æ’æ³• JDKé‡‡ç”¨å°¾æ’æ³• ä¸ƒä¸Šå…«ä¸‹ï¼‰</li><li>ä»¥ä¸‹æµ‹è¯•ä»£ç æ˜¯ç²¾å¿ƒå‡†å¤‡çš„ï¼Œä¸è¦éšä¾¿æ”¹åŠ¨ JDK7 æ‰©å®¹å¹¶å‘æ­»é“¾</li></ul><div class="tabs" id="52ba4830-c292-46ee-b675-b4b7d2516a78"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#52ba4830-c292-46ee-b675-b4b7d2516a78-1"><i class="fas fa-bug"></i>æµ‹è¯•ä»£ç </button></li><li class="tab"><button type="button" data-href="#52ba4830-c292-46ee-b675-b4b7d2516a78-2"><i class="fas fa-cannabis"></i>æ­»é“¾å¤ç°</button></li><li class="tab"><button type="button" data-href="#52ba4830-c292-46ee-b675-b4b7d2516a78-3"><i class="fas fa-candy-cane"></i>æºç å¤ç°</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="52ba4830-c292-46ee-b675-b4b7d2516a78-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// 1, 35, 16, 50 å½“å¤§å°ä¸º16æ—¶ï¼Œå®ƒä»¬åœ¨ä¸€ä¸ªæ¡¶å†…</span></span><br><span class="line">    <span class="keyword">final</span> HashMap&lt;Integer, Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Integer, Integer&gt;();</span><br><span class="line">    <span class="comment">// æ”¾ 12 ä¸ªå…ƒç´ </span></span><br><span class="line">    map.put(<span class="number">2</span>, <span class="literal">null</span>);</span><br><span class="line">    map.put(<span class="number">3</span>, <span class="literal">null</span>);</span><br><span class="line">    map.put(<span class="number">4</span>, <span class="literal">null</span>);</span><br><span class="line">    map.put(<span class="number">5</span>, <span class="literal">null</span>);</span><br><span class="line">    map.put(<span class="number">6</span>, <span class="literal">null</span>);</span><br><span class="line">    map.put(<span class="number">7</span>, <span class="literal">null</span>);</span><br><span class="line">    map.put(<span class="number">8</span>, <span class="literal">null</span>);</span><br><span class="line">    map.put(<span class="number">9</span>, <span class="literal">null</span>);</span><br><span class="line">    map.put(<span class="number">10</span>, <span class="literal">null</span>);</span><br><span class="line">    map.put(<span class="number">16</span>, <span class="literal">null</span>);</span><br><span class="line">    map.put(<span class="number">35</span>, <span class="literal">null</span>);</span><br><span class="line">    map.put(<span class="number">1</span>, <span class="literal">null</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;æ‰©å®¹å‰å¤§å°[main]:&quot;</span>+map.size());</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// æ”¾ç¬¬ 13 ä¸ªå…ƒç´ , å‘ç”Ÿæ‰©å®¹</span></span><br><span class="line">            map.put(<span class="number">50</span>, <span class="literal">null</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;æ‰©å®¹åå¤§å°[Thread-0]:&quot;</span>+map.size());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// æ”¾ç¬¬ 13 ä¸ªå…ƒç´ , å‘ç”Ÿæ‰©å®¹</span></span><br><span class="line">            map.put(<span class="number">50</span>, <span class="literal">null</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;æ‰©å®¹åå¤§å°[Thread-1]:&quot;</span>+map.size());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.start();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object k)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != h &amp;&amp; k <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        <span class="keyword">return</span> sun.misc.Hashing.stringHash32((String) k);</span><br><span class="line">    &#125;</span><br><span class="line">    h ^= k.hashCode();</span><br><span class="line">    h ^= (h &gt;&gt;&gt; <span class="number">20</span>) ^ (h &gt;&gt;&gt; <span class="number">12</span>);</span><br><span class="line">    <span class="keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="number">7</span>) ^ (h &gt;&gt;&gt; <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="52ba4830-c292-46ee-b675-b4b7d2516a78-2"><p>è°ƒè¯•å·¥å…·ä½¿ç”¨ idea</p><p>åœ¨ HashMap æºç  590 è¡ŒåŠ æ–­ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">newCapacity</span> <span class="operator">=</span> newTable.length;</span><br></pre></td></tr></table></figure><p>æ–­ç‚¹çš„æ¡ä»¶å¦‚ä¸‹ï¼Œç›®çš„æ˜¯è®© HashMap åœ¨æ‰©å®¹ä¸º 32 æ—¶ï¼Œå¹¶ä¸”çº¿ç¨‹ä¸º Thread-0 æˆ– Thread-1 æ—¶åœä¸‹æ¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">newTable.length==<span class="number">32</span> &amp;&amp;</span><br><span class="line"> (</span><br><span class="line"> Thread.currentThread().getName().equals(<span class="string">&quot;Thread-0&quot;</span>)||</span><br><span class="line"> Thread.currentThread().getName().equals(<span class="string">&quot;Thread-1&quot;</span>)</span><br><span class="line"> )</span><br></pre></td></tr></table></figure><p>æ–­ç‚¹æš‚åœæ–¹å¼é€‰æ‹© Threadï¼Œå¦åˆ™åœ¨è°ƒè¯• Thread-0 æ—¶ï¼ŒThread-1 æ— æ³•æ¢å¤è¿è¡Œ</p><p>è¿è¡Œä»£ç ï¼Œç¨‹åºåœ¨é¢„æ–™çš„æ–­ç‚¹ä½ç½®åœäº†ä¸‹æ¥ï¼Œè¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">é•¿åº¦ä¸º16æ—¶ï¼Œæ¡¶ä¸‹æ ‡ä¸º1çš„key </span><br><span class="line">1 </span><br><span class="line">16 </span><br><span class="line">35 </span><br><span class="line">50 </span><br><span class="line">é•¿åº¦ä¸º32æ—¶ï¼Œæ¡¶ä¸‹æ ‡ä¸º1çš„key </span><br><span class="line">1 </span><br><span class="line">35 </span><br><span class="line">æ‰©å®¹å‰å¤§å°[main]:12 </span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è¿›å…¥æ‰©å®¹æµç¨‹è°ƒè¯•</p><p>åœ¨ HashMap æºç  594 è¡ŒåŠ æ–­ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Entry&lt;K,V&gt; next = e.next; <span class="comment">// 593</span></span><br><span class="line"><span class="keyword">if</span> (rehash) <span class="comment">// 594</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸ºäº†è§‚å¯Ÿ e èŠ‚ç‚¹å’Œ next èŠ‚ç‚¹çš„çŠ¶æ€ï¼ŒThread-0 å•æ­¥æ‰§è¡Œåˆ° 594 è¡Œï¼Œå† 594 å¤„å†æ·»åŠ ä¸€ä¸ªæ–­ç‚¹ï¼ˆæ¡ä»¶ Thread.currentThread().getName().equals(â€œThread-0â€)ï¼‰</p><p>è¿™æ—¶å¯ä»¥åœ¨ Variables é¢æ¿è§‚å¯Ÿåˆ° e å’Œ next å˜é‡ï¼Œä½¿ç”¨<code>view as -&gt; Object</code>æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">e (<span class="number">1</span>)-&gt;(<span class="number">35</span>)-&gt;(<span class="number">16</span>)-&gt;<span class="literal">null</span> </span><br><span class="line"><span class="title function_">next</span> <span class="params">(<span class="number">35</span>)</span>-&gt;(<span class="number">16</span>)-&gt;<span class="literal">null</span> </span><br></pre></td></tr></table></figure><p>åœ¨ Threads é¢æ¿é€‰ä¸­ Thread-1 æ¢å¤è¿è¡Œï¼Œå¯ä»¥çœ‹åˆ°æ§åˆ¶å°è¾“å‡ºæ–°çš„å†…å®¹å¦‚ä¸‹ï¼ŒThread-1 æ‰©å®¹å·²å®Œæˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">newTable[<span class="number">1</span>] (<span class="number">35</span>)-&gt;(<span class="number">1</span>)-&gt;<span class="literal">null</span> </span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æ‰©å®¹åå¤§å°:13 </span><br></pre></td></tr></table></figure><p>è¿™æ—¶ Thread-0 è¿˜åœåœ¨ 594 å¤„ï¼Œ Variables é¢æ¿å˜é‡çš„çŠ¶æ€å·²ç»å˜åŒ–ä¸º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">e (<span class="number">1</span>)-&gt;<span class="literal">null</span> </span><br><span class="line"><span class="title function_">next</span> <span class="params">(<span class="number">35</span>)</span>-&gt;(<span class="number">1</span>)-&gt;<span class="literal">null</span> </span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆå‘¢ï¼Œå› ä¸º Thread-1 æ‰©å®¹æ—¶é“¾è¡¨ä¹Ÿæ˜¯ååŠ å…¥çš„å…ƒç´ æ”¾å…¥é“¾è¡¨å¤´ï¼Œå› æ­¤é“¾è¡¨å°±å€’è¿‡æ¥äº†ï¼Œä½† Thread-1 è™½ç„¶ç»“ æœæ­£ç¡®ï¼Œä½†å®ƒç»“æŸå Thread-0 è¿˜è¦ç»§ç»­è¿è¡Œ</p><p>æ¥ä¸‹æ¥å°±å¯ä»¥å•æ­¥è°ƒè¯•ï¼ˆF8ï¼‰è§‚å¯Ÿæ­»é“¾çš„äº§ç”Ÿäº†</p><p>ä¸‹ä¸€è½®å¾ªç¯åˆ° 594ï¼Œå°† e æ¬è¿åˆ° newTable é“¾è¡¨å¤´</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">newTable[<span class="number">1</span>] (<span class="number">1</span>)-&gt;<span class="literal">null</span> </span><br><span class="line"><span class="title function_">e</span> <span class="params">(<span class="number">35</span>)</span>-&gt;(<span class="number">1</span>)-&gt;<span class="literal">null</span> </span><br><span class="line"><span class="title function_">next</span> <span class="params">(<span class="number">1</span>)</span>-&gt;<span class="literal">null</span></span><br></pre></td></tr></table></figure><p>ä¸‹ä¸€è½®å¾ªç¯åˆ° 594ï¼Œå°† e æ¬è¿åˆ° newTable é“¾è¡¨å¤´</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">newTable[<span class="number">1</span>] (<span class="number">35</span>)-&gt;(<span class="number">1</span>)-&gt;<span class="literal">null</span> </span><br><span class="line"><span class="title function_">e</span> <span class="params">(<span class="number">1</span>)</span>-&gt;<span class="literal">null</span> </span><br><span class="line">next <span class="literal">null</span> </span><br></pre></td></tr></table></figure><p>å†çœ‹çœ‹æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">e.next = newTable[<span class="number">1</span>];</span><br><span class="line"><span class="comment">// è¿™æ—¶ e (1,35)</span></span><br><span class="line"><span class="comment">// è€Œ newTable[1] (35,1)-&gt;(1,35) å› ä¸ºæ˜¯åŒä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line">newTable[<span class="number">1</span>] = e; </span><br><span class="line"><span class="comment">// å†å°è¯•å°† e ä½œä¸ºé“¾è¡¨å¤´, æ­»é“¾å·²æˆ</span></span><br><span class="line">e = next;</span><br><span class="line"><span class="comment">// è™½ç„¶ next æ˜¯ null, ä¼šè¿›å…¥ä¸‹ä¸€ä¸ªé“¾è¡¨çš„å¤åˆ¶, ä½†æ­»é“¾å·²ç»å½¢æˆäº†</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="52ba4830-c292-46ee-b675-b4b7d2516a78-3"><p>HashMap çš„å¹¶å‘æ­»é“¾å‘ç”Ÿåœ¨æ‰©å®¹æ—¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°† table è¿ç§»è‡³ newTable</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(Entry[] newTable, <span class="type">boolean</span> rehash)</span> &#123; </span><br><span class="line">    <span class="type">int</span> <span class="variable">newCapacity</span> <span class="operator">=</span> newTable.length;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e : table) &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">null</span> != e) &#123;</span><br><span class="line">            Entry&lt;K,V&gt; next = e.next;</span><br><span class="line">            <span class="comment">// 1 å¤„</span></span><br><span class="line">            <span class="keyword">if</span> (rehash) &#123;</span><br><span class="line">                e.hash = <span class="literal">null</span> == e.key ? <span class="number">0</span> : hash(e.key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> indexFor(e.hash, newCapacity);</span><br><span class="line">            <span class="comment">// 2 å¤„</span></span><br><span class="line">            <span class="comment">// å°†æ–°å…ƒç´ åŠ å…¥ newTable[i], åŸ newTable[i] ä½œä¸ºæ–°å…ƒç´ çš„ next</span></span><br><span class="line">            e.next = newTable[i];</span><br><span class="line">            newTable[i] = e;</span><br><span class="line">            e = next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾ map ä¸­åˆå§‹å…ƒç´ æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">åŸå§‹é“¾è¡¨ï¼Œæ ¼å¼ï¼š[ä¸‹æ ‡] (key,next)</span><br><span class="line">[<span class="number">1</span>] (<span class="number">1</span>,<span class="number">35</span>)-&gt;(<span class="number">35</span>,<span class="number">16</span>)-&gt;(<span class="number">16</span>,<span class="literal">null</span>)</span><br><span class="line">çº¿ç¨‹ a æ‰§è¡Œåˆ° <span class="number">1</span> å¤„ ï¼Œæ­¤æ—¶å±€éƒ¨å˜é‡ e ä¸º (<span class="number">1</span>,<span class="number">35</span>)ï¼Œè€Œå±€éƒ¨å˜é‡ next ä¸º (<span class="number">35</span>,<span class="number">16</span>) çº¿ç¨‹ a æŒ‚èµ·</span><br><span class="line">çº¿ç¨‹ b å¼€å§‹æ‰§è¡Œ</span><br><span class="line">ç¬¬ä¸€æ¬¡å¾ªç¯</span><br><span class="line">[<span class="number">1</span>] (<span class="number">1</span>,<span class="literal">null</span>)</span><br><span class="line">ç¬¬äºŒæ¬¡å¾ªç¯</span><br><span class="line">[<span class="number">1</span>] (<span class="number">35</span>,<span class="number">1</span>)-&gt;(<span class="number">1</span>,<span class="literal">null</span>)</span><br><span class="line">ç¬¬ä¸‰æ¬¡å¾ªç¯</span><br><span class="line">[<span class="number">1</span>] (<span class="number">35</span>,<span class="number">1</span>)-&gt;(<span class="number">1</span>,<span class="literal">null</span>)</span><br><span class="line">[<span class="number">17</span>] (<span class="number">16</span>,<span class="literal">null</span>)</span><br><span class="line">åˆ‡æ¢å›çº¿ç¨‹ aï¼Œæ­¤æ—¶å±€éƒ¨å˜é‡ e å’Œ next è¢«æ¢å¤ï¼Œå¼•ç”¨æ²¡å˜ä½†å†…å®¹å˜äº†ï¼še çš„å†…å®¹è¢«æ”¹ä¸º (<span class="number">1</span>,<span class="literal">null</span>)ï¼Œè€Œ next çš„å†…</span><br><span class="line">å®¹è¢«æ”¹ä¸º (<span class="number">35</span>,<span class="number">1</span>) å¹¶é“¾å‘ (<span class="number">1</span>,<span class="literal">null</span>)</span><br><span class="line">ç¬¬ä¸€æ¬¡å¾ªç¯</span><br><span class="line">[<span class="number">1</span>] (<span class="number">1</span>,<span class="literal">null</span>)</span><br><span class="line">ç¬¬äºŒæ¬¡å¾ªç¯ï¼Œæ³¨æ„è¿™æ—¶ e æ˜¯ (<span class="number">35</span>,<span class="number">1</span>) å¹¶é“¾å‘ (<span class="number">1</span>,<span class="literal">null</span>) æ‰€ä»¥ next åˆæ˜¯ (<span class="number">1</span>,<span class="literal">null</span>)</span><br><span class="line">[<span class="number">1</span>] (<span class="number">35</span>,<span class="number">1</span>)-&gt;(<span class="number">1</span>,<span class="literal">null</span>)</span><br><span class="line">ç¬¬ä¸‰æ¬¡å¾ªç¯ï¼Œe æ˜¯ (<span class="number">1</span>,<span class="literal">null</span>)ï¼Œè€Œ next æ˜¯ <span class="literal">null</span>ï¼Œä½† e è¢«æ”¾å…¥é“¾è¡¨å¤´ï¼Œè¿™æ · e.next å˜æˆäº† <span class="number">35</span> ï¼ˆ<span class="number">2</span> å¤„ï¼‰</span><br><span class="line">[<span class="number">1</span>] (<span class="number">1</span>,<span class="number">35</span>)-&gt;(<span class="number">35</span>,<span class="number">1</span>)-&gt;(<span class="number">1</span>,<span class="number">35</span>)</span><br><span class="line">å·²ç»æ˜¯æ­»é“¾äº†</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p><strong>å°ç»“</strong></p><ul><li>ç©¶å…¶åŸå› ï¼Œæ˜¯å› ä¸ºåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨äº†éçº¿ç¨‹å®‰å…¨çš„ map é›†åˆ</li><li>JDK 8 è™½ç„¶å°†æ‰©å®¹ç®—æ³•åšäº†è°ƒæ•´ï¼Œä¸å†å°†å…ƒç´ åŠ å…¥é“¾è¡¨å¤´ï¼ˆè€Œæ˜¯ä¿æŒä¸æ‰©å®¹å‰ä¸€æ ·çš„é¡ºåºï¼‰ï¼Œä½†ä»ä¸æ„å‘³ç€èƒ½ å¤Ÿåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹èƒ½å¤Ÿå®‰å…¨æ‰©å®¹ï¼Œè¿˜ä¼šå‡ºç°å…¶å®ƒé—®é¢˜ï¼ˆå¦‚æ‰©å®¹ä¸¢æ•°æ®ï¼‰</li></ul><h4 id="10-1-2-JDK8-CHM">10.1.2 JDK8 CHM</h4><div class="tabs" id="828127d7-517f-4c92-83cb-1be3abb84ae2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#828127d7-517f-4c92-83cb-1be3abb84ae2-1"><i class="fas fa-bug"></i>é‡è¦å±æ€§å’Œå†…éƒ¨ç±»</button></li><li class="tab"><button type="button" data-href="#828127d7-517f-4c92-83cb-1be3abb84ae2-2"><i class="fas fa-cannabis"></i>é‡è¦æ–¹æ³•</button></li><li class="tab"><button type="button" data-href="#828127d7-517f-4c92-83cb-1be3abb84ae2-3"><i class="fas fa-candy-cane"></i>æ„é€ å™¨åˆ†æ</button></li><li class="tab"><button type="button" data-href="#828127d7-517f-4c92-83cb-1be3abb84ae2-4"><i class="fas fa-child"></i>getæµç¨‹</button></li><li class="tab"><button type="button" data-href="#828127d7-517f-4c92-83cb-1be3abb84ae2-5"><i class="fas fa-award"></i>put æµç¨‹</button></li><li class="tab"><button type="button" data-href="#828127d7-517f-4c92-83cb-1be3abb84ae2-6"><i class="fas fa-baseball-ball"></i>sizeè®¡ç®—</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="828127d7-517f-4c92-83cb-1be3abb84ae2-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é»˜è®¤ä¸º 0</span></span><br><span class="line"><span class="comment">// å½“åˆå§‹åŒ–æ—¶, ä¸º -1</span></span><br><span class="line"><span class="comment">// å½“æ‰©å®¹æ—¶, ä¸º -(1 + æ‰©å®¹çº¿ç¨‹æ•°)</span></span><br><span class="line"><span class="comment">// å½“åˆå§‹åŒ–æˆ–æ‰©å®¹å®Œæˆåï¼Œä¸º ä¸‹ä¸€æ¬¡çš„æ‰©å®¹çš„é˜ˆå€¼å¤§å°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">int</span> sizeCtl;</span><br><span class="line"><span class="comment">// æ•´ä¸ª ConcurrentHashMap å°±æ˜¯ä¸€ä¸ª Node[]</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">Map</span>.Entry&lt;K,V&gt; &#123;&#125;</span><br><span class="line"><span class="comment">// hash è¡¨</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] table;</span><br><span class="line"><span class="comment">// æ‰©å®¹æ—¶çš„ æ–° hash è¡¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line"><span class="comment">// æ‰©å®¹æ—¶å¦‚æœæŸä¸ª bin è¿ç§»å®Œæ¯•, ç”¨ ForwardingNode ä½œä¸ºæ—§ table bin çš„å¤´ç»“ç‚¹</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ForwardingNode</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">Node</span>&lt;K,V&gt; &#123;&#125;</span><br><span class="line"><span class="comment">// ç”¨åœ¨ compute ä»¥åŠ computeIfAbsent æ—¶, ç”¨æ¥å ä½, è®¡ç®—å®Œæˆåæ›¿æ¢ä¸ºæ™®é€š Node</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ReservationNode</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">Node</span>&lt;K,V&gt; &#123;&#125;</span><br><span class="line"><span class="comment">// ä½œä¸º treebin çš„å¤´èŠ‚ç‚¹, å­˜å‚¨ root å’Œ first</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TreeBin</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">Node</span>&lt;K,V&gt; &#123;&#125;</span><br><span class="line"><span class="comment">// ä½œä¸º treebin çš„èŠ‚ç‚¹, å­˜å‚¨ parent, left, right</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TreeNode</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">Node</span>&lt;K,V&gt; &#123;&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="828127d7-517f-4c92-83cb-1be3abb84ae2-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å– Node[] ä¸­ç¬¬ i ä¸ª Node</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; Node&lt;K,V&gt; <span class="title function_">tabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="type">int</span> i)</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// cas ä¿®æ”¹ Node[] ä¸­ç¬¬ i ä¸ª Node çš„å€¼, c ä¸ºæ—§å€¼, v ä¸ºæ–°å€¼</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="type">boolean</span> <span class="title function_">casTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="type">int</span> i, Node&lt;K,V&gt; c, Node&lt;K,V&gt; v)</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// ç›´æ¥ä¿®æ”¹ Node[] ä¸­ç¬¬ i ä¸ª Node çš„å€¼, v ä¸ºæ–°å€¼</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="keyword">void</span> <span class="title function_">setTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="type">int</span> i, Node&lt;K,V&gt; v)</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="828127d7-517f-4c92-83cb-1be3abb84ae2-3"><p>å¯ä»¥çœ‹åˆ°å®ç°äº†æ‡’æƒ°åˆå§‹åŒ–ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­ä»…ä»…è®¡ç®—äº† table çš„å¤§å°ï¼Œä»¥ååœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶æ‰ä¼šçœŸæ­£åˆ›å»º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentHashMap</span><span class="params">(<span class="type">int</span> initialCapacity, <span class="type">float</span> loadFactor, <span class="type">int</span> concurrencyLevel)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(loadFactor &gt; <span class="number">0.0f</span>) || initialCapacity &lt; <span class="number">0</span> || concurrencyLevel &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; concurrencyLevel) <span class="comment">// Use at least as many bins</span></span><br><span class="line">        initialCapacity = concurrencyLevel; <span class="comment">// as estimated threads</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">size</span> <span class="operator">=</span> (<span class="type">long</span>)(<span class="number">1.0</span> + (<span class="type">long</span>)initialCapacity / loadFactor);</span><br><span class="line">    <span class="comment">// tableSizeFor ä»ç„¶æ˜¯ä¿è¯è®¡ç®—çš„å¤§å°æ˜¯ 2^n, å³ 16,32,64 ... </span></span><br><span class="line">    <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> (size &gt;= (<span class="type">long</span>)MAXIMUM_CAPACITY) ?</span><br><span class="line">        MAXIMUM_CAPACITY : tableSizeFor((<span class="type">int</span>)size);</span><br><span class="line">    <span class="built_in">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="828127d7-517f-4c92-83cb-1be3abb84ae2-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="type">int</span> n, eh; K ek;</span><br><span class="line">    <span class="comment">// spread æ–¹æ³•èƒ½ç¡®ä¿è¿”å›ç»“æœæ˜¯æ­£æ•°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> spread(key.hashCode());</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå¤´ç»“ç‚¹å·²ç»æ˜¯è¦æŸ¥æ‰¾çš„ key</span></span><br><span class="line">        <span class="keyword">if</span> ((eh = e.hash) == h) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((ek = e.key) == key || (ek != <span class="literal">null</span> &amp;&amp; key.equals(ek)))</span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// hash ä¸ºè´Ÿæ•°è¡¨ç¤ºè¯¥ bin åœ¨æ‰©å®¹ä¸­æˆ–æ˜¯ treebin, è¿™æ—¶è°ƒç”¨ find æ–¹æ³•æ¥æŸ¥æ‰¾</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (eh &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> (p = e.find(h, key)) != <span class="literal">null</span> ? p.val : <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// æ­£å¸¸éå†é“¾è¡¨, ç”¨ equals æ¯”è¾ƒ</span></span><br><span class="line">        <span class="keyword">while</span> ((e = e.next) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                ((ek = e.key) == key || (ek != <span class="literal">null</span> &amp;&amp; key.equals(ek))))</span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ï¼š</p><ul><li>å¦‚æœtableä¸ä¸ºç©ºä¸”é•¿åº¦å¤§äº0ä¸”ç´¢å¼•ä½ç½®æœ‰å…ƒç´ <ul><li>if å¤´èŠ‚ç‚¹keyçš„hashå€¼ç›¸ç­‰<ul><li>å¤´èŠ‚ç‚¹çš„keyæŒ‡å‘åŒä¸€ä¸ªåœ°å€æˆ–è€…equals<ul><li>è¿”å›value</li></ul></li></ul></li><li>else if å¤´èŠ‚ç‚¹çš„hashä¸ºè´Ÿæ•°ï¼ˆbinåœ¨æ‰©å®¹æˆ–è€…æ˜¯treebinï¼‰<ul><li>è°ƒç”¨findæ–¹æ³•æŸ¥æ‰¾</li></ul></li><li>è¿›å…¥å¾ªç¯ï¼ˆeä¸ä¸ºç©ºï¼‰ï¼š<ul><li>èŠ‚ç‚¹keyçš„hashå€¼ç›¸ç­‰ï¼Œä¸”keyæŒ‡å‘åŒä¸€ä¸ªåœ°å€æˆ–equals<ul><li>è¿”å›value</li></ul></li></ul></li></ul></li><li>è¿”å›null</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="828127d7-517f-4c92-83cb-1be3abb84ae2-5"><p>ä»¥ä¸‹æ•°ç»„ç®€ç§°ï¼ˆtableï¼‰ï¼Œé“¾è¡¨ç®€ç§°ï¼ˆbinï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(key, value, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> V <span class="title function_">putVal</span><span class="params">(K key, V value, <span class="type">boolean</span> onlyIfAbsent)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span> || value == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">// å…¶ä¸­ spread æ–¹æ³•ä¼šç»¼åˆé«˜ä½ä½ä½, å…·æœ‰æ›´å¥½çš„ hash æ€§</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> spread(key.hashCode());</span><br><span class="line">    <span class="type">int</span> <span class="variable">binCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        <span class="comment">// f æ˜¯é“¾è¡¨å¤´èŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">// fh æ˜¯é“¾è¡¨å¤´ç»“ç‚¹çš„ hash</span></span><br><span class="line">        <span class="comment">// i æ˜¯é“¾è¡¨åœ¨ table ä¸­çš„ä¸‹æ ‡</span></span><br><span class="line">        Node&lt;K,V&gt; f; <span class="type">int</span> n, i, fh;</span><br><span class="line">        <span class="comment">// è¦åˆ›å»º table</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ– table ä½¿ç”¨äº† cas, æ— éœ€ synchronized åˆ›å»ºæˆåŠŸ, è¿›å…¥ä¸‹ä¸€è½®å¾ªç¯</span></span><br><span class="line">            tab = initTable();</span><br><span class="line">        <span class="comment">// è¦åˆ›å»ºé“¾è¡¨å¤´èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æ·»åŠ é“¾è¡¨å¤´ä½¿ç”¨äº† cas, æ— éœ€ synchronized</span></span><br><span class="line">            <span class="keyword">if</span> (casTabAt(tab, i, <span class="literal">null</span>,</span><br><span class="line">                         <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(hash, key, value, <span class="literal">null</span>)))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¸®å¿™æ‰©å®¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            <span class="comment">// å¸®å¿™ä¹‹å, è¿›å…¥ä¸‹ä¸€è½®å¾ªç¯</span></span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">V</span> <span class="variable">oldVal</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// é”ä½é“¾è¡¨å¤´èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="comment">// å†æ¬¡ç¡®è®¤é“¾è¡¨å¤´èŠ‚ç‚¹æ²¡æœ‰è¢«ç§»åŠ¨</span></span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="comment">// é“¾è¡¨</span></span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        binCount = <span class="number">1</span>;</span><br><span class="line">                        <span class="comment">// éå†é“¾è¡¨</span></span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                            K ek;</span><br><span class="line">                            <span class="comment">// æ‰¾åˆ°ç›¸åŒçš„ key</span></span><br><span class="line">                            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                 (ek != <span class="literal">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                oldVal = e.val;</span><br><span class="line">                                <span class="comment">// æ›´æ–°</span></span><br><span class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                    e.val = value;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            Node&lt;K,V&gt; pred = e;</span><br><span class="line">                            <span class="comment">// å·²ç»æ˜¯æœ€åçš„èŠ‚ç‚¹äº†, æ–°å¢ Node, è¿½åŠ è‡³é“¾è¡¨å°¾</span></span><br><span class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="literal">null</span>) &#123;</span><br><span class="line">                                pred.next = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                          value, <span class="literal">null</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// çº¢é»‘æ ‘</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        Node&lt;K,V&gt; p;</span><br><span class="line">                        binCount = <span class="number">2</span>;</span><br><span class="line">                        <span class="comment">// putTreeVal ä¼šçœ‹ key æ˜¯å¦å·²ç»åœ¨æ ‘ä¸­, æ˜¯, åˆ™è¿”å›å¯¹åº”çš„ TreeNode</span></span><br><span class="line">                        <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                              value)) != <span class="literal">null</span>) &#123;</span><br><span class="line">                            oldVal = p.val;</span><br><span class="line">                            <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                p.val = value;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// é‡Šæ”¾é“¾è¡¨å¤´èŠ‚ç‚¹çš„é”</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123; </span><br><span class="line">                <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                    <span class="comment">// å¦‚æœé“¾è¡¨é•¿åº¦ &gt;= æ ‘åŒ–é˜ˆå€¼(8), è¿›è¡Œé“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘</span></span><br><span class="line">                    treeifyBin(tab, i);</span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="literal">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¢åŠ  size è®¡æ•°</span></span><br><span class="line">    addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; <span class="type">int</span> sc;</span><br><span class="line">    <span class="keyword">while</span> ((tab = table) == <span class="literal">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</span><br><span class="line">            Thread.<span class="keyword">yield</span>();</span><br><span class="line">        <span class="comment">// å°è¯•å°† sizeCtl è®¾ç½®ä¸º -1ï¼ˆè¡¨ç¤ºåˆå§‹åŒ– tableï¼‰</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="comment">// è·å¾—é”, åˆ›å»º table, è¿™æ—¶å…¶å®ƒçº¿ç¨‹ä¼šåœ¨ while() å¾ªç¯ä¸­ yield ç›´è‡³ table åˆ›å»º</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ((tab = table) == <span class="literal">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">                    Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>&lt;?,?&gt;[n];</span><br><span class="line">                    table = tab = nt;</span><br><span class="line">                    sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                sizeCtl = sc;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tab;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// check æ˜¯ä¹‹å‰ binCount çš„ä¸ªæ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">addCount</span><span class="params">(<span class="type">long</span> x, <span class="type">int</span> check)</span> &#123;</span><br><span class="line">    CounterCell[] as; <span class="type">long</span> b, s;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        <span class="comment">// å·²ç»æœ‰äº† counterCells, å‘ cell ç´¯åŠ </span></span><br><span class="line">        (as = counterCells) != <span class="literal">null</span> ||</span><br><span class="line">        <span class="comment">// è¿˜æ²¡æœ‰, å‘ baseCount ç´¯åŠ </span></span><br><span class="line">        !U.compareAndSwapLong(<span class="built_in">this</span>, BASECOUNT, b = baseCount, s = b + x)</span><br><span class="line">    ) &#123;</span><br><span class="line">        CounterCell a; <span class="type">long</span> v; <span class="type">int</span> m;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">uncontended</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            <span class="comment">// è¿˜æ²¡æœ‰ counterCells</span></span><br><span class="line">            as == <span class="literal">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">            <span class="comment">// è¿˜æ²¡æœ‰ cell</span></span><br><span class="line">            (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span class="literal">null</span> ||</span><br><span class="line">            <span class="comment">// cell cas å¢åŠ è®¡æ•°å¤±è´¥</span></span><br><span class="line">            !(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»ºç´¯åŠ å•å…ƒæ•°ç»„å’Œcell, ç´¯åŠ é‡è¯•</span></span><br><span class="line">            fullAddCount(x, uncontended);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (check &lt;= <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// è·å–å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">        s = sumCount();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (check &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab, nt; <span class="type">int</span> n, sc;</span><br><span class="line">        <span class="keyword">while</span> (s &gt;= (<span class="type">long</span>)(sc = sizeCtl) &amp;&amp; (tab = table) != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">               (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> resizeStamp(n);</span><br><span class="line">            <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                    sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="literal">null</span> ||</span><br><span class="line">                    transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// newtable å·²ç»åˆ›å»ºäº†ï¼Œå¸®å¿™æ‰©å®¹</span></span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                    transfer(tab, nt);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// éœ€è¦æ‰©å®¹ï¼Œè¿™æ—¶ newtable æœªåˆ›å»º</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc,</span><br><span class="line">                                         (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                transfer(tab, <span class="literal">null</span>);</span><br><span class="line">            s = sumCount();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ï¼š</p><ul><li>è¿›å…¥forå¾ªç¯ï¼š<ul><li>if  tableä¸ºnullæˆ–è€…é•¿åº¦ ä¸º0<ul><li>åˆå§‹åŒ–è¡¨</li></ul></li><li>else if ç´¢å¼•å¤„æ— èŠ‚ç‚¹<ul><li>åˆ›å»ºèŠ‚ç‚¹ï¼Œå¡«å…¥keyå’Œvalueï¼Œæ”¾å…¥tableï¼Œé€€å‡ºå¾ªç¯</li></ul></li><li>else if ç´¢å¼•å¤„èŠ‚ç‚¹çš„hashå€¼ä¸ºMOVEï¼ˆForwardingNodeï¼‰ï¼Œè¡¨ç¤ºæ­£åœ¨æ‰©å®¹å’Œè¿ç§»<ul><li>å¸®å¿™</li></ul></li><li>else<ul><li>é”ä½å¤´èŠ‚ç‚¹<ul><li>if å†æ¬¡ç¡®è®¤å¤´èŠ‚ç‚¹æ²¡æœ‰è¢«ç§»åŠ¨<ul><li>if  å¤´èŠ‚ç‚¹hashå€¼å¤§äº0ï¼ˆè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼‰<ul><li>éå†é“¾è¡¨æ‰¾åˆ°å¯¹åº”keyï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºã€‚</li></ul></li><li>else if èŠ‚ç‚¹ä¸ºçº¢é»‘æ ‘èŠ‚ç‚¹<ul><li>è°ƒç”¨<code>putTreeVal</code>æŸ¥çœ‹æ˜¯å¦æœ‰å¯¹åº”keyçš„æ•°èŠ‚ç‚¹<ul><li>å¦‚æœæœ‰ä¸”ä¸ºè¦†ç›–æ¨¡å¼ï¼Œå°†å€¼è¦†ç›–ï¼Œè¿”å›æ—§å€¼</li><li>å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºå¹¶æ’å…¥ï¼Œè¿”å›null</li></ul></li></ul></li></ul></li><li>è§£é”</li></ul></li><li>if binCountä¸ä¸º0<ul><li>å¦‚æœbinCountå¤§äºæ ‘åŒ–é˜ˆå€¼8<ul><li>æ ‘åŒ–</li></ul></li><li>å¦‚æœæ—§å€¼ä¸ä¸ºnull<ul><li>è¿”å›æ—§å€¼</li></ul></li><li>break</li></ul></li></ul></li></ul></li><li>å¢åŠ sizeè®¡æ•°</li><li>return null</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="828127d7-517f-4c92-83cb-1be3abb84ae2-6"><p>size è®¡ç®—å®é™…å‘ç”Ÿåœ¨ putï¼Œremove æ”¹å˜é›†åˆå…ƒç´ çš„æ“ä½œä¹‹ä¸­</p><ul><li>æ²¡æœ‰ç«äº‰å‘ç”Ÿï¼Œå‘ baseCount ç´¯åŠ è®¡æ•°</li><li>æœ‰ç«äº‰å‘ç”Ÿï¼Œæ–°å»º counterCellsï¼Œå‘å…¶ä¸­çš„ä¸€ä¸ª cell ç´¯åŠ è®¡<ul><li>counterCells åˆå§‹æœ‰ä¸¤ä¸ª cell</li><li>å¦‚æœè®¡æ•°ç«äº‰æ¯”è¾ƒæ¿€çƒˆï¼Œä¼šåˆ›å»ºæ–°çš„ cell æ¥ç´¯åŠ è®¡æ•°</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">n</span> <span class="operator">=</span> sumCount();</span><br><span class="line">    <span class="keyword">return</span> ((n &lt; <span class="number">0L</span>) ? <span class="number">0</span> :</span><br><span class="line">            (n &gt; (<span class="type">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE :</span><br><span class="line">            (<span class="type">int</span>)n);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="title function_">sumCount</span><span class="params">()</span> &#123;</span><br><span class="line">    CounterCell[] as = counterCells; CounterCell a;</span><br><span class="line">    <span class="comment">// å°† baseCount è®¡æ•°ä¸æ‰€æœ‰ cell è®¡æ•°ç´¯åŠ </span></span><br><span class="line">    <span class="type">long</span> <span class="variable">sum</span> <span class="operator">=</span> baseCount;</span><br><span class="line">    <span class="keyword">if</span> (as != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="literal">null</span>)</span><br><span class="line">                sum += a.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><blockquote><p>æ€»ç»“</p><p><strong>Java 8</strong> æ•°ç»„ï¼ˆNodeï¼‰ +ï¼ˆ é“¾è¡¨ Node | çº¢é»‘æ ‘ TreeNode ï¼‰ ä»¥ä¸‹æ•°ç»„ç®€ç§°ï¼ˆtableï¼‰ï¼Œé“¾è¡¨ç®€ç§°ï¼ˆbinï¼‰</p><ul><li>åˆå§‹åŒ–ï¼Œä½¿ç”¨ cas æ¥ä¿è¯å¹¶å‘å®‰å…¨ï¼Œæ‡’æƒ°åˆå§‹åŒ– table</li><li>æ ‘åŒ–ï¼Œå½“ table.length &lt; 64 æ—¶ï¼Œå…ˆå°è¯•æ‰©å®¹ï¼Œè¶…è¿‡ 64 æ—¶ï¼Œå¹¶ä¸” bin.length &gt; 8 æ—¶ï¼Œä¼šå°†é“¾è¡¨æ ‘åŒ–ï¼Œæ ‘åŒ–è¿‡ç¨‹ ä¼šç”¨ synchronized é”ä½é“¾è¡¨å¤´</li><li>putï¼Œå¦‚æœè¯¥ bin å°šæœªåˆ›å»ºï¼Œåªéœ€è¦ä½¿ç”¨ cas åˆ›å»º binï¼›å¦‚æœå·²ç»æœ‰äº†ï¼Œé”ä½é“¾è¡¨å¤´è¿›è¡Œåç»­ put æ“ä½œï¼Œå…ƒç´  æ·»åŠ è‡³ bin çš„å°¾éƒ¨</li><li>getï¼Œæ— é”æ“ä½œä»…éœ€è¦ä¿è¯å¯è§æ€§ï¼Œæ‰©å®¹è¿‡ç¨‹ä¸­ get æ“ä½œæ‹¿åˆ°çš„æ˜¯ ForwardingNode å®ƒä¼šè®© get æ“ä½œåœ¨æ–° table è¿›è¡Œæœç´¢</li><li>æ‰©å®¹ï¼Œæ‰©å®¹æ—¶ä»¥ bin ä¸ºå•ä½è¿›è¡Œï¼Œéœ€è¦å¯¹ bin è¿›è¡Œ synchronizedï¼Œä½†è¿™æ—¶å¦™çš„æ˜¯å…¶å®ƒç«äº‰çº¿ç¨‹ä¹Ÿä¸æ˜¯æ— äº‹å¯ åšï¼Œå®ƒä»¬ä¼šå¸®åŠ©æŠŠå…¶å®ƒ bin è¿›è¡Œæ‰©å®¹ï¼Œæ‰©å®¹æ—¶å¹³å‡åªæœ‰ 1/6 çš„èŠ‚ç‚¹ä¼šæŠŠå¤åˆ¶åˆ°æ–° table ä¸­</li><li>sizeï¼Œå…ƒç´ ä¸ªæ•°ä¿å­˜åœ¨ baseCount ä¸­ï¼Œå¹¶å‘æ—¶çš„ä¸ªæ•°å˜åŠ¨ä¿å­˜åœ¨ CounterCell[] å½“ä¸­ã€‚æœ€åç»Ÿè®¡æ•°é‡æ—¶ç´¯åŠ  å³å¯</li></ul><p>æºç åˆ†æ <a href="http://www.importnew.com/28263.html">http://www.importnew.com/28263.html</a></p><p>å…¶å®ƒå®ç° <a href="https://github.com/boundary/high-scale-lib">Cliff Clickâ€™s high scale lib</a></p></blockquote><h4 id="10-1-3-JDK7-CHM">10.1.3 JDK7 CHM</h4><p>å®ƒç»´æŠ¤äº†ä¸€ä¸ª segment æ•°ç»„ï¼Œæ¯ä¸ª segment å¯¹åº”ä¸€æŠŠé”</p><ul><li>ä¼˜ç‚¹ï¼šå¦‚æœå¤šä¸ªçº¿ç¨‹è®¿é—®ä¸åŒçš„ segmentï¼Œå®é™…æ˜¯æ²¡æœ‰å†²çªçš„ï¼Œè¿™ä¸ jdk8 ä¸­æ˜¯ç±»ä¼¼çš„</li><li>ç¼ºç‚¹ï¼šSegments æ•°ç»„é»˜è®¤å¤§å°ä¸º16ï¼Œè¿™ä¸ªå®¹é‡åˆå§‹åŒ–æŒ‡å®šåå°±ä¸èƒ½æ”¹å˜äº†ï¼Œå¹¶ä¸”ä¸æ˜¯æ‡’æƒ°åˆå§‹åŒ–</li></ul><div class="tabs" id="5b6f4c97-ee01-4078-ac5f-49d57c177243"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#5b6f4c97-ee01-4078-ac5f-49d57c177243-1"><i class="fas fa-bug"></i>æ„é€ å™¨åˆ†æ</button></li><li class="tab"><button type="button" data-href="#5b6f4c97-ee01-4078-ac5f-49d57c177243-2"><i class="fas fa-cannabis"></i>put æµç¨‹</button></li><li class="tab"><button type="button" data-href="#5b6f4c97-ee01-4078-ac5f-49d57c177243-3"><i class="fas fa-candy-cane"></i>rehashæµç¨‹</button></li><li class="tab"><button type="button" data-href="#5b6f4c97-ee01-4078-ac5f-49d57c177243-4"><i class="fas fa-child"></i>get æµç¨‹</button></li><li class="tab"><button type="button" data-href="#5b6f4c97-ee01-4078-ac5f-49d57c177243-5"><i class="fas fa-cat"></i>size è®¡ç®—</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="5b6f4c97-ee01-4078-ac5f-49d57c177243-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentHashMap</span><span class="params">(<span class="type">int</span> initialCapacity, <span class="type">float</span> loadFactor, <span class="type">int</span> concurrencyLevel)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(loadFactor &gt; <span class="number">0</span>) || initialCapacity &lt; <span class="number">0</span> || concurrencyLevel &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="keyword">if</span> (concurrencyLevel &gt; MAX_SEGMENTS)</span><br><span class="line">        concurrencyLevel = MAX_SEGMENTS;</span><br><span class="line">    <span class="comment">// ssize å¿…é¡»æ˜¯ 2^n, å³ 2, 4, 8, 16 ... è¡¨ç¤ºäº† segments æ•°ç»„çš„å¤§å°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">sshift</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ssize</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (ssize &lt; concurrencyLevel) &#123;</span><br><span class="line">        ++sshift;</span><br><span class="line">        ssize &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// segmentShift é»˜è®¤æ˜¯ 32 - 4 = 28</span></span><br><span class="line">    <span class="built_in">this</span>.segmentShift = <span class="number">32</span> - sshift;</span><br><span class="line">    <span class="comment">// segmentMask é»˜è®¤æ˜¯ 15 å³ 0000 0000 0000 1111</span></span><br><span class="line">    <span class="built_in">this</span>.segmentMask = ssize - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">        initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> initialCapacity / ssize;</span><br><span class="line">    <span class="keyword">if</span> (c * ssize &lt; initialCapacity)</span><br><span class="line">        ++c;</span><br><span class="line">    <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> MIN_SEGMENT_TABLE_CAPACITY;</span><br><span class="line">    <span class="keyword">while</span> (cap &lt; c)</span><br><span class="line">        cap &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// åˆ›å»º segments and segments[0]</span></span><br><span class="line">    Segment&lt;K,V&gt; s0 =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Segment</span>&lt;K,V&gt;(loadFactor, (<span class="type">int</span>)(cap * loadFactor),</span><br><span class="line">                         (HashEntry&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">HashEntry</span>[cap]);</span><br><span class="line">    Segment&lt;K,V&gt;[] ss = (Segment&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Segment</span>[ssize];</span><br><span class="line">    UNSAFE.putOrderedObject(ss, SBASE, s0); <span class="comment">// ordered write of segments[0]</span></span><br><span class="line">    <span class="built_in">this</span>.segments = ss;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ å®Œæˆï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317180837785.png" alt="image-20220317180837785" style="zoom:50%;" /><p>å¯ä»¥çœ‹åˆ° ConcurrentHashMap æ²¡æœ‰å®ç°æ‡’æƒ°åˆå§‹åŒ–ï¼Œç©ºé—´å ç”¨ä¸å‹å¥½</p><p>å…¶ä¸­ this.segmentShift å’Œ this.segmentMask çš„ä½œç”¨æ˜¯å†³å®šå°† key çš„ hash ç»“æœåŒ¹é…åˆ°å“ªä¸ª segment</p><p>ä¾‹å¦‚ï¼Œæ ¹æ®æŸä¸€ hash å€¼æ±‚ segment ä½ç½®ï¼Œå…ˆå°†é«˜ä½å‘ä½ä½ç§»åŠ¨ this.segmentShift ä½</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317180919562.png" alt="image-20220317180919562"></p><p>ç»“æœå†ä¸ this.segmentMask åšä½äºè¿ç®—ï¼Œæœ€ç»ˆå¾—åˆ° 1010 å³ä¸‹æ ‡ä¸º 10 çš„ segment</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317180935914.png" alt="image-20220317180935914"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5b6f4c97-ee01-4078-ac5f-49d57c177243-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    Segment&lt;K,V&gt; s;</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> hash(key);</span><br><span class="line">    <span class="comment">// è®¡ç®—å‡º segment ä¸‹æ ‡</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å¾— segment å¯¹è±¡, åˆ¤æ–­æ˜¯å¦ä¸º null, æ˜¯åˆ™åˆ›å»ºè¯¥ segment</span></span><br><span class="line">    <span class="keyword">if</span> ((s = (Segment&lt;K,V&gt;)UNSAFE.getObject </span><br><span class="line">         (segments, (j &lt;&lt; SSHIFT) + SBASE)) == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// è¿™æ—¶ä¸èƒ½ç¡®å®šæ˜¯å¦çœŸçš„ä¸º null, å› ä¸ºå…¶å®ƒçº¿ç¨‹ä¹Ÿå‘ç°è¯¥ segment ä¸º null,</span></span><br><span class="line">        <span class="comment">// å› æ­¤åœ¨ ensureSegment é‡Œç”¨ cas æ–¹å¼ä¿è¯è¯¥ segment å®‰å…¨æ€§</span></span><br><span class="line">        s = ensureSegment(j);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿›å…¥ segment çš„put æµç¨‹</span></span><br><span class="line">    <span class="keyword">return</span> s.put(key, hash, value, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>segment ç»§æ‰¿äº†å¯é‡å…¥é”ï¼ˆReentrantLockï¼‰ï¼Œå®ƒçš„ put æ–¹æ³•ä¸º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> V <span class="title function_">put</span><span class="params">(K key, <span class="type">int</span> hash, V value, <span class="type">boolean</span> onlyIfAbsent)</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•åŠ é”</span></span><br><span class="line">    HashEntry&lt;K,V&gt; node = tryLock() ? <span class="literal">null</span> :</span><br><span class="line">    <span class="comment">// å¦‚æœä¸æˆåŠŸ, è¿›å…¥ scanAndLockForPut æµç¨‹</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯å¤šæ ¸ cpu æœ€å¤š tryLock 64 æ¬¡, è¿›å…¥ lock æµç¨‹</span></span><br><span class="line">    <span class="comment">// åœ¨å°è¯•æœŸé—´, è¿˜å¯ä»¥é¡ºä¾¿çœ‹è¯¥èŠ‚ç‚¹åœ¨é“¾è¡¨ä¸­æœ‰æ²¡æœ‰, å¦‚æœæ²¡æœ‰é¡ºä¾¿åˆ›å»ºå‡ºæ¥</span></span><br><span class="line">    scanAndLockForPut(key, hash, value);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œåˆ°è¿™é‡Œ segment å·²ç»è¢«æˆåŠŸåŠ é”, å¯ä»¥å®‰å…¨æ‰§è¡Œ</span></span><br><span class="line">    V oldValue;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        HashEntry&lt;K,V&gt;[] tab = table;</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (tab.length - <span class="number">1</span>) &amp; hash;</span><br><span class="line">        HashEntry&lt;K,V&gt; first = entryAt(tab, index);</span><br><span class="line">        <span class="keyword">for</span> (HashEntry&lt;K,V&gt; e = first;;) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// æ›´æ–°</span></span><br><span class="line">                K k;</span><br><span class="line">                <span class="keyword">if</span> ((k = e.key) == key ||</span><br><span class="line">                    (e.hash == hash &amp;&amp; key.equals(k))) &#123; </span><br><span class="line">                    oldValue = e.value;</span><br><span class="line">                    <span class="keyword">if</span> (!onlyIfAbsent) &#123;</span><br><span class="line">                        e.value = value;</span><br><span class="line">                        ++modCount;</span><br><span class="line">                    &#125; <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                e = e.next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// æ–°å¢</span></span><br><span class="line">                <span class="comment">// 1) ä¹‹å‰ç­‰å¾…é”æ—¶, node å·²ç»è¢«åˆ›å»º, next æŒ‡å‘é“¾è¡¨å¤´</span></span><br><span class="line">                <span class="keyword">if</span> (node != <span class="literal">null</span>)</span><br><span class="line">                    node.setNext(first);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="comment">// 2) åˆ›å»ºæ–° node</span></span><br><span class="line">                    node = <span class="keyword">new</span> <span class="title class_">HashEntry</span>&lt;K,V&gt;(hash, key, value, first);</span><br><span class="line">                <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> count + <span class="number">1</span>; </span><br><span class="line">                <span class="comment">// 3) æ‰©å®¹</span></span><br><span class="line">                <span class="keyword">if</span> (c &gt; threshold &amp;&amp; tab.length &lt; MAXIMUM_CAPACITY)</span><br><span class="line">                    rehash(node);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="comment">// å°† node ä½œä¸ºé“¾è¡¨å¤´</span></span><br><span class="line">                    setEntryAt(tab, index, node);</span><br><span class="line">                ++modCount;</span><br><span class="line">                count = c;</span><br><span class="line">                oldValue = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> oldValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5b6f4c97-ee01-4078-ac5f-49d57c177243-3"><p>å‘ç”Ÿåœ¨ put ä¸­ï¼Œå› ä¸ºæ­¤æ—¶å·²ç»è·å¾—äº†é”ï¼Œå› æ­¤ rehash æ—¶ä¸éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">rehash</span><span class="params">(HashEntry&lt;K,V&gt; node)</span> &#123;</span><br><span class="line">    HashEntry&lt;K,V&gt;[] oldTable = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldCapacity</span> <span class="operator">=</span> oldTable.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">newCapacity</span> <span class="operator">=</span> oldCapacity &lt;&lt; <span class="number">1</span>;</span><br><span class="line">    threshold = (<span class="type">int</span>)(newCapacity * loadFactor);</span><br><span class="line">    HashEntry&lt;K,V&gt;[] newTable =</span><br><span class="line">        (HashEntry&lt;K,V&gt;[]) <span class="keyword">new</span> <span class="title class_">HashEntry</span>[newCapacity];</span><br><span class="line">    <span class="type">int</span> <span class="variable">sizeMask</span> <span class="operator">=</span> newCapacity - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; oldCapacity ; i++) &#123;</span><br><span class="line">        HashEntry&lt;K,V&gt; e = oldTable[i];</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            HashEntry&lt;K,V&gt; next = e.next;</span><br><span class="line">            <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> e.hash &amp; sizeMask;</span><br><span class="line">            <span class="keyword">if</span> (next == <span class="literal">null</span>) <span class="comment">// Single node on list</span></span><br><span class="line">                newTable[idx] = e;</span><br><span class="line">            <span class="keyword">else</span> &#123; <span class="comment">// Reuse consecutive sequence at same slot</span></span><br><span class="line">                HashEntry&lt;K,V&gt; lastRun = e;</span><br><span class="line">                <span class="type">int</span> <span class="variable">lastIdx</span> <span class="operator">=</span> idx;</span><br><span class="line">                <span class="comment">// è¿‡ä¸€éé“¾è¡¨, å°½å¯èƒ½æŠŠ rehash å idx ä¸å˜çš„èŠ‚ç‚¹é‡ç”¨</span></span><br><span class="line">                <span class="keyword">for</span> (HashEntry&lt;K,V&gt; last = next;</span><br><span class="line">                     last != <span class="literal">null</span>;</span><br><span class="line">                     last = last.next) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> last.hash &amp; sizeMask;</span><br><span class="line">                    <span class="keyword">if</span> (k != lastIdx) &#123;</span><br><span class="line">                        lastIdx = k;</span><br><span class="line">                        lastRun = last;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                newTable[lastIdx] = lastRun;</span><br><span class="line">                <span class="comment">// å‰©ä½™èŠ‚ç‚¹éœ€è¦æ–°å»º</span></span><br><span class="line">                <span class="keyword">for</span> (HashEntry&lt;K,V&gt; p = e; p != lastRun; p = p.next) &#123;</span><br><span class="line">                    <span class="type">V</span> <span class="variable">v</span> <span class="operator">=</span> p.value;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> p.hash;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> h &amp; sizeMask;</span><br><span class="line">                    HashEntry&lt;K,V&gt; n = newTable[k];</span><br><span class="line">                    newTable[k] = <span class="keyword">new</span> <span class="title class_">HashEntry</span>&lt;K,V&gt;(h, p.key, v, n);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ‰©å®¹å®Œæˆ, æ‰åŠ å…¥æ–°çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">nodeIndex</span> <span class="operator">=</span> node.hash &amp; sizeMask; <span class="comment">// add the new node</span></span><br><span class="line">    node.setNext(newTable[nodeIndex]);</span><br><span class="line">    newTable[nodeIndex] = node;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›¿æ¢ä¸ºæ–°çš„ HashEntry table</span></span><br><span class="line">    table = newTable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™„ï¼Œè°ƒè¯•ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    ConcurrentHashMap&lt;Integer, String&gt; map = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> hash(i);</span><br><span class="line">        <span class="type">int</span> <span class="variable">segmentIndex</span> <span class="operator">=</span> (hash &gt;&gt;&gt; <span class="number">28</span>) &amp; <span class="number">15</span>;</span><br><span class="line">        <span class="keyword">if</span> (segmentIndex == <span class="number">4</span> &amp;&amp; hash % <span class="number">8</span> == <span class="number">2</span>) &#123;</span><br><span class="line">            System.out.println(i + <span class="string">&quot;\t&quot;</span> + segmentIndex + <span class="string">&quot;\t&quot;</span> + hash % <span class="number">2</span> + <span class="string">&quot;\t&quot;</span> + hash % <span class="number">4</span> +</span><br><span class="line">                               <span class="string">&quot;\t&quot;</span> + hash % <span class="number">8</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    map.put(<span class="number">1</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">    map.put(<span class="number">15</span>, <span class="string">&quot;value&quot;</span>); <span class="comment">// 2 æ‰©å®¹ä¸º 4 15 çš„ hash%8 ä¸å…¶ä»–ä¸åŒ</span></span><br><span class="line">    map.put(<span class="number">169</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">    map.put(<span class="number">197</span>, <span class="string">&quot;value&quot;</span>); <span class="comment">// 4 æ‰©å®¹ä¸º 8</span></span><br><span class="line">    map.put(<span class="number">341</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">    map.put(<span class="number">484</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">    map.put(<span class="number">545</span>, <span class="string">&quot;value&quot;</span>); <span class="comment">// 8 æ‰©å®¹ä¸º 16</span></span><br><span class="line">    map.put(<span class="number">912</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">    map.put(<span class="number">941</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object k)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="number">0</span> != h) &amp;&amp; (k <span class="keyword">instanceof</span> String)) &#123;</span><br><span class="line">        <span class="keyword">return</span> sun.misc.Hashing.stringHash32((String) k);</span><br><span class="line">    &#125;</span><br><span class="line">    h ^= k.hashCode();</span><br><span class="line">    <span class="comment">// Spread bits to regularize both segment and index locations,</span></span><br><span class="line">    <span class="comment">// using variant of single-word Wang/Jenkins hash.</span></span><br><span class="line">    h += (h &lt;&lt; <span class="number">15</span>) ^ <span class="number">0xffffcd7d</span>;</span><br><span class="line">    h ^= (h &gt;&gt;&gt; <span class="number">10</span>);</span><br><span class="line">    h += (h &lt;&lt; <span class="number">3</span>);</span><br><span class="line">    h ^= (h &gt;&gt;&gt; <span class="number">6</span>);</span><br><span class="line">    h += (h &lt;&lt; <span class="number">2</span>) + (h &lt;&lt; <span class="number">14</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">v</span> <span class="operator">=</span> h ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5b6f4c97-ee01-4078-ac5f-49d57c177243-4"><p>get æ—¶å¹¶æœªåŠ é”ï¼Œç”¨äº† UNSAFE æ–¹æ³•ä¿è¯äº†å¯è§æ€§ï¼Œæ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œget å…ˆå‘ç”Ÿå°±ä»æ—§è¡¨å–å†…å®¹ï¼Œget åå‘ç”Ÿå°±ä»æ–° è¡¨å–å†…å®¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    Segment&lt;K,V&gt; s; <span class="comment">// manually integrate access methods to reduce overhead</span></span><br><span class="line">    HashEntry&lt;K,V&gt;[] tab;</span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> hash(key);</span><br><span class="line">    <span class="comment">// u ä¸º segment å¯¹è±¡åœ¨æ•°ç»„ä¸­çš„åç§»é‡</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">u</span> <span class="operator">=</span> (((h &gt;&gt;&gt; segmentShift) &amp; segmentMask) &lt;&lt; SSHIFT) + SBASE;</span><br><span class="line">    <span class="comment">// s å³ä¸º segment</span></span><br><span class="line">    <span class="keyword">if</span> ((s = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(segments, u)) != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        (tab = s.table) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (HashEntry&lt;K,V&gt; e = (HashEntry&lt;K,V&gt;) UNSAFE.getObjectVolatile</span><br><span class="line">             (tab, ((<span class="type">long</span>)(((tab.length - <span class="number">1</span>) &amp; h)) &lt;&lt; TSHIFT) + TBASE);</span><br><span class="line">             e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">            K k;</span><br><span class="line">            <span class="keyword">if</span> ((k = e.key) == key || (e.hash == h &amp;&amp; key.equals(k)))</span><br><span class="line">                <span class="keyword">return</span> e.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5b6f4c97-ee01-4078-ac5f-49d57c177243-5"><ul><li>è®¡ç®—å…ƒç´ ä¸ªæ•°å‰ï¼Œå…ˆä¸åŠ é”è®¡ç®—ä¸¤æ¬¡ï¼Œå¦‚æœå‰åä¸¤æ¬¡ç»“æœå¦‚ä¸€æ ·ï¼Œè®¤ä¸ºä¸ªæ•°æ­£ç¡®è¿”å›</li><li>å¦‚æœä¸ä¸€æ ·ï¼Œè¿›è¡Œé‡è¯•ï¼Œé‡è¯•æ¬¡æ•°è¶…è¿‡ 3ï¼Œå°†æ‰€æœ‰ segment é”ä½ï¼Œé‡æ–°è®¡ç®—ä¸ªæ•°è¿”å›</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Try a few times to get accurate count. On failure due to</span></span><br><span class="line">    <span class="comment">// continuous async changes in table, resort to locking.</span></span><br><span class="line">    <span class="keyword">final</span> Segment&lt;K,V&gt;[] segments = <span class="built_in">this</span>.segments;</span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line">    <span class="type">boolean</span> overflow; <span class="comment">// true if size overflows 32 bits</span></span><br><span class="line">    <span class="type">long</span> sum; <span class="comment">// sum of modCounts</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">last</span> <span class="operator">=</span> <span class="number">0L</span>; <span class="comment">// previous sum</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">retries</span> <span class="operator">=</span> -<span class="number">1</span>; <span class="comment">// first iteration isn&#x27;t retry</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">if</span> (retries++ == RETRIES_BEFORE_LOCK) &#123;</span><br><span class="line">                <span class="comment">// è¶…è¿‡é‡è¯•æ¬¡æ•°, éœ€è¦åˆ›å»ºæ‰€æœ‰ segment å¹¶åŠ é”</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; segments.length; ++j)</span><br><span class="line">                    ensureSegment(j).lock(); <span class="comment">// force creation</span></span><br><span class="line">            &#125;</span><br><span class="line">            sum = <span class="number">0L</span>;</span><br><span class="line">            size = <span class="number">0</span>;</span><br><span class="line">            overflow = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; segments.length; ++j) &#123;</span><br><span class="line">                Segment&lt;K,V&gt; seg = segmentAt(segments, j);</span><br><span class="line">                <span class="keyword">if</span> (seg != <span class="literal">null</span>) &#123;</span><br><span class="line">                    sum += seg.modCount;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> seg.count;</span><br><span class="line">                    <span class="keyword">if</span> (c &lt; <span class="number">0</span> || (size += c) &lt; <span class="number">0</span>)</span><br><span class="line">                        overflow = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (sum == last)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            last = sum;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (retries &gt; RETRIES_BEFORE_LOCK) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; segments.length; ++j)</span><br><span class="line">                segmentAt(segments, j).unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> overflow ? Integer.MAX_VALUE : size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="11-BlockingQueue">11.BlockingQueue</h2><p>åŸºæœ¬çš„å…¥é˜Ÿå‡ºé˜Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkedBlockingQueue</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">AbstractQueue</span>&lt;E&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">BlockingQueue</span>&lt;E&gt;, java.io.Serializable &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;E&gt; &#123;</span><br><span class="line">        E item;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸‹åˆ—ä¸‰ç§æƒ…å†µä¹‹ä¸€</span></span><br><span class="line"><span class="comment"> * - çœŸæ­£çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> * - è‡ªå·±, å‘ç”Ÿåœ¨å‡ºé˜Ÿæ—¶</span></span><br><span class="line"><span class="comment"> * - null, è¡¨ç¤ºæ˜¯æ²¡æœ‰åç»§èŠ‚ç‚¹, æ˜¯æœ€åäº†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        Node&lt;E&gt; next;</span><br><span class="line">        Node(E x) &#123; item = x; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="tabs" id="2c4556f8-464e-43e9-b401-f7a2b3f91591"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2c4556f8-464e-43e9-b401-f7a2b3f91591-1"><i class="fas fa-atom"></i>åˆå§‹åŒ–é“¾è¡¨</button></li><li class="tab"><button type="button" data-href="#2c4556f8-464e-43e9-b401-f7a2b3f91591-2"><i class="far fa-sun"></i>èŠ‚ç‚¹å…¥é˜Ÿ</button></li><li class="tab"><button type="button" data-href="#2c4556f8-464e-43e9-b401-f7a2b3f91591-3"><i class="fas fa-wind"></i>å‡ºé˜Ÿ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2c4556f8-464e-43e9-b401-f7a2b3f91591-1"><p><code>last = head = new Node(null);</code>Dummy èŠ‚ç‚¹ç”¨æ¥å ä½ï¼Œitem ä¸º null</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220316215902936.png" alt="image-20220316215902936"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2c4556f8-464e-43e9-b401-f7a2b3f91591-2"><p><code>last = last.next = node;</code></p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220316215925456.png" alt="image-20220316215925456"></p><p>å†æ¥ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿ<code>last = last.next = node;</code></p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220316215949461.png" alt="image-20220316215949461"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2c4556f8-464e-43e9-b401-f7a2b3f91591-3"><h5 id=""></h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸´æ—¶å˜é‡hç”¨æ¥æŒ‡å‘å“¨å…µ</span></span><br><span class="line">Node&lt;E&gt; h = head;</span><br><span class="line"><span class="comment">//firstç”¨æ¥æŒ‡å‘ç¬¬ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">Node&lt;E&gt; first = h.next;</span><br><span class="line">h.next = h; <span class="comment">// help GC</span></span><br><span class="line"><span class="comment">//headèµ‹å€¼ä¸ºfirstï¼Œè¡¨ç¤ºfirstèŠ‚ç‚¹å°±æ˜¯ä¸‹ä¸€ä¸ªå“¨å…µã€‚</span></span><br><span class="line">head = first;</span><br><span class="line"><span class="type">E</span> <span class="variable">x</span> <span class="operator">=</span> first.item;</span><br><span class="line"><span class="comment">//åˆ é™¤firstèŠ‚ç‚¹ä¸­çš„æ•°æ®ï¼Œè¡¨ç¤ºçœŸæ­£æˆä¸ºäº†å“¨å…µï¼Œç¬¬ä¸€ä¸ªå…ƒç´ å‡ºé˜Ÿã€‚</span></span><br><span class="line">first.item = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">return</span> x;</span><br></pre></td></tr></table></figure><p><code>h = head</code></p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317142826808.png" alt="image-20220317142826808"></p><p><code>first = h.next</code></p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317142906729.png" alt="image-20220317142906729"></p><p><code>h.next = h</code></p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317142924725.png" alt="image-20220317142924725"></p><p><code>head = first</code></p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317142942832.png" alt="image-20220317142942832"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">E</span> <span class="variable">x</span> <span class="operator">=</span> first.item;</span><br><span class="line">first.item = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">return</span> x;</span><br></pre></td></tr></table></figure><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317143001497.png" alt="image-20220317143001497"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <p>åŠ é”åˆ†æ</p><p><strong>é«˜æ˜ä¹‹å¤„</strong>åœ¨äºç”¨äº†ä¸¤æŠŠé”å’Œ dummy èŠ‚ç‚¹</p><ul><li>ç”¨ä¸€æŠŠé”ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œæœ€å¤šåªå…è®¸æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼ˆç”Ÿäº§è€…æˆ–æ¶ˆè´¹è€…ï¼ŒäºŒé€‰ä¸€ï¼‰æ‰§è¡Œ</li><li>ç”¨ä¸¤æŠŠé”ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œå¯ä»¥å…è®¸ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ï¼ˆä¸€ä¸ªç”Ÿäº§è€…ä¸ä¸€ä¸ªæ¶ˆè´¹è€…ï¼‰æ‰§è¡Œ<ul><li>æ¶ˆè´¹è€…ä¸æ¶ˆè´¹è€…çº¿ç¨‹ä»ç„¶ä¸²è¡Œ</li><li>ç”Ÿäº§è€…ä¸ç”Ÿäº§è€…çº¿ç¨‹ä»ç„¶ä¸²è¡Œ</li></ul></li></ul><p>çº¿ç¨‹å®‰å…¨åˆ†æ</p><ul><li>å½“èŠ‚ç‚¹æ€»æ•°å¤§äº 2 æ—¶ï¼ˆåŒ…æ‹¬ dummy èŠ‚ç‚¹ï¼‰ï¼ŒputLock ä¿è¯çš„æ˜¯ last èŠ‚ç‚¹çš„çº¿ç¨‹å®‰å…¨ï¼ŒtakeLock ä¿è¯çš„æ˜¯ head èŠ‚ç‚¹çš„çº¿ç¨‹å®‰å…¨ã€‚ä¸¤æŠŠé”ä¿è¯äº†å…¥é˜Ÿå’Œå‡ºé˜Ÿæ²¡æœ‰ç«äº‰</li><li>å½“èŠ‚ç‚¹æ€»æ•°ç­‰äº 2 æ—¶ï¼ˆå³ä¸€ä¸ª dummy èŠ‚ç‚¹ï¼Œä¸€ä¸ªæ­£å¸¸èŠ‚ç‚¹ï¼‰è¿™æ—¶å€™ï¼Œä»ç„¶æ˜¯ä¸¤æŠŠé”é”ä¸¤ä¸ªå¯¹è±¡ï¼Œä¸ä¼šç«äº‰</li><li>å½“èŠ‚ç‚¹æ€»æ•°ç­‰äº 1 æ—¶ï¼ˆå°±ä¸€ä¸ª dummy èŠ‚ç‚¹ï¼‰è¿™æ—¶ take çº¿ç¨‹ä¼šè¢« notEmpty æ¡ä»¶é˜»å¡ï¼Œæœ‰ç«äº‰ï¼Œä¼šé˜»å¡</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”¨äº put(é˜»å¡) offer(éé˜»å¡)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">putLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="comment">// ç”¨æˆ· take(é˜»å¡) poll(éé˜»å¡)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">takeLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br></pre></td></tr></table></figure><div class="tabs" id="086864a5-94c2-483a-809a-97b3071fab65"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#086864a5-94c2-483a-809a-97b3071fab65-1"><i class="fas fa-award"></i>put æ“ä½œ</button></li><li class="tab"><button type="button" data-href="#086864a5-94c2-483a-809a-97b3071fab65-2"><i class="fas fa-baseball-ball"></i>take æ“ä½œ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="086864a5-94c2-483a-809a-97b3071fab65-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">//LinkedBlockingQueueä¸æ”¯æŒç©ºå…ƒç´ </span></span><br><span class="line">    <span class="keyword">if</span> (e == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    Node&lt;E&gt; node = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(e);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">putLock</span> <span class="operator">=</span> <span class="built_in">this</span>.putLock;</span><br><span class="line">    <span class="comment">// count ç”¨æ¥ç»´æŠ¤å…ƒç´ è®¡æ•°</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="built_in">this</span>.count;</span><br><span class="line">    putLock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ»¡äº†ç­‰å¾…</span></span><br><span class="line">        <span class="keyword">while</span> (count.get() == capacity) &#123;</span><br><span class="line">            <span class="comment">// å€’è¿‡æ¥è¯»å°±å¥½: ç­‰å¾… notFull</span></span><br><span class="line">            notFull.await();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æœ‰ç©ºä½, å…¥é˜Ÿä¸”è®¡æ•°åŠ ä¸€</span></span><br><span class="line">        enqueue(node);</span><br><span class="line">        c = count.getAndIncrement(); </span><br><span class="line">        <span class="comment">// é™¤äº†è‡ªå·± put ä»¥å¤–, é˜Ÿåˆ—è¿˜æœ‰ç©ºä½, ç”±è‡ªå·±å«é†’å…¶ä»– put çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (c + <span class="number">1</span> &lt; capacity)</span><br><span class="line">            notFull.signal();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        putLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœé˜Ÿåˆ—ä¸­æœ‰ä¸€ä¸ªå…ƒç´ , å«é†’ take çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// è¿™é‡Œè°ƒç”¨çš„æ˜¯ notEmpty.signal() è€Œä¸æ˜¯ notEmpty.signalAll() æ˜¯ä¸ºäº†å‡å°‘ç«äº‰</span></span><br><span class="line">        signalNotEmpty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="086864a5-94c2-483a-809a-97b3071fab65-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    E x;</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="built_in">this</span>.count;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">takeLock</span> <span class="operator">=</span> <span class="built_in">this</span>.takeLock;</span><br><span class="line">    takeLock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (count.get() == <span class="number">0</span>) &#123;</span><br><span class="line">            notEmpty.await();</span><br><span class="line">        &#125;</span><br><span class="line">        x = dequeue();</span><br><span class="line">        c = count.getAndDecrement();</span><br><span class="line">        <span class="keyword">if</span> (c &gt; <span class="number">1</span>)</span><br><span class="line">            notEmpty.signal();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        takeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœé˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªç©ºä½æ—¶, å«é†’ put çº¿ç¨‹</span></span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹è¿›è¡Œå‡ºé˜Ÿ, ç¬¬ä¸€ä¸ªçº¿ç¨‹æ»¡è¶³ c == capacity, ä½†åç»­çº¿ç¨‹ c &lt; capacity</span></span><br><span class="line">    <span class="keyword">if</span> (c == capacity)</span><br><span class="line">        <span class="comment">// è¿™é‡Œè°ƒç”¨çš„æ˜¯ notFull.signal() è€Œä¸æ˜¯ notFull.signalAll() æ˜¯ä¸ºäº†å‡å°‘ç«äº‰</span></span><br><span class="line">        signalNotFull()</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ç”± put å”¤é†’ put æ˜¯ä¸ºäº†é¿å…ä¿¡å·ä¸è¶³</p></blockquote><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <h2 id="12-ConcurrentLinkedQueue">12. ConcurrentLinkedQueue</h2><p>ConcurrentLinkedQueue çš„è®¾è®¡ä¸ LinkedBlockingQueue éå¸¸åƒï¼Œä¹Ÿæ˜¯</p><ul><li>ä¸¤æŠŠã€é”ã€‘ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œå¯ä»¥å…è®¸ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ï¼ˆä¸€ä¸ªç”Ÿäº§è€…ä¸ä¸€ä¸ªæ¶ˆè´¹è€…ï¼‰æ‰§è¡Œ</li><li>dummy èŠ‚ç‚¹çš„å¼•å…¥è®©ä¸¤æŠŠã€é”ã€‘å°†æ¥é”ä½çš„æ˜¯ä¸åŒå¯¹è±¡ï¼Œé¿å…ç«äº‰</li><li>åªæ˜¯è¿™ã€é”ã€‘ä½¿ç”¨äº† cas æ¥å®ç°</li></ul><p>äº‹å®ä¸Šï¼ŒConcurrentLinkedQueue åº”ç”¨è¿˜æ˜¯éå¸¸å¹¿æ³›çš„</p><p>ä¾‹å¦‚ä¹‹å‰è®²çš„ Tomcat çš„ Connector ç»“æ„æ—¶ï¼ŒAcceptor ä½œä¸ºç”Ÿäº§è€…å‘ Poller æ¶ˆè´¹è€…ä¼ é€’äº‹ä»¶ä¿¡æ¯æ—¶ï¼Œæ­£æ˜¯é‡‡ç”¨äº† ConcurrentLinkedQueue å°† SocketChannel ç»™ Poller ä½¿ç”¨</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230404204402766.png" alt="image-20230404204402766"></p><h2 id="13-CopyOnWriteArrayList">13. CopyOnWriteArrayList</h2><p><code>CopyOnWriteArraySet</code>æ˜¯å®ƒçš„é©¬ç”² åº•å±‚å®ç°é‡‡ç”¨äº† å†™å…¥æ—¶æ‹·è´ çš„æ€æƒ³ï¼Œå¢åˆ æ”¹æ“ä½œä¼šå°†åº•å±‚æ•°ç»„æ‹·è´ä¸€ä»½ï¼Œæ›´ æ”¹æ“ä½œåœ¨æ–°æ•°ç»„ä¸Šæ‰§è¡Œï¼Œè¿™æ—¶ä¸å½±å“å…¶å®ƒçº¿ç¨‹çš„<strong>å¹¶å‘è¯»</strong>ï¼Œ<strong>è¯»å†™åˆ†ç¦»</strong>ã€‚ ä»¥æ–°å¢ä¸ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">        <span class="comment">// è·å–æ—§çš„æ•°ç»„</span></span><br><span class="line">        Object[] es = getArray();</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> es.length;</span><br><span class="line">        <span class="comment">// æ‹·è´æ–°çš„æ•°ç»„ï¼ˆè¿™é‡Œæ˜¯æ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼Œä½†ä¸å½±å“å…¶å®ƒè¯»çº¿ç¨‹ï¼‰</span></span><br><span class="line">        es = Arrays.copyOf(es, len + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// æ·»åŠ æ–°å…ƒç´ </span></span><br><span class="line">        es[len] = e;</span><br><span class="line">        <span class="comment">// æ›¿æ¢æ—§çš„æ•°ç»„</span></span><br><span class="line">        setArray(es);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œçš„æºç ç‰ˆæœ¬æ˜¯ Java 11ï¼Œåœ¨ Java 1.8 ä¸­ä½¿ç”¨çš„æ˜¯å¯é‡å…¥é”è€Œä¸æ˜¯ synchronized</p></blockquote><p>å…¶å®ƒè¯»æ“ä½œå¹¶æœªåŠ é”ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">forEach</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> E&gt; action)</span> &#123;</span><br><span class="line">    Objects.requireNonNull(action);</span><br><span class="line">    <span class="keyword">for</span> (Object x : getArray()) &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span> <span class="type">E</span> <span class="variable">e</span> <span class="operator">=</span> (E) x;</span><br><span class="line">        action.accept(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€‚åˆã€è¯»å¤šå†™å°‘ã€çš„åº”ç”¨åœºæ™¯</p><h3 id="13-1-get-å¼±ä¸€è‡´æ€§">13.1 get å¼±ä¸€è‡´æ€§</h3><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317202641399.png" alt="image-20220317202641399"></p><table><thead><tr><th style="text-align:center">æ—¶é—´ç‚¹</th><th style="text-align:center">æ“ä½œ</th></tr></thead><tbody><tr><td style="text-align:center">1</td><td style="text-align:center">Thread-0 getArray()</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">Thread-1 getArray()</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">Thread-1 setArray(arrayCopy)</td></tr><tr><td style="text-align:center">4</td><td style="text-align:center">Thread-0 array[index]</td></tr></tbody></table><blockquote><p>ä¸å®¹æ˜“æµ‹è¯•ï¼Œä½†é—®é¢˜ç¡®å®å­˜åœ¨</p></blockquote><h3 id="13-2-è¿­ä»£å™¨å¼±ä¸€è‡´æ€§">13.2 è¿­ä»£å™¨å¼±ä¸€è‡´æ€§</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CopyOnWriteArrayList&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();</span><br><span class="line">list.add(<span class="number">1</span>);</span><br><span class="line">list.add(<span class="number">2</span>);</span><br><span class="line">list.add(<span class="number">3</span>);</span><br><span class="line">Iterator&lt;Integer&gt; iter = list.iterator();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    list.remove(<span class="number">0</span>);</span><br><span class="line">    System.out.println(list);</span><br><span class="line">&#125;).start();</span><br><span class="line">sleep1s();</span><br><span class="line"><span class="comment">//æ­¤æ—¶ä¸»çº¿ç¨‹çš„iteratorä¾æ—§æŒ‡å‘æ—§çš„æ•°ç»„ã€‚</span></span><br><span class="line"><span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">    System.out.println(iter.next());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä¸è¦è§‰å¾—å¼±ä¸€è‡´æ€§å°±ä¸å¥½</p><ul><li>æ•°æ®åº“çš„ MVCC éƒ½æ˜¯å¼±ä¸€è‡´æ€§çš„è¡¨ç°</li><li>å¹¶å‘é«˜å’Œä¸€è‡´æ€§æ˜¯çŸ›ç›¾çš„ï¼Œéœ€è¦æƒè¡¡</li></ul></blockquote>]]></content>
    
    
    <summary type="html">çº¿ç¨‹æ± ã€JUCã€ç¬¬ä¸‰æ–¹å¹¶å‘å·¥å…·ç±»</summary>
    
    
    
    <category term="Java" scheme="https://luckylittleboy.gitee.io/categories/Java/"/>
    
    
    <category term="JUC" scheme="https://luckylittleboy.gitee.io/tags/JUC/"/>
    
  </entry>
  
  <entry>
    <title>6.å…±äº«æ¨¡å‹ä¹‹ä¸å¯å˜</title>
    <link href="https://luckylittleboy.gitee.io/posts/b4f56904.html"/>
    <id>https://luckylittleboy.gitee.io/posts/b4f56904.html</id>
    <published>2023-04-02T13:14:00.000Z</published>
    <updated>2023-04-02T15:32:03.140Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-æ—¥æœŸè½¬æ¢çš„é—®é¢˜">1. æ—¥æœŸè½¬æ¢çš„é—®é¢˜</h2><p>DateFormatç±»ä¸­ï¼Œæœ‰ä¸ªprotectedçš„å±æ€§calendarï¼Œç”¨äº<code>å­˜å‚¨è®¾ç½®çš„æ—¶é—´</code>ã€‚DateFormatä¸­æä¾›äº†å¾ˆå¤šå…±æœ‰æ–¹æ³•å»æ›´æ”¹æ­¤å±æ€§ï¼Œå¦‚å°†DateFormatè®¾ç½®ä¸ºä¸€ä¸ªå…¨å±€å˜é‡ã€‚æ—¶é—´è½¬æ¢éƒ½ä½¿ç”¨æ­¤å˜é‡è¿›è¡Œè½¬æ¢ï¼Œæ¯æ¬¡è½¬æ¢æ—¶é—´ï¼Œéƒ½å°†æ›´æ”¹æ­¤å…¨å±€å¯¹è±¡ä¸­çš„calendarä¿¡æ¯ã€‚</p><p>å¤šçº¿ç¨‹æƒ…å†µä¸‹ä¼šå¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨çš„é—®é¢˜ï¼Œå³ä¸€ä¸ªçº¿ç¨‹æ›´æ”¹æ­¤å±æ€§åï¼Œåœ¨è®¡ç®—æ ¼å¼åŒ–æˆ–è€…æ¢è¡Œæˆæ—¥æœŸçš„è¿‡ç¨‹ä¸­ï¼Œå…¶ä»–çº¿ç¨‹å¯¹æ­¤å±æ€§è¿›è¡Œäº†æ›´æ”¹ï¼Œå¯¼è‡´è®¡ç®—æŠ¥é”™ï¼Œæˆ–è€…è®¡ç®—ä¸æ­£ç¡®ã€‚</p><div class="tabs" id="c6805b8b-82e2-4033-abb0-34e10e54f5d9"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c6805b8b-82e2-4033-abb0-34e10e54f5d9-1"><i class="fas fa-atom"></i>ä»£ç </button></li><li class="tab"><button type="button" data-href="#c6805b8b-82e2-4033-abb0-34e10e54f5d9-2"><i class="far fa-sun"></i>å¼‚å¸¸ç»“æœ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c6805b8b-82e2-4033-abb0-34e10e54f5d9-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, sdf.parse(<span class="string">&quot;1951-04-21&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&#123;&#125;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c6805b8b-82e2-4033-abb0-34e10e54f5d9-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">33</span>:<span class="number">36.357</span> cn.itcast.n6.Test [Thread-<span class="number">8</span>] - &#123;&#125;</span><br><span class="line">java.lang.NumberFormatException: For input string: <span class="string">&quot;&quot;</span></span><br><span class="line">at java.lang.NumberFormatException.forInputString(NumberFormatException.java:<span class="number">65</span>)</span><br><span class="line">at java.lang.Long.parseLong(Long.java:<span class="number">601</span>)</span><br><span class="line">at java.lang.Long.parseLong(Long.java:<span class="number">631</span>)</span><br><span class="line">at java.text.DigitList.getLong(DigitList.java:<span class="number">195</span>)</span><br><span class="line">at java.text.DecimalFormat.parse(DecimalFormat.java:<span class="number">2082</span>)</span><br><span class="line">at java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:<span class="number">1869</span>)</span><br><span class="line">at java.text.SimpleDateFormat.parse(SimpleDateFormat.java:<span class="number">1514</span>)</span><br><span class="line">at java.text.DateFormat.parse(DateFormat.java:<span class="number">364</span>)</span><br><span class="line">at cn.itcast.n6.Test.lambda$main$<span class="number">0</span>(Test.java:<span class="number">17</span>)</span><br><span class="line">at java.lang.Thread.run(Thread.java:<span class="number">750</span>)</span><br><span class="line"><span class="number">21</span>:<span class="number">33</span>:<span class="number">36.357</span> cn.itcast.n6.Test [Thread-<span class="number">3</span>] - &#123;&#125;</span><br><span class="line">java.lang.NumberFormatException: For input string: <span class="string">&quot;&quot;</span></span><br><span class="line">at java.lang.NumberFormatException.forInputString(NumberFormatException.java:<span class="number">65</span>)</span><br><span class="line">at java.lang.Long.parseLong(Long.java:<span class="number">601</span>)</span><br><span class="line">at java.lang.Long.parseLong(Long.java:<span class="number">631</span>)</span><br><span class="line">at java.text.DigitList.getLong(DigitList.java:<span class="number">195</span>)</span><br><span class="line">at java.text.DecimalFormat.parse(DecimalFormat.java:<span class="number">2082</span>)</span><br><span class="line">at java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:<span class="number">1869</span>)</span><br><span class="line">at java.text.SimpleDateFormat.parse(SimpleDateFormat.java:<span class="number">1514</span>)</span><br><span class="line">at java.text.DateFormat.parse(DateFormat.java:<span class="number">364</span>)</span><br><span class="line">at cn.itcast.n6.Test.lambda$main$<span class="number">0</span>(Test.java:<span class="number">17</span>)</span><br><span class="line">at java.lang.Thread.run(Thread.java:<span class="number">750</span>)</span><br><span class="line"><span class="number">21</span>:<span class="number">33</span>:<span class="number">36.357</span> cn.itcast.n6.Test [Thread-<span class="number">2</span>] - &#123;&#125;</span><br><span class="line">java.lang.NumberFormatException: For input string: <span class="string">&quot;21.&quot;</span></span><br><span class="line">at java.lang.NumberFormatException.forInputString(NumberFormatException.java:<span class="number">65</span>)</span><br><span class="line">at java.lang.Long.parseLong(Long.java:<span class="number">589</span>)</span><br><span class="line">at java.lang.Long.parseLong(Long.java:<span class="number">631</span>)</span><br><span class="line">at java.text.DigitList.getLong(DigitList.java:<span class="number">195</span>)</span><br><span class="line">at java.text.DecimalFormat.parse(DecimalFormat.java:<span class="number">2082</span>)</span><br><span class="line">at java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:<span class="number">2162</span>)</span><br><span class="line">at java.text.SimpleDateFormat.parse(SimpleDateFormat.java:<span class="number">1514</span>)</span><br><span class="line">at java.text.DateFormat.parse(DateFormat.java:<span class="number">364</span>)</span><br><span class="line">at cn.itcast.n6.Test.lambda$main$<span class="number">0</span>(Test.java:<span class="number">17</span>)</span><br><span class="line">at java.lang.Thread.run(Thread.java:<span class="number">750</span>)</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <p>è§£å†³æ–¹æ³•ï¼š</p><div class="tabs" id="2a6e9693-9369-476f-ae6c-ca9b47a16238"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2a6e9693-9369-476f-ae6c-ca9b47a16238-1"><i class="fas fa-dove"></i>æ€è·¯ - åŒæ­¥é”</button></li><li class="tab"><button type="button" data-href="#2a6e9693-9369-476f-ae6c-ca9b47a16238-2"><i class="fas fa-dragon"></i>æ€è·¯ - ä¸å¯å˜</button></li><li class="tab"><button type="button" data-href="#2a6e9693-9369-476f-ae6c-ca9b47a16238-3"><i class="fas fa-cat"></i>Threadlocal</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2a6e9693-9369-476f-ae6c-ca9b47a16238-1"><p>è¿™æ ·è™½èƒ½è§£å†³é—®é¢˜ï¼Œä½†å¸¦æ¥çš„æ˜¯æ€§èƒ½ä¸Šçš„æŸå¤±ï¼Œå¹¶ä¸ç®—å¾ˆå¥½ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (sdf) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, sdf.parse(<span class="string">&quot;1951-04-21&quot;</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;&#123;&#125;&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2a6e9693-9369-476f-ae6c-ca9b47a16238-2"><p>å¦‚æœä¸€ä¸ªå¯¹è±¡åœ¨ä¸èƒ½å¤Ÿä¿®æ”¹å…¶å†…éƒ¨çŠ¶æ€ï¼ˆå±æ€§ï¼‰ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºä¸å­˜åœ¨å¹¶å‘ä¿®æ”¹å•Šï¼è¿™æ ·çš„å¯¹è±¡åœ¨ Java ä¸­æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚åœ¨ Java 8 åï¼Œæä¾›äº†ä¸€ä¸ªæ–°çš„æ—¥æœŸæ ¼å¼åŒ–ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DateTimeFormatter</span> <span class="variable">dtf</span> <span class="operator">=</span> DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="type">LocalDate</span> <span class="variable">date</span> <span class="operator">=</span> dtf.parse(<span class="string">&quot;2018-10-01&quot;</span>, LocalDate::from);</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, date);</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹ DateTimeFormatter çš„æ–‡æ¡£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@implSpec</span></span><br><span class="line"><span class="comment">//This class is immutable and thread-safe.</span></span><br></pre></td></tr></table></figure><p>ä¸å¯å˜å¯¹è±¡ï¼Œå®é™…æ˜¯å¦ä¸€ç§é¿å…ç«äº‰çš„æ–¹å¼ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2a6e9693-9369-476f-ae6c-ca9b47a16238-3"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-ä¸å¯å˜è®¾è®¡">2. ä¸å¯å˜è®¾è®¡</h2><h3 id="2-1-Stringç±»çš„è®¾è®¡">2.1 Stringç±»çš„è®¾è®¡</h3><p>å¦ä¸€ä¸ªå¤§å®¶æ›´ä¸ºç†Ÿæ‚‰çš„ String ç±»ä¹Ÿæ˜¯ä¸å¯å˜çš„ï¼Œä»¥å®ƒä¸ºä¾‹ï¼Œè¯´æ˜ä¸€ä¸‹ä¸å¯å˜è®¾è®¡çš„è¦ç´ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">String</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable, Comparable&lt;String&gt;, CharSequence &#123;</span><br><span class="line">    <span class="comment">/** The value is used for character storage. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">char</span> value[];</span><br><span class="line">    <span class="comment">/** Cache the hash code for the string */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> hash; <span class="comment">// Default to 0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯´æ˜ï¼š</p><ul><li>å°†ç±»å£°æ˜ä¸ºfinalï¼Œé¿å…è¢«å¸¦å¤–æ˜Ÿæ–¹æ³•çš„å­ç±»ç»§æ‰¿ï¼Œä»è€Œç ´åäº†ä¸å¯å˜æ€§ã€‚</li><li>å°†å­—ç¬¦æ•°ç»„å£°æ˜ä¸ºfinalï¼Œé¿å…è¢«ä¿®æ”¹</li><li>hashè™½ç„¶ä¸æ˜¯finalçš„ï¼Œä½†æ˜¯å…¶åªæœ‰åœ¨è°ƒç”¨<code>hash()</code>æ–¹æ³•çš„æ—¶å€™æ‰è¢«èµ‹å€¼ï¼Œé™¤æ­¤ä¹‹å¤–å†æ— åˆ«çš„æ–¹æ³•ä¿®æ”¹ã€‚</li></ul><h3 id="2-2-final-çš„ä½¿ç”¨">2.2 final çš„ä½¿ç”¨</h3><p>å‘ç°è¯¥ç±»ã€ç±»ä¸­æ‰€æœ‰å±æ€§éƒ½æ˜¯ final çš„</p><ul><li>å±æ€§ç”¨ final ä¿®é¥°ä¿è¯äº†è¯¥å±æ€§æ˜¯åªè¯»çš„ï¼Œä¸èƒ½ä¿®æ”¹</li><li>ç±»ç”¨ final ä¿®é¥°ä¿è¯äº†è¯¥ç±»ä¸­çš„æ–¹æ³•ä¸èƒ½è¢«è¦†ç›–ï¼Œé˜²æ­¢å­ç±»æ— æ„é—´ç ´åä¸å¯å˜æ€§</li></ul><h3 id="2-3-ä¿æŠ¤æ€§æ‹·è´">2.3 ä¿æŠ¤æ€§æ‹·è´</h3><p>ä½†æœ‰åŒå­¦ä¼šè¯´ï¼Œä½¿ç”¨å­—ç¬¦ä¸²æ—¶ï¼Œä¹Ÿæœ‰ä¸€äº›è·Ÿä¿®æ”¹ç›¸å…³çš„æ–¹æ³•å•Šï¼Œæ¯”å¦‚ substring ç­‰ï¼Œé‚£ä¹ˆä¸‹é¢å°±çœ‹ä¸€çœ‹è¿™äº›æ–¹æ³•æ˜¯ å¦‚ä½•å®ç°çš„ï¼Œå°±ä»¥ substring ä¸ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">substring</span><span class="params">(<span class="type">int</span> beginIndex)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (beginIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(beginIndex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">subLen</span> <span class="operator">=</span> value.length - beginIndex;</span><br><span class="line">    <span class="keyword">if</span> (subLen &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(subLen);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (beginIndex == <span class="number">0</span>) ? <span class="built_in">this</span> : <span class="keyword">new</span> <span class="title class_">String</span>(value, beginIndex, subLen);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°å…¶å†…éƒ¨æ˜¯è°ƒç”¨ String çš„æ„é€ æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªæ–°å­—ç¬¦ä¸²ï¼Œå†è¿›å…¥è¿™ä¸ªæ„é€ çœ‹çœ‹ï¼Œæ˜¯å¦å¯¹ final char[] value åšå‡º äº†ä¿®æ”¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">String</span><span class="params">(<span class="type">char</span> value[], <span class="type">int</span> offset, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (offset &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(offset);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (count &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(count);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (offset &lt;= value.length) &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = <span class="string">&quot;&quot;</span>.value;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (offset &gt; value.length - count) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(offset + count);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.value = Arrays.copyOfRange(value, offset, offset+count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœå‘ç°ä¹Ÿæ²¡æœ‰ï¼Œæ„é€ æ–°å­—ç¬¦ä¸²å¯¹è±¡æ—¶ï¼Œä¼šç”Ÿæˆæ–°çš„ char[] valueï¼Œå¯¹å†…å®¹è¿›è¡Œå¤åˆ¶ ã€‚è¿™ç§é€šè¿‡åˆ›å»ºå‰¯æœ¬å¯¹è±¡æ¥é¿å…å…±äº«çš„æ‰‹æ®µç§°ä¹‹ä¸ºã€ä¿æŠ¤æ€§æ‹·è´ï¼ˆdefensive copyï¼‰</p><h3 id="2-4-æ¨¡å¼ä¹‹äº«å…ƒ">2.4 æ¨¡å¼ä¹‹äº«å…ƒ</h3><h4 id="2-4-1-ç®€ä»‹">2.4.1 ç®€ä»‹</h4><p><strong>å®šä¹‰</strong>  äº«å…ƒæ¨¡å¼ï¼ˆFlyweight Patternï¼‰æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œå…¶ç›®çš„æ˜¯é€šè¿‡å…±äº«å°½å¯èƒ½å¤šçš„å¯¹è±¡çŠ¶æ€æ¥æœ€å°åŒ–å†…å­˜ä½¿ç”¨å’Œæé«˜æ€§èƒ½ã€‚</p><blockquote><p>wikipediaï¼š A flyweight is an object that minimizes memory usage by sharing as much data as possible with other similar objects</p></blockquote><p><strong>å‡ºè‡ª</strong>  â€œGang of Fourâ€ design patterns</p><p><strong>å½’ç±»</strong> Structual patterns</p><h4 id="2-4-2-ä½“ç°">2.4.2 ä½“ç°</h4><p><strong>åŒ…è£…ç±»</strong></p><p>åœ¨JDKä¸­ Booleanï¼ŒByteï¼ŒShortï¼ŒIntegerï¼ŒLongï¼ŒCharacter ç­‰åŒ…è£…ç±»æä¾›äº† valueOf æ–¹æ³•ï¼Œä¾‹å¦‚ Long çš„ valueOf ä¼šç¼“å­˜ -128~127 ä¹‹é—´çš„ Long å¯¹è±¡ï¼Œåœ¨è¿™ä¸ªèŒƒå›´ä¹‹é—´ä¼šé‡ç”¨å¯¹è±¡ï¼Œå¤§äºè¿™ä¸ªèŒƒå›´ï¼Œæ‰ä¼šæ–°å»º Long å¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LongCache</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">LongCache</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Long cache[] = <span class="keyword">new</span> <span class="title class_">Long</span>[-(-<span class="number">128</span>) + <span class="number">127</span> + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; cache.length; i++)</span><br><span class="line">            cache[i] = <span class="keyword">new</span> <span class="title class_">Long</span>(i - <span class="number">128</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title function_">valueOf</span><span class="params">(<span class="type">long</span> l)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> <span class="number">128</span>;</span><br><span class="line">    <span class="keyword">if</span> (l &gt;= -<span class="number">128</span> &amp;&amp; l &lt;= <span class="number">127</span>) &#123; <span class="comment">// will cache</span></span><br><span class="line">        <span class="keyword">return</span> LongCache.cache[(<span class="type">int</span>)l + offset];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Long</span>(l);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>æ³¨æ„</strong>ï¼š</p><ul><li>Byte, Short, Long ç¼“å­˜çš„èŒƒå›´éƒ½æ˜¯ -128~127</li><li>Character ç¼“å­˜çš„èŒƒå›´æ˜¯ 0~127</li><li>Integerçš„é»˜è®¤èŒƒå›´æ˜¯ -128~127<ul><li>æœ€å°å€¼ä¸èƒ½å˜</li><li>ä½†æœ€å¤§å€¼å¯ä»¥é€šè¿‡è°ƒæ•´è™šæ‹Ÿæœºå‚æ•° <code>  -Djava.lang.Integer.IntegerCache.high</code> æ¥æ”¹å˜</li></ul></li><li>Boolean ç¼“å­˜äº† TRUE å’Œ FALSE</li></ul></blockquote><p><strong>String ä¸²æ± </strong>ï¼ˆä¸å¯å˜ã€çº¿ç¨‹å®‰å…¨ï¼‰</p><p>è¯¦è§jvm</p><p><strong>BigDecimal BigInteger</strong>(ä¸å¯å˜ã€çº¿ç¨‹å®‰å…¨)</p><p>ä¸€éƒ¨åˆ†æ•°å­—ä½¿ç”¨äº†äº«å…ƒæ¨¡å¼è¿›è¡Œäº†ç¼“å­˜ã€‚</p><blockquote><p>æ³¨æ„ï¼š</p><p>ä¹‹å‰ç¯‡ç« ä¸­å–é’±ç”¨åˆ°BigDecimalï¼Œçº¿ç¨‹å®‰å…¨çš„ï¼Œä¸ºä»€ä¹ˆè¦ç”¨åŸå­å¼•ç”¨ä¿æŠ¤èµ·æ¥å‘¢?å› ä¸ºæ“ä½œè¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°è·å–å€¼ï¼Œè®¾ç½®å€¼ï¼Œå®ƒä»¬çš„ç»„åˆå¹¶ä¸æ˜¯åŸå­çš„ã€‚å•ä¸ªæ–¹æ³•è¿è¡Œèµ·æ¥æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¤šä¸ªæ–¹æ³•çš„ç»„åˆä¸èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p></blockquote><h4 id="2-4-3-æ‰‹å†™è¿æ¥æ± ">2.4.3 æ‰‹å†™è¿æ¥æ± </h4><p>ä¾‹å¦‚ï¼šä¸€ä¸ªçº¿ä¸Šå•†åŸåº”ç”¨ï¼ŒQPS è¾¾åˆ°æ•°åƒï¼Œå¦‚æœæ¯æ¬¡éƒ½é‡æ–°åˆ›å»ºå’Œå…³é—­æ•°æ®åº“è¿æ¥ï¼Œæ€§èƒ½ä¼šå—åˆ°æå¤§å½±å“ã€‚ è¿™æ—¶ é¢„å…ˆåˆ›å»ºå¥½ä¸€æ‰¹è¿æ¥ï¼Œæ”¾å…¥è¿æ¥æ± ã€‚ä¸€æ¬¡è¯·æ±‚åˆ°è¾¾åï¼Œä»è¿æ¥æ± è·å–è¿æ¥ï¼Œä½¿ç”¨å®Œæ¯•åå†è¿˜å›è¿æ¥æ± ï¼Œè¿™æ ·æ—¢èŠ‚çº¦ äº†è¿æ¥çš„åˆ›å»ºå’Œå…³é—­æ—¶é—´ï¼Œä¹Ÿå®ç°äº†è¿æ¥çš„é‡ç”¨ï¼Œä¸è‡³äºè®©åºå¤§çš„è¿æ¥æ•°å‹å®æ•°æ®åº“ã€‚<div class="tabs" id="00f37546-0a35-4056-a4df-02b7fef00f02"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#00f37546-0a35-4056-a4df-02b7fef00f02-1"><i class="fas fa-atom"></i>å®ç°è¿æ¥æ± </button></li><li class="tab"><button type="button" data-href="#00f37546-0a35-4056-a4df-02b7fef00f02-2"><i class="far fa-sun"></i>ä½¿ç”¨è¿æ¥æ± </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="00f37546-0a35-4056-a4df-02b7fef00f02-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Pool</span> &#123;</span><br><span class="line">    <span class="comment">// 1. è¿æ¥æ± å¤§å°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> poolSize;</span><br><span class="line">    <span class="comment">// 2. è¿æ¥å¯¹è±¡æ•°ç»„</span></span><br><span class="line">    <span class="keyword">private</span> Connection[] connections;</span><br><span class="line">    <span class="comment">// 3. è¿æ¥çŠ¶æ€æ•°ç»„ 0 è¡¨ç¤ºç©ºé—²ï¼Œ 1 è¡¨ç¤ºç¹å¿™</span></span><br><span class="line">    <span class="keyword">private</span> AtomicIntegerArray states;</span><br><span class="line">    <span class="comment">// 4. æ„é€ æ–¹æ³•åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Pool</span><span class="params">(<span class="type">int</span> poolSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.poolSize = poolSize;</span><br><span class="line">        <span class="built_in">this</span>.connections = <span class="keyword">new</span> <span class="title class_">Connection</span>[poolSize];</span><br><span class="line">        <span class="built_in">this</span>.states = <span class="keyword">new</span> <span class="title class_">AtomicIntegerArray</span>(<span class="keyword">new</span> <span class="title class_">int</span>[poolSize]);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            connections[i] = <span class="keyword">new</span> <span class="title class_">MockConnection</span>(<span class="string">&quot;è¿æ¥&quot;</span> + (i+<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5. å€Ÿè¿æ¥</span></span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">borrow</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">                <span class="comment">// è·å–ç©ºé—²è¿æ¥</span></span><br><span class="line">                <span class="keyword">if</span>(states.get(i) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (states.compareAndSet(i, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                        log.debug(<span class="string">&quot;borrow &#123;&#125;&quot;</span>, connections[i]);</span><br><span class="line">                        <span class="keyword">return</span> connections[i];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœæ²¡æœ‰ç©ºé—²è¿æ¥ï¼Œå½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…</span></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;wait...&quot;</span>);</span><br><span class="line">                    <span class="built_in">this</span>.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6. å½’è¿˜è¿æ¥</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">free</span><span class="params">(Connection conn)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (connections[i] == conn) &#123;</span><br><span class="line">                states.set(i, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;free &#123;&#125;&quot;</span>, conn);</span><br><span class="line">                    <span class="built_in">this</span>.notifyAll();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MockConnection</span> <span class="keyword">implements</span> <span class="title class_">Connection</span> &#123;</span><br><span class="line">    <span class="comment">// å®ç°ç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="00f37546-0a35-4056-a4df-02b7fef00f02-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Pool</span> <span class="variable">pool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Pool</span>(<span class="number">2</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> pool.borrow();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">1000</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        pool.free(conn);</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></p><p>ä»¥ä¸Šå®ç°æ²¡æœ‰è€ƒè™‘ï¼š</p><ul><li>è¿æ¥çš„åŠ¨æ€å¢é•¿ä¸æ”¶ç¼©</li><li>è¿æ¥ä¿æ´»ï¼ˆå¯ç”¨æ€§æ£€æµ‹ï¼‰</li><li>ç­‰å¾…è¶…æ—¶å¤„ç†</li><li>åˆ†å¸ƒå¼ hash</li></ul><p>å¯¹äºå…³ç³»å‹æ•°æ®åº“ï¼Œæœ‰æ¯”è¾ƒæˆç†Ÿçš„è¿æ¥æ± å®ç°ï¼Œä¾‹å¦‚c3p0, druidç­‰ å¯¹äºæ›´é€šç”¨çš„å¯¹è±¡æ± ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨apache commons poolï¼Œä¾‹å¦‚redisè¿æ¥æ± å¯ä»¥å‚è€ƒjedisä¸­å…³äºè¿æ¥æ± çš„å®ç°</p><h3 id="2-5-åŸç†ä¹‹-final">2.5 åŸç†ä¹‹ final</h3><h4 id="2-5-1-è®¾ç½®-final-å˜é‡åŸç†">2.5.1 è®¾ç½® final å˜é‡åŸç†</h4><p>ç†è§£äº† volatile åŸç†ï¼Œå†å¯¹æ¯” final çš„å®ç°å°±æ¯”è¾ƒç®€å•äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestFinal</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å­—èŠ‚ç </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0: aload_0</span><br><span class="line">1: invokespecial <span class="comment">#1 // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">4: aload_0</span><br><span class="line">5: bipush 20</span><br><span class="line">7: putfield <span class="comment">#2 // Field a:I</span></span><br><span class="line"> &lt;-- å†™å±éšœ</span><br><span class="line">10: <span class="built_in">return</span></span><br></pre></td></tr></table></figure><p>å‘ç° final å˜é‡çš„èµ‹å€¼ä¹Ÿä¼šé€šè¿‡ putfield æŒ‡ä»¤æ¥å®Œæˆï¼ŒåŒæ ·åœ¨è¿™æ¡æŒ‡ä»¤ä¹‹åä¹Ÿä¼šåŠ å…¥å†™å±éšœï¼Œè¿™æ ·å¯¹finalå˜é‡çš„å†™å…¥ä¸ä¼šé‡æ’åºåˆ°æ„é€ æ–¹æ³•ä¹‹å¤–ï¼Œä¿è¯åœ¨å…¶å®ƒçº¿ç¨‹è¯»åˆ° å®ƒçš„å€¼æ—¶ä¸ä¼šå‡ºç°ä¸º 0 çš„æƒ…å†µã€‚æ™®é€šå˜é‡ä¸èƒ½ä¿è¯è¿™ä¸€ç‚¹äº†ã€‚</p><h4 id="2-5-2-è¯»å–finalå˜é‡åŸç†">2.5.2 è¯»å–finalå˜é‡åŸç†</h4><div class="tabs" id="dcacee9f-bafa-4ef0-b8fa-7032a2810c37"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#dcacee9f-bafa-4ef0-b8fa-7032a2810c37-1"><i class="fas fa-seedling"></i>ä»£ç </button></li><li class="tab"><button type="button" data-href="#dcacee9f-bafa-4ef0-b8fa-7032a2810c37-2"><i class="fas fa-leaf"></i>testæ–¹æ³•å­—èŠ‚ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="dcacee9f-bafa-4ef0-b8fa-7032a2810c37-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestFinal</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">A</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">B</span> <span class="operator">=</span> Short.MAX_VALUE + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> Short.MAX_VALUE + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UseFinal</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">A1</span> <span class="operator">=</span> TestFinal.A;</span><br><span class="line">        <span class="type">int</span> <span class="variable">B1</span> <span class="operator">=</span> TestFinal.B;</span><br><span class="line">        <span class="type">int</span> <span class="variable">a1</span> <span class="operator">=</span> TestFinal.a;</span><br><span class="line">        <span class="type">int</span> <span class="variable">b1</span> <span class="operator">=</span> TestFinal.b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="dcacee9f-bafa-4ef0-b8fa-7032a2810c37-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">0</span> bipush <span class="number">10</span></span><br><span class="line"> <span class="number">2</span> istore_1</span><br><span class="line"> <span class="number">3</span> ldc #<span class="number">4</span> &lt;<span class="number">32768</span>&gt;</span><br><span class="line"> <span class="number">5</span> istore_2</span><br><span class="line"> <span class="number">6</span> getstatic #<span class="number">5</span> &lt;cn/itcast/n6/TestFinal.a&gt;</span><br><span class="line"> <span class="number">9</span> istore_3</span><br><span class="line"><span class="number">10</span> getstatic #<span class="number">6</span> &lt;cn/itcast/n6/TestFinal.b&gt;</span><br><span class="line"><span class="number">13</span> istore <span class="number">4</span></span><br><span class="line"><span class="number">15</span> getstatic #<span class="number">7</span> &lt;cn/itcast/n6/TestFinal.c&gt;</span><br><span class="line"><span class="number">18</span> istore <span class="number">5</span></span><br><span class="line"><span class="number">20</span> <span class="keyword">return</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>å¯ä»¥çœ‹è§ï¼Œjvmå¯¹finalå˜é‡çš„è®¿é—®åšå‡ºäº†ä¼˜åŒ–ï¼šå¦ä¸€ä¸ªç±»ä¸­çš„æ–¹æ³•è°ƒç”¨finalå˜é‡æ˜¯ï¼Œä¸æ˜¯ä»finalå˜é‡æ‰€åœ¨ç±»ä¸­è·å–ï¼ˆå…±äº«å†…å­˜ï¼‰ï¼Œè€Œæ˜¯ç›´æ¥å¤åˆ¶ä¸€ä»½åˆ°æ–¹æ³•æ ˆæ ˆå¸§ä¸­çš„æ“ä½œæ•°æ ˆä¸­ï¼ˆå·¥ä½œå†…å­˜ï¼‰ï¼Œè¿™æ ·å¯ä»¥æå‡æ•ˆç‡ï¼Œæ˜¯ä¸€ç§ä¼˜åŒ–ã€‚</p><p>æ€»ç»“ï¼š</p><ul><li>å¯¹äºè¾ƒå°çš„static finalå˜é‡ï¼šå¤åˆ¶ä¸€ä»½åˆ°æ“ä½œæ•°æ ˆä¸­</li><li>å¯¹äºè¾ƒå¤§çš„static finalå˜é‡ï¼šå¤åˆ¶ä¸€ä»½åˆ°å½“å‰ç±»çš„å¸¸é‡æ± ä¸­</li><li>å¯¹äºéé™æ€finalå˜é‡ï¼Œä¼˜åŒ–åŒä¸Šã€‚</li></ul><h4 id="2-5-3-finalæ€»ç»“">2.5.3 finalæ€»ç»“</h4><p><strong>finalå…³é”®å­—çš„å¥½å¤„ï¼š</strong></p><p>ï¼ˆ1ï¼‰finalå…³é”®å­—æé«˜äº†æ€§èƒ½ã€‚JVMå’ŒJavaåº”ç”¨éƒ½ä¼šç¼“å­˜finalå˜é‡ã€‚</p><p>ï¼ˆ2ï¼‰finalå˜é‡å¯ä»¥å®‰å…¨çš„åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è¿›è¡Œå…±äº«ï¼Œè€Œä¸éœ€è¦é¢å¤–çš„åŒæ­¥å¼€é”€ã€‚</p><p>ï¼ˆ3ï¼‰ä½¿ç”¨finalå…³é”®å­—ï¼ŒJVMä¼šå¯¹æ–¹æ³•ã€å˜é‡åŠç±»è¿›è¡Œä¼˜åŒ–ã€‚</p><p><strong>å…³äºfinalçš„é‡è¦çŸ¥è¯†ç‚¹</strong></p><p>1ã€finalå…³é”®å­—å¯ä»¥ç”¨äºæˆå‘˜å˜é‡ã€æœ¬åœ°å˜é‡ã€æ–¹æ³•ä»¥åŠç±»ã€‚</p><p>2ã€finalæˆå‘˜å˜é‡å¿…é¡»åœ¨å£°æ˜çš„æ—¶å€™åˆå§‹åŒ–æˆ–è€…åœ¨æ„é€ å™¨ä¸­åˆå§‹åŒ–ï¼Œå¦åˆ™å°±ä¼šæŠ¥ç¼–è¯‘é”™è¯¯ã€‚</p><p>3ã€ä½ ä¸èƒ½å¤Ÿå¯¹finalå˜é‡å†æ¬¡èµ‹å€¼ã€‚</p><p>4ã€æœ¬åœ°å˜é‡å¿…é¡»åœ¨å£°æ˜æ—¶èµ‹å€¼ã€‚</p><p>5ã€åœ¨åŒ¿åç±»ä¸­æ‰€æœ‰å˜é‡éƒ½å¿…é¡»æ˜¯finalå˜é‡ã€‚</p><p>6ã€finalæ–¹æ³•ä¸èƒ½è¢«é‡å†™ã€‚</p><p>7ã€finalç±»ä¸èƒ½è¢«ç»§æ‰¿ã€‚</p><p>8ã€finalå…³é”®å­—ä¸åŒäºfinallyå…³é”®å­—ï¼Œåè€…ç”¨äºå¼‚å¸¸å¤„ç†ã€‚</p><p>9ã€finalå…³é”®å­—å®¹æ˜“ä¸finalize()æ–¹æ³•ææ··ï¼Œåè€…æ˜¯åœ¨Objectç±»ä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œæ˜¯åœ¨åƒåœ¾å›æ”¶ä¹‹å‰è¢«JVMè°ƒç”¨çš„æ–¹æ³•ã€‚</p><p>10ã€æ¥å£ä¸­å£°æ˜çš„æ‰€æœ‰å˜é‡æœ¬èº«æ˜¯finalçš„ã€‚</p><p>11ã€finalå’Œabstractè¿™ä¸¤ä¸ªå…³é”®å­—æ˜¯åç›¸å…³çš„ï¼Œfinalç±»å°±ä¸å¯èƒ½æ˜¯abstractçš„ã€‚</p><p>12ã€finalæ–¹æ³•åœ¨ç¼–è¯‘é˜¶æ®µç»‘å®šï¼Œç§°ä¸ºé™æ€ç»‘å®š(static binding)ã€‚</p><p>13ã€æ²¡æœ‰åœ¨å£°æ˜æ—¶åˆå§‹åŒ–finalå˜é‡çš„ç§°ä¸ºç©ºç™½finalå˜é‡(blank final variable)ï¼Œå®ƒä»¬å¿…é¡»åœ¨æ„é€ å™¨ä¸­åˆå§‹åŒ–ï¼Œæˆ–è€…è°ƒç”¨this()åˆå§‹åŒ–ã€‚ä¸è¿™ä¹ˆåšçš„è¯ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™â€œfinalå˜é‡(å˜é‡å)éœ€è¦è¿›è¡Œåˆå§‹åŒ–â€ã€‚</p><p>14ã€å°†ç±»ã€æ–¹æ³•ã€å˜é‡å£°æ˜ä¸ºfinalèƒ½å¤Ÿæé«˜æ€§èƒ½ï¼Œè¿™æ ·JVMå°±æœ‰æœºä¼šè¿›è¡Œä¼°è®¡ï¼Œç„¶åä¼˜åŒ–ã€‚</p><p>15ã€æŒ‰ç…§Javaä»£ç æƒ¯ä¾‹ï¼Œfinalå˜é‡å°±æ˜¯å¸¸é‡ï¼Œè€Œä¸”é€šå¸¸å¸¸é‡åè¦å¤§å†™ã€‚</p><p>16ã€å¯¹äºé›†åˆå¯¹è±¡å£°æ˜ä¸ºfinalæŒ‡çš„æ˜¯å¼•ç”¨ä¸èƒ½è¢«æ›´æ”¹ï¼Œä½†æ˜¯ä½ å¯ä»¥å‘å…¶ä¸­å¢åŠ ï¼Œåˆ é™¤æˆ–è€…æ”¹å˜å†…å®¹ã€‚</p><blockquote><p>å‚è€ƒé“¾æ¥ï¼š<a href="https://www.php.cn/java-article-413390.html">Javaä¸­finalå®ç°åŸç†çš„æ·±å…¥åˆ†æï¼ˆé™„ç¤ºä¾‹ï¼‰-javaæ•™ç¨‹-PHPä¸­æ–‡ç½‘</a></p></blockquote>]]></content>
    
    
    <summary type="html">ä¸å¯å˜ç±»çš„ä½¿ç”¨ã€ä¸å¯å˜ç±»è®¾è®¡ã€æ— çŠ¶æ€ç±»è®¾è®¡</summary>
    
    
    
    <category term="Java" scheme="https://luckylittleboy.gitee.io/categories/Java/"/>
    
    
    <category term="JUC" scheme="https://luckylittleboy.gitee.io/tags/JUC/"/>
    
  </entry>
  
  <entry>
    <title>5.å…±äº«æ¨¡å‹ä¹‹æ— é”</title>
    <link href="https://luckylittleboy.gitee.io/posts/943faa28.html"/>
    <id>https://luckylittleboy.gitee.io/posts/943faa28.html</id>
    <published>2023-04-01T09:32:19.000Z</published>
    <updated>2023-04-02T13:17:49.938Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-é—®é¢˜æå‡º-åº”ç”¨ä¹‹äº’æ–¥">1. é—®é¢˜æå‡º (åº”ç”¨ä¹‹äº’æ–¥)</h2><p>æœ‰å¦‚ä¸‹éœ€æ±‚ï¼Œä¿è¯ account.withdraw å–æ¬¾æ–¹æ³•çš„çº¿ç¨‹å®‰å…¨</p><div class="tabs" id="82baad96-94cd-48cb-a4ff-33f009288334"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#82baad96-94cd-48cb-a4ff-33f009288334-1"><i class="fas fa-seedling"></i>Accountæ¥å£</button></li><li class="tab"><button type="button" data-href="#82baad96-94cd-48cb-a4ff-33f009288334-2"><i class="fas fa-leaf"></i>ä¸å®‰å…¨çš„å®ç°ç±»</button></li><li class="tab"><button type="button" data-href="#82baad96-94cd-48cb-a4ff-33f009288334-3"><i class="fab fa-apple"></i>æµ‹è¯•&ç»“æœ</button></li><li class="tab"><button type="button" data-href="#82baad96-94cd-48cb-a4ff-33f009288334-4"><i class="fas fa-tree"></i>ä¸ºä»€ä¹ˆä¸å®‰å…¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="82baad96-94cd-48cb-a4ff-33f009288334-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Account</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–ä½™é¢</span></span><br><span class="line">    Integer <span class="title function_">getBalance</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">// å–æ¬¾</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(Integer amount)</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ–¹æ³•å†…ä¼šå¯åŠ¨ 1000 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åš -10 å…ƒ çš„æ“ä½œ</span></span><br><span class="line"><span class="comment">     * å¦‚æœåˆå§‹ä½™é¢ä¸º 10000 é‚£ä¹ˆæ­£ç¡®çš„ç»“æœåº”å½“æ˜¯ 0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">demo</span><span class="params">(Account account)</span> &#123;</span><br><span class="line">        List&lt;Thread&gt; ts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            ts.add(<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                account.withdraw(<span class="number">10</span>);</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">        ts.forEach(Thread::start);</span><br><span class="line">        ts.forEach(t -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        System.out.println(account.getBalance()</span><br><span class="line">                + <span class="string">&quot; cost: &quot;</span> + (end-start)/<span class="number">1000_000</span> + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="82baad96-94cd-48cb-a4ff-33f009288334-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AccountUnsafe</span> <span class="keyword">implements</span> <span class="title class_">Account</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer balance;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AccountUnsafe</span><span class="params">(Integer balance)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.balance = balance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getBalance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> balance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(Integer amount)</span> &#123;</span><br><span class="line">        balance -= amount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="82baad96-94cd-48cb-a4ff-33f009288334-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    Account.demo(<span class="keyword">new</span> <span class="title class_">AccountUnsafe</span>(<span class="number">10000</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸæ¬¡çš„æ‰§è¡Œç»“æœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">330 cost: 306 ms</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="82baad96-94cd-48cb-a4ff-33f009288334-4"><p><code>withdraw</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(Integer amount)</span> &#123;</span><br><span class="line">    balance -= amount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹åº”çš„å­—èŠ‚ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ALOAD <span class="number">0</span> <span class="comment">// &lt;- this</span></span><br><span class="line">ALOAD <span class="number">0</span></span><br><span class="line">GETFIELD cn/itcast/AccountUnsafe.balance : Ljava/lang/Integer; <span class="comment">// &lt;- this.balance</span></span><br><span class="line">INVOKEVIRTUAL java/lang/Integer.intValue ()I <span class="comment">// æ‹†ç®±</span></span><br><span class="line">ALOAD <span class="number">1</span> <span class="comment">// &lt;- amount</span></span><br><span class="line">INVOKEVIRTUAL java/lang/Integer.intValue ()I <span class="comment">// æ‹†ç®±</span></span><br><span class="line">ISUB <span class="comment">// å‡æ³•</span></span><br><span class="line">INVOKESTATIC java/lang/Integer.valueOf (I)Ljava/lang/Integer; <span class="comment">// ç»“æœè£…ç®±</span></span><br><span class="line">PUTFIELD cn/itcast/AccountUnsafe.balance : Ljava/lang/Integer; <span class="comment">// -&gt; this.balance</span></span><br></pre></td></tr></table></figure><p>å¤šçº¿ç¨‹æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ALOAD <span class="number">0</span> <span class="comment">// thread-0 &lt;- this </span></span><br><span class="line">ALOAD <span class="number">0</span> </span><br><span class="line">GETFIELD cn/itcast/AccountUnsafe.balance <span class="comment">// thread-0 &lt;- this.balance </span></span><br><span class="line">INVOKEVIRTUAL java/lang/Integer.intValue <span class="comment">// thread-0 æ‹†ç®±</span></span><br><span class="line">ALOAD <span class="number">1</span> <span class="comment">// thread-0 &lt;- amount </span></span><br><span class="line">INVOKEVIRTUAL java/lang/Integer.intValue <span class="comment">// thread-0 æ‹†ç®±</span></span><br><span class="line">ISUB <span class="comment">// thread-0 å‡æ³•</span></span><br><span class="line">INVOKESTATIC java/lang/Integer.valueOf <span class="comment">// thread-0 ç»“æœè£…ç®±</span></span><br><span class="line">PUTFIELD cn/itcast/AccountUnsafe.balance <span class="comment">// thread-0 -&gt; this.balance </span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">ALOAD <span class="number">0</span> <span class="comment">// thread-1 &lt;- this </span></span><br><span class="line">ALOAD <span class="number">0</span> </span><br><span class="line">GETFIELD cn/itcast/AccountUnsafe.balance <span class="comment">// thread-1 &lt;- this.balance </span></span><br><span class="line">INVOKEVIRTUAL java/lang/Integer.intValue <span class="comment">// thread-1 æ‹†ç®±</span></span><br><span class="line">ALOAD <span class="number">1</span> <span class="comment">// thread-1 &lt;- amount </span></span><br><span class="line">INVOKEVIRTUAL java/lang/Integer.intValue <span class="comment">// thread-1 æ‹†ç®±</span></span><br><span class="line">ISUB <span class="comment">// thread-1 å‡æ³•</span></span><br><span class="line">INVOKESTATIC java/lang/Integer.valueOf <span class="comment">// thread-1 ç»“æœè£…ç®±</span></span><br><span class="line">PUTFIELD cn/itcast/AccountUnsafe.balance <span class="comment">// thread-1 -&gt; this.balance</span></span><br></pre></td></tr></table></figure><p>åŸå› ï¼šIntegerè™½ç„¶æ˜¯ä¸å¯å˜ç±»ï¼Œå…¶æ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯ä»¥ä¸Šæ“ä½œæ¶‰åŠåˆ°äº†å¤šä¸ªæ–¹æ³•çš„ç»„åˆï¼Œç­‰ä»·äºä»¥ä¸‹ä»£ç ï¼š</p><p>balance = new Integer(Integer.valueOf(balance) - amount);</p><p>å‰ä¸€ä¸ªæ–¹æ³•(valueOf)çš„ç»“æœå†³å®šåä¸€ä¸ªæ–¹æ³•(æ„é€ æ–¹æ³•)ï¼Œè¿™ç§ç»„åˆåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çº¿ç¨‹ä¸å®‰å…¨ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="1-1-è§£å†³æ€è·¯">1.1 è§£å†³æ€è·¯</h3><div class="tabs" id="7d446aa0-c56c-45d1-852b-e1eaa10d29c6"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#7d446aa0-c56c-45d1-852b-e1eaa10d29c6-1"><i class="fas fa-cat"></i>é”-æ‚²è§‚äº’æ–¥</button></li><li class="tab"><button type="button" data-href="#7d446aa0-c56c-45d1-852b-e1eaa10d29c6-2"><i class="fas fa-horse"></i>æ— é”-ä¹è§‚é‡è¯•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="7d446aa0-c56c-45d1-852b-e1eaa10d29c6-1"><p>é¦–å…ˆæƒ³åˆ°çš„æ˜¯ç»™ Account å¯¹è±¡åŠ é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AccountUnsafe</span> <span class="keyword">implements</span> <span class="title class_">Account</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer balance;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AccountUnsafe</span><span class="params">(Integer balance)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.balance = balance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> Integer <span class="title function_">getBalance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> balance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(Integer amount)</span> &#123;</span><br><span class="line">        balance -= amount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœä¸º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> cost: <span class="number">399</span> ms </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="7d446aa0-c56c-45d1-852b-e1eaa10d29c6-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AccountSafe</span> <span class="keyword">implements</span> <span class="title class_">Account</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> AtomicInteger balance;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AccountSafe</span><span class="params">(Integer balance)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.balance = <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(balance);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getBalance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> balance.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(Integer amount)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">prev</span> <span class="operator">=</span> balance.get();</span><br><span class="line">            <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> prev - amount;</span><br><span class="line">            <span class="keyword">if</span> (balance.compareAndSet(prev, next)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¯ä»¥ç®€åŒ–ä¸ºä¸‹é¢çš„æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// balance.addAndGet(-1 * amount);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    Account.demo(<span class="keyword">new</span> <span class="title class_">AccountSafe</span>(<span class="number">10000</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸæ¬¡çš„æ‰§è¡Œç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> cost: <span class="number">302</span> ms</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-CAS-ä¸-volatile">2. CAS ä¸ volatile</h2><p>å‰é¢çœ‹åˆ°çš„ AtomicInteger çš„è§£å†³æ–¹æ³•ï¼Œå†…éƒ¨å¹¶æ²¡æœ‰ç”¨é”æ¥ä¿æŠ¤å…±äº«å˜é‡çš„çº¿ç¨‹å®‰å…¨ã€‚é‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(Integer amount)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// éœ€è¦ä¸æ–­å°è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// æ¯”å¦‚æ‹¿åˆ°äº†æ—§å€¼ 1000</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">prev</span> <span class="operator">=</span> balance.get();</span><br><span class="line">            <span class="comment">// åœ¨è¿™ä¸ªåŸºç¡€ä¸Š 1000-10 = 990</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> prev - amount;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             compareAndSet æ­£æ˜¯åšè¿™ä¸ªæ£€æŸ¥ï¼Œåœ¨ set å‰ï¼Œå…ˆæ¯”è¾ƒ prev ä¸å½“å‰å€¼</span></span><br><span class="line"><span class="comment">             - ä¸ä¸€è‡´äº†ï¼Œnext ä½œåºŸï¼Œè¿”å› false è¡¨ç¤ºå¤±è´¥</span></span><br><span class="line"><span class="comment">             æ¯”å¦‚ï¼Œåˆ«çš„çº¿ç¨‹å·²ç»åšäº†å‡æ³•ï¼Œå½“å‰å€¼å·²ç»è¢«å‡æˆäº† 990</span></span><br><span class="line"><span class="comment">             é‚£ä¹ˆæœ¬çº¿ç¨‹çš„è¿™æ¬¡ 990 å°±ä½œåºŸäº†ï¼Œè¿›å…¥ while ä¸‹æ¬¡å¾ªç¯é‡è¯•</span></span><br><span class="line"><span class="comment">             - ä¸€è‡´ï¼Œä»¥ next è®¾ç½®ä¸ºæ–°å€¼ï¼Œè¿”å› true è¡¨ç¤ºæˆåŠŸ</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (balance.compareAndSet(prev, next)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æˆ–è€…ç®€æ´ä¸€ç‚¹ï¼š</span></span><br><span class="line">            <span class="comment">//balance.getAndAdd(-1 * amount);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„å…³é”®æ˜¯ compareAndSetï¼Œå®ƒçš„ç®€ç§°å°±æ˜¯ CAS ï¼ˆä¹Ÿæœ‰ Compare And Swap çš„è¯´æ³•ï¼‰ï¼Œå®ƒå¿…é¡»æ˜¯åŸå­æ“ä½œã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220308180039801.png" alt="image-20220308180039801" style="zoom:67%;" /><blockquote><p><strong>æ³¨æ„</strong></p><p>å…¶å® CAS çš„åº•å±‚æ˜¯ lock cmpxchg æŒ‡ä»¤ï¼ˆX86 æ¶æ„ï¼‰ï¼Œåœ¨å•æ ¸ CPU å’Œå¤šæ ¸ CPU ä¸‹éƒ½èƒ½å¤Ÿä¿è¯ã€æ¯”è¾ƒ-äº¤ æ¢ã€‘çš„åŸå­æ€§ã€‚</p><p>åœ¨å¤šæ ¸çŠ¶æ€ä¸‹ï¼ŒæŸä¸ªæ ¸æ‰§è¡Œåˆ°å¸¦ lock çš„æŒ‡ä»¤æ—¶ï¼ŒCPU ä¼šè®©æ€»çº¿é”ä½ï¼Œå½“è¿™ä¸ªæ ¸æŠŠæ­¤æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•ï¼Œå† å¼€å¯æ€»çº¿ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ä¸ä¼šè¢«çº¿ç¨‹çš„è°ƒåº¦æœºåˆ¶æ‰€æ‰“æ–­ï¼Œä¿è¯äº†å¤šä¸ªçº¿ç¨‹å¯¹å†…å­˜æ“ä½œçš„å‡†ç¡®æ€§ï¼Œæ˜¯åŸå­ çš„ã€‚</p></blockquote><h3 id="2-1-volatile">2.1 volatile</h3><p>è·å–å…±äº«å˜é‡æ—¶ï¼Œä¸ºäº†ä¿è¯è¯¥å˜é‡çš„å¯è§æ€§ï¼Œéœ€è¦ä½¿ç”¨ volatile ä¿®é¥°ã€‚</p><p>å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡ï¼Œä»–å¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å– å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œ volatile å˜é‡éƒ½æ˜¯ç›´æ¥æ“ä½œä¸»å­˜ã€‚å³ä¸€ä¸ªçº¿ç¨‹å¯¹ volatile å˜é‡çš„ä¿®æ”¹ï¼Œå¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ã€‚</p><blockquote><p><strong>æ³¨æ„</strong></p><p>volatile ä»…ä»…ä¿è¯äº†å…±äº«å˜é‡çš„å¯è§æ€§ï¼Œè®©å…¶å®ƒçº¿ç¨‹èƒ½å¤Ÿçœ‹åˆ°æœ€æ–°å€¼ï¼Œä½†ä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™é—®é¢˜ï¼ˆä¸èƒ½ä¿è¯åŸå­æ€§ï¼‰</p></blockquote><p>CAS å¿…é¡»å€ŸåŠ© volatile æ‰èƒ½è¯»å–åˆ°å…±äº«å˜é‡çš„æœ€æ–°å€¼æ¥å®ç°ã€æ¯”è¾ƒå¹¶äº¤æ¢ã€‘çš„æ•ˆæœã€‚</p><h3 id="2-2-ä¸ºä»€ä¹ˆæ— é”æ•ˆç‡é«˜">2.2 ä¸ºä»€ä¹ˆæ— é”æ•ˆç‡é«˜</h3><ul><li>æ— é”æƒ…å†µä¸‹ï¼Œå³ä½¿é‡è¯•å¤±è´¥ï¼Œçº¿ç¨‹å§‹ç»ˆåœ¨é«˜é€Ÿè¿è¡Œï¼Œæ²¡æœ‰åœæ­‡ï¼Œç±»ä¼¼äºè‡ªæ—‹ã€‚è€Œ synchronized ä¼šè®©çº¿ç¨‹åœ¨æ²¡æœ‰è·å¾—é”çš„æ—¶å€™ï¼Œå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥é˜»å¡ã€‚çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯è´¹æ—¶çš„ï¼Œåœ¨é‡è¯•æ¬¡æ•°ä¸æ˜¯å¤ªå¤šæ—¶ï¼Œæ— é”çš„æ•ˆç‡é«˜äºæœ‰é”ã€‚</li><li>çº¿ç¨‹å°±å¥½åƒé«˜é€Ÿè·‘é“ä¸Šçš„èµ›è½¦ï¼Œé«˜é€Ÿè¿è¡Œæ—¶ï¼Œé€Ÿåº¦è¶…å¿«ï¼Œä¸€æ—¦å‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå°±å¥½æ¯”èµ›è½¦è¦å‡é€Ÿã€ç†„ç«ï¼Œ ç­‰è¢«å”¤é†’åˆå¾—é‡æ–°æ‰“ç«ã€å¯åŠ¨ã€åŠ é€Ÿâ€¦ æ¢å¤åˆ°é«˜é€Ÿè¿è¡Œï¼Œä»£ä»·æ¯”è¾ƒå¤§</li><li>ä½†æ— é”æƒ…å†µä¸‹ï¼Œå› ä¸ºçº¿ç¨‹è¦ä¿æŒè¿è¡Œï¼Œéœ€è¦é¢å¤– CPU çš„æ”¯æŒï¼ŒCPU åœ¨è¿™é‡Œå°±å¥½æ¯”é«˜é€Ÿè·‘é“ï¼Œæ²¡æœ‰é¢å¤–çš„è·‘ é“ï¼Œçº¿ç¨‹æƒ³é«˜é€Ÿè¿è¡Œä¹Ÿæ— ä»è°ˆèµ·ï¼Œè™½ç„¶ä¸ä¼šè¿›å…¥é˜»å¡ï¼Œä½†ç”±äºæ²¡æœ‰åˆ†åˆ°æ—¶é—´ç‰‡ï¼Œä»ç„¶ä¼šè¿›å…¥å¯è¿è¡ŒçŠ¶æ€ï¼Œè¿˜ æ˜¯ä¼šå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚æ‰€ä»¥æ€»çš„æ¥è¯´ï¼Œå½“çº¿ç¨‹æ•°å°äºç­‰äºcpuæ ¸å¿ƒæ•°æ—¶ï¼Œä½¿ç”¨æ— é”æ–¹æ¡ˆæ˜¯å¾ˆåˆé€‚çš„ï¼Œå› ä¸ºæœ‰è¶³å¤Ÿå¤šçš„cpuè®©çº¿ç¨‹è¿è¡Œã€‚å½“çº¿ç¨‹æ•°è¿œå¤šäºcpuæ ¸å¿ƒæ•°æ—¶ï¼Œæ— é”æ•ˆç‡ç›¸æ¯”äºæœ‰é”å°±æ²¡æœ‰å¤ªå¤§ä¼˜åŠ¿ï¼Œå› ä¸ºä¾æ—§ä¼šå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</li></ul><h3 id="2-3-CAS-çš„ç‰¹ç‚¹">2.3 CAS çš„ç‰¹ç‚¹</h3><p>ç»“åˆ CAS å’Œ volatile å¯ä»¥å®ç°æ— é”å¹¶å‘ï¼Œé€‚ç”¨äºçº¿ç¨‹æ•°å°‘ã€å¤šæ ¸ CPU çš„åœºæ™¯ä¸‹ã€‚</p><ul><li>CAS æ˜¯åŸºäºä¹è§‚é”çš„æ€æƒ³ï¼šæœ€ä¹è§‚çš„ä¼°è®¡ï¼Œä¸æ€•åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œå°±ç®—æ”¹äº†ä¹Ÿæ²¡å…³ç³»ï¼Œæˆ‘åƒäºç‚¹å†é‡è¯•å‘—ã€‚</li><li>synchronized æ˜¯åŸºäºæ‚²è§‚é”çš„æ€æƒ³ï¼šæœ€æ‚²è§‚çš„ä¼°è®¡ï¼Œå¾—é˜²ç€å…¶å®ƒçº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œæˆ‘ä¸Šäº†é”ä½ ä»¬éƒ½åˆ«æƒ³ æ”¹ï¼Œæˆ‘æ”¹å®Œäº†è§£å¼€é”ï¼Œä½ ä»¬æ‰æœ‰æœºä¼šã€‚</li><li>CAS ä½“ç°çš„æ˜¯æ— é”å¹¶å‘ã€æ— é˜»å¡å¹¶å‘ï¼Œè¯·ä»”ç»†ä½“ä¼šè¿™ä¸¤å¥è¯çš„æ„æ€<ul><li>å› ä¸ºæ²¡æœ‰ä½¿ç”¨ synchronizedï¼Œæ‰€ä»¥çº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ï¼Œè¿™æ˜¯æ•ˆç‡æå‡çš„å› ç´ ä¹‹ä¸€</li><li>ä½†å¦‚æœç«äº‰æ¿€çƒˆï¼Œå¯ä»¥æƒ³åˆ°é‡è¯•å¿…ç„¶é¢‘ç¹å‘ç”Ÿï¼Œåè€Œæ•ˆç‡ä¼šå—å½±å“</li></ul></li></ul><h2 id="3-åŸå­æ•´æ•°">3. åŸå­æ•´æ•°</h2><p>J.U.C å¹¶å‘åŒ…æä¾›äº†ï¼š</p><ul><li>AtomicBoolean</li><li>AtomicInteger</li><li>AtomicLong</li></ul><p>ä»¥ AtomicInteger ä¸ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AtomicInteger</span> <span class="variable">i</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// è·å–å¹¶è‡ªå¢ï¼ˆi = 0, ç»“æœ i = 1, è¿”å› 0ï¼‰ï¼Œç±»ä¼¼äº i++</span></span><br><span class="line">System.out.println(i.getAndIncrement());</span><br><span class="line"><span class="comment">// è‡ªå¢å¹¶è·å–ï¼ˆi = 1, ç»“æœ i = 2, è¿”å› 2ï¼‰ï¼Œç±»ä¼¼äº ++i</span></span><br><span class="line">System.out.println(i.incrementAndGet());</span><br><span class="line"><span class="comment">// è‡ªå‡å¹¶è·å–ï¼ˆi = 2, ç»“æœ i = 1, è¿”å› 1ï¼‰ï¼Œç±»ä¼¼äº --i</span></span><br><span class="line">System.out.println(i.decrementAndGet());</span><br><span class="line"><span class="comment">// è·å–å¹¶è‡ªå‡ï¼ˆi = 1, ç»“æœ i = 0, è¿”å› 1ï¼‰ï¼Œç±»ä¼¼äº i--</span></span><br><span class="line">System.out.println(i.getAndDecrement());</span><br><span class="line"><span class="comment">// è·å–å¹¶åŠ å€¼ï¼ˆi = 0, ç»“æœ i = 5, è¿”å› 0ï¼‰</span></span><br><span class="line">System.out.println(i.getAndAdd(<span class="number">5</span>));</span><br><span class="line"><span class="comment">// åŠ å€¼å¹¶è·å–ï¼ˆi = 5, ç»“æœ i = 0, è¿”å› 0ï¼‰</span></span><br><span class="line">System.out.println(i.addAndGet(-<span class="number">5</span>));</span><br><span class="line"><span class="comment">// è·å–å¹¶æ›´æ–°(æ›´æ–°æ–¹å¼å¯ä»¥è‡ªå®šä¹‰ï¼Œå‡½æ•°å¼æ¥å£)ï¼ˆi = 0, p ä¸º i çš„å½“å‰å€¼, ç»“æœ i = -2, è¿”å› 0ï¼‰</span></span><br><span class="line">System.out.println(i.getAndUpdate(p -&gt; p - <span class="number">2</span>));</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæ–¹æ³•éƒ½æ˜¯ä»¥CASä¸ºåŸºç¡€è¿›è¡Œäº†å°è£…ï¼Œä¿è¯äº†æ–¹æ³•çš„åŸå­æ€§å’Œå˜é‡çš„å¯è§æ€§ã€‚</p><p><code>updateAndGetåŸç†</code></p><div class="tabs" id="913c8794-ca5f-4754-9bc9-eff6be9dbded"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#913c8794-ca5f-4754-9bc9-eff6be9dbded-1"><i class="fas fa-atom"></i>è‡ªå·±åŠ¨æ‰‹å®ç°</button></li><li class="tab"><button type="button" data-href="#913c8794-ca5f-4754-9bc9-eff6be9dbded-2"><i class="far fa-sun"></i>æ”¹è¿›1</button></li><li class="tab"><button type="button" data-href="#913c8794-ca5f-4754-9bc9-eff6be9dbded-3"><i class="fas fa-wind"></i>æ”¹è¿›2</button></li><li class="tab"><button type="button" data-href="#913c8794-ca5f-4754-9bc9-eff6be9dbded-4"><i class="fas fa-fire-alt"></i>åŸç”Ÿå®ç°</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="913c8794-ca5f-4754-9bc9-eff6be9dbded-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">AtomicInteger</span> <span class="variable">i</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="type">int</span> prev=i.get();</span><br><span class="line">        <span class="type">int</span> next=prev*<span class="number">10</span>;</span><br><span class="line">        <span class="keyword">if</span>(i.compareAndSet(prev,next))&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(i.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="913c8794-ca5f-4754-9bc9-eff6be9dbded-2"><p>è¿™æ ·åšä»£ç æ²¡æœ‰ä»»ä½•é€šç”¨æ€§ï¼Œå…·ä½“çš„è®¡ç®—æ“ä½œå·²ç»å†™æ­»äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠæ“ä½œå½“åšå˜åŒ–çš„å†…å®¹ä¼ è¿›æ¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">AtomicInteger</span> <span class="variable">i</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">    updateAndGet(i);</span><br><span class="line">    System.out.println(i.get());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">updateAndGet</span><span class="params">(AtomicInteger i)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="type">int</span> prev=i.get();</span><br><span class="line">        <span class="type">int</span> next=prev*<span class="number">10</span>;</span><br><span class="line">        <span class="keyword">if</span>(i.compareAndSet(prev,next))&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="913c8794-ca5f-4754-9bc9-eff6be9dbded-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">AtomicInteger</span> <span class="variable">i</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">5</span>);</span><br><span class="line">    updateAndGet(i, operand -&gt; operand/<span class="number">2</span>);</span><br><span class="line">    System.out.println(i.get());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">updateAndGet</span><span class="params">(AtomicInteger i, IntUnaryOperator operator)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="type">int</span> prev=i.get();</span><br><span class="line">        <span class="type">int</span> next=operator.applyAsInt(prev);</span><br><span class="line">        <span class="keyword">if</span>(i.compareAndSet(prev,next))&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="913c8794-ca5f-4754-9bc9-eff6be9dbded-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">updateAndGet</span><span class="params">(IntUnaryOperator updateFunction)</span> &#123;</span><br><span class="line">    <span class="type">int</span> prev, next;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        prev = get();</span><br><span class="line">        next = updateFunction.applyAsInt(prev);</span><br><span class="line">    &#125; <span class="keyword">while</span> (!compareAndSet(prev, next));</span><br><span class="line">    <span class="keyword">return</span> next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <h2 id="3-åŸå­å¼•ç”¨">3. åŸå­å¼•ç”¨</h2><p>ä¸ºä»€ä¹ˆéœ€è¦åŸå­å¼•ç”¨ç±»å‹ï¼Ÿ</p><ul><li>AtomicReference</li><li>AtomicMarkableReference</li><li>AtomicStampedReference</li></ul><p>å®é™…å¼€å‘çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬ä½¿ç”¨çš„ä¸ä¸€å®šæ˜¯intã€longç­‰åŸºæœ¬æ•°æ®ç±»å‹ï¼Œä¹Ÿæœ‰å¯èƒ½æ—¶BigDecimalè¿™æ ·çš„ç±»å‹ï¼Œè¿™æ—¶å°±éœ€è¦ç”¨åˆ°åŸå­å¼•ç”¨ä½œä¸ºå®¹å™¨ã€‚åŸå­å¼•ç”¨è®¾ç½®å€¼ä½¿ç”¨çš„æ˜¯<code>unsafe.compareAndSwapObject()</code>æ–¹æ³•ã€‚åŸå­å¼•ç”¨ä¸­è¡¨ç¤ºæ•°æ®çš„ç±»å‹éœ€è¦é‡å†™<code>equals()</code>æ–¹æ³•ã€‚<div class="tabs" id="2bae6376-5a46-4999-bad9-046428061114"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2bae6376-5a46-4999-bad9-046428061114-1"><i class="fas fa-seedling"></i>DecimalAccounæ¥å£</button></li><li class="tab"><button type="button" data-href="#2bae6376-5a46-4999-bad9-046428061114-2"><i class="fas fa-tree"></i>ä½¿ç”¨é”</button></li><li class="tab"><button type="button" data-href="#2bae6376-5a46-4999-bad9-046428061114-3"><i class="fas fa-leaf"></i>ä½¿ç”¨ CAS</button></li><li class="tab"><button type="button" data-href="#2bae6376-5a46-4999-bad9-046428061114-4"><i class="fab fa-apple"></i>æµ‹è¯•&ç»“æœ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2bae6376-5a46-4999-bad9-046428061114-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DecimalAccount</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–ä½™é¢</span></span><br><span class="line">    BigDecimal <span class="title function_">getBalance</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">// å–æ¬¾</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(BigDecimal amount)</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ–¹æ³•å†…ä¼šå¯åŠ¨ 1000 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åš -10 å…ƒ çš„æ“ä½œ</span></span><br><span class="line"><span class="comment"> * å¦‚æœåˆå§‹ä½™é¢ä¸º 10000 é‚£ä¹ˆæ­£ç¡®çš„ç»“æœåº”å½“æ˜¯ 0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">demo</span><span class="params">(DecimalAccount account)</span> &#123;</span><br><span class="line">        List&lt;Thread&gt; ts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            ts.add(<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                account.withdraw(BigDecimal.TEN);</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">        ts.forEach(Thread::start);</span><br><span class="line">        ts.forEach(t -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(account.getBalance());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2bae6376-5a46-4999-bad9-046428061114-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DecimalAccountSafeLock</span> <span class="keyword">implements</span> <span class="title class_">DecimalAccount</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    BigDecimal balance;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DecimalAccountSafeLock</span><span class="params">(BigDecimal balance)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.balance = balance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">getBalance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> balance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(BigDecimal amount)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="type">BigDecimal</span> <span class="variable">balance</span> <span class="operator">=</span> <span class="built_in">this</span>.getBalance();</span><br><span class="line">            <span class="built_in">this</span>.balance = balance.subtract(amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2bae6376-5a46-4999-bad9-046428061114-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DecimalAccountSafeCas</span> <span class="keyword">implements</span> <span class="title class_">DecimalAccount</span> &#123;</span><br><span class="line">    AtomicReference&lt;BigDecimal&gt; ref;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DecimalAccountSafeCas</span><span class="params">(BigDecimal balance)</span> &#123;</span><br><span class="line">        ref = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;(balance);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">getBalance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ref.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(BigDecimal amount)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">BigDecimal</span> <span class="variable">prev</span> <span class="operator">=</span> ref.get();</span><br><span class="line">            <span class="type">BigDecimal</span> <span class="variable">next</span> <span class="operator">=</span> prev.subtract(amount);</span><br><span class="line">            <span class="keyword">if</span> (ref.compareAndSet(prev, next)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2bae6376-5a46-4999-bad9-046428061114-4"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DecimalAccount.demo(new DecimalAccountUnsafe(new BigDecimal(<span class="string">&quot;10000&quot;</span>)));</span><br><span class="line">DecimalAccount.demo(new DecimalAccountSafeLock(new BigDecimal(<span class="string">&quot;10000&quot;</span>)));</span><br><span class="line">DecimalAccount.demo(new DecimalAccountSafeCas(new BigDecimal(<span class="string">&quot;10000&quot;</span>)));</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">4310 cost: 425 ms </span><br><span class="line">0 cost: 285 ms </span><br><span class="line">0 cost: 274 ms</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></p><h3 id="3-1-ABA-é—®é¢˜åŠè§£å†³">3.1 ABA é—®é¢˜åŠè§£å†³</h3><p>ABAé—®é¢˜æ˜¯æŒ‡åœ¨å¤šçº¿ç¨‹å¹¶å‘è®¿é—®ä¸­ï¼Œä¸€ä¸ªå…±äº«å˜é‡çš„å€¼ä»Aå˜ä¸ºBï¼Œåˆä»Bå˜å›Aï¼Œè¿™æ—¶ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨æ£€æŸ¥è¯¥å˜é‡å€¼æ˜¯å¦ä¸ºAæ—¶ï¼Œå¯èƒ½ä¼šè¢«è¯¯å¯¼è®¤ä¸ºè¯¥å˜é‡å€¼ä¸€ç›´æ²¡æœ‰å‘ç”Ÿæ”¹å˜ã€‚</p><p>ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> AtomicReference&lt;String&gt; ref = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;(<span class="string">&quot;A&quot;</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;main start...&quot;</span>);</span><br><span class="line">    <span class="comment">// è·å–å€¼ A</span></span><br><span class="line">    <span class="comment">// è¿™ä¸ªå…±äº«å˜é‡è¢«å®ƒçº¿ç¨‹ä¿®æ”¹è¿‡ï¼Ÿ</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">prev</span> <span class="operator">=</span> ref.get();</span><br><span class="line">    other();</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// å°è¯•æ”¹ä¸º C</span></span><br><span class="line">    log.debug(<span class="string">&quot;change A-&gt;C &#123;&#125;&quot;</span>, ref.compareAndSet(prev, <span class="string">&quot;C&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">other</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;change A-&gt;B &#123;&#125;&quot;</span>, ref.compareAndSet(ref.get(), <span class="string">&quot;B&quot;</span>));</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    sleep(<span class="number">0.5</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;change B-&gt;A &#123;&#125;&quot;</span>, ref.compareAndSet(ref.get(), <span class="string">&quot;A&quot;</span>));</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">11:29:52.325 c.Test36 [main] - main start... </span><br><span class="line">11:29:52.379 c.Test36 [t1] - change A-&gt;B <span class="literal">true</span> </span><br><span class="line">11:29:52.879 c.Test36 [t2] - change B-&gt;A <span class="literal">true</span> </span><br><span class="line">11:29:53.880 c.Test36 [main] - change A-&gt;C <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>ä¸»çº¿ç¨‹ä»…èƒ½åˆ¤æ–­å‡ºå…±äº«å˜é‡çš„å€¼ä¸æœ€åˆå€¼ A æ˜¯å¦ç›¸åŒï¼Œä¸èƒ½æ„ŸçŸ¥åˆ°è¿™ç§ä» A æ”¹ä¸º B åˆ æ”¹å› A çš„æƒ…å†µï¼Œå¦‚æœä¸»çº¿ç¨‹ å¸Œæœ›ï¼š</p><p>åªè¦æœ‰å…¶å®ƒçº¿ç¨‹ã€åŠ¨è¿‡äº†ã€‘å…±äº«å˜é‡ï¼Œé‚£ä¹ˆè‡ªå·±çš„ cas å°±ç®—å¤±è´¥ï¼Œè¿™æ—¶ï¼Œä»…æ¯”è¾ƒå€¼æ˜¯ä¸å¤Ÿçš„ï¼Œéœ€è¦å†åŠ ä¸€ä¸ªç‰ˆæœ¬å·</p><div class="tabs" id="0f439f44-44d6-43b9-b786-95ff64c89826"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#0f439f44-44d6-43b9-b786-95ff64c89826-1"><i class="fas fa-cat"></i>AtomicStampedReference</button></li><li class="tab"><button type="button" data-href="#0f439f44-44d6-43b9-b786-95ff64c89826-2"><i class="fas fa-horse"></i>è¾“å‡º</button></li><li class="tab"><button type="button" data-href="#0f439f44-44d6-43b9-b786-95ff64c89826-3"><i class="fas fa-dove"></i>AtomicMarkableReference</button></li><li class="tab"><button type="button" data-href="#0f439f44-44d6-43b9-b786-95ff64c89826-4"><i class="fas fa-dragon"></i>è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="0f439f44-44d6-43b9-b786-95ff64c89826-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> AtomicStampedReference&lt;String&gt; ref = <span class="keyword">new</span> <span class="title class_">AtomicStampedReference</span>&lt;&gt;(<span class="string">&quot;A&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;main start...&quot;</span>);</span><br><span class="line">    <span class="comment">// è·å–å€¼ A</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">prev</span> <span class="operator">=</span> ref.getReference();</span><br><span class="line">    <span class="comment">// è·å–ç‰ˆæœ¬å·</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">stamp</span> <span class="operator">=</span> ref.getStamp();</span><br><span class="line">    log.debug(<span class="string">&quot;ç‰ˆæœ¬ &#123;&#125;&quot;</span>, stamp);</span><br><span class="line">    <span class="comment">// å¦‚æœä¸­é—´æœ‰å…¶å®ƒçº¿ç¨‹å¹²æ‰°ï¼Œå‘ç”Ÿäº† ABA ç°è±¡</span></span><br><span class="line">    other();</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// å°è¯•æ”¹ä¸º C</span></span><br><span class="line">    log.debug(<span class="string">&quot;change A-&gt;C &#123;&#125;&quot;</span>, ref.compareAndSet(prev, <span class="string">&quot;C&quot;</span>, stamp, stamp + <span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">other</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;change A-&gt;B &#123;&#125;&quot;</span>, ref.compareAndSet(ref.getReference(), <span class="string">&quot;B&quot;</span>,</span><br><span class="line">                ref.getStamp(), ref.getStamp() + <span class="number">1</span>));</span><br><span class="line">        log.debug(<span class="string">&quot;æ›´æ–°ç‰ˆæœ¬ä¸º &#123;&#125;&quot;</span>, ref.getStamp());</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    sleep(<span class="number">0.5</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;change B-&gt;A &#123;&#125;&quot;</span>, ref.compareAndSet(ref.getReference(), <span class="string">&quot;A&quot;</span>,</span><br><span class="line">                ref.getStamp(), ref.getStamp() + <span class="number">1</span>));</span><br><span class="line">        log.debug(<span class="string">&quot;æ›´æ–°ç‰ˆæœ¬ä¸º &#123;&#125;&quot;</span>, ref.getStamp());</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0f439f44-44d6-43b9-b786-95ff64c89826-2"><p>AtomicStampedReference å¯ä»¥ç»™åŸå­å¼•ç”¨åŠ ä¸Šç‰ˆæœ¬å·ï¼Œè¿½è¸ªåŸå­å¼•ç”¨æ•´ä¸ªçš„å˜åŒ–è¿‡ç¨‹ï¼Œå¦‚ï¼š <code>A -&gt; B -&gt; A -&gt; C</code> ï¼Œé€šè¿‡AtomicStampedReferenceï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¼•ç”¨å˜é‡ä¸­é€”è¢«æ›´æ”¹äº†å‡ æ¬¡ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">15:41:34.891 c.Test36 [main] - main start... </span><br><span class="line">15:41:34.894 c.Test36 [main] - ç‰ˆæœ¬ 0 </span><br><span class="line">15:41:34.956 c.Test36 [t1] - change A-&gt;B <span class="literal">true</span> </span><br><span class="line">15:41:34.956 c.Test36 [t1] - æ›´æ–°ç‰ˆæœ¬ä¸º 1 </span><br><span class="line">15:41:35.457 c.Test36 [t2] - change B-&gt;A <span class="literal">true</span> </span><br><span class="line">15:41:35.457 c.Test36 [t2] - æ›´æ–°ç‰ˆæœ¬ä¸º 2 </span><br><span class="line">15:41:36.457 c.Test36 [main] - change A-&gt;C <span class="literal">false</span> </span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æœ‰æ—¶å€™ï¼Œå¹¶ä¸å…³å¿ƒå¼•ç”¨å˜é‡æ›´æ”¹äº†å‡ æ¬¡ï¼Œåªæ˜¯å•çº¯çš„å…³å¿ƒæ˜¯å¦æ›´æ”¹è¿‡ï¼Œæ‰€ä»¥å°±æœ‰äº† AtomicMarkableReference</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230402145328927.png" alt="image-20230402145328927" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0f439f44-44d6-43b9-b786-95ff64c89826-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">GarbageBag</span> <span class="variable">bag</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GarbageBag</span>(<span class="string">&quot;è£…æ»¡äº†åƒåœ¾&quot;</span>);</span><br><span class="line">        <span class="comment">// å‚æ•°2 mark å¯ä»¥çœ‹ä½œä¸€ä¸ªæ ‡è®°ï¼Œè¡¨ç¤ºåƒåœ¾è¢‹æ»¡äº†</span></span><br><span class="line">        AtomicMarkableReference&lt;GarbageBag&gt; ref = <span class="keyword">new</span> <span class="title class_">AtomicMarkableReference</span>&lt;&gt;(bag, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">        <span class="type">GarbageBag</span> <span class="variable">prev</span> <span class="operator">=</span> ref.getReference();</span><br><span class="line">        log.debug(prev.toString());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">            bag.setDesc(<span class="string">&quot;ç©ºåƒåœ¾è¢‹&quot;</span>);</span><br><span class="line">            ref.compareAndSet(bag, bag, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">            log.debug(bag.toString());</span><br><span class="line">        &#125;,<span class="string">&quot;ä¿æ´é˜¿å§¨&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;æƒ³æ¢ä¸€åªæ–°åƒåœ¾è¢‹ï¼Ÿ&quot;</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> ref.compareAndSet(prev, <span class="keyword">new</span> <span class="title class_">GarbageBag</span>(<span class="string">&quot;ç©ºåƒåœ¾è¢‹&quot;</span>), <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;æ¢äº†ä¹ˆï¼Ÿ&quot;</span> + success);</span><br><span class="line">        log.debug(ref.getReference().toString());</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GarbageBag</span> &#123;</span><br><span class="line">    String desc;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GarbageBag</span><span class="params">(String desc)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDesc</span><span class="params">(String desc)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.toString() + <span class="string">&quot; &quot;</span> + desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0f439f44-44d6-43b9-b786-95ff64c89826-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">43.062</span> c.Test38 [main] - start...</span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">43.066</span> c.Test38 [main] - cn.itcast.test.GarbageBag@6aceb1a5 è£…æ»¡äº†åƒåœ¾</span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">43.223</span> c.Test38 [ä¿æ´é˜¿å§¨] - start...</span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">43.227</span> c.Test38 [ä¿æ´é˜¿å§¨] - cn.itcast.test.GarbageBag@6aceb1a5 ç©ºåƒåœ¾è¢‹</span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">44.237</span> c.Test38 [main] - æƒ³æ¢ä¸€åªæ–°åƒåœ¾è¢‹ï¼Ÿ</span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">44.238</span> c.Test38 [main] - æ¢äº†ä¹ˆï¼Ÿ<span class="literal">false</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">44.238</span> c.Test38 [main] - cn.itcast.test.GarbageBag@6aceb1a5 ç©ºåƒåœ¾è¢‹</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="4-åŸå­æ•°ç»„">4. åŸå­æ•°ç»„</h2><ul><li>AtomicIntegerArray</li><li>AtomicLongArray</li><li>AtomicReferenceArray</li></ul><div class="tabs" id="32db3c34-225f-48e2-ac57-d9ce08f287b4"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#32db3c34-225f-48e2-ac57-d9ce08f287b4-1"><i class="fas fa-atom"></i>å°è£…æ–¹æ³•</button></li><li class="tab"><button type="button" data-href="#32db3c34-225f-48e2-ac57-d9ce08f287b4-2"><i class="far fa-sun"></i>ä¸å®‰å…¨çš„æ•°ç»„</button></li><li class="tab"><button type="button" data-href="#32db3c34-225f-48e2-ac57-d9ce08f287b4-3"><i class="fas fa-wind"></i>å®‰å…¨çš„æ•°ç»„</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="32db3c34-225f-48e2-ac57-d9ce08f287b4-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> å‚æ•°1ï¼Œæä¾›æ•°ç»„ã€å¯ä»¥æ˜¯çº¿ç¨‹ä¸å®‰å…¨æ•°ç»„æˆ–çº¿ç¨‹å®‰å…¨æ•°ç»„</span></span><br><span class="line"><span class="comment"> å‚æ•°2ï¼Œè·å–æ•°ç»„é•¿åº¦çš„æ–¹æ³•</span></span><br><span class="line"><span class="comment"> å‚æ•°3ï¼Œè‡ªå¢æ–¹æ³•ï¼Œå›ä¼  array, index</span></span><br><span class="line"><span class="comment"> å‚æ•°4ï¼Œæ‰“å°æ•°ç»„çš„æ–¹æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// supplier æä¾›è€… æ— ä¸­ç”Ÿæœ‰ ()-&gt;ç»“æœ</span></span><br><span class="line"><span class="comment">// function å‡½æ•° ä¸€ä¸ªå‚æ•°ä¸€ä¸ªç»“æœ (å‚æ•°)-&gt;ç»“æœ , BiFunction (å‚æ•°1,å‚æ•°2)-&gt;ç»“æœ</span></span><br><span class="line"><span class="comment">// consumer æ¶ˆè´¹è€… ä¸€ä¸ªå‚æ•°æ²¡ç»“æœ (å‚æ•°)-&gt;void, BiConsumer (å‚æ•°1,å‚æ•°2)-&gt;</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">demo</span><span class="params">(Supplier&lt;T&gt; arraySupplier, Function&lt;T, Integer&gt; lengthFun,</span></span><br><span class="line"><span class="params">        BiConsumer&lt;T, Integer&gt; putConsumer, Consumer&lt;T&gt; printConsumer )</span> &#123;</span><br><span class="line">    </span><br><span class="line">    List&lt;Thread&gt; ts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">T</span> <span class="variable">array</span> <span class="operator">=</span> arraySupplier.get();</span><br><span class="line">    <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> lengthFun.apply(array);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        <span class="comment">// æ¯ä¸ªçº¿ç¨‹å¯¹æ•°ç»„ä½œ 10000 æ¬¡æ“ä½œ</span></span><br><span class="line">        ts.add(<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">10000</span>; j++) &#123;</span><br><span class="line">                putConsumer.accept(array, j%length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    ts.forEach(t -&gt; t.start()); <span class="comment">// å¯åŠ¨æ‰€æœ‰çº¿ç¨‹</span></span><br><span class="line">    ts.forEach(t -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            t.join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;); <span class="comment">// ç­‰æ‰€æœ‰çº¿ç¨‹ç»“æŸ</span></span><br><span class="line">    printConsumer.accept(array);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="32db3c34-225f-48e2-ac57-d9ce08f287b4-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">demo(</span><br><span class="line">    ()-&gt;<span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">10</span>],</span><br><span class="line">    (array)-&gt;array.length,</span><br><span class="line">    (array, index) -&gt; array[index]++,</span><br><span class="line">    array-&gt; System.out.println(Arrays.toString(array))</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ç»“æœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[9870, 9862, 9774, 9697, 9683, 9678, 9679, 9668, 9680, 9698] </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="32db3c34-225f-48e2-ac57-d9ce08f287b4-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">demo(</span><br><span class="line">    ()-&gt; <span class="keyword">new</span> <span class="title class_">AtomicIntegerArray</span>(<span class="number">10</span>),</span><br><span class="line">    (array) -&gt; array.length(),</span><br><span class="line">    (array, index) -&gt; array.getAndIncrement(index),</span><br><span class="line">    array -&gt; System.out.println(array)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ç»“æœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000] </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <h2 id="5-å­—æ®µæ›´æ–°å™¨">5. å­—æ®µæ›´æ–°å™¨</h2><ul><li>AtomicReferenceFieldUpdater // åŸŸ å­—æ®µ</li><li>AtomicIntegerFieldUpdater</li><li>AtomicLongFieldUpdater</li></ul><p>åˆ©ç”¨å­—æ®µæ›´æ–°å™¨ï¼Œå¯ä»¥é’ˆå¯¹å¯¹è±¡çš„æŸä¸ªåŸŸï¼ˆFieldï¼‰è¿›è¡ŒåŸå­æ“ä½œï¼Œåªèƒ½é…åˆ volatile ä¿®é¥°çš„å­—æ®µä½¿ç”¨ï¼Œå¦åˆ™ä¼šå‡ºç° å¼‚å¸¸</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> field;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AtomicIntegerFieldUpdater</span> <span class="variable">fieldUpdater</span> <span class="operator">=</span></span><br><span class="line">            AtomicIntegerFieldUpdater.newUpdater(Test5.class, <span class="string">&quot;field&quot;</span>);</span><br><span class="line">        <span class="type">Test5</span> <span class="variable">test5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Test5</span>();</span><br><span class="line">        fieldUpdater.compareAndSet(test5, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">        <span class="comment">// ä¿®æ”¹æˆåŠŸ field = 10</span></span><br><span class="line">        System.out.println(test5.field);</span><br><span class="line">        <span class="comment">// ä¿®æ”¹æˆåŠŸ field = 20</span></span><br><span class="line">        fieldUpdater.compareAndSet(test5, <span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line">        System.out.println(test5.field);</span><br><span class="line">        <span class="comment">// ä¿®æ”¹å¤±è´¥ field = 20</span></span><br><span class="line">        fieldUpdater.compareAndSet(test5, <span class="number">10</span>, <span class="number">30</span>);</span><br><span class="line">        System.out.println(test5.field);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span> </span><br><span class="line"><span class="number">20</span> </span><br><span class="line"><span class="number">20</span> </span><br></pre></td></tr></table></figure><h2 id="6-åŸå­ç´¯åŠ å™¨">6. åŸå­ç´¯åŠ å™¨</h2><p><strong>åŸå­ç±»å‹ç´¯åŠ å™¨</strong>æ˜¯<strong>JDK1.8</strong>å¼•è¿›çš„å¹¶å‘æ–°æŠ€æœ¯ï¼Œå®ƒå¯ä»¥çœ‹åš<strong>AtomicLong</strong>å’Œ<strong>AtomicDouble</strong>çš„éƒ¨åˆ†åŠ å¼ºç±»å‹ã€‚</p><p><strong>åŸå­ç±»å‹ç´¯åŠ å™¨</strong>æœ‰å¦‚ä¸‹å››ç§ï¼š</p><ul><li>DoubleAccumulator</li><li>DoubleAdder</li><li>LongAccumulator</li><li>LongAdder</li></ul><p>æ ¹æ®Oracleå®˜æ–¹æ–‡æ¡£çš„ä»‹ç»ï¼ŒLongAdderåœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ä¼šæ¯”å®ƒçš„å‰è¾ˆâ€”AtomicLong å…·æœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œä»£ä»·æ˜¯æ¶ˆè€—æ›´å¤šçš„å†…å­˜ç©ºé—´</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œ<strong>AtomicLong</strong>æ˜¯åˆ©ç”¨äº†åº•å±‚çš„CASæ“ä½œæ¥æä¾›å¹¶å‘æ€§çš„ï¼Œæ¯”å¦‚<strong>addAndGet</strong>æ–¹æ³•ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/bVbeJG6.png" alt="clipboard.png"></p><p>ä¸Šè¿°æ–¹æ³•è°ƒç”¨äº†<strong>Unsafe</strong>ç±»çš„<strong>getAndAddLong</strong>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯ä¸ª<strong>native</strong>æ–¹æ³•ï¼Œå®ƒçš„é€»è¾‘æ˜¯é‡‡ç”¨è‡ªæ—‹çš„æ–¹å¼ä¸æ–­æ›´æ–°ç›®æ ‡å€¼ï¼Œç›´åˆ°æ›´æ–°æˆåŠŸã€‚</p><p>åœ¨å¹¶å‘é‡è¾ƒä½çš„ç¯å¢ƒä¸‹ï¼Œçº¿ç¨‹å†²çªçš„æ¦‚ç‡æ¯”è¾ƒå°ï¼Œè‡ªæ—‹çš„æ¬¡æ•°ä¸ä¼šå¾ˆå¤šã€‚ä½†æ˜¯ï¼Œé«˜å¹¶å‘ç¯å¢ƒä¸‹ï¼ŒNä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œè‡ªæ—‹æ“ä½œï¼Œä¼šå‡ºç°å¤§é‡å¤±è´¥å¹¶ä¸æ–­è‡ªæ—‹çš„æƒ…å†µï¼Œæ­¤æ—¶<strong>AtomicLong</strong>çš„è‡ªæ—‹ä¼šæˆä¸ºç“¶é¢ˆã€‚</p><p>è¿™å°±æ˜¯<strong>LongAdder</strong>å¼•å…¥çš„åˆè¡·â€”â€”è§£å†³é«˜å¹¶å‘ç¯å¢ƒä¸‹<strong>AtomicLong</strong>çš„è‡ªæ—‹ç“¶é¢ˆé—®é¢˜ã€‚</p><h3 id="6-1-ç´¯åŠ å™¨æ€§èƒ½æ¯”è¾ƒ">6.1 ç´¯åŠ å™¨æ€§èƒ½æ¯”è¾ƒ</h3><div class="tabs" id="89dc092d-f028-4c6e-9fed-f34e1e27d053"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#89dc092d-f028-4c6e-9fed-f34e1e27d053-1"><i class="fas fa-seedling"></i>å°è£…æ–¹æ³•</button></li><li class="tab"><button type="button" data-href="#89dc092d-f028-4c6e-9fed-f34e1e27d053-2"><i class="fas fa-leaf"></i>æ¯”è¾ƒ AtomicLong ä¸ LongAdder</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="89dc092d-f028-4c6e-9fed-f34e1e27d053-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">() -&gt; ç»“æœ    æä¾›ç´¯åŠ å™¨å¯¹è±¡</span></span><br><span class="line"><span class="comment">(å‚æ•°) -&gt;     æ‰§è¡Œç´¯åŠ æ“ä½œ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">demo</span><span class="params">(Supplier&lt;T&gt; adderSupplier, Consumer&lt;T&gt; action)</span> &#123;</span><br><span class="line">    <span class="type">T</span> <span class="variable">adder</span> <span class="operator">=</span> adderSupplier.get();</span><br><span class="line">    List&lt;Thread&gt; ts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 4 ä¸ªçº¿ç¨‹ï¼Œæ¯äººç´¯åŠ  50 ä¸‡</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        ts.add(<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">500000</span>; j++) &#123;</span><br><span class="line">                action.accept(adder);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">    ts.forEach(t -&gt; t.start());</span><br><span class="line">    ts.forEach(t -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            t.join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">    System.out.println(adder + <span class="string">&quot; cost:&quot;</span> + (end - start) / <span class="number">1000_000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="89dc092d-f028-4c6e-9fed-f34e1e27d053-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">    demo(() -&gt; <span class="keyword">new</span> <span class="title class_">LongAdder</span>(), adder -&gt; adder.increment());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">    demo(() -&gt; <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(), adder -&gt; adder.getAndIncrement());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2000000</span> cost:<span class="number">33</span></span><br><span class="line"><span class="number">2000000</span> cost:<span class="number">8</span></span><br><span class="line"><span class="number">2000000</span> cost:<span class="number">13</span></span><br><span class="line"><span class="number">2000000</span> cost:<span class="number">8</span></span><br><span class="line"><span class="number">2000000</span> cost:<span class="number">7</span></span><br><span class="line"><span class="number">2000000</span> cost:<span class="number">86</span></span><br><span class="line"><span class="number">2000000</span> cost:<span class="number">79</span></span><br><span class="line"><span class="number">2000000</span> cost:<span class="number">68</span></span><br><span class="line"><span class="number">2000000</span> cost:<span class="number">72</span></span><br><span class="line"><span class="number">2000000</span> cost:<span class="number">74</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>æˆ‘ä»¬çŸ¥é“ï¼Œ<strong>AtomicLong</strong>ä¸­æœ‰ä¸ªå†…éƒ¨å˜é‡<strong>value</strong>ä¿å­˜ç€å®é™…çš„longå€¼ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯é’ˆå¯¹è¯¥å˜é‡è¿›è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé«˜å¹¶å‘ç¯å¢ƒä¸‹ï¼Œvalueå˜é‡å…¶å®æ˜¯ä¸€ä¸ªçƒ­ç‚¹ï¼Œä¹Ÿå°±æ˜¯Nä¸ªçº¿ç¨‹ç«äº‰ä¸€ä¸ªçƒ­ç‚¹ã€‚</p><p><strong>LongAdder</strong>çš„åŸºæœ¬æ€è·¯å°±æ˜¯<strong>åˆ†æ•£çƒ­ç‚¹</strong>ï¼Œå°†valueå€¼åˆ†æ•£åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œä¸åŒçº¿ç¨‹ä¼šå‘½ä¸­åˆ°æ•°ç»„çš„ä¸åŒæ§½ä¸­ï¼Œå„ä¸ªçº¿ç¨‹åªå¯¹è‡ªå·±æ§½ä¸­çš„é‚£ä¸ªå€¼è¿›è¡ŒCASæ“ä½œï¼Œè¿™æ ·çƒ­ç‚¹å°±è¢«åˆ†æ•£äº†ï¼Œå†²çªçš„æ¦‚ç‡å°±å°å¾ˆå¤šã€‚å¦‚æœè¦è·å–çœŸæ­£çš„longå€¼ï¼Œåªè¦å°†å„ä¸ªæ§½ä¸­çš„å˜é‡å€¼ç´¯åŠ è¿”å›ã€‚éç«æ€æ¡ä»¶ä¸‹ï¼Œç›´æ¥ç´¯åŠ åˆ°Baseå˜é‡ä¸Šã€‚åœ¨æœ‰ç«äº‰æ—¶ï¼Œè®¾ç½®å¤šä¸ªç´¯åŠ å•å…ƒï¼ŒTherad-0 ç´¯åŠ  Cell[0]ï¼Œè€Œ Thread-1 ç´¯åŠ  Cell[1]â€¦ æœ€åå°†ç»“æœæ±‡æ€»ã€‚è¿™æ ·å®ƒä»¬åœ¨ç´¯åŠ æ—¶æ“ä½œçš„ä¸åŒçš„ Cell å˜é‡ï¼Œå› æ­¤å‡å°‘äº† CAS é‡è¯•å¤±è´¥ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚</p><h3 id="6-2-åŸç†ä¹‹ä¼ªå…±äº«-CPU-ç¼“å­˜ç»“æ„">6.2 åŸç†ä¹‹ä¼ªå…±äº«(CPU ç¼“å­˜ç»“æ„)</h3><h4 id="6-2-1-CPU-ç¼“å­˜ç»“æ„">6.2.1 CPU ç¼“å­˜ç»“æ„</h4><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317203911517.png" alt="image-20220317203911517" style="zoom: 50%;" /><p>é€Ÿåº¦æ¯”è¾ƒ</p><table><thead><tr><th style="text-align:center">ä»cpuåˆ°</th><th style="text-align:center">å¤§çº¦éœ€è¦çš„æ—¶é’Ÿå‘¨æœŸ</th></tr></thead><tbody><tr><td style="text-align:center">å¯„å­˜å™¨</td><td style="text-align:center">1 cycle</td></tr><tr><td style="text-align:center">L1</td><td style="text-align:center">3~4 cycle</td></tr><tr><td style="text-align:center">L2</td><td style="text-align:center">10~20 cycle</td></tr><tr><td style="text-align:center">L3</td><td style="text-align:center">40~45 cycle</td></tr><tr><td style="text-align:center">å†…å­˜</td><td style="text-align:center">120~240 cycle</td></tr></tbody></table><p>cpu æ‹¿åˆ°çš„å†…å­˜åœ°å€æ ¼å¼æ˜¯è¿™æ ·çš„</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[é«˜ä½ç»„æ ‡è®°][ä½ä½ç´¢å¼•][åç§»é‡]</span><br></pre></td></tr></table></figure><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317204208269.png" alt="image-20220317204208269"></p><h4 id="6-2-2-CPU-ç¼“å­˜è¯»">6.2.2 CPU ç¼“å­˜è¯»</h4><p>è¯»å–æ•°æ®æµç¨‹å¦‚ä¸‹</p><ul><li>æ ¹æ®ä½ä½ï¼Œè®¡ç®—åœ¨ç¼“å­˜ä¸­çš„ç´¢å¼•</li><li>åˆ¤æ–­æ˜¯å¦æœ‰æ•ˆ<ul><li>0 å»å†…å­˜è¯»å–æ–°æ•°æ®æ›´æ–°ç¼“å­˜è¡Œ</li><li>1 å†å¯¹æ¯”é«˜ä½ç»„æ ‡è®°æ˜¯å¦ä¸€è‡´<ul><li>ä¸€è‡´ï¼Œæ ¹æ®åç§»é‡è¿”å›ç¼“å­˜æ•°æ®</li><li>ä¸ä¸€è‡´ï¼Œå»å†…å­˜è¯»å–æ–°æ•°æ®æ›´æ–°ç¼“å­˜è¡Œ</li></ul></li></ul></li></ul><h4 id="6-2-3-MESI-åè®®">6.2.3 MESI åè®®</h4><p>å¯¹äºå•æ ¸CPUæ¥è¯´ï¼Œä¸å­˜åœ¨æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼›ç„¶è€Œå¯¹äºå¤šæ ¸ç³»ç»Ÿæ¥è¯´ï¼Œä¸åŒCPUä¸Šçš„cacheå’Œramå¯èƒ½å…·æœ‰åŒä¸€ä¸ªæ•°æ®çš„å¤šä¸ªå‰¯æœ¬ã€‚è¿™å°±ä¼šå¯¼è‡´æ•°æ®è§‚å¯Ÿè€…ï¼ˆCPU/GPU/DMAï¼‰èƒ½çœ‹åˆ°çš„æ•°æ®ä¸ä¸€è‡´ã€‚</p><p>MESIè¿™å››ä¸ªå­—æ¯åˆ†åˆ«ä»£è¡¨Modifyã€Exclusiveã€Sharedå’ŒInvalidã€‚Cache Lineçš„çŠ¶æ€å¿…é¡»æ˜¯è¿™å››ä¸ªä¸­çš„ä¸€ç§ã€‚å‰ä¸‰ç§çŠ¶æ€å‡æ˜¯æ•°æ®æœ‰æ•ˆä¸‹çš„çŠ¶æ€ã€‚Cache Lineæœ‰ä¸¤ä¸ªæ ‡å¿—-è„ï¼ˆdirtyï¼‰å’Œæœ‰æ•ˆï¼ˆvalid)ã€‚</p><table><thead><tr><th>çŠ¶æ€</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>M</td><td>æ•°æ®å·²è¢«ä¿®æ”¹ï¼Œå’Œå†…å­˜çš„æ•°æ®ä¸ä¸€è‡´ï¼Œè¯¥æ•°æ®åªå­˜åœ¨äºæ­¤Cache Lineä¸­</td></tr><tr><td>E</td><td>æ•°æ®å’Œå†…å­˜ä¸­ä¸€è‡´ï¼Œè¯¥æ•°æ®åªå­˜åœ¨äºæ­¤Cache Lineä¸­</td></tr><tr><td>S</td><td>æ•°æ®å’Œå†…å­˜ä¸­ä¸€è‡´ï¼Œå¤šä¸ªCache LineæŒæœ‰è¿™è¡Œæ•°æ®çš„å‰¯æœ¬</td></tr><tr><td>I</td><td>è¿™è¡Œæ•°æ®æ— æ•ˆ</td></tr></tbody></table><ol><li>Eã€Sã€M çŠ¶æ€çš„ç¼“å­˜è¡Œéƒ½å¯ä»¥æ»¡è¶³ CPU çš„è¯»è¯·æ±‚</li><li>E çŠ¶æ€çš„ç¼“å­˜è¡Œï¼Œæœ‰å†™è¯·æ±‚ï¼Œä¼šå°†çŠ¶æ€æ”¹ä¸º Mï¼Œè¿™æ—¶å¹¶ä¸è§¦å‘å‘ä¸»å­˜çš„å†™</li><li>E çŠ¶æ€çš„ç¼“å­˜è¡Œï¼Œå¿…é¡»ç›‘å¬è¯¥ç¼“å­˜è¡Œçš„è¯»æ“ä½œï¼Œå¦‚æœæœ‰ï¼Œè¦å˜ä¸º S çŠ¶æ€</li></ol><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317204411550.png" alt="image-20220317204411550"></p><ol start="4"><li>M çŠ¶æ€çš„ç¼“å­˜è¡Œï¼Œå¿…é¡»ç›‘å¬è¯¥ç¼“å­˜è¡Œçš„è¯»æ“ä½œï¼Œå¦‚æœæœ‰ï¼Œå…ˆå°†å…¶å®ƒç¼“å­˜ï¼ˆS çŠ¶æ€ï¼‰ä¸­è¯¥ç¼“å­˜è¡Œå˜æˆ I çŠ¶æ€ï¼ˆå³ 6. çš„æµç¨‹ï¼‰ï¼Œå†™å…¥ä¸»å­˜ï¼Œè‡ªå·±å˜ä¸º S çŠ¶æ€</li><li>S çŠ¶æ€çš„ç¼“å­˜è¡Œï¼Œæœ‰å†™è¯·æ±‚ï¼Œèµ° 4. çš„æµç¨‹</li><li>S çŠ¶æ€çš„ç¼“å­˜è¡Œï¼Œå¿…é¡»ç›‘å¬è¯¥ç¼“å­˜è¡Œçš„å¤±æ•ˆæ“ä½œï¼Œå¦‚æœæœ‰ï¼Œè‡ªå·±å˜ä¸º I çŠ¶æ€</li><li>I çŠ¶æ€çš„ç¼“å­˜è¡Œï¼Œæœ‰è¯»è¯·æ±‚ï¼Œå¿…é¡»ä»ä¸»å­˜è¯»å–</li></ol><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317204507325.png" alt="image-20220317204507325"></p><h4 id="6-2-4-å†…å­˜å±éšœ">6.2.4 å†…å­˜å±éšœ</h4><p>Memory Barrierï¼ˆMemory Fenceï¼‰</p><p>å¯è§æ€§</p><ul><li>å†™å±éšœï¼ˆsfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹å‰çš„ï¼Œå¯¹å…±äº«å˜é‡çš„æ”¹åŠ¨ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­</li><li>è€Œè¯»å±éšœï¼ˆlfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹åï¼Œå¯¹å…±äº«å˜é‡çš„è¯»å–ï¼ŒåŠ è½½çš„æ˜¯ä¸»å­˜ä¸­æœ€æ–°æ•°æ®</li></ul><p>æœ‰åºæ€§</p><ul><li>å†™å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†å†™å±éšœä¹‹å‰çš„ä»£ç æ’åœ¨å†™å±éšœä¹‹å</li><li>è¯»å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†è¯»å±éšœä¹‹åçš„ä»£ç æ’åœ¨è¯»å±éšœä¹‹å‰</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317204610541.png" alt="image-20220317204610541"></p><h3 id="6-3-æºç ä¹‹LongAdder">6.3 æºç ä¹‹LongAdder</h3><p>LongAdder æ˜¯å¹¶å‘å¤§å¸ˆ @author Doug Lea ï¼ˆå¤§å“¥æï¼‰çš„ä½œå“ï¼Œè®¾è®¡çš„éå¸¸ç²¾å·§</p><p>LongAdder ç±»æœ‰å‡ ä¸ªå…³é”®åŸŸ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç´¯åŠ å•å…ƒæ•°ç»„, æ‡’æƒ°åˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Cell[] cells;</span><br><span class="line"><span class="comment">// åŸºç¡€å€¼, å¦‚æœæ²¡æœ‰ç«äº‰, åˆ™ç”¨ cas ç´¯åŠ è¿™ä¸ªåŸŸ</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">long</span> base;</span><br><span class="line"><span class="comment">// åœ¨ cells åˆ›å»ºæˆ–æ‰©å®¹æ—¶, ç½®ä¸º 1, è¡¨ç¤ºåŠ é”</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">int</span> cellsBusy;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ Cell å³ä¸ºç´¯åŠ å•å…ƒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é˜²æ­¢ç¼“å­˜è¡Œä¼ªå…±äº«</span></span><br><span class="line"><span class="meta">@sun</span>.misc.Contended</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Cell</span> &#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">long</span> value;</span><br><span class="line">    Cell(<span class="type">long</span> x) &#123; value = x; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€é‡è¦çš„æ–¹æ³•, ç”¨æ¥ cas æ–¹å¼è¿›è¡Œç´¯åŠ , prev è¡¨ç¤ºæ—§å€¼, next è¡¨ç¤ºæ–°å€¼</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">cas</span><span class="params">(<span class="type">long</span> prev, <span class="type">long</span> next)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> UNSAFE.compareAndSwapLong(<span class="built_in">this</span>, valueOffset, prev, next);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// çœç•¥ä¸é‡è¦ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾—ä»ç¼“å­˜è¯´èµ·  å› ä¸º CPU ä¸ å†…å­˜çš„é€Ÿåº¦å·®å¼‚å¾ˆå¤§ï¼Œéœ€è¦é é¢„è¯»æ•°æ®è‡³ç¼“å­˜æ¥æå‡æ•ˆç‡ã€‚</p><p>è€Œç¼“å­˜ä»¥ç¼“å­˜è¡Œä¸ºå•ä½ï¼Œæ¯ä¸ªç¼“å­˜è¡Œå¯¹åº”ç€ä¸€å—å†…å­˜ï¼Œä¸€èˆ¬æ˜¯ 64 byteï¼ˆ8 ä¸ª longï¼‰</p><p>ç¼“å­˜çš„åŠ å…¥ä¼šé€ æˆæ•°æ®å‰¯æœ¬çš„äº§ç”Ÿï¼Œå³åŒä¸€ä»½æ•°æ®ä¼šç¼“å­˜åœ¨ä¸åŒæ ¸å¿ƒçš„ç¼“å­˜è¡Œä¸­</p><p>CPU è¦ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå¦‚æœæŸä¸ª CPU æ ¸å¿ƒæ›´æ”¹äº†æ•°æ®ï¼Œå…¶å®ƒ CPU æ ¸å¿ƒå¯¹åº”çš„æ•´ä¸ªç¼“å­˜è¡Œå¿…é¡»å¤±æ•ˆ</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317205206297.png" alt="image-20220317205206297" style="zoom:67%;" /><p>å› ä¸º Cell æ˜¯æ•°ç»„å½¢å¼ï¼Œåœ¨å†…å­˜ä¸­æ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œä¸€ä¸ª Cell ä¸º 24 å­—èŠ‚ï¼ˆ16 å­—èŠ‚çš„å¯¹è±¡å¤´å’Œ 8 å­—èŠ‚çš„ valueï¼‰ï¼Œå›  æ­¤ç¼“å­˜è¡Œå¯ä»¥å­˜ä¸‹ 2 ä¸ªçš„ Cell å¯¹è±¡ã€‚è¿™æ ·é—®é¢˜æ¥äº†ï¼š</p><ul><li>Core-0 è¦ä¿®æ”¹ Cell[0]</li><li>Core-1 è¦ä¿®æ”¹ Cell[1]</li></ul><p>æ— è®ºè°ä¿®æ”¹æˆåŠŸï¼Œéƒ½ä¼šå¯¼è‡´å¯¹æ–¹ Core çš„ç¼“å­˜è¡Œå¤±æ•ˆï¼Œæ¯”å¦‚Core-0 ä¸­<code>Cell[0]=6000, Cell[1]=8000</code>è¦ç´¯åŠ <code>Cell[0]=6001, Cell[1]=8000</code> ï¼Œè¿™æ—¶ä¼šè®© Core-1 çš„ç¼“å­˜è¡Œå¤±æ•ˆ</p><p>@sun.misc.Contended ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒçš„åŸç†æ˜¯åœ¨ä½¿ç”¨æ­¤æ³¨è§£çš„å¯¹è±¡æˆ–å­—æ®µçš„å‰åå„å¢åŠ  128 å­—èŠ‚å¤§å°çš„ paddingï¼Œä»è€Œè®© CPU å°†å¯¹è±¡é¢„è¯»è‡³ç¼“å­˜æ—¶å ç”¨ä¸åŒçš„ç¼“å­˜è¡Œï¼Œè¿™æ ·ï¼Œä¸ä¼šé€ æˆå¯¹æ–¹ç¼“å­˜è¡Œçš„å¤±æ•ˆ</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317205321951.png" alt="image-20220317205321951" style="zoom:67%;" /><p>ç´¯åŠ ä¸»è¦è°ƒç”¨ä¸‹é¢çš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="type">long</span> x)</span> &#123;</span><br><span class="line">    <span class="comment">// as ä¸ºç´¯åŠ å•å…ƒæ•°ç»„</span></span><br><span class="line">    <span class="comment">// b ä¸ºåŸºç¡€å€¼</span></span><br><span class="line">    <span class="comment">// x ä¸ºç´¯åŠ å€¼</span></span><br><span class="line">    Cell[] as; <span class="type">long</span> b, v; <span class="type">int</span> m; Cell a;</span><br><span class="line">    <span class="comment">// è¿›å…¥ if çš„ä¸¤ä¸ªæ¡ä»¶</span></span><br><span class="line">    <span class="comment">// 1. as æœ‰å€¼, è¡¨ç¤ºå·²ç»å‘ç”Ÿè¿‡ç«äº‰, è¿›å…¥ if</span></span><br><span class="line">    <span class="comment">// 2. cas ç»™ base ç´¯åŠ æ—¶å¤±è´¥äº†, è¡¨ç¤º base å‘ç”Ÿäº†ç«äº‰, è¿›å…¥ if</span></span><br><span class="line">    <span class="keyword">if</span> ((as = cells) != <span class="literal">null</span> || !casBase(b = base, b + x)) &#123;</span><br><span class="line">        <span class="comment">// uncontended è¡¨ç¤º cell æ²¡æœ‰ç«äº‰</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">uncontended</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            <span class="comment">// as è¿˜æ²¡æœ‰åˆ›å»º</span></span><br><span class="line">            as == <span class="literal">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">            <span class="comment">// å½“å‰çº¿ç¨‹å¯¹åº”çš„ cell è¿˜æ²¡æœ‰</span></span><br><span class="line">            <span class="comment">// getProbe()æ–¹æ³•è¿”å›çš„æ˜¯çº¿ç¨‹ä¸­çš„threadLocalRandomProbeå­—æ®µ</span></span><br><span class="line">            <span class="comment">// å®ƒæ˜¯é€šè¿‡éšæœºæ•°ç”Ÿæˆçš„ä¸€ä¸ªå€¼ï¼Œå¯¹äºä¸€ä¸ªç¡®å®šçš„çº¿ç¨‹è¿™ä¸ªå€¼æ˜¯å›ºå®šçš„</span></span><br><span class="line">            <span class="comment">// é™¤éåˆ»æ„ä¿®æ”¹å®ƒ</span></span><br><span class="line">            (a = as[getProbe() &amp; m]) == <span class="literal">null</span> ||</span><br><span class="line">            <span class="comment">// cas ç»™å½“å‰çº¿ç¨‹çš„ cell ç´¯åŠ å¤±è´¥ uncontended=false ( a ä¸ºå½“å‰çº¿ç¨‹çš„ cell )</span></span><br><span class="line">            !(uncontended = a.cas(v = a.value, v + x))</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// è¿›å…¥ cell æ•°ç»„åˆ›å»ºã€cell åˆ›å»ºçš„æµç¨‹</span></span><br><span class="line">            longAccumulate(x, <span class="literal">null</span>, uncontended);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ ï¼š</p><ul><li>å¦‚æœå·²ç»<code>æœ‰äº†ç´¯åŠ æ•°ç»„</code>æˆ–<code>ç»™baseç´¯åŠ å‘ç”Ÿäº†ç«äº‰å¯¼è‡´å¤±è´¥</code><ul><li>å¦‚æœ<code>ç´¯åŠ æ•°ç»„æ²¡æœ‰åˆ›å»º</code>æˆ–è€…<code>ç´¯åŠ æ•°ç»„é•¿åº¦ä¸º1</code>æˆ–è€…<code>å½“å‰çº¿ç¨‹è¿˜æ²¡æœ‰å¯¹åº”çš„cell</code>æˆ–è€…<code>ç´¯åŠ cellå¤±è´¥</code><ul><li>è¿›å…¥ç´¯åŠ æ•°ç»„çš„åˆ›å»ºæµç¨‹</li></ul></li><li>å¦è€…è¯´æ˜ç´¯åŠ æˆåŠŸï¼Œé€€å‡ºã€‚</li></ul></li><li>å¦åˆ™ç´¯åŠ æˆåŠŸ</li></ul><p>add æµç¨‹å›¾</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317205409166.png" alt="image-20220317205409166"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">longAccumulate</span><span class="params">(<span class="type">long</span> x, LongBinaryOperator fn,</span></span><br><span class="line"><span class="params">                          <span class="type">boolean</span> wasUncontended)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="comment">// å½“å‰çº¿ç¨‹è¿˜æ²¡æœ‰å¯¹åº”çš„ cell, éœ€è¦éšæœºç”Ÿæˆä¸€ä¸ª h å€¼ç”¨æ¥å°†å½“å‰çº¿ç¨‹ç»‘å®šåˆ° cell</span></span><br><span class="line">    <span class="keyword">if</span> ((h = getProbe()) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ– probe</span></span><br><span class="line">        ThreadLocalRandom.current();</span><br><span class="line">        <span class="comment">// h å¯¹åº”æ–°çš„ probe å€¼, ç”¨æ¥å¯¹åº” cell</span></span><br><span class="line">        h = getProbe();</span><br><span class="line">        wasUncontended = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// collide ä¸º true è¡¨ç¤ºæœ€åä¸€ä¸ªæ§½éç©ºï¼Œéœ€è¦æ‰©å®¹</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">collide</span> <span class="operator">=</span> <span class="literal">false</span>; </span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Cell[] as; Cell a; <span class="type">int</span> n; <span class="type">long</span> v;</span><br><span class="line">        <span class="comment">// å·²ç»æœ‰äº† cells</span></span><br><span class="line">        <span class="keyword">if</span> ((as = cells) != <span class="literal">null</span> &amp;&amp; (n = as.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// è¿˜æ²¡æœ‰ cell</span></span><br><span class="line">            <span class="keyword">if</span> ((a = as[(n - <span class="number">1</span>) &amp; h]) == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// ä¸º cellsBusy åŠ é”, åˆ›å»º cell, cell çš„åˆå§‹ç´¯åŠ å€¼ä¸º x</span></span><br><span class="line">                <span class="comment">// æˆåŠŸåˆ™ break, å¦åˆ™ç»§ç»­ continue å¾ªç¯</span></span><br><span class="line">                <span class="keyword">if</span> (cellsBusy == <span class="number">0</span>) &#123;       <span class="comment">// Try to attach new Cell</span></span><br><span class="line">                    <span class="type">Cell</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cell</span>(x);   <span class="comment">// Optimistically create</span></span><br><span class="line">                    <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">created</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;               <span class="comment">// Recheck under lock</span></span><br><span class="line">                            Cell[] rs; <span class="type">int</span> m, j;</span><br><span class="line">                            <span class="keyword">if</span> ((rs = cells) != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                                (m = rs.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                rs[j = (m - <span class="number">1</span>) &amp; h] == <span class="literal">null</span>) &#123;</span><br><span class="line">                                rs[j] = r;</span><br><span class="line">                                created = <span class="literal">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            cellsBusy = <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (created)</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">continue</span>;           <span class="comment">// Slot is now non-empty</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æœ‰ç«äº‰, æ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell æ¥é‡è¯• cas</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!wasUncontended)</span><br><span class="line">                wasUncontended = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// cas å°è¯•ç´¯åŠ , fn é…åˆ LongAccumulator ä¸ä¸º null, é…åˆ LongAdder ä¸º null</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (a.cas(v = a.value, ((fn == <span class="literal">null</span>) ? v + x : fn.applyAsLong(v, x))))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// å¦‚æœ cells é•¿åº¦å·²ç»è¶…è¿‡äº†æœ€å¤§é•¿åº¦, æˆ–è€…å·²ç»æ‰©å®¹, æ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell æ¥é‡è¯• cas</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (n &gt;= NCPU || cells != as)</span><br><span class="line">                collide = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// ç¡®ä¿ collide ä¸º false è¿›å…¥æ­¤åˆ†æ”¯, å°±ä¸ä¼šè¿›å…¥ä¸‹é¢çš„ else if è¿›è¡Œæ‰©å®¹äº†</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!collide)</span><br><span class="line">                collide = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// åŠ é”</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                <span class="comment">// åŠ é”æˆåŠŸ, æ‰©å®¹</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell</span></span><br><span class="line">            h = advanceProbe(h);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¿˜æ²¡æœ‰ cells, å°è¯•ç»™ cellsBusy åŠ é”</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; cells == as &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">            <span class="comment">// åŠ é”æˆåŠŸ, åˆå§‹åŒ– cells, æœ€å¼€å§‹é•¿åº¦ä¸º 2, å¹¶å¡«å……ä¸€ä¸ª cell</span></span><br><span class="line">            <span class="comment">// æˆåŠŸåˆ™ break;</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">init</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;                           <span class="comment">// Initialize table</span></span><br><span class="line">                <span class="keyword">if</span> (cells == as) &#123;</span><br><span class="line">                    Cell[] rs = <span class="keyword">new</span> <span class="title class_">Cell</span>[<span class="number">2</span>];</span><br><span class="line">                    rs[h &amp; <span class="number">1</span>] = <span class="keyword">new</span> <span class="title class_">Cell</span>(x);</span><br><span class="line">                    cells = rs;</span><br><span class="line">                    init = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                cellsBusy = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (init)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¸Šä¸¤ç§æƒ…å†µå¤±è´¥, å°è¯•ç»™ base ç´¯åŠ </span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (casBase(v = base, ((fn == <span class="literal">null</span>) ? v + x : fn.applyAsLong(v, x))))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ€»ç»“ï¼š</p><ul><li><p>å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æœ‰æ²¡æœ‰å¯¹åº”çš„Cell</p><ul><li>å¦‚æœæ²¡æœ‰ï¼Œéšæœºç”Ÿæˆä¸€ä¸ªå€¼ï¼Œè¿™ä¸ªå€¼ä¸å½“å‰çº¿ç¨‹ç»‘å®šï¼Œé€šè¿‡è¿™ä¸ªå€¼çš„å–æ¨¡è¿ç®—å®šä½å½“å‰çº¿ç¨‹Cellçš„ä½ç½®ã€‚</li></ul></li><li><p>è¿›å…¥forå¾ªç¯</p><ul><li><p>if æœ‰Cellsç´¯åŠ æ•°ç»„ä¸”é•¿åº¦å¤§äº0</p><ul><li><p>if å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰cell</p><ul><li>å‡†å¤‡æ‰©å®¹ï¼Œå¦‚æœå‰ç´¯åŠ æ•°ç»„ä¸ç¹å¿™ï¼ˆæ­£åœ¨æ‰©å®¹ä¹‹ç±»ï¼‰<ul><li>å°†æ–°å»ºçš„cellæ”¾å…¥å¯¹åº”çš„æ§½ä½ä¸­ï¼Œæ–°å»ºCellæˆåŠŸï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œå°è¯•casç´¯åŠ ã€‚</li></ul></li><li>å°†collideç½®ä¸ºfalseï¼Œè¡¨ç¤ºæ— éœ€æ‰©å®¹ã€‚</li></ul></li><li><p>else if æœ‰ç«äº‰</p><ul><li>å°†wasUncontendedç½®ä¸ºtueï¼Œè¿›å…¥åˆ†æ”¯åº•éƒ¨ï¼Œæ”¹å˜çº¿ç¨‹å¯¹åº”çš„cellæ¥casé‡è¯•</li></ul></li><li><p>else if casé‡è¯•ç´¯åŠ æˆåŠŸ</p><ul><li>é€€å‡ºå¾ªç¯ã€‚</li></ul></li><li><p>else if  cells é•¿åº¦å·²ç»è¶…è¿‡äº†æœ€å¤§é•¿åº¦, æˆ–è€…å·²ç»æ‰©å®¹,</p><ul><li>collideç½®ä¸ºfalseï¼Œè¿›å…¥åˆ†æ”¯åº•éƒ¨ï¼Œæ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell æ¥é‡è¯• cas</li></ul></li><li><p>else if collideä¸ºfalse</p><ul><li>å°†collideç½®ä¸ºtrueï¼ˆç¡®ä¿ collide ä¸º false è¿›å…¥æ­¤åˆ†æ”¯, å°±ä¸ä¼šè¿›å…¥ä¸‹é¢çš„ else if è¿›è¡Œæ‰©å®¹äº†ï¼‰</li></ul></li><li><p>else if ç´¯åŠ æ•°ç»„ä¸ç¹å¿™ä¸”åŠ é”æˆåŠŸ</p><ul><li>é€€å‡ºæœ¬æ¬¡å¾ªç¯ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼ˆæ‰©å®¹ï¼‰</li></ul></li><li><p>æ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell æ¥é‡è¯• cas</p></li></ul></li><li><p>else if æ•°ç»„ä¸ç¹å¿™ä¸”æ•°ç»„ä¸ºnullä¸”åŠ é”æˆåŠŸ</p><ul><li>æ–°å»ºæ•°ç»„ï¼Œåœ¨æ§½ä½å¤„æ–°å»ºcellï¼Œé‡Šæ”¾é”ï¼Œé€€å‡ºå¾ªç¯ã€‚</li></ul></li><li><p>else if å°è¯•ç»™baseç´¯åŠ æˆåŠŸ</p><ul><li>é€€å‡ºå¾ªç¯</li></ul></li></ul></li></ul><p>longAccumulate æµç¨‹å›¾</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317205457078.png" alt="image-20220317205457078"></p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317205515695.png" alt="image-20220317205515695"></p><p>æ¯ä¸ªçº¿ç¨‹åˆšè¿›å…¥ longAccumulate æ—¶ï¼Œä¼šå°è¯•å¯¹åº”ä¸€ä¸ª cell å¯¹è±¡ï¼ˆæ‰¾åˆ°ä¸€ä¸ªå‘ä½ï¼‰</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317205530752.png" alt="image-20220317205530752"></p><p>è·å–æœ€ç»ˆç»“æœé€šè¿‡ sum æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">sum</span><span class="params">()</span> &#123;</span><br><span class="line">    Cell[] as = cells; Cell a;</span><br><span class="line">    <span class="type">long</span> <span class="variable">sum</span> <span class="operator">=</span> base;</span><br><span class="line">    <span class="keyword">if</span> (as != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="literal">null</span>)</span><br><span class="line">                sum += a.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-Unsafe">7. Unsafe</h2><h3 id="7-1-æ¦‚è¿°">7.1 æ¦‚è¿°</h3><p>Unsafe å¯¹è±¡æä¾›äº†éå¸¸åº•å±‚çš„ï¼Œæ“ä½œå†…å­˜ã€çº¿ç¨‹çš„æ–¹æ³•ï¼ŒUnsafeç±»æ˜¯&quot;final&quot;çš„ï¼Œä¸å…è®¸ç»§æ‰¿ï¼Œä¸”æ„é€ å‡½æ•°æ˜¯privateçš„ï¼Œåªèƒ½é€šè¿‡åå°„è·å¾—ã€‚</p><p>Unsafeçš„åŠŸèƒ½å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/webp" alt="img"></p><p>Unsafeç±»çš„è·å–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnsafeAccessor</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> Unsafe unsafe;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123; </span><br><span class="line">            <span class="type">Field</span> <span class="variable">theUnsafe</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">            theUnsafe.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            unsafe = (Unsafe) theUnsafe.get(<span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> Unsafe <span class="title function_">getUnsafe</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-2-Unsafe-CAS-æ“ä½œ">7.2 Unsafe CAS æ“ä½œ</h3><div class="tabs" id="bb235cdf-d14b-4b3f-a34a-6eeafc5bac34"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#bb235cdf-d14b-4b3f-a34a-6eeafc5bac34-1"><i class="fas fa-cat"></i>unsafeå®ç°å­—æ®µæ›´æ–°</button></li><li class="tab"><button type="button" data-href="#bb235cdf-d14b-4b3f-a34a-6eeafc5bac34-2"><i class="fas fa-horse"></i>unsafeå®ç°åŸå­æ•´æ•°ç±»</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="bb235cdf-d14b-4b3f-a34a-6eeafc5bac34-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">volatile</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> UnsafeAccessor.getUnsafe();</span><br><span class="line"><span class="type">Field</span> <span class="variable">id</span> <span class="operator">=</span> Student.class.getDeclaredField(<span class="string">&quot;id&quot;</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> Student.class.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"><span class="comment">// è·å¾—æˆå‘˜å˜é‡çš„åç§»é‡</span></span><br><span class="line"><span class="type">long</span> <span class="variable">idOffset</span> <span class="operator">=</span> UnsafeAccessor.unsafe.objectFieldOffset(id);</span><br><span class="line"><span class="type">long</span> <span class="variable">nameOffset</span> <span class="operator">=</span> UnsafeAccessor.unsafe.objectFieldOffset(name);</span><br><span class="line"><span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line"><span class="comment">// ä½¿ç”¨ cas æ–¹æ³•æ›¿æ¢æˆå‘˜å˜é‡çš„å€¼</span></span><br><span class="line">UnsafeAccessor.unsafe.compareAndSwapInt(student, idOffset, <span class="number">0</span>, <span class="number">20</span>); <span class="comment">// è¿”å› true</span></span><br><span class="line">UnsafeAccessor.unsafe.compareAndSwapObject(student, nameOffset, <span class="literal">null</span>, <span class="string">&quot;å¼ ä¸‰&quot;</span>); <span class="comment">// è¿”å› true</span></span><br><span class="line">System.out.println(student);</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Student(<span class="built_in">id</span>=20, name=å¼ ä¸‰) </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="bb235cdf-d14b-4b3f-a34a-6eeafc5bac34-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AtomicData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> data;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Unsafe unsafe;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> DATA_OFFSET;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        unsafe = UnsafeAccessor.getUnsafe();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// data å±æ€§åœ¨ DataContainer å¯¹è±¡ä¸­çš„åç§»é‡ï¼Œç”¨äº Unsafe ç›´æ¥è®¿é—®è¯¥å±æ€§</span></span><br><span class="line">            DATA_OFFSET = unsafe.objectFieldOffset(AtomicData.class.getDeclaredField(<span class="string">&quot;data&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AtomicData</span><span class="params">(<span class="type">int</span> data)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decrease</span><span class="params">(<span class="type">int</span> amount)</span> &#123;</span><br><span class="line">        <span class="type">int</span> oldValue;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// è·å–å…±äº«å˜é‡æ—§å€¼ï¼Œå¯ä»¥åœ¨è¿™ä¸€è¡ŒåŠ å…¥æ–­ç‚¹ï¼Œä¿®æ”¹ data è°ƒè¯•æ¥åŠ æ·±ç†è§£</span></span><br><span class="line">            oldValue = data;</span><br><span class="line">            <span class="comment">// cas å°è¯•ä¿®æ”¹ data ä¸º æ—§å€¼ + amountï¼Œå¦‚æœæœŸé—´æ—§å€¼è¢«åˆ«çš„çº¿ç¨‹æ”¹äº†ï¼Œè¿”å› false</span></span><br><span class="line">            <span class="keyword">if</span> (unsafe.compareAndSwapInt(<span class="built_in">this</span>, DATA_OFFSET, oldValue, oldValue - amount)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>]]></content>
    
    
    <summary type="html">CASä¸volatileã€åŸå­æ•´æ•°ã€åŸå­å¼•ç”¨ã€åŸå­ç´¯åŠ å™¨Unsafe</summary>
    
    
    
    <category term="Java" scheme="https://luckylittleboy.gitee.io/categories/Java/"/>
    
    
    <category term="JUC" scheme="https://luckylittleboy.gitee.io/tags/JUC/"/>
    
  </entry>
  
  <entry>
    <title>4.å…±äº«æ¨¡å‹ä¹‹å†…å­˜</title>
    <link href="https://luckylittleboy.gitee.io/posts/20410f72.html"/>
    <id>https://luckylittleboy.gitee.io/posts/20410f72.html</id>
    <published>2023-04-01T04:56:08.000Z</published>
    <updated>2023-04-01T09:31:16.495Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-Java-å†…å­˜æ¨¡å‹">1. Java å†…å­˜æ¨¡å‹</h2><p>JMM å³ Java Memory Modelï¼Œå®ƒå®šä¹‰äº†ä¸»å­˜ã€å·¥ä½œå†…å­˜æŠ½è±¡æ¦‚å¿µï¼Œåº•å±‚å¯¹åº”ç€ CPU å¯„å­˜å™¨ã€ç¼“å­˜ã€ç¡¬ä»¶å†…å­˜ã€ CPU æŒ‡ä»¤ä¼˜åŒ–ç­‰ã€‚</p><p>JMMçš„æ„ä¹‰</p><ul><li>è®¡ç®—æœºç¡¬ä»¶åº•å±‚çš„å†…å­˜ç»“æ„è¿‡äºå¤æ‚ï¼ŒJMMçš„æ„ä¹‰åœ¨äºé¿å…ç¨‹åºå‘˜ç›´æ¥ç®¡ç†è®¡ç®—æœºåº•å±‚å†…å­˜ï¼Œç”¨ä¸€äº›å…³é”®å­—synchronizedã€volatileç­‰å¯ä»¥æ–¹ä¾¿çš„ç®¡ç†å†…å­˜ã€‚</li></ul><p>JMM ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢</p><ul><li>åŸå­æ€§ - ä¿è¯æŒ‡ä»¤ä¸ä¼šå—åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å½±å“</li><li>å¯è§æ€§ - ä¿è¯æŒ‡ä»¤ä¸ä¼šå— cpu ç¼“å­˜çš„å½±å“</li><li>æœ‰åºæ€§ - ä¿è¯æŒ‡ä»¤ä¸ä¼šå— cpu æŒ‡ä»¤å¹¶è¡Œä¼˜åŒ–çš„å½±å“</li></ul><h2 id="2-å¯è§æ€§">2. å¯è§æ€§</h2><h3 id="2-1-é€€ä¸å‡ºçš„å¾ªç¯">2.1 é€€ä¸å‡ºçš„å¾ªç¯</h3><p>å…ˆæ¥çœ‹ä¸€ä¸ªç°è±¡ï¼Œmain çº¿ç¨‹å¯¹ run å˜é‡çš„ä¿®æ”¹å¯¹äº t çº¿ç¨‹ä¸å¯è§ï¼Œå¯¼è‡´äº† t çº¿ç¨‹æ— æ³•åœæ­¢ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">run</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">while</span>(run)&#123;</span><br><span class="line">            <span class="comment">// ....</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    t.start();</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    run = <span class="literal">false</span>; <span class="comment">// çº¿ç¨‹tä¸ä¼šå¦‚é¢„æƒ³çš„åœä¸‹æ¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆå‘¢ï¼Ÿåˆ†æä¸€ä¸‹ï¼š</p><div class="tabs" id="79f5f556-04c6-4010-a9d2-774abb2d9f58"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#79f5f556-04c6-4010-a9d2-774abb2d9f58-1"><i class="fas fa-atom"></i>1</button></li><li class="tab"><button type="button" data-href="#79f5f556-04c6-4010-a9d2-774abb2d9f58-2"><i class="far fa-sun"></i>2</button></li><li class="tab"><button type="button" data-href="#79f5f556-04c6-4010-a9d2-774abb2d9f58-3"><i class="fas fa-wind"></i>3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="79f5f556-04c6-4010-a9d2-774abb2d9f58-1"><ol><li>åˆå§‹çŠ¶æ€ï¼Œ t çº¿ç¨‹åˆšå¼€å§‹ä»ä¸»å†…å­˜è¯»å–äº† run çš„å€¼åˆ°å·¥ä½œå†…å­˜ã€‚</li></ol><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220305192346249.png" alt="image-20220305192346249" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="79f5f556-04c6-4010-a9d2-774abb2d9f58-2"><ol start="2"><li>å› ä¸º t çº¿ç¨‹è¦é¢‘ç¹ä»ä¸»å†…å­˜ä¸­è¯»å– run çš„å€¼ï¼ŒJIT ç¼–è¯‘å™¨ä¼šå°† run çš„å€¼ç¼“å­˜è‡³è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œ å‡å°‘å¯¹ä¸»å­˜ä¸­ run çš„è®¿é—®ï¼Œæé«˜æ•ˆç‡</li></ol><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220305192416102.png" alt="image-20220305192416102" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="79f5f556-04c6-4010-a9d2-774abb2d9f58-3"><ol start="3"><li>1 ç§’ä¹‹åï¼Œmain çº¿ç¨‹ä¿®æ”¹äº† run çš„å€¼ï¼Œå¹¶åŒæ­¥è‡³ä¸»å­˜ï¼Œè€Œ t æ˜¯ä»è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­è¯»å–è¿™ä¸ªå˜é‡ çš„å€¼ï¼Œç»“æœæ°¸è¿œæ˜¯æ—§å€¼</li></ol><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220305192512523.png" alt="image-20220305192512523" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <blockquote><p>è§£å†³æ–¹æ³•</p><p>volatileï¼ˆæ˜“å˜å…³é”®å­—ï¼‰</p><p>å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡ï¼Œä»–å¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å–å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œ volatile å˜é‡éƒ½æ˜¯ç›´æ¥æ“ä½œä¸»å­˜</p></blockquote><h3 id="2-2-å¯è§æ€§-vs-åŸå­æ€§">2.2 å¯è§æ€§ vs åŸå­æ€§</h3><p>å‰é¢ä¾‹å­ä½“ç°çš„å®é™…å°±æ˜¯å¯è§æ€§ï¼Œå®ƒä¿è¯çš„æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹ volatile å˜é‡çš„ä¿®æ”¹å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ï¼Œä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œ<code>ä»…ç”¨åœ¨ä¸€ä¸ªå†™çº¿ç¨‹ï¼Œå¤šä¸ªè¯»çº¿ç¨‹</code>çš„æƒ…å†µï¼š ä¸Šä¾‹ä»å­—èŠ‚ç ç†è§£æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">getstatic run <span class="comment">// çº¿ç¨‹ t è·å– run true </span></span><br><span class="line">getstatic run <span class="comment">// çº¿ç¨‹ t è·å– run true </span></span><br><span class="line">getstatic run <span class="comment">// çº¿ç¨‹ t è·å– run true </span></span><br><span class="line">getstatic run <span class="comment">// çº¿ç¨‹ t è·å– run true </span></span><br><span class="line">putstatic run <span class="comment">// çº¿ç¨‹ main ä¿®æ”¹ run ä¸º falseï¼Œ ä»…æ­¤ä¸€æ¬¡</span></span><br><span class="line">getstatic run <span class="comment">// çº¿ç¨‹ t è·å– run false </span></span><br></pre></td></tr></table></figure><p>æ¯”è¾ƒä¸€ä¸‹ä¹‹å‰æˆ‘ä»¬å°†çº¿ç¨‹å®‰å…¨æ—¶ä¸¾çš„ä¾‹å­ï¼šä¸¤ä¸ªçº¿ç¨‹ä¸€ä¸ª i++ ä¸€ä¸ª i-- ï¼Œåªèƒ½ä¿è¯çœ‹åˆ°æœ€æ–°å€¼ï¼Œä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡è®¾içš„åˆå§‹å€¼ä¸º0 </span></span><br><span class="line">getstatic i <span class="comment">// çº¿ç¨‹2-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0 </span></span><br><span class="line">getstatic i <span class="comment">// çº¿ç¨‹1-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0 </span></span><br><span class="line">iconst_1 <span class="comment">// çº¿ç¨‹1-å‡†å¤‡å¸¸é‡1 </span></span><br><span class="line">iadd <span class="comment">// çº¿ç¨‹1-è‡ªå¢ çº¿ç¨‹å†…i=1 </span></span><br><span class="line">putstatic i <span class="comment">// çº¿ç¨‹1-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=1 </span></span><br><span class="line">iconst_1 <span class="comment">// çº¿ç¨‹2-å‡†å¤‡å¸¸é‡1 </span></span><br><span class="line">isub <span class="comment">// çº¿ç¨‹2-è‡ªå‡ çº¿ç¨‹å†…i=-1 </span></span><br><span class="line">putstatic i <span class="comment">// çº¿ç¨‹2-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=-1 </span></span><br></pre></td></tr></table></figure><blockquote><p><code>æ³¨æ„</code></p><p>synchronized è¯­å¥å—æ—¢å¯ä»¥ä¿è¯ä»£ç å—çš„åŸå­æ€§ï¼Œä¹ŸåŒæ—¶ä¿è¯ä»£ç å—å†…å˜é‡çš„å¯è§æ€§ã€‚ä½†ç¼ºç‚¹æ˜¯ synchronized æ˜¯å±äºé‡é‡çº§æ“ä½œï¼Œæ€§èƒ½ç›¸å¯¹æ›´ä½ ã€‚</p><p>JMMå…³äºsynchronizedçš„ä¸¤æ¡è§„å®šï¼š</p><p>1ï¼‰çº¿ç¨‹è§£é”å‰ï¼Œå¿…é¡»æŠŠå…±äº«å˜é‡çš„æœ€æ–°å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­</p><p>2ï¼‰çº¿ç¨‹åŠ é”æ—¶ï¼Œå°†æ¸…ç©ºå·¥ä½œå†…å­˜ä¸­å…±äº«å˜é‡çš„å€¼ï¼Œä»è€Œä½¿ç”¨å…±äº«å˜é‡æ—¶éœ€è¦ä»ä¸»å†…å­˜ä¸­é‡æ–°è·å–æœ€æ–°çš„å€¼</p><p>ï¼ˆæ³¨æ„ï¼šåŠ é”ä¸è§£é”éœ€è¦æ˜¯åŒä¸€æŠŠé”ï¼‰</p><p>é€šè¿‡ä»¥ä¸Šä¸¤ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°synchronizedèƒ½å¤Ÿå®ç°å¯è§æ€§ã€‚åŒæ—¶ï¼Œç”±äºsynchronizedå…·æœ‰åŒæ­¥é”ï¼Œæ‰€ä»¥å®ƒä¹Ÿå…·æœ‰åŸå­æ€§</p><p>å¦‚æœåœ¨å‰é¢ç¤ºä¾‹çš„æ­»å¾ªç¯ä¸­åŠ å…¥ System.out.println() ä¼šå‘ç°å³ä½¿ä¸åŠ  volatile ä¿®é¥°ç¬¦ï¼Œçº¿ç¨‹ t ä¹Ÿèƒ½æ­£ç¡®çœ‹åˆ° å¯¹ run å˜é‡çš„ä¿®æ”¹äº†ï¼Œæƒ³ä¸€æƒ³ä¸ºä»€ä¹ˆï¼Ÿ(printlnæ–¹æ³•ä¸­æœ‰synchronizedä»£ç å—ä¿è¯äº†å¯è§æ€§)</p><p>synchronizedå…³é”®å­—ä¸èƒ½é˜»æ­¢æŒ‡ä»¤é‡æ’ï¼Œä½†åœ¨ä¸€å®šç¨‹åº¦ä¸Šèƒ½ä¿è¯æœ‰åºæ€§ï¼ˆå¦‚æœå…±äº«å˜é‡æ²¡æœ‰é€ƒé€¸å‡ºåŒæ­¥ä»£ç å—çš„è¯ï¼‰ã€‚å› ä¸ºåœ¨å•çº¿ç¨‹çš„æƒ…å†µä¸‹æŒ‡ä»¤é‡æ’ä¸å½±å“ç»“æœï¼Œç›¸å½“äºä¿éšœäº†æœ‰åºæ€§ã€‚</p></blockquote><h3 id="2-3-æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢">2.3 æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢</h3><p>Two Phase Termination</p><p>åœ¨ä¸€ä¸ªçº¿ç¨‹ T1 ä¸­å¦‚ä½•â€œä¼˜é›…â€ç»ˆæ­¢çº¿ç¨‹ T2ï¼Ÿè¿™é‡Œçš„ã€ä¼˜é›…ã€‘æŒ‡çš„æ˜¯ç»™ T2 ä¸€ä¸ªæ–™ç†åäº‹çš„æœºä¼šã€‚</p><p>é”™è¯¯æ€è·¯</p><ul><li>ä½¿ç”¨çº¿ç¨‹å¯¹è±¡çš„ stop() æ–¹æ³•åœæ­¢çº¿ç¨‹<ul><li>stop æ–¹æ³•ä¼šçœŸæ­£æ€æ­»çº¿ç¨‹ï¼Œå¦‚æœè¿™æ—¶çº¿ç¨‹é”ä½äº†å…±äº«èµ„æºï¼Œé‚£ä¹ˆå½“å®ƒè¢«æ€æ­»åå°±å†ä¹Ÿæ²¡æœ‰æœºä¼šé‡Šæ”¾é”ï¼Œ å…¶å®ƒçº¿ç¨‹å°†æ°¸è¿œæ— æ³•è·å–é”</li></ul></li><li>ä½¿ç”¨ System.exit(int) æ–¹æ³•åœæ­¢çº¿ç¨‹<ul><li>ç›®çš„ä»…æ˜¯åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†è¿™ç§åšæ³•ä¼šè®©æ•´ä¸ªç¨‹åºéƒ½åœæ­¢</li></ul></li></ul><div class="tabs" id="e534a3ae-a48e-4600-b307-289713ffc247"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e534a3ae-a48e-4600-b307-289713ffc247-1"><i class="fas fa-seedling"></i>åˆ©ç”¨ isInterrupted</button></li><li class="tab"><button type="button" data-href="#e534a3ae-a48e-4600-b307-289713ffc247-2"><i class="fas fa-leaf"></i>è°ƒç”¨&è¾“å‡º</button></li><li class="tab"><button type="button" data-href="#e534a3ae-a48e-4600-b307-289713ffc247-3"><i class="fab fa-apple"></i>åˆ©ç”¨volatileä¿®é¥°çš„åœæ­¢æ ‡è®°</button></li><li class="tab"><button type="button" data-href="#e534a3ae-a48e-4600-b307-289713ffc247-4"><i class="fas fa-tree"></i>è°ƒç”¨&è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e534a3ae-a48e-4600-b307-289713ffc247-1"><p>interrupt å¯ä»¥æ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼Œæ— è®ºè¿™ä¸ªçº¿ç¨‹æ˜¯åœ¨ sleepï¼Œwaitï¼Œè¿˜æ˜¯æ­£å¸¸è¿è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TPTInterrupt</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Thread thread;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span>&#123;</span><br><span class="line">        thread = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">                <span class="keyword">if</span>(current.isInterrupted()) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ–™ç†åäº‹&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    log.debug(<span class="string">&quot;å°†ç»“æœä¿å­˜&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="comment">//æ‰“æ–­sleepçº¿ç¨‹ä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°ï¼Œæ‰€ä»¥è¦æ·»åŠ æ ‡è®°</span></span><br><span class="line">                    current.interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ‰§è¡Œç›‘æ§æ“ä½œ </span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;ç›‘æ§çº¿ç¨‹&quot;</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        thread.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e534a3ae-a48e-4600-b307-289713ffc247-2"><p>è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TPTInterrupt</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TPTInterrupt</span>();</span><br><span class="line">t.start();</span><br><span class="line">Thread.sleep(<span class="number">3500</span>);</span><br><span class="line">log.debug(<span class="string">&quot;stop&quot;</span>);</span><br><span class="line">t.stop();</span><br></pre></td></tr></table></figure><p>ç»“æœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">11:49:42.915 c.TwoPhaseTermination [ç›‘æ§çº¿ç¨‹] - å°†ç»“æœä¿å­˜</span><br><span class="line">11:49:43.919 c.TwoPhaseTermination [ç›‘æ§çº¿ç¨‹] - å°†ç»“æœä¿å­˜</span><br><span class="line">11:49:44.919 c.TwoPhaseTermination [ç›‘æ§çº¿ç¨‹] - å°†ç»“æœä¿å­˜</span><br><span class="line">11:49:45.413 c.TestTwoPhaseTermination [main] - stop </span><br><span class="line">11:49:45.413 c.TwoPhaseTermination [ç›‘æ§çº¿ç¨‹] - æ–™ç†åäº‹</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e534a3ae-a48e-4600-b307-289713ffc247-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœæ­¢æ ‡è®°ç”¨ volatile æ˜¯ä¸ºäº†ä¿è¯è¯¥å˜é‡åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§</span></span><br><span class="line"><span class="comment">// æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå³ä¸»çº¿ç¨‹æŠŠå®ƒä¿®æ”¹ä¸º true å¯¹ t1 çº¿ç¨‹å¯è§</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TPTVolatile</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Thread thread;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">stop</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span>&#123;</span><br><span class="line">        thread = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">                <span class="keyword">if</span>(stop) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ–™ç†åäº‹&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    log.debug(<span class="string">&quot;å°†ç»“æœä¿å­˜&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                     &#125;</span><br><span class="line">                <span class="comment">// æ‰§è¡Œç›‘æ§æ“ä½œ</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;ç›‘æ§çº¿ç¨‹&quot;</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        stop = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">//è®©çº¿ç¨‹ç«‹å³åœæ­¢è€Œä¸æ˜¯ç­‰å¾…sleepç»“æŸ</span></span><br><span class="line">        thread.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e534a3ae-a48e-4600-b307-289713ffc247-4"><p>è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TPTVolatile</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TPTVolatile</span>();</span><br><span class="line">t.start();</span><br><span class="line">Thread.sleep(<span class="number">3500</span>);</span><br><span class="line">log.debug(<span class="string">&quot;stop&quot;</span>);</span><br><span class="line">t.stop();</span><br></pre></td></tr></table></figure><p>ç»“æœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">11:54:52.003 c.TPTVolatile [ç›‘æ§çº¿ç¨‹] - å°†ç»“æœä¿å­˜</span><br><span class="line">11:54:53.006 c.TPTVolatile [ç›‘æ§çº¿ç¨‹] - å°†ç»“æœä¿å­˜</span><br><span class="line">11:54:54.007 c.TPTVolatile [ç›‘æ§çº¿ç¨‹] - å°†ç»“æœä¿å­˜</span><br><span class="line">11:54:54.502 c.TestTwoPhaseTermination [main] - stop </span><br><span class="line">11:54:54.502 c.TPTVolatile [ç›‘æ§çº¿ç¨‹] - æ–™ç†åäº‹</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="3-æœ‰åºæ€§">3. æœ‰åºæ€§</h2><p>JVM ä¼šåœ¨ä¸å½±å“æ­£ç¡®æ€§çš„å‰æä¸‹ï¼Œå¯ä»¥è°ƒæ•´è¯­å¥çš„æ‰§è¡Œé¡ºåºï¼Œæ€è€ƒä¸‹é¢ä¸€æ®µä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> i;</span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> j;</span><br><span class="line"><span class="comment">// åœ¨æŸä¸ªçº¿ç¨‹å†…æ‰§è¡Œå¦‚ä¸‹èµ‹å€¼æ“ä½œ</span></span><br><span class="line">i = ...; </span><br><span class="line">j = ...; </span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè‡³äºæ˜¯å…ˆæ‰§è¡Œ i è¿˜æ˜¯ å…ˆæ‰§è¡Œ j ï¼Œå¯¹æœ€ç»ˆçš„ç»“æœä¸ä¼šäº§ç”Ÿå½±å“ã€‚æ‰€ä»¥ï¼Œä¸Šé¢ä»£ç çœŸæ­£æ‰§è¡Œæ—¶ï¼Œæ—¢å¯ä»¥æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">i = ...; </span><br><span class="line">j = ...;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">j = ...;</span><br><span class="line">i = ...; </span><br></pre></td></tr></table></figure><p>è¿™ç§ç‰¹æ€§ç§°ä¹‹ä¸ºã€æŒ‡ä»¤é‡æ’ã€ï¼Œå¤šçº¿ç¨‹ä¸‹ã€æŒ‡ä»¤é‡æ’ã€ä¼šå½±å“æ­£ç¡®æ€§ã€‚ä¸ºä»€ä¹ˆè¦æœ‰é‡æ’æŒ‡ä»¤è¿™é¡¹ä¼˜åŒ–å‘¢ï¼Ÿä» CPU æ‰§è¡ŒæŒ‡ä»¤çš„åŸç†æ¥ç†è§£ä¸€ä¸‹å§</p><h3 id="3-1-åŸç†ä¹‹æŒ‡ä»¤çº§å¹¶è¡Œ">3.1 åŸç†ä¹‹æŒ‡ä»¤çº§å¹¶è¡Œ</h3><p>åè¯ï¼š</p><p><code>Clock Cycle Time</code></p><p>ä¸»é¢‘çš„æ¦‚å¿µå¤§å®¶æ¥è§¦çš„æ¯”è¾ƒå¤šï¼Œè€Œ CPU çš„ Clock Cycle Timeï¼ˆæ—¶é’Ÿå‘¨æœŸæ—¶é—´ï¼‰ï¼Œç­‰äºä¸»é¢‘çš„å€’æ•°ï¼Œæ„æ€æ˜¯ CPU èƒ½ å¤Ÿè¯†åˆ«çš„æœ€å°æ—¶é—´å•ä½ï¼Œæ¯”å¦‚è¯´ 4G ä¸»é¢‘çš„ CPU çš„ Clock Cycle Time å°±æ˜¯ 0.25 nsï¼Œä½œä¸ºå¯¹æ¯”ï¼Œæˆ‘ä»¬å¢™ä¸ŠæŒ‚é’Ÿçš„ Cycle Time æ˜¯ 1s</p><p>ä¾‹å¦‚ï¼Œè¿è¡Œä¸€æ¡åŠ æ³•æŒ‡ä»¤ä¸€èˆ¬éœ€è¦ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸæ—¶é—´</p><p><code>CPI</code></p><p>æœ‰çš„æŒ‡ä»¤éœ€è¦æ›´å¤šçš„æ—¶é’Ÿå‘¨æœŸæ—¶é—´ï¼Œæ‰€ä»¥å¼•å‡ºäº† CPI ï¼ˆCycles Per Instructionï¼‰æŒ‡ä»¤å¹³å‡æ—¶é’Ÿå‘¨æœŸæ•°</p><p><code>IPC</code></p><p>IPCï¼ˆInstruction Per Clock Cycleï¼‰ å³ CPI çš„å€’æ•°ï¼Œè¡¨ç¤ºæ¯ä¸ªæ—¶é’Ÿå‘¨æœŸèƒ½å¤Ÿè¿è¡Œçš„æŒ‡ä»¤æ•°</p><p><code>CPU æ‰§è¡Œæ—¶é—´</code></p><p>ç¨‹åºçš„ CPU æ‰§è¡Œæ—¶é—´ï¼Œå³æˆ‘ä»¬å‰é¢æåˆ°çš„ user + system æ—¶é—´ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„å…¬å¼æ¥è¡¨ç¤º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç¨‹åº CPU æ‰§è¡Œæ—¶é—´ = æŒ‡ä»¤æ•° * CPI * Clock Cycle Time</span><br></pre></td></tr></table></figure><p><code>æŒ‡ä»¤é‡æ’åºä¼˜åŒ–</code></p><p>äº‹å®ä¸Šï¼Œç°ä»£å¤„ç†å™¨ä¼šè®¾è®¡ä¸ºä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå®Œæˆä¸€æ¡æ‰§è¡Œæ—¶é—´æœ€é•¿çš„ CPU æŒ‡ä»¤ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆåšå‘¢ï¼Ÿå¯ä»¥æƒ³åˆ°æŒ‡ä»¤ è¿˜å¯ä»¥å†åˆ’åˆ†æˆä¸€ä¸ªä¸ªæ›´å°çš„é˜¶æ®µï¼Œä¾‹å¦‚ï¼Œæ¯æ¡æŒ‡ä»¤éƒ½å¯ä»¥åˆ†ä¸ºï¼š <code>å–æŒ‡ä»¤ - æŒ‡ä»¤è¯‘ç  - æ‰§è¡ŒæŒ‡ä»¤ - å†…å­˜è®¿é—® - æ•°æ®å†™å›</code> è¿™ 5 ä¸ªé˜¶æ®µ</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220306122605032.png" alt="image-20220306122605032"></p><p>åœ¨ä¸æ”¹å˜ç¨‹åºç»“æœçš„å‰æä¸‹ï¼Œè¿™äº›æŒ‡ä»¤çš„å„ä¸ªé˜¶æ®µå¯ä»¥é€šè¿‡<strong>é‡æ’åº</strong>å’Œ<strong>ç»„åˆ</strong>æ¥å®ç°æŒ‡ä»¤çº§å¹¶è¡Œï¼Œè¿™ä¸€æŠ€æœ¯åœ¨ 80â€™s ä¸­ å¶åˆ° 90â€™s ä¸­å¶å æ®äº†è®¡ç®—æ¶æ„çš„é‡è¦åœ°ä½ã€‚</p><blockquote><p><strong>æç¤º</strong>ï¼š</p><p>åˆ†é˜¶æ®µï¼Œåˆ†å·¥æ˜¯æå‡æ•ˆç‡çš„å…³é”®ï¼</p></blockquote><p>æŒ‡ä»¤é‡æ’çš„å‰ææ˜¯ï¼Œé‡æ’æŒ‡ä»¤ä¸èƒ½å½±å“ç»“æœï¼Œä¾‹å¦‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯ä»¥é‡æ’çš„ä¾‹å­</span></span><br><span class="line"><span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">10</span>; <span class="comment">// æŒ‡ä»¤1</span></span><br><span class="line"><span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">20</span>; <span class="comment">// æŒ‡ä»¤2</span></span><br><span class="line">System.out.println( a + b );</span><br><span class="line"><span class="comment">// ä¸èƒ½é‡æ’çš„ä¾‹å­</span></span><br><span class="line"><span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">10</span>; <span class="comment">// æŒ‡ä»¤1</span></span><br><span class="line"><span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> a - <span class="number">5</span>; <span class="comment">// æŒ‡ä»¤2</span></span><br></pre></td></tr></table></figure><div class="tabs" id="7ffbf873-2465-4c87-9b21-b825a0f410f8"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#7ffbf873-2465-4c87-9b21-b825a0f410f8-1"><i class="fas fa-atom"></i>æ”¯æŒæµæ°´çº¿çš„å¤„ç†å™¨</button></li><li class="tab"><button type="button" data-href="#7ffbf873-2465-4c87-9b21-b825a0f410f8-2"><i class="far fa-sun"></i>SuperScalar å¤„ç†å™¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="7ffbf873-2465-4c87-9b21-b825a0f410f8-1"><p>ç°ä»£ CPU æ”¯æŒ<strong>å¤šçº§æŒ‡ä»¤æµæ°´çº¿</strong>ï¼Œä¾‹å¦‚æ”¯æŒåŒæ—¶æ‰§è¡Œ <code>å–æŒ‡ä»¤ - æŒ‡ä»¤è¯‘ç  - æ‰§è¡ŒæŒ‡ä»¤ - å†…å­˜è®¿é—® - æ•°æ®å†™å›</code> çš„å¤„ç† å™¨ï¼Œå°±å¯ä»¥ç§°ä¹‹ä¸º<strong>äº”çº§æŒ‡ä»¤æµæ°´çº¿</strong>ã€‚è¿™æ—¶ CPU å¯ä»¥åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…ï¼ŒåŒæ—¶è¿è¡Œäº”æ¡æŒ‡ä»¤çš„ä¸åŒé˜¶æ®µï¼ˆç›¸å½“äºä¸€ æ¡æ‰§è¡Œæ—¶é—´æœ€é•¿çš„å¤æ‚æŒ‡ä»¤ï¼‰ï¼ŒIPC = 1ï¼Œæœ¬è´¨ä¸Šï¼Œæµæ°´çº¿æŠ€æœ¯å¹¶ä¸èƒ½ç¼©çŸ­å•æ¡æŒ‡ä»¤çš„æ‰§è¡Œæ—¶é—´ï¼Œä½†å®ƒå˜ç›¸åœ°æé«˜äº† æŒ‡ä»¤åœ°ååç‡ã€‚</p><blockquote><p><strong>æç¤º</strong>ï¼š</p><p>å¥”è…¾å››ï¼ˆPentium 4ï¼‰æ”¯æŒé«˜è¾¾ 35 çº§æµæ°´çº¿ï¼Œä½†ç”±äºåŠŸè€—å¤ªé«˜è¢«åºŸå¼ƒ</p></blockquote><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220306123819512.png" alt="image-20220306123819512"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="7ffbf873-2465-4c87-9b21-b825a0f410f8-2"><p>å¤§å¤šæ•°å¤„ç†å™¨åŒ…å«å¤šä¸ªæ‰§è¡Œå•å…ƒï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰è®¡ç®—åŠŸèƒ½éƒ½é›†ä¸­åœ¨ä¸€èµ·ï¼Œå¯ä»¥å†ç»†åˆ†ä¸ºæ•´æ•°è¿ç®—å•å…ƒã€æµ®ç‚¹æ•°è¿ç®—å• å…ƒç­‰ï¼Œè¿™æ ·å¯ä»¥æŠŠå¤šæ¡æŒ‡ä»¤ä¹Ÿå¯ä»¥åšåˆ°å¹¶è¡Œè·å–ã€è¯‘ç ç­‰ï¼ŒCPU å¯ä»¥åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…ï¼Œæ‰§è¡Œå¤šäºä¸€æ¡æŒ‡ä»¤ï¼ŒIPC &gt; 1</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220306123933327.png" alt="image-20220306123933327"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <p>è¯¡å¼‚çš„ç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="type">boolean</span> <span class="variable">ready</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"><span class="comment">// çº¿ç¨‹1 æ‰§è¡Œæ­¤æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor1</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(ready) &#123;</span><br><span class="line">        r.r1 = num + num;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        r.r1 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// çº¿ç¨‹2 æ‰§è¡Œæ­¤æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor2</span><span class="params">(I_Result r)</span> &#123; </span><br><span class="line">    num = <span class="number">2</span>;</span><br><span class="line">    ready = <span class="literal">true</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>I_Result æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæœ‰ä¸€ä¸ªå±æ€§ r1 ç”¨æ¥ä¿å­˜ç»“æœï¼Œé—®ï¼Œå¯èƒ½çš„ç»“æœæœ‰å‡ ç§ï¼Ÿ</p><p>æœ‰åŒå­¦è¿™ä¹ˆåˆ†æ</p><p>æƒ…å†µ1ï¼šçº¿ç¨‹1 å…ˆæ‰§è¡Œï¼Œè¿™æ—¶ ready = falseï¼Œæ‰€ä»¥è¿›å…¥ else åˆ†æ”¯ç»“æœä¸º 1</p><p>æƒ…å†µ2ï¼šçº¿ç¨‹2 å…ˆæ‰§è¡Œ num = 2ï¼Œä½†æ²¡æ¥å¾—åŠæ‰§è¡Œ ready = trueï¼Œçº¿ç¨‹1 æ‰§è¡Œï¼Œè¿˜æ˜¯è¿›å…¥ else åˆ†æ”¯ï¼Œç»“æœä¸º1</p><p>æƒ…å†µ3ï¼šçº¿ç¨‹2 æ‰§è¡Œåˆ° ready = trueï¼Œçº¿ç¨‹1 æ‰§è¡Œï¼Œè¿™å›è¿›å…¥ if åˆ†æ”¯ï¼Œç»“æœä¸º 4ï¼ˆå› ä¸º num å·²ç»æ‰§è¡Œè¿‡äº†ï¼‰</p><p>ä½†æˆ‘å‘Šè¯‰ä½ ï¼Œç»“æœè¿˜æœ‰å¯èƒ½æ˜¯ 0 ğŸ˜ğŸ˜ğŸ˜ï¼Œä¿¡ä¸ä¿¡å§ï¼</p><p>è¿™ç§æƒ…å†µä¸‹æ˜¯ï¼šçº¿ç¨‹2 æ‰§è¡Œ ready = trueï¼Œåˆ‡æ¢åˆ°çº¿ç¨‹1ï¼Œè¿›å…¥ if åˆ†æ”¯ï¼Œç›¸åŠ ä¸º 0ï¼Œå†åˆ‡å›çº¿ç¨‹2 æ‰§è¡Œ num = 2</p><p>ç›¸ä¿¡å¾ˆå¤šäººå·²ç»æ™•äº† ğŸ˜µğŸ˜µğŸ˜µ</p><p>è¿™ç§ç°è±¡å«åšæŒ‡ä»¤é‡æ’ï¼Œæ˜¯ JIT ç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶çš„ä¸€äº›ä¼˜åŒ–ï¼Œè¿™ä¸ªç°è±¡éœ€è¦é€šè¿‡å¤§é‡æµ‹è¯•æ‰èƒ½å¤ç°ï¼š</p><p>å€ŸåŠ© java å¹¶å‘å‹æµ‹å·¥å…· jcstress <a href="https://wiki.openjdk.java.net/display/CodeTools/jcstress">https://wiki.openjdk.java.net/display/CodeTools/jcstress</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mvn archetype:generate -DinteractiveMode=<span class="literal">false</span> -DarchetypeGroupId=org.openjdk.jcstress -</span><br><span class="line">DarchetypeArtifactId=jcstress-java-test-archetype -DarchetypeVersion=0.5 -DgroupId=cn.itcast -</span><br><span class="line">DartifactId=ordering -Dversion=1.0 </span><br></pre></td></tr></table></figure><p>åˆ›å»º maven é¡¹ç›®ï¼Œæä¾›å¦‚ä¸‹æµ‹è¯•ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JCStressTest</span></span><br><span class="line"><span class="meta">@Outcome(id = &#123;&quot;1&quot;, &quot;4&quot;&#125;, expect = Expect.ACCEPTABLE, desc = &quot;ok&quot;)</span></span><br><span class="line"><span class="meta">@Outcome(id = &quot;0&quot;, expect = Expect.ACCEPTABLE_INTERESTING, desc = &quot;!!!!&quot;)</span></span><br><span class="line"><span class="meta">@State</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConcurrencyTest</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">ready</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="meta">@Actor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor1</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(ready) &#123;</span><br><span class="line">            r.r1 = num + num;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            r.r1 = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Actor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor2</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">        num = <span class="number">2</span>;</span><br><span class="line">        ready = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install </span><br><span class="line">java -jar target/jcstress.jar </span><br></pre></td></tr></table></figure><p>ä¼šè¾“å‡ºæˆ‘ä»¬æ„Ÿå…´è¶£çš„ç»“æœï¼Œæ‘˜å½•å…¶ä¸­ä¸€æ¬¡ç»“æœï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">*** INTERESTING tests </span><br><span class="line"> Some interesting behaviors observed. This is <span class="keyword">for</span> the plain curiosity. </span><br><span class="line"> </span><br><span class="line"> 2 matching <span class="built_in">test</span> results. </span><br><span class="line"> [OK] test.ConcurrencyTest </span><br><span class="line"> (JVM args: [-XX:-TieredCompilation]) </span><br><span class="line">    Observed state Occurrences Expectation Interpretation </span><br><span class="line">    0 1,729 ACCEPTABLE_INTERESTING !!!! </span><br><span class="line"> 1 42,617,915 ACCEPTABLE ok </span><br><span class="line"> 4 5,146,627 ACCEPTABLE ok </span><br><span class="line"> </span><br><span class="line"> [OK] test.ConcurrencyTest </span><br><span class="line"> (JVM args: []) </span><br><span class="line"> Observed state Occurrences Expectation Interpretation </span><br><span class="line"> 0 1,652 ACCEPTABLE_INTERESTING !!!! </span><br><span class="line"> 1 46,460,657 ACCEPTABLE ok </span><br><span class="line"> 4 4,571,072 ACCEPTABLE ok </span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå‡ºç°ç»“æœä¸º 0 çš„æƒ…å†µæœ‰ 638 æ¬¡ï¼Œè™½ç„¶æ¬¡æ•°ç›¸å¯¹å¾ˆå°‘ï¼Œä½†æ¯•ç«Ÿæ˜¯å‡ºç°äº†ã€‚</p><p>è§£å†³æ–¹æ³•</p><p>volatile ä¿®é¥°çš„å˜é‡ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JCStressTest</span></span><br><span class="line"><span class="meta">@Outcome(id = &#123;&quot;1&quot;, &quot;4&quot;&#125;, expect = Expect.ACCEPTABLE, desc = &quot;ok&quot;)</span></span><br><span class="line"><span class="meta">@Outcome(id = &quot;0&quot;, expect = Expect.ACCEPTABLE_INTERESTING, desc = &quot;!!!!&quot;)</span></span><br><span class="line"><span class="meta">@State</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConcurrencyTest</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">ready</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="meta">@Actor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor1</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(ready) &#123;</span><br><span class="line">            r.r1 = num + num;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            r.r1 = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Actor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor2</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">        num = <span class="number">2</span>;</span><br><span class="line">        ready = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœä¸ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*** INTERESTING tests </span><br><span class="line"> Some interesting behaviors observed. This is <span class="keyword">for</span> the plain curiosity. </span><br><span class="line"> 0 matching <span class="built_in">test</span> results. </span><br></pre></td></tr></table></figure><h3 id="3-2-åŸç†ä¹‹-volatile">3.2 åŸç†ä¹‹ volatile</h3><p>volatile çš„åº•å±‚å®ç°åŸç†æ˜¯å†…å­˜å±éšœï¼ŒMemory Barrierï¼ˆMemory Fenceï¼‰</p><ul><li>å¯¹ volatile å˜é‡çš„å†™æŒ‡ä»¤åä¼šåŠ å…¥å†™å±éšœ</li><li>å¯¹ volatile å˜é‡çš„è¯»æŒ‡ä»¤å‰ä¼šåŠ å…¥è¯»å±éšœ</li></ul><h4 id="3-2-1-å¦‚ä½•ä¿è¯å¯è§æ€§">3.2.1 å¦‚ä½•ä¿è¯å¯è§æ€§</h4><ul><li>å†™å±éšœï¼ˆsfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹å‰çš„ï¼Œå¯¹å…±äº«å˜é‡(numå’Œready)çš„æ”¹åŠ¨ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor2</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">    num = <span class="number">2</span>;</span><br><span class="line">    ready = <span class="literal">true</span>; <span class="comment">// ready æ˜¯ volatile èµ‹å€¼å¸¦å†™å±éšœ</span></span><br><span class="line">    <span class="comment">// å†™å±éšœ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è€Œè¯»å±éšœï¼ˆlfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹åï¼Œå¯¹å…±äº«å˜é‡çš„è¯»å–ï¼ŒåŠ è½½çš„æ˜¯ä¸»å­˜ä¸­æœ€æ–°æ•°æ®</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor1</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">    <span class="comment">// è¯»å±éšœ</span></span><br><span class="line">    <span class="comment">// ready æ˜¯ volatile è¯»å–å€¼å¸¦è¯»å±éšœ</span></span><br><span class="line">    <span class="keyword">if</span>(ready) &#123;</span><br><span class="line">        r.r1 = num + num;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        r.r1 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220306125622336.png" alt="image-20220306125622336" style="zoom: 67%;" /><h4 id="3-2-2-å¦‚ä½•ä¿è¯æœ‰åºæ€§">3.2.2 å¦‚ä½•ä¿è¯æœ‰åºæ€§</h4><ul><li>å†™å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†å†™å±éšœä¹‹å‰çš„ä»£ç æ’åœ¨å†™å±éšœä¹‹å</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor2</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">    num = <span class="number">2</span>;</span><br><span class="line">    ready = <span class="literal">true</span>; <span class="comment">// ready æ˜¯ volatile èµ‹å€¼å¸¦å†™å±éšœ</span></span><br><span class="line">    <span class="comment">// å†™å±éšœ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¯»å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†è¯»å±éšœä¹‹åçš„ä»£ç æ’åœ¨è¯»å±éšœä¹‹å‰</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor1</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">    <span class="comment">// è¯»å±éšœ</span></span><br><span class="line">    <span class="comment">// ready æ˜¯ volatile è¯»å–å€¼å¸¦è¯»å±éšœ</span></span><br><span class="line">    <span class="keyword">if</span>(ready) &#123;</span><br><span class="line">        r.r1 = num + num;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        r.r1 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220306130348150.png" alt="image-20220306130348150" style="zoom: 67%;" /><p>è¿˜æ˜¯é‚£å¥è¯ï¼Œä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™ï¼š</p><ul><li>å†™å±éšœä»…ä»…æ˜¯ä¿è¯ä¹‹åçš„è¯»èƒ½å¤Ÿè¯»åˆ°æœ€æ–°çš„ç»“æœï¼Œä½†ä¸èƒ½ä¿è¯è¯»è·‘åˆ°å®ƒå‰é¢å»</li><li>è€Œæœ‰åºæ€§çš„ä¿è¯ä¹Ÿåªæ˜¯ä¿è¯äº†æœ¬çº¿ç¨‹å†…ç›¸å…³ä»£ç ä¸è¢«é‡æ’åº</li></ul><p>ä»¥i++ iâ€“ä¸ºä¾‹</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220306130731767.png" alt="image-20220306130731767" style="zoom: 67%;" /><h4 id="3-2-3-åŒé‡æ£€æŸ¥é”é—®é¢˜">3.2.3 åŒé‡æ£€æŸ¥é”é—®é¢˜</h4><p>ä»¥è‘—åçš„ double-checked locking å•ä¾‹æ¨¡å¼ä¸ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Singleton</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123; </span><br><span class="line">        <span class="keyword">if</span>(INSTANCE == <span class="literal">null</span>) &#123; <span class="comment">// t2 t1</span></span><br><span class="line">            <span class="comment">// é¦–æ¬¡è®¿é—®ä¼šåŒæ­¥ï¼Œè€Œä¹‹åçš„ä½¿ç”¨æ²¡æœ‰ synchronized</span></span><br><span class="line">            <span class="keyword">synchronized</span>(Singleton.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) &#123; <span class="comment">// t1</span></span><br><span class="line">                    INSTANCE = <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">                &#125; </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šçš„å®ç°ç‰¹ç‚¹æ˜¯ï¼š</p><ul><li>æ‡’æƒ°å®ä¾‹åŒ–</li><li>é¦–æ¬¡ä½¿ç”¨ getInstance() æ‰ä½¿ç”¨ synchronized åŠ é”ï¼Œåç»­ä½¿ç”¨æ—¶æ— éœ€åŠ é”</li><li>æœ‰éšå«çš„ï¼Œä½†å¾ˆå…³é”®çš„ä¸€ç‚¹ï¼šç¬¬ä¸€ä¸ª if ä½¿ç”¨äº† INSTANCE å˜é‡ï¼Œæ˜¯åœ¨åŒæ­¥å—ä¹‹å¤–</li></ul><p>ä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¸Šé¢çš„ä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼ŒgetInstance æ–¹æ³•å¯¹åº”çš„å­—èŠ‚ç ä¸ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0: getstatic <span class="comment">#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span></span><br><span class="line">3: ifnonnull 37</span><br><span class="line">6: ldc <span class="comment">#3 // class cn/itcast/n5/Singleton</span></span><br><span class="line">8: dup</span><br><span class="line">9: astore_0</span><br><span class="line">10: monitorenter</span><br><span class="line">11: getstatic <span class="comment">#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span></span><br><span class="line">14: ifnonnull 27</span><br><span class="line">17: new <span class="comment">#3 // class cn/itcast/n5/Singleton</span></span><br><span class="line">20: dup</span><br><span class="line">21: invokespecial <span class="comment">#4 // Method &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">24: putstatic <span class="comment">#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span></span><br><span class="line">27: aload_0</span><br><span class="line">28: monitorexit</span><br><span class="line">29: goto 37</span><br><span class="line">32: astore_1</span><br><span class="line">33: aload_0</span><br><span class="line">34: monitorexit</span><br><span class="line">35: aload_1</span><br><span class="line">36: athrow</span><br><span class="line">37: getstatic <span class="comment">#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span></span><br><span class="line">40: areturn</span><br></pre></td></tr></table></figure><p>å…¶ä¸­</p><ul><li>17 è¡¨ç¤ºåˆ›å»ºå¯¹è±¡ï¼Œå°†å¯¹è±¡å¼•ç”¨å…¥æ ˆ // new Singleton</li><li>20 è¡¨ç¤ºå¤åˆ¶ä¸€ä»½å¯¹è±¡å¼•ç”¨ // å¼•ç”¨åœ°å€</li><li>21 è¡¨ç¤ºåˆ©ç”¨ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œè°ƒç”¨æ„é€ æ–¹æ³•</li><li>24 è¡¨ç¤ºåˆ©ç”¨ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œèµ‹å€¼ç»™ static INSTANCE</li></ul><p>ä¹Ÿè®¸ jvm ä¼šä¼˜åŒ–ä¸ºï¼šå…ˆæ‰§è¡Œ 24ï¼Œå†æ‰§è¡Œ 21ã€‚å¦‚æœä¸¤ä¸ªçº¿ç¨‹ t1ï¼Œt2 æŒ‰å¦‚ä¸‹æ—¶é—´åºåˆ—æ‰§è¡Œï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230401160623110.png" alt="image-20230401160623110" style="zoom: 33%;" /><p>å…³é”®åœ¨äº 0: getstatic è¿™è¡Œä»£ç åœ¨ monitor æ§åˆ¶ä¹‹å¤–ï¼Œå®ƒå°±åƒä¹‹å‰ä¸¾ä¾‹ä¸­ä¸å®ˆè§„åˆ™çš„äººï¼Œå¯ä»¥è¶Šè¿‡ monitor è¯»å– INSTANCE å˜é‡çš„å€¼</p><p>è¿™æ—¶ t1 è¿˜æœªå®Œå…¨å°†æ„é€ æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œå¦‚æœåœ¨æ„é€ æ–¹æ³•ä¸­è¦æ‰§è¡Œå¾ˆå¤šåˆå§‹åŒ–æ“ä½œï¼Œé‚£ä¹ˆ t2 æ‹¿åˆ°çš„æ˜¯å°†æ˜¯ä¸€ä¸ªæœªåˆ å§‹åŒ–å®Œæ¯•çš„å•ä¾‹</p><p>å¯¹ INSTANCE ä½¿ç”¨ volatile ä¿®é¥°å³å¯ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’ï¼Œä½†è¦æ³¨æ„åœ¨ JDK 5 ä»¥ä¸Šçš„ç‰ˆæœ¬çš„ volatile æ‰ä¼šçœŸæ­£æœ‰æ•ˆ</p><h4 id="3-2-4-åŒé‡æ£€æŸ¥é”è§£å†³">3.2.4 åŒé‡æ£€æŸ¥é”è§£å†³</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">Singleton</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å®ä¾‹æ²¡åˆ›å»ºï¼Œæ‰ä¼šè¿›å…¥å†…éƒ¨çš„ synchronizedä»£ç å—</span></span><br><span class="line">        <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) &#123; </span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton.class) &#123; <span class="comment">// t2</span></span><br><span class="line">                <span class="comment">// ä¹Ÿè®¸æœ‰å…¶å®ƒçº¿ç¨‹å·²ç»åˆ›å»ºå®ä¾‹ï¼Œæ‰€ä»¥å†åˆ¤æ–­ä¸€æ¬¡</span></span><br><span class="line">                <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) &#123; <span class="comment">// t1</span></span><br><span class="line">                    INSTANCE = <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å­—èŠ‚ç ä¸Šçœ‹ä¸å‡ºæ¥ volatile æŒ‡ä»¤çš„æ•ˆæœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// -------------------------------------&gt; åŠ å…¥å¯¹ INSTANCE å˜é‡çš„è¯»å±éšœ</span><br><span class="line">0: getstatic <span class="comment">#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span></span><br><span class="line">3: ifnonnull 37</span><br><span class="line">6: ldc <span class="comment">#3 // class cn/itcast/n5/Singleton</span></span><br><span class="line">8: dup</span><br><span class="line">9: astore_0</span><br><span class="line">10: monitorenter -----------------------&gt; ä¿è¯åŸå­æ€§ã€å¯è§æ€§</span><br><span class="line">11: getstatic <span class="comment">#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span></span><br><span class="line">14: ifnonnull 27</span><br><span class="line">17: new <span class="comment">#3 // class cn/itcast/n5/Singleton</span></span><br><span class="line">20: dup</span><br><span class="line">21: invokespecial <span class="comment">#4 // Method &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">24: putstatic <span class="comment">#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span></span><br><span class="line">// -------------------------------------&gt; åŠ å…¥å¯¹ INSTANCE å˜é‡çš„å†™å±éšœ</span><br><span class="line">27: aload_0</span><br><span class="line">28: monitorexit ------------------------&gt; ä¿è¯åŸå­æ€§ã€å¯è§æ€§</span><br><span class="line">29: goto 37</span><br><span class="line">32: astore_1</span><br><span class="line">33: aload_0</span><br><span class="line">34: monitorexit</span><br><span class="line">35: aload_1</span><br><span class="line">36: athrow</span><br><span class="line">37: getstatic <span class="comment">#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span></span><br><span class="line">40: areturn</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šé¢çš„æ³¨é‡Šå†…å®¹æ‰€ç¤ºï¼Œè¯»å†™ volatile å˜é‡æ—¶ä¼šåŠ å…¥å†…å­˜å±éšœï¼ˆMemory Barrierï¼ˆMemory Fenceï¼‰ï¼‰ï¼Œä¿è¯ä¸‹é¢ä¸¤ç‚¹ï¼š</p><ul><li>å¯è§æ€§<ul><li>å†™å±éšœï¼ˆsfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹å‰çš„ t1 å¯¹å…±äº«å˜é‡çš„æ”¹åŠ¨ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­</li><li>è€Œè¯»å±éšœï¼ˆlfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹å t2 å¯¹å…±äº«å˜é‡çš„è¯»å–ï¼ŒåŠ è½½çš„æ˜¯ä¸»å­˜ä¸­æœ€æ–°æ•°æ®</li></ul></li><li>æœ‰åºæ€§<ul><li>å†™å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†å†™å±éšœä¹‹å‰çš„ä»£ç æ’åœ¨å†™å±éšœä¹‹å</li><li>è¯»å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†è¯»å±éšœä¹‹åçš„ä»£ç æ’åœ¨è¯»å±éšœä¹‹å‰</li></ul></li><li>æ›´åº•å±‚æ˜¯è¯»å†™å˜é‡æ—¶ä½¿ç”¨ lock æŒ‡ä»¤æ¥å¤šæ ¸ CPU ä¹‹é—´çš„å¯è§æ€§ä¸æœ‰åºæ€§</li></ul><h4 id="3-2-5-happens-beforeè§„åˆ™">3.2.5 happens-beforeè§„åˆ™</h4><p>happens-beforeè§„åˆ™è§„å®šäº†å¯¹å…±äº«å˜é‡çš„å†™æ“ä½œå¯¹å…¶å®ƒçº¿ç¨‹çš„è¯»æ“ä½œå¯è§ï¼Œå®ƒæ˜¯å¯è§æ€§ä¸æœ‰åºæ€§çš„ä¸€å¥—è§„åˆ™æ€»ç»“ï¼ŒæŠ›å¼€ä»¥ä¸‹ happens-before è§„åˆ™ï¼ŒJMM å¹¶ä¸èƒ½ä¿è¯ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™ï¼Œå¯¹äºå…¶å®ƒçº¿ç¨‹å¯¹è¯¥å…±äº«å˜é‡çš„è¯»å¯è§ <div class="tabs" id="0d60299e-3ed8-46ed-82f2-8ce4b9694d1a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#0d60299e-3ed8-46ed-82f2-8ce4b9694d1a-1"><i class="fas fa-atom"></i>è§„åˆ™1</button></li><li class="tab"><button type="button" data-href="#0d60299e-3ed8-46ed-82f2-8ce4b9694d1a-2"><i class="far fa-sun"></i>è§„åˆ™2</button></li><li class="tab"><button type="button" data-href="#0d60299e-3ed8-46ed-82f2-8ce4b9694d1a-3"><i class="fas fa-wind"></i>è§„åˆ™3</button></li><li class="tab"><button type="button" data-href="#0d60299e-3ed8-46ed-82f2-8ce4b9694d1a-4"><i class="fas fa-fire-alt"></i>è§„åˆ™4</button></li><li class="tab"><button type="button" data-href="#0d60299e-3ed8-46ed-82f2-8ce4b9694d1a-5"><i class="fas fa-cat"></i>è§„åˆ™5</button></li><li class="tab"><button type="button" data-href="#0d60299e-3ed8-46ed-82f2-8ce4b9694d1a-6"><i class="fas fa-dragon"></i>è§„åˆ™6</button></li><li class="tab"><button type="button" data-href="#0d60299e-3ed8-46ed-82f2-8ce4b9694d1a-7"><i class="fas fa-horse"></i>è§„åˆ™7</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="0d60299e-3ed8-46ed-82f2-8ce4b9694d1a-1"><p>çº¿ç¨‹è§£é” m ä¹‹å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºæ¥ä¸‹æ¥å¯¹ m åŠ é”çš„å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§(synchronizedå…³é”®å­—çš„å¯è§æ€§ã€ç›‘è§†å™¨è§„åˆ™)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> x;</span><br><span class="line"><span class="keyword">static</span> <span class="type">Object</span> <span class="variable">m</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(m) &#123;</span><br><span class="line">        x = <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(m) &#123;</span><br><span class="line">        System.out.println(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0d60299e-3ed8-46ed-82f2-8ce4b9694d1a-2"><p>çº¿ç¨‹å¯¹ volatile å˜é‡çš„å†™ï¼Œå¯¹æ¥ä¸‹æ¥å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§(volatileå…³é”®å­—çš„å¯è§æ€§ã€volatileè§„åˆ™)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> <span class="keyword">static</span> <span class="type">int</span> x;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">    x = <span class="number">10</span>;</span><br><span class="line">&#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">    System.out.println(x);</span><br><span class="line">&#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0d60299e-3ed8-46ed-82f2-8ce4b9694d1a-3"><p>çº¿ç¨‹ start å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹è¯¥çº¿ç¨‹å¼€å§‹åå¯¹è¯¥å˜é‡çš„è¯»å¯è§(ç¨‹åºé¡ºåºè§„åˆ™+çº¿ç¨‹å¯åŠ¨è§„åˆ™)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> x;</span><br><span class="line">x = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">    System.out.println(x);</span><br><span class="line">&#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0d60299e-3ed8-46ed-82f2-8ce4b9694d1a-4"><p>çº¿ç¨‹ç»“æŸå‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹å…¶å®ƒçº¿ç¨‹å¾—çŸ¥å®ƒç»“æŸåçš„è¯»å¯è§ï¼ˆæ¯”å¦‚å…¶å®ƒçº¿ç¨‹è°ƒç”¨ t1.isAlive() æˆ– t1.join()ç­‰å¾… å®ƒç»“æŸï¼‰(çº¿ç¨‹ç»ˆæ­¢è§„åˆ™)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> x;</span><br><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">    x = <span class="number">10</span>;</span><br><span class="line">&#125;,<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">t1.start();</span><br><span class="line">t1.join();</span><br><span class="line">System.out.println(x);</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0d60299e-3ed8-46ed-82f2-8ce4b9694d1a-5"><p>çº¿ç¨‹ t1 æ‰“æ–­ t2ï¼ˆinterruptï¼‰å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹å¾—çŸ¥ t2 è¢«æ‰“æ–­åå¯¹å˜é‡çš„è¯»å¯è§ï¼ˆé€šè¿‡ t2.interrupted æˆ– t2.isInterruptedï¼‰ï¼ˆçº¿ç¨‹ä¸­æ–­æœºåˆ¶ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> x;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">                System.out.println(x);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    t2.start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        x = <span class="number">10</span>;</span><br><span class="line">        t2.interrupt();</span><br><span class="line">    &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    <span class="keyword">while</span>(!t2.isInterrupted()) &#123;</span><br><span class="line">        Thread.<span class="keyword">yield</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0d60299e-3ed8-46ed-82f2-8ce4b9694d1a-6"><p>å¯¹å˜é‡é»˜è®¤å€¼ï¼ˆ0ï¼Œfalseï¼Œnullï¼‰çš„å†™ï¼Œå¯¹å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0d60299e-3ed8-46ed-82f2-8ce4b9694d1a-7"><p>å…·æœ‰ä¼ é€’æ€§ï¼Œå¦‚æœ <code>x hb-&gt; y</code> å¹¶ä¸” <code>y hb-&gt; z</code> é‚£ä¹ˆæœ‰ <code>x hb-&gt; z</code> ï¼Œé…åˆ volatile çš„é˜²æŒ‡ä»¤é‡æ’ï¼Œæœ‰ä¸‹é¢çš„ä¾‹å­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> <span class="keyword">static</span> <span class="type">int</span> x;</span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> y;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; </span><br><span class="line">    y = <span class="number">10</span>;</span><br><span class="line">    x = <span class="number">20</span>;</span><br><span class="line">&#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">    <span class="comment">// x=20 å¯¹ t2 å¯è§, åŒæ—¶ y=10 ä¹Ÿå¯¹ t2 å¯è§</span></span><br><span class="line">    System.out.println(x); </span><br><span class="line">&#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></p><blockquote><p>å˜é‡éƒ½æ˜¯æŒ‡æˆå‘˜å˜é‡æˆ–é™æ€æˆå‘˜å˜é‡</p><p>å‚è€ƒï¼š ç¬¬17é¡µ</p><p>åœ¨JMMä¸­æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µå¯¹äºæˆ‘ä»¬äº†è§£JMMæœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼Œé‚£å°±æ˜¯happens-beforeè§„åˆ™ã€‚happens-beforeè§„åˆ™éå¸¸é‡è¦ï¼Œå®ƒæ˜¯åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ç«äº‰ã€çº¿ç¨‹æ˜¯å¦å®‰å…¨çš„ä¸»è¦ä¾æ®ã€‚JSR-133Sä½¿ç”¨happens-beforeæ¦‚å¿µé˜è¿°äº†ä¸¤ä¸ªæ“ä½œä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚åœ¨JMMä¸­ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œçš„ç»“æœéœ€è¦å¯¹å¦ä¸€ä¸ªæ“ä½œå¯è§ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œåˆ™å­˜åœ¨happens-beforeå…³ç³»ã€‚</p><p>é‚£ä»€ä¹ˆæ˜¯happens-beforeå‘¢ï¼Ÿåœ¨JSR-133ä¸­ï¼Œhappens-beforeå…³ç³»å®šä¹‰å¦‚ä¸‹ï¼š</p><ol><li>å¦‚æœä¸€ä¸ªæ“ä½œhappens-beforeå¦ä¸€ä¸ªæ“ä½œï¼Œé‚£ä¹ˆæ„å‘³ç€ç¬¬ä¸€ä¸ªæ“ä½œçš„ç»“æœå¯¹ç¬¬äºŒä¸ªæ“ä½œå¯è§ï¼Œè€Œä¸”ç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºå°†æ’åœ¨ç¬¬äºŒä¸ªæ“ä½œçš„å‰é¢ã€‚</li><li>ä¸¤ä¸ªæ“ä½œä¹‹é—´å­˜åœ¨happens-beforeå…³ç³»ï¼Œå¹¶ä¸æ„å‘³ç€Javaå¹³å°çš„å…·ä½“å®ç°å¿…é¡»æŒ‰ç…§happens-beforeå…³ç³»æŒ‡å®šçš„é¡ºåºæ¥æ‰§è¡Œã€‚å¦‚æœé‡æ’åºä¹‹åçš„ç»“æœï¼Œä¸æŒ‰ç…§happens-beforeå…³ç³»æ¥æ‰§è¡Œçš„ç»“æœä¸€è‡´ï¼Œé‚£ä¹ˆè¿™ç§é‡æ’åºå¹¶ä¸éæ³•ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼ŒJMMå…è®¸è¿™ç§é‡æ’åºï¼‰</li></ol><p>happens-beforeè§„åˆ™å¦‚ä¸‹ï¼š</p><ol><li>ç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸€ä¸ªæ“ä½œï¼Œhappens-beforeäºè¯¥çº¿ç¨‹ä¸­çš„ä»»æ„åç»­æ“ä½œã€‚</li><li>ç›‘è§†å™¨è§„åˆ™ï¼šå¯¹ä¸€ä¸ªé”çš„è§£é”ï¼Œhappens-beforeäºéšåå¯¹è¿™ä¸ªé”çš„åŠ é”ã€‚</li><li>volatileè§„åˆ™ï¼šå¯¹ä¸€ä¸ªvolatileå˜é‡çš„å†™ï¼Œhappens-beforeäºä»»æ„åç»­å¯¹ä¸€ä¸ªvolatileå˜é‡çš„è¯»ã€‚</li><li>ä¼ é€’æ€§ï¼šè‹¥æœA happens-before Bï¼ŒB happens-before Cï¼Œé‚£ä¹ˆA happens-before Cã€‚</li><li>çº¿ç¨‹å¯åŠ¨è§„åˆ™ï¼šThreadå¯¹è±¡çš„start()æ–¹æ³•ï¼Œhappens-beforeäºè¿™ä¸ªçº¿ç¨‹çš„ä»»æ„åç»­æ“ä½œã€‚</li><li>çº¿ç¨‹ç»ˆæ­¢è§„åˆ™ï¼šçº¿ç¨‹ä¸­çš„ä»»æ„æ“ä½œï¼Œhappens-beforeäºè¯¥çº¿ç¨‹çš„ç»ˆæ­¢ç›‘æµ‹ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡Thread.join()æ–¹æ³•ç»“æŸã€Thread.isAlive()çš„è¿”å›å€¼ç­‰æ‰‹æ®µæ£€æµ‹åˆ°çº¿ç¨‹å·²ç»ç»ˆæ­¢æ‰§è¡Œã€‚</li><li>çº¿ç¨‹ä¸­æ–­æ“ä½œï¼šå¯¹çº¿ç¨‹interrupt()æ–¹æ³•çš„è°ƒç”¨ï¼Œhappens-beforeäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿï¼Œå¯ä»¥é€šè¿‡Thread.interrupted()æ–¹æ³•æ£€æµ‹åˆ°çº¿ç¨‹æ˜¯å¦æœ‰ä¸­æ–­å‘ç”Ÿã€‚</li><li>å¯¹è±¡ç»ˆç»“è§„åˆ™ï¼šä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆï¼Œhappens-beforeäºè¿™ä¸ªå¯¹è±¡çš„finalize()æ–¹æ³•çš„å¼€å§‹ã€‚</li></ol><p>å‚è€ƒé“¾æ¥ï¼š<a href="https://zhuanlan.zhihu.com/p/77157725">happens-beforeè§„åˆ™è§£æ - çŸ¥ä¹ (zhihu.com)</a></p></blockquote><h2 id="4-ä¹ é¢˜">4. ä¹ é¢˜</h2><h3 id="4-1-balking-æ¨¡å¼ä¹ é¢˜">4.1 balking æ¨¡å¼ä¹ é¢˜</h3><p>å¸Œæœ› doInit() æ–¹æ³•ä»…è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä¸‹é¢çš„å®ç°æ˜¯å¦æœ‰é—®é¢˜ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestVolatile</span> &#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">initialized</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (initialized) &#123; <span class="comment">//t1 t2</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; </span><br><span class="line">        doInit();<span class="comment">// t1 t2</span></span><br><span class="line">        initialized = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doInit</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><h3 id="4-2-çº¿ç¨‹å®‰å…¨å•ä¾‹ä¹ é¢˜">4.2 çº¿ç¨‹å®‰å…¨å•ä¾‹ä¹ é¢˜</h3><p>å•ä¾‹æ¨¡å¼æœ‰å¾ˆå¤šå®ç°æ–¹æ³•ï¼Œé¥¿æ±‰ã€æ‡’æ±‰ã€é™æ€å†…éƒ¨ç±»ã€æšä¸¾ç±»ï¼Œè¯•åˆ†ææ¯ç§å®ç°ä¸‹è·å–å•ä¾‹å¯¹è±¡ï¼ˆå³è°ƒç”¨ getInstanceï¼‰æ—¶çš„çº¿ç¨‹å®‰å…¨ï¼Œå¹¶æ€è€ƒæ³¨é‡Šä¸­çš„é—®é¢˜</p><blockquote><p>é¥¿æ±‰å¼ï¼šç±»åŠ è½½å°±ä¼šå¯¼è‡´è¯¥å•å®ä¾‹å¯¹è±¡è¢«åˆ›å»º</p><p>æ‡’æ±‰å¼ï¼šç±»åŠ è½½ä¸ä¼šå¯¼è‡´è¯¥å•å®ä¾‹å¯¹è±¡è¢«åˆ›å»ºï¼Œè€Œæ˜¯é¦–æ¬¡ä½¿ç”¨è¯¥å¯¹è±¡æ—¶æ‰ä¼šåˆ›å»º</p></blockquote><div class="tabs" id="7c0c5838-fe44-480d-b317-5bcc661905ce"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#7c0c5838-fe44-480d-b317-5bcc661905ce-1"><i class="fas fa-seedling"></i>é¥¿æ±‰å¼</button></li><li class="tab"><button type="button" data-href="#7c0c5838-fe44-480d-b317-5bcc661905ce-2"><i class="fas fa-leaf"></i>æšä¸¾ç±»</button></li><li class="tab"><button type="button" data-href="#7c0c5838-fe44-480d-b317-5bcc661905ce-3"><i class="fab fa-apple"></i>synchronizedæ–¹æ³•</button></li><li class="tab"><button type="button" data-href="#7c0c5838-fe44-480d-b317-5bcc661905ce-4"><i class="fas fa-tree"></i>DCL+volatile</button></li><li class="tab"><button type="button" data-href="#7c0c5838-fe44-480d-b317-5bcc661905ce-5"><i class="fas fa-fire-alt"></i>å†…éƒ¨ç±»åˆå§‹åŒ–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="7c0c5838-fe44-480d-b317-5bcc661905ce-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é—®é¢˜1ï¼šä¸ºä»€ä¹ˆåŠ  final(é˜²æ­¢è¢«å­ç±»ç»§æ‰¿ä»è€Œé‡å†™æ–¹æ³•æ”¹å†™å•ä¾‹)</span></span><br><span class="line"><span class="comment">// é—®é¢˜2ï¼šå¦‚æœå®ç°äº†åºåˆ—åŒ–æ¥å£, è¿˜è¦åšä»€ä¹ˆæ¥é˜²æ­¢ååºåˆ—åŒ–ç ´åå•ä¾‹(é‡å†™readResolveæ–¹æ³•)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">// é—®é¢˜3ï¼šä¸ºä»€ä¹ˆè®¾ç½®ä¸ºç§æœ‰? æ˜¯å¦èƒ½é˜²æ­¢åå°„åˆ›å»ºæ–°çš„å®ä¾‹?(é˜²æ­¢å¤–éƒ¨è°ƒç”¨æ„é€ æ–¹æ³•åˆ›å»ºå¤šä¸ªå®ä¾‹ï¼›ä¸èƒ½)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    <span class="comment">// é—®é¢˜4ï¼šè¿™æ ·åˆå§‹åŒ–æ˜¯å¦èƒ½ä¿è¯å•ä¾‹å¯¹è±¡åˆ›å»ºæ—¶çš„çº¿ç¨‹å®‰å…¨?(èƒ½ï¼Œçº¿ç¨‹å®‰å…¨æ€§ç”±ç±»åŠ è½½å™¨ä¿éšœ)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Singleton</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">    <span class="comment">// é—®é¢˜5ï¼šä¸ºä»€ä¹ˆæä¾›é™æ€æ–¹æ³•è€Œä¸æ˜¯ç›´æ¥å°† INSTANCE è®¾ç½®ä¸º public, è¯´å‡ºä½ çŸ¥é“çš„ç†ç”±(å¯ä»¥ä¿è¯instanceçš„å®‰å…¨æ€§ï¼Œä¹Ÿèƒ½æ–¹ä¾¿å®ç°ä¸€äº›é™„åŠ é€»è¾‘)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">readResolve</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="7c0c5838-fe44-480d-b317-5bcc661905ce-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é—®é¢˜1ï¼šæšä¸¾å•ä¾‹æ˜¯å¦‚ä½•é™åˆ¶å®ä¾‹ä¸ªæ•°çš„ (æšä¸¾ç±»ä¼šæŒ‰ç…§å£°æ˜çš„ä¸ªæ•°åœ¨ç±»åŠ è½½æ—¶å®ä¾‹åŒ–å¯¹è±¡)</span></span><br><span class="line"><span class="comment">// é—®é¢˜2ï¼šæšä¸¾å•ä¾‹åœ¨åˆ›å»ºæ—¶æ˜¯å¦æœ‰å¹¶å‘é—®é¢˜(æ²¡æœ‰ï¼Œç”±ç±»åŠ è½½å™¨ä¿éšœå®‰å…¨æ€§)</span></span><br><span class="line"><span class="comment">// é—®é¢˜3ï¼šæšä¸¾å•ä¾‹èƒ½å¦è¢«åå°„ç ´åå•ä¾‹(ä¸èƒ½)</span></span><br><span class="line"><span class="comment">// é—®é¢˜4ï¼šæšä¸¾å•ä¾‹èƒ½å¦è¢«ååºåˆ—åŒ–ç ´åå•ä¾‹(ä¸èƒ½)</span></span><br><span class="line"><span class="comment">// é—®é¢˜5ï¼šæšä¸¾å•ä¾‹å±äºæ‡’æ±‰å¼è¿˜æ˜¯é¥¿æ±‰å¼(é¥¿æ±‰)</span></span><br><span class="line"><span class="comment">// é—®é¢˜6ï¼šæšä¸¾å•ä¾‹å¦‚æœå¸Œæœ›åŠ å…¥ä¸€äº›å•ä¾‹åˆ›å»ºæ—¶çš„åˆå§‹åŒ–é€»è¾‘è¯¥å¦‚ä½•åš(å†™æ„é€ æ–¹æ³•)</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line">    <span class="keyword">public</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="7c0c5838-fe44-480d-b317-5bcc661905ce-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Singleton</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// åˆ†æè¿™é‡Œçš„çº¿ç¨‹å®‰å…¨, å¹¶è¯´æ˜æœ‰ä»€ä¹ˆç¼ºç‚¹(æ²¡æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ŒåŒæ­¥ä»£ç å—ç²’åº¦å¤ªå¤§ï¼Œæ€§èƒ½å·®)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>( INSTANCE != <span class="literal">null</span> )&#123;</span><br><span class="line">            <span class="keyword">return</span> INSTANCE;</span><br><span class="line">        &#125; </span><br><span class="line">        INSTANCE = <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="7c0c5838-fe44-480d-b317-5bcc661905ce-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="comment">// é—®é¢˜1ï¼šè§£é‡Šä¸ºä»€ä¹ˆè¦åŠ  volatile ?(é˜²æ­¢putstaticå’Œinvokespecialé‡æ’å¯¼è‡´çš„å¼‚å¸¸)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">Singleton</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é—®é¢˜2ï¼šå¯¹æ¯”å®ç°3, è¯´å‡ºè¿™æ ·åšçš„æ„ä¹‰ (ç¼©å°äº†é”çš„ç²’åº¦ï¼Œæé«˜äº†æ€§èƒ½)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (INSTANCE != <span class="literal">null</span>) &#123; </span><br><span class="line">            <span class="keyword">return</span> INSTANCE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (Singleton.class) &#123; </span><br><span class="line">            <span class="comment">// é—®é¢˜3ï¼šä¸ºä»€ä¹ˆè¿˜è¦åœ¨è¿™é‡ŒåŠ ä¸ºç©ºåˆ¤æ–­, ä¹‹å‰ä¸æ˜¯åˆ¤æ–­è¿‡äº†å—</span></span><br><span class="line">            <span class="keyword">if</span> (INSTANCE != <span class="literal">null</span>) &#123; <span class="comment">// t2 </span></span><br><span class="line">                <span class="keyword">return</span> INSTANCE;</span><br><span class="line">            &#125;</span><br><span class="line">            INSTANCE = <span class="keyword">new</span> <span class="title class_">Singleton</span>(); </span><br><span class="line">            <span class="keyword">return</span> INSTANCE;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="7c0c5838-fe44-480d-b317-5bcc661905ce-5"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="comment">// é—®é¢˜1ï¼šå±äºæ‡’æ±‰å¼è¿˜æ˜¯é¥¿æ±‰å¼</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LazyHolder</span> &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Singleton</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é—®é¢˜2ï¼šåœ¨åˆ›å»ºæ—¶æ˜¯å¦æœ‰å¹¶å‘é—®é¢˜</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> LazyHolder.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>]]></content>
    
    
    <summary type="html">å­¦ä¹ å…±äº«å˜é‡åœ¨å¤šçº¿ç¨‹é—´çš„ã€å¯è§æ€§ã€‘é—®é¢˜ä¸å¤šæ¡æŒ‡ä»¤æ‰§è¡Œæ—¶çš„ã€æœ‰åºæ€§ã€‘é—®é¢˜</summary>
    
    
    
    <category term="Java" scheme="https://luckylittleboy.gitee.io/categories/Java/"/>
    
    
    <category term="JUC" scheme="https://luckylittleboy.gitee.io/tags/JUC/"/>
    
  </entry>
  
  <entry>
    <title>3.å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹</title>
    <link href="https://luckylittleboy.gitee.io/posts/3f9c0b8e.html"/>
    <id>https://luckylittleboy.gitee.io/posts/3f9c0b8e.html</id>
    <published>2023-03-29T00:38:55.000Z</published>
    <updated>2023-04-02T03:27:03.099Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-å…±äº«å¸¦æ¥çš„é—®é¢˜">1. å…±äº«å¸¦æ¥çš„é—®é¢˜</h2><h3 id="1-1-å°æ•…äº‹-ç¤ºä¾‹">1.1 å°æ•…äº‹&amp;ç¤ºä¾‹</h3><div class="tabs" id="632e1c38-4593-41ef-a8ce-7bda29448e44"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#632e1c38-4593-41ef-a8ce-7bda29448e44-1"><i class="fas fa-seedling"></i>å°æ•…äº‹-1</button></li><li class="tab"><button type="button" data-href="#632e1c38-4593-41ef-a8ce-7bda29448e44-2"><i class="fas fa-leaf"></i>å°æ•…äº‹-2</button></li><li class="tab"><button type="button" data-href="#632e1c38-4593-41ef-a8ce-7bda29448e44-3"><i class="fab fa-apple"></i>å°æ•…äº‹-3</button></li><li class="tab"><button type="button" data-href="#632e1c38-4593-41ef-a8ce-7bda29448e44-4"><i class="fas fa-seedling"></i>å°æ•…äº‹-4</button></li><li class="tab"><button type="button" data-href="#632e1c38-4593-41ef-a8ce-7bda29448e44-5"><i class="fas fa-leaf"></i>Javaä»£ç ç¤ºä¾‹</button></li><li class="tab"><button type="button" data-href="#632e1c38-4593-41ef-a8ce-7bda29448e44-6"><i class="fab fa-apple"></i>è¾“å‡º&åˆ†æ</button></li><li class="tab"><button type="button" data-href="#632e1c38-4593-41ef-a8ce-7bda29448e44-7"><i class="fas fa-tree"></i>ç»“è®º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="632e1c38-4593-41ef-a8ce-7bda29448e44-1"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230329085103871.png" alt="image-20230329085103871"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="632e1c38-4593-41ef-a8ce-7bda29448e44-2"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230329085149594.png" alt="image-20230329085149594"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="632e1c38-4593-41ef-a8ce-7bda29448e44-3"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230329085218114.png" alt="image-20230329085218114"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="632e1c38-4593-41ef-a8ce-7bda29448e44-4"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230329085726138.png" alt="image-20230329085726138"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="632e1c38-4593-41ef-a8ce-7bda29448e44-5"><p>ä¸¤ä¸ªçº¿ç¨‹å¯¹åˆå§‹å€¼ä¸º 0 çš„é™æ€å˜é‡ä¸€ä¸ªåšè‡ªå¢ï¼Œä¸€ä¸ªåšè‡ªå‡ï¼Œå„åš 5000 æ¬¡ï¼Œç»“æœæ˜¯ 0 å—ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">            counter++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">            counter--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">    log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>,counter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="632e1c38-4593-41ef-a8ce-7bda29448e44-6"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">09</span><span class="string">:00:59.709</span> <span class="string">c.Test1</span> [<span class="string">main</span>] <span class="bullet">-</span> <span class="number">0</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="number">09</span><span class="string">:01:20.733</span> <span class="string">c.Test1</span> [<span class="string">main</span>] <span class="bullet">-</span> <span class="number">-55</span></span><br></pre></td></tr></table></figure><p>é—®é¢˜åˆ†æ</p><p>ä»¥ä¸Šçš„ç»“æœå¯èƒ½æ˜¯æ­£æ•°ã€è´Ÿæ•°ã€é›¶ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ<code>åˆ†æ—¶ç³»ç»Ÿ</code>,å°±å¯èƒ½ä¼šäº§ç”ŸæŒ‡ä»¤çš„äº¤é”™ã€‚ å› ä¸º Java ä¸­å¯¹é™æ€å˜é‡çš„è‡ªå¢ï¼Œè‡ªå‡å¹¶ä¸æ˜¯åŸå­æ“ä½œï¼Œè¦å½»åº•ç†è§£ï¼Œå¿…é¡»ä»å­—èŠ‚ç æ¥è¿›è¡Œåˆ†æ</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230329090622052.png" alt="image-20230329090622052"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="632e1c38-4593-41ef-a8ce-7bda29448e44-7"><p>å¦‚æœæ˜¯å•çº¿ç¨‹ä»¥ä¸Š 8 è¡Œä»£ç æ˜¯é¡ºåºæ‰§è¡Œï¼ˆä¸ä¼šäº¤é”™ï¼‰æ²¡æœ‰é—®é¢˜ï¼Œä½†å¤šçº¿ç¨‹ä¸‹è¿™ 8 è¡Œä»£ç å¯èƒ½äº¤é”™è¿è¡Œã€‚</p><div class="tabs" id="95484648-9d8c-40dd-807b-5c62202541c5"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#95484648-9d8c-40dd-807b-5c62202541c5-1">å•çº¿ç¨‹</button></li><li class="tab"><button type="button" data-href="#95484648-9d8c-40dd-807b-5c62202541c5-2">å¤šçº¿ç¨‹-1</button></li><li class="tab"><button type="button" data-href="#95484648-9d8c-40dd-807b-5c62202541c5-3">å¤šçº¿ç¨‹-2</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="95484648-9d8c-40dd-807b-5c62202541c5-1"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230329091004566.png" alt="image-20230329091004566" style="zoom: 33%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="95484648-9d8c-40dd-807b-5c62202541c5-2"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230329091037804.png" alt="image-20230329091037804" style="zoom: 33%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="95484648-9d8c-40dd-807b-5c62202541c5-3"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230329091110387.png" alt="image-20230329091110387" style="zoom: 33%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="1-2-ä¸´ç•ŒåŒº-ç«æ€æ¡ä»¶">1.2 ä¸´ç•ŒåŒº&amp;ç«æ€æ¡ä»¶</h3><ul><li><p>ä¸€ä¸ªç¨‹åºè¿è¡Œå¤šä¸ªçº¿ç¨‹æœ¬èº«æ˜¯æ²¡æœ‰é—®é¢˜çš„</p></li><li><p>é—®é¢˜å‡ºåœ¨å¤šä¸ªçº¿ç¨‹è®¿é—®<code>å…±äº«èµ„æº </code></p><ul><li><p>å¤šä¸ªçº¿ç¨‹è¯»<code>å…±äº«èµ„æº</code>å…¶å®ä¹Ÿæ²¡æœ‰é—®é¢˜</p></li><li><p>åœ¨å¤šä¸ªçº¿ç¨‹å¯¹<code>å…±äº«èµ„æº</code>è¯»å†™æ“ä½œæ—¶å‘ç”ŸæŒ‡ä»¤äº¤é”™ï¼Œå°±ä¼šå‡ºç°é—®é¢˜</p></li></ul></li><li><p>ä¸€æ®µä»£ç å—å†…å¦‚æœå­˜åœ¨å¯¹å…±äº«èµ„æºçš„å¤šçº¿ç¨‹è¯»å†™æ“ä½œï¼Œç§°è¿™æ®µä»£ç å—ä¸º<code>ä¸´ç•ŒåŒº</code></p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span>  &#123;</span><br><span class="line">    <span class="comment">// ä¸´ç•ŒåŒº</span></span><br><span class="line">    counter++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">decrement</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// ä¸´ç•ŒåŒº</span></span><br><span class="line">    counter--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤šä¸ªçº¿ç¨‹åœ¨<code>ä¸´ç•ŒåŒº</code>å†…æ‰§è¡Œï¼Œç”±äºä»£ç çš„æ‰§è¡Œåºåˆ—ä¸åŒè€Œå¯¼è‡´ç»“æœæ— æ³•é¢„æµ‹ï¼Œç§°ä¹‹ä¸ºå‘ç”Ÿäº†<code>ç«æ€æ¡ä»¶</code></p><h2 id="2-synchronized-è§£å†³æ–¹æ¡ˆ">2. synchronized è§£å†³æ–¹æ¡ˆ</h2><span class='p green'>åº”ç”¨->äº’æ–¥</span> <p>ä¸ºäº†é¿å…ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼Œæœ‰å¤šç§æ‰‹æ®µå¯ä»¥è¾¾åˆ°ç›®çš„ã€‚</p><ul><li>é˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šsynchronizedï¼ŒLock</li><li>éé˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šåŸå­å˜é‡</li></ul><p>æœ¬æ¬¡è¯¾ä½¿ç”¨é˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šsynchronizedï¼Œæ¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå³ä¿—ç§°çš„ã€å¯¹è±¡é”ã€‘ï¼Œå®ƒé‡‡ç”¨äº’æ–¥çš„æ–¹å¼è®©åŒä¸€ æ—¶åˆ»è‡³å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰ã€å¯¹è±¡é”ã€‘ï¼Œå…¶å®ƒçº¿ç¨‹å†æƒ³è·å–è¿™ä¸ªã€å¯¹è±¡é”ã€‘æ—¶å°±ä¼šé˜»å¡ä½ã€‚è¿™æ ·å°±èƒ½ä¿è¯æ‹¥æœ‰é” çš„çº¿ç¨‹å¯ä»¥å®‰å…¨çš„æ‰§è¡Œä¸´ç•ŒåŒºå†…çš„ä»£ç ï¼Œä¸ç”¨æ‹…å¿ƒçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</p><blockquote><p><strong>æ³¨æ„</strong></p><p>è™½ç„¶ java ä¸­äº’æ–¥å’ŒåŒæ­¥éƒ½å¯ä»¥é‡‡ç”¨ synchronized å…³é”®å­—æ¥å®Œæˆï¼Œä½†å®ƒä»¬è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼š</p><ul><li>äº’æ–¥æ˜¯ä¿è¯ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸´ç•ŒåŒºä»£ç </li><li>åŒæ­¥æ˜¯ç”±äºçº¿ç¨‹æ‰§è¡Œçš„å…ˆåã€é¡ºåºä¸åŒã€éœ€è¦ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å…¶å®ƒçº¿ç¨‹è¿è¡Œåˆ°æŸä¸ªç‚¹</li></ul></blockquote><h3 id="2-1-synchronized">2.1 synchronized</h3><div class="tabs" id="8e7661b7-b5d5-49ff-875f-881747f1d8ff"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#8e7661b7-b5d5-49ff-875f-881747f1d8ff-1"><i class="fas fa-seedling"></i>è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#8e7661b7-b5d5-49ff-875f-881747f1d8ff-2"><i class="fas fa-leaf"></i>è§£å†³</button></li><li class="tab"><button type="button" data-href="#8e7661b7-b5d5-49ff-875f-881747f1d8ff-3"><i class="fab fa-apple"></i>åˆ†æ</button></li><li class="tab"><button type="button" data-href="#8e7661b7-b5d5-49ff-875f-881747f1d8ff-4"><i class="fas fa-tree"></i>æµç¨‹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="8e7661b7-b5d5-49ff-875f-881747f1d8ff-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(å¯¹è±¡)</span><br><span class="line">&#123;</span><br><span class="line">    ä¸´ç•ŒåŒº</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8e7661b7-b5d5-49ff-875f-881747f1d8ff-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">room</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                counter++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                counter--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">    log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>,counter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8e7661b7-b5d5-49ff-875f-881747f1d8ff-3"><p>ä½ å¯ä»¥åšè¿™æ ·çš„ç±»æ¯”ï¼š</p><ul><li>synchronized(å¯¹è±¡) ä¸­çš„å¯¹è±¡ï¼Œå¯ä»¥æƒ³è±¡ä¸ºä¸€ä¸ªæˆ¿é—´ï¼ˆroomï¼‰ï¼Œæœ‰å”¯ä¸€å…¥å£ï¼ˆé—¨ï¼‰æˆ¿é—´åªèƒ½ä¸€æ¬¡è¿›å…¥ä¸€äººè¿›è¡Œè®¡ç®—ï¼Œçº¿ç¨‹ t1ï¼Œt2 æƒ³è±¡æˆä¸¤ä¸ªäºº</li><li>çº¿ç¨‹ t1 æ‰§è¡Œåˆ° synchronized(room) æ—¶å°±å¥½æ¯” t1 è¿›å…¥äº†è¿™ä¸ªæˆ¿é—´ï¼Œå¹¶é”ä½äº†é—¨æ‹¿èµ°äº†é’¥åŒ™ï¼Œåœ¨é—¨å†…æ‰§è¡Œcount++ ä»£ç </li><li>è¿™æ—¶å€™å¦‚æœ t2 ä¹Ÿè¿è¡Œåˆ°äº† synchronized(room) æ—¶ï¼Œå®ƒå‘ç°é—¨è¢«é”ä½äº†ï¼Œåªèƒ½åœ¨é—¨å¤–ç­‰å¾…ï¼Œå‘ç”Ÿäº†ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œé˜»å¡ä½äº†</li><li>è¿™ä¸­é—´å³ä½¿ t1 çš„ cpu æ—¶é—´ç‰‡ä¸å¹¸ç”¨å®Œï¼Œè¢«è¸¢å‡ºäº†é—¨å¤–ï¼ˆä¸è¦é”™è¯¯ç†è§£ä¸ºé”ä½äº†å¯¹è±¡å°±èƒ½ä¸€ç›´æ‰§è¡Œä¸‹å»å“¦ï¼‰ï¼Œè¿™æ—¶é—¨è¿˜æ˜¯é”ä½çš„ï¼Œt1 ä»æ‹¿ç€é’¥åŒ™ï¼Œt2 çº¿ç¨‹è¿˜åœ¨é˜»å¡çŠ¶æ€è¿›ä¸æ¥ï¼Œåªæœ‰ä¸‹æ¬¡è½®åˆ° t1 è‡ªå·±å†æ¬¡è·å¾—æ—¶é—´ç‰‡æ—¶æ‰èƒ½å¼€é—¨è¿›å…¥</li><li>å½“ t1 æ‰§è¡Œå®Œ synchronized{} å—å†…çš„ä»£ç ï¼Œè¿™æ—¶å€™æ‰ä¼šä» obj æˆ¿é—´å‡ºæ¥å¹¶è§£å¼€é—¨ä¸Šçš„é”ï¼Œå”¤é†’ t2 çº¿ç¨‹æŠŠé’¥åŒ™ç»™ä»–ã€‚t2 çº¿ç¨‹è¿™æ—¶æ‰å¯ä»¥è¿›å…¥ obj æˆ¿é—´ï¼Œé”ä½äº†é—¨æ‹¿ä¸Šé’¥åŒ™ï¼Œæ‰§è¡Œå®ƒçš„ count-- ä»£ç </li></ul><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230329093820961.png" alt="image-20230329093820961" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8e7661b7-b5d5-49ff-875f-881747f1d8ff-4"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230329093343861.png" alt="image-20230329093343861" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>synchronized å®é™…æ˜¯ç”¨å¯¹è±¡é”ä¿è¯äº†ä¸´ç•ŒåŒºå†…ä»£ç çš„åŸå­æ€§ï¼Œä¸´ç•ŒåŒºå†…çš„ä»£ç å¯¹å¤–æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œä¸ä¼šè¢«çº¿ç¨‹åˆ‡æ¢æ‰€æ‰“æ–­ã€‚</p><p>ä¸ºäº†åŠ æ·±ç†è§£ï¼Œè¯·æ€è€ƒä¸‹é¢çš„é—®é¢˜</p><ul><li>å¦‚æœæŠŠ synchronized(obj) æ”¾åœ¨ for å¾ªç¯çš„å¤–é¢ï¼Œå¦‚ä½•ç†è§£ï¼Ÿ-- åŸå­æ€§</li><li>å¦‚æœ t1 synchronized(obj1) è€Œ t2 synchronized(obj2) ä¼šæ€æ ·è¿ä½œï¼Ÿ-- é”å¯¹è±¡</li><li>å¦‚æœ t1 synchronized(obj) è€Œ t2 æ²¡æœ‰åŠ ä¼šæ€ä¹ˆæ ·ï¼Ÿå¦‚ä½•ç†è§£ï¼Ÿ-- é”å¯¹è±¡</li></ul><h3 id="2-2-é¢å‘å¯¹è±¡æ”¹è¿›">2.2 é¢å‘å¯¹è±¡æ”¹è¿›</h3><p>æŠŠéœ€è¦ä¿æŠ¤çš„å…±äº«å˜é‡æ”¾å…¥ä¸€ä¸ªç±»</p><div class="tabs" id="888d00e1-d8b1-4d7f-97e3-7d7cc5a4aa6a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#888d00e1-d8b1-4d7f-97e3-7d7cc5a4aa6a-1"><i class="fas fa-seedling"></i>é”å¯¹è±¡</button></li><li class="tab"><button type="button" data-href="#888d00e1-d8b1-4d7f-97e3-7d7cc5a4aa6a-2"><i class="fas fa-leaf"></i>ç¤ºä¾‹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="888d00e1-d8b1-4d7f-97e3-7d7cc5a4aa6a-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Room</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            value++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decrement</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            value--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="888d00e1-d8b1-4d7f-97e3-7d7cc5a4aa6a-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Room</span> <span class="variable">room</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Room</span>();</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">            room.increment();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">            room.decrement();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">    log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, room.getCounter());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-3-æ–¹æ³•ä¸Šçš„synchronized">2.3 æ–¹æ³•ä¸Šçš„synchronized</h3><div class="tabs" id="ef394c11-045f-4cb7-b17c-c89ad509af68"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ef394c11-045f-4cb7-b17c-c89ad509af68-1"><i class="fas fa-seedling"></i>æˆå‘˜æ–¹æ³•</button></li><li class="tab"><button type="button" data-href="#ef394c11-045f-4cb7-b17c-c89ad509af68-2"><i class="fas fa-leaf"></i>é™æ€æ–¹æ³•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ef394c11-045f-4cb7-b17c-c89ad509af68-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç­‰ä»·äº</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="built_in">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ef394c11-045f-4cb7-b17c-c89ad509af68-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç­‰ä»·äº</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(Test.class) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>ä¸åŠ  synchronzied çš„æ–¹æ³•å°±å¥½æ¯”ä¸éµå®ˆè§„åˆ™çš„äººï¼Œä¸å»è€å®æ’é˜Ÿï¼ˆå¥½æ¯”ç¿»çª—æˆ·è¿›å»çš„ï¼‰</p><h3 id="2-4-â€œçº¿ç¨‹å…«é”â€">2.4 â€œçº¿ç¨‹å…«é”â€</h3><p>å°±æ˜¯è€ƒå¯Ÿ synchronized é”ä½çš„æ˜¯å“ªä¸ªå¯¹è±¡</p><div class="tabs" id="2f283a08-661c-43f8-969d-3d0bdf1d4e52"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2f283a08-661c-43f8-969d-3d0bdf1d4e52-1"><i class="fas fa-seedling"></i>æƒ…å†µä¸€</button></li><li class="tab"><button type="button" data-href="#2f283a08-661c-43f8-969d-3d0bdf1d4e52-2"><i class="fas fa-leaf"></i>æƒ…å†µäºŒ</button></li><li class="tab"><button type="button" data-href="#2f283a08-661c-43f8-969d-3d0bdf1d4e52-3"><i class="fab fa-apple"></i>æƒ…å†µä¸‰</button></li><li class="tab"><button type="button" data-href="#2f283a08-661c-43f8-969d-3d0bdf1d4e52-4"><i class="fas fa-tree"></i>æƒ…å†µå››</button></li><li class="tab"><button type="button" data-href="#2f283a08-661c-43f8-969d-3d0bdf1d4e52-5"><i class="fas fa-seedling"></i>æƒ…å†µäº”</button></li><li class="tab"><button type="button" data-href="#2f283a08-661c-43f8-969d-3d0bdf1d4e52-6"><i class="fas fa-leaf"></i>æƒ…å†µå…­</button></li><li class="tab"><button type="button" data-href="#2f283a08-661c-43f8-969d-3d0bdf1d4e52-7"><i class="fab fa-apple"></i>æƒ…å†µä¸ƒ</button></li><li class="tab"><button type="button" data-href="#2f283a08-661c-43f8-969d-3d0bdf1d4e52-8"><i class="fas fa-tree"></i>æƒ…å†µå…«</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2f283a08-661c-43f8-969d-3d0bdf1d4e52-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.b(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š â‘ ï¼š12  â‘¡ï¼š21</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2f283a08-661c-43f8-969d-3d0bdf1d4e52-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.b(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š â‘ ï¼šsleep(1)å 12  â‘¡ï¼š2 sleep(1)å 1</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2f283a08-661c-43f8-969d-3d0bdf1d4e52-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">c</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.b(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.c(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼šâ‘ ï¼š3 sleep(1) 12   â‘¡ï¼š23 sleep(1) 1  â‘¢ï¼š32 sleep(1) 1</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2f283a08-661c-43f8-969d-3d0bdf1d4e52-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n2.b(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><p>â‘ ï¼š2 sleep(1) 1</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2f283a08-661c-43f8-969d-3d0bdf1d4e52-5"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.b(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š â‘ ï¼š2 sleep(1) 1</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2f283a08-661c-43f8-969d-3d0bdf1d4e52-6"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.b(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š â‘ ï¼šsleep(1)å 12  â‘¡ï¼š2 sleep(1)å 1</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2f283a08-661c-43f8-969d-3d0bdf1d4e52-7"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n2.b(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š â‘ ï¼š2 sleep(1)å 1</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2f283a08-661c-43f8-969d-3d0bdf1d4e52-8"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n2.b(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š  â‘ ï¼šsleep(1)å 12  â‘¡ï¼š2 sleep(1)å 1</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="3-å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æ">3. å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æ</h2><p><strong>æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ</strong></p><ul><li>å¦‚æœå®ƒä»¬æ²¡æœ‰å…±äº«ï¼Œåˆ™çº¿ç¨‹å®‰å…¨</li><li>å¦‚æœå®ƒä»¬è¢«å…±äº«äº†ï¼Œæ ¹æ®å®ƒä»¬çš„çŠ¶æ€æ˜¯å¦èƒ½å¤Ÿæ”¹å˜ï¼Œåˆåˆ†ä¸¤ç§æƒ…å†µ<ul><li>å¦‚æœåªæœ‰è¯»æ“ä½œï¼Œåˆ™çº¿ç¨‹å®‰å…¨</li><li>å¦‚æœæœ‰è¯»å†™æ“ä½œï¼Œåˆ™è¿™æ®µä»£ç æ˜¯ä¸´ç•ŒåŒºï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨</li></ul></li></ul><p><strong>å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ</strong></p><ul><li>å±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„</li><li>ä½†å±€éƒ¨å˜é‡å¼•ç”¨çš„å¯¹è±¡åˆ™æœªå¿…<ul><li>å¦‚æœè¯¥å¯¹è±¡æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨è®¿é—®ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„</li><li>å¦‚æœè¯¥å¯¹è±¡é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨</li></ul></li></ul><h3 id="3-1-å±€éƒ¨å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æ">3.1 å±€éƒ¨å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æ</h3><p>å±€éƒ¨å˜é‡</p><div class="tabs" id="3f1e03cc-0bfc-4ad1-9d25-db4bcb2236b9"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#3f1e03cc-0bfc-4ad1-9d25-db4bcb2236b9-1"><i class="fas fa-seedling"></i>ä»£ç </button></li><li class="tab"><button type="button" data-href="#3f1e03cc-0bfc-4ad1-9d25-db4bcb2236b9-2"><i class="fas fa-leaf"></i>å­—èŠ‚ç </button></li><li class="tab"><button type="button" data-href="#3f1e03cc-0bfc-4ad1-9d25-db4bcb2236b9-3"><i class="fab fa-apple"></i>å›¾è§£</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="3f1e03cc-0bfc-4ad1-9d25-db4bcb2236b9-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    i++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="3f1e03cc-0bfc-4ad1-9d25-db4bcb2236b9-2"><p>æ¯ä¸ªçº¿ç¨‹è°ƒç”¨ test1() æ–¹æ³•æ—¶å±€éƒ¨å˜é‡ iï¼Œä¼šåœ¨æ¯ä¸ªçº¿ç¨‹çš„æ ˆå¸§å†…å­˜ä¸­è¢«åˆ›å»ºå¤šä»½ï¼Œå› æ­¤ä¸å­˜åœ¨å…±äº«</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span>;</span><br><span class="line"> descriptor: ()V </span><br><span class="line"> flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line"> Code:</span><br><span class="line"> stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: bipush <span class="number">10</span></span><br><span class="line"> <span class="number">2</span>: istore_0</span><br><span class="line"> <span class="number">3</span>: iinc <span class="number">0</span>, <span class="number">1</span></span><br><span class="line"> <span class="number">6</span>: <span class="keyword">return</span></span><br><span class="line"> LineNumberTable:</span><br><span class="line"> line <span class="number">10</span>: <span class="number">0</span></span><br><span class="line"> line <span class="number">11</span>: <span class="number">3</span></span><br><span class="line"> line <span class="number">12</span>: <span class="number">6</span></span><br><span class="line"> LocalVariableTable:</span><br><span class="line"> Start Length Slot Name Signature</span><br><span class="line"> <span class="number">3</span>        <span class="number">4</span>     <span class="number">0</span>   i      I</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="3f1e03cc-0bfc-4ad1-9d25-db4bcb2236b9-3"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220303005909688.png" alt="image-20220303005909688"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><p>å±€éƒ¨å˜é‡çš„å¼•ç”¨ç¨æœ‰ä¸åŒ  å…ˆçœ‹ä¸€ä¸ªæˆå‘˜å˜é‡çš„ä¾‹å­</p><div class="tabs" id="4419593a-95db-45a7-9cc7-3242fb5d02ac"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#4419593a-95db-45a7-9cc7-3242fb5d02ac-1"><i class="fas fa-seedling"></i>ä»£ç </button></li><li class="tab"><button type="button" data-href="#4419593a-95db-45a7-9cc7-3242fb5d02ac-2"><i class="fas fa-leaf"></i>æ‰§è¡Œ</button></li><li class="tab"><button type="button" data-href="#4419593a-95db-45a7-9cc7-3242fb5d02ac-3"><i class="fab fa-apple"></i>ç»“æœ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="4419593a-95db-45a7-9cc7-3242fb5d02ac-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadUnsafe</span> &#123;</span><br><span class="line">    ArrayList&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">(<span class="type">int</span> loopNumber)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            <span class="comment">// &#123; ä¸´ç•ŒåŒº, ä¼šäº§ç”Ÿç«æ€æ¡ä»¶</span></span><br><span class="line">            method2();</span><br><span class="line">            method3();</span><br><span class="line">            <span class="comment">// &#125; ä¸´ç•ŒåŒº</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;</span><br><span class="line">        list.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">method3</span><span class="params">()</span> &#123;</span><br><span class="line">        list.remove(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4419593a-95db-45a7-9cc7-3242fb5d02ac-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THREAD_NUMBER</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">LOOP_NUMBER</span> <span class="operator">=</span> <span class="number">200</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ThreadUnsafe</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadUnsafe</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; THREAD_NUMBER; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            test.method1(LOOP_NUMBER);</span><br><span class="line">        &#125;, <span class="string">&quot;Thread&quot;</span> + i).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4419593a-95db-45a7-9cc7-3242fb5d02ac-3"><p>å…¶ä¸­ä¸€ç§æƒ…å†µæ˜¯ï¼Œå¦‚æœçº¿ç¨‹2 è¿˜æœª addï¼Œçº¿ç¨‹1 remove å°±ä¼šæŠ¥é”™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">&quot;Thread1&quot;</span> java.lang.IndexOutOfBoundsException: Index: <span class="number">0</span>, Size: <span class="number">0</span> </span><br><span class="line"> at java.util.ArrayList.rangeCheck(ArrayList.java:<span class="number">657</span>) </span><br><span class="line"> at java.util.ArrayList.remove(ArrayList.java:<span class="number">496</span>) </span><br><span class="line"> at cn.itcast.n6.ThreadUnsafe.method3(TestThreadSafe.java:<span class="number">35</span>) </span><br><span class="line"> at cn.itcast.n6.ThreadUnsafe.method1(TestThreadSafe.java:<span class="number">26</span>) </span><br><span class="line"> at cn.itcast.n6.TestThreadSafe.lambda$main$<span class="number">0</span>(TestThreadSafe.java:<span class="number">14</span>) </span><br><span class="line"> at java.lang.Thread.run(Thread.java:<span class="number">748</span>) </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>åˆ†æï¼š</p><ul><li>æ— è®ºå“ªä¸ªçº¿ç¨‹ä¸­çš„ method2 å¼•ç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡ä¸­çš„ list æˆå‘˜å˜é‡</li><li>method3 ä¸ method2 åˆ†æç›¸åŒ</li></ul><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220303010311338.png" alt="image-20220303010311338" style="zoom:50%;" /><p>å°† list ä¿®æ”¹ä¸ºå±€éƒ¨å˜é‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadSafe</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">(<span class="type">int</span> loopNumber)</span> &#123;</span><br><span class="line">        ArrayList&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            method2(list);</span><br><span class="line">            method3(list);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">(ArrayList&lt;String&gt; list)</span> &#123;</span><br><span class="line">        list.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">method3</span><span class="params">(ArrayList&lt;String&gt; list)</span> &#123;</span><br><span class="line">        list.remove(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå°±ä¸ä¼šæœ‰ä¸Šè¿°é—®é¢˜äº†</p><p>åˆ†æï¼š</p><ul><li>list æ˜¯å±€éƒ¨å˜é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨æ—¶ä¼šåˆ›å»ºå…¶ä¸åŒå®ä¾‹ï¼Œæ²¡æœ‰å…±äº«</li><li>è€Œ method2 çš„å‚æ•°æ˜¯ä» method1 ä¸­ä¼ é€’è¿‡æ¥çš„ï¼Œä¸ method1 ä¸­å¼•ç”¨åŒä¸€ä¸ªå¯¹è±¡</li><li>method3 çš„å‚æ•°åˆ†æä¸ method2 ç›¸åŒ</li></ul><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220303010518661.png" alt="image-20220303010518661" style="zoom:50%;" /><p>æ–¹æ³•è®¿é—®ä¿®é¥°ç¬¦å¸¦æ¥çš„æ€è€ƒï¼Œå¦‚æœæŠŠ method2 å’Œ method3 çš„æ–¹æ³•ä¿®æ”¹ä¸º public ä¼šä¸ä¼šä»£ç†çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ</p><ul><li>æƒ…å†µ1ï¼šæœ‰å…¶å®ƒçº¿ç¨‹è°ƒç”¨ method2 å’Œ method3</li><li>æƒ…å†µ2ï¼šåœ¨ æƒ…å†µ1 çš„åŸºç¡€ä¸Šï¼Œä¸º ThreadSafe ç±»æ·»åŠ å­ç±»ï¼Œå­ç±»è¦†ç›– method2 æˆ– method3 æ–¹æ³•ï¼Œ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadSafe</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">(<span class="type">int</span> loopNumber)</span> &#123;</span><br><span class="line">        ArrayList&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            method2(list);</span><br><span class="line">            method3(list);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">(ArrayList&lt;String&gt; list)</span> &#123;</span><br><span class="line">        list.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">method3</span><span class="params">(ArrayList&lt;String&gt; list)</span> &#123;</span><br><span class="line">        list.remove(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadSafeSubClass</span> <span class="keyword">extends</span> <span class="title class_">ThreadSafe</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method3</span><span class="params">(ArrayList&lt;String&gt; list)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            list.remove(<span class="number">0</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">&quot;Thread1&quot;</span> java.lang.IndexOutOfBoundsException: Index: <span class="number">0</span>, Size: <span class="number">0</span> </span><br><span class="line"> at java.util.ArrayList.rangeCheck(ArrayList.java:<span class="number">657</span>) </span><br><span class="line"> at java.util.ArrayList.remove(ArrayList.java:<span class="number">496</span>) </span><br><span class="line"> at cn.itcast.n6.ThreadUnsafe.method3(TestThreadSafe.java:<span class="number">35</span>) </span><br><span class="line"> at cn.itcast.n6.ThreadUnsafe.method1(TestThreadSafe.java:<span class="number">26</span>) </span><br><span class="line"> at cn.itcast.n6.TestThreadSafe.lambda$main$<span class="number">0</span>(TestThreadSafe.java:<span class="number">14</span>) </span><br><span class="line"> at java.lang.Thread.run(Thread.java:<span class="number">748</span>) </span><br></pre></td></tr></table></figure><p>ä»è¿™ä¸ªä¾‹å­å¯ä»¥çœ‹å‡º private æˆ– final æä¾›ã€å®‰å…¨ã€‘çš„æ„ä¹‰æ‰€åœ¨ï¼Œè¯·ä½“ä¼šå¼€é—­åŸåˆ™ä¸­çš„ã€é—­ã€‘</p><h2 id="4-å¸¸è§çš„çº¿ç¨‹å®‰å…¨ç±»">4. å¸¸è§çš„çº¿ç¨‹å®‰å…¨ç±»</h2><ul><li>String</li><li>Integer</li><li>StringBuffer</li><li>Random</li><li>Vector</li><li>Hashtable</li><li>java.util.concurrent åŒ…ä¸‹çš„ç±»</li></ul><p>è¿™é‡Œè¯´å®ƒä»¬æ˜¯çº¿ç¨‹å®‰å…¨çš„æ˜¯æŒ‡ï¼Œå¤šä¸ªçº¿ç¨‹è°ƒç”¨å®ƒä»¬åŒä¸€ä¸ªå®ä¾‹çš„æŸä¸ªæ–¹æ³•æ—¶ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä¹Ÿå¯ä»¥ç†è§£ä¸º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Hashtable</span> <span class="variable">table</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">    table.put(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value1&quot;</span>);</span><br><span class="line">&#125;).start();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">    table.put(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value2&quot;</span>);</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure><ul><li>å®ƒä»¬çš„æ¯ä¸ªæ–¹æ³•æ˜¯åŸå­çš„</li><li>ä½†æ³¨æ„å®ƒä»¬å¤šä¸ªæ–¹æ³•çš„ç»„åˆä¸æ˜¯åŸå­çš„ï¼Œè§åé¢åˆ†æ</li></ul><h3 id="4-1-çº¿ç¨‹å®‰å…¨ç±»æ–¹æ³•çš„ç»„åˆ">4.1 çº¿ç¨‹å®‰å…¨ç±»æ–¹æ³•çš„ç»„åˆ</h3><p>åˆ†æä¸‹é¢ä»£ç æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Hashtable</span> <span class="variable">table</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line"><span class="comment">// çº¿ç¨‹1ï¼Œçº¿ç¨‹2</span></span><br><span class="line"><span class="keyword">if</span>( table.get(<span class="string">&quot;key&quot;</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">table.put(<span class="string">&quot;key&quot;</span>, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220303011322077.png" alt="image-20220303011322077"></p><h3 id="4-2-ä¸å¯å˜ç±»çº¿ç¨‹å®‰å…¨æ€§">4.2 ä¸å¯å˜ç±»çº¿ç¨‹å®‰å…¨æ€§</h3><p>Stringã€Integer ç­‰éƒ½æ˜¯ä¸å¯å˜ç±»ï¼Œå› ä¸ºå…¶å†…éƒ¨çš„çŠ¶æ€ä¸å¯ä»¥æ”¹å˜ï¼Œå› æ­¤å®ƒä»¬çš„æ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ æœ‰åŒå­¦æˆ–è®¸æœ‰ç–‘é—®ï¼ŒString æœ‰ replaceï¼Œsubstring ç­‰æ–¹æ³•ã€å¯ä»¥ã€‘æ”¹å˜å€¼å•Šï¼Œé‚£ä¹ˆè¿™äº›æ–¹æ³•åˆæ˜¯å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨çš„å‘¢ï¼Ÿ</p><p>ä»¥Stringçš„substringä¸ºä¾‹å­ï¼šä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ï¼ŒåŒ…å«æˆªå–çš„ç»“æœï¼Œç”¨æ–°çš„å¯¹è±¡æ¥å®ç°ä¸å¯å˜æ•ˆæœã€‚</p><div class="tabs" id="0ce61650-ca88-4c15-935d-8242ef1d9d88"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#0ce61650-ca88-4c15-935d-8242ef1d9d88-1"><i class="fas fa-seedling"></i>substring</button></li><li class="tab"><button type="button" data-href="#0ce61650-ca88-4c15-935d-8242ef1d9d88-2"><i class="fas fa-leaf"></i>new String</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="0ce61650-ca88-4c15-935d-8242ef1d9d88-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">substring</span><span class="params">(<span class="type">int</span> beginIndex)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (beginIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(beginIndex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">subLen</span> <span class="operator">=</span> value.length - beginIndex;</span><br><span class="line">    <span class="keyword">if</span> (subLen &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(subLen);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (beginIndex == <span class="number">0</span>) ? <span class="built_in">this</span> : <span class="keyword">new</span> <span class="title class_">String</span>(value, beginIndex, subLen);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0ce61650-ca88-4c15-935d-8242ef1d9d88-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">String</span><span class="params">(<span class="type">char</span> value[], <span class="type">int</span> offset, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (offset &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(offset);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (count &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(count);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (offset &lt;= value.length) &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = <span class="string">&quot;&quot;</span>.value;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Note: offset or count might be near -1&gt;&gt;&gt;1.</span></span><br><span class="line">    <span class="keyword">if</span> (offset &gt; value.length - count) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(offset + count);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.value = Arrays.copyOfRange(value, offset, offset+count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="4-3-å®ä¾‹åˆ†æ">4.3 å®ä¾‹åˆ†æ</h3><p>servletè¿è¡Œåœ¨Tomcatç¯å¢ƒä¸‹ï¼Œä¼šè¢«Tomcatçš„å¤šä¸ªçº¿ç¨‹å…±äº«ä½¿ç”¨ï¼Œæˆå‘˜å˜é‡éƒ½å­˜åœ¨å…±äº«é—®é¢˜</p><div class="tabs" id="c55383bb-2db1-4375-925e-f451bff12eb2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c55383bb-2db1-4375-925e-f451bff12eb2-1"><i class="fas fa-seedling"></i>ä¾‹ä¸€</button></li><li class="tab"><button type="button" data-href="#c55383bb-2db1-4375-925e-f451bff12eb2-2"><i class="fas fa-leaf"></i>ä¾‹äºŒ</button></li><li class="tab"><button type="button" data-href="#c55383bb-2db1-4375-925e-f451bff12eb2-3"><i class="fab fa-apple"></i>ä¾‹ä¸‰</button></li><li class="tab"><button type="button" data-href="#c55383bb-2db1-4375-925e-f451bff12eb2-4"><i class="fas fa-tree"></i>ä¾‹å››</button></li><li class="tab"><button type="button" data-href="#c55383bb-2db1-4375-925e-f451bff12eb2-5"><i class="fas fa-seedling"></i>ä¾‹äº”</button></li><li class="tab"><button type="button" data-href="#c55383bb-2db1-4375-925e-f451bff12eb2-6"><i class="fas fa-leaf"></i>ä¾‹å…­</button></li><li class="tab"><button type="button" data-href="#c55383bb-2db1-4375-925e-f451bff12eb2-7"><i class="fab fa-apple"></i>ä¾‹ä¸ƒ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c55383bb-2db1-4375-925e-f451bff12eb2-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿ  å¦ HashMapä¸å®‰å…¨</span></span><br><span class="line">    Map&lt;String,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿ  æ˜¯</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">S1</span> <span class="operator">=</span> <span class="string">&quot;...&quot;</span>;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿ  æ˜¯</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">S2</span> <span class="operator">=</span> <span class="string">&quot;...&quot;</span>;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿ  å¦</span></span><br><span class="line">    <span class="type">Date</span> <span class="variable">D1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿ  å¦</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Date</span> <span class="variable">D2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨ä¸Šè¿°å˜é‡</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c55383bb-2db1-4375-925e-f451bff12eb2-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿ  å¦</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserServiceImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        userService.update(...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="comment">// è®°å½•è°ƒç”¨æ¬¡æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c55383bb-2db1-4375-925e-f451bff12eb2-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿ å¦ springé»˜è®¤å•ä¾‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;execution(* *(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> &#123;</span><br><span class="line">        start = System.nanoTime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;execution(* *(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        System.out.println(<span class="string">&quot;cost time:&quot;</span> + (end-start));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c55383bb-2db1-4375-925e-f451bff12eb2-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ å®‰å…¨ serviceæœ‰æˆå‘˜å˜é‡ ä½†æ˜¯æ˜¯ç§æœ‰çš„ï¼Œæ²¡æœ‰å…¶ä»–åœ°æ–¹ä¿®æ”¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserServiceImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        userService.update(...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ daoæ²¡æœ‰æˆå‘˜å˜é‡ å®‰å…¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserDao</span> <span class="variable">userDao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserDaoImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">        userDao.update();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;update user set password = ? where username = ?&quot;</span>;</span><br><span class="line">        <span class="comment">// æ˜¯å¦å®‰å…¨ å±€éƒ¨å˜é‡ å®‰å…¨</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c55383bb-2db1-4375-925e-f451bff12eb2-5"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserServiceImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        userService.update(...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserDao</span> <span class="variable">userDao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserDaoImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">        userDao.update();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨  ä¸å®‰å…¨ æˆå‘˜å˜é‡ å¤šçº¿ç¨‹ä¸‹åˆ«äººclose</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;update user set password = ? where username = ?&quot;</span>;</span><br><span class="line">        conn = DriverManager.getConnection(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        conn.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c55383bb-2db1-4375-925e-f451bff12eb2-6"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserServiceImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        userService.update(...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">UserDao</span> <span class="variable">userDao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserDaoImpl</span>();</span><br><span class="line">        userDao.update();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ serviceæ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„dao å®‰å…¨</span></span><br><span class="line">    <span class="type">private</span> <span class="variable">Connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;update user set password = ? where username = ?&quot;</span>;</span><br><span class="line">        conn = DriverManager.getConnection(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        conn.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c55383bb-2db1-4375-925e-f451bff12eb2-7"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bar</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æ˜¯å¦å®‰å…¨</span></span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        foo(sdf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="title function_">foo</span><span class="params">(SimpleDateFormat sdf)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Test</span>().bar();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ foo çš„è¡Œä¸ºæ˜¯ä¸ç¡®å®šçš„ï¼Œå¯èƒ½å¯¼è‡´ä¸å®‰å…¨çš„å‘ç”Ÿï¼Œè¢«ç§°ä¹‹ä¸º<strong>å¤–æ˜Ÿæ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">(SimpleDateFormat sdf)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">dateStr</span> <span class="operator">=</span> <span class="string">&quot;1999-10-11 00:00:00&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sdf.parse(dateStr);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯·æ¯”è¾ƒ JDK ä¸­ String ç±»çš„å®ç°ï¼Œè®¾è®¡ä¸ºfinalï¼Œå°±æ˜¯é¿å…å­ç±»è¦†ç›–å…¶æ–¹æ³•ï¼Œå®‰å…¨çš„å°±ä¼šå˜æˆä¸å®‰å…¨çš„ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="5-Monitor-æ¦‚å¿µ">5. Monitor æ¦‚å¿µ</h2><h3 id="5-1-JAVAå¯¹è±¡å¤´">5.1 JAVAå¯¹è±¡å¤´</h3><p>â€‹    ç”±äºJavaé¢å‘å¯¹è±¡çš„æ€æƒ³ï¼Œåœ¨JVMä¸­éœ€è¦å¤§é‡å­˜å‚¨å¯¹è±¡ï¼Œå­˜å‚¨æ—¶ä¸ºäº†å®ç°ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼Œéœ€è¦åœ¨å¯¹è±¡ä¸­æ·»åŠ ä¸€äº›æ ‡è®°å­—æ®µç”¨äºå¢å¼ºå¯¹è±¡åŠŸèƒ½ï¼Œè¿™äº›æ ‡è®°å­—æ®µç»„æˆäº†å¯¹è±¡å¤´ã€‚</p><p>â€‹    å¯¹è±¡å¤´åŒ…å«ä¸¤éƒ¨åˆ†ï¼š<code>è¿è¡Œæ—¶å…ƒæ•°æ®ï¼ˆMark Wordï¼‰</code>ï¼ˆå­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼‰å’Œ<code>ç±»å‹æŒ‡é’ˆï¼ˆKlass Wordï¼‰</code></p><p>å…¶ä¸­ï¼Œè¿è¡Œæ—¶å…ƒæ•°æ®Mark Wordç»“æ„ä¸ºï¼š</p><p>å“ˆå¸Œå€¼ï¼ˆHashCodeï¼‰ï¼Œå¯ä»¥çœ‹ä½œæ˜¯å †ä¸­å¯¹è±¡çš„åœ°å€<br>GCåˆ†ä»£å¹´é¾„ï¼ˆå¹´é¾„è®¡æ•°å™¨ï¼‰ (ç”¨äºæ–°ç”Ÿä»£from/toåŒºæ™‹å‡è€å¹´ä»£çš„æ ‡å‡†, é˜ˆå€¼ä¸º15)<br>é”çŠ¶æ€æ ‡å¿— (ç”¨äºJDK1.6å¯¹synchronizedçš„ä¼˜åŒ– -&gt; è½»é‡çº§é”)<br>çº¿ç¨‹æŒæœ‰çš„é”<br>åå‘çº¿ç¨‹ID (ç”¨äºJDK1.6å¯¹synchronizedçš„ä¼˜åŒ– -&gt; åå‘é”)<br>åå‘æ—¶é—´æˆ³<br>ç±»å‹æŒ‡é’ˆï¼š æŒ‡å‘ç±»å…ƒæ•°æ®InstanceKlassï¼Œç¡®å®šè¯¥å¯¹è±¡æ‰€å±çš„ç±»å‹ã€‚æŒ‡å‘çš„å…¶å®æ˜¯æ–¹æ³•åŒºä¸­å­˜æ”¾çš„ç±»å…ƒä¿¡æ¯ï¼ŒJavaè™šæ‹Ÿæœºé€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ¥ç¡®å®šæ˜¯å“ªä¸ªç±»çš„å®ä¾‹ã€‚</p><p>ä»¥ 32 ä½è™šæ‹Ÿæœºä¸ºä¾‹</p><p>int 4å­—èŠ‚</p><p>Integer 8+4=12å­—èŠ‚</p><div class="tabs" id="55289838-2fe6-47de-800e-ff3d19e5698d"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#55289838-2fe6-47de-800e-ff3d19e5698d-1"><i class="fas fa-seedling"></i>æ™®é€šå¯¹è±¡</button></li><li class="tab"><button type="button" data-href="#55289838-2fe6-47de-800e-ff3d19e5698d-2"><i class="fas fa-leaf"></i>æ•°ç»„å¯¹è±¡</button></li><li class="tab"><button type="button" data-href="#55289838-2fe6-47de-800e-ff3d19e5698d-3"><i class="fab fa-apple"></i>32ä½Mark Wordç»“æ„</button></li><li class="tab"><button type="button" data-href="#55289838-2fe6-47de-800e-ff3d19e5698d-4"><i class="fas fa-tree"></i>64ä½Mark Wordç»“æ„</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="55289838-2fe6-47de-800e-ff3d19e5698d-1"><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|<span class="params">--------------------------------------------------------------</span>|</span><br><span class="line">|<span class="params">                    Object Header (64 bits)                   </span>|</span><br><span class="line">|<span class="params">------------------------------------</span>|-------------------------|<span class="params"></span></span><br><span class="line"><span class="params"></span>|       <span class="title class_">Mark</span> <span class="title class_">Word</span> (<span class="number">32</span> bits)          |<span class="params">   Klass Word (32 bits)  </span>|</span><br><span class="line">|<span class="params">------------------------------------</span>|-------------------------|<span class="params"></span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="55289838-2fe6-47de-800e-ff3d19e5698d-2"><p>æ•°ç»„å¯¹è±¡ï¼š<strong>æ•°ç»„å¯¹è±¡è¿˜éœ€è¦è®°å½•æ•°ç»„é•¿åº¦</strong></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|<span class="params">---------------------------------------------------------------------------------</span>|</span><br><span class="line">|<span class="params">                             Object Header (96 bits)                             </span>|</span><br><span class="line">|<span class="params">--------------------------------</span>|-----------------------|<span class="params">------------------------</span>|</span><br><span class="line">|<span class="params">        Mark Word(32bits)       </span>|   <span class="title class_">Klass</span> <span class="title class_">Word</span>(32bits)  |<span class="params">  array length(32bits)  </span>|</span><br><span class="line">|<span class="params">--------------------------------</span>|-----------------------|<span class="params">------------------------</span>|</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="55289838-2fe6-47de-800e-ff3d19e5698d-3"><p>åœ¨è¿è¡ŒæœŸé—´ï¼ŒMark Wordé‡Œå­˜å‚¨çš„æ•°æ®ä¼šéšç€é”æ ‡å¿—ä½çš„å˜åŒ–è€Œå˜åŒ–ã€‚Mark Wordå¯èƒ½å˜åŒ–ä¸ºå­˜å‚¨ä»¥ä¸‹4ä¸­æ•°æ®ï¼Œå¦‚è¡¨æ‰€ç¤ºï¼š</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">|<span class="params">-------------------------------------------------------</span>|--------------------|<span class="params"></span></span><br><span class="line"><span class="params"></span>|                  <span class="title class_">Mark</span> <span class="title class_">Word</span> (<span class="number">32</span> bits)                  |<span class="params">        State       </span>|</span><br><span class="line">|<span class="params">-------------------------------------------------------</span>|--------------------|<span class="params"></span></span><br><span class="line"><span class="params"></span>|    <span class="symbol">hashcode:</span><span class="number">25</span>  |<span class="params"> age:4 </span>|   <span class="symbol">biased_lock:</span><span class="number">0</span>   |<span class="params">   01    </span>|       <span class="title class_">Normal</span>       |<span class="params"></span></span><br><span class="line"><span class="params"></span>|-------------------------------------------------------|<span class="params">--------------------</span>|</span><br><span class="line">|<span class="params">thread:23</span>|<span class="symbol">epoch:</span><span class="number">2</span>|<span class="params"> age:4 </span>|   <span class="symbol">biased_lock:</span><span class="number">1</span>   |<span class="params">   01    </span>|       <span class="title class_">Biased</span>       |<span class="params"></span></span><br><span class="line"><span class="params"></span>|-------------------------------------------------------|<span class="params">--------------------</span>|</span><br><span class="line">|<span class="params">          ptr_to_lock_record:30              </span>|   <span class="number">00</span>    |<span class="params"> Lightweight Locked </span>|</span><br><span class="line">|<span class="params">-------------------------------------------------------</span>|--------------------|<span class="params"></span></span><br><span class="line"><span class="params"></span>|          <span class="symbol">ptr_to_heavyweight_monitor:</span><span class="number">30</span>      |<span class="params">   10    </span>| <span class="title class_">Heavyweight</span> <span class="title class_">Locked</span> |<span class="params"></span></span><br><span class="line"><span class="params"></span>|-------------------------------------------------------|<span class="params">--------------------</span>|</span><br><span class="line">|<span class="params">                                             </span>|   <span class="number">11</span>    |<span class="params">    Marked <span class="keyword">for</span> GC   </span>|</span><br><span class="line">|<span class="params">-------------------------------------------------------</span>|--------------------|<span class="params"></span></span><br></pre></td></tr></table></figure><div class="table-box"><table><thead><tr><th align="center">é”çŠ¶æ€</th><th align="center">25bit</th><th align="center">4bit</th><th align="center">1bitæ˜¯å¦æ˜¯åå‘é”</th><th align="center">2bité”æ ‡å¿—ä½</th></tr></thead><tbody><tr><td align="center">æ— é”çŠ¶æ€  </td><td align="center">å¯¹è±¡çš„HashCode</td><td align="center">å¯¹è±¡åˆ†ä»£å¹´é¾„</td><td align="center">0</td><td align="center">01</td></tr></tbody></table></div><div class="table-box"><table><tbody><tr align="center"><th rowspan="2">é”çŠ¶æ€</th><th colspan="2">25bit</th><th rowspan="2">4bit</th><th>1bit</th><th>2bit</th></tr><tr align="center"><th>23bit</th><th>2bit</th><th>æ˜¯å¦æ˜¯åå‘é”</th><th>é”æ ‡å¿—ä½</th></tr><tr align="center"><th>è½»é‡çº§é”</th><td colspan="4">æŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆ</td><td>00</td></tr><tr align="center"><th>é‡é‡çº§é”</th><td colspan="4">æŒ‡å‘äº’æ–¥é‡ï¼ˆé‡é‡çº§é”ï¼‰çš„æŒ‡é’ˆ</td><td>10</td></tr><tr align="center"><th>GCæ ‡è®°</th><td colspan="4">ç©º</td><td>11</td></tr><tr align="center"><th>åå‘é”</th><td>çº¿ç¨‹ID</td><td>Epoch</td><td>å¯¹è±¡åˆ†ä»£å¹´é¾„</td><td>1</td><td>01</td></tr></tbody></table></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="55289838-2fe6-47de-800e-ff3d19e5698d-4"><p>64 ä½è™šæ‹Ÿæœº Mark Word</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">|<span class="params">--------------------------------------------------------------------</span>|--------------------|<span class="params"></span></span><br><span class="line"><span class="params"></span>|                          <span class="title class_">Mark</span> <span class="title class_">Word</span> (<span class="number">64</span> bits)                       |<span class="params">        State       </span>|</span><br><span class="line">|<span class="params">--------------------------------------------------------------------</span>|--------------------|<span class="params"></span></span><br><span class="line"><span class="params"></span>| <span class="symbol">unused:</span><span class="number">25</span> |<span class="params"> hashcode:31 </span>| <span class="symbol">unused:</span><span class="number">1</span> |<span class="params"> age:4 </span>| <span class="symbol">biased_lock:</span><span class="number">0</span> |<span class="params">  01   </span>|        <span class="title class_">Normal</span>      |<span class="params"></span></span><br><span class="line"><span class="params"></span>|--------------------------------------------------------------------|<span class="params">--------------------</span>|</span><br><span class="line">|<span class="params"> thread:54 </span>|   <span class="symbol">epoch:</span><span class="number">2</span>   |<span class="params"> unused:1 </span>| <span class="symbol">age:</span><span class="number">4</span> |<span class="params"> biased_lock:1 </span>|  <span class="number">01</span>   |<span class="params">        Biased      </span>|</span><br><span class="line">|<span class="params">--------------------------------------------------------------------</span>|--------------------|<span class="params"></span></span><br><span class="line"><span class="params"></span>|                    <span class="symbol">ptr_to_lock_record:</span><span class="number">62</span>                   |<span class="params">  00   </span>| <span class="title class_">Lightweight</span> <span class="title class_">Locked</span> |<span class="params"></span></span><br><span class="line"><span class="params"></span>|--------------------------------------------------------------------|<span class="params">--------------------</span>|</span><br><span class="line">|<span class="params">                 ptr_to_heavyweight_monitor:62              </span>|  <span class="number">10</span>   |<span class="params"> Heavyweight Locked </span>|</span><br><span class="line">|<span class="params">--------------------------------------------------------------------</span>|--------------------|<span class="params"></span></span><br><span class="line"><span class="params"></span>|                                                            |<span class="params">  11   </span>|    <span class="title class_">Marked</span> <span class="keyword">for</span> <span class="variable constant_">GC</span>   |<span class="params"></span></span><br><span class="line"><span class="params"></span>|--------------------------------------------------------------------|<span class="params">--------------------</span>|</span><br></pre></td></tr></table></figure><div class="table-box"><table><tbody><tr align="center"><th rowspan="2">é”çŠ¶æ€</th><th>25bit</th><th>31bit</th><th>1bit</th><th>4bit</th><th>1bit</th><th>2bit</th></tr><tr align="center"><th></th><th></th><th>cms_free</th><th>åˆ†ä»£å¹´é¾„</th><th>åå‘é”</th><th>é”æ ‡å¿—ä½</th></tr><tr align="center"><th>æ— é”</th><td>unused</td><td>HashCode</td><td></td><td></td><td>0</td><td>01</td></tr><tr align="center"><th>åå‘é”</th><td colspan="2">ThreadID(54bit) Epoch(2bit)</td><td></td><td></td><td>1</td><td>01</td></tr></tbody></table></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="5-2-Monitor-é”">5.2 Monitor(é”)</h3><p>Monitor è¢«ç¿»è¯‘ä¸º<code>ç›‘è§†å™¨</code>æˆ–<code>ç®¡ç¨‹</code></p><p>Monitorå·¥ä½œåŸç†ï¼š</p><p>æ¯ä¸ª Java å¯¹è±¡éƒ½å¯ä»¥å…³è”ä¸€ä¸ª Monitor å¯¹è±¡ï¼Œå¦‚æœä½¿ç”¨ synchronized ç»™å¯¹è±¡ä¸Šé”<code>ï¼ˆé‡é‡çº§ï¼‰</code>ä¹‹åï¼Œè¯¥å¯¹è±¡å¤´çš„ Mark Word ä¸­å°±è¢«è®¾ç½®æŒ‡å‘ Monitor å¯¹è±¡çš„æŒ‡é’ˆï¼ŒåŸæœ¬Mark Wordå½“ä¸­çš„å†…å®¹ä¼šå­˜å‚¨åˆ°Monitorå½“ä¸­ï¼Œé‡Šæ”¾æ—¶ä¼šå–å‡ºè¿™äº›å†…å®¹å†æ¬¡æ”¾åˆ°Mark Wordã€‚</p><div class="tabs" id="253d8353-d44d-448f-97c6-9db8e2a858ec"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#253d8353-d44d-448f-97c6-9db8e2a858ec-1"><i class="fas fa-cat"></i>1</button></li><li class="tab"><button type="button" data-href="#253d8353-d44d-448f-97c6-9db8e2a858ec-2"><i class="fas fa-horse"></i>2</button></li><li class="tab"><button type="button" data-href="#253d8353-d44d-448f-97c6-9db8e2a858ec-3"><i class="fas fa-dove"></i>3</button></li><li class="tab"><button type="button" data-href="#253d8353-d44d-448f-97c6-9db8e2a858ec-4"><i class="fas fa-dragon"></i>4</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="253d8353-d44d-448f-97c6-9db8e2a858ec-1"><p>çº¿ç¨‹2 è¦æ¥æ‰§è¡Œä¸´ç•ŒåŒºä»£ç ï¼Œæ‰§è¡Œè¿™æ®µä»£ç æ—¶ï¼Œå°±ä¼šæŠŠè¿™ä¸ªJavaä¸­çš„objå¯¹è±¡ä¸æ“ä½œç³»ç»Ÿæä¾›çš„Monitorå¯¹è±¡ç›¸å…³è”ã€‚è¯¥objçš„MarkWordä¸­å°±è®°å½•äº†å®ƒçš„Monitorå¯¹è±¡çš„æŒ‡é’ˆåœ°å€ã€‚</p><p>Thread-2å°±æˆä¸ºè¿™ä¸ªMontiorçš„Owner<br><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230330131156867.png" style="zoom:50%;" /></p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230330132128736.png" alt="image-20230330132128736" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="253d8353-d44d-448f-97c6-9db8e2a858ec-2"><p>å¦‚æœè¿˜æœ‰åˆ«çš„çº¿ç¨‹ï¼Œä¹Ÿæ‰§è¡Œåˆ°ä¸´ç•ŒåŒºä»£ç ï¼Œè¯¥çº¿ç¨‹å°±ä¼šå…ˆæ£€æŸ¥ä¸€ä¸‹è¿™ä¸ªobjæœ‰æ²¡æœ‰å…³è”ä¸€ä¸ªmonitoré”ï¼Œç»“æœå‘ç°è¯¥objå·²ç»å…³è”ä¸€ä¸ªmonitoré”ï¼Œæ‰€ä»¥å°±ä¼šæ£€æŸ¥ä¸€ä¸‹è¿™ä¸ªé”æœ‰æ²¡æœ‰ä¸»äººï¼Œå‘ç°é”çš„ä¸»äººå·²ç»æ˜¯Thread-2ï¼Œè·å¾—ä¸äº†é”ã€‚Thread-1å°±å’Œè¿™ä¸ªMonitorä¸­çš„EntryListç›¸å…³è”ï¼Œå¹¶è¿›å…¥åˆ°é˜»å¡çŠ¶æ€ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230330132906262.png" style="zoom:50%;" /><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230330132834897.png" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="253d8353-d44d-448f-97c6-9db8e2a858ec-3"><p>Thread-3 åŒç†</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230330133756183.png" alt="image-20230330133756183" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="253d8353-d44d-448f-97c6-9db8e2a858ec-4"><p>å½“Thread-2æŠŠä¸´ç•ŒåŒºä»£ç éƒ½æ‰§è¡Œå®Œåï¼ŒOwnerå°±ç©ºå‡ºæ¥äº†ï¼Œä¼šé€šçŸ¥Monitorä¸­çš„EntryListä¸­çº¿ç¨‹å”¤é†’å¹¶ç«äº‰ï¼Œç«äº‰æ˜¯éå…¬å¹³çš„</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230330134054149.png" alt="image-20230330134054149" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><blockquote><p><strong>æ³¨æ„</strong>ï¼š</p><ul><li>synchronized å¿…é¡»æ˜¯è¿›å…¥åŒä¸€ä¸ªå¯¹è±¡çš„ monitor æ‰æœ‰ä¸Šè¿°çš„æ•ˆæœ</li><li>ä¸åŠ  synchronized çš„å¯¹è±¡ä¸ä¼šå…³è”ç›‘è§†å™¨ï¼Œä¸éµä»ä»¥ä¸Šè§„åˆ™</li><li>å›¾ä¸­ WaitSet ï¼Œæ˜¯ä¹‹å‰è·å¾—è¿‡é”ï¼Œä½†æ¡ä»¶ä¸æ»¡è¶³è¿›å…¥ WAITING çŠ¶æ€çš„çº¿ç¨‹ï¼Œåé¢è®² wait-notify æ—¶ä¼šåˆ†æ</li></ul></blockquote><h2 id="6-åŸç†ä¹‹-synchronized">6. åŸç†ä¹‹ synchronized</h2><div class="tabs" id="a5a6161e-0c2b-4005-9ed3-898f411eb92a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#a5a6161e-0c2b-4005-9ed3-898f411eb92a-1"><i class="fas fa-cat"></i>ä»£ç </button></li><li class="tab"><button type="button" data-href="#a5a6161e-0c2b-4005-9ed3-898f411eb92a-2"><i class="fas fa-dragon"></i>å­—èŠ‚ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="a5a6161e-0c2b-4005-9ed3-898f411eb92a-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">        counter++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a5a6161e-0c2b-4005-9ed3-898f411eb92a-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(java.lang.String[])</span>;</span><br><span class="line">descriptor: ([Ljava/lang/String;)V</span><br><span class="line">              flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">              Code:</span><br><span class="line">              stack=<span class="number">2</span>, locals=<span class="number">3</span>, args_size=<span class="number">1</span></span><br><span class="line">              <span class="number">0</span>: getstatic #<span class="number">2</span> <span class="comment">// &lt;- lockå¼•ç”¨ ï¼ˆsynchronizedå¼€å§‹ï¼‰</span></span><br><span class="line">              <span class="number">3</span>: dup</span><br><span class="line">              <span class="number">4</span>: astore_1 <span class="comment">// lockå¼•ç”¨ -&gt; slot 1</span></span><br><span class="line">              <span class="number">5</span>: monitorenter <span class="comment">// å°† lockå¯¹è±¡ MarkWord ç½®ä¸º Monitor æŒ‡é’ˆ Cå®ç°</span></span><br><span class="line">              <span class="number">6</span>: getstatic #<span class="number">3</span> <span class="comment">// &lt;- i</span></span><br><span class="line">              <span class="number">9</span>: iconst_1 <span class="comment">// å‡†å¤‡å¸¸æ•° 1</span></span><br><span class="line">              <span class="number">10</span>: iadd <span class="comment">// +1</span></span><br><span class="line">              <span class="number">11</span>: putstatic #<span class="number">3</span> <span class="comment">// -&gt; i</span></span><br><span class="line">              <span class="number">14</span>: aload_1 <span class="comment">// &lt;- lockå¼•ç”¨</span></span><br><span class="line">              <span class="number">15</span>: monitorexit <span class="comment">// å°† lockå¯¹è±¡ MarkWord é‡ç½®, å”¤é†’ EntryList</span></span><br><span class="line">              <span class="number">16</span>: goto <span class="number">24</span></span><br><span class="line">              <span class="number">19</span>: astore_2 <span class="comment">// e -&gt; slot 2 </span></span><br><span class="line">              <span class="number">20</span>: aload_1 <span class="comment">// &lt;- lockå¼•ç”¨</span></span><br><span class="line">              <span class="number">21</span>: monitorexit <span class="comment">// å°† lockå¯¹è±¡ MarkWord é‡ç½®, å”¤é†’ EntryList</span></span><br><span class="line">              <span class="number">22</span>: aload_2 <span class="comment">// &lt;- slot 2 (e)</span></span><br><span class="line">              <span class="number">23</span>: athrow <span class="comment">// throw e</span></span><br><span class="line">              <span class="number">24</span>: <span class="keyword">return</span></span><br><span class="line">              Exception table:</span><br><span class="line">              from to target type</span><br><span class="line">              <span class="number">6</span>    <span class="number">16</span>  <span class="number">19</span>    any</span><br><span class="line">              <span class="number">19</span>   <span class="number">22</span>  <span class="number">19</span>    any</span><br><span class="line">              LineNumberTable:</span><br><span class="line">              line <span class="number">8</span>: <span class="number">0</span></span><br><span class="line">              line <span class="number">9</span>: <span class="number">6</span></span><br><span class="line">              line <span class="number">10</span>: <span class="number">14</span></span><br><span class="line">              line <span class="number">11</span>: <span class="number">24</span></span><br><span class="line">              LocalVariableTable:</span><br><span class="line">              Start Length Slot Name Signature</span><br><span class="line">              <span class="number">0</span>     <span class="number">25</span>     <span class="number">0</span>    args [Ljava/lang/String;</span><br><span class="line">              StackMapTable: number_of_entries = <span class="number">2</span></span><br><span class="line">              frame_type = <span class="number">255</span> <span class="comment">/* full_frame */</span></span><br><span class="line">              offset_delta = <span class="number">19</span></span><br><span class="line">              locals = [ class <span class="string">&quot;[Ljava/lang/String;&quot;</span>, <span class="keyword">class</span> <span class="title class_">java</span>/lang/Object ]</span><br><span class="line">              stack = [ <span class="keyword">class</span> <span class="title class_">java</span>/lang/Throwable ]</span><br><span class="line">              frame_type = <span class="number">250</span> <span class="comment">/* chop */</span></span><br><span class="line">              offset_delta = <span class="number">4</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><blockquote><p><strong>æ³¨æ„</strong></p><p>æ–¹æ³•çº§åˆ«çš„ synchronized ä¸ä¼šåœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­æœ‰æ‰€ä½“ç°</p></blockquote><h2 id="8-åŸç†ä¹‹-synchronizedè¿›é˜¶">8. åŸç†ä¹‹ synchronizedè¿›é˜¶</h2><h3 id="8-1-å°æ•…äº‹">8.1 å°æ•…äº‹</h3><div class="tabs" id="342c43e6-2d14-4269-a7ef-d61a3dd67322"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#342c43e6-2d14-4269-a7ef-d61a3dd67322-1"><i class="fas fa-atom"></i>æ•…äº‹è§’è‰²</button></li><li class="tab"><button type="button" data-href="#342c43e6-2d14-4269-a7ef-d61a3dd67322-2"><i class="far fa-sun"></i>æ•…äº‹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="342c43e6-2d14-4269-a7ef-d61a3dd67322-1"><p>æ•…äº‹è§’è‰²</p><ul><li><p>è€ç‹ - JVM</p></li><li><p>å°å— - çº¿ç¨‹</p></li><li><p>å°å¥³ - çº¿ç¨‹</p></li><li><p>æˆ¿é—´ - å¯¹è±¡</p></li><li><p>æˆ¿é—´é—¨ä¸Š - é˜²ç›—é” - Monitor</p></li><li><p>æˆ¿é—´é—¨ä¸Š - å°å—ä¹¦åŒ… - è½»é‡çº§é”</p></li><li><p>æˆ¿é—´é—¨ä¸Š - åˆ»ä¸Šå°å—å¤§å - åå‘é”</p></li><li><p>æ‰¹é‡é‡åˆ»å - ä¸€ä¸ªç±»çš„åå‘é”æ’¤é”€åˆ°è¾¾ 20 é˜ˆå€¼</p></li><li><p>ä¸èƒ½åˆ»åå­— - æ‰¹é‡æ’¤é”€è¯¥ç±»å¯¹è±¡çš„åå‘é”ï¼Œè®¾ç½®è¯¥ç±»ä¸å¯åå‘</p></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="342c43e6-2d14-4269-a7ef-d61a3dd67322-2"><p>å°å—è¦ä½¿ç”¨æˆ¿é—´ä¿è¯è®¡ç®—ä¸è¢«å…¶å®ƒäººå¹²æ‰°ï¼ˆåŸå­æ€§ï¼‰ï¼Œæœ€åˆï¼Œä»–ç”¨çš„æ˜¯é˜²ç›—é”ï¼Œå½“ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶ï¼Œé”ä½é—¨ã€‚è¿™æ ·ï¼Œå³ä½¿ä»–ç¦»å¼€äº†ï¼Œåˆ«äººä¹Ÿè¿›ä¸äº†é—¨ï¼Œä»–çš„å·¥ä½œå°±æ˜¯å®‰å…¨çš„ã€‚</p><p>ä½†æ˜¯ï¼Œå¾ˆå¤šæƒ…å†µä¸‹æ²¡äººè·Ÿä»–æ¥ç«äº‰æˆ¿é—´çš„ä½¿ç”¨æƒã€‚å°å¥³æ˜¯è¦ç”¨æˆ¿é—´ï¼Œä½†ä½¿ç”¨çš„æ—¶é—´ä¸Šæ˜¯é”™å¼€çš„ï¼Œå°å—ç™½å¤©ç”¨ï¼Œå°å¥³æ™šä¸Šç”¨ã€‚æ¯æ¬¡ä¸Šé”å¤ªéº»çƒ¦äº†ï¼Œæœ‰æ²¡æœ‰æ›´ç®€å•çš„åŠæ³•å‘¢ï¼Ÿ</p><p>å°å—å’Œå°å¥³å•†é‡äº†ä¸€ä¸‹ï¼Œçº¦å®šä¸é”é—¨äº†ï¼Œè€Œæ˜¯è°ç”¨æˆ¿é—´ï¼Œè°æŠŠè‡ªå·±çš„ä¹¦åŒ…æŒ‚åœ¨é—¨å£ï¼Œä½†ä»–ä»¬çš„ä¹¦åŒ…æ ·å¼éƒ½ä¸€æ ·ï¼Œå› æ­¤æ¯æ¬¡è¿›é—¨å‰å¾—ç¿»ç¿»ä¹¦åŒ…ï¼Œçœ‹è¯¾æœ¬æ˜¯è°çš„ï¼Œå¦‚æœæ˜¯è‡ªå·±çš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¿›é—¨ï¼Œè¿™æ ·çœçš„ä¸Šé”è§£é”äº†ã€‚ä¸‡ä¸€ä¹¦åŒ…ä¸æ˜¯è‡ªå·±çš„ï¼Œé‚£ä¹ˆå°±åœ¨é—¨å¤–ç­‰ï¼Œå¹¶é€šçŸ¥å¯¹æ–¹ä¸‹æ¬¡ç”¨é”é—¨çš„æ–¹å¼ã€‚</p><p>åæ¥ï¼Œå°å¥³å›è€å®¶äº†ï¼Œå¾ˆé•¿ä¸€æ®µæ—¶é—´éƒ½ä¸ä¼šç”¨è¿™ä¸ªæˆ¿é—´ã€‚å°å—æ¯æ¬¡è¿˜æ˜¯æŒ‚ä¹¦åŒ…ï¼Œç¿»ä¹¦åŒ…ï¼Œè™½ç„¶æ¯”é”é—¨çœäº‹äº†ï¼Œä½†ä»ç„¶è§‰å¾—éº»çƒ¦ã€‚</p><p>äºæ˜¯ï¼Œå°å—å¹²è„†åœ¨é—¨ä¸Šåˆ»ä¸Šäº†è‡ªå·±çš„åå­—ï¼šã€å°å—ä¸“å±æˆ¿é—´ï¼Œå…¶å®ƒäººå‹¿ç”¨ã€‘ï¼Œä¸‹æ¬¡æ¥ç”¨æˆ¿é—´æ—¶ï¼Œåªè¦åå­—è¿˜åœ¨ï¼Œé‚£ä¹ˆè¯´æ˜æ²¡äººæ‰“æ‰°ï¼Œè¿˜æ˜¯å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨æˆ¿é—´ã€‚å¦‚æœè¿™æœŸé—´æœ‰å…¶å®ƒäººè¦ç”¨è¿™ä¸ªæˆ¿é—´ï¼Œé‚£ä¹ˆç”±ä½¿ç”¨è€…å°†å°å—åˆ»çš„åå­—æ“¦æ‰ï¼Œå‡çº§ä¸ºæŒ‚ä¹¦åŒ…çš„æ–¹å¼ã€‚</p><p>åŒå­¦ä»¬éƒ½æ”¾å‡å›è€å®¶äº†ï¼Œå°å—å°±è†¨èƒ€äº†ï¼Œåœ¨ 20 ä¸ªæˆ¿é—´åˆ»ä¸Šäº†è‡ªå·±çš„åå­—ï¼Œæƒ³è¿›å“ªä¸ªè¿›å“ªä¸ªã€‚åæ¥ä»–è‡ªå·±æ”¾å‡å›è€å®¶äº†ï¼Œè¿™æ—¶å°å¥³å›æ¥äº†ï¼ˆå¥¹ä¹Ÿè¦ç”¨è¿™äº›æˆ¿é—´ï¼‰ï¼Œç»“æœå°±æ˜¯å¾—ä¸€ä¸ªä¸ªåœ°æ“¦æ‰å°å—åˆ»çš„åå­—ï¼Œå‡çº§ä¸ºæŒ‚ä¹¦åŒ…çš„æ–¹å¼ã€‚è€ç‹è§‰å¾—è¿™æˆæœ¬æœ‰ç‚¹é«˜ï¼Œæå‡ºäº†ä¸€ç§æ‰¹é‡é‡åˆ»åçš„æ–¹æ³•ï¼Œä»–è®©å°å¥³ä¸ç”¨æŒ‚ä¹¦åŒ…äº†ï¼Œå¯ä»¥ç›´æ¥åœ¨é—¨ä¸Šåˆ»ä¸Šè‡ªå·±çš„åå­—ã€‚</p><p>åæ¥ï¼Œåˆ»åçš„ç°è±¡è¶Šæ¥è¶Šé¢‘ç¹ï¼Œè€ç‹å—ä¸äº†äº†ï¼šç®—äº†ï¼Œè¿™äº›æˆ¿é—´éƒ½ä¸èƒ½åˆ»åäº†ï¼Œåªèƒ½æŒ‚ä¹¦åŒ…</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <h3 id="8-2-è½»é‡çº§é”">8.2 è½»é‡çº§é”</h3><p>è½»é‡çº§é”çš„ä½¿ç”¨åœºæ™¯ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡è™½ç„¶æœ‰å¤šçº¿ç¨‹è¦åŠ é”ï¼Œä½†åŠ é”çš„æ—¶é—´æ˜¯é”™å¼€çš„ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰ç«äº‰ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è½»é‡çº§é”æ¥ä¼˜åŒ–ã€‚</p><p>è½»é‡çº§é”å¯¹ä½¿ç”¨è€…æ˜¯é€æ˜çš„ï¼Œå³è¯­æ³•ä»ç„¶æ˜¯ synchronized</p><p>å‡è®¾æœ‰ä¸¤ä¸ªæ–¹æ³•åŒæ­¥å—ï¼Œåˆ©ç”¨åŒä¸€ä¸ªå¯¹è±¡åŠ é”</p><div class="tabs" id="ca665ee3-33f0-49bd-a1a4-59a3b938e8b2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ca665ee3-33f0-49bd-a1a4-59a3b938e8b2-1"><i class="fas fa-fire-alt"></i>ä»£ç </button></li><li class="tab"><button type="button" data-href="#ca665ee3-33f0-49bd-a1a4-59a3b938e8b2-2"><i class="fas fa-seedling"></i>1</button></li><li class="tab"><button type="button" data-href="#ca665ee3-33f0-49bd-a1a4-59a3b938e8b2-3"><i class="fas fa-leaf"></i>2</button></li><li class="tab"><button type="button" data-href="#ca665ee3-33f0-49bd-a1a4-59a3b938e8b2-4"><i class="fab fa-apple"></i>3</button></li><li class="tab"><button type="button" data-href="#ca665ee3-33f0-49bd-a1a4-59a3b938e8b2-5"><i class="fas fa-tree"></i>4</button></li><li class="tab"><button type="button" data-href="#ca665ee3-33f0-49bd-a1a4-59a3b938e8b2-6"><i class="fas fa-cat"></i>5</button></li><li class="tab"><button type="button" data-href="#ca665ee3-33f0-49bd-a1a4-59a3b938e8b2-7"><i class="fas fa-horse"></i>6</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ca665ee3-33f0-49bd-a1a4-59a3b938e8b2-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>( obj ) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å— A</span></span><br><span class="line">        method2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>( obj ) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å— B</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ca665ee3-33f0-49bd-a1a4-59a3b938e8b2-2"><p>åˆ›å»ºé”è®°å½•ï¼ˆLock Recordï¼‰å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½çš„æ ˆå¸§éƒ½ä¼šåŒ…å«ä¸€ä¸ªé”è®°å½•çš„ç»“æ„ï¼Œå†…éƒ¨å¯ä»¥å­˜å‚¨é”å®šå¯¹è±¡çš„ Mark Word</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317183003930.png" alt="image-20220317183003930"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ca665ee3-33f0-49bd-a1a4-59a3b938e8b2-3"><p>00 è½»é‡çº§é”çŠ¶æ€ 01æ­£å¸¸çŠ¶æ€æœªåŠ é”</p><p>è®©é”è®°å½•ä¸­ Object reference æŒ‡å‘é”å¯¹è±¡ï¼Œå¹¶å°è¯•ç”¨ cas æ›¿æ¢ Object çš„ Mark Wordï¼Œå°† Mark Word çš„å€¼å­˜ å…¥é”è®°å½•</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317183043247.png" alt="image-20220317183043247"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ca665ee3-33f0-49bd-a1a4-59a3b938e8b2-4"><p>å¦‚æœ cas æ›¿æ¢æˆåŠŸï¼Œå¯¹è±¡å¤´ä¸­å­˜å‚¨äº† é”è®°å½•åœ°å€å’ŒçŠ¶æ€ 00 ï¼Œè¡¨ç¤ºç”±è¯¥çº¿ç¨‹ç»™å¯¹è±¡åŠ é”ï¼Œè¿™æ—¶å›¾ç¤ºå¦‚ä¸‹</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317183112363.png" alt="image-20220317183112363"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ca665ee3-33f0-49bd-a1a4-59a3b938e8b2-5"><p>å¦‚æœ cas å¤±è´¥ï¼Œæœ‰ä¸¤ç§æƒ…å†µ</p><ul><li>å¦‚æœæ˜¯å…¶å®ƒçº¿ç¨‹å·²ç»æŒæœ‰äº†è¯¥ Object çš„è½»é‡çº§é”ï¼Œè¿™æ—¶è¡¨æ˜æœ‰ç«äº‰ï¼Œè¿›å…¥é”è†¨èƒ€è¿‡ç¨‹</li><li>å¦‚æœæ˜¯è‡ªå·±æ‰§è¡Œäº† synchronized é”é‡å…¥ï¼Œé‚£ä¹ˆå†æ·»åŠ ä¸€æ¡ Lock Record ä½œä¸ºé‡å…¥çš„è®¡æ•°</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317183158959.png" alt="image-20220317183158959"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ca665ee3-33f0-49bd-a1a4-59a3b938e8b2-6"><p>å½“é€€å‡º synchronized ä»£ç å—ï¼ˆè§£é”æ—¶ï¼‰å¦‚æœæœ‰å–å€¼ä¸º null çš„é”è®°å½•ï¼Œè¡¨ç¤ºæœ‰é‡å…¥ï¼Œè¿™æ—¶é‡ç½®é”è®°å½•ï¼Œè¡¨ç¤ºé‡ å…¥è®¡æ•°å‡ä¸€</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317183219677.png" alt="image-20220317183219677"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ca665ee3-33f0-49bd-a1a4-59a3b938e8b2-7"><p>å½“é€€å‡º synchronized ä»£ç å—ï¼ˆè§£é”æ—¶ï¼‰é”è®°å½•çš„å€¼ä¸ä¸º nullï¼Œè¿™æ—¶ä½¿ç”¨caså°†Mark Wordçš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´</p><ul><li>æˆåŠŸï¼Œåˆ™è§£é”æˆåŠŸ</li><li>å¤±è´¥ï¼Œè¯´æ˜è½»é‡çº§é”è¿›è¡Œäº†é”è†¨èƒ€æˆ–å·²ç»å‡çº§ä¸ºé‡é‡çº§é”ï¼Œè¿›å…¥é‡é‡çº§é”è§£é”æµç¨‹</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="8-3-é”è†¨èƒ€">8.3 é”è†¨èƒ€</h3><p>å¦‚æœåœ¨å°è¯•åŠ è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­ï¼ŒCAS æ“ä½œæ— æ³•æˆåŠŸï¼Œè¿™æ—¶ä¸€ç§æƒ…å†µå°±æ˜¯æœ‰å…¶å®ƒçº¿ç¨‹ä¸ºæ­¤å¯¹è±¡åŠ ä¸Šäº†è½»é‡çº§é”ï¼ˆæœ‰ ç«äº‰ï¼‰ï¼Œè¿™æ—¶éœ€è¦è¿›è¡Œé”è†¨èƒ€ï¼Œå°†è½»é‡çº§é”å˜ä¸ºé‡é‡çº§é”ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>( obj ) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å—</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="tabs" id="81b72517-7212-413d-a530-9d15bd789ffd"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#81b72517-7212-413d-a530-9d15bd789ffd-1"><i class="fas fa-atom"></i>1</button></li><li class="tab"><button type="button" data-href="#81b72517-7212-413d-a530-9d15bd789ffd-2"><i class="far fa-sun"></i>2</button></li><li class="tab"><button type="button" data-href="#81b72517-7212-413d-a530-9d15bd789ffd-3"><i class="fas fa-wind"></i>3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="81b72517-7212-413d-a530-9d15bd789ffd-1"><p>å½“å‰Thread-0å·²ç»å¯¹ObjectåŠ äº†è½»é‡çº§é”ï¼Œè¿™æ—¶æ¥äº†Thread-1ï¼Œä¹Ÿæ˜¯ä¼˜å…ˆé‡‡ç”¨è½»é‡çº§çš„åŠ é”æ–¹å¼</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317183453057.png" alt="image-20220317183453057"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="81b72517-7212-413d-a530-9d15bd789ffd-2"><p>è¿™æ—¶ Thread-1 åŠ è½»é‡çº§é”å¤±è´¥ï¼Œè¿›å…¥é”è†¨èƒ€æµç¨‹</p><ul><li>å³ä¸º Object å¯¹è±¡ç”³è¯· Monitor é”ï¼Œè®© Objectçš„ MarkWordä¸­æŒ‡é’ˆæŒ‡å‘é‡é‡çº§é”åœ°å€</li><li>ç„¶åè‡ªå·±è¿›å…¥ Monitor çš„ EntryList BLOCKED</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317183547387.png" alt="image-20220317183547387"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="81b72517-7212-413d-a530-9d15bd789ffd-3"><p>å½“ Thread-0 é€€å‡ºåŒæ­¥å—è§£é”æ—¶ï¼Œä½¿ç”¨ cas å°† Mark Word çš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´ï¼Œå¤±è´¥ã€‚è¿™æ—¶ä¼šè¿›å…¥é‡é‡çº§è§£é” æµç¨‹ï¼Œå³æŒ‰ç…§ Monitor åœ°å€æ‰¾åˆ° Monitor å¯¹è±¡ï¼Œè®¾ç½® Owner ä¸º nullï¼Œå”¤é†’ EntryList ä¸­ BLOCKED çº¿ç¨‹</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <h3 id="8-4-è‡ªæ—‹ä¼˜åŒ–">8.4 è‡ªæ—‹ä¼˜åŒ–</h3><p>é‡é‡çº§é”ç«äº‰çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªæ—‹æ¥è¿›è¡Œä¼˜åŒ–<code>ï¼ˆæš‚æ—¶å…ˆä¸è¿›å…¥é˜»å¡ï¼‰</code>ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è‡ªæ—‹æˆåŠŸï¼ˆå³è¿™æ—¶å€™æŒé”çº¿ç¨‹å·²ç»é€€å‡ºäº†åŒæ­¥ å—ï¼Œé‡Šæ”¾äº†é”ï¼‰ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹å°±å¯ä»¥é¿å…é˜»å¡ã€‚</p><div class="tabs" id="5330635d-da0f-42e3-84be-e2cf8e598e79"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#5330635d-da0f-42e3-84be-e2cf8e598e79-1"><i class="fas fa-dove"></i>è‡ªæ—‹é‡è¯•æˆåŠŸçš„æƒ…å†µ</button></li><li class="tab"><button type="button" data-href="#5330635d-da0f-42e3-84be-e2cf8e598e79-2"><i class="fas fa-dragon"></i>è‡ªæ—‹é‡è¯•å¤±è´¥çš„æƒ…å†µ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="5330635d-da0f-42e3-84be-e2cf8e598e79-1"><p>æ—‹é‡è¯•æˆåŠŸçš„æƒ…å†µ</p><table><thead><tr><th style="text-align:center">çº¿ç¨‹1 (  core 1ä¸Š)</th><th style="text-align:center">å¯¹è±¡Mark</th><th style="text-align:center">çº¿ç¨‹2 ( core 2ä¸Š)</th></tr></thead><tbody><tr><td style="text-align:center">-</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">è®¿é—®åŒæ­¥å—ï¼Œè·å–monitor</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">æˆåŠŸï¼ˆåŠ é”ï¼‰</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td><td style="text-align:center">10(é‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">è®¿é—®åŒæ­¥å—ï¼Œè·å– monitor</td></tr><tr><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">è‡ªæ—‹é‡è¯•</td></tr><tr><td style="text-align:center">æ‰§è¡Œå®Œæ¯•</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">è‡ªæ—‹é‡è¯•</td></tr><tr><td style="text-align:center">æˆåŠŸï¼ˆè§£é”ï¼‰</td><td style="text-align:center">01ï¼ˆæ— é”ï¼‰</td><td style="text-align:center">è‡ªæ—‹é‡è¯•</td></tr><tr><td style="text-align:center">-</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">æˆåŠŸï¼ˆåŠ é”)</td></tr><tr><td style="text-align:center">-</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td></tr><tr><td style="text-align:center">-</td><td style="text-align:center">â€¦</td><td style="text-align:center">â€¦</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5330635d-da0f-42e3-84be-e2cf8e598e79-2"><table><thead><tr><th style="text-align:center">çº¿ç¨‹1 ( core 1ä¸Š)</th><th style="text-align:center">å¯¹è±¡Mark</th><th style="text-align:center">çº¿ç¨‹2( core 2ä¸Š)</th></tr></thead><tbody><tr><td style="text-align:center">-</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">è®¿é—®åŒæ­¥å—ï¼Œè·å–monitor</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">æˆåŠŸï¼ˆåŠ é”)</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">è®¿é—®åŒæ­¥å—ï¼Œè·å–monitor</td></tr><tr><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">è‡ªæ—‹é‡è¯•</td></tr><tr><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">è‡ªæ—‹é‡è¯•</td></tr><tr><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">è‡ªæ—‹é‡è¯•</td></tr><tr><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">é˜»å¡,è¿›å…¥EntryList</td></tr><tr><td style="text-align:center">-</td><td style="text-align:center">â€¦</td><td style="text-align:center">â€¦</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><ul><li>è‡ªæ—‹ä¼šå ç”¨ CPU æ—¶é—´ï¼Œå•æ ¸ CPU è‡ªæ—‹å°±æ˜¯æµªè´¹ï¼Œå¤šæ ¸ CPU è‡ªæ—‹æ‰èƒ½å‘æŒ¥ä¼˜åŠ¿ã€‚</li><li>åœ¨ Java 6 ä¹‹åè‡ªæ—‹é”æ˜¯è‡ªé€‚åº”çš„ï¼Œæ¯”å¦‚å¯¹è±¡åˆšåˆšçš„ä¸€æ¬¡è‡ªæ—‹æ“ä½œæˆåŠŸè¿‡ï¼Œé‚£ä¹ˆè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹æˆåŠŸçš„å¯èƒ½æ€§ä¼šé«˜ï¼Œå°±å¤šè‡ªæ—‹å‡ æ¬¡ï¼›åä¹‹ï¼Œå°±å°‘è‡ªæ—‹ç”šè‡³ä¸è‡ªæ—‹ï¼Œæ€»ä¹‹ï¼Œæ¯”è¾ƒæ™ºèƒ½ã€‚</li><li>Java 7 ä¹‹åä¸èƒ½æ§åˆ¶æ˜¯å¦å¼€å¯è‡ªæ—‹åŠŸèƒ½</li></ul><h3 id="8-5-åå‘é”">8.5 åå‘é”</h3><p>è½»é‡çº§é”åœ¨æ²¡æœ‰ç«äº‰æ—¶ï¼ˆå°±è‡ªå·±è¿™ä¸ªçº¿ç¨‹ï¼‰ï¼Œæ¯æ¬¡é‡å…¥ä»ç„¶éœ€è¦æ‰§è¡Œ CAS æ“ä½œã€‚</p><p>Java 6 ä¸­å¼•å…¥äº†åå‘é”æ¥åšè¿›ä¸€æ­¥ä¼˜åŒ–ï¼šåªæœ‰ç¬¬ä¸€æ¬¡ä½¿ç”¨ CAS å°†çº¿ç¨‹ ID è®¾ç½®åˆ°å¯¹è±¡çš„ Mark Word å¤´ï¼Œä¹‹åå‘ç° è¿™ä¸ªçº¿ç¨‹ ID æ˜¯è‡ªå·±çš„å°±è¡¨ç¤ºæ²¡æœ‰ç«äº‰ï¼Œä¸ç”¨é‡æ–° CASã€‚ä»¥ååªè¦ä¸å‘ç”Ÿç«äº‰ï¼Œè¿™ä¸ªå¯¹è±¡å°±å½’è¯¥çº¿ç¨‹æ‰€æœ‰</p><p>å‡ºåŒæ­¥å—ï¼Œobjä¸­çš„çº¿ç¨‹IDä¹Ÿä¸ä¼šæ¸…0</p><p>ä¾‹å¦‚ï¼š</p><div class="tabs" id="6f3eb04d-761f-417c-87bf-8ba1103971e9"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6f3eb04d-761f-417c-87bf-8ba1103971e9-1"><i class="fas fa-seedling"></i>ä»£ç å®ä¾‹</button></li><li class="tab"><button type="button" data-href="#6f3eb04d-761f-417c-87bf-8ba1103971e9-2"><i class="fas fa-leaf"></i>è½»é‡çº§é”</button></li><li class="tab"><button type="button" data-href="#6f3eb04d-761f-417c-87bf-8ba1103971e9-3"><i class="fas fa-tree"></i>åå‘é”</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6f3eb04d-761f-417c-87bf-8ba1103971e9-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">m1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>( obj ) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å— A</span></span><br><span class="line">        m2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">m2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>( obj ) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å— B</span></span><br><span class="line">        m3();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">m3</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>( obj ) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å— C</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6f3eb04d-761f-417c-87bf-8ba1103971e9-2"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230330144351008.png" alt="image-20230330144351008" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6f3eb04d-761f-417c-87bf-8ba1103971e9-3"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230330144432492.png" alt="image-20230330144432492" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h4 id="8-5-1-åå‘çŠ¶æ€">8.5.1 åå‘çŠ¶æ€</h4><p>å›å¿†ä¸€ä¸‹å¯¹è±¡å¤´æ ¼å¼</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">|<span class="params">--------------------------------------------------------------------</span>|--------------------|<span class="params"></span></span><br><span class="line"><span class="params"></span>|                          <span class="title class_">Mark</span> <span class="title class_">Word</span> (<span class="number">64</span> bits)                       |<span class="params">        State       </span>|</span><br><span class="line">|<span class="params">--------------------------------------------------------------------</span>|--------------------|<span class="params"></span></span><br><span class="line"><span class="params"></span>| <span class="symbol">unused:</span><span class="number">25</span> |<span class="params"> hashcode:31 </span>| <span class="symbol">unused:</span><span class="number">1</span> |<span class="params"> age:4 </span>| <span class="symbol">biased_lock:</span><span class="number">0</span> |<span class="params">  01   </span>|        <span class="title class_">Normal</span>      |<span class="params"></span></span><br><span class="line"><span class="params"></span>|--------------------------------------------------------------------|<span class="params">--------------------</span>|</span><br><span class="line">|<span class="params"> thread:54 </span>|   <span class="symbol">epoch:</span><span class="number">2</span>   |<span class="params"> unused:1 </span>| <span class="symbol">age:</span><span class="number">4</span> |<span class="params"> biased_lock:1 </span>|  <span class="number">01</span>   |<span class="params">        Biased      </span>|</span><br><span class="line">|<span class="params">--------------------------------------------------------------------</span>|--------------------|<span class="params"></span></span><br><span class="line"><span class="params"></span>|                    <span class="symbol">ptr_to_lock_record:</span><span class="number">62</span>                   |<span class="params">  00   </span>| <span class="title class_">Lightweight</span> <span class="title class_">Locked</span> |<span class="params"></span></span><br><span class="line"><span class="params"></span>|--------------------------------------------------------------------|<span class="params">--------------------</span>|</span><br><span class="line">|<span class="params">                 ptr_to_heavyweight_monitor:62              </span>|  <span class="number">10</span>   |<span class="params"> Heavyweight Locked </span>|</span><br><span class="line">|<span class="params">--------------------------------------------------------------------</span>|--------------------|<span class="params"></span></span><br><span class="line"><span class="params"></span>|                                                            |<span class="params">  11   </span>|    <span class="title class_">Marked</span> <span class="keyword">for</span> <span class="variable constant_">GC</span>   |<span class="params"></span></span><br><span class="line"><span class="params"></span>|--------------------------------------------------------------------|<span class="params">--------------------</span>|</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªå¯¹è±¡åˆ›å»ºæ—¶ï¼š</p><ul><li><p>å¦‚æœå¼€å¯äº†åå‘é”ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼Œmarkword å€¼æœ€å 3 ä½ä¸º 101 <code>BiasedçŠ¶æ€</code>ï¼Œè¿™æ—¶å®ƒçš„ threadã€epochã€age éƒ½ä¸º 0</p></li><li><p>åå‘é”æ˜¯é»˜è®¤æ˜¯å»¶è¿Ÿçš„ï¼Œä¸ä¼šåœ¨ç¨‹åºå¯åŠ¨æ—¶ç«‹å³ç”Ÿæ•ˆï¼Œå¦‚æœæƒ³é¿å…å»¶è¿Ÿï¼Œå¯ä»¥åŠ  VM å‚æ•°<code>- XX:BiasedLockingStartupDelay=0</code>æ¥ç¦ç”¨å»¶è¿Ÿ</p></li><li><p>å¦‚æœæ²¡æœ‰å¼€å¯åå‘é”ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼Œmarkword å€¼æœ€å 3 ä½ä¸º 001 <code>NormalçŠ¶æ€</code>ï¼Œè¿™æ—¶å®ƒçš„ hashcodeã€ age éƒ½ä¸º 0</p></li></ul><h4 id="8-5-2-æ’¤é”€-è°ƒç”¨å¯¹è±¡hashcode">8.5.2 æ’¤é”€-è°ƒç”¨å¯¹è±¡hashcode</h4><ul><li>hashcodeæ˜¯æ‡’åŠ è½½ï¼Œåœ¨è°ƒç”¨hashCodeæ–¹æ³•åæ‰ä¼šä¿å­˜åœ¨å¯¹è±¡å¤´ä¸­ã€‚</li><li>å½“å¯¹è±¡å¤´ä¸­æ²¡æœ‰hashcodeæ—¶ï¼Œå¯¹è±¡å¤´é”çš„çŠ¶æ€æ˜¯ å¯åå‘ï¼ˆ biasableï¼Œ101ï¼Œä¸”æ— çº¿ç¨‹idï¼‰ã€‚</li><li>å¦‚æœåœ¨åŒæ­¥ä»£ç å—ä¹‹å‰è°ƒç”¨hashCodeæ–¹æ³•ï¼Œåˆ™å¯¹è±¡å¤´ä¸­ä¼šæœ‰hashcodeï¼Œä¸”é”çŠ¶æ€æ˜¯ ä¸å¯åå‘ ï¼ˆ0 01ï¼‰ï¼Œè¿™æ—¶å€™å†æ‰§è¡ŒåŒæ­¥ä»£ç å—ï¼Œé”ç›´æ¥æ˜¯ è½»é‡çº§é”00ã€‚</li><li>å¦‚æœæ˜¯åœ¨åŒæ­¥ä»£ç å—ä¸­æ‰§è¡Œhashcodeï¼Œåˆ™é”æ˜¯ä» åå‘é” ç›´æ¥è†¨èƒ€ä¸º é‡é‡çº§é”ã€‚</li></ul><p>è½»é‡çº§é”ä¼šåœ¨é”è®°å½•ä¸­è®°å½• hashCode</p><p>é‡é‡çº§é”ä¼šåœ¨ Monitor ä¸­è®°å½• hashCode</p><h4 id="8-5-3-æ’¤é”€-å…¶å®ƒçº¿ç¨‹ä½¿ç”¨å¯¹è±¡">8.5.3 æ’¤é”€ - å…¶å®ƒçº¿ç¨‹ä½¿ç”¨å¯¹è±¡</h4><p>å½“æœ‰å…¶å®ƒçº¿ç¨‹ä½¿ç”¨åå‘é”å¯¹è±¡æ—¶(é”™å¼€ä½¿ç”¨ï¼Œè‹¥åŒæ—¶ä½¿ç”¨å°±ä¼šè†¨èƒ€)ï¼Œä¼šå°†åå‘é”å‡çº§ä¸ºè½»é‡çº§é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Dog</span> <span class="variable">d</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>();</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(ClassLayout.parseInstance(d).toPrintable(<span class="literal">true</span>));</span><br><span class="line">        <span class="keyword">synchronized</span> (d) &#123;</span><br><span class="line">            log.debug(ClassLayout.parseInstance(d).toPrintable(<span class="literal">true</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(ClassLayout.parseInstance(d).toPrintable(<span class="literal">true</span>));</span><br><span class="line">        TestBiased.class.notify();</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (TestBiased.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TestBiased.class.wait();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(ClassLayout.parseInstance(d).toPrintable(<span class="literal">true</span>));</span><br><span class="line">        <span class="keyword">synchronized</span> (d) &#123;</span><br><span class="line">            log.debug(ClassLayout.parseInstance(d).toPrintable(<span class="literal">true</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(ClassLayout.parseInstance(d).toPrintable(<span class="literal">true</span>));</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    t2.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[t1] - <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000101</span>   è¿›å…¥åŒæ­¥ä»£ç å—å‰  åå‘çŠ¶æ€</span><br><span class="line">[t1] - <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00011111</span> <span class="number">01000001</span> <span class="number">00010000</span> <span class="number">00000101</span>   t1çº¿ç¨‹ID+<span class="number">101</span></span><br><span class="line">[t1] - <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00011111</span> <span class="number">01000001</span> <span class="number">00010000</span> <span class="number">00000101</span>  t1çº¿ç¨‹ID+<span class="number">101</span></span><br><span class="line">[t2] - <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00011111</span> <span class="number">01000001</span> <span class="number">00010000</span> <span class="number">00000101</span>   t1çº¿ç¨‹ID+<span class="number">101</span></span><br><span class="line">[t2] - <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00100000</span> <span class="number">01001011</span> <span class="number">11110011</span> <span class="number">00100000</span>   t2çº¿ç¨‹åŠ è½»é‡çº§é” é”è®°å½•+<span class="number">000</span></span><br><span class="line">[t2] - <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000001</span>   æ— é”çŠ¶æ€ åå‘çŠ¶æ€è¢«æ’¤é”€</span><br></pre></td></tr></table></figure><h4 id="8-5-4-æ’¤é”€-è°ƒç”¨-wait-notify">8.5.4 æ’¤é”€ - è°ƒç”¨ wait/notify</h4><p>wait/notifyåªæœ‰é‡é‡çº§é”æœ‰</p><h4 id="8-5-5-æ‰¹é‡é‡åå‘">8.5.5 æ‰¹é‡é‡åå‘</h4><p>å¦‚æœå¯¹è±¡è™½ç„¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ²¡æœ‰ç«äº‰ï¼Œè¿™æ—¶åå‘äº†çº¿ç¨‹ T1 çš„å¯¹è±¡ä»æœ‰æœºä¼šé‡æ–°åå‘ T2ï¼Œé‡åå‘ä¼šé‡ç½®å¯¹è±¡ çš„ Thread ID</p><p>å½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡ 20 æ¬¡åï¼Œjvm ä¼šè¿™æ ·è§‰å¾—ï¼Œæˆ‘æ˜¯ä¸æ˜¯åå‘é”™äº†å‘¢ï¼Œäºæ˜¯ä¼šåœ¨ç»™è¿™äº›å¯¹è±¡åŠ é”æ—¶é‡æ–°åå‘è‡³ åŠ é”çº¿ç¨‹</p><div class="tabs" id="e0ea9519-0165-48a8-8333-4b4a8b88289c"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e0ea9519-0165-48a8-8333-4b4a8b88289c-1"><i class="fas fa-cat"></i>ä»£ç </button></li><li class="tab"><button type="button" data-href="#e0ea9519-0165-48a8-8333-4b4a8b88289c-2"><i class="fas fa-horse"></i>è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e0ea9519-0165-48a8-8333-4b4a8b88289c-1"><p>t1çº¿ç¨‹ t2çº¿ç¨‹é”™å¼€æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    Vector&lt;Dog&gt; list = <span class="keyword">new</span> <span class="title class_">Vector</span>&lt;&gt;();</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">30</span>; i++) &#123;</span><br><span class="line">            <span class="type">Dog</span> <span class="variable">d</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>();</span><br><span class="line">            list.add(d);</span><br><span class="line">            <span class="keyword">synchronized</span> (d) &#123;</span><br><span class="line">                log.debug(i + <span class="string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line">            list.notify();</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line"></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                list.wait();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;===============&gt; &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">30</span>; i++) &#123;</span><br><span class="line">            <span class="type">Dog</span> <span class="variable">d</span> <span class="operator">=</span> list.get(i);</span><br><span class="line">            log.debug(i + <span class="string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">            <span class="keyword">synchronized</span> (d) &#123;</span><br><span class="line">                log.debug(i + <span class="string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(i + <span class="string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    t2.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e0ea9519-0165-48a8-8333-4b4a8b88289c-2"><p>t1çº¿ç¨‹ 0-29åŠ çš„éƒ½æ˜¯åå‘é”ï¼ˆçº¿ç¨‹ID+101ï¼‰</p><p>t2çº¿ç¨‹ åå‘é” å˜æˆè½»é‡çº§é” è§£é” å¾ªç¯ ä»ç¬¬20ä¸ªå¯¹è±¡å¼€å§‹ åˆå˜æˆåå‘é”ï¼ˆçº¿ç¨‹ID+101ï¼‰</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">[t1] - 0 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 1 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 2 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 3 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 4 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 5 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 6 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 7 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 8 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 9 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 10 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 11 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 12 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 13 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 14 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 15 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 16 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 17 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 18 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 19 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 20 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 21 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 22 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 23 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 24 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 25 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 26 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 27 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 28 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 29 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - ===============&gt; </span><br><span class="line">[t2] - 0 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 0 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 0 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 1 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 1 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 1 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 2 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 2 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 2 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 3 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 3 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 3 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 4 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 4 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 4 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 5 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 5 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 5 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 6 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 6 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 6 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 7 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101</span><br><span class="line">[t2] - 7 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 7 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 8 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 8 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 8 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 9 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 9 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 9 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 10 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 10 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 10 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 11 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 11 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 11 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 12 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 12 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 12 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 13 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 13 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 13 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 14 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 14 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 14 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 15 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 15 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 15 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 16 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 16 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 16 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 17 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 17 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 17 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 18 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 18 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 18 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 19 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 19 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 19 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 20 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 20 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 20 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 21 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 21 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 21 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 22 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 22 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 22 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 23 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 23 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 23 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 24 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 24 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 24 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 25 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 25 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 25 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 26 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 26 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 26 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 27 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 27 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 27 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 28 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 28 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 28 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 29 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 29 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 29 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h4 id="8-5-6-æ‰¹é‡æ’¤é”€">8.5.6 æ‰¹é‡æ’¤é”€</h4><p>å½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡ 40 æ¬¡åï¼Œjvm ä¼šè¿™æ ·è§‰å¾—ï¼Œè‡ªå·±ç¡®å®åå‘é”™äº†ï¼Œæ ¹æœ¬å°±ä¸è¯¥åå‘ã€‚äºæ˜¯æ•´ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡ éƒ½ä¼šå˜ä¸ºä¸å¯åå‘çš„ï¼Œæ–°å»ºçš„å¯¹è±¡ä¹Ÿæ˜¯ä¸å¯åå‘çš„</p><h3 id="8-6-é”æ¶ˆé™¤">8.6 é”æ¶ˆé™¤</h3><p>JITå³æ—¶ç¼–è¯‘å™¨ä¼šå¯¹ä»£ç è¿›è¡Œé€ƒé€¸åˆ†æï¼Œå‘ç°å±€éƒ¨å˜é‡ä¸ä¼šé€ƒç¦»æ–¹æ³•åï¼Œä¸å¯èƒ½è¢«å…±äº«ï¼ŒåŠ é”å°±æ²¡å¿…è¦äº†ã€‚</p><p>å¯ä»¥é€šè¿‡å¼€å…³æ§åˆ¶ -XX:-EliminateLocks é”æ¶ˆé™¤</p><div class="tabs" id="8cff80bf-aa9c-4d4c-a752-aec833649197"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#8cff80bf-aa9c-4d4c-a752-aec833649197-1"><i class="fas fa-cat"></i>æµ‹è¯•ä»£ç </button></li><li class="tab"><button type="button" data-href="#8cff80bf-aa9c-4d4c-a752-aec833649197-2"><i class="fas fa-horse"></i>é»˜è®¤å¼€å¯æµ‹è¯•</button></li><li class="tab"><button type="button" data-href="#8cff80bf-aa9c-4d4c-a752-aec833649197-3"><i class="fas fa-dove"></i>å…³é—­åæµ‹è¯•ç»“æœ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="8cff80bf-aa9c-4d4c-a752-aec833649197-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Fork(1)</span></span><br><span class="line"><span class="meta">@BenchmarkMode(Mode.AverageTime)</span></span><br><span class="line"><span class="meta">@Warmup(iterations=3)</span></span><br><span class="line"><span class="meta">@Measurement(iterations=5)</span></span><br><span class="line"><span class="meta">@OutputTimeUnit(TimeUnit.NANOSECONDS)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBenchmark</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        x++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">        <span class="keyword">synchronized</span> (o) &#123;</span><br><span class="line">            x++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8cff80bf-aa9c-4d4c-a752-aec833649197-2"><p>å‘ç°åŠ é”ä¸ä¸åŠ é”å¾—åˆ†ç›¸å·®ä¸å¤§</p><p><code>java -jar benchmarks.jar</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Benchmark Mode Samples Score Score error Units </span><br><span class="line">c.i.MyBenchmark.a avgt 5 1.542 0.056 ns/op </span><br><span class="line">c.i.MyBenchmark.b avgt 5 1.518 0.091 ns/op </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8cff80bf-aa9c-4d4c-a752-aec833649197-3"><p>å…³é—­åç›¸å·®è¾ƒå¤§</p><p><code>java -XX:-EliminateLocks -jar benchmarks.jar</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Benchmark Mode Samples Score Score error Units </span><br><span class="line">c.i.MyBenchmark.a avgt 5 1.507 0.108 ns/op </span><br><span class="line">c.i.MyBenchmark.b avgt 5 16.976 1.572 ns/op</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="9-Wait-Notify">9. Wait &amp; Notify</h2><h3 id="9-1-å°æ•…äº‹-ä¸ºä»€ä¹ˆéœ€è¦-wait">9.1 å°æ•…äº‹ - ä¸ºä»€ä¹ˆéœ€è¦ wait</h3><div class="tabs" id="14c28997-7b76-48a8-ba7d-7393d9e64cb0"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#14c28997-7b76-48a8-ba7d-7393d9e64cb0-1"><i class="fas fa-cat"></i>1</button></li><li class="tab"><button type="button" data-href="#14c28997-7b76-48a8-ba7d-7393d9e64cb0-2"><i class="fas fa-horse"></i>2</button></li><li class="tab"><button type="button" data-href="#14c28997-7b76-48a8-ba7d-7393d9e64cb0-3"><i class="fas fa-dove"></i>3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="14c28997-7b76-48a8-ba7d-7393d9e64cb0-1"><p>å°å—è´¹åŠ²ä¹ç‰›äºŒè™ä¹‹åŠ›äº‰æŠ¢åˆ°äº†é”ï¼Œæˆä¸ºäº†ä¸»äººï¼Œè®¡ç®—è¿‡ç¨‹ä¸­å‘ç°æœ‰äº›æ¡ä»¶ä¸æ»¡è¶³</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230330164151398.png" alt="image-20230330164151398"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="14c28997-7b76-48a8-ba7d-7393d9e64cb0-2"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230330164414278.png" alt="image-20230330164414278"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="14c28997-7b76-48a8-ba7d-7393d9e64cb0-3"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230330164528815.png" alt="image-20230330164528815"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="9-2-åŸç†ä¹‹-wait-notify">9.2 åŸç†ä¹‹ wait / notify</h3><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220317191950175.png" alt="image-20220317191950175"></p><ul><li>Owner çº¿ç¨‹å‘ç°æ¡ä»¶ä¸æ»¡è¶³ï¼Œè°ƒç”¨ wait æ–¹æ³•ï¼Œå³å¯è¿›å…¥ WaitSet å˜ä¸º WAITING çŠ¶æ€</li><li>BLOCKED å’Œ WAITING çš„çº¿ç¨‹éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¸å ç”¨ CPU æ—¶é—´ç‰‡</li><li>BLOCKED çº¿ç¨‹ä¼šåœ¨ Owner çº¿ç¨‹é‡Šæ”¾é”æ—¶å”¤é†’</li><li>WAITING çº¿ç¨‹ä¼šåœ¨ Owner çº¿ç¨‹è°ƒç”¨ notify æˆ– notifyAll æ—¶å”¤é†’ï¼Œä½†å”¤é†’åå¹¶ä¸æ„å‘³è€…ç«‹åˆ»è·å¾—é”ï¼Œä»éœ€è¿›å…¥ EntryList é‡æ–°ç«äº‰</li></ul><h3 id="9-3-APIä»‹ç»">9.3 APIä»‹ç»</h3><ul><li><code>obj.wait()</code> è®©è¿›å…¥ object ç›‘è§†å™¨ï¼ˆè·å¾—é”ï¼‰çš„çº¿ç¨‹åˆ° waitSet ç­‰å¾…</li><li><code>obj.notify()</code> åœ¨ object ä¸Šæ­£åœ¨ waitSet ç­‰å¾…çš„çº¿ç¨‹ä¸­æŒ‘ä¸€ä¸ªå”¤é†’</li><li><code>obj.notifyAll()</code> è®© object ä¸Šæ­£åœ¨ waitSet ç­‰å¾…çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’</li></ul><p><code>wait()</code> æ–¹æ³•ä¼šé‡Šæ”¾å¯¹è±¡çš„é”ï¼Œè¿›å…¥ WaitSet ç­‰å¾…åŒºï¼Œä»è€Œè®©å…¶ä»–çº¿ç¨‹å°±æœºä¼šè·å–å¯¹è±¡çš„é”ã€‚æ— é™åˆ¶ç­‰å¾…ï¼Œç›´åˆ° notify ä¸ºæ­¢</p><p><code>wait(long n)</code> æœ‰æ—¶é™çš„ç­‰å¾…, åˆ° n æ¯«ç§’åç»“æŸç­‰å¾…ï¼Œæˆ–æ˜¯è¢« notify</p><p>å®ƒä»¬éƒ½æ˜¯çº¿ç¨‹ä¹‹é—´è¿›è¡Œåä½œçš„æ‰‹æ®µï¼Œéƒ½å±äº Object å¯¹è±¡çš„æ–¹æ³•ã€‚å¿…é¡»è·å¾—æ­¤å¯¹è±¡çš„é”ï¼Œæ‰èƒ½è°ƒç”¨è¿™å‡ ä¸ªæ–¹æ³•</p><div class="tabs" id="7582f5ab-170b-499b-8fd7-51fbf927d646"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#7582f5ab-170b-499b-8fd7-51fbf927d646-1"><i class="fas fa-atom"></i>ä¸è·å–é”ï¼Œè°ƒç”¨</button></li><li class="tab"><button type="button" data-href="#7582f5ab-170b-499b-8fd7-51fbf927d646-2"><i class="far fa-sun"></i>è·å–é”å†è°ƒç”¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="7582f5ab-170b-499b-8fd7-51fbf927d646-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    lock.wait();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> java.lang.IllegalMonitorStateException</span><br><span class="line">at java.lang.Object.wait(Native Method)</span><br><span class="line">at java.lang.Object.wait(Object.java:<span class="number">502</span>)</span><br><span class="line">at cn.itcast.test.Test18.main(Test18.java:<span class="number">12</span>)</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="7582f5ab-170b-499b-8fd7-51fbf927d646-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        lock.wait();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <h3 id="9-4-wait-notify-çš„æ­£ç¡®å§¿åŠ¿">9.4 wait notify çš„æ­£ç¡®å§¿åŠ¿</h3><p>å¼€å§‹ä¹‹å‰å…ˆçœ‹çœ‹</p><p><code>sleep(long n)</code> å’Œ <code>wait(long n)</code> çš„åŒºåˆ«</p><ol><li>sleep æ˜¯ Thread æ–¹æ³•ï¼Œè€Œ wait æ˜¯ Object çš„æ–¹æ³•</li><li>sleep ä¸éœ€è¦å¼ºåˆ¶å’Œ synchronized é…åˆä½¿ç”¨ï¼Œä½† wait éœ€è¦ å’Œ synchronized ä¸€èµ·ç”¨</li><li>sleep åœ¨ç¡çœ çš„åŒæ—¶ï¼Œä¸ä¼šé‡Šæ”¾å¯¹è±¡é”çš„ï¼Œä½† wait åœ¨ç­‰å¾…çš„æ—¶å€™ä¼šé‡Šæ”¾å¯¹è±¡é”</li><li>å®ƒä»¬ çŠ¶æ€ TIMED_WAITING</li></ol><p>æ€è€ƒä¸‹é¢çš„è§£å†³æ–¹æ¡ˆå¥½ä¸å¥½ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">room</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasCigarette</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasTakeout</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure><div class="tabs" id="23c61133-258a-4d7f-ab94-6da8725566cc"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#23c61133-258a-4d7f-ab94-6da8725566cc-1"><i class="fas fa-cat"></i>æ–¹æ¡ˆ1</button></li><li class="tab"><button type="button" data-href="#23c61133-258a-4d7f-ab94-6da8725566cc-2"><i class="fas fa-horse"></i>è¾“å‡º1</button></li><li class="tab"><button type="button" data-href="#23c61133-258a-4d7f-ab94-6da8725566cc-3"><i class="fas fa-dove"></i>æ–¹æ¡ˆäºŒ</button></li><li class="tab"><button type="button" data-href="#23c61133-258a-4d7f-ab94-6da8725566cc-4"><i class="fas fa-dragon"></i>è¾“å‡ºäºŒ</button></li><li class="tab"><button type="button" data-href="#23c61133-258a-4d7f-ab94-6da8725566cc-5"><i class="fas fa-seedling"></i>æµ‹è¯•ä¸‰</button></li><li class="tab"><button type="button" data-href="#23c61133-258a-4d7f-ab94-6da8725566cc-6"><i class="fas fa-leaf"></i>è¾“å‡ºä¸‰</button></li><li class="tab"><button type="button" data-href="#23c61133-258a-4d7f-ab94-6da8725566cc-7"><i class="fab fa-apple"></i>æ–¹æ¡ˆå››</button></li><li class="tab"><button type="button" data-href="#23c61133-258a-4d7f-ab94-6da8725566cc-8"><i class="fas fa-tree"></i>è¾“å‡ºå››</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="23c61133-258a-4d7f-ab94-6da8725566cc-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;æœ‰çƒŸæ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">        <span class="keyword">if</span> (!hasCigarette) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼&quot;</span>);</span><br><span class="line">            sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;æœ‰çƒŸæ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">        <span class="keyword">if</span> (hasCigarette) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å¯ä»¥å¼€å§‹å¹²æ´»äº†&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="string">&quot;å°å—&quot;</span>).start();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å¯ä»¥å¼€å§‹å¹²æ´»äº†&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;å…¶å®ƒäºº&quot;</span>).start();</span><br><span class="line">&#125;</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œèƒ½ä¸èƒ½åŠ  synchronized (room)ï¼Ÿ</span></span><br><span class="line">    hasCigarette = <span class="literal">true</span>;</span><br><span class="line">    log.debug(<span class="string">&quot;çƒŸåˆ°äº†å™¢ï¼&quot;</span>);</span><br><span class="line">&#125;, <span class="string">&quot;é€çƒŸçš„&quot;</span>).start();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="23c61133-258a-4d7f-ab94-6da8725566cc-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">49</span>:<span class="number">49.883</span> [å°å—] c.TestCorrectPosture - æœ‰çƒŸæ²¡ï¼Ÿ[<span class="literal">false</span>] </span><br><span class="line"><span class="number">20</span>:<span class="number">49</span>:<span class="number">49.887</span> [å°å—] c.TestCorrectPosture - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼</span><br><span class="line"><span class="number">20</span>:<span class="number">49</span>:<span class="number">50.882</span> [é€çƒŸçš„] c.TestCorrectPosture - çƒŸåˆ°äº†å™¢ï¼</span><br><span class="line"><span class="number">20</span>:<span class="number">49</span>:<span class="number">51.887</span> [å°å—] c.TestCorrectPosture - æœ‰çƒŸæ²¡ï¼Ÿ[<span class="literal">true</span>] </span><br><span class="line"><span class="number">20</span>:<span class="number">49</span>:<span class="number">51.887</span> [å°å—] c.TestCorrectPosture - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">20</span>:<span class="number">49</span>:<span class="number">51.887</span> [å…¶å®ƒäºº] c.TestCorrectPosture - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">20</span>:<span class="number">49</span>:<span class="number">51.887</span> [å…¶å®ƒäºº] c.TestCorrectPosture - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">20</span>:<span class="number">49</span>:<span class="number">51.888</span> [å…¶å®ƒäºº] c.TestCorrectPosture - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">20</span>:<span class="number">49</span>:<span class="number">51.888</span> [å…¶å®ƒäºº] c.TestCorrectPosture - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">20</span>:<span class="number">49</span>:<span class="number">51.888</span> [å…¶å®ƒäºº] c.TestCorrectPosture - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br></pre></td></tr></table></figure><ul><li>å…¶å®ƒå¹²æ´»çš„çº¿ç¨‹ï¼Œéƒ½è¦ä¸€ç›´é˜»å¡ï¼Œæ•ˆç‡å¤ªä½</li><li>å°å—çº¿ç¨‹å¿…é¡»ç¡è¶³ 2s åæ‰èƒ½é†’æ¥ï¼Œå°±ç®—çƒŸæå‰é€åˆ°ï¼Œä¹Ÿæ— æ³•ç«‹åˆ»é†’æ¥</li><li>åŠ äº† synchronized (room) åï¼Œå°±å¥½æ¯”å°å—åœ¨é‡Œé¢åé”äº†é—¨ç¡è§‰ï¼ŒçƒŸæ ¹æœ¬æ²¡æ³•é€è¿›é—¨ï¼Œmain æ²¡åŠ  synchronized å°±å¥½åƒ main çº¿ç¨‹æ˜¯ç¿»çª—æˆ·è¿›æ¥çš„</li><li>è§£å†³æ–¹æ³•ï¼Œä½¿ç”¨ wait - notify æœºåˆ¶</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="23c61133-258a-4d7f-ab94-6da8725566cc-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;æœ‰çƒŸæ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">        <span class="keyword">if</span> (!hasCigarette) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                room.wait(<span class="number">2000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;æœ‰çƒŸæ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">        <span class="keyword">if</span> (hasCigarette) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å¯ä»¥å¼€å§‹å¹²æ´»äº†&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="string">&quot;å°å—&quot;</span>).start();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å¯ä»¥å¼€å§‹å¹²æ´»äº†&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;å…¶å®ƒäºº&quot;</span>).start();</span><br><span class="line">&#125;</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">        hasCigarette = <span class="literal">true</span>;</span><br><span class="line">        log.debug(<span class="string">&quot;çƒŸåˆ°äº†å™¢ï¼&quot;</span>);</span><br><span class="line">        room.notify();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="string">&quot;é€çƒŸçš„&quot;</span>).start();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="23c61133-258a-4d7f-ab94-6da8725566cc-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>:<span class="number">06</span>:<span class="number">36.095</span> c.TestCorrectPosture [å°å—] - æœ‰çƒŸæ²¡ï¼Ÿ[<span class="literal">false</span>]</span><br><span class="line"><span class="number">19</span>:<span class="number">06</span>:<span class="number">36.101</span> c.TestCorrectPosture [å°å—] - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼</span><br><span class="line"><span class="number">19</span>:<span class="number">06</span>:<span class="number">36.102</span> c.TestCorrectPosture [å…¶å®ƒäºº] - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">19</span>:<span class="number">06</span>:<span class="number">36.102</span> c.TestCorrectPosture [å…¶å®ƒäºº] - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">19</span>:<span class="number">06</span>:<span class="number">36.102</span> c.TestCorrectPosture [å…¶å®ƒäºº] - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">19</span>:<span class="number">06</span>:<span class="number">36.102</span> c.TestCorrectPosture [å…¶å®ƒäºº] - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">19</span>:<span class="number">06</span>:<span class="number">36.102</span> c.TestCorrectPosture [å…¶å®ƒäºº] - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">19</span>:<span class="number">06</span>:<span class="number">37.097</span> c.TestCorrectPosture [é€çƒŸçš„] - çƒŸåˆ°äº†å™¢ï¼</span><br><span class="line"><span class="number">19</span>:<span class="number">06</span>:<span class="number">37.098</span> c.TestCorrectPosture [å°å—] - æœ‰çƒŸæ²¡ï¼Ÿ[<span class="literal">true</span>]</span><br><span class="line"><span class="number">19</span>:<span class="number">06</span>:<span class="number">37.098</span> c.TestCorrectPosture [å°å—] - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br></pre></td></tr></table></figure><ul><li>è§£å†³äº†å…¶å®ƒå¹²æ´»çš„çº¿ç¨‹é˜»å¡çš„é—®é¢˜</li><li>ä½†å¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹ä¹Ÿåœ¨ç­‰å¾…å‘¢ï¼Œnotifyæ—¶ä¼šä¸ä¼šé”™è¯¯å«é†’äº†å…¶ä»–çº¿ç¨‹ï¼Ÿ</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="23c61133-258a-4d7f-ab94-6da8725566cc-5"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;æœ‰çƒŸæ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">        <span class="keyword">if</span> (!hasCigarette) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                room.wait();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;æœ‰çƒŸæ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">        <span class="keyword">if</span> (hasCigarette) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å¯ä»¥å¼€å§‹å¹²æ´»äº†&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;æ²¡å¹²æˆæ´»...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="string">&quot;å°å—&quot;</span>).start();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        log.debug(<span class="string">&quot;å¤–å–é€åˆ°æ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasTakeout);</span><br><span class="line">        <span class="keyword">if</span> (!hasTakeout) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                room.wait();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;å¤–å–é€åˆ°æ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasTakeout);</span><br><span class="line">        <span class="keyword">if</span> (hasTakeout) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å¯ä»¥å¼€å§‹å¹²æ´»äº†&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;æ²¡å¹²æˆæ´»...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="string">&quot;å°å¥³&quot;</span>).start();</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">        hasTakeout = <span class="literal">true</span>;</span><br><span class="line">        log.debug(<span class="string">&quot;å¤–å–åˆ°äº†å™¢ï¼&quot;</span>);</span><br><span class="line">        room.notify();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="string">&quot;é€å¤–å–çš„&quot;</span>).start();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="23c61133-258a-4d7f-ab94-6da8725566cc-6"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">20:53:12.173 [å°å—] c.TestCorrectPosture - æœ‰çƒŸæ²¡ï¼Ÿ[<span class="literal">false</span>] </span><br><span class="line">20:53:12.176 [å°å—] c.TestCorrectPosture - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼</span><br><span class="line">20:53:12.176 [å°å¥³] c.TestCorrectPosture - å¤–å–é€åˆ°æ²¡ï¼Ÿ[<span class="literal">false</span>] </span><br><span class="line">20:53:12.176 [å°å¥³] c.TestCorrectPosture - æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼</span><br><span class="line">20:53:13.174 [é€å¤–å–çš„] c.TestCorrectPosture - å¤–å–åˆ°äº†å™¢ï¼</span><br><span class="line">20:53:13.174 [å°å—] c.TestCorrectPosture - æœ‰çƒŸæ²¡ï¼Ÿ[<span class="literal">false</span>] </span><br><span class="line">20:53:13.174 [å°å—] c.TestCorrectPosture - æ²¡å¹²æˆæ´»... </span><br></pre></td></tr></table></figure><ul><li>notify åªèƒ½éšæœºå”¤é†’ä¸€ä¸ª WaitSet ä¸­çš„çº¿ç¨‹ï¼Œè¿™æ—¶å¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹ä¹Ÿåœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå°±å¯èƒ½å”¤é†’ä¸äº†æ­£ç¡®çš„çº¿ç¨‹ï¼Œç§°ä¹‹ä¸ºã€è™šå‡å”¤é†’ã€‘</li><li>è§£å†³æ–¹æ³•ï¼Œæ”¹ä¸º notifyAll</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">20:55:23.978 [å°å—] c.TestCorrectPosture - æœ‰çƒŸæ²¡ï¼Ÿ[<span class="literal">false</span>] </span><br><span class="line">20:55:23.982 [å°å—] c.TestCorrectPosture - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼</span><br><span class="line">20:55:23.982 [å°å¥³] c.TestCorrectPosture - å¤–å–é€åˆ°æ²¡ï¼Ÿ[<span class="literal">false</span>] </span><br><span class="line">20:55:23.982 [å°å¥³] c.TestCorrectPosture - æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼</span><br><span class="line">20:55:24.979 [é€å¤–å–çš„] c.TestCorrectPosture - å¤–å–åˆ°äº†å™¢ï¼</span><br><span class="line">20:55:24.979 [å°å¥³] c.TestCorrectPosture - å¤–å–é€åˆ°æ²¡ï¼Ÿ[<span class="literal">true</span>] </span><br><span class="line">20:55:24.980 [å°å¥³] c.TestCorrectPosture - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line">20:55:24.980 [å°å—] c.TestCorrectPosture - æœ‰çƒŸæ²¡ï¼Ÿ[<span class="literal">false</span>] </span><br><span class="line">20:55:24.980 [å°å—] c.TestCorrectPosture - æ²¡å¹²æˆæ´»... </span><br></pre></td></tr></table></figure><ul><li>ç”¨ notifyAll ä»…è§£å†³æŸä¸ªçº¿ç¨‹çš„å”¤é†’é—®é¢˜ï¼Œä½†ä½¿ç”¨ if + wait åˆ¤æ–­ä»…æœ‰ä¸€æ¬¡æœºä¼šï¼Œä¸€æ—¦æ¡ä»¶ä¸æˆç«‹ï¼Œå°±æ²¡æœ‰é‡æ–°åˆ¤æ–­çš„æœºä¼šäº†</li><li>è§£å†³æ–¹æ³•ï¼Œç”¨ while + waitï¼Œå½“æ¡ä»¶ä¸æˆç«‹ï¼Œå†æ¬¡ wait</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="23c61133-258a-4d7f-ab94-6da8725566cc-7"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!hasCigarette) &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        room.wait();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ”¹åŠ¨å</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (!hasCigarette) &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        room.wait();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="23c61133-258a-4d7f-ab94-6da8725566cc-8"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">20:58:34.322 [å°å—] c.TestCorrectPosture - æœ‰çƒŸæ²¡ï¼Ÿ[<span class="literal">false</span>] </span><br><span class="line">20:58:34.326 [å°å—] c.TestCorrectPosture - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼</span><br><span class="line">20:58:34.326 [å°å¥³] c.TestCorrectPosture - å¤–å–é€åˆ°æ²¡ï¼Ÿ[<span class="literal">false</span>] </span><br><span class="line">20:58:34.326 [å°å¥³] c.TestCorrectPosture - æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼</span><br><span class="line">20:58:35.323 [é€å¤–å–çš„] c.TestCorrectPosture - å¤–å–åˆ°äº†å™¢ï¼</span><br><span class="line">20:58:35.324 [å°å¥³] c.TestCorrectPosture - å¤–å–é€åˆ°æ²¡ï¼Ÿ[<span class="literal">true</span>] </span><br><span class="line">20:58:35.324 [å°å¥³] c.TestCorrectPosture - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line">20:58:35.324 [å°å—] c.TestCorrectPosture - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>æ­£ç¡®å§¿åŠ¿ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(lock) &#123;</span><br><span class="line">    <span class="keyword">while</span>(æ¡ä»¶ä¸æˆç«‹) &#123;</span><br><span class="line">        lock.wait();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¹²æ´»</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¦ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line"><span class="keyword">synchronized</span>(lock) &#123;</span><br><span class="line">    lock.notifyAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-5-æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ">9.5 æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ</h3><p>å³ Guarded Suspensionï¼Œç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœ</p><p>è¦ç‚¹</p><ul><li>æœ‰ä¸€ä¸ªç»“æœéœ€è¦ä»ä¸€ä¸ªçº¿ç¨‹ä¼ é€’åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œè®©ä»–ä»¬å…³è”åŒä¸€ä¸ª GuardedObject</li><li>å¦‚æœæœ‰ç»“æœä¸æ–­ä»ä¸€ä¸ªçº¿ç¨‹åˆ°å¦ä¸€ä¸ªçº¿ç¨‹é‚£ä¹ˆå¯ä»¥ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè§ç”Ÿäº§è€…/æ¶ˆè´¹è€…ï¼‰</li><li>JDK ä¸­ï¼Œjoin çš„å®ç°ã€Future çš„å®ç°ï¼Œé‡‡ç”¨çš„å°±æ˜¯æ­¤æ¨¡å¼</li><li>å› ä¸ºè¦ç­‰å¾…å¦ä¸€æ–¹çš„ç»“æœï¼Œå› æ­¤å½’ç±»åˆ°åŒæ­¥æ¨¡å¼</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220304134602353.png" alt="image-20220304134602353"></p><div class="tabs" id="30c67623-2bc9-45f2-b399-d2eb68b62fc8"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#30c67623-2bc9-45f2-b399-d2eb68b62fc8-1"><i class="fas fa-atom"></i>å®ç°</button></li><li class="tab"><button type="button" data-href="#30c67623-2bc9-45f2-b399-d2eb68b62fc8-2"><i class="far fa-sun"></i>æµ‹è¯•</button></li><li class="tab"><button type="button" data-href="#30c67623-2bc9-45f2-b399-d2eb68b62fc8-3"><i class="fas fa-wind"></i>æ‰§è¡Œç»“æœ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="30c67623-2bc9-45f2-b399-d2eb68b62fc8-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GuardedObject</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object response;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="comment">// æ¡ä»¶ä¸æ»¡è¶³åˆ™ç­‰å¾…</span></span><br><span class="line">            <span class="keyword">while</span> (response == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    lock.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">complete</span><span class="params">(Object response)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="comment">// æ¡ä»¶æ»¡è¶³ï¼Œé€šçŸ¥ç­‰å¾…çº¿ç¨‹</span></span><br><span class="line">            <span class="built_in">this</span>.response = response;</span><br><span class="line">            lock.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="30c67623-2bc9-45f2-b399-d2eb68b62fc8-2"><p>ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">GuardedObject</span> <span class="variable">guardedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuardedObject</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å­çº¿ç¨‹æ‰§è¡Œä¸‹è½½</span></span><br><span class="line">            List&lt;String&gt; response = download();</span><br><span class="line">            log.debug(<span class="string">&quot;download complete...&quot;</span>);</span><br><span class="line">            guardedObject.complete(response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">    log.debug(<span class="string">&quot;waiting...&quot;</span>);</span><br><span class="line">    <span class="comment">// ä¸»çº¿ç¨‹é˜»å¡ç­‰å¾…</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">response</span> <span class="operator">=</span> guardedObject.get();</span><br><span class="line">    log.debug(<span class="string">&quot;get response: [&#123;&#125;] lines&quot;</span>, ((List&lt;String&gt;) response).size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="30c67623-2bc9-45f2-b399-d2eb68b62fc8-3"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">08:42:18.568 [main] c.TestGuardedObject - waiting...</span><br><span class="line">08:42:23.312 [Thread-0] c.TestGuardedObject - download complete...</span><br><span class="line">08:42:23.312 [main] c.TestGuardedObject - get response: [3] lines</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><p>æ”¹è¿›å¸¦è¶…æ—¶ç‰ˆ GuardedObjectï¼šå¯ä»¥æ§åˆ¶è¶…æ—¶æ—¶é—´</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GuardedObjectV2</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object response;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(<span class="type">long</span> millis)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="comment">// 1) è®°å½•æœ€åˆæ—¶é—´</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="comment">// 2) å·²ç»ç»å†çš„æ—¶é—´</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">timePassed</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (response == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 4) å‡è®¾ millis æ˜¯ 1000ï¼Œç»“æœåœ¨ 400 æ—¶å”¤é†’äº†ï¼Œé‚£ä¹ˆè¿˜æœ‰ 600 è¦ç­‰</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">waitTime</span> <span class="operator">=</span> millis - timePassed;</span><br><span class="line">                log.debug(<span class="string">&quot;waitTime: &#123;&#125;&quot;</span>, waitTime);</span><br><span class="line">                <span class="keyword">if</span> (waitTime &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;break...&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    lock.wait(waitTime);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 3) å¦‚æœæå‰è¢«å”¤é†’ï¼Œè¿™æ—¶å·²ç»ç»å†çš„æ—¶é—´å‡è®¾ä¸º 400</span></span><br><span class="line">                timePassed = System.currentTimeMillis() - begin;</span><br><span class="line">                log.debug(<span class="string">&quot;timePassed: &#123;&#125;, object is null &#123;&#125;&quot;</span>,</span><br><span class="line">                        timePassed, response == <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">complete</span><span class="params">(Object response)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="comment">// æ¡ä»¶æ»¡è¶³ï¼Œé€šçŸ¥ç­‰å¾…çº¿ç¨‹</span></span><br><span class="line">            <span class="built_in">this</span>.response = response;</span><br><span class="line">            log.debug(<span class="string">&quot;notify...&quot;</span>);</span><br><span class="line">            lock.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>å¤šä»»åŠ¡ç‰ˆGuardedObject</p><p>å›¾ä¸­ Futures å°±å¥½æ¯”å±…æ°‘æ¥¼ä¸€å±‚çš„ä¿¡ç®±ï¼ˆæ¯ä¸ªä¿¡ç®±æœ‰æˆ¿é—´ç¼–å·ï¼‰ï¼Œå·¦ä¾§çš„ t0ï¼Œt2ï¼Œt4 å°±å¥½æ¯”ç­‰å¾…é‚®ä»¶çš„å±…æ°‘ï¼Œå³ä¾§çš„ t1ï¼Œt3ï¼Œt5 å°±å¥½æ¯”é‚®é€’å‘˜ ã€‚</p><p>å¦‚æœéœ€è¦åœ¨å¤šä¸ªç±»ä¹‹é—´ä½¿ç”¨ GuardedObject å¯¹è±¡ï¼Œä½œä¸ºå‚æ•°ä¼ é€’ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œå› æ­¤è®¾è®¡ä¸€ä¸ªç”¨æ¥è§£è€¦çš„ä¸­é—´ç±»ï¼Œ è¿™æ ·ä¸ä»…èƒ½å¤Ÿè§£è€¦ã€ç»“æœç­‰å¾…è€…ã€‘å’Œã€ç»“æœç”Ÿäº§è€…ã€‘ï¼Œè¿˜èƒ½å¤ŸåŒæ—¶æ”¯æŒå¤šä¸ªä»»åŠ¡çš„ç®¡ç†ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220304141821782.png" alt="image-20220304141821782"></p><div class="tabs" id="bb55dde2-f71b-47fa-aff5-45737640b7c7"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#bb55dde2-f71b-47fa-aff5-45737640b7c7-1"><i class="fas fa-cat"></i>Guarded Object</button></li><li class="tab"><button type="button" data-href="#bb55dde2-f71b-47fa-aff5-45737640b7c7-2"><i class="fas fa-horse"></i>ä¸­é—´è§£è€¦ç±»</button></li><li class="tab"><button type="button" data-href="#bb55dde2-f71b-47fa-aff5-45737640b7c7-3"><i class="fas fa-dove"></i>ä¸šåŠ¡ç›¸å…³ç±»</button></li><li class="tab"><button type="button" data-href="#bb55dde2-f71b-47fa-aff5-45737640b7c7-4"><i class="fas fa-dragon"></i>æµ‹è¯•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="bb55dde2-f71b-47fa-aff5-45737640b7c7-1"><p>æ–°å¢ id ç”¨æ¥æ ‡è¯† Guarded Object</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GuardedObject</span> &#123;</span><br><span class="line">    <span class="comment">// æ ‡è¯† Guarded Object</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GuardedObject</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç»“æœ</span></span><br><span class="line">    <span class="keyword">private</span> Object response;</span><br><span class="line">    <span class="comment">// è·å–ç»“æœ</span></span><br><span class="line">    <span class="comment">// timeout è¡¨ç¤ºè¦ç­‰å¾…å¤šä¹… 2000</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(<span class="type">long</span> timeout)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="comment">// å¼€å§‹æ—¶é—´ 15:00:00</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="comment">// ç»å†çš„æ—¶é—´</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">passedTime</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (response == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// è¿™ä¸€è½®å¾ªç¯åº”è¯¥ç­‰å¾…çš„æ—¶é—´</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">waitTime</span> <span class="operator">=</span> timeout - passedTime;</span><br><span class="line">                <span class="comment">// ç»å†çš„æ—¶é—´è¶…è¿‡äº†æœ€å¤§ç­‰å¾…æ—¶é—´æ—¶ï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">                <span class="keyword">if</span> (timeout - passedTime &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="built_in">this</span>.wait(waitTime); <span class="comment">// è™šå‡å”¤é†’ 15:00:01</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ±‚å¾—ç»å†æ—¶é—´</span></span><br><span class="line">                passedTime = System.currentTimeMillis() - begin; <span class="comment">// 15:00:02 1s</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// äº§ç”Ÿç»“æœ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">complete</span><span class="params">(Object response)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="comment">// ç»™ç»“æœæˆå‘˜å˜é‡èµ‹å€¼</span></span><br><span class="line">            <span class="built_in">this</span>.response = response;</span><br><span class="line">            <span class="built_in">this</span>.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="bb55dde2-f71b-47fa-aff5-45737640b7c7-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Mailboxes</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer, GuardedObject&gt; boxes = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// äº§ç”Ÿå”¯ä¸€ idï¼Œæ–¹æ³•å¿…é¡»å£°æ˜ä¸ºsynchronized</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">generateId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> GuardedObject <span class="title function_">getGuardedObject</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> boxes.remove(id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> GuardedObject <span class="title function_">createGuardedObject</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">GuardedObject</span> <span class="variable">go</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuardedObject</span>(generateId());</span><br><span class="line">        boxes.put(go.getId(), go);</span><br><span class="line">        <span class="keyword">return</span> go;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Integer&gt; <span class="title function_">getIds</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> boxes.keySet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="bb55dde2-f71b-47fa-aff5-45737640b7c7-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">People</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æ”¶ä¿¡</span></span><br><span class="line">        <span class="type">GuardedObject</span> <span class="variable">guardedObject</span> <span class="operator">=</span> Mailboxes.createGuardedObject();</span><br><span class="line">        log.debug(<span class="string">&quot;å¼€å§‹æ”¶ä¿¡ id:&#123;&#125;&quot;</span>, guardedObject.getId());</span><br><span class="line">        <span class="type">Object</span> <span class="variable">mail</span> <span class="operator">=</span> guardedObject.get(<span class="number">5000</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;æ”¶åˆ°ä¿¡ id:&#123;&#125;, å†…å®¹:&#123;&#125;&quot;</span>, guardedObject.getId(), mail);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Postman</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String mail;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Postman</span><span class="params">(<span class="type">int</span> id, String mail)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.mail = mail;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">GuardedObject</span> <span class="variable">guardedObject</span> <span class="operator">=</span> Mailboxes.getGuardedObject(id);</span><br><span class="line">        log.debug(<span class="string">&quot;é€ä¿¡ id:&#123;&#125;, å†…å®¹:&#123;&#125;&quot;</span>, id, mail);</span><br><span class="line">        guardedObject.complete(mail);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="bb55dde2-f71b-47fa-aff5-45737640b7c7-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">People</span>().start();</span><br><span class="line">    &#125;</span><br><span class="line">    Sleeper.sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (Integer id : Mailboxes.getIds()) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Postman</span>(id, <span class="string">&quot;å†…å®¹&quot;</span> + id).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸæ¬¡è¿è¡Œç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">35</span>:<span class="number">05.689</span> c.People [Thread-<span class="number">1</span>] - å¼€å§‹æ”¶ä¿¡ id:<span class="number">3</span></span><br><span class="line"><span class="number">10</span>:<span class="number">35</span>:<span class="number">05.689</span> c.People [Thread-<span class="number">2</span>] - å¼€å§‹æ”¶ä¿¡ id:<span class="number">1</span></span><br><span class="line"><span class="number">10</span>:<span class="number">35</span>:<span class="number">05.689</span> c.People [Thread-<span class="number">0</span>] - å¼€å§‹æ”¶ä¿¡ id:<span class="number">2</span></span><br><span class="line"><span class="number">10</span>:<span class="number">35</span>:<span class="number">06.688</span> c.Postman [Thread-<span class="number">4</span>] - é€ä¿¡ id:<span class="number">2</span>, å†…å®¹:å†…å®¹<span class="number">2</span></span><br><span class="line"><span class="number">10</span>:<span class="number">35</span>:<span class="number">06.688</span> c.Postman [Thread-<span class="number">5</span>] - é€ä¿¡ id:<span class="number">1</span>, å†…å®¹:å†…å®¹<span class="number">1</span></span><br><span class="line"><span class="number">10</span>:<span class="number">35</span>:<span class="number">06.688</span> c.People [Thread-<span class="number">0</span>] - æ”¶åˆ°ä¿¡ id:<span class="number">2</span>, å†…å®¹:å†…å®¹<span class="number">2</span></span><br><span class="line"><span class="number">10</span>:<span class="number">35</span>:<span class="number">06.688</span> c.People [Thread-<span class="number">2</span>] - æ”¶åˆ°ä¿¡ id:<span class="number">1</span>, å†…å®¹:å†…å®¹<span class="number">1</span></span><br><span class="line"><span class="number">10</span>:<span class="number">35</span>:<span class="number">06.688</span> c.Postman [Thread-<span class="number">3</span>] - é€ä¿¡ id:<span class="number">3</span>, å†…å®¹:å†…å®¹<span class="number">3</span></span><br><span class="line"><span class="number">10</span>:<span class="number">35</span>:<span class="number">06.689</span> c.People [Thread-<span class="number">1</span>] - æ”¶åˆ°ä¿¡ id:<span class="number">3</span>, å†…å®¹:å†…å®¹<span class="number">3</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="9-6-åŸç†ä¹‹-join">9.6 åŸç†ä¹‹ join</h3><p>æ˜¯è°ƒç”¨è€…è½®è¯¢æ£€æŸ¥çº¿ç¨‹ alive çŠ¶æ€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">t1.join();</span><br></pre></td></tr></table></figure><p>ç­‰ä»·äºä¸‹é¢çš„ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (t1) &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨è€…çº¿ç¨‹è¿›å…¥ t1 çš„ waitSet ç­‰å¾…, ç›´åˆ° t1 è¿è¡Œç»“æŸ</span></span><br><span class="line">    <span class="keyword">while</span> (t1.isAlive()) &#123;</span><br><span class="line">        t1.wait(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>æ³¨æ„</strong></p><p>join ä½“ç°çš„æ˜¯ã€ä¿æŠ¤æ€§æš‚åœã€‘æ¨¡å¼ï¼Œè¯·å‚è€ƒä¹‹</p></blockquote><p>æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸å¸¦å‚</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">join</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    join(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¸¦å‚</span></span><br><span class="line"><span class="comment">//ç­‰å¾…æ—¶é•¿çš„å®ç°ç±»ä¼¼äºä¹‹å‰çš„ä¿æŠ¤æ€§æš‚åœ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">join</span><span class="params">(<span class="type">long</span> millis)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">base</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (millis &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;timeout value is negative&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (millis == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">            wait(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">delay</span> <span class="operator">=</span> millis - now;</span><br><span class="line">            <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            wait(delay);</span><br><span class="line">            now = System.currentTimeMillis() - base;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-7-æ¨¡å¼ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…">9.7 æ¨¡å¼ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…</h3><p>è¦ç‚¹</p><ul><li>ä¸å‰é¢çš„ä¿æŠ¤æ€§æš‚åœä¸­çš„ GuardObject ä¸åŒï¼Œä¸éœ€è¦äº§ç”Ÿç»“æœå’Œæ¶ˆè´¹ç»“æœçš„çº¿ç¨‹ä¸€ä¸€å¯¹åº”</li><li>æ¶ˆè´¹é˜Ÿåˆ—å¯ä»¥ç”¨æ¥å¹³è¡¡ç”Ÿäº§å’Œæ¶ˆè´¹çš„çº¿ç¨‹èµ„æº</li><li>ç”Ÿäº§è€…ä»…è´Ÿè´£äº§ç”Ÿç»“æœæ•°æ®ï¼Œä¸å…³å¿ƒæ•°æ®è¯¥å¦‚ä½•å¤„ç†ï¼Œè€Œæ¶ˆè´¹è€…ä¸“å¿ƒå¤„ç†ç»“æœæ•°æ®</li><li>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æœ‰å®¹é‡é™åˆ¶çš„ï¼Œæ»¡æ—¶ä¸ä¼šå†åŠ å…¥æ•°æ®ï¼Œç©ºæ—¶ä¸ä¼šå†æ¶ˆè€—æ•°æ®</li><li>JDK ä¸­å„ç§é˜»å¡é˜Ÿåˆ—ï¼Œé‡‡ç”¨çš„å°±æ˜¯è¿™ç§æ¨¡å¼</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220304142831627.png" alt="image-20220304142831627"></p><div class="tabs" id="06619b53-37b9-4d2e-9afb-27d27fadbbeb"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#06619b53-37b9-4d2e-9afb-27d27fadbbeb-1"><i class="fas fa-dragon"></i>æ¶ˆæ¯å®ç°</button></li><li class="tab"><button type="button" data-href="#06619b53-37b9-4d2e-9afb-27d27fadbbeb-2"><i class="fas fa-seedling"></i>æ¶ˆæ¯é˜Ÿåˆ—å®ç°</button></li><li class="tab"><button type="button" data-href="#06619b53-37b9-4d2e-9afb-27d27fadbbeb-3"><i class="fas fa-leaf"></i>æµ‹è¯•</button></li><li class="tab"><button type="button" data-href="#06619b53-37b9-4d2e-9afb-27d27fadbbeb-4"><i class="fab fa-apple"></i>æµ‹è¯•ç»“æœ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="06619b53-37b9-4d2e-9afb-27d27fadbbeb-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> Object value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Message</span><span class="params">(<span class="type">int</span> id, Object value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Message&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, value=&quot;</span> + value +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="06619b53-37b9-4d2e-9afb-27d27fadbbeb-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">Class MessageQueue &#123;</span><br><span class="line">    <span class="comment">// æ¶ˆæ¯çš„é˜Ÿåˆ—é›†åˆ</span></span><br><span class="line">    <span class="keyword">private</span> LinkedList&lt;Message&gt; list = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// é˜Ÿåˆ—å®¹é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> capcity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MessageQueue</span><span class="params">(<span class="type">int</span> capcity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.capcity = capcity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">public</span> Message <span class="title function_">take</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line">            <span class="keyword">while</span>(list.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;é˜Ÿåˆ—ä¸ºç©º, æ¶ˆè´¹è€…çº¿ç¨‹ç­‰å¾…&quot;</span>);</span><br><span class="line">                    list.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ä»é˜Ÿåˆ—å¤´éƒ¨è·å–æ¶ˆæ¯å¹¶è¿”å›</span></span><br><span class="line">            <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> list.removeFirst();</span><br><span class="line">            log.debug(<span class="string">&quot;å·²æ¶ˆè´¹æ¶ˆæ¯ &#123;&#125;&quot;</span>, message);</span><br><span class="line">            list.notifyAll();</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­˜å…¥æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line">            <span class="comment">// æ£€æŸ¥å¯¹è±¡æ˜¯å¦å·²æ»¡</span></span><br><span class="line">            <span class="keyword">while</span>(list.size() == capcity) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;é˜Ÿåˆ—å·²æ»¡, ç”Ÿäº§è€…çº¿ç¨‹ç­‰å¾…&quot;</span>);</span><br><span class="line">                    list.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å°†æ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">            list.addLast(message);</span><br><span class="line">            log.debug(<span class="string">&quot;å·²ç”Ÿäº§æ¶ˆæ¯ &#123;&#125;&quot;</span>, message);</span><br><span class="line">            list.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="06619b53-37b9-4d2e-9afb-27d27fadbbeb-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">MessageQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageQueue</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> i;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            queue.put(<span class="keyword">new</span> <span class="title class_">Message</span>(id , <span class="string">&quot;å€¼&quot;</span>+id));</span><br><span class="line">        &#125;, <span class="string">&quot;ç”Ÿäº§è€…&quot;</span> + i).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">//æ¯éš”ä¸€ç§’æ¶ˆæ¯ä¸€ä¸ªæ¶ˆæ¯</span></span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">            <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> queue.take();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;æ¶ˆè´¹è€…&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="06619b53-37b9-4d2e-9afb-27d27fadbbeb-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">09:<span class="number">42</span>:<span class="number">46.548</span> c.MessageQueue [ç”Ÿäº§è€…<span class="number">0</span>] - å·²ç”Ÿäº§æ¶ˆæ¯ Message&#123;id=<span class="number">0</span>, value=å€¼<span class="number">0</span>&#125;</span><br><span class="line">09:<span class="number">42</span>:<span class="number">46.558</span> c.MessageQueue [ç”Ÿäº§è€…<span class="number">2</span>] - å·²ç”Ÿäº§æ¶ˆæ¯ Message&#123;id=<span class="number">2</span>, value=å€¼<span class="number">2</span>&#125;</span><br><span class="line">09:<span class="number">42</span>:<span class="number">46.558</span> c.MessageQueue [ç”Ÿäº§è€…<span class="number">1</span>] - é˜Ÿåˆ—å·²æ»¡, ç”Ÿäº§è€…çº¿ç¨‹ç­‰å¾…</span><br><span class="line">09:<span class="number">42</span>:<span class="number">47.548</span> c.MessageQueue [æ¶ˆè´¹è€…] - å·²æ¶ˆè´¹æ¶ˆæ¯ Message&#123;id=<span class="number">0</span>, value=å€¼<span class="number">0</span>&#125;</span><br><span class="line">09:<span class="number">42</span>:<span class="number">47.548</span> c.MessageQueue [ç”Ÿäº§è€…<span class="number">1</span>] - å·²ç”Ÿäº§æ¶ˆæ¯ Message&#123;id=<span class="number">1</span>, value=å€¼<span class="number">1</span>&#125;</span><br><span class="line">09:<span class="number">42</span>:<span class="number">48.547</span> c.MessageQueue [æ¶ˆè´¹è€…] - å·²æ¶ˆè´¹æ¶ˆæ¯ Message&#123;id=<span class="number">2</span>, value=å€¼<span class="number">2</span>&#125;</span><br><span class="line">09:<span class="number">42</span>:<span class="number">49.550</span> c.MessageQueue [æ¶ˆè´¹è€…] - å·²æ¶ˆè´¹æ¶ˆæ¯ Message&#123;id=<span class="number">1</span>, value=å€¼<span class="number">1</span>&#125;</span><br><span class="line">09:<span class="number">42</span>:<span class="number">50.552</span> c.MessageQueue [æ¶ˆè´¹è€…] - é˜Ÿåˆ—ä¸ºç©º, æ¶ˆè´¹è€…çº¿ç¨‹ç­‰å¾…</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="10-Park-Unpark">10. Park &amp; Unpark</h2><p>åŸºæœ¬ä½¿ç”¨</p><p>å®ƒä»¬æ˜¯ LockSupport ç±»ä¸­çš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æš‚åœå½“å‰çº¿ç¨‹</span></span><br><span class="line">LockSupport.park(); </span><br><span class="line"><span class="comment">// æ¢å¤æŸä¸ªçº¿ç¨‹çš„è¿è¡Œ</span></span><br><span class="line">LockSupport.unpark(æš‚åœçº¿ç¨‹å¯¹è±¡)</span><br></pre></td></tr></table></figure><div class="tabs" id="549b0847-55b6-44cd-b3e9-c4a1bb32a189"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#549b0847-55b6-44cd-b3e9-c4a1bb32a189-1"><i class="fas fa-atom"></i>å…ˆ park å† unpark</button></li><li class="tab"><button type="button" data-href="#549b0847-55b6-44cd-b3e9-c4a1bb32a189-2"><i class="far fa-sun"></i>è¾“å‡º</button></li><li class="tab"><button type="button" data-href="#549b0847-55b6-44cd-b3e9-c4a1bb32a189-3"><i class="fas fa-wind"></i>å…ˆ unpark å† park</button></li><li class="tab"><button type="button" data-href="#549b0847-55b6-44cd-b3e9-c4a1bb32a189-4"><i class="fas fa-fire-alt"></i>è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="549b0847-55b6-44cd-b3e9-c4a1bb32a189-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    log.debug(<span class="string">&quot;park...&quot;</span>);</span><br><span class="line">    LockSupport.park();</span><br><span class="line">    log.debug(<span class="string">&quot;resume...&quot;</span>);</span><br><span class="line">&#125;,<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">t1.start();</span><br><span class="line">sleep(<span class="number">2</span>);</span><br><span class="line">log.debug(<span class="string">&quot;unpark...&quot;</span>);</span><br><span class="line">LockSupport.unpark(t1);</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="549b0847-55b6-44cd-b3e9-c4a1bb32a189-2"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">18:42:52.585 c.TestParkUnpark [t1] - start... </span><br><span class="line">18:42:53.589 c.TestParkUnpark [t1] - park... </span><br><span class="line">18:42:54.583 c.TestParkUnpark [main] - unpark... </span><br><span class="line">18:42:54.583 c.TestParkUnpark [t1] - resume... </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="549b0847-55b6-44cd-b3e9-c4a1bb32a189-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    log.debug(<span class="string">&quot;park...&quot;</span>);</span><br><span class="line">    LockSupport.park();</span><br><span class="line">    log.debug(<span class="string">&quot;resume...&quot;</span>);</span><br><span class="line">&#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">t1.start();</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">log.debug(<span class="string">&quot;unpark...&quot;</span>);</span><br><span class="line">LockSupport.unpark(t1);</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="549b0847-55b6-44cd-b3e9-c4a1bb32a189-4"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">18:43:50.765 c.TestParkUnpark [t1] - start... </span><br><span class="line">18:43:51.764 c.TestParkUnpark [main] - unpark... </span><br><span class="line">18:43:52.769 c.TestParkUnpark [t1] - park... </span><br><span class="line">18:43:52.769 c.TestParkUnpark [t1] - resume... </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <p>ç‰¹ç‚¹</p><blockquote><p>ä¸ Object çš„ wait &amp; notify ç›¸æ¯”</p><ul><li>waitï¼Œnotify å’Œ notifyAll å¿…é¡»é…åˆ Object Monitor ä¸€èµ·ä½¿ç”¨ï¼Œè€Œ parkï¼Œunpark ä¸å¿…</li><li>park &amp; unpark æ˜¯ä»¥çº¿ç¨‹ä¸ºå•ä½æ¥ã€é˜»å¡ã€‘å’Œã€å”¤é†’ã€‘çº¿ç¨‹ï¼Œè€Œ notify åªèƒ½éšæœºå”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼ŒnotifyAll  æ˜¯å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œå°±ä¸é‚£ä¹ˆã€ç²¾ç¡®ã€‘</li><li>park &amp; unpark å¯ä»¥å…ˆ unparkï¼Œè€Œ wait &amp; notify ä¸èƒ½å…ˆ notify</li></ul></blockquote><h3 id="10-1-åŸç†ä¹‹parkå’Œunpark">10.1 åŸç†ä¹‹parkå’Œunpark</h3><p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ª Parker å¯¹è±¡(ç”±C++ç¼–å†™ï¼Œjavaä¸­ä¸å¯è§)ï¼Œç”±ä¸‰éƒ¨åˆ†ç»„æˆ <code>_counter </code>ï¼Œ <code>_cond </code>å’Œ <code>_mutex</code> æ‰“ä¸ªæ¯”å–»</p><ul><li>çº¿ç¨‹å°±åƒä¸€ä¸ªæ—…äººï¼ŒParker å°±åƒä»–éšèº«æºå¸¦çš„èƒŒåŒ…ï¼Œæ¡ä»¶å˜é‡å°±å¥½æ¯”èƒŒåŒ…ä¸­çš„å¸ç¯·ã€‚_counter å°±å¥½æ¯”èƒŒåŒ…ä¸­ çš„å¤‡ç”¨å¹²ç²®ï¼ˆ0 ä¸ºè€—å°½ï¼Œ1 ä¸ºå……è¶³ï¼‰</li><li>è°ƒç”¨ park å°±æ˜¯è¦çœ‹éœ€ä¸éœ€è¦åœä¸‹æ¥æ­‡æ¯<ul><li>å¦‚æœå¤‡ç”¨å¹²ç²®è€—å°½ï¼Œé‚£ä¹ˆé’»è¿›å¸ç¯·æ­‡æ¯</li><li>å¦‚æœå¤‡ç”¨å¹²ç²®å……è¶³ï¼Œé‚£ä¹ˆä¸éœ€åœç•™ï¼Œç»§ç»­å‰è¿›</li></ul></li><li>è°ƒç”¨ unparkï¼Œå°±å¥½æ¯”ä»¤å¹²ç²®å……è¶³<ul><li>å¦‚æœè¿™æ—¶çº¿ç¨‹è¿˜åœ¨å¸ç¯·ï¼Œå°±å”¤é†’è®©ä»–ç»§ç»­å‰è¿›</li><li>å¦‚æœè¿™æ—¶çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆä¸‹æ¬¡ä»–è°ƒç”¨ park æ—¶ï¼Œä»…æ˜¯æ¶ˆè€—æ‰å¤‡ç”¨å¹²ç²®ï¼Œä¸éœ€åœç•™ç»§ç»­å‰è¿›<ul><li>å› ä¸ºèƒŒåŒ…ç©ºé—´æœ‰é™ï¼Œå¤šæ¬¡è°ƒç”¨ unpark ä»…ä¼šè¡¥å……ä¸€ä»½å¤‡ç”¨å¹²ç²®</li></ul></li></ul></li></ul><div class="tabs" id="39df6706-9f63-496c-b263-5bd8ebeacb7f"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#39df6706-9f63-496c-b263-5bd8ebeacb7f-1"><i class="fas fa-cat"></i>æƒ…å†µä¸€</button></li><li class="tab"><button type="button" data-href="#39df6706-9f63-496c-b263-5bd8ebeacb7f-2"><i class="fas fa-horse"></i>æƒ…å†µäºŒ</button></li><li class="tab"><button type="button" data-href="#39df6706-9f63-496c-b263-5bd8ebeacb7f-3"><i class="fas fa-dove"></i>æƒ…å†µä¸‰</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="39df6706-9f63-496c-b263-5bd8ebeacb7f-1"><ol><li>å½“å‰çº¿ç¨‹è°ƒç”¨ Unsafe.park() æ–¹æ³•</li><li>æ£€æŸ¥ _counter ï¼Œæœ¬æƒ…å†µä¸º 0ï¼Œè¿™æ—¶ï¼Œè·å¾— _mutex äº’æ–¥é”</li><li>çº¿ç¨‹è¿›å…¥ _cond æ¡ä»¶å˜é‡é˜»å¡</li><li>è®¾ç½® _counter = 0</li></ol><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220304144415441.png" alt="image-20220304144415441"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="39df6706-9f63-496c-b263-5bd8ebeacb7f-2"><ol><li>è°ƒç”¨ Unsafe.unpark(Thread_0) æ–¹æ³•ï¼Œè®¾ç½® _counter ä¸º 1</li><li>å”¤é†’ _cond æ¡ä»¶å˜é‡ä¸­çš„ Thread_0</li><li>Thread_0 æ¢å¤è¿è¡Œ</li><li>è®¾ç½® _counter ä¸º 0</li></ol><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220304144548871.png" alt="image-20220304144548871"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="39df6706-9f63-496c-b263-5bd8ebeacb7f-3"><ol><li>è°ƒç”¨ Unsafe.unpark(Thread_0) æ–¹æ³•ï¼Œè®¾ç½® _counter ä¸º 1</li><li>å½“å‰çº¿ç¨‹è°ƒç”¨ Unsafe.park() æ–¹æ³•</li><li>æ£€æŸ¥ _counter ï¼Œæœ¬æƒ…å†µä¸º 1ï¼Œè¿™æ—¶çº¿ç¨‹æ— éœ€é˜»å¡ï¼Œç»§ç»­è¿è¡Œ</li><li>è®¾ç½® _counter ä¸º 0</li></ol><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220304144626180.png" alt="image-20220304144626180"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="11-é‡æ–°ç†è§£çº¿ç¨‹çŠ¶æ€è½¬æ¢">11. é‡æ–°ç†è§£çº¿ç¨‹çŠ¶æ€è½¬æ¢</h2><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220304151245960.png" alt="image-20220304151245960"></p><p>å‡è®¾æœ‰çº¿ç¨‹ <code>Thread t</code></p><div class="tabs" id="cc24504c-fd6f-4944-8865-bde78ce984ad"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#cc24504c-fd6f-4944-8865-bde78ce984ad-1"><i class="fas fa-cat"></i>1</button></li><li class="tab"><button type="button" data-href="#cc24504c-fd6f-4944-8865-bde78ce984ad-2"><i class="fas fa-horse"></i>2</button></li><li class="tab"><button type="button" data-href="#cc24504c-fd6f-4944-8865-bde78ce984ad-3"><i class="fas fa-dove"></i>3</button></li><li class="tab"><button type="button" data-href="#cc24504c-fd6f-4944-8865-bde78ce984ad-4"><i class="fas fa-dragon"></i>4</button></li><li class="tab"><button type="button" data-href="#cc24504c-fd6f-4944-8865-bde78ce984ad-5"><i class="fas fa-atom"></i>5</button></li><li class="tab"><button type="button" data-href="#cc24504c-fd6f-4944-8865-bde78ce984ad-6"><i class="far fa-sun"></i>6</button></li><li class="tab"><button type="button" data-href="#cc24504c-fd6f-4944-8865-bde78ce984ad-7"><i class="fas fa-wind"></i>7</button></li><li class="tab"><button type="button" data-href="#cc24504c-fd6f-4944-8865-bde78ce984ad-8"><i class="fas fa-fire-alt"></i>8</button></li><li class="tab"><button type="button" data-href="#cc24504c-fd6f-4944-8865-bde78ce984ad-9"><i class="fab fa-apple"></i>9</button></li><li class="tab"><button type="button" data-href="#cc24504c-fd6f-4944-8865-bde78ce984ad-10"><i class="fas fa-tree"></i>10</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="cc24504c-fd6f-4944-8865-bde78ce984ad-1"><p>NEW-&gt;RUNNABLE</p><p>å½“è°ƒç”¨ <code>t.start()</code> æ–¹æ³•æ—¶ï¼Œç”± NEW --&gt; RUNNABLE</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cc24504c-fd6f-4944-8865-bde78ce984ad-2"><p>RUNNABLE&lt;-&gt;WAITING</p><p><strong>t çº¿ç¨‹</strong>ç”¨ <code>synchronized(obj)</code> è·å–äº†å¯¹è±¡é”å</p><ul><li>è°ƒç”¨ <code>obj.wait()</code> æ–¹æ³•æ—¶ï¼Œ<strong>t çº¿ç¨‹</strong>ä» <code>RUNNABLE --&gt; WAITING</code></li><li>è°ƒç”¨ <code>obj.notify()</code> ï¼Œ <code>obj.notifyAll()</code> ï¼Œ <code>t.interrupt()</code> æ—¶<ul><li>ç«äº‰é”æˆåŠŸï¼Œ<strong>t çº¿ç¨‹</strong>ä» <code>WAITING --&gt; RUNNABLE</code></li><li>ç«äº‰é”å¤±è´¥ï¼Œ<strong>t çº¿ç¨‹</strong>ä» `WAITING --&gt; BLOCKED</li></ul></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cc24504c-fd6f-4944-8865-bde78ce984ad-3"><p>RUNNABLE&lt;-&gt;WAITING</p><ul><li><strong>å½“å‰çº¿ç¨‹</strong>è°ƒç”¨ <code>t.join()</code> æ–¹æ³•æ—¶ï¼Œ<strong>å½“å‰çº¿ç¨‹</strong>ä» <code>RUNNABLE --&gt; WAITING</code> æ³¨æ„æ˜¯<strong>å½“å‰çº¿ç¨‹</strong>åœ¨<strong>t çº¿ç¨‹å¯¹è±¡</strong>çš„ç›‘è§†å™¨ä¸Šç­‰å¾…</li><li><strong>t çº¿ç¨‹</strong>è¿è¡Œç»“æŸï¼Œæˆ–è°ƒç”¨äº†<strong>å½“å‰çº¿ç¨‹</strong>çš„ interrupt() æ—¶ï¼Œå½“å‰çº¿ç¨‹ä» <code>WAITING --&gt; RUNNABLE</code></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cc24504c-fd6f-4944-8865-bde78ce984ad-4"><p>RUNNABLE&lt;-&gt;WAITING</p><ul><li><strong>å½“å‰çº¿ç¨‹</strong>è°ƒç”¨ <code>LockSupport.park()</code> æ–¹æ³•ä¼šè®©<strong>å½“å‰çº¿ç¨‹</strong>ä» <code>RUNNABLE --&gt; WAITING</code></li><li>è°ƒç”¨ <code>LockSupport.unpark</code>(ç›®æ ‡çº¿ç¨‹) æˆ–è°ƒç”¨äº†çº¿ç¨‹ çš„ <code>interrupt()</code> ï¼Œä¼šè®©ç›®æ ‡çº¿ç¨‹ä» <code>WAITING --&gt;  RUNNABLE</code></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cc24504c-fd6f-4944-8865-bde78ce984ad-5"><p>RUNNABLE&lt;-&gt;TIMED_WAITING</p><p><strong>t çº¿ç¨‹</strong>ç”¨ <code>synchronized(obj)</code> è·å–äº†å¯¹è±¡é”å</p><ul><li>è°ƒç”¨ <code>obj.wait(long n)</code> æ–¹æ³•æ—¶ï¼Œ<strong>t çº¿ç¨‹</strong>ä» <code>RUNNABLE --&gt; TIMED_WAITING</code></li><li><strong>t çº¿ç¨‹</strong>ç­‰å¾…æ—¶é—´è¶…è¿‡äº† n æ¯«ç§’ï¼Œæˆ–è°ƒç”¨ <code>obj.notify()</code> ï¼Œ <code>obj.notifyAll()</code> ï¼Œ<code>t.interrupt()</code>æ—¶<ul><li>ç«äº‰é”æˆåŠŸï¼Œ<strong>t çº¿ç¨‹</strong>ä» <code>TIMED_WAITING --&gt; RUNNABLE</code></li><li>ç«äº‰é”å¤±è´¥ï¼Œ<strong>t çº¿ç¨‹</strong>ä» <code>TIMED_WAITING --&gt; BLOCKED</code></li></ul></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cc24504c-fd6f-4944-8865-bde78ce984ad-6"><p>RUNNABLE&lt;-&gt;TIMED_WAITING</p><ul><li><strong>å½“å‰çº¿ç¨‹</strong>è°ƒç”¨ <code>t.join(long n)</code> æ–¹æ³•æ—¶ï¼Œ<strong>å½“å‰çº¿ç¨‹</strong>ä» <code>RUNNABLE --&gt; TIMED_WAITING</code> æ³¨æ„æ˜¯å½“å‰çº¿ç¨‹åœ¨<strong>t çº¿ç¨‹</strong>å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…</li><li><strong>å½“å‰çº¿ç¨‹</strong>ç­‰å¾…æ—¶é—´è¶…è¿‡äº† n æ¯«ç§’ï¼Œæˆ–<strong>t çº¿ç¨‹</strong>è¿è¡Œç»“æŸï¼Œæˆ–è°ƒç”¨äº†<strong>å½“å‰çº¿ç¨‹</strong>çš„ <code>interrupt()</code> æ—¶ï¼Œå½“å‰çº¿ç¨‹ä» <code>TIMED_WAITING --&gt; RUNNABLE</code></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cc24504c-fd6f-4944-8865-bde78ce984ad-7"><p>RUNNABLE&lt;-&gt;TIMED_WAITING</p><ul><li><strong>å½“å‰çº¿ç¨‹</strong>è°ƒç”¨ <code>Thread.sleep(long n)</code> ï¼Œ<strong>å½“å‰çº¿ç¨‹</strong>ä» <code>RUNNABLE --&gt; TIMED_WAITING</code></li><li><strong>å½“å‰çº¿ç¨‹</strong>ç­‰å¾…æ—¶é—´è¶…è¿‡äº† n æ¯«ç§’ï¼Œ<strong>å½“å‰çº¿ç¨‹</strong>ä» <code>TIMED_WAITING --&gt; RUNNABLE</code></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cc24504c-fd6f-4944-8865-bde78ce984ad-8"><p>RUNNABLE&lt;-&gt;TIMED_WAITIN</p><ul><li><strong>å½“å‰çº¿ç¨‹</strong>è°ƒç”¨ <code>LockSupport.parkNanos(long nanos)</code> æˆ– <code>LockSupport.parkUntil(long millis)</code> æ—¶ï¼Œ<strong>å½“å‰çº¿ç¨‹</strong>ä» <code>RUNNABLE --&gt; TIMED_WAITING </code></li><li>è°ƒç”¨ <code>LockSupport.unpark</code>(ç›®æ ‡çº¿ç¨‹) æˆ–è°ƒç”¨äº†çº¿ç¨‹ çš„ <code>interrupt()</code> ï¼Œæˆ–æ˜¯ç­‰å¾…è¶…æ—¶ï¼Œä¼šè®©ç›®æ ‡çº¿ç¨‹ä» <code>TIMED_WAITING--&gt; RUNNABLE</code></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cc24504c-fd6f-4944-8865-bde78ce984ad-9"><p>RUNNABLE&lt;-&gt;BLOCKED</p><ul><li><strong>t çº¿ç¨‹</strong>ç”¨ <code>synchronized(obj)</code> è·å–äº†å¯¹è±¡é”æ—¶å¦‚æœç«äº‰å¤±è´¥ï¼Œä» <code>RUNNABLE --&gt; BLOCKED</code></li><li>æŒ obj é”çº¿ç¨‹çš„åŒæ­¥ä»£ç å—æ‰§è¡Œå®Œæ¯•ï¼Œä¼šå”¤é†’è¯¥å¯¹è±¡ä¸Šæ‰€æœ‰ <code>BLOCKED</code> çš„çº¿ç¨‹é‡æ–°ç«äº‰ï¼Œå¦‚æœå…¶ä¸­ <strong>t çº¿ç¨‹</strong>ç«äº‰ æˆåŠŸï¼Œä» <code>BLOCKED --&gt; RUNNABLE</code> ï¼Œå…¶å®ƒå¤±è´¥çš„çº¿ç¨‹ä»ç„¶ <code>BLOCKED</code></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cc24504c-fd6f-4944-8865-bde78ce984ad-10"><p>RUNNABLE&lt;-&gt;TERMINATED</p><p>å½“å‰çº¿ç¨‹æ‰€æœ‰ä»£ç è¿è¡Œå®Œæ¯•ï¼Œè¿›å…¥ <code>TERMINATED</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="12-å¤šæŠŠé”">12. å¤šæŠŠé”</h2><p><strong>å¤šæŠŠä¸ç›¸å¹²çš„é”</strong></p><p>ä¸€é—´å¤§å±‹å­æœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼šç¡è§‰ã€å­¦ä¹ ï¼Œäº’ä¸ç›¸å¹²ã€‚</p><p>ç°åœ¨å°å—è¦å­¦ä¹ ï¼Œå°å¥³è¦ç¡è§‰ï¼Œä½†å¦‚æœåªç”¨ä¸€é—´å±‹å­ï¼ˆä¸€ä¸ªå¯¹è±¡é”ï¼‰çš„è¯ï¼Œé‚£ä¹ˆå¹¶å‘åº¦å¾ˆä½</p><p>è§£å†³æ–¹æ³•æ˜¯å‡†å¤‡å¤šä¸ªæˆ¿é—´ï¼ˆå¤šä¸ªå¯¹è±¡é”ï¼‰</p><div class="tabs" id="2e4e6892-7182-42f4-8bd2-c0a51fbe73fd"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2e4e6892-7182-42f4-8bd2-c0a51fbe73fd-1"><i class="fas fa-seedling"></i>ä¾‹å­</button></li><li class="tab"><button type="button" data-href="#2e4e6892-7182-42f4-8bd2-c0a51fbe73fd-2"><i class="fas fa-leaf"></i>æ‰§è¡Œ&ç»“æœ</button></li><li class="tab"><button type="button" data-href="#2e4e6892-7182-42f4-8bd2-c0a51fbe73fd-3"><i class="fab fa-apple"></i>æ”¹è¿›</button></li><li class="tab"><button type="button" data-href="#2e4e6892-7182-42f4-8bd2-c0a51fbe73fd-4"><i class="fas fa-tree"></i>æ‰§è¡Œç»“æœ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2e4e6892-7182-42f4-8bd2-c0a51fbe73fd-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BigRoom</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;sleeping 2 å°æ—¶&quot;</span>);</span><br><span class="line">            Sleeper.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">study</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;study 1 å°æ—¶&quot;</span>);</span><br><span class="line">            Sleeper.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2e4e6892-7182-42f4-8bd2-c0a51fbe73fd-2"><p>æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BigRoom</span> <span class="variable">bigRoom</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigRoom</span>();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    bigRoom.compute();</span><br><span class="line">&#125;,<span class="string">&quot;å°å—&quot;</span>).start();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    bigRoom.sleep();</span><br><span class="line">&#125;,<span class="string">&quot;å°å¥³&quot;</span>).start();</span><br></pre></td></tr></table></figure><p>ç»“æœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">12:13:54.471 [å°å—] c.BigRoom - study 1 å°æ—¶</span><br><span class="line">12:13:55.476 [å°å¥³] c.BigRoom - sleeping 2 å°æ—¶</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2e4e6892-7182-42f4-8bd2-c0a51fbe73fd-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BigRoom</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">studyRoom</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">bedRoom</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (bedRoom) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;sleeping 2 å°æ—¶&quot;</span>);</span><br><span class="line">            Sleeper.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">study</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (studyRoom) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;study 1 å°æ—¶&quot;</span>);</span><br><span class="line">            Sleeper.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2e4e6892-7182-42f4-8bd2-c0a51fbe73fd-4"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">12:15:35.069 [å°å—] c.BigRoom - study 1 å°æ—¶</span><br><span class="line">12:15:35.069 [å°å¥³] c.BigRoom - sleeping 2 å°æ—¶</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>å°†é”çš„ç²’åº¦ç»†åˆ†</p><ul><li>å¥½å¤„ï¼Œæ˜¯å¯ä»¥å¢å¼ºå¹¶å‘åº¦</li><li>åå¤„ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å¾—å¤šæŠŠé”ï¼Œå°±å®¹æ˜“å‘ç”Ÿæ­»é”</li><li>å‰æï¼šä¸¤æŠŠé”é”ä½çš„ä¸¤æ®µä»£ç äº’ä¸ç›¸å…³</li></ul><h2 id="13-æ´»è·ƒæ€§">13. æ´»è·ƒæ€§</h2><h3 id="13-1-æ­»é”">13.1 æ­»é”</h3><p>æœ‰è¿™æ ·çš„æƒ…å†µï¼šä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å–å¤šæŠŠé”ï¼Œè¿™æ—¶å°±å®¹æ˜“å‘ç”Ÿæ­»é”</p><p><code>t1 çº¿ç¨‹</code> è·å¾— <code>Aå¯¹è±¡</code> é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å– <code>Bå¯¹è±¡</code> çš„é”</p><p><code>t2 çº¿ç¨‹</code> è·å¾— <code>Bå¯¹è±¡</code> é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å– <code>Aå¯¹è±¡</code> çš„é”</p><p>ä¾‹ï¼š</p><div class="tabs" id="fbfd646f-a763-4991-bacf-ad453492eaa5"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#fbfd646f-a763-4991-bacf-ad453492eaa5-1"><i class="fas fa-wind"></i>æ­»é”ç¤ºä¾‹</button></li><li class="tab"><button type="button" data-href="#fbfd646f-a763-4991-bacf-ad453492eaa5-2"><i class="fas fa-fire-alt"></i>å®šä½æ­»é”</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="fbfd646f-a763-4991-bacf-ad453492eaa5-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">A</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="type">Object</span> <span class="variable">B</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (A) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;lock A&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">synchronized</span> (B) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;lock B&quot;</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;æ“ä½œ...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line"><span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (B) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;lock B&quot;</span>);</span><br><span class="line">        sleep(<span class="number">0.5</span>);</span><br><span class="line">        <span class="keyword">synchronized</span> (A) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;lock A&quot;</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;æ“ä½œ...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">t1.start();</span><br><span class="line">t2.start();</span><br></pre></td></tr></table></figure><p>ç»“æœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">12:22:06.962 [t2] c.TestDeadLock - lock B </span><br><span class="line">12:22:06.962 [t1] c.TestDeadLock - lock A</span><br></pre></td></tr></table></figure><p>è§£å†³æ–¹å¼ï¼š</p><ul><li>ReentrantLock</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="fbfd646f-a763-4991-bacf-ad453492eaa5-2"><p>æ£€æµ‹æ­»é”å¯ä»¥ä½¿ç”¨ jconsoleå·¥å…·ï¼Œæˆ–è€…ä½¿ç”¨ jps å®šä½è¿›ç¨‹ idï¼Œå†ç”¨ jstack å®šä½æ­»é”ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cmd &gt; jps</span><br><span class="line">Picked up JAVA_TOOL_OPTIONS: -Dfile.encoding=UTF-8</span><br><span class="line">12320 Jps</span><br><span class="line">22816 KotlinCompileDaemon</span><br><span class="line">33200 TestDeadLock // JVM è¿›ç¨‹</span><br><span class="line">11508 Main</span><br><span class="line">28468 Launcher</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cmd &gt; jstack 33200</span><br><span class="line"></span><br><span class="line">Found one Java-level deadlock:</span><br><span class="line">=============================</span><br><span class="line"><span class="string">&quot;Thread-1&quot;</span>:</span><br><span class="line"> waiting to lock monitor 0x000000000361d378 (object 0x000000076b5bf1c0, a java.lang.Object),</span><br><span class="line"> <span class="built_in">which</span> is held by <span class="string">&quot;Thread-0&quot;</span></span><br><span class="line"><span class="string">&quot;Thread-0&quot;</span>:</span><br><span class="line"> waiting to lock monitor 0x000000000361e768 (object 0x000000076b5bf1d0, a java.lang.Object),</span><br><span class="line"> <span class="built_in">which</span> is held by <span class="string">&quot;Thread-1&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>é¿å…æ­»é”è¦æ³¨æ„åŠ é”é¡ºåº</li><li>å¦å¤–å¦‚æœç”±äºæŸä¸ªçº¿ç¨‹è¿›å…¥äº†æ­»å¾ªç¯ï¼Œå¯¼è‡´å…¶å®ƒçº¿ç¨‹ä¸€ç›´ç­‰å¾…ï¼Œå¯¹äºè¿™ç§æƒ…å†µ linux ä¸‹å¯ä»¥é€šè¿‡ top å…ˆå®šä½åˆ° CPU å ç”¨é«˜çš„ Java è¿›ç¨‹ï¼Œå†åˆ©ç”¨ top -Hp è¿›ç¨‹id æ¥å®šä½æ˜¯å“ªä¸ªçº¿ç¨‹ï¼Œæœ€åå†ç”¨ jstack æ’æŸ¥</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <h3 id="13-2-å“²å­¦å®¶å°±é¤é—®é¢˜">13.2 å“²å­¦å®¶å°±é¤é—®é¢˜</h3><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230331110454999.png" alt="image-20230331110454999" style="zoom:33%;" /><p>æœ‰äº”ä½å“²å­¦å®¶ï¼Œå›´ååœ¨åœ†æ¡Œæ—ã€‚</p><ul><li>ä»–ä»¬åªåšä¸¤ä»¶äº‹ï¼Œæ€è€ƒå’Œåƒé¥­ï¼Œæ€è€ƒä¸€ä¼šåƒå£é¥­ï¼Œåƒå®Œé¥­åæ¥ç€æ€è€ƒã€‚</li><li>åƒé¥­æ—¶è¦ç”¨ä¸¤æ ¹ç­·å­åƒï¼Œæ¡Œä¸Šå…±æœ‰ 5 æ ¹ç­·å­ï¼Œæ¯ä½å“²å­¦å®¶å·¦å³æ‰‹è¾¹å„æœ‰ä¸€æ ¹ç­·å­ã€‚</li><li>å¦‚æœç­·å­è¢«èº«è¾¹çš„äººæ‹¿ç€ï¼Œè‡ªå·±å°±å¾—ç­‰å¾…</li></ul><div class="tabs" id="7cbaa0d2-e3c1-4597-8593-412d0a0583fd"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#7cbaa0d2-e3c1-4597-8593-412d0a0583fd-1"><i class="fas fa-seedling"></i>ç­·å­ç±»</button></li><li class="tab"><button type="button" data-href="#7cbaa0d2-e3c1-4597-8593-412d0a0583fd-2"><i class="fas fa-leaf"></i>å“²å­¦å®¶ç±»</button></li><li class="tab"><button type="button" data-href="#7cbaa0d2-e3c1-4597-8593-412d0a0583fd-3"><i class="fab fa-apple"></i>å°±é¤</button></li><li class="tab"><button type="button" data-href="#7cbaa0d2-e3c1-4597-8593-412d0a0583fd-4"><i class="fas fa-tree"></i>æ£€æµ‹æ­»é”</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="7cbaa0d2-e3c1-4597-8593-412d0a0583fd-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Chopstick</span> &#123;</span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Chopstick</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ç­·å­&#123;&quot;</span> + name + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="7cbaa0d2-e3c1-4597-8593-412d0a0583fd-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Philosopher</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    Chopstick left;</span><br><span class="line">    Chopstick right;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Philosopher</span><span class="params">(String name, Chopstick left, Chopstick right)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name);</span><br><span class="line">        <span class="built_in">this</span>.left = left;</span><br><span class="line">        <span class="built_in">this</span>.right = right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">//ã€€å°è¯•è·å¾—å·¦æ‰‹ç­·å­</span></span><br><span class="line">            <span class="keyword">synchronized</span> (left) &#123;</span><br><span class="line">                <span class="comment">// å°è¯•è·å¾—å³æ‰‹ç­·å­</span></span><br><span class="line">                <span class="keyword">synchronized</span> (right) &#123;</span><br><span class="line">                    eat();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;eating...&quot;</span>);</span><br><span class="line">        Sleeper.sleep(<span class="number">0.5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="7cbaa0d2-e3c1-4597-8593-412d0a0583fd-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Chopstick</span> <span class="variable">c1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="type">Chopstick</span> <span class="variable">c2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    <span class="type">Chopstick</span> <span class="variable">c3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">    <span class="type">Chopstick</span> <span class="variable">c4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">    <span class="type">Chopstick</span> <span class="variable">c5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;5&quot;</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;è‹æ ¼æ‹‰åº•&quot;</span>, c1, c2).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;æŸæ‹‰å›¾&quot;</span>, c2, c3).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;äºšé‡Œå£«å¤šå¾·&quot;</span>, c3, c4).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;èµ«æ‹‰å…‹åˆ©ç‰¹&quot;</span>, c4, c5).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;é˜¿åŸºç±³å¾·&quot;</span>, c1, c5).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä¸å¤šä¼šï¼Œå°±æ‰§è¡Œä¸ä¸‹å»äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span>:<span class="number">33</span>:<span class="number">15.575</span> [è‹æ ¼æ‹‰åº•] c.Philosopher - eating...</span><br><span class="line"></span><br><span class="line"><span class="number">12</span>:<span class="number">33</span>:<span class="number">15.575</span> [äºšé‡Œå£«å¤šå¾·] c.Philosopher - eating...</span><br><span class="line"></span><br><span class="line"><span class="number">12</span>:<span class="number">33</span>:<span class="number">16.580</span> [é˜¿åŸºç±³å¾·] c.Philosopher - eating...</span><br><span class="line"></span><br><span class="line"><span class="number">12</span>:<span class="number">33</span>:<span class="number">17.580</span> [é˜¿åŸºç±³å¾·] c.Philosopher - eating...</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¡åœ¨è¿™é‡Œ, ä¸å‘ä¸‹è¿è¡Œ</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="7cbaa0d2-e3c1-4597-8593-412d0a0583fd-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">-------------------------------------------------------------------------</span><br><span class="line">åç§°: é˜¿åŸºç±³å¾·</span><br><span class="line">çŠ¶æ€: cn.itcast.Chopstick@<span class="number">1540e19d</span> (ç­·å­<span class="number">1</span>) ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: è‹æ ¼æ‹‰åº•</span><br><span class="line">æ€»é˜»æ­¢æ•°: <span class="number">2</span>, æ€»ç­‰å¾…æ•°: <span class="number">1</span></span><br><span class="line">å †æ ˆè·Ÿè¸ª:</span><br><span class="line">cn.itcast.Philosopher.run(TestDinner.java:<span class="number">48</span>)</span><br><span class="line">- å·²é”å®š cn.itcast.Chopstick@6d6f6e28 (ç­·å­<span class="number">5</span>)</span><br><span class="line">-------------------------------------------------------------------------</span><br><span class="line">åç§°: è‹æ ¼æ‹‰åº•</span><br><span class="line">çŠ¶æ€: cn.itcast.Chopstick@677327b6 (ç­·å­<span class="number">2</span>) ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: æŸæ‹‰å›¾</span><br><span class="line">æ€»é˜»æ­¢æ•°: <span class="number">2</span>, æ€»ç­‰å¾…æ•°: <span class="number">1</span></span><br><span class="line">å †æ ˆè·Ÿè¸ª:</span><br><span class="line">cn.itcast.Philosopher.run(TestDinner.java:<span class="number">48</span>)</span><br><span class="line">- å·²é”å®š cn.itcast.Chopstick@<span class="number">1540e19d</span> (ç­·å­<span class="number">1</span>)</span><br><span class="line">-------------------------------------------------------------------------</span><br><span class="line">åç§°: æŸæ‹‰å›¾</span><br><span class="line">çŠ¶æ€: cn.itcast.Chopstick@14ae5a5 (ç­·å­<span class="number">3</span>) ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: äºšé‡Œå£«å¤šå¾·</span><br><span class="line">æ€»é˜»æ­¢æ•°: <span class="number">2</span>, æ€»ç­‰å¾…æ•°: <span class="number">0</span></span><br><span class="line">å †æ ˆè·Ÿè¸ª:</span><br><span class="line">cn.itcast.Philosopher.run(TestDinner.java:<span class="number">48</span>)</span><br><span class="line">- å·²é”å®š cn.itcast.Chopstick@677327b6 (ç­·å­<span class="number">2</span>)</span><br><span class="line">-------------------------------------------------------------------------</span><br><span class="line">åç§°: äºšé‡Œå£«å¤šå¾·</span><br><span class="line">çŠ¶æ€: cn.itcast.Chopstick@7f31245a (ç­·å­<span class="number">4</span>) ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: èµ«æ‹‰å…‹åˆ©ç‰¹</span><br><span class="line">æ€»é˜»æ­¢æ•°: <span class="number">1</span>, æ€»ç­‰å¾…æ•°: <span class="number">1</span></span><br><span class="line">å †æ ˆè·Ÿè¸ª:</span><br><span class="line">cn.itcast.Philosopher.run(TestDinner.java:<span class="number">48</span>)</span><br><span class="line">- å·²é”å®š cn.itcast.Chopstick@14ae5a5 (ç­·å­<span class="number">3</span>)</span><br><span class="line">-------------------------------------------------------------------------</span><br><span class="line">åç§°: èµ«æ‹‰å…‹åˆ©ç‰¹</span><br><span class="line">çŠ¶æ€: cn.itcast.Chopstick@6d6f6e28 (ç­·å­<span class="number">5</span>) ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: é˜¿åŸºç±³å¾·</span><br><span class="line">æ€»é˜»æ­¢æ•°: <span class="number">2</span>, æ€»ç­‰å¾…æ•°: <span class="number">0</span></span><br><span class="line">å †æ ˆè·Ÿè¸ª:</span><br><span class="line">cn.itcast.Philosopher.run(TestDinner.java:<span class="number">48</span>)</span><br><span class="line">- å·²é”å®š cn.itcast.Chopstick@7f31245a (ç­·å­<span class="number">4</span>)</span><br></pre></td></tr></table></figure><p>è¿™ç§çº¿ç¨‹æ²¡æœ‰æŒ‰é¢„æœŸç»“æŸï¼Œæ‰§è¡Œä¸ä¸‹å»çš„æƒ…å†µï¼Œå½’ç±»ä¸ºã€æ´»è·ƒæ€§ã€‘é—®é¢˜ï¼Œé™¤äº†æ­»é”ä»¥å¤–ï¼Œè¿˜æœ‰æ´»é”å’Œé¥¥é¥¿è€…ä¸¤ç§æƒ…å†µ</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="13-3-æ´»é”">13.3 æ´»é”</h3><p>æ´»é”å‡ºç°åœ¨ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸æ”¹å˜å¯¹æ–¹çš„ç»“æŸæ¡ä»¶ï¼Œæœ€åè°ä¹Ÿæ— æ³•ç»“æŸï¼Œä¾‹å¦‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestLiveLock</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// æœŸæœ›å‡åˆ° 0 é€€å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">while</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                sleep(<span class="number">0.2</span>);</span><br><span class="line">                count--;</span><br><span class="line">                log.debug(<span class="string">&quot;count: &#123;&#125;&quot;</span>, count);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// æœŸæœ›è¶…è¿‡ 20 é€€å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">while</span> (count &lt; <span class="number">20</span>) &#123;</span><br><span class="line">                sleep(<span class="number">0.2</span>);</span><br><span class="line">                count++;</span><br><span class="line">                log.debug(<span class="string">&quot;count: &#123;&#125;&quot;</span>, count);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£å†³æ–¹å¼ï¼š</p><ul><li>é”™å¼€çº¿ç¨‹çš„è¿è¡Œæ—¶é—´ï¼Œä½¿å¾—ä¸€æ–¹ä¸èƒ½æ”¹å˜å¦ä¸€æ–¹çš„ç»“æŸæ¡ä»¶ã€‚</li><li>å°†ç¡çœ æ—¶é—´è°ƒæ•´ä¸ºéšæœºæ•°ã€‚</li></ul><h3 id="13-4-é¥¥é¥¿">13.4 é¥¥é¥¿</h3><p>å¾ˆå¤šæ•™ç¨‹ä¸­æŠŠé¥¥é¥¿å®šä¹‰ä¸ºï¼Œä¸€ä¸ªçº¿ç¨‹ç”±äºä¼˜å…ˆçº§å¤ªä½ï¼Œå§‹ç»ˆå¾—ä¸åˆ° CPU è°ƒåº¦æ‰§è¡Œï¼Œä¹Ÿä¸èƒ½å¤Ÿç»“æŸï¼Œé¥¥é¥¿çš„æƒ…å†µä¸æ˜“æ¼”ç¤ºï¼Œè®²è¯»å†™é”æ—¶ä¼šæ¶‰åŠé¥¥é¥¿é—®é¢˜</p><p>ä¸‹é¢æˆ‘è®²ä¸€ä¸‹æˆ‘é‡åˆ°çš„ä¸€ä¸ªçº¿ç¨‹é¥¥é¥¿çš„ä¾‹å­ï¼Œå…ˆæ¥çœ‹çœ‹ä½¿ç”¨é¡ºåºåŠ é”çš„æ–¹å¼è§£å†³ä¹‹å‰çš„æ­»é”é—®é¢˜</p><p>çº¿ç¨‹1 å°è¯•è·å–é”é¡ºåºAB</p><p>çº¿ç¨‹1 å°è¯•è·å–é”é¡ºåºBA</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220304205818794.png" alt="image-20220304205818794" style="zoom:50%;" /><p>é¡ºåºåŠ é”çš„è§£å†³æ–¹æ¡ˆ</p><p>è®©è·å¾—é”é¡ºåºéƒ½ä¸ºAB</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220304205837519.png" alt="image-20220304205837519" style="zoom:50%;" /><p>è¯´æ˜ï¼š</p><ul><li>é¡ºåºåŠ é”å¯ä»¥è§£å†³æ­»é”é—®é¢˜ï¼Œä½†ä¹Ÿä¼šå¯¼è‡´ä¸€äº›çº¿ç¨‹ä¸€ç›´å¾—ä¸åˆ°é”ï¼Œäº§ç”Ÿé¥¥é¥¿ç°è±¡ã€‚</li><li>è§£å†³æ–¹å¼ï¼šReentrantLock</li></ul><h2 id="14-ReentrantLock">14. ReentrantLock</h2><p>ç›¸å¯¹äº synchronized å®ƒå…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹</p><ul><li>å¯ä¸­æ–­</li><li>å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´</li><li>å¯ä»¥è®¾ç½®ä¸ºå…¬å¹³é”</li><li>æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡</li></ul><p>ä¸ synchronized ä¸€æ ·ï¼Œéƒ½æ”¯æŒå¯é‡å…¥</p><p>åŸºæœ¬è¯­æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–é” å°½é‡æ”¾åœ¨å¤–é¢ é¿å…ç”±äºå…¶å®ƒæ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼Œå¯¼è‡´åœ¨finallyä»£ç å—ä¸­ï¼Œunlock å¯¹æœªåŠ é”çš„å¯¹è±¡è§£é”</span></span><br><span class="line">reentrantLock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"> <span class="comment">// ä¸´ç•ŒåŒº</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"> <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line"> reentrantLock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="14-1-å¯é‡å…¥">14.1 å¯é‡å…¥</h3><p>å¯é‡å…¥æ˜¯æŒ‡åŒä¸€ä¸ªçº¿ç¨‹å¦‚æœé¦–æ¬¡è·å¾—äº†è¿™æŠŠé”ï¼Œé‚£ä¹ˆå› ä¸ºå®ƒæ˜¯è¿™æŠŠé”çš„æ‹¥æœ‰è€…ï¼Œå› æ­¤æœ‰æƒåˆ©å†æ¬¡è·å–è¿™æŠŠé” å¦‚æœæ˜¯ä¸å¯é‡å…¥é”ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡è·å¾—é”æ—¶ï¼Œè‡ªå·±ä¹Ÿä¼šè¢«é”æŒ¡ä½ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    method1();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;execute method1&quot;</span>);</span><br><span class="line">        method2();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;execute method2&quot;</span>);</span><br><span class="line">        method3();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method3</span><span class="params">()</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;execute method3&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">17:59:11.862 [main] c.TestReentrant - execute method1 </span><br><span class="line">17:59:11.865 [main] c.TestReentrant - execute method2 </span><br><span class="line">17:59:11.865 [main] c.TestReentrant - execute method3</span><br></pre></td></tr></table></figure><h3 id="14-2-å¯æ‰“æ–­">14.2 å¯æ‰“æ–­</h3><p>å¯æ‰“æ–­æŒ‡çš„æ˜¯å¤„äºé˜»å¡çŠ¶æ€ç­‰å¾…é”çš„çº¿ç¨‹å¯ä»¥è¢«æ‰“æ–­ç­‰å¾…ã€‚æ³¨æ„<code>lock.lockInterruptibly()</code>å’Œ<code>lock.trylock()</code>æ–¹æ³•æ˜¯å¯æ‰“æ–­çš„,<code>lock.lock()</code>ä¸æ˜¯ã€‚å¯æ‰“æ–­çš„æ„ä¹‰åœ¨äºé¿å…å¾—ä¸åˆ°é”çš„çº¿ç¨‹æ— é™åˆ¶åœ°ç­‰å¾…ä¸‹å»ï¼Œé˜²æ­¢æ­»é”çš„ä¸€ç§æ–¹å¼ã€‚</p><div class="tabs" id="37f6603d-8ac2-421f-949f-0cfc85b4cc9f"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#37f6603d-8ac2-421f-949f-0cfc85b4cc9f-1"><i class="fas fa-cat"></i>lockInterruptibly()æ‰“æ–­å®ä¾‹</button></li><li class="tab"><button type="button" data-href="#37f6603d-8ac2-421f-949f-0cfc85b4cc9f-2"><i class="fas fa-horse"></i>lockInterruptibly()æ‰“æ–­è¾“å‡º</button></li><li class="tab"><button type="button" data-href="#37f6603d-8ac2-421f-949f-0cfc85b4cc9f-3"><i class="fas fa-dove"></i>lock()æ‰“æ–­ç¤ºä¾‹</button></li><li class="tab"><button type="button" data-href="#37f6603d-8ac2-421f-949f-0cfc85b4cc9f-4"><i class="fas fa-dragon"></i>lock()æ‰“æ–­è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="37f6603d-8ac2-421f-949f-0cfc85b4cc9f-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;å¯åŠ¨...&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//å¦‚æœæ²¡æœ‰ç«äº‰é‚£ä¹ˆæ­¤æ–¹æ³•å°±ä¼šè·å–lockå¯¹è±¡é”</span></span><br><span class="line">      <span class="comment">//å¦‚æœæœ‰ç«äº‰å°±è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥è¢«å…¶ä»–çº¿ç¨‹ç”¨interruptæ–¹æ³•æ‰“æ–­</span></span><br><span class="line">        lock.lockInterruptibly();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        log.debug(<span class="string">&quot;ç­‰é”çš„è¿‡ç¨‹ä¸­è¢«æ‰“æ–­&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;è·å¾—äº†é”&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">lock.lock();</span><br><span class="line">log.debug(<span class="string">&quot;è·å¾—äº†é”&quot;</span>);</span><br><span class="line">t1.start();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    t1.interrupt();</span><br><span class="line">    log.debug(<span class="string">&quot;æ‰§è¡Œæ‰“æ–­&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="37f6603d-8ac2-421f-949f-0cfc85b4cc9f-2"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">18:02:40.520 [main] c.TestInterrupt - è·å¾—äº†é”</span><br><span class="line">18:02:40.524 [t1] c.TestInterrupt - å¯åŠ¨... </span><br><span class="line">18:02:41.530 [main] c.TestInterrupt - æ‰§è¡Œæ‰“æ–­</span><br><span class="line">java.lang.InterruptedException </span><br><span class="line"> at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireInterruptibly(AbstractQueuedSynchronizer.java:898) </span><br><span class="line"> at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireInterruptibly(AbstractQueuedSynchronizer.java:1222) </span><br><span class="line"> at java.util.concurrent.locks.ReentrantLock.lockInterruptibly(ReentrantLock.java:335) </span><br><span class="line"> at cn.itcast.n4.reentrant.TestInterrupt.lambda$main<span class="variable">$0</span>(TestInterrupt.java:17) </span><br><span class="line"> at java.lang.Thread.run(Thread.java:748) </span><br><span class="line">18:02:41.532 [t1] c.TestInterrupt - ç­‰é”çš„è¿‡ç¨‹ä¸­è¢«æ‰“æ–­</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="37f6603d-8ac2-421f-949f-0cfc85b4cc9f-3"><p>æ³¨æ„å¦‚æœæ˜¯ä¸å¯ä¸­æ–­æ¨¡å¼ï¼Œé‚£ä¹ˆå³ä½¿ä½¿ç”¨äº† interrupt ä¹Ÿä¸ä¼šè®©ç­‰å¾…ä¸­æ–­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;å¯åŠ¨...&quot;</span>);</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;è·å¾—äº†é”&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">lock.lock();</span><br><span class="line">log.debug(<span class="string">&quot;è·å¾—äº†é”&quot;</span>);</span><br><span class="line">t1.start();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    t1.interrupt();</span><br><span class="line">    log.debug(<span class="string">&quot;æ‰§è¡Œæ‰“æ–­&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;é‡Šæ”¾äº†é”&quot;</span>);</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="37f6603d-8ac2-421f-949f-0cfc85b4cc9f-4"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">18:06:56.261 [main] c.TestInterrupt - è·å¾—äº†é”</span><br><span class="line">18:06:56.265 [t1] c.TestInterrupt - å¯åŠ¨... </span><br><span class="line">18:06:57.266 [main] c.TestInterrupt - æ‰§è¡Œæ‰“æ–­ // è¿™æ—¶ t1 å¹¶æ²¡æœ‰è¢«çœŸæ­£æ‰“æ–­, è€Œæ˜¯ä»ç»§ç»­ç­‰å¾…é”</span><br><span class="line">18:06:58.267 [main] c.TestInterrupt - é‡Šæ”¾äº†é”</span><br><span class="line">18:06:58.267 [t1] c.TestInterrupt - è·å¾—äº†é”</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="14-3-é”è¶…æ—¶">14.3 é”è¶…æ—¶</h3><div class="tabs" id="d1a81628-c6ee-4779-948d-92a9b4718e79"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d1a81628-c6ee-4779-948d-92a9b4718e79-1"><i class="fas fa-cat"></i>ç«‹åˆ»å¤±è´¥</button></li><li class="tab"><button type="button" data-href="#d1a81628-c6ee-4779-948d-92a9b4718e79-2"><i class="fas fa-horse"></i>è¶…æ—¶å¤±è´¥</button></li><li class="tab"><button type="button" data-href="#d1a81628-c6ee-4779-948d-92a9b4718e79-3"><i class="fas fa-dragon"></i>ä½¿ç”¨ tryLock è§£å†³å“²å­¦å®¶å°±é¤é—®é¢˜</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d1a81628-c6ee-4779-948d-92a9b4718e79-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;å¯åŠ¨...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!lock.tryLock()) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;è·å–ç«‹åˆ»å¤±è´¥ï¼Œè¿”å›&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;è·å¾—äº†é”&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">lock.lock();</span><br><span class="line">log.debug(<span class="string">&quot;è·å¾—äº†é”&quot;</span>);</span><br><span class="line">t1.start();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">18:15:02.918 [main] c.TestTimeout - è·å¾—äº†é”</span><br><span class="line">18:15:02.921 [t1] c.TestTimeout - å¯åŠ¨... </span><br><span class="line">18:15:02.921 [t1] c.TestTimeout - è·å–ç«‹åˆ»å¤±è´¥ï¼Œè¿”å›</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d1a81628-c6ee-4779-948d-92a9b4718e79-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;å¯åŠ¨...&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!lock.tryLock(<span class="number">1</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;è·å–ç­‰å¾… 1s åå¤±è´¥ï¼Œè¿”å›&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;è·å¾—äº†é”&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">lock.lock();</span><br><span class="line">log.debug(<span class="string">&quot;è·å¾—äº†é”&quot;</span>);</span><br><span class="line">t1.start();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">18:19:40.537 [main] c.TestTimeout - è·å¾—äº†é”</span><br><span class="line">18:19:40.544 [t1] c.TestTimeout - å¯åŠ¨... </span><br><span class="line">18:19:41.547 [t1] c.TestTimeout - è·å–ç­‰å¾… 1s åå¤±è´¥ï¼Œè¿”å›</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d1a81628-c6ee-4779-948d-92a9b4718e79-3"><p>ç»§æ‰¿ReentrantLock</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Chopstick</span> <span class="keyword">extends</span> <span class="title class_">ReentrantLock</span> &#123;</span><br><span class="line">    String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Chopstick</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ç­·å­&#123;&quot;</span> + name + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Philosopher</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    Chopstick left;</span><br><span class="line">    Chopstick right;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Philosopher</span><span class="params">(String name, Chopstick left, Chopstick right)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name);</span><br><span class="line">        <span class="built_in">this</span>.left = left;</span><br><span class="line">        <span class="built_in">this</span>.right = right;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// å°è¯•è·å¾—å·¦æ‰‹ç­·å­</span></span><br><span class="line">            <span class="keyword">if</span> (left.tryLock()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// å°è¯•è·å¾—å³æ‰‹ç­·å­</span></span><br><span class="line">                    <span class="keyword">if</span> (right.tryLock()) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            eat();</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            right.unlock();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    left.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;eating...&quot;</span>);</span><br><span class="line">        Sleeper.sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="14-4-å…¬å¹³é”">14.4 å…¬å¹³é”</h3><p>ReentrantLock é»˜è®¤æ˜¯ä¸å…¬å¹³çš„</p><div class="tabs" id="07b5ace6-abcd-4567-bafa-b7f987dff620"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#07b5ace6-abcd-4567-bafa-b7f987dff620-1"><i class="fas fa-atom"></i>é»˜è®¤:ä¸å…¬å¹³é”</button></li><li class="tab"><button type="button" data-href="#07b5ace6-abcd-4567-bafa-b7f987dff620-2"><i class="fas fa-wind"></i>è¾“å‡º</button></li><li class="tab"><button type="button" data-href="#07b5ace6-abcd-4567-bafa-b7f987dff620-3"><i class="far fa-sun"></i>å…¬å¹³é”</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="07b5ace6-abcd-4567-bafa-b7f987dff620-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>(<span class="literal">false</span>);</span><br><span class="line">lock.lock();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">500</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; running...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t&quot;</span> + i).start();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 1s ä¹‹åå»äº‰æŠ¢é”</span></span><br><span class="line">Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; start...&quot;</span>);</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; running...&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="string">&quot;å¼ºè¡Œæ’å…¥&quot;</span>).start();</span><br><span class="line">lock.unlock();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="07b5ace6-abcd-4567-bafa-b7f987dff620-2"><p>å¼ºè¡Œæ’å…¥ï¼Œæœ‰æœºä¼šåœ¨ä¸­é—´è¾“å‡º</p><blockquote><p><strong>æ³¨æ„</strong>ï¼šè¯¥å®éªŒä¸ä¸€å®šæ€»èƒ½å¤ç°</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">t39 running... </span><br><span class="line">t40 running... </span><br><span class="line">t41 running... </span><br><span class="line">t42 running... </span><br><span class="line">t43 running... </span><br><span class="line">å¼ºè¡Œæ’å…¥ start... </span><br><span class="line">å¼ºè¡Œæ’å…¥ running... </span><br><span class="line">t44 running... </span><br><span class="line">t45 running... </span><br><span class="line">t46 running... </span><br><span class="line">t47 running... </span><br><span class="line">t49 running... </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="07b5ace6-abcd-4567-bafa-b7f987dff620-3"><p>æ”¹ä¸ºå…¬å¹³é”å</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p>å¼ºè¡Œæ’å…¥ï¼Œæ€»æ˜¯åœ¨æœ€åè¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">t465 running... </span><br><span class="line">t464 running... </span><br><span class="line">t477 running... </span><br><span class="line">t442 running... </span><br><span class="line">t468 running... </span><br><span class="line">t493 running... </span><br><span class="line">t482 running... </span><br><span class="line">t485 running... </span><br><span class="line">t481 running... </span><br><span class="line">å¼ºè¡Œæ’å…¥ running... </span><br></pre></td></tr></table></figure><p>å…¬å¹³é”ä¸€èˆ¬æ²¡æœ‰å¿…è¦ï¼Œä¼šé™ä½å¹¶å‘åº¦ï¼Œåé¢åˆ†æåŸç†æ—¶ä¼šè®²è§£</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <h3 id="14-5-æ¡ä»¶å˜é‡">14.5 æ¡ä»¶å˜é‡</h3><p>synchronized ä¸­ä¹Ÿæœ‰æ¡ä»¶å˜é‡ï¼Œå°±æ˜¯æˆ‘ä»¬è®²åŸç†æ—¶é‚£ä¸ª waitSet ä¼‘æ¯å®¤ï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶è¿›å…¥ waitSet ç­‰å¾…</p><p>ReentrantLock çš„æ¡ä»¶å˜é‡æ¯” synchronized å¼ºå¤§ä¹‹å¤„åœ¨äºï¼Œå®ƒæ˜¯æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡çš„ï¼Œè¿™å°±å¥½æ¯”</p><ul><li>synchronized æ˜¯é‚£äº›ä¸æ»¡è¶³æ¡ä»¶çš„çº¿ç¨‹éƒ½åœ¨ä¸€é—´ä¼‘æ¯å®¤ç­‰æ¶ˆæ¯</li><li>è€Œ ReentrantLock æ”¯æŒå¤šé—´ä¼‘æ¯å®¤ï¼Œæœ‰ä¸“é—¨ç­‰çƒŸçš„ä¼‘æ¯å®¤ã€ä¸“é—¨ç­‰æ—©é¤çš„ä¼‘æ¯å®¤ã€å”¤é†’æ—¶ä¹Ÿæ˜¯æŒ‰ä¼‘æ¯å®¤æ¥å”¤é†’</li></ul><blockquote><p>ä½¿ç”¨è¦ç‚¹</p><ul><li>await å‰éœ€è¦è·å¾—é”</li><li>await æ‰§è¡Œåï¼Œä¼šé‡Šæ”¾é”ï¼Œè¿›å…¥ conditionObject ç­‰å¾…</li><li>await çš„çº¿ç¨‹è¢«å”¤é†’ï¼ˆæˆ–æ‰“æ–­ã€æˆ–è¶…æ—¶ï¼‰å–é‡æ–°ç«äº‰ lock é”</li><li>ç«äº‰ lock é”æˆåŠŸåï¼Œä» await åç»§ç»­æ‰§è¡Œ</li></ul></blockquote><div class="tabs" id="dd3e5e35-f46d-4096-a5fc-234bb16f150d"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#dd3e5e35-f46d-4096-a5fc-234bb16f150d-1"><i class="fas fa-cat"></i>è¯¦ç»†API</button></li><li class="tab"><button type="button" data-href="#dd3e5e35-f46d-4096-a5fc-234bb16f150d-2"><i class="fas fa-horse"></i>ç¤ºä¾‹</button></li><li class="tab"><button type="button" data-href="#dd3e5e35-f46d-4096-a5fc-234bb16f150d-3"><i class="fas fa-dove"></i>è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="dd3e5e35-f46d-4096-a5fc-234bb16f150d-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Condition</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">awaitUninterruptibly</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="title function_">awaitNanos</span><span class="params">(<span class="type">long</span> nanosTimeout)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">await</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">awaitUntil</span><span class="params">(Date deadline)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Wakes up one waiting thread.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">signal</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Wakes up all waiting threads.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">signalAll</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="dd3e5e35-f46d-4096-a5fc-234bb16f150d-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="comment">//ç­‰å¾…çƒŸçš„ä¼‘æ¯å®¤</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">Condition</span> <span class="variable">waitCigaretteQueue</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"><span class="comment">//ç­‰å¾…å¤–å–çš„ä¼‘æ¯å®¤</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">Condition</span> <span class="variable">waitbreakfastQueue</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">hasCigrette</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">hasBreakfast</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">while</span> (!hasCigrette) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    waitCigaretteQueue.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;ç­‰åˆ°äº†å®ƒçš„çƒŸ&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">while</span> (!hasBreakfast) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    waitbreakfastQueue.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;ç­‰åˆ°äº†å®ƒçš„æ—©é¤&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    sendBreakfast();</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    sendCigarette();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendCigarette</span><span class="params">()</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;é€çƒŸæ¥äº†&quot;</span>);</span><br><span class="line">        hasCigrette = <span class="literal">true</span>;</span><br><span class="line">        waitCigaretteQueue.signal();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendBreakfast</span><span class="params">()</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;é€æ—©é¤æ¥äº†&quot;</span>);</span><br><span class="line">        hasBreakfast = <span class="literal">true</span>;</span><br><span class="line">        waitbreakfastQueue.signal();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="dd3e5e35-f46d-4096-a5fc-234bb16f150d-3"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">18:52:27.680 [main] c.TestCondition - é€æ—©é¤æ¥äº†</span><br><span class="line">18:52:27.682 [Thread-1] c.TestCondition - ç­‰åˆ°äº†å®ƒçš„æ—©é¤</span><br><span class="line">18:52:28.683 [main] c.TestCondition - é€çƒŸæ¥äº†</span><br><span class="line">18:52:28.683 [Thread-0] c.TestCondition - ç­‰åˆ°äº†å®ƒçš„çƒŸ</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="14-6-åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶">14.6 åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶</h3><h4 id="14-6-1-å›ºå®šè¾“å‡ºé¡ºåº">14.6.1 å›ºå®šè¾“å‡ºé¡ºåº</h4><p>æ¯”å¦‚ï¼Œå¿…é¡»å…ˆ 2 å 1 æ‰“å°</p><div class="tabs" id="2bc8ea38-6300-4d31-b849-4925d1756110"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2bc8ea38-6300-4d31-b849-4925d1756110-1"><i class="fas fa-cat"></i>wait notify ç‰ˆ</button></li><li class="tab"><button type="button" data-href="#2bc8ea38-6300-4d31-b849-4925d1756110-2"><i class="fas fa-horse"></i>Park Unpark ç‰ˆ</button></li><li class="tab"><button type="button" data-href="#2bc8ea38-6300-4d31-b849-4925d1756110-3"><i class="fas fa-dove"></i>é¸½</button></li><li class="tab"><button type="button" data-href="#2bc8ea38-6300-4d31-b849-4925d1756110-4"><i class="fas fa-dragon"></i>é¾™</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2bc8ea38-6300-4d31-b849-4925d1756110-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”¨æ¥åŒæ­¥çš„å¯¹è±¡</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="comment">// t2 è¿è¡Œæ ‡è®°ï¼Œ ä»£è¡¨ t2 æ˜¯å¦æ‰§è¡Œè¿‡</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">t2runed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœ t2 æ²¡æœ‰æ‰§è¡Œè¿‡</span></span><br><span class="line">            <span class="keyword">while</span> (!t2runed) &#123; </span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// t1 å…ˆç­‰ä¸€ä¼š</span></span><br><span class="line">                    obj.wait(); </span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">            <span class="comment">// ä¿®æ”¹è¿è¡Œæ ‡è®°</span></span><br><span class="line">            t2runed = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// é€šçŸ¥ obj ä¸Šç­‰å¾…çš„çº¿ç¨‹ï¼ˆå¯èƒ½æœ‰å¤šä¸ªï¼Œå› æ­¤éœ€è¦ç”¨ notifyAllï¼‰</span></span><br><span class="line">            obj.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2bc8ea38-6300-4d31-b849-4925d1756110-2"><p>å¯ä»¥çœ‹åˆ°ï¼Œå®ç°ä¸Šå¾ˆéº»çƒ¦ï¼š</p><ul><li>é¦–å…ˆï¼Œéœ€è¦ä¿è¯å…ˆ wait å† notifyï¼Œå¦åˆ™ wait çº¿ç¨‹æ°¸è¿œå¾—ä¸åˆ°å”¤é†’ã€‚å› æ­¤ä½¿ç”¨äº†ã€è¿è¡Œæ ‡è®°ã€æ¥åˆ¤æ–­è¯¥ä¸è¯¥ wait</li><li>ç¬¬äºŒï¼Œå¦‚æœæœ‰äº›å¹²æ‰°çº¿ç¨‹é”™è¯¯åœ° notify äº† wait çº¿ç¨‹ï¼Œæ¡ä»¶ä¸æ»¡è¶³æ—¶è¿˜è¦é‡æ–°ç­‰å¾…ï¼Œä½¿ç”¨äº† while å¾ªç¯æ¥è§£å†³ æ­¤é—®é¢˜</li><li>æœ€åï¼Œå”¤é†’å¯¹è±¡ä¸Šçš„ wait çº¿ç¨‹éœ€è¦ä½¿ç”¨ notifyAllï¼Œå› ä¸ºã€åŒæ­¥å¯¹è±¡ã€ä¸Šçš„ç­‰å¾…çº¿ç¨‹å¯èƒ½ä¸æ­¢ä¸€ä¸ª</li></ul><p>å¯ä»¥ä½¿ç”¨ LockSupport ç±»çš„ park å’Œ unpark æ¥ç®€åŒ–ä¸Šé¢çš„é¢˜ç›®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">1000</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; &#125;</span><br><span class="line">    <span class="comment">// å½“æ²¡æœ‰ã€è®¸å¯ã€æ—¶ï¼Œå½“å‰çº¿ç¨‹æš‚åœè¿è¡Œï¼›æœ‰ã€è®¸å¯ã€æ—¶ï¼Œç”¨æ‰è¿™ä¸ªã€è®¸å¯ã€ï¼Œå½“å‰çº¿ç¨‹æ¢å¤è¿è¡Œ</span></span><br><span class="line">    LockSupport.park();</span><br><span class="line">    System.out.println(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    <span class="comment">// ç»™çº¿ç¨‹ t1 å‘æ”¾ã€è®¸å¯ã€ï¼ˆå¤šæ¬¡è¿ç»­è°ƒç”¨ unpark åªä¼šå‘æ”¾ä¸€ä¸ªã€è®¸å¯ã€ï¼‰</span></span><br><span class="line">    LockSupport.unpark(t1);</span><br><span class="line">&#125;);</span><br><span class="line">t1.start();</span><br><span class="line">t2.start();</span><br></pre></td></tr></table></figure><p>park å’Œ unpark æ–¹æ³•æ¯”è¾ƒçµæ´»ï¼Œä»–ä¿©è°å…ˆè°ƒç”¨ï¼Œè°åè°ƒç”¨æ— æ‰€è°“ã€‚å¹¶ä¸”æ˜¯ä»¥çº¿ç¨‹ä¸ºå•ä½è¿›è¡Œã€æš‚åœã€å’Œã€æ¢å¤ã€ï¼Œ ä¸éœ€è¦ã€åŒæ­¥å¯¹è±¡ã€å’Œã€è¿è¡Œæ ‡è®°ã€</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2bc8ea38-6300-4d31-b849-4925d1756110-3"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2bc8ea38-6300-4d31-b849-4925d1756110-4"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h4 id="14-6-2-äº¤æ›¿è¾“å‡ºé¡ºåº">14.6.2 äº¤æ›¿è¾“å‡ºé¡ºåº</h4><p>çº¿ç¨‹ 1 è¾“å‡º a 5 æ¬¡ï¼Œçº¿ç¨‹ 2 è¾“å‡º b 5 æ¬¡ï¼Œçº¿ç¨‹ 3 è¾“å‡º c 5 æ¬¡ã€‚ç°åœ¨è¦æ±‚è¾“å‡º abcabcabcabcabc æ€ä¹ˆå®ç°</p><div class="tabs" id="fb0c53f1-b17f-443c-b9b2-f7a444fd474f"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#fb0c53f1-b17f-443c-b9b2-f7a444fd474f-1"><i class="fas fa-dove"></i>wait notify ç‰ˆ</button></li><li class="tab"><button type="button" data-href="#fb0c53f1-b17f-443c-b9b2-f7a444fd474f-2"><i class="fas fa-dragon"></i>Lock æ¡ä»¶å˜é‡ç‰ˆ</button></li><li class="tab"><button type="button" data-href="#fb0c53f1-b17f-443c-b9b2-f7a444fd474f-3"><i class="fas fa-atom"></i>Park Unpark ç‰ˆ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="fb0c53f1-b17f-443c-b9b2-f7a444fd474f-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SyncWaitNotify</span> <span class="variable">syncWaitNotify</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SyncWaitNotify</span>(<span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        è¾“å‡ºå†…å®¹       ç­‰å¾…æ ‡è®°     ä¸‹ä¸€ä¸ªæ ‡è®°</span></span><br><span class="line"><span class="comment">         a           1             2</span></span><br><span class="line"><span class="comment">         b           2             3</span></span><br><span class="line"><span class="comment">         c           3             1</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            syncWaitNotify.print(<span class="number">1</span>, <span class="number">2</span>, <span class="string">&quot;a&quot;</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            syncWaitNotify.print(<span class="number">2</span>, <span class="number">3</span>, <span class="string">&quot;b&quot;</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            syncWaitNotify.print(<span class="number">3</span>, <span class="number">1</span>, <span class="string">&quot;c&quot;</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SyncWaitNotify</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> flag;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> loopNumber;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">SyncWaitNotify</span><span class="params">(<span class="type">int</span> flag, <span class="type">int</span> loopNumber)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.flag = flag;</span><br><span class="line">            <span class="built_in">this</span>.loopNumber = loopNumber;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(<span class="type">int</span> waitFlag, <span class="type">int</span> nextFlag, String str)</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                    <span class="keyword">while</span> (<span class="built_in">this</span>.flag != waitFlag) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="built_in">this</span>.wait();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.print(str);</span><br><span class="line">                    flag = nextFlag;</span><br><span class="line">                    <span class="built_in">this</span>.notifyAll();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="fb0c53f1-b17f-443c-b9b2-f7a444fd474f-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AwaitSignal</span> <span class="variable">as</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AwaitSignal</span>(<span class="number">5</span>);</span><br><span class="line">        <span class="type">Condition</span> <span class="variable">aWaitSet</span> <span class="operator">=</span> as.newCondition();</span><br><span class="line">        <span class="type">Condition</span> <span class="variable">bWaitSet</span> <span class="operator">=</span> as.newCondition();</span><br><span class="line">        <span class="type">Condition</span> <span class="variable">cWaitSet</span> <span class="operator">=</span> as.newCondition();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            as.print(<span class="string">&quot;a&quot;</span>, aWaitSet, bWaitSet);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            as.print(<span class="string">&quot;b&quot;</span>, bWaitSet, cWaitSet);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            as.print(<span class="string">&quot;c&quot;</span>, cWaitSet, aWaitSet);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        as.start(aWaitSet);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AwaitSignal</span> <span class="keyword">extends</span> <span class="title class_">ReentrantLock</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(Condition first)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">            first.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(String str, Condition current, Condition next)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            <span class="built_in">this</span>.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                current.await();</span><br><span class="line">                log.debug(str);</span><br><span class="line">                next.signal();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¾ªç¯æ¬¡æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> loopNumber;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AwaitSignal</span><span class="params">(<span class="type">int</span> loopNumber)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.loopNumber = loopNumber;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>æ³¨æ„</strong></p><p>è¯¥å®ç°æ²¡æœ‰è€ƒè™‘ aï¼Œbï¼Œc çº¿ç¨‹éƒ½å°±ç»ªå†å¼€å§‹</p></blockquote><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="fb0c53f1-b17f-443c-b9b2-f7a444fd474f-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SyncPark</span> <span class="variable">syncPark</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SyncPark</span>(<span class="number">5</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            syncPark.print(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            syncPark.print(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            syncPark.print(<span class="string">&quot;c\n&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        syncPark.setThreads(t1, t2, t3);</span><br><span class="line">        syncPark.start();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SyncPark</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> loopNumber;</span><br><span class="line">    <span class="keyword">private</span> Thread[] threads;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SyncPark</span><span class="params">(<span class="type">int</span> loopNumber)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.loopNumber = loopNumber;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setThreads</span><span class="params">(Thread... threads)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.threads = threads;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            LockSupport.park();</span><br><span class="line">            System.out.print(str);</span><br><span class="line">            LockSupport.unpark(nextThread());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> Thread <span class="title function_">nextThread</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; threads.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(threads[i] == current) &#123;</span><br><span class="line">                index = i;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(index &lt; threads.length - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> threads[index+<span class="number">1</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> threads[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Thread thread : threads) &#123;</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">        LockSupport.unpark(threads[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> ]]></content>
    
    
    <summary type="html">å…±äº«é—®é¢˜ã€synchronizedã€çº¿ç¨‹å®‰å…¨åˆ†æã€Monitorã€wait/notifyã€çº¿ç¨‹çŠ¶æ€è½¬æ¢ã€æ´»è·ƒæ€§ã€Lock</summary>
    
    
    
    <category term="Java" scheme="https://luckylittleboy.gitee.io/categories/Java/"/>
    
    
    <category term="JUC" scheme="https://luckylittleboy.gitee.io/tags/JUC/"/>
    
  </entry>
  
  <entry>
    <title>2.Javaçº¿ç¨‹</title>
    <link href="https://luckylittleboy.gitee.io/posts/766dd8c2.html"/>
    <id>https://luckylittleboy.gitee.io/posts/766dd8c2.html</id>
    <published>2023-03-28T05:13:29.000Z</published>
    <updated>2023-03-31T14:10:19.772Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹">1. åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹</h2><h3 id="1-1-ä½¿ç”¨-Thread">1.1 ä½¿ç”¨ Thread</h3><div class="tabs" id="codetabs1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#codetabs1-1"><i class="fas fa-seedling"></i>ä»£ç </button></li><li class="tab"><button type="button" data-href="#codetabs1-2"><i class="fas fa-leaf"></i>è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="codetabs1-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ„é€ æ–¹æ³•çš„å‚æ•°æ˜¯ç»™çº¿ç¨‹æŒ‡å®šåå­—ï¼Œæ¨è</span></span><br><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="comment">// run æ–¹æ³•å†…å®ç°äº†è¦æ‰§è¡Œçš„ä»»åŠ¡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">t1.start();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="codetabs1-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>:<span class="number">19</span>:<span class="number">00</span> [t1] c.ThreadStarter - hello</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <h3 id="1-2-Runnable-é…åˆ-Thread">1.2 Runnable é…åˆ Thread</h3><p>æŠŠã€çº¿ç¨‹ã€‘å’Œã€ä»»åŠ¡ã€‘ï¼ˆè¦æ‰§è¡Œçš„ä»£ç ï¼‰åˆ†å¼€</p><ul><li>Thread ä»£è¡¨çº¿ç¨‹</li><li>Runnable å¯è¿è¡Œçš„ä»»åŠ¡ï¼ˆçº¿ç¨‹è¦æ‰§è¡Œçš„ä»£ç ï¼‰</li></ul><div class="tabs" id="codetabs2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#codetabs2-1"><i class="fas fa-seedling"></i>ä»£ç </button></li><li class="tab"><button type="button" data-href="#codetabs2-2"><i class="fas fa-leaf"></i>è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="codetabs2-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä»»åŠ¡å¯¹è±¡</span></span><br><span class="line"><span class="type">Runnable</span> <span class="variable">task2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// å‚æ•°1 æ˜¯ä»»åŠ¡å¯¹è±¡; å‚æ•°2 æ˜¯çº¿ç¨‹åå­—ï¼Œæ¨è</span></span><br><span class="line"><span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(task2, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">t2.start();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="codetabs2-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>:<span class="number">19</span>:<span class="number">00</span> [t2] c.ThreadStarter - hello</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>Java 8 ä»¥åå¯ä»¥ä½¿ç”¨ lambda ç²¾ç®€ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä»»åŠ¡å¯¹è±¡</span></span><br><span class="line"><span class="type">Runnable</span> <span class="variable">task2</span> <span class="operator">=</span> () -&gt; log.debug(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"><span class="comment">// å‚æ•°1 æ˜¯ä»»åŠ¡å¯¹è±¡; å‚æ•°2 æ˜¯çº¿ç¨‹åå­—ï¼Œæ¨è</span></span><br><span class="line"><span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(task2, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">t2.start();</span><br></pre></td></tr></table></figure><span class='p green'>åŸç†ä¹‹Threadä¸Runnableçš„å…³ç³»ï¼š</span> <div class="tabs" id="codetabs3"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#codetabs3-1"><i class="fas fa-seedling"></i>æ„é€ å‡½æ•°</button></li><li class="tab"><button type="button" data-href="#codetabs3-2"><i class="fas fa-leaf"></i>initå‡½æ•°</button></li><li class="tab"><button type="button" data-href="#codetabs3-3"><i class="fab fa-apple"></i>runå‡½æ•°</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="codetabs3-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(task2, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">---</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Thread</span><span class="params">(Runnable target, String name)</span> &#123;</span><br><span class="line">        init(<span class="literal">null</span>, target, name, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="codetabs3-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.target=target;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="codetabs3-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (target != <span class="literal">null</span>) &#123;</span><br><span class="line">       target.run();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <p>å°ç»“</p><ul><li>æ–¹æ³•1 æ˜¯æŠŠçº¿ç¨‹å’Œä»»åŠ¡åˆå¹¶åœ¨äº†ä¸€èµ·æ–¹æ³•2 æ˜¯æŠŠçº¿ç¨‹å’Œä»»åŠ¡åˆ†å¼€äº†</li><li>ç”¨ Runnable æ›´å®¹æ˜“ä¸çº¿ç¨‹æ± ç­‰é«˜çº§ API é…åˆ</li><li>ç”¨ Runnable è®©ä»»åŠ¡ç±»è„±ç¦»äº† Thread ç»§æ‰¿ä½“ç³»ï¼Œæ›´çµæ´»</li></ul><h3 id="1-3-FutureTask-é…åˆ-Thread">1.3 FutureTask é…åˆ Thread</h3><p>FutureTask èƒ½å¤Ÿæ¥æ”¶ Callable ç±»å‹çš„å‚æ•°ï¼Œç”¨æ¥å¤„ç†æœ‰è¿”å›ç»“æœçš„æƒ…å†µ</p><div class="tabs" id="codetabs4"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#codetabs4-1"><i class="fas fa-seedling"></i>ä»£ç </button></li><li class="tab"><button type="button" data-href="#codetabs4-2"><i class="fas fa-leaf"></i>è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="codetabs4-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä»»åŠ¡å¯¹è±¡</span></span><br><span class="line">FutureTask&lt;Integer&gt; task3 = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(() -&gt; &#123;</span><br><span class="line">log.debug(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// å‚æ•°1 æ˜¯ä»»åŠ¡å¯¹è±¡; å‚æ•°2 æ˜¯çº¿ç¨‹åå­—ï¼Œæ¨è</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(task3, <span class="string">&quot;t3&quot;</span>).start();</span><br><span class="line"><span class="comment">// ä¸»çº¿ç¨‹é˜»å¡ï¼ŒåŒæ­¥ç­‰å¾… task æ‰§è¡Œå®Œæ¯•çš„ç»“æœ</span></span><br><span class="line"><span class="type">Integer</span> <span class="variable">result</span> <span class="operator">=</span> task3.get();</span><br><span class="line">log.debug(<span class="string">&quot;ç»“æœæ˜¯:&#123;&#125;&quot;</span>, result);</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="codetabs4-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>:<span class="number">22</span>:<span class="number">27</span> [t3] c.ThreadStarter - hello</span><br><span class="line"><span class="number">19</span>:<span class="number">22</span>:<span class="number">27</span> [main] c.ThreadStarter - ç»“æœæ˜¯:<span class="number">100</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-æŸ¥çœ‹è¿›ç¨‹çº¿ç¨‹çš„æ–¹æ³•">2. æŸ¥çœ‹è¿›ç¨‹çº¿ç¨‹çš„æ–¹æ³•</h2><div class="tabs" id="codetabs5"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#codetabs5-1"><i class="fas fa-seedling"></i>windows</button></li><li class="tab"><button type="button" data-href="#codetabs5-2"><i class="fas fa-leaf"></i>Linux</button></li><li class="tab"><button type="button" data-href="#codetabs5-3"><i class="fab fa-apple"></i>Java</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="codetabs5-1"><ul><li>ä»»åŠ¡ç®¡ç†å™¨å¯ä»¥æŸ¥çœ‹è¿›ç¨‹å’Œçº¿ç¨‹æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ€æ­»è¿›ç¨‹</li><li>tasklist æŸ¥çœ‹è¿›ç¨‹<ul><li><code>tasklist</code> | <code>findstr</code> (æŸ¥æ‰¾å…³é”®å­—)</li></ul></li><li>taskkill æ€æ­»è¿›ç¨‹<ul><li>taskkill /F(å½»åº•æ€æ­»ï¼‰/PID(è¿›ç¨‹PID)</li></ul></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="codetabs5-2"><ul><li>ps -fe æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹</li><li>ps -fT -p  æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹</li><li>kill æ€æ­»è¿›ç¨‹</li><li>top åŠ¨æ€ç›‘è§†è¿›ç¨‹</li><li>top -H -p  æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹ä¿¡æ¯</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="codetabs5-3"><ul><li>jps å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰ Java è¿›ç¨‹</li><li>jstack  æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹çŠ¶æ€</li><li>jconsole æ¥æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ä¸­çº¿ç¨‹çš„è¿è¡Œæƒ…å†µï¼ˆå›¾å½¢ç•Œé¢ï¼‰</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <h2 id="3-åŸç†ä¹‹çº¿ç¨‹è¿è¡Œ">3. åŸç†ä¹‹çº¿ç¨‹è¿è¡Œ</h2><span class='p red'>æ ˆä¸æ ˆå¸§</span> <p>Java Virtual Machine Stacks ï¼ˆJava è™šæ‹Ÿæœºæ ˆï¼‰</p><p>æˆ‘ä»¬éƒ½çŸ¥é“ JVM ä¸­ç”±å †ã€æ ˆã€æ–¹æ³•åŒºæ‰€ç»„æˆï¼Œå…¶ä¸­æ ˆå†…å­˜æ˜¯ç»™è°ç”¨çš„å‘¢ï¼Ÿå…¶å®å°±æ˜¯çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯åŠ¨åï¼Œè™šæ‹Ÿæœºå°±ä¼šä¸ºå…¶åˆ†é…ä¸€å—æ ˆå†…å­˜ã€‚</p><ul><li>æ¯ä¸ªæ ˆç”±å¤šä¸ªæ ˆå¸§ï¼ˆFrameï¼‰ç»„æˆï¼Œå¯¹åº”ç€æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶æ‰€å ç”¨çš„å†…å­˜</li><li>æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§ï¼Œå¯¹åº”ç€å½“å‰æ­£åœ¨æ‰§è¡Œçš„é‚£ä¸ªæ–¹æ³•</li></ul><span class='p red'>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆThread Context Switchï¼‰</span>  <p>å› ä¸ºä»¥ä¸‹ä¸€äº›åŸå› å¯¼è‡´ cpu ä¸å†æ‰§è¡Œå½“å‰çš„çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹çš„ä»£ç </p><ul><li>çº¿ç¨‹çš„ cpu æ—¶é—´ç‰‡ç”¨å®Œ</li><li>åƒåœ¾å›æ”¶</li><li>æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦è¿è¡Œ</li><li>çº¿ç¨‹è‡ªå·±è°ƒç”¨äº† sleepã€yieldã€waitã€joinã€parkã€synchronizedã€lock ç­‰æ–¹æ³•</li></ul><p>å½“ Context Switch å‘ç”Ÿæ—¶ï¼Œéœ€è¦ç”±æ“ä½œç³»ç»Ÿä¿å­˜å½“å‰çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼ŒJava ä¸­å¯¹åº”çš„æ¦‚å¿µ å°±æ˜¯ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®°ä½ä¸‹ä¸€æ¡ jvm æŒ‡ä»¤çš„æ‰§è¡Œåœ°å€ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„</p><ul><li>çŠ¶æ€åŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆä¸­æ¯ä¸ªæ ˆå¸§çš„ä¿¡æ¯ï¼Œå¦‚å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆã€è¿”å›åœ°å€ç­‰</li><li>Context Switch é¢‘ç¹å‘ç”Ÿä¼šå½±å“æ€§èƒ½</li></ul><h2 id="4-å¸¸è§æ–¹æ³•">4. å¸¸è§æ–¹æ³•</h2><table><thead><tr><th style="text-align:center">æ–¹æ³•</th><th>åŠŸèƒ½</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center"><strong>public void start()</strong></td><td>å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ï¼›Javaè™šæ‹Ÿæœºè°ƒç”¨æ­¤çº¿ç¨‹çš„runæ–¹æ³•</td><td>start æ–¹æ³•åªæ˜¯è®©çº¿ç¨‹è¿›å…¥å°±ç»ªï¼Œé‡Œé¢ä»£ç ä¸ä¸€å®šç«‹åˆ» è¿è¡Œï¼ˆCPU çš„æ—¶é—´ç‰‡è¿˜æ²¡åˆ†ç»™å®ƒï¼‰ã€‚æ¯ä¸ªçº¿ç¨‹å¯¹è±¡çš„ startæ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœè°ƒç”¨äº†å¤šæ¬¡ä¼šå‡ºç° IllegalThreadStateException</td></tr><tr><td style="text-align:center"><strong>public void run()</strong></td><td>çº¿ç¨‹å¯åŠ¨åè°ƒç”¨è¯¥æ–¹æ³•</td><td>å¦‚æœåœ¨æ„é€  Thread å¯¹è±¡æ—¶ä¼ é€’äº† Runnable å‚æ•°ï¼Œåˆ™ çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨ Runnable ä¸­çš„ run æ–¹æ³•ï¼Œå¦åˆ™é»˜ è®¤ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ä½†å¯ä»¥åˆ›å»º Thread çš„å­ç±»å¯¹è±¡ï¼Œ æ¥è¦†ç›–é»˜è®¤è¡Œä¸º</td></tr><tr><td style="text-align:center"><strong>public void setName(String name)</strong></td><td>ç»™å½“å‰çº¿ç¨‹å–åå­—</td><td></td></tr><tr><td style="text-align:center"><strong>public void getName()</strong></td><td>è·å–å½“å‰çº¿ç¨‹çš„åå­—ã€‚çº¿ç¨‹å­˜åœ¨é»˜è®¤åç§°ï¼šå­çº¿ç¨‹æ˜¯Thread-ç´¢å¼•ï¼Œä¸»çº¿ç¨‹æ˜¯main</td><td></td></tr><tr><td style="text-align:center"><strong>public static Thread currentThread()</strong></td><td>è·å–å½“å‰çº¿ç¨‹å¯¹è±¡ï¼Œä»£ç åœ¨å“ªä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œ</td><td></td></tr><tr><td style="text-align:center"><strong>public static void sleep(long time)</strong></td><td>è®©å½“å‰çº¿ç¨‹ä¼‘çœ å¤šå°‘æ¯«ç§’å†ç»§ç»­æ‰§è¡Œã€‚<strong>Thread.sleep(0)</strong> : è®©æ“ä½œç³»ç»Ÿç«‹åˆ»é‡æ–°è¿›è¡Œä¸€æ¬¡cpuç«äº‰</td><td></td></tr><tr><td style="text-align:center"><strong>public static native void yield()</strong></td><td>æç¤ºçº¿ç¨‹è°ƒåº¦å™¨è®©å‡ºå½“å‰çº¿ç¨‹å¯¹CPUçš„ä½¿ç”¨</td><td>ä¸»è¦æ˜¯ä¸ºäº†æµ‹è¯•å’Œè°ƒè¯•</td></tr><tr><td style="text-align:center"><strong>public final int getPriority()</strong></td><td>è¿”å›æ­¤çº¿ç¨‹çš„ä¼˜å…ˆçº§</td><td></td></tr><tr><td style="text-align:center"><strong>public final void setPriority(int priority)</strong></td><td>æ›´æ”¹æ­¤çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œå¸¸ç”¨1 5 10</td><td>javaä¸­è§„å®šçº¿ç¨‹ä¼˜å…ˆçº§æ˜¯1~10 çš„æ•´æ•°ï¼Œè¾ƒå¤§çš„ä¼˜å…ˆçº§ èƒ½æé«˜è¯¥çº¿ç¨‹è¢« CPU è°ƒåº¦çš„æœºç‡</td></tr><tr><td style="text-align:center"><strong>public void interrupt()</strong></td><td>ä¸­æ–­è¿™ä¸ªçº¿ç¨‹ï¼Œå¼‚å¸¸å¤„ç†æœºåˆ¶</td><td></td></tr><tr><td style="text-align:center"><strong>public static boolean interrupted()</strong></td><td>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°</td><td></td></tr><tr><td style="text-align:center"><strong>public boolean isInterrupted()</strong></td><td>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œä¸æ¸…é™¤æ‰“æ–­æ ‡è®°</td><td></td></tr><tr><td style="text-align:center"><strong>public final void join()</strong></td><td>ç­‰å¾…è¿™ä¸ªçº¿ç¨‹ç»“æŸ</td><td></td></tr><tr><td style="text-align:center"><strong>public final void join(long millis)</strong></td><td>ç­‰å¾…è¿™ä¸ªçº¿ç¨‹æ­»äº¡millisæ¯«ç§’ï¼Œ0æ„å‘³ç€æ°¸è¿œç­‰å¾…</td><td></td></tr><tr><td style="text-align:center"><strong>public final native boolean isAlive()</strong></td><td>çº¿ç¨‹æ˜¯å¦å­˜æ´»ï¼ˆè¿˜æ²¡æœ‰è¿è¡Œå®Œæ¯•ï¼‰</td><td></td></tr><tr><td style="text-align:center"><strong>public final void setDaemon(boolean on)</strong></td><td>å°†æ­¤çº¿ç¨‹æ ‡è®°ä¸ºå®ˆæŠ¤çº¿ç¨‹æˆ–ç”¨æˆ·çº¿ç¨‹</td><td></td></tr><tr><td style="text-align:center"><strong>public long getId()</strong></td><td>è·å–çº¿ç¨‹é•¿æ•´å‹ çš„ id</td><td>id å”¯ä¸€</td></tr><tr><td style="text-align:center"><strong>public state getState()</strong></td><td>è·å–çº¿ç¨‹çŠ¶æ€</td><td>Java ä¸­çº¿ç¨‹çŠ¶æ€æ˜¯ç”¨ 6 ä¸ª enum è¡¨ç¤ºï¼Œåˆ†åˆ«ä¸ºï¼š NEW, RUNNABLE, BLOCKED, WAITING,  TIMED_WAITING, TERMINATED</td></tr><tr><td style="text-align:center"><strong>public boolean isInterrupted()</strong></td><td>åˆ¤æ–­æ˜¯å¦è¢«æ‰“æ–­</td><td>ä¸ä¼šæ¸…é™¤ æ‰“æ–­æ ‡è®°</td></tr></tbody></table><h3 id="4-1-start-ä¸-run">4.1 start ä¸ run</h3><div class="tabs" id="37a7a653-d3c7-430b-9d4c-4ae74634c993"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#37a7a653-d3c7-430b-9d4c-4ae74634c993-1"><i class="fas fa-seedling"></i>è°ƒç”¨run</button></li><li class="tab"><button type="button" data-href="#37a7a653-d3c7-430b-9d4c-4ae74634c993-2"><i class="fas fa-leaf"></i>è°ƒç”¨ start</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="37a7a653-d3c7-430b-9d4c-4ae74634c993-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;running...&quot;</span>);</span><br><span class="line">        FileReader.read(Constants.MP4_FULL_PATH);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">t1.run();</span><br><span class="line">log.debug(<span class="string">&quot;do other things...&quot;</span>);</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>:<span class="number">39</span>:<span class="number">14</span> [main] c.TestStart - main</span><br><span class="line"><span class="number">19</span>:<span class="number">39</span>:<span class="number">14</span> [main] c.FileReader - read [<span class="number">1.</span>mp4] start ...</span><br><span class="line"><span class="number">19</span>:<span class="number">39</span>:<span class="number">18</span> [main] c.FileReader - read [<span class="number">1.</span>mp4] end ... cost: <span class="number">4227</span> ms</span><br><span class="line"><span class="number">19</span>:<span class="number">39</span>:<span class="number">18</span> [main] c.TestStart - <span class="keyword">do</span> other things ...</span><br></pre></td></tr></table></figure><p>ç¨‹åºä»åœ¨ main çº¿ç¨‹è¿è¡Œï¼Œ FileReader.read() æ–¹æ³•è°ƒç”¨è¿˜æ˜¯åŒæ­¥çš„</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="37a7a653-d3c7-430b-9d4c-4ae74634c993-2"><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Thread t1 = <span class="built_in">new</span> Thread(&quot;t1&quot;) &#123;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="built_in">public</span> <span class="type">void</span> run() &#123;</span><br><span class="line">        <span class="keyword">log</span>.<span class="keyword">debug</span>(&quot;running...&quot;);</span><br><span class="line">        FileReader.<span class="keyword">read</span>(Constants.MP4_FULL_PATH);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">t1.<span class="keyword">start</span>();</span><br><span class="line"><span class="keyword">log</span>.<span class="keyword">debug</span>(&quot;do other things...&quot;);</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>:<span class="number">41</span>:<span class="number">30</span> [main] c.TestStart - <span class="keyword">do</span> other things ...</span><br><span class="line"><span class="number">19</span>:<span class="number">41</span>:<span class="number">30</span> [t1] c.TestStart - t1</span><br><span class="line"><span class="number">19</span>:<span class="number">41</span>:<span class="number">30</span> [t1] c.FileReader - read [<span class="number">1.</span>mp4] start ...</span><br><span class="line"><span class="number">19</span>:<span class="number">41</span>:<span class="number">35</span> [t1] c.FileReader - read [<span class="number">1.</span>mp4] end ... cost: <span class="number">4542</span> ms</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <p>ç¨‹åºåœ¨ t1 çº¿ç¨‹è¿è¡Œï¼Œ FileReader.read() æ–¹æ³•è°ƒç”¨æ˜¯å¼‚æ­¥çš„</p><p>å°ç»“</p><ul><li>ç›´æ¥è°ƒç”¨ run æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œäº† runï¼Œæ²¡æœ‰å¯åŠ¨æ–°çš„çº¿ç¨‹ä½¿ç”¨</li><li>start æ˜¯å¯åŠ¨æ–°çš„çº¿ç¨‹ï¼Œé€šè¿‡æ–°çš„çº¿ç¨‹é—´æ¥æ‰§è¡Œ run ä¸­çš„ä»£ç </li></ul><h3 id="4-2-sleep-ä¸-yield">4.2 sleep ä¸ yield</h3> <span class='p red'>sleep</span><ol><li><p>è°ƒç”¨ sleep ä¼šè®©å½“å‰çº¿ç¨‹ä» <code>Running</code> è¿›å…¥ <code>Timed Waiting</code> çŠ¶æ€ï¼ˆé˜»å¡ï¼‰</p></li><li><p>å…¶å®ƒçº¿ç¨‹å¯ä»¥ä½¿ç”¨<code>interrupt</code> æ–¹æ³•æ‰“æ–­æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ï¼Œè¿™æ—¶ sleep æ–¹æ³•ä¼šæŠ›å‡º<code> InterruptedException</code></p></li><li><p>ç¡çœ ç»“æŸåçš„çº¿ç¨‹æœªå¿…ä¼šç«‹åˆ»å¾—åˆ°æ‰§è¡Œ</p></li><li><p>å»ºè®®ç”¨ TimeUnit çš„ sleep ä»£æ›¿ Thread çš„ sleep æ¥è·å¾—æ›´å¥½çš„å¯è¯»æ€§</p></li></ol><div class="tabs" id="3b3240a2-7334-448d-a058-86575d758a4a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#3b3240a2-7334-448d-a058-86575d758a4a-1"><i class="fas fa-seedling"></i>sleep</button></li><li class="tab"><button type="button" data-href="#3b3240a2-7334-448d-a058-86575d758a4a-2"><i class="fas fa-leaf"></i>interrupt</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="3b3240a2-7334-448d-a058-86575d758a4a-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">t1.start();</span><br><span class="line">log.debug(<span class="string">&quot;t1 state: &#123;&#125;&quot;</span>, t1.getState());</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Thread.sleep(<span class="number">500</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">log.debug(<span class="string">&quot;t1 state: &#123;&#125;&quot;</span>, t1.getState());</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>:<span class="number">48</span>:<span class="number">28.583</span> c.Test6 [main] - t1 state: RUNNABLE</span><br><span class="line"><span class="number">19</span>:<span class="number">48</span>:<span class="number">29.093</span> c.Test6 [main] - t1 state: TIMED_WAITING</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="3b3240a2-7334-448d-a058-86575d758a4a-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;enter sleep...&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;wake up...&quot;</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">t1.start();</span><br><span class="line"></span><br><span class="line">Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">log.debug(<span class="string">&quot;interrupt...&quot;</span>);</span><br><span class="line">t1.interrupt();</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>:<span class="number">47</span>:<span class="number">28.034</span> c.Test7 [t1] - enter sleep...</span><br><span class="line"><span class="number">19</span>:<span class="number">47</span>:<span class="number">29.035</span> c.Test7 [main] - interrupt...</span><br><span class="line"><span class="number">19</span>:<span class="number">47</span>:<span class="number">29.036</span> c.Test7 [t1] - wake up...</span><br><span class="line">java.lang.InterruptedException: sleep interrupted</span><br><span class="line">  at java.lang.Thread.sleep(Native Method)</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <span class='p red'>yield</span><ol><li>è°ƒç”¨ yield ä¼šè®©å½“å‰çº¿ç¨‹ä» <code>Running</code> è¿›å…¥ <code>Runnable</code> å°±ç»ªçŠ¶ï¼Œç„¶åè°ƒåº¦æ‰§è¡Œå…¶å®ƒçº¿ç¨‹</li><li>å…·ä½“çš„å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨</li></ol><span class='p red'>çº¿ç¨‹ä¼˜å…ˆçº§</span> <ul><li>çº¿ç¨‹ä¼˜å…ˆçº§ä¼šæç¤ºï¼ˆhintï¼‰è°ƒåº¦å™¨ä¼˜å…ˆè°ƒåº¦è¯¥çº¿ç¨‹ï¼Œä½†å®ƒä»…ä»…æ˜¯ä¸€ä¸ªæç¤ºï¼Œè°ƒåº¦å™¨å¯ä»¥å¿½ç•¥å®ƒ</li><li>å¦‚æœ cpu æ¯”è¾ƒå¿™ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ä¼šè·å¾—æ›´å¤šçš„æ—¶é—´ç‰‡ï¼Œä½† cpu é—²æ—¶ï¼Œä¼˜å…ˆçº§å‡ ä¹æ²¡ä½œç”¨</li></ul><hr><span class='p green'>åº”ç”¨->é™åˆ¶å¯¹ CPU çš„ä½¿ç”¨:sleepå®ç°</span><p>åœ¨æ²¡æœ‰åˆ©ç”¨ cpu æ¥è®¡ç®—æ—¶ï¼Œä¸è¦è®© while(true) ç©ºè½¬æµªè´¹ cpuï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨ yield æˆ– sleep æ¥è®©å‡º cpu çš„ä½¿ç”¨æƒç»™å…¶ä»–ç¨‹åº</p><div class="tabs" id="77ec7c60-8160-4630-b5cd-b0877ffaa8eb"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#77ec7c60-8160-4630-b5cd-b0877ffaa8eb-1"><i class="fas fa-seedling"></i>ä¸åŠ sleep</button></li><li class="tab"><button type="button" data-href="#77ec7c60-8160-4630-b5cd-b0877ffaa8eb-2"><i class="fas fa-leaf"></i>åŠ äº†sleep</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="77ec7c60-8160-4630-b5cd-b0877ffaa8eb-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//Thread.sleep(50);</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230328202021650.png" alt="image-20230328202021650"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="77ec7c60-8160-4630-b5cd-b0877ffaa8eb-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">50</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230328202215363.png" alt="image-20230328202215363"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <p>å¯¹æ¯”å·®è·æ˜æ˜¾ å‰ï¼šCPUå ç”¨ç‡è¾¾åˆ°98% åï¼šCPUå ç”¨ç‡ä»…ä¸º4%</p><ul><li>å¯ä»¥ç”¨ wait æˆ– æ¡ä»¶å˜é‡è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœ</li><li>ä¸åŒçš„æ˜¯ï¼Œåä¸¤ç§éƒ½éœ€è¦åŠ é”ï¼Œå¹¶ä¸”éœ€è¦ç›¸åº”çš„å”¤é†’æ“ä½œï¼Œä¸€èˆ¬é€‚ç”¨äºè¦è¿›è¡ŒåŒæ­¥çš„åœºæ™¯</li><li>sleep é€‚ç”¨äºæ— éœ€é”åŒæ­¥çš„åœºæ™¯</li></ul><h3 id="4-3-join">4.3 join</h3><h4 id="4-3-1-ä¸ºä»€ä¹ˆéœ€è¦-joinï¼Ÿ">4.3.1 ä¸ºä»€ä¹ˆéœ€è¦ joinï¼Ÿ</h4><p>join():ç­‰å¾…è¿™ä¸ªçº¿ç¨‹ç»“æŸ</p><p>ä¸‹é¢çš„ä»£ç æ‰§è¡Œï¼Œæ‰“å° r æ˜¯ä»€ä¹ˆï¼Ÿ<div class="tabs" id="e86601f4-66de-4283-b742-f4fc07296e30"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e86601f4-66de-4283-b742-f4fc07296e30-1"><i class="fas fa-seedling"></i>æ— join</button></li><li class="tab"><button type="button" data-href="#e86601f4-66de-4283-b742-f4fc07296e30-2"><i class="fas fa-leaf"></i>joinå</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e86601f4-66de-4283-b742-f4fc07296e30-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    test1();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;å¼€å§‹&quot;</span>);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;å¼€å§‹&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;ç»“æŸ&quot;</span>);</span><br><span class="line">        r = <span class="number">10</span>;</span><br><span class="line">    &#125;,<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    <span class="comment">//t1.join();</span></span><br><span class="line">    log.debug(<span class="string">&quot;ç»“æœä¸º:&#123;&#125;&quot;</span>, r);</span><br><span class="line">    log.debug(<span class="string">&quot;ç»“æŸ&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">31</span>:<span class="number">57.122</span> c.Test10 [main] - å¼€å§‹</span><br><span class="line"><span class="number">20</span>:<span class="number">31</span>:<span class="number">57.208</span> c.Test10 [t1] - å¼€å§‹</span><br><span class="line"><span class="number">20</span>:<span class="number">31</span>:<span class="number">57.208</span> c.Test10 [main] - ç»“æœä¸º:<span class="number">0</span></span><br><span class="line"><span class="number">20</span>:<span class="number">31</span>:<span class="number">57.215</span> c.Test10 [main] - ç»“æŸ</span><br><span class="line"><span class="number">20</span>:<span class="number">31</span>:<span class="number">58.218</span> c.Test10 [t1] - ç»“æŸ</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e86601f4-66de-4283-b742-f4fc07296e30-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    test1();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;å¼€å§‹&quot;</span>);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;å¼€å§‹&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;ç»“æŸ&quot;</span>);</span><br><span class="line">        r = <span class="number">10</span>;</span><br><span class="line">    &#125;,<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    t1.join();</span><br><span class="line">    log.debug(<span class="string">&quot;ç»“æœä¸º:&#123;&#125;&quot;</span>, r);</span><br><span class="line">    log.debug(<span class="string">&quot;ç»“æŸ&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">32</span>:<span class="number">24.676</span> c.Test10 [main] - å¼€å§‹</span><br><span class="line"><span class="number">20</span>:<span class="number">32</span>:<span class="number">24.760</span> c.Test10 [t1] - å¼€å§‹</span><br><span class="line"><span class="number">20</span>:<span class="number">32</span>:<span class="number">25.769</span> c.Test10 [t1] - ç»“æŸ</span><br><span class="line"><span class="number">20</span>:<span class="number">32</span>:<span class="number">25.770</span> c.Test10 [main] - ç»“æœä¸º:<span class="number">10</span></span><br><span class="line"><span class="number">20</span>:<span class="number">32</span>:<span class="number">25.775</span> c.Test10 [main] - ç»“æŸ</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></p><p>åˆ†æ</p><ul><li>å› ä¸ºä¸»çº¿ç¨‹å’Œçº¿ç¨‹ t1 æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œt1 çº¿ç¨‹éœ€è¦ 1 ç§’ä¹‹åæ‰èƒ½ç®—å‡º r=10</li><li>è€Œä¸»çº¿ç¨‹ä¸€å¼€å§‹å°±è¦æ‰“å° r çš„ç»“æœï¼Œæ‰€ä»¥åªèƒ½æ‰“å°å‡º r=0</li></ul><p>è§£å†³æ–¹æ³•</p><ul><li>ç”¨ sleepï¼Œç¡çœ æ—¶é—´ä¸å¤ªå¥½æŠŠæ¡</li><li>ç”¨ joinï¼ŒåŠ åœ¨ t1.start() ä¹‹åå³å¯</li></ul><span class='p green'>åº”ç”¨ä¹‹åŒæ­¥</span> <p>ä»¥è°ƒç”¨æ–¹è§’åº¦æ¥è®²ï¼Œå¦‚æœ</p><ul><li>éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯åŒæ­¥</li><li>ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯å¼‚æ­¥</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220224020718153.png" alt="image-20220224020718153"></p><span class='p blue'>ç­‰å¾…å¤šä¸ªç»“æœ</span> <p>é—®ï¼Œä¸‹é¢ä»£ç  cost å¤§çº¦å¤šå°‘ç§’ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">r1</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">r2</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    test2();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        r1 = <span class="number">10</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        r2 = <span class="number">20</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    log.debug(<span class="string">&quot;join begin&quot;</span>);</span><br><span class="line">    t2.join();</span><br><span class="line">    log.debug(<span class="string">&quot;t1 join end&quot;</span>);</span><br><span class="line">    t1.join();</span><br><span class="line">    log.debug(<span class="string">&quot;t2 join end&quot;</span>);</span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    log.debug(<span class="string">&quot;r1: &#123;&#125; r2: &#123;&#125; cost: &#123;&#125;&quot;</span>, r1, r2, end - start);</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>åˆ†æå¦‚ä¸‹</p><ul><li>ç¬¬ä¸€ä¸ª joinï¼šç­‰å¾… t1 æ—¶, t2 å¹¶æ²¡æœ‰åœæ­¢, è€Œåœ¨è¿è¡Œ</li><li>ç¬¬äºŒä¸ª joinï¼š1s å, æ‰§è¡Œåˆ°æ­¤, t2 ä¹Ÿè¿è¡Œäº† 1s, å› æ­¤ä¹Ÿåªéœ€å†ç­‰å¾… 1s</li></ul><p>å¦‚æœé¢ å€’ä¸¤ä¸ª join å‘¢ï¼Ÿ</p><p>æœ€ç»ˆéƒ½æ˜¯è¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">20:50:36.894 c.TestJoin [main] - <span class="built_in">join</span> begin</span><br><span class="line">20:50:37.897 c.TestJoin [main] - t1 <span class="built_in">join</span> end</span><br><span class="line">20:50:38.896 c.TestJoin [main] - t2 <span class="built_in">join</span> end</span><br><span class="line">20:50:38.897 c.TestJoin [main] - r1: 10 r2: 20 cost: 2012</span><br></pre></td></tr></table></figure><h4 id="4-3-2-æœ‰æ—¶æ•ˆçš„join">4.3.2 æœ‰æ—¶æ•ˆçš„join</h4><p><code>public final void join(long millis)</code></p><div class="tabs" id="92e88be6-bfba-468b-90c6-0a618f0a04f0"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#92e88be6-bfba-468b-90c6-0a618f0a04f0-1"><i class="fas fa-seedling"></i>å½“çº¿ç¨‹æ‰§è¡Œæ—¶é—´æ²¡æœ‰è¶…è¿‡joinè®¾å®šæ—¶é—´</button></li><li class="tab"><button type="button" data-href="#92e88be6-bfba-468b-90c6-0a618f0a04f0-2"><i class="fas fa-leaf"></i>å½“æ‰§è¡Œæ—¶é—´è¶…æ—¶joinè®¾å®šæ—¶é—´</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="92e88be6-bfba-468b-90c6-0a618f0a04f0-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">r1</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">r2</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    test3();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        r1 = <span class="number">10</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    t1.start();</span><br><span class="line">    <span class="comment">// çº¿ç¨‹æ‰§è¡Œç»“æŸä¼šå¯¼è‡´ join ç»“æŸ</span></span><br><span class="line">    t1.join(<span class="number">1500</span>);</span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    log.debug(<span class="string">&quot;r1: &#123;&#125; r2: &#123;&#125; cost: &#123;&#125;&quot;</span>, r1, r2, end - start);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">48</span>:<span class="number">01.320</span> [main] c.TestJoin - r1: <span class="number">10</span> r2: <span class="number">0</span> cost: <span class="number">1010</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="92e88be6-bfba-468b-90c6-0a618f0a04f0-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">r1</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">r2</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    test3();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        r1 = <span class="number">10</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    t1.start();</span><br><span class="line">    <span class="comment">// çº¿ç¨‹æ‰§è¡Œç»“æŸä¼šå¯¼è‡´ join ç»“æŸ</span></span><br><span class="line">    t1.join(<span class="number">1500</span>);</span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    log.debug(<span class="string">&quot;r1: &#123;&#125; r2: &#123;&#125; cost: &#123;&#125;&quot;</span>, r1, r2, end - start);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">52</span>:<span class="number">15.623</span> [main] c.TestJoin - r1: <span class="number">0</span> r2: <span class="number">0</span> cost: <span class="number">1502</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <h3 id="4-4-interruptæ–¹æ³•è¯¦è§£">4.4 interruptæ–¹æ³•è¯¦è§£</h3><blockquote><p>interrupt() ä¸­æ–­è¿™ä¸ªçº¿ç¨‹ï¼Œå¼‚å¸¸å¤„ç†æœºåˆ¶</p><p>isInterrupted() åˆ¤æ–­æ˜¯å¦è¢«æ‰“æ–­ï¼Œä¸ä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°</p><p>interrupted() åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°</p></blockquote><h4 id="4-4-1-Interruptè¯´æ˜">4.4.1 Interruptè¯´æ˜</h4><p><code>interrupt</code>çš„æœ¬è´¨æ˜¯å°†çº¿ç¨‹çš„æ‰“æ–­æ ‡è®°è®¾ä¸ºtrueï¼Œå¹¶è°ƒç”¨çº¿ç¨‹çš„ä¸‰ä¸ªparkerå¯¹è±¡ï¼ˆC++å®ç°çº§åˆ«ï¼‰unparkè¯¥çº¿ç¨‹ã€‚</p><p>åŸºäºä»¥ä¸Šæœ¬è´¨ï¼Œæœ‰å¦‚ä¸‹è¯´æ˜ï¼š</p><ul><li>æ‰“æ–­çº¿ç¨‹ä¸ç­‰äºä¸­æ–­çº¿ç¨‹ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š<ul><li>æ‰“æ–­æ­£åœ¨è¿è¡Œä¸­çš„çº¿ç¨‹å¹¶ä¸ä¼šå½±å“çº¿ç¨‹çš„è¿è¡Œï¼Œä½†å¦‚æœçº¿ç¨‹ç›‘æµ‹åˆ°äº†æ‰“æ–­æ ‡è®°ä¸ºtrueï¼Œå¯ä»¥è‡ªè¡Œå†³å®šåç»­å¤„ç†ã€‚</li><li>æ‰“æ–­é˜»å¡ä¸­çš„çº¿ç¨‹ä¼šè®©æ­¤çº¿ç¨‹äº§ç”Ÿä¸€ä¸ª<code>InterruptedException</code>å¼‚å¸¸ï¼Œç»“æŸçº¿ç¨‹çš„è¿è¡Œã€‚ä½†å¦‚æœè¯¥å¼‚å¸¸è¢«çº¿ç¨‹æ•è·ä½ï¼Œè¯¥çº¿ç¨‹ä¾ç„¶å¯ä»¥è‡ªè¡Œå†³å®šåç»­å¤„ç†ï¼ˆç»ˆæ­¢è¿è¡Œï¼Œç»§ç»­è¿è¡Œï¼Œåšä¸€äº›å–„åå·¥ä½œç­‰ç­‰ï¼‰</li></ul></li></ul><div class="tabs" id="49a6a199-6c57-4024-96bf-35414686bad9"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#49a6a199-6c57-4024-96bf-35414686bad9-1"><i class="fas fa-seedling"></i>æ‰“æ–­sleepï¼Œwaitï¼Œjoin çš„çº¿ç¨‹</button></li><li class="tab"><button type="button" data-href="#49a6a199-6c57-4024-96bf-35414686bad9-2"><i class="fas fa-leaf"></i>æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="49a6a199-6c57-4024-96bf-35414686bad9-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    sleep(<span class="number">0.5</span>);</span><br><span class="line">    t1.interrupt();</span><br><span class="line">    log.debug(<span class="string">&quot; æ‰“æ–­çŠ¶æ€: &#123;&#125;&quot;</span>, t1.isInterrupted());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">java.lang.InterruptedException: sleep interrupted</span><br><span class="line"> at java.lang.Thread.sleep(Native Method)</span><br><span class="line"> at java.lang.Thread.sleep(Thread.java:<span class="number">340</span>)</span><br><span class="line"> at java.util.concurrent.TimeUnit.sleep(TimeUnit.java:<span class="number">386</span>)</span><br><span class="line"> at cn.itcast.n2.util.Sleeper.sleep(Sleeper.java:<span class="number">8</span>)</span><br><span class="line"> at cn.itcast.n4.TestInterrupt.lambda$test1$<span class="number">3</span>(TestInterrupt.java:<span class="number">59</span>)</span><br><span class="line"> at java.lang.Thread.run(Thread.java:<span class="number">745</span>)</span><br><span class="line"><span class="number">21</span>:<span class="number">18</span>:<span class="number">10.374</span> [main] c.TestInterrupt - æ‰“æ–­çŠ¶æ€: <span class="literal">false</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="49a6a199-6c57-4024-96bf-35414686bad9-2"><p>æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹, ä¸ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> current.isInterrupted();</span><br><span class="line">            <span class="keyword">if</span>(interrupted) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot; æ‰“æ–­çŠ¶æ€: &#123;&#125;&quot;</span>, interrupted);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    t2.start();</span><br><span class="line">    sleep(<span class="number">0.5</span>);</span><br><span class="line">    t2.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">57</span>:<span class="number">37.964</span> [t2] c.TestInterrupt - æ‰“æ–­çŠ¶æ€: <span class="literal">true</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><span class='p yellow'>æ¨¡å¼->ä¸¤é˜¶æ®µç»ˆæ­¢</span><p>Two Phase Termination</p><p>åœ¨ä¸€ä¸ªçº¿ç¨‹ T1 ä¸­å¦‚ä½•â€œä¼˜é›…â€ç»ˆæ­¢çº¿ç¨‹ T2ï¼Ÿ</p><p>è¿™é‡Œçš„ã€ä¼˜é›…ã€‘æŒ‡çš„æ˜¯ç»™ T2 ä¸€ä¸ªæ–™ç†åäº‹çš„æœºä¼šã€‚</p><p>é”™è¯¯æ€è·¯</p><ul><li>ä½¿ç”¨çº¿ç¨‹å¯¹è±¡çš„ stop() æ–¹æ³•åœæ­¢çº¿ç¨‹<ul><li>stop æ–¹æ³•ä¼šçœŸæ­£æ€æ­»çº¿ç¨‹ï¼Œä¼šç«‹å³é‡Šæ”¾CPUèµ„æºå’Œé‡Šæ”¾é”,å¼ºè¡ŒæŠŠæ‰§è¡Œåˆ°ä¸€åŠçš„çº¿ç¨‹ç»ˆæ­¢ï¼Œæ˜¯ä¸å®‰å…¨çš„,å¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸åŒæ­¥å’Œä¸€äº›æ¸…ç†æ€§çš„å·¥ä½œå¾—ä¸åˆ°å®Œæˆ</li></ul></li><li>ä½¿ç”¨ System.exit(int) æ–¹æ³•åœæ­¢çº¿ç¨‹<ul><li>ç›®çš„ä»…æ˜¯åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†è¿™ç§åšæ³•ä¼šè®©æ•´ä¸ªç¨‹åºéƒ½åœæ­¢</li></ul></li></ul><div class="tabs" id="0467aa06-fc60-4b4f-b765-2f69cae104e4"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#0467aa06-fc60-4b4f-b765-2f69cae104e4-1"><i class="fas fa-seedling"></i>ä»£ç </button></li><li class="tab"><button type="button" data-href="#0467aa06-fc60-4b4f-b765-2f69cae104e4-2"><i class="fas fa-leaf"></i>è°ƒç”¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="0467aa06-fc60-4b4f-b765-2f69cae104e4-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TPTInterrupt</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Thread thread;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span>&#123;</span><br><span class="line">        thread = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">                <span class="keyword">if</span>(current.isInterrupted()) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ–™ç†åäº‹&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    log.debug(<span class="string">&quot;å°†ç»“æœä¿å­˜&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                  <span class="comment">//é‡æ–°è®¾ç½®æ‰“æ–­æ ‡è®°</span></span><br><span class="line">                    current.interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ‰§è¡Œç›‘æ§æ“ä½œ </span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;ç›‘æ§çº¿ç¨‹&quot;</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        thread.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0467aa06-fc60-4b4f-b765-2f69cae104e4-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TPTInterrupt</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TPTInterrupt</span>();</span><br><span class="line">t.start();</span><br><span class="line">Thread.sleep(<span class="number">3500</span>);</span><br><span class="line">log.debug(<span class="string">&quot;stop&quot;</span>);</span><br><span class="line">t.stop();</span><br></pre></td></tr></table></figure><p>ç»“æœï¼š</p><p>æ­£å¸¸æƒ…å†µè¢«æ‰“æ–­ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">11:49:42.915 c.TwoPhaseTermination [ç›‘æ§çº¿ç¨‹] - å°†ç»“æœä¿å­˜</span><br><span class="line">11:49:43.919 c.TwoPhaseTermination [ç›‘æ§çº¿ç¨‹] - å°†ç»“æœä¿å­˜</span><br><span class="line">11:49:44.919 c.TwoPhaseTermination [ç›‘æ§çº¿ç¨‹] - å°†ç»“æœä¿å­˜</span><br><span class="line">11:49:45.413 c.TestTwoPhaseTermination [main] - stop </span><br><span class="line">11:49:45.413 c.TwoPhaseTermination [ç›‘æ§çº¿ç¨‹] - æ–™ç†åäº‹</span><br></pre></td></tr></table></figure><p>Sleepæƒ…å†µè¢«æ‰“æ–­ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">11:49:42.915 c.TwoPhaseTermination [ç›‘æ§çº¿ç¨‹] - å°†ç»“æœä¿å­˜</span><br><span class="line">11:49:43.919 c.TwoPhaseTermination [ç›‘æ§çº¿ç¨‹] - å°†ç»“æœä¿å­˜</span><br><span class="line">11:49:44.919 c.TwoPhaseTermination [ç›‘æ§çº¿ç¨‹] - å°†ç»“æœä¿å­˜</span><br><span class="line">java.lang.InterruptedException: <span class="built_in">sleep</span> interrupted</span><br><span class="line"> at java.lang.Thread.<span class="built_in">sleep</span>(Native Method)</span><br><span class="line"> ...</span><br><span class="line">11:49:45.413 c.TwoPhaseTermination [ç›‘æ§çº¿ç¨‹] - æ–™ç†åäº‹</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230328220322812.png" alt="image-20230328220322812"></p><h3 id="4-5-ä¸æ¨èçš„æ–¹æ³•">4.5 ä¸æ¨èçš„æ–¹æ³•</h3><p>è¿˜æœ‰ä¸€äº›ä¸æ¨èä½¿ç”¨çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å·²è¿‡æ—¶ï¼Œå®¹æ˜“ç ´ååŒæ­¥ä»£ç å—ï¼Œé€ æˆçº¿ç¨‹æ­»é”</p><table><thead><tr><th style="text-align:center">æ–¹æ³•å</th><th style="text-align:center">static</th><th style="text-align:center">åŠŸèƒ½è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center">stop()</td><td style="text-align:center"></td><td style="text-align:center">åœæ­¢çº¿ç¨‹è¿è¡Œ</td></tr><tr><td style="text-align:center">suspend()</td><td style="text-align:center"></td><td style="text-align:center">æŒ‚èµ·ï¼ˆæš‚åœï¼‰çº¿ç¨‹è¿è¡Œ</td></tr><tr><td style="text-align:center">resume()</td><td style="text-align:center"></td><td style="text-align:center">æ¢å¤çº¿ç¨‹è¿è¡Œ</td></tr></tbody></table><h2 id="5-ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹">5. ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒJava è¿›ç¨‹éœ€è¦ç­‰å¾…æ‰€æœ‰çº¿ç¨‹éƒ½è¿è¡Œç»“æŸï¼Œæ‰ä¼šç»“æŸã€‚æœ‰ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹å«åšå®ˆæŠ¤çº¿ç¨‹ï¼Œåªè¦å…¶å®ƒéå®ˆæŠ¤çº¿ç¨‹è¿è¡Œç»“æŸäº†ï¼Œå³ä½¿å®ˆæŠ¤çº¿ç¨‹çš„ä»£ç æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¹Ÿä¼šå¼ºåˆ¶ç»“æŸã€‚</p><p>ä¾‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">log.debug(<span class="string">&quot;å¼€å§‹è¿è¡Œ...&quot;</span>);</span><br><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">     log.debug(<span class="string">&quot;å¼€å§‹è¿è¡Œ...&quot;</span>);</span><br><span class="line">     sleep(<span class="number">2</span>);</span><br><span class="line">     log.debug(<span class="string">&quot;è¿è¡Œç»“æŸ...&quot;</span>);</span><br><span class="line">&#125;, <span class="string">&quot;daemon&quot;</span>);</span><br><span class="line"><span class="comment">// è®¾ç½®è¯¥çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹</span></span><br><span class="line">t1.setDaemon(<span class="literal">true</span>);</span><br><span class="line">t1.start();</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">log.debug(<span class="string">&quot;è¿è¡Œç»“æŸ...&quot;</span>);</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">08:26:38.123 [main] c.TestDaemon - å¼€å§‹è¿è¡Œ... </span><br><span class="line">08:26:38.213 [daemon] c.TestDaemon - å¼€å§‹è¿è¡Œ... </span><br><span class="line">08:26:39.215 [main] c.TestDaemon - è¿è¡Œç»“æŸ... </span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„</p><ul><li>åƒåœ¾å›æ”¶å™¨çº¿ç¨‹å°±æ˜¯ä¸€ç§å®ˆæŠ¤çº¿ç¨‹</li><li>Tomcat ä¸­çš„ Acceptor å’Œ Poller çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œæ‰€ä»¥ Tomcat æ¥æ”¶åˆ° shutdown å‘½ä»¤åï¼Œä¸ä¼šç­‰å¾…å®ƒä»¬å¤„ç†å®Œå½“å‰è¯·æ±‚</li></ul></blockquote><h2 id="6-çº¿ç¨‹çŠ¶æ€æ¨¡å‹">6. çº¿ç¨‹çŠ¶æ€æ¨¡å‹</h2><h3 id="6-1-äº”ç§çŠ¶æ€">6.1 äº”ç§çŠ¶æ€</h3><p>è¿™æ˜¯ä» <code>æ“ä½œç³»ç»Ÿ</code> å±‚é¢æ¥æè¿°çš„</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230328225841170.png" alt="image-20230328225841170"></p><ul><li>ã€åˆå§‹çŠ¶æ€ã€‘ä»…æ˜¯åœ¨è¯­è¨€å±‚é¢åˆ›å»ºäº†çº¿ç¨‹å¯¹è±¡ï¼Œè¿˜æœªä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”</li><li>ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ï¼ˆå°±ç»ªçŠ¶æ€ï¼‰æŒ‡è¯¥çº¿ç¨‹å·²ç»è¢«åˆ›å»ºï¼ˆä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”ï¼‰ï¼Œå¯ä»¥ç”± CPU è°ƒåº¦æ‰§è¡Œ</li><li>ã€è¿è¡ŒçŠ¶æ€ã€‘æŒ‡è·å–äº† CPU æ—¶é—´ç‰‡è¿è¡Œä¸­çš„çŠ¶æ€<ul><li>å½“ CPU æ—¶é—´ç‰‡ç”¨å®Œï¼Œä¼šä»ã€è¿è¡ŒçŠ¶æ€ã€‘è½¬æ¢è‡³ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ï¼Œä¼šå¯¼è‡´çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢</li></ul></li><li>ã€é˜»å¡çŠ¶æ€ã€‘<ul><li>å¦‚æœè°ƒç”¨äº†é˜»å¡ APIï¼Œå¦‚ BIO è¯»å†™æ–‡ä»¶ï¼Œè¿™æ—¶è¯¥çº¿ç¨‹å®é™…ä¸ä¼šç”¨åˆ° CPUï¼Œä¼šå¯¼è‡´çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥ ã€é˜»å¡çŠ¶æ€ã€‘</li><li>ç­‰ BIO æ“ä½œå®Œæ¯•ï¼Œä¼šç”±æ“ä½œç³»ç»Ÿå”¤é†’é˜»å¡çš„çº¿ç¨‹ï¼Œè½¬æ¢è‡³ã€å¯è¿è¡ŒçŠ¶æ€ã€‘</li><li>ä¸ã€å¯è¿è¡ŒçŠ¶æ€ã€‘çš„åŒºåˆ«æ˜¯ï¼Œå¯¹ã€é˜»å¡çŠ¶æ€ã€‘çš„çº¿ç¨‹æ¥è¯´åªè¦å®ƒä»¬ä¸€ç›´ä¸å”¤é†’ï¼Œè°ƒåº¦å™¨å°±ä¸€ç›´ä¸ä¼šè€ƒè™‘ è°ƒåº¦å®ƒä»¬</li></ul></li><li>ã€ç»ˆæ­¢çŠ¶æ€ã€‘è¡¨ç¤ºçº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œç”Ÿå‘½å‘¨æœŸå·²ç»ç»“æŸï¼Œä¸ä¼šå†è½¬æ¢ä¸ºå…¶å®ƒçŠ¶æ€</li></ul><h3 id="6-2-å…­ç§çŠ¶æ€">6.2 å…­ç§çŠ¶æ€</h3><p>è¿™æ˜¯ä» <code>Java API </code>å±‚é¢æ¥æè¿°çš„</p><p>æ ¹æ® Thread.State æšä¸¾ï¼Œåˆ†ä¸ºå…­ç§çŠ¶æ€</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230328225953696.png" alt="image-20230328225953696"></p><ul><li>NEW çº¿ç¨‹åˆšè¢«åˆ›å»ºï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è°ƒç”¨ start() æ–¹æ³•</li><li>RUNNABLE å½“è°ƒç”¨äº† start() æ–¹æ³•ä¹‹åï¼Œæ³¨æ„ï¼ŒJava API å±‚é¢çš„ RUNNABLE çŠ¶æ€æ¶µç›–äº† æ“ä½œç³»ç»Ÿ å±‚é¢çš„ ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ã€ã€è¿è¡ŒçŠ¶æ€ã€‘å’Œã€é˜»å¡çŠ¶æ€ã€‘ï¼ˆç”±äº BIO å¯¼è‡´çš„çº¿ç¨‹é˜»å¡ï¼Œåœ¨ Java é‡Œæ— æ³•åŒºåˆ†ï¼Œä»ç„¶è®¤ä¸º æ˜¯å¯è¿è¡Œï¼‰</li><li>BLOCKED ï¼Œ WAITING ï¼Œ TIMED_WAITING éƒ½æ˜¯ Java API å±‚é¢å¯¹ã€é˜»å¡çŠ¶æ€ã€‘çš„ç»†åˆ†ï¼Œåé¢ä¼šåœ¨çŠ¶æ€è½¬æ¢ä¸€èŠ‚ è¯¦è¿°</li><li>TERMINATED å½“çº¿ç¨‹ä»£ç è¿è¡Œç»“æŸ</li></ul><div class="tabs" id="0091ddbb-7624-40c0-b929-7f012b5c82d6"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#0091ddbb-7624-40c0-b929-7f012b5c82d6-1">NEW</button></li><li class="tab"><button type="button" data-href="#0091ddbb-7624-40c0-b929-7f012b5c82d6-2">RUNNABLE</button></li><li class="tab"><button type="button" data-href="#0091ddbb-7624-40c0-b929-7f012b5c82d6-3">TERMINATED</button></li><li class="tab"><button type="button" data-href="#0091ddbb-7624-40c0-b929-7f012b5c82d6-4">TIMED_WAITING</button></li><li class="tab"><button type="button" data-href="#0091ddbb-7624-40c0-b929-7f012b5c82d6-5">WAITING</button></li><li class="tab"><button type="button" data-href="#0091ddbb-7624-40c0-b929-7f012b5c82d6-6">BLOCKED</button></li><li class="tab"><button type="button" data-href="#0091ddbb-7624-40c0-b929-7f012b5c82d6-7">è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="0091ddbb-7624-40c0-b929-7f012b5c82d6-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;running...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">log.debug(<span class="string">&quot;t1 state &#123;&#125;&quot;</span>, t1.getState());</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0091ddbb-7624-40c0-b929-7f012b5c82d6-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;t2&quot;</span>) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123; </span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">t2.start();</span><br><span class="line">log.debug(<span class="string">&quot;t2 state &#123;&#125;&quot;</span>, t2.getState());</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0091ddbb-7624-40c0-b929-7f012b5c82d6-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">t3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;t3&quot;</span>) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;running...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">t3.start();</span><br><span class="line">log.debug(<span class="string">&quot;t3 state &#123;&#125;&quot;</span>, t3.getState());</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0091ddbb-7624-40c0-b929-7f012b5c82d6-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">t4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;t4&quot;</span>) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (TestState.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000000</span>); </span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">t4.start();</span><br><span class="line">log.debug(<span class="string">&quot;t4 state &#123;&#125;&quot;</span>, t4.getState());</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0091ddbb-7624-40c0-b929-7f012b5c82d6-5"><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Thread t5 = <span class="keyword">new</span> Thread(<span class="string">&quot;t5&quot;</span>) &#123;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            t2.<span class="keyword">join</span>(); </span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">t5.start();</span><br><span class="line">log.debug(<span class="string">&quot;t5 state &#123;&#125;&quot;</span>, t5.getState());</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0091ddbb-7624-40c0-b929-7f012b5c82d6-6"><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Thread t6 = <span class="keyword">new</span> Thread(<span class="string">&quot;t6&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> run() &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (TestState.<span class="keyword">class</span>) &#123; </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">t6.start();</span><br><span class="line">log.<span class="keyword">debug</span>(<span class="string">&quot;t6 state &#123;&#125;&quot;</span>, t6.getState());</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0091ddbb-7624-40c0-b929-7f012b5c82d6-7"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Thread.sleep(<span class="number">500</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">08:<span class="number">30</span>:<span class="number">14.858</span> c.TestState [t3] - running...</span><br><span class="line">08:<span class="number">30</span>:<span class="number">15.356</span> c.TestState [main] - t1 state NEW</span><br><span class="line">08:<span class="number">30</span>:<span class="number">15.361</span> c.TestState [main] - t2 state RUNNABLE</span><br><span class="line">08:<span class="number">30</span>:<span class="number">15.361</span> c.TestState [main] - t3 state TERMINATED</span><br><span class="line">08:<span class="number">30</span>:<span class="number">15.361</span> c.TestState [main] - t4 state TIMED_WAITING</span><br><span class="line">08:<span class="number">30</span>:<span class="number">15.361</span> c.TestState [main] - t5 state WAITING</span><br><span class="line">08:<span class="number">30</span>:<span class="number">15.361</span> c.TestState [main] - t6 state BLOCKED</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>]]></content>
    
    
    <summary type="html">åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹ã€æŸ¥çœ‹çº¿ç¨‹ã€çº¿ç¨‹APIã€çº¿ç¨‹çŠ¶æ€</summary>
    
    
    
    <category term="Java" scheme="https://luckylittleboy.gitee.io/categories/Java/"/>
    
    
    <category term="JUC" scheme="https://luckylittleboy.gitee.io/tags/JUC/"/>
    
  </entry>
  
  <entry>
    <title>1.è¿›ç¨‹ä¸çº¿ç¨‹</title>
    <link href="https://luckylittleboy.gitee.io/posts/792b4657.html"/>
    <id>https://luckylittleboy.gitee.io/posts/792b4657.html</id>
    <published>2023-03-28T00:40:21.000Z</published>
    <updated>2023-04-04T13:37:55.549Z</updated>
    
    <content type="html"><![CDATA[<div class="tag link"><a class="link-card" title="JUCå¹¶å‘ç¼–ç¨‹" href="www.bilibili.com/video/BV16J411h7Rd"><div class="left"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/cc9c854fba9e3eb1139ee772d18fbdb9d056eac5.png@320w_200h_!web-space-upload-video.avif"/></div><div class="right"><p class="text">JUCå¹¶å‘ç¼–ç¨‹</p><p class="url">www.bilibili.com/video/BV16J411h7Rd</p></div></a></div><h2 id="1-çº¿ç¨‹ä¸è¿›ç¨‹">1.çº¿ç¨‹ä¸è¿›ç¨‹</h2><span class='p red'>è¿›ç¨‹</span><p>ç¨‹åºç”±æŒ‡ä»¤å’Œæ•°æ®ç»„æˆï¼Œä½†è¿™äº›æŒ‡ä»¤è¦è¿è¡Œï¼Œæ•°æ®è¦è¯»å†™ï¼Œå°±å¿…é¡»å°†æŒ‡ä»¤åŠ è½½è‡³CPUï¼Œæ•°æ®åŠ è½½è‡³å†…å­˜ã€‚åœ¨æŒ‡ä»¤è¿è¡Œè¿‡ç¨‹ä¸­è¿˜éœ€è¦ç”¨åˆ°ç£ç›˜ï¼Œç½‘ç»œç­‰è®¾å¤‡ã€‚è¿›ç¨‹å°±æ˜¯ç”¨æ¥åŠ è½½æŒ‡ä»¤ï¼Œç®¡ç†å†…å­˜ï¼Œç®¡ç†OIçš„ã€‚<br>å½“ä¸€ä¸ªç¨‹åºè¢«è¿è¡Œï¼Œä»ç£ç›˜åŠ è½½è¿™ä¸ªç¨‹åºçš„ä»£ç è‡³å†…å­˜ï¼Œè¿™æ—¶å°±å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹ã€‚<br>è¿›ç¨‹å°±å¯ä»¥è§†ä¸ºç¨‹åºçš„ä¸€ä¸ªå®ä¾‹ã€‚å¤§éƒ¨åˆ†ç¨‹åºå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚è®°äº‹æœ¬ï¼Œç”»å›¾ï¼Œæµè§ˆå™¨ç­‰ï¼‰ï¼Œä¹Ÿæœ‰ç¨‹åºåªèƒ½å¯åŠ¨ä¸€ä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚ç½‘æ˜“äº‘éŸ³ä¹ï¼Œ360å®‰å…¨å«å£«ç­‰ï¼‰ã€‚</p><span class='p red'>çº¿ç¨‹</span><p>ä¸€ä¸ªè¿›ç¨‹ä¹‹å†…å¯ä»¥åˆ†ä¸ºä¸€åˆ°å¤šä¸ªçº¿ç¨‹ã€‚<br>ä¸€ä¸ªçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªæŒ‡ä»¤æµï¼Œå°†æŒ‡ä»¤æµä¸­çš„ä¸€æ¡æ¡æŒ‡ä»¤ä»¥ä¸€å®šçš„é¡ºåºäº¤ç»™CPUæ‰§è¡Œã€‚<br>javaä¸­ï¼Œçº¿ç¨‹ä½œä¸ºæœ€å°è°ƒåº¦å•ä½ï¼Œè¿›ç¨‹ä½œä¸ºèµ„æºåˆ†é…çš„æœ€å°å•ä½ã€‚åœ¨windowsä¸­è¿›ç¨‹æ˜¯ä¸æ´»åŠ¨çš„ï¼Œåªæ˜¯ä½œä¸ºçº¿ç¨‹çš„å®¹å™¨ã€‚</p><span class='p red'>äºŒè€…å¯¹æ¯”</span><p>è¿›ç¨‹åŸºæœ¬ä¸Šç›¸äº’ç‹¬ç«‹ï¼Œè€Œçº¿ç¨‹å­˜åœ¨äºè¿›ç¨‹å†…ï¼Œæ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå­é›†ã€‚<br>è¿›ç¨‹æ‹¥æœ‰å…±äº«çš„èµ„æºï¼Œå¦‚å†…å­˜ç©ºé—´ï¼Œä¾›å…¶å†…éƒ¨çš„çº¿ç¨‹å…±äº«ã€‚<br>è¿›ç¨‹é—´é€šä¿¡è¾ƒä¸ºå¤æ‚<br>åŒä¸€å°è®¡ç®—æœºçš„è¿›ç¨‹é€šä¿¡ç§°ä¸ºIPCï¼ˆInter-process communication).<br>ä¸åŒè®¡ç®—æœºä¹‹é—´çš„è¿›ç¨‹é€šä¿¡ï¼Œéœ€è¦é€šè¿‡ç½‘ç»œï¼Œå¹¶éµå®ˆå…±åŒçš„åè®®ï¼Œå¦‚HTTPã€‚<br>çº¿ç¨‹é€šä¿¡ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºå®ƒä»¬å…±äº«è¿›ç¨‹å†…çš„å†…å­˜ã€‚ä¸€ä¸ªä¾‹å­æ˜¯å¤šä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®åŒä¸€ä¸ªå…±äº«å˜é‡ã€‚<br>çº¿ç¨‹æ›´è½»é‡ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ä¸€èˆ¬æ¯”è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä½ã€‚</p><h2 id="2-å¹¶è¡Œä¸å¹¶å‘">2.å¹¶è¡Œä¸å¹¶å‘</h2><span class='p red'>å¹¶å‘</span><p>å•æ ¸cpuä¸‹ï¼Œçº¿ç¨‹å®é™…è¿˜<span class='p red'>ä¸²è¡Œæ‰§è¡Œ</span> çš„ã€‚æ“ä½œç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªç»„ä»¶å«åšä»»åŠ¡è°ƒåº¦å™¨ï¼Œå°†cpuçš„æ—¶é—´ç‰‡ï¼ˆwindowsä¸‹æ—¶é—´ç‰‡æœ€å°çº¦15æ¯«ç§’ï¼‰åˆ†ç»™ä¸åŒçº¿ç¨‹ä½¿ç”¨ï¼Œåªæ˜¯ç”±äºcpuåœ¨çº¿ç¨‹é—´ï¼ˆæ—¶é—´ç‰‡å¾ˆçŸ­ï¼‰çš„åˆ‡æ¢éå¸¸å¿«ã€‚äººç±»æ„Ÿè§‰æ˜¯åŒæ—¶è¿è¡Œçš„ã€‚æ€»ç»“ä¸€å¥è¯å°±æ˜¯ï¼š<span class='p green'>å¾®è§‚ä¸²è¡Œï¼Œå®è§‚å¹¶è¡Œ</span> ã€‚</p><span class='p red'>åŒä¸€æ—¶åˆ»ï¼Œå…¶å®åªæœ‰ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿ</span><p>ä¸€èˆ¬ä¼šå°†è¿™ç§çº¿ç¨‹è½®æµä½¿ç”¨cpuçš„åšæ³•ç§°ä¸ºå¹¶å‘ï¼ˆconcurrentï¼‰ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1OTY2NDQw,size_16,color_FFFFFF,t_70.png" alt="img"></p><table><thead><tr><th style="text-align:center">CPU</th><th style="text-align:center">æ—¶é—´ç‰‡ 1</th><th style="text-align:center">æ—¶é—´ç‰‡ 2</th><th style="text-align:center">æ—¶é—´ç‰‡ 3</th><th style="text-align:center">æ—¶é—´ç‰‡ 4</th></tr></thead><tbody><tr><td style="text-align:center">core</td><td style="text-align:center">çº¿ç¨‹ 1</td><td style="text-align:center">çº¿ç¨‹ 2</td><td style="text-align:center">çº¿ç¨‹ 3</td><td style="text-align:center">çº¿ç¨‹ 4</td></tr></tbody></table><span class='p red'>å¹¶è¡Œ</span> <p>å¤šæ ¸cpuä¸‹ï¼Œæ¯ä¸ªæ ¸ï¼ˆcoreï¼‰éƒ½å¯ä»¥è°ƒåº¦è¿è¡Œçº¿ç¨‹ï¼Œè¿™æ—¶å€™çº¿ç¨‹å¯ä»¥æ˜¯å¹¶è¡Œçš„ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1OTY2NDQw,size_16,color_FFFFFF,t_70-20230328115500809.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><table><thead><tr><th style="text-align:center">CPU</th><th style="text-align:center">æ—¶é—´ç‰‡ 1</th><th style="text-align:center">æ—¶é—´ç‰‡ 2</th><th style="text-align:center">æ—¶é—´ç‰‡ 3</th><th style="text-align:center">æ—¶é—´ç‰‡ 4</th></tr></thead><tbody><tr><td style="text-align:center">core1</td><td style="text-align:center">çº¿ç¨‹ 1</td><td style="text-align:center">çº¿ç¨‹ 2</td><td style="text-align:center">çº¿ç¨‹ 3</td><td style="text-align:center">çº¿ç¨‹ 4</td></tr><tr><td style="text-align:center">core2</td><td style="text-align:center">çº¿ç¨‹ 4</td><td style="text-align:center">çº¿ç¨‹ 4</td><td style="text-align:center">çº¿ç¨‹ 2</td><td style="text-align:center">çº¿ç¨‹ 2</td></tr></tbody></table><p>å¼•ç”¨ Rob Pike çš„ä¸€æ®µæè¿°ï¼š</p><p>â€‹å¹¶å‘ï¼ˆconcurrentï¼‰æ˜¯åŒä¸€æ—¶é—´åº”å¯¹ï¼ˆdealing withï¼‰å¤šä»¶äº‹æƒ…çš„èƒ½åŠ› ã€‚</p><p>â€‹å¹¶è¡Œï¼ˆparallelï¼‰æ˜¯åŒä¸€æ—¶é—´åŠ¨æ‰‹åšï¼ˆdoingï¼‰å¤šä»¶äº‹æƒ…çš„èƒ½åŠ›ã€‚</p><h2 id="3-åº”ç”¨">3.åº”ç”¨</h2><span class='p green'>åº”ç”¨ä¹‹å¼‚æ­¥è°ƒç”¨</span> <blockquote><ul><li>éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯åŒæ­¥ã€‚</li><li>ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯å¼‚æ­¥ã€‚</li></ul></blockquote><p>1ï¼‰è®¾è®¡</p><p>å¤šçº¿ç¨‹å¯ä»¥è®©æ–¹æ³•æ‰§è¡Œå˜ä¸ºå¼‚æ­¥ï¼ˆå³ä¸è¦å¹²å·´å·´ç­‰ç€ï¼‰æ¯”å¦‚è¯´è¯»å–ç£ç›˜æ–‡ä»¶æ—¶ï¼Œå‡è®¾è¯»å–æ“ä½œèŠ±è´¹äº†5ç§’é’Ÿï¼Œå¦‚æœæ²¡æœ‰çº¿ç¨‹è°ƒåº¦æœºåˆ¶ï¼Œè¿™5ç§’cpuä»€ä¹ˆéƒ½åšä¸äº†ï¼Œå…¶ä»–ä»£ç éƒ½å¾—æš‚åœã€‚</p><p>ï¼ˆ2ï¼‰ç»“è®º</p><p>æ¯”å¦‚åœ¨é¡¹ç›®ä¸­ï¼Œè§†é¢‘æ–‡ä»¶éœ€è¦è½¬æ¢æ ¼å¼ç­‰æ“ä½œæ¯”è¾ƒè´¹æ—¶æ—¶ï¼Œè¿™æ—¶å¼€ä¸€ä¸ªæ–°çº¿ç¨‹å¤„ç†è§†é¢‘è½¬æ¢ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚<br>tomcatçš„å¼‚æ­¥servletä¹Ÿæ˜¯ç±»ä¼¼ç›®çš„ï¼Œè®©ç”¨æˆ·çº¿ç¨‹å¤„ç†è€—æ—¶è¾ƒé•¿çš„æ“ä½œï¼Œé¿å…é˜»å¡tomcatçš„å·¥ä½œçº¿ç¨‹ã€‚<br>uiç¨‹åºä¸­ï¼Œå¼€çº¿ç¨‹è¿›è¡Œå…¶ä»–æ“ä½œï¼Œé¿å…é˜»å¡uiçº¿ç¨‹ã€‚</p><span class='p green'>åº”ç”¨ä¹‹æé«˜æ•ˆç‡</span> <p>å……åˆ†åˆ©ç”¨å¤šæ ¸cpuçš„ä¼˜åŠ¿ï¼Œæé«˜è¿è¡Œæ•ˆç‡ã€‚æƒ³è±¡ä¸‹é¢çš„åœºæ™¯ï¼Œæ‰§è¡Œ 3 ä¸ªè®¡ç®—ï¼Œæœ€åå°†è®¡ç®—ç»“æœæ±‡æ€»ã€‚</p><blockquote><p>è®¡ç®—1 èŠ±è´¹ 10 ms<br>è®¡ç®—2 èŠ±è´¹ 11 ms<br>è®¡ç®—3 èŠ±è´¹ 9 ms<br>æ±‡æ€»éœ€è¦ 1 ms</p></blockquote><p>å¦‚æœæ˜¯ä¸²è¡Œæ‰§è¡Œï¼Œé‚£ä¹ˆæ€»å…±èŠ±è´¹çš„æ—¶é—´æ˜¯<br>10+11+9+1=31ms</p><p>ä½†å¦‚æœæ˜¯å››æ ¸cpuï¼Œå„ä¸ªæ ¸å¿ƒåˆ†åˆ«ä½¿ç”¨çº¿ç¨‹1æ‰§è¡Œè®¡ç®—1ï¼Œçº¿ç¨‹2æ‰§è¡Œè®¡ç®—1ï¼Œçº¿ç¨‹3æ‰§è¡Œè®¡ç®—3ï¼Œé‚£ä¹ˆ3ä¸ªçº¿ç¨‹æ˜¯å¹¶è¡Œçš„å—ï¼ŒèŠ±è´¹æ—¶é—´åªå–å†³äºæœ€é•¿çš„é‚£ä¸ªçº¿ç¨‹è¿è¡Œçš„æ—¶é—´ï¼Œ11msæœ€ååŠ ä¸Šæ±‡æ€»æ—¶é—´æ€»å…±åªèŠ±è´¹ 12msã€‚</p><blockquote><p>æ³¨æ„</p><p>éœ€è¦åœ¨å¤šæ ¸cpuä¸­æ‰èƒ½æé«˜æ•ˆç‡ï¼Œå•æ ¸ä»ç„¶æ˜¯è½®æµæ‰§è¡Œ</p></blockquote><p>ç»“è®º</p><ol><li>å•æ ¸ cpu ä¸‹ï¼Œå¤šçº¿ç¨‹ä¸èƒ½å®é™…æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡ï¼Œåªæ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨ä¸åŒçš„ä»»åŠ¡ä¹‹é—´åˆ‡æ¢ï¼Œä¸åŒçº¿ç¨‹è½®æµä½¿ç”¨cpu ï¼Œä¸è‡³äºä¸€ä¸ªçº¿ç¨‹æ€»å ç”¨ cpuï¼Œåˆ«çš„çº¿ç¨‹æ²¡æ³•å¹²æ´»</li><li>å¤šæ ¸ cpu å¯ä»¥å¹¶è¡Œè·‘å¤šä¸ªçº¿ç¨‹ï¼Œä½†èƒ½å¦æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡è¿˜æ˜¯è¦åˆ†æƒ…å†µçš„æœ‰äº›ä»»åŠ¡ï¼Œç»è¿‡ç²¾å¿ƒè®¾è®¡ï¼Œå°†ä»»åŠ¡æ‹†åˆ†ï¼Œå¹¶è¡Œæ‰§è¡Œï¼Œå½“ç„¶å¯ä»¥æé«˜ç¨‹åºçš„è¿è¡Œæ•ˆç‡ã€‚ä½†ä¸æ˜¯æ‰€æœ‰è®¡ç®—ä»»åŠ¡éƒ½èƒ½æ‹†åˆ†ï¼ˆå‚è€ƒåæ–‡çš„ã€é˜¿å§†è¾¾å°”å®šå¾‹ã€‘ï¼‰ä¹Ÿä¸æ˜¯æ‰€æœ‰ä»»åŠ¡éƒ½éœ€è¦æ‹†åˆ†ï¼Œä»»åŠ¡çš„ç›®çš„å¦‚æœä¸åŒï¼Œè°ˆæ‹†åˆ†å’Œæ•ˆç‡æ²¡å•¥æ„ä¹‰</li><li>IO æ“ä½œä¸å ç”¨ cpuï¼Œåªæ˜¯æˆ‘ä»¬ä¸€èˆ¬æ‹·è´æ–‡ä»¶ä½¿ç”¨çš„æ˜¯ã€é˜»å¡ IOã€‘ï¼Œè¿™æ—¶ç›¸å½“äºçº¿ç¨‹è™½ç„¶ä¸ç”¨ cpuï¼Œä½†éœ€è¦ä¸€ç›´ç­‰å¾… IO ç»“æŸï¼Œæ²¡èƒ½å……åˆ†åˆ©ç”¨çº¿ç¨‹ã€‚æ‰€ä»¥æ‰æœ‰åé¢çš„ã€éé˜»å¡ IOã€‘å’Œã€å¼‚æ­¥ IOã€‘ä¼˜åŒ–</li></ol>]]></content>
    
    
    <summary type="html">è¿›ç¨‹ã€çº¿ç¨‹ã€å¹¶è¡Œå’Œå¹¶å‘ç›¸å…³æ¦‚å¿µ</summary>
    
    
    
    <category term="Java" scheme="https://luckylittleboy.gitee.io/categories/Java/"/>
    
    
    <category term="JUC" scheme="https://luckylittleboy.gitee.io/tags/JUC/"/>
    
  </entry>
  
  <entry>
    <title>å…³äºå­—ç¬¦ä¸²å­—é¢é‡è¿›å…¥åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± çš„æ—¶æœº</title>
    <link href="https://luckylittleboy.gitee.io/posts/f9285b5c.html"/>
    <id>https://luckylittleboy.gitee.io/posts/f9285b5c.html</id>
    <published>2023-03-10T10:19:03.000Z</published>
    <updated>2023-03-11T14:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1>Q1ï¼šä»€ä¹ˆæ˜¯å­—ç¬¦ä¸²å¸¸é‡æ± </h1><p><strong>å­—ç¬¦ä¸²å¸¸é‡æ± </strong>ï¼Œå³<code>String Constant Pool</code>ï¼Œåˆå«åš<code>String Pool</code>ï¼Œ<code>String Table</code>ã€‚é¡¾åæ€ä¹‰ï¼Œå³ç”¨äºå­˜æ”¾å­—ç¬¦ä¸²å¸¸é‡çš„è¿è¡Œæ—¶å†…å­˜ç»“æ„ï¼Œå…¶åº•å±‚å®ç°ä¸ºä¸€ç§<code>Hashtable</code>ã€‚å…¶ä¸­æ‰€æŒ‡çš„<strong>å­—ç¬¦ä¸²å¸¸é‡</strong>ï¼Œå¯ä»¥æ˜¯ç¼–è¯‘æœŸåœ¨æºç ä¸­æ˜¾å¼çš„<strong>å­—ç¬¦ä¸²å­—é¢é‡</strong>ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¹‹ååœ¨ç¨‹åºè¿è¡Œæ—¶åˆ›å»ºçš„å­—ç¬¦ä¸²Stringå¯¹è±¡ã€‚</p><p>åœ¨<strong>JDK1.6</strong>åŠä¹‹å‰ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åªä¼šå­˜æ”¾å…·ä½“çš„Stringå®ä¾‹ï¼Œåœ¨ä½¿ç”¨<code>String.intern</code>æ–¹æ³•æ—¶ï¼Œè‹¥å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æœ‰æ»¡è¶³<code>String.equals</code>æ–¹æ³•çš„Stringå¯¹è±¡ï¼Œåˆ™è¿”å›å…¶å¼•ç”¨ï¼›è‹¥å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ²¡æœ‰ç›¸åŒçš„Stringå¯¹è±¡ï¼Œåˆ™å½“å‰Stringå¯¹è±¡ä¸ºå †ä¸Šå¯¹è±¡ï¼Œæ•…åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åˆ›å»ºä¸€ä¸ªç›¸åŒçš„Stringå¯¹è±¡ï¼Œå¹¶è¿”å›å…¶å¼•ç”¨ã€‚</p><p>åœ¨<strong>JDK1.7</strong>åŠä¹‹åï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ä¸ä»…å¯ä»¥å­˜æ”¾Stringå®ä¾‹ï¼ŒåŒæ—¶è¿˜èƒ½å­˜æ”¾æŒ‡å‘Javaå †ä¸­æŸä¸ªStringå®ä¾‹çš„å¼•ç”¨ã€‚åœ¨ä½¿ç”¨<code>String.intern</code>æ–¹æ³•æ—¶ï¼Œè‹¥å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æœ‰æ»¡è¶³<code>String.equals</code>æ–¹æ³•çš„Stringå¯¹è±¡ï¼Œåˆ™è¿”å›å…¶å¼•ç”¨ï¼Œè¿™ä¸€ç‚¹å’ŒJDK1.6ç›¸åŒï¼›è‹¥å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ²¡æœ‰ç›¸åŒçš„Stringå¯¹è±¡ï¼Œåˆ™å½“å‰Stringå¯¹è±¡ä¸ºå †ä¸Šå¯¹è±¡ï¼Œæ•…åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å­˜æ”¾ä¸€ä¸ªæŒ‡å‘å †ä¸Šæ­¤Stringå¯¹è±¡çš„å¼•ç”¨ï¼Œå¹¶è¿”å›æ­¤å¼•ç”¨ã€‚</p><p>å‚è€ƒèµ„æ–™</p><ul><li><a href="https://stackoverflow.com/questions/16783971/string-constant-pool-vs-string-pool">stackoverflow: String Constant Pool vs String pool</a></li><li><a href="https://stackoverflow.com/questions/23252767/string-pool-vs-constant-pool">stackoverflow: String pool vs Constant pool</a></li><li><a href="https://tech.meituan.com/2014/03/06/in-depth-understanding-string-intern.html">ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ: æ·±å…¥è§£æString#intern</a></li><li>åœ¨IDK1.6ä¸­ï¼Œintern() æ–¹æ³•ä¼šæŠŠé¦–æ¬¡é‡åˆ°çš„å­—ç¬¦ä¸²å®ä¾‹å¤åˆ¶åˆ°æ°¸ä¹…ä»£ä¸­ï¼Œè¿”å›çš„ä¹Ÿæ˜¯æ°¸ä¹…ä»£ä¸­è¿™ä¸ªå­—ç¬¦ä¸²å®ä¾‹çš„å¼•ç”¨ã€‚è€ŒJDK1.7ä¸­ï¼ˆä»¥åŠéƒ¨åˆ†å…¶ä»–è™šæ‹Ÿæœºï¼Œä¾‹å¦‚ JRockitï¼‰çš„ intern() å®ç°ä¸ä¼šå†å¤åˆ¶å®ä¾‹ï¼Œåªæ˜¯åœ¨å¸¸é‡æ± ä¸­è®°å½•é¦–æ¬¡å‡ºç°çš„å®ä¾‹å¼•ç”¨ã€‚<br>â€”â€”ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºï¼ˆç¬¬2ç‰ˆï¼‰ã€‹2.4.3 æ–¹æ³•åŒºå’Œè¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º</li><li>JDK 7ï¼ˆä»¥åŠéƒ¨åˆ†å…¶ä»–è™šæ‹Ÿæœºï¼Œä¾‹å¦‚ JRockitï¼‰çš„ intern() æ–¹æ³•å®ç°å°±ä¸éœ€è¦å†æ‹·è´å­—ç¬¦ä¸²çš„å®ä¾‹åˆ°æ°¸ä¹…ä»£äº†ï¼Œæ—¢ç„¶å­—ç¬¦ä¸²å¸¸é‡æ± å·²ç»ç§»åˆ° Java å †ä¸­ï¼Œé‚£åªéœ€è¦åœ¨å¸¸é‡æ± é‡Œè®°å½•ä¸€ä¸‹é¦–æ¬¡å‡ºç°çš„å®ä¾‹å¼•ç”¨å³å¯ã€‚<br>â€”â€”ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºï¼ˆç¬¬3ç‰ˆï¼‰ã€‹2.4.3 æ–¹æ³•åŒºå’Œè¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º</li><li>åœ¨æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ï¼Œè­¬å¦‚å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆString Tableï¼‰é‡Œçš„å¼•ç”¨<br>â€”â€”ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºï¼ˆç¬¬3ç‰ˆï¼‰ã€‹3.2.2 å¯è¾¾æ€§åˆ†æ</li></ul><h1>Q2ï¼šå­—ç¬¦ä¸²å¸¸é‡æ± åœ¨JVMä¸­çš„åˆ†å¸ƒ</h1><p>åœ¨<strong>JDK1.6</strong>åŠä¹‹å‰ï¼Œå­—ç¬¦ä¸²å¸¸é‡å’Œå…¶ä»–çš„åŸºæœ¬ç±»å‹çš„å¸¸é‡ä¸€æ ·ï¼Œå­˜æ”¾åœ¨ <strong>è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRun-Time Constant Poolï¼‰</strong> ä¸­ï¼Œå³åœ¨<strong>æ–¹æ³•åŒº</strong>ï¼ˆHotSpotä¸­ä¸º<strong>æ°¸ä¹…ä»£PermGen</strong>ï¼‰ä¸­ã€‚</p><p>åœ¨<strong>JDK1.7</strong>åŠä¹‹åï¼Œå­—ç¬¦ä¸²å¸¸é‡çš„å­˜æ”¾ä½ç½®å·²ç»ä»è¿è¡Œæ—¶å¸¸é‡æ± ä¸­åˆ†ç¦»åˆ°äº† <strong>Javaå †ï¼ˆHeapï¼‰</strong> ä¸­ï¼Œå½¢æˆäº†ç‹¬ç«‹çš„<strong>å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆString Poolï¼‰</strong>ï¼Œå…¶ä¸­ä¸€æ–¹é¢ä¹Ÿæ˜¯å› ä¸ºåœ¨æ°¸ä¹…ä»£ä¸­åˆ›å»ºStringå¯¹è±¡ï¼Œå®¹æ˜“è€—å°½æ°¸ä¹…ä»£å†…å­˜ç©ºé—´ã€‚</p><p>å‚è€ƒèµ„æ–™</p><ul><li><a href="https://tech.meituan.com/2014/03/06/in-depth-understanding-string-intern.html">ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ: æ·±å…¥è§£æString#intern</a></li><li>åœ¨IDK1.6ä¸­ï¼Œintern() æ–¹æ³•ä¼šæŠŠé¦–æ¬¡é‡åˆ°çš„å­—ç¬¦ä¸²å®ä¾‹å¤åˆ¶åˆ°æ°¸ä¹…ä»£ä¸­ï¼Œè¿”å›çš„ä¹Ÿæ˜¯æ°¸ä¹…ä»£ä¸­è¿™ä¸ªå­—ç¬¦ä¸²å®ä¾‹çš„å¼•ç”¨ã€‚è€ŒJDK1.7ä¸­ï¼ˆä»¥åŠéƒ¨åˆ†å…¶ä»–è™šæ‹Ÿæœºï¼Œä¾‹å¦‚ JRockitï¼‰çš„ intern() å®ç°ä¸ä¼šå†å¤åˆ¶å®ä¾‹ï¼Œåªæ˜¯åœ¨å¸¸é‡æ± ä¸­è®°å½•é¦–æ¬¡å‡ºç°çš„å®ä¾‹å¼•ç”¨ã€‚<br>â€”â€”ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºï¼ˆç¬¬2ç‰ˆï¼‰ã€‹2.4.3 æ–¹æ³•åŒºå’Œè¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º</li><li>JDK 7ï¼ˆä»¥åŠéƒ¨åˆ†å…¶ä»–è™šæ‹Ÿæœºï¼Œä¾‹å¦‚ JRockitï¼‰çš„ intern() æ–¹æ³•å®ç°å°±ä¸éœ€è¦å†æ‹·è´å­—ç¬¦ä¸²çš„å®ä¾‹åˆ°æ°¸ä¹…ä»£äº†ï¼Œæ—¢ç„¶å­—ç¬¦ä¸²å¸¸é‡æ± å·²ç»ç§»åˆ° Java å †ä¸­ï¼Œé‚£åªéœ€è¦åœ¨å¸¸é‡æ± é‡Œè®°å½•ä¸€ä¸‹é¦–æ¬¡å‡ºç°çš„å®ä¾‹å¼•ç”¨å³å¯ã€‚<br>â€”â€”ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºï¼ˆç¬¬3ç‰ˆï¼‰ã€‹2.4.3 æ–¹æ³•åŒºå’Œè¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º</li></ul><h1>Q3ï¼šå­—ç¬¦ä¸²å­—é¢é‡åœ¨classæ–‡ä»¶ä¸­çš„ä½ç½®</h1><p>æºç ç»è¿‡Javaç¼–è¯‘å™¨ç¼–è¯‘åï¼Œå…¶ä¸­çš„å­—ç¬¦ä¸²å­—é¢é‡ä»¥<code>CONSTANT_String_info</code>çš„å½¢å¼å­˜æ”¾åœ¨classæ–‡ä»¶çš„<strong>å¸¸é‡æ± ï¼ˆConstant Poolï¼‰</strong> ä¸­ã€‚</p><p>classæ–‡ä»¶çš„å¸¸é‡æ± ï¼Œå¯ä»¥é€šè¿‡<code>javac -verbose</code>å‘½ä»¤æ˜¾å¼æŸ¥çœ‹ã€‚</p><p>ç¤ºä¾‹ä»£ç ï¼ˆJDK1.8ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.tomandersen.javastudy.LeetCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="string">&quot;He&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="string">&quot;llo&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>javac -verbose</code>ç¼–è¯‘ç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">Constant pool:</span><br><span class="line">   #<span class="number">1</span> = Methodref          #<span class="number">10.</span>#<span class="number">28</span>        <span class="comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   #<span class="number">2</span> = String             #<span class="number">29</span>            <span class="comment">// llo</span></span><br><span class="line">   #<span class="number">3</span> = Fieldref           #<span class="number">9.</span>#<span class="number">30</span>         <span class="comment">// cn/tomandersen/javastudy/LeetCode/Test.s2:Ljava/lang/String;</span></span><br><span class="line">   #<span class="number">4</span> = Fieldref           #<span class="number">31.</span>#<span class="number">32</span>        <span class="comment">// java/lang/System.out:Ljava/io/PrintStream;</span></span><br><span class="line">   #<span class="number">5</span> = String             #<span class="number">33</span>            <span class="comment">// Hello</span></span><br><span class="line">   #<span class="number">6</span> = Methodref          #<span class="number">34.</span>#<span class="number">35</span>        <span class="comment">// java/io/PrintStream.println:(Ljava/lang/String;)V</span></span><br><span class="line">   #<span class="number">7</span> = String             #<span class="number">36</span>            <span class="comment">// He</span></span><br><span class="line">   #<span class="number">8</span> = Fieldref           #<span class="number">9.</span>#<span class="number">37</span>         <span class="comment">// cn/tomandersen/javastudy/LeetCode/Test.s1:Ljava/lang/String;</span></span><br><span class="line">   #<span class="number">9</span> = Class              #<span class="number">38</span>            <span class="comment">// cn/tomandersen/javastudy/LeetCode/Test</span></span><br><span class="line">  #<span class="number">10</span> = Class              #<span class="number">39</span>            <span class="comment">// java/lang/Object</span></span><br><span class="line">  #<span class="number">11</span> = Utf8               s1</span><br><span class="line">  #<span class="number">12</span> = Utf8               Ljava/lang/String;</span><br><span class="line">  #<span class="number">13</span> = Utf8               s2</span><br><span class="line">  #<span class="number">14</span> = Utf8               &lt;init&gt;</span><br><span class="line">  #<span class="number">15</span> = Utf8               ()V</span><br><span class="line">  #<span class="number">16</span> = Utf8               Code</span><br><span class="line">  #<span class="number">17</span> = Utf8               LineNumberTable</span><br><span class="line">  #<span class="number">18</span> = Utf8               LocalVariableTable</span><br><span class="line">  #<span class="number">19</span> = Utf8               <span class="built_in">this</span></span><br><span class="line">  #<span class="number">20</span> = Utf8               Lcn/tomandersen/javastudy/LeetCode/Test;</span><br><span class="line">  #<span class="number">21</span> = Utf8               main</span><br><span class="line">  #<span class="number">22</span> = Utf8               ([Ljava/lang/String;)V</span><br><span class="line">  #<span class="number">23</span> = Utf8               args</span><br><span class="line">  #<span class="number">24</span> = Utf8               [Ljava/lang/String;</span><br><span class="line">  #<span class="number">25</span> = Utf8               &lt;clinit&gt;</span><br><span class="line">  #<span class="number">26</span> = Utf8               SourceFile</span><br><span class="line">  #<span class="number">27</span> = Utf8               Test.java</span><br><span class="line">  #<span class="number">28</span> = NameAndType        #<span class="number">14</span>:#<span class="number">15</span>        <span class="comment">// &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">  #<span class="number">29</span> = Utf8               llo</span><br><span class="line">  #<span class="number">30</span> = NameAndType        #<span class="number">13</span>:#<span class="number">12</span>        <span class="comment">// s2:Ljava/lang/String;</span></span><br><span class="line">  #<span class="number">31</span> = Class              #<span class="number">40</span>            <span class="comment">// java/lang/System</span></span><br><span class="line">  #<span class="number">32</span> = NameAndType        #<span class="number">41</span>:#<span class="number">42</span>        <span class="comment">// out:Ljava/io/PrintStream;</span></span><br><span class="line">  #<span class="number">33</span> = Utf8               Hello</span><br><span class="line">  #<span class="number">34</span> = Class              #<span class="number">43</span>            <span class="comment">// java/io/PrintStream</span></span><br><span class="line">  #<span class="number">35</span> = NameAndType        #<span class="number">44</span>:#<span class="number">45</span>        <span class="comment">// println:(Ljava/lang/String;)V</span></span><br><span class="line">  #<span class="number">36</span> = Utf8               He</span><br><span class="line">  #<span class="number">37</span> = NameAndType        #<span class="number">11</span>:#<span class="number">12</span>        <span class="comment">// s1:Ljava/lang/String;</span></span><br><span class="line">  #<span class="number">38</span> = Utf8               cn/tomandersen/javastudy/LeetCode/Test</span><br><span class="line">  #<span class="number">39</span> = Utf8               java/lang/Object</span><br><span class="line">  #<span class="number">40</span> = Utf8               java/lang/System</span><br><span class="line">  #<span class="number">41</span> = Utf8               out</span><br><span class="line">  #<span class="number">42</span> = Utf8               Ljava/io/PrintStream;</span><br><span class="line">  #<span class="number">43</span> = Utf8               java/io/PrintStream</span><br><span class="line">  #<span class="number">44</span> = Utf8               println</span><br><span class="line">  #<span class="number">45</span> = Utf8               (Ljava/lang/String;)V</span><br></pre></td></tr></table></figure><p><strong>ä»javacå·¥å…·çš„ç¼–è¯‘ç»“æœæ¥çœ‹ï¼Œå¯ä»¥å‘ç°classæ–‡ä»¶çš„å¸¸é‡æ± ï¼ˆConstant Poolï¼‰ä¸­ä¿å­˜æœ‰æºç ä¸­å‡ºç°çš„æ‰€æœ‰å­—ç¬¦ä¸²å­—é¢é‡ã€‚</strong></p><p>å‚è€ƒèµ„æ–™</p><ul><li>å¸¸é‡æ± ä¸­ä¸»è¦å­˜æ”¾ä¸¤å¤§ç±»å¸¸é‡ï¼šå­—é¢é‡ï¼ˆLiteralï¼‰å’Œç¬¦å·å¼•ç”¨ï¼ˆSymbolic Referencesï¼‰ã€‚å­—é¢é‡æ¯”è¾ƒæ¥è¿‘äºJavaè¯­è¨€å±‚é¢çš„å¸¸é‡æ¦‚å¿µï¼Œå¦‚æ–‡æœ¬å­—ç¬¦ä¸²ã€è¢«å£°æ˜ä¸ºfinalçš„å¸¸é‡å€¼ç­‰ã€‚<br>â€”â€”ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºï¼ˆç¬¬3ç‰ˆï¼‰ã€‹6.3.2 å¸¸é‡æ± </li></ul><h1>Q4ï¼šå­—ç¬¦ä¸²å­—é¢é‡ä½•æ—¶è¿›å…¥åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­</h1><p>å­—ç¬¦ä¸²å­—é¢é‡ï¼Œå’Œå…¶ä»–åŸºæœ¬ç±»å‹çš„å­—é¢é‡æˆ–å¸¸é‡ä¸åŒï¼Œå¹¶ä¸ä¼šåœ¨ç±»åŠ è½½ä¸­çš„<strong>è§£æï¼ˆresolveï¼‰</strong> é˜¶æ®µå¡«å……å¹¶é©»ç•™åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œè€Œæ˜¯ä»¥ç‰¹æ®Šçš„å½¢å¼å­˜å‚¨åœ¨ <strong>è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRun-Time Constant Poolï¼‰</strong> ä¸­ã€‚è€Œæ˜¯åªæœ‰å½“æ­¤å­—ç¬¦ä¸²å­—é¢é‡è¢«è°ƒç”¨æ—¶ï¼ˆå¦‚å¯¹å…¶æ‰§è¡Œ<code>ldc</code>å­—èŠ‚ç æŒ‡ä»¤ï¼Œå°†å…¶æ·»åŠ åˆ°æ ˆé¡¶ï¼‰ï¼ŒHotSpot VMæ‰ä¼šå¯¹å…¶è¿›è¡Œresolveï¼Œä¸ºå…¶åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åˆ›å»ºå¯¹åº”çš„Stringå®ä¾‹ã€‚</p><p>åœ¨<strong>JDK1.7</strong>çš„HotSpot VMä¸­ï¼Œè¿™ç§è¿˜æœªçœŸæ­£è§£æï¼ˆresolveï¼‰çš„Stringå­—é¢é‡ï¼Œä»¥<code>JVM_CONSTANT_UnresolvedString</code>çš„å½¢å¼å­˜æ”¾åœ¨è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ï¼Œæ­¤æ—¶å¹¶æœªä¸ºå…¶åˆ›å»ºStringå®ä¾‹ï¼›</p><p>åœ¨<strong>JDK1.8</strong>çš„HotSpot VMä¸­ï¼Œè¿™ç§æœªçœŸæ­£è§£æï¼ˆresolveï¼‰çš„Stringå­—é¢é‡ï¼Œè¢«ç§°ä¸º<code>pseudo-string</code>ï¼Œä»¥<code>JVM_CONSTANT_String</code>çš„å½¢å¼å­˜æ”¾åœ¨è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ï¼Œæ­¤æ—¶å¹¶æœªä¸ºå…¶åˆ›å»ºStringå®ä¾‹ã€‚</p><p>åœ¨<strong>ç¼–è¯‘æœŸ</strong>ï¼Œå­—ç¬¦ä¸²å­—é¢é‡ä»¥<code>&quot;CONSTANT_String_info&quot;</code>+<code>&quot;CONSTANT_Utf8_info&quot;</code>çš„å½¢å¼å­˜æ”¾åœ¨classæ–‡ä»¶çš„ <strong>å¸¸é‡æ± ï¼ˆConstant Poolï¼‰</strong> ä¸­ï¼›</p><p>åœ¨<strong>ç±»åŠ è½½ä¹‹å</strong>ï¼Œå­—ç¬¦ä¸²å­—é¢é‡ä»¥<code>&quot;JVM_CONSTANT_UnresolvedString(JDK1.7)&quot;</code>æˆ–è€…<code>&quot;JVM_CONSTANT_String(JDK1.8)&quot;</code>çš„å½¢å¼å­˜æ”¾åœ¨ <strong>è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRun-time Constant Poolï¼‰</strong> ä¸­ï¼›</p><p>åœ¨<strong>é¦–æ¬¡ä½¿ç”¨æŸä¸ªå­—ç¬¦ä¸²å­—é¢é‡æ—¶</strong>ï¼Œå­—ç¬¦ä¸²å­—é¢é‡ä»¥çœŸæ­£çš„Stringå¯¹è±¡çš„æ–¹å¼å­˜æ”¾åœ¨ <strong>å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆString Poolï¼‰</strong> ä¸­ã€‚</p><p>ç¤ºä¾‹ä»£ç ï¼ˆJDK1.8ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.tomandersen.javastudy.LeetCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;He&quot;</span>) + <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;llo&quot;</span>);<span class="comment">// å †ä¸Šåˆ›å»º&quot;Hello&quot;,&quot;He&quot;,&quot;llo&quot;å®ä¾‹,String Poolä¸­åˆ›å»º&quot;He&quot;å’Œ&quot;llo&quot;å®ä¾‹</span></span><br><span class="line">        s1.intern();<span class="comment">// å°†å †ä¸Š&quot;Hello&quot;çš„å¼•ç”¨å­˜å…¥String Pool</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="string">&quot;Hello&quot;</span>;<span class="comment">// è·å–String Poolä¸­çš„&quot;Hello&quot;çš„å¼•ç”¨</span></span><br><span class="line">        System.out.println(s1 == s2);<span class="comment">// true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚è€ƒèµ„æ–™</p><p><a href="https://www.zhihu.com/question/55994121/answer/147296098">çŸ¥ä¹: Java ä¸­new String(â€œå­—é¢é‡â€) ä¸­ â€œå­—é¢é‡â€ æ˜¯ä½•æ—¶è¿›å…¥å­—ç¬¦ä¸²å¸¸é‡æ± çš„?</a></p><p><a href="http://hg.openjdk.java.net/jdk7/jdk7/hotspot/file/9b0ca45cd756/src/share/vm/oops/constantPoolOop.cpp">OpenJDK1.7 HotSpot: src/share/vm/oops/constantPoolOop.cpp</a></p><p><a href="http://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/oops/constantPool.cpp">OpenJDK1.8 HotSpot: src/share/vm/oops/constantPool.cpp</a></p><h1>Q5ï¼šåˆ›å»ºäº†å‡ ä¸ªå¯¹è±¡</h1><p><code>new String(&quot;Hello&quot;)</code></p><p>åŸºäºå¯¹ä¹‹å‰é—®é¢˜çš„è§£ç­”ï¼Œè¿™ä¸ªé—®é¢˜å°±æ¯”è¾ƒå¥½è§£ç­”äº†ï¼š</p><ul><li>è‹¥æ­¤ä»£ç è¿è¡Œä¹‹å‰æ²¡æœ‰æ˜¾ç¤ºä½¿ç”¨è¿‡&quot;Hello&quot;å­—é¢é‡ï¼Œä¹Ÿæ²¡æœ‰è°ƒç”¨æŸä¸ªå€¼ä¸º&quot;Hello&quot;å­—ç¬¦ä¸²å¯¹è±¡çš„<code>intern</code>æ–¹æ³•ï¼Œé‚£ä¹ˆ<code>new String(&quot;Hello&quot;)</code>è¿è¡Œæ—¶ä¼šåˆ›å»ºä¸¤ä¸ªå¯¹è±¡ï¼Œä¸€ä¸ªåœ¨<strong>å †</strong>ä¸Šï¼Œä¸€ä¸ªåœ¨<strong>å­—ç¬¦ä¸²å¸¸é‡æ± </strong>ä¸­</li><li>è‹¥æ­¤ä»£ç è¿è¡Œä¹‹å‰å·²ç»ä½¿ç”¨è¿‡&quot;Hello&quot;å­—é¢é‡ï¼Œæˆ–è€…è°ƒç”¨äº†<code>intern</code>æ–¹æ³•ï¼Œåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åˆ›å»ºäº†ç›¸åŒçš„å®ä¾‹æˆ–è€…ä¿å­˜äº†å †ä¸Šç›¸åŒå¯¹è±¡çš„å¼•ç”¨ï¼Œé‚£ä¹ˆ<code>new String(&quot;Hello&quot;)</code>è¿è¡Œæ—¶åªä¼šåˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨<strong>å †</strong>ä¸Š</li></ul><p>æ³¨æ„</p><p>è‹¥åœ¨æŸä¸ªç±»çš„é™æ€å˜é‡ä¸­ä½¿ç”¨äº†æŸä¸ªå­—ç¬¦ä¸²å­—é¢é‡ï¼Œå¦‚&quot;Hello&quot;ï¼Œåˆ™åœ¨ç±»åŠ è½½çš„åˆå§‹åŒ–ï¼ˆinitializeï¼‰é˜¶æ®µï¼Œä¾¿ä¼šåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åˆ›å»ºå¯¹åº”çš„Stringå®ä¾‹ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™å¯¹åº”çš„é™æ€å˜é‡</p><p>ç¤ºä¾‹ä»£ç ï¼ˆJDK1.8ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.tomandersen.javastudy.LeetCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;He&quot;</span>) + <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;llo&quot;</span>);</span><br><span class="line">        <span class="comment">// å †ä¸Šåˆ›å»º&quot;Hello&quot;,&quot;He&quot;,&quot;llo&quot;å®ä¾‹,String Poolä¸­åˆ›å»º&quot;He&quot;å’Œ&quot;llo&quot;å®ä¾‹</span></span><br><span class="line">        s1.intern();</span><br><span class="line">        <span class="comment">// String Poolä¸­å·²æœ‰&quot;Hello&quot;,æ•…æ²¡æœ‰å°†s1çš„å¼•ç”¨æ·»åŠ åˆ°String Poolä¸­,è¿”å›çš„æ˜¯String Poolä¸­å·²æœ‰çš„&quot;Hello&quot;çš„å¼•ç”¨</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">        <span class="comment">// è·å–String Poolä¸­çš„&quot;Hello&quot;çš„å¼•ç”¨</span></span><br><span class="line">        System.out.println(s1 == s2);<span class="comment">// false</span></span><br><span class="line">        System.out.println(s == s2);<span class="comment">// true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">å­—ç¬¦ä¸²å¸¸é‡æ± çš„ä¸€äº›é—®é¢˜</summary>
    
    
    
    <category term="Java" scheme="https://luckylittleboy.gitee.io/categories/Java/"/>
    
    
    <category term="å¸¸é‡æ± " scheme="https://luckylittleboy.gitee.io/tags/%E5%B8%B8%E9%87%8F%E6%B1%A0/"/>
    
    <category term="JVM" scheme="https://luckylittleboy.gitee.io/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>Markdownè¯­æ³•ä¸å¤–æŒ‚æ ‡ç­¾å†™æ³•æ±‡æ€»</title>
    <link href="https://luckylittleboy.gitee.io/posts/2013454d.html"/>
    <id>https://luckylittleboy.gitee.io/posts/2013454d.html</id>
    <published>2022-08-09T10:19:03.000Z</published>
    <updated>2022-10-23T14:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-Markdownè¯­æ³•è‡ªå¸¦æ ¼å¼">1.Markdownè¯­æ³•è‡ªå¸¦æ ¼å¼</h2><div class="note info flat"><p>å‚è€ƒï¼š<a href="https://blog.csdn.net/u014061630/article/details/81359144">Markdownè¯­æ³•å›¾æ–‡å…¨é¢è¯¦è§£(10åˆ†é’Ÿå­¦ä¼š)</a></p></div><div class="note warning flat"><p>æ³¨æ„ï¼šæ­¤é¡µé¢å¶å°”ä¼šå­˜åœ¨CSSå†²çªé—®é¢˜!</p></div><h3 id="1-1-ä»£ç å—">1.1 ä»£ç å—</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">\```shell</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">VSCodeç»ˆç«¯</span></span><br><span class="line">hexo clean; hexo s</span><br><span class="line">hexo clean; hexo g; hexo d</span><br><span class="line">git add .; git commit -m &quot;npm publish&quot;; npm version patch; </span><br><span class="line">git push</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Cmderç»ˆç«¯</span></span><br><span class="line">hexo clean &amp;&amp; hexo s</span><br><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</span><br><span class="line">git add . &amp;&amp; git commit -m &quot;npm publish&quot; &amp;&amp; npm version patch</span><br><span class="line">git push</span><br><span class="line">\```</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">VSCodeç»ˆç«¯</span></span><br><span class="line">hexo clean; hexo s</span><br><span class="line">hexo clean; hexo g; hexo d</span><br><span class="line">git add .; git commit -m &quot;npm publish&quot;; npm version patch; </span><br><span class="line">git push</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Cmderç»ˆç«¯</span></span><br><span class="line">hexo clean &amp;&amp; hexo s</span><br><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</span><br><span class="line">git add . &amp;&amp; git commit -m &quot;npm publish&quot; &amp;&amp; npm version patch</span><br><span class="line">git push</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="1-2-å¤šçº§æ ‡é¢˜">1.2 å¤šçº§æ ‡é¢˜</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># H1</span></span><br><span class="line"><span class="section">## H2</span></span><br><span class="line"><span class="section">### H3</span></span><br><span class="line"><span class="section">#### H4</span></span><br><span class="line"><span class="section">##### H5</span></span><br><span class="line"><span class="section">###### H6</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><p>è§æœ¬æ–‡ç« æ ‡é¢˜!</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="1-3-æ–‡å­—æ ·å¼">1.3 æ–‡å­—æ ·å¼</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">u</span>&gt;</span></span>ä¸‹åˆ’çº¿æ¼”ç¤º<span class="language-xml"><span class="tag">&lt;/<span class="name">u</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">æ–‡å­—<span class="strong">**åŠ ç²—**</span>æ¼”ç¤º</span><br><span class="line"></span><br><span class="line">æ–‡å­—<span class="emphasis">*æ–œä½“*</span>æ¼”ç¤º</span><br><span class="line"></span><br><span class="line">æ–‡æœ¬<span class="code">`é«˜äº®`</span>æ¼”ç¤º</span><br><span class="line"></span><br><span class="line">æ–‡æœ¬~~åˆ é™¤~~çº¿æ¼”ç¤º</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">font</span> <span class="attr">size</span> = <span class="string">5</span>&gt;</span></span>5å·å­—<span class="language-xml"><span class="tag">&lt;/<span class="name">font</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">font</span> <span class="attr">face</span>=<span class="string">&quot;é»‘ä½“&quot;</span>&gt;</span></span>é»‘ä½“<span class="language-xml"><span class="tag">&lt;/<span class="name">font</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">blue</span>&gt;</span></span>è“è‰²<span class="language-xml"><span class="tag">&lt;/<span class="name">font</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;<span class="name">td</span> <span class="attr">bgcolor</span>=<span class="string">MistyRose</span>&gt;</span></span>è¿™é‡Œçš„èƒŒæ™¯è‰²æ˜¯ï¼šMistyRosenï¼Œæ­¤å¤„è¾“å…¥ä»»æ„æƒ³è¾“å…¥çš„å†…å®¹<span class="language-xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><p><u>ä¸‹åˆ’çº¿æ¼”ç¤º</u></p><p>æ–‡å­—<strong>åŠ ç²—</strong>æ¼”ç¤º</p><p>æ–‡å­—<em>æ–œä½“</em>æ¼”ç¤º</p><p>æ–‡æœ¬<code>é«˜äº®</code>æ¼”ç¤º</p><p>æ–‡æœ¬<s>åˆ é™¤</s>çº¿æ¼”ç¤º</p><p><font size = 5>5å·å­—</font><br><font face="é»‘ä½“">é»‘ä½“</font><br><font color=blue>è“è‰²</font></p><table><tr><td bgcolor=MistyRose>è¿™é‡Œçš„èƒŒæ™¯è‰²æ˜¯ï¼šMistyRosenï¼Œæ­¤å¤„è¾“å…¥ä»»æ„æƒ³è¾“å…¥çš„å†…å®¹</td></tr></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><div class="note info flat"><p>ä¸Šè¿°è¦ç‚¹å¯å‚è€ƒ:<a href="https://blog.csdn.net/qq_43732429/article/details/108034518">ã€Markdownè¯­æ³•ã€‘å­—ä½“é¢œè‰²å¤§å°åŠæ–‡å­—åº•è‰²è®¾ç½®</a></p></div><h3 id="1-4-å¼•ç”¨">1.4 å¼•ç”¨</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="quote">&gt;  Java</span></span><br><span class="line"><span class="quote">&gt; äºŒçº§å¼•ç”¨æ¼”ç¤º</span></span><br><span class="line"><span class="quote">&gt; MySQL</span></span><br><span class="line"><span class="quote">&gt; &gt;å¤–é”®</span></span><br><span class="line"><span class="quote">&gt; &gt;</span></span><br><span class="line"><span class="quote">&gt; &gt;äº‹åŠ¡</span></span><br><span class="line"><span class="quote">&gt; &gt;</span></span><br><span class="line"><span class="quote">&gt; &gt;<span class="strong">**è¡Œçº§é”**</span>(å¼•ç”¨å†…éƒ¨ä¸€æ ·å¯ä»¥ç”¨æ ¼å¼)</span></span><br><span class="line"><span class="quote">&gt; </span></span><br><span class="line"><span class="quote">&gt; ....</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><blockquote><p>Java<br>äºŒçº§å¼•ç”¨æ¼”ç¤º<br>MySQL</p><blockquote><p>å¤–é”®</p><p>äº‹åŠ¡</p><p><strong>è¡Œçº§é”</strong>(å¼•ç”¨å†…éƒ¨ä¸€æ ·å¯ä»¥ç”¨æ ¼å¼)</p></blockquote><p>â€¦</p></blockquote><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="1-5-åˆ†å‰²çº¿">1.5 åˆ†å‰²çº¿</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"><span class="strong">**<span class="emphasis">*</span></span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><hr><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="1-6-åˆ—è¡¨-è·Ÿç©ºæ ¼éƒ½å¯ä»¥">1.6 åˆ—è¡¨(*,+,-è·Ÿç©ºæ ¼éƒ½å¯ä»¥)</h3><h4 id="1-6-1-æ— åºåˆ—è¡¨">1.6.1 æ— åºåˆ—è¡¨</h4><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">*</span> Java</span><br><span class="line"><span class="bullet">*</span> Python</span><br><span class="line"><span class="bullet">*</span> ...</span><br><span class="line"></span><br><span class="line"><span class="bullet">+</span> Java</span><br><span class="line"><span class="bullet">+</span> Python</span><br><span class="line"><span class="bullet">+</span> ...</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> Java</span><br><span class="line"><span class="bullet">-</span> Python</span><br><span class="line"><span class="bullet">-</span> ...</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ul><li>Java</li><li>Python</li><li>â€¦</li></ul><ul><li>Java</li><li>Python</li><li>â€¦</li></ul><ul><li>Java</li><li>Python</li><li>â€¦</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="1-6-2-æœ‰åºåˆ—è¡¨">1.6.2 æœ‰åºåˆ—è¡¨</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># æ³¨æ„åé¢æœ‰ç©ºæ ¼</span></span><br><span class="line"><span class="bullet">1.</span> </span><br><span class="line"><span class="bullet">2.</span> </span><br><span class="line"><span class="bullet">3.</span> </span><br><span class="line"><span class="bullet">4.</span> </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li></li><li></li><li></li><li></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="1-7-å›¾ç‰‡">1.7 å›¾ç‰‡</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># æœ¬åœ°å›¾ç‰‡</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/assets/pusheencode.webp&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;ç¤ºä¾‹å›¾ç‰‡&quot;</span> <span class="attr">style</span>=<span class="string">&quot;zoom:50%;&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="section"># åœ¨çº¿å›¾ç‰‡</span></span><br><span class="line">![<span class="string">code</span>](<span class="link">https://cdn.jsdelivr.net/gh/fomalhaut1998/markdown_pic/img/code.png</span>)</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><p>æœ¬åœ°å›¾ç‰‡:<br><img src="/assets/pusheencode.webp" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /><br>åœ¨çº¿å›¾ç‰‡:<br><img src="https://cdn.jsdelivr.net/gh/fomalhaut1998/markdown_pic/img/code.png" alt="code"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="1-8-è¡¨æ ¼">1.8 è¡¨æ ¼</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">| é¡¹ç›®æ ‡å· | èµ„é‡‘     | å¤‡æ³¨ |</span><br><span class="line">| -------- | -------- | ---- |</span><br><span class="line">| 1        | 100ï¼Œ000 | æ—    |</span><br><span class="line">| 2        | 200ï¼Œ000 | æ—    |</span><br><span class="line">| 3        | 300,600  | é‡è¦ |</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><table><thead><tr><th>é¡¹ç›®æ ‡å·</th><th>èµ„é‡‘</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>1</td><td>100ï¼Œ000</td><td>æ— </td></tr><tr><td>2</td><td>200ï¼Œ000</td><td>æ— </td></tr><tr><td>3</td><td>300,600</td><td>é‡è¦</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h4 id="1-9-å…¬å¼">1.9 å…¬å¼</h4><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$$</span><br><span class="line">\Gamma(z)=\int<span class="emphasis">_0^\infty t^&#123;z-1&#125;e^&#123;-t&#125;dt.</span></span><br><span class="line"><span class="emphasis">$$</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><p>$$<br>\Gamma(z)=\int_0^\infty t^{z-1}e^{-t}dt.<br>$$</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-Butterflyå¤–æŒ‚æ ‡ç­¾">2.Butterflyå¤–æŒ‚æ ‡ç­¾</h2><div class="note info flat"><p>è¿™éƒ¨åˆ†å‚è€ƒå®‰çŸ¥é±¼:<a href="https://anzhiy.cn/posts/7d58.html">åŸºäºButterflyçš„å¤–æŒ‚æ ‡ç­¾å¼•å…¥</a></p></div><h3 id="2-1-è¡Œå†…æ–‡æœ¬æ ·å¼-text">2.1 è¡Œå†…æ–‡æœ¬æ ·å¼ text</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% u æ–‡æœ¬å†…å®¹ %&#125;</span><br><span class="line">&#123;% emp æ–‡æœ¬å†…å®¹ %&#125;</span><br><span class="line">&#123;% wavy æ–‡æœ¬å†…å®¹ %&#125;</span><br><span class="line">&#123;% del æ–‡æœ¬å†…å®¹ %&#125;</span><br><span class="line">&#123;% kbd æ–‡æœ¬å†…å®¹ %&#125;</span><br><span class="line">&#123;% psw æ–‡æœ¬å†…å®¹ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> å¸¦ &#123;% u ä¸‹åˆ’çº¿ %&#125; çš„æ–‡æœ¬</span><br><span class="line"><span class="bullet">2.</span> å¸¦ &#123;% emp ç€é‡å· %&#125; çš„æ–‡æœ¬</span><br><span class="line"><span class="bullet">3.</span> å¸¦ &#123;% wavy æ³¢æµªçº¿ %&#125; çš„æ–‡æœ¬</span><br><span class="line"><span class="bullet">4.</span> å¸¦ &#123;% del åˆ é™¤çº¿ %&#125; çš„æ–‡æœ¬</span><br><span class="line"><span class="bullet">5.</span> é”®ç›˜æ ·å¼çš„æ–‡æœ¬ &#123;% kbd command %&#125; + &#123;% kbd D %&#125;</span><br><span class="line"><span class="bullet">6.</span> å¯†ç æ ·å¼çš„æ–‡æœ¬ï¼š&#123;% psw è¿™é‡Œæ²¡æœ‰éªŒè¯ç  %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><ol><li>å¸¦ <u>ä¸‹åˆ’çº¿</u> çš„æ–‡æœ¬</li><li>å¸¦ <emp>ç€é‡å·</emp> çš„æ–‡æœ¬</li><li>å¸¦ <wavy>æ³¢æµªçº¿</wavy> çš„æ–‡æœ¬</li><li>å¸¦ <del>åˆ é™¤çº¿</del> çš„æ–‡æœ¬</li><li>é”®ç›˜æ ·å¼çš„æ–‡æœ¬ <kbd>command</kbd> + <kbd>D</kbd></li><li>å¯†ç æ ·å¼çš„æ–‡æœ¬ï¼š<psw>è¿™é‡Œæ²¡æœ‰éªŒè¯ç </psw></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-2-è¡Œå†…æ–‡æœ¬-span">2.2 è¡Œå†…æ–‡æœ¬ span</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">é…ç½®å‚æ•°</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% span æ ·å¼å‚æ•°(å‚æ•°ä»¥ç©ºæ ¼åˆ’åˆ†), æ–‡æœ¬å†…å®¹ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>å­—ä½“</code>: logo, code</li><li><code>é¢œè‰²</code>: red,yellow,green,cyan,blue,gray</li><li><code>å¤§å°</code>: small, h4, h3, h2, h1, large, huge, ultra</li><li><code>å¯¹é½æ–¹å‘</code>: left, center, right</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> å½©è‰²æ–‡å­—</span><br><span class="line">åœ¨ä¸€æ®µè¯ä¸­æ–¹ä¾¿æ’å…¥å„ç§é¢œè‰²çš„æ ‡ç­¾ï¼ŒåŒ…æ‹¬ï¼š&#123;% span red, çº¢è‰² %&#125;ã€&#123;% span yellow, é»„è‰² %&#125;ã€&#123;% span green, ç»¿è‰² %&#125;ã€&#123;% span cyan, é’è‰² %&#125;ã€&#123;% span blue, è“è‰² %&#125;ã€&#123;% span gray, ç°è‰² %&#125;ã€‚</span><br><span class="line"><span class="bullet">-</span> è¶…å¤§å·æ–‡å­—</span><br><span class="line">æ–‡æ¡£ã€Œå¼€å§‹ã€é¡µé¢ä¸­çš„æ ‡é¢˜éƒ¨åˆ†å°±æ˜¯è¶…å¤§å·æ–‡å­—ã€‚</span><br><span class="line">&#123;% span center logo large, Volantis %&#125;</span><br><span class="line">&#123;% span center small, A Wonderful Theme for Hexo %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><ul><li>å½©è‰²æ–‡å­—<br>åœ¨ä¸€æ®µè¯ä¸­æ–¹ä¾¿æ’å…¥å„ç§é¢œè‰²çš„æ ‡ç­¾ï¼ŒåŒ…æ‹¬ï¼š<span class='p red'>çº¢è‰²</span>ã€<span class='p yellow'>é»„è‰²</span>ã€<span class='p green'>ç»¿è‰²</span>ã€<span class='p cyan'>é’è‰²</span>ã€<span class='p blue'>è“è‰²</span>ã€<span class='p gray'>ç°è‰²</span>ã€‚</li><li>è¶…å¤§å·æ–‡å­—<br>æ–‡æ¡£ã€Œå¼€å§‹ã€é¡µé¢ä¸­çš„æ ‡é¢˜éƒ¨åˆ†å°±æ˜¯è¶…å¤§å·æ–‡å­—ã€‚<br><span class='p center logo large'>Volantis</span><br><span class='p center small'>A Wonderful Theme for Hexo</span></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-3-æ®µè½æ–‡æœ¬-p">2.3 æ®µè½æ–‡æœ¬ p</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">é…ç½®å‚æ•°</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% p æ ·å¼å‚æ•°(å‚æ•°ä»¥ç©ºæ ¼åˆ’åˆ†), æ–‡æœ¬å†…å®¹ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>å­—ä½“</code>: logo, code</li><li><code>é¢œè‰²</code>: red,yellow,green,cyan,blue,gray</li><li><code>å¤§å°</code>: small, h4, h3, h2, h1, large, huge, ultra</li><li><code>å¯¹é½æ–¹å‘</code>: left, center, right</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> å½©è‰²æ–‡å­—</span><br><span class="line">åœ¨ä¸€æ®µè¯ä¸­æ–¹ä¾¿æ’å…¥å„ç§é¢œè‰²çš„æ ‡ç­¾ï¼ŒåŒ…æ‹¬ï¼š&#123;% p red, çº¢è‰² %&#125;ã€&#123;% p yellow, é»„è‰² %&#125;ã€&#123;% p green, ç»¿è‰² %&#125;ã€&#123;% p cyan, é’è‰² %&#125;ã€&#123;% p blue, è“è‰² %&#125;ã€&#123;% p gray, ç°è‰² %&#125;ã€‚</span><br><span class="line"><span class="bullet">-</span> è¶…å¤§å·æ–‡å­—</span><br><span class="line">æ–‡æ¡£ã€Œå¼€å§‹ã€é¡µé¢ä¸­çš„æ ‡é¢˜éƒ¨åˆ†å°±æ˜¯è¶…å¤§å·æ–‡å­—ã€‚</span><br><span class="line">&#123;% p center logo large, Volantis %&#125;</span><br><span class="line">&#123;% p center small, A Wonderful Theme for Hexo %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><ul><li>å½©è‰²æ–‡å­—<br>åœ¨ä¸€æ®µè¯ä¸­æ–¹ä¾¿æ’å…¥å„ç§é¢œè‰²çš„æ ‡ç­¾ï¼ŒåŒ…æ‹¬ï¼š<p class='p red'>çº¢è‰²</p>ã€<p class='p yellow'>é»„è‰²</p>ã€<p class='p green'>ç»¿è‰²</p>ã€<p class='p cyan'>é’è‰²</p>ã€<p class='p blue'>è“è‰²</p>ã€<p class='p gray'>ç°è‰²</p>ã€‚</li><li>è¶…å¤§å·æ–‡å­—<br>æ–‡æ¡£ã€Œå¼€å§‹ã€é¡µé¢ä¸­çš„æ ‡é¢˜éƒ¨åˆ†å°±æ˜¯è¶…å¤§å·æ–‡å­—ã€‚</li></ul><p class='p center logo large'>Volantis</p><p class='p center small'>A Wonderful Theme for Hexo</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-4-å¼•ç”¨note">2.4 å¼•ç”¨note</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">é€šç”¨é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">è¯­æ³•æ ¼å¼</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -5">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">note:</span><br><span class="line">  # Note tag style values:</span><br><span class="line">  #  - simple    bs-callout old alert style. Default.</span><br><span class="line">  #  - modern    bs-callout new (v2-v3) alert style.</span><br><span class="line">  #  - flat      flat callout style with background, like on Mozilla or StackOverflow.</span><br><span class="line">  #  - disabled  disable all CSS styles import of note tag.</span><br><span class="line">  style: simple</span><br><span class="line">  icons: false</span><br><span class="line">  border<span class="emphasis">_radius: 3</span></span><br><span class="line"><span class="emphasis">  # Offset lighter of background in % for modern and flat styles (modern: -12 | 12; flat: -18 | 6).</span></span><br><span class="line"><span class="emphasis">  # Offset also applied to label tag variables. This option can work with disabled note tag.</span></span><br><span class="line"><span class="emphasis">  light_</span>bg<span class="emphasis">_offset: 0</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># è‡ªå¸¦icon</span></span><br><span class="line">&#123;% note [class] [no-icon] [style] %&#125;</span><br><span class="line">Any content (support inline tags too.io).</span><br><span class="line">&#123;% endnote %&#125;</span><br><span class="line"><span class="section"># å¤–éƒ¨icon</span></span><br><span class="line">&#123;% note [color] [icon] [style] %&#125;</span><br><span class="line">Any content (support inline tags too.io).</span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.è‡ªå¸¦icon</p><table><thead><tr><th>å‚æ•°</th><th style="text-align:center">ç”¨æ³•</th></tr></thead><tbody><tr><td>class</td><td style="text-align:center">ã€å¯é€‰ã€‘æ ‡è¯†ï¼Œä¸åŒçš„æ ‡è¯†æœ‰ä¸åŒçš„é…è‰² ï¼ˆ default / primary / success / info / warning / danger ï¼‰</td></tr><tr><td>no-icon</td><td style="text-align:center">ã€å¯é€‰ã€‘ä¸æ˜¾ç¤º icon</td></tr><tr><td>style</td><td style="text-align:center">ã€å¯é€‰ã€‘å¯ä»¥è¦†ç›–é…ç½®ä¸­çš„ style ï¼ˆsimple/modern/flat/disabledï¼‰</td></tr></tbody></table><p>2.å¤–éƒ¨icon</p><table><thead><tr><th>å‚æ•°</th><th style="text-align:center">ç”¨æ³•</th></tr></thead><tbody><tr><td>class</td><td style="text-align:center">ã€å¯é€‰ã€‘æ ‡è¯†ï¼Œä¸åŒçš„æ ‡è¯†æœ‰ä¸åŒçš„é…è‰² ï¼ˆ default / blue / pink / red / purple / orange / green ï¼‰</td></tr><tr><td>no-icon</td><td style="text-align:center">ã€å¯é€‰ã€‘å¯é…ç½®è‡ªå®šä¹‰ icon (åªæ”¯æŒ fontawesome å›¾æ ‡, ä¹Ÿå¯ä»¥é…ç½® no-icon )</td></tr><tr><td>style</td><td style="text-align:center">ã€å¯é€‰ã€‘å¯ä»¥è¦†ç›–é…ç½®ä¸­çš„ style ï¼ˆsimple/modern/flat/disabledï¼‰</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><details class="folding-tag" blue><summary> 1.è‡ªå¸¦icon </summary>              <div class='content'>              <p>1.<code>simple</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note simple %&#125;é»˜è®¤ æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note default simple %&#125;default æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note primary simple %&#125;primary æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note success simple %&#125;success æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note info simple %&#125;info æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note warning simple %&#125;warning æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note danger simple %&#125;danger æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>2.<code>modern</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note modern %&#125;é»˜è®¤ æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note default modern %&#125;default æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note primary modern %&#125;primary æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note success modern %&#125;success æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note info modern %&#125;info æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note warning modern %&#125;warning æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note danger modern %&#125;danger æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>3.<code>flat</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note flat %&#125;é»˜è®¤ æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note default flat %&#125;default æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note primary flat %&#125;primary æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note success flat %&#125;success æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note info flat %&#125;info æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note warning flat %&#125;warning æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note danger flat %&#125;danger æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>4.<code>disabled</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note disabled %&#125;é»˜è®¤ æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note default disabled %&#125;default æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note primary disabled %&#125;primary æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note success disabled %&#125;success æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note info disabled %&#125;info æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note warning disabled %&#125;warning æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note danger disabled %&#125;danger æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>5.<code>no-icon</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note no-icon %&#125;é»˜è®¤ æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note default no-icon %&#125;default æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note primary no-icon %&#125;primary æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note success no-icon %&#125;success æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note info no-icon %&#125;info æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note warning no-icon %&#125;warning æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note danger no-icon %&#125;danger æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>              </div>            </details><details class="folding-tag" blue><summary> 2.å¤–éƒ¨icon </summary>              <div class='content'>              <p>1.<code>simple</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note &#x27;fab fa-cc-visa&#x27; simple %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note blue &#x27;fas fa-bullhorn&#x27; simple %&#125;2021å¹´å¿«åˆ°äº†....&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note pink &#x27;fas fa-car-crash&#x27; simple %&#125;å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note red &#x27;fas fa-fan&#x27; simple%&#125;è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note orange &#x27;fas fa-battery-half&#x27; simple %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note purple &#x27;far fa-hand-scissors&#x27; simple %&#125;å‰ªåˆ€çŸ³å¤´å¸ƒ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note green &#x27;fab fa-internet-explorer&#x27; simple %&#125;å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>2.<code>modern</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note &#x27;fab fa-cc-visa&#x27; modern %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note blue &#x27;fas fa-bullhorn&#x27; modern %&#125;2021å¹´å¿«åˆ°äº†....&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note pink &#x27;fas fa-car-crash&#x27; modern %&#125;å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note red &#x27;fas fa-fan&#x27; modern%&#125;è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note orange &#x27;fas fa-battery-half&#x27; modern %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note purple &#x27;far fa-hand-scissors&#x27; modern %&#125;å‰ªåˆ€çŸ³å¤´å¸ƒ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note green &#x27;fab fa-internet-explorer&#x27; modern %&#125;å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>3.<code>flat</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note &#x27;fab fa-cc-visa&#x27; flat %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note blue &#x27;fas fa-bullhorn&#x27; flat %&#125;2021å¹´å¿«åˆ°äº†....&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note pink &#x27;fas fa-car-crash&#x27; flat %&#125;å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note red &#x27;fas fa-fan&#x27; flat%&#125;è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note orange &#x27;fas fa-battery-half&#x27; flat %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note purple &#x27;far fa-hand-scissors&#x27; flat %&#125;å‰ªåˆ€çŸ³å¤´å¸ƒ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note green &#x27;fab fa-internet-explorer&#x27; flat %&#125;å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>4.<code>disabled</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note &#x27;fab fa-cc-visa&#x27; disabled %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note blue &#x27;fas fa-bullhorn&#x27; disabled %&#125;2021å¹´å¿«åˆ°äº†....&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note pink &#x27;fas fa-car-crash&#x27; disabled %&#125;å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note red &#x27;fas fa-fan&#x27; disabled %&#125;è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note orange &#x27;fas fa-battery-half&#x27; disabled %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note purple &#x27;far fa-hand-scissors&#x27; disabled %&#125;å‰ªåˆ€çŸ³å¤´å¸ƒ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note green &#x27;fab fa-internet-explorer&#x27; disabled %&#125;å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>5.<code>no-icon</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note no-icon %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note blue no-icon %&#125;2021å¹´å¿«åˆ°äº†....&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note pink no-icon %&#125;å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note red no-icon %&#125;è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note orange no-icon %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note purple no-icon %&#125;å‰ªåˆ€çŸ³å¤´å¸ƒ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note green no-icon %&#125;å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>              </div>            </details><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -5"><details class="folding-tag" blue><summary> 1.è‡ªå¸¦icon </summary>              <div class='content'>              <p>1.<code>simple</code>æ ·å¼</p><div class="note simple"><p>é»˜è®¤ æç¤ºå—æ ‡ç­¾</p></div><div class="note default simple"><p>default æç¤ºå—æ ‡ç­¾</p></div><div class="note primary simple"><p>primary æç¤ºå—æ ‡ç­¾</p></div><div class="note success simple"><p>success æç¤ºå—æ ‡ç­¾</p></div><div class="note info simple"><p>info æç¤ºå—æ ‡ç­¾</p></div><div class="note warning simple"><p>warning æç¤ºå—æ ‡ç­¾</p></div><div class="note danger simple"><p>danger æç¤ºå—æ ‡ç­¾</p></div>2.`modern`æ ·å¼<div class="note modern"><p>é»˜è®¤ æç¤ºå—æ ‡ç­¾</p></div><div class="note default modern"><p>default æç¤ºå—æ ‡ç­¾</p></div><div class="note primary modern"><p>primary æç¤ºå—æ ‡ç­¾</p></div><div class="note success modern"><p>success æç¤ºå—æ ‡ç­¾</p></div><div class="note info modern"><p>info æç¤ºå—æ ‡ç­¾</p></div><div class="note warning modern"><p>warning æç¤ºå—æ ‡ç­¾</p></div><div class="note danger modern"><p>danger æç¤ºå—æ ‡ç­¾</p></div><p>3.<code>flat</code>æ ·å¼</p><div class="note flat"><p>é»˜è®¤ æç¤ºå—æ ‡ç­¾</p></div><div class="note default flat"><p>default æç¤ºå—æ ‡ç­¾</p></div><div class="note primary flat"><p>primary æç¤ºå—æ ‡ç­¾</p></div><div class="note success flat"><p>success æç¤ºå—æ ‡ç­¾</p></div><div class="note info flat"><p>info æç¤ºå—æ ‡ç­¾</p></div><div class="note warning flat"><p>warning æç¤ºå—æ ‡ç­¾</p></div><div class="note danger flat"><p>danger æç¤ºå—æ ‡ç­¾</p></div><p>4.<code>disabled</code>æ ·å¼</p><div class="note disabled"><p>é»˜è®¤ æç¤ºå—æ ‡ç­¾</p></div><div class="note default disabled"><p>default æç¤ºå—æ ‡ç­¾</p></div><div class="note primary disabled"><p>primary æç¤ºå—æ ‡ç­¾</p></div><div class="note success disabled"><p>success æç¤ºå—æ ‡ç­¾</p></div><div class="note info disabled"><p>info æç¤ºå—æ ‡ç­¾</p></div><div class="note warning disabled"><p>warning æç¤ºå—æ ‡ç­¾</p></div><div class="note danger disabled"><p>danger æç¤ºå—æ ‡ç­¾</p></div><p>5.<code>no-icon</code>æ ·å¼</p><div class="note no-icon flat"><p>é»˜è®¤ æç¤ºå—æ ‡ç­¾</p></div><div class="note default no-icon flat"><p>default æç¤ºå—æ ‡ç­¾</p></div><div class="note primary no-icon flat"><p>primary æç¤ºå—æ ‡ç­¾</p></div><div class="note success no-icon flat"><p>success æç¤ºå—æ ‡ç­¾</p></div><div class="note info no-icon flat"><p>info æç¤ºå—æ ‡ç­¾</p></div><div class="note warning no-icon flat"><p>warning æç¤ºå—æ ‡ç­¾</p></div><div class="note danger no-icon flat"><p>danger æç¤ºå—æ ‡ç­¾</p></div>              </div>            </details><details class="folding-tag" blue><summary> 2.å¤–éƒ¨icon </summary>              <div class='content'>              <p>1.<code>simple</code>æ ·å¼</p><div class="note icon-padding simple"><i class="note-icon fab fa-cc-visa"></i><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note blue icon-padding simple"><i class="note-icon fas fa-bullhorn"></i><p>2021å¹´å¿«åˆ°äº†â€¦</p></div><div class="note pink icon-padding simple"><i class="note-icon fas fa-car-crash"></i><p>å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š</p></div><div class="note red icon-padding simple"><i class="note-icon fas fa-fan"></i><p>è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ</p></div><div class="note orange icon-padding simple"><i class="note-icon fas fa-battery-half"></i><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note purple icon-padding simple"><i class="note-icon far fa-hand-scissors"></i><p>å‰ªåˆ€çŸ³å¤´å¸ƒ</p></div><div class="note green icon-padding simple"><i class="note-icon fab fa-internet-explorer"></i><p>å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨</p></div><p>2.<code>modern</code>æ ·å¼</p><div class="note icon-padding modern"><i class="note-icon fab fa-cc-visa"></i><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note blue icon-padding modern"><i class="note-icon fas fa-bullhorn"></i><p>2021å¹´å¿«åˆ°äº†â€¦</p></div><div class="note pink icon-padding modern"><i class="note-icon fas fa-car-crash"></i><p>å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š</p></div><div class="note red icon-padding modern"><i class="note-icon fas fa-fan"></i><p>è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ</p></div><div class="note orange icon-padding modern"><i class="note-icon fas fa-battery-half"></i><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note purple icon-padding modern"><i class="note-icon far fa-hand-scissors"></i><p>å‰ªåˆ€çŸ³å¤´å¸ƒ</p></div><div class="note green icon-padding modern"><i class="note-icon fab fa-internet-explorer"></i><p>å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨</p></div><p>3.<code>flat</code>æ ·å¼</p><div class="note icon-padding flat"><i class="note-icon fab fa-cc-visa"></i><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note blue icon-padding flat"><i class="note-icon fas fa-bullhorn"></i><p>2021å¹´å¿«åˆ°äº†â€¦</p></div><div class="note pink icon-padding flat"><i class="note-icon fas fa-car-crash"></i><p>å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š</p></div><div class="note red icon-padding flat"><i class="note-icon fas fa-fan"></i><p>è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ</p></div><div class="note orange icon-padding flat"><i class="note-icon fas fa-battery-half"></i><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note purple icon-padding flat"><i class="note-icon far fa-hand-scissors"></i><p>å‰ªåˆ€çŸ³å¤´å¸ƒ</p></div><div class="note green icon-padding flat"><i class="note-icon fab fa-internet-explorer"></i><p>å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨</p></div><p>4.<code>disabled</code>æ ·å¼</p><div class="note icon-padding disabled"><i class="note-icon fab fa-cc-visa"></i><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note blue icon-padding disabled"><i class="note-icon fas fa-bullhorn"></i><p>2021å¹´å¿«åˆ°äº†â€¦</p></div><div class="note pink icon-padding disabled"><i class="note-icon fas fa-car-crash"></i><p>å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š</p></div><div class="note red icon-padding disabled"><i class="note-icon fas fa-fan"></i><p>è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ</p></div><div class="note orange icon-padding disabled"><i class="note-icon fas fa-battery-half"></i><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note purple icon-padding disabled"><i class="note-icon far fa-hand-scissors"></i><p>å‰ªåˆ€çŸ³å¤´å¸ƒ</p></div><div class="note green icon-padding disabled"><i class="note-icon fab fa-internet-explorer"></i><p>å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨</p></div><p>5.<code>no-icon</code>æ ·å¼</p><div class="note no-icon flat"><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note blue no-icon flat"><p>2021å¹´å¿«åˆ°äº†â€¦</p></div><div class="note pink no-icon flat"><p>å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š</p></div><div class="note red no-icon flat"><p>è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ</p></div><div class="note orange no-icon flat"><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note purple no-icon flat"><p>å‰ªåˆ€çŸ³å¤´å¸ƒ</p></div><div class="note green no-icon flat"><p>å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨</p></div>              </div>            </details><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-5-ä¸Šæ ‡æ ‡ç­¾-tip">2.5 ä¸Šæ ‡æ ‡ç­¾ tip</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">é…ç½®å‚æ•°</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip [å‚æ•°ï¼Œå¯é€‰] %&#125;æ–‡æœ¬å†…å®¹&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>æ ·å¼</code>: success,error,warning,bolt,ban,home,sync,cogs,key,bell</li><li><code>è‡ªå®šä¹‰å›¾æ ‡</code>: æ”¯æŒfontawesomeã€‚</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip %&#125;default&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip info %&#125;info&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip success %&#125;success&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip error %&#125;error&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip warning %&#125;warning&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip bolt %&#125;bolt&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip ban %&#125;ban&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip home %&#125;home&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip sync %&#125;sync&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip cogs %&#125;cogs&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip key %&#125;key&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip bell %&#125;bell&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip fa-atom %&#125;è‡ªå®šä¹‰font awesomeå›¾æ ‡&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><div class="tip "><p>default</p></div><div class="tip info"><p>info</p></div><div class="tip success"><p>success</p></div><div class="tip error"><p>error</p></div><div class="tip warning"><p>warning</p></div><div class="tip bolt"><p>bolt</p></div><div class="tip ban"><p>ban</p></div><div class="tip home"><p>home</p></div><div class="tip sync"><p>sync</p></div><div class="tip cogs"><p>cogs</p></div><div class="tip key"><p>key</p></div><div class="tip bell"><p>bell</p></div><div class="tip fa-atom"><p>è‡ªå®šä¹‰font awesomeå›¾æ ‡</p></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-6-åŠ¨æ€æ ‡ç­¾-anima">2.6 åŠ¨æ€æ ‡ç­¾ anima</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">é…ç½®å‚æ•°</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip [å‚æ•°ï¼Œå¯é€‰] %&#125;æ–‡æœ¬å†…å®¹&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><div class="note info flat"><ol><li>å°†æ‰€éœ€çš„CSSç±»æ·»åŠ åˆ°å›¾æ ‡ï¼ˆæˆ–DOMä¸­çš„ä»»ä½•å…ƒç´ ï¼‰ã€‚</li><li>å¯¹äºçˆ¶çº§æ‚¬åœæ ·å¼ï¼Œéœ€è¦ç»™ç›®æ ‡å…ƒç´ æ·»åŠ æŒ‡å®šCSSç±»ï¼ŒåŒæ—¶è¿˜è¦ç»™ç›®æ ‡å…ƒç´ çš„çˆ¶çº§å…ƒç´ æ·»åŠ CSSç±»<code>faa-parent animated-hover</code>ã€‚ï¼ˆè¯¦æƒ…è§ç¤ºä¾‹åŠç¤ºä¾‹æºç ï¼‰<br>You can regulate the speed of the animation by adding the CSS class or . faa-fastfaa-slow</li><li>å¯ä»¥é€šè¿‡ç»™ç›®æ ‡å…ƒç´ æ·»åŠ CSSç±»<code>faa-fast</code>æˆ–<code>faa-slow</code>æ¥æ§åˆ¶åŠ¨ç”»å¿«æ…¢ã€‚</li></ol></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.On DOM loadï¼ˆå½“é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºåŠ¨ç”»ï¼‰</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip warning faa-horizontal animated %&#125;warning&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip ban faa-flash animated %&#125;ban&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><p>2.è°ƒæ•´åŠ¨ç”»é€Ÿåº¦</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip warning faa-horizontal animated faa-fast %&#125;warning&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip ban faa-flash animated faa-slow %&#125;ban&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><p>3.On hoverï¼ˆå½“é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºåŠ¨ç”»ï¼‰</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip warning faa-horizontal animated-hover %&#125;warning&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip ban faa-flash animated-hover %&#125;ban&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><p>4.On parent hoverï¼ˆå½“é¼ æ ‡æ‚¬åœåœ¨çˆ¶çº§å…ƒç´ æ—¶æ˜¾ç¤ºåŠ¨ç”»ï¼‰</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip warning faa-parent animated-hover %&#125;<span class="language-xml"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;faa-horizontal&quot;</span>&gt;</span></span>warning<span class="language-xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip ban faa-parent animated-hover %&#125;<span class="language-xml"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;faa-flash&quot;</span>&gt;</span></span>ban<span class="language-xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>1.On DOM loadï¼ˆå½“é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºåŠ¨ç”»ï¼‰</p><div class="tip warning faa-horizontal animated"><p>warning</p></div><div class="tip ban faa-flash animated"><p>ban</p></div>2.è°ƒæ•´åŠ¨ç”»é€Ÿåº¦<div class="tip warning faa-horizontal animated faa-fast"><p>warning</p></div><div class="tip ban faa-flash animated faa-slow"><p>ban</p></div>3.On hoverï¼ˆå½“é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºåŠ¨ç”»ï¼‰<div class="tip warning faa-horizontal animated-hover"><p>warning</p></div><div class="tip ban faa-flash animated-hover"><p>ban</p></div>4.On parent hoverï¼ˆå½“é¼ æ ‡æ‚¬åœåœ¨çˆ¶çº§å…ƒç´ æ—¶æ˜¾ç¤ºåŠ¨ç”»ï¼‰<div class="tip warning faa-parent animated-hover"><p class="faa-horizontal">warning</p></div><div class="tip ban faa-parent animated-hover"><p class="faa-flash">ban</p></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-7-å¤é€‰åˆ—è¡¨-checkbox">2.7 å¤é€‰åˆ—è¡¨ checkbox</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">é…ç½®å‚æ•°</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% checkbox æ ·å¼å‚æ•°ï¼ˆå¯é€‰ï¼‰, æ–‡æœ¬ï¼ˆæ”¯æŒç®€å•mdï¼‰ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>æ ·å¼</code>: plus, minus, times</li><li><code>é¢œè‰²</code>: red,yellow,green,cyan,blue,gray</li><li><code>é€‰ä¸­çŠ¶æ€</code>: checked</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;% checkbox çº¯æ–‡æœ¬æµ‹è¯• %&#125;</span><br><span class="line">&#123;% checkbox checked, æ”¯æŒç®€å•çš„ [<span class="string">markdown</span>](<span class="link">https://guides.github.com/features/mastering-markdown/</span>) è¯­æ³• %&#125;</span><br><span class="line">&#123;% checkbox red, æ”¯æŒè‡ªå®šä¹‰é¢œè‰² %&#125;</span><br><span class="line">&#123;% checkbox green checked, ç»¿è‰² + é»˜è®¤é€‰ä¸­ %&#125;</span><br><span class="line">&#123;% checkbox yellow checked, é»„è‰² + é»˜è®¤é€‰ä¸­ %&#125;</span><br><span class="line">&#123;% checkbox cyan checked, é’è‰² + é»˜è®¤é€‰ä¸­ %&#125;</span><br><span class="line">&#123;% checkbox blue checked, è“è‰² + é»˜è®¤é€‰ä¸­ %&#125;</span><br><span class="line">&#123;% checkbox plus green checked, å¢åŠ  %&#125;</span><br><span class="line">&#123;% checkbox minus yellow checked, å‡å°‘ %&#125;</span><br><span class="line">&#123;% checkbox times red checked, å‰ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><div class='checkbox'><input type="checkbox" />            <p>çº¯æ–‡æœ¬æµ‹è¯•</p>            </div><div class='checkbox checked'><input type="checkbox" checked="checked"/>            <p>æ”¯æŒç®€å•çš„ <a href="https://guides.github.com/features/mastering-markdown/">markdown</a> è¯­æ³•</p>            </div><div class='checkbox red'><input type="checkbox" />            <p>æ”¯æŒè‡ªå®šä¹‰é¢œè‰²</p>            </div><div class='checkbox green checked'><input type="checkbox" checked="checked"/>            <p>ç»¿è‰² + é»˜è®¤é€‰ä¸­</p>            </div><div class='checkbox yellow checked'><input type="checkbox" checked="checked"/>            <p>é»„è‰² + é»˜è®¤é€‰ä¸­</p>            </div><div class='checkbox cyan checked'><input type="checkbox" checked="checked"/>            <p>é’è‰² + é»˜è®¤é€‰ä¸­</p>            </div><div class='checkbox blue checked'><input type="checkbox" checked="checked"/>            <p>è“è‰² + é»˜è®¤é€‰ä¸­</p>            </div><div class='checkbox plus green checked'><input type="checkbox" checked="checked"/>            <p>å¢åŠ </p>            </div><div class='checkbox minus yellow checked'><input type="checkbox" checked="checked"/>            <p>å‡å°‘</p>            </div><div class='checkbox times red checked'><input type="checkbox" checked="checked"/>            <p>å‰</p>            </div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-8-å•é€‰åˆ—è¡¨-radio">2.8 å•é€‰åˆ—è¡¨ radio</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">é…ç½®å‚æ•°</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% radio æ ·å¼å‚æ•°ï¼ˆå¯é€‰ï¼‰, æ–‡æœ¬ï¼ˆæ”¯æŒç®€å•mdï¼‰ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>é¢œè‰²</code>: red,yellow,green,cyan,blue,gray</li><li><code>é€‰ä¸­çŠ¶æ€</code>: checked</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% radio çº¯æ–‡æœ¬æµ‹è¯• %&#125;</span><br><span class="line">&#123;% radio checked, æ”¯æŒç®€å•çš„ [<span class="string">markdown</span>](<span class="link">https://guides.github.com/features/mastering-markdown/</span>) è¯­æ³• %&#125;</span><br><span class="line">&#123;% radio red, æ”¯æŒè‡ªå®šä¹‰é¢œè‰² %&#125;</span><br><span class="line">&#123;% radio green, ç»¿è‰² %&#125;</span><br><span class="line">&#123;% radio yellow, é»„è‰² %&#125;</span><br><span class="line">&#123;% radio cyan, é’è‰² %&#125;</span><br><span class="line">&#123;% radio blue, è“è‰² %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><div class='checkbox'><input type="radio" />            <p>çº¯æ–‡æœ¬æµ‹è¯•</p>            </div><div class='checkbox checked'><input type="radio" checked="checked"/>            <p>æ”¯æŒç®€å•çš„ <a href="https://guides.github.com/features/mastering-markdown/">markdown</a> è¯­æ³•</p>            </div><div class='checkbox red'><input type="radio" />            <p>æ”¯æŒè‡ªå®šä¹‰é¢œè‰²</p>            </div><div class='checkbox green'><input type="radio" />            <p>ç»¿è‰²</p>            </div><div class='checkbox yellow'><input type="radio" />            <p>é»„è‰²</p>            </div><div class='checkbox cyan'><input type="radio" />            <p>é’è‰²</p>            </div><div class='checkbox blue'><input type="radio" />            <p>è“è‰²</p>            </div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-9-æ—¶é—´è½´-timeline">2.9 æ—¶é—´è½´ timeline</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">é…ç½®å‚æ•°</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;% timeline æ—¶é—´çº¿æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰[,color] %&#125;</span><br><span class="line">&lt;!-- timeline æ—¶é—´èŠ‚ç‚¹ï¼ˆæ ‡é¢˜ï¼‰ --&gt;</span><br><span class="line">æ­£æ–‡å†…å®¹</span><br><span class="line">&lt;!-- endtimeline --&gt;</span><br><span class="line">&lt;!-- timeline æ—¶é—´èŠ‚ç‚¹ï¼ˆæ ‡é¢˜ï¼‰ --&gt;</span><br><span class="line">æ­£æ–‡å†…å®¹</span><br><span class="line">&lt;!-- endtimeline --&gt;</span><br><span class="line">&#123;% endtimeline %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>title</code>:æ ‡é¢˜/æ—¶é—´çº¿</li><li><code>color</code>:<code>timeline</code>é¢œè‰²:default(ç•™ç©º) / blue / pink / red / purple / orange / green</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;% timeline æ—¶é—´è½´æ ·å¼,blue %&#125;</span><br><span class="line"></span><br><span class="line">&lt;!-- timeline 2020-07-24 [<span class="string">2.6.6 -&gt; 3.0</span>](<span class="link">https://github.com/volantis-x/hexo-theme-volantis/releases</span>) --&gt;</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.</span> å¦‚æœæœ‰ <span class="code">`hexo-lazyload-image`</span> æ’ä»¶ï¼Œéœ€è¦åˆ é™¤å¹¶é‡æ–°å®‰è£…æœ€æ–°ç‰ˆæœ¬ï¼Œè®¾ç½® <span class="code">`lazyload.isSPA: true`</span>ã€‚</span><br><span class="line"><span class="bullet">2.</span> 2.x ç‰ˆæœ¬çš„ css å’Œ js ä¸é€‚ç”¨äº 3.x ç‰ˆæœ¬ï¼Œå¦‚æœä½¿ç”¨äº† <span class="code">`use_cdn: true`</span> åˆ™éœ€è¦åˆ é™¤ã€‚</span><br><span class="line"><span class="bullet">3.</span> 2.x ç‰ˆæœ¬çš„ fancybox æ ‡ç­¾åœ¨ 3.x ç‰ˆæœ¬ä¸­è¢«é‡å‘½åä¸º gallery ã€‚</span><br><span class="line"><span class="bullet">4.</span> 2.x ç‰ˆæœ¬çš„ç½®é¡¶ <span class="code">`top: true`</span> æ”¹ä¸ºäº† <span class="code">`pin: true`</span>ï¼Œå¹¶ä¸”åŒæ ·é€‚ç”¨äº <span class="code">`layout: page`</span> çš„é¡µé¢ã€‚</span><br><span class="line"><span class="bullet">5.</span> å¦‚æœä½¿ç”¨äº† <span class="code">`hexo-offline`</span> æ’ä»¶ï¼Œå»ºè®®å¸è½½ï¼Œ3.0 ç‰ˆæœ¬é»˜è®¤å¼€å¯äº† pjax æœåŠ¡ã€‚</span><br><span class="line"></span><br><span class="line">&lt;!-- endtimeline --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- timeline 2020-05-15 [<span class="string">2.6.3 -&gt; 2.6.6</span>](<span class="link">https://github.com/volantis-x/hexo-theme-volantis/releases/tag/2.6.6</span>) --&gt;</span><br><span class="line"></span><br><span class="line">ä¸éœ€è¦é¢å¤–å¤„ç†ã€‚</span><br><span class="line"></span><br><span class="line">&lt;!-- endtimeline --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- timeline 2020-04-20 [<span class="string">2.6.2 -&gt; 2.6.3</span>](<span class="link">https://github.com/volantis-x/hexo-theme-volantis/releases/tag/2.6.3</span>) --&gt;</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.</span> å…¨å±€æœç´¢ <span class="code">`seotitle`</span> å¹¶æ›¿æ¢ä¸º <span class="code">`seo_title`</span>ã€‚</span><br><span class="line"><span class="bullet">2.</span> group ç»„ä»¶çš„ç´¢å¼•è§„åˆ™æœ‰å˜ï¼Œä½¿ç”¨ group ç»„ä»¶çš„æ–‡ç« å†…ï¼Œ<span class="code">`group: group_name`</span> å¯¹åº”çš„ç»„ä»¶åå¿…é¡»æ˜¯ <span class="code">`group_name`</span>ã€‚</span><br><span class="line"><span class="bullet">2.</span> group ç»„ä»¶çš„åˆ—è¡¨åä¼˜å…ˆæ˜¾ç¤ºæ–‡ç« çš„ <span class="code">`short_title`</span> å…¶æ¬¡æ˜¯ <span class="code">`title`</span>ã€‚</span><br><span class="line"></span><br><span class="line">&lt;!-- endtimeline --&gt;</span><br><span class="line"></span><br><span class="line">&#123;% endtimeline %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><div class="timeline blue"><div class='timeline-item headline'><div class='timeline-item-title'><div class='item-circle'><p>æ—¶é—´è½´æ ·å¼</p></div></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>2020-07-24 <a href="https://github.com/volantis-x/hexo-theme-volantis/releases">2.6.6 -&gt; 3.0</a></p></div></div><div class='timeline-item-content'><ol><li>å¦‚æœæœ‰ <code>hexo-lazyload-image</code> æ’ä»¶ï¼Œéœ€è¦åˆ é™¤å¹¶é‡æ–°å®‰è£…æœ€æ–°ç‰ˆæœ¬ï¼Œè®¾ç½® <code>lazyload.isSPA: true</code>ã€‚</li><li>2.x ç‰ˆæœ¬çš„ css å’Œ js ä¸é€‚ç”¨äº 3.x ç‰ˆæœ¬ï¼Œå¦‚æœä½¿ç”¨äº† <code>use_cdn: true</code> åˆ™éœ€è¦åˆ é™¤ã€‚</li><li>2.x ç‰ˆæœ¬çš„ fancybox æ ‡ç­¾åœ¨ 3.x ç‰ˆæœ¬ä¸­è¢«é‡å‘½åä¸º gallery ã€‚</li><li>2.x ç‰ˆæœ¬çš„ç½®é¡¶ <code>top: true</code> æ”¹ä¸ºäº† <code>pin: true</code>ï¼Œå¹¶ä¸”åŒæ ·é€‚ç”¨äº <code>layout: page</code> çš„é¡µé¢ã€‚</li><li>å¦‚æœä½¿ç”¨äº† <code>hexo-offline</code> æ’ä»¶ï¼Œå»ºè®®å¸è½½ï¼Œ3.0 ç‰ˆæœ¬é»˜è®¤å¼€å¯äº† pjax æœåŠ¡ã€‚</li></ol></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>2020-05-15 <a href="https://github.com/volantis-x/hexo-theme-volantis/releases/tag/2.6.6">2.6.3 -&gt; 2.6.6</a></p></div></div><div class='timeline-item-content'><p>ä¸éœ€è¦é¢å¤–å¤„ç†ã€‚</p></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>2020-04-20 <a href="https://github.com/volantis-x/hexo-theme-volantis/releases/tag/2.6.3">2.6.2 -&gt; 2.6.3</a></p></div></div><div class='timeline-item-content'><ol><li>å…¨å±€æœç´¢ <code>seotitle</code> å¹¶æ›¿æ¢ä¸º <code>seo_title</code>ã€‚</li><li>group ç»„ä»¶çš„ç´¢å¼•è§„åˆ™æœ‰å˜ï¼Œä½¿ç”¨ group ç»„ä»¶çš„æ–‡ç« å†…ï¼Œ<code>group: group_name</code> å¯¹åº”çš„ç»„ä»¶åå¿…é¡»æ˜¯ <code>group_name</code>ã€‚</li><li>group ç»„ä»¶çš„åˆ—è¡¨åä¼˜å…ˆæ˜¾ç¤ºæ–‡ç« çš„ <code>short_title</code> å…¶æ¬¡æ˜¯ <code>title</code>ã€‚</li></ol></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-10-é“¾æ¥å¡ç‰‡-link">2.10 é“¾æ¥å¡ç‰‡ link</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% link æ ‡é¢˜, é“¾æ¥, å›¾ç‰‡é“¾æ¥ï¼ˆå¯é€‰ï¼‰ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% link ç³–æœå±‹æ•™ç¨‹è´´, https://akilar.top/posts/615e2dec/, https://cdn.cbd.int/akilar-candyassets@1.0.36/image/siteicon/favicon.ico %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><div class="tag link"><a class="link-card" title="ç³–æœå±‹æ•™ç¨‹è´´" href="https://akilar.top/posts/615e2dec/"><div class="left"><img src="https://cdn.cbd.int/akilar-candyassets@1.0.36/image/siteicon/favicon.ico"/></div><div class="right"><p class="text">ç³–æœå±‹æ•™ç¨‹è´´</p><p class="url">https://akilar.top/posts/615e2dec/</p></div></a></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-11-æŒ‰é’®-btns">2.11 æŒ‰é’® btns</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% btns æ ·å¼å‚æ•° %&#125;</span><br><span class="line">&#123;% cell æ ‡é¢˜, é“¾æ¥, å›¾ç‰‡æˆ–è€…å›¾æ ‡ %&#125;</span><br><span class="line">&#123;% cell æ ‡é¢˜, é“¾æ¥, å›¾ç‰‡æˆ–è€…å›¾æ ‡ %&#125;</span><br><span class="line">&#123;% endbtns %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li>åœ†è§’æ ·å¼ï¼šrounded, circle</li><li>å¢åŠ æ–‡å­—æ ·å¼ï¼šå¯ä»¥åœ¨å®¹å™¨å†…å¢åŠ  <code>&lt;b&gt;</code>æ ‡é¢˜<code>&lt;/b&gt;</code>å’Œ<code>&lt;p&gt;</code>æè¿°æ–‡å­—<code>&lt;/p&gt;</code></li><li>å¸ƒå±€æ–¹å¼ï¼š<br>é»˜è®¤ä¸ºè‡ªåŠ¨å®½åº¦ï¼Œé€‚åˆè§†é‡å†…åªæœ‰ä¸€ä¸¤ä¸ªçš„æƒ…å†µã€‚</li></ol><table><thead><tr><th>å‚æ•°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>wide</td><td>å®½ä¸€ç‚¹çš„æŒ‰é’®</td></tr><tr><td>fill</td><td>å¡«å……å¸ƒå±€ï¼Œè‡ªåŠ¨é“ºæ»¡è‡³å°‘ä¸€è¡Œï¼Œå¤šäº†ä¼šæ¢è¡Œ</td></tr><tr><td>center</td><td>å±…ä¸­ï¼ŒæŒ‰é’®ä¹‹é—´æ˜¯å›ºå®šé—´è·</td></tr><tr><td>around</td><td>å±…ä¸­åˆ†æ•£</td></tr><tr><td>grid2</td><td>ç­‰å®½æœ€å¤š2åˆ—ï¼Œå±å¹•å˜çª„ä¼šé€‚å½“å‡å°‘åˆ—æ•°</td></tr><tr><td>grid3</td><td>ç­‰å®½æœ€å¤š3åˆ—ï¼Œå±å¹•å˜çª„ä¼šé€‚å½“å‡å°‘åˆ—æ•°</td></tr><tr><td>grid4</td><td>ç­‰å®½æœ€å¤š4åˆ—ï¼Œå±å¹•å˜çª„ä¼šé€‚å½“å‡å°‘åˆ—æ•°</td></tr><tr><td>grid5</td><td>ç­‰å®½æœ€å¤š5åˆ—ï¼Œå±å¹•å˜çª„ä¼šé€‚å½“å‡å°‘åˆ—æ•°</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.å¦‚æœéœ€è¦æ˜¾ç¤ºç±»ä¼¼ã€Œå›¢é˜Ÿæˆå‘˜ã€ä¹‹ç±»çš„ä¸€ç»„å«æœ‰å¤´åƒçš„é“¾æ¥</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% btns circle grid5 %&#125;</span><br><span class="line">&#123;% cell xaoxuu, https://xaoxuu.com, https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png %&#125;</span><br><span class="line">&#123;% cell xaoxuu, https://xaoxuu.com, https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png %&#125;</span><br><span class="line">&#123;% cell xaoxuu, https://xaoxuu.com, https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png %&#125;</span><br><span class="line">&#123;% cell xaoxuu, https://xaoxuu.com, https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png %&#125;</span><br><span class="line">&#123;% cell xaoxuu, https://xaoxuu.com, https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png %&#125;</span><br><span class="line">&#123;% endbtns %&#125;</span><br></pre></td></tr></table></figure><p>2.æˆ–è€…å«æœ‰å›¾æ ‡çš„æŒ‰é’®</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% btns rounded grid5 %&#125;</span><br><span class="line">&#123;% cell ä¸‹è½½æºç , /, fas fa-download %&#125;</span><br><span class="line">&#123;% cell æŸ¥çœ‹æ–‡æ¡£, /, fas fa-book-open %&#125;</span><br><span class="line">&#123;% endbtns %&#125;</span><br></pre></td></tr></table></figure><p>3.åœ†å½¢å›¾æ ‡ + æ ‡é¢˜ + æè¿° + å›¾ç‰‡ + ç½‘æ ¼5åˆ— + å±…ä¸­</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;% btns circle center grid5 %&#125;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;https://apps.apple.com/cn/app/heart-mate-pro-hrm-utility/id1463348922?ls=1&#x27;</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&#x27;fab fa-apple&#x27;</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">b</span>&gt;</span></span>å¿ƒç‡ç®¡å®¶<span class="language-xml"><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span></span><br><span class="line">  &#123;% p red, ä¸“ä¸šç‰ˆ %&#125;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;https://cdn.jsdelivr.net/gh/fomalhaut1998/cdn-assets/qrcode/heartmate_pro.png&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;https://apps.apple.com/cn/app/heart-mate-lite-hrm-utility/id1475747930?ls=1&#x27;</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&#x27;fab fa-apple&#x27;</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">b</span>&gt;</span></span>å¿ƒç‡ç®¡å®¶<span class="language-xml"><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span></span><br><span class="line">  &#123;% p green, å…è´¹ç‰ˆ %&#125;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;https://cdn.jsdelivr.net/gh/fomalhaut1998/cdn-assets/qrcode/heartmate_lite.png&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line">&#123;% endbtns %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>1.å¦‚æœéœ€è¦æ˜¾ç¤ºç±»ä¼¼ã€Œå›¢é˜Ÿæˆå‘˜ã€ä¹‹ç±»çš„ä¸€ç»„å«æœ‰å¤´åƒçš„é“¾æ¥</p><div class="btns circle grid5">            <a class="button" href='https://xaoxuu.com' title='xaoxuu'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png'>xaoxuu</a><a class="button" href='https://xaoxuu.com' title='xaoxuu'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png'>xaoxuu</a><a class="button" href='https://xaoxuu.com' title='xaoxuu'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png'>xaoxuu</a><a class="button" href='https://xaoxuu.com' title='xaoxuu'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png'>xaoxuu</a><a class="button" href='https://xaoxuu.com' title='xaoxuu'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png'>xaoxuu</a>          </div>2.æˆ–è€…å«æœ‰å›¾æ ‡çš„æŒ‰é’®<div class="btns rounded grid5">            <a class="button" href='/' title='ä¸‹è½½æºç '><i class='fas fa-download'></i>ä¸‹è½½æºç </a><a class="button" href='/' title='æŸ¥çœ‹æ–‡æ¡£'><i class='fas fa-book-open'></i>æŸ¥çœ‹æ–‡æ¡£</a>          </div>3.åœ†å½¢å›¾æ ‡ + æ ‡é¢˜ + æè¿° + å›¾ç‰‡ + ç½‘æ ¼5åˆ— + å±…ä¸­<div class="btns circle center grid5">            <a href='https://apps.apple.com/cn/app/heart-mate-pro-hrm-utility/id1463348922?ls=1'>  <i class='fab fa-apple'></i>  <b>å¿ƒç‡ç®¡å®¶</b>  <p class='p red'>ä¸“ä¸šç‰ˆ</p>  <img src='https://cdn.jsdelivr.net/gh/fomalhaut1998/cdn-assets/qrcode/heartmate_pro.png'></a><a href='https://apps.apple.com/cn/app/heart-mate-lite-hrm-utility/id1475747930?ls=1'>  <i class='fab fa-apple'></i>  <b>å¿ƒç‡ç®¡å®¶</b>  <p class='p green'>å…è´¹ç‰ˆ</p>  <img src='https://cdn.jsdelivr.net/gh/fomalhaut1998/cdn-assets/qrcode/heartmate_lite.png'></a>          </div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-12-githubå¡ç‰‡-ghcard">2.12 githubå¡ç‰‡ ghcard</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% ghcard ç”¨æˆ·å, å…¶å®ƒå‚æ•°ï¼ˆå¯é€‰ï¼‰ %&#125;</span><br><span class="line">&#123;% ghcard ç”¨æˆ·å/ä»“åº“, å…¶å®ƒå‚æ•°ï¼ˆå¯é€‰ï¼‰ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><p>ä½¿ç”¨<code>,</code>åˆ†å‰²å„ä¸ªå‚æ•°ã€‚å†™æ³•ä¸ºï¼š<code>å‚æ•°å=å‚æ•°å€¼</code><br>ä»¥ä¸‹åªå†™å‡ ä¸ªå¸¸ç”¨å‚æ•°å€¼ã€‚</p><table><thead><tr><th><strong>å‚æ•°å</strong></th><th>å–å€¼</th><th>é‡Šä¹‰</th></tr></thead><tbody><tr><td>hide</td><td>stars,commits,prs,issues,contribs</td><td>éšè—æŒ‡å®šç»Ÿè®¡</td></tr><tr><td>count_private</td><td>true</td><td>å°†ç§äººé¡¹ç›®è´¡çŒ®æ·»åŠ åˆ°æ€»æäº¤è®¡æ•°ä¸­</td></tr><tr><td>show_icons</td><td>true</td><td>æ˜¾ç¤ºå›¾æ ‡</td></tr><tr><td>theme</td><td>æŸ¥é˜…:<a href="https://github.com/anuraghazra/github-readme-stats/blob/master/themes/README.md">Available Themes</a></td><td>ä¸»é¢˜</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.ç”¨æˆ·ä¿¡æ¯å¡ç‰‡</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">| &#123;% ghcard fomalhaut1998 %&#125; | &#123;% ghcard fomalhaut1998, theme=vue %&#125; |</span><br><span class="line">| -- | -- |</span><br><span class="line">| &#123;% ghcard fomalhaut1998, theme=buefy %&#125; | &#123;% ghcard fomalhaut1998, theme=solarized-light %&#125; |</span><br><span class="line">| &#123;% ghcard fomalhaut1998, theme=onedark %&#125; | &#123;% ghcard fomalhaut1998, theme=solarized-dark %&#125; |</span><br><span class="line">| &#123;% ghcard fomalhaut1998, theme=algolia %&#125; | &#123;% ghcard fomalhaut1998, theme=calm %&#125; |</span><br></pre></td></tr></table></figure><p>2.ä»“åº“ä¿¡æ¯å¡ç‰‡</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">| &#123;% ghcard volantis-x/hexo-theme-volantis %&#125; | &#123;% ghcard volantis-x/hexo-theme-volantis, theme=vue %&#125; |</span><br><span class="line">| -- | -- |</span><br><span class="line">| &#123;% ghcard volantis-x/hexo-theme-volantis, theme=buefy %&#125; | &#123;% ghcard volantis-x/hexo-theme-volantis, theme=solarized-light %&#125; |</span><br><span class="line">| &#123;% ghcard volantis-x/hexo-theme-volantis, theme=onedark %&#125; | &#123;% ghcard volantis-x/hexo-theme-volantis, theme=solarized-dark %&#125; |</span><br><span class="line">| &#123;% ghcard volantis-x/hexo-theme-volantis, theme=algolia %&#125; | &#123;% ghcard volantis-x/hexo-theme-volantis, theme=calm %&#125; |</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>1.ç”¨æˆ·ä¿¡æ¯å¡ç‰‡</p><table><thead><tr><th><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&show_owner=true"/></a></th><th><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=vue&show_owner=true"/></a></th></tr></thead><tbody><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=buefy&show_owner=true"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=solarized-light&show_owner=true"/></a></td></tr><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=onedark&show_owner=true"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=solarized-dark&show_owner=true"/></a></td></tr><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=algolia&show_owner=true"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=calm&show_owner=true"/></a></td></tr></tbody></table><p>2.ä»“åº“ä¿¡æ¯å¡ç‰‡</p><table><thead><tr><th><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&show_owner=true"/></a></th><th><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=vue&show_owner=true"/></a></th></tr></thead><tbody><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=buefy&show_owner=true"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=solarized-light&show_owner=true"/></a></td></tr><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=onedark&show_owner=true"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=solarized-dark&show_owner=true"/></a></td></tr><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=algolia&show_owner=true"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=calm&show_owner=true"/></a></td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-13-githubå¾½æ ‡-ghbdage">2.13 githubå¾½æ ‡ ghbdage</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">é…ç½®å‚æ•°</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% bdage [right],[left],[logo]||[color],[link],[title]||[option] %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>left</code>ï¼šå¾½æ ‡å·¦è¾¹çš„ä¿¡æ¯ï¼Œå¿…é€‰å‚æ•°ã€‚</li><li><code>right</code>: å¾½æ ‡å³è¾¹çš„ä¿¡æ¯ï¼Œå¿…é€‰å‚æ•°ï¼Œ</li><li><code>logo</code>ï¼šå¾½æ ‡å›¾æ ‡ï¼Œå›¾æ ‡åç§°è¯¦è§<a href="https://simpleicons.org/">simpleicons</a>ï¼Œå¯é€‰å‚æ•°ã€‚</li><li><code>color</code>ï¼šå¾½æ ‡å³è¾¹çš„é¢œè‰²ï¼Œå¯é€‰å‚æ•°ã€‚</li><li><code>link</code>ï¼šæŒ‡å‘çš„é“¾æ¥ï¼Œå¯é€‰å‚æ•°ã€‚</li><li><code>title</code>ï¼šå¾½æ ‡çš„é¢å¤–ä¿¡æ¯ï¼Œå¯é€‰å‚æ•°ã€‚ä¸»è¦ç”¨äºä¼˜åŒ–SEOï¼Œä½†<code>object</code>æ ‡ç­¾ä¸ä¼šåƒ<code>a</code>æ ‡ç­¾ä¸€æ ·åœ¨é¼ æ ‡æ‚¬åœæ˜¾ç¤º<code>title</code>ä¿¡æ¯ã€‚</li><li><code>option</code>ï¼šè‡ªå®šä¹‰å‚æ•°ï¼Œæ”¯æŒ<a href="https://shields.io/">shields.io</a>çš„å…¨éƒ¨APIå‚æ•°æ”¯æŒï¼Œå…·ä½“å‚æ•°å¯ä»¥å‚çœ‹ä¸Šæ–‡ä¸­çš„æ‹“å±•å†™æ³•ç¤ºä¾‹ã€‚å½¢å¼ä¸º<code>name1=value2&amp;name2=value2</code>ã€‚</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.åŸºæœ¬å‚æ•°,å®šä¹‰å¾½æ ‡å·¦å³æ–‡å­—å’Œå›¾æ ‡</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% bdage Theme,Butterfly %&#125;</span><br><span class="line">&#123;% bdage Frame,Hexo,hexo %&#125;</span><br></pre></td></tr></table></figure><p>2.ä¿¡æ¯å‚æ•°ï¼Œå®šä¹‰å¾½æ ‡å³ä¾§å†…å®¹èƒŒæ™¯è‰²ï¼ŒæŒ‡å‘é“¾æ¥</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% bdage CDN,JsDelivr,jsDelivr||abcdef,https://metroui.org.ua/index.html,æœ¬ç«™ä½¿ç”¨JsDelivrä¸ºé™æ€èµ„æºæä¾›CDNåŠ é€Ÿ %&#125;</span><br><span class="line">//å¦‚æœæ˜¯è·¨é¡ºåºçœç•¥å¯é€‰å‚æ•°ï¼Œä»ç„¶éœ€è¦å†™ä¸ªé€—å·,ç”¨ä½œåˆ†å‰²</span><br><span class="line">&#123;% bdage Source,GitHub,GitHub||,https://github.com/ %&#125;</span><br></pre></td></tr></table></figure><p>3.æ‹“å±•å‚æ•°ï¼Œæ”¯æŒshieldsçš„APIçš„å…¨éƒ¨å‚æ•°å†…å®¹</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% bdage Hosted,Vercel,Vercel||brightgreen,https://vercel.com/,æœ¬ç«™é‡‡ç”¨åŒçº¿éƒ¨ç½²ï¼Œé»˜è®¤çº¿è·¯æ‰˜ç®¡äºVercel||style=social&amp;logoWidth=20 %&#125;</span><br><span class="line">//å¦‚æœæ˜¯è·¨é¡ºåºçœç•¥å¯é€‰å‚æ•°ç»„ï¼Œä»ç„¶éœ€è¦å†™åŒç«–çº¿||ç”¨ä½œåˆ†å‰²</span><br><span class="line">&#123;% bdage Hosted,Vercel,Vercel||||style=social&amp;logoWidth=20&amp;logoColor=violet %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>1.åŸºæœ¬å‚æ•°,å®šä¹‰å¾½æ ‡å·¦å³æ–‡å­—å’Œå›¾æ ‡</p><p><object class="ghbdage" style="margin-inline:5px" title="" standby="loading..." data="https://img.shields.io/badge/Butterfly-Theme-orange?logo=&color=orange&link=&"></object><br><object class="ghbdage" style="margin-inline:5px" title="" standby="loading..." data="https://img.shields.io/badge/Hexo-Frame-orange?logo=hexo&color=orange&link=&"></object></p><p>2.ä¿¡æ¯å‚æ•°ï¼Œå®šä¹‰å¾½æ ‡å³ä¾§å†…å®¹èƒŒæ™¯è‰²ï¼ŒæŒ‡å‘é“¾æ¥</p><p><object class="ghbdage" style="margin-inline:5px" title="æœ¬ç«™ä½¿ç”¨JsDelivrä¸ºé™æ€èµ„æºæä¾›CDNåŠ é€Ÿ" standby="loading..." data="https://img.shields.io/badge/JsDelivr-CDN-orange?logo=jsDelivr&color=abcdef&link=https://metroui.org.ua/index.html&"></object><br>//å¦‚æœæ˜¯è·¨é¡ºåºçœç•¥å¯é€‰å‚æ•°ï¼Œä»ç„¶éœ€è¦å†™ä¸ªé€—å·,ç”¨ä½œåˆ†å‰²<br><object class="ghbdage" style="margin-inline:5px" title="" standby="loading..." data="https://img.shields.io/badge/GitHub-Source-orange?logo=GitHub&color=orange&link=https://github.com/&"></object></p><p>3.æ‹“å±•å‚æ•°ï¼Œæ”¯æŒshieldsçš„APIçš„å…¨éƒ¨å‚æ•°å†…å®¹</p><p><object class="ghbdage" style="margin-inline:5px" title="æœ¬ç«™é‡‡ç”¨åŒçº¿éƒ¨ç½²ï¼Œé»˜è®¤çº¿è·¯æ‰˜ç®¡äºVercel" standby="loading..." data="https://img.shields.io/badge/Vercel-Hosted-orange?logo=Vercel&color=brightgreen&link=https://vercel.com/&style=social&logoWidth=20"></object><br>//å¦‚æœæ˜¯è·¨é¡ºåºçœç•¥å¯é€‰å‚æ•°ç»„ï¼Œä»ç„¶éœ€è¦å†™åŒç«–çº¿||ç”¨ä½œåˆ†å‰²<br><object class="ghbdage" style="margin-inline:5px" title="" standby="loading..." data="https://img.shields.io/badge/Vercel-Hosted-orange?logo=Vercel&color=orange&link=&style=social&logoWidth=20&logoColor=violet"></object></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-14-ç½‘ç«™å¡ç‰‡-sites">2.14 ç½‘ç«™å¡ç‰‡ sites</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% sitegroup %&#125;</span><br><span class="line">&#123;% site æ ‡é¢˜, url=é“¾æ¥, screenshot=æˆªå›¾é“¾æ¥, avatar=å¤´åƒé“¾æ¥ï¼ˆå¯é€‰ï¼‰, description=æè¿°ï¼ˆå¯é€‰ï¼‰ %&#125;</span><br><span class="line">&#123;% site æ ‡é¢˜, url=é“¾æ¥, screenshot=æˆªå›¾é“¾æ¥, avatar=å¤´åƒé“¾æ¥ï¼ˆå¯é€‰ï¼‰, description=æè¿°ï¼ˆå¯é€‰ï¼‰ %&#125;</span><br><span class="line">&#123;% endsitegroup %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% sitegroup %&#125;</span><br><span class="line">&#123;% site xaoxuu, url=https://xaoxuu.com, screenshot=https://i.loli.net/2020/08/21/VuSwWZ1xAeUHEBC.jpg, avatar=https://cdn.jsdelivr.net/gh/fomalhaut1998/cdn-assets/avatar/avatar.png, description=ç®€çº¦é£æ ¼ %&#125;</span><br><span class="line">&#123;% site inkss, url=https://inkss.cn, screenshot=https://i.loli.net/2020/08/21/Vzbu3i8fXs6Nh5Y.jpg, avatar=https://cdn.jsdelivr.net/gh/inkss/common@master/static/web/avatar.jpg, description=è¿™æ˜¯ä¸€æ®µå…³äºè¿™ä¸ªç½‘ç«™çš„æè¿°æ–‡å­— %&#125;</span><br><span class="line">&#123;% site MHuiG, url=https://blog.mhuig.top, screenshot=https://i.loli.net/2020/08/22/d24zpPlhLYWX6D1.png, avatar=https://cdn.jsdelivr.net/gh/MHuiG/imgbed@master/data/p.png, description=è¿™æ˜¯ä¸€æ®µå…³äºè¿™ä¸ªç½‘ç«™çš„æè¿°æ–‡å­— %&#125;</span><br><span class="line">&#123;% site Colsrch, url=https://colsrch.top, screenshot=https://i.loli.net/2020/08/22/dFRWXm52OVu8qfK.png, avatar=https://cdn.jsdelivr.net/gh/Colsrch/images/Colsrch/avatar.jpg, description=è¿™æ˜¯ä¸€æ®µå…³äºè¿™ä¸ªç½‘ç«™çš„æè¿°æ–‡å­— %&#125;</span><br><span class="line">&#123;% site Linhk1606, url=https://linhk1606.github.io, screenshot=https://i.loli.net/2020/08/21/3PmGLCKicnfow1x.png, avatar=https://i.loli.net/2020/02/09/PN7I5RJfFtA93r2.png, description=è¿™æ˜¯ä¸€æ®µå…³äºè¿™ä¸ªç½‘ç«™çš„æè¿°æ–‡å­— %&#125;</span><br><span class="line">&#123;% endsitegroup %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><div class="site-card-group"><a class="site-card" href="https://fomalhaut1998.com"><div class="img"><img src="https://i.loli.net/2020/08/21/VuSwWZ1xAeUHEBC.jpg"/></div><div class="info"><img src="https://cdn.jsdelivr.net/gh/fomalhaut1998/cdn-assets/avatar/avatar.png"/><span class="title">fomalhaut1998</span><span class="desc">ç®€çº¦é£æ ¼</span></div></a><a class="site-card" href="https://inkss.cn"><div class="img"><img src="https://i.loli.net/2020/08/21/Vzbu3i8fXs6Nh5Y.jpg"/></div><div class="info"><img src="https://cdn.jsdelivr.net/gh/inkss/common@master/static/web/avatar.jpg"/><span class="title">inkss</span><span class="desc">è¿™æ˜¯ä¸€æ®µå…³äºè¿™ä¸ªç½‘ç«™çš„æè¿°æ–‡å­—</span></div></a><a class="site-card" href="https://blog.mhuig.top"><div class="img"><img src="https://i.loli.net/2020/08/22/d24zpPlhLYWX6D1.png"/></div><div class="info"><img src="https://cdn.jsdelivr.net/gh/MHuiG/imgbed@master/data/p.png"/><span class="title">MHuiG</span><span class="desc">è¿™æ˜¯ä¸€æ®µå…³äºè¿™ä¸ªç½‘ç«™çš„æè¿°æ–‡å­—</span></div></a><a class="site-card" href="https://colsrch.top"><div class="img"><img src="https://i.loli.net/2020/08/22/dFRWXm52OVu8qfK.png"/></div><div class="info"><img src="https://cdn.jsdelivr.net/gh/Colsrch/images/Colsrch/avatar.jpg"/><span class="title">Colsrch</span><span class="desc">è¿™æ˜¯ä¸€æ®µå…³äºè¿™ä¸ªç½‘ç«™çš„æè¿°æ–‡å­—</span></div></a><a class="site-card" href="https://linhk1606.github.io"><div class="img"><img src="https://i.loli.net/2020/08/21/3PmGLCKicnfow1x.png"/></div><div class="info"><img src="https://i.loli.net/2020/02/09/PN7I5RJfFtA93r2.png"/><span class="title">Linhk1606</span><span class="desc">è¿™æ˜¯ä¸€æ®µå…³äºè¿™ä¸ªç½‘ç«™çš„æè¿°æ–‡å­—</span></div></a></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-15-è¡Œå†…å›¾ç‰‡-inlineimage">2.15 è¡Œå†…å›¾ç‰‡ inlineimage</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% inlineimage å›¾ç‰‡é“¾æ¥, height=é«˜åº¦ï¼ˆå¯é€‰ï¼‰ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>é«˜åº¦</code>ï¼šheight=20px</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¿™æ˜¯ &#123;% inlineimage https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/aru-l/0000.gif %&#125; ä¸€æ®µè¯ã€‚</span><br><span class="line"></span><br><span class="line">è¿™åˆæ˜¯ &#123;% inlineimage https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/aru-l/5150.gif, height=40px %&#125; ä¸€æ®µè¯ã€‚</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>è¿™æ˜¯ <img no-lazy class="inline" src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/aru-l/0000.gif" style="height:1.5em"/> ä¸€æ®µè¯ã€‚</p><p>è¿™åˆæ˜¯ <img no-lazy class="inline" src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/aru-l/5150.gif" style="height:40px;"/> ä¸€æ®µè¯ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-16-å•å¼ å›¾ç‰‡-image">2.16 å•å¼ å›¾ç‰‡ image</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% image é“¾æ¥, width=å®½åº¦ï¼ˆå¯é€‰ï¼‰, height=é«˜åº¦ï¼ˆå¯é€‰ï¼‰, alt=æè¿°ï¼ˆå¯é€‰ï¼‰, bg=å ä½é¢œè‰²ï¼ˆå¯é€‰ï¼‰ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li>å›¾ç‰‡å®½åº¦é«˜åº¦ï¼šwidth=300px, height=32px</li><li>å›¾ç‰‡æè¿°ï¼šalt=å›¾ç‰‡æè¿°ï¼ˆbutterflyéœ€è¦åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­å¼€å¯å›¾ç‰‡æè¿°ï¼‰</li><li>å ä½èƒŒæ™¯è‰²ï¼šbg=#f2f2f2</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.æ·»åŠ æè¿°ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% image https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg, alt=æ¯å¤©ä¸‹è¯¾å›å®¿èˆçš„è·¯ï¼Œæ²¡æœ‰ä»€ä¹ˆæ•…äº‹ã€‚ %&#125;</span><br></pre></td></tr></table></figure><p>2.æŒ‡å®šå®½åº¦</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% image https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg, width=400px %&#125;</span><br></pre></td></tr></table></figure><p>3.æŒ‡å®šå®½åº¦å¹¶æ·»åŠ æè¿°ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% image https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg, width=400px, alt=æ¯å¤©ä¸‹è¯¾å›å®¿èˆçš„è·¯ï¼Œæ²¡æœ‰ä»€ä¹ˆæ•…äº‹ã€‚ %&#125;</span><br></pre></td></tr></table></figure><p>4.è®¾ç½®å ä½èƒŒæ™¯è‰²ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% image https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg, width=400px, bg=#1D0C04, alt=ä¼˜åŒ–ä¸åŒå®½åº¦æµè§ˆçš„è§‚æ„Ÿ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>1.æ·»åŠ æè¿°ï¼š</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg" alt="æ¯å¤©ä¸‹è¯¾å›å®¿èˆçš„è·¯ï¼Œæ²¡æœ‰ä»€ä¹ˆæ•…äº‹ã€‚"/></div><span class="image-caption">æ¯å¤©ä¸‹è¯¾å›å®¿èˆçš„è·¯ï¼Œæ²¡æœ‰ä»€ä¹ˆæ•…äº‹ã€‚</span></div>2..æŒ‡å®šå®½åº¦<div class="img-wrap"><div class="img-bg"><img class="img" src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg" style="width:400px;"/></div></div>3.æŒ‡å®šå®½åº¦å¹¶æ·»åŠ æè¿°ï¼š<div class="img-wrap"><div class="img-bg"><img class="img" src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg" alt="æ¯å¤©ä¸‹è¯¾å›å®¿èˆçš„è·¯ï¼Œæ²¡æœ‰ä»€ä¹ˆæ•…äº‹ã€‚" style="width:400px;"/></div><span class="image-caption">æ¯å¤©ä¸‹è¯¾å›å®¿èˆçš„è·¯ï¼Œæ²¡æœ‰ä»€ä¹ˆæ•…äº‹ã€‚</span></div>4.è®¾ç½®å ä½èƒŒæ™¯è‰²ï¼š<div class="img-wrap"><div class="img-bg" style="background:#1D0C04"><img class="img" src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg" alt="ä¼˜åŒ–ä¸åŒå®½åº¦æµè§ˆçš„è§‚æ„Ÿ" style="width:400px;"/></div><span class="image-caption">ä¼˜åŒ–ä¸åŒå®½åº¦æµè§ˆçš„è§‚æ„Ÿ</span></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-17-éŸ³é¢‘-audio">2.17 éŸ³é¢‘ audio</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% audio éŸ³é¢‘é“¾æ¥ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% audio https://github.com/volantis-x/volantis-docs/releases/download/assets/Lumia1020.mp3 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><div class="audio"><audio controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/Lumia1020.mp3' type='audio/mp3'>Your browser does not support the audio tag.</audio></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-18-è§†é¢‘-video">2.18 è§†é¢‘ video</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% video è§†é¢‘é“¾æ¥ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>å¯¹é½æ–¹å‘</code>ï¼šleft, center, right</li><li><code>åˆ—æ•°</code>ï¼šé€—å·åé¢ç›´æ¥å†™åˆ—æ•°ï¼Œæ”¯æŒ 1 ï½ 4 åˆ—ã€‚</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.100%å®½åº¦</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br></pre></td></tr></table></figure><p>2.50%å®½åº¦</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% videos, 2 %&#125;</span><br><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_</span>0341.mov %&#125;</span><br><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_</span>0341.mov %&#125;</span><br><span class="line">&#123;% endvideos %&#125;</span><br></pre></td></tr></table></figure><p>3.25%å®½åº¦</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;% videos, 4 %&#125;</span><br><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_</span>0341.mov %&#125;</span><br><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_</span>0341.mov %&#125;</span><br><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_</span>0341.mov %&#125;</span><br><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_</span>0341.mov %&#125;</span><br><span class="line">&#123;% endvideos %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>1.100%å®½åº¦</p><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div>2.50%å®½åº¦<div class="videos" col='2'><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div></div>3.25%å®½åº¦<div class="videos" col='4'><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-19-ç›¸å†Œ-gallery">2.19 ç›¸å†Œ gallery</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><p>1.gallerygroup ç›¸å†Œå›¾åº“</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;gallery-group-main&quot;</span>&gt;</span></span></span><br><span class="line">&#123;% galleryGroup name description link img-url %&#125;</span><br><span class="line">&#123;% galleryGroup name description link img-url %&#125;</span><br><span class="line">&#123;% galleryGroup name description link img-url %&#125;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>2.gallery ç›¸å†Œ</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% gallery %&#125;</span><br><span class="line">markdown åœ–ç‰‡æ ¼å¼</span><br><span class="line">&#123;% endgallery %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ul><li>gallerygroup ç›¸å†Œå›¾åº“</li></ul><table><thead><tr><th>å‚æ•°å</th><th>é‡Šä¹‰</th></tr></thead><tbody><tr><td>name</td><td>å›¾åº“åå­—</td></tr><tr><td>description</td><td>å›¾åº“æè¿°</td></tr><tr><td>link</td><td>é“¾æ¥åˆ°å¯¹åº”ç›¸å†Œçš„åœ°å€</td></tr><tr><td>img-url</td><td>å›¾åº“å°é¢</td></tr></tbody></table><ul><li><p>gallery ç›¸å†Œ</p><p>åŒºåˆ«äºæ—§ç‰ˆçš„Galleryç›¸å†Œ,æ–°çš„Galleryç›¸å†Œä¼šè‡ªåŠ¨æ ¹æ®å›¾ç‰‡é•¿åº¦è¿›è¡Œæ’ç‰ˆï¼Œä¹¦å†™ä¹Ÿæ›´åŠ æ–¹ä¾¿ï¼Œä¸markdownæ ¼å¼ä¸€æ ·ã€‚å¯æ ¹æ®éœ€è¦æ’å…¥åˆ°ç›¸åº”çš„mdã€‚æ— éœ€å†è‡ªå·±é…ç½®é•¿å®½ã€‚<strong>å»ºè®®åœ¨ç²˜è´´æ—¶æ•…æ„ä½¿ç”¨é•¿çŸ­ã€å¤§å°ã€æ¨ªç«–ä¸ä¸€çš„å›¾ç‰‡</strong>ï¼Œä¼šæœ‰æ›´å¥½çš„æ•ˆæœã€‚ï¼ˆå°ºå¯¸å®Œå…¨ç›¸åŒçš„å›¾ç‰‡åªä¼šå¹³é“ºè¾“å‡ºï¼Œæ•ˆæœå¾ˆç³Ÿç³•ï¼‰</p></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.gallerygroup ç›¸å†Œå›¾åº“</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;gallery-group-main&quot;</span>&gt;</span></span></span><br><span class="line">&#123;% galleryGroup MC åœ¨Rikkaã®å…­èŠ±æœåŠ¡å™¨é‡Œç•™ä¸‹çš„è¶³è¿¹ &#x27;/gallery/MC/&#x27; https://cdn.cbd.int/akilar-candyassets@1.0.36/image/1.jpg %&#125;</span><br><span class="line">&#123;% galleryGroup Gundam å“¦å’§å“‡gundamå“’ï¼ &#x27;/gallery/Gundam/&#x27; https://cdn.cbd.int/akilar-candyassets@1.0.36/image/20200907110508327.png %&#125;</span><br><span class="line">&#123;% galleryGroup I-am-Akilar æŸç§æ„ä¹‰ä¸Šä¹Ÿç®—è‡ªæ‹å§ &#x27;/gallery/I-am-Akilar/&#x27; https://cdn.cbd.int/akilar-candyassets@1.0.36/image/20200907113116651.png %&#125;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>2.gallery ç›¸å†Œ</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% gallery %&#125;</span><br><span class="line">![](<span class="link">https://i.loli.net/2019/12/25/Fze9jchtnyJXMHN.jpg</span>)</span><br><span class="line">![](<span class="link">https://i.loli.net/2019/12/25/ryLVePaqkYm4TEK.jpg</span>)</span><br><span class="line">&#123;% endgallery %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>1.gallerygroup ç›¸å†Œå›¾åº“</p><div class="gallery-group-main">  <figure class="gallery-group">  <img class="gallery-group-img no-lightbox" src='https://cdn.cbd.int/akilar-candyassets@1.0.36/image/1.jpg' alt="Group Image Gallery">  <figcaption>  <div class="gallery-group-name">MC</div>  <p>åœ¨Rikkaã®å…­èŠ±æœåŠ¡å™¨é‡Œç•™ä¸‹çš„è¶³è¿¹</p>  <a href='/gallery/MC/'></a>  </figcaption>  </figure>  <figure class="gallery-group">  <img class="gallery-group-img no-lightbox" src='https://cdn.cbd.int/akilar-candyassets@1.0.36/image/20200907110508327.png' alt="Group Image Gallery">  <figcaption>  <div class="gallery-group-name">Gundam</div>  <p>å“¦å’§å“‡gundamå“’ï¼</p>  <a href='/gallery/Gundam/'></a>  </figcaption>  </figure>  <figure class="gallery-group">  <img class="gallery-group-img no-lightbox" src='https://cdn.cbd.int/akilar-candyassets@1.0.36/image/20200907113116651.png' alt="Group Image Gallery">  <figcaption>  <div class="gallery-group-name">I-am-Akilar</div>  <p>æŸç§æ„ä¹‰ä¸Šä¹Ÿç®—è‡ªæ‹å§</p>  <a href='/gallery/I-am-Akilar/'></a>  </figcaption>  </figure></div>2.gallery ç›¸å†Œ<div class="fj-gallery"><p><img src="https://i.loli.net/2019/12/25/Fze9jchtnyJXMHN.jpg" alt=""><br><img src="https://i.loli.net/2019/12/25/ryLVePaqkYm4TEK.jpg" alt=""></p>          </div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-20-æŠ˜å æ¡†-folding">2.20 æŠ˜å æ¡† folding</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><p>1.gallerygroup ç›¸å†Œå›¾åº“</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% folding å‚æ•°ï¼ˆå¯é€‰ï¼‰, æ ‡é¢˜ %&#125;</span><br><span class="line">![](<span class="link">https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg</span>)</span><br><span class="line">&#123;% endfolding %&#125;</span><br></pre></td></tr></table></figure><!-- tab å‚æ•°é…ç½® --><ol><li><p><code>é¢œè‰²</code>ï¼šblue, cyan, green, yellow, red</p></li><li><p><code>çŠ¶æ€</code>ï¼šçŠ¶æ€å¡«å†™ open ä»£è¡¨é»˜è®¤æ‰“å¼€ã€‚</p></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;% folding æŸ¥çœ‹å›¾ç‰‡æµ‹è¯• %&#125;</span><br><span class="line"></span><br><span class="line">![](<span class="link">https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg</span>)</span><br><span class="line"></span><br><span class="line">&#123;% endfolding %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% folding cyan open, æŸ¥çœ‹é»˜è®¤æ‰“å¼€çš„æŠ˜å æ¡† %&#125;</span><br><span class="line"></span><br><span class="line">è¿™æ˜¯ä¸€ä¸ªé»˜è®¤æ‰“å¼€çš„æŠ˜å æ¡†ã€‚</span><br><span class="line"></span><br><span class="line">&#123;% endfolding %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% folding green, æŸ¥çœ‹ä»£ç æµ‹è¯• %&#125;</span><br><span class="line">å‡è£…è¿™é‡Œæœ‰ä»£ç å—ï¼ˆä»£ç å—æ²¡æ³•åµŒå¥—ä»£ç å—ï¼‰</span><br><span class="line">&#123;% endfolding %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% folding yellow, æŸ¥çœ‹åˆ—è¡¨æµ‹è¯• %&#125;</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> haha</span><br><span class="line"><span class="bullet">-</span> hehe</span><br><span class="line"></span><br><span class="line">&#123;% endfolding %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% folding red, æŸ¥çœ‹åµŒå¥—æµ‹è¯• %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% folding blue, æŸ¥çœ‹åµŒå¥—æµ‹è¯•2 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% folding æŸ¥çœ‹åµŒå¥—æµ‹è¯•3 %&#125;</span><br><span class="line"></span><br><span class="line">hahaha <span class="language-xml"><span class="tag">&lt;<span class="name">span</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/tieba/%E6%BB%91%E7%A8%BD.png&#x27;</span> <span class="attr">style</span>=<span class="string">&#x27;height:24px&#x27;</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&#123;% endfolding %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endfolding %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endfolding %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><details class="folding-tag" ><summary> æŸ¥çœ‹å›¾ç‰‡æµ‹è¯• </summary>              <div class='content'>              <p><img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg" alt=""></p>              </div>            </details><details class="folding-tag" cyan open><summary> æŸ¥çœ‹é»˜è®¤æ‰“å¼€çš„æŠ˜å æ¡† </summary>              <div class='content'>              <p>è¿™æ˜¯ä¸€ä¸ªé»˜è®¤æ‰“å¼€çš„æŠ˜å æ¡†ã€‚</p>              </div>            </details><details class="folding-tag" green><summary> æŸ¥çœ‹ä»£ç æµ‹è¯• </summary>              <div class='content'>              <p>å‡è£…è¿™é‡Œæœ‰ä»£ç å—ï¼ˆä»£ç å—æ²¡æ³•åµŒå¥—ä»£ç å—ï¼‰</p>              </div>            </details><details class="folding-tag" yellow><summary> æŸ¥çœ‹åˆ—è¡¨æµ‹è¯• </summary>              <div class='content'>              <ul><li>haha</li><li>hehe</li></ul>              </div>            </details><details class="folding-tag" red><summary> æŸ¥çœ‹åµŒå¥—æµ‹è¯• </summary>              <div class='content'>              <details class="folding-tag" blue><summary> æŸ¥çœ‹åµŒå¥—æµ‹è¯•2 </summary>              <div class='content'>              <details class="folding-tag" ><summary> æŸ¥çœ‹åµŒå¥—æµ‹è¯•3 </summary>              <div class='content'>              <p>hahaha <span><img src='https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/tieba/%E6%BB%91%E7%A8%BD.png' style='height:24px'></span></p>              </div>            </details>              </div>            </details>              </div>            </details><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-21-åˆ†æ -tab">2.21 åˆ†æ  tab</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">é…ç½®å‚æ•°</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tabs Unique name, [index] %&#125;</span><br><span class="line">&lt;!-- tab [Tab caption] [@icon] --&gt;</span><br><span class="line">Any content (support inline tags too).</span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&#123;% endtabs %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><p>Unique name :</p><ul><li><p>é€‰é¡¹å¡å—æ ‡ç­¾çš„å”¯ä¸€åç§°ï¼Œä¸å¸¦é€—å·ã€‚</p></li><li><p>å°†åœ¨#idä¸­ç”¨ä½œæ¯ä¸ªæ ‡ç­¾åŠå…¶ç´¢å¼•å·çš„å‰ç¼€ã€‚</p></li><li><p>å¦‚æœåç§°ä¸­åŒ…å«ç©ºæ ¼ï¼Œåˆ™å¯¹äºç”Ÿæˆ#idï¼Œæ‰€æœ‰ç©ºæ ¼å°†ç”±ç ´æŠ˜å·ä»£æ›¿ã€‚</p></li><li><p>ä»…å½“å‰å¸–å­/é¡µé¢çš„URLå¿…é¡»æ˜¯å”¯ä¸€çš„ï¼</p></li></ul></li><li><p>[index]:</p><ul><li><p>æ´»åŠ¨é€‰é¡¹å¡çš„ç´¢å¼•å·ã€‚</p></li><li><p>å¦‚æœæœªæŒ‡å®šï¼Œå°†é€‰æ‹©ç¬¬ä¸€ä¸ªæ ‡ç­¾ï¼ˆ1ï¼‰ã€‚</p></li><li><p>å¦‚æœindexä¸º-1ï¼Œåˆ™ä¸ä¼šé€‰æ‹©ä»»ä½•é€‰é¡¹å¡ã€‚</p></li><li><p>å¯é€‰å‚æ•°ã€‚</p></li></ul></li><li><p>[Tab caption]:</p><ul><li><p>å½“å‰é€‰é¡¹å¡çš„æ ‡é¢˜ã€‚</p></li><li><p>å¦‚æœæœªæŒ‡å®šæ ‡é¢˜ï¼Œåˆ™å¸¦æœ‰åˆ¶è¡¨ç¬¦ç´¢å¼•åç¼€çš„å”¯ä¸€åç§°å°†ç”¨ä½œåˆ¶è¡¨ç¬¦çš„æ ‡é¢˜ã€‚</p></li><li><p>å¦‚æœæœªæŒ‡å®šæ ‡é¢˜ï¼Œä½†æŒ‡å®šäº†å›¾æ ‡ï¼Œåˆ™æ ‡é¢˜å°†ä¸ºç©ºã€‚</p></li><li><p>å¯é€‰å‚æ•°ã€‚</p></li></ul></li><li><p>[@icon]:</p><ul><li><p>FontAwesomeå›¾æ ‡åç§°ï¼ˆå…¨åï¼Œçœ‹èµ·æ¥åƒâ€œ fas fa-fontâ€ï¼‰</p></li><li><p>å¯ä»¥æŒ‡å®šå¸¦ç©ºæ ¼æˆ–ä¸å¸¦ç©ºæ ¼ï¼›</p></li><li><p>ä¾‹å¦‚â€™Tab caption @iconâ€™ å’Œ â€˜Tab caption@iconâ€™.</p></li><li><p>å¯é€‰å‚æ•°ã€‚</p></li></ul></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.Demo 1 - é¢„è®¾é€‰æ‹©ç¬¬ä¸€ä¸ªã€é»˜è®¤ã€‘</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tabs test1 %&#125;</span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 1.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 2.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 3.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&#123;% endtabs %&#125;</span><br></pre></td></tr></table></figure><p>2.Demo 2 - é¢„è®¾é€‰æ‹©tabs</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tabs test2, 3 %&#125;</span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 1.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 2.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 3.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&#123;% endtabs %&#125;</span><br></pre></td></tr></table></figure><p>3.Demo 3 - æ²¡æœ‰é¢„è®¾å€¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tabs test3, -1 %&#125;</span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 1.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 2.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 3.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&#123;% endtabs %&#125;</span><br></pre></td></tr></table></figure><p>4.Demo 4 - è‡ªå®šä¹‰Tabå + åªæœ‰icon + iconå’ŒTabå</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tabs test4 %&#125;</span><br><span class="line">&lt;!-- tab ç¬¬ä¸€ä¸ªTab --&gt;</span><br><span class="line"><span class="strong">**tabåå­—ä¸ºç¬¬ä¸€ä¸ªTab**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab @fab fa-apple-pay --&gt;</span><br><span class="line"><span class="strong">**åªæœ‰å›¾æ ‡ æ²¡æœ‰Tabåå­—**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab ç‚¸å¼¹@fas fa-bomb --&gt;</span><br><span class="line"><span class="strong">**åå­—+icon**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&#123;% endtabs %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>1.Demo 1 - é¢„è®¾é€‰æ‹©ç¬¬ä¸€ä¸ªã€é»˜è®¤ã€‘</p><div class="tabs" id="test1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#test1-1">test1 1</button></li><li class="tab"><button type="button" data-href="#test1-2">test1 2</button></li><li class="tab"><button type="button" data-href="#test1-3">test1 3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="test1-1"><p><strong>This is Tab 1.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test1-2"><p><strong>This is Tab 2.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test1-3"><p><strong>This is Tab 3.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>2.Demo 2 - é¢„è®¾é€‰æ‹©tabs</p><div class="tabs" id="test2"><ul class="nav-tabs"><li class="tab"><button type="button" data-href="#test2-1">test2 1</button></li><li class="tab"><button type="button" data-href="#test2-2">test2 2</button></li><li class="tab active"><button type="button" data-href="#test2-3">test2 3</button></li></ul><div class="tab-contents"><div class="tab-item-content" id="test2-1"><p><strong>This is Tab 1.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test2-2"><p><strong>This is Tab 2.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content active" id="test2-3"><p><strong>This is Tab 3.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>3.Demo 3 - æ²¡æœ‰é¢„è®¾å€¼</p><div class="tabs" id="test3"><ul class="nav-tabs"><li class="tab"><button type="button" data-href="#test3-1">test3 1</button></li><li class="tab"><button type="button" data-href="#test3-2">test3 2</button></li><li class="tab"><button type="button" data-href="#test3-3">test3 3</button></li></ul><div class="tab-contents"><div class="tab-item-content" id="test3-1"><p><strong>This is Tab 1.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test3-2"><p><strong>This is Tab 2.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test3-3"><p><strong>This is Tab 3.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>4.Demo 4 - è‡ªå®šä¹‰Tabå + åªæœ‰icon + iconå’ŒTabå</p><div class="tabs" id="test4"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#test4-1">ç¬¬ä¸€ä¸ªTab</button></li><li class="tab"><button type="button" data-href="#test4-2"><i class="fab fa-apple-pay" style="text-align: center;"></i></button></li><li class="tab"><button type="button" data-href="#test4-3"><i class="fas fa-bomb"></i>ç‚¸å¼¹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="test4-1"><p><strong>tabåå­—ä¸ºç¬¬ä¸€ä¸ªTab</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test4-2"><p><strong>åªæœ‰å›¾æ ‡ æ²¡æœ‰Tabåå­—</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test4-3"><p><strong>åå­—+icon</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-22-è¯—è¯æ ‡ç­¾-poem">2.22 è¯—è¯æ ‡ç­¾ poem</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><ol><li><code>title</code>ï¼šè¯—è¯æ ‡é¢˜</li><li><code>author</code>ï¼šä½œè€…ï¼Œå¯ä»¥ä¸å†™</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;% poem æ°´è°ƒæ­Œå¤´,è‹è½¼ %&#125;</span><br><span class="line">ä¸™è¾°ä¸­ç§‹ï¼Œæ¬¢é¥®è¾¾æ—¦ï¼Œå¤§é†‰ï¼Œä½œæ­¤ç¯‡ï¼Œå…¼æ€€å­ç”±ã€‚</span><br><span class="line">æ˜æœˆå‡ æ—¶æœ‰ï¼ŸæŠŠé…’é—®é’å¤©ã€‚</span><br><span class="line">ä¸çŸ¥å¤©ä¸Šå®«é˜™ï¼Œä»Šå¤•æ˜¯ä½•å¹´ï¼Ÿ</span><br><span class="line">æˆ‘æ¬²ä¹˜é£å½’å»ï¼Œåˆæç¼æ¥¼ç‰å®‡ï¼Œé«˜å¤„ä¸èƒœå¯’ã€‚</span><br><span class="line">èµ·èˆå¼„æ¸…å½±ï¼Œä½•ä¼¼åœ¨äººé—´ï¼Ÿ</span><br><span class="line"></span><br><span class="line">è½¬æœ±é˜ï¼Œä½ç»®æˆ·ï¼Œç…§æ— çœ ã€‚</span><br><span class="line">ä¸åº”æœ‰æ¨ï¼Œä½•äº‹é•¿å‘åˆ«æ—¶åœ†ï¼Ÿ</span><br><span class="line">äººæœ‰æ‚²æ¬¢ç¦»åˆï¼Œæœˆæœ‰é˜´æ™´åœ†ç¼ºï¼Œæ­¤äº‹å¤éš¾å…¨ã€‚</span><br><span class="line">ä½†æ„¿äººé•¿ä¹…ï¼Œåƒé‡Œå…±å©µå¨Ÿã€‚</span><br><span class="line">&#123;% endpoem %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><div class='poem'><div class='poem-title'>æ°´è°ƒæ­Œå¤´</div><div class='poem-author'>è‹è½¼</div><p>ä¸™è¾°ä¸­ç§‹ï¼Œæ¬¢é¥®è¾¾æ—¦ï¼Œå¤§é†‰ï¼Œä½œæ­¤ç¯‡ï¼Œå…¼æ€€å­ç”±ã€‚<br>æ˜æœˆå‡ æ—¶æœ‰ï¼ŸæŠŠé…’é—®é’å¤©ã€‚<br>ä¸çŸ¥å¤©ä¸Šå®«é˜™ï¼Œä»Šå¤•æ˜¯ä½•å¹´ï¼Ÿ<br>æˆ‘æ¬²ä¹˜é£å½’å»ï¼Œåˆæç¼æ¥¼ç‰å®‡ï¼Œé«˜å¤„ä¸èƒœå¯’ã€‚<br>èµ·èˆå¼„æ¸…å½±ï¼Œä½•ä¼¼åœ¨äººé—´ï¼Ÿ</p><p>è½¬æœ±é˜ï¼Œä½ç»®æˆ·ï¼Œç…§æ— çœ ã€‚<br>ä¸åº”æœ‰æ¨ï¼Œä½•äº‹é•¿å‘åˆ«æ—¶åœ†ï¼Ÿ<br>äººæœ‰æ‚²æ¬¢ç¦»åˆï¼Œæœˆæœ‰é˜´æ™´åœ†ç¼ºï¼Œæ­¤äº‹å¤éš¾å…¨ã€‚<br>ä½†æ„¿äººé•¿ä¹…ï¼Œåƒé‡Œå…±å©µå¨Ÿã€‚</p></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-23-é˜¿é‡Œå›¾æ ‡-icon">2.23 é˜¿é‡Œå›¾æ ‡ icon</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% icon [icon-xxxx],[font-size] %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>icon-xxxx</code>ï¼šè¡¨ç¤ºå›¾æ ‡<code>font-class</code>,å¯ä»¥åœ¨è‡ªå·±çš„é˜¿é‡ŒçŸ¢é‡å›¾æ ‡åº“é¡¹ç›®çš„<code>font-class</code>å¼•ç”¨æ–¹æ¡ˆå†…æŸ¥è¯¢å¹¶å¤åˆ¶ã€‚</li><li><code>font-size</code>ï¼šè¡¨ç¤ºå›¾æ ‡å¤§å°ï¼Œç›´æ¥å¡«å†™æ•°å­—å³å¯ï¼Œå•ä½ä¸º<code>em</code>ã€‚å›¾æ ‡å¤§å°é»˜è®¤å€¼ä¸º<code>1em</code>ã€‚</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;% icon icon-rat<span class="emphasis">_zi %&#125;&#123;% icon icon-rat,2 %&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">&#123;% icon icon-ox_</span>chou,3 %&#125;&#123;% icon icon-ox,4 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% icon icon-tiger<span class="emphasis">_yin,5 %&#125;&#123;% icon icon-tiger,6 %&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">&#123;% icon icon-rabbit_</span>mao,1 %&#125;&#123;% icon icon-rabbit,2 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% icon icon-dragon<span class="emphasis">_chen,3 %&#125;&#123;% icon icon-dragon,4 %&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">&#123;% icon icon-snake_</span>si,5 %&#125;&#123;% icon icon-snake,6 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% icon icon-horse<span class="emphasis">_wu %&#125;&#123;% icon icon-horse,2 %&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">&#123;% icon icon-goat_</span>wei,3 %&#125;&#123;% icon icon-goat,4 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% icon icon-monkey<span class="emphasis">_shen,5 %&#125;&#123;% icon icon-monkey,6 %&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">&#123;% icon icon-rooster_</span>you %&#125;&#123;% icon icon-rooster,2 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% icon icon-dog<span class="emphasis">_xu,3 %&#125;&#123;% icon icon-dog,4 %&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">&#123;% icon icon-boar_</span>hai,5 %&#125;&#123;% icon icon-boar,6 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p><svg class="icon" style="width:1em; height:1em" aria-hidden="true"><use xlink:href="#icon-rat_zi"></use></svg><svg class="icon" style="width:2em; height:2em" aria-hidden="true"><use xlink:href="#icon-rat"></use></svg></p><p><svg class="icon" style="width:3em; height:3em" aria-hidden="true"><use xlink:href="#icon-ox_chou"></use></svg><svg class="icon" style="width:4em; height:4em" aria-hidden="true"><use xlink:href="#icon-ox"></use></svg></p><p><svg class="icon" style="width:5em; height:5em" aria-hidden="true"><use xlink:href="#icon-tiger_yin"></use></svg><svg class="icon" style="width:6em; height:6em" aria-hidden="true"><use xlink:href="#icon-tiger"></use></svg></p><p><svg class="icon" style="width:1em; height:1em" aria-hidden="true"><use xlink:href="#icon-rabbit_mao"></use></svg><svg class="icon" style="width:2em; height:2em" aria-hidden="true"><use xlink:href="#icon-rabbit"></use></svg></p><p><svg class="icon" style="width:3em; height:3em" aria-hidden="true"><use xlink:href="#icon-dragon_chen"></use></svg><svg class="icon" style="width:4em; height:4em" aria-hidden="true"><use xlink:href="#icon-dragon"></use></svg></p><p><svg class="icon" style="width:5em; height:5em" aria-hidden="true"><use xlink:href="#icon-snake_si"></use></svg><svg class="icon" style="width:6em; height:6em" aria-hidden="true"><use xlink:href="#icon-snake"></use></svg></p><p><svg class="icon" style="width:1em; height:1em" aria-hidden="true"><use xlink:href="#icon-horse_wu"></use></svg><svg class="icon" style="width:2em; height:2em" aria-hidden="true"><use xlink:href="#icon-horse"></use></svg></p><p><svg class="icon" style="width:3em; height:3em" aria-hidden="true"><use xlink:href="#icon-goat_wei"></use></svg><svg class="icon" style="width:4em; height:4em" aria-hidden="true"><use xlink:href="#icon-goat"></use></svg></p><p><svg class="icon" style="width:5em; height:5em" aria-hidden="true"><use xlink:href="#icon-monkey_shen"></use></svg><svg class="icon" style="width:6em; height:6em" aria-hidden="true"><use xlink:href="#icon-monkey"></use></svg></p><p><svg class="icon" style="width:1em; height:1em" aria-hidden="true"><use xlink:href="#icon-rooster_you"></use></svg><svg class="icon" style="width:2em; height:2em" aria-hidden="true"><use xlink:href="#icon-rooster"></use></svg></p><p><svg class="icon" style="width:3em; height:3em" aria-hidden="true"><use xlink:href="#icon-dog_xu"></use></svg><svg class="icon" style="width:4em; height:4em" aria-hidden="true"><use xlink:href="#icon-dog"></use></svg></p><p><svg class="icon" style="width:5em; height:5em" aria-hidden="true"><use xlink:href="#icon-boar_hai"></use></svg><svg class="icon" style="width:6em; height:6em" aria-hidden="true"><use xlink:href="#icon-boar"></use></svg></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-24-ç‰¹æ•ˆæ ‡ç­¾wow">2.24 ç‰¹æ•ˆæ ‡ç­¾wow</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% wow [animete],[duration],[delay],[offset],[iteration] %&#125;</span><br><span class="line">å†…å®¹</span><br><span class="line">&#123;% endwow %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>animate</code>: åŠ¨ç”»æ ·å¼ï¼Œæ•ˆæœè¯¦è§<a href="https://animate.style/">animate.csså‚è€ƒæ–‡æ¡£</a></li><li><code>duration</code>: é€‰å¡«é¡¹ï¼ŒåŠ¨ç”»æŒç»­æ—¶é—´ï¼Œå•ä½å¯ä»¥æ˜¯<code>ms</code>ä¹Ÿå¯ä»¥æ˜¯<code>s</code>ã€‚ä¾‹å¦‚<code>3s</code>ï¼Œ<code>700ms</code>ã€‚</li><li><code>delay</code>: é€‰å¡«é¡¹ï¼ŒåŠ¨ç”»å¼€å§‹çš„å»¶è¿Ÿæ—¶é—´ï¼Œå•ä½å¯ä»¥æ˜¯<code>ms</code>ä¹Ÿå¯ä»¥æ˜¯<code>s</code>ã€‚ä¾‹å¦‚<code>3s</code>ï¼Œ<code>700ms</code>ã€‚</li><li><code>offset</code>: é€‰å¡«é¡¹ï¼Œå¼€å§‹åŠ¨ç”»çš„è·ç¦»ï¼ˆç›¸å¯¹æµè§ˆå™¨åº•éƒ¨ï¼‰</li><li><code>iteration</code>: é€‰å¡«é¡¹ï¼ŒåŠ¨ç”»é‡å¤çš„æ¬¡æ•°</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.flipåŠ¨ç”»æ•ˆæœã€‚</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% wow animate<span class="strong">__zoomIn,5s,5s,100,10 %&#125;</span></span><br><span class="line"><span class="strong">&#123;% note blue &#x27;fas fa-bullhorn&#x27; modern%&#125;</span></span><br><span class="line"><span class="strong">`zoomIn`åŠ¨ç”»æ•ˆæœï¼ŒæŒç»­`5s`ï¼Œå»¶æ—¶`5s`ï¼Œç¦»åº•éƒ¨`100`è·ç¦»æ—¶å¯åŠ¨ï¼Œé‡å¤`10`æ¬¡</span></span><br><span class="line"><span class="strong">&#123;% endnote %&#125;</span></span><br><span class="line"><span class="strong">&#123;% endwow %&#125;</span></span><br></pre></td></tr></table></figure><p>2.zoomInåŠ¨ç”»æ•ˆæœï¼ŒæŒç»­5sï¼Œå»¶æ—¶5sï¼Œç¦»åº•éƒ¨100è·ç¦»æ—¶å¯åŠ¨ï¼Œé‡å¤10æ¬¡</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% wow animate<span class="strong">__zoomIn,5s,5s,100,10 %&#125;</span></span><br><span class="line"><span class="strong">&#123;% note blue &#x27;fas fa-bullhorn&#x27; modern%&#125;</span></span><br><span class="line"><span class="strong">`zoomIn`åŠ¨ç”»æ•ˆæœï¼ŒæŒç»­`5s`ï¼Œå»¶æ—¶`5s`ï¼Œç¦»åº•éƒ¨`100`è·ç¦»æ—¶å¯åŠ¨ï¼Œé‡å¤`10`æ¬¡</span></span><br><span class="line"><span class="strong">&#123;% endnote %&#125;</span></span><br><span class="line"><span class="strong">&#123;% endwow %&#125;</span></span><br></pre></td></tr></table></figure><p>3.slideInRightåŠ¨ç”»æ•ˆæœï¼ŒæŒç»­5sï¼Œå»¶æ—¶5s</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% wow animate<span class="strong">__slideInRight,5s,5s %&#125;</span></span><br><span class="line"><span class="strong">&#123;% note orange &#x27;fas fa-car&#x27; modern%&#125;</span></span><br><span class="line"><span class="strong">`slideInRight`åŠ¨ç”»æ•ˆæœï¼ŒæŒç»­`5s`ï¼Œå»¶æ—¶`5s`ã€‚</span></span><br><span class="line"><span class="strong">&#123;% endnote %&#125;</span></span><br><span class="line"><span class="strong">&#123;% endwow %&#125;</span></span><br></pre></td></tr></table></figure><p>4.heartBeatåŠ¨ç”»æ•ˆæœï¼Œå»¶æ—¶5sï¼Œé‡å¤10æ¬¡ã€‚æ­¤å¤„æ³¨æ„ä¸ç”¨çš„å‚æ•°ä½ç½®è¦ç•™ç©ºï¼Œç”¨é€—å·é—´éš”ã€‚</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% wow animate<span class="strong">__heartBeat,,5s,,10 %&#125;</span></span><br><span class="line"><span class="strong">&#123;% note red &#x27;fas fa-battery-half&#x27; modern%&#125;</span></span><br><span class="line"><span class="strong">`heartBeat`åŠ¨ç”»æ•ˆæœï¼Œå»¶æ—¶`5s`ï¼Œé‡å¤`10`æ¬¡ã€‚</span></span><br><span class="line"><span class="strong">&#123;% endnote %&#125;</span></span><br><span class="line"><span class="strong">&#123;% endwow %&#125;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>1.flipåŠ¨ç”»æ•ˆæœã€‚</p><div class='wow animate__zoomIn' data-wow-duration='5s' data-wow-delay='5s' data-wow-offset='100'  data-wow-iteration='10' ><div class="note blue icon-padding modern"><i class="note-icon fas fa-bullhorn"></i><p><code>zoomIn</code>åŠ¨ç”»æ•ˆæœï¼ŒæŒç»­<code>5s</code>ï¼Œå»¶æ—¶<code>5s</code>ï¼Œç¦»åº•éƒ¨<code>100</code>è·ç¦»æ—¶å¯åŠ¨ï¼Œé‡å¤<code>10</code>æ¬¡</p></div></div><p>2.zoomInåŠ¨ç”»æ•ˆæœï¼ŒæŒç»­5sï¼Œå»¶æ—¶5sï¼Œç¦»åº•éƒ¨100è·ç¦»æ—¶å¯åŠ¨ï¼Œé‡å¤10æ¬¡</p><div class='wow animate__zoomIn' data-wow-duration='5s' data-wow-delay='5s' data-wow-offset='100'  data-wow-iteration='10' ><div class="note blue icon-padding modern"><i class="note-icon fas fa-bullhorn"></i><p><code>zoomIn</code>åŠ¨ç”»æ•ˆæœï¼ŒæŒç»­<code>5s</code>ï¼Œå»¶æ—¶<code>5s</code>ï¼Œç¦»åº•éƒ¨<code>100</code>è·ç¦»æ—¶å¯åŠ¨ï¼Œé‡å¤<code>10</code>æ¬¡</p></div></div><p>3.slideInRightåŠ¨ç”»æ•ˆæœï¼ŒæŒç»­5sï¼Œå»¶æ—¶5s</p><div class='wow animate__slideInRight' data-wow-duration='5s' data-wow-delay='5s' data-wow-offset=''  data-wow-iteration='' ><div class="note orange icon-padding modern"><i class="note-icon fas fa-car"></i><p><code>slideInRight</code>åŠ¨ç”»æ•ˆæœï¼ŒæŒç»­<code>5s</code>ï¼Œå»¶æ—¶<code>5s</code>ã€‚</p></div></div><p>4.heartBeatåŠ¨ç”»æ•ˆæœï¼Œå»¶æ—¶5sï¼Œé‡å¤10æ¬¡ã€‚æ­¤å¤„æ³¨æ„ä¸ç”¨çš„å‚æ•°ä½ç½®è¦ç•™ç©ºï¼Œç”¨é€—å·é—´éš”ã€‚</p><div class='wow animate__heartBeat' data-wow-duration='' data-wow-delay='5s' data-wow-offset=''  data-wow-iteration='10' ><div class="note red icon-padding modern"><i class="note-icon fas fa-battery-half"></i><p><code>heartBeat</code>åŠ¨ç”»æ•ˆæœï¼Œå»¶æ—¶<code>5s</code>ï¼Œé‡å¤<code>10</code>æ¬¡ã€‚</p></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-25-è¿›åº¦æ¡-progress">2.25  è¿›åº¦æ¡ progress</h3><div class="note info flat"><p>è¿›åº¦æ¡æ ‡ç­¾å‚è€ƒ<a href="https://rongbuqiu.com/jdt.html">æ²‚ä½°å­œçŒ«-ç»™HEXOæ–‡ç« æ·»åŠ å½©è‰²è¿›åº¦æ¡</a>ã€‚<br>æºæ ·å¼æå–è‡ª<a href="https://zwying0814.gitbook.io/cuteen/">Cuteen</a>ä¸»é¢˜ã€‚</p></div><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% progress [width] [color] [text] %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>width</code>: 0åˆ°100çš„é˜¿æ‹‰ä¼¯æ•°å­—</li><li><code>color</code>: é¢œè‰²ï¼Œå–å€¼æœ‰red,yellow,green,cyan,blue,gray</li><li><code>text</code>:è¿›åº¦æ¡ä¸Šçš„æ–‡å­—å†…å®¹</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% progress 10 red è¿›åº¦æ¡æ ·å¼é¢„è§ˆ %&#125;</span><br><span class="line">&#123;% progress 30 yellow è¿›åº¦æ¡æ ·å¼é¢„è§ˆ %&#125;</span><br><span class="line">&#123;% progress 50 green è¿›åº¦æ¡æ ·å¼é¢„è§ˆ %&#125;</span><br><span class="line">&#123;% progress 70 cyan è¿›åº¦æ¡æ ·å¼é¢„è§ˆ %&#125;</span><br><span class="line">&#123;% progress 90 blue è¿›åº¦æ¡æ ·å¼é¢„è§ˆ %&#125;</span><br><span class="line">&#123;% progress 100 gray è¿›åº¦æ¡æ ·å¼é¢„è§ˆ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-red"  style="width: 10%" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100"><p>è¿›åº¦æ¡æ ·å¼é¢„è§ˆ</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-yellow"  style="width: 30%" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"><p>è¿›åº¦æ¡æ ·å¼é¢„è§ˆ</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-green"  style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"><p>è¿›åº¦æ¡æ ·å¼é¢„è§ˆ</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-cyan"  style="width: 70%" aria-valuenow="70" aria-valuemin="0" aria-valuemax="100"><p>è¿›åº¦æ¡æ ·å¼é¢„è§ˆ</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-blue"  style="width: 90%" aria-valuenow="90" aria-valuemin="0" aria-valuemax="100"><p>è¿›åº¦æ¡æ ·å¼é¢„è§ˆ</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-gray"  style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"><p>è¿›åº¦æ¡æ ·å¼é¢„è§ˆ</p></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-26-æ³¨é‡Š-notation">2.26 æ³¨é‡Š notation</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% nota [label] , [text] %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><p><code>label</code>: æ³¨é‡Šè¯æ±‡</p></li><li><p><code>text</code>: æ‚¬åœæ˜¾ç¤ºçš„æ³¨è§£å†…å®¹</p></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% nota æŠŠé¼ æ ‡ç§»åŠ¨åˆ°æˆ‘ä¸Šé¢è¯•è¯• ,å¯ä»¥çœ‹åˆ°æ³¨è§£å†…å®¹å‡ºç°åœ¨é¡¶æ  %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p><span class='nota' data-nota='å¯ä»¥çœ‹åˆ°æ³¨è§£å†…å®¹å‡ºç°åœ¨é¡¶æ '>æŠŠé¼ æ ‡ç§»åŠ¨åˆ°æˆ‘ä¸Šé¢è¯•è¯•</span></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-27-æ°”æ³¡æ³¨é‡Š-bubble">2.27 æ°”æ³¡æ³¨é‡Š bubble</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% bubble [content] , [notation] ,[background-color] %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>content</code>: æ³¨é‡Šè¯æ±‡</li><li><code>notation</code>: æ‚¬åœæ˜¾ç¤ºçš„æ³¨è§£å†…å®¹</li><li><code>background-color</code>: å¯é€‰ï¼Œæ°”æ³¡èƒŒæ™¯è‰²ã€‚é»˜è®¤ä¸ºâ€œ#71a4e3â€</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æœ€è¿‘æˆ‘å­¦åˆ°äº†ä¸å°‘æ–°ç©æ„å„¿ï¼ˆè™½ç„¶å¯¹å¾ˆå¤šå¤§ä½¬æ¥è¯´è¿™äº›å·²ç»æ˜¯æ—§æŠ€æœ¯äº†ï¼‰ï¼Œæ¯”å¦‚CSSçš„&#123;% bubble å…„å¼Ÿç›¸é‚»é€‰æ‹©å™¨,&quot;ä¾‹å¦‚ h1 + p &#123;margin-top:50px;&#125;&quot; %&#125;ï¼Œ&#123;% bubble flexå¸ƒå±€,&quot;Flex æ˜¯ Flexible Box çš„ç¼©å†™ï¼Œæ„ä¸º&quot;å¼¹æ€§å¸ƒå±€&quot;ï¼Œç”¨æ¥ä¸ºç›’çŠ¶æ¨¡å‹æä¾›æœ€å¤§çš„çµæ´»æ€§&quot;,&quot;#ec5830&quot; %&#125;ï¼Œ&#123;% bubble transformå˜æ¢,&quot;transform å±æ€§å‘å…ƒç´ åº”ç”¨ 2D æˆ– 3D è½¬æ¢ã€‚è¯¥å±æ€§å…è®¸æˆ‘ä»¬å¯¹å…ƒç´ è¿›è¡Œæ—‹è½¬ã€ç¼©æ”¾ã€ç§»åŠ¨æˆ–å€¾æ–œã€‚&quot;,&quot;#1db675&quot; %&#125;ï¼Œanimationçš„&#123;% bubble è´å¡å°”é€Ÿåº¦æ›²çº¿,&quot;è´å¡å°”æ›²çº¿(BÃ©zier curve)ï¼Œåˆç§°è´å…¹æ›²çº¿æˆ–è´æµåŸƒæ›²çº¿ï¼Œæ˜¯åº”ç”¨äºäºŒç»´å›¾å½¢åº”ç”¨ç¨‹åºçš„æ•°å­¦æ›²çº¿ã€‚ä¸€èˆ¬çš„çŸ¢é‡å›¾å½¢è½¯ä»¶é€šè¿‡å®ƒæ¥ç²¾ç¡®ç”»å‡ºæ›²çº¿ï¼Œè´å…¹æ›²çº¿ç”±çº¿æ®µä¸èŠ‚ç‚¹ç»„æˆï¼ŒèŠ‚ç‚¹æ˜¯å¯æ‹–åŠ¨çš„æ”¯ç‚¹ï¼Œçº¿æ®µåƒå¯ä¼¸ç¼©çš„çš®ç­‹&quot;,&quot;#de4489&quot; %&#125;å†™æ³•ï¼Œè¿˜æœ‰ä»Šå¤©åˆšçœ‹åˆ°çš„&#123;% bubble clip-path,&quot;clip-pathå±æ€§ä½¿ç”¨è£å‰ªæ–¹å¼åˆ›å»ºå…ƒç´ çš„å¯æ˜¾ç¤ºåŒºåŸŸã€‚åŒºåŸŸå†…çš„éƒ¨åˆ†æ˜¾ç¤ºï¼ŒåŒºåŸŸå¤–çš„éšè—ã€‚&quot;,&quot;#868fd7&quot; %&#125;å±æ€§ã€‚è¿™äº›å¯¹æˆ‘æ¥è¯´å¾ˆæ–°é¢–çš„æ¦‚å¿µç‹ ç‹ çš„å†²å‡»ç€æˆ‘ä»¥å‰ç§¯ç´¯èµ·æ¥çš„è®¾è®¡æ€è·¯ã€‚</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>æœ€è¿‘æˆ‘å­¦åˆ°äº†ä¸å°‘æ–°ç©æ„å„¿ï¼ˆè™½ç„¶å¯¹å¾ˆå¤šå¤§ä½¬æ¥è¯´è¿™äº›å·²ç»æ˜¯æ—§æŠ€æœ¯äº†ï¼‰ï¼Œæ¯”å¦‚CSSçš„<span class="bubble-content">å…„å¼Ÿç›¸é‚»é€‰æ‹©å™¨</span><span class="bubble-notation"><span class="bubble-item" style="background-color:#71a4e3;">ä¾‹å¦‚ h1 + p {margin-top:50px;}</span></span>ï¼Œ<span class="bubble-content">flexå¸ƒå±€</span><span class="bubble-notation"><span class="bubble-item" style="background-color:#ec5830;">Flex æ˜¯ Flexible Box çš„ç¼©å†™ï¼Œæ„ä¸ºå¼¹æ€§å¸ƒå±€&quot;ï¼Œç”¨æ¥ä¸ºç›’çŠ¶æ¨¡å‹æä¾›æœ€å¤§çš„çµæ´»æ€§&quot;</span></span>ï¼Œ<span class="bubble-content">transformå˜æ¢</span><span class="bubble-notation"><span class="bubble-item" style="background-color:#1db675;">transform å±æ€§å‘å…ƒç´ åº”ç”¨ 2D æˆ– 3D è½¬æ¢ã€‚è¯¥å±æ€§å…è®¸æˆ‘ä»¬å¯¹å…ƒç´ è¿›è¡Œæ—‹è½¬ã€ç¼©æ”¾ã€ç§»åŠ¨æˆ–å€¾æ–œã€‚</span></span>ï¼Œanimationçš„<span class="bubble-content">è´å¡å°”é€Ÿåº¦æ›²çº¿</span><span class="bubble-notation"><span class="bubble-item" style="background-color:#de4489;">è´å¡å°”æ›²çº¿(BÃ©zier curve)ï¼Œåˆç§°è´å…¹æ›²çº¿æˆ–è´æµåŸƒæ›²çº¿ï¼Œæ˜¯åº”ç”¨äºäºŒç»´å›¾å½¢åº”ç”¨ç¨‹åºçš„æ•°å­¦æ›²çº¿ã€‚ä¸€èˆ¬çš„çŸ¢é‡å›¾å½¢è½¯ä»¶é€šè¿‡å®ƒæ¥ç²¾ç¡®ç”»å‡ºæ›²çº¿ï¼Œè´å…¹æ›²çº¿ç”±çº¿æ®µä¸èŠ‚ç‚¹ç»„æˆï¼ŒèŠ‚ç‚¹æ˜¯å¯æ‹–åŠ¨çš„æ”¯ç‚¹ï¼Œçº¿æ®µåƒå¯ä¼¸ç¼©çš„çš®ç­‹</span></span>å†™æ³•ï¼Œè¿˜æœ‰ä»Šå¤©åˆšçœ‹åˆ°çš„<span class="bubble-content">clip-path</span><span class="bubble-notation"><span class="bubble-item" style="background-color:#868fd7;">clip-pathå±æ€§ä½¿ç”¨è£å‰ªæ–¹å¼åˆ›å»ºå…ƒç´ çš„å¯æ˜¾ç¤ºåŒºåŸŸã€‚åŒºåŸŸå†…çš„éƒ¨åˆ†æ˜¾ç¤ºï¼ŒåŒºåŸŸå¤–çš„éšè—ã€‚</span></span>å±æ€§ã€‚è¿™äº›å¯¹æˆ‘æ¥è¯´å¾ˆæ–°é¢–çš„æ¦‚å¿µç‹ ç‹ çš„å†²å‡»ç€æˆ‘ä»¥å‰ç§¯ç´¯èµ·æ¥çš„è®¾è®¡æ€è·¯ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-28-å¼•ç”¨æ–‡çŒ®-reference">2.28 å¼•ç”¨æ–‡çŒ® reference</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% referto [id] , [literature] %&#125;</span><br><span class="line">&#123;% referfrom [id] , [literature] , [url] %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><p>referto å¼•ç”¨ä¸Šæ ‡</p><ul><li><p><code>id</code>: ä¸Šæ ‡åºå·å†…å®¹ï¼Œéœ€ä¸referfromæ ‡ç­¾çš„idå¯¹åº”æ‰èƒ½å®ç°è·³è½¬</p></li><li><p><code>literature</code>: å¼•ç”¨çš„å‚è€ƒæ–‡çŒ®åç§°</p></li></ul></li><li><p>referfrom å¼•ç”¨å‡ºå¤„</p><ul><li><p><code>id</code>: åºå·å†…å®¹ï¼Œéœ€ä¸refertoæ ‡ç­¾çš„idå¯¹åº”æ‰èƒ½å®ç° è·³è½¬</p></li><li><p><code>literature</code>: å¼•ç”¨çš„å‚è€ƒæ–‡çŒ®åç§°</p></li><li><p><code>url</code>: å¼•ç”¨çš„å‚è€ƒæ–‡çŒ®é“¾æ¥ï¼Œå¯çœç•¥</p></li></ul></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Akilarã®ç³–æœå±‹(akilar.top)æ˜¯ä¸€ä¸ªç§äººæ€§è´¨çš„åšå®¢&#123;% referto &#x27;[1]&#x27;,&#x27;Akilarã®ç³–æœå±‹ç¾¤èŠç®€ä»‹&#x27; %&#125;ï¼Œä»å„ç±»æ•™ç¨‹è‡³ç”Ÿæ´»ç‚¹æ»´ï¼Œæ— è¯ä¸è°ˆã€‚å»ºç¾¤çš„ç›®çš„æ˜¯æä¾›ä¸€ä¸ªé—²èŠçš„åœºæ‰€ã€‚åšå®¢é‡‡ç”¨Hexoæ¡†æ¶&#123;% referto &#x27;[2]&#x27;,&#x27;Hexoä¸­æ–‡æ–‡æ¡£&#x27; %&#125;ï¼ŒButterflyä¸»é¢˜&#123;% referto &#x27;[3]&#x27;,&#x27;Butterfly å®‰è£…æ–‡æ¡£(ä¸€) å¿«é€Ÿå¼€å§‹&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">æœ¬é¡¹ç›®å‚è€ƒäº†Volantis&#123;% referto &#x27;[4]&#x27;,&#x27;hexo-theme-volantis æ ‡ç­¾æ’ä»¶&#x27; %&#125;çš„æ ‡ç­¾æ ·å¼ã€‚å¼•å…¥<span class="code">`[tag].js`</span>ï¼Œå¹¶é’ˆå¯¹<span class="code">`butterfly`</span>ä¸»é¢˜ä¿®æ”¹äº†ç›¸åº”çš„<span class="code">`[tag].styl`</span>ã€‚åœ¨æ­¤é¸£è°¢<span class="code">`Volantis`</span>ä¸»é¢˜ä¼—å¼€å‘è€…ã€‚</span><br><span class="line">ä¸»è¦å‚è€ƒå†…å®¹åŒ…æ‹¬å„ä¸ªvolantisçš„å†…ç½®æ ‡ç­¾æ’ä»¶æ–‡æ¡£&#123;% referto &#x27;[5]&#x27;,&#x27;Volantisæ–‡æ¡£:å†…ç½®æ ‡ç­¾æ’ä»¶&#x27; %&#125;</span><br><span class="line">Butterflyä¸»é¢˜çš„å„ä¸ªè¡ç”Ÿé­”æ”¹&#123;% referto &#x27;[6]&#x27;,&#x27;Butterfly å®‰è£…æ–‡æ¡£:æ ‡ç­¾å¤–æŒ‚ï¼ˆTag Plugins&#x27; %&#125;&#123;% referto &#x27;[7]&#x27;,&#x27;å°å¼‹ã®ç”Ÿæ´»é¦†å…¨æ ·å¼é¢„è§ˆ&#x27; %&#125;&#123;% referto &#x27;[8]&#x27;,&#x27;l-lin-font-awesome-animation&#x27; %&#125;&#123;% referto &#x27;[9]&#x27;,&#x27;å°åº·çš„butterflyä¸»é¢˜ä½¿ç”¨æ–‡æ¡£&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% referfrom &#x27;[1]&#x27;,&#x27;Akilarã®ç³–æœå±‹ç¾¤èŠç®€ä»‹&#x27;,&#x27;https://jq.qq.com/?<span class="emphasis">_wv=1027&amp;k=pGLB2C0N&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[2]&#x27;,&#x27;Hexoä¸­æ–‡æ–‡æ¡£&#x27;,&#x27;https://hexo.io/zh-cn/docs/&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[3]&#x27;,&#x27;Butterfly å®‰è£…æ–‡æ¡£(ä¸€) å¿«é€Ÿå¼€å§‹&#x27;,&#x27;https://butterfly.js.org/posts/21cfbf15/&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[4]&#x27;,&#x27;hexo-theme-volantis æ ‡ç­¾æ’ä»¶&#x27;,&#x27;https://volantis.js.org/v5/tag-plugins/&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[5]&#x27;,&#x27;Volantisæ–‡æ¡£:å†…ç½®æ ‡ç­¾æ’ä»¶&#x27;,&#x27;https://volantis.js.org/tag-plugins/&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[6]&#x27;,&#x27;Butterfly å®‰è£…æ–‡æ¡£:æ ‡ç­¾å¤–æŒ‚ï¼ˆTag Plugins&#x27;,&#x27;https://butterfly.js.org/posts/4aa8abbe/#%E6%A8%99%E7%B1%A4%E5%A4%96%E6%8E%9B%EF%BC%88Tag-Plugins%EF%BC%89&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[7]&#x27;,&#x27;å°å¼‹ã®ç”Ÿæ´»é¦†å…¨æ ·å¼é¢„è§ˆ&#x27;,&#x27;https://lovelijunyi.gitee.io/posts/c898.html&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[8]&#x27;,&#x27;l-lin-font-awesome-animation&#x27;,&#x27;https://github.com/l-lin/font-awesome-animation&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[9]&#x27;,&#x27;å°åº·çš„butterflyä¸»é¢˜ä½¿ç”¨æ–‡æ¡£&#x27;,&#x27;https://www.antmoe.com/posts/3b43914f/&#x27; %&#125;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>Akilarã®ç³–æœå±‹(akilar.top)æ˜¯ä¸€ä¸ªç§äººæ€§è´¨çš„åšå®¢<span class="hidden-anchor" id="referto_[1]"></span><sup class="reference"><a href="#referfrom_[1]">[1]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">Akilarã®ç³–æœå±‹ç¾¤èŠç®€ä»‹</span><span class="reference-title">å‚è€ƒèµ„æ–™</span></span></span>ï¼Œä»å„ç±»æ•™ç¨‹è‡³ç”Ÿæ´»ç‚¹æ»´ï¼Œæ— è¯ä¸è°ˆã€‚å»ºç¾¤çš„ç›®çš„æ˜¯æä¾›ä¸€ä¸ªé—²èŠçš„åœºæ‰€ã€‚åšå®¢é‡‡ç”¨Hexoæ¡†æ¶<span class="hidden-anchor" id="referto_[2]"></span><sup class="reference"><a href="#referfrom_[2]">[2]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">Hexoä¸­æ–‡æ–‡æ¡£</span><span class="reference-title">å‚è€ƒèµ„æ–™</span></span></span>ï¼ŒButterflyä¸»é¢˜<span class="hidden-anchor" id="referto_[3]"></span><sup class="reference"><a href="#referfrom_[3]">[3]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">Butterfly å®‰è£…æ–‡æ¡£(ä¸€) å¿«é€Ÿå¼€å§‹</span><span class="reference-title">å‚è€ƒèµ„æ–™</span></span></span></p><p>æœ¬é¡¹ç›®å‚è€ƒäº†Volantis<span class="hidden-anchor" id="referto_[4]"></span><sup class="reference"><a href="#referfrom_[4]">[4]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">hexo-theme-volantis æ ‡ç­¾æ’ä»¶</span><span class="reference-title">å‚è€ƒèµ„æ–™</span></span></span>çš„æ ‡ç­¾æ ·å¼ã€‚å¼•å…¥<code>[tag].js</code>ï¼Œå¹¶é’ˆå¯¹<code>butterfly</code>ä¸»é¢˜ä¿®æ”¹äº†ç›¸åº”çš„<code>[tag].styl</code>ã€‚åœ¨æ­¤é¸£è°¢<code>Volantis</code>ä¸»é¢˜ä¼—å¼€å‘è€…ã€‚<br>ä¸»è¦å‚è€ƒå†…å®¹åŒ…æ‹¬å„ä¸ªvolantisçš„å†…ç½®æ ‡ç­¾æ’ä»¶æ–‡æ¡£<span class="hidden-anchor" id="referto_[5]"></span><sup class="reference"><a href="#referfrom_[5]">[5]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">Volantisæ–‡æ¡£:å†…ç½®æ ‡ç­¾æ’ä»¶</span><span class="reference-title">å‚è€ƒèµ„æ–™</span></span></span><br>Butterflyä¸»é¢˜çš„å„ä¸ªè¡ç”Ÿé­”æ”¹<span class="hidden-anchor" id="referto_[6]"></span><sup class="reference"><a href="#referfrom_[6]">[6]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">Butterfly å®‰è£…æ–‡æ¡£:æ ‡ç­¾å¤–æŒ‚ï¼ˆTag Plugins</span><span class="reference-title">å‚è€ƒèµ„æ–™</span></span></span><span class="hidden-anchor" id="referto_[7]"></span><sup class="reference"><a href="#referfrom_[7]">[7]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">å°å¼‹ã®ç”Ÿæ´»é¦†å…¨æ ·å¼é¢„è§ˆ</span><span class="reference-title">å‚è€ƒèµ„æ–™</span></span></span><span class="hidden-anchor" id="referto_[8]"></span><sup class="reference"><a href="#referfrom_[8]">[8]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">l-lin-font-awesome-animation</span><span class="reference-title">å‚è€ƒèµ„æ–™</span></span></span><span class="hidden-anchor" id="referto_[9]"></span><sup class="reference"><a href="#referfrom_[9]">[9]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">å°åº·çš„butterflyä¸»é¢˜ä½¿ç”¨æ–‡æ¡£</span><span class="reference-title">å‚è€ƒèµ„æ–™</span></span></span></p><div class="reference-source"><span class="hidden-anchor" id="referfrom_[1]"></span><a class="reference-anchor" href="#referto_[1]">[1]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://jq.qq.com/?_wv=1027&k=pGLB2C0N">Akilarã®ç³–æœå±‹ç¾¤èŠç®€ä»‹</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[2]"></span><a class="reference-anchor" href="#referto_[2]">[2]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://hexo.io/zh-cn/docs/">Hexoä¸­æ–‡æ–‡æ¡£</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[3]"></span><a class="reference-anchor" href="#referto_[3]">[3]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://butterfly.js.org/posts/21cfbf15/">Butterfly å®‰è£…æ–‡æ¡£(ä¸€) å¿«é€Ÿå¼€å§‹</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[4]"></span><a class="reference-anchor" href="#referto_[4]">[4]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://volantis.js.org/v5/tag-plugins/">hexo-theme-volantis æ ‡ç­¾æ’ä»¶</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[5]"></span><a class="reference-anchor" href="#referto_[5]">[5]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://volantis.js.org/tag-plugins/">Volantisæ–‡æ¡£:å†…ç½®æ ‡ç­¾æ’ä»¶</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[6]"></span><a class="reference-anchor" href="#referto_[6]">[6]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://butterfly.js.org/posts/4aa8abbe/#%E6%A8%99%E7%B1%A4%E5%A4%96%E6%8E%9B%EF%BC%88Tag-Plugins%EF%BC%89">Butterfly å®‰è£…æ–‡æ¡£:æ ‡ç­¾å¤–æŒ‚ï¼ˆTag Plugins</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[7]"></span><a class="reference-anchor" href="#referto_[7]">[7]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://lovelijunyi.gitee.io/posts/c898.html">å°å¼‹ã®ç”Ÿæ´»é¦†å…¨æ ·å¼é¢„è§ˆ</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[8]"></span><a class="reference-anchor" href="#referto_[8]">[8]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://github.com/l-lin/font-awesome-animation">l-lin-font-awesome-animation</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[9]"></span><a class="reference-anchor" href="#referto_[9]">[9]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://www.antmoe.com/posts/3b43914f/">å°åº·çš„butterflyä¸»é¢˜ä½¿ç”¨æ–‡æ¡£</a></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-29-PDFå±•ç¤º">2.29 PDFå±•ç¤º</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% pdf æ–‡ä»¶è·¯å¾„ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>æ–‡ä»¶è·¯å¾„</code>: å¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„æˆ–è€…æ˜¯åœ¨çº¿é“¾æ¥</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 1.æœ¬åœ°æ–‡ä»¶:åœ¨mdæ–‡ä»¶è·¯å¾„ä¸‹åˆ›å»ºä¸€ä¸ªåŒåæ–‡ä»¶å¤¹ï¼Œå…¶å†…æ”¾pdfæ–‡ä»¶åä¸ºxxx.pdfçš„æ–‡ä»¶</span></span><br><span class="line">&#123;% pdf xxx.pdf %&#125;</span><br><span class="line"><span class="section"># 2.åœ¨çº¿é“¾æ¥</span></span><br><span class="line">&#123;% pdf https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/pdf/å°ä½œæ–‡è®²ä¹‰.pdf %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>2.åœ¨çº¿é“¾æ¥(è¦æ”¾åˆ°æœ€å¤–å±‚æ‰èƒ½èµ·ä½œç”¨)</p><pre><code>&lt;div class=&quot;row&quot;&gt;&lt;embed src=&quot;https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/pdf/å°ä½œæ–‡è®²ä¹‰.pdf&quot; width=&quot;100%&quot; height=&quot;550&quot; type=&quot;application/pdf&quot;&gt;&lt;/div&gt;</code></pre><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-30-Hexo-tag-map-æ’ä»¶">2.30 Hexo-tag-map æ’ä»¶</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% + æ ‡ç­¾å€¼ + ç»åº¦ + çº¬åº¦ + æ–‡æœ¬ + ç¼©æ”¾ç­‰çº§ + å®½ + é«˜ + é»˜è®¤å›¾å±‚ + %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><table><thead><tr><th style="text-align:center">åœ°å›¾å</th><th style="text-align:center">æ ‡ç­¾å€¼ &lt;å¿…å¡«&gt;</th><th style="text-align:center">å®½ (é»˜è®¤ 100%) / é«˜ (é»˜è®¤ 360px)</th><th style="text-align:center">ç¼©æ”¾ç­‰çº§ (é»˜è®¤ 14)</th><th style="text-align:center">å®½ (é»˜è®¤ 100%) / é«˜ (é»˜è®¤ 360px)</th><th style="text-align:center">é»˜è®¤å›¾å±‚ (é»˜è®¤ 1)</th></tr></thead><tbody><tr><td style="text-align:center">æ··åˆåœ°å›¾</td><td style="text-align:center">map</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 3~18</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 1~7</td></tr><tr><td style="text-align:center">è°·æ­Œåœ°å›¾</td><td style="text-align:center">googleMap</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 1~20</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 1~3</td></tr><tr><td style="text-align:center">é«˜å¾·åœ°å›¾</td><td style="text-align:center">gaodeMap</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 3~18</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 1~3</td></tr><tr><td style="text-align:center">ç™¾åº¦åœ°å›¾</td><td style="text-align:center">baiduMap</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 4~18</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 1~2</td></tr><tr><td style="text-align:center">Geoq åœ°å›¾</td><td style="text-align:center">geoqMap</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 1~18</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 1~5</td></tr><tr><td style="text-align:center">openstreet åœ°å›¾</td><td style="text-align:center">openstreetMap</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 1~18</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">ä¸æ”¯æŒæ­¤å‚æ•°</td></tr></tbody></table><ol><li>å‚æ•°ä¹‹é—´ï¼Œç”¨è‹±æ–‡é€—å·ç›¸éš”</li><li>å‚æ•°å¿…é¡»æŒ‰ä¸Šè¿°äº‹ä¾‹é¡ºåºè¾“å…¥ï¼Œä¸å¾—ä¸ºç©º</li><li>åŒä¸€ä¸ªé¡µé¢ï¼ŒåŒä¸€ç»„ç»çº¬åº¦å€¼ï¼Œåªèƒ½æ’å…¥ä¸€ä¸ªç›¸åŒæ ‡ç­¾å€¼çš„åœ°å›¾ (è‹¥æœ‰éœ€è¦ï¼Œå¯ä»¥å°†ç¬¬äºŒä¸ªåœ°å›¾ä¸Šï¼Œç»åº¦æˆ–çº¬åº¦æœ«å°¾åˆ é™¤ä¸€ä¸¤ä¸ªæ•°)</li><li>å‚æ•°å–å€¼å¿…é¡»åœ¨ä¸Šè¿°èŒƒå›´å†…</li><li>é»˜è®¤å›¾å±‚ï¼šå³åœ°å›¾å åŠ å±‚çš„å€¼ï¼Œé»˜è®¤å¸¸è§„åœ°å›¾è¿˜æ˜¯å«æ˜Ÿåœ°å›¾ï¼Œå¯æŒ‰åœ°å›¾æ˜¾ç¤ºé¡ºåºå–å€¼</li><li>ç¼©æ”¾ç­‰çº§ï¼Œæ•°å­—è¶Šå¤§ï¼Œåœ°å›¾æ¯”ä¾‹å°ºè¶Šå°ï¼Œæ˜¾ç¤ºçš„è¶Šç²¾ç»†</li><li>é™¤æ ‡ç­¾å€¼å¤–ï¼Œå…¶ä»–å‚æ•°é€‰å¡«ï¼Œä½† æ¯ä¸ªå‚æ•°çš„å·¦è¾¹çš„å‚æ•°å¿…å¡«</li><li>è°·æ­Œåœ°å›¾éœ€è¦å¤–ç½‘æ‰èƒ½åŠ è½½æŸ¥çœ‹</li></ol><p>åæ ‡è·å–ï¼š<a href="https://lbs.amap.com/tools/picker">é«˜å¾·åœ°å›¾åæ ‡æ‹¾å–ç³»ç»Ÿ</a> ã€<a href="https://api.map.baidu.com/lbsapi/getpoint/index.html">ç™¾åº¦åœ°å›¾åæ ‡æ‹¾å–ç³»ç»Ÿ</a></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% map 120.101101,30.239119 %&#125;</span><br><span class="line">&#123;% googleMap 120.101101,30.239119, è¿™é‡Œæ˜¯è¥¿æ¹–çµéšå¯ºï¼Œæ®è¯´æ±‚å§»ç¼˜å¾ˆçµéªŒå“¦ï¼ %&#125;</span><br><span class="line">&#123;% geoqMap 120.101101,30.239119, è¿™é‡Œæ˜¯è¥¿æ¹–çµéšå¯ºï¼Œæ®è¯´æ±‚å§»ç¼˜å¾ˆçµéªŒå“¦ï¼, 13, 90%, 320px, 3 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-tag-map/lib/leaflet@1.7.1.css"><script data-pjax src="https://cdn.jsdelivr.net/npm/hexo-tag-map/lib/leaflet@1.7.1.js"></script><script data-pjax src="https://cdn.jsdelivr.net/npm/hexo-tag-map/lib/leaflet.ChineseTmsProviders@1.0.4.js"></script><div class="map-box"><div id="map-120.101101-30.239119" style="max-width:100%; height:360px;display: block;margin:0 auto;z-index:1;border-radius: 5px;"></div></div><script type="text/javascript">var normalm=L.tileLayer.chinaProvider('GaoDe.Normal.Map',{maxZoom:20,minZoom:1,attribution:'Amap'});var imgm=L.tileLayer.chinaProvider('GaoDe.Satellite.Map',{maxZoom:20,minZoom:1,attribution:'Amap'});var imga=L.tileLayer.chinaProvider('GaoDe.Satellite.Annotion',{maxZoom:20,minZoom:1,attribution:'Amap'});var normalMap=L.tileLayer.chinaProvider('Google.Normal.Map',{maxZoom:20,minZoom:1,attribution:'Google Maps'}),satelliteMap=L.tileLayer.chinaProvider('Google.Satellite.Map',{maxZoom:21,minZoom:1,attribution:'Google Maps'});routeMap=L.tileLayer.chinaProvider('Google.Satellite.Annotion',{maxZoom:21,minZoom:1});var normalMap=L.tileLayer.chinaProvider('Google.Normal.Map',{maxZoom:21,minZoom:1,attribution:'Google Maps'}),satelliteMap=L.tileLayer.chinaProvider('Google.Satellite.Map',{maxZoom:21,minZoom:1,attribution:'Google Maps'}),routeMap=L.tileLayer.chinaProvider('Google.Satellite.Annotion',{maxZoom:21,minZoom:1,attribution:'Google Maps'});var normalm1=L.tileLayer.chinaProvider('Geoq.Normal.Map',{maxZoom:21,minZoom:1,attribution:'GeoQ'});var normal=L.layerGroup([normalm]),image=L.layerGroup([imgm,imga]);var baseLayers={"é«˜å¾·åœ°å›¾":normal,"æ™ºå›¾åœ°å›¾":normalm1,"è°·æ­Œåœ°å›¾":normalMap,"é«˜å¾·å«æ˜Ÿåœ°å›¾":imgm,"è°·æ­Œå«æ˜Ÿåœ°å›¾":satelliteMap,"é«˜å¾·å«æ˜Ÿæ ‡æ³¨":image,"è°·æ­Œå«æ˜Ÿæ ‡æ³¨":routeMap};var mymap=L.map('map-120.101101-30.239119',{center:[30.239119,120.101101],zoom:14,layers:[normal],zoomControl:false});L.control.layers(baseLayers,null).addTo(mymap);L.control.zoom({zoomInTitle:'æ”¾å¤§',zoomOutTitle:'ç¼©å°'}).addTo(mymap);</script><br><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-tag-map/lib/leaflet@1.7.1.css"><script data-pjax src="https://cdn.jsdelivr.net/npm/hexo-tag-map/lib/leaflet@1.7.1.js"></script><script data-pjax src="https://cdn.jsdelivr.net/npm/hexo-tag-map/lib/leaflet.ChineseTmsProviders@1.0.4.js"></script><div id="googleMap-120.101101-30.239119" style="max-width:100%; height:360px;display: block;margin:0 auto;z-index:1;border-radius: 5px;"></div><script type="text/javascript">var normalMap=L.tileLayer.chinaProvider('Google.Normal.Map',{maxZoom:22,minZoom:1,attribution:'Google Maps'}),satelliteMap=L.tileLayer.chinaProvider('Google.Satellite.Map',{maxZoom:22,minZoom:1,attribution:'Google Maps'}),routeMap=L.tileLayer.chinaProvider('Google.Satellite.Annotion',{maxZoom:22,minZoom:1,attribution:'Google Maps'});var baseLayers={"è°·æ­Œåœ°å›¾":normalMap,"è°·æ­Œå«æ˜Ÿå›¾":satelliteMap,"è°·æ­Œå«æ˜Ÿæ ‡æ³¨": routeMap};var overlayLayers={};var mymap=L.map("googleMap-120.101101-30.239119",{center:[30.239119,120.101101],zoom:14,layers:[normalMap],zoomControl:false});L.control.layers(baseLayers,null).addTo(mymap);L.control.zoom({zoomInTitle:'æ”¾å¤§',zoomOutTitle:'ç¼©å°'}).addTo(mymap);var marker = L.marker(['30.239119','120.101101']).addTo(mymap);marker.bindPopup("è¿™é‡Œæ˜¯è¥¿æ¹–çµéšå¯ºï¼Œæ®è¯´æ±‚å§»ç¼˜å¾ˆçµéªŒå“¦ï¼").openPopup();</script><br><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-tag-map/lib/leaflet@1.7.1.css"><script data-pjax src="https://cdn.jsdelivr.net/npm/hexo-tag-map/lib/leaflet@1.7.1.js"></script><script data-pjax src="https://cdn.jsdelivr.net/npm/hexo-tag-map/lib/leaflet.ChineseTmsProviders@1.0.4.js"></script><div id="geoqMap-120.101101-30.239119" style="max-width:90%; height:320px;display: block;margin:0 auto;z-index:1;border-radius: 5px;"></div><script type="text/javascript">var normalm1=L.tileLayer.chinaProvider('Geoq.Normal.Map',{maxZoom:20,minZoom:1,attribution:'GeoQ'});var normalm2=L.tileLayer.chinaProvider('Geoq.Normal.PurplishBlue',{maxZoom:20,minZoom:1,attribution:'GeoQ'});var normalm3=L.tileLayer.chinaProvider('Geoq.Normal.Gray',{maxZoom:20,minZoom:1,attribution:'GeoQ'});var normalm4=L.tileLayer.chinaProvider('Geoq.Normal.Warm',{maxZoom:20,minZoom:1,attribution:'GeoQ'});var normalm5=L.tileLayer.chinaProvider('Geoq.Theme.Hydro',{maxZoom:20,minZoom:1,attribution:'GeoQ'});var normal=L.layerGroup([normalm1,normalm2,normalm3,normalm4,normalm5]);var baseLayers={"æ™ºå›¾åœ°å›¾":normalm1,"åˆå¤œè“":normalm2,"ç°è‰²":normalm3,"æš–è‰²":normalm4,"æ°´ç³»":normalm5};var mymap=L.map("geoqMap-120.101101-30.239119",{center:[30.239119,120.101101],zoom:13,layers:[normalm3],zoomControl:false});L.control.layers(baseLayers,null).addTo(mymap);L.control.zoom({zoomInTitle:'æ”¾å¤§',zoomOutTitle:'ç¼©å°'}).addTo(mymap);var marker = L.marker(['30.239119','120.101101']).addTo(mymap);marker.bindPopup("è¿™é‡Œæ˜¯è¥¿æ¹–çµéšå¯ºï¼Œæ®è¯´æ±‚å§»ç¼˜å¾ˆçµéªŒå“¦ï¼").openPopup();</script><br><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-31-éšè—å—">2.31 éšè—å—</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% hideBlock display,bg,color %&#125;</span><br><span class="line">content</span><br><span class="line">&#123;% endhideBlock %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li>contentï¼šè¦éšè—çš„å†…å®¹</li><li>displayï¼šå±•ç¤ºå‰æŒ‰é’®æ˜¾ç¤ºçš„æ–‡å­—ï¼ˆå¯é€‰ï¼‰</li><li>bgï¼šæŒ‰é’®çš„èƒŒæ™¯é¢œè‰²ï¼ˆå¯é€‰ï¼‰</li><li>colorï¼šæŒ‰é’®æ˜¾ç¤ºçš„æ–‡å­—çš„é¢œè‰²ï¼ˆå¯é€‰ï¼‰</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% hideBlock ç‚¹æˆ‘é¢„è§ˆ, blue %&#125;</span><br><span class="line">è¿™é‡Œæœ‰å¼ å›¾ç‰‡ï¼š</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://s1.vika.cn/space/2022/10/30/b35fce448bc9404a8d65c3ce1e6e46eb&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;image (1)&quot;</span> <span class="attr">style</span>=<span class="string">&quot;zoom:67%;&quot;</span> /&gt;</span></span></span><br><span class="line">&#123;% endhideBlock %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><div class="hide-block"><button type="button" class="hide-button" style="background-color:  blue;">ç‚¹æˆ‘é¢„è§ˆ    </button><div class="hide-content"><p>è¿™é‡Œæœ‰å¼ å›¾ç‰‡ï¼š<br><img src="https://s1.vika.cn/space/2022/10/30/b35fce448bc9404a8d65c3ce1e6e46eb" alt="image (1)" style="zoom:67%;" /></p></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>]]></content>
    
    
    <summary type="html">ğŸ¥§æœ¬æ–‡æ±‡æ€»Markdownæ ¼å¼ä»¥åŠå¤–æŒ‚æ ‡ç­¾åœ¨ç½‘é¡µç«¯çš„æ¸²æŸ“æ•ˆæœï¼Œå¯ä½œä¸ºæ–‡æ¡£è¿›è¡ŒæŸ¥è¯¢</summary>
    
    
    
    <category term="æ¼”ç¤º" scheme="https://luckylittleboy.gitee.io/categories/%E6%BC%94%E7%A4%BA/"/>
    
    
    <category term="Markdown" scheme="https://luckylittleboy.gitee.io/tags/Markdown/"/>
    
    <category term="å¤–æŒ‚æ ‡ç­¾" scheme="https://luckylittleboy.gitee.io/tags/%E5%A4%96%E6%8C%82%E6%A0%87%E7%AD%BE/"/>
    
  </entry>
  
</feed>
