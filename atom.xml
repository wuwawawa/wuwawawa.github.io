<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>LuckyBoyğŸ¥</title>
  
  
  <link href="https://wuwawawa.github.io/atom.xml" rel="self"/>
  
  <link href="https://wuwawawa.github.io/"/>
  <updated>2023-06-13T08:52:18.303Z</updated>
  <id>https://wuwawawa.github.io/</id>
  
  <author>
    <name>LuckyBoyğŸ¥</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Redisé«˜çº§</title>
    <link href="https://wuwawawa.github.io/posts/db4d2069.html"/>
    <id>https://wuwawawa.github.io/posts/db4d2069.html</id>
    <published>2023-06-12T09:12:51.000Z</published>
    <updated>2023-06-13T08:52:18.303Z</updated>
    
    <content type="html"><![CDATA[<h1>åˆ†å¸ƒå¼ç¼“å­˜</h1><h2 id="RedisæŒä¹…åŒ–">RedisæŒä¹…åŒ–</h2><p>Redisæœ‰ä¸¤ç§æŒä¹…åŒ–æ–¹æ¡ˆï¼š</p><ul><li>RDBæŒä¹…åŒ–</li><li>AOFæŒä¹…åŒ–</li></ul><hr><h3 id="RDBæŒä¹…åŒ–">RDBæŒä¹…åŒ–</h3><p>RDBå…¨ç§°<code>Redis Database Backup file</code>ï¼ˆRedisæ•°æ®å¤‡ä»½æ–‡ä»¶ï¼‰ï¼Œä¹Ÿè¢«å«åšRedisæ•°æ®å¿«ç…§ã€‚ç®€å•æ¥è¯´å°±æ˜¯æŠŠå†…å­˜ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½è®°å½•åˆ°ç£ç›˜ä¸­ã€‚å½“Rediså®ä¾‹æ•…éšœé‡å¯åï¼Œä»ç£ç›˜è¯»å–å¿«ç…§æ–‡ä»¶ï¼Œæ¢å¤æ•°æ®ã€‚å¿«ç…§æ–‡ä»¶ç§°ä¸ºRDBæ–‡ä»¶ï¼Œé»˜è®¤æ˜¯ä¿å­˜åœ¨å½“å‰è¿è¡Œç›®å½•ã€‚</p><hr><h4 id="æ‰§è¡Œæ—¶æœº">æ‰§è¡Œæ—¶æœº</h4><div class="tabs" id="d7672d57-2890-4cd6-9d53-7464f9c2a49f"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d7672d57-2890-4cd6-9d53-7464f9c2a49f-1"><i class="fas fa-seedling"></i>1)saveå‘½ä»¤</button></li><li class="tab"><button type="button" data-href="#d7672d57-2890-4cd6-9d53-7464f9c2a49f-2"><i class="fas fa-leaf"></i>2)bgsaveå‘½ä»¤</button></li><li class="tab"><button type="button" data-href="#d7672d57-2890-4cd6-9d53-7464f9c2a49f-3"><i class="fab fa-apple"></i>3)åœæœºæ—¶</button></li><li class="tab"><button type="button" data-href="#d7672d57-2890-4cd6-9d53-7464f9c2a49f-4"><i class="fas fa-tree"></i>4)è§¦å‘RDBæ¡ä»¶</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d7672d57-2890-4cd6-9d53-7464f9c2a49f-1"><p>æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¯ä»¥ç«‹å³æ‰§è¡Œä¸€æ¬¡RDBï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; save    <span class="comment">#ç”±Redisä¸»è¿›ç¨‹æ¥æ‰§è¡ŒRDBï¼Œä¼šé˜»å¡æ‰€æœ‰å‘½ä»¤</span></span><br><span class="line">ok</span><br></pre></td></tr></table></figure><p>saveå‘½ä»¤ä¼šå¯¼è‡´ä¸»è¿›ç¨‹æ‰§è¡ŒRDBï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­å…¶å®ƒæ‰€æœ‰å‘½ä»¤éƒ½ä¼šè¢«é˜»å¡ã€‚åªæœ‰åœ¨æ•°æ®è¿ç§»æ—¶å¯èƒ½ç”¨åˆ°ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d7672d57-2890-4cd6-9d53-7464f9c2a49f-2"><p>ä¸‹é¢çš„å‘½ä»¤å¯ä»¥å¼‚æ­¥æ‰§è¡ŒRDBï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; bgsave    <span class="comment">#å¼€å¯å­è¿›ç¨‹æ‰§è¡ŒRDBï¼Œé¿å…ä¸»è¿›ç¨‹å—åˆ°å½±å“</span></span><br><span class="line">ok</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‘½ä»¤æ‰§è¡Œåä¼šå¼€å¯ç‹¬ç«‹è¿›ç¨‹å®ŒæˆRDBï¼Œä¸»è¿›ç¨‹å¯ä»¥æŒç»­å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œä¸å—å½±å“ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d7672d57-2890-4cd6-9d53-7464f9c2a49f-3"><p>Redisåœæœºæ—¶ä¼šæ‰§è¡Œä¸€æ¬¡saveå‘½ä»¤ï¼Œå®ç°RDBæŒä¹…åŒ–ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d7672d57-2890-4cd6-9d53-7464f9c2a49f-4"><p>Rediså†…éƒ¨æœ‰è§¦å‘RDBçš„æœºåˆ¶ï¼Œå¯ä»¥åœ¨redis.confæ–‡ä»¶ä¸­æ‰¾åˆ°ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 900ç§’å†…ï¼Œå¦‚æœè‡³å°‘æœ‰1ä¸ªkeyè¢«ä¿®æ”¹ï¼Œåˆ™æ‰§è¡Œbgsave ï¼Œ å¦‚æœæ˜¯save &quot;&quot; åˆ™è¡¨ç¤ºç¦ç”¨RDB</span></span><br><span class="line"><span class="attr">save</span> <span class="string">900 1  </span></span><br><span class="line"><span class="attr">save</span> <span class="string">300 10  </span></span><br><span class="line"><span class="attr">save</span> <span class="string">60 10000 </span></span><br></pre></td></tr></table></figure><p>RDBçš„å…¶å®ƒé…ç½®ä¹Ÿå¯ä»¥åœ¨redis.confæ–‡ä»¶ä¸­è®¾ç½®ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ˜¯å¦å‹ç¼© ,å»ºè®®ä¸å¼€å¯ï¼Œå‹ç¼©ä¹Ÿä¼šæ¶ˆè€—cpuï¼Œç£ç›˜çš„è¯ä¸å€¼é’±</span></span><br><span class="line"><span class="attr">rdbcompression</span> <span class="string">yes</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># RDBæ–‡ä»¶åç§°</span></span><br><span class="line"><span class="attr">dbfilename</span> <span class="string">dump.rdb  </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># æ–‡ä»¶ä¿å­˜çš„è·¯å¾„ç›®å½•</span></span><br><span class="line"><span class="attr">dir</span> <span class="string">./ </span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h4 id="RDBåŸç†">RDBåŸç†</h4><p>bgsaveå¼€å§‹æ—¶ä¼šforkä¸»è¿›ç¨‹å¾—åˆ°å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹å…±äº«ä¸»è¿›ç¨‹çš„å†…å­˜æ•°æ®ã€‚å®Œæˆforkåè¯»å–å†…å­˜æ•°æ®å¹¶å†™å…¥ RDB æ–‡ä»¶ã€‚</p><p>forké‡‡ç”¨çš„æ˜¯copy-on-writeæŠ€æœ¯ï¼š</p><ul><li>å½“ä¸»è¿›ç¨‹æ‰§è¡Œè¯»æ“ä½œæ—¶ï¼Œè®¿é—®å…±äº«å†…å­˜ï¼›</li><li>å½“ä¸»è¿›ç¨‹æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œåˆ™ä¼šæ‹·è´ä¸€ä»½æ•°æ®ï¼Œæ‰§è¡Œå†™æ“ä½œã€‚</li></ul><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725151319695.png" alt="image-20210725151319695" style="zoom:67%;" /><hr><h4 id="å°ç»“">å°ç»“</h4><p>RDBæ–¹å¼bgsaveçš„åŸºæœ¬æµç¨‹ï¼Ÿ</p><ul><li>forkä¸»è¿›ç¨‹å¾—åˆ°ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå…±äº«å†…å­˜ç©ºé—´</li><li>å­è¿›ç¨‹è¯»å–å†…å­˜æ•°æ®å¹¶å†™å…¥æ–°çš„RDBæ–‡ä»¶</li><li>ç”¨æ–°RDBæ–‡ä»¶æ›¿æ¢æ—§çš„RDBæ–‡ä»¶</li></ul><p>RDBä¼šåœ¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿsave 60 1000ä»£è¡¨ä»€ä¹ˆå«ä¹‰ï¼Ÿ</p><ul><li>é»˜è®¤æ˜¯æœåŠ¡åœæ­¢æ—¶</li><li>ä»£è¡¨60ç§’å†…è‡³å°‘æ‰§è¡Œ1000æ¬¡ä¿®æ”¹åˆ™è§¦å‘RDB</li></ul><p>RDBçš„ç¼ºç‚¹ï¼Ÿ</p><ul><li>RDBæ‰§è¡Œé—´éš”æ—¶é—´é•¿ï¼Œä¸¤æ¬¡RDBä¹‹é—´å†™å…¥æ•°æ®æœ‰ä¸¢å¤±çš„é£é™©</li><li>forkå­è¿›ç¨‹ã€å‹ç¼©ã€å†™å‡ºRDBæ–‡ä»¶éƒ½æ¯”è¾ƒè€—æ—¶</li></ul><hr><h3 id="AOFæŒä¹…åŒ–">AOFæŒä¹…åŒ–</h3><h4 id="AOFåŸç†">AOFåŸç†</h4><p>AOFå…¨ç§°ä¸º<code>Append Only File</code>ï¼ˆè¿½åŠ æ–‡ä»¶ï¼‰ã€‚Rediså¤„ç†çš„æ¯ä¸€ä¸ªå†™å‘½ä»¤éƒ½ä¼šè®°å½•åœ¨AOFæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åšæ˜¯å‘½ä»¤æ—¥å¿—æ–‡ä»¶ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725151543640.png" alt="image-20210725151543640" style="zoom:67%;" /><hr><h4 id="AOFé…ç½®">AOFé…ç½®</h4><p>AOFé»˜è®¤æ˜¯å…³é—­çš„ï¼Œéœ€è¦ä¿®æ”¹redis.confé…ç½®æ–‡ä»¶æ¥å¼€å¯AOFï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ˜¯å¦å¼€å¯AOFåŠŸèƒ½ï¼Œé»˜è®¤æ˜¯no</span></span><br><span class="line"><span class="attr">appendonly</span> <span class="string">yes</span></span><br><span class="line"><span class="comment"># AOFæ–‡ä»¶çš„åç§°</span></span><br><span class="line"><span class="attr">appendfilename</span> <span class="string">&quot;appendonly.aof&quot;</span></span><br></pre></td></tr></table></figure><p>AOFçš„å‘½ä»¤è®°å½•çš„é¢‘ç‡ä¹Ÿå¯ä»¥é€šè¿‡redis.confæ–‡ä»¶æ¥é…ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¡¨ç¤ºæ¯æ‰§è¡Œä¸€æ¬¡å†™å‘½ä»¤ï¼Œç«‹å³è®°å½•åˆ°AOFæ–‡ä»¶</span></span><br><span class="line"><span class="attr">appendfsync</span> <span class="string">always </span></span><br><span class="line"><span class="comment"># å†™å‘½ä»¤æ‰§è¡Œå®Œå…ˆæ”¾å…¥AOFç¼“å†²åŒºï¼Œç„¶åè¡¨ç¤ºæ¯éš”1ç§’å°†ç¼“å†²åŒºæ•°æ®å†™åˆ°AOFæ–‡ä»¶ï¼Œæ˜¯é»˜è®¤æ–¹æ¡ˆ</span></span><br><span class="line"><span class="attr">appendfsync</span> <span class="string">everysec </span></span><br><span class="line"><span class="comment"># å†™å‘½ä»¤æ‰§è¡Œå®Œå…ˆæ”¾å…¥AOFç¼“å†²åŒºï¼Œç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶å°†ç¼“å†²åŒºå†…å®¹å†™å›ç£ç›˜</span></span><br><span class="line"><span class="attr">appendfsync</span> <span class="string">no</span></span><br></pre></td></tr></table></figure><mark class="hl-label blue">ä¸‰ç§ç­–ç•¥å¯¹æ¯”</mark> <table><thead><tr><th style="text-align:center">é…ç½®é¡¹</th><th style="text-align:center">åˆ·ç›˜æ—¶æœº</th><th style="text-align:center">ä¼˜ç‚¹</th><th style="text-align:center">ç¼ºç‚¹</th></tr></thead><tbody><tr><td style="text-align:center">always</td><td style="text-align:center">åŒæ­¥åˆ·ç›˜</td><td style="text-align:center">å¯é æ€§é«˜ï¼Œå‡ ä¹ä¸ä¸¢æ•°æ®</td><td style="text-align:center">æ€§èƒ½å½±å“æœ€å¤§</td></tr><tr><td style="text-align:center">everysec</td><td style="text-align:center">ç¾å¦™åˆ·ç›˜</td><td style="text-align:center">æ€§èƒ½é€‚ä¸­</td><td style="text-align:center">æœ€å¤šä¸¢å¤±1sæ•°æ®</td></tr><tr><td style="text-align:center">no</td><td style="text-align:center">æ“ä½œç³»ç»Ÿæ§åˆ¶</td><td style="text-align:center">æ€§èƒ½æœ€å¥½</td><td style="text-align:center">å¯é æ€§è¾ƒå·®ï¼Œå¯èƒ½ä¸¢å¤±å¤§é‡æ•°æ®</td></tr></tbody></table><hr><h4 id="AOFæ–‡ä»¶é‡å†™">AOFæ–‡ä»¶é‡å†™</h4><p>å› ä¸ºæ˜¯è®°å½•å‘½ä»¤ï¼ŒAOFæ–‡ä»¶ä¼šæ¯”RDBæ–‡ä»¶å¤§çš„å¤šã€‚è€Œä¸”AOFä¼šè®°å½•å¯¹åŒä¸€ä¸ªkeyçš„å¤šæ¬¡å†™æ“ä½œï¼Œä½†åªæœ‰æœ€åä¸€æ¬¡å†™æ“ä½œæ‰æœ‰æ„ä¹‰ã€‚é€šè¿‡æ‰§è¡Œbgrewriteaofå‘½ä»¤ï¼Œå¯ä»¥è®©AOFæ–‡ä»¶æ‰§è¡Œé‡å†™åŠŸèƒ½ï¼Œç”¨æœ€å°‘çš„å‘½ä»¤è¾¾åˆ°ç›¸åŒæ•ˆæœã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725151729118.png" alt="image-20210725151729118"></p><p>å¦‚å›¾ï¼ŒAOFåŸæœ¬æœ‰ä¸‰ä¸ªå‘½ä»¤ï¼Œä½†æ˜¯<code>set num 123 å’Œ set num 666</code>éƒ½æ˜¯å¯¹numçš„æ“ä½œï¼Œç¬¬äºŒæ¬¡ä¼šè¦†ç›–ç¬¬ä¸€æ¬¡çš„å€¼ï¼Œå› æ­¤ç¬¬ä¸€ä¸ªå‘½ä»¤è®°å½•ä¸‹æ¥æ²¡æœ‰æ„ä¹‰ã€‚</p><p>æ‰€ä»¥é‡å†™å‘½ä»¤åï¼ŒAOFæ–‡ä»¶å†…å®¹å°±æ˜¯ï¼š<code>mset name jack num 666</code></p><p>Redisä¹Ÿä¼šåœ¨è§¦å‘é˜ˆå€¼æ—¶è‡ªåŠ¨å»é‡å†™AOFæ–‡ä»¶ã€‚é˜ˆå€¼ä¹Ÿå¯ä»¥åœ¨redis.confä¸­é…ç½®ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># AOFæ–‡ä»¶æ¯”ä¸Šæ¬¡æ–‡ä»¶ å¢é•¿è¶…è¿‡å¤šå°‘ç™¾åˆ†æ¯”åˆ™è§¦å‘é‡å†™</span></span><br><span class="line"><span class="attr">auto-aof-rewrite-percentage</span> <span class="string">100</span></span><br><span class="line"><span class="comment"># AOFæ–‡ä»¶ä½“ç§¯æœ€å°å¤šå¤§ä»¥ä¸Šæ‰è§¦å‘é‡å†™ </span></span><br><span class="line"><span class="attr">auto-aof-rewrite-min-size</span> <span class="string">64mb </span></span><br></pre></td></tr></table></figure><hr><h3 id="RDBä¸AOFå¯¹æ¯”">RDBä¸AOFå¯¹æ¯”</h3><p>RDBå’ŒAOFå„æœ‰è‡ªå·±çš„ä¼˜ç¼ºç‚¹ï¼Œå¦‚æœå¯¹æ•°æ®å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜ï¼Œåœ¨å®é™…å¼€å‘ä¸­å¾€å¾€ä¼š<span class='p green'>ç»“åˆä¸¤è€…</span>æ¥ä½¿ç”¨ã€‚</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">RDB</th><th style="text-align:center">AOF</th></tr></thead><tbody><tr><td style="text-align:center">æŒä¹…åŒ–æ–¹å¼</td><td style="text-align:center">å®šæ—¶å¯¹æ•´ä¸ªå†…å­˜åšå¿«ç…§</td><td style="text-align:center">è®°å½•æ¯ä¸€æ¬¡æ‰§è¡Œçš„å‘½ä»¤</td></tr><tr><td style="text-align:center">æ•°æ®å®Œæ•´æ€§</td><td style="text-align:center">ä¸å®Œæ•´ï¼Œä¸¤æ¬¡å¤‡ä»½ä¹‹é—´ä¼šä¸¢å¤±</td><td style="text-align:center">ç›¸å¯¹å®Œæ•´ï¼Œå–å†³äºåˆ·ç›˜ç­–ç•¥</td></tr><tr><td style="text-align:center">æ–‡ä»¶å¤§å°</td><td style="text-align:center">ä¼šæœ‰å‹ç¼©ï¼Œæ–‡ä»¶ä½“ç§¯å°</td><td style="text-align:center">è®°å½•å‘½ä»¤ï¼Œæ–‡ä»¶ä½“ç§¯å¾ˆå¤§</td></tr><tr><td style="text-align:center">å®•æœºæ¢å¤é€Ÿåº¦</td><td style="text-align:center">å¾ˆå¿«</td><td style="text-align:center">æ…¢</td></tr><tr><td style="text-align:center">æ•°æ®æ¢å¤ä¼˜å…ˆçº§</td><td style="text-align:center">ä½ï¼Œå› ä¸ºæ•°æ®å®Œæ•´æ€§ä¸å¦‚AOF</td><td style="text-align:center">é«˜ï¼Œå› ä¸ºæ•°æ®å®Œæ•´æ€§æ›´é«˜</td></tr><tr><td style="text-align:center">ç³»ç»Ÿèµ„æºå ç”¨</td><td style="text-align:center">é«˜ï¼Œå¤§é‡CPUå’Œå†…å­˜æ¶ˆè€—</td><td style="text-align:center">ä½ï¼Œä¸»è¦æ˜¯ç£ç›˜I0èµ„æº<br/>ä½†AOFé‡å†™æ—¶ä¼šå ç”¨å¤§é‡CPUå’Œå†…å­˜èµ„æº</td></tr><tr><td style="text-align:center">ä½¿ç”¨åœºæ™¯</td><td style="text-align:center">å¯ä»¥å®¹å¿æ•°åˆ†é’Ÿçš„æ•°æ®ä¸¢å¤±ï¼Œè¿½æ±‚æ›´å¿«çš„å¯åŠ¨é€Ÿåº¦</td><td style="text-align:center">å¯¹æ•°æ®å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜å¸¸è§</td></tr></tbody></table><hr><hr><h2 id="Redisä¸»ä»">Redisä¸»ä»</h2><h3 id="æ­å»ºä¸»ä»æ¶æ„">æ­å»ºä¸»ä»æ¶æ„</h3><p>å•èŠ‚ç‚¹Redisçš„å¹¶å‘èƒ½åŠ›æ˜¯æœ‰ä¸Šé™çš„ï¼Œè¦è¿›ä¸€æ­¥æé«˜Redisçš„å¹¶å‘èƒ½åŠ›ï¼Œå°±éœ€è¦æ­å»ºä¸»ä»é›†ç¾¤ï¼Œå®ç°è¯»å†™åˆ†ç¦»ã€‚</p><p>æˆ‘ä»¬æ­å»ºçš„ä¸»ä»é›†ç¾¤ç»“æ„å¦‚å›¾ï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210630111505799.png" alt="image-20210630111505799" style="zoom:87%;" /><p>å…±åŒ…å«ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œä¸¤ä¸ªä»èŠ‚ç‚¹ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä¼šåœ¨åŒä¸€å°æœºå™¨ä¸­å¼€å¯3ä¸ªrediså®ä¾‹ï¼Œæ¨¡æ‹Ÿä¸»ä»é›†ç¾¤ï¼Œä¿¡æ¯å¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:center">IP</th><th style="text-align:center">PORT</th><th style="text-align:center">è§’è‰²</th></tr></thead><tbody><tr><td style="text-align:center">8.130.68.59</td><td style="text-align:center">6379</td><td style="text-align:center">master</td></tr><tr><td style="text-align:center">8.130.68.59</td><td style="text-align:center">6380</td><td style="text-align:center">slave</td></tr><tr><td style="text-align:center">8.130.68.59</td><td style="text-align:center">6381</td><td style="text-align:center">slave</td></tr></tbody></table><div class="tabs" id="36348bc6-aaa7-41c6-84c3-f97777968ac3"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#36348bc6-aaa7-41c6-84c3-f97777968ac3-1"><i class="fas fa-heartbeat"></i>åˆ›å»ºæ–‡ä»¶å¤¹</button></li><li class="tab"><button type="button" data-href="#36348bc6-aaa7-41c6-84c3-f97777968ac3-2"><i class="fas fa-cat"></i>ç¼–å†™docker-compose.yml</button></li><li class="tab"><button type="button" data-href="#36348bc6-aaa7-41c6-84c3-f97777968ac3-3"><i class="fas fa-horse"></i>å¯åŠ¨</button></li><li class="tab"><button type="button" data-href="#36348bc6-aaa7-41c6-84c3-f97777968ac3-4"><i class="fas fa-dove"></i>æŸ¥çœ‹ä¸»ä»å…³ç³»</button></li><li class="tab"><button type="button" data-href="#36348bc6-aaa7-41c6-84c3-f97777968ac3-5"><i class="fas fa-dragon"></i>æŸ¥çœ‹æ˜¯å¦åŒæ­¥äº†æ•°æ®</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="36348bc6-aaa7-41c6-84c3-f97777968ac3-1"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /Users/fortune/soft/Redis</span><br><span class="line"><span class="built_in">mkdir</span> /Users/fortune/soft/Redis/data-master</span><br><span class="line"><span class="built_in">mkdir</span> /Users/fortune/soft/Redis/data-slave-1</span><br><span class="line"><span class="built_in">mkdir</span> /Users/fortune/soft/Redis/data-slave-2</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶å±‚çº§å…³ç³»</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Redis</span></span><br><span class="line">â”œâ”€â”€ <span class="class"><span class="keyword">data</span>-master </span></span><br><span class="line">â”œâ”€â”€ <span class="class"><span class="keyword">data</span>-slave-1 </span></span><br><span class="line">â”œâ”€â”€ <span class="class"><span class="keyword">data</span>-slave-2</span></span><br><span class="line">â”œâ”€â”€ docker-compose.yml</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="36348bc6-aaa7-41c6-84c3-f97777968ac3-2"><p><code>vi /Users/fortune/soft/Redis/docker-compose.yml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.1&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">master:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-master</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--port</span> <span class="number">6379</span> <span class="string">--requirepass</span> <span class="string">test</span>  <span class="string">--appendonly</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6379</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data-master:/data</span></span><br><span class="line">  <span class="attr">slave1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave-1</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--slaveof</span> <span class="number">10.132</span><span class="number">.75</span><span class="number">.15</span> <span class="number">6379</span> <span class="string">--port</span> <span class="number">6380</span>  <span class="string">--requirepass</span> <span class="string">test</span> <span class="string">--masterauth</span> <span class="string">test</span>  <span class="string">--appendonly</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6380</span><span class="string">:6380</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data-slave-1:/data</span></span><br><span class="line">  <span class="attr">slave2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave-2</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--slaveof</span> <span class="number">10.132</span><span class="number">.75</span><span class="number">.15</span> <span class="number">6379</span> <span class="string">--port</span> <span class="number">6381</span>  <span class="string">--requirepass</span> <span class="string">test</span> <span class="string">--masterauth</span> <span class="string">test</span>  <span class="string">--appendonly</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6381</span><span class="string">:6381</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data-slave-2:/data</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="36348bc6-aaa7-41c6-84c3-f97777968ac3-3"><p><code>docker-compose up -d</code></p><p><mark class="hl-label red">å…³é—­</mark></p><p><code>docker-compose down</code></p><p><mark class="hl-label blue">æŸ¥çœ‹æ—¥å¿—</mark></p><p><code>docker-compose logs -f</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="36348bc6-aaa7-41c6-84c3-f97777968ac3-4"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ0jl2rei3z6qtg79h1lbeZ redis]<span class="comment"># docker exec -it redis-master /bin/bash</span></span><br><span class="line">root@39d4a5aa7ddb:/data<span class="comment"># redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt; INFO REPLICATION</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=172.20.0.1,port=6381,state=online,offset=28,lag=0</span><br><span class="line">slave1:ip=172.20.0.1,port=6380,state=online,offset=28,lag=0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:2a6869f1541acab507d59c7fc484476a6231eb10</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:28</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:28</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="36348bc6-aaa7-41c6-84c3-f97777968ac3-5"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> a 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> b 2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">exit</span></span><br><span class="line">root@39d4a5aa7ddb:/data<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">[root@iZ0jl2rei3z6qtg79h1lbeZ redis]<span class="comment"># docker exec -it redis-slave-1 /bin/bash</span></span><br><span class="line">root@6dbd2b7c1676:/data<span class="comment"># redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">&quot;b&quot;</span></span><br><span class="line">2) <span class="string">&quot;a&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="ä¸»ä»æ•°æ®åŒæ­¥åŸç†">ä¸»ä»æ•°æ®åŒæ­¥åŸç†</h3><h4 id="å…¨é‡åŒæ­¥">å…¨é‡åŒæ­¥</h4><p>ä¸»ä»ç¬¬ä¸€æ¬¡å»ºç«‹è¿æ¥æ—¶ï¼Œä¼šæ‰§è¡Œå…¨é‡åŒæ­¥ï¼Œå°†masterèŠ‚ç‚¹çš„æ‰€æœ‰æ•°æ®éƒ½æ‹·è´ç»™slaveèŠ‚ç‚¹ï¼Œ</p><p>å®Œæ•´æµç¨‹æè¿°ï¼š</p><ul><li>slaveèŠ‚ç‚¹è¯·æ±‚å¢é‡åŒæ­¥</li><li>masterèŠ‚ç‚¹åˆ¤æ–­replidï¼Œå‘ç°ä¸ä¸€è‡´ï¼Œæ‹’ç»å¢é‡åŒæ­¥</li><li>masterå°†å®Œæ•´å†…å­˜æ•°æ®ç”ŸæˆRDBï¼Œå‘é€RDBåˆ°slave</li><li>slaveæ¸…ç©ºæœ¬åœ°æ•°æ®ï¼ŒåŠ è½½masterçš„RDB</li><li>masterå°†RDBæœŸé—´çš„å‘½ä»¤è®°å½•åœ¨repl_baklogï¼Œå¹¶æŒç»­å°†logä¸­çš„å‘½ä»¤å‘é€ç»™slave</li><li>slaveæ‰§è¡Œæ¥æ”¶åˆ°çš„å‘½ä»¤ï¼Œä¿æŒä¸masterä¹‹é—´çš„åŒæ­¥</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725152222497.png" alt="image-20210725152222497"></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œmasterå¦‚ä½•å¾—çŸ¥salveæ˜¯ç¬¬ä¸€æ¬¡æ¥è¿æ¥å‘¢ï¼Ÿï¼Ÿ</p><p>æœ‰å‡ ä¸ªæ¦‚å¿µï¼Œå¯ä»¥ä½œä¸ºåˆ¤æ–­ä¾æ®ï¼š</p><ul><li><strong>Replication Id</strong>ï¼šç®€ç§°replidï¼Œæ˜¯æ•°æ®é›†çš„æ ‡è®°ï¼Œidä¸€è‡´åˆ™è¯´æ˜æ˜¯åŒä¸€æ•°æ®é›†ã€‚æ¯ä¸€ä¸ªmasteréƒ½æœ‰å”¯ä¸€çš„replidï¼Œslaveåˆ™ä¼šç»§æ‰¿masterèŠ‚ç‚¹çš„replid</li><li><strong>offset</strong>ï¼šåç§»é‡ï¼Œéšç€è®°å½•åœ¨repl_baklogä¸­çš„æ•°æ®å¢å¤šè€Œé€æ¸å¢å¤§ã€‚slaveå®ŒæˆåŒæ­¥æ—¶ä¹Ÿä¼šè®°å½•å½“å‰åŒæ­¥çš„offsetã€‚å¦‚æœslaveçš„offsetå°äºmasterçš„offsetï¼Œè¯´æ˜slaveæ•°æ®è½åäºmasterï¼Œéœ€è¦æ›´æ–°ã€‚</li></ul><p>å› æ­¤slaveåšæ•°æ®åŒæ­¥ï¼Œå¿…é¡»å‘masterå£°æ˜è‡ªå·±çš„replication id å’Œoffsetï¼Œmasteræ‰å¯ä»¥åˆ¤æ–­åˆ°åº•éœ€è¦åŒæ­¥å“ªäº›æ•°æ®ã€‚</p><p>å› ä¸ºslaveåŸæœ¬ä¹Ÿæ˜¯ä¸€ä¸ªmasterï¼Œæœ‰è‡ªå·±çš„replidå’Œoffsetï¼Œå½“ç¬¬ä¸€æ¬¡å˜æˆslaveï¼Œä¸masterå»ºç«‹è¿æ¥æ—¶ï¼Œå‘é€çš„replidå’Œoffsetæ˜¯è‡ªå·±çš„replidå’Œoffsetã€‚</p><p>masteråˆ¤æ–­å‘ç°slaveå‘é€æ¥çš„replidä¸è‡ªå·±çš„ä¸ä¸€è‡´ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªå…¨æ–°çš„slaveï¼Œå°±çŸ¥é“è¦åšå…¨é‡åŒæ­¥äº†ã€‚</p><p>masterä¼šå°†è‡ªå·±çš„replidå’Œoffsetéƒ½å‘é€ç»™è¿™ä¸ªslaveï¼Œslaveä¿å­˜è¿™äº›ä¿¡æ¯ã€‚ä»¥åslaveçš„replidå°±ä¸masterä¸€è‡´äº†ã€‚</p><p>å› æ­¤ï¼Œ<strong>masteråˆ¤æ–­ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥çš„ä¾æ®ï¼Œå°±æ˜¯çœ‹replidæ˜¯å¦ä¸€è‡´</strong>ã€‚</p><hr><h4 id="å¢é‡åŒæ­¥">å¢é‡åŒæ­¥</h4><p>å…¨é‡åŒæ­¥éœ€è¦å…ˆåšRDBï¼Œç„¶åå°†RDBæ–‡ä»¶é€šè¿‡ç½‘ç»œä¼ è¾“ä¸ªslaveï¼Œæˆæœ¬å¤ªé«˜äº†ã€‚å› æ­¤é™¤äº†ç¬¬ä¸€æ¬¡åšå…¨é‡åŒæ­¥ï¼Œå…¶å®ƒå¤§å¤šæ•°æ—¶å€™slaveä¸masteréƒ½æ˜¯åš<strong>å¢é‡åŒæ­¥</strong>ã€‚</p><p>ä»€ä¹ˆæ˜¯å¢é‡åŒæ­¥ï¼Ÿå°±æ˜¯åªæ›´æ–°slaveä¸masterå­˜åœ¨å·®å¼‚çš„éƒ¨åˆ†æ•°æ®ã€‚å¦‚å›¾</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725153201086.png" alt="image-20210725153201086" style="zoom:67%;" /><hr><h4 id="repl-backlogåŸç†">repl_backlogåŸç†</h4><p>masteræ€ä¹ˆçŸ¥é“slaveä¸è‡ªå·±çš„æ•°æ®å·®å¼‚åœ¨å“ªé‡Œå‘¢?</p><p>è¿™å°±è¦è¯´åˆ°å…¨é‡åŒæ­¥æ—¶çš„repl_baklogæ–‡ä»¶äº†ã€‚</p><p>è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ªå›ºå®šå¤§å°çš„æ•°ç»„ï¼Œåªä¸è¿‡æ•°ç»„æ˜¯ç¯å½¢ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>è§’æ ‡åˆ°è¾¾æ•°ç»„æœ«å°¾åï¼Œä¼šå†æ¬¡ä»0å¼€å§‹è¯»å†™</strong>ï¼Œè¿™æ ·æ•°ç»„å¤´éƒ¨çš„æ•°æ®å°±ä¼šè¢«è¦†ç›–ã€‚</p><div class="tabs" id="0715ae52-b306-4cfd-b62c-be9d9a3465d6"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#0715ae52-b306-4cfd-b62c-be9d9a3465d6-1"><i class="fas fa-seedling"></i>1</button></li><li class="tab"><button type="button" data-href="#0715ae52-b306-4cfd-b62c-be9d9a3465d6-2"><i class="fas fa-leaf"></i>2</button></li><li class="tab"><button type="button" data-href="#0715ae52-b306-4cfd-b62c-be9d9a3465d6-3"><i class="fab fa-apple"></i>3</button></li><li class="tab"><button type="button" data-href="#0715ae52-b306-4cfd-b62c-be9d9a3465d6-4"><i class="fas fa-tree"></i>4</button></li><li class="tab"><button type="button" data-href="#0715ae52-b306-4cfd-b62c-be9d9a3465d6-5"><i class="fas fa-heartbeat"></i>5</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="0715ae52-b306-4cfd-b62c-be9d9a3465d6-1"><p>repl_baklogä¸­ä¼šè®°å½•Rediså¤„ç†è¿‡çš„å‘½ä»¤æ—¥å¿—åŠoffsetï¼ŒåŒ…æ‹¬masterå½“å‰çš„offsetï¼Œå’Œslaveå·²ç»æ‹·è´åˆ°çš„offsetï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725153359022.png" alt="image-20210725153359022"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0715ae52-b306-4cfd-b62c-be9d9a3465d6-2"><p>slaveä¸masterçš„offsetä¹‹é—´çš„å·®å¼‚ï¼Œå°±æ˜¯salveéœ€è¦å¢é‡æ‹·è´çš„æ•°æ®äº†ã€‚</p><p>éšç€ä¸æ–­æœ‰æ•°æ®å†™å…¥ï¼Œmasterçš„offseté€æ¸å˜å¤§ï¼Œslaveä¹Ÿä¸æ–­çš„æ‹·è´ï¼Œè¿½èµ¶masterçš„offsetï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725153524190.png" alt="image-20210725153524190"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0715ae52-b306-4cfd-b62c-be9d9a3465d6-3"><p>ç›´åˆ°æ•°ç»„è¢«å¡«æ»¡ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725153715910.png" alt="image-20210725153715910"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0715ae52-b306-4cfd-b62c-be9d9a3465d6-4"><p>æ­¤æ—¶ï¼Œå¦‚æœæœ‰æ–°çš„æ•°æ®å†™å…¥ï¼Œå°±ä¼šè¦†ç›–æ•°ç»„ä¸­çš„æ—§æ•°æ®ã€‚ä¸è¿‡ï¼Œæ—§çš„æ•°æ®åªè¦æ˜¯ç»¿è‰²çš„ï¼Œè¯´æ˜æ˜¯å·²ç»è¢«åŒæ­¥åˆ°slaveçš„æ•°æ®ï¼Œå³ä¾¿è¢«è¦†ç›–äº†ä¹Ÿæ²¡ä»€ä¹ˆå½±å“ã€‚å› ä¸ºæœªåŒæ­¥çš„ä»…ä»…æ˜¯çº¢è‰²éƒ¨åˆ†ã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœslaveå‡ºç°ç½‘ç»œé˜»å¡ï¼Œå¯¼è‡´masterçš„offsetè¿œè¿œè¶…è¿‡äº†slaveçš„offsetï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725153937031.png" alt="image-20210725153937031"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0715ae52-b306-4cfd-b62c-be9d9a3465d6-5"><p>å¦‚æœmasterç»§ç»­å†™å…¥æ–°æ•°æ®ï¼Œå…¶offsetå°±ä¼šè¦†ç›–æ—§çš„æ•°æ®ï¼Œç›´åˆ°å°†slaveç°åœ¨çš„offsetä¹Ÿè¦†ç›–ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725154155984.png" alt="image-20210725154155984"></p><p>æ£•è‰²æ¡†ä¸­çš„çº¢è‰²éƒ¨åˆ†ï¼Œå°±æ˜¯å°šæœªåŒæ­¥ï¼Œä½†æ˜¯å´å·²ç»è¢«è¦†ç›–çš„æ•°æ®ã€‚æ­¤æ—¶å¦‚æœslaveæ¢å¤ï¼Œéœ€è¦åŒæ­¥ï¼Œå´å‘ç°è‡ªå·±çš„offsetéƒ½æ²¡æœ‰äº†ï¼Œæ— æ³•å®Œæˆå¢é‡åŒæ­¥äº†ã€‚åªèƒ½åšå…¨é‡åŒæ­¥ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>repl_baklogå¤§å°æœ‰ä¸Šé™ï¼Œå†™æ»¡åä¼šè¦†ç›–æœ€æ—©çš„æ•°æ®ã€‚å¦‚æœslaveæ–­å¼€æ—¶é—´è¿‡ä¹…ï¼Œå¯¼è‡´å°šæœªå¤‡ä»½çš„æ•°æ®è¢«è¦†ç›–ï¼Œåˆ™æ— æ³•åŸºäºlogåšå¢é‡åŒæ­¥ï¼Œåªèƒ½å†æ¬¡å…¨é‡åŒæ­¥ã€‚</p><hr><h3 id="ä¸»ä»åŒæ­¥ä¼˜åŒ–">ä¸»ä»åŒæ­¥ä¼˜åŒ–</h3><p>ä¸»ä»åŒæ­¥å¯ä»¥ä¿è¯ä¸»ä»æ•°æ®çš„ä¸€è‡´æ€§ï¼Œéå¸¸é‡è¦ã€‚</p><p>å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥ä¼˜åŒ–Redisä¸»ä»å°±é›†ç¾¤ï¼š</p><ul><li>åœ¨masterä¸­é…ç½®repl-diskless-sync yeså¯ç”¨æ— ç£ç›˜å¤åˆ¶ï¼Œé¿å…å…¨é‡åŒæ­¥æ—¶çš„ç£ç›˜IOã€‚</li><li>Rediså•èŠ‚ç‚¹ä¸Šçš„å†…å­˜å ç”¨ä¸è¦å¤ªå¤§ï¼Œå‡å°‘RDBå¯¼è‡´çš„è¿‡å¤šç£ç›˜IO</li><li>é€‚å½“æé«˜repl_baklogçš„å¤§å°ï¼Œå‘ç°slaveå®•æœºæ—¶å°½å¿«å®ç°æ•…éšœæ¢å¤ï¼Œå°½å¯èƒ½é¿å…å…¨é‡åŒæ­¥</li><li>é™åˆ¶ä¸€ä¸ªmasterä¸Šçš„slaveèŠ‚ç‚¹æ•°é‡ï¼Œå¦‚æœå®åœ¨æ˜¯å¤ªå¤šslaveï¼Œåˆ™å¯ä»¥é‡‡ç”¨ä¸»-ä»-ä»é“¾å¼ç»“æ„ï¼Œå‡å°‘masterå‹åŠ›</li></ul><p>ä¸»ä»ä»æ¶æ„å›¾ï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725154405899.png" alt="image-20210725154405899" style="zoom: 67%;" /><hr><h3 id="å°ç»“-2">å°ç»“</h3><blockquote><p>ç®€è¿°å…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥åŒºåˆ«ï¼Ÿ</p></blockquote><ul><li>å…¨é‡åŒæ­¥ï¼šmasterå°†å®Œæ•´å†…å­˜æ•°æ®ç”ŸæˆRDBï¼Œå‘é€RDBåˆ°slaveã€‚åç»­å‘½ä»¤åˆ™è®°å½•åœ¨repl_baklogï¼Œé€ä¸ªå‘é€ç»™slaveã€‚</li><li>å¢é‡åŒæ­¥ï¼šslaveæäº¤è‡ªå·±çš„offsetåˆ°masterï¼Œmasterè·å–repl_baklogä¸­ä»offsetä¹‹åçš„å‘½ä»¤ç»™slave</li></ul><blockquote><p>ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå…¨é‡åŒæ­¥ï¼Ÿ</p></blockquote><ul><li>slaveèŠ‚ç‚¹ç¬¬ä¸€æ¬¡è¿æ¥masterèŠ‚ç‚¹æ—¶</li><li>slaveèŠ‚ç‚¹æ–­å¼€æ—¶é—´å¤ªä¹…ï¼Œrepl_baklogä¸­çš„offsetå·²ç»è¢«è¦†ç›–æ—¶</li></ul><blockquote><p>ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå¢é‡åŒæ­¥ï¼Ÿ</p></blockquote><ul><li>slaveèŠ‚ç‚¹æ–­å¼€åˆæ¢å¤ï¼Œå¹¶ä¸”åœ¨repl_baklogä¸­èƒ½æ‰¾åˆ°offsetæ—¶</li></ul><hr><hr><h2 id="Rediså“¨å…µ">Rediså“¨å…µ</h2><p>Redisæä¾›äº†å“¨å…µï¼ˆSentinelï¼‰æœºåˆ¶æ¥å®ç°ä¸»ä»é›†ç¾¤çš„è‡ªåŠ¨æ•…éšœæ¢å¤ã€‚</p><hr><h3 id="å“¨å…µä½œç”¨">å“¨å…µä½œç”¨</h3><p>å“¨å…µçš„ä½œç”¨å¦‚ä¸‹ï¼š</p><ul><li><span class='p blue'>ç›‘æ§</span>ï¼šSentinel ä¼šä¸æ–­æ£€æŸ¥æ‚¨çš„masterå’Œslaveæ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œ</li><li><span class='p red'>è‡ªåŠ¨æ•…éšœæ¢å¤</span>ï¼šå¦‚æœmasteræ•…éšœï¼ŒSentinelä¼šå°†ä¸€ä¸ªslaveæå‡ä¸ºmasterã€‚å½“æ•…éšœå®ä¾‹æ¢å¤åä¹Ÿä»¥æ–°çš„masterä¸ºä¸»</li><li><span class='p green'>é€šçŸ¥</span>ï¼šSentinelå……å½“Rediså®¢æˆ·ç«¯çš„æœåŠ¡å‘ç°æ¥æºï¼Œå½“é›†ç¾¤å‘ç”Ÿæ•…éšœè½¬ç§»æ—¶ï¼Œä¼šå°†æœ€æ–°ä¿¡æ¯æ¨é€ç»™Redisçš„å®¢æˆ·ç«¯</li></ul><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725154528072.png" alt="image-20210725154528072" style="zoom:67%;" /><hr><h3 id="é›†ç¾¤ç›‘æ§">é›†ç¾¤ç›‘æ§</h3><p>SentinelåŸºäºå¿ƒè·³æœºåˆ¶ç›‘æµ‹æœåŠ¡çŠ¶æ€ï¼Œæ¯éš”1ç§’å‘é›†ç¾¤çš„æ¯ä¸ªå®ä¾‹å‘é€pingå‘½ä»¤ï¼Œå“¨å…µå…ˆç›‘å¬ä¸»ï¼Œé€šè¿‡å¯¹ä¸»å‘é€infoå‘½ä»¤ï¼Œè·å–åˆ°ä»çš„ä¿¡æ¯ï¼Œç„¶åä¹Ÿä¼šç›‘å¬åˆ°ä»ã€‚</p><p>ä¸»è§‚ä¸‹çº¿ï¼šå¦‚æœæŸsentinelèŠ‚ç‚¹å‘ç°æŸå®ä¾‹æœªåœ¨è§„å®šæ—¶é—´å“åº”ï¼Œåˆ™è®¤ä¸ºè¯¥å®ä¾‹<span class='p blue'>ä¸»è§‚ä¸‹çº¿</span>ã€‚</p><p>å®¢è§‚ä¸‹çº¿ï¼šè‹¥è¶…è¿‡æŒ‡å®šæ•°é‡ï¼ˆquorumï¼‰çš„sentineléƒ½è®¤ä¸ºè¯¥å®ä¾‹ä¸»è§‚ä¸‹çº¿ï¼Œåˆ™è¯¥å®ä¾‹<span class='p blue'>å®¢è§‚ä¸‹çº¿</span>ã€‚quorumå€¼æœ€å¥½è¶…è¿‡Sentinelå®ä¾‹æ•°é‡çš„ä¸€åŠã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725154632354.png" alt="image-20210725154632354" style="zoom:67%;" /><hr><h3 id="é›†ç¾¤æ•…éšœæ¢å¤">é›†ç¾¤æ•…éšœæ¢å¤</h3><p>ä¸€æ—¦å‘ç°masteræ•…éšœï¼Œsentineléœ€è¦åœ¨salveä¸­é€‰æ‹©ä¸€ä¸ªä½œä¸ºæ–°çš„masterï¼Œé€‰æ‹©ä¾æ®æ˜¯è¿™æ ·çš„ï¼š</p><ul><li>é¦–å…ˆä¼šåˆ¤æ–­slaveèŠ‚ç‚¹ä¸masterèŠ‚ç‚¹æ–­å¼€æ—¶é—´é•¿çŸ­ï¼Œå¦‚æœè¶…è¿‡æŒ‡å®šå€¼ï¼ˆdown-after-milliseconds * 10ï¼‰åˆ™ä¼šæ’é™¤è¯¥slaveèŠ‚ç‚¹</li><li>ç„¶ååˆ¤æ–­slaveèŠ‚ç‚¹çš„slave-priorityå€¼ï¼Œè¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œå¦‚æœæ˜¯0åˆ™æ°¸ä¸å‚ä¸é€‰ä¸¾</li><li>å¦‚æœslave-prorityä¸€æ ·ï¼Œåˆ™åˆ¤æ–­slaveèŠ‚ç‚¹çš„offsetå€¼ï¼Œè¶Šå¤§è¯´æ˜æ•°æ®è¶Šæ–°ï¼Œä¼˜å…ˆçº§è¶Šé«˜</li><li>æœ€åæ˜¯åˆ¤æ–­slaveèŠ‚ç‚¹çš„è¿è¡Œidå¤§å°ï¼Œè¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚</li></ul><p>å½“é€‰å‡ºä¸€ä¸ªæ–°çš„masteråï¼Œè¯¥å¦‚ä½•å®ç°åˆ‡æ¢å‘¢ï¼Ÿ</p><mark class="hl-label blue">æµç¨‹å¦‚ä¸‹</mark> <ul><li>sentinelç»™å¤‡é€‰çš„slave1èŠ‚ç‚¹å‘é€slaveof no oneå‘½ä»¤ï¼Œè®©è¯¥èŠ‚ç‚¹æˆä¸ºmaster</li><li>sentinelç»™æ‰€æœ‰å…¶å®ƒslaveå‘é€slaveofå‘½ä»¤ï¼Œè®©è¿™äº›slaveæˆä¸ºæ–°masterçš„ä»èŠ‚ç‚¹ï¼Œå¼€å§‹ä»æ–°çš„masterä¸ŠåŒæ­¥æ•°æ®ã€‚</li><li>æœ€åï¼Œsentinelå°†æ•…éšœèŠ‚ç‚¹æ ‡è®°ä¸ºslaveï¼Œå½“æ•…éšœèŠ‚ç‚¹æ¢å¤åä¼šè‡ªåŠ¨æˆä¸ºæ–°çš„masterçš„slaveèŠ‚ç‚¹</li></ul><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725154816841.png" alt="image-20210725154816841" style="zoom:67%;" /><hr><h3 id="æ­å»ºå“¨å…µé›†ç¾¤">æ­å»ºå“¨å…µé›†ç¾¤</h3><p>ä¸‰ä¸ªsentinelå®ä¾‹ä¿¡æ¯å¦‚ä¸‹ï¼š</p><table><thead><tr><th>èŠ‚ç‚¹</th><th style="text-align:center">IP</th><th style="text-align:center">PORT</th></tr></thead><tbody><tr><td>s1</td><td style="text-align:center">8.130.68.59</td><td style="text-align:center">26379</td></tr><tr><td>s2</td><td style="text-align:center">8.130.68.59</td><td style="text-align:center">26380</td></tr><tr><td>s3</td><td style="text-align:center">8.130.68.59</td><td style="text-align:center">26381</td></tr></tbody></table><div class="tabs" id="801339e8-ef40-4cba-ae84-d2003c9067f9"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#801339e8-ef40-4cba-ae84-d2003c9067f9-1"><i class="fas fa-bug"></i>ç¼–å†™docker-compose.yml</button></li><li class="tab"><button type="button" data-href="#801339e8-ef40-4cba-ae84-d2003c9067f9-2"><i class="fas fa-cannabis"></i>åˆ›å»ºé…ç½®æ–‡ä»¶</button></li><li class="tab"><button type="button" data-href="#801339e8-ef40-4cba-ae84-d2003c9067f9-3"><i class="fas fa-candy-cane"></i>å¯åŠ¨</button></li><li class="tab"><button type="button" data-href="#801339e8-ef40-4cba-ae84-d2003c9067f9-4"><i class="fas fa-child"></i>æŸ¥çœ‹å“¨å…µå…³ç³»</button></li><li class="tab"><button type="button" data-href="#801339e8-ef40-4cba-ae84-d2003c9067f9-5"><i class="fas fa-cookie-bite"></i>éªŒè¯æ•…éšœæ¢å¤</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="801339e8-ef40-4cba-ae84-d2003c9067f9-1"><p><code>mkdir -p /Users/fortune/soft/sentinel</code></p><p><code>vi /Users/fortune/soft/sentinel/docker-compose.yml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.1&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis-sentinel-1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-sentinel-1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">26379</span><span class="string">:26379</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-sentinel</span> <span class="string">/user/local/etc/redis/sentinel.conf</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sentinel1.conf:/user/local/etc/redis/sentinel.conf</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis-sentinel-2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-sentinel-2</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">26380</span><span class="string">:26379</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-sentinel</span> <span class="string">/user/local/etc/redis/sentinel.conf</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sentinel2.conf:/user/local/etc/redis/sentinel.conf</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis-sentinel-3:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-sentinel-3</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">26381</span><span class="string">:26379</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-sentinel</span> <span class="string">/user/local/etc/redis/sentinel.conf</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sentinel3.conf:/user/local/etc/redis/sentinel.conf</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="801339e8-ef40-4cba-ae84-d2003c9067f9-2"><p><code>vi /opt/docker/sentinel/sentinel1.conf</code></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">port</span> <span class="string">26379</span></span><br><span class="line"><span class="attr">dir</span> <span class="string">/tmp</span></span><br><span class="line"><span class="comment"># è‡ªå®šä¹‰é›†ç¾¤åï¼Œå…¶ä¸­ 192.168.8.188 ä¸º redis-master çš„ ipï¼Œ6379 ä¸º redis-master çš„ç«¯å£ï¼Œ2 ä¸ºæœ€å°æŠ•ç¥¨æ•°ï¼ˆå› ä¸ºæœ‰ 3 å° Sentinel æ‰€ä»¥å¯ä»¥è®¾ç½®æˆ 2ï¼‰</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">monitor mymaster 10.132.75.15 6379 2</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">down-after-milliseconds mymaster 30000</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">parallel-syncs mymaster 1</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">auth-pass mymaster test</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">failover-timeout mymaster 180000</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">deny-scripts-reconfig yes</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> sentinel1.conf sentinel2.conf</span><br><span class="line"><span class="built_in">cp</span> sentinel1.conf sentinel3.conf</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="801339e8-ef40-4cba-ae84-d2003c9067f9-3"><p><code>docker-compose up -d</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="801339e8-ef40-4cba-ae84-d2003c9067f9-4"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ0jl2rei3z6qtg79h1lbeZ sentinel]<span class="comment"># docker exec -it redis-sentinel-1 /bin/bash</span></span><br><span class="line">root@3d95304a04ff:/data<span class="comment"># redis-cli -p 26379</span></span><br><span class="line">127.0.0.1:26379&gt; INFO SENTINEL</span><br><span class="line"><span class="comment"># Sentinel</span></span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">sentinel_simulate_failure_flags:0</span><br><span class="line">master0:name=mymaster,status=ok,address=10.132.75.15:6379,slaves=2,sentinels=3</span><br></pre></td></tr></table></figure><p>æ„æ€æ˜¯xxxè¿™ä¸ªé›†ç¾¤å½“å‰çŠ¶æ€æ˜¯okçš„ï¼Œå½“å‰ä¸»redisæ˜¯6379ï¼Œæœ‰2ä¸ªä»redisï¼Œ 3ä¸ªsentinel</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="801339e8-ef40-4cba-ae84-d2003c9067f9-5"><p>å°è¯•è®©master7001èŠ‚ç‚¹å®•æœºï¼ŒæŸ¥çœ‹sentinelæ—¥å¿—ï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210701222857997.png" alt="image-20210701222857997" style="zoom:67%;" /><p>æŸ¥çœ‹7003çš„æ—¥å¿—ï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210701223025709.png" alt="image-20210701223025709" style="zoom:67%;" /><p>æŸ¥çœ‹7002çš„æ—¥å¿—ï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210701223131264.png" alt="image-20210701223131264" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="RedisTemplate">RedisTemplate</h3><p>åœ¨Sentinelé›†ç¾¤ç›‘ç®¡ä¸‹çš„Redisä¸»ä»é›†ç¾¤ï¼Œå…¶èŠ‚ç‚¹ä¼šå› ä¸ºè‡ªåŠ¨æ•…éšœè½¬ç§»è€Œå‘ç”Ÿå˜åŒ–ï¼ŒRedisçš„å®¢æˆ·ç«¯å¿…é¡»æ„ŸçŸ¥è¿™ç§å˜åŒ–ï¼ŒåŠæ—¶æ›´æ–°è¿æ¥ä¿¡æ¯ã€‚Springçš„RedisTemplateåº•å±‚åˆ©ç”¨lettuceå®ç°äº†èŠ‚ç‚¹çš„æ„ŸçŸ¥å’Œè‡ªåŠ¨åˆ‡æ¢ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªæµ‹è¯•æ¥å®ç°RedisTemplateé›†æˆå“¨å…µæœºåˆ¶ã€‚</p><div class="tabs" id="ff1a06f6-f9a8-4235-9707-f3b456739ae1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ff1a06f6-f9a8-4235-9707-f3b456739ae1-1"><i class="fas fa-cat"></i>å¼•å…¥ä¾èµ–</button></li><li class="tab"><button type="button" data-href="#ff1a06f6-f9a8-4235-9707-f3b456739ae1-2"><i class="fas fa-horse"></i>é…ç½®Redisåœ°å€</button></li><li class="tab"><button type="button" data-href="#ff1a06f6-f9a8-4235-9707-f3b456739ae1-3"><i class="fas fa-dove"></i>é…ç½®è¯»å†™åˆ†ç¦»</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ff1a06f6-f9a8-4235-9707-f3b456739ae1-1"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ff1a06f6-f9a8-4235-9707-f3b456739ae1-2"><p>ç„¶ååœ¨é…ç½®æ–‡ä»¶application.ymlä¸­æŒ‡å®šredisçš„sentinelç›¸å…³ä¿¡æ¯ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">master:</span> <span class="string">mymaster</span></span><br><span class="line">      <span class="attr">nodes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span><span class="string">:27001</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span><span class="string">:27002</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span><span class="string">:27003</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ff1a06f6-f9a8-4235-9707-f3b456739ae1-3"><p>åœ¨é¡¹ç›®çš„å¯åŠ¨ç±»ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªæ–°çš„beanï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> LettuceClientConfigurationBuilderCustomizer <span class="title function_">clientConfigurationBuilderCustomizer</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> clientConfigurationBuilder -&gt; clientConfigurationBuilder.readFrom(ReadFrom.REPLICA_PREFERRED);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªbeanä¸­é…ç½®çš„å°±æ˜¯è¯»å†™ç­–ç•¥ï¼ŒåŒ…æ‹¬å››ç§ï¼š</p><ul><li><code>MASTER</code>ï¼šä»ä¸»èŠ‚ç‚¹è¯»å–</li><li><code>MASTER_PREFERRED</code>ï¼šä¼˜å…ˆä»masterèŠ‚ç‚¹è¯»å–ï¼Œmasterä¸å¯ç”¨æ‰è¯»å–replica</li><li><code>REPLICA</code>ï¼šä»slaveï¼ˆreplicaï¼‰èŠ‚ç‚¹è¯»å–</li><li><code>REPLICA _PREFERRED</code>ï¼šä¼˜å…ˆä»slaveï¼ˆreplicaï¼‰èŠ‚ç‚¹è¯»å–ï¼Œæ‰€æœ‰çš„slaveéƒ½ä¸å¯ç”¨æ‰è¯»å–master</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="Redisåˆ†ç‰‡é›†ç¾¤">Redisåˆ†ç‰‡é›†ç¾¤</h2><h3 id="æ­å»ºåˆ†ç‰‡é›†ç¾¤">æ­å»ºåˆ†ç‰‡é›†ç¾¤</h3><p>ä¸»ä»å’Œå“¨å…µå¯ä»¥è§£å†³é«˜å¯ç”¨ã€é«˜å¹¶å‘è¯»çš„é—®é¢˜ã€‚ä½†æ˜¯ä¾ç„¶æœ‰ä¸¤ä¸ªé—®é¢˜æ²¡æœ‰è§£å†³ï¼š</p><ul><li><p>æµ·é‡æ•°æ®å­˜å‚¨é—®é¢˜</p></li><li><p>é«˜å¹¶å‘å†™çš„é—®é¢˜</p></li></ul><p>ä½¿ç”¨åˆ†ç‰‡é›†ç¾¤å¯ä»¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå¦‚å›¾:</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725155747294.png" alt="image-20210725155747294" style="zoom:67%;" /><p>åˆ†ç‰‡é›†ç¾¤ç‰¹å¾ï¼š</p><ul><li><p>é›†ç¾¤ä¸­æœ‰å¤šä¸ªmasterï¼Œæ¯ä¸ªmasterä¿å­˜ä¸åŒæ•°æ®</p></li><li><p>æ¯ä¸ªmasteréƒ½å¯ä»¥æœ‰å¤šä¸ªslaveèŠ‚ç‚¹</p></li><li><p>masterä¹‹é—´é€šè¿‡pingç›‘æµ‹å½¼æ­¤å¥åº·çŠ¶æ€</p></li><li><p>å®¢æˆ·ç«¯è¯·æ±‚å¯ä»¥è®¿é—®é›†ç¾¤ä»»æ„èŠ‚ç‚¹ï¼Œæœ€ç»ˆéƒ½ä¼šè¢«è½¬å‘åˆ°æ­£ç¡®èŠ‚ç‚¹</p></li></ul><div class="tabs" id="74a71bc3-53a7-4b6b-b3a7-25b60085ec85"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#74a71bc3-53a7-4b6b-b3a7-25b60085ec85-1"><i class="fas fa-seedling"></i>åˆ›å»ºæ–‡ä»¶</button></li><li class="tab"><button type="button" data-href="#74a71bc3-53a7-4b6b-b3a7-25b60085ec85-2"><i class="fas fa-leaf"></i>redis.conf</button></li><li class="tab"><button type="button" data-href="#74a71bc3-53a7-4b6b-b3a7-25b60085ec85-3"><i class="fab fa-apple"></i>åˆ›å»º6ä¸ªRediså®¹å™¨</button></li><li class="tab"><button type="button" data-href="#74a71bc3-53a7-4b6b-b3a7-25b60085ec85-4"><i class="fas fa-tree"></i>4</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="74a71bc3-53a7-4b6b-b3a7-25b60085ec85-1"><p>åˆ›å»º6ä¸ªæ–‡ä»¶å¤¹ï¼Œåˆ†åˆ«å¯¹åº”3ä¸»3ä»,domæ ‘å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@192 redis]<span class="comment"># tree</span></span><br><span class="line">â”œâ”€â”€ 7001</span><br><span class="line">â”‚   â”œâ”€â”€ conf</span><br><span class="line">â”‚   â”‚   â””â”€â”€ redis.conf</span><br><span class="line">â”‚   â””â”€â”€ data</span><br><span class="line">â”œâ”€â”€ 7002</span><br><span class="line">â”‚   â”œâ”€â”€ conf</span><br><span class="line">â”‚   â”‚   â””â”€â”€ redis.conf</span><br><span class="line">â”‚   â””â”€â”€ data</span><br><span class="line">â”œâ”€â”€ 7003</span><br><span class="line">â”‚   â”œâ”€â”€ conf</span><br><span class="line">â”‚   â”‚   â””â”€â”€ redis.conf</span><br><span class="line">â”‚   â””â”€â”€ data</span><br><span class="line">â”œâ”€â”€ 7004</span><br><span class="line">â”‚   â”œâ”€â”€ conf</span><br><span class="line">â”‚   â”‚   â””â”€â”€ redis.conf</span><br><span class="line">â”‚   â””â”€â”€ data</span><br><span class="line">â”œâ”€â”€ 7005</span><br><span class="line">â”‚   â”œâ”€â”€ conf</span><br><span class="line">â”‚   â”‚   â””â”€â”€ redis.conf</span><br><span class="line">â”‚   â””â”€â”€ data</span><br><span class="line">â””â”€â”€ 7006</span><br><span class="line">    â”œâ”€â”€ conf</span><br><span class="line">    â”‚   â””â”€â”€ redis.conf</span><br><span class="line">    â””â”€â”€ data</span><br><span class="line">18 directories, 6 files</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="74a71bc3-53a7-4b6b-b3a7-25b60085ec85-2"><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redisç«¯å£ï¼Œä¸åŒèŠ‚ç‚¹ç«¯å£ä¸åŒåˆ†åˆ«æ˜¯7001 7002 7003 7004 7005 7006</span></span><br><span class="line"><span class="attr">port</span> <span class="string">7001</span></span><br><span class="line"><span class="comment">#redis è®¿é—®å¯†ç </span></span><br><span class="line"><span class="comment">#requirepass 123456</span></span><br><span class="line"><span class="comment">#redis è®¿é—®MasterèŠ‚ç‚¹å¯†ç </span></span><br><span class="line"><span class="comment">#masterauth 123456</span></span><br><span class="line"><span class="comment"># å…³é—­ä¿æŠ¤æ¨¡å¼</span></span><br><span class="line"><span class="attr">protected-mode</span> <span class="string">no</span></span><br><span class="line"><span class="comment"># å¼€å¯é›†ç¾¤</span></span><br><span class="line"><span class="attr">cluster-enabled</span> <span class="string">yes</span></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹é…ç½®</span></span><br><span class="line"><span class="attr">cluster-config-file</span> <span class="string">nodes.conf</span></span><br><span class="line"><span class="comment"># è¶…æ—¶</span></span><br><span class="line"><span class="attr">cluster-node-timeout</span> <span class="string">5000</span></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹IP hostæ¨¡å¼ä¸ºå®¿ä¸»æœºIP</span></span><br><span class="line"><span class="attr">cluster-announce-ip</span> <span class="string">192.168.25.129</span></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹ç«¯å£ 7001 - 7006</span></span><br><span class="line"><span class="attr">cluster-announce-port</span> <span class="string">7001</span></span><br><span class="line"><span class="attr">cluster-announce-bus-port</span> <span class="string">17001</span></span><br><span class="line"><span class="comment"># å¼€å¯ appendonly å¤‡ä»½æ¨¡å¼</span></span><br><span class="line"><span class="attr">appendonly</span> <span class="string">yes</span></span><br><span class="line"><span class="comment"># æ¯ç§’é’Ÿå¤‡ä»½</span></span><br><span class="line"><span class="attr">appendfsync</span> <span class="string">everysec</span></span><br><span class="line"><span class="comment"># å¯¹aofæ–‡ä»¶è¿›è¡Œå‹ç¼©æ—¶ï¼Œæ˜¯å¦æ‰§è¡ŒåŒæ­¥æ“ä½œ</span></span><br><span class="line"><span class="attr">no-appendfsync-on-rewrite</span> <span class="string">no</span></span><br><span class="line"><span class="comment"># å½“ç›®å‰aofæ–‡ä»¶å¤§å°è¶…è¿‡ä¸Šä¸€æ¬¡é‡å†™æ—¶çš„aofæ–‡ä»¶å¤§å°çš„100%æ—¶ä¼šå†æ¬¡è¿›è¡Œé‡å†™</span></span><br><span class="line"><span class="attr">auto-aof-rewrite-percentage</span> <span class="string">100</span></span><br><span class="line"><span class="comment"># é‡å†™å‰AOFæ–‡ä»¶çš„å¤§å°æœ€å°å€¼ é»˜è®¤ 64mb</span></span><br><span class="line"><span class="attr">auto-aof-rewrite-min-size</span> <span class="string">64mb</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># æ—¥å¿—é…ç½®</span></span><br><span class="line"><span class="comment"># de<span class="doctag">bug:</span>ä¼šæ‰“å°ç”Ÿæˆå¤§é‡ä¿¡æ¯ï¼Œé€‚ç”¨äºå¼€å‘/æµ‹è¯•é˜¶æ®µ</span></span><br><span class="line"><span class="comment"># verbose:åŒ…å«å¾ˆå¤šä¸å¤ªæœ‰ç”¨çš„ä¿¡æ¯ï¼Œä½†æ˜¯ä¸åƒdebugçº§åˆ«é‚£ä¹ˆæ··ä¹±</span></span><br><span class="line"><span class="comment"># notice:é€‚åº¦å†—é•¿ï¼Œé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒ</span></span><br><span class="line"><span class="comment"># warning:ä»…è®°å½•éå¸¸é‡è¦ã€å…³é”®çš„è­¦å‘Šæ¶ˆæ¯</span></span><br><span class="line"><span class="attr">loglevel</span> <span class="string">notice</span></span><br><span class="line"><span class="comment"># æ—¥å¿—æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="attr">logfile</span> <span class="string">&quot;/data/redis.log&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="74a71bc3-53a7-4b6b-b3a7-25b60085ec85-3"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºå®¹å™¨redis-master7001</span></span><br><span class="line">[root@192 redis]<span class="comment"># docker run -d --name redis-master7001 -p 7001:7001 -p 17001:17001 -v /home/docker/redis/7001/conf/redis.conf:/etc/local/redis/redis.conf -v /home/docker/redis/7001/data/:/data redis /etc/local/redis/redis.conf</span></span><br><span class="line">f7cb69c25237cd3fdbd0dbb2665915817ec225f5c71d2e84a5bea7c80a8aabca</span><br><span class="line"><span class="comment"># åˆ›å»ºå®¹å™¨redis-master7002</span></span><br><span class="line">[root@192 redis]<span class="comment"># docker run -d --name redis-master7002 -p 7002:7002 -p 17002:17002 -v /home/docker/redis/7002/conf/redis.conf:/etc/local/redis/redis.conf -v /home/docker/redis/7002/data/:/data redis /etc/local/redis/redis.conf</span></span><br><span class="line">c43a93be0336de6b3414df35c607685091ba21739b1541bc699680da9cb498f1</span><br><span class="line"><span class="comment"># åˆ›å»ºå®¹å™¨redis-master7003</span></span><br><span class="line">[root@192 redis]<span class="comment"># docker run -d --name redis-master7003 -p 7003:7003 -p 17003:17003 -v /home/docker/redis/7003/conf/redis.conf:/etc/local/redis/redis.conf -v /home/docker/redis/7003/data/:/data redis /etc/local/redis/redis.conf</span></span><br><span class="line">e09d957b7e91b94ddd8ec1b64f2df20c601684634488d1c7915bcb785bae7960</span><br><span class="line"><span class="comment"># åˆ›å»ºå®¹å™¨redis-slave7004</span></span><br><span class="line">[root@192 redis]<span class="comment"># docker run -d --name redis-slave7004 -p 7004:7004 -p 17004:17004 -v /home/docker/redis/7004/conf/redis.conf:/etc/local/redis/redis.conf -v /home/docker/redis/7004/data/:/data redis /etc/local/redis/redis.conf</span></span><br><span class="line">4581f424484d83a46b533fbb6e33e15af9d7074aa1237fcc3b07b91246dce581</span><br><span class="line"><span class="comment"># åˆ›å»ºå®¹å™¨redis-slave7005</span></span><br><span class="line">[root@192 redis]<span class="comment"># docker run -d --name redis-slave7005 -p 7005:7005 -p 17005:17005 -v /home/docker/redis/7005/conf/redis.conf:/etc/local/redis/redis.conf -v /home/docker/redis/7005/data/:/data redis /etc/local/redis/redis.conf</span></span><br><span class="line">ce67f012b23e8a92f0b43fc397bf5723456cda6beaff513c11789b52b98afde9</span><br><span class="line"><span class="comment"># åˆ›å»ºå®¹å™¨redis-slave7006</span></span><br><span class="line">[root@192 redis]<span class="comment"># docker run -d --name redis-slave7006 -p 7006:7006 -p 17006:17006 -v /home/docker/redis/7006/conf/redis.conf:/etc/local/redis/redis.conf -v /home/docker/redis/7006/data/:/data redis /etc/local/redis/redis.conf</span></span><br><span class="line">14e77785503cfd7bbfaf3177f1442f507d74265020f9aedbeecb46f692e54de9</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="74a71bc3-53a7-4b6b-b3a7-25b60085ec85-4"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h1>å¤šçº§ç¼“å­˜</h1><h2 id="ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜">ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜</h2><p>ä¼ ç»Ÿçš„ç¼“å­˜ç­–ç•¥ä¸€èˆ¬æ˜¯è¯·æ±‚åˆ°è¾¾Tomcatåï¼Œå…ˆæŸ¥è¯¢Redisï¼Œå¦‚æœæœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¦‚å›¾ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210821075259137.png" alt="image-20210821075259137"></p><p>å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š</p><p>â€¢è¯·æ±‚è¦ç»è¿‡Tomcatå¤„ç†ï¼ŒTomcatçš„æ€§èƒ½æˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆ</p><p>â€¢Redisç¼“å­˜å¤±æ•ˆæ—¶ï¼Œä¼šå¯¹æ•°æ®åº“äº§ç”Ÿå†²å‡»</p><p>å¤šçº§ç¼“å­˜å°±æ˜¯å……åˆ†åˆ©ç”¨è¯·æ±‚å¤„ç†çš„æ¯ä¸ªç¯èŠ‚ï¼Œåˆ†åˆ«æ·»åŠ ç¼“å­˜ï¼Œå‡è½»Tomcatå‹åŠ›ï¼Œæå‡æœåŠ¡æ€§èƒ½ï¼š</p><ul><li>æµè§ˆå™¨è®¿é—®é™æ€èµ„æºæ—¶ï¼Œä¼˜å…ˆè¯»å–æµè§ˆå™¨æœ¬åœ°ç¼“å­˜</li><li>è®¿é—®éé™æ€èµ„æºï¼ˆajaxæŸ¥è¯¢æ•°æ®ï¼‰æ—¶ï¼Œè®¿é—®æœåŠ¡ç«¯</li><li>è¯·æ±‚åˆ°è¾¾Nginxåï¼Œä¼˜å…ˆè¯»å–Nginxæœ¬åœ°ç¼“å­˜</li><li>å¦‚æœNginxæœ¬åœ°ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™å»ç›´æ¥æŸ¥è¯¢Redisï¼ˆä¸ç»è¿‡Tomcatï¼‰</li><li>å¦‚æœRedisæŸ¥è¯¢æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢Tomcat</li><li>è¯·æ±‚è¿›å…¥Tomcatåï¼Œä¼˜å…ˆæŸ¥è¯¢JVMè¿›ç¨‹ç¼“å­˜</li><li>å¦‚æœJVMè¿›ç¨‹ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210821075558137.png" alt="image-20210821075558137"></p><p>åœ¨å¤šçº§ç¼“å­˜æ¶æ„ä¸­ï¼ŒNginxå†…éƒ¨éœ€è¦ç¼–å†™æœ¬åœ°ç¼“å­˜æŸ¥è¯¢ã€RedisæŸ¥è¯¢ã€TomcatæŸ¥è¯¢çš„ä¸šåŠ¡é€»è¾‘ï¼Œå› æ­¤è¿™æ ·çš„nginxæœåŠ¡ä¸å†æ˜¯ä¸€ä¸ª<strong>åå‘ä»£ç†æœåŠ¡å™¨</strong>ï¼Œè€Œæ˜¯ä¸€ä¸ªç¼–å†™<strong>ä¸šåŠ¡çš„WebæœåŠ¡å™¨äº†</strong>ã€‚</p><p>å› æ­¤è¿™æ ·çš„ä¸šåŠ¡NginxæœåŠ¡ä¹Ÿéœ€è¦æ­å»ºé›†ç¾¤æ¥æé«˜å¹¶å‘ï¼Œå†æœ‰ä¸“é—¨çš„nginxæœåŠ¡æ¥åšåå‘ä»£ç†ï¼Œå¦‚å›¾ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210821080511581.png" alt="image-20210821080511581"></p><p>å¦å¤–ï¼Œæˆ‘ä»¬çš„TomcatæœåŠ¡å°†æ¥ä¹Ÿä¼šéƒ¨ç½²ä¸ºé›†ç¾¤æ¨¡å¼ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210821080954947.png" alt="image-20210821080954947"></p><p>å¯è§ï¼Œå¤šçº§ç¼“å­˜çš„å…³é”®æœ‰ä¸¤ä¸ªï¼š</p><ul><li><p>ä¸€ä¸ªæ˜¯åœ¨nginxä¸­ç¼–å†™ä¸šåŠ¡ï¼Œå®ç°nginxæœ¬åœ°ç¼“å­˜ã€Redisã€Tomcatçš„æŸ¥è¯¢</p></li><li><p>å¦ä¸€ä¸ªå°±æ˜¯åœ¨Tomcatä¸­å®ç°JVMè¿›ç¨‹ç¼“å­˜</p></li></ul><p>å…¶ä¸­Nginxç¼–ç¨‹åˆ™ä¼šç”¨åˆ°OpenRestyæ¡†æ¶ç»“åˆLuaè¿™æ ·çš„è¯­è¨€ã€‚</p><hr><hr><h2 id="JVMè¿›ç¨‹ç¼“å­˜">JVMè¿›ç¨‹ç¼“å­˜</h2><blockquote><p>ä¸ºäº†æ¼”ç¤ºå¤šçº§ç¼“å­˜çš„æ¡ˆä¾‹ï¼Œæˆ‘ä»¬å…ˆå‡†å¤‡ä¸€ä¸ªå•†å“æŸ¥è¯¢çš„ä¸šåŠ¡ã€‚</p></blockquote><hr><hr><h2 id="Luaè¯­æ³•å…¥é—¨">Luaè¯­æ³•å…¥é—¨</h2><hr><hr><h2 id="å®ç°å¤šçº§ç¼“å­˜">å®ç°å¤šçº§ç¼“å­˜</h2><hr><hr><h2 id="ç¼“å­˜åŒæ­¥">ç¼“å­˜åŒæ­¥</h2><h1>æœ€ä½³å®è·µ</h1><hr><hr><h2 id="Redisé”®å€¼è®¾è®¡">Redisé”®å€¼è®¾è®¡</h2><p>Redisçš„Keyè™½ç„¶å¯ä»¥è‡ªå®šä¹‰ï¼Œä½†æœ€å¥½éµå¾ªä¸‹é¢çš„å‡ ä¸ªæœ€ä½³å®è·µçº¦å®šï¼š</p><ul><li>éµå¾ªåŸºæœ¬æ ¼å¼ï¼š[ä¸šåŠ¡åç§°]:[æ•°æ®å]:[id]</li><li>é•¿åº¦ä¸è¶…è¿‡44å­—èŠ‚</li><li>ä¸åŒ…å«ç‰¹æ®Šå­—ç¬¦</li></ul><p>ä¾‹å¦‚ï¼šæˆ‘ä»¬çš„ç™»å½•ä¸šåŠ¡ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œå…¶keyå¯ä»¥è®¾è®¡æˆå¦‚ä¸‹æ ¼å¼ï¼š</p><hr><hr><h2 id="æ‰¹å¤„ç†ä¼˜åŒ–">æ‰¹å¤„ç†ä¼˜åŒ–</h2><hr><hr><h2 id="æŒä¹…åŒ–é…ç½®">æŒä¹…åŒ–é…ç½®</h2><hr><hr><h2 id="æ…¢æŸ¥è¯¢ä¼˜åŒ–">æ…¢æŸ¥è¯¢ä¼˜åŒ–</h2><hr><hr><h2 id="å‘½ä»¤åŠå®‰å…¨é…ç½®">å‘½ä»¤åŠå®‰å…¨é…ç½®</h2><hr><hr><h2 id="Rediså†…å­˜åˆ’åˆ†å’Œå†…å­˜é…ç½®">Rediså†…å­˜åˆ’åˆ†å’Œå†…å­˜é…ç½®</h2><hr><hr><h2 id="é›†ç¾¤è¿˜æ˜¯ä¸»ä»">é›†ç¾¤è¿˜æ˜¯ä¸»ä»</h2>]]></content>
    
    
    <summary type="html">åˆ†å¸ƒå¼ç¼“å­˜ã€å¤šçº§ç¼“å­˜ã€Redisæœ€ä½³å®è·µ</summary>
    
    
    
    <category term="æ•°æ®åº“" scheme="https://wuwawawa.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="Redis" scheme="https://wuwawawa.github.io/tags/Redis/"/>
    
    <category term="æ•°æ®åº“" scheme="https://wuwawawa.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>Rediså®æˆ˜</title>
    <link href="https://wuwawawa.github.io/posts/1bd023c5.html"/>
    <id>https://wuwawawa.github.io/posts/1bd023c5.html</id>
    <published>2023-06-07T01:27:51.000Z</published>
    <updated>2023-06-12T05:12:22.945Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æŸ¥è¯¢ç¼“å­˜">æŸ¥è¯¢ç¼“å­˜</h2><h3 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç¼“å­˜">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç¼“å­˜</h3><p>ä¸€å¥è¯:å› ä¸º<span class='p green'>é€Ÿåº¦å¿«å¥½ç”¨</span></p><p>ç¼“å­˜æ•°æ®å­˜å‚¨äºä»£ç ä¸­,è€Œä»£ç è¿è¡Œåœ¨å†…å­˜ä¸­,å†…å­˜çš„è¯»å†™æ€§èƒ½è¿œé«˜äºç£ç›˜,ç¼“å­˜å¯ä»¥å¤§å¤§é™ç”¨æˆ·è®¿é—®å¹¶å‘é‡å¸¦æ¥çš„æœåŠ¡å™¨è¯»å†™å‹åŠ›</p><p>å®é™…å¼€å‘è¿‡ç¨‹ä¸­,ä¼ä¸šçš„æ•°æ®é‡,å°‘åˆ™å‡ åä¸‡,å¤šåˆ™å‡ åƒä¸‡,è¿™ä¹ˆå¤§æ•°æ®é‡,å¦‚æœæ²¡æœ‰ç¼“å­˜æ¥ä½œä¸º&quot;é¿éœ‡å™¨&quot;,ç³»ç»Ÿæ˜¯å‡ ä¹æ’‘ä¸ä½çš„,æ‰€ä»¥ä¼ä¸šä¼šå¤§é‡è¿ç”¨åˆ°ç¼“å­˜æŠ€æœ¯;</p><p>ä½†æ˜¯ç¼“å­˜ä¹Ÿä¼šå¢åŠ ä»£ç å¤æ‚åº¦å’Œè¿è¥çš„æˆæœ¬:</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220523214414123.png" alt="image-20220523214414123" style="zoom:67%;" /><hr><h3 id="å¦‚ä½•ä½¿ç”¨ç¼“å­˜">å¦‚ä½•ä½¿ç”¨ç¼“å­˜</h3><p>å®é™…å¼€å‘ä¸­,ä¼šæ„ç­‘å¤šçº§ç¼“å­˜æ¥ä½¿ç³»ç»Ÿè¿è¡Œé€Ÿåº¦è¿›ä¸€æ­¥æå‡,ä¾‹å¦‚:æœ¬åœ°ç¼“å­˜ä¸redisä¸­çš„ç¼“å­˜å¹¶å‘ä½¿ç”¨</p><p>æµè§ˆå™¨ç¼“å­˜ï¼šä¸»è¦æ˜¯å­˜åœ¨äºæµè§ˆå™¨ç«¯çš„ç¼“å­˜</p><p>åº”ç”¨å±‚ç¼“å­˜ï¼šå¯ä»¥åˆ†ä¸ºtomcatæœ¬åœ°ç¼“å­˜ï¼Œæ¯”å¦‚ä¹‹å‰æåˆ°çš„mapï¼Œæˆ–è€…æ˜¯ä½¿ç”¨redisä½œä¸ºç¼“å­˜</p><p>æ•°æ®åº“ç¼“å­˜ï¼šåœ¨æ•°æ®åº“ä¸­æœ‰ä¸€ç‰‡ç©ºé—´æ˜¯ buffer poolï¼Œå¢æ”¹æŸ¥æ•°æ®éƒ½ä¼šå…ˆåŠ è½½åˆ°mysqlçš„ç¼“å­˜ä¸­</p><p>CPUç¼“å­˜ï¼šå½“ä»£è®¡ç®—æœºæœ€å¤§çš„é—®é¢˜æ˜¯ cpuæ€§èƒ½æå‡äº†ï¼Œä½†å†…å­˜è¯»å†™é€Ÿåº¦æ²¡æœ‰è·Ÿä¸Šï¼Œæ‰€ä»¥ä¸ºäº†é€‚åº”å½“ä¸‹çš„æƒ…å†µï¼Œå¢åŠ äº†cpuçš„L1ï¼ŒL2ï¼ŒL3çº§çš„ç¼“å­˜</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220523212915666.png" alt="image-20220523212915666" style="zoom:67%;" /><hr><h3 id="æ·»åŠ ç¼“å­˜ç¤ºä¾‹">æ·»åŠ ç¼“å­˜ç¤ºä¾‹</h3><div class="tabs" id="84f6d553-6ab6-4b83-b7b7-552490e051a5"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#84f6d553-6ab6-4b83-b7b7-552490e051a5-1"><i class="fas fa-seedling"></i>åŸæœ¬æ“ä½œ</button></li><li class="tab"><button type="button" data-href="#84f6d553-6ab6-4b83-b7b7-552490e051a5-2"><i class="fas fa-leaf"></i>æ”¹è¿›æ€è·¯</button></li><li class="tab"><button type="button" data-href="#84f6d553-6ab6-4b83-b7b7-552490e051a5-3"><i class="fab fa-apple"></i>å®ç°ä»£ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="84f6d553-6ab6-4b83-b7b7-552490e051a5-1"><p>åœ¨æˆ‘ä»¬æŸ¥è¯¢å•†æˆ·ä¿¡æ¯æ—¶ï¼Œæˆ‘ä»¬æ˜¯ç›´æ¥æ“ä½œä»æ•°æ®åº“ä¸­å»è¿›è¡ŒæŸ¥è¯¢çš„ï¼Œå¤§è‡´é€»è¾‘æ˜¯è¿™æ ·ï¼Œç›´æ¥æŸ¥è¯¢æ•°æ®åº“é‚£è‚¯å®šæ…¢å’¯ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¢åŠ ç¼“å­˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//è¿™é‡Œæ˜¯ç›´æ¥æŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">    <span class="keyword">return</span> shopService.queryById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="84f6d553-6ab6-4b83-b7b7-552490e051a5-2"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653322097736.png" alt="1653322097736" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="84f6d553-6ab6-4b83-b7b7-552490e051a5-3"><p>ä»£ç æ€è·¯ï¼šå¦‚æœç¼“å­˜æœ‰ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå¦‚æœç¼“å­˜ä¸å­˜åœ¨ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åå­˜å…¥redisã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653322190155.png" alt="1653322190155" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="ç¼“å­˜æ›´æ–°ç­–ç•¥">ç¼“å­˜æ›´æ–°ç­–ç•¥</h3><p>ç¼“å­˜æ›´æ–°æ˜¯redisä¸ºäº†èŠ‚çº¦å†…å­˜è€Œè®¾è®¡å‡ºæ¥çš„ä¸€ä¸ªä¸œè¥¿ï¼Œä¸»è¦æ˜¯å› ä¸ºå†…å­˜æ•°æ®å®è´µï¼Œå½“æˆ‘ä»¬å‘redisæ’å…¥å¤ªå¤šæ•°æ®ï¼Œæ­¤æ—¶å°±å¯èƒ½ä¼šå¯¼è‡´ç¼“å­˜ä¸­çš„æ•°æ®è¿‡å¤šï¼Œæ‰€ä»¥redisä¼šå¯¹éƒ¨åˆ†æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œæˆ–è€…æŠŠä»–å«ä¸ºæ·˜æ±°æ›´åˆé€‚ã€‚</p><p>å†…å­˜æ·˜æ±°ï¼šredisè‡ªåŠ¨è¿›è¡Œï¼Œå½“rediså†…å­˜è¾¾åˆ°å’±ä»¬è®¾å®šçš„max-memeryçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨è§¦å‘æ·˜æ±°æœºåˆ¶ï¼Œæ·˜æ±°æ‰ä¸€äº›ä¸é‡è¦çš„æ•°æ®(å¯ä»¥è‡ªå·±è®¾ç½®ç­–ç•¥æ–¹å¼)</p><p>è¶…æ—¶å‰”é™¤ï¼šå½“æˆ‘ä»¬ç»™redisè®¾ç½®äº†è¿‡æœŸæ—¶é—´ttlä¹‹åï¼Œredisä¼šå°†è¶…æ—¶çš„æ•°æ®è¿›è¡Œåˆ é™¤ï¼Œæ–¹ä¾¿å’±ä»¬ç»§ç»­ä½¿ç”¨ç¼“å­˜</p><p>ä¸»åŠ¨æ›´æ–°ï¼šæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨è°ƒç”¨æ–¹æ³•æŠŠç¼“å­˜åˆ æ‰ï¼Œé€šå¸¸ç”¨äºè§£å†³ç¼“å­˜å’Œæ•°æ®åº“ä¸ä¸€è‡´é—®é¢˜</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">å†…å­˜æ·˜æ±°</th><th style="text-align:center">è¶…æ—¶å‰”é™¤</th><th style="text-align:center">ä¸»åŠ¨æ›´æ–°</th></tr></thead><tbody><tr><td style="text-align:center">è¯´æ˜</td><td style="text-align:center">ä¸ç”¨è‡ªå·±ç»´æŠ¤ï¼Œåˆ©ç”¨Redisçš„å…§å­˜æ·˜æ±°æœºåˆ¶ï¼Œå½“å†…å­˜ä¸è¶³æ—¶è‡ªåŠ¨æ·˜æ±°éƒ¨åˆ†æ•°æ®ã€‚ä¸‹æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ç¼“å­˜ã€‚</td><td style="text-align:center">ç»™ç¼“å­˜æ•°æ®æ·»åŠ TTLæ—¶é—´ï¼Œåˆ°æœŸåè‡ªåŠ¨åˆ é™¤ç¼“å­˜ã€‚ä¸‹æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ç¼“å­˜ã€‚</td><td style="text-align:center">ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œåœ¨ä¿®æ”¹æ•°æ®åº“çš„åŒæ—¶ï¼Œæ›´æ–°ç¼“å­˜ã€‚</td></tr><tr><td style="text-align:center">ä¸€è‡´æ€§</td><td style="text-align:center">å·®</td><td style="text-align:center">ä¸€èˆ¬</td><td style="text-align:center">å¥½</td></tr><tr><td style="text-align:center">ç»´æŠ¤æˆæœ¬</td><td style="text-align:center">æ— </td><td style="text-align:center">åº•</td><td style="text-align:center">é«˜</td></tr></tbody></table><p>ä¸šåŠ¡åœºæ™¯ï¼š</p><p>ä½ä¸€è‡´æ€§éœ€æ±‚ï¼šä½¿ç”¨å†…å­˜æ·˜æ±°æœºåˆ¶ã€‚ä¾‹å¦‚åº—é“ºç±»å‹çš„æŸ¥è¯¢ç¼“å­˜</p><p>é«˜ä¸€è‡´æ€§éœ€æ±‚ï¼šä¸»åŠ¨æ›´æ–°ï¼Œå¹¶ä»¥è¶…æ—¶å‰”é™¤ä½œä¸ºå…œåº•æ–¹æ¡ˆã€‚ä¾‹å¦‚åº—é“ºè¯¦æƒ…æŸ¥è¯¢çš„ç¼“å­˜</p><hr><p>ä¸»åŠ¨æ›´æ–°ä¸šåŠ¡å®ç°å¸¸è§çš„æœ‰ä¸‰ç§æ¨¡å¼ï¼š</p><p>Cache Aside Patternï¼šç”±ç¼“å­˜çš„è°ƒç”¨è€…ï¼Œåœ¨æ›´æ–°æ•°æ®åº“çš„åŒæ—¶æ›´æ–°ç¼“å­˜</p><p>Read/Write Through Patternï¼šç¼“å­˜ä¸æ•°æ®åº“æ•´åˆä¸ºä¸€ä¸ªæœåŠ¡ï¼Œ ç”±æœåŠ¡æ¥ç»´æŠ¤ä¸€è‡´æ€§ã€‚è°ƒç”¨è€…è°ƒç”¨è¯¥æœåŠ¡ï¼Œæ— éœ€å…³å¿ƒç¼“å­˜ä¸€è‡´æ€§é—®é¢˜</p><p>Write Behind Caching Patternï¼šè°ƒç”¨è€…åªæ“ä½œç¼“å­˜ï¼Œç”±å…¶å®ƒçº¿ç¨‹å¼‚æ­¥çš„å°†ç¼“å­˜æ•°æ®æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨æœ€å¤šçš„è¿˜æ˜¯æ–¹æ¡ˆä¸€ï¼šCache Aside Patternã€‚</p><p>å› æ­¤åœ¨ç¼–ç è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘å‡ ä¸ªé—®é¢˜</p><mark class="hl-label blue">åˆ é™¤ç¼“å­˜è¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ</mark> <ul><li><span class='p red'>æ›´æ–°ç¼“å­˜</span>ï¼šæ¯æ¬¡æ›´æ–°æ•°æ®åº“éƒ½æ›´æ–°ç¼“å­˜ï¼Œæ— æ•ˆå†™æ“ä½œè¾ƒå¤šâŒ</li><li><span class='p green'>åˆ é™¤ç¼“å­˜</span>ï¼šæ›´æ–°æ•°æ®åº“æ—¶è®©ç¼“å­˜å¤±æ•ˆï¼ŒæŸ¥è¯¢æ—¶å†æ›´æ–°ç¼“å­˜âœ…</li></ul><mark class="hl-label blue">å¦‚ä½•ä¿è¯ç¼“å­˜ä¸æ•°æ®åº“çš„æ“ä½œçš„åŒæ—¶æˆåŠŸæˆ–å¤±è´¥ï¼Ÿ</mark> <ul><li>å•ä½“ç³»ç»Ÿï¼Œå°†ç¼“å­˜ä¸æ•°æ®åº“æ“ä½œæ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡</li><li>åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåˆ©ç”¨TCCç­‰åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ</li></ul><mark class="hl-label blue">å…ˆæ“ä½œç¼“å­˜è¿˜æ˜¯å…ˆæ“ä½œæ•°æ®åº“ï¼Ÿ</mark> <ul><li><span class='p red'>å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ“ä½œæ•°æ®åº“</span>âŒ</li><li><span class='p green'>å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</span>âœ…</li></ul><p>æˆ‘ä»¬åº”å½“æ˜¯å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ï¼ŒåŸå› åœ¨äºï¼Œå¦‚æœä½ é€‰æ‹©ç¬¬ä¸€ç§æ–¹æ¡ˆï¼Œåœ¨ä¸¤ä¸ªçº¿ç¨‹å¹¶å‘æ¥è®¿é—®æ—¶ï¼Œå‡è®¾çº¿ç¨‹1å…ˆæ¥ï¼Œä»–å…ˆæŠŠç¼“å­˜åˆ äº†ï¼Œæ­¤æ—¶çº¿ç¨‹2è¿‡æ¥ï¼Œä»–æŸ¥è¯¢ç¼“å­˜æ•°æ®å¹¶ä¸å­˜åœ¨ï¼Œæ­¤æ—¶ä»–å†™å…¥ç¼“å­˜ï¼Œå½“ä»–å†™å…¥ç¼“å­˜åï¼Œçº¿ç¨‹1å†æ‰§è¡Œæ›´æ–°åŠ¨ä½œæ—¶ï¼Œå®é™…ä¸Šå†™å…¥çš„å°±æ˜¯æ—§çš„æ•°æ®ï¼Œæ–°çš„æ•°æ®è¢«æ—§æ•°æ®è¦†ç›–äº†ã€‚</p><p>æ–¹æ¡ˆäºŒåŒæ ·å¯èƒ½å‘ç”Ÿä¸ä¸€è‡´é—®é¢˜ï¼Œå½“çº¿ç¨‹1æŸ¥è¯¢æ—¶ç¼“å­˜åˆšå¥½å¤±æ•ˆäº†ï¼Œæ­¤æ—¶çº¿ç¨‹2è¿‡æ¥æ›´æ–°æ•°æ®åº“åˆ é™¤ç¼“å­˜ï¼Œçº¿ç¨‹1å†æŠŠæ—§æ•°æ®å†™å…¥ç¼“å­˜ã€‚ä½†æ˜¯è¿™ç§æƒ…å†µç›¸å¯¹æ¥è¯´å‡ºç°çš„å¯èƒ½æ€§æ¯”è¾ƒä½ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653323595206.png" alt="1653323595206" style="zoom:67%;" /><mark class="hl-label blue">ä»£ç å®ç°</mark> <div class="tabs" id="e590ce20-d8fc-4b54-bf5b-e8ff4675c66e"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e590ce20-d8fc-4b54-bf5b-e8ff4675c66e-1"><i class="fas fa-bug"></i>æ ¸å¿ƒæ€è·¯</button></li><li class="tab"><button type="button" data-href="#e590ce20-d8fc-4b54-bf5b-e8ff4675c66e-2"><i class="fas fa-cannabis"></i>è®¾ç½®redisç¼“å­˜æ—¶æ·»åŠ è¿‡æœŸæ—¶é—´</button></li><li class="tab"><button type="button" data-href="#e590ce20-d8fc-4b54-bf5b-e8ff4675c66e-3"><i class="fas fa-candy-cane"></i>æ›´æ–°æ•°æ®åº“æ—¶åˆ é™¤ç¼“å­˜</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e590ce20-d8fc-4b54-bf5b-e8ff4675c66e-1"><p>æ ¸å¿ƒæ€è·¯å¦‚ä¸‹ï¼š</p><p>ä¿®æ”¹ShopControllerä¸­çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ»¡è¶³ä¸‹é¢çš„éœ€æ±‚ï¼š</p><p>æ ¹æ®idæŸ¥è¯¢åº—é“ºæ—¶ï¼Œå¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå°†æ•°æ®åº“ç»“æœå†™å…¥ç¼“å­˜ï¼Œå¹¶è®¾ç½®è¶…æ—¶æ—¶é—´</p><p>æ ¹æ®idä¿®æ”¹åº—é“ºæ—¶ï¼Œå…ˆä¿®æ”¹æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e590ce20-d8fc-4b54-bf5b-e8ff4675c66e-2"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653325871232.png" alt="1653325871232"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e590ce20-d8fc-4b54-bf5b-e8ff4675c66e-3"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653325929549.png" alt="1653325929549"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><mark class="hl-label blue">æ€»ç»“ï¼šç¼“å­˜æ›´æ–°ç­–ç•¥çš„æœ€ä½³å®è·µæ–¹æ¡ˆ</mark> <p>1.ä½ä¸€è‡´æ€§éœ€æ±‚ï¼šä½¿ç”¨Redisè‡ªå¸¦çš„å†…å­˜æ·˜æ±°æœºåˆ¶</p><p>2.é«˜ä¸€è‡´æ€§éœ€æ±‚ï¼šä¸»åŠ¨æ›´æ–°ï¼Œå¹¶ä»¥è¶…æ—¶å‰”é™¤ä½œä¸ºå…œåº•æ–¹æ¡ˆ</p><ul><li>è¯»æ“ä½œ<ul><li>ç¼“å­˜å‘½ä¸­ç›´æ¥è¿”å›</li><li>ç¼“å­˜æœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶å†™å…¥ç¼“å­˜ï¼Œè®¾å®šè¶…æ—¶æ—¶é—´</li></ul></li><li>å†™æ“ä½œ<ul><li>å…ˆå†™æ•°æ®åº“ï¼Œç„¶ååˆ é™¤ç¼“å­˜</li><li>è¦ç¡®ä¿æ•°æ®åº“ä¸ç¼“å­˜æ“ä½œçš„åŸå­æ€§</li></ul></li></ul><hr><h3 id="ç¼“å­˜ç©¿é€">ç¼“å­˜ç©¿é€</h3><p>ç¼“å­˜ç©¿é€ ï¼šç¼“å­˜ç©¿é€æ˜¯æŒ‡å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œè¿™æ ·ç¼“å­˜æ°¸è¿œä¸ä¼šç”Ÿæ•ˆï¼Œè¿™äº›è¯·æ±‚éƒ½ä¼šæ‰“åˆ°æ•°æ®åº“ã€‚</p><p>å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</p><div class="tabs" id="b931f832-db95-4426-be0c-b4fa3d765ef3"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#b931f832-db95-4426-be0c-b4fa3d765ef3-1"><i class="fas fa-cat"></i>ç¼“å­˜ç©ºå¯¹è±¡</button></li><li class="tab"><button type="button" data-href="#b931f832-db95-4426-be0c-b4fa3d765ef3-2"><i class="fas fa-horse"></i>å¸ƒéš†è¿‡æ»¤</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="b931f832-db95-4426-be0c-b4fa3d765ef3-1"><p>å½“æˆ‘ä»¬å®¢æˆ·ç«¯è®¿é—®ä¸å­˜åœ¨çš„æ•°æ®æ—¶ï¼Œå…ˆè¯·æ±‚redisï¼Œä½†æ˜¯æ­¤æ—¶redisä¸­æ²¡æœ‰æ•°æ®ï¼Œæ­¤æ—¶ä¼šè®¿é—®åˆ°æ•°æ®åº“ï¼Œä½†æ˜¯æ•°æ®åº“ä¸­ä¹Ÿæ²¡æœ‰æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®ç©¿é€äº†ç¼“å­˜ï¼Œç›´å‡»æ•°æ®åº“ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“æ•°æ®åº“èƒ½å¤Ÿæ‰¿è½½çš„å¹¶å‘ä¸å¦‚redisè¿™ä¹ˆé«˜ï¼Œå¦‚æœå¤§é‡çš„è¯·æ±‚åŒæ—¶è¿‡æ¥è®¿é—®è¿™ç§ä¸å­˜åœ¨çš„æ•°æ®ï¼Œè¿™äº›è¯·æ±‚å°±éƒ½ä¼šè®¿é—®åˆ°æ•°æ®åº“ï¼Œç®€å•çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯å“ªæ€•è¿™ä¸ªæ•°æ®åœ¨æ•°æ®åº“ä¸­ä¹Ÿä¸å­˜åœ¨ï¼Œæˆ‘ä»¬ä¹ŸæŠŠè¿™ä¸ªæ•°æ®å­˜å…¥åˆ°redisä¸­å»ï¼Œè¿™æ ·ï¼Œä¸‹æ¬¡ç”¨æˆ·è¿‡æ¥è®¿é—®è¿™ä¸ªä¸å­˜åœ¨çš„æ•°æ®ï¼Œé‚£ä¹ˆåœ¨redisä¸­ä¹Ÿèƒ½æ‰¾åˆ°è¿™ä¸ªæ•°æ®å°±ä¸ä¼šè¿›å…¥åˆ°ç¼“å­˜äº†ã€‚</p><ul><li>ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œç»´æŠ¤æ–¹ä¾¿</li><li>ç¼ºç‚¹ï¼š<ul><li>é¢å¤–çš„å†…å­˜æ¶ˆè€—</li><li>å¯èƒ½é€ æˆçŸ­æœŸçš„ä¸ä¸€è‡´</li></ul></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b931f832-db95-4426-be0c-b4fa3d765ef3-2"><p>å¸ƒéš†è¿‡æ»¤å™¨å…¶å®é‡‡ç”¨çš„æ˜¯å“ˆå¸Œæ€æƒ³æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡ä¸€ä¸ªåºå¤§çš„äºŒè¿›åˆ¶æ•°ç»„ï¼Œèµ°å“ˆå¸Œæ€æƒ³å»åˆ¤æ–­å½“å‰è¿™ä¸ªè¦æŸ¥è¯¢çš„è¿™ä¸ªæ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­å­˜åœ¨ï¼Œåˆ™æ”¾è¡Œï¼Œè¿™ä¸ªè¯·æ±‚ä¼šå»è®¿é—®redisï¼Œå“ªæ€•æ­¤æ—¶redisä¸­çš„æ•°æ®è¿‡æœŸäº†ï¼Œä½†æ˜¯æ•°æ®åº“ä¸­ä¸€å®šå­˜åœ¨è¿™ä¸ªæ•°æ®ï¼Œåœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥è¿™ä¸ªæ•°æ®åï¼Œå†å°†å…¶æ”¾å…¥åˆ°redisä¸­ï¼Œå‡è®¾å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­è¿™ä¸ªæ•°æ®ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚</p><ul><li>ä¼˜ç‚¹ï¼šå†…å­˜å ç”¨è¾ƒå°‘ï¼Œæ²¡æœ‰å¤šä½™key</li><li>ç¼ºç‚¹ï¼š<ul><li>å®ç°å¤æ‚</li><li>å­˜åœ¨è¯¯åˆ¤å¯èƒ½ï¼Œè¯¯åˆ¤åŸå› åœ¨äºï¼šå¸ƒéš†è¿‡æ»¤å™¨èµ°çš„æ˜¯å“ˆå¸Œæ€æƒ³ï¼Œåªè¦å“ˆå¸Œæ€æƒ³ï¼Œå°±å¯èƒ½å­˜åœ¨å“ˆå¸Œå†²çª</li></ul></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653326156516.png" alt="1653326156516" style="zoom:67%;" /><mark class="hl-label blue">ç¼–ç è§£å†³å•†å“æŸ¥è¯¢çš„ç¼“å­˜ç©¿é€é—®é¢˜</mark> <div class="tabs" id="d31401f6-73bd-497d-86f5-8c8710cc5731"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d31401f6-73bd-497d-86f5-8c8710cc5731-1"><i class="fas fa-atom"></i>æ ¸å¿ƒæ€è·¯</button></li><li class="tab"><button type="button" data-href="#d31401f6-73bd-497d-86f5-8c8710cc5731-2"><i class="far fa-sun"></i>æµç¨‹å›¾</button></li><li class="tab"><button type="button" data-href="#d31401f6-73bd-497d-86f5-8c8710cc5731-3"><i class="fas fa-wind"></i>ä»£ç å®ç°</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d31401f6-73bd-497d-86f5-8c8710cc5731-1"><p>æ ¸å¿ƒæ€è·¯å¦‚ä¸‹ï¼š</p><p>åœ¨åŸæ¥çš„é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬å¦‚æœå‘ç°è¿™ä¸ªæ•°æ®åœ¨mysqlä¸­ä¸å­˜åœ¨ï¼Œç›´æ¥å°±è¿”å›404äº†ï¼Œè¿™æ ·æ˜¯ä¼šå­˜åœ¨ç¼“å­˜ç©¿é€é—®é¢˜çš„</p><p>ç°åœ¨çš„é€»è¾‘ä¸­ï¼šå¦‚æœè¿™ä¸ªæ•°æ®ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬ä¸ä¼šè¿”å›404 ï¼Œè¿˜æ˜¯ä¼šæŠŠè¿™ä¸ªæ•°æ®å†™å…¥åˆ°Redisä¸­ï¼Œå¹¶ä¸”å°†valueè®¾ç½®ä¸ºç©ºï¼Œæ¬§å½“å†æ¬¡å‘èµ·æŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬å¦‚æœå‘ç°å‘½ä¸­ä¹‹åï¼Œåˆ¤æ–­è¿™ä¸ªvalueæ˜¯å¦æ˜¯nullï¼Œå¦‚æœæ˜¯nullï¼Œåˆ™æ˜¯ä¹‹å‰å†™å…¥çš„æ•°æ®ï¼Œè¯æ˜æ˜¯ç¼“å­˜ç©¿é€æ•°æ®ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ç›´æ¥è¿”å›æ•°æ®ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d31401f6-73bd-497d-86f5-8c8710cc5731-2"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653327124561.png" alt="1653327124561" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d31401f6-73bd-497d-86f5-8c8710cc5731-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//1.ä»RedisæŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="comment">//3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­å‘½ä¸­çš„æ˜¯å¦æ˜¯ç©ºå€¼</span></span><br><span class="line">    <span class="keyword">if</span> (shopJson != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//è¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//4.ä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="comment">//5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.å­˜åœ¨ï¼Œå†™å…¥Redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(shop), CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <mark class="hl-label blue">æ€»ç»“</mark> <p>ç¼“å­˜ç©¿é€äº§ç”Ÿçš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ</p><ul><li>ç”¨æˆ·è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œä¸æ–­å‘èµ·è¿™æ ·çš„è¯·æ±‚ï¼Œç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§å‹åŠ›</li></ul><p>ç¼“å­˜ç©¿é€çš„è§£å†³æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ</p><ul><li>ç¼“å­˜nullå€¼</li><li>å¸ƒéš†è¿‡æ»¤</li><li>å¢å¼ºidçš„å¤æ‚åº¦ï¼Œé¿å…è¢«çŒœæµ‹idè§„å¾‹</li><li>åšå¥½æ•°æ®çš„åŸºç¡€æ ¼å¼æ ¡éªŒ</li><li>åŠ å¼ºç”¨æˆ·æƒé™æ ¡éªŒ</li><li>åšå¥½çƒ­ç‚¹å‚æ•°çš„é™æµ</li></ul><hr><h3 id="ç¼“å­˜é›ªå´©">ç¼“å­˜é›ªå´©</h3><p>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨åŒä¸€æ—¶æ®µå¤§é‡çš„ç¼“å­˜keyåŒæ—¶å¤±æ•ˆæˆ–è€…RedisæœåŠ¡å®•æœºï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚åˆ°è¾¾æ•°æ®åº“ï¼Œå¸¦æ¥å·¨å¤§å‹åŠ›ã€‚</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><ul><li>ç»™ä¸åŒçš„Keyçš„TTLæ·»åŠ éšæœºå€¼</li><li>åˆ©ç”¨Redisé›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§</li><li>ç»™ç¼“å­˜ä¸šåŠ¡æ·»åŠ é™çº§é™æµç­–ç•¥</li><li>ç»™ä¸šåŠ¡æ·»åŠ å¤šçº§ç¼“å­˜</li></ul><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653327884526.png" alt="1653327884526" style="zoom:67%;" /><hr><h3 id="ç¼“å­˜å‡»ç©¿">ç¼“å­˜å‡»ç©¿</h3><p>ç¼“å­˜å‡»ç©¿é—®é¢˜ä¹Ÿå«çƒ­ç‚¹Keyé—®é¢˜ï¼Œå°±æ˜¯ä¸€ä¸ªè¢«é«˜å¹¶å‘è®¿é—®å¹¶ä¸”ç¼“å­˜é‡å»ºä¸šåŠ¡è¾ƒå¤æ‚çš„keyçªç„¶å¤±æ•ˆäº†ï¼Œæ— æ•°çš„è¯·æ±‚è®¿é—®ä¼šåœ¨ç¬é—´ç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„å†²å‡»ã€‚</p><p>å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</p><ul><li>äº’æ–¥é”</li><li>é€»è¾‘è¿‡æœŸ</li></ul><div class="tabs" id="adfa7107-a653-49ad-bd02-ad74091d7f4a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#adfa7107-a653-49ad-bd02-ad74091d7f4a-1"><i class="fas fa-atom"></i>åˆ†æ</button></li><li class="tab"><button type="button" data-href="#adfa7107-a653-49ad-bd02-ad74091d7f4a-2"><i class="far fa-sun"></i>äº’æ–¥é”</button></li><li class="tab"><button type="button" data-href="#adfa7107-a653-49ad-bd02-ad74091d7f4a-3"><i class="fas fa-wind"></i>é€»è¾‘è¿‡æœŸ</button></li><li class="tab"><button type="button" data-href="#adfa7107-a653-49ad-bd02-ad74091d7f4a-4"><i class="fas fa-fire-alt"></i>æ–¹æ¡ˆå¯¹æ¯”</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="adfa7107-a653-49ad-bd02-ad74091d7f4a-1"><p>å‡è®¾çº¿ç¨‹1åœ¨æŸ¥è¯¢ç¼“å­˜ä¹‹åï¼Œæœ¬æ¥åº”è¯¥å»æŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åæŠŠè¿™ä¸ªæ•°æ®é‡æ–°åŠ è½½åˆ°ç¼“å­˜çš„ï¼Œæ­¤æ—¶åªè¦çº¿ç¨‹1èµ°å®Œè¿™ä¸ªé€»è¾‘ï¼Œå…¶ä»–çº¿ç¨‹å°±éƒ½èƒ½ä»ç¼“å­˜ä¸­åŠ è½½è¿™äº›æ•°æ®äº†ï¼Œä½†æ˜¯å‡è®¾åœ¨çº¿ç¨‹1æ²¡æœ‰èµ°å®Œçš„æ—¶å€™ï¼Œåç»­çš„çº¿ç¨‹2ï¼Œçº¿ç¨‹3ï¼Œçº¿ç¨‹4åŒæ—¶è¿‡æ¥è®¿é—®å½“å‰è¿™ä¸ªæ–¹æ³•ï¼Œ é‚£ä¹ˆè¿™äº›çº¿ç¨‹éƒ½ä¸èƒ½ä»ç¼“å­˜ä¸­æŸ¥è¯¢åˆ°æ•°æ®ï¼Œé‚£ä¹ˆä»–ä»¬å°±ä¼šåŒä¸€æ—¶åˆ»æ¥è®¿é—®æŸ¥è¯¢ç¼“å­˜ï¼Œéƒ½æ²¡æŸ¥åˆ°ï¼Œæ¥ç€åŒä¸€æ—¶é—´å»è®¿é—®æ•°æ®åº“ï¼ŒåŒæ—¶çš„å»æ‰§è¡Œæ•°æ®åº“ä»£ç ï¼Œå¯¹æ•°æ®åº“è®¿é—®å‹åŠ›è¿‡å¤§</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653328022622.png" alt="1653328022622" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="adfa7107-a653-49ad-bd02-ad74091d7f4a-2"><p>å› ä¸ºé”èƒ½å®ç°äº’æ–¥æ€§ã€‚å‡è®¾çº¿ç¨‹è¿‡æ¥ï¼Œåªèƒ½ä¸€ä¸ªäººä¸€ä¸ªäººçš„æ¥è®¿é—®æ•°æ®åº“ï¼Œä»è€Œé¿å…å¯¹äºæ•°æ®åº“è®¿é—®å‹åŠ›è¿‡å¤§ï¼Œä½†è¿™ä¹Ÿä¼šå½±å“æŸ¥è¯¢çš„æ€§èƒ½ï¼Œå› ä¸ºæ­¤æ—¶ä¼šè®©æŸ¥è¯¢çš„æ€§èƒ½ä»å¹¶è¡Œå˜æˆäº†ä¸²è¡Œï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨tryLockæ–¹æ³• + double checkæ¥è§£å†³è¿™æ ·çš„é—®é¢˜ã€‚</p><p>å‡è®¾ç°åœ¨çº¿ç¨‹1è¿‡æ¥è®¿é—®ï¼Œä»–æŸ¥è¯¢ç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œä½†æ˜¯æ­¤æ—¶ä»–è·å¾—åˆ°äº†é”çš„èµ„æºï¼Œé‚£ä¹ˆçº¿ç¨‹1å°±ä¼šä¸€ä¸ªäººå»æ‰§è¡Œé€»è¾‘ï¼Œå‡è®¾ç°åœ¨çº¿ç¨‹2è¿‡æ¥ï¼Œçº¿ç¨‹2åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¹¶æ²¡æœ‰è·å¾—åˆ°é”ï¼Œé‚£ä¹ˆçº¿ç¨‹2å°±å¯ä»¥è¿›è¡Œåˆ°ä¼‘çœ ï¼Œç›´åˆ°çº¿ç¨‹1æŠŠé”é‡Šæ”¾åï¼Œçº¿ç¨‹2è·å¾—åˆ°é”ï¼Œç„¶åå†æ¥æ‰§è¡Œé€»è¾‘ï¼Œæ­¤æ—¶å°±èƒ½å¤Ÿä»ç¼“å­˜ä¸­æ‹¿åˆ°æ•°æ®äº†ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653328288627.png" alt="1653328288627" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="adfa7107-a653-49ad-bd02-ad74091d7f4a-3"><p>æˆ‘ä»¬ä¹‹æ‰€ä»¥ä¼šå‡ºç°è¿™ä¸ªç¼“å­˜å‡»ç©¿é—®é¢˜ï¼Œä¸»è¦åŸå› æ˜¯åœ¨äºæˆ‘ä»¬å¯¹keyè®¾ç½®äº†è¿‡æœŸæ—¶é—´ï¼Œå‡è®¾æˆ‘ä»¬ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå…¶å®å°±ä¸ä¼šæœ‰ç¼“å­˜å‡»ç©¿çš„é—®é¢˜ï¼Œä½†æ˜¯ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·æ•°æ®ä¸å°±ä¸€ç›´å ç”¨æˆ‘ä»¬å†…å­˜äº†å—ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨é€»è¾‘è¿‡æœŸæ–¹æ¡ˆã€‚</p><p>æˆ‘ä»¬æŠŠè¿‡æœŸæ—¶é—´è®¾ç½®åœ¨redisçš„valueä¸­ï¼Œæ³¨æ„ï¼šè¿™ä¸ªè¿‡æœŸæ—¶é—´å¹¶ä¸ä¼šç›´æ¥ä½œç”¨äºredisï¼Œè€Œæ˜¯æˆ‘ä»¬åç»­é€šè¿‡é€»è¾‘å»å¤„ç†ã€‚å‡è®¾çº¿ç¨‹1å»æŸ¥è¯¢ç¼“å­˜ï¼Œç„¶åä»valueä¸­åˆ¤æ–­å‡ºæ¥å½“å‰çš„æ•°æ®å·²ç»è¿‡æœŸäº†ï¼Œæ­¤æ—¶çº¿ç¨‹1å»è·å¾—äº’æ–¥é”ï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹ä¼šè¿›è¡Œé˜»å¡ï¼Œè·å¾—äº†é”çš„çº¿ç¨‹ä»–ä¼šå¼€å¯ä¸€ä¸ª çº¿ç¨‹å»è¿›è¡Œä»¥å‰çš„é‡æ„æ•°æ®çš„é€»è¾‘ï¼Œç›´åˆ°æ–°å¼€çš„çº¿ç¨‹å®Œæˆè¿™ä¸ªé€»è¾‘åï¼Œæ‰é‡Šæ”¾é”ï¼Œ è€Œçº¿ç¨‹1ç›´æ¥è¿›è¡Œè¿”å›ï¼Œå‡è®¾ç°åœ¨çº¿ç¨‹3è¿‡æ¥è®¿é—®ï¼Œç”±äºçº¿ç¨‹çº¿ç¨‹2æŒæœ‰ç€é”ï¼Œæ‰€ä»¥çº¿ç¨‹3æ— æ³•è·å¾—é”ï¼Œçº¿ç¨‹3ä¹Ÿç›´æ¥è¿”å›æ•°æ®ï¼Œåªæœ‰ç­‰åˆ°æ–°å¼€çš„çº¿ç¨‹2æŠŠé‡å»ºæ•°æ®æ„å»ºå®Œåï¼Œå…¶ä»–çº¿ç¨‹æ‰èƒ½èµ°è¿”å›æ­£ç¡®çš„æ•°æ®ã€‚</p><p>è¿™ç§æ–¹æ¡ˆå·§å¦™åœ¨äºï¼Œå¼‚æ­¥çš„æ„å»ºç¼“å­˜ï¼Œç¼ºç‚¹åœ¨äºåœ¨æ„å»ºå®Œç¼“å­˜ä¹‹å‰ï¼Œè¿”å›çš„éƒ½æ˜¯è„æ•°æ®ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653328663897.png" alt="1653328663897" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="adfa7107-a653-49ad-bd02-ad74091d7f4a-4"><p>äº’æ–¥é”æ–¹æ¡ˆï¼šç”±äºä¿è¯äº†äº’æ–¥æ€§ï¼Œæ‰€ä»¥æ•°æ®ä¸€è‡´ï¼Œä¸”å®ç°ç®€å•ï¼Œå› ä¸ºä»…ä»…åªéœ€è¦åŠ ä¸€æŠŠé”è€Œå·²ï¼Œä¹Ÿæ²¡å…¶ä»–çš„äº‹æƒ…éœ€è¦æ“å¿ƒï¼Œæ‰€ä»¥æ²¡æœ‰é¢å¤–çš„å†…å­˜æ¶ˆè€—ï¼Œç¼ºç‚¹åœ¨äºæœ‰é”å°±æœ‰æ­»é”é—®é¢˜çš„å‘ç”Ÿï¼Œä¸”åªèƒ½ä¸²è¡Œæ‰§è¡Œæ€§èƒ½è‚¯å®šå—åˆ°å½±å“</p><p>é€»è¾‘è¿‡æœŸæ–¹æ¡ˆï¼šçº¿ç¨‹è¯»å–è¿‡ç¨‹ä¸­ä¸éœ€è¦ç­‰å¾…ï¼Œæ€§èƒ½å¥½ï¼Œæœ‰ä¸€ä¸ªé¢å¤–çš„çº¿ç¨‹æŒæœ‰é”å»è¿›è¡Œé‡æ„æ•°æ®ï¼Œä½†æ˜¯åœ¨é‡æ„æ•°æ®å®Œæˆå‰ï¼Œå…¶ä»–çš„çº¿ç¨‹åªèƒ½è¿”å›ä¹‹å‰çš„æ•°æ®ï¼Œä¸”å®ç°èµ·æ¥éº»çƒ¦</p><table><thead><tr><th style="text-align:center">è§£å†³æ–¹æ¡ˆ</th><th style="text-align:center">ä¼˜ç‚¹</th><th style="text-align:center">ç¼ºç‚¹</th></tr></thead><tbody><tr><td style="text-align:center">äº’æ–¥é”</td><td style="text-align:center">1.æ²¡æœ‰é¢å¤–çš„å†…å­˜æ¶ˆè€—<br/>2.ä¿è¯ä¸€è‡´æ€§<br/>3.å®ç°ç®€å•</td><td style="text-align:center">1.çº¿ç¨‹éœ€è¦ç­‰å¾…ï¼Œæ€§èƒ½å—å½±å“<br/>2.å¯èƒ½æœ‰æ­»é”é£é™©</td></tr><tr><td style="text-align:center">é€»è¾‘è¿‡æœŸ</td><td style="text-align:center">çº¿ç¨‹æ— éœ€ç­‰å¾…ï¼Œæ€§èƒ½è¾ƒå¥½</td><td style="text-align:center">1.ä¸ä¿è¯ä¸€è‡´æ€§<br/>2.æœ‰é¢å¤–å†…å­˜æ¶ˆè€—<br/>3.å®ç°å¤æ‚</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <mark class="hl-label blue">ä»£ç å®ç°</mark> <div class="tabs" id="b617c6aa-a20d-44d3-9872-b0b0c06d3c0a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#b617c6aa-a20d-44d3-9872-b0b0c06d3c0a-1"><i class="fas fa-cat"></i>äº’æ–¥é”æ€è·¯</button></li><li class="tab"><button type="button" data-href="#b617c6aa-a20d-44d3-9872-b0b0c06d3c0a-2"><i class="fas fa-horse"></i>äº’æ–¥é”ä»£ç </button></li><li class="tab"><button type="button" data-href="#b617c6aa-a20d-44d3-9872-b0b0c06d3c0a-3"><i class="fas fa-dove"></i>é€»è¾‘è¿‡æœŸæ€è·¯</button></li><li class="tab"><button type="button" data-href="#b617c6aa-a20d-44d3-9872-b0b0c06d3c0a-4"><i class="fas fa-dragon"></i>é€»è¾‘è¿‡æœŸä»£ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="b617c6aa-a20d-44d3-9872-b0b0c06d3c0a-1"><p>æ ¸å¿ƒæ€è·¯ï¼šç›¸è¾ƒäºåŸæ¥ä»ç¼“å­˜ä¸­æŸ¥è¯¢ä¸åˆ°æ•°æ®åç›´æ¥æŸ¥è¯¢æ•°æ®åº“è€Œè¨€ï¼Œç°åœ¨çš„æ–¹æ¡ˆæ˜¯ è¿›è¡ŒæŸ¥è¯¢ä¹‹åï¼Œå¦‚æœä»ç¼“å­˜æ²¡æœ‰æŸ¥è¯¢åˆ°æ•°æ®ï¼Œåˆ™è¿›è¡Œäº’æ–¥é”çš„è·å–ï¼Œè·å–äº’æ–¥é”åï¼Œåˆ¤æ–­æ˜¯å¦è·å¾—åˆ°äº†é”ï¼Œå¦‚æœæ²¡æœ‰è·å¾—åˆ°ï¼Œåˆ™ä¼‘çœ ï¼Œè¿‡ä¸€ä¼šå†è¿›è¡Œå°è¯•ï¼Œç›´åˆ°è·å–åˆ°é”ä¸ºæ­¢ï¼Œæ‰èƒ½è¿›è¡ŒæŸ¥è¯¢</p><p>å¦‚æœè·å–åˆ°äº†é”çš„çº¿ç¨‹ï¼Œå†å»è¿›è¡ŒæŸ¥è¯¢ï¼ŒæŸ¥è¯¢åå°†æ•°æ®å†™å…¥redisï¼Œå†é‡Šæ”¾é”ï¼Œè¿”å›æ•°æ®ï¼Œåˆ©ç”¨äº’æ–¥é”å°±èƒ½ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œæ“ä½œæ•°æ®åº“çš„é€»è¾‘ï¼Œé˜²æ­¢ç¼“å­˜å‡»ç©¿</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653357860001.png" alt="1653357860001" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b617c6aa-a20d-44d3-9872-b0b0c06d3c0a-2"><div class="tabs" id="72d25354-8817-4911-9f5a-d200d956aee0"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#72d25354-8817-4911-9f5a-d200d956aee0-1"><i class="fas fa-bug"></i>æ“ä½œé”çš„ä»£ç </button></li><li class="tab"><button type="button" data-href="#72d25354-8817-4911-9f5a-d200d956aee0-2"><i class="fas fa-cannabis"></i>æ“ä½œä»£ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="72d25354-8817-4911-9f5a-d200d956aee0-1"><p>æ ¸å¿ƒæ€è·¯å°±æ˜¯åˆ©ç”¨redisçš„setnxæ–¹æ³•æ¥è¡¨ç¤ºè·å–é”ï¼Œè¯¥æ–¹æ³•å«ä¹‰æ˜¯redisä¸­å¦‚æœæ²¡æœ‰è¿™ä¸ªkeyï¼Œåˆ™æ’å…¥æˆåŠŸï¼Œè¿”å›1ï¼Œåœ¨stringRedisTemplateä¸­è¿”å›trueï¼Œ  å¦‚æœæœ‰è¿™ä¸ªkeyåˆ™æ’å…¥å¤±è´¥ï¼Œåˆ™è¿”å›0ï¼Œåœ¨stringRedisTemplateè¿”å›falseï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡trueï¼Œæˆ–è€…æ˜¯falseï¼Œæ¥è¡¨ç¤ºæ˜¯å¦æœ‰çº¿ç¨‹æˆåŠŸæ’å…¥keyï¼ŒæˆåŠŸæ’å…¥çš„keyçš„çº¿ç¨‹æˆ‘ä»¬è®¤ä¸ºä»–å°±æ˜¯è·å¾—åˆ°é”çš„çº¿ç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    stringRedisTemplate.delete(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="72d25354-8817-4911-9f5a-d200d956aee0-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Shop <span class="title function_">queryWithMutex</span><span class="params">(Long id)</span>  &#123;</span><br><span class="line">       <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id;</span><br><span class="line">       <span class="comment">// 1ã€ä»redisä¸­æŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">       <span class="comment">// 2ã€åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">       <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">           <span class="comment">// å­˜åœ¨,ç›´æ¥è¿”å›</span></span><br><span class="line">           <span class="keyword">return</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//åˆ¤æ–­å‘½ä¸­çš„å€¼æ˜¯å¦æ˜¯ç©ºå€¼</span></span><br><span class="line">       <span class="keyword">if</span> (shopJson != <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="comment">//è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯</span></span><br><span class="line">           <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 4.å®ç°ç¼“å­˜é‡æ„</span></span><br><span class="line">       <span class="comment">//4.1 è·å–äº’æ–¥é”</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> <span class="string">&quot;lock:shop:&quot;</span> + id;</span><br><span class="line">       <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">           <span class="comment">// 4.2 åˆ¤æ–­å¦è·å–æˆåŠŸ</span></span><br><span class="line">           <span class="keyword">if</span>(!isLock)&#123;</span><br><span class="line">               <span class="comment">//4.3 å¤±è´¥ï¼Œåˆ™ä¼‘çœ é‡è¯•</span></span><br><span class="line">               Thread.sleep(<span class="number">50</span>);</span><br><span class="line">               <span class="keyword">return</span> queryWithMutex(id);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//4.4 æˆåŠŸï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">            shop = getById(id);</span><br><span class="line">           <span class="comment">// 5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯</span></span><br><span class="line">           <span class="keyword">if</span>(shop == <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">//å°†ç©ºå€¼å†™å…¥redis</span></span><br><span class="line">               stringRedisTemplate.opsForValue().set(key,<span class="string">&quot;&quot;</span>,CACHE_NULL_TTL,TimeUnit.MINUTES);</span><br><span class="line">               <span class="comment">//è¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">               <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//6.å†™å…¥redis</span></span><br><span class="line">           stringRedisTemplate.opsForValue().set(key,JSONUtil.toJsonStr(shop),CACHE_NULL_TTL,TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">       &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="comment">//7.é‡Šæ”¾äº’æ–¥é”</span></span><br><span class="line">           unlock(lockKey);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> shop;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b617c6aa-a20d-44d3-9872-b0b0c06d3c0a-3"><p>éœ€æ±‚ï¼šä¿®æ”¹æ ¹æ®idæŸ¥è¯¢å•†é“ºçš„ä¸šåŠ¡ï¼ŒåŸºäºé€»è¾‘è¿‡æœŸæ–¹å¼æ¥è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</p><p>æ€è·¯åˆ†æï¼šå½“ç”¨æˆ·å¼€å§‹æŸ¥è¯¢redisæ—¶ï¼Œåˆ¤æ–­æ˜¯å¦å‘½ä¸­ï¼Œå¦‚æœæ²¡æœ‰å‘½ä¸­åˆ™ç›´æ¥è¿”å›ç©ºæ•°æ®ï¼Œä¸æŸ¥è¯¢æ•°æ®åº“ï¼Œè€Œä¸€æ—¦å‘½ä¸­åï¼Œå°†valueå–å‡ºï¼Œåˆ¤æ–­valueä¸­çš„è¿‡æœŸæ—¶é—´æ˜¯å¦æ»¡è¶³ï¼Œå¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œåˆ™ç›´æ¥è¿”å›redisä¸­çš„æ•°æ®ï¼Œå¦‚æœè¿‡æœŸï¼Œåˆ™åœ¨å¼€å¯ç‹¬ç«‹çº¿ç¨‹åç›´æ¥è¿”å›ä¹‹å‰çš„æ•°æ®ï¼Œç‹¬ç«‹çº¿ç¨‹å»é‡æ„æ•°æ®ï¼Œé‡æ„å®Œæˆåé‡Šæ”¾äº’æ–¥é”ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653360308731.png" alt="1653360308731" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b617c6aa-a20d-44d3-9872-b0b0c06d3c0a-4"><div class="tabs" id="28dbfd45-11d5-4d6b-a08c-4132542e590d"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#28dbfd45-11d5-4d6b-a08c-4132542e590d-1"><i class="fas fa-seedling"></i>æ–°å»ºå®ä½“ç±»</button></li><li class="tab"><button type="button" data-href="#28dbfd45-11d5-4d6b-a08c-4132542e590d-2"><i class="fas fa-leaf"></i>æ–°å¢æ–¹æ³•</button></li><li class="tab"><button type="button" data-href="#28dbfd45-11d5-4d6b-a08c-4132542e590d-3"><i class="fab fa-apple"></i>æ­£å¼ä»£ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="28dbfd45-11d5-4d6b-a08c-4132542e590d-1"><p>å› ä¸ºç°åœ¨redisä¸­å­˜å‚¨çš„æ•°æ®çš„valueéœ€è¦å¸¦ä¸Šè¿‡æœŸæ—¶é—´ï¼Œæ­¤æ—¶è¦ä¹ˆä½ å»ä¿®æ”¹åŸæ¥çš„å®ä½“ç±»ï¼Œè¦ä¹ˆæ–°å»ºä¸€ä¸ªå®ä½“ç±»ï¼Œæˆ‘ä»¬é‡‡ç”¨ç¬¬äºŒä¸ªæ–¹æ¡ˆï¼Œè¿™ä¸ªæ–¹æ¡ˆï¼Œå¯¹åŸæ¥ä»£ç æ²¡æœ‰ä¾µå…¥æ€§ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime expireTime;</span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="28dbfd45-11d5-4d6b-a08c-4132542e590d-2"><p>åœ¨ShopServiceImpl æ–°å¢æ­¤æ–¹æ³•ï¼Œåˆ©ç”¨å•å…ƒæµ‹è¯•è¿›è¡Œç¼“å­˜é¢„çƒ­</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653360807133.png" alt="1653360807133"></p><p>åœ¨æµ‹è¯•ç±»ä¸­</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653360864839.png" alt="1653360864839"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="28dbfd45-11d5-4d6b-a08c-4132542e590d-3"><p>ShopServiceImpl</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">public</span> Shop <span class="title function_">queryWithLogicalExpire</span><span class="params">( Long id )</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">// 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(json)) &#123;</span><br><span class="line">        <span class="comment">// 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.å‘½ä¸­ï¼Œéœ€è¦å…ˆæŠŠjsonååºåˆ—åŒ–ä¸ºå¯¹è±¡</span></span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(json, RedisData.class);</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), Shop.class);</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();</span><br><span class="line">    <span class="comment">// 5.åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">if</span>(expireTime.isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// 5.1.æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›åº—é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.2.å·²è¿‡æœŸï¼Œéœ€è¦ç¼“å­˜é‡å»º</span></span><br><span class="line">    <span class="comment">// 6.ç¼“å­˜é‡å»º</span></span><br><span class="line">    <span class="comment">// 6.1.è·å–äº’æ–¥é”</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">    <span class="comment">// 6.2.åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (isLock)&#123;</span><br><span class="line">        CACHE_REBUILD_EXECUTOR.submit( ()-&gt;&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="comment">//é‡å»ºç¼“å­˜</span></span><br><span class="line">                <span class="built_in">this</span>.saveShop2Redis(id,<span class="number">20L</span>);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                unlock(lockKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6.4.è¿”å›è¿‡æœŸçš„å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="ç¼“å­˜å·¥å…·å°è£…">ç¼“å­˜å·¥å…·å°è£…</h3><p>åŸºäºStringRedisTemplateå°è£…ä¸€ä¸ªç¼“å­˜å·¥å…·ç±»ï¼Œæ»¡è¶³ä¸‹åˆ—éœ€æ±‚ï¼š</p><ul><li>æ–¹æ³•1ï¼šå°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®TTLè¿‡æœŸæ—¶é—´</li><li>æ–¹æ³•2ï¼šå°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œç”¨äºå¤„ç†ç¼“å­˜å‡»ç©¿é—®é¢˜</li><li>æ–¹æ³•3ï¼šæ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œåˆ©ç”¨ç¼“å­˜ç©ºå€¼çš„æ–¹å¼è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜</li><li>æ–¹æ³•4ï¼šæ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œéœ€è¦åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</li></ul><div class="tabs" id="48e5902e-5df4-4efe-ad11-be584fa4d16e"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#48e5902e-5df4-4efe-ad11-be584fa4d16e-1"><i class="fas fa-bug"></i>æˆå‘˜å˜é‡åŠéƒ¨åˆ†æ–¹æ³•</button></li><li class="tab"><button type="button" data-href="#48e5902e-5df4-4efe-ad11-be584fa4d16e-2"><i class="fas fa-cannabis"></i>æ–¹æ³•ä¸€</button></li><li class="tab"><button type="button" data-href="#48e5902e-5df4-4efe-ad11-be584fa4d16e-3"><i class="fas fa-candy-cane"></i>æ–¹æ³•äºŒ</button></li><li class="tab"><button type="button" data-href="#48e5902e-5df4-4efe-ad11-be584fa4d16e-4"><i class="fas fa-child"></i>æ–¹æ³•ä¸‰</button></li><li class="tab"><button type="button" data-href="#48e5902e-5df4-4efe-ad11-be584fa4d16e-5"><i class="fas fa-heartbeat"></i>æ–¹æ³•å››</button></li><li class="tab"><button type="button" data-href="#48e5902e-5df4-4efe-ad11-be584fa4d16e-6"><i class="fas fa-cookie-bite"></i>ä½¿ç”¨ç¤ºä¾‹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="48e5902e-5df4-4efe-ad11-be584fa4d16e-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheClient</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        stringRedisTemplate.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="48e5902e-5df4-4efe-ad11-be584fa4d16e-2"><p>å°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®TTLè¿‡æœŸæ—¶é—´</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, Object value, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, timeUnit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="48e5902e-5df4-4efe-ad11-be584fa4d16e-3"><p>å°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œç”¨äºå¤„ç†ç¼“å­˜å‡»ç©¿é—®é¢˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithPassThrough</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    <span class="comment">//å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºRç±»å‹ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toBean(json, type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (json != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥ï¼ŒæŸ¥è¯¢é€»è¾‘ç”¨æˆ‘ä»¬å‚æ•°ä¸­æ³¨å…¥çš„å‡½æ•°</span></span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">    <span class="comment">//æŸ¥ä¸åˆ°ï¼Œåˆ™å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">    <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æŸ¥åˆ°äº†åˆ™è½¬ä¸ºjsonå­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(r);</span><br><span class="line">    <span class="comment">//å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span></span><br><span class="line">    <span class="built_in">this</span>.set(key, jsonStr, time, timeUnit);</span><br><span class="line">    <span class="comment">//æœ€ç»ˆæŠŠæŸ¥è¯¢åˆ°çš„å•†æˆ·ä¿¡æ¯è¿”å›ç»™å‰ç«¯</span></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="48e5902e-5df4-4efe-ad11-be584fa4d16e-4"><p>æ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œç¼“å­˜ç©ºå€¼çš„æ–¹å¼è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithMutex</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    <span class="comment">//å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºShopç±»å‹ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toBean(json, type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (json != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">        <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">50</span>);</span><br><span class="line">            <span class="keyword">return</span> queryWithMutex(keyPrefix, id, type, dbFallback, time, timeUnit);</span><br><span class="line">        &#125;</span><br><span class="line">        r = dbFallback.apply(id);</span><br><span class="line">        <span class="comment">//æŸ¥ä¸åˆ°ï¼Œåˆ™å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">        <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span></span><br><span class="line">        <span class="built_in">this</span>.set(key, r, time, timeUnit);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        unlock(lockKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="48e5902e-5df4-4efe-ad11-be584fa4d16e-5"><p>æ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œéœ€è¦åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithLogicalExpire</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    <span class="comment">//1. ä»redisä¸­æŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//2. å¦‚æœæœªå‘½ä¸­ï¼Œåˆ™è¿”å›ç©º</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(json)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3. å‘½ä¸­ï¼Œå°†jsonååºåˆ—åŒ–ä¸ºå¯¹è±¡</span></span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(json, RedisData.class);</span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), type);</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();</span><br><span class="line">    <span class="comment">//4. åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">if</span> (expireTime.isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">//5. è¿‡æœŸï¼Œç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6. è¿‡æœŸï¼Œå°è¯•è·å–äº’æ–¥é”</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">    <span class="comment">//7. è·å–åˆ°äº†é”</span></span><br><span class="line">    <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">        <span class="comment">//8. å¼€å¯ç‹¬ç«‹çº¿ç¨‹</span></span><br><span class="line">        CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">R</span> <span class="variable">tmp</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">                <span class="built_in">this</span>.setWithLogicExpire(key, tmp, time, timeUnit);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                unlock(lockKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//9. ç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//10. æœªè·å–åˆ°é”ï¼Œç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setWithLogicExpire</span><span class="params">(String key, Object value, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    RedisData&lt;Object&gt; redisData = <span class="keyword">new</span> <span class="title class_">RedisData</span>&lt;&gt;();</span><br><span class="line">    redisData.setData(value);</span><br><span class="line">    redisData.setExpireTime(LocalDateTime.now().plusSeconds(timeUnit.toSeconds(time)));</span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="48e5902e-5df4-4efe-ad11-be584fa4d16e-6"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> CacheClient cacheClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// è§£å†³ç¼“å­˜ç©¿é€</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> cacheClient</span><br><span class="line">            .queryWithPassThrough(CACHE_SHOP_KEY, id, Shop.class, <span class="built_in">this</span>::getById, CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿</span></span><br><span class="line">    <span class="comment">// Shop shop = cacheClient</span></span><br><span class="line">    <span class="comment">//         .queryWithMutex(CACHE_SHOP_KEY, id, Shop.class, this::getById, CACHE_SHOP_TTL, TimeUnit.MINUTES);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿</span></span><br><span class="line">    <span class="comment">// Shop shop = cacheClient</span></span><br><span class="line">    <span class="comment">//         .queryWithLogicalExpire(CACHE_SHOP_KEY, id, Shop.class, this::getById, 20L, TimeUnit.SECONDS);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 7.è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="ä¼˜æƒ åˆ¸ç§’æ€">ä¼˜æƒ åˆ¸ç§’æ€</h2><h3 id="å…¨å±€å”¯ä¸€ID">å…¨å±€å”¯ä¸€ID</h3><p>æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼Œå½“ç”¨æˆ·æŠ¢è´­æ—¶ï¼Œå°±ä¼šç”Ÿæˆè®¢å•å¹¶ä¿å­˜åˆ°tb_voucher_orderè¿™å¼ è¡¨ä¸­ï¼Œè€Œè®¢å•è¡¨å¦‚æœä½¿ç”¨æ•°æ®åº“è‡ªå¢IDå°±å­˜åœ¨ä¸€äº›é—®é¢˜ï¼š</p><ul><li>idçš„è§„å¾‹æ€§å¤ªæ˜æ˜¾</li><li>å—å•è¡¨æ•°æ®é‡çš„é™åˆ¶</li></ul><p>åœºæ™¯åˆ†æï¼šå¦‚æœæˆ‘ä»¬çš„idå…·æœ‰å¤ªæ˜æ˜¾çš„è§„åˆ™ï¼Œç”¨æˆ·æˆ–è€…è¯´å•†ä¸šå¯¹æ‰‹å¾ˆå®¹æ˜“çŒœæµ‹å‡ºæ¥æˆ‘ä»¬çš„ä¸€äº›æ•æ„Ÿä¿¡æ¯ï¼Œæ¯”å¦‚å•†åŸåœ¨ä¸€å¤©æ—¶é—´å†…ï¼Œå–å‡ºäº†å¤šå°‘å•ï¼Œè¿™æ˜æ˜¾ä¸åˆé€‚ã€‚</p><p>åœºæ™¯åˆ†æäºŒï¼šéšç€æˆ‘ä»¬å•†åŸè§„æ¨¡è¶Šæ¥è¶Šå¤§ï¼Œmysqlçš„å•è¡¨çš„å®¹é‡ä¸å®œè¶…è¿‡500Wï¼Œæ•°æ®é‡è¿‡å¤§ä¹‹åï¼Œæˆ‘ä»¬è¦è¿›è¡Œæ‹†åº“æ‹†è¡¨ï¼Œä½†æ‹†åˆ†è¡¨äº†ä¹‹åï¼Œä»–ä»¬ä»é€»è¾‘ä¸Šè®²ä»–ä»¬æ˜¯åŒä¸€å¼ è¡¨ï¼Œæ‰€ä»¥ä»–ä»¬çš„idæ˜¯ä¸èƒ½ä¸€æ ·çš„ï¼Œ äºæ˜¯ä¹æˆ‘ä»¬éœ€è¦ä¿è¯idçš„å”¯ä¸€æ€§ã€‚</p><p>å…¨å±€IDç”Ÿæˆå™¨ï¼Œæ˜¯ä¸€ç§åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ç”¨æ¥ç”Ÿæˆå…¨å±€å”¯ä¸€IDçš„å·¥å…·ï¼Œä¸€èˆ¬è¦æ»¡è¶³ä¸‹åˆ—ç‰¹æ€§ï¼š</p><p>å”¯ä¸€æ€§ã€é«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€é€’å¢æ€§ã€å®‰å…¨æ€§</p><p>ä¸ºäº†å¢åŠ IDçš„å®‰å…¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç›´æ¥ä½¿ç”¨Redisè‡ªå¢çš„æ•°å€¼ï¼Œè€Œæ˜¯æ‹¼æ¥ä¸€äº›å…¶å®ƒä¿¡æ¯</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653363172079.png" alt="1653363172079"></p><p>IDçš„ç»„æˆéƒ¨åˆ†ï¼šç¬¦å·ä½ï¼š1bitï¼Œæ°¸è¿œä¸º0</p><p>æ—¶é—´æˆ³ï¼š31bitï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œå¯ä»¥ä½¿ç”¨69å¹´</p><p>åºåˆ—å·ï¼š32bitï¼Œç§’å†…çš„è®¡æ•°å™¨ï¼Œæ”¯æŒæ¯ç§’äº§ç”Ÿ2^32ä¸ªä¸åŒID</p><mark class="hl-label blue">Rediså®ç°å…¨å±€å”¯ä¸€Id</mark> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisIdWorker</span> &#123;</span><br><span class="line">    <span class="comment">// å¼€å§‹æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">BEGIN_TIMESTAMP</span> <span class="operator">=</span> <span class="number">1640995200L</span>;</span><br><span class="line">    <span class="comment">//åºåˆ—å·çš„ä½æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BITS</span> <span class="operator">=</span> <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisIdWorker</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">(String keyPrefix)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.ç”Ÿæˆæ—¶é—´æˆ³</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="type">long</span> <span class="variable">nowSecond</span> <span class="operator">=</span> now.toEpochSecond(ZoneOffset.UTC);</span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> nowSecond - BEGIN_TIMESTAMP;</span><br><span class="line">        <span class="comment">// 2.ç”Ÿæˆåºåˆ—å·</span></span><br><span class="line">        <span class="comment">// 2.1.è·å–å½“å‰æ—¥æœŸï¼Œç²¾ç¡®åˆ°å¤©</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">date</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy:MM:dd&quot;</span>));</span><br><span class="line">        <span class="comment">// 2.2.è‡ªå¢é•¿</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().increment(<span class="string">&quot;icr:&quot;</span> + keyPrefix + <span class="string">&quot;:&quot;</span> + date);</span><br><span class="line">        <span class="comment">// 3.æ‹¼æ¥å¹¶è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> timestamp &lt;&lt; COUNT_BITS | count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="æ·»åŠ ä¼˜æƒ å·">æ·»åŠ ä¼˜æƒ å·</h3><p>æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼Œåˆ†ä¸ºå¹³ä»·åˆ¸å’Œç‰¹ä»·åˆ¸ã€‚å¹³ä»·åˆ¸å¯ä»¥ä»»æ„è´­ä¹°ï¼Œè€Œç‰¹ä»·åˆ¸éœ€è¦ç§’æ€æŠ¢è´­ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653365145124.png" alt="1653365145124"></p><p>tb_voucherï¼šä¼˜æƒ åˆ¸çš„åŸºæœ¬ä¿¡æ¯ï¼Œä¼˜æƒ é‡‘é¢ã€ä½¿ç”¨è§„åˆ™ç­‰<br>tb_seckill_voucherï¼šä¼˜æƒ åˆ¸çš„åº“å­˜ã€å¼€å§‹æŠ¢è´­æ—¶é—´ï¼Œç»“æŸæŠ¢è´­æ—¶é—´ã€‚ç‰¹ä»·ä¼˜æƒ åˆ¸æ‰éœ€è¦å¡«å†™è¿™äº›ä¿¡æ¯</p><p>å¹³ä»·å·ç”±äºä¼˜æƒ åŠ›åº¦å¹¶ä¸æ˜¯å¾ˆå¤§ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥ä»»æ„é¢†å–</p><p>è€Œä»£é‡‘åˆ¸ç”±äºä¼˜æƒ åŠ›åº¦å¤§ï¼Œæ‰€ä»¥åƒç¬¬äºŒç§å·ï¼Œå°±å¾—é™åˆ¶æ•°é‡ï¼Œä»è¡¨ç»“æ„ä¸Šä¹Ÿèƒ½çœ‹å‡ºï¼Œç‰¹ä»·å·é™¤äº†å…·æœ‰ä¼˜æƒ å·çš„åŸºæœ¬ä¿¡æ¯ä»¥å¤–ï¼Œè¿˜å…·æœ‰åº“å­˜ï¼ŒæŠ¢è´­æ—¶é—´ï¼Œç»“æŸæ—¶é—´ç­‰ç­‰å­—æ®µ</p><div class="tabs" id="e389ccba-adc1-4058-b892-47404b04c12b"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e389ccba-adc1-4058-b892-47404b04c12b-1"><i class="fas fa-seedling"></i>æ–°å¢æ™®é€šå·</button></li><li class="tab"><button type="button" data-href="#e389ccba-adc1-4058-b892-47404b04c12b-2"><i class="fas fa-leaf"></i>æ–°å¢ç§’æ€å·1</button></li><li class="tab"><button type="button" data-href="#e389ccba-adc1-4058-b892-47404b04c12b-3"><i class="fab fa-apple"></i>æ–°å¢ç§’æ€å·2</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e389ccba-adc1-4058-b892-47404b04c12b-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">addVoucher</span><span class="params">(<span class="meta">@RequestBody</span> Voucher voucher)</span> &#123;</span><br><span class="line">    voucherService.save(voucher);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(voucher.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e389ccba-adc1-4058-b892-47404b04c12b-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;seckill&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">addSeckillVoucher</span><span class="params">(<span class="meta">@RequestBody</span> Voucher voucher)</span> &#123;</span><br><span class="line">    voucherService.addSeckillVoucher(voucher);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(voucher.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e389ccba-adc1-4058-b892-47404b04c12b-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜ä¼˜æƒ åˆ¸</span></span><br><span class="line">    save(voucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€ä¿¡æ¯</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">    seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">    seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">    seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">    seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">    seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€åº“å­˜åˆ°Redisä¸­</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="å®ç°ç§’æ€ä¸‹å•-ç¼ºé™·ç‰ˆ">å®ç°ç§’æ€ä¸‹å•-ç¼ºé™·ç‰ˆ</h3><div class="tabs" id="faddf319-29fa-41f3-8852-c88d6baa697b"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#faddf319-29fa-41f3-8852-c88d6baa697b-1"><i class="fas fa-cat"></i>æ ¸å¿ƒæ€è·¯</button></li><li class="tab"><button type="button" data-href="#faddf319-29fa-41f3-8852-c88d6baa697b-2"><i class="fas fa-horse"></i>æ³¨æ„ç‚¹</button></li><li class="tab"><button type="button" data-href="#faddf319-29fa-41f3-8852-c88d6baa697b-3"><i class="fas fa-dove"></i>æµç¨‹å›¾</button></li><li class="tab"><button type="button" data-href="#faddf319-29fa-41f3-8852-c88d6baa697b-4"><i class="fas fa-dragon"></i>å®ç°ä»£ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="faddf319-29fa-41f3-8852-c88d6baa697b-1"><p>å½“æˆ‘ä»¬ç‚¹å‡»æŠ¢è´­æ—¶ï¼Œä¼šè§¦å‘å³ä¾§çš„è¯·æ±‚ï¼Œæˆ‘ä»¬åªéœ€è¦ç¼–å†™å¯¹åº”çš„controllerå³å¯</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653365839526.png" alt="1653365839526" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="faddf319-29fa-41f3-8852-c88d6baa697b-2"><p>ä¸‹å•æ—¶éœ€è¦åˆ¤æ–­ä¸¤ç‚¹ï¼š</p><ul><li>ç§’æ€æ˜¯å¦å¼€å§‹æˆ–ç»“æŸï¼Œå¦‚æœå°šæœªå¼€å§‹æˆ–å·²ç»ç»“æŸåˆ™æ— æ³•ä¸‹å•</li><li>åº“å­˜æ˜¯å¦å……è¶³ï¼Œä¸è¶³åˆ™æ— æ³•ä¸‹å•</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="faddf319-29fa-41f3-8852-c88d6baa697b-3"><p>å½“ç”¨æˆ·å¼€å§‹è¿›è¡Œä¸‹å•ï¼Œæˆ‘ä»¬åº”å½“å»æŸ¥è¯¢ä¼˜æƒ å·ä¿¡æ¯ï¼ŒæŸ¥è¯¢åˆ°ä¼˜æƒ å·ä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦æ»¡è¶³ç§’æ€æ¡ä»¶</p><p>æ¯”å¦‚æ—¶é—´æ˜¯å¦å……è¶³ï¼Œå¦‚æœæ—¶é—´å……è¶³ï¼Œåˆ™è¿›ä¸€æ­¥åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœä¸¤è€…éƒ½æ»¡è¶³ï¼Œåˆ™æ‰£å‡åº“å­˜ï¼Œåˆ›å»ºè®¢å•ï¼Œç„¶åè¿”å›è®¢å•idï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ¡ä»¶ä¸æ»¡è¶³åˆ™ç›´æ¥ç»“æŸã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653366238564.png" alt="1653366238564" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="faddf319-29fa-41f3-8852-c88d6baa697b-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5ï¼Œæ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock= stock -1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="comment">//æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">// 6.1.è®¢å•id</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="comment">// 6.2.ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    <span class="comment">// 6.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    save(voucherOrder);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="è¶…å–é—®é¢˜åˆ†æ">è¶…å–é—®é¢˜åˆ†æ</h3><p>åœ¨æˆ‘ä»¬åŸæœ‰ä»£ç ä¸­æ˜¯è¿™ä¹ˆå†™çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">       <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">       <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//5ï¼Œæ‰£å‡åº“å­˜</span></span><br><span class="line">   <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">           .setSql(<span class="string">&quot;stock= stock -1&quot;</span>)</span><br><span class="line">           .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update();</span><br><span class="line">   <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">       <span class="comment">//æ‰£å‡åº“å­˜</span></span><br><span class="line">       <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾çº¿ç¨‹1è¿‡æ¥æŸ¥è¯¢åº“å­˜ï¼Œåˆ¤æ–­å‡ºæ¥åº“å­˜å¤§äº1ï¼Œæ­£å‡†å¤‡å»æ‰£å‡åº“å­˜ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ¥å¾—åŠå»æ‰£å‡ï¼Œæ­¤æ—¶çº¿ç¨‹2è¿‡æ¥ï¼Œçº¿ç¨‹2ä¹Ÿå»æŸ¥è¯¢åº“å­˜ï¼Œå‘ç°è¿™ä¸ªæ•°é‡ä¸€å®šä¹Ÿå¤§äº1ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªçº¿ç¨‹éƒ½ä¼šå»æ‰£å‡åº“å­˜ï¼Œæœ€ç»ˆå¤šä¸ªçº¿ç¨‹ç›¸å½“äºä¸€èµ·å»æ‰£å‡åº“å­˜ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°åº“å­˜çš„è¶…å–é—®é¢˜ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230607171606864.png" alt="image-20230607171606864" style="zoom: 33%;" /><p>è¶…å–é—®é¢˜æ˜¯å…¸å‹çš„å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé’ˆå¯¹è¿™ä¸€é—®é¢˜çš„å¸¸è§è§£å†³æ–¹æ¡ˆå°±æ˜¯åŠ é”ï¼šè€Œå¯¹äºåŠ é”ï¼Œæˆ‘ä»¬é€šå¸¸æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆ</p><ul><li>æ‚²è§‚é”ï¼šè®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜ä¸€å®šä¼šå‘ç”Ÿï¼Œå› æ­¤åœ¨æ“ä½œæ•°æ®ä¹‹å‰å…ˆè·å–é”ï¼Œç¡®ä¿çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œã€‚ä¾‹å¦‚Synchronizedã€ Lockéƒ½å±äºæ‚²è§‚é”</li><li>ä¹è§‚é”ï¼šè®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜ä¸ä¸€å®šä¼šå‘ç”Ÿï¼Œå› æ­¤ä¸åŠ é”ï¼Œåªæ˜¯åœ¨æ›´æ–°æ•°æ®æ—¶å»åˆ¤æ–­æœ‰æ²¡æœ‰å…¶å®ƒçº¿ç¨‹å¯¹æ•°æ®åšäº†ä¿®æ”¹ã€‚å¦‚æœæ²¡æœ‰ä¿®æ”¹åˆ™è®¤ä¸ºæ˜¯å®‰å…¨çš„ï¼Œè‡ªå·±æ‰æ›´æ–°æ•°æ®ã€‚å¦‚æœå·²ç»è¢«å…¶å®ƒçº¿ç¨‹ä¿®æ”¹è¯´æ˜å‘ç”Ÿäº†å®‰å…¨é—®é¢˜ï¼Œæ­¤æ—¶å¯ä»¥é‡è¯•æˆ–å¼‚å¸¸ã€‚</li></ul><hr><h3 id="ä¹è§‚é”è§£å†³è¶…å–é—®é¢˜">ä¹è§‚é”è§£å†³è¶…å–é—®é¢˜</h3><div class="tabs" id="3ed92029-ae41-412d-8870-94fe421ccd57"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#3ed92029-ae41-412d-8870-94fe421ccd57-1"><i class="fas fa-award"></i>ä¿®æ”¹ä»£ç æ–¹æ¡ˆä¸€</button></li><li class="tab"><button type="button" data-href="#3ed92029-ae41-412d-8870-94fe421ccd57-2"><i class="fas fa-baseball-ball"></i>æ”¹è¿›ä»£ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="3ed92029-ae41-412d-8870-94fe421ccd57-1"><p>VoucherOrderServiceImpl åœ¨æ‰£å‡åº“å­˜æ—¶ï¼Œæ”¹ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock= stock -1&quot;</span>) <span class="comment">//set stock = stock -1</span></span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).eq(<span class="string">&quot;stock&quot;</span>,voucher.getStock()).update(); <span class="comment">//where id = ï¼Ÿ and stock = ?</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šé€»è¾‘çš„æ ¸å¿ƒå«ä¹‰æ˜¯ï¼šåªè¦æˆ‘æ‰£å‡åº“å­˜æ—¶çš„åº“å­˜å’Œä¹‹å‰æˆ‘æŸ¥è¯¢åˆ°çš„åº“å­˜æ˜¯ä¸€æ ·çš„ï¼Œå°±æ„å‘³ç€æ²¡æœ‰äººåœ¨ä¸­é—´ä¿®æ”¹è¿‡åº“å­˜ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±æ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯ä»¥ä¸Šè¿™ç§æ–¹å¼é€šè¿‡æµ‹è¯•å‘ç°ä¼šæœ‰å¾ˆå¤šå¤±è´¥çš„æƒ…å†µï¼Œå¤±è´¥çš„åŸå› åœ¨äºï¼šåœ¨ä½¿ç”¨ä¹è§‚é”è¿‡ç¨‹ä¸­å‡è®¾100ä¸ªçº¿ç¨‹åŒæ—¶éƒ½æ‹¿åˆ°äº†100çš„åº“å­˜ï¼Œç„¶åå¤§å®¶ä¸€èµ·å»è¿›è¡Œæ‰£å‡ï¼Œä½†æ˜¯100ä¸ªäººä¸­åªæœ‰1ä¸ªäººèƒ½æ‰£å‡æˆåŠŸï¼Œå…¶ä»–çš„äººåœ¨å¤„ç†æ—¶ï¼Œä»–ä»¬åœ¨æ‰£å‡æ—¶ï¼Œåº“å­˜å·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œæ‰€ä»¥æ­¤æ—¶å…¶ä»–çº¿ç¨‹éƒ½ä¼šå¤±è´¥</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="3ed92029-ae41-412d-8870-94fe421ccd57-2"><p>ä¹‹å‰çš„æ–¹å¼è¦ä¿®æ”¹å‰åéƒ½ä¿æŒä¸€è‡´ï¼Œä½†æ˜¯è¿™æ ·æˆ‘ä»¬åˆ†æè¿‡ï¼ŒæˆåŠŸçš„æ¦‚ç‡å¤ªä½ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ä¹è§‚é”éœ€è¦å˜ä¸€ä¸‹ï¼Œæ”¹æˆstockå¤§äº0 å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock= stock -1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update().gt(<span class="string">&quot;stock&quot;</span>,<span class="number">0</span>); <span class="comment">//where id = ? and stock &gt; 0</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="ä¸€äººä¸€å•">ä¸€äººä¸€å•</h3><p>éœ€æ±‚ï¼šä¿®æ”¹ç§’æ€ä¸šåŠ¡ï¼Œè¦æ±‚åŒä¸€ä¸ªä¼˜æƒ åˆ¸ï¼Œä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€å•</p><p>ç°åœ¨çš„é—®é¢˜åœ¨äºï¼š</p><p>ä¼˜æƒ å·æ˜¯ä¸ºäº†å¼•æµï¼Œä½†æ˜¯ç›®å‰çš„æƒ…å†µæ˜¯ï¼Œä¸€ä¸ªäººå¯ä»¥æ— é™åˆ¶çš„æŠ¢è¿™ä¸ªä¼˜æƒ å·ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”å½“å¢åŠ ä¸€å±‚é€»è¾‘ï¼Œè®©ä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€ä¸ªå•ï¼Œè€Œä¸æ˜¯è®©ä¸€ä¸ªç”¨æˆ·ä¸‹å¤šä¸ªå•</p><p>å…·ä½“æ“ä½œé€»è¾‘å¦‚ä¸‹ï¼šæ¯”å¦‚æ—¶é—´æ˜¯å¦å……è¶³ï¼Œå¦‚æœæ—¶é—´å……è¶³ï¼Œåˆ™è¿›ä¸€æ­¥åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œç„¶åå†æ ¹æ®ä¼˜æƒ å·idå’Œç”¨æˆ·idæŸ¥è¯¢æ˜¯å¦å·²ç»ä¸‹è¿‡è¿™ä¸ªè®¢å•ï¼Œå¦‚æœä¸‹è¿‡è¿™ä¸ªè®¢å•ï¼Œåˆ™ä¸å†ä¸‹å•ï¼Œå¦åˆ™è¿›è¡Œä¸‹å•</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653371854389.png" alt="1653371854389" style="zoom:67%;" /><mark class="hl-label blue">ä»£ç å®ç°</mark> <div class="tabs" id="335ee1ee-824b-4142-8394-a9c120829fa1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#335ee1ee-824b-4142-8394-a9c120829fa1-1"><i class="fas fa-bug"></i>åˆæ­¥ä»£ç </button></li><li class="tab"><button type="button" data-href="#335ee1ee-824b-4142-8394-a9c120829fa1-2"><i class="fas fa-heartbeat"></i>å°è£…æ–¹æ³•</button></li><li class="tab"><button type="button" data-href="#335ee1ee-824b-4142-8394-a9c120829fa1-3"><i class="fas fa-cannabis"></i>é—®é¢˜åˆ†æ1</button></li><li class="tab"><button type="button" data-href="#335ee1ee-824b-4142-8394-a9c120829fa1-4"><i class="fas fa-candy-cane"></i>ä»£ç å®ç°1</button></li><li class="tab"><button type="button" data-href="#335ee1ee-824b-4142-8394-a9c120829fa1-5"><i class="fas fa-child"></i>é—®é¢˜åˆ†æ2</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="335ee1ee-824b-4142-8394-a9c120829fa1-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.ä¸€äººä¸€å•é€»è¾‘</span></span><br><span class="line">    <span class="comment">// 5.1.ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">    <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6ï¼Œæ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock= stock -1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="comment">//æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//7.åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">// 7.1.è®¢å•id</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line"></span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    <span class="comment">// 7.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    save(voucherOrder);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="335ee1ee-824b-4142-8394-a9c120829fa1-2"><p>å°è£…äº†ä¸€ä¸ªcreateVoucherOrderæ–¹æ³•ï¼ŒåŒæ—¶ä¸ºäº†ç¡®ä¿ä»–çº¿ç¨‹å®‰å…¨ï¼Œåœ¨æ–¹æ³•ä¸Šæ·»åŠ äº†ä¸€æŠŠsynchronized é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">         <span class="comment">// 5.1.æŸ¥è¯¢è®¢å•</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">        <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) <span class="comment">// set stock = stock - 1</span></span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>) <span class="comment">// where id = ? and stock &gt; 0</span></span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.åˆ›å»ºè®¢å•</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="comment">// 7.1.è®¢å•id</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        <span class="comment">// 7.2.ç”¨æˆ·id</span></span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        <span class="comment">// 7.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        save(voucherOrder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.è¿”å›è®¢å•id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="335ee1ee-824b-4142-8394-a9c120829fa1-3"><p>ç°åœ¨çš„é—®é¢˜è¿˜æ˜¯å’Œä¹‹å‰ä¸€æ ·ï¼Œå¹¶å‘è¿‡æ¥ï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œéƒ½ä¸å­˜åœ¨è®¢å•ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯éœ€è¦åŠ é”ï¼Œä½†æ˜¯ä¹è§‚é”æ¯”è¾ƒé€‚åˆæ›´æ–°æ•°æ®ï¼Œè€Œç°åœ¨æ˜¯æ’å…¥æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ‚²è§‚é”æ“ä½œã€‚æˆ‘ä»¬åœ¨æ–¹æ³•ä¸Šæ·»åŠ äº†ä¸€æŠŠsynchronized é”ï¼Œä½†æ˜¯è¿™æ ·æ·»åŠ é”ï¼Œé”çš„ç²’åº¦å¤ªç²—äº†ï¼Œåœ¨ä½¿ç”¨é”è¿‡ç¨‹ä¸­ï¼Œæ§åˆ¶é”ç²’åº¦æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„äº‹æƒ…ï¼Œå› ä¸ºå¦‚æœé”çš„ç²’åº¦å¤ªå¤§ï¼Œä¼šå¯¼è‡´æ¯ä¸ªçº¿ç¨‹è¿›æ¥éƒ½ä¼šé”ä½ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»æ§åˆ¶é”çš„ç²’åº¦ã€‚intern() è¿™ä¸ªæ–¹æ³•æ˜¯ä»å¸¸é‡æ± ä¸­æ‹¿åˆ°æ•°æ®ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨userId.toString() ä»–æ‹¿åˆ°çš„å¯¹è±¡å®é™…ä¸Šæ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œnewå‡ºæ¥çš„å¯¹è±¡ï¼Œæˆ‘ä»¬ä½¿ç”¨é”å¿…é¡»ä¿è¯é”å¿…é¡»æ˜¯åŒä¸€æŠŠï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨intern()æ–¹æ³•ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="335ee1ee-824b-4142-8394-a9c120829fa1-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span>  Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="keyword">synchronized</span>(userId.toString().intern())&#123;</span><br><span class="line">        <span class="comment">// 5.1.æŸ¥è¯¢è®¢å•</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">        <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) <span class="comment">// set stock = stock - 1</span></span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>) <span class="comment">// where id = ? and stock &gt; 0</span></span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.åˆ›å»ºè®¢å•</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="comment">// 7.1.è®¢å•id</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        <span class="comment">// 7.2.ç”¨æˆ·id</span></span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        <span class="comment">// 7.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        save(voucherOrder);</span><br><span class="line">        <span class="comment">// 7.è¿”å›è®¢å•id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="335ee1ee-824b-4142-8394-a9c120829fa1-5"><p>ä½†æ˜¯ä»¥ä¸Šä»£ç è¿˜æ˜¯å­˜åœ¨é—®é¢˜ï¼Œé—®é¢˜çš„åŸå› åœ¨äºå½“å‰æ–¹æ³•è¢«springçš„äº‹åŠ¡æ§åˆ¶ï¼Œå¦‚æœä½ åœ¨æ–¹æ³•å†…éƒ¨åŠ é”ï¼Œå¯èƒ½ä¼šå¯¼è‡´å½“å‰æ–¹æ³•äº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ï¼Œä½†æ˜¯é”å·²ç»é‡Šæ”¾ä¹Ÿä¼šå¯¼è‡´é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©å°†å½“å‰æ–¹æ³•æ•´ä½“åŒ…è£¹èµ·æ¥ï¼Œç¡®ä¿äº‹åŠ¡ä¸ä¼šå‡ºç°é—®é¢˜ï¼šå¦‚ä¸‹ï¼š</p><p>åœ¨seckillVoucher æ–¹æ³•ä¸­ï¼Œæ·»åŠ ä»¥ä¸‹é€»è¾‘ï¼Œè¿™æ ·å°±èƒ½ä¿è¯äº‹åŠ¡çš„ç‰¹æ€§ï¼ŒåŒæ—¶ä¹Ÿæ§åˆ¶äº†é”çš„ç²’åº¦</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653373434815.png" alt="1653373434815"></p><p>ä½†æ˜¯ä»¥ä¸Šåšæ³•ä¾ç„¶æœ‰é—®é¢˜ï¼Œå› ä¸ºä½ è°ƒç”¨çš„æ–¹æ³•ï¼Œå…¶å®æ˜¯this.çš„æ–¹å¼è°ƒç”¨çš„ï¼Œäº‹åŠ¡æƒ³è¦ç”Ÿæ•ˆï¼Œè¿˜å¾—åˆ©ç”¨ä»£ç†æ¥ç”Ÿæ•ˆï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹ï¼Œæˆ‘ä»¬éœ€è¦è·å¾—åŸå§‹çš„äº‹åŠ¡å¯¹è±¡ï¼Œ æ¥æ“ä½œäº‹åŠ¡</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653383810643.png" alt="1653383810643"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜">é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜</h3><p>é€šè¿‡åŠ é”å¯ä»¥è§£å†³åœ¨å•æœºæƒ…å†µä¸‹çš„ä¸€äººä¸€å•å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯åœ¨é›†ç¾¤æ¨¡å¼ä¸‹å°±ä¸è¡Œäº†ã€‚</p><p>ç”±äºç°åœ¨æˆ‘ä»¬éƒ¨ç½²äº†å¤šä¸ªtomcatï¼Œæ¯ä¸ªtomcatéƒ½æœ‰ä¸€ä¸ªå±äºè‡ªå·±çš„jvmï¼Œé‚£ä¹ˆå‡è®¾åœ¨æœåŠ¡å™¨Açš„tomcatå†…éƒ¨ï¼Œæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹ç”±äºä½¿ç”¨çš„æ˜¯åŒä¸€ä»½ä»£ç ï¼Œé‚£ä¹ˆä»–ä»¬çš„é”å¯¹è±¡æ˜¯åŒä¸€ä¸ªï¼Œæ˜¯å¯ä»¥å®ç°äº’æ–¥çš„ï¼Œä½†æ˜¯å¦‚æœç°åœ¨æ˜¯æœåŠ¡å™¨Bçš„tomcatå†…éƒ¨ï¼Œåˆæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯ä»–ä»¬çš„é”å¯¹è±¡å†™çš„è™½ç„¶å’ŒæœåŠ¡å™¨Aä¸€æ ·ï¼Œä½†æ˜¯é”å¯¹è±¡å´ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥çº¿ç¨‹3å’Œçº¿ç¨‹4å¯ä»¥å®ç°äº’æ–¥ï¼Œä½†æ˜¯å´æ— æ³•å’Œçº¿ç¨‹1å’Œçº¿ç¨‹2å®ç°äº’æ–¥ï¼Œè¿™å°±æ˜¯ é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œsyné”å¤±æ•ˆçš„åŸå› ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653374044740.png" alt="1653374044740"></p><hr><hr><h2 id="åˆ†å¸ƒå¼é”">åˆ†å¸ƒå¼é”</h2><h3 id="åŸºæœ¬åŸç†å’Œå®ç°æ–¹å¼å¯¹æ¯”">åŸºæœ¬åŸç†å’Œå®ç°æ–¹å¼å¯¹æ¯”</h3><p>åˆ†å¸ƒå¼é”ï¼šæ»¡è¶³åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–é›†ç¾¤æ¨¡å¼ä¸‹å¤šè¿›ç¨‹å¯è§å¹¶ä¸”äº’æ–¥çš„é”ã€‚</p><p>åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯è®©å¤§å®¶éƒ½ä½¿ç”¨åŒä¸€æŠŠé”ï¼Œåªè¦å¤§å®¶ä½¿ç”¨çš„æ˜¯åŒä¸€æŠŠé”ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½é”ä½çº¿ç¨‹ï¼Œä¸è®©çº¿ç¨‹è¿›è¡Œï¼Œè®©ç¨‹åºä¸²è¡Œæ‰§è¡Œï¼Œè¿™å°±æ˜¯åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€è·¯</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653374296906.png" alt="1653374296906" style="zoom: 50%;" /><mark class="hl-label blue">é‚£ä¹ˆåˆ†å¸ƒå¼é”ä»–åº”è¯¥æ»¡è¶³ä¸€äº›ä»€ä¹ˆæ ·çš„æ¡ä»¶å‘¢ï¼Ÿ</mark> <p>å¯è§æ€§ï¼šå¤šä¸ªçº¿ç¨‹éƒ½èƒ½çœ‹åˆ°ç›¸åŒçš„ç»“æœï¼Œæ³¨æ„ï¼šè¿™ä¸ªåœ°æ–¹è¯´çš„å¯è§æ€§å¹¶ä¸æ˜¯å¹¶å‘ç¼–ç¨‹ä¸­æŒ‡çš„å†…å­˜å¯è§æ€§ï¼Œåªæ˜¯è¯´å¤šä¸ªè¿›ç¨‹ä¹‹é—´éƒ½èƒ½æ„ŸçŸ¥åˆ°å˜åŒ–çš„æ„æ€</p><p>äº’æ–¥ï¼šäº’æ–¥æ˜¯åˆ†å¸ƒå¼é”çš„æœ€åŸºæœ¬çš„æ¡ä»¶ï¼Œä½¿å¾—ç¨‹åºä¸²è¡Œæ‰§è¡Œ</p><p>é«˜å¯ç”¨ï¼šç¨‹åºä¸æ˜“å´©æºƒï¼Œæ—¶æ—¶åˆ»åˆ»éƒ½ä¿è¯è¾ƒé«˜çš„å¯ç”¨æ€§</p><p>é«˜æ€§èƒ½ï¼šç”±äºåŠ é”æœ¬èº«å°±è®©æ€§èƒ½é™ä½ï¼Œæ‰€æœ‰å¯¹äºåˆ†å¸ƒå¼é”æœ¬èº«éœ€è¦ä»–å°±è¾ƒé«˜çš„åŠ é”æ€§èƒ½å’Œé‡Šæ”¾é”æ€§èƒ½</p><p>å®‰å…¨æ€§ï¼šå®‰å…¨ä¹Ÿæ˜¯ç¨‹åºä¸­å¿…ä¸å¯å°‘çš„ä¸€ç¯</p><mark class="hl-label blue">å¸¸è§çš„åˆ†å¸ƒå¼é”æœ‰ä¸‰ç§</mark> <p>Mysqlï¼šmysqlæœ¬èº«å°±å¸¦æœ‰é”æœºåˆ¶ï¼Œä½†æ˜¯ç”±äºmysqlæ€§èƒ½æœ¬èº«ä¸€èˆ¬ï¼Œæ‰€ä»¥é‡‡ç”¨åˆ†å¸ƒå¼é”çš„æƒ…å†µä¸‹ï¼Œå…¶å®ä½¿ç”¨mysqlä½œä¸ºåˆ†å¸ƒå¼é”æ¯”è¾ƒå°‘è§</p><p>Redisï¼šredisä½œä¸ºåˆ†å¸ƒå¼é”æ˜¯éå¸¸å¸¸è§çš„ä¸€ç§ä½¿ç”¨æ–¹å¼ï¼Œç°åœ¨ä¼ä¸šçº§å¼€å‘ä¸­åŸºæœ¬éƒ½ä½¿ç”¨redisæˆ–è€…zookeeperä½œä¸ºåˆ†å¸ƒå¼é”ï¼Œåˆ©ç”¨setnxè¿™ä¸ªæ–¹æ³•ï¼Œå¦‚æœæ’å…¥keyæˆåŠŸï¼Œåˆ™è¡¨ç¤ºè·å¾—åˆ°äº†é”ï¼Œå¦‚æœæœ‰äººæ’å…¥æˆåŠŸï¼Œå…¶ä»–äººæ’å…¥å¤±è´¥åˆ™è¡¨ç¤ºæ— æ³•è·å¾—åˆ°é”ï¼Œåˆ©ç”¨è¿™å¥—é€»è¾‘æ¥å®ç°åˆ†å¸ƒå¼é”</p><p>Zookeeperï¼šzookeeperä¹Ÿæ˜¯ä¼ä¸šçº§å¼€å‘ä¸­è¾ƒå¥½çš„ä¸€ä¸ªå®ç°åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆï¼Œç”±äºæœ¬å¥—è§†é¢‘å¹¶ä¸è®²è§£zookeeperçš„åŸç†å’Œåˆ†å¸ƒå¼é”çš„å®ç°ï¼Œæ‰€ä»¥ä¸è¿‡å¤šé˜è¿°</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">MySQL</th><th style="text-align:center">Redis</th><th style="text-align:center">Zookeeper</th></tr></thead><tbody><tr><td style="text-align:center">äº’æ–¥</td><td style="text-align:center">åˆ©ç”¨mysqlæœ¬èº«çš„äº’æ–¥é”æœºåˆ¶</td><td style="text-align:center">åˆ©ç”¨setnxè¿™æ ·çš„äº’æ–¥å‘½ä»¤</td><td style="text-align:center">åˆ©ç”¨èŠ‚ç‚¹çš„å”¯ä¸€æ€§å’Œæœ‰åºæ€§å®ç°äº’æ–¥</td></tr><tr><td style="text-align:center">é«˜å¯ç”¨</td><td style="text-align:center">å¥½</td><td style="text-align:center">å¥½</td><td style="text-align:center">å¥½</td></tr><tr><td style="text-align:center">é«˜æ€§èƒ½</td><td style="text-align:center">ä¸€èˆ¬</td><td style="text-align:center">å¥½</td><td style="text-align:center">ä¸€èˆ¬</td></tr><tr><td style="text-align:center">å®‰å…¨æ€§</td><td style="text-align:center">æ–­å¼€è¿æ¥ï¼Œè‡ªåŠ¨é‡Šæ”¾é”</td><td style="text-align:center">åˆ©ç”¨é”è¶…æ—¶æ—¶é—´ï¼Œåˆ°æœŸé‡Šæ”¾</td><td style="text-align:center">ä¸´æ—¶èŠ‚ç‚¹ï¼Œæ–­å¼€è¿æ¥è‡ªåŠ¨é‡Šæ”¾</td></tr></tbody></table><hr><h3 id="Redisåˆ†å¸ƒå¼é”å®ç°æ€è·¯">Redisåˆ†å¸ƒå¼é”å®ç°æ€è·¯</h3><p>å®ç°åˆ†å¸ƒå¼é”æ—¶éœ€è¦å®ç°çš„ä¸¤ä¸ªåŸºæœ¬æ–¹æ³•ï¼š</p><ul><li><p>è·å–é”ï¼š</p><ul><li>äº’æ–¥ï¼šç¡®ä¿åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”</li><li>éé˜»å¡ï¼šå°è¯•ä¸€æ¬¡ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false</li></ul></li><li><p>é‡Šæ”¾é”ï¼š</p><ul><li>æ‰‹åŠ¨é‡Šæ”¾</li><li>è¶…æ—¶é‡Šæ”¾ï¼šè·å–é”æ—¶æ·»åŠ ä¸€ä¸ªè¶…æ—¶æ—¶é—´</li></ul></li></ul><p>æˆ‘ä»¬åˆ©ç”¨redis çš„setnxæ–¹æ³•ï¼Œå½“æœ‰å¤šä¸ªçº¿ç¨‹è¿›å…¥æ—¶ï¼Œæˆ‘ä»¬å°±åˆ©ç”¨è¯¥æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›å…¥æ—¶ï¼Œredis ä¸­å°±æœ‰è¿™ä¸ªkey äº†ï¼Œè¿”å›äº†1ï¼Œå¦‚æœç»“æœæ˜¯1ï¼Œåˆ™è¡¨ç¤ºä»–æŠ¢åˆ°äº†é”ï¼Œé‚£ä¹ˆä»–å»æ‰§è¡Œä¸šåŠ¡ï¼Œç„¶åå†åˆ é™¤é”ï¼Œé€€å‡ºé”é€»è¾‘ï¼Œæ²¡æœ‰æŠ¢åˆ°é”çš„å“¥ä»¬ï¼Œç­‰å¾…ä¸€å®šæ—¶é—´åé‡è¯•å³å¯</p><hr><h3 id="Rediså®ç°åˆ†å¸ƒå¼é”ç‰ˆæœ¬ä¸€">Rediså®ç°åˆ†å¸ƒå¼é”ç‰ˆæœ¬ä¸€</h3><div class="tabs" id="6661440d-2301-409e-8e0d-f8408cedc68f"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6661440d-2301-409e-8e0d-f8408cedc68f-1"><i class="fas fa-award"></i>é”çš„åŸºæœ¬æ¥å£</button></li><li class="tab"><button type="button" data-href="#6661440d-2301-409e-8e0d-f8408cedc68f-2"><i class="fas fa-baseball-ball"></i>åŠ é”é€»è¾‘</button></li><li class="tab"><button type="button" data-href="#6661440d-2301-409e-8e0d-f8408cedc68f-3"><i class="fas fa-bone"></i>é‡Šæ”¾é”é€»è¾‘</button></li><li class="tab"><button type="button" data-href="#6661440d-2301-409e-8e0d-f8408cedc68f-4"><i class="fas fa-anchor"></i>ä½¿ç”¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6661440d-2301-409e-8e0d-f8408cedc68f-1"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1656079017728.png" alt="1656079017728"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6661440d-2301-409e-8e0d-f8408cedc68f-2"><p>åˆ›å»º<code>SimpleRedisLock</code>å®ç°<code>ILock</code>æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRedisLock</span> <span class="keyword">implements</span> <span class="title class_">ILock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_PREFIX=<span class="string">&quot;lock:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">threadId</span> <span class="operator">=</span> Thread.currentThread().getId();</span><br><span class="line">        <span class="comment">// è·å–é”</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">                .setIfAbsent(KEY_PREFIX + name, threadId + <span class="string">&quot;&quot;</span>, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6661440d-2301-409e-8e0d-f8408cedc68f-3"><p>é‡Šæ”¾é”ï¼Œé˜²æ­¢åˆ é™¤åˆ«äººçš„é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//é€šè¿‡delåˆ é™¤é”</span></span><br><span class="line">    stringRedisTemplate.delete(KEY_PREFIX + name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6661440d-2301-409e-8e0d-f8408cedc68f-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">     <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">     <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">     <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">     <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">         <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">         <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">     <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">         <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">         <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">     <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">         <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">         <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">     <span class="comment">//åˆ›å»ºé”å¯¹è±¡(æ–°å¢ä»£ç )</span></span><br><span class="line">     <span class="type">SimpleRedisLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleRedisLock</span>(<span class="string">&quot;order:&quot;</span> + userId, stringRedisTemplate);</span><br><span class="line">     <span class="comment">//è·å–é”å¯¹è±¡</span></span><br><span class="line">     <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">1200</span>);</span><br><span class="line"><span class="comment">//åŠ é”å¤±è´¥</span></span><br><span class="line">     <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">         <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">//è·å–ä»£ç†å¯¹è±¡(äº‹åŠ¡)</span></span><br><span class="line">         <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">         <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">     &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">         <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">         lock.unlock();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="Redisåˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µè¯´æ˜">Redisåˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µè¯´æ˜</h3><p>é€»è¾‘è¯´æ˜ï¼š</p><p>æŒæœ‰é”çš„çº¿ç¨‹åœ¨é”çš„å†…éƒ¨å‡ºç°äº†é˜»å¡ï¼Œå¯¼è‡´ä»–çš„é”è‡ªåŠ¨é‡Šæ”¾ï¼Œè¿™æ—¶å…¶ä»–çº¿ç¨‹ï¼Œçº¿ç¨‹2æ¥å°è¯•è·å¾—é”ï¼Œå°±æ‹¿åˆ°äº†è¿™æŠŠé”ï¼Œç„¶åçº¿ç¨‹2åœ¨æŒæœ‰é”æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹1ååº”è¿‡æ¥ï¼Œç»§ç»­æ‰§è¡Œï¼Œè€Œçº¿ç¨‹1æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œèµ°åˆ°äº†åˆ é™¤é”é€»è¾‘ï¼Œæ­¤æ—¶å°±ä¼šæŠŠæœ¬åº”è¯¥å±äºçº¿ç¨‹2çš„é”è¿›è¡Œåˆ é™¤ï¼Œè¿™å°±æ˜¯è¯¯åˆ åˆ«äººé”çš„æƒ…å†µè¯´æ˜</p><p>è§£å†³æ–¹æ¡ˆï¼šè§£å†³æ–¹æ¡ˆå°±æ˜¯åœ¨æ¯ä¸ªçº¿ç¨‹é‡Šæ”¾é”çš„æ—¶å€™ï¼Œå»åˆ¤æ–­ä¸€ä¸‹å½“å‰è¿™æŠŠé”æ˜¯å¦å±äºè‡ªå·±ï¼Œå¦‚æœå±äºè‡ªå·±ï¼Œåˆ™ä¸è¿›è¡Œé”çš„åˆ é™¤ï¼Œå‡è®¾è¿˜æ˜¯ä¸Šè¾¹çš„æƒ…å†µï¼Œçº¿ç¨‹1å¡é¡¿ï¼Œé”è‡ªåŠ¨é‡Šæ”¾ï¼Œçº¿ç¨‹2è¿›å…¥åˆ°é”çš„å†…éƒ¨æ‰§è¡Œé€»è¾‘ï¼Œæ­¤æ—¶çº¿ç¨‹1ååº”è¿‡æ¥ï¼Œç„¶ååˆ é™¤é”ï¼Œä½†æ˜¯çº¿ç¨‹1ï¼Œä¸€çœ‹å½“å‰è¿™æŠŠé”ä¸æ˜¯å±äºè‡ªå·±ï¼Œäºæ˜¯ä¸è¿›è¡Œåˆ é™¤é”é€»è¾‘ï¼Œå½“çº¿ç¨‹2èµ°åˆ°åˆ é™¤é”é€»è¾‘æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¡è¿‡è‡ªåŠ¨é‡Šæ”¾é”çš„æ—¶é—´ç‚¹ï¼Œåˆ™åˆ¤æ–­å½“å‰è¿™æŠŠé”æ˜¯å±äºè‡ªå·±çš„ï¼Œäºæ˜¯åˆ é™¤è¿™æŠŠé”ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653385920025.png" alt="1653385920025" style="zoom:67%;" /><mark class="hl-label blue">è§£å†³Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜</mark> <div class="tabs" id="421e4a73-18f7-4d39-9729-ecce756dbdf1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#421e4a73-18f7-4d39-9729-ecce756dbdf1-1"><i class="fas fa-bug"></i>å®ç°æ€è·¯</button></li><li class="tab"><button type="button" data-href="#421e4a73-18f7-4d39-9729-ecce756dbdf1-2"><i class="fas fa-cannabis"></i>åŠ é”</button></li><li class="tab"><button type="button" data-href="#421e4a73-18f7-4d39-9729-ecce756dbdf1-3"><i class="fas fa-candy-cane"></i>é‡Šæ”¾é”</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="421e4a73-18f7-4d39-9729-ecce756dbdf1-1"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230607190409171.png" alt="image-20230607190409171" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="421e4a73-18f7-4d39-9729-ecce756dbdf1-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ID_PREFIX</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>) + <span class="string">&quot;-&quot;</span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">   <span class="comment">// è·å–çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line">   <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">   <span class="comment">// è·å–é”</span></span><br><span class="line">   <span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">                .setIfAbsent(KEY_PREFIX + name, threadId, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">   <span class="keyword">return</span> Boolean.TRUE.equals(success);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="421e4a73-18f7-4d39-9729-ecce756dbdf1-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">    <span class="comment">// è·å–é”ä¸­çš„æ ‡ç¤º</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(KEY_PREFIX + name);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ ‡ç¤ºæ˜¯å¦ä¸€è‡´</span></span><br><span class="line">    <span class="keyword">if</span>(threadId.equals(id)) &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">        stringRedisTemplate.delete(KEY_PREFIX + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜">åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜</h3><p>æ›´ä¸ºæç«¯çš„è¯¯åˆ é€»è¾‘è¯´æ˜ï¼š</p><p>çº¿ç¨‹1ç°åœ¨æŒæœ‰é”ä¹‹åï¼Œåœ¨æ‰§è¡Œä¸šåŠ¡é€»è¾‘è¿‡ç¨‹ä¸­ï¼Œä»–æ­£å‡†å¤‡åˆ é™¤é”ï¼Œè€Œä¸”å·²ç»èµ°åˆ°äº†æ¡ä»¶åˆ¤æ–­çš„è¿‡ç¨‹ä¸­ï¼Œæ¯”å¦‚ä»–å·²ç»æ‹¿åˆ°äº†å½“å‰è¿™æŠŠé”ç¡®å®æ˜¯å±äºä»–è‡ªå·±çš„ï¼Œæ­£å‡†å¤‡åˆ é™¤é”ï¼Œä½†æ˜¯æ­¤æ—¶ä»–çš„é”åˆ°æœŸäº†ï¼Œé‚£ä¹ˆæ­¤æ—¶çº¿ç¨‹2è¿›æ¥ï¼Œä½†æ˜¯çº¿ç¨‹1ä»–ä¼šæ¥ç€å¾€åæ‰§è¡Œï¼Œå½“ä»–å¡é¡¿ç»“æŸåï¼Œä»–ç›´æ¥å°±ä¼šæ‰§è¡Œåˆ é™¤é”é‚£è¡Œä»£ç ï¼Œç›¸å½“äºæ¡ä»¶åˆ¤æ–­å¹¶æ²¡æœ‰èµ·åˆ°ä½œç”¨ï¼Œè¿™å°±æ˜¯åˆ é”æ—¶çš„åŸå­æ€§é—®é¢˜ï¼Œä¹‹æ‰€ä»¥æœ‰è¿™ä¸ªé—®é¢˜ï¼Œæ˜¯å› ä¸ºçº¿ç¨‹1çš„æ‹¿é”ï¼Œæ¯”é”ï¼Œåˆ é”ï¼Œå®é™…ä¸Šå¹¶ä¸æ˜¯åŸå­æ€§çš„ï¼Œæˆ‘ä»¬è¦é˜²æ­¢åˆšæ‰çš„æƒ…å†µå‘ç”Ÿã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230607190933715.png" alt="image-20230607190933715" style="zoom: 50%;" /><hr><h3 id="Luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜">Luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜</h3><p>Redisæä¾›äº†Luaè„šæœ¬åŠŸèƒ½ï¼Œåœ¨ä¸€ä¸ªè„šæœ¬ä¸­ç¼–å†™å¤šæ¡Rediså‘½ä»¤ï¼Œç¡®ä¿å¤šæ¡å‘½ä»¤æ‰§è¡Œæ—¶çš„åŸå­æ€§ã€‚Luaæ˜¯ä¸€ç§ç¼–ç¨‹è¯­è¨€ï¼Œå®ƒçš„åŸºæœ¬è¯­æ³•å¤§å®¶å¯ä»¥å‚è€ƒç½‘ç«™ï¼š<a href="https://www.runoob.com/lua/lua-tutorial.html%EF%BC%8C%E8%BF%99%E9%87%8C%E9%87%8D%E7%82%B9%E4%BB%8B%E7%BB%8DRedis%E6%8F%90%E4%BE%9B%E7%9A%84%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8lua%E5%8E%BB%E6%93%8D%E4%BD%9Credis%EF%BC%8C%E5%8F%88%E8%83%BD%E4%BF%9D%E8%AF%81%E4%BB%96%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%B0%B1%E5%8F%AF%E4%BB%A5%E5%AE%9E%E7%8E%B0%E6%8B%BF%E9%94%81%E6%AF%94%E9%94%81%E5%88%A0%E9%94%81%E6%98%AF%E4%B8%80%E4%B8%AA%E5%8E%9F%E5%AD%90%E6%80%A7%E5%8A%A8%E4%BD%9C%E4%BA%86%EF%BC%8C%E4%BD%9C%E4%B8%BAJava%E7%A8%8B%E5%BA%8F%E5%91%98%E8%BF%99%E4%B8%80%E5%9D%97%E5%B9%B6%E4%B8%8D%E4%BD%9C%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E8%A6%81%E6%B1%82%EF%BC%8C%E5%B9%B6%E4%B8%8D%E9%9C%80%E8%A6%81%E5%A4%A7%E5%AE%B6%E8%BF%87%E4%BA%8E%E7%B2%BE%E9%80%9A%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E4%BB%96%E6%9C%89%E4%BB%80%E4%B9%88%E4%BD%9C%E7%94%A8%E5%8D%B3%E5%8F%AF%E3%80%82">https://www.runoob.com/lua/lua-tutorial.htmlï¼Œè¿™é‡Œé‡ç‚¹ä»‹ç»Redisæä¾›çš„è°ƒç”¨å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨luaå»æ“ä½œredisï¼Œåˆèƒ½ä¿è¯ä»–çš„åŸå­æ€§ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°æ‹¿é”æ¯”é”åˆ é”æ˜¯ä¸€ä¸ªåŸå­æ€§åŠ¨ä½œäº†ï¼Œä½œä¸ºJavaç¨‹åºå‘˜è¿™ä¸€å—å¹¶ä¸ä½œä¸€ä¸ªç®€å•è¦æ±‚ï¼Œå¹¶ä¸éœ€è¦å¤§å®¶è¿‡äºç²¾é€šï¼Œåªéœ€è¦çŸ¥é“ä»–æœ‰ä»€ä¹ˆä½œç”¨å³å¯ã€‚</a></p><p>è¿™é‡Œé‡ç‚¹ä»‹ç»Redisæä¾›çš„è°ƒç”¨å‡½æ•°ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.call(<span class="string">&#x27;å‘½ä»¤åç§°&#x27;</span>, <span class="string">&#x27;key&#x27;</span>, <span class="string">&#x27;å…¶å®ƒå‚æ•°&#x27;</span>, ...)</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦æ‰§è¡Œset name jackï¼Œåˆ™è„šæœ¬æ˜¯è¿™æ ·ï¼š</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># æ‰§è¡Œ set name jack</span><br><span class="line">redis.call(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;jack&#x27;</span>)</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦å…ˆæ‰§è¡Œset name Roseï¼Œå†æ‰§è¡Œget nameï¼Œåˆ™è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># å…ˆæ‰§è¡Œ set name jack</span><br><span class="line">redis.call(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;Rose&#x27;</span>)</span><br><span class="line"># å†æ‰§è¡Œ get name</span><br><span class="line"><span class="keyword">local</span> name = redis.call(<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"># è¿”å›</span><br><span class="line"><span class="keyword">return</span> name</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å›ä¸€ä¸‹æˆ‘ä»¬é‡Šæ”¾é”çš„é€»è¾‘ï¼š</p><p>é‡Šæ”¾é”çš„ä¸šåŠ¡æµç¨‹æ˜¯è¿™æ ·çš„</p><p>â€‹1ã€è·å–é”ä¸­çš„çº¿ç¨‹æ ‡ç¤º</p><p>â€‹2ã€åˆ¤æ–­æ˜¯å¦ä¸æŒ‡å®šçš„æ ‡ç¤ºï¼ˆå½“å‰çº¿ç¨‹æ ‡ç¤ºï¼‰ä¸€è‡´</p><p>â€‹3ã€å¦‚æœä¸€è‡´åˆ™é‡Šæ”¾é”ï¼ˆåˆ é™¤ï¼‰</p><p>â€‹4ã€å¦‚æœä¸ä¸€è‡´åˆ™ä»€ä¹ˆéƒ½ä¸åš</p><p>å¦‚æœç”¨Luaè„šæœ¬æ¥è¡¨ç¤ºåˆ™æ˜¯è¿™æ ·çš„ï¼š</p><p>æœ€ç»ˆæˆ‘ä»¬æ“ä½œredisçš„æ‹¿é”æ¯”é”åˆ é”çš„luaè„šæœ¬å°±ä¼šå˜æˆè¿™æ ·</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- è¿™é‡Œçš„ KEYS[1] å°±æ˜¯é”çš„keyï¼Œè¿™é‡Œçš„ARGV[1] å°±æ˜¯å½“å‰çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line"><span class="comment">-- è·å–é”ä¸­çš„æ ‡ç¤ºï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡ç¤ºä¸€è‡´</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;GET&#x27;</span>, KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>]) <span class="keyword">then</span></span><br><span class="line">  <span class="comment">-- ä¸€è‡´ï¼Œåˆ™åˆ é™¤é”</span></span><br><span class="line">  <span class="keyword">return</span> redis.call(<span class="string">&#x27;DEL&#x27;</span>, KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- ä¸ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><mark class="hl-label blue">æœ€ç»ˆè§£é”ä»£ç </mark> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; UNLOCK_SCRIPT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    UNLOCK_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>();</span><br><span class="line">    UNLOCK_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;unlock.lua&quot;</span>));</span><br><span class="line">    UNLOCK_SCRIPT.setResultType(Long.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    stringRedisTemplate.execute(UNLOCK_SCRIPT,</span><br><span class="line">            Collections.singletonList(KEY_PREFIX + name),</span><br><span class="line">            ID_PREFIX + Thread.currentThread().getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="å°æ€»ç»“">å°æ€»ç»“</h3><p>åŸºäºRedisçš„åˆ†å¸ƒå¼é”å®ç°æ€è·¯ï¼š</p><ul><li>åˆ©ç”¨set nx exè·å–é”ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä¿å­˜çº¿ç¨‹æ ‡ç¤º</li><li>é‡Šæ”¾é”æ—¶å…ˆåˆ¤æ–­çº¿ç¨‹æ ‡ç¤ºæ˜¯å¦ä¸è‡ªå·±ä¸€è‡´ï¼Œä¸€è‡´åˆ™åˆ é™¤é”<ul><li>ç‰¹æ€§ï¼š<ul><li>åˆ©ç”¨set nxæ»¡è¶³äº’æ–¥æ€§</li><li>åˆ©ç”¨set exä¿è¯æ•…éšœæ—¶é”ä¾ç„¶èƒ½é‡Šæ”¾ï¼Œé¿å…æ­»é”ï¼Œæé«˜å®‰å…¨æ€§</li><li>åˆ©ç”¨Redisé›†ç¾¤ä¿è¯é«˜å¯ç”¨å’Œé«˜å¹¶å‘ç‰¹æ€§</li></ul></li></ul></li></ul><p>ç¬”è€…æ€»ç»“ï¼šæˆ‘ä»¬ä¸€è·¯èµ°æ¥ï¼Œåˆ©ç”¨æ·»åŠ è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”é—®é¢˜çš„å‘ç”Ÿï¼Œä½†æ˜¯æœ‰äº†è¿‡æœŸæ—¶é—´ä¹‹åï¼Œå¯èƒ½å‡ºç°è¯¯åˆ åˆ«äººé”çš„é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¼€å§‹æ˜¯åˆ©ç”¨åˆ ä¹‹å‰ é€šè¿‡æ‹¿é”ï¼Œæ¯”é”ï¼Œåˆ é”è¿™ä¸ªé€»è¾‘æ¥è§£å†³çš„ï¼Œä¹Ÿå°±æ˜¯åˆ ä¹‹å‰åˆ¤æ–­ä¸€ä¸‹å½“å‰è¿™æŠŠé”æ˜¯å¦æ˜¯å±äºè‡ªå·±çš„ï¼Œä½†æ˜¯ç°åœ¨è¿˜æœ‰åŸå­æ€§é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ²¡æ³•ä¿è¯æ‹¿é”æ¯”é”åˆ é”æ˜¯ä¸€ä¸ªåŸå­æ€§çš„åŠ¨ä½œï¼Œæœ€åé€šè¿‡luaè¡¨è¾¾å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜</p><p>ä½†æ˜¯ç›®å‰è¿˜å‰©ä¸‹ä¸€ä¸ªé—®é¢˜é”ä¸ä½ï¼Œä»€ä¹ˆæ˜¯é”ä¸ä½å‘¢ï¼Œä½ æƒ³ä¸€æƒ³ï¼Œå¦‚æœå½“è¿‡æœŸæ—¶é—´åˆ°äº†ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ç»™ä»–ç»­æœŸä¸€ä¸‹ï¼Œæ¯”å¦‚ç»­ä¸ª30sï¼Œå°±å¥½åƒæ˜¯ç½‘å§ä¸Šç½‘ï¼Œ ç½‘è´¹åˆ°äº†ä¹‹åï¼Œç„¶åè¯´ï¼Œæ¥ï¼Œç½‘ç®¡ï¼Œå†ç»™æˆ‘æ¥10å—çš„ï¼Œæ˜¯ä¸æ˜¯åè¾¹çš„é—®é¢˜éƒ½ä¸ä¼šå‘ç”Ÿäº†ï¼Œé‚£ä¹ˆç»­æœŸé—®é¢˜æ€ä¹ˆè§£å†³å‘¢ï¼Œå¯ä»¥ä¾èµ–äºæˆ‘ä»¬æ¥ä¸‹æ¥è¦å­¦ä¹ redissionå•¦</p><hr><hr><h2 id="åˆ†å¸ƒå¼é”-redission">åˆ†å¸ƒå¼é”-redission</h2><h3 id="setnxå­˜åœ¨çš„é—®é¢˜">setnxå­˜åœ¨çš„é—®é¢˜</h3><p>åŸºäºsetnxå®ç°çš„åˆ†å¸ƒå¼é”å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š</p><ul><li>é‡å…¥é—®é¢˜ï¼šé‡å…¥é—®é¢˜æ˜¯æŒ‡ è·å¾—é”çš„çº¿ç¨‹å¯ä»¥å†æ¬¡è¿›å…¥åˆ°ç›¸åŒçš„é”çš„ä»£ç å—ä¸­ï¼Œå¯é‡å…¥é”çš„æ„ä¹‰åœ¨äºé˜²æ­¢æ­»é”ï¼Œæ¯”å¦‚HashTableè¿™æ ·çš„ä»£ç ä¸­ï¼Œä»–çš„æ–¹æ³•éƒ½æ˜¯ä½¿ç”¨synchronizedä¿®é¥°çš„ï¼Œå‡å¦‚ä»–åœ¨ä¸€ä¸ªæ–¹æ³•å†…ï¼Œè°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆæ­¤æ—¶å¦‚æœæ˜¯ä¸å¯é‡å…¥çš„ï¼Œä¸å°±æ­»é”äº†å—ï¼Ÿæ‰€ä»¥å¯é‡å…¥é”ä»–çš„ä¸»è¦æ„ä¹‰æ˜¯é˜²æ­¢æ­»é”ï¼Œæˆ‘ä»¬çš„synchronizedå’ŒLocké”éƒ½æ˜¯å¯é‡å…¥çš„ã€‚</li><li>ä¸å¯é‡è¯•ï¼šæ˜¯æŒ‡ç›®å‰çš„åˆ†å¸ƒå¼åªèƒ½å°è¯•ä¸€æ¬¡ï¼Œæˆ‘ä»¬è®¤ä¸ºåˆç†çš„æƒ…å†µæ˜¯ï¼šå½“çº¿ç¨‹åœ¨è·å¾—é”å¤±è´¥åï¼Œä»–åº”è¯¥èƒ½å†æ¬¡å°è¯•è·å¾—é”ã€‚</li><li>è¶…æ—¶é‡Šæ”¾ï¼šæˆ‘ä»¬åœ¨åŠ é”æ—¶å¢åŠ äº†è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·çš„æˆ‘ä»¬å¯ä»¥é˜²æ­¢æ­»é”ï¼Œä½†æ˜¯å¦‚æœå¡é¡¿çš„æ—¶é—´è¶…é•¿ï¼Œè™½ç„¶æˆ‘ä»¬é‡‡ç”¨äº†luaè¡¨è¾¾å¼é˜²æ­¢åˆ é”çš„æ—¶å€™ï¼Œè¯¯åˆ åˆ«äººçš„é”ï¼Œä½†æ˜¯æ¯•ç«Ÿæ²¡æœ‰é”ä½ï¼Œæœ‰å®‰å…¨éšæ‚£</li><li>ä¸»ä»ä¸€è‡´æ€§ï¼š å¦‚æœRedisæä¾›äº†ä¸»ä»é›†ç¾¤ï¼Œå½“æˆ‘ä»¬å‘é›†ç¾¤å†™æ•°æ®æ—¶ï¼Œä¸»æœºéœ€è¦å¼‚æ­¥çš„å°†æ•°æ®åŒæ­¥ç»™ä»æœºï¼Œè€Œä¸‡ä¸€åœ¨åŒæ­¥è¿‡å»ä¹‹å‰ï¼Œä¸»æœºå®•æœºäº†ï¼Œå°±ä¼šå‡ºç°æ­»é”é—®é¢˜ã€‚</li></ul><p>é‚£ä¹ˆä»€ä¹ˆæ˜¯Redissionå‘¢ï¼Ÿ</p><p>Redissonæ˜¯ä¸€ä¸ªåœ¨Redisçš„åŸºç¡€ä¸Šå®ç°çš„Javaé©»å†…å­˜æ•°æ®ç½‘æ ¼ï¼ˆIn-Memory Data Gridï¼‰ã€‚å®ƒä¸ä»…æä¾›äº†ä¸€ç³»åˆ—çš„åˆ†å¸ƒå¼çš„Javaå¸¸ç”¨å¯¹è±¡ï¼Œè¿˜æä¾›äº†è®¸å¤šåˆ†å¸ƒå¼æœåŠ¡ï¼Œå…¶ä¸­å°±åŒ…å«äº†å„ç§åˆ†å¸ƒå¼é”çš„å®ç°ã€‚Redissionæä¾›äº†åˆ†å¸ƒå¼é”çš„å¤šç§å¤šæ ·çš„åŠŸèƒ½ã€‚</p><hr><h3 id="Redissionå¿«é€Ÿå…¥é—¨">Redissionå¿«é€Ÿå…¥é—¨</h3><div class="tabs" id="550dcb47-48ae-4dc5-81b4-1849f0bde594"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#550dcb47-48ae-4dc5-81b4-1849f0bde594-1"><i class="fas fa-seedling"></i>å¼•å…¥ä¾èµ–</button></li><li class="tab"><button type="button" data-href="#550dcb47-48ae-4dc5-81b4-1849f0bde594-2"><i class="fas fa-leaf"></i>é…ç½®Redissonå®¢æˆ·ç«¯</button></li><li class="tab"><button type="button" data-href="#550dcb47-48ae-4dc5-81b4-1849f0bde594-3"><i class="fas fa-cookie-bite"></i>ä½¿ç”¨1</button></li><li class="tab"><button type="button" data-href="#550dcb47-48ae-4dc5-81b4-1849f0bde594-4"><i class="fab fa-apple"></i>ä½¿ç”¨2</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="550dcb47-48ae-4dc5-81b4-1849f0bde594-1"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.13.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="550dcb47-48ae-4dc5-81b4-1849f0bde594-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// é…ç½®</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://8.130.68.59:6379&quot;</span>)</span><br><span class="line">            .setPassword(<span class="string">&quot;root123&quot;</span>);</span><br><span class="line">        <span class="comment">// åˆ›å»ºRedissonClientå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="550dcb47-48ae-4dc5-81b4-1849f0bde594-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissionClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testRedisson</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="comment">//è·å–é”(å¯é‡å…¥)ï¼ŒæŒ‡å®šé”çš„åç§°</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;anyLock&quot;</span>);</span><br><span class="line">    <span class="comment">//å°è¯•è·å–é”ï¼Œå‚æ•°åˆ†åˆ«æ˜¯ï¼šè·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´(æœŸé—´ä¼šé‡è¯•)ï¼Œé”è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ï¼Œæ—¶é—´å•ä½</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">1</span>,<span class="number">10</span>,TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­è·å–é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span>(isLock)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ‰§è¡Œä¸šåŠ¡&quot;</span>);          </span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="550dcb47-48ae-4dc5-81b4-1849f0bde594-4"><p>åœ¨ VoucherOrderServiceImplæ³¨å…¥RedissonClient</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">        <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">        <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//åˆ›å»ºé”å¯¹è±¡ è¿™ä¸ªä»£ç ä¸ç”¨äº†ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨è¦ä½¿ç”¨åˆ†å¸ƒå¼é”</span></span><br><span class="line">        <span class="comment">//SimpleRedisLock lock = new SimpleRedisLock(&quot;order:&quot; + userId, stringRedisTemplate);</span></span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">        <span class="comment">//è·å–é”å¯¹è±¡</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock();</span><br><span class="line">       </span><br><span class="line"><span class="comment">//åŠ é”å¤±è´¥</span></span><br><span class="line">        <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//è·å–ä»£ç†å¯¹è±¡(äº‹åŠ¡)</span></span><br><span class="line">            <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">            <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="redissonåˆ†å¸ƒå¼é”åŸç†">redissonåˆ†å¸ƒå¼é”åŸç†</h3><h4 id="å¯é‡å…¥åŸç†">å¯é‡å…¥åŸç†</h4><mark class="hl-label blue">åˆ©ç”¨hashç»“æ„è®°å½•çº¿ç¨‹idå’Œé‡å…¥æ¬¡æ•°</mark> <div class="tabs" id="adddc3e0-e4f7-4203-ab4c-c166ae4a5387"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#adddc3e0-e4f7-4203-ab4c-c166ae4a5387-1"><i class="fas fa-seedling"></i>è·å–é”çš„luaè„šæœ¬</button></li><li class="tab"><button type="button" data-href="#adddc3e0-e4f7-4203-ab4c-c166ae4a5387-2"><i class="fas fa-leaf"></i>è·å–é”æµç¨‹å›¾</button></li><li class="tab"><button type="button" data-href="#adddc3e0-e4f7-4203-ab4c-c166ae4a5387-3"><i class="fab fa-apple"></i>é‡Šæ”¾é”çš„luaè„šæœ¬</button></li><li class="tab"><button type="button" data-href="#adddc3e0-e4f7-4203-ab4c-c166ae4a5387-4"><i class="fas fa-tree"></i>é‡Šæ”¾é”æµç¨‹å›¾</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="adddc3e0-e4f7-4203-ab4c-c166ae4a5387-1"><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>]; <span class="comment">-- é”çš„key</span></span><br><span class="line"><span class="keyword">local</span> threadId = ARGV[<span class="number">1</span>]; <span class="comment">-- çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†</span></span><br><span class="line"><span class="keyword">local</span> releaseTime = ARGV[<span class="number">2</span>]; <span class="comment">-- é”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é—´</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- è‹¥é”ä¸å­˜åœ¨ï¼šåˆ™è·å–é”</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;exists&#x27;</span>, key) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">     redis.call(<span class="string">&#x27;hset&#x27;</span>, key, releaseTime, <span class="number">1</span>);</span><br><span class="line">     <span class="comment">-- è®¾ç½®é”æœ‰æ•ˆæœŸ</span></span><br><span class="line">     redis.call(<span class="string">&#x27;pexpire&#x27;</span>, key, threadId);</span><br><span class="line">     <span class="keyword">return</span> <span class="literal">nil</span>; <span class="comment">-- è¿”å›ç»“æœ</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="comment">-- é”å·²ç»å­˜åœ¨ï¼Œåˆ¤æ–­threadIdæ˜¯å¦æ˜¯è‡ªå·±</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;hexists&#x27;</span>, key, releaseTime) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">     <span class="comment">-- é”é‡å…¥æ¬¡æ•°+1</span></span><br><span class="line">     redis.call(<span class="string">&#x27;hincrby&#x27;</span>, key, releaseTime, <span class="number">1</span>);</span><br><span class="line">     <span class="comment">-- é‡æ–°è®¾ç½®æœ‰æ•ˆæœŸ</span></span><br><span class="line">     redis.call(<span class="string">&#x27;pexpire&#x27;</span>, key, threadId);</span><br><span class="line">     <span class="keyword">return</span> <span class="literal">nil</span>; <span class="comment">-- è¿”å›ç»“æœ</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="comment">--é”æ˜¯è¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼Œç›´æ¥è¿”å›é”å‰©ä½™è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="keyword">return</span> redis.call(<span class="string">&#x27;pttl&#x27;</span>, key);</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="adddc3e0-e4f7-4203-ab4c-c166ae4a5387-2"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230609170228655.png" alt="image-20230609170228655" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="adddc3e0-e4f7-4203-ab4c-c166ae4a5387-3"><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>]; <span class="comment">-- é”çš„key</span></span><br><span class="line"><span class="keyword">local</span> channel = KEYS[<span class="number">2</span>]; <span class="comment">-- è§£é”æ¶ˆæ¯PubSubé¢‘é“</span></span><br><span class="line"><span class="keyword">local</span> message = ARGV[<span class="number">1</span>]; <span class="comment">-- è§£é”æ¶ˆæ¯</span></span><br><span class="line"><span class="keyword">local</span> releaseTime = ARGV[<span class="number">2</span>]; <span class="comment">-- é”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é—´</span></span><br><span class="line"><span class="keyword">local</span> threadId = ARGV[<span class="number">3</span>]; <span class="comment">-- çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†</span></span><br><span class="line"><span class="comment">-- è‹¥é”ä¸å­˜åœ¨ï¼šåˆ™ç›´æ¥å¹¿æ’­è§£é”æ¶ˆæ¯ï¼Œå¹¶è¿”å›1</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;exists&#x27;</span>, key) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    redis.call(<span class="string">&#x27;publish&#x27;</span>, channel, message);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="comment">-- è‹¥é”å­˜åœ¨ï¼Œä½†å”¯ä¸€æ ‡è¯†ä¸åŒ¹é…</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;hexists&#x27;</span>, key, threadId) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>; <span class="comment">--ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="comment">-- æ˜¯è‡ªå·±çš„é”ï¼Œåˆ™é‡å…¥æ¬¡æ•°-1</span></span><br><span class="line"><span class="keyword">local</span> counter = redis.call(<span class="string">&#x27;hincrby&#x27;</span>, key, threadId, <span class="number">-1</span>);</span><br><span class="line"><span class="comment">-- åˆ¤æ–­é‡å…¥æ¬¡æ•°æ˜¯å¦å·²ç»ç­‰äº0</span></span><br><span class="line"><span class="keyword">if</span> (counter &gt; <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- å¤§äº0ï¼Œè¯´æ˜ä¸èƒ½é‡Šæ”¾é”ï¼Œé‡ç½®æœ‰æ•ˆæœŸç„¶åè¿”å›</span></span><br><span class="line">    redis.call(<span class="string">&#x27;pexpire&#x27;</span>, key, releaseTime);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="comment">--ç­‰äº0è¯´æ˜å¯ä»¥é‡Šæ”¾é”</span></span><br><span class="line">    <span class="comment">-- åˆ é™¤é”</span></span><br><span class="line">    redis.call(<span class="string">&#x27;del&#x27;</span>, key);</span><br><span class="line">    <span class="comment">-- å‘å¸ƒé”é‡Šæ”¾ä¿¡å·ï¼Œå¹¿æ’­è§£é”æ¶ˆæ¯ï¼Œå”¤é†’ç«äº‰è€…</span></span><br><span class="line">    redis.call(<span class="string">&#x27;publish&#x27;</span>, channel, message);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="adddc3e0-e4f7-4203-ab4c-c166ae4a5387-4"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230609170245983.png" alt="image-20230609170245983" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h4 id="é‡è¯•æœºåˆ¶å’Œçœ‹é—¨ç‹—æœºåˆ¶">é‡è¯•æœºåˆ¶å’Œçœ‹é—¨ç‹—æœºåˆ¶</h4><mark class="hl-label blue">å¯é‡è¯•ï¼šåˆ©ç”¨ä¿¡å·é‡å’ŒPubSubåŠŸèƒ½å®ç°ç­‰å¾…ã€å”¤é†’ï¼Œè·å–é”å¤±è´¥çš„é‡è¯•æœºåˆ¶</mark> <br/><mark class="hl-label green">è¶…æ—¶ç»­çº¦ï¼šåˆ©ç”¨watchDogï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆreleaseTime/3ï¼‰ï¼Œé‡ç½®è¶…æ—¶æ—¶é—´</mark> <img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230610113051979.png" alt="image-20230610113051979" style="zoom:67%;" /><div class="tabs" id="89bedab8-920c-414a-8e85-5ebf98ba1f65"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#89bedab8-920c-414a-8e85-5ebf98ba1f65-1"><i class="fas fa-bug"></i>å‚æ•°</button></li><li class="tab"><button type="button" data-href="#89bedab8-920c-414a-8e85-5ebf98ba1f65-2"><i class="fas fa-cannabis"></i>tryLock</button></li><li class="tab"><button type="button" data-href="#89bedab8-920c-414a-8e85-5ebf98ba1f65-3"><i class="fas fa-candy-cane"></i>ç¬¬ä¸€æ¬¡å°è¯•è·å–é”</button></li><li class="tab"><button type="button" data-href="#89bedab8-920c-414a-8e85-5ebf98ba1f65-4"><i class="fas fa-child"></i>è®¢é˜…é”é‡Šæ”¾ä¿¡å·</button></li><li class="tab"><button type="button" data-href="#89bedab8-920c-414a-8e85-5ebf98ba1f65-5"><i class="fas fa-cookie-bite"></i>å¾ªç¯å†æ¬¡å°è¯•</button></li><li class="tab"><button type="button" data-href="#89bedab8-920c-414a-8e85-5ebf98ba1f65-6"><i class="fas fa-heartbeat"></i>é‡Šæ”¾é”</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="89bedab8-920c-414a-8e85-5ebf98ba1f65-1"><p><code>tryLock</code>æ–¹æ³•æœ‰ä¸‰ä¸ªé‡è½½å½¢å¼ã€‚</p><p><code>tryLock()</code> waiteTimeé»˜è®¤ä¸º-1ï¼ŒleaseTimeé»˜è®¤ä¸º30s</p><p><code>tryLock(long waitTime, TimeUnit unit)</code> leaseTimeé»˜è®¤ä¸º30s</p><p><code>tryLock(long waitTime, long leaseTime, TimeUnit unit)</code></p><p>waitTimeï¼šè·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é•¿ï¼Œåœ¨ç¬¬ä¸€æ¬¡è·å–é”å¤±è´¥æ—¶å°±ä¸ä¼šç«‹å³è¿”å›ï¼Œè€Œæ˜¯åœ¨ç­‰å¾…æ—¶é—´å†…ä¸æ–­å»å°è¯•ã€‚</p><p>leaseTimeï¼šè‡ªåŠ¨å¤±æ•ˆé‡Šæ”¾æ—¶é—´</p><p>æˆ‘ä»¬åœ¨è¿™é‡Œè¦ç ”ç©¶é”é‡è¯•æœºåˆ¶ï¼Œæ‰€ä»¥waitTimeå¿…é¡»å¾—ä¼ ï¼ŒleaseTimeä¸ä¼ ä¹Ÿä¼šç»™é»˜è®¤å‚æ•°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RLock</span> <span class="variable">redisLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;order:&quot;</span> + <span class="number">1010</span>);</span><br><span class="line"><span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> redisLock.tryLock(<span class="number">1L</span>,TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line"><span class="comment">//RedissonLock#tryLock</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> waitTime, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">   <span class="keyword">return</span> tryLock(waitTime, -<span class="number">1</span>, unit);<span class="comment">//-&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="89bedab8-920c-414a-8e85-5ebf98ba1f65-2"><p>æ³¨æ„ä¸‹é¢çš„æ‰€æœ‰æ–¹æ³•éƒ½åœ¨æˆ‘ä»¬è·å–çš„é”ä¸­ã€‚</p><p><code>RLock redisLock = redissonClient.getLock(&quot;order:&quot; + 1010);</code></p><p>å°†tryLockå†…éƒ¨ä»£ç è¿›è¡Œç»†åˆ†å¯åˆ†ä¸ºä¸‹é¢è¿™äº›æ­¥éª¤</p><p>1ã€ <code>tryAcquire</code>å°è¯•ç¬¬ä¸€æ¬¡è·å–é”ï¼Œè¿”å›<code>ttl</code>ã€‚<code>ttl</code>ä¸º<code>null</code>åˆ™è·å–é”æˆåŠŸè¿”å›<code>true</code>ï¼›å¦åˆ™çœ‹è·å–é”æ˜¯å¦è¶…æ—¶ï¼Œè¶…æ—¶åˆ™è·å–é”å¤±è´¥è¿”å›<code>false</code>ï¼Œæœªè¶…æ—¶ç»§ç»­</p><p>3ã€ <code>subscribe</code>è®¢é˜…é”é‡Šæ”¾ä¿¡å·</p><p>4ã€å¾ªç¯<code>tryAcquire</code>å°è¯•è·å–é”ï¼Œ<code>semaphore</code>é˜»å¡ç­‰å¾…é”é‡Šæ”¾ä¿¡å·ã€‚é”è¶…æ—¶æ—¶é—´ &lt; ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼Œåˆ™é˜»å¡æ—¶é—´ä¸ºé”è¶…æ—¶æ—¶é—´ ï¼›å¦åˆ™ä¸ºç­‰å¾…è¶…æ—¶æ—¶é—´ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="89bedab8-920c-414a-8e85-5ebf98ba1f65-3"><div class="tabs" id="b73af6f0-6d79-4089-9b56-1f41afd1c947"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#b73af6f0-6d79-4089-9b56-1f41afd1c947-1"><i class="fas fa-award"></i>tryLock</button></li><li class="tab"><button type="button" data-href="#b73af6f0-6d79-4089-9b56-1f41afd1c947-2"><i class="fas fa-baseball-ball"></i>tryAcquire</button></li><li class="tab"><button type="button" data-href="#b73af6f0-6d79-4089-9b56-1f41afd1c947-3"><i class="fas fa-bone"></i>tryLockInnerAsyncæ‰§è¡ŒåŠ é”luaè„šæœ¬</button></li><li class="tab"><button type="button" data-href="#b73af6f0-6d79-4089-9b56-1f41afd1c947-4"><i class="fas fa-anchor"></i>scheduleExpirationRenewalé”ç»­çº¦</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="b73af6f0-6d79-4089-9b56-1f41afd1c947-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è½¬æ¢æˆæ¯«ç§’</span></span><br><span class="line"><span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> unit.toMillis(waitTime);</span><br><span class="line"><span class="type">long</span> <span class="variable">current</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"><span class="comment">//è·å–çº¿ç¨‹æ ‡è¯†</span></span><br><span class="line"><span class="type">long</span> <span class="variable">threadId</span> <span class="operator">=</span> Thread.currentThread().getId();</span><br><span class="line"><span class="comment">// å°è¯•è·å–é”ï¼Œè‹¥è¿”å›å€¼ä¸ºnullï¼Œåˆ™è¡¨ç¤ºå·²è·å–åˆ°é” -&gt;</span></span><br><span class="line"><span class="type">Long</span> <span class="variable">ttl</span> <span class="operator">=</span> tryAcquire(waitTime, leaseTime, unit, threadId);</span><br><span class="line"><span class="comment">// lock acquired</span></span><br><span class="line"><span class="keyword">if</span> (ttl == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æœ€å¤§ç­‰å¾…æ—¶é—´-è·å–é”æ¶ˆè€—çš„æ—¶é—´</span></span><br><span class="line">time -= System.currentTimeMillis() - current;</span><br><span class="line"><span class="comment">// å‰©ä½™ç­‰å¾…æ—¶é—´å°äº0 è¿”å›</span></span><br><span class="line"><span class="keyword">if</span> (time &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    acquireFailed(waitTime, unit, threadId);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç»§ç»­å°è¯• -&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b73af6f0-6d79-4089-9b56-1f41afd1c947-2"><p>leaseTime å¿…é¡»æ˜¯ -1 æ‰ä¼šå¼€å¯ Watch Dog æœºåˆ¶ï¼Œå¦‚æœéœ€è¦å¼€å¯ Watch Dog æœºåˆ¶å°±å¿…é¡»ä½¿ç”¨é»˜è®¤çš„åŠ é”æ—¶é—´ä¸º 30sã€‚</p><p>å¦‚æœä½ è‡ªå·±è‡ªå®šä¹‰æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œé”å°±ä¼šè‡ªå®šé‡Šæ”¾ï¼Œå¹¶ä¸ä¼šè‡ªåŠ¨ç»­æœŸã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Long <span class="title function_">tryAcquire</span><span class="params">(<span class="type">long</span> waitTime, <span class="type">long</span> leaseTime, TimeUnit unit, <span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> get(tryAcquireAsync(waitTime, leaseTime, unit, threadId));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; RFuture&lt;Long&gt; <span class="title function_">tryAcquireAsync</span><span class="params">(<span class="type">long</span> waitTime, <span class="type">long</span> leaseTime, TimeUnit unit, <span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœä¼ äº†leaseTimeåˆ™æŒ‰ä¼ å…¥çš„</span></span><br><span class="line">    <span class="keyword">if</span> (leaseTime != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> tryLockInnerAsync(waitTime, leaseTime, unit, threadId, RedisCommands.EVAL_LONG);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰ä¼ leaseTimeï¼Œåˆ™è·å–é…ç½®ä¸­çš„ï¼Œé»˜è®¤ä¸º30s -&gt;</span></span><br><span class="line">    RFuture&lt;Long&gt; ttlRemainingFuture = tryLockInnerAsync(waitTime,</span><br><span class="line">            commandExecutor.getConnectionManager().getCfg().getLockWatchdogTimeout(),</span><br><span class="line">            TimeUnit.MILLISECONDS, threadId, RedisCommands.EVAL_LONG);</span><br><span class="line">    <span class="comment">// Futureå®Œæˆä¹‹åè¿›å…¥è¿™ä¸ªå‡½æ•° </span></span><br><span class="line">    ttlRemainingFuture.onComplete((ttlRemaining, e) -&gt; &#123;</span><br><span class="line">        <span class="comment">// å¼‚å¸¸ä¸ä¸ºNull è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// lock acquired</span></span><br><span class="line">        <span class="keyword">if</span> (ttlRemaining == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¼€å¯çœ‹é—¨ç‹—</span></span><br><span class="line">            scheduleExpirationRenewal(threadId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> ttlRemainingFuture;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b73af6f0-6d79-4089-9b56-1f41afd1c947-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;T&gt; RFuture&lt;T&gt; <span class="title function_">tryLockInnerAsync</span><span class="params">(<span class="type">long</span> waitTime, <span class="type">long</span> leaseTime, TimeUnit unit, <span class="type">long</span> threadId, RedisStrictCommand&lt;T&gt; command)</span> &#123;</span><br><span class="line">        <span class="comment">// å°†leaseTimeè®°å½•åˆ°æˆå‘˜å˜é‡ ä¸‹é¢ç»­çº¦ä¼šç”¨åˆ°</span></span><br><span class="line">        internalLockLeaseTime = unit.toMillis(leaseTime);</span><br><span class="line">        <span class="comment">// æ³¨æ„è·å–é”æˆåŠŸè¿”å›nil å¤±è´¥è¿”å›é”çš„å‰©ä½™æœ‰æ•ˆæœŸ</span></span><br><span class="line">        <span class="keyword">return</span> evalWriteAsync(getName(), LongCodec.INSTANCE, command,</span><br><span class="line">                <span class="string">&quot;if (redis.call(&#x27;exists&#x27;, KEYS[1]) == 0) then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[2], 1); &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return nil; &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[2]) == 1) then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[2], 1); &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return nil; &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return redis.call(&#x27;pttl&#x27;, KEYS[1]);&quot;</span>,</span><br><span class="line">                Collections.singletonList(getName()), internalLockLeaseTime, getLockName(threadId));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b73af6f0-6d79-4089-9b56-1f41afd1c947-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">scheduleExpirationRenewal</span><span class="params">(<span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">    <span class="type">ExpirationEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExpirationEntry</span>();</span><br><span class="line">    <span class="comment">// getEntryName() è¿”å› è¿æ¥å+:+é”å </span></span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ¬¡æ”¾ é‡Œé¢è‚¯å®šæ²¡æœ‰ è¿”å›Null ä¿è¯åŒä¸€ä¸ªé”ä¸ç®¡é‡å…¥å¤šå°‘æ¬¡è·å¾—çš„éƒ½æ˜¯åŒä¸€ä¸ªEntry</span></span><br><span class="line">    <span class="type">ExpirationEntry</span> <span class="variable">oldEntry</span> <span class="operator">=</span> EXPIRATION_RENEWAL_MAP.putIfAbsent(getEntryName(), entry);</span><br><span class="line">    <span class="keyword">if</span> (oldEntry != <span class="literal">null</span>) &#123;</span><br><span class="line">        oldEntry.addThreadId(threadId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        entry.addThreadId(threadId);</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€æ¬¡æ¥ åšä¸€ä¸ªç»­çº¦çš„åŠ¨ä½œ</span></span><br><span class="line">        renewExpiration();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">renewExpiration</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ä»mapé‡Œè·å¾—Entry</span></span><br><span class="line">    <span class="type">ExpirationEntry</span> <span class="variable">ee</span> <span class="operator">=</span> EXPIRATION_RENEWAL_MAP.get(getEntryName());</span><br><span class="line">    <span class="keyword">if</span> (ee == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Timeoutæ˜¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ æ¯è¿‡internalLockLeaseTime/3 æ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">    <span class="type">Timeout</span> <span class="variable">task</span> <span class="operator">=</span> commandExecutor.getConnectionManager().newTimeout(<span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(Timeout timeout)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="comment">// ä»mapé‡Œè·å¾—Entry</span></span><br><span class="line">            <span class="type">ExpirationEntry</span> <span class="variable">ent</span> <span class="operator">=</span> EXPIRATION_RENEWAL_MAP.get(getEntryName());</span><br><span class="line">            <span class="keyword">if</span> (ent == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">threadId</span> <span class="operator">=</span> ent.getFirstThreadId();</span><br><span class="line">            <span class="keyword">if</span> (threadId == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åˆ·æ–°æœ‰æ•ˆæœŸ</span></span><br><span class="line">            RFuture&lt;Boolean&gt; future = renewExpirationAsync(threadId);</span><br><span class="line">            <span class="comment">// ä¸Šé¢çš„futureæ‰§è¡Œç»“æŸå</span></span><br><span class="line">            future.onComplete((res, e) -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;Can&#x27;t update lock &quot;</span> + getName() + <span class="string">&quot; expiration&quot;</span>, e);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (res) &#123;</span><br><span class="line">                    <span class="comment">// é€’å½’è°ƒç”¨è‡ªå·±</span></span><br><span class="line">                    renewExpiration();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, internalLockLeaseTime / <span class="number">3</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    <span class="comment">// å°†ä»»åŠ¡æ”¾åˆ°entryä¸­</span></span><br><span class="line">    ee.setTimeout(task);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//é‡ç½®é”æœ‰æ•ˆæœŸ</span></span><br><span class="line"><span class="keyword">protected</span> RFuture&lt;Boolean&gt; <span class="title function_">renewExpirationAsync</span><span class="params">(<span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> evalWriteAsync(getName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN,</span><br><span class="line">            <span class="string">&quot;if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[2]) == 1) then &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return 1; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return 0;&quot;</span>,</span><br><span class="line">            Collections.singletonList(getName()),</span><br><span class="line">            internalLockLeaseTime, getLockName(threadId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="89bedab8-920c-414a-8e85-5ebf98ba1f65-4"><p>ä¸ä¼šç«‹å³å»å°è¯•ï¼Œåˆšåˆšè·å–é”å¤±è´¥ï¼Œç«‹å³å»é‡è¯•ï¼Œå¤§æ¦‚ç‡ä¹Ÿæ˜¯å¤±è´¥çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">current = System.currentTimeMillis();</span><br><span class="line"><span class="comment">// é˜…è§£é”æ¶ˆæ¯ï¼Œè§org.redisson.pubsub.LockPubSub#onMessage</span></span><br><span class="line">RFuture&lt;RedissonLockEntry&gt; subscribeFuture = subscribe(threadId);</span><br><span class="line"><span class="comment">// å½“this.awaitè¿”å›falseï¼Œè¯´æ˜ç­‰å¾…æ—¶é—´å·²ç»è¶…å‡ºè·å–é”æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œ</span></span><br><span class="line"><span class="keyword">if</span> (!subscribeFuture.await(time, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!subscribeFuture.cancel(<span class="literal">false</span>)) &#123;</span><br><span class="line">        subscribeFuture.onComplete((res, e) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (e == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// å–æ¶ˆè®¢é˜…å¹¶è¿”å›è·å–é”å¤±è´¥</span></span><br><span class="line">                unsubscribe(subscribeFuture, threadId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    acquireFailed(waitTime, unit, threadId);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// this.awaitè¿”å›trueï¼Œåœ¨timeä»¥å†…ç­‰åˆ°äº†é‡Šæ”¾é”çš„é€šçŸ¥,è¿›å…¥å¾ªç¯å°è¯•è·å–é”</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="89bedab8-920c-414a-8e85-5ebf98ba1f65-5"><p>å½“é”æ­£åœ¨è¢«å ç”¨æ—¶ï¼Œç­‰å¾…è·å–é”çš„è¿›ç¨‹å¹¶ä¸æ˜¯é€šè¿‡ä¸€ä¸ª while(true) æ­»å¾ªç¯å»è·å–é”ï¼Œè€Œæ˜¯åˆ©ç”¨äº† Redis çš„å‘å¸ƒè®¢é˜…æœºåˆ¶,é€šè¿‡ await æ–¹æ³•é˜»å¡ç­‰å¾…é”çš„è¿›ç¨‹ï¼Œæœ‰æ•ˆçš„è§£å†³äº†æ— æ•ˆçš„é”ç”³è¯·æµªè´¹èµ„æºçš„é—®é¢˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// å†æ¬¡è®¡ç®—å‰©ä½™ç­‰å¾…æ—¶é—´</span></span><br><span class="line">    time -= System.currentTimeMillis() - current;</span><br><span class="line">    <span class="keyword">if</span> (time &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        acquireFailed(waitTime, unit, threadId);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// å†æ¬¡é‡è¯•è·å–é” é€»è¾‘ä¸ç¬¬ä¸€æ¬¡ç›¸åŒ</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        ttl = tryAcquire(waitTime, leaseTime, unit, threadId);</span><br><span class="line">        <span class="comment">// lock acquired</span></span><br><span class="line">        <span class="keyword">if</span> (ttl == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        time -= System.currentTimeMillis() - currentTime;</span><br><span class="line">        <span class="keyword">if</span> (time &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            acquireFailed(waitTime, unit, threadId);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// waiting for message</span></span><br><span class="line">        currentTime = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//æ ¹æ®é”TTLï¼Œè°ƒæ•´é˜»å¡ç­‰å¾…æ—¶é•¿ï¼›</span></span><br><span class="line">        <span class="keyword">if</span> (ttl &gt;= <span class="number">0</span> &amp;&amp; ttl &lt; time) &#123;</span><br><span class="line">            <span class="comment">// åˆ©ç”¨åˆšåˆšè®¢é˜…ç”Ÿæˆçš„futureç”Ÿæˆä¿¡å·é‡ä¿¡å·é‡Semaphore</span></span><br><span class="line">            <span class="comment">//è°ƒç”¨å…¶tryAcquireæ–¹æ³•ä¼šè®©å½“å‰çº¿ç¨‹é˜»å¡ä¸€æ®µæ—¶é—´ï¼Œé¿å…äº†åœ¨whileå¾ªç¯ä¸­é¢‘ç¹è¯·æ±‚è·å–é”ï¼›</span></span><br><span class="line">            <span class="comment">//è¯¥Semaphoreçš„releaseæ–¹æ³•ï¼Œä¼šåœ¨è®¢é˜…è§£é”æ¶ˆæ¯çš„ç›‘å¬å™¨æ¶ˆæ¯å¤„ç†æ–¹æ³•org.redisson.pubsub.LockPubSub#onMessageè°ƒç”¨ï¼›</span></span><br><span class="line">            <span class="comment">//å½“å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†å ç”¨çš„é”ï¼Œä¼šå¹¿æ’­è§£é”æ¶ˆæ¯ï¼Œç›‘å¬å™¨æ¥æ”¶è§£é”æ¶ˆæ¯ï¼Œå¹¶é‡Šæ”¾ä¿¡å·é‡ï¼Œæœ€ç»ˆä¼šå”¤é†’é˜»å¡åœ¨è¿™é‡Œçš„çº¿ç¨‹ã€‚</span></span><br><span class="line">            subscribeFuture.getNow().getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            subscribeFuture.getNow().getLatch().tryAcquire(time, TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        time -= System.currentTimeMillis() - currentTime;</span><br><span class="line">        <span class="keyword">if</span> (time &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            acquireFailed(waitTime, unit, threadId);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">//å–æ¶ˆè§£é”æ¶ˆæ¯çš„è®¢é˜…</span></span><br><span class="line">    unsubscribe(subscribeFuture, threadId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="89bedab8-920c-414a-8e85-5ebf98ba1f65-6"><div class="tabs" id="97f2d8d9-dd2f-4030-9c26-0b35173589cd"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#97f2d8d9-dd2f-4030-9c26-0b35173589cd-1"><i class="fas fa-seedling"></i>unlockAsync</button></li><li class="tab"><button type="button" data-href="#97f2d8d9-dd2f-4030-9c26-0b35173589cd-2"><i class="fas fa-leaf"></i>unlockInnerAsyncæ‰§è¡Œé‡Šæ”¾é”luaè„šæœ¬</button></li><li class="tab"><button type="button" data-href="#97f2d8d9-dd2f-4030-9c26-0b35173589cd-3"><i class="fab fa-apple"></i>å–æ¶ˆçœ‹é—¨ç‹—</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="97f2d8d9-dd2f-4030-9c26-0b35173589cd-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RFuture&lt;Void&gt; <span class="title function_">unlockAsync</span><span class="params">(<span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">    RPromise&lt;Void&gt; result = <span class="keyword">new</span> <span class="title class_">RedissonPromise</span>&lt;Void&gt;();</span><br><span class="line">    <span class="comment">// æ‰§è¡Œé‡Šæ”¾é”luaè„šæœ¬</span></span><br><span class="line">    RFuture&lt;Boolean&gt; future = unlockInnerAsync(threadId);</span><br><span class="line">    <span class="comment">// ç­‰å¾…ä¸Šé¢çš„futureå®Œæˆå</span></span><br><span class="line">    future.onComplete((opStatus, e) -&gt; &#123;</span><br><span class="line">        <span class="comment">// å–æ¶ˆæ›´æ–°ä»»åŠ¡</span></span><br><span class="line">        cancelExpirationRenewal(threadId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            result.tryFailure(e);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (opStatus == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">IllegalMonitorStateException</span> <span class="variable">cause</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>(<span class="string">&quot;attempt to unlock lock, not locked by current thread by node id: &quot;</span></span><br><span class="line">                    + id + <span class="string">&quot; thread-id: &quot;</span> + threadId);</span><br><span class="line">            result.tryFailure(cause);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        result.trySuccess(<span class="literal">null</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="97f2d8d9-dd2f-4030-9c26-0b35173589cd-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> RFuture&lt;Boolean&gt; <span class="title function_">unlockInnerAsync</span><span class="params">(<span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> evalWriteAsync(getName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN,</span><br><span class="line">            <span class="string">&quot;if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[3]) == 0) then &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return nil;&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;local counter = redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[3], -1); &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;if (counter &gt; 0) then &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[2]); &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return 0; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;redis.call(&#x27;del&#x27;, KEYS[1]); &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;redis.call(&#x27;publish&#x27;, KEYS[2], ARGV[1]); &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return 1; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return nil;&quot;</span>,</span><br><span class="line">            Arrays.asList(getName(), getChannelName()), LockPubSub.UNLOCK_MESSAGE, internalLockLeaseTime, getLockName(threadId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="97f2d8d9-dd2f-4030-9c26-0b35173589cd-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">cancelExpirationRenewal</span><span class="params">(Long threadId)</span> &#123;</span><br><span class="line">    <span class="comment">// ä»mapé‡Œå–</span></span><br><span class="line">    <span class="type">ExpirationEntry</span> <span class="variable">task</span> <span class="operator">=</span> EXPIRATION_RENEWAL_MAP.get(getEntryName());</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç§»é™¤id</span></span><br><span class="line">    <span class="keyword">if</span> (threadId != <span class="literal">null</span>) &#123;</span><br><span class="line">        task.removeThreadId(threadId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å–æ¶ˆå®šæ—¶ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">if</span> (threadId == <span class="literal">null</span> || task.hasNoThreads()) &#123;</span><br><span class="line">        <span class="type">Timeout</span> <span class="variable">timeout</span> <span class="operator">=</span> task.getTimeout();</span><br><span class="line">        <span class="keyword">if</span> (timeout != <span class="literal">null</span>) &#123;</span><br><span class="line">            timeout.cancel();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// entryç§»é™¤</span></span><br><span class="line">        EXPIRATION_RENEWAL_MAP.remove(getEntryName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>ç»“åˆLuaè„šæœ¬å’Œæºç ï¼Œæ¨¡æ‹Ÿä¸‹å¤šä¸ªçº¿ç¨‹äº‰æŠ¢é”ä¼šæ˜¯æ€æ ·çš„æµç¨‹ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼Œæ¯”è¾ƒå…³é”®çš„ä¸‰å¤„å·²ç”¨çº¢è‰²å­—ä½“æ ‡æ³¨ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230609231717380.png" alt="image-20230609231717380" style="zoom:67%;" /><hr><h4 id="MutiLockåŸç†">MutiLockåŸç†</h4><div class="tabs" id="d29f6808-63d3-4753-9c5a-1049488b38c8"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d29f6808-63d3-4753-9c5a-1049488b38c8-1"><i class="fas fa-seedling"></i>ä¸»èŠ‚ç‚¹å®•æœº</button></li><li class="tab"><button type="button" data-href="#d29f6808-63d3-4753-9c5a-1049488b38c8-2"><i class="fas fa-leaf"></i>MutiLocké”</button></li><li class="tab"><button type="button" data-href="#d29f6808-63d3-4753-9c5a-1049488b38c8-3"><i class="fab fa-apple"></i>MutiLockåŠ é”åŸç†</button></li><li class="tab"><button type="button" data-href="#d29f6808-63d3-4753-9c5a-1049488b38c8-4"><i class="fas fa-tree"></i>MutiLockä½¿ç”¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d29f6808-63d3-4753-9c5a-1049488b38c8-1"><p>ä¸ºäº†æé«˜redisçš„å¯ç”¨æ€§ï¼Œæˆ‘ä»¬ä¼šæ­å»ºé›†ç¾¤æˆ–è€…ä¸»ä»ï¼Œç°åœ¨ä»¥ä¸»ä»ä¸ºä¾‹</p><p>æ­¤æ—¶æˆ‘ä»¬å»å†™å‘½ä»¤ï¼Œå†™åœ¨ä¸»æœºä¸Šï¼Œ ä¸»æœºä¼šå°†æ•°æ®åŒæ­¥ç»™ä»æœºï¼Œä½†æ˜¯å‡è®¾åœ¨ä¸»æœºè¿˜æ²¡æœ‰æ¥å¾—åŠæŠŠæ•°æ®å†™å…¥åˆ°ä»æœºå»çš„æ—¶å€™ï¼Œæ­¤æ—¶ä¸»æœºå®•æœºï¼Œå“¨å…µä¼šå‘ç°ä¸»æœºå®•æœºï¼Œå¹¶ä¸”é€‰ä¸¾ä¸€ä¸ªslaveå˜æˆmasterï¼Œè€Œæ­¤æ—¶æ–°çš„masterä¸­å®é™…ä¸Šå¹¶æ²¡æœ‰é”ä¿¡æ¯ï¼Œæ­¤æ—¶é”ä¿¡æ¯å°±å·²ç»ä¸¢æ‰äº†ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653553998403.png" alt="1653553998403" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d29f6808-63d3-4753-9c5a-1049488b38c8-2"><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œredissionæå‡ºæ¥äº†MutiLocké”ï¼Œä½¿ç”¨è¿™æŠŠé”å’±ä»¬å°±ä¸ä½¿ç”¨ä¸»ä»äº†ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„åœ°ä½éƒ½æ˜¯ä¸€æ ·çš„ï¼Œ è¿™æŠŠé”åŠ é”çš„é€»è¾‘éœ€è¦å†™å…¥åˆ°æ¯ä¸€ä¸ªä¸»ä¸›èŠ‚ç‚¹ä¸Šï¼Œåªæœ‰æ‰€æœ‰çš„æœåŠ¡å™¨éƒ½å†™å…¥æˆåŠŸï¼Œæ­¤æ—¶æ‰æ˜¯åŠ é”æˆåŠŸï¼Œå‡è®¾ç°åœ¨æŸä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œé‚£ä¹ˆä»–å»è·å¾—é”çš„æ—¶å€™ï¼Œåªè¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ‹¿ä¸åˆ°ï¼Œéƒ½ä¸èƒ½ç®—æ˜¯åŠ é”æˆåŠŸï¼Œå°±ä¿è¯äº†åŠ é”çš„å¯é æ€§ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653554055048.png" alt="1653554055048" style="zoom: 50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d29f6808-63d3-4753-9c5a-1049488b38c8-3"><p>é‚£ä¹ˆMutiLock åŠ é”åŸç†æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å½“æˆ‘ä»¬å»è®¾ç½®äº†å¤šä¸ªé”æ—¶ï¼Œredissionä¼šå°†å¤šä¸ªé”æ·»åŠ åˆ°ä¸€ä¸ªé›†åˆä¸­ï¼Œç„¶åç”¨whileå¾ªç¯å»ä¸åœå»å°è¯•æ‹¿é”ï¼Œä½†æ˜¯ä¼šæœ‰ä¸€ä¸ªæ€»å…±çš„åŠ é”æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´æ˜¯ç”¨éœ€è¦åŠ é”çš„ä¸ªæ•° * 1500ms ï¼Œå‡è®¾æœ‰3ä¸ªé”ï¼Œé‚£ä¹ˆæ—¶é—´å°±æ˜¯4500msï¼Œå‡è®¾åœ¨è¿™4500mså†…ï¼Œæ‰€æœ‰çš„é”éƒ½åŠ é”æˆåŠŸï¼Œ é‚£ä¹ˆæ­¤æ—¶æ‰ç®—æ˜¯åŠ é”æˆåŠŸï¼Œå¦‚æœåœ¨4500msæœ‰çº¿ç¨‹åŠ é”å¤±è´¥ï¼Œåˆ™ä¼šå†æ¬¡å»è¿›è¡Œé‡è¯•.</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653553093967.png" alt="1653553093967" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d29f6808-63d3-4753-9c5a-1049488b38c8-4"><div class="tabs" id="d7456afb-9c83-4e3e-bf27-18a45d1cbbe7"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d7456afb-9c83-4e3e-bf27-18a45d1cbbe7-1"><i class="fas fa-cat"></i>é…ç½®å¤šä¸ªredissonClient</button></li><li class="tab"><button type="button" data-href="#d7456afb-9c83-4e3e-bf27-18a45d1cbbe7-2"><i class="fas fa-horse"></i>ä½¿ç”¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d7456afb-9c83-4e3e-bf27-18a45d1cbbe7-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://8.130.68.59:6379&quot;</span>)</span><br><span class="line">                .setPassword(<span class="string">&quot;root123&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://8.130.68.59:6380&quot;</span>)</span><br><span class="line">                .setPassword(<span class="string">&quot;root123&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://8.130.68.59:6381&quot;</span>)</span><br><span class="line">                .setPassword(<span class="string">&quot;root123&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d7456afb-9c83-4e3e-bf27-18a45d1cbbe7-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient2;</span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient3;</span><br><span class="line"><span class="keyword">private</span> RLock lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@BeforeEach</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock1</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock2</span> <span class="operator">=</span> redissonClient2.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock3</span> <span class="operator">=</span> redissonClient3.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">    lock = redissonClient.getMultiLock(lock1, lock2, lock3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">method</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> lock.tryLock();</span><br><span class="line">    redissonClient.getMultiLock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="ç§’æ€ä¼˜åŒ–">ç§’æ€ä¼˜åŒ–</h2><h3 id="å¼‚æ­¥ç§’æ€æ€è·¯">å¼‚æ­¥ç§’æ€æ€è·¯</h3><p>æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹ä¸‹å•æµç¨‹</p><p>å½“ç”¨æˆ·å‘èµ·è¯·æ±‚ï¼Œæ­¤æ—¶ä¼šè¯·æ±‚nginxï¼Œnginxä¼šè®¿é—®åˆ°tomcatï¼Œè€Œtomcatä¸­çš„ç¨‹åºï¼Œä¼šè¿›è¡Œä¸²è¡Œæ“ä½œï¼Œåˆ†æˆå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤</p><p>1ã€æŸ¥è¯¢ä¼˜æƒ å·</p><p>2ã€åˆ¤æ–­ç§’æ€åº“å­˜æ˜¯å¦è¶³å¤Ÿ</p><p>3ã€æŸ¥è¯¢è®¢å•</p><p>4ã€æ ¡éªŒæ˜¯å¦æ˜¯ä¸€äººä¸€å•</p><p>5ã€æ‰£å‡åº“å­˜</p><p>6ã€åˆ›å»ºè®¢å•</p><p>åœ¨è¿™å…­æ­¥æ“ä½œä¸­ï¼Œåˆæœ‰å¾ˆå¤šæ“ä½œæ˜¯è¦å»æ“ä½œæ•°æ®åº“çš„ï¼Œè€Œä¸”è¿˜æ˜¯ä¸€ä¸ªçº¿ç¨‹ä¸²è¡Œæ‰§è¡Œï¼Œ è¿™æ ·å°±ä¼šå¯¼è‡´æˆ‘ä»¬çš„ç¨‹åºæ‰§è¡Œçš„å¾ˆæ…¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼‚æ­¥ç¨‹åºæ‰§è¡Œï¼Œé‚£ä¹ˆå¦‚ä½•åŠ é€Ÿå‘¢ï¼Ÿ</p><div class="tabs" id="4baba01a-1fd4-4d5b-b3bb-b19671e2bcae"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#4baba01a-1fd4-4d5b-b3bb-b19671e2bcae-1"><i class="fas fa-atom"></i>æ–¹æ¡ˆä¸€</button></li><li class="tab"><button type="button" data-href="#4baba01a-1fd4-4d5b-b3bb-b19671e2bcae-2"><i class="far fa-sun"></i>æ–¹æ¡ˆäºŒ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="4baba01a-1fd4-4d5b-b3bb-b19671e2bcae-1"><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¸å¯ä»¥ä½¿ç”¨å¼‚æ­¥ç¼–æ’æ¥åšï¼Œæˆ–è€…è¯´æˆ‘å¼€å¯Nå¤šçº¿ç¨‹ï¼ŒNå¤šä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒæŸ¥è¯¢ä¼˜æƒ å·ï¼Œä¸€ä¸ªæ‰§è¡Œåˆ¤æ–­æ‰£å‡åº“å­˜ï¼Œä¸€ä¸ªå»åˆ›å»ºè®¢å•ç­‰ç­‰ï¼Œç„¶åå†ç»Ÿä¸€åšè¿”å›ã€‚å¦‚æœä½ é‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œå¦‚æœè®¿é—®çš„äººå¾ˆå¤šï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¯èƒ½ä¸€ä¸‹å­å°±è¢«æ¶ˆè€—å®Œäº†ï¼Œè€Œä¸”ä½¿ç”¨ä¸Šè¿°æ–¹æ¡ˆï¼Œæœ€å¤§çš„ç‰¹ç‚¹åœ¨äºï¼Œä½ è§‰å¾—æ—¶æ•ˆæ€§ä¼šéå¸¸é‡è¦ï¼Œä½†æ˜¯ä½ æƒ³æƒ³æ˜¯å—ï¼Ÿå¹¶ä¸æ˜¯ï¼Œæ¯”å¦‚æˆ‘åªè¦ç¡®å®šä»–èƒ½åšè¿™ä»¶äº‹ï¼Œç„¶åæˆ‘åè¾¹æ…¢æ…¢åšå°±å¯ä»¥äº†ï¼Œæˆ‘å¹¶ä¸éœ€è¦ä»–ä¸€å£æ°”åšå®Œè¿™ä»¶äº‹ã€‚æ‰€ä»¥æˆ‘ä»¬åº”å½“é‡‡ç”¨ç±»ä¼¼æ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹å¼æ¥å®Œæˆæˆ‘ä»¬çš„éœ€æ±‚ï¼Œè€Œä¸æ˜¯ä½¿ç”¨çº¿ç¨‹æ± æˆ–è€…æ˜¯å¼‚æ­¥ç¼–æ’çš„æ–¹å¼æ¥å®Œæˆè¿™ä¸ªéœ€æ±‚ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653560986599.png" alt="1653560986599" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4baba01a-1fd4-4d5b-b3bb-b19671e2bcae-2"><p>æˆ‘ä»¬å°†è€—æ—¶æ¯”è¾ƒçŸ­çš„é€»è¾‘åˆ¤æ–­æ”¾å…¥åˆ°redisä¸­ï¼Œæ¯”å¦‚æ˜¯å¦åº“å­˜è¶³å¤Ÿï¼Œæ¯”å¦‚æ˜¯å¦ä¸€äººä¸€å•ï¼Œè¿™æ ·çš„æ“ä½œï¼Œåªè¦è¿™ç§é€»è¾‘å¯ä»¥å®Œæˆï¼Œå°±æ„å‘³ç€æˆ‘ä»¬æ˜¯ä¸€å®šå¯ä»¥ä¸‹å•å®Œæˆçš„ï¼Œæˆ‘ä»¬åªéœ€è¦è¿›è¡Œå¿«é€Ÿçš„é€»è¾‘åˆ¤æ–­ï¼Œæ ¹æœ¬å°±ä¸ç”¨ç­‰ä¸‹å•é€»è¾‘èµ°å®Œï¼Œæˆ‘ä»¬ç›´æ¥ç»™ç”¨æˆ·è¿”å›æˆåŠŸï¼Œ å†åœ¨åå°å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œåå°çº¿ç¨‹æ…¢æ…¢çš„å»æ‰§è¡Œqueueé‡Œè¾¹çš„æ¶ˆæ¯ï¼Œè¿™æ ·ç¨‹åºä¸å°±è¶…çº§å¿«äº†å—ï¼Ÿè€Œä¸”ä¹Ÿä¸ç”¨æ‹…å¿ƒçº¿ç¨‹æ± æ¶ˆè€—æ®†å°½çš„é—®é¢˜ï¼Œå› ä¸ºè¿™é‡Œæˆ‘ä»¬çš„ç¨‹åºä¸­å¹¶æ²¡æœ‰æ‰‹åŠ¨ä½¿ç”¨ä»»ä½•çº¿ç¨‹æ± ï¼Œå½“ç„¶è¿™é‡Œè¾¹æœ‰ä¸¤ä¸ªéš¾ç‚¹</p><p>ç¬¬ä¸€ä¸ªéš¾ç‚¹æ˜¯æˆ‘ä»¬æ€ä¹ˆåœ¨redisä¸­å»å¿«é€Ÿæ ¡éªŒä¸€äººä¸€å•ï¼Œè¿˜æœ‰åº“å­˜åˆ¤æ–­</p><p>ç¬¬äºŒä¸ªéš¾ç‚¹æ˜¯ç”±äºæˆ‘ä»¬æ ¡éªŒå’Œtomctä¸‹å•æ˜¯ä¸¤ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•çŸ¥é“åˆ°åº•å“ªä¸ªå•ä»–æœ€åæ˜¯å¦æˆåŠŸï¼Œæˆ–è€…æ˜¯ä¸‹å•å®Œæˆï¼Œä¸ºäº†å®Œæˆè¿™ä»¶äº‹æˆ‘ä»¬åœ¨redisæ“ä½œå®Œä¹‹åï¼Œæˆ‘ä»¬ä¼šå°†ä¸€äº›ä¿¡æ¯è¿”å›ç»™å‰ç«¯ï¼ŒåŒæ—¶ä¹Ÿä¼šæŠŠè¿™äº›ä¿¡æ¯ä¸¢åˆ°å¼‚æ­¥queueä¸­å»ï¼Œåç»­æ“ä½œä¸­ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªidæ¥æŸ¥è¯¢æˆ‘ä»¬tomcatä¸­çš„ä¸‹å•é€»è¾‘æ˜¯å¦å®Œæˆäº†ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653561657295.png" alt="1653561657295" style="zoom:67%;" /><p>æˆ‘ä»¬ç°åœ¨æ¥çœ‹çœ‹æ•´ä½“æ€è·¯ï¼šå½“ç”¨æˆ·ä¸‹å•ä¹‹åï¼Œåˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³åªéœ€è¦å¯¼redisä¸­å»æ ¹æ®keyæ‰¾å¯¹åº”çš„valueæ˜¯å¦å¤§äº0å³å¯ï¼Œå¦‚æœä¸å……è¶³ï¼Œåˆ™ç›´æ¥ç»“æŸï¼Œå¦‚æœå……è¶³ï¼Œç»§ç»­åœ¨redisä¸­åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å¯ä»¥ä¸‹å•ï¼Œå¦‚æœseté›†åˆä¸­æ²¡æœ‰è¿™æ¡æ•°æ®ï¼Œè¯´æ˜ä»–å¯ä»¥ä¸‹å•ï¼Œå¦‚æœseté›†åˆä¸­æ²¡æœ‰è¿™æ¡è®°å½•ï¼Œåˆ™å°†userIdå’Œä¼˜æƒ å·å­˜å…¥åˆ°redisä¸­ï¼Œå¹¶ä¸”è¿”å›0ï¼Œæ•´ä¸ªè¿‡ç¨‹éœ€è¦ä¿è¯æ˜¯åŸå­æ€§çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨luaæ¥æ“ä½œ</p><p>å½“ä»¥ä¸Šåˆ¤æ–­é€»è¾‘èµ°å®Œä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­å½“å‰redisä¸­è¿”å›çš„ç»“æœæ˜¯å¦æ˜¯0 ï¼Œå¦‚æœæ˜¯0ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥ä¸‹å•ï¼Œåˆ™å°†ä¹‹å‰è¯´çš„ä¿¡æ¯å­˜å…¥åˆ°åˆ°queueä¸­å»ï¼Œç„¶åè¿”å›ï¼Œç„¶åå†æ¥ä¸ªçº¿ç¨‹å¼‚æ­¥çš„ä¸‹å•ï¼Œå‰ç«¯å¯ä»¥é€šè¿‡è¿”å›çš„è®¢å•idæ¥åˆ¤æ–­æ˜¯å¦ä¸‹å•æˆåŠŸã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653562234886.png" alt="1653562234886" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="ç§’æ€èµ„æ ¼åˆ¤æ–­">ç§’æ€èµ„æ ¼åˆ¤æ–­</h3><p>éœ€æ±‚ï¼š</p><ul><li><p>æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œå°†ä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</p></li><li><p>åŸºäºLuaè„šæœ¬ï¼Œåˆ¤æ–­ç§’æ€åº“å­˜ã€ä¸€äººä¸€å•ï¼Œå†³å®šç”¨æˆ·æ˜¯å¦æŠ¢è´­æˆåŠŸ</p></li><li><p>å¦‚æœæŠ¢è´­æˆåŠŸï¼Œå°†ä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idå°è£…åå­˜å…¥é˜»å¡é˜Ÿåˆ—</p></li><li><p>å¼€å¯çº¿ç¨‹ä»»åŠ¡ï¼Œä¸æ–­ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå®ç°å¼‚æ­¥ä¸‹å•åŠŸèƒ½</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1656080546603.png" alt="1656080546603"></p></li></ul><div class="tabs" id="601d3706-08b9-4770-8325-8be09a054135"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#601d3706-08b9-4770-8325-8be09a054135-1"><i class="fas fa-atom"></i>æ·»åŠ ä¼˜æƒ åˆ¸</button></li><li class="tab"><button type="button" data-href="#601d3706-08b9-4770-8325-8be09a054135-2"><i class="far fa-sun"></i>luaè„šæœ¬</button></li><li class="tab"><button type="button" data-href="#601d3706-08b9-4770-8325-8be09a054135-3"><i class="fas fa-wind"></i>ç§’æ€é€»è¾‘</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="601d3706-08b9-4770-8325-8be09a054135-1"><p><mark class="hl-label blue">VoucherServiceImpl</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜ä¼˜æƒ åˆ¸</span></span><br><span class="line">    save(voucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€ä¿¡æ¯</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">    seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">    seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">    seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">    seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">    seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€åº“å­˜åˆ°Redisä¸­</span></span><br><span class="line">    <span class="comment">//SECKILL_STOCK_KEY è¿™ä¸ªå˜é‡å®šä¹‰åœ¨RedisConstansä¸­</span></span><br><span class="line">    <span class="comment">//private static final String SECKILL_STOCK_KEY =&quot;seckill:stock:&quot;</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="601d3706-08b9-4770-8325-8be09a054135-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">-- <span class="number">1.</span>å‚æ•°åˆ—è¡¨</span><br><span class="line">-- <span class="number">1.1</span>.ä¼˜æƒ åˆ¸id</span><br><span class="line"><span class="type">local</span> <span class="variable">voucherId</span> <span class="operator">=</span> ARGV[<span class="number">1</span>]</span><br><span class="line">-- <span class="number">1.2</span>.ç”¨æˆ·id</span><br><span class="line"><span class="type">local</span> <span class="variable">userId</span> <span class="operator">=</span> ARGV[<span class="number">2</span>]</span><br><span class="line">-- <span class="number">1.3</span>.è®¢å•id</span><br><span class="line"><span class="type">local</span> <span class="variable">orderId</span> <span class="operator">=</span> ARGV[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">-- <span class="number">2.</span>æ•°æ®key</span><br><span class="line">-- <span class="number">2.1</span>.åº“å­˜key</span><br><span class="line"><span class="type">local</span> <span class="variable">stockKey</span> <span class="operator">=</span> <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId</span><br><span class="line">-- <span class="number">2.2</span>.è®¢å•key</span><br><span class="line"><span class="type">local</span> <span class="variable">orderKey</span> <span class="operator">=</span> <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId</span><br><span class="line"></span><br><span class="line">-- <span class="number">3.</span>è„šæœ¬ä¸šåŠ¡</span><br><span class="line">-- <span class="number">3.1</span>.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ get stockKey</span><br><span class="line"><span class="title function_">if</span><span class="params">(tonumber(redis.call(<span class="string">&#x27;get&#x27;</span>, stockKey)</span>) &lt;= <span class="number">0</span>) then</span><br><span class="line">    -- <span class="number">3.2</span>.åº“å­˜ä¸è¶³ï¼Œè¿”å›<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">end</span><br><span class="line">-- <span class="number">3.2</span>.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å• SISMEMBER orderKey userId</span><br><span class="line"><span class="title function_">if</span><span class="params">(redis.call(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId)</span> == <span class="number">1</span>) then</span><br><span class="line">    -- <span class="number">3.3</span>.å­˜åœ¨ï¼Œè¯´æ˜æ˜¯é‡å¤ä¸‹å•ï¼Œè¿”å›<span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">end</span><br><span class="line">-- <span class="number">3.4</span>.æ‰£åº“å­˜ incrby stockKey -<span class="number">1</span></span><br><span class="line">redis.call(<span class="string">&#x27;incrby&#x27;</span>, stockKey, -<span class="number">1</span>)</span><br><span class="line">-- <span class="number">3.5</span>.ä¸‹å•ï¼ˆä¿å­˜ç”¨æˆ·ï¼‰sadd orderKey userId</span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="601d3706-08b9-4770-8325-8be09a054135-3"><p><mark class="hl-label green">VoucherOrderServiceImpl</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">//è·å–ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="comment">// 1.æ‰§è¡Œluaè„šæœ¬</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(</span><br><span class="line">            SECKILL_SCRIPT,</span><br><span class="line">            Collections.emptyList(),</span><br><span class="line">            voucherId.toString(), userId.toString(), String.valueOf(orderId)</span><br><span class="line">    );</span><br><span class="line">    <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> result.intValue();</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0</span></span><br><span class="line">    <span class="keyword">if</span> (r != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 2.1.ä¸ä¸º0 ï¼Œä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(r == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//TODO ä¿å­˜é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="comment">// 3.è¿”å›è®¢å•id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="Redisæ¶ˆæ¯é˜Ÿåˆ—">Redisæ¶ˆæ¯é˜Ÿåˆ—</h2><p>ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚æœ€ç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹åŒ…æ‹¬3ä¸ªè§’è‰²ï¼š</p><ul><li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­˜å‚¨å’Œç®¡ç†æ¶ˆæ¯ï¼Œä¹Ÿè¢«ç§°ä¸ºæ¶ˆæ¯ä»£ç†ï¼ˆMessage Brokerï¼‰</li><li>ç”Ÿäº§è€…ï¼šå‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—</li><li>æ¶ˆè´¹è€…ï¼šä»æ¶ˆæ¯é˜Ÿåˆ—è·å–æ¶ˆæ¯å¹¶å¤„ç†æ¶ˆæ¯</li></ul><p>ä½¿ç”¨é˜Ÿåˆ—çš„å¥½å¤„åœ¨äº **è§£è€¦ï¼š**æ‰€è°“è§£è€¦ï¼Œä¸¾ä¸€ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­å°±æ˜¯ï¼šå¿«é€’å‘˜(ç”Ÿäº§è€…)æŠŠå¿«é€’æ”¾åˆ°å¿«é€’æŸœé‡Œè¾¹(Message Queue)å»ï¼Œæˆ‘ä»¬(æ¶ˆè´¹è€…)ä»å¿«é€’æŸœé‡Œè¾¹å»æ‹¿ä¸œè¥¿ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå¼‚æ­¥ï¼Œå¦‚æœè€¦åˆï¼Œé‚£ä¹ˆè¿™ä¸ªå¿«é€’å‘˜ç›¸å½“äºç›´æ¥æŠŠå¿«é€’äº¤ç»™ä½ ï¼Œè¿™äº‹å›ºç„¶å¥½ï¼Œä½†æ˜¯ä¸‡ä¸€ä½ ä¸åœ¨å®¶ï¼Œé‚£ä¹ˆå¿«é€’å‘˜å°±ä¼šä¸€ç›´ç­‰ä½ ï¼Œè¿™å°±æµªè´¹äº†å¿«é€’å‘˜çš„æ—¶é—´ï¼Œæ‰€ä»¥è¿™ç§æ€æƒ³åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ï¼Œæ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚</p><p>è¿™ç§åœºæ™¯åœ¨æˆ‘ä»¬ç§’æ€ä¸­å°±å˜æˆäº†ï¼šæˆ‘ä»¬ä¸‹å•ä¹‹åï¼Œåˆ©ç”¨rediså»è¿›è¡Œæ ¡éªŒä¸‹å•æ¡ä»¶ï¼Œå†é€šè¿‡é˜Ÿåˆ—æŠŠæ¶ˆæ¯å‘é€å‡ºå»ï¼Œç„¶åå†å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»æ¶ˆè´¹è¿™ä¸ªæ¶ˆæ¯ï¼Œå®Œæˆè§£è€¦ï¼ŒåŒæ—¶ä¹ŸåŠ å¿«æˆ‘ä»¬çš„å“åº”é€Ÿåº¦ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›ç°æˆçš„mqï¼Œæ¯”å¦‚kafkaï¼Œrabbitmqç­‰ç­‰ï¼Œä½†æ˜¯å‘¢ï¼Œå¦‚æœæ²¡æœ‰å®‰è£…mqï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨redisæä¾›çš„mqæ–¹æ¡ˆï¼Œé™ä½æˆ‘ä»¬çš„éƒ¨ç½²å’Œå­¦ä¹ æˆæœ¬ã€‚</p><hr><h3 id="åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—">åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—</h3><p>æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰ï¼Œå­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚è€ŒRedisçš„listæ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¾ˆå®¹æ˜“æ¨¡æ‹Ÿå‡ºé˜Ÿåˆ—æ•ˆæœã€‚</p><p>é˜Ÿåˆ—æ˜¯å…¥å£å’Œå‡ºå£ä¸åœ¨ä¸€è¾¹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ï¼šLPUSH ç»“åˆ RPOPã€æˆ–è€… RPUSH ç»“åˆ LPOPæ¥å®ç°ã€‚<br>ä¸è¿‡è¦æ³¨æ„çš„æ˜¯ï¼Œå½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯æ—¶RPOPæˆ–LPOPæ“ä½œä¼šè¿”å›nullï¼Œå¹¶ä¸åƒJVMçš„é˜»å¡é˜Ÿåˆ—é‚£æ ·ä¼šé˜»å¡å¹¶ç­‰å¾…æ¶ˆæ¯ã€‚å› æ­¤è¿™é‡Œåº”è¯¥ä½¿ç”¨BRPOPæˆ–è€…BLPOPæ¥å®ç°é˜»å¡æ•ˆæœã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653575176451.png" alt="1653575176451"></p><p>åŸºäºListçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ<br>ä¼˜ç‚¹ï¼š</p><ul><li>åˆ©ç”¨Rediså­˜å‚¨ï¼Œä¸å—é™äºJVMå†…å­˜ä¸Šé™</li><li>åŸºäºRedisçš„æŒä¹…åŒ–æœºåˆ¶ï¼Œæ•°æ®å®‰å…¨æ€§æœ‰ä¿è¯</li><li>å¯ä»¥æ»¡è¶³æ¶ˆæ¯æœ‰åºæ€§</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±</li><li>åªæ”¯æŒå•æ¶ˆè´¹è€…</li></ul><hr><h3 id="åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—">åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—</h3><p>PubSubï¼ˆå‘å¸ƒè®¢é˜…ï¼‰æ˜¯Redis2.0ç‰ˆæœ¬å¼•å…¥çš„æ¶ˆæ¯ä¼ é€’æ¨¡å‹ã€‚é¡¾åæ€ä¹‰ï¼Œæ¶ˆè´¹è€…å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªchannelï¼Œç”Ÿäº§è€…å‘å¯¹åº”channelå‘é€æ¶ˆæ¯åï¼Œæ‰€æœ‰è®¢é˜…è€…éƒ½èƒ½æ”¶åˆ°ç›¸å…³æ¶ˆæ¯ã€‚</p><p>SUBSCRIBE channel [channel] ï¼šè®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“<br>PUBLISH channel msg ï¼šå‘ä¸€ä¸ªé¢‘é“å‘é€æ¶ˆæ¯<br>PSUBSCRIBE pattern[pattern] ï¼šè®¢é˜…ä¸patternæ ¼å¼åŒ¹é…çš„æ‰€æœ‰é¢‘é“</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653575506373.png" alt="1653575506373" style="zoom:67%;" /><p>åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ<br>ä¼˜ç‚¹ï¼š</p><ul><li>é‡‡ç”¨å‘å¸ƒè®¢é˜…æ¨¡å‹ï¼Œæ”¯æŒå¤šç”Ÿäº§ã€å¤šæ¶ˆè´¹</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>ä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–</li><li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±</li><li>æ¶ˆæ¯å †ç§¯æœ‰ä¸Šé™ï¼Œè¶…å‡ºæ—¶æ•°æ®ä¸¢å¤±</li></ul><hr><h3 id="åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—">åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—</h3><p>Stream æ˜¯ Redis 5.0 å¼•å…¥çš„ä¸€ç§æ–°æ•°æ®ç±»å‹ï¼Œå¯ä»¥å®ç°ä¸€ä¸ªåŠŸèƒ½éå¸¸å®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p><div class="tabs" id="4bf99a7f-851c-4e60-aa15-4aa143909861"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#4bf99a7f-851c-4e60-aa15-4aa143909861-1"><i class="fas fa-award"></i>å‘é€æ¶ˆæ¯</button></li><li class="tab"><button type="button" data-href="#4bf99a7f-851c-4e60-aa15-4aa143909861-2"><i class="fas fa-baseball-ball"></i>è¯»å–æ¶ˆæ¯</button></li><li class="tab"><button type="button" data-href="#4bf99a7f-851c-4e60-aa15-4aa143909861-3"><i class="fas fa-bone"></i>ä½¿ç”¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="4bf99a7f-851c-4e60-aa15-4aa143909861-1"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653577301737.png" alt="1653577301737"></p><p>ä¾‹å¦‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## åˆ›å»ºåä¸º users çš„é˜Ÿåˆ—ï¼Œå¹¶ä¸”å…¶ä¸­å‘é€ä¸€ä¸ªæ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š&#123;name=jack,age=21&#125;,å¹¶ä¸”ä½¿ç”¨Redisè‡ªåŠ¨ç”ŸæˆID</span></span><br><span class="line">127.0.0.1:6379&gt; XADD <span class="built_in">users</span> * name jack age 21</span><br><span class="line"><span class="string">&quot;1644805700523-0&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4bf99a7f-851c-4e60-aa15-4aa143909861-2"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653577445413.png" alt="1653577445413" style="zoom:67%;" /><p>ä¾‹å¦‚ï¼Œä½¿ç”¨XREADè¯»å–ç¬¬ä¸€ä¸ªæ¶ˆæ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; XREAD COUNT 1 STREAMS <span class="built_in">users</span> 0</span><br><span class="line">1) 1) <span class="string">&quot;users&quot;</span></span><br><span class="line">   2) 1) 1) <span class="string">&quot;1686396575325-0&quot;</span></span><br><span class="line">         2) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">            2) <span class="string">&quot;jack&quot;</span></span><br><span class="line">            3) <span class="string">&quot;age&quot;</span></span><br><span class="line">            4) 21</span><br></pre></td></tr></table></figure><p>XREADé˜»å¡æ–¹å¼ï¼Œè¯»å–æœ€æ–°çš„æ¶ˆæ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; XREAD COUNT 1 BLOCK 1000 STREAMS <span class="built_in">users</span> $</span><br><span class="line">(nil)</span><br><span class="line">(1.10s)</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4bf99a7f-851c-4e60-aa15-4aa143909861-3"><p>åœ¨ä¸šåŠ¡å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾ªç¯çš„è°ƒç”¨XREADé˜»å¡æ–¹å¼æ¥æŸ¥è¯¢æœ€æ–°æ¶ˆæ¯ï¼Œä»è€Œå®ç°æŒç»­ç›‘å¬é˜Ÿåˆ—çš„æ•ˆæœï¼Œä¼ªä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">    <span class="comment">// å°è¯•è¯»å–é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œæœ€å¤šé˜»å¡2ç§’</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.excute(<span class="string">&quot;XREAD COUNT 1 BLOCK 2000 STREAMS users $&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(msg == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">    handleMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šå½“æˆ‘ä»¬æŒ‡å®šèµ·å§‹IDä¸º$æ—¶ï¼Œä»£è¡¨è¯»å–æœ€æ–°çš„æ¶ˆæ¯ï¼Œå¦‚æœæˆ‘ä»¬å¤„ç†ä¸€æ¡æ¶ˆæ¯çš„è¿‡ç¨‹ä¸­ï¼Œåˆæœ‰è¶…è¿‡1æ¡ä»¥ä¸Šçš„æ¶ˆæ¯åˆ°è¾¾é˜Ÿåˆ—ï¼Œåˆ™ä¸‹æ¬¡è·å–æ—¶ä¹Ÿåªèƒ½è·å–åˆ°æœ€æ–°çš„ä¸€æ¡ï¼Œä¼šå‡ºç°æ¼è¯»æ¶ˆæ¯çš„é—®é¢˜</p><p>STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADå‘½ä»¤ç‰¹ç‚¹ï¼š</p><ul><li>æ¶ˆæ¯å¯å›æº¯</li><li>ä¸€ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…è¯»å–</li><li>å¯ä»¥é˜»å¡è¯»å–</li><li>æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <mark class="hl-label blue">æ¶ˆè´¹è€…ç»„</mark> <p>æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰ï¼šå°†å¤šä¸ªæ¶ˆè´¹è€…åˆ’åˆ†åˆ°ä¸€ä¸ªç»„ä¸­ï¼Œç›‘å¬åŒä¸€ä¸ªé˜Ÿåˆ—ã€‚å…·å¤‡ä¸‹åˆ—ç‰¹ç‚¹ï¼š</p><ul><li>æ¶ˆæ¯åˆ†æµ é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¼šåˆ†æµç»™ç»„å†…çš„ä¸åŒæ¶ˆè´¹è€…ï¼Œè€Œä¸æ˜¯é‡å¤æ¶ˆè´¹ï¼Œä»è€ŒåŠ å¿«æ¶ˆæ¯å¤„ç†çš„é€Ÿåº¦</li><li>æ¶ˆæ¯æ ‡ç¤º æ¶ˆè´¹è€…ç»„ä¼šç»´æŠ¤ä¸€ä¸ªæ ‡ç¤ºï¼Œ è®°å½•æœ€åä¸€ä¸ªè¢«å¤„ç†çš„æ¶ˆæ¯ï¼Œ å“ªæ€•æ¶ˆè´¹è€…å®•æœºé‡å¯ï¼Œè¿˜ä¼šä»æ ‡ç¤ºä¹‹åè¯»å–æ¶ˆæ¯ã€‚ç¡®ä¿æ¯ä¸€ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æ¶ˆè´¹</li><li>æ¶ˆæ¯ç¡®è®¤ æ¶ˆè´¹è€…è·å–æ¶ˆæ¯åï¼Œæ¶ˆæ¯å¤„äº pendingçŠ¶æ€ï¼Œäº•å­˜å…¥ä¸€ä¸ªpending-listã€‚å½“å¤„ç†å®Œæˆåéœ€è¦é€šè¿‡XACKæ¥ç¡®è®¤æ¶ˆæ¯ï¼Œæ ‡è®°æ¶ˆæ¯ä¸ºå·²å¤„ç†ï¼Œæ‰ä¼šä»pending-listç§»é™¤</li></ul><div class="tabs" id="75b87830-c6bf-4e70-bbf1-8cdb998001a2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#75b87830-c6bf-4e70-bbf1-8cdb998001a2-1"><i class="fas fa-cat"></i>åˆ›å»ºæ¶ˆè´¹è€…ç»„</button></li><li class="tab"><button type="button" data-href="#75b87830-c6bf-4e70-bbf1-8cdb998001a2-2"><i class="fas fa-horse"></i>åˆ é™¤æ¶ˆè´¹ç»„</button></li><li class="tab"><button type="button" data-href="#75b87830-c6bf-4e70-bbf1-8cdb998001a2-3"><i class="fas fa-dove"></i>æ·»åŠ æ¶ˆè´¹è€…</button></li><li class="tab"><button type="button" data-href="#75b87830-c6bf-4e70-bbf1-8cdb998001a2-4"><i class="fas fa-dragon"></i>åˆ é™¤æ¶ˆè´¹è€…</button></li><li class="tab"><button type="button" data-href="#75b87830-c6bf-4e70-bbf1-8cdb998001a2-5"><i class="fas fa-heartbeat"></i>ä»æ¶ˆè´¹è€…ç»„è¯»å–æ¶ˆæ¯</button></li><li class="tab"><button type="button" data-href="#75b87830-c6bf-4e70-bbf1-8cdb998001a2-6"><i class="fas fa-cookie-bite"></i>ä½¿ç”¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="75b87830-c6bf-4e70-bbf1-8cdb998001a2-1"><p><code>XGROUP CREATE key groupName ID [MKSTREAM]</code></p><p>keyï¼šé˜Ÿåˆ—åç§°<br>groupNameï¼šæ¶ˆè´¹è€…ç»„åç§°<br>IDï¼šèµ·å§‹IDæ ‡ç¤ºï¼Œ$ä»£è¡¨é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªæ¶ˆæ¯ï¼Œ0åˆ™ä»£è¡¨é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ¶ˆæ¯<br>MKSTREAMï¼šé˜Ÿåˆ—ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="75b87830-c6bf-4e70-bbf1-8cdb998001a2-2"><p><code>XGROUP DESTORY key groupName</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="75b87830-c6bf-4e70-bbf1-8cdb998001a2-3"><p><code>XGROUP CREATECONSUMER key groupname consumername</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="75b87830-c6bf-4e70-bbf1-8cdb998001a2-4"><p><code>XGROUP DELCONSUMER key groupname consumername</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="75b87830-c6bf-4e70-bbf1-8cdb998001a2-5"><p><code>XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key ...] ID [ID ...]</code></p><p>groupï¼šæ¶ˆè´¹ç»„åç§°</p><p>consumerï¼šæ¶ˆè´¹è€…åç§°ï¼Œå¦‚æœæ¶ˆè´¹è€…ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…</p><p>countï¼šæœ¬æ¬¡æŸ¥è¯¢çš„æœ€å¤§æ•°é‡</p><p>BLOCK millisecondsï¼šå½“æ²¡æœ‰æ¶ˆæ¯æ—¶æœ€é•¿ç­‰å¾…æ—¶é—´</p><p>NOACKï¼šæ— éœ€æ‰‹åŠ¨ACKï¼Œè·å–åˆ°æ¶ˆæ¯åè‡ªåŠ¨ç¡®è®¤</p><p>STREAMS keyï¼šæŒ‡å®šé˜Ÿåˆ—åç§°</p><p>IDï¼šè·å–æ¶ˆæ¯çš„èµ·å§‹ID</p><ul><li>â€œ&gt;â€ï¼šä»ä¸‹ä¸€ä¸ªæœªæ¶ˆè´¹çš„æ¶ˆæ¯å¼€å§‹</li><li>å…¶å®ƒï¼šæ ¹æ®æŒ‡å®šidä»pending-listä¸­è·å–å·²æ¶ˆè´¹ä½†æœªç¡®è®¤çš„æ¶ˆæ¯ï¼Œä¾‹å¦‚0ï¼Œæ˜¯ä»pending-listä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯å¼€å§‹ã€‚</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="75b87830-c6bf-4e70-bbf1-8cdb998001a2-6"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">    <span class="comment">// å°è¯•ç›‘å¬é˜Ÿåˆ—ï¼Œä½¿ç”¨é˜»å¡æ¨¡å¼ï¼Œæœ€å¤šç­‰å¾… 2000 æ¯«ç§’</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.call(<span class="string">&quot;XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 &gt;&quot;</span>);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ç»“æœ</span></span><br><span class="line">    <span class="keyword">if</span> (msg == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//æœ‰ç»“æœï¼Œåˆ™å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">        handleMessage(msg);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="comment">//å‡ºç°å¼‚å¸¸ï¼Œåˆ™æŸ¥è¯¢pending-list,ç»§ç»­å¤„ç†</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.call(<span class="string">&quot;XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 0&quot;</span>);</span><br><span class="line">            <span class="comment">// åˆ¤æ–­ç»“æœ</span></span><br><span class="line">            <span class="keyword">if</span> (msg == <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="comment">//æœ‰ç»“æœï¼Œåˆ™å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">                handleMessage(msg);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                <span class="comment">// å‡ºç°å¼‚å¸¸è®°å½•æ—¥å¿—å³å¯ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADGROUPå‘½ä»¤ç‰¹ç‚¹ï¼š</p><ul><li>æ¶ˆæ¯å¯å›æº¯</li><li>å¯ä»¥å¤šæ¶ˆè´¹è€…äº‰æŠ¢æ¶ˆæ¯ï¼ŒåŠ å¿«æ¶ˆè´¹é€Ÿåº¦</li><li>å¯ä»¥é˜»å¡è¯»å–</li><li>æ²¡æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©</li><li>æœ‰æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼Œä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡</li></ul><p>æœ€åæˆ‘ä»¬æ¥ä¸ªå°å¯¹æ¯”</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">List</th><th style="text-align:center">PubSub</th><th style="text-align:center">Stream</th></tr></thead><tbody><tr><td style="text-align:center">æ¶ˆæ¯æŒä¹…åŒ–</td><td style="text-align:center">æ”¯æŒ</td><td style="text-align:center">ä¸æ”¯æŒ</td><td style="text-align:center">æ”¯æŒ</td></tr><tr><td style="text-align:center">é˜»å¡è¯»å–</td><td style="text-align:center">æ”¯æŒ</td><td style="text-align:center">æ”¯æŒ</td><td style="text-align:center">æ”¯æŒ</td></tr><tr><td style="text-align:center">æ¶ˆæ¯å †ç§¯å¤„ç†</td><td style="text-align:center">é¦–å…ˆäºå†…å­˜ç©ºé—´ï¼Œkeyåˆ©ç”¨å¤šæ¶ˆè´¹è€…åŠ å¿«å¤„ç†</td><td style="text-align:center">å—é™äºæ¶ˆè´¹è€…ç¼“å†²åŒº</td><td style="text-align:center">å—é™äºé˜Ÿåˆ—é•¿åº¦ï¼Œå¯ä»¥åˆ©ç”¨æ¶ˆè´¹è€…ç»„æé«˜æ¶ˆè´¹é€Ÿåº¦ï¼Œå‡å°‘å †ç§¯</td></tr><tr><td style="text-align:center">æ¶ˆæ¯ç¡®è®¤æœºåˆ¶</td><td style="text-align:center">ä¸æ”¯æŒ</td><td style="text-align:center">ä¸æ”¯æŒ</td><td style="text-align:center">æ”¯æŒ</td></tr><tr><td style="text-align:center">æ¶ˆæ¯å›æº¯</td><td style="text-align:center">ä¸æ”¯æŒ</td><td style="text-align:center">ä¸æ”¯æŒ</td><td style="text-align:center">æ”¯æŒ</td></tr></tbody></table><hr><h3 id="Streamçš„æ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ä¸‹å•">Streamçš„æ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ä¸‹å•</h3><p>éœ€æ±‚ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªStreamç±»å‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåä¸ºstream.orders</li><li>ä¿®æ”¹ä¹‹å‰çš„ç§’æ€ä¸‹å•Luaè„šæœ¬ï¼Œåœ¨è®¤å®šæœ‰æŠ¢è´­èµ„æ ¼åï¼Œç›´æ¥å‘stream.ordersä¸­æ·»åŠ æ¶ˆæ¯ï¼Œå†…å®¹åŒ…å«voucherIdã€userIdã€orderId</li><li>é¡¹ç›®å¯åŠ¨æ—¶ï¼Œå¼€å¯ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡ï¼Œå°è¯•è·å–stream.ordersä¸­çš„æ¶ˆæ¯ï¼Œå®Œæˆä¸‹å•</li></ul><div class="tabs" id="002b742c-1310-4d1b-b929-2a7f61880510"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#002b742c-1310-4d1b-b929-2a7f61880510-1"><i class="fas fa-cat"></i>åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—å’Œæ¶ˆè´¹è€…ç»„</button></li><li class="tab"><button type="button" data-href="#002b742c-1310-4d1b-b929-2a7f61880510-2"><i class="fas fa-horse"></i>ä¿®æ”¹luaè¡¨è¾¾å¼</button></li><li class="tab"><button type="button" data-href="#002b742c-1310-4d1b-b929-2a7f61880510-3"><i class="fas fa-heartbeat"></i>VoucherOrderServiceImpl</button></li><li class="tab"><button type="button" data-href="#002b742c-1310-4d1b-b929-2a7f61880510-4"><i class="fas fa-dove"></i>å¤„ç†æ¶ˆæ¯</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="002b742c-1310-4d1b-b929-2a7f61880510-1"><p><code>XGROUP CREATE stream.orders g1 0 MKSTREAM</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="002b742c-1310-4d1b-b929-2a7f61880510-2"><p>æ–°å¢3.6 å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ä¸­</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1.å‚æ•°åˆ—è¡¨</span></span><br><span class="line"><span class="comment">-- 1.1.ä¼˜æƒ åˆ¸id</span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- 1.2.ç”¨æˆ·id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="comment">-- 1.3.è®¢å•id</span></span><br><span class="line"><span class="keyword">local</span> orderId = ARGV[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2.æ•°æ®key</span></span><br><span class="line"><span class="comment">-- 2.1.åº“å­˜key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">-- 2.2.è®¢å•key</span></span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.è„šæœ¬ä¸šåŠ¡</span></span><br><span class="line"><span class="comment">-- 3.1.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ get stockKey</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.2.åº“å­˜ä¸è¶³ï¼Œè¿”å›1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 3.2.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å• SISMEMBER orderKey userId</span></span><br><span class="line"><span class="keyword">if</span>(redis.call(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.3.å­˜åœ¨ï¼Œè¯´æ˜æ˜¯é‡å¤ä¸‹å•ï¼Œè¿”å›2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 3.4.æ‰£åº“å­˜ incrby stockKey -1</span></span><br><span class="line">redis.call(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>)</span><br><span class="line"><span class="comment">-- 3.5.ä¸‹å•ï¼ˆä¿å­˜ç”¨æˆ·ï¼‰sadd orderKey userId</span></span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId)</span><br><span class="line"><span class="comment">-- 1.å‚æ•°åˆ—è¡¨</span></span><br><span class="line"><span class="comment">-- 1.1.ä¼˜æƒ åˆ¸id</span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- 1.2.ç”¨æˆ·id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="comment">-- 1.3.è®¢å•id</span></span><br><span class="line"><span class="keyword">local</span> orderId = ARGV[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2.æ•°æ®key</span></span><br><span class="line"><span class="comment">-- 2.1.åº“å­˜key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">-- 2.2.è®¢å•key</span></span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.è„šæœ¬ä¸šåŠ¡</span></span><br><span class="line"><span class="comment">-- 3.1.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ get stockKey</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.2.åº“å­˜ä¸è¶³ï¼Œè¿”å›1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 3.2.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å• SISMEMBER orderKey userId</span></span><br><span class="line"><span class="keyword">if</span>(redis.call(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.3.å­˜åœ¨ï¼Œè¯´æ˜æ˜¯é‡å¤ä¸‹å•ï¼Œè¿”å›2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 3.4.æ‰£åº“å­˜ incrby stockKey -1</span></span><br><span class="line">redis.call(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>)</span><br><span class="line"><span class="comment">-- 3.5.ä¸‹å•ï¼ˆä¿å­˜ç”¨æˆ·ï¼‰sadd orderKey userId</span></span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId)</span><br><span class="line"><span class="comment">-- 3.6.å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ä¸­ï¼Œ XADD stream.orders * k1 v1 k2 v2 ...</span></span><br><span class="line">redis.call(<span class="string">&#x27;xadd&#x27;</span>, <span class="string">&#x27;stream.orders&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;userId&#x27;</span>, userId, <span class="string">&#x27;voucherId&#x27;</span>, voucherId, <span class="string">&#x27;id&#x27;</span>, orderId)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="002b742c-1310-4d1b-b929-2a7f61880510-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(SECKILL_SCRIPT,</span><br><span class="line">            Collections.emptyList(), voucherId.toString(),</span><br><span class="line">            UserHolder.getUser().getId().toString(), String.valueOf(orderId));</span><br><span class="line">    <span class="keyword">if</span> (result.intValue() != <span class="number">0</span>) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;luaè„šæœ¬è¿”å›å€¼ï¼š&#123;&#125;&quot;</span>, result.intValue());</span><br><span class="line">        <span class="keyword">return</span> Result.fail(result.intValue() == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•å•Š&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸»çº¿ç¨‹è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">    proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="002b742c-1310-4d1b-b929-2a7f61880510-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 1.è·å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 &gt;</span></span><br><span class="line">                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(</span><br><span class="line">                    Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                    StreamReadOptions.empty().count(<span class="number">1</span>).block(Duration.ofSeconds(<span class="number">2</span>)),</span><br><span class="line">                    StreamOffset.create(<span class="string">&quot;stream.orders&quot;</span>, ReadOffset.lastConsumed())</span><br><span class="line">                );</span><br><span class="line">                <span class="comment">// 2.åˆ¤æ–­è®¢å•ä¿¡æ¯æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">                <span class="keyword">if</span> (list == <span class="literal">null</span> || list.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰æ¶ˆæ¯ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è§£ææ•°æ®</span></span><br><span class="line">                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="number">0</span>);</span><br><span class="line">                Map&lt;Object, Object&gt; value = record.getValue();</span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                <span class="comment">// 3.åˆ›å»ºè®¢å•</span></span><br><span class="line">                createVoucherOrder(voucherOrder);</span><br><span class="line">                <span class="comment">// 4.ç¡®è®¤æ¶ˆæ¯ XACK</span></span><br><span class="line">                stringRedisTemplate.opsForStream().acknowledge(<span class="string">&quot;s1&quot;</span>, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                <span class="comment">//å¤„ç†å¼‚å¸¸æ¶ˆæ¯</span></span><br><span class="line">                handlePendingList();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlePendingList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 1.è·å–pending-listä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 0</span></span><br><span class="line">                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(</span><br><span class="line">                    Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                    StreamReadOptions.empty().count(<span class="number">1</span>),</span><br><span class="line">                    StreamOffset.create(<span class="string">&quot;stream.orders&quot;</span>, ReadOffset.from(<span class="string">&quot;0&quot;</span>))</span><br><span class="line">                );</span><br><span class="line">                <span class="comment">// 2.åˆ¤æ–­è®¢å•ä¿¡æ¯æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">                <span class="keyword">if</span> (list == <span class="literal">null</span> || list.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œç»“æŸå¾ªç¯</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è§£ææ•°æ®</span></span><br><span class="line">                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="number">0</span>);</span><br><span class="line">                Map&lt;Object, Object&gt; value = record.getValue();</span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                <span class="comment">// 3.åˆ›å»ºè®¢å•</span></span><br><span class="line">                createVoucherOrder(voucherOrder);</span><br><span class="line">                <span class="comment">// 4.ç¡®è®¤æ¶ˆæ¯ XACK</span></span><br><span class="line">                stringRedisTemplate.opsForStream().acknowledge(<span class="string">&quot;s1&quot;</span>, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;å¤„ç†penddingè®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    Thread.sleep(<span class="number">20</span>);</span><br><span class="line">                &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="ç‚¹èµå®ç°-sortedSet">ç‚¹èµå®ç°-sortedSet</h2><div class="tabs" id="ed3f0b4c-f93a-49ef-9df3-492ab55d6d5a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ed3f0b4c-f93a-49ef-9df3-492ab55d6d5a-1"><i class="fas fa-atom"></i>åˆå§‹ä»£ç </button></li><li class="tab"><button type="button" data-href="#ed3f0b4c-f93a-49ef-9df3-492ab55d6d5a-2"><i class="far fa-sun"></i>å®Œå–„ç‚¹èµåŠŸèƒ½</button></li><li class="tab"><button type="button" data-href="#ed3f0b4c-f93a-49ef-9df3-492ab55d6d5a-3"><i class="fas fa-wind"></i>åœ¨Blogæ·»åŠ ä¸€ä¸ªå­—æ®µ</button></li><li class="tab"><button type="button" data-href="#ed3f0b4c-f93a-49ef-9df3-492ab55d6d5a-4"><i class="fas fa-fire-alt"></i>ä¿®æ”¹ä»£ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ed3f0b4c-f93a-49ef-9df3-492ab55d6d5a-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/likes/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogLikes</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//ä¿®æ”¹ç‚¹èµæ•°é‡</span></span><br><span class="line">    blogService.update().setSql(<span class="string">&quot;liked = liked +1 &quot;</span>).eq(<span class="string">&quot;id&quot;</span>,id).update();</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é—®é¢˜åˆ†æï¼šè¿™ç§æ–¹å¼ä¼šå¯¼è‡´ä¸€ä¸ªç”¨æˆ·æ— é™ç‚¹èµï¼Œæ˜æ˜¾æ˜¯ä¸åˆç†çš„</p><p>é€ æˆè¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯ï¼Œæˆ‘ä»¬ç°åœ¨çš„é€»è¾‘ï¼Œå‘èµ·è¯·æ±‚å°±ç»™æ•°æ®åº“+1ï¼Œæ‰€ä»¥æ‰ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ed3f0b4c-f93a-49ef-9df3-492ab55d6d5a-2"><p>éœ€æ±‚ï¼š</p><ul><li>åŒä¸€ä¸ªç”¨æˆ·åªèƒ½ç‚¹èµä¸€æ¬¡ï¼Œå†æ¬¡ç‚¹å‡»åˆ™å–æ¶ˆç‚¹èµ</li><li>å¦‚æœå½“å‰ç”¨æˆ·å·²ç»ç‚¹èµï¼Œåˆ™ç‚¹èµæŒ‰é’®é«˜äº®æ˜¾ç¤ºï¼ˆå‰ç«¯å·²å®ç°ï¼Œåˆ¤æ–­å­—æ®µBlogç±»çš„isLikeå±æ€§ï¼‰</li></ul><p>å®ç°æ­¥éª¤ï¼š</p><ul><li>ç»™Blogç±»ä¸­æ·»åŠ ä¸€ä¸ªisLikeå­—æ®µï¼Œæ ‡ç¤ºæ˜¯å¦è¢«å½“å‰ç”¨æˆ·ç‚¹èµ</li><li>ä¿®æ”¹ç‚¹èµåŠŸèƒ½ï¼Œåˆ©ç”¨Redisçš„seté›†åˆåˆ¤æ–­æ˜¯å¦ç‚¹èµè¿‡ï¼Œæœªç‚¹èµè¿‡åˆ™ç‚¹èµæ•°+1ï¼Œå·²ç‚¹èµè¿‡åˆ™ç‚¹èµæ•°-1</li><li>ä¿®æ”¹æ ¹æ®idæŸ¥è¯¢Blogçš„ä¸šåŠ¡ï¼Œåˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦ç‚¹èµè¿‡ï¼Œèµ‹å€¼ç»™isLikeå­—æ®µ</li><li>ä¿®æ”¹åˆ†é¡µæŸ¥è¯¢Blogä¸šåŠ¡ï¼Œåˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦ç‚¹èµè¿‡ï¼Œèµ‹å€¼ç»™isLikeå­—æ®µ</li></ul><p>ä¸ºä»€ä¹ˆé‡‡ç”¨seté›†åˆï¼š</p><p>å› ä¸ºæˆ‘ä»¬çš„æ•°æ®æ˜¯ä¸èƒ½é‡å¤çš„ï¼Œå½“ç”¨æˆ·æ“ä½œè¿‡ä¹‹åï¼Œæ— è®ºä»–æ€ä¹ˆæ“ä½œï¼Œéƒ½æ˜¯</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ed3f0b4c-f93a-49ef-9df3-492ab55d6d5a-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableField(exist = false)</span></span><br><span class="line"><span class="keyword">private</span> Boolean isLike;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ed3f0b4c-f93a-49ef-9df3-492ab55d6d5a-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµ</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span><br><span class="line">    <span class="keyword">if</span> (BooleanUtil.isFalse(isMember)) &#123;</span><br><span class="line">        <span class="comment">//3.å¦‚æœæœªç‚¹èµï¼Œå¯ä»¥ç‚¹èµ</span></span><br><span class="line">        <span class="comment">//3.1 æ•°æ®åº“ç‚¹èµæ•°+1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="comment">//3.2 ä¿å­˜ç”¨æˆ·åˆ°Redisçš„seté›†åˆ</span></span><br><span class="line">        <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">            stringRedisTemplate.opsForSet().add(key, userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//4.å¦‚æœå·²ç‚¹èµï¼Œå–æ¶ˆç‚¹èµ</span></span><br><span class="line">        <span class="comment">//4.1 æ•°æ®åº“ç‚¹èµæ•°-1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="comment">//4.2 æŠŠç”¨æˆ·ä»Redisçš„seté›†åˆç§»é™¤</span></span><br><span class="line">        <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">            stringRedisTemplate.opsForSet().remove(key, userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <mark class="hl-label blue">ç‚¹èµæ’è¡Œæ¦œ</mark> <p>åœ¨æ¢åº—ç¬”è®°çš„è¯¦æƒ…é¡µé¢ï¼Œåº”è¯¥æŠŠç»™è¯¥ç¬”è®°ç‚¹èµçš„äººæ˜¾ç¤ºå‡ºæ¥ï¼Œæ¯”å¦‚æœ€æ—©ç‚¹èµçš„TOP5ï¼Œå½¢æˆç‚¹èµæ’è¡Œæ¦œï¼š</p><p>ä¹‹å‰çš„ç‚¹èµæ˜¯æ”¾åˆ°seté›†åˆï¼Œä½†æ˜¯seté›†åˆæ˜¯ä¸èƒ½æ’åºçš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ï¼Œå’±ä»¬å¯ä»¥é‡‡ç”¨ä¸€ä¸ªå¯ä»¥æ’åºçš„seté›†åˆï¼Œå°±æ˜¯å’±ä»¬çš„sortedSet</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653805077118.png" alt="1653805077118" style="zoom:67%;" /><p>æˆ‘ä»¬æ¥ä¸‹æ¥æ¥å¯¹æ¯”ä¸€ä¸‹è¿™äº›é›†åˆçš„åŒºåˆ«æ˜¯ä»€ä¹ˆ</p><p>æ‰€æœ‰ç‚¹èµçš„äººï¼Œéœ€è¦æ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”å½“ä½¿ç”¨setæˆ–è€…æ˜¯sortedSet</p><p>å…¶æ¬¡æˆ‘ä»¬éœ€è¦æ’åºï¼Œå°±å¯ä»¥ç›´æ¥é”å®šä½¿ç”¨sortedSetå•¦</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">List</th><th style="text-align:center">Set</th><th style="text-align:center">SortedSet</th></tr></thead><tbody><tr><td style="text-align:center">æ’åºæ–¹å¼</td><td style="text-align:center">æŒ‰æ·»åŠ é¡ºåºæ’åº</td><td style="text-align:center">æ— æ³•æ’åº</td><td style="text-align:center">æŒ‰scoreå€¼æ’åº</td></tr><tr><td style="text-align:center">å”¯ä¸€æ€§</td><td style="text-align:center">ä¸å”¯ä¸€</td><td style="text-align:center">å”¯ä¸€</td><td style="text-align:center">å”¯ä¸€</td></tr><tr><td style="text-align:center">æŸ¥æ‰¾æ–¹å¼</td><td style="text-align:center">æŒ‰ç´¢å¼•æŸ¥æ‰¾æˆ–é¦–ä½æŸ¥æ‰¾</td><td style="text-align:center">æ ¹æ®å…ƒç´ æŸ¥æ‰¾</td><td style="text-align:center">æ ¹æ®å…ƒç´ æŸ¥æ‰¾</td></tr></tbody></table><p>ä¿®æ”¹ä»£ç </p><div class="tabs" id="136de59c-033e-4085-a058-77f0cad44561"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#136de59c-033e-4085-a058-77f0cad44561-1"><i class="fas fa-bug"></i>ç‚¹èµé€»è¾‘ä»£ç </button></li><li class="tab"><button type="button" data-href="#136de59c-033e-4085-a058-77f0cad44561-2"><i class="fas fa-cannabis"></i>ç‚¹èµåˆ—è¡¨æŸ¥è¯¢åˆ—è¡¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="136de59c-033e-4085-a058-77f0cad44561-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">     <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">     <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">     <span class="comment">// 2.åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµ</span></span><br><span class="line">     <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">     <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());</span><br><span class="line">     <span class="keyword">if</span> (score == <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="comment">// 3.å¦‚æœæœªç‚¹èµï¼Œå¯ä»¥ç‚¹èµ</span></span><br><span class="line">         <span class="comment">// 3.1.æ•°æ®åº“ç‚¹èµæ•° + 1</span></span><br><span class="line">         <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">         <span class="comment">// 3.2.ä¿å­˜ç”¨æˆ·åˆ°Redisçš„seté›†åˆ  zadd key value score</span></span><br><span class="line">         <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">             stringRedisTemplate.opsForZSet().add(key, userId.toString(), System.currentTimeMillis());</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// 4.å¦‚æœå·²ç‚¹èµï¼Œå–æ¶ˆç‚¹èµ</span></span><br><span class="line">         <span class="comment">// 4.1.æ•°æ®åº“ç‚¹èµæ•° -1</span></span><br><span class="line">         <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">         <span class="comment">// 4.2.æŠŠç”¨æˆ·ä»Redisçš„seté›†åˆç§»é™¤</span></span><br><span class="line">         <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">             stringRedisTemplate.opsForZSet().remove(key, userId.toString());</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> Result.ok();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">isBlogLiked</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">     <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">     <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">     <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="comment">// ç”¨æˆ·æœªç™»å½•ï¼Œæ— éœ€æŸ¥è¯¢æ˜¯å¦ç‚¹èµ</span></span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line">     <span class="comment">// 2.åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµ</span></span><br><span class="line">     <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;blog:liked:&quot;</span> + blog.getId();</span><br><span class="line">     <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());</span><br><span class="line">     blog.setIsLike(score != <span class="literal">null</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="136de59c-033e-4085-a058-77f0cad44561-2"><p><code>BlogController</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/likes/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogLikes</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> blogService.queryBlogLikes(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>BlogService</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogLikes</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢top5çš„ç‚¹èµç”¨æˆ· zrange key 0 4</span></span><br><span class="line">    Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span> (top5 == <span class="literal">null</span> || top5.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2.è§£æå‡ºå…¶ä¸­çš„ç”¨æˆ·id</span></span><br><span class="line">    List&lt;Long&gt; ids = top5.stream().map(Long::valueOf).collect(Collectors.toList());</span><br><span class="line">    <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    <span class="comment">// 3.æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢ç”¨æˆ· WHERE id IN ( 5 , 1 ) ORDER BY FIELD(id, 5, 1)</span></span><br><span class="line">    List&lt;UserDTO&gt; userDTOS = userService.query()</span><br><span class="line">            .in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="string">&quot;)&quot;</span>).list()</span><br><span class="line">            .stream()</span><br><span class="line">            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// 4.è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(userDTOS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="å¥½å‹å…³æ³¨-set">å¥½å‹å…³æ³¨-set</h2><h3 id="å…³æ³¨å’Œå–æ¶ˆå…³æ³¨">å…³æ³¨å’Œå–æ¶ˆå…³æ³¨</h3><div class="tabs" id="bdd86502-abdf-4f47-9317-fa06d5ab6d28"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#bdd86502-abdf-4f47-9317-fa06d5ab6d28-1"><i class="fas fa-seedling"></i>1</button></li><li class="tab"><button type="button" data-href="#bdd86502-abdf-4f47-9317-fa06d5ab6d28-2"><i class="fas fa-leaf"></i>å®ç°æ€è·¯</button></li><li class="tab"><button type="button" data-href="#bdd86502-abdf-4f47-9317-fa06d5ab6d28-3"><i class="fab fa-apple"></i>FollowController</button></li><li class="tab"><button type="button" data-href="#bdd86502-abdf-4f47-9317-fa06d5ab6d28-4"><i class="fas fa-tree"></i>FollowService</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="bdd86502-abdf-4f47-9317-fa06d5ab6d28-1"><p>é’ˆå¯¹ç”¨æˆ·çš„æ“ä½œï¼šå¯ä»¥å¯¹ç”¨æˆ·è¿›è¡Œå…³æ³¨å’Œå–æ¶ˆå…³æ³¨åŠŸèƒ½ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653806140822.png" alt="1653806140822" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="bdd86502-abdf-4f47-9317-fa06d5ab6d28-2"><p>éœ€æ±‚ï¼šåŸºäºè¯¥è¡¨æ•°æ®ç»“æ„ï¼Œå®ç°ä¸¤ä¸ªæ¥å£ï¼š</p><ul><li>å…³æ³¨å’Œå–å…³æ¥å£</li><li>åˆ¤æ–­æ˜¯å¦å…³æ³¨çš„æ¥å£</li></ul><p>å…³æ³¨æ˜¯Userä¹‹é—´çš„å…³ç³»ï¼Œæ˜¯åšä¸»ä¸ç²‰ä¸çš„å…³ç³»ï¼Œæ•°æ®åº“ä¸­æœ‰ä¸€å¼ tb_followè¡¨æ¥æ ‡ç¤ºï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653806253817.png" alt="1653806253817"></p><p>æ³¨æ„: è¿™é‡Œéœ€è¦æŠŠä¸»é”®ä¿®æ”¹ä¸ºè‡ªå¢é•¿ï¼Œç®€åŒ–å¼€å‘ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="bdd86502-abdf-4f47-9317-fa06d5ab6d28-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…³æ³¨</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/&#123;id&#125;/&#123;isFollow&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long followUserId, <span class="meta">@PathVariable(&quot;isFollow&quot;)</span> Boolean isFollow)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> followService.follow(followUserId, isFollow);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å–æ¶ˆå…³æ³¨</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/or/not/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">isFollow</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long followUserId)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> followService.isFollow(followUserId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="bdd86502-abdf-4f47-9317-fa06d5ab6d28-4"><div class="tabs" id="cccdfb68-bd1f-430e-906b-bff07b662bc9"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#cccdfb68-bd1f-430e-906b-bff07b662bc9-1"><i class="fas fa-award"></i>å…³æ³¨</button></li><li class="tab"><button type="button" data-href="#cccdfb68-bd1f-430e-906b-bff07b662bc9-2"><i class="fas fa-baseball-ball"></i>å–æ¶ˆå…³æ³¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="cccdfb68-bd1f-430e-906b-bff07b662bc9-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…³æ³¨service</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFollow)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">    <span class="comment">// 1.åˆ¤æ–­åˆ°åº•æ˜¯å…³æ³¨è¿˜æ˜¯å–å…³</span></span><br><span class="line">    <span class="keyword">if</span> (isFollow) &#123;</span><br><span class="line">        <span class="comment">// 2.å…³æ³¨ï¼Œæ–°å¢æ•°æ®</span></span><br><span class="line">        <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">        follow.setUserId(userId);</span><br><span class="line">        follow.setFollowUserId(followUserId);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(follow);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 3.å–å…³ï¼Œåˆ é™¤ delete from tb_follow where user_id = ? and follow_user_id = ?</span></span><br><span class="line">        remove(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;Follow&gt;()</span><br><span class="line">                .eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cccdfb68-bd1f-430e-906b-bff07b662bc9-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å–æ¶ˆå…³æ³¨</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">isFollow</span><span class="params">(Long followUserId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.æŸ¥è¯¢æ˜¯å¦å…³æ³¨ select count(*) from tb_follow where user_id = ? and follow_user_id = ?</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId).count();</span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(count &gt; <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="å…±åŒå…³æ³¨">å…±åŒå…³æ³¨</h3><div class="tabs" id="d7cfd170-156e-4615-ae27-3c3a93bae496"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d7cfd170-156e-4615-ae27-3c3a93bae496-1"><i class="fas fa-horse"></i>1</button></li><li class="tab"><button type="button" data-href="#d7cfd170-156e-4615-ae27-3c3a93bae496-2"><i class="fas fa-dove"></i>2</button></li><li class="tab"><button type="button" data-href="#d7cfd170-156e-4615-ae27-3c3a93bae496-3"><i class="fas fa-dragon"></i>3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d7cfd170-156e-4615-ae27-3c3a93bae496-1"><p>éœ€æ±‚ï¼šåˆ©ç”¨Redisä¸­æ°å½“çš„æ•°æ®ç»“æ„ï¼Œå®ç°å…±åŒå…³æ³¨åŠŸèƒ½ã€‚åœ¨åšä¸»ä¸ªäººé¡µé¢å±•ç¤ºå‡ºå½“å‰ç”¨æˆ·ä¸åšä¸»çš„å…±åŒå…³æ³¨å‘¢ã€‚</p><p>å½“ç„¶æ˜¯ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰å­¦ä¹ è¿‡çš„seté›†åˆå’¯ï¼Œåœ¨seté›†åˆä¸­ï¼Œæœ‰äº¤é›†å¹¶é›†è¡¥é›†çš„apiï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸¤äººçš„å…³æ³¨çš„äººåˆ†åˆ«æ”¾å…¥åˆ°ä¸€ä¸ªseté›†åˆä¸­ï¼Œç„¶åå†é€šè¿‡apiå»æŸ¥çœ‹è¿™ä¸¤ä¸ªseté›†åˆä¸­çš„äº¤é›†æ•°æ®ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d7cfd170-156e-4615-ae27-3c3a93bae496-2"><p>æˆ‘ä»¬å…ˆæ¥æ”¹é€ å½“å‰çš„å…³æ³¨åˆ—è¡¨</p><p>æ”¹é€ åŸå› æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦åœ¨ç”¨æˆ·å…³æ³¨äº†æŸä½ç”¨æˆ·åï¼Œéœ€è¦å°†æ•°æ®æ”¾å…¥åˆ°seté›†åˆä¸­ï¼Œæ–¹ä¾¿åç»­è¿›è¡Œå…±åŒå…³æ³¨ï¼ŒåŒæ—¶å½“å–æ¶ˆå…³æ³¨æ—¶ï¼Œä¹Ÿéœ€è¦ä»seté›†åˆä¸­è¿›è¡Œåˆ é™¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFollow)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">    <span class="comment">// 1.åˆ¤æ–­åˆ°åº•æ˜¯å…³æ³¨è¿˜æ˜¯å–å…³</span></span><br><span class="line">    <span class="keyword">if</span> (isFollow) &#123;</span><br><span class="line">        <span class="comment">// 2.å…³æ³¨ï¼Œæ–°å¢æ•°æ®</span></span><br><span class="line">        <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">        follow.setUserId(userId);</span><br><span class="line">        follow.setFollowUserId(followUserId);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(follow);</span><br><span class="line">        <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">            <span class="comment">// æŠŠå…³æ³¨ç”¨æˆ·çš„idï¼Œæ”¾å…¥redisçš„seté›†åˆ sadd userId followerUserId</span></span><br><span class="line">            stringRedisTemplate.opsForSet().add(key, followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 3.å–å…³ï¼Œåˆ é™¤ delete from tb_follow where user_id = ? and follow_user_id = ?</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> remove(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;Follow&gt;()</span><br><span class="line">                .eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId));</span><br><span class="line">        <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">            <span class="comment">// æŠŠå…³æ³¨ç”¨æˆ·çš„idä»Redisé›†åˆä¸­ç§»é™¤</span></span><br><span class="line">            stringRedisTemplate.opsForSet().remove(key, followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d7cfd170-156e-4615-ae27-3c3a93bae496-3"><p>å…·ä½“çš„å…³æ³¨ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">followCommons</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">    <span class="comment">// 2.æ±‚äº¤é›†</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key2</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + id;</span><br><span class="line">    Set&lt;String&gt; intersect = stringRedisTemplate.opsForSet().intersect(key, key2);</span><br><span class="line">    <span class="keyword">if</span> (intersect == <span class="literal">null</span> || intersect.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// æ— äº¤é›†</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.è§£æidé›†åˆ</span></span><br><span class="line">    List&lt;Long&gt; ids = intersect.stream().map(Long::valueOf).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// 4.æŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">    List&lt;UserDTO&gt; users = userService.listByIds(ids)</span><br><span class="line">            .stream()</span><br><span class="line">            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> Result.ok(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="Feedæµå®ç°æ–¹æ¡ˆ">Feedæµå®ç°æ–¹æ¡ˆ</h3><p>å½“æˆ‘ä»¬å…³æ³¨äº†ç”¨æˆ·åï¼Œè¿™ä¸ªç”¨æˆ·å‘äº†åŠ¨æ€ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥æŠŠè¿™äº›æ•°æ®æ¨é€ç»™ç”¨æˆ·ï¼Œè¿™ä¸ªéœ€æ±‚ï¼Œå…¶å®æˆ‘ä»¬åˆæŠŠä»–å«åšFeedæµï¼Œå…³æ³¨æ¨é€ä¹Ÿå«åšFeedæµï¼Œç›´è¯‘ä¸ºæŠ•å–‚ã€‚ä¸ºç”¨æˆ·æŒç»­çš„æä¾›â€œæ²‰æµ¸å¼â€çš„ä½“éªŒï¼Œé€šè¿‡æ— é™ä¸‹æ‹‰åˆ·æ–°è·å–æ–°çš„ä¿¡æ¯ã€‚</p><div class="tabs" id="c3c3b6b8-5d41-479e-88a8-7ffb8fcddecb"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c3c3b6b8-5d41-479e-88a8-7ffb8fcddecb-1"><i class="fas fa-bug"></i>ä¼ ç»Ÿæ¨¡å¼</button></li><li class="tab"><button type="button" data-href="#c3c3b6b8-5d41-479e-88a8-7ffb8fcddecb-2"><i class="fas fa-cannabis"></i>Feedæ¨¡å¼</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c3c3b6b8-5d41-479e-88a8-7ffb8fcddecb-1"><p>å¯¹äºä¼ ç»Ÿçš„æ¨¡å¼çš„å†…å®¹è§£é”ï¼šæˆ‘ä»¬æ˜¯éœ€è¦ç”¨æˆ·å»é€šè¿‡æœç´¢å¼•æ“æˆ–è€…æ˜¯å…¶ä»–çš„æ–¹å¼å»è§£é”æƒ³è¦çœ‹çš„å†…å®¹</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653808641260.png" alt="1653808641260"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c3c3b6b8-5d41-479e-88a8-7ffb8fcddecb-2"><p>å¯¹äºæ–°å‹çš„Feedæµçš„çš„æ•ˆæœï¼šä¸éœ€è¦æˆ‘ä»¬ç”¨æˆ·å†å»æ¨é€ä¿¡æ¯ï¼Œè€Œæ˜¯ç³»ç»Ÿåˆ†æç”¨æˆ·åˆ°åº•æƒ³è¦ä»€ä¹ˆï¼Œç„¶åç›´æ¥æŠŠå†…å®¹æ¨é€ç»™ç”¨æˆ·ï¼Œä»è€Œä½¿ç”¨æˆ·èƒ½å¤Ÿæ›´åŠ çš„èŠ‚çº¦æ—¶é—´ï¼Œä¸ç”¨ä¸»åŠ¨å»å¯»æ‰¾ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653808993693.png" alt="1653808993693"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>Feedæµçš„å®ç°æœ‰ä¸¤ç§æ¨¡å¼ï¼š</p><p>Feedæµäº§å“æœ‰ä¸¤ç§å¸¸è§æ¨¡å¼ï¼š<br>Timelineï¼šä¸åšå†…å®¹ç­›é€‰ï¼Œç®€å•çš„æŒ‰ç…§å†…å®¹å‘å¸ƒæ—¶é—´æ’åºï¼Œå¸¸ç”¨äºå¥½å‹æˆ–å…³æ³¨ã€‚ä¾‹å¦‚æœ‹å‹åœˆ</p><ul><li>ä¼˜ç‚¹ï¼šä¿¡æ¯å…¨é¢ï¼Œä¸ä¼šæœ‰ç¼ºå¤±ã€‚å¹¶ä¸”å®ç°ä¹Ÿç›¸å¯¹ç®€å•</li><li>ç¼ºç‚¹ï¼šä¿¡æ¯å™ªéŸ³è¾ƒå¤šï¼Œç”¨æˆ·ä¸ä¸€å®šæ„Ÿå…´è¶£ï¼Œå†…å®¹è·å–æ•ˆç‡ä½</li></ul><p>æ™ºèƒ½æ’åºï¼šåˆ©ç”¨æ™ºèƒ½ç®—æ³•å±è”½æ‰è¿è§„çš„ã€ç”¨æˆ·ä¸æ„Ÿå…´è¶£çš„å†…å®¹ã€‚æ¨é€ç”¨æˆ·æ„Ÿå…´è¶£ä¿¡æ¯æ¥å¸å¼•ç”¨æˆ·</p><ul><li>ä¼˜ç‚¹ï¼šæŠ•å–‚ç”¨æˆ·æ„Ÿå…´è¶£ä¿¡æ¯ï¼Œç”¨æˆ·ç²˜åº¦å¾ˆé«˜ï¼Œå®¹æ˜“æ²‰è¿·</li><li>ç¼ºç‚¹ï¼šå¦‚æœç®—æ³•ä¸ç²¾å‡†ï¼Œå¯èƒ½èµ·åˆ°åä½œç”¨<br>æœ¬ä¾‹ä¸­çš„ä¸ªäººé¡µé¢ï¼Œæ˜¯åŸºäºå…³æ³¨çš„å¥½å‹æ¥åšFeedæµï¼Œå› æ­¤é‡‡ç”¨Timelineçš„æ¨¡å¼ã€‚è¯¥æ¨¡å¼çš„å®ç°æ–¹æ¡ˆæœ‰ä¸‰ç§ï¼š</li></ul><p>æˆ‘ä»¬æœ¬æ¬¡é’ˆå¯¹å¥½å‹çš„æ“ä½œï¼Œé‡‡ç”¨çš„å°±æ˜¯Timelineçš„æ–¹å¼ï¼Œåªéœ€è¦æ‹¿åˆ°æˆ‘ä»¬å…³æ³¨ç”¨æˆ·çš„ä¿¡æ¯ï¼Œç„¶åæŒ‰ç…§æ—¶é—´æ’åºå³å¯</p><p>ï¼Œå› æ­¤é‡‡ç”¨Timelineçš„æ¨¡å¼ã€‚è¯¥æ¨¡å¼çš„å®ç°æ–¹æ¡ˆæœ‰ä¸‰ç§ï¼š</p><ul><li>æ‹‰æ¨¡å¼</li><li>æ¨æ¨¡å¼</li><li>æ¨æ‹‰ç»“åˆ</li></ul><div class="tabs" id="95619f31-dad8-4bef-9533-b2217ebb6587"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#95619f31-dad8-4bef-9533-b2217ebb6587-1"><i class="fas fa-cat"></i>æ‹‰æ¨¡å¼</button></li><li class="tab"><button type="button" data-href="#95619f31-dad8-4bef-9533-b2217ebb6587-2"><i class="fas fa-horse"></i>æ¨æ¨¡å¼</button></li><li class="tab"><button type="button" data-href="#95619f31-dad8-4bef-9533-b2217ebb6587-3"><i class="fas fa-dove"></i>æ¨æ‹‰ç»“åˆ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="95619f31-dad8-4bef-9533-b2217ebb6587-1"><p><strong>æ‹‰æ¨¡å¼</strong>ï¼šä¹Ÿå«åšè¯»æ‰©æ•£</p><p>è¯¥æ¨¡å¼çš„æ ¸å¿ƒå«ä¹‰å°±æ˜¯ï¼šå½“å¼ ä¸‰å’Œæå››å’Œç‹äº”å‘äº†æ¶ˆæ¯åï¼Œéƒ½ä¼šä¿å­˜åœ¨è‡ªå·±çš„é‚®ç®±ä¸­ï¼Œå‡è®¾èµµå…­è¦è¯»å–ä¿¡æ¯ï¼Œé‚£ä¹ˆä»–ä¼šä»è¯»å–ä»–è‡ªå·±çš„æ”¶ä»¶ç®±ï¼Œæ­¤æ—¶ç³»ç»Ÿä¼šä»ä»–å…³æ³¨çš„äººç¾¤ä¸­ï¼ŒæŠŠä»–å…³æ³¨äººçš„ä¿¡æ¯å…¨éƒ¨éƒ½è¿›è¡Œæ‹‰å–ï¼Œç„¶ååœ¨è¿›è¡Œæ’åº</p><p>ä¼˜ç‚¹ï¼šæ¯”è¾ƒèŠ‚çº¦ç©ºé—´ï¼Œå› ä¸ºèµµå…­åœ¨è¯»ä¿¡æ¯æ—¶ï¼Œå¹¶æ²¡æœ‰é‡å¤è¯»å–ï¼Œè€Œä¸”è¯»å–å®Œä¹‹åå¯ä»¥æŠŠä»–çš„æ”¶ä»¶ç®±è¿›è¡Œæ¸…æ¥šã€‚</p><p>ç¼ºç‚¹ï¼šæ¯”è¾ƒå»¶è¿Ÿï¼Œå½“ç”¨æˆ·è¯»å–æ•°æ®æ—¶æ‰å»å…³æ³¨çš„äººé‡Œè¾¹å»è¯»å–æ•°æ®ï¼Œå‡è®¾ç”¨æˆ·å…³æ³¨äº†å¤§é‡çš„ç”¨æˆ·ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šæ‹‰å–æµ·é‡çš„å†…å®¹ï¼Œå¯¹æœåŠ¡å™¨å‹åŠ›å·¨å¤§ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653809450816.png" alt="1653809450816" style="zoom: 50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="95619f31-dad8-4bef-9533-b2217ebb6587-2"><p><strong>æ¨æ¨¡å¼</strong>ï¼šä¹Ÿå«åšå†™æ‰©æ•£ã€‚</p><p>æ¨æ¨¡å¼æ˜¯æ²¡æœ‰å†™é‚®ç®±çš„ï¼Œå½“å¼ ä¸‰å†™äº†ä¸€ä¸ªå†…å®¹ï¼Œæ­¤æ—¶ä¼šä¸»åŠ¨çš„æŠŠå¼ ä¸‰å†™çš„å†…å®¹å‘é€åˆ°ä»–çš„ç²‰ä¸æ”¶ä»¶ç®±ä¸­å»ï¼Œå‡è®¾æ­¤æ—¶æå››å†æ¥è¯»å–ï¼Œå°±ä¸ç”¨å†å»ä¸´æ—¶æ‹‰å–äº†</p><p>ä¼˜ç‚¹ï¼šæ—¶æ•ˆå¿«ï¼Œä¸ç”¨ä¸´æ—¶æ‹‰å–</p><p>ç¼ºç‚¹ï¼šå†…å­˜å‹åŠ›å¤§ï¼Œå‡è®¾ä¸€ä¸ªå¤§Vå†™ä¿¡æ¯ï¼Œå¾ˆå¤šäººå…³æ³¨ä»–ï¼Œ å°±ä¼šå†™å¾ˆå¤šåˆ†æ•°æ®åˆ°ç²‰ä¸é‚£è¾¹å»</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653809875208.png" alt="1653809875208" style="zoom: 50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="95619f31-dad8-4bef-9533-b2217ebb6587-3"><p><strong>æ¨æ‹‰ç»“åˆæ¨¡å¼</strong>ï¼šä¹Ÿå«åšè¯»å†™æ··åˆï¼Œå…¼å…·æ¨å’Œæ‹‰ä¸¤ç§æ¨¡å¼çš„ä¼˜ç‚¹ã€‚</p><p>æ¨æ‹‰æ¨¡å¼æ˜¯ä¸€ä¸ªæŠ˜ä¸­çš„æ–¹æ¡ˆï¼Œç«™åœ¨å‘ä»¶äººè¿™ä¸€æ®µï¼Œå¦‚æœæ˜¯ä¸ªæ™®é€šçš„äººï¼Œé‚£ä¹ˆæˆ‘ä»¬é‡‡ç”¨å†™æ‰©æ•£çš„æ–¹å¼ï¼Œç›´æ¥æŠŠæ•°æ®å†™å…¥åˆ°ä»–çš„ç²‰ä¸ä¸­å»ï¼Œå› ä¸ºæ™®é€šçš„äººä»–çš„ç²‰ä¸å…³æ³¨é‡æ¯”è¾ƒå°ï¼Œæ‰€ä»¥è¿™æ ·åšæ²¡æœ‰å‹åŠ›ï¼Œå¦‚æœæ˜¯å¤§Vï¼Œé‚£ä¹ˆä»–æ˜¯ç›´æ¥å°†æ•°æ®å…ˆå†™å…¥åˆ°ä¸€ä»½åˆ°å‘ä»¶ç®±é‡Œè¾¹å»ï¼Œç„¶åå†ç›´æ¥å†™ä¸€ä»½åˆ°æ´»è·ƒç²‰ä¸æ”¶ä»¶ç®±é‡Œè¾¹å»ï¼Œç°åœ¨ç«™åœ¨æ”¶ä»¶äººè¿™ç«¯æ¥çœ‹ï¼Œå¦‚æœæ˜¯æ´»è·ƒç²‰ä¸ï¼Œé‚£ä¹ˆå¤§Vå’Œæ™®é€šçš„äººå‘çš„éƒ½ä¼šç›´æ¥å†™å…¥åˆ°è‡ªå·±æ”¶ä»¶ç®±é‡Œè¾¹æ¥ï¼Œè€Œå¦‚æœæ˜¯æ™®é€šçš„ç²‰ä¸ï¼Œç”±äºä»–ä»¬ä¸Šçº¿ä¸æ˜¯å¾ˆé¢‘ç¹ï¼Œæ‰€ä»¥ç­‰ä»–ä»¬ä¸Šçº¿æ—¶ï¼Œå†ä»å‘ä»¶ç®±é‡Œè¾¹å»æ‹‰ä¿¡æ¯ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653812346852.png" alt="1653812346852" style="zoom: 50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">æ‹‰æ¨¡å¼</th><th style="text-align:center">æ¨æ¨¡å¼</th><th style="text-align:center">æ¨æ‹‰ç»“åˆ</th></tr></thead><tbody><tr><td style="text-align:center">å†™æ¯”ä¾‹</td><td style="text-align:center">ä½</td><td style="text-align:center">é«˜</td><td style="text-align:center">ä¸­</td></tr><tr><td style="text-align:center">è¯»æ¯”ä¾‹</td><td style="text-align:center">é«˜</td><td style="text-align:center">ä½</td><td style="text-align:center">ä¸­</td></tr><tr><td style="text-align:center">ç”¨æˆ·è¯»å–å»¶è¿Ÿ</td><td style="text-align:center">é«˜</td><td style="text-align:center">ä½</td><td style="text-align:center">ä¸­</td></tr><tr><td style="text-align:center">å®ç°éš¾åº¦</td><td style="text-align:center">å¤æ‚</td><td style="text-align:center">ç®€å•</td><td style="text-align:center">å¾ˆå¤æ‚</td></tr><tr><td style="text-align:center">ä½¿ç”¨åœºæ™¯</td><td style="text-align:center">å¾ˆå°‘ä½¿ç”¨</td><td style="text-align:center">ç”¨æˆ·é‡å°‘ï¼Œæ²¡æœ‰å¤§V</td><td style="text-align:center">è¿‡åƒä¸‡çš„ç”¨æˆ·é‡ï¼Œæœ‰å¤§V</td></tr></tbody></table><hr><h3 id="æ¨æ¨¡å¼å®ç°">æ¨æ¨¡å¼å®ç°</h3><p>éœ€æ±‚ï¼š</p><ul><li>ä¿®æ”¹æ–°å¢æ¢åº—ç¬”è®°çš„ä¸šåŠ¡ï¼Œåœ¨ä¿å­˜blogåˆ°æ•°æ®åº“çš„åŒæ—¶ï¼Œæ¨é€åˆ°ç²‰ä¸çš„æ”¶ä»¶ç®±</li><li>æ”¶ä»¶ç®±æ»¡è¶³å¯ä»¥æ ¹æ®æ—¶é—´æˆ³æ’åºï¼Œå¿…é¡»ç”¨Redisçš„æ•°æ®ç»“æ„å®ç°</li><li>æŸ¥è¯¢æ”¶ä»¶ç®±æ•°æ®æ—¶ï¼Œå¯ä»¥å®ç°åˆ†é¡µæŸ¥è¯¢</li></ul><p>Feedæµä¸­çš„æ•°æ®ä¼šä¸æ–­æ›´æ–°ï¼Œæ‰€ä»¥æ•°æ®çš„è§’æ ‡ä¹Ÿåœ¨å˜åŒ–ï¼Œå› æ­¤ä¸èƒ½é‡‡ç”¨ä¼ ç»Ÿçš„åˆ†é¡µæ¨¡å¼ã€‚</p><p>ä¼ ç»Ÿäº†åˆ†é¡µåœ¨feedæµæ˜¯ä¸é€‚ç”¨çš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„æ•°æ®ä¼šéšæ—¶å‘ç”Ÿå˜åŒ–</p><p>å‡è®¾åœ¨t1 æ—¶åˆ»ï¼Œæˆ‘ä»¬å»è¯»å–ç¬¬ä¸€é¡µï¼Œæ­¤æ—¶page = 1 ï¼Œsize = 5 ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‹¿åˆ°çš„å°±æ˜¯10~6 è¿™å‡ æ¡è®°å½•ï¼Œå‡è®¾ç°åœ¨t2æ—¶å€™åˆå‘å¸ƒäº†ä¸€æ¡è®°å½•ï¼Œæ­¤æ—¶t3 æ—¶åˆ»ï¼Œæˆ‘ä»¬æ¥è¯»å–ç¬¬äºŒé¡µï¼Œè¯»å–ç¬¬äºŒé¡µä¼ å…¥çš„å‚æ•°æ˜¯page=2 ï¼Œsize=5 ï¼Œé‚£ä¹ˆæ­¤æ—¶è¯»å–åˆ°çš„ç¬¬äºŒé¡µå®é™…ä¸Šæ˜¯ä»6 å¼€å§‹ï¼Œç„¶åæ˜¯6~2 ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¯»å–åˆ°äº†é‡å¤çš„æ•°æ®ï¼Œæ‰€ä»¥feedæµçš„åˆ†é¡µï¼Œä¸èƒ½é‡‡ç”¨åŸå§‹æ–¹æ¡ˆæ¥åšã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653813047671.png" alt="1653813047671" style="zoom:67%;" /><mark class="hl-label blue">Feedæµçš„æ»šåŠ¨åˆ†é¡µ</mark> <p>æˆ‘ä»¬éœ€è¦è®°å½•æ¯æ¬¡æ“ä½œçš„æœ€åä¸€æ¡ï¼Œç„¶åä»è¿™ä¸ªä½ç½®å¼€å§‹å»è¯»å–æ•°æ®</p><p>ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬ä»t1æ—¶åˆ»å¼€å§‹ï¼Œæ‹¿ç¬¬ä¸€é¡µæ•°æ®ï¼Œæ‹¿åˆ°äº†10~6ï¼Œç„¶åè®°å½•ä¸‹å½“å‰æœ€åä¸€æ¬¡æ‹¿å–çš„è®°å½•ï¼Œå°±æ˜¯6ï¼Œt2æ—¶åˆ»å‘å¸ƒäº†æ–°çš„è®°å½•ï¼Œæ­¤æ—¶è¿™ä¸ª11æ”¾åˆ°æœ€é¡¶ä¸Šï¼Œä½†æ˜¯ä¸ä¼šå½±å“æˆ‘ä»¬ä¹‹å‰è®°å½•çš„6ï¼Œæ­¤æ—¶t3æ—¶åˆ»æ¥æ‹¿ç¬¬äºŒé¡µï¼Œç¬¬äºŒé¡µè¿™ä¸ªæ—¶å€™æ‹¿æ•°æ®ï¼Œè¿˜æ˜¯ä»6åä¸€ç‚¹çš„5å»æ‹¿ï¼Œå°±æ‹¿åˆ°äº†5-1çš„è®°å½•ã€‚æˆ‘ä»¬è¿™ä¸ªåœ°æ–¹å¯ä»¥é‡‡ç”¨sortedSetæ¥åšï¼Œå¯ä»¥è¿›è¡ŒèŒƒå›´æŸ¥è¯¢ï¼Œå¹¶ä¸”è¿˜å¯ä»¥è®°å½•å½“å‰è·å–æ•°æ®æ—¶é—´æˆ³æœ€å°å€¼ï¼Œå°±å¯ä»¥å®ç°æ»šåŠ¨åˆ†é¡µäº†</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653813462834.png" alt="1653813462834" style="zoom:67%;" /><p>æ ¸å¿ƒçš„æ„æ€ï¼šå°±æ˜¯æˆ‘ä»¬åœ¨ä¿å­˜å®Œæ¢åº—ç¬”è®°åï¼Œè·å¾—åˆ°å½“å‰ç¬”è®°çš„ç²‰ä¸ï¼Œç„¶åæŠŠæ•°æ®æ¨é€åˆ°ç²‰ä¸çš„redisä¸­å»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    blog.setUserId(user.getId());</span><br><span class="line">    <span class="comment">// 2.ä¿å­˜æ¢åº—ç¬”è®°</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(blog);</span><br><span class="line">    <span class="keyword">if</span>(!isSuccess)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ–°å¢ç¬”è®°å¤±è´¥!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.æŸ¥è¯¢ç¬”è®°ä½œè€…çš„æ‰€æœ‰ç²‰ä¸ select * from tb_follow where follow_user_id = ?</span></span><br><span class="line">    List&lt;Follow&gt; follows = followService.query().eq(<span class="string">&quot;follow_user_id&quot;</span>, user.getId()).list();</span><br><span class="line">    <span class="comment">// 4.æ¨é€ç¬”è®°idç»™æ‰€æœ‰ç²‰ä¸</span></span><br><span class="line">    <span class="keyword">for</span> (Follow follow : follows) &#123;</span><br><span class="line">        <span class="comment">// 4.1.è·å–ç²‰ä¸id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> follow.getUserId();</span><br><span class="line">        <span class="comment">// 4.2.æ¨é€</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> FEED_KEY + userId;</span><br><span class="line">        stringRedisTemplate.opsForZSet().add(key, blog.getId().toString(), System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.è¿”å›id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶é‚®ç®±">å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶é‚®ç®±</h3><p>éœ€æ±‚ï¼šåœ¨ä¸ªäººä¸»é¡µçš„â€œå…³æ³¨â€å¡ç‰‡ä¸­ï¼ŒæŸ¥è¯¢å¹¶å±•ç¤ºæ¨é€çš„Blogä¿¡æ¯ï¼š</p><p>å…·ä½“æ“ä½œå¦‚ä¸‹ï¼š</p><p>1ã€æ¯æ¬¡æŸ¥è¯¢å®Œæˆåï¼Œæˆ‘ä»¬è¦åˆ†æå‡ºæŸ¥è¯¢å‡ºæ•°æ®çš„æœ€å°æ—¶é—´æˆ³ï¼Œè¿™ä¸ªå€¼ä¼šä½œä¸ºä¸‹ä¸€æ¬¡æŸ¥è¯¢çš„æ¡ä»¶</p><p>2ã€æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸ä¸Šä¸€æ¬¡æŸ¥è¯¢ç›¸åŒçš„æŸ¥è¯¢ä¸ªæ•°ä½œä¸ºåç§»é‡ï¼Œä¸‹æ¬¡æŸ¥è¯¢æ—¶ï¼Œè·³è¿‡è¿™äº›æŸ¥è¯¢è¿‡çš„æ•°æ®ï¼Œæ‹¿åˆ°æˆ‘ä»¬éœ€è¦çš„æ•°æ®</p><p>ç»¼ä¸Šï¼šæˆ‘ä»¬çš„è¯·æ±‚å‚æ•°ä¸­å°±éœ€è¦æºå¸¦ lastIdï¼šä¸Šä¸€æ¬¡æŸ¥è¯¢çš„æœ€å°æ—¶é—´æˆ³å’Œåç§»é‡è¿™ä¸¤ä¸ªå‚æ•°ã€‚</p><p>è¿™ä¸¤ä¸ªå‚æ•°ç¬¬ä¸€æ¬¡ä¼šç”±å‰ç«¯æ¥æŒ‡å®šï¼Œä»¥åçš„æŸ¥è¯¢å°±æ ¹æ®åå°ç»“æœä½œä¸ºæ¡ä»¶ï¼Œå†æ¬¡ä¼ é€’åˆ°åå°ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653819821591.png" alt="1653819821591" style="zoom:67%;" /><div class="tabs" id="cdf486cb-451e-45f1-aa05-c5341900e3aa"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#cdf486cb-451e-45f1-aa05-c5341900e3aa-1"><i class="fas fa-award"></i>å®šä¹‰è¿”å›å€¼å®ä½“ç±»</button></li><li class="tab"><button type="button" data-href="#cdf486cb-451e-45f1-aa05-c5341900e3aa-2"><i class="fas fa-baseball-ball"></i>BlogController</button></li><li class="tab"><button type="button" data-href="#cdf486cb-451e-45f1-aa05-c5341900e3aa-3"><i class="fas fa-bone"></i>BlogServiceImpl</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="cdf486cb-451e-45f1-aa05-c5341900e3aa-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScrollResult</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;?&gt; list;</span><br><span class="line">    <span class="keyword">private</span> Long minTime;</span><br><span class="line">    <span class="keyword">private</span> Integer offset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cdf486cb-451e-45f1-aa05-c5341900e3aa-2"><p>æ³¨æ„ï¼šRequestParam è¡¨ç¤ºæ¥å—urlåœ°å€æ ä¼ å‚çš„æ³¨è§£ï¼Œå½“æ–¹æ³•ä¸Šå‚æ•°çš„åç§°å’Œurlåœ°å€æ ä¸ç›¸åŒæ—¶ï¼Œå¯ä»¥é€šè¿‡RequestParam æ¥è¿›è¡ŒæŒ‡å®š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/of/follow&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogOfFollow</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@RequestParam(&quot;lastId&quot;)</span> Long max, <span class="meta">@RequestParam(value = &quot;offset&quot;, defaultValue = &quot;0&quot;)</span> Integer offset)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> blogService.queryBlogOfFollow(max, offset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cdf486cb-451e-45f1-aa05-c5341900e3aa-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogOfFollow</span><span class="params">(Long max, Integer offset)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.æŸ¥è¯¢æ”¶ä»¶ç®± ZREVRANGEBYSCORE key Max Min LIMIT offset count</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> FEED_KEY + userId;</span><br><span class="line">    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples = stringRedisTemplate.opsForZSet()</span><br><span class="line">        .reverseRangeByScoreWithScores(key, <span class="number">0</span>, max, offset, <span class="number">2</span>);</span><br><span class="line">    <span class="comment">// 3.éç©ºåˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (typedTuples == <span class="literal">null</span> || typedTuples.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.è§£ææ•°æ®ï¼šblogIdã€minTimeï¼ˆæ—¶é—´æˆ³ï¼‰ã€offset</span></span><br><span class="line">    List&lt;Long&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(typedTuples.size());</span><br><span class="line">    <span class="type">long</span> <span class="variable">minTime</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// 2</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">os</span> <span class="operator">=</span> <span class="number">1</span>; <span class="comment">// 2</span></span><br><span class="line">    <span class="keyword">for</span> (ZSetOperations.TypedTuple&lt;String&gt; tuple : typedTuples) &#123; <span class="comment">// 5 4 4 2 2</span></span><br><span class="line">        <span class="comment">// 4.1.è·å–id</span></span><br><span class="line">        ids.add(Long.valueOf(tuple.getValue()));</span><br><span class="line">        <span class="comment">// 4.2.è·å–åˆ†æ•°(æ—¶é—´æˆ³ï¼‰</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> tuple.getScore().longValue();</span><br><span class="line">        <span class="keyword">if</span>(time == minTime)&#123;</span><br><span class="line">            os++;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            minTime = time;</span><br><span class="line">            os = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">os = minTime == max ? os : os + offset;</span><br><span class="line">    <span class="comment">// 5.æ ¹æ®idæŸ¥è¯¢blog</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    List&lt;Blog&gt; blogs = query().in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Blog blog : blogs) &#123;</span><br><span class="line">        <span class="comment">// 5.1.æŸ¥è¯¢blogæœ‰å…³çš„ç”¨æˆ·</span></span><br><span class="line">        queryBlogUser(blog);</span><br><span class="line">        <span class="comment">// 5.2.æŸ¥è¯¢blogæ˜¯å¦è¢«ç‚¹èµ</span></span><br><span class="line">        isBlogLiked(blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6.å°è£…å¹¶è¿”å›</span></span><br><span class="line">    <span class="type">ScrollResult</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScrollResult</span>();</span><br><span class="line">    r.setList(blogs);</span><br><span class="line">    r.setOffset(os);</span><br><span class="line">    r.setMinTime(minTime);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.ok(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><hr><h2 id="é™„è¿‘å•†æˆ·-GEO">é™„è¿‘å•†æˆ·-GEO</h2><h3 id="GEOæ•°æ®ç»“æ„çš„åŸºæœ¬ç”¨æ³•">GEOæ•°æ®ç»“æ„çš„åŸºæœ¬ç”¨æ³•</h3><p>GEOå°±æ˜¯Geolocationçš„ç®€å†™å½¢å¼ï¼Œä»£è¡¨åœ°ç†åæ ‡ã€‚Redisåœ¨3.2ç‰ˆæœ¬ä¸­åŠ å…¥äº†å¯¹GEOçš„æ”¯æŒï¼Œå…è®¸å­˜å‚¨åœ°ç†åæ ‡ä¿¡æ¯ï¼Œå¸®åŠ©æˆ‘ä»¬æ ¹æ®ç»çº¬åº¦æ¥æ£€ç´¢æ•°æ®ã€‚å¸¸è§çš„å‘½ä»¤æœ‰ï¼š</p><ul><li>GEOADDï¼šæ·»åŠ ä¸€ä¸ªåœ°ç†ç©ºé—´ä¿¡æ¯ï¼ŒåŒ…å«ï¼šç»åº¦ï¼ˆlongitudeï¼‰ã€çº¬åº¦ï¼ˆlatitudeï¼‰ã€å€¼ï¼ˆmemberï¼‰</li><li>GEODISTï¼šè®¡ç®—æŒ‡å®šçš„ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»å¹¶è¿”å›</li><li>GEOHASHï¼šå°†æŒ‡å®šmemberçš„åæ ‡è½¬ä¸ºhashå­—ç¬¦ä¸²å½¢å¼å¹¶è¿”å›</li><li>GEOPOSï¼šè¿”å›æŒ‡å®šmemberçš„åæ ‡</li><li>GEORADIUSï¼šæŒ‡å®šåœ†å¿ƒã€åŠå¾„ï¼Œæ‰¾åˆ°è¯¥åœ†å†…åŒ…å«çš„æ‰€æœ‰memberï¼Œå¹¶æŒ‰ç…§ä¸åœ†å¿ƒä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚6.ä»¥åå·²åºŸå¼ƒ</li><li>GEOSEARCHï¼šåœ¨æŒ‡å®šèŒƒå›´å†…æœç´¢memberï¼Œå¹¶æŒ‰ç…§ä¸æŒ‡å®šç‚¹ä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚èŒƒå›´å¯ä»¥æ˜¯åœ†å½¢æˆ–çŸ©å½¢ã€‚6.2.æ–°åŠŸèƒ½</li><li>GEOSEARCHSTOREï¼šä¸GEOSEARCHåŠŸèƒ½ä¸€è‡´ï¼Œä¸è¿‡å¯ä»¥æŠŠç»“æœå­˜å‚¨åˆ°ä¸€ä¸ªæŒ‡å®šçš„keyã€‚ 6.2.æ–°åŠŸèƒ½</li></ul><mark class="hl-label blue">ç»ƒä¹ Redisçš„GEOåŠŸèƒ½</mark> <div class="tabs" id="be3f2628-88ce-4261-99aa-adfabd0d52aa"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#be3f2628-88ce-4261-99aa-adfabd0d52aa-1"><i class="fas fa-seedling"></i>éœ€æ±‚</button></li><li class="tab"><button type="button" data-href="#be3f2628-88ce-4261-99aa-adfabd0d52aa-2"><i class="fas fa-leaf"></i>æ·»åŠ æ•°æ®</button></li><li class="tab"><button type="button" data-href="#be3f2628-88ce-4261-99aa-adfabd0d52aa-3"><i class="fab fa-apple"></i>è®¡ç®—è·ç¦»</button></li><li class="tab"><button type="button" data-href="#be3f2628-88ce-4261-99aa-adfabd0d52aa-4"><i class="fas fa-tree"></i>æœç´¢</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="be3f2628-88ce-4261-99aa-adfabd0d52aa-1"><p>æ·»åŠ ä¸‹é¢å‡ æ¡æ•°æ®ï¼š</p><ul><li><p>åŒ—äº¬å—ç«™ï¼ˆ 116.378248 39.865275 ï¼‰</p></li><li><p>åŒ—äº¬ç«™ï¼ˆ 116.42803 39.903738 ï¼‰</p></li><li><p>åŒ—äº¬è¥¿ç«™ï¼ˆ 116.322287 39.893729 ï¼‰</p></li></ul><p>è®¡ç®—åŒ—äº¬è¥¿ç«™åˆ°åŒ—äº¬ç«™çš„è·ç¦»<br>æœç´¢å¤©å®‰é—¨ï¼ˆ 116.397904 39.909005 ï¼‰é™„è¿‘10kmå†…çš„æ‰€æœ‰ç«è½¦ç«™ï¼Œå¹¶æŒ‰ç…§è·ç¦»å‡åºæ’åº</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="be3f2628-88ce-4261-99aa-adfabd0d52aa-2"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt;GEOADD g1 116.378248 39.865275 bjn 116.42803 39.903738 bjz 116.322287 39.893729 bjx</span><br><span class="line">3</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> g1</span><br><span class="line">zset</span><br></pre></td></tr></table></figure><p>å…¶å†…éƒ¨å­˜å‚¨ä¸ºsortedSet</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230612083827052.png" alt="image-20230612083827052"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="be3f2628-88ce-4261-99aa-adfabd0d52aa-3"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEODIST g1 bjx bjz</span><br><span class="line"><span class="string">&quot;9091.5648&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; GEODIST g1 bjx bjz km</span><br><span class="line"><span class="string">&quot;9.0916&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="be3f2628-88ce-4261-99aa-adfabd0d52aa-4"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEOSEARCH g1 FROMLONLAT 116.397904 39.909005 BYRADIUS 10 km WITHDIST</span><br><span class="line">1) 1) <span class="string">&quot;bjz&quot;</span></span><br><span class="line">   2) <span class="string">&quot;2.6361&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;bjn&quot;</span></span><br><span class="line">   2) <span class="string">&quot;5.1452&quot;</span></span><br><span class="line">3) 1) <span class="string">&quot;bjx&quot;</span></span><br><span class="line">   2) <span class="string">&quot;6.6723&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO">å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO</h3><div class="tabs" id="9532e0ee-db13-4865-b062-daed8d75507c"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#9532e0ee-db13-4865-b062-daed8d75507c-1"><i class="fas fa-award"></i>å…·ä½“åœºæ™¯è¯´æ˜</button></li><li class="tab"><button type="button" data-href="#9532e0ee-db13-4865-b062-daed8d75507c-2"><i class="fas fa-baseball-ball"></i>å°†æ•°æ®è¿›è¡Œåˆ†ç»„</button></li><li class="tab"><button type="button" data-href="#9532e0ee-db13-4865-b062-daed8d75507c-3"><i class="fas fa-bone"></i>ä»£ç å®ç°å¯¼å…¥</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="9532e0ee-db13-4865-b062-daed8d75507c-1"><p>å½“æˆ‘ä»¬ç‚¹å‡»ç¾é£Ÿä¹‹åï¼Œä¼šå‡ºç°ä¸€ç³»åˆ—çš„å•†å®¶ï¼Œå•†å®¶ä¸­å¯ä»¥æŒ‰ç…§å¤šç§æ’åºæ–¹å¼ï¼Œæˆ‘ä»¬æ­¤æ—¶å…³æ³¨çš„æ˜¯è·ç¦»ï¼Œè¿™ä¸ªåœ°æ–¹å°±éœ€è¦ä½¿ç”¨åˆ°æˆ‘ä»¬çš„GEOï¼Œå‘åå°ä¼ å…¥å½“å‰appæ”¶é›†çš„åœ°å€(æˆ‘ä»¬æ­¤å¤„æ˜¯å†™æ­»çš„) ï¼Œä»¥å½“å‰åæ ‡ä½œä¸ºåœ†å¿ƒï¼ŒåŒæ—¶ç»‘å®šç›¸åŒçš„åº—å®¶ç±»å‹typeï¼Œä»¥åŠåˆ†é¡µä¿¡æ¯ï¼ŒæŠŠè¿™å‡ ä¸ªæ¡ä»¶ä¼ å…¥åå°ï¼Œåå°æŸ¥è¯¢å‡ºå¯¹åº”çš„æ•°æ®å†è¿”å›ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653822036941.png" alt="1653822036941" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9532e0ee-db13-4865-b062-daed8d75507c-2"><p>æˆ‘ä»¬è¦åšçš„äº‹æƒ…æ˜¯ï¼šå°†æ•°æ®åº“è¡¨ä¸­çš„æ•°æ®å¯¼å…¥åˆ°redisä¸­å»ï¼Œredisä¸­çš„GEOï¼ŒGEOåœ¨redisä¸­å°±ä¸€ä¸ªmenberå’Œä¸€ä¸ªç»çº¬åº¦ï¼Œæˆ‘ä»¬æŠŠxå’Œyè½´ä¼ å…¥åˆ°redisåšçš„ç»çº¬åº¦ä½ç½®å»ï¼Œä½†æˆ‘ä»¬ä¸èƒ½æŠŠæ‰€æœ‰çš„æ•°æ®éƒ½æ”¾å…¥åˆ°menberä¸­å»ï¼Œæ¯•ç«Ÿä½œä¸ºredisæ˜¯ä¸€ä¸ªå†…å­˜çº§æ•°æ®åº“ï¼Œå¦‚æœå­˜æµ·é‡æ•°æ®ï¼Œredisè¿˜æ˜¯åŠ›ä¸ä»å¿ƒï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™ä¸ªåœ°æ–¹å­˜å‚¨ä»–çš„idå³å¯ã€‚</p><p>ä½†æ˜¯è¿™ä¸ªæ—¶å€™è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨redisä¸­å¹¶æ²¡æœ‰å­˜å‚¨typeï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•æ ¹æ®typeæ¥å¯¹æ•°æ®è¿›è¡Œç­›é€‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŒ‰ç…§å•†æˆ·ç±»å‹åšåˆ†ç»„ï¼Œç±»å‹ç›¸åŒçš„å•†æˆ·ä½œä¸ºåŒä¸€ç»„ï¼Œä»¥typeIdä¸ºkeyå­˜å…¥åŒä¸€ä¸ªGEOé›†åˆä¸­å³å¯</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653822021827.png" alt="1653822021827" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9532e0ee-db13-4865-b062-daed8d75507c-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">loadShopData</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢åº—é“ºä¿¡æ¯</span></span><br><span class="line">    List&lt;Shop&gt; list = shopService.list();</span><br><span class="line">    <span class="comment">// 2.æŠŠåº—é“ºåˆ†ç»„ï¼ŒæŒ‰ç…§typeIdåˆ†ç»„ï¼ŒtypeIdä¸€è‡´çš„æ”¾åˆ°ä¸€ä¸ªé›†åˆ</span></span><br><span class="line">    Map&lt;Long, List&lt;Shop&gt;&gt; map = list.stream().collect(Collectors.groupingBy(Shop::getTypeId));</span><br><span class="line">    <span class="comment">// 3.åˆ†æ‰¹å®Œæˆå†™å…¥Redis</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; entry : map.entrySet()) &#123;</span><br><span class="line">        <span class="comment">// 3.1.è·å–ç±»å‹id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">typeId</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SHOP_GEO_KEY + typeId;</span><br><span class="line">        <span class="comment">// 3.2.è·å–åŒç±»å‹çš„åº—é“ºçš„é›†åˆ</span></span><br><span class="line">        List&lt;Shop&gt; value = entry.getValue();</span><br><span class="line">        List&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; locations = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(value.size());</span><br><span class="line">        <span class="comment">// 3.3.å†™å…¥redis GEOADD key ç»åº¦ çº¬åº¦ member</span></span><br><span class="line">        <span class="keyword">for</span> (Shop shop : value) &#123;</span><br><span class="line">            <span class="comment">// stringRedisTemplate.opsForGeo().add(key, new Point(shop.getX(), shop.getY()), shop.getId().toString());</span></span><br><span class="line">            locations.add(<span class="keyword">new</span> <span class="title class_">RedisGeoCommands</span>.GeoLocation&lt;&gt;(</span><br><span class="line">                    shop.getId().toString(),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Point</span>(shop.getX(), shop.getY())</span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line">        stringRedisTemplate.opsForGeo().add(key, locations);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½">å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½</h3><div class="tabs" id="2a724b43-d390-4eb3-b4bb-dd8fafbbd2b1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2a724b43-d390-4eb3-b4bb-dd8fafbbd2b1-1"><i class="fas fa-bug"></i>ä¿®æ”¹pomæ–‡ä»¶</button></li><li class="tab"><button type="button" data-href="#2a724b43-d390-4eb3-b4bb-dd8fafbbd2b1-2"><i class="fas fa-cannabis"></i>ShopController</button></li><li class="tab"><button type="button" data-href="#2a724b43-d390-4eb3-b4bb-dd8fafbbd2b1-3"><i class="fas fa-candy-cane"></i>ShopServiceImpl</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2a724b43-d390-4eb3-b4bb-dd8fafbbd2b1-1"><p>SpringDataRedisçš„2.3.9ç‰ˆæœ¬å¹¶ä¸æ”¯æŒRedis 6.2æä¾›çš„GEOSEARCHå‘½ä»¤ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æç¤ºå…¶ç‰ˆæœ¬ï¼Œä¿®æ”¹è‡ªå·±çš„POM</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2a724b43-d390-4eb3-b4bb-dd8fafbbd2b1-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/of/type&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopByType</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(&quot;typeId&quot;)</span> Integer typeId,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;x&quot;, required = false)</span> Double x,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;y&quot;, required = false)</span> Double y</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> shopService.queryShopByType(typeId, current, x, y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2a724b43-d390-4eb3-b4bb-dd8fafbbd2b1-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryShopByType</span><span class="params">(Integer typeId, Integer current, Double x, Double y)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.åˆ¤æ–­æ˜¯å¦éœ€è¦æ ¹æ®åæ ‡æŸ¥è¯¢</span></span><br><span class="line">        <span class="keyword">if</span> (x == <span class="literal">null</span> || y == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// ä¸éœ€è¦åæ ‡æŸ¥è¯¢ï¼ŒæŒ‰æ•°æ®åº“æŸ¥è¯¢</span></span><br><span class="line">            Page&lt;Shop&gt; page = query()</span><br><span class="line">                    .eq(<span class="string">&quot;type_id&quot;</span>, typeId)</span><br><span class="line">                    .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));</span><br><span class="line">            <span class="comment">// è¿”å›æ•°æ®</span></span><br><span class="line">            <span class="keyword">return</span> Result.ok(page.getRecords());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.è®¡ç®—åˆ†é¡µå‚æ•°</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">from</span> <span class="operator">=</span> (current - <span class="number">1</span>) * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line">        <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> current * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.æŸ¥è¯¢redisã€æŒ‰ç…§è·ç¦»æ’åºã€åˆ†é¡µã€‚ç»“æœï¼šshopIdã€distance</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SHOP_GEO_KEY + typeId;</span><br><span class="line">        GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo() <span class="comment">// GEOSEARCH key BYLONLAT x y BYRADIUS 10 WITHDISTANCE</span></span><br><span class="line">                .search(</span><br><span class="line">                        key,</span><br><span class="line">                        GeoReference.fromCoordinate(x, y),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Distance</span>(<span class="number">5000</span>),</span><br><span class="line">                        RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs().includeDistance().limit(end)</span><br><span class="line">                );</span><br><span class="line">        <span class="comment">// 4.è§£æå‡ºid</span></span><br><span class="line">        <span class="keyword">if</span> (results == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; list = results.getContent();</span><br><span class="line">        <span class="keyword">if</span> (list.size() &lt;= from) &#123;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰ä¸‹ä¸€é¡µäº†ï¼Œç»“æŸ</span></span><br><span class="line">            <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.1.æˆªå– from ~ endçš„éƒ¨åˆ†</span></span><br><span class="line">        List&lt;Long&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(list.size());</span><br><span class="line">        Map&lt;String, Distance&gt; distanceMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(list.size());</span><br><span class="line">        list.stream().skip(from).forEach(result -&gt; &#123;</span><br><span class="line">            <span class="comment">// 4.2.è·å–åº—é“ºid</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">shopIdStr</span> <span class="operator">=</span> result.getContent().getName();</span><br><span class="line">            ids.add(Long.valueOf(shopIdStr));</span><br><span class="line">            <span class="comment">// 4.3.è·å–è·ç¦»</span></span><br><span class="line">            <span class="type">Distance</span> <span class="variable">distance</span> <span class="operator">=</span> result.getDistance();</span><br><span class="line">            distanceMap.put(shopIdStr, distance);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 5.æ ¹æ®idæŸ¥è¯¢Shop</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">        List&lt;Shop&gt; shops = query().in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line">        <span class="keyword">for</span> (Shop shop : shops) &#123;</span><br><span class="line">            shop.setDistance(distanceMap.get(shop.getId().toString()).getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 6.è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(shops);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="ç”¨æˆ·ç­¾åˆ°-BitMap">ç”¨æˆ·ç­¾åˆ°-BitMap</h2><h3 id="BitMapåŠŸèƒ½æ¼”ç¤º">BitMapåŠŸèƒ½æ¼”ç¤º</h3><p>æˆ‘ä»¬é’ˆå¯¹ç­¾åˆ°åŠŸèƒ½å®Œå…¨å¯ä»¥é€šè¿‡mysqlæ¥å®Œæˆï¼Œæ¯”å¦‚è¯´ä»¥ä¸‹è¿™å¼ è¡¨</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653823145495.png" alt="1653823145495"></p><p>ç”¨æˆ·ä¸€æ¬¡ç­¾åˆ°ï¼Œå°±æ˜¯ä¸€æ¡è®°å½•ï¼Œå‡å¦‚æœ‰1000ä¸‡ç”¨æˆ·ï¼Œå¹³å‡æ¯äººæ¯å¹´ç­¾åˆ°æ¬¡æ•°ä¸º10æ¬¡ï¼Œåˆ™è¿™å¼ è¡¨ä¸€å¹´çš„æ•°æ®é‡ä¸º 1äº¿æ¡</p><p>æ¯ç­¾åˆ°ä¸€æ¬¡éœ€è¦ä½¿ç”¨ï¼ˆ8 + 8 + 1 + 1 + 3 + 1ï¼‰å…±22 å­—èŠ‚çš„å†…å­˜ï¼Œä¸€ä¸ªæœˆåˆ™æœ€å¤šéœ€è¦600å¤šå­—èŠ‚</p><p>æˆ‘ä»¬å¦‚ä½•èƒ½å¤Ÿç®€åŒ–ä¸€ç‚¹å‘¢ï¼Ÿå…¶å®å¯ä»¥è€ƒè™‘å°æ—¶å€™ä¸€ä¸ªæŒºå¸¸è§çš„æ–¹æ¡ˆï¼Œå°±æ˜¯å°æ—¶å€™ï¼Œå’±ä»¬å‡†å¤‡ä¸€å¼ å°å°çš„å¡ç‰‡ï¼Œä½ åªè¦ç­¾åˆ°å°±æ‰“ä¸Šä¸€ä¸ªå‹¾ï¼Œæˆ‘æœ€ååˆ¤æ–­ä½ æ˜¯å¦ç­¾åˆ°ï¼Œå…¶å®åªéœ€è¦åˆ°å°å¡ç‰‡ä¸Šçœ‹ä¸€çœ‹å°±çŸ¥é“äº†</p><p>æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ç±»ä¼¼è¿™æ ·çš„æ–¹æ¡ˆæ¥å®ç°æˆ‘ä»¬çš„ç­¾åˆ°éœ€æ±‚ã€‚</p><p>æˆ‘ä»¬æŒ‰æœˆæ¥ç»Ÿè®¡ç”¨æˆ·ç­¾åˆ°ä¿¡æ¯ï¼Œç­¾åˆ°è®°å½•ä¸º1ï¼Œæœªç­¾åˆ°åˆ™è®°å½•ä¸º0.</p><p>æŠŠæ¯ä¸€ä¸ªbitä½å¯¹åº”å½“æœˆçš„æ¯ä¸€å¤©ï¼Œå½¢æˆäº†æ˜ å°„å…³ç³»ã€‚ç”¨0å’Œ1æ ‡ç¤ºä¸šåŠ¡çŠ¶æ€ï¼Œè¿™ç§æ€è·¯å°±ç§°ä¸ºä½å›¾ï¼ˆBitMapï¼‰ã€‚è¿™æ ·æˆ‘ä»¬å°±ç”¨æå°çš„ç©ºé—´ï¼Œæ¥å®ç°äº†å¤§é‡æ•°æ®çš„è¡¨ç¤º</p><p>Redisä¸­æ˜¯åˆ©ç”¨stringç±»å‹æ•°æ®ç»“æ„å®ç°BitMapï¼Œå› æ­¤æœ€å¤§ä¸Šé™æ˜¯512Mï¼Œè½¬æ¢ä¸ºbitåˆ™æ˜¯ 2^32ä¸ªbitä½ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653824498278.png" alt="1653824498278"></p><p>BitMapçš„æ“ä½œå‘½ä»¤æœ‰ï¼š</p><ul><li>SETBITï¼šå‘æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰å­˜å…¥ä¸€ä¸ª0æˆ–1</li><li>GETBIT ï¼šè·å–æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰çš„bitå€¼</li><li>BITCOUNT ï¼šç»Ÿè®¡BitMapä¸­å€¼ä¸º1çš„bitä½çš„æ•°é‡</li><li>BITFIELD ï¼šæ“ä½œï¼ˆæŸ¥è¯¢ã€ä¿®æ”¹ã€è‡ªå¢ï¼‰BitMapä¸­bitæ•°ç»„ä¸­çš„æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰çš„å€¼</li><li>BITFIELD_RO ï¼šè·å–BitMapä¸­bitæ•°ç»„ï¼Œå¹¶ä»¥åè¿›åˆ¶å½¢å¼è¿”å›</li><li>BITOP ï¼šå°†å¤šä¸ªBitMapçš„ç»“æœåšä½è¿ç®—ï¼ˆä¸ ã€æˆ–ã€å¼‚æˆ–ï¼‰</li><li>BITPOS ï¼šæŸ¥æ‰¾bitæ•°ç»„ä¸­æŒ‡å®šèŒƒå›´å†…ç¬¬ä¸€ä¸ª0æˆ–1å‡ºç°çš„ä½ç½®</li></ul><hr><h3 id="ç­¾åˆ°åŠŸèƒ½">ç­¾åˆ°åŠŸèƒ½</h3><div class="tabs" id="d58e03cd-0d6f-440a-b95c-765f4d71de34"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d58e03cd-0d6f-440a-b95c-765f4d71de34-1"><i class="fas fa-atom"></i>éœ€æ±‚</button></li><li class="tab"><button type="button" data-href="#d58e03cd-0d6f-440a-b95c-765f4d71de34-2"><i class="far fa-sun"></i>UserController</button></li><li class="tab"><button type="button" data-href="#d58e03cd-0d6f-440a-b95c-765f4d71de34-3"><i class="fas fa-wind"></i>UserServiceImpl</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d58e03cd-0d6f-440a-b95c-765f4d71de34-1"><p>éœ€æ±‚ï¼šå®ç°ç­¾åˆ°æ¥å£ï¼Œå°†å½“å‰ç”¨æˆ·å½“å¤©ç­¾åˆ°ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</p><p>æ€è·¯ï¼šæˆ‘ä»¬å¯ä»¥æŠŠå¹´å’Œæœˆä½œä¸ºbitMapçš„keyï¼Œç„¶åä¿å­˜åˆ°ä¸€ä¸ªbitMapä¸­ï¼Œæ¯æ¬¡ç­¾åˆ°å°±åˆ°å¯¹åº”çš„ä½ä¸ŠæŠŠæ•°å­—ä»0å˜æˆ1ï¼Œåªè¦å¯¹åº”æ˜¯1ï¼Œå°±è¡¨æ˜è¯´æ˜è¿™ä¸€å¤©å·²ç»ç­¾åˆ°äº†ï¼Œåä¹‹åˆ™æ²¡æœ‰ç­¾åˆ°ã€‚</p><p>æˆ‘ä»¬é€šè¿‡æ¥å£æ–‡æ¡£å‘ç°ï¼Œæ­¤æ¥å£å¹¶æ²¡æœ‰ä¼ é€’ä»»ä½•çš„å‚æ•°ï¼Œæ²¡æœ‰å‚æ•°æ€ä¹ˆç¡®å®æ˜¯å“ªä¸€å¤©ç­¾åˆ°å‘¢ï¼Ÿè¿™ä¸ªå¾ˆå®¹æ˜“ï¼Œå¯ä»¥é€šè¿‡åå°ä»£ç ç›´æ¥è·å–å³å¯ï¼Œç„¶ååˆ°å¯¹åº”çš„åœ°å€ä¸Šå»ä¿®æ”¹bitMapã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653833970361.png" alt="1653833970361" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d58e03cd-0d6f-440a-b95c-765f4d71de34-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/sign&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> userService.sign();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d58e03cd-0d6f-440a-b95c-765f4d71de34-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.è·å–æ—¥æœŸ</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">// 3.æ‹¼æ¥key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">keySuffix</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">// 4.è·å–ä»Šå¤©æ˜¯æœ¬æœˆçš„ç¬¬å‡ å¤©</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dayOfMonth</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">    <span class="comment">// 5.å†™å…¥Redis SETBIT key offset 1</span></span><br><span class="line">    stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="ç­¾åˆ°ç»Ÿè®¡">ç­¾åˆ°ç»Ÿè®¡</h3><div class="tabs" id="ab69da0a-f994-436f-ae40-68f5398abfc0"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ab69da0a-f994-436f-ae40-68f5398abfc0-1"><i class="fas fa-award"></i>é—®é¢˜åˆ†æ</button></li><li class="tab"><button type="button" data-href="#ab69da0a-f994-436f-ae40-68f5398abfc0-2"><i class="fas fa-baseball-ball"></i>UserController</button></li><li class="tab"><button type="button" data-href="#ab69da0a-f994-436f-ae40-68f5398abfc0-3"><i class="fas fa-bone"></i>UserServiceImpl</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ab69da0a-f994-436f-ae40-68f5398abfc0-1"><blockquote><p>é—®é¢˜1ï¼šä»€ä¹ˆå«åšè¿ç»­ç­¾åˆ°å¤©æ•°ï¼Ÿ</p></blockquote><p>ä»æœ€åä¸€æ¬¡ç­¾åˆ°å¼€å§‹å‘å‰ç»Ÿè®¡ï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€æ¬¡æœªç­¾åˆ°ä¸ºæ­¢ï¼Œè®¡ç®—æ€»çš„ç­¾åˆ°æ¬¡æ•°ï¼Œå°±æ˜¯è¿ç»­ç­¾åˆ°å¤©æ•°ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653834455899.png" alt="1653834455899"></p><p>Javaé€»è¾‘ä»£ç ï¼šè·å¾—å½“å‰è¿™ä¸ªæœˆçš„æœ€åä¸€æ¬¡ç­¾åˆ°æ•°æ®ï¼Œå®šä¹‰ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç„¶åä¸åœçš„å‘å‰ç»Ÿè®¡ï¼Œç›´åˆ°è·å¾—ç¬¬ä¸€ä¸ªé0çš„æ•°å­—å³å¯ï¼Œæ¯å¾—åˆ°ä¸€ä¸ªé0çš„æ•°å­—è®¡æ•°å™¨+1ï¼Œç›´åˆ°éå†å®Œæ‰€æœ‰çš„æ•°æ®ï¼Œå°±å¯ä»¥è·å¾—å½“å‰æœˆçš„ç­¾åˆ°æ€»å¤©æ•°äº†</p><blockquote><p>é—®é¢˜2ï¼šå¦‚ä½•å¾—åˆ°æœ¬æœˆåˆ°ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰ç­¾åˆ°æ•°æ®ï¼Ÿ</p></blockquote><p><code>BITFIELD key GET u[dayOfMonth] 0</code></p><p>å‡è®¾ä»Šå¤©æ˜¯10å·ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä»å½“å‰æœˆçš„ç¬¬ä¸€å¤©å¼€å§‹ï¼Œè·å¾—åˆ°å½“å‰è¿™ä¸€å¤©çš„ä½æ•°ï¼Œæ˜¯10å·ï¼Œé‚£ä¹ˆå°±æ˜¯10ä½ï¼Œå»æ‹¿è¿™æ®µæ—¶é—´çš„æ•°æ®ï¼Œå°±èƒ½æ‹¿åˆ°æ‰€æœ‰çš„æ•°æ®äº†ï¼Œé‚£ä¹ˆè¿™10å¤©é‡Œè¾¹ç­¾åˆ°äº†å¤šå°‘æ¬¡å‘¢ï¼Ÿç»Ÿè®¡æœ‰å¤šå°‘ä¸ª1å³å¯ã€‚</p><blockquote><p>é—®é¢˜3ï¼šå¦‚ä½•ä»åå‘å‰éå†æ¯ä¸ªbitä½ï¼Ÿ</p></blockquote><p>æ³¨æ„ï¼šbitMapè¿”å›çš„æ•°æ®æ˜¯10è¿›åˆ¶ï¼Œå“ªå‡å¦‚è¯´è¿”å›ä¸€ä¸ªæ•°å­—8ï¼Œé‚£ä¹ˆæˆ‘å“ªå„¿çŸ¥é“åˆ°åº•å“ªäº›æ˜¯0ï¼Œå“ªäº›æ˜¯1å‘¢ï¼Ÿæˆ‘ä»¬åªéœ€è¦è®©å¾—åˆ°çš„10è¿›åˆ¶æ•°å­—å’Œ1åšä¸è¿ç®—å°±å¯ä»¥äº†ï¼Œå› ä¸º1åªæœ‰é‡è§1 æ‰æ˜¯1ï¼Œå…¶ä»–æ•°å­—éƒ½æ˜¯0 ï¼Œæˆ‘ä»¬æŠŠç­¾åˆ°ç»“æœå’Œ1è¿›è¡Œä¸æ“ä½œï¼Œæ¯ä¸ä¸€æ¬¡ï¼Œå°±æŠŠç­¾åˆ°ç»“æœå‘å³ç§»åŠ¨ä¸€ä½ï¼Œä¾æ¬¡å†…æ¨ï¼Œæˆ‘ä»¬å°±èƒ½å®Œæˆé€ä¸ªéå†çš„æ•ˆæœäº†ã€‚</p><p>éœ€æ±‚ï¼šå®ç°ä¸‹é¢æ¥å£ï¼Œç»Ÿè®¡å½“å‰ç”¨æˆ·æˆªæ­¢å½“å‰æ—¶é—´åœ¨æœ¬æœˆçš„è¿ç»­ç­¾åˆ°å¤©æ•°</p><p>æœ‰ç”¨æˆ·æœ‰æ—¶é—´æˆ‘ä»¬å°±å¯ä»¥ç»„ç»‡å‡ºå¯¹åº”çš„keyï¼Œæ­¤æ—¶å°±èƒ½æ‰¾åˆ°è¿™ä¸ªç”¨æˆ·æˆªæ­¢è¿™å¤©çš„æ‰€æœ‰ç­¾åˆ°è®°å½•ï¼Œå†æ ¹æ®è¿™å¥—ç®—æ³•ï¼Œå°±èƒ½ç»Ÿè®¡å‡ºæ¥ä»–è¿ç»­ç­¾åˆ°çš„æ¬¡æ•°äº†</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653835784444.png" alt="1653835784444"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ab69da0a-f994-436f-ae40-68f5398abfc0-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/sign/count&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">signCount</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userService.signCount();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ab69da0a-f994-436f-ae40-68f5398abfc0-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">signCount</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.è·å–æ—¥æœŸ</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">// 3.æ‹¼æ¥key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">keySuffix</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">// 4.è·å–ä»Šå¤©æ˜¯æœ¬æœˆçš„ç¬¬å‡ å¤©</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dayOfMonth</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">    <span class="comment">// 5.è·å–æœ¬æœˆæˆªæ­¢ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰çš„ç­¾åˆ°è®°å½•ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªåè¿›åˆ¶çš„æ•°å­— BITFIELD sign:5:202203 GET u14 0</span></span><br><span class="line">    List&lt;Long&gt; result = stringRedisTemplate.opsForValue().bitField(</span><br><span class="line">            key,</span><br><span class="line">            BitFieldSubCommands.create()</span><br><span class="line">                    .get(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth)).valueAt(<span class="number">0</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span> || result.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰ä»»ä½•ç­¾åˆ°ç»“æœ</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">num</span> <span class="operator">=</span> result.get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (num == <span class="literal">null</span> || num == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6.å¾ªç¯éå†</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// 6.1.è®©è¿™ä¸ªæ•°å­—ä¸1åšä¸è¿ç®—ï¼Œå¾—åˆ°æ•°å­—çš„æœ€åä¸€ä¸ªbitä½  // åˆ¤æ–­è¿™ä¸ªbitä½æ˜¯å¦ä¸º0</span></span><br><span class="line">        <span class="keyword">if</span> ((num &amp; <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸º0ï¼Œè¯´æ˜æœªç­¾åˆ°ï¼Œç»“æŸ</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸ä¸º0ï¼Œè¯´æ˜å·²ç­¾åˆ°ï¼Œè®¡æ•°å™¨+1</span></span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŠŠæ•°å­—å³ç§»ä¸€ä½ï¼ŒæŠ›å¼ƒæœ€åä¸€ä¸ªbitä½ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªbitä½</span></span><br><span class="line">        num &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><hr><h2 id="UVç»Ÿè®¡-HyperLogLog">UVç»Ÿè®¡-HyperLogLog</h2><p>é¦–å…ˆæˆ‘ä»¬ææ‡‚ä¸¤ä¸ªæ¦‚å¿µï¼š</p><ul><li>UVï¼šå…¨ç§°Unique Visitorï¼Œä¹Ÿå«ç‹¬ç«‹è®¿å®¢é‡ï¼Œæ˜¯æŒ‡é€šè¿‡äº’è”ç½‘è®¿é—®ã€æµè§ˆè¿™ä¸ªç½‘é¡µçš„è‡ªç„¶äººã€‚1å¤©å†…åŒä¸€ä¸ªç”¨æˆ·å¤šæ¬¡è®¿é—®è¯¥ç½‘ç«™ï¼Œåªè®°å½•1æ¬¡ã€‚</li><li>PVï¼šå…¨ç§°Page Viewï¼Œä¹Ÿå«é¡µé¢è®¿é—®é‡æˆ–ç‚¹å‡»é‡ï¼Œç”¨æˆ·æ¯è®¿é—®ç½‘ç«™çš„ä¸€ä¸ªé¡µé¢ï¼Œè®°å½•1æ¬¡PVï¼Œç”¨æˆ·å¤šæ¬¡æ‰“å¼€é¡µé¢ï¼Œåˆ™è®°å½•å¤šæ¬¡PVã€‚å¾€å¾€ç”¨æ¥è¡¡é‡ç½‘ç«™çš„æµé‡ã€‚</li></ul><p>é€šå¸¸æ¥è¯´UVä¼šæ¯”PVå¤§å¾ˆå¤šï¼Œæ‰€ä»¥è¡¡é‡åŒä¸€ä¸ªç½‘ç«™çš„è®¿é—®é‡ï¼Œæˆ‘ä»¬éœ€è¦ç»¼åˆè€ƒè™‘å¾ˆå¤šå› ç´ ï¼Œæ‰€ä»¥æˆ‘ä»¬åªæ˜¯å•çº¯çš„æŠŠè¿™ä¸¤ä¸ªå€¼ä½œä¸ºä¸€ä¸ªå‚è€ƒå€¼</p><p>UVç»Ÿè®¡åœ¨æœåŠ¡ç«¯åšä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºè¦åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦å·²ç»ç»Ÿè®¡è¿‡äº†ï¼Œéœ€è¦å°†ç»Ÿè®¡è¿‡çš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜ã€‚ä½†æ˜¯å¦‚æœæ¯ä¸ªè®¿é—®çš„ç”¨æˆ·éƒ½ä¿å­˜åˆ°Redisä¸­ï¼Œæ•°æ®é‡ä¼šéå¸¸ææ€–ï¼Œé‚£æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p><p>Hyperloglog(HLL)æ˜¯ä»Loglogç®—æ³•æ´¾ç”Ÿçš„æ¦‚ç‡ç®—æ³•ï¼Œç”¨äºç¡®å®šéå¸¸å¤§çš„é›†åˆçš„åŸºæ•°ï¼Œè€Œä¸éœ€è¦å­˜å‚¨å…¶æ‰€æœ‰å€¼ã€‚ç›¸å…³ç®—æ³•åŸç†å¤§å®¶å¯ä»¥å‚è€ƒï¼š<a href="https://juejin.cn/post/6844903785744056333#heading-0">https://juejin.cn/post/6844903785744056333#heading-0</a><br>Redisä¸­çš„HLLæ˜¯åŸºäºstringç»“æ„å®ç°çš„ï¼Œ<span class='p red'>å•ä¸ªHLLçš„å†…å­˜æ°¸è¿œå°äº16kb**ï¼Œ**å†…å­˜å ç”¨ä½çš„ä»¤äººå‘æŒ‡ï¼</span>ä½œä¸ºä»£ä»·ï¼Œå…¶æµ‹é‡ç»“æœæ˜¯æ¦‚ç‡æ€§çš„ï¼Œ<span class='p blue'>æœ‰å°äº0.81ï¼…çš„è¯¯å·®ã€‚</span>ä¸è¿‡å¯¹äºUVç»Ÿè®¡æ¥è¯´ï¼Œè¿™å®Œå…¨å¯ä»¥å¿½ç•¥ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653837988985.png" alt="1653837988985"></p><p>æµ‹è¯•æ€è·¯ï¼šæˆ‘ä»¬ç›´æ¥åˆ©ç”¨å•å…ƒæµ‹è¯•ï¼Œå‘HyperLogLogä¸­æ·»åŠ 100ä¸‡æ¡æ•°æ®ï¼Œçœ‹çœ‹å†…å­˜å ç”¨å’Œç»Ÿè®¡æ•ˆæœå¦‚ä½•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testHyperLogLog</span><span class="params">()</span> &#123;</span><br><span class="line">    String[] users = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">1000</span>];</span><br><span class="line">    <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">        j = i % <span class="number">1000</span>;</span><br><span class="line">        users[j] = <span class="string">&quot;user_&quot;</span> + i;</span><br><span class="line">        <span class="keyword">if</span> (j == <span class="number">999</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForHyperLogLog().add(<span class="string">&quot;HLL&quot;</span>, users);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> stringRedisTemplate.opsForHyperLogLog().size(<span class="string">&quot;HLL&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;count = &quot;</span> + count);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//count = 997593</span></span><br></pre></td></tr></table></figure><p>ç»è¿‡æµ‹è¯•ï¼šæˆ‘ä»¬ä¼šå‘ç”Ÿä»–çš„è¯¯å·®æ˜¯åœ¨å…è®¸èŒƒå›´å†…ï¼Œå¹¶ä¸”å†…å­˜å ç”¨æå°</p>]]></content>
    
    
    <summary type="html">ç¼“å­˜ã€ç§’æ€ã€åˆ†å¸ƒå¼é”redissonã€ç‚¹èµã€å…±åŒå…³æ³¨ã€GEOã€BitMapã€HyperLogLog</summary>
    
    
    
    <category term="æ•°æ®åº“" scheme="https://wuwawawa.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="Redis" scheme="https://wuwawawa.github.io/tags/Redis/"/>
    
    <category term="æ•°æ®åº“" scheme="https://wuwawawa.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>RedisåŸºç¡€</title>
    <link href="https://wuwawawa.github.io/posts/6dfcb629.html"/>
    <id>https://wuwawawa.github.io/posts/6dfcb629.html</id>
    <published>2023-06-06T01:14:58.000Z</published>
    <updated>2023-06-07T02:21:05.707Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Rediså…¥é—¨">Rediså…¥é—¨</h2><h3 id="ä»€ä¹ˆæ˜¯NoSQL">ä»€ä¹ˆæ˜¯NoSQL</h3><ul><li>NoSQLæœ€å¸¸è§çš„è§£é‡Šæ˜¯&quot;<code>non-relational</code>&quot;ï¼Œ å¾ˆå¤šäººä¹Ÿè¯´å®ƒæ˜¯&quot;<span class='p green'>Not Only SQL</span>&quot;</li><li>NoSQLä»…ä»…æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œæ³›æŒ‡<span class='p blue'>éå…³ç³»å‹çš„æ•°æ®åº“</span></li><li>åŒºåˆ«äºå…³ç³»æ•°æ®åº“ï¼Œå®ƒä»¬ä¸ä¿è¯å…³ç³»æ•°æ®çš„ACIDç‰¹æ€§</li><li>NoSQLæ˜¯ä¸€é¡¹å…¨æ–°çš„æ•°æ®åº“é©å‘½æ€§è¿åŠ¨ï¼Œæå€¡è¿ç”¨éå…³ç³»å‹çš„æ•°æ®å­˜å‚¨ï¼Œç›¸å¯¹äºé“ºå¤©ç›–åœ°çš„å…³ç³»å‹æ•°æ®åº“è¿ç”¨ï¼Œè¿™ä¸€æ¦‚å¿µæ— ç–‘æ˜¯ä¸€ç§å…¨æ–°çš„æ€ç»´çš„æ³¨å…¥</li><li>å¸¸è§çš„NoSQLæ•°æ®åº“æœ‰ï¼š<code>Redis</code>ã€<code>MemCache</code>ã€<code>MongoDB</code>ç­‰</li></ul><hr><h3 id="NoSQLä¸SQLçš„å·®å¼‚">NoSQLä¸SQLçš„å·®å¼‚</h3><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">SQL</th><th style="text-align:center">NoSQL</th></tr></thead><tbody><tr><td style="text-align:center">æ•°æ®ç»“æ„</td><td style="text-align:center">ç»“æ„åŒ–</td><td style="text-align:center">éç»“æ„åŒ–</td></tr><tr><td style="text-align:center">æ•°æ®å…³è”</td><td style="text-align:center">å…³è”çš„</td><td style="text-align:center">æ— å…³è”çš„</td></tr><tr><td style="text-align:center">æŸ¥è¯¢æ–¹å¼</td><td style="text-align:center">SQLæŸ¥è¯¢</td><td style="text-align:center">éSQL</td></tr><tr><td style="text-align:center">äº‹åŠ¡ç‰¹æ€§</td><td style="text-align:center">ACID</td><td style="text-align:center">BASE</td></tr><tr><td style="text-align:center">å­˜å‚¨æ–¹å¼</td><td style="text-align:center">ç£ç›˜</td><td style="text-align:center">å†…å­˜</td></tr><tr><td style="text-align:center">æ‰©å±•æ€§</td><td style="text-align:center">å‚ç›´</td><td style="text-align:center">æ°´å¹³</td></tr><tr><td style="text-align:center">ä½¿ç”¨åœºæ™¯</td><td style="text-align:center">1ï¼‰æ•°æ®ç»“æ„å›ºå®š<br>2ï¼‰ç›¸å…³ä¸šåŠ¡å¯¹æ•°æ®å®‰å…¨æ€§ã€ä¸€è‡´æ€§è¦æ±‚è¾ƒé«˜</td><td style="text-align:center">1ï¼‰æ•°æ®ç»“æ„ä¸å›ºå®š<br>2ï¼‰å¯¹ä¸€è‡´æ€§ã€å®‰å…¨æ€§è¦æ±‚ä¸é«˜<br>3ï¼‰å¯¹æ€§èƒ½è¦æ±‚</td></tr></tbody></table><hr><h3 id="è®¤è¯†Redis">è®¤è¯†Redis</h3><blockquote><p>Redisè¯ç”Ÿäº2009å¹´å…¨ç§°æ˜¯Remote Dictionary Serverï¼Œè¿œç¨‹è¯å…¸æœåŠ¡å™¨ï¼Œæ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„é”®å€¼å‹NoSQLæ•°æ®åº“ã€‚</p></blockquote><mark class="hl-label blue">Redisçš„ç‰¹å¾ï¼š</mark> <ul><li>é”®å€¼ï¼ˆ<code>key-value</code>ï¼‰å‹ï¼Œvalueæ”¯æŒå¤šç§ä¸åŒæ•°æ®ç»“æ„ï¼ŒåŠŸèƒ½ä¸°å¯Œ</li><li>å•çº¿ç¨‹ï¼Œæ¯ä¸ªå‘½ä»¤å…·å¤‡åŸå­æ€§</li><li>ä½å»¶è¿Ÿï¼Œé€Ÿåº¦å¿«ï¼ˆåŸºäºå†…å­˜ã€IOå¤šè·¯å¤ç”¨ã€è‰¯å¥½çš„ç¼–ç ï¼‰ã€‚</li><li>æ”¯æŒæ•°æ®æŒä¹…åŒ–</li><li>æ”¯æŒä¸»ä»é›†ç¾¤ã€åˆ†ç‰‡é›†ç¾¤</li><li>æ”¯æŒå¤šè¯­è¨€å®¢æˆ·ç«¯</li></ul><hr><h3 id="å•çº¿ç¨‹æ¶æ„">å•çº¿ç¨‹æ¶æ„</h3><p>Redisä½¿ç”¨äº†<span class='p blue'>å•çº¿ç¨‹æ¶æ„</span>å’Œ<span class='p green'>I/Oå¤šè·¯å¤ç”¨æ¨¡å‹</span>æ¥å®ç°é«˜æ€§èƒ½çš„å†…å­˜æ•°æ®åº“æœåŠ¡ã€‚</p><div class="tabs" id="6f10bb80-30b4-4dbd-9043-37cd961f9301"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6f10bb80-30b4-4dbd-9043-37cd961f9301-1"><i class="fas fa-award"></i>1</button></li><li class="tab"><button type="button" data-href="#6f10bb80-30b4-4dbd-9043-37cd961f9301-2"><i class="fas fa-baseball-ball"></i>2</button></li><li class="tab"><button type="button" data-href="#6f10bb80-30b4-4dbd-9043-37cd961f9301-3"><i class="fas fa-bone"></i>3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6f10bb80-30b4-4dbd-9043-37cd961f9301-1"><p>Redis å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„æ¨¡å‹å¯ä»¥ç®€åŒ–æˆä¸‹å›¾, æ¯æ¬¡å®¢æˆ·ç«¯è°ƒç”¨éƒ½ç»å†äº†å‘é€å‘½ä»¤ã€æ‰§è¡Œå‘½ä»¤ã€è¿”å›ç»“æœä¸‰ä¸ªè¿‡ç¨‹ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/Redis%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg" alt="Redisæµç¨‹å›¾" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6f10bb80-30b4-4dbd-9043-37cd961f9301-2"><p>å…¶ä¸­ç¬¬2æ­¥æ˜¯é‡ç‚¹è¦è®¨è®ºçš„ï¼Œå› ä¸ºRedis æ˜¯å•çº¿ç¨‹æ¥å¤„ç†å‘½ä»¤çš„ï¼Œæ‰€ä»¥ä¸€æ¡å‘½ä»¤ä»å®¢æˆ·ç«¯è¾¾åˆ°æœåŠ¡ç«¯ä¸ä¼šç«‹åˆ»è¢«æ‰§è¡Œï¼Œæ‰€æœ‰å‘½ä»¤éƒ½ä¼šè¿›å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åé€ä¸ªè¢«æ‰§è¡Œã€‚</p><p>å‘é€å‘½ä»¤ã€è¿”å›ç»“æœã€å‘½ä»¤æ’é˜Ÿè‚¯å®šä¸åƒæè¿°çš„è¿™ä¹ˆç®€å•ï¼Œ Redisä½¿ç”¨äº†I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯æ¥è§£å†³I/Oçš„é—®é¢˜</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/Redis%E5%91%BD%E4%BB%A4%E9%98%9F%E5%88%971.jpg" alt="Rediså‘½ä»¤é˜Ÿåˆ—1" style="zoom: 67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6f10bb80-30b4-4dbd-9043-37cd961f9301-3"><p>å‘½ä»¤çš„æ‰§è¡Œé¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼Œä½†æ˜¯å¯ä»¥ç¡®å®šä¸ä¼šæœ‰ä¸¤æ¡å‘½ä»¤è¢«åŒæ—¶æ‰§è¡Œã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/Redis%E5%91%BD%E4%BB%A4%E9%98%9F%E5%88%973.jpg" alt="Rediså‘½ä»¤é˜Ÿåˆ—3" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <blockquote><p>ä¸ºä»€ä¹ˆå•çº¿ç¨‹è¿˜èƒ½è¿™ä¹ˆå¿«</p></blockquote><p>é€šå¸¸æ¥è®²ï¼Œå•çº¿ç¨‹å¤„ç†èƒ½åŠ›è¦æ¯”å¤šçº¿ç¨‹å·®ï¼Œä¾‹å¦‚æœ‰10000æ–¤è´§ç‰©ï¼Œæ¯è¾†è½¦çš„è¿è½½èƒ½åŠ›æ˜¯æ¯æ¬¡200æ–¤ï¼Œé‚£ä¹ˆè¦50æ¬¡æ‰èƒ½å®Œæˆï¼Œä½†æ˜¯å¦‚æœæœ‰50è¾†è½¦ï¼Œåªè¦å®‰æ’åˆç†ï¼Œåªéœ€è¦ä¸€æ¬¡å°±å¯ä»¥å®Œæˆä»»åŠ¡ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆRedis ä½¿ç”¨å•çº¿ç¨‹æ¨¡å‹ä¼šè¾¾åˆ°æ¯ç§’ä¸‡çº§åˆ«çš„å¤„ç†èƒ½åŠ›å‘¢ï¼Ÿå¯ä»¥å°†å…¶å½’ç»“ä¸ºä¸‰ç‚¹ï¼š</p><p>ç¬¬ä¸€ï¼Œçº¯å†…å­˜è®¿é—®ï¼Œ Redis å°†æ‰€æœ‰æ•°æ®æ”¾åœ¨å†…å­˜ä¸­ï¼Œå†…å­˜çš„å“åº”æ—¶é•¿å¤§çº¦ä¸º100 çº³ç§’ï¼Œè¿™æ˜¯Redisè¾¾åˆ°æ¯ç§’ä¸‡çº§åˆ«è®¿é—®çš„é‡è¦åŸºç¡€ã€‚</p><p>ç¬¬äºŒï¼Œéé˜»å¡I/O, Redis ä½¿ç”¨epollä½œä¸ºI/Oå¤šè·¯å¤ç”¨æŠ€æœ¯çš„å®ç°ï¼Œå†åŠ ä¸ŠRedisè‡ªèº«çš„äº‹ä»¶å¤„ç†æ¨¡å‹å°†epollä¸­çš„è¿æ¥ã€è¯»å†™ã€å…³é—­éƒ½è½¬æ¢ä¸ºäº‹ä»¶ï¼Œä¸åœ¨ç½‘ç»œI/Oä¸Šæµªè´¹è¿‡å¤šçš„æ—¶é—´ã€‚</p><p>ç¬¬ä¸‰ï¼Œå•çº¿ç¨‹é¿å…äº†çº¿ç¨‹åˆ‡æ¢å’Œç«æ€äº§ç”Ÿçš„æ¶ˆè€—ã€‚</p><p>ä½†æ˜¯å•çº¿ç¨‹ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼šå¯¹äºæ¯ä¸ªå‘½ä»¤çš„æ‰§è¡Œæ—¶é—´æ˜¯æœ‰è¦æ±‚çš„ã€‚å¦‚æœæŸä¸ªå‘½ä»¤æ‰§è¡Œè¿‡é•¿ï¼Œä¼šé€ æˆå…¶ä»–å‘½ä»¤çš„é˜»å¡ï¼Œå¯¹äºRedis è¿™ç§é«˜æ€§èƒ½çš„æœåŠ¡æ¥è¯´æ˜¯è‡´å‘½çš„ï¼Œæ‰€ä»¥Redis æ˜¯é¢å‘å¿«é€Ÿæ‰§è¡Œåœºæ™¯çš„æ•°æ®åº“ã€‚</p><hr><h3 id="Redisä½¿ç”¨åœºæ™¯">Redisä½¿ç”¨åœºæ™¯</h3><div class="tabs" id="afd4130e-07a4-4024-b30c-71235e734c38"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#afd4130e-07a4-4024-b30c-71235e734c38-1"><i class="fas fa-seedling"></i>ç¼“å­˜</button></li><li class="tab"><button type="button" data-href="#afd4130e-07a4-4024-b30c-71235e734c38-2"><i class="fas fa-leaf"></i>æ’è¡Œæ¦œç³»ç»Ÿ</button></li><li class="tab"><button type="button" data-href="#afd4130e-07a4-4024-b30c-71235e734c38-3"><i class="fab fa-apple"></i>è®¡æ•°å™¨åº”ç”¨</button></li><li class="tab"><button type="button" data-href="#afd4130e-07a4-4024-b30c-71235e734c38-4"><i class="fas fa-tree"></i>ç¤¾äº¤ç½‘ç»œ</button></li><li class="tab"><button type="button" data-href="#afd4130e-07a4-4024-b30c-71235e734c38-5"><i class="fas fa-heartbeat"></i>æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="afd4130e-07a4-4024-b30c-71235e734c38-1"><p>ç¼“å­˜æœºåˆ¶å‡ ä¹åœ¨æ‰€æœ‰çš„å¤§å‹ç½‘ç«™éƒ½æœ‰ä½¿ç”¨ï¼Œåˆç†åœ°ä½¿ç”¨ç¼“å­˜ä¸ä»…å¯ä»¥åŠ å¿«æ•°æ®çš„è®¿é—®é€Ÿåº¦ï¼Œè€Œä¸”èƒ½å¤Ÿæœ‰æ•ˆåœ°é™ä½åç«¯æ•°æ®æºçš„å‹åŠ›ã€‚Redis æä¾›äº†é”®å€¼è¿‡æœŸæ—¶é—´è®¾ç½®ï¼Œå¹¶ä¸”ä¹Ÿæä¾›äº†çµæ´»æ§åˆ¶æœ€å¤§å†…å­˜å’Œå†…å­˜æº¢å‡ºåçš„æ·˜æ±°ç­–ç•¥ã€‚å¯ä»¥è¿™ä¹ˆè¯´ï¼Œä¸€ä¸ªåˆç†çš„ç¼“å­˜è®¾è®¡èƒ½å¤Ÿä¸ºä¸€ä¸ªç½‘ç«™çš„ç¨³å®šä¿é©¾æŠ¤èˆªã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="afd4130e-07a4-4024-b30c-71235e734c38-2"><p>æ’è¡Œæ¦œç³»ç»Ÿå‡ ä¹å­˜åœ¨äºæ‰€æœ‰çš„ç½‘ç«™ï¼Œä¾‹å¦‚æŒ‰ç…§çƒ­åº¦æ’åçš„æ’è¡Œæ¦œï¼ŒæŒ‰ç…§å‘å¸ƒæ—¶é—´çš„æ’è¡Œæ¦œï¼ŒæŒ‰ç…§å„ç§å¤æ‚ç»´åº¦è®¡ç®—å‡ºçš„æ’è¡Œæ¦œï¼Œ Redisæä¾›äº†åˆ—è¡¨å’Œæœ‰åºé›†åˆæ•°æ®ç»“æ„ï¼Œåˆç†åœ°ä½¿ç”¨è¿™äº›æ•°æ®ç»“æ„å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ„å»ºå„ç§æ’è¡Œæ¦œç³»ç»Ÿã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="afd4130e-07a4-4024-b30c-71235e734c38-3"><p>è®¡æ•°å™¨åœ¨ç½‘ç«™ä¸­çš„ä½œç”¨è‡³å…³é‡è¦ï¼Œä¾‹å¦‚è§†é¢‘ç½‘ç«™æœ‰æ’­æ”¾æ•°ã€ç”µå•†ç½‘ç«™æœ‰æµè§ˆæ•°ï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„å®æ—¶æ€§ï¼Œæ¯ä¸€æ¬¡æ’­æ”¾å’Œæµè§ˆéƒ½è¦åšåŠ 1 çš„æ“ä½œï¼Œå¦‚æœå¹¶å‘é‡å¾ˆå¤§å¯¹äºä¼ ç»Ÿå…³ç³»å‹æ•°æ®çš„æ€§èƒ½æ˜¯ä¸€ç§æŒ‘æˆ˜ã€‚Redis å¤©ç„¶æ”¯æŒè®¡æ•°åŠŸèƒ½è€Œä¸”è®¡æ•°çš„æ€§èƒ½ä¹Ÿéå¸¸å¥½ï¼Œå¯ä»¥è¯´æ˜¯è®¡æ•°å™¨ç³»ç»Ÿçš„é‡è¦é€‰æ‹©ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="afd4130e-07a4-4024-b30c-71235e734c38-4"><p>èµï¼è¸©ã€ç²‰ä¸ã€å…±åŒå¥½å‹ï¼å–œå¥½ã€æ¨é€ã€ä¸‹æ‹‰åˆ·æ–°ç­‰æ˜¯ç¤¾äº¤ç½‘ç«™çš„å¿…å¤‡åŠŸèƒ½ï¼Œç”±äºç¤¾äº¤ç½‘ç«™è®¿é—®é‡é€šå¸¸æ¯”è¾ƒå¤§ï¼Œè€Œä¸”ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®ä¸å¤ªé€‚åˆä¿å­˜è¿™ç§ç±»å‹çš„æ•°æ®ï¼Œ Redis æä¾›çš„æ•°æ®ç»“æ„å¯ä»¥ç›¸å¯¹æ¯”è¾ƒå®¹æ˜“åœ°å®ç°è¿™äº›åŠŸèƒ½ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="afd4130e-07a4-4024-b30c-71235e734c38-5"><p>æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿå¯ä»¥è¯´æ˜¯ä¸€ä¸ªå¤§å‹ç½‘ç«™çš„å¿…å¤‡åŸºç¡€ç»„ä»¶ï¼Œå› ä¸ºå…¶å…·æœ‰ä¸šåŠ¡è§£è€¦ã€éå®æ—¶ä¸šåŠ¡å‰Šå³°ç­‰ç‰¹æ€§ã€‚Redi s æä¾›äº†å‘å¸ƒè®¢é˜…åŠŸèƒ½å’Œé˜»å¡é˜Ÿåˆ—çš„åŠŸèƒ½ï¼Œè™½ç„¶å’Œä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—æ¯”è¿˜ä¸å¤Ÿè¶³å¤Ÿå¼ºå¤§ï¼Œä½†æ˜¯å¯¹äºä¸€èˆ¬çš„æ¶ˆæ¯é˜Ÿåˆ—åŠŸèƒ½åŸºæœ¬å¯ä»¥æ»¡è¶³ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="Rediså…¨å±€å‘½ä»¤">Rediså…¨å±€å‘½ä»¤</h2><div class="tabs" id="56da306b-3cff-458e-b89a-0e52e5a6f25b"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#56da306b-3cff-458e-b89a-0e52e5a6f25b-1"><i class="fas fa-cat"></i>é”®ç®¡ç†</button></li><li class="tab"><button type="button" data-href="#56da306b-3cff-458e-b89a-0e52e5a6f25b-2"><i class="fas fa-horse"></i>éå†é”®</button></li><li class="tab"><button type="button" data-href="#56da306b-3cff-458e-b89a-0e52e5a6f25b-3"><i class="fas fa-heartbeat"></i>é”®è¿‡æœŸ</button></li><li class="tab"><button type="button" data-href="#56da306b-3cff-458e-b89a-0e52e5a6f25b-4"><i class="fas fa-cookie-bite"></i>é”®çš„æ•°æ®ç»“æ„ç±»å‹å’Œå†…éƒ¨ç¼–ç </button></li><li class="tab"><button type="button" data-href="#56da306b-3cff-458e-b89a-0e52e5a6f25b-5"><i class="fas fa-dove"></i>æ•°æ®åº“ç®¡ç†</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="56da306b-3cff-458e-b89a-0e52e5a6f25b-1"><p><code>del key</code></p><p>del æ˜¯ä¸€ä¸ªé€šç”¨å‘½ä»¤ï¼Œæ— è®ºå€¼æ˜¯ä»€ä¹ˆæ•°æ®ç»“æ„ç±»å‹ï¼Œ del å‘½ä»¤éƒ½å¯ä»¥å°†å…¶åˆ é™¤</p><p>è¿”å›ç»“æœä¸ºæˆåŠŸåˆ é™¤é”®çš„ä¸ªæ•°ï¼Œå‡è®¾åˆ é™¤ä¸€ä¸ªä¸å­˜åœ¨çš„é”®ï¼Œå°±ä¼šè¿”å›0</p><p><code>dbsize</code></p><p>dbsize å‘½ä»¤ä¼šè¿”å›å½“å‰æ•°æ®åº“ä¸­é”®çš„æ€»æ•°ã€‚</p><p>dbsizeå‘½ä»¤åœ¨è®¡ç®—é”®æ€»æ•°æ—¶ä¸ä¼šéå†æ‰€æœ‰é”®ï¼Œè€Œæ˜¯ç›´æ¥è·å–Rediså†…ç½®çš„é”®æ€»æ•°å˜é‡ï¼Œæ‰€ä»¥dbsizeå‘½ä»¤çš„æ—¶é—´å¤æ‚åº¦æ˜¯0(1) ã€‚</p><p>è€Œkeyså‘½ä»¤ä¼šéå†æ‰€æœ‰é”®ï¼Œæ‰€ä»¥å®ƒçš„æ—¶é—´å¤æ‚åº¦æ˜¯O(n), å½“Redisä¿å­˜äº†å¤§é‡é”®æ—¶ï¼Œçº¿ä¸Šç¯å¢ƒç¦æ­¢ä½¿ç”¨ã€‚</p><p><code>exists key</code></p><p>å¦‚æœé”®å­˜åœ¨åˆ™è¿”å›1ä¸å­˜åœ¨åˆ™è¿”å›0</p><p><code>rename key newkey</code></p><p>é”®é‡å‘½å</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="56da306b-3cff-458e-b89a-0e52e5a6f25b-2"><p><code>keys pattern</code></p><p>å…¨é‡éå†é”®ï¼Œæ ¹æ®patternåŒ¹é…</p><p>ï¼Šä»£è¡¨åŒ¹é…ä»»æ„å­—ç¬¦ã€‚ä¼šå°†æ‰€æœ‰çš„é”®è¾“å‡ºï¼Œ<span class='p red'>ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒè®¾å¤‡ä¸Šä½¿ç”¨</span></p><p>? ä»£è¡¨åŒ¹é…ä¸€ä¸ªå­—ç¬¦</p><p>[] ä»£è¡¨ppéƒ¨åˆ†å­—ç¬¦</p><p><code>scan cursor [match pattern] [count number]</code></p><p>æ¸è¿›å¼éå†</p><p>cursoræ˜¯å¿…éœ€å‚æ•°ï¼Œå®é™…ä¸Šcursor æ˜¯ä¸€ä¸ªæ¸¸æ ‡ï¼Œç¬¬ä¸€æ¬¡éå†ä»0 å¼€å§‹ï¼Œæ¯æ¬¡scanéå†å®Œéƒ½ä¼šè¿”å›å½“å‰æ¸¸æ ‡çš„å€¼ï¼Œç›´åˆ°æ¸¸æ ‡å€¼ä¸º0, è¡¨ç¤ºéå†ç»“æŸã€‚</p><p>match patternæ˜¯å¯é€‰å‚æ•°ï¼Œå®ƒçš„ä½œç”¨çš„æ˜¯åšæ¨¡å¼çš„åŒ¹é…ï¼Œè¿™ç‚¹å’Œkeysçš„æ¨¡å¼åŒ¹é…å¾ˆåƒã€‚</p><p>count numberæ˜¯å¯é€‰å‚æ•°,å®ƒçš„ä½œç”¨æ˜¯è¡¨æ˜æ¯æ¬¡è¦éå†çš„é”®ä¸ªæ•°ï¼Œé»˜è®¤å€¼æ˜¯10, æ­¤å‚æ•°å¯ä»¥é€‚å½“å¢å¤§ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="56da306b-3cff-458e-b89a-0e52e5a6f25b-3"><p><code>expire key seconds</code></p><p>Redis æ”¯æŒå¯¹é”®æ·»åŠ è¿‡æœŸæ—¶é—´ï¼Œå½“è¶…è¿‡è¿‡æœŸæ—¶é—´åï¼Œä¼šè‡ªåŠ¨åˆ é™¤</p><p><code>ttl key</code></p><p>ttlå‘½ä»¤ä¼šè¿”å›é”®çš„å‰©ä½™è¿‡æœŸæ—¶é—´ï¼Œå®ƒæœ‰3 ç§è¿”å›å€¼ï¼š</p><ul><li>å¤§äºç­‰äº0 çš„æ•´æ•°ï¼šé”®å‰©ä½™çš„è¿‡æœŸæ—¶é—´ã€‚</li><li>-1: é”®æ²¡è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚</li><li>-2: é”®ä¸å­˜åœ¨</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="56da306b-3cff-458e-b89a-0e52e5a6f25b-4"><p><code>type key</code></p><p>è¿”å›é”®çš„æ•°æ®ç»“æ„ç±»å‹ï¼Œå¦‚æœé”®ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›none</p><p><code>object encoding key</code></p><p>æ¯ç§æ•°æ®ç»“æ„éƒ½æœ‰è‡ªå·±åº•å±‚çš„å†…éƒ¨ç¼–ç å®ç°ï¼Œè€Œä¸”æ˜¯å¤šç§å®ç°ï¼Œè¿™æ ·Redisä¼šåœ¨åˆé€‚çš„åœºæ™¯é€‰æ‹©åˆé€‚çš„å†…éƒ¨ç¼–ç ã€‚ä¾‹å¦‚listæ•°æ®ç»“æ„åŒ…å«äº†linkedlistå’Œziplistä¸¤ç§å†…éƒ¨ç¼–ç ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="56da306b-3cff-458e-b89a-0e52e5a6f25b-5"><p><code>select dbIndex</code></p><p>åˆ‡æ¢æ•°æ®åº“ã€‚ã€‚Redisé»˜è®¤é…ç½®ä¸­æ˜¯æœ‰16 ä¸ªæ•°æ®åº“ï¼Œé»˜è®¤ä½¿ç”¨çš„å°±æ˜¯0å·æ•°æ®åº“</p><p><code>FLUSHDB</code></p><p>åˆ é™¤å½“å‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰key</p><p><code>FLUSHALL</code></p><p>åˆ é™¤æ‰€æœ‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰key</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="Redisæ•°æ®ç»“æ„">Redisæ•°æ®ç»“æ„</h2><p>Redisæ˜¯ä¸€ä¸ªkey-valueçš„æ•°æ®åº“ï¼Œkeyä¸€èˆ¬æ˜¯Stringç±»å‹ï¼Œä¸è¿‡valueçš„ç±»å‹å¤šç§å¤šæ ·ï¼Œä¸ä»…å¯ä»¥å¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œä¸”è¿˜å¯ä»¥æ˜¯å…·ä½“çš„æ•°æ®ç»“æ„ã€‚</p><p><img src="https://image-bed-vz.oss-cn-hangzhou.aliyuncs.com/Redis/image-20220524205926164.png" alt="image-20220524205926164"></p><hr><hr><h2 id="Stringç±»å‹">Stringç±»å‹</h2><p>å­—ç¬¦ä¸²ç±»å‹æ˜¯Redisæœ€åŸºç¡€çš„æ•°æ®ç»“æ„ã€‚é¦–å…ˆé”®éƒ½æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œè€Œä¸”å…¶ä»–å‡ ç§æ•°æ®ç»“æ„éƒ½æ˜¯åœ¨å­—ç¬¦ä¸²ç±»å‹åŸºç¡€ä¸Šæ„å»ºçš„ã€‚</p><p>å…¶valueæ˜¯å­—ç¬¦ä¸²ï¼Œä¸è¿‡æ ¹æ®å­—ç¬¦ä¸²çš„æ ¼å¼ä¸åŒï¼Œåˆå¯ä»¥åˆ†ä¸º3ç±»ï¼š</p><ul><li><code>string</code>ï¼šæ™®é€šå­—ç¬¦ä¸²</li><li><code>int</code>ï¼šæ•´æ•°ç±»å‹ï¼Œå¯ä»¥åšè‡ªå¢ã€è‡ªå‡æ“ä½œ</li><li><code>float</code>ï¼šæµ®ç‚¹ç±»å‹ï¼Œå¯ä»¥åšè‡ªå¢ã€è‡ªå‡æ“ä½œ</li></ul><p>ä¸ç®¡æ˜¯å“ªç§æ ¼å¼ï¼Œåº•å±‚éƒ½æ˜¯å­—èŠ‚æ•°ç»„å½¢å¼å­˜å‚¨ï¼Œåªä¸è¿‡æ˜¯ç¼–ç æ–¹å¼ä¸åŒã€‚å­—ç¬¦ä¸²ç±»å‹çš„æœ€å¤§ç©ºé—´ä¸èƒ½è¶…è¿‡512m.</p><hr><h3 id="å¸¸è§å‘½ä»¤">å¸¸è§å‘½ä»¤</h3><div class="tabs" id="2fc12848-ed04-4e93-a442-0ffca0b79ef7"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2fc12848-ed04-4e93-a442-0ffca0b79ef7-1"><i class="fas fa-cat"></i>è®¾ç½®å€¼</button></li><li class="tab"><button type="button" data-href="#2fc12848-ed04-4e93-a442-0ffca0b79ef7-2"><i class="fas fa-horse"></i>è·å–å€¼</button></li><li class="tab"><button type="button" data-href="#2fc12848-ed04-4e93-a442-0ffca0b79ef7-3"><i class="fas fa-dove"></i>è‡ªå¢å€¼</button></li><li class="tab"><button type="button" data-href="#2fc12848-ed04-4e93-a442-0ffca0b79ef7-4"><i class="fas fa-dragon"></i>ä¸å¸¸ç”¨å‘½ä»¤</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2fc12848-ed04-4e93-a442-0ffca0b79ef7-1"><p><code>set key value [ex seconds] [px milliseconds] [nx|xx]</code></p><p>setå‘½ä»¤æœ‰å‡ ä¸ªé€‰é¡¹ï¼š</p><ul><li>ex secondsï¼šä¸ºé”®è®¾ç½®ç§’çº§è¿‡æœŸæ—¶é—´ã€‚</li><li>px millisecondsï¼šä¸ºé”®è®¾ç½®æ¯«ç§’çº§è¿‡æœŸæ—¶é—´ã€‚</li><li>nx : é”®å¿…é¡»ä¸å­˜åœ¨ï¼Œæ‰å¯ä»¥è®¾ç½®æˆåŠŸï¼Œç”¨äºæ·»åŠ ã€‚</li><li>xxï¼šä¸nxç›¸åï¼Œé”®å¿…é¡»å­˜åœ¨ï¼Œæ‰å¯ä»¥è®¾ç½®æˆåŠŸï¼Œ ç”¨äºæ›´æ–°ã€‚</li></ul><p>é™¤äº†seté€‰é¡¹ï¼Œ Redis è¿˜æä¾›äº†<code>setex</code>å’Œ<code>setnx</code>ä¸¤ä¸ªå‘½ä»¤ï¼Œå®ƒä»¬çš„ä½œç”¨å’Œexå’Œnxé€‰é¡¹æ˜¯ä¸€æ ·çš„ã€‚</p><p><code>mset key value [key value ...]</code></p><p>æ‰¹é‡è®¾ç½®å€¼ï¼Œé€šè¿‡<code>mset</code>å‘½ä»¤å¯ä»¥ä¸€æ¬¡æ€§è®¾ç½®å¤šä¸ªé”®å€¼å¯¹ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2fc12848-ed04-4e93-a442-0ffca0b79ef7-2"><p><code>get key</code></p><p>å¦‚æœè¦è·å–çš„é”®ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›nil(ç©º)</p><p><code>mget key [key ...]</code></p><p>æ‰¹é‡è·å–å€¼ï¼Œé€šè¿‡<code>mget</code>å‘½ä»¤å¯ä»¥ä¸€æ¬¡æ€§è·å–å¤šä¸ªé”®çš„å€¼ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2fc12848-ed04-4e93-a442-0ffca0b79ef7-3"><p><code>incr key</code></p><p>incrå‘½ä»¤ç”¨äºå¯¹å€¼åšè‡ªå¢æ“ä½œï¼Œè¿”å›ç»“æœåˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š</p><ul><li>å€¼ä¸æ˜¯æ•´æ•°ï¼Œè¿”å›é”™è¯¯ã€‚</li><li>å€¼æ˜¯æ•´æ•°ï¼Œè¿”å›è‡ªå¢åçš„ç»“æœã€‚</li><li>é”®ä¸å­˜åœ¨ï¼ŒæŒ‰ç…§å€¼ä¸º0 è‡ªå¢ï¼Œè¿”å›ç»“æœä¸º1 ã€‚</li></ul><p>é™¤äº†incrå‘½ä»¤ï¼ŒRedisæä¾›äº†decr(è‡ªå‡)ã€incrby(è‡ªå¢æŒ‡å®šæ•°å­—)ã€decrby (è‡ªå‡æŒ‡å®šæ•°å­—)ã€incrbyfloat(è‡ªå¢æµ®ç‚¹æ•°)</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2fc12848-ed04-4e93-a442-0ffca0b79ef7-4"><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>append key value </code></td><td>å‘å­—ç¬¦ä¸²å°¾éƒ¨è¿½åŠ å€¼</td></tr><tr><td><code>strlen key</code></td><td>å­—ç¬¦ä¸²é•¿åº¦</td></tr><tr><td><code>getset key value</code></td><td>è®¾ç½®å€¼å¹¶è¿”å›é”®åŸæ¥çš„å€¼</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="å†…éƒ¨ç¼–ç ">å†…éƒ¨ç¼–ç </h3><p>å­—ç¬¦ä¸²ç±»å‹çš„å†…éƒ¨ç¼–ç æœ‰3 ç§ï¼š</p><ul><li>int: 8 ä¸ªå­—èŠ‚çš„é•¿æ•´å‹ã€‚</li><li>embstr: é•¿åº¦å°äºç­‰äº44çš„å­—ç¬¦ä¸²ã€‚</li><li>raw: å¤§äº44ä¸ªå­—èŠ‚çš„å­—ç¬¦ä¸²ã€‚</li></ul><p>Redis ä¼šæ ¹æ®å½“å‰å€¼çš„ç±»å‹å’Œé•¿åº¦å†³å®šä½¿ç”¨å“ªç§å†…éƒ¨ç¼–ç å®ç°ã€‚</p><div class="tabs" id="95fe8596-9b07-4151-8343-ec780819f209"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#95fe8596-9b07-4151-8343-ec780819f209-1"><i class="fas fa-seedling"></i>æ•´æ•°ç±»å‹ç¤ºä¾‹</button></li><li class="tab"><button type="button" data-href="#95fe8596-9b07-4151-8343-ec780819f209-2"><i class="fas fa-leaf"></i>çŸ­å­—ç¬¦ä¸²ç¤ºä¾‹</button></li><li class="tab"><button type="button" data-href="#95fe8596-9b07-4151-8343-ec780819f209-3"><i class="fab fa-apple"></i>é•¿å­—ç¬¦ä¸²ç¤ºä¾‹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="95fe8596-9b07-4151-8343-ec780819f209-1"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> key1 123</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> key1</span><br><span class="line">string</span><br><span class="line">127.0.0.1:6379&gt; object encoding key1</span><br><span class="line"><span class="string">&quot;int&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="95fe8596-9b07-4151-8343-ec780819f209-2"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> key2 <span class="string">&quot;hello,world&quot;</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> key2</span><br><span class="line">string</span><br><span class="line">127.0.0.1:6379&gt; object encoding key2 </span><br><span class="line"><span class="string">&quot;embstr&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="95fe8596-9b07-4151-8343-ec780819f209-3"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> key3 <span class="string">&quot;one string greater than 39 byte..............&quot;</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; object encoding key3</span><br><span class="line"><span class="string">&quot;raw&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; strlen key3</span><br><span class="line">(<span class="built_in">integer</span>) 45</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="ä½¿ç”¨åœºæ™¯">ä½¿ç”¨åœºæ™¯</h3><div class="tabs" id="e4babf27-43ae-4acf-be62-fad0bb243223"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e4babf27-43ae-4acf-be62-fad0bb243223-1"><i class="fas fa-cat"></i>ç¼“å­˜åŠŸèƒ½</button></li><li class="tab"><button type="button" data-href="#e4babf27-43ae-4acf-be62-fad0bb243223-2"><i class="fas fa-horse"></i>è®¡æ•°</button></li><li class="tab"><button type="button" data-href="#e4babf27-43ae-4acf-be62-fad0bb243223-3"><i class="fas fa-dove"></i>å…±äº«Session</button></li><li class="tab"><button type="button" data-href="#e4babf27-43ae-4acf-be62-fad0bb243223-4"><i class="fas fa-dragon"></i>é™é€Ÿ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e4babf27-43ae-4acf-be62-fad0bb243223-1"><p>Redis ä½œä¸ºç¼“å­˜å±‚ï¼Œ MySQL ä½œä¸ºå­˜å‚¨å±‚ï¼Œç»å¤§éƒ¨åˆ†è¯·æ±‚çš„æ•°æ®éƒ½æ˜¯ä»Redisä¸­è·å–ã€‚ç”±åƒRediså…·æœ‰æ”¯æ’‘é«˜å¹¶å‘çš„ç‰¹æ€§ï¼Œæ‰€ä»¥ç¼“å­˜é€šå¸¸èƒ½èµ·åˆ°åŠ é€Ÿè¯»å†™å’Œé™ä½åç«¯å‹åŠ›çš„ä½œç”¨ã€‚</p><p>ä¸ MySQLç­‰å…³ç³»å‹æ•°æ®åº“ä¸åŒçš„æ˜¯ï¼ŒRedisæ²¡æœ‰å‘½ä»¤ç©ºé—´ï¼Œ è€Œä¸”ä¹Ÿæ²¡æœ‰å¯¹é”®åæœ‰ å¼ºåˆ¶è¦æ±‚ï¼ˆé™¤äº†ä¸èƒ½ä½¿ç”¨ä¸€äº›ç‰¹æ®Šå­—ç¬¦ï¼‰ã€‚ ä½†è®¾è®¡åˆç†çš„é”®åï¼Œ æœ‰åˆ©äºé˜²æ­¢é”®å†²çªï¼Œå’Œé¡¹ç›®çš„å¯ç»´æŠ¤æ€§ï¼Œ æ¯”è¾ƒæ¨èçš„æ–¹å¼æ˜¯ä½¿ç”¨ <code>&quot;ä¸šåŠ¡å:å¯¹è±¡å:id:[å±æ€§]</code> ä½œä¸ºé”®åï¼ˆä¹Ÿå¯ä»¥ä¸æ˜¯åˆ†å·ï¼‰ã€‚</p><p>ä¾‹å¦‚MySQLçš„æ•°æ®åº“åä¸ºvs, ç”¨æˆ·è¡¨åä¸ºuser, é‚£ä¹ˆå¯¹åº”çš„é”®å¯ä»¥ç”¨<code>&quot;vs:user:1&quot;,&quot;vs:user:1:name&quot;</code>æ¥è¡¨ç¤ºï¼Œ å¦‚æœå½“å‰Redisåªè¢«ä¸€ä¸ªä¸šåŠ¡ä½¿ç”¨ï¼Œ ç”šè‡³å¯ä»¥å»æ‰ â€œvsâ€ã€‚</p><p>å¦‚æœé”®åæ¯”è¾ƒé•¿ï¼Œ ä¾‹å¦‚<code>&quot;user:{uid}:friends:messages:{mid}&quot;</code>, å¯ä»¥åœ¨èƒ½æè¿°é”®å«ä¹‰çš„å‰æä¸‹é€‚å½“å‡å°‘é”®çš„é•¿åº¦ï¼Œ ä¾‹å¦‚å˜ä¸º<code>&quot;u:{uid}:fr:m:{mid}&quot;</code>, ä»è€Œå‡å°‘ç”±äºé”®è¿‡é•¿çš„å†…å­˜æµªè´¹ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e4babf27-43ae-4acf-be62-fad0bb243223-2"><p>è®¸å¤šåº”ç”¨éƒ½ä¼šä½¿ç”¨Redisä½œä¸ºè®¡æ•°çš„åŸºç¡€å·¥å…·ï¼Œ å®ƒå¯ä»¥å®ç°å¿«é€Ÿè®¡æ•°ã€ æŸ¥è¯¢ç¼“å­˜çš„åŠŸèƒ½ï¼ŒåŒæ—¶æ•°æ®å¯ä»¥å¼‚æ­¥è½åœ°åˆ°å…¶ä»–æ•°æ®æºã€‚</p><p>ä¾‹å¦‚è§†é¢‘æ’­æ”¾æ•°è®¡ç³»ç»Ÿå°±æ˜¯ä½¿ç”¨Redisä½œä¸ºè§†é¢‘æ’­æ”¾æ•°è®¡æ•°çš„åŸºç¡€ç»„ä»¶ï¼Œ ç”¨æˆ·æ¯æ’­æ”¾ä¸€æ¬¡è§†é¢‘ï¼Œ ç›¸åº”çš„è§†é¢‘æ’­æ”¾æ•°å°±ä¼šè‡ªå¢1ã€‚</p><p>å®é™…ä¸Šä¸€ä¸ªçœŸå®çš„è®¡æ•°ç³»ç»Ÿè¦è€ƒè™‘çš„é—®é¢˜ä¼šå¾ˆå¤šï¼šé˜²ä½œå¼Šã€æŒ‰ç…§ä¸åŒç»´åº¦è®¡æ•°ï¼Œæ•°æ®æŒä¹…åŒ–åˆ°åº•å±‚æ•°æ®æºç­‰ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e4babf27-43ae-4acf-be62-fad0bb243223-3"><p>ä¸€ä¸ªåˆ†å¸ƒå¼WebæœåŠ¡å°†ç”¨æˆ·çš„Sessionä¿¡æ¯ï¼ˆä¾‹å¦‚ç”¨æˆ·ç™»å½•ä¿¡æ¯ï¼‰ä¿å­˜åœ¨å„è‡ªæœåŠ¡å™¨ä¸­ï¼Œè¿™æ ·ä¼šé€ æˆä¸€ä¸ªé—®é¢˜ï¼Œå‡ºåƒè´Ÿè½½å‡è¡¡çš„è€ƒè™‘ï¼Œåˆ†å¸ƒå¼æœåŠ¡ä¼šå°†ç”¨æˆ·çš„è®¿é—®å‡è¡¡åˆ°ä¸åŒæœåŠ¡å™¨ä¸Šï¼Œç”¨æˆ·åˆ·æ–°ä¸€æ¬¡è®¿é—®å¯èƒ½ä¼šå‘ç°éœ€è¦é‡æ–°ç™»å½•ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯ç”¨æˆ·æ— æ³•å®¹å¿çš„ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨Rediså°†ç”¨æˆ·çš„Sessionè¿›è¡Œé›†ä¸­ç®¡ç†ï¼Œï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹åªè¦ä¿è¯Redisæ˜¯é«˜å¯ç”¨å’Œæ‰©å±•æ€§çš„ï¼Œæ¯æ¬¡ç”¨æˆ·æ›´æ–°æˆ–è€…æŸ¥è¯¢ç™»å½•ä¿¡æ¯éƒ½ç›´æ¥ä»Redisä¸­é›†ä¸­è·å–ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e4babf27-43ae-4acf-be62-fad0bb243223-4"><p>å¾ˆå¤šåº”ç”¨å‡ºäºå®‰å…¨çš„è€ƒè™‘ï¼Œä¼šåœ¨æ¯æ¬¡è¿›è¡Œç™»å½•æ—¶ï¼Œè®©ç”¨æˆ·è¾“å…¥æ‰‹æœºéªŒè¯ç ï¼Œä»è€Œç¡®å®šæ˜¯å¦æ˜¯ç”¨æˆ·æœ¬äººã€‚ä½†æ˜¯ä¸ºäº†çŸ­ä¿¡æ¥å£ä¸è¢«é¢‘ç¹è®¿é—®ï¼Œä¼šé™åˆ¶ç”¨æˆ·æ¯åˆ†é’Ÿè·å–éªŒè¯ç çš„é¢‘ç‡ï¼Œä¾‹å¦‚ä¸€åˆ†é’Ÿä¸èƒ½è¶…è¿‡5æ¬¡ã€‚</p><p>ä¸€äº›ç½‘ç«™é™åˆ¶ä¸€ä¸ªIP åœ°å€ä¸èƒ½åœ¨ä¸€ç§’é’Ÿä¹‹å†…è®¿é—´è¶…è¿‡n æ¬¡ä¹Ÿå¯ä»¥é‡‡ç”¨ç±»ä¼¼çš„æ€è·¯ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="Hashç±»å‹">Hashç±»å‹</h2><p>å‡ ä¹æ‰€æœ‰çš„ç¼–ç¨‹è¯­è¨€éƒ½æä¾›äº†å“ˆå¸Œ(hash) ç±»å‹ï¼Œå®ƒä»¬çš„å«æ³•å¯èƒ½æ˜¯å“ˆå¸Œã€å­—å…¸ã€å…³è”æ•°ç»„ã€‚åœ¨Redis ä¸­ï¼Œå“ˆå¸Œç±»å‹æ˜¯æŒ‡é”®å€¼æœ¬èº«åˆæ˜¯ä¸€ä¸ªé”®å€¼å¯¹ç»“æ„ï¼Œå½¢å¦‚<code>value=&#123;&#123;fi eldl,valuel&#125;,... &#123;fieldN,valueN&#125;&#125;</code>, Redisé”®å€¼å¯¹å’Œå“ˆå¸Œç±»å‹äºŒè€…çš„å…³ç³»å¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220525001227167.png" alt="image-20220525001227167"  /><p>å“ˆå¸Œç±»å‹ä¸­çš„æ˜ å°„å…³ç³»å«ä½œfield-value, æ³¨æ„è¿™é‡Œçš„valueæ˜¯æŒ‡fieldå¯¹åº”çš„å€¼ï¼Œä¸æ˜¯é”®å¯¹åº”çš„å€¼ï¼Œè¯·æ³¨æ„valueåœ¨ä¸åŒä¸Šä¸‹æ–‡çš„ä½œç”¨ã€‚</p><hr><h3 id="å¸¸è§å‘½ä»¤-2">å¸¸è§å‘½ä»¤</h3><div class="tabs" id="c3256886-0ff3-4b02-b127-c277beeba0ae"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c3256886-0ff3-4b02-b127-c277beeba0ae-1"><i class="fas fa-seedling"></i>è®¾ç½®å€¼</button></li><li class="tab"><button type="button" data-href="#c3256886-0ff3-4b02-b127-c277beeba0ae-2"><i class="fas fa-leaf"></i>è·å–å€¼</button></li><li class="tab"><button type="button" data-href="#c3256886-0ff3-4b02-b127-c277beeba0ae-3"><i class="fab fa-apple"></i>field</button></li><li class="tab"><button type="button" data-href="#c3256886-0ff3-4b02-b127-c277beeba0ae-4"><i class="fas fa-tree"></i>value</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c3256886-0ff3-4b02-b127-c277beeba0ae-1"><p><code>hset key field value</code></p><p>å¦‚æœè®¾ç½®æˆåŠŸä¼šè¿”å›1, åä¹‹ä¼šè¿”å›0ã€‚æ­¤å¤–Redisæä¾›äº†hsetnxå‘½ä»¤ï¼Œå®ƒä»¬çš„å…³ç³»å°±åƒsetå’Œsetnxå‘½ä»¤ä¸€æ ·ï¼Œåªä¸è¿‡ä½œç”¨åŸŸç”±é”®å˜ä¸ºfield ã€‚</p><p><code>hmset key field value [field value....]</code></p><p>æ‰¹é‡è®¾ç½®å€¼</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c3256886-0ff3-4b02-b127-c277beeba0ae-2"><p><code>hget key field</code></p><p>å¦‚æœé”®æˆ–fieldä¸å­˜åœ¨ï¼Œä¼šè¿”å›nil</p><p><code>hmget field [field ...]</code></p><p>æ‰¹é‡è·å–å€¼</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c3256886-0ff3-4b02-b127-c277beeba0ae-3"><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>hdel key field [field ...]</code></td><td>hdelä¼šåˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªfieldï¼Œè¿”å›åˆ é™¤fieldçš„ä¸ªæ•°</td></tr><tr><td><code>hlen key</code></td><td>è®¡ç®—keyä¸­fieldä¸ªæ•°</td></tr><tr><td><code>hexists key field</code></td><td>åˆ¤æ–­keyä¸­fieldæ˜¯å¦å­˜åœ¨</td></tr><tr><td><code>hkeys keys</code></td><td>è·å–keyä¸­æ‰€æœ‰field</td></tr><tr><td><code>hgetall key</code></td><td>è·å–keyçš„ç´¢å¼•field-value</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c3256886-0ff3-4b02-b127-c277beeba0ae-4"><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>hvals key</code></td><td>è·å–keyçš„æ‰€æœ‰value</td></tr><tr><td><code>hincrby key field</code></td><td>å¯¹åº”key-field-valueé€’å¢æ•´æ•°</td></tr><tr><td><code>hincrbyfloat key field</code></td><td>å¯¹åº”key-field-valueé€’å¢æµ®ç‚¹æ•°</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="å†…éƒ¨ç¼–ç -2">å†…éƒ¨ç¼–ç </h3><p>å“ˆå¸Œç±»å‹çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ï¼š</p><ul><li>listpack(å‹ç¼©åˆ—è¡¨)ï¼šå½“å“ˆå¸Œç±»å‹å…ƒç´ ä¸ªæ•°å°äºhash-max-listpack-entriesé…ç½®ï¼ˆé»˜è®¤512 ä¸ªï¼‰ã€åŒæ—¶æ‰€æœ‰å€¼éƒ½å°äºhash-max-listpackï¼value é…ç½®ï¼ˆé»˜è®¤64å­—èŠ‚ï¼‰æ—¶ï¼Œ Redis ä¼šä½¿ç”¨listpackä½œä¸ºå“ˆå¸Œçš„å†…éƒ¨å®ç°ï¼Œlistpackä½¿ç”¨æ›´åŠ ç´§å‡‘çš„ç»“æ„å®ç°å¤šä¸ªå…ƒç´ çš„è¿ç»­å­˜å‚¨ï¼Œæ‰€ä»¥åœ¨èŠ‚çœå†…å­˜æ–¹é¢æ¯”hashtableæ›´åŠ ä¼˜ç§€ã€‚</li><li>hashtable(å“ˆå¸Œè¡¨)ï¼šå½“å“ˆå¸Œç±»å‹æ— æ³•æ»¡è¶³ziplistçš„æ¡ä»¶æ—¶ï¼Œ Redisä¼šä½¿ç”¨hashtableä½œä¸ºå“ˆå¸Œçš„å†…éƒ¨å®ç°ï¼Œå› ä¸ºæ­¤æ—¶ziplistçš„è¯»å†™æ•ˆç‡ä¼šä¸‹é™ï¼Œè€Œhashtable çš„è¯»å†™æ—¶é—´å¤æ‚åº¦ä¸º0(1) ã€‚</li></ul><div class="tabs" id="73731162-3585-43b0-9a3a-0f1ac9d26ced"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#73731162-3585-43b0-9a3a-0f1ac9d26ced-1"><i class="fas fa-cat"></i>1</button></li><li class="tab"><button type="button" data-href="#73731162-3585-43b0-9a3a-0f1ac9d26ced-2"><i class="fas fa-horse"></i>2</button></li><li class="tab"><button type="button" data-href="#73731162-3585-43b0-9a3a-0f1ac9d26ced-3"><i class="fas fa-dove"></i>3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="73731162-3585-43b0-9a3a-0f1ac9d26ced-1"><p>å½“fieldä¸ªæ•°æ¯”è¾ƒå°‘ä¸”æ²¡æœ‰å¤§çš„value æ—¶ï¼Œå†…éƒ¨ç¼–ç ä¸ºlistpack</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hmset hashkey f1 v1 f2 v2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> hashkey</span><br><span class="line"><span class="built_in">hash</span></span><br><span class="line">127.0.0.1:6379&gt; object encoding hashkey</span><br><span class="line"><span class="string">&quot;listpack&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="73731162-3585-43b0-9a3a-0f1ac9d26ced-2"><p>å½“æœ‰valueå¤§åƒ64 å­—èŠ‚ï¼Œå†…éƒ¨ç¼–ç ä¼šç”±listpackå˜ä¸ºhashtable</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hset hashkey f3 <span class="string">&quot;one string is bigger than 64 byte ............................................................&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; object encoding hashkey</span><br><span class="line"><span class="string">&quot;hashtable&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="73731162-3585-43b0-9a3a-0f1ac9d26ced-3"><p>å½“fieldä¸ªæ•°è¶…è¿‡512, å†…éƒ¨ç¼–ç ä¹Ÿä¼šç”±listpackå˜ä¸ºhashtabl</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hset hashkey1 f4 v4 f5 v5 ......f513 v513</span><br><span class="line">ok</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; object encoding hashkey1</span><br><span class="line"><span class="string">&quot;hashtable&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="ä½¿ç”¨åœºæ™¯-2">ä½¿ç”¨åœºæ™¯</h3><p>ç›¸æ¯”äºä½¿ç”¨å­—ç¬¦ä¸²åºåˆ—åŒ–ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œå“ˆå¸Œç±»å‹å˜å¾—æ›´åŠ ç›´è§‚ï¼Œå¹¶ä¸”åœ¨æ›´æ–°æ“ä½œä¸Šä¼šæ›´åŠ ä¾¿æ·ã€‚å¯ä»¥å°†æ¯ä¸ªç”¨æˆ·çš„idå®šä¹‰ä¸ºé”®åç¼€ï¼Œå¤šå¯¹field-value å¯¹åº”æ¯ä¸ªç”¨æˆ·çš„å±æ€§ã€‚</p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»èƒ½å¤Ÿç”¨ä¸‰ç§æ–¹æ³•ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œä¸‹é¢ç»™å‡ºä¸‰ç§æ–¹æ¡ˆçš„å®ç°æ–¹æ³•å’Œä¼˜ç¼ºç‚¹åˆ†æã€‚</p><div class="tabs" id="93174b1e-5063-45a8-9951-073e9c3b1815"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#93174b1e-5063-45a8-9951-073e9c3b1815-1"><i class="fas fa-atom"></i>åŸç”Ÿå­—ç¬¦ä¸²ç±»å‹</button></li><li class="tab"><button type="button" data-href="#93174b1e-5063-45a8-9951-073e9c3b1815-2"><i class="far fa-sun"></i>2</button></li><li class="tab"><button type="button" data-href="#93174b1e-5063-45a8-9951-073e9c3b1815-3"><i class="fas fa-wind"></i>å“ˆå¸Œç±»å‹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="93174b1e-5063-45a8-9951-073e9c3b1815-1"><p>æ¯ä¸ªå±æ€§ä¸€ä¸ªé”®ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> user:1:name <span class="string">&quot;tom&quot;</span></span><br><span class="line"><span class="built_in">set</span> user:1:age 23</span><br><span class="line"><span class="built_in">set</span> user:1:city <span class="string">&quot;beijing&quot;</span></span><br></pre></td></tr></table></figure><p>ä¼˜ç‚¹ï¼šç®€å•ç›´è§‚ï¼Œæ¯ä¸ªå±æ€§éƒ½æ”¯å¾…æ›´æ–°æ“ä½œã€‚</p><p>ç¼ºç‚¹ï¼šå ç”¨è¿‡å¤šçš„é”®ï¼Œå†…å­˜å ç”¨é‡è¾ƒå¤§ï¼ŒåŒæ—¶ç”¨æˆ·ä¿¡æ¯å†…èšæ€§æ¯”è¾ƒå·®ï¼Œæ‰€ä»¥æ­¤ç§æ–¹æ¡ˆä¸€èˆ¬ä¸ä¼šåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="93174b1e-5063-45a8-9951-073e9c3b1815-2"><p>åºåˆ—åŒ–å­—ç¬¦ä¸²ç±»å‹ï¼šå°†ç”¨æˆ·ä¿¡æ¯åºåˆ—åŒ–åç”¨ä¸€ä¸ªé”®ä¿å­˜ã€‚</p><p><code>set user:1 serialize(userInfo)</code></p><p>ä¼˜ç‚¹ï¼šç®€åŒ–ç¼–ç¨‹ï¼Œå¦‚æœåˆç†çš„ä½¿ç”¨åºåˆ—åŒ–å¯ä»¥æé«˜å†…å­˜çš„ä½¿ç”¨æ•ˆç‡ã€‚</p><p>ç¼ºç‚¹ï¼šåºåˆ—åŒ–å’Œååºåˆ—åŒ–æœ‰ä¸€å®šçš„å¼€é”€ï¼ŒåŒæ—¶æ¯æ¬¡æ›´æ–°å±æ€§éƒ½éœ€è¦æŠŠå…¨éƒ¨æ•°æ®å–å‡ºè¿›è¡Œååºåˆ—åŒ–ï¼Œæ›´æ–°åå†åºåˆ—åŒ–åˆ°Redisä¸­ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="93174b1e-5063-45a8-9951-073e9c3b1815-3"><p>æ¯ä¸ªç”¨æˆ·å±æ€§ä½¿ç”¨ä¸€å¯¹field-value, ä½†æ˜¯åªç”¨ä¸€ä¸ªé”®ä¿å­˜ã€‚</p><p><code>hmset user:1 name &quot;tom&quot; age 23 city &quot;beijing&quot;</code></p><p>ä¼˜ç‚¹ï¼šç®€å•ç›´è§‚ï¼Œå¦‚æœä½¿ç”¨åˆç†å¯ä»¥å‡å°‘å†…å­˜ç©ºé—´çš„ä½¿ç”¨ã€‚</p><p>ç¼ºç‚¹ï¼šè¦æ§åˆ¶å“ˆå¸Œåœ¨listpackå’Œhashtableä¸¤ç§å†…éƒ¨ç¼–ç çš„è½¬æ¢ï¼Œ hashtableä¼šæ¶ˆè€—æ›´å¤šå†…å­˜ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><hr><h2 id="Listç±»å‹">Listç±»å‹</h2><p>åˆ—è¡¨(list)ç±»å‹æ˜¯ç”¨æ¥å­˜å‚¨å¤šä¸ªæœ‰åºçš„å­—ç¬¦ä¸²ï¼Œåˆ—è¡¨ä¸­çš„æ¯ä¸ªå­—ç¬¦ä¸²ç§°ä¸ºå…ƒç´ (element),ä¸€ä¸ªåˆ—è¡¨æœ€å¤šå¯ä»¥å­˜å‚¨2çš„32æ¬¡æ–¹ä¸ªå…ƒç´ ã€‚åœ¨Redisä¸­ï¼Œå¯ä»¥å¯¹åˆ—è¡¨ä¸¤ç«¯æ’å…¥(push) å’Œå¼¹å‡º(pop),è¿˜å¯ä»¥è·å–æŒ‡å®šèŒƒå›´çš„å…ƒç´ åˆ—è¡¨ã€è·å–æŒ‡å®šç´¢å¼•ä¸‹æ ‡çš„å…ƒç´ ç­‰ã€‚åˆ—è¡¨æ˜¯ä¸€ç§æ¯”è¾ƒçµæ´»çš„æ•°æ®ç»“æ„ï¼Œå®ƒå¯ä»¥å……å½“æ ˆå’Œé˜Ÿåˆ—çš„è§’è‰²ï¼Œåœ¨å®é™…å¼€å‘ä¸Šæœ‰å¾ˆå¤šåº”ç”¨åœºæ™¯ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/new.gif" alt="new"></p><p>åˆ—è¡¨ç±»å‹æœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š</p><p>ç¬¬ä¸€ã€åˆ—è¡¨ä¸­çš„å…ƒç´ æ˜¯æœ‰åºçš„ï¼Œè¿™å°±æ„å‘³ç€å¯ä»¥é€šè¿‡ç´¢å¼•ä¸‹æ ‡è·å–æŸä¸ªå…ƒç´ æˆ–è€…æŸä¸ªèŒƒå›´å†…çš„å…ƒç´ åˆ—è¡¨ã€‚</p><p>ç¬¬äºŒã€åˆ—è¡¨ä¸­çš„å…ƒç´ å¯ä»¥æ˜¯é‡å¤çš„ã€‚</p><hr><h3 id="å¸¸è§å‘½ä»¤-3">å¸¸è§å‘½ä»¤</h3><div class="tabs" id="9a7ceafc-8a90-480c-a138-38d48c77fbcd"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#9a7ceafc-8a90-480c-a138-38d48c77fbcd-1"><i class="fas fa-seedling"></i>æ·»åŠ æ“ä½œ</button></li><li class="tab"><button type="button" data-href="#9a7ceafc-8a90-480c-a138-38d48c77fbcd-2"><i class="fas fa-leaf"></i>æŸ¥æ‰¾</button></li><li class="tab"><button type="button" data-href="#9a7ceafc-8a90-480c-a138-38d48c77fbcd-3"><i class="fab fa-apple"></i>åˆ é™¤</button></li><li class="tab"><button type="button" data-href="#9a7ceafc-8a90-480c-a138-38d48c77fbcd-4"><i class="fas fa-tree"></i>ä¿®æ”¹</button></li><li class="tab"><button type="button" data-href="#9a7ceafc-8a90-480c-a138-38d48c77fbcd-5"><i class="fas fa-heartbeat"></i>é˜»å¡æ“ä½œ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="9a7ceafc-8a90-480c-a138-38d48c77fbcd-1"><p><code>rpush key value [value ....]</code></p><p>ä»å³è¾¹æ’å…¥å…ƒç´ </p><p><code>lpush key value [value]</code></p><p>ä»å·¦è¾¹æ’å…¥å…ƒç´ </p><p><code>linsert key before|after pivot value</code></p><p>linsertå‘½ä»¤ä¼šä»åˆ—è¡¨ä¸­æ‰¾åˆ°ç­‰äºpivotçš„å…ƒç´ ï¼Œåœ¨å…¶å‰(before)æˆ–è€…å(after) æ’å…¥ä¸€ä¸ªæ–°çš„å…ƒç´ value</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9a7ceafc-8a90-480c-a138-38d48c77fbcd-2"><p><code>lrange key start end </code></p><p>è·å–æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ åˆ—è¡¨ï¼Œstartä¸º0ï¼Œendä¸º-1æ˜¯è¡¨ç¤ºè·å–æ‰€æœ‰å…ƒç´ </p><p><code>lindex key index</code></p><p>è·å–åˆ—è¡¨æŒ‡å®šç´¢å¼•ä¸‹æ ‡çš„å…ƒç´ </p><p><code>llen key</code></p><p>è·å–åˆ—è¡¨é•¿åº¦</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9a7ceafc-8a90-480c-a138-38d48c77fbcd-3"><p><code>lpop key</code></p><p>ä»åˆ—è¡¨å·¦ä¾§å¼¹å‡ºå…ƒç´ </p><p><code>rpop key</code></p><p>ä»åˆ—è¡¨å³ä¾§å¼¹å‡º</p><p><code>ltrim key start end</code></p><p>æŒ‰ç…§ç´¢å¼•èŒƒå›´ä¿®å‰ªåˆ—è¡¨</p><p><code>lrem key count value</code></p><p>åˆ é™¤æŒ‡å®šå…ƒç´ </p><p>lrem å‘½ä»¤ä¼šä»åˆ—è¡¨ä¸­æ‰¾åˆ°ç­‰åƒvalue çš„å…ƒç´ è¿›è¡Œåˆ é™¤ï¼Œæ ¹æ®countçš„ä¸åŒåˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š</p><ul><li>countï¼0, ä»å·¦åˆ°å³ï¼Œåˆ é™¤æœ€å¤šcountä¸ªå…ƒç´ </li><li>count&lt;0, ä»å³åˆ°å·¦ï¼Œåˆ é™¤æœ€å¤šcountç»å¯¹å€¼ä¸ªå…ƒç´ </li><li>count=0,åˆ é™¤æ‰€æœ‰</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9a7ceafc-8a90-480c-a138-38d48c77fbcd-4"><p><code>lset key index newValue</code></p><p>ä¿®æ”¹æŒ‡å®šç´¢å¼•ä¸‹æ ‡çš„å…ƒç´ </p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9a7ceafc-8a90-480c-a138-38d48c77fbcd-5"><p>é˜»å¡å¼å¼¹å‡ºå¦‚ä¸‹ï¼š</p><p><code>blpop key [key . . .] timeout </code></p><p><code>brpop key [key . . .] timeout</code></p><p>blpopå’Œbrpopæ˜¯lpopå’Œrpopçš„é˜»å¡ç‰ˆæœ¬ï¼Œå®ƒä»¬é™¤äº†å¼¹å‡ºæ–¹å‘ä¸åŒï¼Œä½¿ç”¨æ–¹æ³•åŸºæœ¬ç›¸åŒï¼Œæ‰€ä»¥ä¸‹é¢ä»¥brpopå‘½ä»¤è¿›è¡Œè¯´æ˜ï¼Œ brpopå‘½ä»¤åŒ…å«ä¸¤ä¸ªå‚æ•°ï¼š</p><p>[key . . .]  å¤šä¸ªåˆ—è¡¨çš„é”®</p><p>timeout é˜»å¡æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰</p><p>1)åˆ—è¡¨ä¸ºç©ºï¼šå¦‚æœtimeout =3 ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯è¦ç­‰åˆ°3ç§’åè¿”å›nilï¼Œå¦‚æœtimeoutï¼ 0ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¸€ç›´é˜»å¡ç­‰ä¸‹å»</p><p>2)åˆ—è¡¨ä¸ºç©ºï¼šå¦‚æœæ­¤æœŸé—´æ·»åŠ äº†æ•°æ®elementï¼Œå®¢æˆ·ç«¯ç«‹å³è¿”å›</p><p>3)åˆ—è¡¨ä¸ä¸ºç©ºï¼šå®¢æˆ·ç«¯ä¼šç«‹å³è¿”å›</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="å†…éƒ¨ç¼–ç -3">å†…éƒ¨ç¼–ç </h3><p>åˆ—è¡¨ç±»å‹çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ã€‚</p><p>ziplist(å‹ç¼©åˆ—è¡¨)ï¼š å½“åˆ—è¡¨çš„å…ƒç´ ä¸ªæ•°å°äºlist-max-ziplist-entriesé…ç½®(é»˜è®¤512ä¸ª)ï¼ŒåŒæ—¶åˆ—è¡¨ä¸­æ¯ä¸ªå…ƒç´ çš„å€¼éƒ½å°äºlist-max-ziplistï¼value é…ç½®ï¼ˆé»˜è®¤64å­—èŠ‚ï¼‰æ—¶ï¼Œ Redis ä¼šä½¿ç”¨ziplistä½œä¸ºåˆ—è¡¨çš„å†…éƒ¨å®ç°ã€‚</p><p>linkedlist(é“¾è¡¨)ï¼šå½“åˆ—è¡¨ç±»å‹æ— æ³•æ»¡è¶³ziplistçš„æ¡ä»¶æ—¶ï¼Œ Redisä¼šä½¿ç”¨linkedlistä½œä¸ºåˆ—è¡¨çš„å†…éƒ¨å®ç°ã€‚</p><p>Redis3.2 ç‰ˆæœ¬æä¾›äº†quicklistå†…éƒ¨ç¼–ç ï¼Œç®€å•åœ°è¯´å®ƒæ˜¯ä»¥ä¸€ä¸ªziplistä¸ºèŠ‚ç‚¹çš„linkedlist,å®ƒç»“åˆäº†ziplistå’Œlinkedlistä¸¤è€…çš„ä¼˜åŠ¿ï¼Œä¸ºåˆ—è¡¨ç±»å‹æä¾›äº†ä¸€ç§æ›´ä¸ºä¼˜ç§€çš„å†…éƒ¨ç¼–ç å®ç°ã€‚</p><hr><h3 id="ä½¿ç”¨åœºæ™¯-3">ä½¿ç”¨åœºæ™¯</h3><p>Redis çš„lpush+brpopå‘½ä»¤ç»„åˆå³å¯å®ç°é˜»å¡é˜Ÿåˆ—ï¼Œç”Ÿäº§è€…å®¢æˆ·ç«¯ä½¿ç”¨lrpush ä»åˆ—è¡¨å·¦ä¾§æ’å…¥å…ƒç´ ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å®¢æˆ·ç«¯ä½¿ç”¨brpopå‘½ä»¤é˜»å¡å¼çš„ï¼‚æŠ¢ï¼‚åˆ—è¡¨å°¾éƒ¨çš„å…ƒç´ ï¼Œå¤šä¸ªå®¢æˆ·ç«¯ä¿è¯äº†æ¶ˆè´¹çš„è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨æ€§ã€‚</p><p>å®é™…ä¸Šåˆ—è¡¨çš„ä½¿ç”¨åœºæ™¯å¾ˆå¤šï¼Œåœ¨é€‰æ‹©æ—¶å¯ä»¥å‚è€ƒä»¥ä¸‹å£è¯€</p><p>lpush+lpop = Stack(æ ˆ)</p><p>lpush+rpop = Queue(é˜Ÿåˆ—)</p><p>lpush+ltrim = Capped Collection(æœ‰é™é›†åˆ)</p><p>lpush+brpop = Message Queue(æ¶ˆæ¯é˜Ÿåˆ—)</p><hr><hr><h2 id="Setç±»å‹">Setç±»å‹</h2><p>é›†åˆ(set)ç±»å‹ä¹Ÿæ˜¯ç”¨æ¥ä¿å­˜å¤šä¸ªçš„å­—ç¬¦ä¸²å…ƒç´ ï¼Œä½†å’Œåˆ—è¡¨ç±»å‹ä¸ä¸€æ ·çš„æ˜¯ï¼Œé›†åˆä¸­ä¸å…è®¸æœ‰é‡å¤å…ƒç´ ï¼Œå¹¶ä¸”é›†åˆä¸­çš„å…ƒç´ æ˜¯æ— åºçš„ï¼Œä¸èƒ½é€šè¿‡ç´¢å¼•ä¸‹æ ‡è·å–å…ƒç´ ã€‚ä¸€ä¸ªé›†</p><p>åˆæœ€å¤šå¯ä»¥å­˜å‚¨2çš„32æ¬¡æ–¹- 1ä¸ªå…ƒç´ ã€‚</p><p>Redisé™¤äº†æ”¯æŒé›†åˆå†…çš„å¢åˆ æ”¹æŸ¥ï¼ŒåŒæ—¶è¿˜æ”¯æŒå¤šä¸ªé›†åˆå–äº¤é›†ã€å¹¶é›†ã€å·®é›†ï¼Œåˆç†åœ°ä½¿ç”¨å¥½é›†åˆç±»å‹ï¼Œèƒ½åœ¨å®é™…å¼€å‘ä¸­è§£å†³å¾ˆå¤šå®é™…é—®é¢˜ã€‚</p><hr><h3 id="å¸¸è§å‘½ä»¤-4">å¸¸è§å‘½ä»¤</h3><div class="tabs" id="ae2f84aa-7721-4abd-bbcb-20d3a2f0410a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ae2f84aa-7721-4abd-bbcb-20d3a2f0410a-1"><i class="fas fa-seedling"></i>æ·»åŠ å…ƒç´ </button></li><li class="tab"><button type="button" data-href="#ae2f84aa-7721-4abd-bbcb-20d3a2f0410a-2"><i class="fas fa-leaf"></i>åˆ é™¤å…ƒç´ </button></li><li class="tab"><button type="button" data-href="#ae2f84aa-7721-4abd-bbcb-20d3a2f0410a-3"><i class="fab fa-apple"></i>é›†åˆæ“ä½œ</button></li><li class="tab"><button type="button" data-href="#ae2f84aa-7721-4abd-bbcb-20d3a2f0410a-4"><i class="fas fa-tree"></i>é›†åˆé—´æ“ä½œ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ae2f84aa-7721-4abd-bbcb-20d3a2f0410a-1"><p><code>sadd key element [element ...]</code></p><p>è¿”å›ç»“æœä¸ºæ·»åŠ æˆåŠŸçš„å…ƒç´ ä¸ªæ•°</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ae2f84aa-7721-4abd-bbcb-20d3a2f0410a-2"><p><code>srem key element [element ...]</code></p><p>è¿”å›ç»“æœä¸ºæˆåŠŸåˆ é™¤å…ƒç´ ä¸ªæ•°</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ae2f84aa-7721-4abd-bbcb-20d3a2f0410a-3"><p><code>smembers key</code></p><p>è·å–æ‰€æœ‰å…ƒç´ </p><p><code>scard key</code></p><p>è®¡ç®—å…ƒç´ ä¸ªæ•°,scard çš„æ—¶é—´å¤æ‚åº¦ä¸º0(1), å®ƒä¸ä¼šéå†é›†åˆæ‰€æœ‰å…ƒç´ ï¼Œè€Œæ˜¯ç›´æ¥ç”¨Rediså†…éƒ¨çš„å˜é‡</p><p><code>sismember key element</code></p><p>åˆ¤æ–­å…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­ï¼Œå¦‚æœç»™å®šå…ƒç´ elementåœ¨é›†åˆå†…è¿”å›1, åä¹‹è¿”å›0</p><p><code>srandmember key [count]</code></p><p>éšæœºä»é›†åˆè¿”å›æŒ‡å®šä¸ªæ•°å…ƒç´ ï¼Œ[count]æ˜¯å¯é€‰å‚æ•°ï¼Œå¦‚æœä¸å†™é»˜è®¤ä¸º1</p><p><code>spop key</code></p><p>ä»é›†åˆéšæœºå¼¹å‡ºå…ƒç´ ,srandmember å’Œspopéƒ½æ˜¯éšæœºä»é›†åˆé€‰å‡ºå…ƒç´ ï¼Œä¸¤è€…ä¸åŒçš„æ˜¯spopå‘½ä»¤æ‰§è¡Œåï¼Œå…ƒç´ ä¼šä»é›†åˆä¸­åˆ é™¤ï¼Œè€Œsrandmember ä¸ä¼šã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ae2f84aa-7721-4abd-bbcb-20d3a2f0410a-4"><p><code>sinter key [key ...]</code></p><p>æ±‚å¤šä¸ªé›†åˆçš„äº¤é›†</p><p><code>suinon key [key ...]</code></p><p>æ±‚å¤šä¸ªé›†åˆçš„å¹¶é›†</p><p><code>sdiff key [key ...]</code></p><p>æ±‚å¤šä¸ªé›†åˆçš„å·®é›†</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sinterstore</span> destination_key<span class="meta"> [key1 key2 ...]</span></span><br><span class="line"><span class="attribute">suinonstore</span> destination_key<span class="meta"> [key1 key2 ...]</span></span><br><span class="line"><span class="attribute">sdiffstore</span> destination_key<span class="meta"> [key1 key2 ...]</span></span><br></pre></td></tr></table></figure><p>å°†äº¤é›†ã€å¹¶é›†ã€å·®é›†çš„ç»“æœä¿å­˜åˆ°destination_keyä¸­</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="å†…éƒ¨ç¼–ç -4">å†…éƒ¨ç¼–ç </h3><p>é›†åˆç±»å‹çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ï¼š</p><ul><li>intset(æ•´æ•°é›†åˆ)ï¼šå½“é›†åˆå…ƒç´ ä¸ªæ•°å°äºset-max-intset-entriesé…ç½®ï¼ˆé»˜è®¤512 ä¸ªï¼‰ï¼ŒRedis ä¼šä½¿ç”¨intsetä½œä¸ºé›†åˆçš„å†…éƒ¨å®ç°ï¼Œä»è€Œå‡å°‘å†…å­˜çš„ä½¿ç”¨ã€‚</li><li>hashtable(å“ˆå¸Œè¡¨)ï¼šå½“é›†åˆç±»å‹æ— æ³•æ»¡è¶³intsetçš„æ¡ä»¶æ—¶ï¼Œ Redisä¼šä½¿ç”¨hashtableä½œä¸ºé›†åˆçš„å†…éƒ¨å®ç°ã€‚</li></ul><p>å½“å…ƒç´ ä¸ªæ•°è¾ƒå°‘ä¸”éƒ½ä¸ºæ•´æ•°æ—¶ï¼Œå†…éƒ¨ç¼–ç ä¸ºintset</p><p>å½“æŸä¸ªå…ƒç´ ä¸ä¸ºæ•´æ•°æ—¶ï¼Œå†…éƒ¨ç¼–ç ä¹Ÿä¼šå˜ä¸ºhashtable</p><p>å½“å…ƒç´ ä¸ªæ•°è¶…è¿‡512 ä¸ªï¼Œå†…éƒ¨ç¼–ç å˜ä¸ºhashtable</p><hr><h3 id="ä½¿ç”¨åœºæ™¯-4">ä½¿ç”¨åœºæ™¯</h3><p>é›†åˆç±»å‹æ¯”è¾ƒå…¸å‹çš„ä½¿ç”¨åœºæ™¯æ˜¯æ ‡ç­¾(tag)ã€‚ä¾‹å¦‚ä¸€ä¸ªç”¨æˆ·å¯èƒ½å¯¹å¨±ä¹ã€ä½“è‚²æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œå¦ä¸€ä¸ªç”¨æˆ·å¯èƒ½å¯¹å†å²ã€æ–°é—»æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œè¿™äº›å…´è¶£ç‚¹å°±æ˜¯æ ‡ç­¾ã€‚æœ‰äº†è¿™äº›æ•°æ®å°±å¯ä»¥å¾—åˆ°å–œæ¬¢åŒä¸€ä¸ªæ ‡ç­¾çš„äººï¼Œä»¥åŠç”¨æˆ·çš„å…±åŒå–œå¥½çš„æ ‡ç­¾ï¼Œè¿™äº›æ•°æ®å¯¹äºç”¨æˆ·ä½“éªŒä»¥åŠå¢å¼ºç”¨æˆ·é»åº¦æ¯”è¾ƒé‡è¦ã€‚ä¾‹å¦‚ä¸€ä¸ªç”µå­å•†åŠ¡çš„ç½‘ç«™ä¼šå¯¹ä¸åŒæ ‡ç­¾çš„ç”¨æˆ·åšä¸åŒç±»å‹çš„æ¨èï¼Œæ¯”å¦‚å¯¹æ•°ç äº§å“æ¯”è¾ƒæ„Ÿå…´è¶£çš„äººï¼Œåœ¨å„ä¸ªé¡µé¢æˆ–è€…é€šè¿‡é‚®ä»¶çš„å½¢å¼ç»™ä»–ä»¬æ¨èæœ€æ–°çš„æ•°ç äº§å“ï¼Œé€šå¸¸ä¼šä¸ºç½‘ç«™å¸¦æ¥æ›´å¤šçš„åˆ©ç›Šã€‚</p><hr><hr><h2 id="SortedSetç±»å‹">SortedSetç±»å‹</h2><p>æœ‰åºé›†åˆç›¸å¯¹äºå“ˆå¸Œã€åˆ—è¡¨ã€é›†åˆæ¥è¯´ä¼šæœ‰ä¸€ç‚¹ç‚¹é™Œç”Ÿï¼Œä½†æ—¢ç„¶å«æœ‰åºé›†åˆï¼Œé‚£ä¹ˆå®ƒå’Œé›†åˆå¿…ç„¶æœ‰ç€è”ç³»ï¼Œå®ƒä¿ç•™äº†é›†åˆä¸èƒ½æœ‰é‡å¤æˆå‘˜çš„ç‰¹æ€§ï¼Œä½†ä¸åŒçš„æ˜¯ï¼Œæœ‰åºé›†åˆä¸­çš„å…ƒç´ å¯ä»¥æ’åºã€‚ä½†æ˜¯å®ƒå’Œåˆ—è¡¨ä½¿ç”¨ç´¢å¼•ä¸‹æ ‡ä½œä¸ºæ’åºä¾æ®ä¸åŒçš„æ˜¯ï¼Œå®ƒç»™æ¯ä¸ªå…ƒç´ è®¾ç½®ä¸€ä¸ªåˆ†æ•°(scoreï¼‰ ï¼Œå¯ä»¥åŸºäºscoreå±æ€§å¯¹å…ƒç´ æ’åºï¼Œåº•å±‚çš„å®ç°æ˜¯ä¸€ä¸ªè·³è¡¨ï¼ˆSkipListï¼‰åŠ  hashè¡¨ã€‚</p><blockquote><p>æœ‰åºé›†åˆä¸­çš„å…ƒç´ ä¸èƒ½é‡å¤ï¼Œä½†æ˜¯score å¯ä»¥é‡å¤ï¼Œå°±å’Œä¸€ä¸ªç­é‡Œçš„åŒå­¦å­¦å·ä¸èƒ½é‡å¤ï¼Œä½†æ˜¯è€ƒè¯•æˆç»©å¯ä»¥ç›¸åŒã€‚</p></blockquote><h3 id="å¸¸è§å‘½ä»¤-5">å¸¸è§å‘½ä»¤</h3><div class="tabs" id="ceb52e25-aef0-4aae-9d3b-c0c2a49b0cdf"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ceb52e25-aef0-4aae-9d3b-c0c2a49b0cdf-1"><i class="fas fa-seedling"></i>æ·»åŠ æˆå‘˜</button></li><li class="tab"><button type="button" data-href="#ceb52e25-aef0-4aae-9d3b-c0c2a49b0cdf-2"><i class="fas fa-leaf"></i>åˆ é™¤æˆå‘˜</button></li><li class="tab"><button type="button" data-href="#ceb52e25-aef0-4aae-9d3b-c0c2a49b0cdf-3"><i class="fab fa-apple"></i>é›†åˆæ“ä½œ</button></li><li class="tab"><button type="button" data-href="#ceb52e25-aef0-4aae-9d3b-c0c2a49b0cdf-4"><i class="fas fa-tree"></i>é›†åˆé—´æ“ä½œ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ceb52e25-aef0-4aae-9d3b-c0c2a49b0cdf-1"><p><code>zadd key score member [score member ...]</code></p><p>è¿”å›ç»“æœä»£è¡¨æˆåŠŸæ·»åŠ æˆå‘˜çš„ä¸ªæ•°</p><p>zadd å‘½ä»¤æ·»åŠ äº†nx ã€xx ã€ch ã€incr å››ä¸ªé€‰é¡¹</p><p>â€¢ nx: memberå¿…é¡»ä¸å­˜åœ¨ï¼Œæ‰å¯ä»¥è®¾ç½®æˆåŠŸï¼Œç”¨äºæ·»åŠ </p><p>â€¢ xx: memberå¿…é¡»å­˜åœ¨ï¼Œæ‰å¯ä»¥è®¾ç½®æˆåŠŸï¼Œç”¨äºæ›´æ–°</p><p>â€¢ ch: è¿”å›æ­¤æ¬¡æ“ä½œåï¼Œæœ‰åºé›†åˆå…ƒç´ å’Œåˆ†æ•°å‘ç”Ÿå˜åŒ–çš„ä¸ªæ•°</p><p>â€¢ incrï¼šå¯¹score åšå¢åŠ ï¼Œç›¸å½“äºåé¢ä»‹ç»çš„zincrby</p><p>æœ‰åºé›†åˆç›¸æ¯”é›†åˆæä¾›äº†æ’åºå­—æ®µï¼Œä½†æ˜¯ä¹Ÿäº§ç”Ÿäº†ä»£ä»·ï¼Œ zadd çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(lo g(n)), sadd çš„æ—¶é—´å¤æ‚åº¦ä¸º0(1)ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ceb52e25-aef0-4aae-9d3b-c0c2a49b0cdf-2"><p><code>zrem key member [member ...]</code></p><p>è¿”å›ç»“æœä¸ºæˆåŠŸåˆ é™¤çš„ä¸ªæ•°ã€‚</p><p><code>zremrangebyrank key start end</code></p><p>åˆ é™¤æŒ‡å®šæ’åå†…çš„å‡åºå…ƒç´ </p><p><code>zremrangebyscore key min max</code></p><p>åˆ é™¤æŒ‡å®šåˆ†æ•°èŒƒå›´çš„æˆå‘˜</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ceb52e25-aef0-4aae-9d3b-c0c2a49b0cdf-3"><p><code>zcard key</code></p><p>è®¡ç®—æˆå‘˜ä¸ªæ•°</p><p><code>zscore key member</code></p><p>è®¡ç®—æŸä¸ªæˆå‘˜çš„åˆ†æ•°</p><p><code>zincrby key increment member</code></p><p>å¢åŠ æˆå‘˜çš„åˆ†æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zrange key start end [withscores]</span><br><span class="line">zrevrange key start end [withscores]</span><br></pre></td></tr></table></figure><p>è¿”å›æŒ‡å®šæ’åèŒƒå›´çš„æˆå‘˜,æœ‰åºé›†åˆæ˜¯æŒ‰ç…§åˆ†å€¼æ’åçš„ï¼Œ zran g e æ˜¯ä»ä½åˆ°é«˜è¿”å›ï¼Œ zrevran g e åä¹‹ã€‚ä¸‹é¢ä»£ç </p><p>è¿”å›æ’åæœ€ä½çš„æ˜¯ä¸‰ä¸ªæˆå‘˜ï¼Œå¦‚æœåŠ ä¸Šw it hscores é€‰é¡¹ï¼ŒåŒæ—¶ä¼šè¿”å›æˆå‘˜çš„åˆ†æ•°ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zrank key member</span><br><span class="line">zrevrank key member</span><br></pre></td></tr></table></figure><p>è®¡ç®—æˆå‘˜çš„æ’å,zrank æ˜¯ä»åˆ†æ•°ä»ä½åˆ°é«˜è¿”å›æ’åï¼Œ zrevrank åä¹‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zrangebyscore key min max [withsocre] [<span class="built_in">limit</span> offset count]</span><br><span class="line">zrevrangebyscore key min max [withsocre] [<span class="built_in">limit</span> offset count]</span><br></pre></td></tr></table></figure><p>è¿”å›æŒ‡å®šåˆ†æ•°èŒƒå›´çš„æˆå‘˜,å…¶ä¸­zrangebyscoreæŒ‰ç…§åˆ†æ•°ä»ä½åˆ°é«˜è¿”å›ï¼Œzrevrangebyscoreåä¹‹,withscoresé€‰é¡¹ä¼šåŒæ—¶è¿”å›æ¯ä¸ªæˆå‘˜çš„åˆ†æ•°ã€‚</p><p>[limit offset count]é€‰é¡¹å¯ä»¥é™åˆ¶è¾“å‡ºçš„èµ·å§‹ä½ç½®å’Œä¸ªæ•°</p><p><code>zcount key min max </code></p><p>è¿”å›æŒ‡å®šåˆ†æ•°èŒƒå›´æˆå‘˜ä¸ªæ•°</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ceb52e25-aef0-4aae-9d3b-c0c2a49b0cdf-4"><div class="tabs" id="ad595fb0-f098-427c-8472-85c3ecf2eedc"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ad595fb0-f098-427c-8472-85c3ecf2eedc-1"><i class="fas fa-cat"></i>å¯¼å…¥æ•°æ®</button></li><li class="tab"><button type="button" data-href="#ad595fb0-f098-427c-8472-85c3ecf2eedc-2"><i class="fas fa-horse"></i>äº¤é›†</button></li><li class="tab"><button type="button" data-href="#ad595fb0-f098-427c-8472-85c3ecf2eedc-3"><i class="fas fa-dove"></i>å¹¶é›†</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ad595fb0-f098-427c-8472-85c3ecf2eedc-1"><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">zadd</span> user:ranking:<span class="number">1</span> <span class="number">1</span> kris <span class="number">91</span> mike <span class="number">200</span> frank <span class="number">220</span> tim <span class="number">250</span> martin <span class="number">251</span> tom</span><br><span class="line"><span class="attribute">zadd</span> user:ranking:<span class="number">2</span> <span class="number">8</span> james <span class="number">77</span> mike <span class="number">625</span> martin <span class="number">888</span> tom</span><br></pre></td></tr></table></figure><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230606161459008.png" alt="image-20230606161459008" style="zoom:33%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ad595fb0-f098-427c-8472-85c3ecf2eedc-2"><p><code>zinterstore destination numkeys key [key ...] [weights weight [weight ...]] [aggregate sum|min|max]</code></p><p>äº¤é›†:è¿™ä¸ªå‘½ä»¤å‚æ•°è¾ƒå¤šï¼Œä¸‹é¢åˆ†åˆ«è¿›è¡Œè¯´æ˜ï¼š</p><p>destination: äº¤é›†è®¡ç®—ç»“æœä¿å­˜åˆ°è¿™ä¸ªé”®ã€‚</p><p>numkeys: éœ€è¦åšäº¤é›†è®¡ç®—é”®çš„ä¸ªæ•°ã€‚</p><p>key [key â€¦]:éœ€è¦åšäº¤é›†è®¡ç®—çš„é”®ã€‚</p><p>[weights weight [weight â€¦]]:æ¯ä¸ªé”®çš„æƒé‡ï¼Œåœ¨åšäº¤é›†è®¡ç®—æ—¶ï¼Œæ¯ä¸ªé”®ä¸­çš„æ¯ä¸ªmember ä¼šå°†è‡ªå·±åˆ†æ•°ä¹˜ä»¥è¿™ä¸ªæƒé‡ï¼Œæ¯ä¸ªé”®çš„æƒé‡é»˜è®¤æ˜¯1ã€‚</p><p>aggregate sum|min|max:è®¡ç®—æˆå‘˜äº¤é›†åï¼Œåˆ†å€¼å¯ä»¥æŒ‰ç…§sumå’Œã€minæœ€å°å€¼ã€maxæœ€å¤§å€¼åšæ±‡æ€»ï¼Œé»˜è®¤å€¼æ˜¯sum ã€‚</p><p><mark class="hl-label blue">ç¤ºä¾‹</mark></p><p>ä¸‹é¢æ“ä½œå¯¹user:ranking:1å’Œuser:ranking:2åšäº¤é›†ï¼Œ weightå’Œaggregateä½¿ç”¨äº†é»˜è®¤é…ç½®ï¼Œå¯ä»¥çœ‹åˆ°ç›®æ ‡é”®user:ranking:interå¯¹åˆ†å€¼åšäº†sum æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">zinterstore user:ranking:inter 2 user:ranking:1 user:ranking:2 </span><br><span class="line">zrange user:ranking:inter 0 -1 withscores </span><br><span class="line">1) <span class="string">&quot;mike&quot;</span></span><br><span class="line">2) <span class="string">&quot;168&quot;</span></span><br><span class="line">3) <span class="string">&quot;martin&quot;</span></span><br><span class="line">4) <span class="string">&quot;875&quot;</span></span><br><span class="line">5) <span class="string">&quot;tom&quot;</span></span><br><span class="line">6) <span class="string">&quot;1139&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ad595fb0-f098-427c-8472-85c3ecf2eedc-3"><p><code>zunionstore destination numkeys key [key ...] [weights weight [weight ...]] [aggregate sum|min|max]</code></p><p>å‚æ•°å’Œzinterstoreæ˜¯ä¸€è‡´çš„ï¼Œåªä¸è¿‡æ˜¯åšå¹¶é›†è®¡ç®—</p><p><mark class="hl-label blue">ç¤ºä¾‹</mark></p><p>ä¸‹é¢æ“ä½œå¯¹user:ranking:1å’Œuser:ranking:2åšå¹¶é›†ï¼Œ weightå’Œaggregateä½¿ç”¨äº†é»˜è®¤é…ç½®ï¼Œå¯ä»¥çœ‹åˆ°ç›®æ ‡é”®user:ranking:unionå¯¹åˆ†å€¼åšäº†sumæ“ä½œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">zunionstore user:ranking:union 2 user:ranking:1 user:ranking:2 </span><br><span class="line">zrange user:ranking:union 0 -1 withscores </span><br><span class="line"> 1) <span class="string">&quot;kris&quot;</span></span><br><span class="line"> 2) <span class="string">&quot;1&quot;</span></span><br><span class="line"> 3) <span class="string">&quot;james&quot;</span></span><br><span class="line"> 4) <span class="string">&quot;8&quot;</span></span><br><span class="line"> 5) <span class="string">&quot;mike&quot;</span></span><br><span class="line"> 6) <span class="string">&quot;168&quot;</span></span><br><span class="line"> 7) <span class="string">&quot;frank&quot;</span></span><br><span class="line"> 8) <span class="string">&quot;200&quot;</span></span><br><span class="line"> 9) <span class="string">&quot;tim&quot;</span></span><br><span class="line">10) <span class="string">&quot;220&quot;</span></span><br><span class="line">11) <span class="string">&quot;martin&quot;</span></span><br><span class="line">12) <span class="string">&quot;875&quot;</span></span><br><span class="line">13) <span class="string">&quot;tom&quot;</span></span><br><span class="line">14) <span class="string">&quot;1139&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="å†…éƒ¨ç¼–ç -5">å†…éƒ¨ç¼–ç </h3><p>æœ‰åºé›†åˆç±»å‹çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ï¼š</p><p>ziplist(å‹ç¼©åˆ—è¡¨)ï¼š å½“åˆ—è¡¨çš„å…ƒç´ ä¸ªæ•°å°äºlist-max-ziplist-entriesé…ç½®(é»˜è®¤512ä¸ª)ï¼ŒåŒæ—¶åˆ—è¡¨ä¸­æ¯ä¸ªå…ƒç´ çš„å€¼éƒ½å°äºlist-max-ziplistï¼value é…ç½®ï¼ˆé»˜è®¤64å­—èŠ‚ï¼‰æ—¶ï¼Œ Redis ä¼šä½¿ç”¨ziplistä½œä¸ºæœ‰åºçš„å†…éƒ¨å®ç°ã€‚</p><p>skiplist(è·³è¡¨)ï¼šå½“æ— æ³•æ»¡è¶³ziplistçš„æ¡ä»¶æ—¶ï¼Œ Redisä¼šä½¿ç”¨skiplistä½œä¸ºæœ‰åºé›†åˆçš„å†…éƒ¨å®ç°ï¼Œå› ä¸ºæ­¤æ—¶ziplistçš„è¯»å†™æ•ˆç‡ä¼šä¸‹é™ã€‚</p><p>å½“å…ƒç´ ä¸ªæ•°è¾ƒå°‘ä¸”æ¯ä¸ªå…ƒç´ è¾ƒå°æ—¶ï¼Œå†…éƒ¨ç¼–ç ä¸ºziplist</p><p>å½“å…ƒç´ ä¸ªæ•°è¶…è¿‡128 ä¸ªï¼Œå†…éƒ¨ç¼–ç å˜ä¸ºskiplist</p><p>å½“æŸä¸ªå…ƒç´ å¤§äº64 å­—èŠ‚æ—¶ï¼Œå†…éƒ¨ç¼–ç ä¹Ÿä¼šå˜ä¸ºhashtable:</p><hr><h3 id="ä½¿ç”¨åœºæ™¯-5">ä½¿ç”¨åœºæ™¯</h3><p>æœ‰åºé›†åˆæ¯”è¾ƒå…¸å‹çš„ä½¿ç”¨åœºæ™¯å°±æ˜¯æ’è¡Œæ¦œç³»ç»Ÿã€‚ä¾‹å¦‚è§†é¢‘ç½‘ç«™éœ€è¦å¯¹ç”¨æˆ·ä¸Šä¼ çš„è§†é¢‘åšæ’è¡Œæ¦œï¼Œæ¦œå•çš„ç»´åº¦å¯èƒ½æ˜¯å¤šä¸ªæ–¹é¢çš„ï¼šæŒ‰ç…§æ—¶é—´ã€æŒ‰ç…§æ’­æ”¾æ•°é‡ã€æŒ‰ç…§è·å¾—çš„èµæ•°ã€‚</p><p>ä½¿ç”¨èµæ•°è¿™ä¸ªç»´åº¦ï¼Œè®°å½•æ¯å¤©ç”¨æˆ·ä¸Šä¼ è§†é¢‘çš„æ’è¡Œæ¦œã€‚ä¸»è¦éœ€è¦å®ç°ä»¥ä¸‹4 ä¸ªåŠŸèƒ½ã€‚</p><div class="tabs" id="6f561f11-7489-4c61-a554-c7bb7ac8838d"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6f561f11-7489-4c61-a554-c7bb7ac8838d-1"><i class="fas fa-award"></i>æ·»åŠ ç”¨æˆ·èµæ•°</button></li><li class="tab"><button type="button" data-href="#6f561f11-7489-4c61-a554-c7bb7ac8838d-2"><i class="fas fa-baseball-ball"></i>å–æ¶ˆç”¨æˆ·èµæ•°</button></li><li class="tab"><button type="button" data-href="#6f561f11-7489-4c61-a554-c7bb7ac8838d-3"><i class="fas fa-bone"></i>å±•ç¤ºè·å–èµæ•°æœ€å¤šçš„åä¸ªç”¨æˆ·</button></li><li class="tab"><button type="button" data-href="#6f561f11-7489-4c61-a554-c7bb7ac8838d-4"><i class="fas fa-anchor"></i>å±•ç¤ºç”¨æˆ·ä¿¡æ¯ä»¥åŠç”¨æˆ·åˆ†æ•°</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6f561f11-7489-4c61-a554-c7bb7ac8838d-1"><p>ä¾‹å¦‚ç”¨æˆ·mikeä¸Šä¼ äº†ä¸€ä¸ªè§†é¢‘ï¼Œå¹¶è·å¾—äº†3 ä¸ªèµï¼Œå¯ä»¥ä½¿ç”¨æœ‰åºé›†åˆçš„zaddå’ŒzincrbyåŠŸèƒ½ï¼š</p><p><code>zadd user:ranking mike 3</code></p><p>å¦‚æœä¹‹åå†è·å¾—ä¸€ä¸ªèµï¼Œå¯ä»¥ä½¿ç”¨zincrby</p><p><code>zincrby user:ranking mike 1</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6f561f11-7489-4c61-a554-c7bb7ac8838d-2"><p>ç”±äºå„ç§åŸå› ï¼ˆä¾‹å¦‚ç”¨æˆ·æ³¨é”€ã€ç”¨æˆ·ä½œå¼Šï¼‰éœ€è¦å°†ç”¨æˆ·åˆ é™¤ï¼Œæ­¤æ—¶éœ€è¦å°†ç”¨æˆ·ä»æ¦œå•ä¸­åˆ é™¤æ‰ï¼Œå¯ä»¥ä½¿ç”¨zrem ã€‚ä¾‹å¦‚åˆ é™¤æˆå‘˜tom:</p><p><code>zrem user:ranking tom</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6f561f11-7489-4c61-a554-c7bb7ac8838d-3"><p>æ­¤åŠŸèƒ½ä½¿ç”¨zrevrangeå‘½ä»¤å®ç°ï¼š</p><p><code>zrevrangebyrank user:ranking 0 9</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6f561f11-7489-4c61-a554-c7bb7ac8838d-4"><p>æ­¤åŠŸèƒ½å°†ç”¨æˆ·åä½œä¸ºé”®åç¼€ï¼Œå°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åœ¨å“ˆå¸Œç±»å‹ä¸­ï¼Œè‡³äºç”¨æˆ·çš„åˆ†æ•°å’Œæ’åå¯ä»¥ä½¿ç”¨zscore å’Œzrank ä¸¤ä¸ªåŠŸèƒ½ï¼š</p><p><code>hgetall user:info:tom</code></p><p><code>zscore user:ranking mike</code></p><p><code>zrank user:ranking mike</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><hr><h2 id="SpringDataRediså®¢æˆ·ç«¯">SpringDataRediså®¢æˆ·ç«¯</h2><p>SpringDataæ˜¯Springä¸­æ•°æ®æ“ä½œçš„æ¨¡å—ï¼ŒåŒ…å«å¯¹å„ç§æ•°æ®åº“çš„é›†æˆï¼Œå…¶ä¸­å¯¹Redisçš„é›†æˆæ¨¡å—å°±å«åšSpringDataRedisã€‚</p><p>å®˜ç½‘åœ°å€ï¼š<a href="https://spring.io/projects/spring-data-redis">https://spring.io/projects/spring-data-redis</a></p><ul><li>æä¾›äº†å¯¹ä¸åŒRediså®¢æˆ·ç«¯çš„æ•´åˆï¼ˆLettuceå’ŒJedisï¼‰</li><li>æä¾›äº†RedisTemplateç»Ÿä¸€APIæ¥æ“ä½œRedis</li><li>æ”¯æŒRedisçš„å‘å¸ƒè®¢é˜…æ¨¡å‹</li><li>æ”¯æŒRediså“¨å…µå’ŒRedisé›†ç¾¤</li><li>æ”¯æŒåŸºäºLettuceçš„å“åº”å¼ç¼–ç¨‹</li><li>æ”¯æŒåŸºäºJDKã€JSONã€å­—ç¬¦ä¸²ã€Springå¯¹è±¡çš„æ•°æ®åºåˆ—åŒ–åŠååºåˆ—åŒ–</li><li>æ”¯æŒåŸºäºRedisçš„JDKCollectionå®ç°</li></ul><p>SpringDataRedisä¸­æä¾›äº†RedisTemplateå·¥å…·ç±»ï¼Œå…¶ä¸­å°è£…äº†å„ç§å¯¹Redisçš„æ“ä½œã€‚å¹¶ä¸”å°†ä¸åŒæ•°æ®ç±»å‹çš„æ“ä½œAPIå°è£…åˆ°äº†ä¸åŒçš„ç±»å‹ä¸­ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/UFlNIV0.png" alt=""></p><hr><h3 id="å¿«é€Ÿä½¿ç”¨">å¿«é€Ÿä½¿ç”¨</h3><p>SpringBootå·²ç»æä¾›äº†å¯¹SpringDataRedisçš„æ”¯æŒï¼Œä½¿ç”¨éå¸¸ç®€å•ã€‚</p><div class="tabs" id="d8e4ee01-5335-4db3-a2f8-7eaaf1b9e974"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d8e4ee01-5335-4db3-a2f8-7eaaf1b9e974-1"><i class="fas fa-award"></i>å¼•å…¥ä¾èµ–</button></li><li class="tab"><button type="button" data-href="#d8e4ee01-5335-4db3-a2f8-7eaaf1b9e974-2"><i class="fas fa-baseball-ball"></i>é…ç½®Redis</button></li><li class="tab"><button type="button" data-href="#d8e4ee01-5335-4db3-a2f8-7eaaf1b9e974-3"><i class="fas fa-bone"></i>æ³¨å…¥RedisTemplate</button></li><li class="tab"><button type="button" data-href="#d8e4ee01-5335-4db3-a2f8-7eaaf1b9e974-4"><i class="fas fa-anchor"></i>ç¼–å†™æµ‹è¯•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d8e4ee01-5335-4db3-a2f8-7eaaf1b9e974-1"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--redisä¾èµ–--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--common-pool--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Jacksonä¾èµ–--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d8e4ee01-5335-4db3-a2f8-7eaaf1b9e974-2"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123321</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">8</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">8</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="string">100ms</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d8e4ee01-5335-4db3-a2f8-7eaaf1b9e974-3"><p>å› ä¸ºæœ‰äº†SpringBootçš„è‡ªåŠ¨è£…é…ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿æ¥å°±ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisStringTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d8e4ee01-5335-4db3-a2f8-7eaaf1b9e974-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisStringTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å†™å…¥ä¸€æ¡Stringæ•°æ®</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;è™å“¥&quot;</span>);</span><br><span class="line">        <span class="comment">// è·å–stringæ•°æ®</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">name</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;name = &quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="è‡ªå®šä¹‰åºåˆ—åŒ–">è‡ªå®šä¹‰åºåˆ—åŒ–</h3><p>RedisTemplateå¯ä»¥æ¥æ”¶ä»»æ„Objectä½œä¸ºå€¼å†™å…¥Redisï¼Œåªä¸è¿‡å†™å…¥å‰ä¼šæŠŠObjectåºåˆ—åŒ–ä¸ºå­—èŠ‚å½¢å¼ï¼Œé»˜è®¤æ˜¯é‡‡ç”¨JDKåºåˆ—åŒ–ï¼Œå¾—åˆ°çš„ç»“æœæ˜¯è¿™æ ·çš„ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/5FjtWk5.png" alt=""></p><p>ç¼ºç‚¹ï¼š</p><ul><li>å¯è¯»æ€§å·®</li><li>å†…å­˜å ç”¨è¾ƒå¤§</li></ul><p>æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰RedisTemplateçš„åºåˆ—åŒ–æ–¹å¼ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory connectionFactory)</span>&#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºRedisTemplateå¯¹è±¡</span></span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// è®¾ç½®è¿æ¥å·¥å‚</span></span><br><span class="line">        template.setConnectionFactory(connectionFactory);</span><br><span class="line">        <span class="comment">// åˆ›å»ºJSONåºåˆ—åŒ–å·¥å…·</span></span><br><span class="line">        <span class="type">GenericJackson2JsonRedisSerializer</span> <span class="variable">jsonRedisSerializer</span> <span class="operator">=</span> </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>();</span><br><span class="line">        <span class="comment">// è®¾ç½®Keyçš„åºåˆ—åŒ–</span></span><br><span class="line">        template.setKeySerializer(RedisSerializer.string());</span><br><span class="line">        template.setHashKeySerializer(RedisSerializer.string());</span><br><span class="line">        <span class="comment">// è®¾ç½®Valueçš„åºåˆ—åŒ–</span></span><br><span class="line">        template.setValueSerializer(jsonRedisSerializer);</span><br><span class="line">        template.setHashValueSerializer(jsonRedisSerializer);</span><br><span class="line">        <span class="comment">// è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé‡‡ç”¨äº†JSONåºåˆ—åŒ–æ¥ä»£æ›¿é»˜è®¤çš„JDKåºåˆ—åŒ–æ–¹å¼ã€‚æœ€ç»ˆç»“æœå¦‚å›¾ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/XOAq3cN.png" alt=""></p><p>æ•´ä½“å¯è¯»æ€§æœ‰äº†å¾ˆå¤§æå‡ï¼Œå¹¶ä¸”èƒ½å°†Javaå¯¹è±¡è‡ªåŠ¨çš„åºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸²ï¼Œå¹¶ä¸”æŸ¥è¯¢æ—¶èƒ½è‡ªåŠ¨æŠŠJSONååºåˆ—åŒ–ä¸ºJavaå¯¹è±¡ã€‚ä¸è¿‡ï¼Œå…¶ä¸­è®°å½•äº†åºåˆ—åŒ–æ—¶å¯¹åº”çš„classåç§°ï¼Œç›®çš„æ˜¯ä¸ºäº†æŸ¥è¯¢æ—¶å®ç°è‡ªåŠ¨ååºåˆ—åŒ–ã€‚è¿™ä¼šå¸¦æ¥é¢å¤–çš„å†…å­˜å¼€é”€ã€‚</p><hr><h3 id="Stringåºåˆ—åŒ–">Stringåºåˆ—åŒ–</h3><p>ä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ä½¿ç”¨JSONåºåˆ—åŒ–å™¨æ¥å¤„ç†valueï¼Œè€Œæ˜¯ç»Ÿä¸€ä½¿ç”¨Stringåºåˆ—åŒ–å™¨ï¼Œè¦æ±‚åªèƒ½å­˜å‚¨Stringç±»å‹çš„keyå’Œvalueã€‚å½“éœ€è¦å­˜å‚¨Javaå¯¹è±¡æ—¶ï¼Œæ‰‹åŠ¨å®Œæˆå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/Ip9TKSY.png" style="zoom:67%;" /><p>å› ä¸ºå­˜å…¥å’Œè¯»å–æ—¶çš„åºåˆ—åŒ–åŠååºåˆ—åŒ–éƒ½æ˜¯æˆ‘ä»¬è‡ªå·±å®ç°çš„ï¼ŒSpringDataRediså°±ä¸ä¼šå°†classä¿¡æ¯å†™å…¥Redisäº†ã€‚</p><p>è¿™ç§ç”¨æ³•æ¯”è¾ƒæ™®éï¼Œå› æ­¤SpringDataRediså°±æä¾›äº†RedisTemplateçš„å­ç±»ï¼šStringRedisTemplateï¼Œå®ƒçš„keyå’Œvalueçš„åºåˆ—åŒ–æ–¹å¼é»˜è®¤å°±æ˜¯Stringæ–¹å¼ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/zXH6Qn6.png" style="zoom:67%;" /><p>çœå»äº†æˆ‘ä»¬è‡ªå®šä¹‰RedisTemplateçš„åºåˆ—åŒ–æ–¹å¼çš„æ­¥éª¤ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"><span class="comment">// JSONåºåˆ—åŒ–å·¥å…·</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testSaveUser</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºå¯¹è±¡</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;è™å“¥&quot;</span>, <span class="number">21</span>);</span><br><span class="line">    <span class="comment">// æ‰‹åŠ¨åºåˆ—åŒ–</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> mapper.writeValueAsString(user);</span><br><span class="line">    <span class="comment">// å†™å…¥æ•°æ®</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(<span class="string">&quot;user:200&quot;</span>, json);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æ•°æ®</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonUser</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;user:200&quot;</span>);</span><br><span class="line">    <span class="comment">// æ‰‹åŠ¨ååºåˆ—åŒ–</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> mapper.readValue(jsonUser, User.class);</span><br><span class="line">    System.out.println(<span class="string">&quot;user1 = &quot;</span> + user1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Rediså…¥é—¨ã€å¸¸è§å‘½ä»¤ã€å®¢æˆ·ç«¯</summary>
    
    
    
    <category term="æ•°æ®åº“" scheme="https://wuwawawa.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="Redis" scheme="https://wuwawawa.github.io/tags/Redis/"/>
    
    <category term="æ•°æ®åº“" scheme="https://wuwawawa.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>IOæµ</title>
    <link href="https://wuwawawa.github.io/posts/7f134d07.html"/>
    <id>https://wuwawawa.github.io/posts/7f134d07.html</id>
    <published>2023-06-04T07:03:25.000Z</published>
    <updated>2023-06-05T08:39:06.889Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-IOæ¦‚è¿°">1. IOæ¦‚è¿°</h2><h3 id="1-1-ä»€ä¹ˆæ˜¯IO">1.1 ä»€ä¹ˆæ˜¯IO</h3><p>ç”Ÿæ´»ä¸­ï¼Œä½ è‚¯å®šç»å†è¿‡è¿™æ ·çš„åœºæ™¯ã€‚å½“ä½ ç¼–è¾‘ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå¿˜è®°äº†<code>ctrl+s</code> ï¼Œå¯èƒ½æ–‡ä»¶å°±ç™½ç™½ç¼–è¾‘äº†ã€‚å½“ä½ ç”µè„‘ä¸Šæ’å…¥ä¸€ä¸ªUç›˜ï¼Œå¯ä»¥æŠŠä¸€ä¸ªè§†é¢‘ï¼Œæ‹·è´åˆ°ä½ çš„ç”µè„‘ç¡¬ç›˜é‡Œã€‚é‚£ä¹ˆæ•°æ®éƒ½æ˜¯åœ¨å“ªäº›è®¾å¤‡ä¸Šçš„å‘¢ï¼Ÿé”®ç›˜ã€å†…å­˜ã€ç¡¬ç›˜ã€å¤–æ¥è®¾å¤‡ç­‰ç­‰ã€‚</p><p>æˆ‘ä»¬æŠŠè¿™ç§æ•°æ®çš„ä¼ è¾“ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€ç§æ•°æ®çš„æµåŠ¨ï¼ŒæŒ‰ç…§æµåŠ¨çš„æ–¹å‘ï¼Œä»¥å†…å­˜ä¸ºåŸºå‡†ï¼Œåˆ†ä¸º<code>è¾“å…¥input</code> å’Œ<code>è¾“å‡ºoutput</code> ï¼Œå³æµå‘å†…å­˜æ˜¯è¾“å…¥æµï¼Œæµå‡ºå†…å­˜çš„è¾“å‡ºæµã€‚</p><p>Javaä¸­I/Oæ“ä½œä¸»è¦æ˜¯æŒ‡ä½¿ç”¨<code>java.io</code>åŒ…ä¸‹çš„å†…å®¹ï¼Œè¿›è¡Œè¾“å…¥ã€è¾“å‡ºæ“ä½œã€‚<strong>è¾“å…¥</strong>ä¹Ÿå«åš<strong>è¯»å–</strong>æ•°æ®ï¼Œ<strong>è¾“å‡º</strong>ä¹Ÿå«åšä½œ<strong>å†™å‡º</strong>æ•°æ®ã€‚</p><hr><h3 id="1-2-IOçš„åˆ†ç±»">1.2 IOçš„åˆ†ç±»</h3><p>æ ¹æ®æ•°æ®çš„æµå‘åˆ†ä¸ºï¼š<strong>è¾“å…¥æµ</strong>å’Œ<strong>è¾“å‡ºæµ</strong>ã€‚</p><ul><li><strong>è¾“å…¥æµ</strong> ï¼šæŠŠæ•°æ®ä»<code>å…¶ä»–è®¾å¤‡</code>ä¸Šè¯»å–åˆ°<code>å†…å­˜</code>ä¸­çš„æµã€‚</li><li><strong>è¾“å‡ºæµ</strong> ï¼šæŠŠæ•°æ®ä»<code>å†…å­˜</code> ä¸­å†™å‡ºåˆ°<code>å…¶ä»–è®¾å¤‡</code>ä¸Šçš„æµã€‚</li></ul><p>æ ¼å±€æ•°æ®çš„ç±»å‹åˆ†ä¸ºï¼š<strong>å­—èŠ‚æµ</strong>å’Œ<strong>å­—ç¬¦æµ</strong>ã€‚</p><ul><li><strong>å­—èŠ‚æµ</strong> ï¼šä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œè¯»å†™æ•°æ®çš„æµï¼Œå¯ä»¥æ“ä½œæ‰€æœ‰ç±»å‹çš„æ–‡ä»¶ã€‚</li><li><strong>å­—ç¬¦æµ</strong> ï¼šä»¥å­—ç¬¦ä¸ºå•ä½ï¼Œè¯»å†™æ•°æ®çš„æµï¼Œåªèƒ½æ“ä½œçº¯æ–‡æœ¬æ–‡ä»¶ã€‚</li></ul><hr><h3 id="1-3-IOçš„æµå‘è¯´æ˜å›¾è§£">1.3 IOçš„æµå‘è¯´æ˜å›¾è§£</h3><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1_io.jpg" style="zoom:67%;" /><hr><h3 id="1-4-é¡¶çº§çˆ¶ç±»ä»¬">1.4 é¡¶çº§çˆ¶ç±»ä»¬</h3><table><thead><tr><th style="text-align:center"></th><th style="text-align:center"><strong>è¾“å…¥æµ</strong></th><th style="text-align:center">è¾“å‡ºæµ</th></tr></thead><tbody><tr><td style="text-align:center"><strong><span class='p blue'>å­—èŠ‚æµ</span></strong></td><td style="text-align:center">å­—èŠ‚è¾“å…¥æµ<br /><strong><span class='p blue'>InputStream</span></strong></td><td style="text-align:center">å­—èŠ‚è¾“å‡ºæµ<br /><strong><span class='p blue'>OutputStream</span></strong></td></tr><tr><td style="text-align:center"><strong><span class='p green'>å­—ç¬¦æµ</span></strong></td><td style="text-align:center">å­—ç¬¦è¾“å…¥æµ<br /><strong><span class='p green'>Reader</span></strong></td><td style="text-align:center">å­—ç¬¦è¾“å‡ºæµ<br /><strong><span class='p green'>Writer</span></strong></td></tr></tbody></table><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605103133931.png" alt="image-20230605103133931" style="zoom: 50%;" /><hr><hr><h2 id="2-å­—èŠ‚æµ">2. å­—èŠ‚æµ</h2><p>ä¸€åˆ‡æ–‡ä»¶æ•°æ®(æ–‡æœ¬ã€å›¾ç‰‡ã€è§†é¢‘ç­‰)åœ¨å­˜å‚¨æ—¶ï¼Œéƒ½æ˜¯ä»¥<span class='p blue'>äºŒè¿›åˆ¶æ•°å­—</span>çš„å½¢å¼ä¿å­˜ï¼Œéƒ½ä¸€ä¸ªä¸€ä¸ªçš„å­—èŠ‚ï¼Œé‚£ä¹ˆä¼ è¾“æ—¶ä¸€æ ·å¦‚æ­¤ã€‚æ‰€ä»¥ï¼Œå­—èŠ‚æµå¯ä»¥ä¼ è¾“ä»»æ„æ–‡ä»¶æ•°æ®ã€‚åœ¨æ“ä½œæµçš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦æ—¶åˆ»æ˜ç¡®ï¼Œæ— è®ºä½¿ç”¨ä»€ä¹ˆæ ·çš„æµå¯¹è±¡ï¼Œåº•å±‚ä¼ è¾“çš„å§‹ç»ˆä¸ºäºŒè¿›åˆ¶æ•°æ®ã€‚</p><hr><h3 id="2-1-å­—èŠ‚è¾“å‡ºæµ-OutputStream">2.1 å­—èŠ‚è¾“å‡ºæµ[OutputStream]</h3><p><code>java.io.OutputStream </code>æŠ½è±¡ç±»æ˜¯è¡¨ç¤º<span class='p blue'>å­—èŠ‚è¾“å‡ºæµ</span>çš„æ‰€æœ‰ç±»çš„<span class='p green'>è¶…ç±»</span>ï¼Œå°†æŒ‡å®šçš„å­—èŠ‚ä¿¡æ¯å†™å‡ºåˆ°ç›®çš„åœ°ã€‚å®ƒå®šä¹‰äº†å­—èŠ‚è¾“å‡ºæµçš„<strong>åŸºæœ¬å…±æ€§åŠŸèƒ½æ–¹æ³•</strong>ã€‚</p><table><thead><tr><th style="text-align:left">æ–¹æ³•</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left"><code>public void close()</code></td><td style="text-align:left">å…³é—­æ­¤è¾“å‡ºæµå¹¶é‡Šæ”¾ä¸æ­¤æµç›¸å…³è”çš„ä»»ä½•ç³»ç»Ÿèµ„æº</td></tr><tr><td style="text-align:left"><code>public void flush() </code></td><td style="text-align:left">åˆ·æ–°æ­¤è¾“å‡ºæµå¹¶å¼ºåˆ¶ä»»ä½•ç¼“å†²çš„è¾“å‡ºå­—èŠ‚è¢«å†™å‡º</td></tr><tr><td style="text-align:left"><code>public void write(byte[] b)</code></td><td style="text-align:left">å°† b.lengthå­—èŠ‚ä»æŒ‡å®šçš„å­—èŠ‚æ•°ç»„å†™å…¥æ­¤è¾“å‡ºæµ</td></tr><tr><td style="text-align:left"><code>public void write(byte[] b, int off, int len)</code></td><td style="text-align:left">ä»æŒ‡å®šçš„å­—èŠ‚æ•°ç»„å†™å…¥ lenå­—èŠ‚ï¼Œä»åç§»é‡ offå¼€å§‹è¾“å‡ºåˆ°æ­¤è¾“å‡ºæµ</td></tr><tr><td style="text-align:left"><code>public abstract void write(int b)</code></td><td style="text-align:left">å°†æŒ‡å®šçš„å­—èŠ‚è¾“å‡ºæµ</td></tr></tbody></table><p>å°è´´å£«ï¼š</p><blockquote><p>closeæ–¹æ³•ï¼Œå½“å®Œæˆæµçš„æ“ä½œæ—¶ï¼Œå¿…é¡»è°ƒç”¨æ­¤æ–¹æ³•ï¼Œé‡Šæ”¾ç³»ç»Ÿèµ„æºã€‚</p></blockquote><hr><h3 id="2-2-FileOutputStreamç±»">2.2 FileOutputStreamç±»</h3><p><code>OutputStream</code>æœ‰å¾ˆå¤šå­ç±»ï¼Œæˆ‘ä»¬ä»æœ€ç®€å•çš„ä¸€ä¸ªå­ç±»å¼€å§‹ã€‚</p><p><code>java.io.FileOutputStream </code>ç±»æ˜¯æ–‡ä»¶è¾“å‡ºæµï¼Œç”¨äºå°†æ•°æ®å†™å‡ºåˆ°æ–‡ä»¶ã€‚</p><hr><h4 id="æ„é€ æ–¹æ³•">æ„é€ æ–¹æ³•</h4><ul><li><code>public FileOutputStream(File file)</code>ï¼šåˆ›å»ºæ–‡ä»¶è¾“å‡ºæµä»¥å†™å…¥ç”±æŒ‡å®šçš„ Fileå¯¹è±¡è¡¨ç¤ºçš„æ–‡ä»¶ã€‚</li><li><code>public FileOutputStream(String name)</code>ï¼š åˆ›å»ºæ–‡ä»¶è¾“å‡ºæµä»¥æŒ‡å®šçš„åç§°å†™å…¥æ–‡ä»¶ã€‚</li></ul><p>å½“ä½ åˆ›å»ºä¸€ä¸ªæµå¯¹è±¡æ—¶ï¼Œå¿…é¡»ä¼ å…¥ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ã€‚</p><p>è¯¥è·¯å¾„ä¸‹ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œä¼šåˆ›å»ºè¯¥æ–‡ä»¶ã€‚å¦‚æœæœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œä¼šæ¸…ç©ºè¿™ä¸ªæ–‡ä»¶çš„æ•°æ®ã€‚</p><p>å¦‚æœè¯¥çˆ¶çº§è·¯å¾„ä¸å­˜åœ¨ï¼Œåˆ™ä¼šæŠ›å¼‚å¸¸ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileOutputStreamConstructor</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[]args)</span>&#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨Fileå¯¹è±¡åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        File file=<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;a.txt&quot;</span>);</span><br><span class="line">        FileOutputStream fos=<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        FileOutputStream fos=<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;b.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="å†™å‡ºå­—èŠ‚æ•°æ®">å†™å‡ºå­—èŠ‚æ•°æ®</h4><div class="tabs" id="21c1247c-49c1-4bc8-b28c-26f07175856d"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#21c1247c-49c1-4bc8-b28c-26f07175856d-1"><i class="fas fa-seedling"></i>å†™å‡ºå­—èŠ‚</button></li><li class="tab"><button type="button" data-href="#21c1247c-49c1-4bc8-b28c-26f07175856d-2"><i class="fas fa-leaf"></i>å†™å‡ºå­—èŠ‚æ•°ç»„</button></li><li class="tab"><button type="button" data-href="#21c1247c-49c1-4bc8-b28c-26f07175856d-3"><i class="fab fa-apple"></i>å†™å‡ºæŒ‡å®šé•¿åº¦å­—èŠ‚æ•°ç»„</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="21c1247c-49c1-4bc8-b28c-26f07175856d-1"><p><code>write(int b)</code> æ–¹æ³•ï¼Œæ¯æ¬¡å¯ä»¥å†™å‡ºä¸€ä¸ªå­—èŠ‚æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FOSWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;fos.txt&quot;</span>);     </span><br><span class="line">      <span class="comment">// å†™å‡ºæ•°æ®</span></span><br><span class="line">      fos.write(<span class="number">97</span>); <span class="comment">// å†™å‡ºç¬¬1ä¸ªå­—èŠ‚</span></span><br><span class="line">      fos.write(<span class="number">98</span>); <span class="comment">// å†™å‡ºç¬¬2ä¸ªå­—èŠ‚</span></span><br><span class="line">      fos.write(<span class="number">99</span>); <span class="comment">// å†™å‡ºç¬¬3ä¸ªå­—èŠ‚</span></span><br><span class="line">      <span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¾“å‡ºç»“æœï¼š</span></span><br><span class="line"><span class="comment">//abc</span></span><br></pre></td></tr></table></figure><p>å°è´´å£«ï¼š</p><blockquote><ol><li>è™½ç„¶å‚æ•°ä¸ºintç±»å‹å››ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯åªä¼šä¿ç•™ä¸€ä¸ªå­—èŠ‚çš„ä¿¡æ¯å†™å‡ºã€‚</li><li>æµæ“ä½œå®Œæ¯•åï¼Œå¿…é¡»é‡Šæ”¾ç³»ç»Ÿèµ„æºï¼Œè°ƒç”¨closeæ–¹æ³•ï¼Œåƒä¸‡è®°å¾—ã€‚</li></ol></blockquote><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="21c1247c-49c1-4bc8-b28c-26f07175856d-2"><p><code>write(byte[] b)</code>ï¼Œæ¯æ¬¡å¯ä»¥å†™å‡ºæ•°ç»„ä¸­çš„æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FOSWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;fos.txt&quot;</span>);     </span><br><span class="line">      <span class="comment">// å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">      <span class="type">byte</span>[] b = <span class="string">&quot;é»‘é©¬ç¨‹åºå‘˜&quot;</span>.getBytes();</span><br><span class="line">      <span class="comment">// å†™å‡ºå­—èŠ‚æ•°ç»„æ•°æ®</span></span><br><span class="line">      fos.write(b);</span><br><span class="line">      <span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¾“å‡ºç»“æœï¼š</span></span><br><span class="line"><span class="comment">//é»‘é©¬ç¨‹åºå‘˜</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="21c1247c-49c1-4bc8-b28c-26f07175856d-3"><p><code>write(byte[] b, int off, int len)</code> ,æ¯æ¬¡å†™å‡ºä»offç´¢å¼•å¼€å§‹ï¼Œlenä¸ªå­—èŠ‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FOSWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;fos.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">        <span class="type">byte</span>[] b = <span class="string">&quot;abcde&quot;</span>.getBytes();</span><br><span class="line">        <span class="comment">// å†™å‡ºä»ç´¢å¼•2å¼€å§‹ï¼Œ2ä¸ªå­—èŠ‚ã€‚ç´¢å¼•2æ˜¯cï¼Œä¸¤ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯cdã€‚</span></span><br><span class="line">        fos.write(b,<span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¾“å‡ºç»“æœï¼š</span></span><br><span class="line"><span class="comment">//cd</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h4 id="æ•°æ®è¿½åŠ ç»­å†™">æ•°æ®è¿½åŠ ç»­å†™</h4><p>æ¯æ¬¡ç¨‹åºè¿è¡Œï¼Œåˆ›å»ºè¾“å‡ºæµå¯¹è±¡ï¼Œéƒ½ä¼šæ¸…ç©ºç›®æ ‡æ–‡ä»¶ä¸­çš„æ•°æ®ã€‚å¦‚ä½•ä¿ç•™ç›®æ ‡æ–‡ä»¶ä¸­æ•°æ®ï¼Œè¿˜èƒ½ç»§ç»­æ·»åŠ æ–°æ•°æ®å‘¢ï¼Ÿ</p><ul><li><code>public FileOutputStream(File file, boolean append)</code>ï¼š åˆ›å»ºæ–‡ä»¶è¾“å‡ºæµä»¥å†™å…¥ç”±æŒ‡å®šçš„ Fileå¯¹è±¡è¡¨ç¤ºçš„æ–‡ä»¶ã€‚</li><li><code>public FileOutputStream(String name, boolean append)</code>ï¼š åˆ›å»ºæ–‡ä»¶è¾“å‡ºæµä»¥æŒ‡å®šçš„åç§°å†™å…¥æ–‡ä»¶ã€‚</li></ul><p>è¿™ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œå‚æ•°ä¸­éƒ½éœ€è¦ä¼ å…¥ä¸€ä¸ªbooleanç±»å‹çš„å€¼ï¼Œ<code>true</code> è¡¨ç¤ºè¿½åŠ æ•°æ®ï¼Œ<code>false</code> è¡¨ç¤ºæ¸…ç©ºåŸæœ‰æ•°æ®ã€‚è¿™æ ·åˆ›å»ºçš„è¾“å‡ºæµå¯¹è±¡ï¼Œå°±å¯ä»¥æŒ‡å®šæ˜¯å¦è¿½åŠ ç»­å†™äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FOSWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;fos.txt&quot;</span>ï¼Œ<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">        <span class="type">byte</span>[] b = <span class="string">&quot;abcde&quot;</span>.getBytes();</span><br><span class="line">        <span class="comment">// å†™å‡ºä»ç´¢å¼•2å¼€å§‹ï¼Œ2ä¸ªå­—èŠ‚ã€‚ç´¢å¼•2æ˜¯cï¼Œä¸¤ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯cdã€‚</span></span><br><span class="line">        fos.write(b);</span><br><span class="line">        <span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ–‡ä»¶æ“ä½œå‰ï¼šcd</span></span><br><span class="line"><span class="comment">//æ–‡ä»¶æ“ä½œåï¼šcdabcde</span></span><br></pre></td></tr></table></figure><hr><h4 id="å†™å‡ºæ¢è¡Œ">å†™å‡ºæ¢è¡Œ</h4><p>Windowsç³»ç»Ÿé‡Œï¼Œæ¢è¡Œç¬¦å·æ˜¯<code>\r\n</code> ã€‚ä»¥æŒ‡å®šæ˜¯å¦è¿½åŠ ç»­å†™äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FOSWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;fos.txt&quot;</span>);  </span><br><span class="line">      <span class="comment">// å®šä¹‰å­—èŠ‚æ•°ç»„</span></span><br><span class="line">      <span class="type">byte</span>[] words = &#123;<span class="number">97</span>,<span class="number">98</span>,<span class="number">99</span>,<span class="number">100</span>,<span class="number">101</span>&#125;;</span><br><span class="line">      <span class="comment">// éå†æ•°ç»„</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; words.length; i++) &#123;</span><br><span class="line">          <span class="comment">// å†™å‡ºä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">            fos.write(words[i]);</span><br><span class="line">          <span class="comment">// å†™å‡ºä¸€ä¸ªæ¢è¡Œ, æ¢è¡Œç¬¦å·è½¬æˆæ•°ç»„å†™å‡º</span></span><br><span class="line">            fos.write(<span class="string">&quot;\r\n&quot;</span>.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">è¾“å‡ºç»“æœï¼š</span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">c</span><br><span class="line">d</span><br><span class="line">e</span><br></pre></td></tr></table></figure><ul><li>å›è½¦ç¬¦<code>\r</code>å’Œæ¢è¡Œç¬¦<code>\n</code> ï¼š<ul><li>å›è½¦ç¬¦ï¼šå›åˆ°ä¸€è¡Œçš„å¼€å¤´ï¼ˆreturnï¼‰ã€‚</li><li>æ¢è¡Œç¬¦ï¼šä¸‹ä¸€è¡Œï¼ˆnewlineï¼‰ã€‚</li></ul></li><li>ç³»ç»Ÿä¸­çš„æ¢è¡Œï¼š<ul><li>Windowsç³»ç»Ÿé‡Œï¼Œæ¯è¡Œç»“å°¾æ˜¯ <code>å›è½¦+æ¢è¡Œ</code> ï¼Œå³<code>\r\n</code>ï¼›</li><li>Unixç³»ç»Ÿé‡Œï¼Œæ¯è¡Œç»“å°¾åªæœ‰ <code>æ¢è¡Œ</code> ï¼Œå³<code>\n</code>ï¼›</li><li>Macç³»ç»Ÿé‡Œï¼Œæ¯è¡Œç»“å°¾æ˜¯ <code>å›è½¦</code> ï¼Œå³<code>\r</code>ã€‚ä» Mac OS Xå¼€å§‹ä¸Linuxç»Ÿä¸€ã€‚</li></ul></li></ul><hr><hr><h3 id="2-3-å­—èŠ‚è¾“å…¥æµ-InputStream">2.3 å­—èŠ‚è¾“å…¥æµ[InputStream]</h3><p><code>java.io.InputStream </code>æŠ½è±¡ç±»æ˜¯è¡¨ç¤º<span class='p blue'>å­—èŠ‚è¾“å…¥æµ</span>çš„æ‰€æœ‰ç±»çš„<span class='p green'>è¶…ç±»</span>ï¼Œå¯ä»¥è¯»å–å­—èŠ‚ä¿¡æ¯åˆ°å†…å­˜ä¸­ã€‚å®ƒå®šä¹‰äº†å­—èŠ‚è¾“å…¥æµçš„<strong>åŸºæœ¬å…±æ€§åŠŸèƒ½æ–¹æ³•</strong>ã€‚</p><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>public void close()</code></td><td>å…³é—­æ­¤è¾“å…¥æµå¹¶é‡Šæ”¾ä¸æ­¤æµç›¸å…³è”çš„ä»»ä½•ç³»ç»Ÿèµ„æº</td></tr><tr><td><code>public abstract int read()</code></td><td>ä»è¾“å…¥æµè¯»å–æ•°æ®çš„ä¸‹ä¸€ä¸ªå­—èŠ‚</td></tr><tr><td><code>public int read(byte[] b)</code></td><td>ä»è¾“å…¥æµä¸­è¯»å–ä¸€äº›å­—èŠ‚æ•°ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åˆ°å­—èŠ‚æ•°ç»„ bä¸­</td></tr></tbody></table><hr><h3 id="2-4-FileInputStreamç±»">2.4 FileInputStreamç±»</h3><p><code>java.io.FileInputStream </code>ç±»æ˜¯æ–‡ä»¶è¾“å…¥æµï¼Œä»æ–‡ä»¶ä¸­è¯»å–å­—èŠ‚ã€‚</p><hr><h4 id="æ„é€ æ–¹æ³•-2">æ„é€ æ–¹æ³•</h4><ul><li><code>FileInputStream(File file)</code>ï¼š é€šè¿‡æ‰“å¼€ä¸å®é™…æ–‡ä»¶çš„è¿æ¥æ¥åˆ›å»ºä¸€ä¸ª FileInputStream ï¼Œè¯¥æ–‡ä»¶ç”±æ–‡ä»¶ç³»ç»Ÿä¸­çš„ Fileå¯¹è±¡ fileå‘½åã€‚</li><li><code>FileInputStream(String name)</code>ï¼š é€šè¿‡æ‰“å¼€ä¸å®é™…æ–‡ä»¶çš„è¿æ¥æ¥åˆ›å»ºä¸€ä¸ª FileInputStream ï¼Œè¯¥æ–‡ä»¶ç”±æ–‡ä»¶ç³»ç»Ÿä¸­çš„è·¯å¾„å nameå‘½åã€‚</li></ul><p>å½“ä½ åˆ›å»ºä¸€ä¸ªæµå¯¹è±¡æ—¶ï¼Œå¿…é¡»ä¼ å…¥ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ã€‚è¯¥è·¯å¾„ä¸‹ï¼Œå¦‚æœæ²¡æœ‰è¯¥æ–‡ä»¶,ä¼šæŠ›å‡º<code>FileNotFoundException</code> ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileInputStreamConstructor</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨Fileå¯¹è±¡åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;a.txt&quot;</span>);</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;b.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="è¯»å–å­—èŠ‚æ•°æ®">è¯»å–å­—èŠ‚æ•°æ®</h4><div class="tabs" id="de55a6fe-5f85-42d2-8091-b9d3495e2f38"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#de55a6fe-5f85-42d2-8091-b9d3495e2f38-1"><i class="fas fa-cat"></i>è¯»å–å­—èŠ‚</button></li><li class="tab"><button type="button" data-href="#de55a6fe-5f85-42d2-8091-b9d3495e2f38-2"><i class="fas fa-horse"></i>ä½¿ç”¨å­—èŠ‚æ•°ç»„è¯»å–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="de55a6fe-5f85-42d2-8091-b9d3495e2f38-1"><p><code>read</code>æ–¹æ³•ï¼Œæ¯æ¬¡å¯ä»¥è¯»å–ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œ<span class='p red'>è‡ªåŠ¨æå‡ä¸ºintç±»å‹</span>ï¼Œè¯»å–åˆ°æ–‡ä»¶æœ«å°¾ï¼Œè¿”å›`-1</p><p><mark class="hl-label blue">å¾ªç¯è¯»å–æ–¹å¼</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FISRead</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">      <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">       <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;read.txt&quot;</span>);</span><br><span class="line">      <span class="comment">// å®šä¹‰å˜é‡ï¼Œä¿å­˜æ•°æ®</span></span><br><span class="line">        <span class="type">int</span> b ï¼›</span><br><span class="line">        <span class="comment">// å¾ªç¯è¯»å–</span></span><br><span class="line">        <span class="keyword">while</span> ((b = fis.read())!=-<span class="number">1</span>) &#123;</span><br><span class="line">            System.out.println((<span class="type">char</span>)b);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¾“å‡ºç»“æœï¼š</span></span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">c</span><br><span class="line">d</span><br><span class="line">e</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="de55a6fe-5f85-42d2-8091-b9d3495e2f38-2"><p><code>read(byte[] b)</code>ï¼Œæ¯æ¬¡è¯»å–bçš„é•¿åº¦ä¸ªå­—èŠ‚åˆ°æ•°ç»„ä¸­ï¼Œè¿”å›è¯»å–åˆ°çš„æœ‰æ•ˆå­—èŠ‚ä¸ªæ•°ï¼Œè¯»å–åˆ°æœ«å°¾æ—¶ï¼Œè¿”å›<code>-1</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FISRead</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">      <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡.</span></span><br><span class="line">       <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;read.txt&quot;</span>); <span class="comment">// æ–‡ä»¶ä¸­ä¸ºabcde</span></span><br><span class="line">      <span class="comment">// å®šä¹‰å˜é‡ï¼Œä½œä¸ºæœ‰æ•ˆä¸ªæ•°</span></span><br><span class="line">        <span class="type">int</span> len ï¼›</span><br><span class="line">        <span class="comment">// å®šä¹‰å­—èŠ‚æ•°ç»„ï¼Œä½œä¸ºè£…å­—èŠ‚æ•°æ®çš„å®¹å™¨   </span></span><br><span class="line">        <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">2</span>];</span><br><span class="line">        <span class="comment">// å¾ªç¯è¯»å–</span></span><br><span class="line">        <span class="keyword">while</span> (( len= fis.read(b))!=-<span class="number">1</span>) &#123;</span><br><span class="line">           <span class="comment">// æ¯æ¬¡è¯»å–å,æŠŠæ•°ç»„çš„æœ‰æ•ˆå­—èŠ‚éƒ¨åˆ†ï¼Œå˜æˆå­—ç¬¦ä¸²æ‰“å°</span></span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(bï¼Œ<span class="number">0</span>ï¼Œlen));<span class="comment">//  len æ¯æ¬¡è¯»å–çš„æœ‰æ•ˆå­—èŠ‚ä¸ªæ•°</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¾“å‡ºç»“æœï¼š</span></span><br><span class="line">ab</span><br><span class="line">cd</span><br><span class="line">e</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="2-5-å­—èŠ‚æµç»ƒä¹ -å›¾ç‰‡å¤åˆ¶">2.5 å­—èŠ‚æµç»ƒä¹ :å›¾ç‰‡å¤åˆ¶</h3><mark class="hl-label blue">å¤åˆ¶åŸç†å›¾è§£</mark> <p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2_copy.jpg" alt=""></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Copy</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 1.åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="comment">// 1.1 æŒ‡å®šæ•°æ®æº</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/Users/fortune/Downloads/test.png&quot;</span>);</span><br><span class="line">        <span class="comment">// 1.2 æŒ‡å®šç›®çš„åœ°</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;test_copy.jpg&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.è¯»å†™æ•°æ®</span></span><br><span class="line">        <span class="comment">// 2.1 å®šä¹‰æ•°ç»„</span></span><br><span class="line">        <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="comment">// 2.2 å®šä¹‰é•¿åº¦</span></span><br><span class="line">        <span class="type">int</span> len;</span><br><span class="line">        <span class="comment">// 2.3 å¾ªç¯è¯»å–</span></span><br><span class="line">        <span class="keyword">while</span> ((len = fis.read(b))!=-<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 2.4 å†™å‡ºæ•°æ®</span></span><br><span class="line">            fos.write(b, <span class="number">0</span> , len);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.å…³é—­èµ„æº</span></span><br><span class="line">        fos.close();</span><br><span class="line">        fis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><mark class="hl-label blue">å°è´´å£«-æµçš„å…³é—­åŸåˆ™</mark> <p>å…ˆå¼€åå…³ï¼Œåå¼€å…ˆå…³</p><hr><hr><h2 id="3-å­—ç¬¦ç¼–ç å’Œå­—ç¬¦é›†">3 å­—ç¬¦ç¼–ç å’Œå­—ç¬¦é›†</h2><h3 id="å­—ç¬¦ç¼–ç ">å­—ç¬¦ç¼–ç </h3><p>è®¡ç®—æœºä¸­å‚¨å­˜çš„ä¿¡æ¯éƒ½æ˜¯ç”¨äºŒè¿›åˆ¶æ•°è¡¨ç¤ºçš„ï¼Œè€Œæˆ‘ä»¬åœ¨å±å¹•ä¸Šçœ‹åˆ°çš„æ•°å­—ã€è‹±æ–‡ã€æ ‡ç‚¹ç¬¦å·ã€æ±‰å­—ç­‰å­—ç¬¦æ˜¯äºŒè¿›åˆ¶æ•°è½¬æ¢ä¹‹åçš„ç»“æœã€‚æŒ‰ç…§æŸç§è§„åˆ™ï¼Œå°†å­—ç¬¦å­˜å‚¨åˆ°è®¡ç®—æœºä¸­ï¼Œç§°ä¸º<span class='p blue'>ç¼–ç </span> ã€‚åä¹‹ï¼Œå°†å­˜å‚¨åœ¨è®¡ç®—æœºä¸­çš„äºŒè¿›åˆ¶æ•°æŒ‰ç…§æŸç§è§„åˆ™è§£ææ˜¾ç¤ºå‡ºæ¥ï¼Œç§°ä¸º<span class='p green'>è§£ç </span> ã€‚</p><p>æ¯”å¦‚è¯´ï¼ŒæŒ‰ç…§Aè§„åˆ™å­˜å‚¨ï¼ŒåŒæ ·æŒ‰ç…§Aè§„åˆ™è§£æï¼Œé‚£ä¹ˆå°±èƒ½æ˜¾ç¤ºæ­£ç¡®çš„æ–‡æœ¬ç¬¦å·ã€‚åä¹‹ï¼ŒæŒ‰ç…§Aè§„åˆ™å­˜å‚¨ï¼Œå†æŒ‰ç…§Bè§„åˆ™è§£æï¼Œå°±ä¼šå¯¼è‡´ä¹±ç ç°è±¡ã€‚</p><p>ç¼–ç :å­—ç¬¦(èƒ½çœ‹æ‡‚çš„)â€“å­—èŠ‚(çœ‹ä¸æ‡‚çš„)</p><p>è§£ç :å­—èŠ‚(çœ‹ä¸æ‡‚çš„)â€“&gt;å­—ç¬¦(èƒ½çœ‹æ‡‚çš„)</p><p>å­—ç¬¦ç¼–ç <code>Character Encoding</code> : å°±æ˜¯ä¸€å¥—è‡ªç„¶è¯­è¨€çš„å­—ç¬¦ä¸äºŒè¿›åˆ¶æ•°ä¹‹é—´çš„å¯¹åº”è§„åˆ™ã€‚</p><p>ç¼–ç è¡¨:ç”Ÿæ´»ä¸­æ–‡å­—å’Œè®¡ç®—æœºä¸­äºŒè¿›åˆ¶çš„å¯¹åº”è§„åˆ™</p><h3 id="å­—ç¬¦é›†">å­—ç¬¦é›†</h3><p>å­—ç¬¦é›† <code>Charset</code>ï¼šä¹Ÿå«ç¼–ç è¡¨ã€‚æ˜¯ä¸€ä¸ªç³»ç»Ÿæ”¯æŒçš„æ‰€æœ‰å­—ç¬¦çš„é›†åˆï¼ŒåŒ…æ‹¬å„å›½å®¶æ–‡å­—ã€æ ‡ç‚¹ç¬¦å·ã€å›¾å½¢ç¬¦å·ã€æ•°å­—ç­‰ã€‚</p><p>è®¡ç®—æœºè¦å‡†ç¡®çš„å­˜å‚¨å’Œè¯†åˆ«å„ç§å­—ç¬¦é›†ç¬¦å·ï¼Œéœ€è¦è¿›è¡Œå­—ç¬¦ç¼–ç ï¼Œä¸€å¥—å­—ç¬¦é›†å¿…ç„¶è‡³å°‘æœ‰ä¸€å¥—å­—ç¬¦ç¼–ç ã€‚å¸¸è§å­—ç¬¦é›†æœ‰ASCIIå­—ç¬¦é›†ã€GBKå­—ç¬¦é›†ã€Unicodeå­—ç¬¦é›†ç­‰ã€‚<img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1_charset.jpg" alt=""></p><p>å¯è§ï¼Œå½“æŒ‡å®šäº†<span class='p blue'>ç¼–ç </span>ï¼Œå®ƒæ‰€å¯¹åº”çš„<span class='p green'>å­—ç¬¦é›†</span>è‡ªç„¶å°±æŒ‡å®šäº†ï¼Œæ‰€ä»¥<span class='p blue'>ç¼–ç </span>æ‰æ˜¯æˆ‘ä»¬æœ€ç»ˆè¦å…³å¿ƒçš„ã€‚</p><ul><li>ASCIIå­—ç¬¦é›† ï¼š<ul><li>ASCIIï¼ˆAmerican Standard Code for Information Interchangeï¼Œç¾å›½ä¿¡æ¯äº¤æ¢æ ‡å‡†ä»£ç ï¼‰æ˜¯åŸºäºæ‹‰ä¸å­—æ¯çš„ä¸€å¥—ç”µè„‘ç¼–ç ç³»ç»Ÿï¼Œç”¨äºæ˜¾ç¤ºç°ä»£è‹±è¯­ï¼Œä¸»è¦åŒ…æ‹¬æ§åˆ¶å­—ç¬¦ï¼ˆå›è½¦é”®ã€é€€æ ¼ã€æ¢è¡Œé”®ç­‰ï¼‰å’Œå¯æ˜¾ç¤ºå­—ç¬¦ï¼ˆè‹±æ–‡å¤§å°å†™å­—ç¬¦ã€é˜¿æ‹‰ä¼¯æ•°å­—å’Œè¥¿æ–‡ç¬¦å·ï¼‰ã€‚</li><li>åŸºæœ¬çš„ASCIIå­—ç¬¦é›†ï¼Œä½¿ç”¨7ä½ï¼ˆbitsï¼‰è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œå…±128å­—ç¬¦ã€‚ASCIIçš„æ‰©å±•å­—ç¬¦é›†ä½¿ç”¨8ä½ï¼ˆbitsï¼‰è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œå…±256å­—ç¬¦ï¼Œæ–¹ä¾¿æ”¯æŒæ¬§æ´²å¸¸ç”¨å­—ç¬¦ã€‚</li></ul></li><li>ISO-8859-1å­—ç¬¦é›†ï¼š<ul><li>æ‹‰ä¸ç è¡¨ï¼Œåˆ«åLatin-1ï¼Œç”¨äºæ˜¾ç¤ºæ¬§æ´²ä½¿ç”¨çš„è¯­è¨€ï¼ŒåŒ…æ‹¬è·å…°ã€ä¸¹éº¦ã€å¾·è¯­ã€æ„å¤§åˆ©è¯­ã€è¥¿ç­ç‰™è¯­ç­‰ã€‚</li><li>ISO-8859-1ä½¿ç”¨å•å­—èŠ‚ç¼–ç ï¼Œå…¼å®¹ASCIIç¼–ç ã€‚</li></ul></li><li>GBxxxå­—ç¬¦é›†ï¼š<ul><li>GBå°±æ˜¯å›½æ ‡çš„æ„æ€ï¼Œæ˜¯ä¸ºäº†æ˜¾ç¤ºä¸­æ–‡è€Œè®¾è®¡çš„ä¸€å¥—å­—ç¬¦é›†ã€‚</li><li>GB2312ï¼šç®€ä½“ä¸­æ–‡ç è¡¨ã€‚ä¸€ä¸ªå°äº127çš„å­—ç¬¦çš„æ„ä¹‰ä¸åŸæ¥ç›¸åŒã€‚ä½†ä¸¤ä¸ªå¤§äº127çš„å­—ç¬¦è¿åœ¨ä¸€èµ·æ—¶ï¼Œå°±è¡¨ç¤ºä¸€ä¸ªæ±‰å­—ï¼Œè¿™æ ·å¤§çº¦å¯ä»¥ç»„åˆäº†åŒ…å«7000å¤šä¸ªç®€ä½“æ±‰å­—ï¼Œæ­¤å¤–æ•°å­¦ç¬¦å·ã€ç½—é©¬å¸Œè…Šçš„å­—æ¯ã€æ—¥æ–‡çš„å‡åä»¬éƒ½ç¼–è¿›å»äº†ï¼Œè¿åœ¨ASCIIé‡Œæœ¬æ¥å°±æœ‰çš„æ•°å­—ã€æ ‡ç‚¹ã€å­—æ¯éƒ½ç»Ÿç»Ÿé‡æ–°ç¼–äº†ä¸¤ä¸ªå­—èŠ‚é•¿çš„ç¼–ç ï¼Œè¿™å°±æ˜¯å¸¸è¯´çš„&quot;å…¨è§’&quot;å­—ç¬¦ï¼Œè€ŒåŸæ¥åœ¨127å·ä»¥ä¸‹çš„é‚£äº›å°±å«&quot;åŠè§’&quot;å­—ç¬¦äº†ã€‚</li><li>GBKï¼šæœ€å¸¸ç”¨çš„ä¸­æ–‡ç è¡¨ã€‚æ˜¯åœ¨GB2312æ ‡å‡†åŸºç¡€ä¸Šçš„æ‰©å±•è§„èŒƒï¼Œä½¿ç”¨äº†åŒå­—èŠ‚ç¼–ç æ–¹æ¡ˆï¼Œå…±æ”¶å½•äº†21003ä¸ªæ±‰å­—ï¼Œå®Œå…¨å…¼å®¹GB2312æ ‡å‡†ï¼ŒåŒæ—¶æ”¯æŒç¹ä½“æ±‰å­—ä»¥åŠæ—¥éŸ©æ±‰å­—ç­‰ã€‚</li><li>GB18030ï¼šæœ€æ–°çš„ä¸­æ–‡ç è¡¨ã€‚æ”¶å½•æ±‰å­—70244ä¸ªï¼Œé‡‡ç”¨å¤šå­—èŠ‚ç¼–ç ï¼Œæ¯ä¸ªå­—å¯ä»¥ç”±1ä¸ªã€2ä¸ªæˆ–4ä¸ªå­—èŠ‚ç»„æˆã€‚æ”¯æŒä¸­å›½å›½å†…å°‘æ•°æ°‘æ—çš„æ–‡å­—ï¼ŒåŒæ—¶æ”¯æŒç¹ä½“æ±‰å­—ä»¥åŠæ—¥éŸ©æ±‰å­—ç­‰ã€‚</li></ul></li><li>Unicodeå­—ç¬¦é›† ï¼š<ul><li>Unicodeç¼–ç ç³»ç»Ÿä¸ºè¡¨è¾¾ä»»æ„è¯­è¨€çš„ä»»æ„å­—ç¬¦è€Œè®¾è®¡ï¼Œæ˜¯ä¸šç•Œçš„ä¸€ç§æ ‡å‡†ï¼Œä¹Ÿç§°ä¸ºç»Ÿä¸€ç ã€æ ‡å‡†ä¸‡å›½ç ã€‚</li><li>å®ƒæœ€å¤šä½¿ç”¨4ä¸ªå­—èŠ‚çš„æ•°å­—æ¥è¡¨è¾¾æ¯ä¸ªå­—æ¯ã€ç¬¦å·ï¼Œæˆ–è€…æ–‡å­—ã€‚æœ‰ä¸‰ç§ç¼–ç æ–¹æ¡ˆï¼ŒUTF-8ã€UTF-16å’ŒUTF-32ã€‚æœ€ä¸ºå¸¸ç”¨çš„UTF-8ç¼–ç ã€‚</li><li>UTF-8ç¼–ç ï¼Œå¯ä»¥ç”¨æ¥è¡¨ç¤ºUnicodeæ ‡å‡†ä¸­ä»»ä½•å­—ç¬¦ï¼Œå®ƒæ˜¯ç”µå­é‚®ä»¶ã€ç½‘é¡µåŠå…¶ä»–å­˜å‚¨æˆ–ä¼ é€æ–‡å­—çš„åº”ç”¨ä¸­ï¼Œä¼˜å…ˆé‡‡ç”¨çš„ç¼–ç ã€‚äº’è”ç½‘å·¥ç¨‹å·¥ä½œå°ç»„ï¼ˆIETFï¼‰è¦æ±‚æ‰€æœ‰äº’è”ç½‘åè®®éƒ½å¿…é¡»æ”¯æŒUTF-8ç¼–ç ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¼€å‘Webåº”ç”¨ï¼Œä¹Ÿè¦ä½¿ç”¨UTF-8ç¼–ç ã€‚å®ƒä½¿ç”¨ä¸€è‡³å››ä¸ªå­—èŠ‚ä¸ºæ¯ä¸ªå­—ç¬¦ç¼–ç ï¼Œç¼–ç è§„åˆ™ï¼š<ol><li>128ä¸ªUS-ASCIIå­—ç¬¦ï¼Œåªéœ€ä¸€ä¸ªå­—èŠ‚ç¼–ç ã€‚</li><li>æ‹‰ä¸æ–‡ç­‰å­—ç¬¦ï¼Œéœ€è¦äºŒä¸ªå­—èŠ‚ç¼–ç ã€‚</li><li>å¤§éƒ¨åˆ†å¸¸ç”¨å­—ï¼ˆå«ä¸­æ–‡ï¼‰ï¼Œä½¿ç”¨ä¸‰ä¸ªå­—èŠ‚ç¼–ç ã€‚</li><li>å…¶ä»–æå°‘ä½¿ç”¨çš„Unicodeè¾…åŠ©å­—ç¬¦ï¼Œä½¿ç”¨å››å­—èŠ‚ç¼–ç ã€‚</li></ol></li></ul></li></ul><div class="tabs" id="184ab7b2-45a9-47d5-b04c-fa10b15e6949"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#184ab7b2-45a9-47d5-b04c-fa10b15e6949-1"><i class="fas fa-cat"></i>ASCII</button></li><li class="tab"><button type="button" data-href="#184ab7b2-45a9-47d5-b04c-fa10b15e6949-2"><i class="fas fa-dragon"></i>GBK</button></li><li class="tab"><button type="button" data-href="#184ab7b2-45a9-47d5-b04c-fa10b15e6949-3"><i class="fas fa-horse"></i>GBK-è‹±æ–‡</button></li><li class="tab"><button type="button" data-href="#184ab7b2-45a9-47d5-b04c-fa10b15e6949-4"><i class="fas fa-dove"></i>GBK-ä¸­æ–‡</button></li><li class="tab"><button type="button" data-href="#184ab7b2-45a9-47d5-b04c-fa10b15e6949-5"><i class="fas fa-heartbeat"></i>ç»ƒä¹ 1</button></li><li class="tab"><button type="button" data-href="#184ab7b2-45a9-47d5-b04c-fa10b15e6949-6"><i class="fas fa-cookie-bite"></i>Unicode</button></li><li class="tab"><button type="button" data-href="#184ab7b2-45a9-47d5-b04c-fa10b15e6949-7"><i class="fas fa-seedling"></i>ç»ƒä¹ 2</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="184ab7b2-45a9-47d5-b04c-fa10b15e6949-1"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605105932374.png" alt="image-20230605105932374" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="184ab7b2-45a9-47d5-b04c-fa10b15e6949-2"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605110521924.png" alt="image-20230605110521924"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="184ab7b2-45a9-47d5-b04c-fa10b15e6949-3"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605110159762.png" alt="image-20230605110159762" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="184ab7b2-45a9-47d5-b04c-fa10b15e6949-4"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605110902419.png" alt="image-20230605110902419" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="184ab7b2-45a9-47d5-b04c-fa10b15e6949-5"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605110938055.png" alt="image-20230605110938055" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="184ab7b2-45a9-47d5-b04c-fa10b15e6949-6"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605111250559.png" alt="image-20230605111250559" style="zoom:67%;" /><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605111345585.png" alt="image-20230605111345585" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="184ab7b2-45a9-47d5-b04c-fa10b15e6949-7"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605111953146.png" alt="image-20230605111953146"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="ç¼–ç å¼•å‡ºçš„é—®é¢˜">ç¼–ç å¼•å‡ºçš„é—®é¢˜</h3><p>åœ¨IDEAä¸­ï¼Œä½¿ç”¨<code>FileReader</code> è¯»å–é¡¹ç›®ä¸­çš„æ–‡æœ¬æ–‡ä»¶ã€‚ç”±äºIDEAçš„è®¾ç½®ï¼Œéƒ½æ˜¯é»˜è®¤çš„<code>UTF-8</code>ç¼–ç ï¼Œæ‰€ä»¥æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚ä½†æ˜¯ï¼Œå½“è¯»å–Windowsç³»ç»Ÿä¸­åˆ›å»ºçš„æ–‡æœ¬æ–‡ä»¶æ—¶ï¼Œç”±äºWindowsç³»ç»Ÿçš„é»˜è®¤æ˜¯GBKç¼–ç ï¼Œå°±ä¼šå‡ºç°ä¹±ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReaderDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">FileReader</span> <span class="variable">fileReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;E:\\File_GBK.txt&quot;</span>);</span><br><span class="line">        <span class="type">int</span> read;</span><br><span class="line">        <span class="keyword">while</span> ((read = fileReader.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">            System.out.print((<span class="type">char</span>)read);</span><br><span class="line">        &#125;</span><br><span class="line">        fileReader.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">è¾“å‡ºç»“æœï¼š</span><br><span class="line">ï¿½ï¿½ï¿½</span><br></pre></td></tr></table></figure><hr><h3 id="ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¹±ç ">ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¹±ç </h3><div class="tabs" id="772e38d1-bb09-4f2e-b77a-e4f2ea15ea94"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#772e38d1-bb09-4f2e-b77a-e4f2ea15ea94-1"><i class="fas fa-atom"></i>è¯»å–æ•°æ®æ—¶æœªè¯»å®Œæ•´ä¸ªæ±‰å­—</button></li><li class="tab"><button type="button" data-href="#772e38d1-bb09-4f2e-b77a-e4f2ea15ea94-2"><i class="far fa-sun"></i>ç¼–ç å’Œè§£ç æ—¶çš„æ–¹å¼ä¸ç»Ÿä¸€</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="772e38d1-bb09-4f2e-b77a-e4f2ea15ea94-1"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605112545784.png" alt="image-20230605112545784" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="772e38d1-bb09-4f2e-b77a-e4f2ea15ea94-2"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605112647860.png" alt="image-20230605112647860" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="å¦‚ä½•é¿å…ä¹±ç ">å¦‚ä½•é¿å…ä¹±ç </h3><ol><li>ä¸è¦ç”¨å­—èŠ‚æµè¯»å–æ–‡æœ¬æ–‡ä»¶</li><li>ç¼–ç è§£ç æ—¶ä½¿ç”¨åŒä¸€ä¸ªç è¡¨ï¼ŒåŒä¸€ä¸ªç¼–ç æ–¹å¼</li></ol><hr><h3 id="Javaä¸­ç¼–ç ä¸è§£ç ">Javaä¸­ç¼–ç ä¸è§£ç </h3><table><thead><tr><th>Stringç±»ä¸­æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>public byte[] geyBytes()</code></td><td>ä½¿ç”¨é»˜è®¤æ–¹å¼è¿›è¡Œç¼–ç </td></tr><tr><td><code>public byte[] getBytes(String charsetName)</code></td><td>ä½¿ç”¨æŒ‡å®šæ–¹å¼è¿›è¡Œç¼–ç </td></tr><tr><td><code>String(byte[] bytes)</code></td><td>ä½¿ç”¨é»˜è®¤æ–¹å¼è¿›è¡Œè§£ç </td></tr><tr><td><code>String(byte[] bytes, String charsetName)</code></td><td>ä½¿ç”¨æŒ‡å®šæ–¹å¼è¿›è¡Œè§£ç </td></tr></tbody></table><hr><hr><h2 id="4-å­—ç¬¦æµ">4. å­—ç¬¦æµ</h2><p>å½“ä½¿ç”¨å­—èŠ‚æµè¯»å–æ–‡æœ¬æ–‡ä»¶æ—¶ï¼Œå¯èƒ½ä¼šæœ‰ä¸€ä¸ªå°é—®é¢˜ã€‚å°±æ˜¯é‡åˆ°ä¸­æ–‡å­—ç¬¦æ—¶ï¼Œå¯èƒ½ä¸ä¼šæ˜¾ç¤ºå®Œæ•´çš„å­—ç¬¦ï¼Œé‚£æ˜¯å› ä¸ºä¸€ä¸ªä¸­æ–‡å­—ç¬¦å¯èƒ½å ç”¨å¤šä¸ªå­—èŠ‚å­˜å‚¨ã€‚æ‰€ä»¥Javaæä¾›ä¸€äº›å­—ç¬¦æµç±»ï¼Œä»¥å­—ç¬¦ä¸ºå•ä½è¯»å†™æ•°æ®ï¼Œä¸“é—¨ç”¨äºå¤„ç†æ–‡æœ¬æ–‡ä»¶ã€‚</p><span class='p red'>å­—ç¬¦æµçš„åº•å±‚å…¶å®å°±æ˜¯å­—èŠ‚æµ</span><p>å­—ç¬¦æµ= å­—èŠ‚æµ+å­—ç¬¦é›†</p><span class='p green'>ç‰¹ç‚¹</span><p>è¾“å…¥æµï¼šä¸€æ¬¡è¯»ä¸€ä¸ªå­—èŠ‚ï¼Œé‡åˆ°ä¸­æ–‡æ—¶ï¼Œä¸€æ¬¡è¯»å¤šä¸ªå­—èŠ‚</p><span class='p blue'>ä½¿ç”¨åœºæ™¯</span><p>å¯¹äºçº¯æ–‡æœ¬æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œ</p><hr><h3 id="4-1-å­—ç¬¦è¾“å…¥æµ-Reader">4.1 å­—ç¬¦è¾“å…¥æµ[Reader]</h3><p><code>java.io.Reader</code>æŠ½è±¡ç±»æ˜¯è¡¨ç¤ºç”¨äºè¯»å–<span class='p blue'>å­—ç¬¦æµ</span>çš„æ‰€æœ‰ç±»çš„<span class='p green'>å­—ç¬¦æµ</span>ï¼Œå¯ä»¥è¯»å–å­—ç¬¦ä¿¡æ¯åˆ°å†…å­˜ä¸­ã€‚å®ƒå®šä¹‰äº†å­—ç¬¦è¾“å…¥æµçš„åŸºæœ¬å…±æ€§åŠŸèƒ½æ–¹æ³•ã€‚</p><table><thead><tr><th style="text-align:left">æ–¹æ³•</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left"><code>public void close()</code></td><td style="text-align:left">å…³é—­æ­¤æµå¹¶é‡Šæ”¾ä¸æ­¤æµç›¸å…³è”çš„ä»»ä½•ç³»ç»Ÿèµ„æº</td></tr><tr><td style="text-align:left"><code>public int read()</code></td><td style="text-align:left">ä»è¾“å…¥æµè¯»å–ä¸€ä¸ªå­—ç¬¦</td></tr><tr><td style="text-align:left"><code>public int read(char[] cbuf)</code></td><td style="text-align:left">ä»è¾“å…¥æµä¸­è¯»å–ä¸€äº›å­—ç¬¦ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åˆ°å­—ç¬¦æ•°ç»„ cbufä¸­</td></tr></tbody></table><h3 id="4-2-FileReaderç±»">4.2 FileReaderç±»</h3><p><code>java.io.FileReader </code>ç±»æ˜¯è¯»å–å­—ç¬¦æ–‡ä»¶çš„ä¾¿åˆ©ç±»ã€‚æ„é€ æ—¶ä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„å­—ç¬¦ç¼–ç å’Œé»˜è®¤å­—èŠ‚ç¼“å†²åŒºã€‚</p><ol><li><p>å­—ç¬¦ç¼–ç ï¼šå­—èŠ‚ä¸å­—ç¬¦çš„å¯¹åº”è§„åˆ™ã€‚Windowsç³»ç»Ÿçš„ä¸­æ–‡ç¼–ç é»˜è®¤æ˜¯GBKç¼–ç è¡¨ã€‚ideaä¸­UTF-8</p></li><li><p>å­—èŠ‚ç¼“å†²åŒºï¼šä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œç”¨æ¥ä¸´æ—¶å­˜å‚¨å­—èŠ‚æ•°æ®ã€‚</p></li></ol><hr><h4 id="æ„é€ æ–¹æ³•-3">æ„é€ æ–¹æ³•</h4><ul><li><code>FileReader(File file)</code>ï¼š åˆ›å»ºä¸€ä¸ªæ–°çš„ FileReader ï¼Œç»™å®šè¦è¯»å–çš„Fileå¯¹è±¡ã€‚</li><li><code>FileReader(String fileName)</code>ï¼š åˆ›å»ºä¸€ä¸ªæ–°çš„ FileReader ï¼Œç»™å®šè¦è¯»å–çš„æ–‡ä»¶çš„åç§°ã€‚</li></ul><p>å½“ä½ åˆ›å»ºä¸€ä¸ªæµå¯¹è±¡æ—¶ï¼Œå¿…é¡»ä¼ å…¥ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ã€‚ç±»ä¼¼äºFileInputStream ã€‚</p><ul><li>æ„é€ ä¸¾ä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileReaderConstructor</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨Fileå¯¹è±¡åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;a.txt&quot;</span>);</span><br><span class="line">        <span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(file);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;b.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="è¯»å–å­—ç¬¦æ•°æ®">è¯»å–å­—ç¬¦æ•°æ®</h4><p>å­—ç¬¦æµçš„åº•å±‚ä¹Ÿæ˜¯å­—èŠ‚æµï¼Œé»˜è®¤ä¹Ÿæ˜¯ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚çš„è¯»å–çš„ã€‚</p><p>å¦‚æœé‡åˆ°ä¸­æ–‡å°±ä¼šä¸€æ¬¡è¯»å–å¤šä¸ªï¼ŒGBKä¸€æ¬¡è¯»ä¸¤ä¸ªå­—èŠ‚ï¼ŒUTF-8ä¸€æ¬¡è¯»ä¸‰ä¸ªå­—èŠ‚</p><div class="tabs" id="b7b8e42e-fb85-44ea-96a1-96a262669edd"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#b7b8e42e-fb85-44ea-96a1-96a262669edd-1"><i class="fas fa-atom"></i>è¯»å–å­—ç¬¦</button></li><li class="tab"><button type="button" data-href="#b7b8e42e-fb85-44ea-96a1-96a262669edd-2"><i class="far fa-sun"></i>ä½¿ç”¨å­—ç¬¦æ•°ç»„è¯»å–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="b7b8e42e-fb85-44ea-96a1-96a262669edd-1"><p><code>read</code>æ–¹æ³•ï¼Œæ¯æ¬¡å¯ä»¥è¯»å–ä¸€ä¸ªå­—ç¬¦çš„æ•°æ®ï¼Œæå‡ä¸ºintç±»å‹ï¼Œè¯»å–åˆ°æ–‡ä»¶æœ«å°¾ï¼Œè¿”å›<code>-1</code></p><p><mark class="hl-label blue">éœ€è¦å¼ºè½¬</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FRRead</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">      <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">       <span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;read.txt&quot;</span>);</span><br><span class="line">      <span class="comment">// å®šä¹‰å˜é‡ï¼Œä¿å­˜æ•°æ®</span></span><br><span class="line">        <span class="type">int</span> b ï¼›</span><br><span class="line">        <span class="comment">// å¾ªç¯è¯»å–</span></span><br><span class="line">        <span class="keyword">while</span> ((b = fr.read())!=-<span class="number">1</span>) &#123;</span><br><span class="line">            System.out.println((<span class="type">char</span>)b);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fr.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¾“å‡ºç»“æœï¼š</span></span><br><span class="line">é»‘</span><br><span class="line">é©¬</span><br><span class="line">ç¨‹</span><br><span class="line">åº</span><br><span class="line">å‘˜</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b7b8e42e-fb85-44ea-96a1-96a262669edd-2"><p><code>read(char[] cbuf)</code>ï¼Œæ¯æ¬¡è¯»å–bçš„é•¿åº¦ä¸ªå­—ç¬¦åˆ°æ•°ç»„ä¸­ï¼Œè¿”å›è¯»å–åˆ°çš„æœ‰æ•ˆå­—ç¬¦ä¸ªæ•°ï¼Œè¯»å–åˆ°æœ«å°¾æ—¶ï¼Œè¿”å›<code>-1</code></p><p><mark class="hl-label blue">ä¸éœ€è¦å¼ºè½¬</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FISRead</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">      <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">       <span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;read.txt&quot;</span>);</span><br><span class="line">      <span class="comment">// å®šä¹‰å˜é‡ï¼Œä¿å­˜æœ‰æ•ˆå­—ç¬¦ä¸ªæ•°</span></span><br><span class="line">        <span class="type">int</span> len ï¼›</span><br><span class="line">        <span class="comment">// å®šä¹‰å­—ç¬¦æ•°ç»„ï¼Œä½œä¸ºè£…å­—ç¬¦æ•°æ®çš„å®¹å™¨</span></span><br><span class="line">        <span class="type">char</span>[] cbuf = <span class="keyword">new</span> <span class="title class_">char</span>[<span class="number">2</span>];</span><br><span class="line">        <span class="comment">// å¾ªç¯è¯»å–</span></span><br><span class="line">        <span class="keyword">while</span> ((len = fr.read(cbuf))!=-<span class="number">1</span>) &#123;</span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(cbuf,<span class="number">0</span>,len));</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fr.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">è¾“å‡ºç»“æœï¼š</span><br><span class="line">é»‘é©¬</span><br><span class="line">ç¨‹åº</span><br><span class="line">å‘˜</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><hr><h3 id="4-3-å­—ç¬¦è¾“å‡ºæµ-Writer">4.3 å­—ç¬¦è¾“å‡ºæµ[Writer]</h3><p><code>java.io.Writer </code>æŠ½è±¡ç±»æ˜¯è¡¨ç¤ºç”¨äº<span class='p blue'>å†™å‡ºå­—ç¬¦æµ</span>çš„æ‰€æœ‰ç±»çš„<span class='p green'>è¶…ç±»</span>ï¼Œå°†æŒ‡å®šçš„å­—ç¬¦ä¿¡æ¯å†™å‡ºåˆ°ç›®çš„åœ°ã€‚å®ƒå®šä¹‰äº†å­—èŠ‚è¾“å‡ºæµçš„åŸºæœ¬å…±æ€§åŠŸèƒ½æ–¹æ³•ã€‚</p><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>void write(int c)</code></td><td>å†™å…¥å•ä¸ªå­—ç¬¦</td></tr><tr><td><code>void write(char[] cbuf) </code></td><td>å†™å…¥å­—ç¬¦æ•°ç»„</td></tr><tr><td><code>abstract  void write(char[] cbuf, int off, int len) </code></td><td>å†™å…¥å­—ç¬¦æ•°ç»„çš„æŸä¸€éƒ¨åˆ†,offæ•°ç»„çš„å¼€å§‹ç´¢å¼•,lenå†™çš„å­—ç¬¦ä¸ªæ•°</td></tr><tr><td><code>void write(String str) </code></td><td>å†™å…¥å­—ç¬¦ä¸²</td></tr><tr><td><code>void write(String str, int off, int len)</code></td><td>å†™å…¥å­—ç¬¦ä¸²çš„æŸä¸€éƒ¨åˆ†,offå­—ç¬¦ä¸²çš„å¼€å§‹ç´¢å¼•,lenå†™çš„å­—ç¬¦ä¸ªæ•°</td></tr><tr><td><code>void flush() </code></td><td>åˆ·æ–°è¯¥æµçš„ç¼“å†²</td></tr><tr><td><code>void close()</code></td><td>å…³é—­æ­¤æµï¼Œä½†è¦å…ˆåˆ·æ–°å®ƒ</td></tr></tbody></table><hr><h3 id="4-4-FileWriterç±»">4.4 FileWriterç±»</h3><p><code>java.io.FileWriter </code>ç±»æ˜¯å†™å‡ºå­—ç¬¦åˆ°æ–‡ä»¶çš„ä¾¿åˆ©ç±»ã€‚æ„é€ æ—¶ä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„å­—ç¬¦ç¼–ç å’Œé»˜è®¤å­—èŠ‚ç¼“å†²åŒºã€‚</p><hr><h4 id="æ„é€ æ–¹æ³•-4">æ„é€ æ–¹æ³•</h4><ul><li><code>FileWriter(File file)</code>ï¼š åˆ›å»ºä¸€ä¸ªæ–°çš„ FileWriterï¼Œç»™å®šè¦è¯»å–çš„Fileå¯¹è±¡ã€‚</li><li><code>FileWriter(String fileName)</code>ï¼š åˆ›å»ºä¸€ä¸ªæ–°çš„ FileWriterï¼Œç»™å®šè¦è¯»å–çš„æ–‡ä»¶çš„åç§°ã€‚</li></ul><p>å½“ä½ åˆ›å»ºä¸€ä¸ªæµå¯¹è±¡æ—¶ï¼Œå¿…é¡»ä¼ å…¥ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ï¼Œç±»ä¼¼äºFileOutputStreamã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileWriterConstructor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨Fileå¯¹è±¡åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;a.txt&quot;</span>);</span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(file);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;b.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="å†™å‡ºå­—ç¬¦æ•°æ®">å†™å‡ºå­—ç¬¦æ•°æ®</h4><div class="tabs" id="e6d3229b-770e-460b-8f25-294467efdc76"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e6d3229b-770e-460b-8f25-294467efdc76-1"><i class="fas fa-award"></i>å†™å‡ºå­—ç¬¦</button></li><li class="tab"><button type="button" data-href="#e6d3229b-770e-460b-8f25-294467efdc76-2"><i class="fas fa-baseball-ball"></i>å†™å‡ºå­—ç¬¦æ•°ç»„</button></li><li class="tab"><button type="button" data-href="#e6d3229b-770e-460b-8f25-294467efdc76-3"><i class="fas fa-bone"></i>å†™å‡ºå­—ç¬¦ä¸²</button></li><li class="tab"><button type="button" data-href="#e6d3229b-770e-460b-8f25-294467efdc76-4"><i class="fas fa-anchor"></i>ç»­å†™å’Œæ¢è¡Œ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e6d3229b-770e-460b-8f25-294467efdc76-1"><p><code>write(int b)</code> æ–¹æ³•ï¼Œæ¯æ¬¡å¯ä»¥å†™å‡ºä¸€ä¸ªå­—ç¬¦æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FWWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;fw.txt&quot;</span>);     </span><br><span class="line">      <span class="comment">// å†™å‡ºæ•°æ®</span></span><br><span class="line">      fw.write(<span class="number">97</span>); <span class="comment">// å†™å‡ºç¬¬1ä¸ªå­—ç¬¦</span></span><br><span class="line">      fw.write(<span class="string">&#x27;b&#x27;</span>); <span class="comment">// å†™å‡ºç¬¬2ä¸ªå­—ç¬¦</span></span><br><span class="line">      fw.write(<span class="string">&#x27;C&#x27;</span>); <span class="comment">// å†™å‡ºç¬¬3ä¸ªå­—ç¬¦</span></span><br><span class="line">      fw.write(<span class="number">30000</span>); <span class="comment">// å†™å‡ºç¬¬4ä¸ªå­—ç¬¦ï¼Œä¸­æ–‡ç¼–ç è¡¨ä¸­30000å¯¹åº”ä¸€ä¸ªæ±‰å­—ã€‚</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">        ã€æ³¨æ„ã€‘å…³é—­èµ„æºæ—¶,ä¸FileOutputStreamä¸åŒã€‚</span></span><br><span class="line"><span class="comment">       å¦‚æœä¸å…³é—­,æ•°æ®åªæ˜¯ä¿å­˜åˆ°ç¼“å†²åŒºï¼Œå¹¶æœªä¿å­˜åˆ°æ–‡ä»¶ã€‚</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">// fw.close();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¾“å‡ºç»“æœï¼š</span></span><br><span class="line">abCç”°</span><br></pre></td></tr></table></figure><p>å°è´´å£«ï¼š</p><ol><li>è™½ç„¶å‚æ•°ä¸ºintç±»å‹å››ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯åªä¼šä¿ç•™ä¸€ä¸ªå­—ç¬¦çš„ä¿¡æ¯å†™å‡ºã€‚</li><li>æœªè°ƒç”¨closeæ–¹æ³•ï¼Œæ•°æ®åªæ˜¯ä¿å­˜åˆ°äº†ç¼“å†²åŒºï¼Œå¹¶æœªå†™å‡ºåˆ°æ–‡ä»¶ä¸­ã€‚</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e6d3229b-770e-460b-8f25-294467efdc76-2"><p><code>write(char[] cbuf)</code> å’Œ <code>write(char[] cbuf, int off, int len)</code> ï¼Œæ¯æ¬¡å¯ä»¥å†™å‡ºå­—ç¬¦æ•°ç»„ä¸­çš„æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FWWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;fw.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">        <span class="type">char</span>[] chars = <span class="string">&quot;é»‘é©¬ç¨‹åºå‘˜&quot;</span>.toCharArray();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å†™å‡ºå­—ç¬¦æ•°ç»„</span></span><br><span class="line">        fw.write(chars); <span class="comment">// é»‘é©¬ç¨‹åºå‘˜</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å†™å‡ºä»ç´¢å¼•2å¼€å§‹ï¼Œ2ä¸ªå­—èŠ‚ã€‚ç´¢å¼•2æ˜¯&#x27;ç¨‹&#x27;ï¼Œä¸¤ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯&#x27;ç¨‹åº&#x27;ã€‚</span></span><br><span class="line">        fw.write(b,<span class="number">2</span>,<span class="number">2</span>); <span class="comment">// ç¨‹åº</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e6d3229b-770e-460b-8f25-294467efdc76-3"><p><code>write(String str)</code> å’Œ <code>write(String str, int off, int len)</code> ï¼Œæ¯æ¬¡å¯ä»¥å†™å‡ºå­—ç¬¦ä¸²ä¸­çš„æ•°æ®ï¼Œæ›´ä¸ºæ–¹ä¾¿</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FWWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;fw.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// å­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;é»‘é©¬ç¨‹åºå‘˜&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å†™å‡ºå­—ç¬¦æ•°ç»„</span></span><br><span class="line">        fw.write(msg); <span class="comment">//é»‘é©¬ç¨‹åºå‘˜</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å†™å‡ºä»ç´¢å¼•2å¼€å§‹ï¼Œ2ä¸ªå­—èŠ‚ã€‚ç´¢å¼•2æ˜¯&#x27;ç¨‹&#x27;ï¼Œä¸¤ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯&#x27;ç¨‹åº&#x27;ã€‚</span></span><br><span class="line">        fw.write(msg, <span class="number">2</span>, <span class="number">2</span>);<span class="comment">// ç¨‹åº</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e6d3229b-770e-460b-8f25-294467efdc76-4"><p>æ“ä½œç±»ä¼¼äºFileOutputStreamã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FWWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡ï¼Œå¯ä»¥ç»­å†™æ•°æ®</span></span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;fw.txt&quot;</span>ï¼Œ<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// å†™å‡ºå­—ç¬¦ä¸²</span></span><br><span class="line">        fw.write(<span class="string">&quot;é»‘é©¬&quot;</span>);</span><br><span class="line">        <span class="comment">// å†™å‡ºæ¢è¡Œ</span></span><br><span class="line">        fw.write(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">        <span class="comment">// å†™å‡ºå­—ç¬¦ä¸²</span></span><br><span class="line">        fw.write(<span class="string">&quot;ç¨‹åºå‘˜&quot;</span>);</span><br><span class="line">        <span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">è¾“å‡ºç»“æœ:</span><br><span class="line">é»‘é©¬ </span><br><span class="line">ç¨‹åºå‘˜</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h4 id="å…³é—­å’Œåˆ·æ–°">å…³é—­å’Œåˆ·æ–°</h4><p>å› ä¸ºå†…ç½®ç¼“å†²åŒºçš„åŸå› ï¼Œå¦‚æœä¸å…³é—­è¾“å‡ºæµï¼Œæ— æ³•å†™å‡ºå­—ç¬¦åˆ°æ–‡ä»¶ä¸­ã€‚ä½†æ˜¯å…³é—­çš„æµå¯¹è±¡ï¼Œæ˜¯æ— æ³•ç»§ç»­å†™å‡ºæ•°æ®çš„ã€‚å¦‚æœæˆ‘ä»¬æ—¢æƒ³å†™å‡ºæ•°æ®ï¼Œåˆæƒ³ç»§ç»­ä½¿ç”¨æµï¼Œå°±éœ€è¦<code>flush</code> æ–¹æ³•äº†ã€‚</p><ul><li><code>flush</code> ï¼šåˆ·æ–°ç¼“å†²åŒºï¼Œæµå¯¹è±¡å¯ä»¥ç»§ç»­ä½¿ç”¨ã€‚</li><li><code>close </code>: å…ˆåˆ·æ–°ç¼“å†²åŒºï¼Œç„¶åé€šçŸ¥ç³»ç»Ÿé‡Šæ”¾èµ„æºã€‚æµå¯¹è±¡ä¸å¯ä»¥å†è¢«ä½¿ç”¨äº†ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FWWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;fw.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// å†™å‡ºæ•°æ®ï¼Œé€šè¿‡flush</span></span><br><span class="line">        fw.write(<span class="string">&#x27;åˆ·&#x27;</span>); <span class="comment">// å†™å‡ºç¬¬1ä¸ªå­—ç¬¦</span></span><br><span class="line">        fw.flush();</span><br><span class="line">        fw.write(<span class="string">&#x27;æ–°&#x27;</span>); <span class="comment">// ç»§ç»­å†™å‡ºç¬¬2ä¸ªå­—ç¬¦ï¼Œå†™å‡ºæˆåŠŸ</span></span><br><span class="line">        fw.flush();</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// å†™å‡ºæ•°æ®ï¼Œé€šè¿‡close</span></span><br><span class="line">        fw.write(<span class="string">&#x27;å…³&#x27;</span>); <span class="comment">// å†™å‡ºç¬¬1ä¸ªå­—ç¬¦</span></span><br><span class="line">        fw.close();</span><br><span class="line">        fw.write(<span class="string">&#x27;é—­&#x27;</span>); <span class="comment">// ç»§ç»­å†™å‡ºç¬¬2ä¸ªå­—ç¬¦,ã€æŠ¥é”™ã€‘java.io.IOException: Stream closed</span></span><br><span class="line">        fw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><mark class="hl-label red">å°è´´å£«</mark> <p>å³ä¾¿æ˜¯flushæ–¹æ³•å†™å‡ºäº†æ•°æ®ï¼Œæ“ä½œçš„æœ€åè¿˜æ˜¯è¦è°ƒç”¨closeæ–¹æ³•ï¼Œé‡Šæ”¾ç³»ç»Ÿèµ„æºã€‚</p><p>å­—ç¬¦æµï¼Œåªèƒ½æ“ä½œæ–‡æœ¬æ–‡ä»¶ï¼Œä¸èƒ½æ“ä½œå›¾ç‰‡ï¼Œè§†é¢‘ç­‰éæ–‡æœ¬æ–‡ä»¶ã€‚</p><p>å½“æˆ‘ä»¬å•çº¯è¯»æˆ–è€…å†™æ–‡æœ¬æ–‡ä»¶æ—¶  ä½¿ç”¨å­—ç¬¦æµ å…¶ä»–æƒ…å†µä½¿ç”¨å­—èŠ‚æµ</p><hr><hr><hr><h2 id="5-IOå¼‚å¸¸çš„å¤„ç†">5. IOå¼‚å¸¸çš„å¤„ç†</h2><div class="tabs" id="336c0b22-4fcd-45ed-a6cd-98e737540fa5"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#336c0b22-4fcd-45ed-a6cd-98e737540fa5-1"><i class="fas fa-bug"></i>JDK7å‰å¤„ç†</button></li><li class="tab"><button type="button" data-href="#336c0b22-4fcd-45ed-a6cd-98e737540fa5-2"><i class="fas fa-cannabis"></i>JDK7çš„å¤„ç†</button></li><li class="tab"><button type="button" data-href="#336c0b22-4fcd-45ed-a6cd-98e737540fa5-3"><i class="fas fa-candy-cane"></i>JDK9çš„æ”¹è¿›</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="336c0b22-4fcd-45ed-a6cd-98e737540fa5-1"><p><code>try...catch...finally</code> ä»£ç å—ï¼Œå¤„ç†å¼‚å¸¸éƒ¨åˆ†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HandleException1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">      <span class="comment">// å£°æ˜å˜é‡</span></span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">            fw = <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;fw.txt&quot;</span>);</span><br><span class="line">            <span class="comment">// å†™å‡ºæ•°æ®</span></span><br><span class="line">            fw.write(<span class="string">&quot;é»‘é©¬ç¨‹åºå‘˜&quot;</span>); <span class="comment">//é»‘é©¬ç¨‹åºå‘˜</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (fw != <span class="literal">null</span>) &#123;</span><br><span class="line">                    fw.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="336c0b22-4fcd-45ed-a6cd-98e737540fa5-2"><p><code>try-with-resource</code> è¯­å¥ï¼Œè¯¥è¯­å¥ç¡®ä¿äº†æ¯ä¸ªèµ„æºåœ¨è¯­å¥ç»“æŸæ—¶å…³é—­ã€‚æ‰€è°“çš„èµ„æºï¼ˆresourceï¼‰æ˜¯æŒ‡åœ¨ç¨‹åºå®Œæˆåï¼Œå¿…é¡»å…³é—­çš„å¯¹è±¡ã€‚</p><p>åŸç†ï¼šå®ç°äº†AutoClosableæ¥å£ï¼Œç‰¹å®šçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥è‡ªåŠ¨é‡Šæ”¾èµ„æº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (åˆ›å»ºæµå¯¹è±¡è¯­å¥ï¼Œå¦‚æœå¤šä¸ª,ä½¿ç”¨<span class="string">&#x27;;&#x27;</span>éš”å¼€) &#123;</span><br><span class="line"><span class="comment">// è¯»å†™æ•°æ®</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç ä½¿ç”¨æ¼”ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HandleException2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">      <span class="comment">// åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">try</span> ( <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;fw.txt&quot;</span>); ) &#123;</span><br><span class="line">            <span class="comment">// å†™å‡ºæ•°æ®</span></span><br><span class="line">            fw.write(<span class="string">&quot;é»‘é©¬ç¨‹åºå‘˜&quot;</span>); <span class="comment">//é»‘é©¬ç¨‹åºå‘˜</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="336c0b22-4fcd-45ed-a6cd-98e737540fa5-3"><p><code>try-with-resource</code> çš„æ”¹è¿›ï¼Œå¯¹äº<strong>å¼•å…¥å¯¹è±¡</strong>çš„æ–¹å¼ï¼Œæ”¯æŒçš„æ›´åŠ ç®€æ´ã€‚è¢«å¼•å…¥çš„å¯¹è±¡ï¼ŒåŒæ ·å¯ä»¥è‡ªåŠ¨å…³é—­ï¼Œæ— éœ€æ‰‹åŠ¨close</p><p>æ ¼å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¢«finalä¿®é¥°çš„å¯¹è±¡</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Resource</span> <span class="variable">resource1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Resource</span>(<span class="string">&quot;resource1&quot;</span>);</span><br><span class="line"><span class="comment">// æ™®é€šå¯¹è±¡</span></span><br><span class="line"><span class="type">Resource</span> <span class="variable">resource2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Resource</span>(<span class="string">&quot;resource2&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼•å…¥æ–¹å¼ï¼šç›´æ¥å¼•å…¥</span></span><br><span class="line"><span class="keyword">try</span> (resource1; resource2) &#123;</span><br><span class="line">     <span class="comment">// ä½¿ç”¨å¯¹è±¡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç ä½¿ç”¨æ¼”ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TryDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;in.txt&quot;</span>);</span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;out.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// å¼•å…¥åˆ°tryä¸­</span></span><br><span class="line">        <span class="keyword">try</span> (fr; fw) &#123;</span><br><span class="line">            <span class="comment">// å®šä¹‰å˜é‡</span></span><br><span class="line">            <span class="type">int</span> b;</span><br><span class="line">            <span class="comment">// è¯»å–æ•°æ®</span></span><br><span class="line">            <span class="keyword">while</span> ((b = fr.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// å†™å‡ºæ•°æ®</span></span><br><span class="line">                fw.write(b);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="6-ç»¼åˆç»ƒä¹ ">6. ç»¼åˆç»ƒä¹ </h2><h3 id="6-1-æ‹·è´æ–‡ä»¶å¤¹">6.1 æ‹·è´æ–‡ä»¶å¤¹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CopyDir</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//æ‹·è´ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œè€ƒè™‘å­æ–‡ä»¶å¤¹</span></span><br><span class="line">        <span class="comment">//1.åˆ›å»ºå¯¹è±¡è¡¨ç¤ºæ•°æ®æº</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">src</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/Users/fortune/Daily/è®ºæ–‡æ±‡æŠ¥&quot;</span>);</span><br><span class="line">        <span class="comment">//2.åˆ›å»ºå¯¹è±¡è¡¨ç¤ºç›®çš„åœ°</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">dest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/Users/fortune/Daily/æœªå‘½åæ–‡ä»¶å¤¹&quot;</span>);</span><br><span class="line">        <span class="comment">//3.è°ƒç”¨æ–¹æ³•å¼€å§‹æ‹·è´</span></span><br><span class="line">        copydir(src,dest);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">copydir</span><span class="params">(File src, File dest)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        dest.mkdirs();</span><br><span class="line">        <span class="comment">//é€’å½’</span></span><br><span class="line">        <span class="comment">//1.è¿›å…¥æ•°æ®æº</span></span><br><span class="line">        File[] files = src.listFiles();</span><br><span class="line">        <span class="comment">//2.éå†æ•°ç»„</span></span><br><span class="line">        <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">            <span class="keyword">if</span>(file.isFile())&#123;</span><br><span class="line">                <span class="comment">//3.åˆ¤æ–­æ–‡ä»¶ï¼Œæ‹·è´</span></span><br><span class="line">                <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">                <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(dest,file.getName()));</span><br><span class="line">                <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="type">int</span> len;</span><br><span class="line">                <span class="keyword">while</span>((len = fis.read(bytes)) != -<span class="number">1</span>)&#123;</span><br><span class="line">                    fos.write(bytes,<span class="number">0</span>,len);</span><br><span class="line">                &#125;</span><br><span class="line">                fos.close();</span><br><span class="line">                fis.close();</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//4.åˆ¤æ–­æ–‡ä»¶å¤¹ï¼Œé€’å½’</span></span><br><span class="line">                copydir(file, <span class="keyword">new</span> <span class="title class_">File</span>(dest,file.getName()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="6-2-æ•°å­—æ’åº">6.2 æ•°å­—æ’åº</h3><p>æ–‡æœ¬æ–‡ä»¶ä¸­æœ‰ä»¥ä¸‹çš„æ•°æ®ï¼š<br>2-1-9-4-7-8<br>å°†æ–‡ä»¶ä¸­çš„æ•°æ®è¿›è¡Œæ’åºï¼Œå˜æˆä»¥ä¸‹çš„æ•°æ®ï¼š<br>1-2-4-7-8-9</p><div class="tabs" id="895d1d50-960d-47e9-946c-fd0e2c421614"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#895d1d50-960d-47e9-946c-fd0e2c421614-1"><i class="fas fa-seedling"></i>å®ç°æ–¹å¼ä¸€</button></li><li class="tab"><button type="button" data-href="#895d1d50-960d-47e9-946c-fd0e2c421614-2"><i class="fas fa-leaf"></i>å®ç°æ–¹å¼äºŒ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="895d1d50-960d-47e9-946c-fd0e2c421614-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test03</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//1.è¯»å–æ•°æ®</span></span><br><span class="line">        <span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;myio\\a.txt&quot;</span>);</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="type">int</span> ch;</span><br><span class="line">        <span class="keyword">while</span>((ch = fr.read()) != -<span class="number">1</span>)&#123;</span><br><span class="line">            sb.append((<span class="type">char</span>)ch);</span><br><span class="line">        &#125;</span><br><span class="line">        fr.close();</span><br><span class="line">        System.out.println(sb);</span><br><span class="line">        <span class="comment">//2.æ’åº</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> sb.toString();</span><br><span class="line">        String[] arrStr = str.split(<span class="string">&quot;-&quot;</span>);<span class="comment">//2-1-9-4-7-8</span></span><br><span class="line"></span><br><span class="line">        ArrayList&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String s : arrStr) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> Integer.parseInt(s);</span><br><span class="line">            list.add(i);</span><br><span class="line">        &#125;</span><br><span class="line">        Collections.sort(list);</span><br><span class="line">        System.out.println(list);</span><br><span class="line">        <span class="comment">//3.å†™å‡º</span></span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;myio\\a.txt&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(i == list.size() - <span class="number">1</span>)&#123;</span><br><span class="line">                fw.write(list.get(i) + <span class="string">&quot;&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                fw.write(list.get(i) + <span class="string">&quot;-&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        fw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="895d1d50-960d-47e9-946c-fd0e2c421614-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test04</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//1.è¯»å–æ•°æ®</span></span><br><span class="line">        <span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;myio\\a.txt&quot;</span>);</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="type">int</span> ch;</span><br><span class="line">        <span class="keyword">while</span>((ch = fr.read()) != -<span class="number">1</span>)&#123;</span><br><span class="line">            sb.append((<span class="type">char</span>)ch);</span><br><span class="line">        &#125;</span><br><span class="line">        fr.close();</span><br><span class="line">        System.out.println(sb);</span><br><span class="line">        <span class="comment">//2.æ’åº</span></span><br><span class="line">        Integer[] arr = Arrays.stream(sb.toString()</span><br><span class="line">                                      .split(<span class="string">&quot;-&quot;</span>))</span><br><span class="line">            .map(Integer::parseInt)</span><br><span class="line">            .sorted()</span><br><span class="line">            .toArray(Integer[]::<span class="keyword">new</span>);</span><br><span class="line">        <span class="comment">//3.å†™å‡º</span></span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;myio\\a.txt&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> Arrays.toString(arr).replace(<span class="string">&quot;, &quot;</span>,<span class="string">&quot;-&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> s.substring(<span class="number">1</span>, s.length() - <span class="number">1</span>);</span><br><span class="line">        fw.write(result);</span><br><span class="line">        fw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="7-ç¼“å†²æµ">7. ç¼“å†²æµ</h2><h3 id="7-1-æ¦‚è¿°">7.1 æ¦‚è¿°</h3><p>ç¼“å†²æµ,ä¹Ÿå«é«˜æ•ˆæµï¼Œæ˜¯å¯¹4ä¸ªåŸºæœ¬çš„<code>FileXxx</code> æµçš„å¢å¼ºï¼Œæ‰€ä»¥ä¹Ÿæ˜¯4ä¸ªæµï¼ŒæŒ‰ç…§æ•°æ®ç±»å‹åˆ†ç±»ï¼š</p><ul><li><strong>å­—èŠ‚ç¼“å†²æµ</strong>ï¼š<code>BufferedInputStream</code>ï¼Œ<code>BufferedOutputStream</code></li><li><strong>å­—ç¬¦ç¼“å†²æµ</strong>ï¼š<code>BufferedReader</code>ï¼Œ<code>BufferedWriter</code></li></ul><p>ç¼“å†²æµçš„åŸºæœ¬åŸç†ï¼Œæ˜¯åœ¨åˆ›å»ºæµå¯¹è±¡æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªå†…ç½®çš„é»˜è®¤å¤§å°çš„ç¼“å†²åŒºæ•°ç»„ï¼Œé€šè¿‡ç¼“å†²åŒºè¯»å†™ï¼Œå‡å°‘ç³»ç»ŸIOæ¬¡æ•°ï¼Œä»è€Œæé«˜è¯»å†™çš„æ•ˆç‡ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605131840638.png" alt="image-20230605131840638" style="zoom:67%;" /><hr><h3 id="7-2-å­—èŠ‚ç¼“å†²æµ">7.2 å­—èŠ‚ç¼“å†²æµ</h3><h4 id="æ„é€ æ–¹æ³•-5">æ„é€ æ–¹æ³•</h4><ul><li><code>public BufferedInputStream(InputStream in)</code> ï¼šåˆ›å»ºä¸€ä¸ª æ–°çš„ç¼“å†²è¾“å…¥æµã€‚</li><li><code>public BufferedOutputStream(OutputStream out)</code>ï¼š åˆ›å»ºä¸€ä¸ªæ–°çš„ç¼“å†²è¾“å‡ºæµã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºå­—èŠ‚ç¼“å†²è¾“å…¥æµ</span></span><br><span class="line"><span class="type">BufferedInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;bis.txt&quot;</span>));</span><br><span class="line"><span class="comment">// åˆ›å»ºå­—èŠ‚ç¼“å†²è¾“å‡ºæµ</span></span><br><span class="line"><span class="type">BufferedOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;bos.txt&quot;</span>));</span><br></pre></td></tr></table></figure><hr><h4 id="æ•ˆç‡æµ‹è¯•">æ•ˆç‡æµ‹è¯•</h4><p>æŸ¥è¯¢APIï¼Œç¼“å†²æµè¯»å†™æ–¹æ³•ä¸åŸºæœ¬çš„æµæ˜¯ä¸€è‡´çš„ï¼Œæˆ‘ä»¬é€šè¿‡å¤åˆ¶å¤§æ–‡ä»¶ï¼ˆ375MBï¼‰ï¼Œæµ‹è¯•å®ƒçš„æ•ˆç‡ã€‚</p><div class="tabs" id="9d5d2982-e909-4d73-9076-fa41f7f0fcb5"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#9d5d2982-e909-4d73-9076-fa41f7f0fcb5-1"><i class="fas fa-seedling"></i>åŸºæœ¬æµ</button></li><li class="tab"><button type="button" data-href="#9d5d2982-e909-4d73-9076-fa41f7f0fcb5-2"><i class="fas fa-leaf"></i>ç¼“å†²æµ1</button></li><li class="tab"><button type="button" data-href="#9d5d2982-e909-4d73-9076-fa41f7f0fcb5-3"><i class="fab fa-apple"></i>ç¼“å†²æµ2</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="9d5d2982-e909-4d73-9076-fa41f7f0fcb5-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BufferedDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="comment">// è®°å½•å¼€å§‹æ—¶é—´</span></span><br><span class="line">      <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"><span class="comment">// åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;jdk9.exe&quot;</span>);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;copy.exe&quot;</span>)</span><br><span class="line">        )&#123;</span><br><span class="line">        <span class="comment">// è¯»å†™æ•°æ®</span></span><br><span class="line">            <span class="type">int</span> b;</span><br><span class="line">            <span class="keyword">while</span> ((b = fis.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                fos.write(b);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// è®°å½•ç»“æŸæ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;æ™®é€šæµå¤åˆ¶æ—¶é—´:&quot;</span>+(end - start)+<span class="string">&quot; æ¯«ç§’&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">åå‡ åˆ†é’Ÿè¿‡å»äº†...</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9d5d2982-e909-4d73-9076-fa41f7f0fcb5-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BufferedDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="comment">// è®°å½•å¼€å§‹æ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">                <span class="type">BufferedInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;jdk9.exe&quot;</span>));</span><br><span class="line">                <span class="type">BufferedOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;copy.exe&quot;</span>));</span><br><span class="line">        )&#123;</span><br><span class="line">            <span class="comment">// è¯»å†™æ•°æ®</span></span><br><span class="line">            <span class="type">int</span> b;</span><br><span class="line">            <span class="keyword">while</span> ((b = bis.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                bos.write(b);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è®°å½•ç»“æŸæ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;ç¼“å†²æµå¤åˆ¶æ—¶é—´:&quot;</span>+(end - start)+<span class="string">&quot; æ¯«ç§’&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ç¼“å†²æµå¤åˆ¶æ—¶é—´:<span class="number">8016</span> æ¯«ç§’</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9d5d2982-e909-4d73-9076-fa41f7f0fcb5-3"><p>å¦‚ä½•æ›´å¿«å‘¢ï¼Ÿä½¿ç”¨æ•°ç»„çš„æ–¹å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BufferedDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">      <span class="comment">// è®°å½•å¼€å§‹æ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"><span class="comment">// åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line"><span class="type">BufferedInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;jdk9.exe&quot;</span>));</span><br><span class="line"> <span class="type">BufferedOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;copy.exe&quot;</span>));</span><br><span class="line">        )&#123;</span><br><span class="line">          <span class="comment">// è¯»å†™æ•°æ®</span></span><br><span class="line">            <span class="type">int</span> len;</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8</span>*<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">while</span> ((len = bis.read(bytes)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                bos.write(bytes, <span class="number">0</span> , len);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// è®°å½•ç»“æŸæ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;ç¼“å†²æµä½¿ç”¨æ•°ç»„å¤åˆ¶æ—¶é—´:&quot;</span>+(end - start)+<span class="string">&quot; æ¯«ç§’&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">ç¼“å†²æµä½¿ç”¨æ•°ç»„å¤åˆ¶æ—¶é—´:<span class="number">666</span> æ¯«ç§’</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h3 id="7-3-å­—ç¬¦ç¼“å†²æµ">7.3 å­—ç¬¦ç¼“å†²æµ</h3><h4 id="æ„é€ æ–¹æ³•-6">æ„é€ æ–¹æ³•</h4><ul><li><code>public BufferedReader(Reader in)</code> ï¼šåˆ›å»ºä¸€ä¸ª æ–°çš„ç¼“å†²è¾“å…¥æµã€‚</li><li><code>public BufferedWriter(Writer out)</code>ï¼š åˆ›å»ºä¸€ä¸ªæ–°çš„ç¼“å†²è¾“å‡ºæµã€‚</li></ul><p>æ„é€ ä¸¾ä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºå­—ç¬¦ç¼“å†²è¾“å…¥æµ</span></span><br><span class="line"><span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;br.txt&quot;</span>));</span><br><span class="line"><span class="comment">// åˆ›å»ºå­—ç¬¦ç¼“å†²è¾“å‡ºæµ</span></span><br><span class="line"><span class="type">BufferedWriter</span> <span class="variable">bw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;bw.txt&quot;</span>));</span><br></pre></td></tr></table></figure><h4 id="ç‰¹æœ‰æ–¹æ³•">ç‰¹æœ‰æ–¹æ³•</h4><p>å­—ç¬¦ç¼“å†²æµçš„åŸºæœ¬æ–¹æ³•ä¸æ™®é€šå­—ç¬¦æµè°ƒç”¨æ–¹å¼ä¸€è‡´ï¼Œä¸å†é˜è¿°ï¼Œæˆ‘ä»¬æ¥çœ‹å®ƒä»¬å…·å¤‡çš„ç‰¹æœ‰æ–¹æ³•ã€‚</p><ul><li>BufferedReaderï¼š<code>public String readLine()</code>: è¯»ä¸€è¡Œæ–‡å­—ã€‚</li><li>BufferedWriterï¼š<code>public void newLine()</code>: å†™ä¸€è¡Œè¡Œåˆ†éš”ç¬¦,ç”±ç³»ç»Ÿå±æ€§å®šä¹‰ç¬¦å·ã€‚ è·¨å¹³å°çš„æ¢è¡Œ</li></ul><div class="tabs" id="76a42036-3cc4-4933-9695-5f84eea8bb52"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#76a42036-3cc4-4933-9695-5f84eea8bb52-1"><i class="fas fa-cat"></i>readLine</button></li><li class="tab"><button type="button" data-href="#76a42036-3cc4-4933-9695-5f84eea8bb52-2"><i class="fas fa-horse"></i>newLine</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="76a42036-3cc4-4933-9695-5f84eea8bb52-1"><p>readLineæ–¹æ³•åœ¨è¯»å–çš„æ—¶å€™ï¼Œä¸€æ¬¡è¯»ä¸€æ•´è¡Œï¼Œé‡åˆ°å›è½¦æ¢è¡Œç»“æŸ</p><p>ä½†æ˜¯ä¸ä¼šæŠŠå›è½¦æ¢è¡Œè¯»å…¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BufferedReaderDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;in.txt&quot;</span>));</span><br><span class="line">        <span class="comment">// å®šä¹‰å­—ç¬¦ä¸²,ä¿å­˜è¯»å–çš„ä¸€è¡Œæ–‡å­—</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">line</span>  <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// å¾ªç¯è¯»å–,è¯»å–åˆ°æœ€åè¿”å›null</span></span><br><span class="line">        <span class="keyword">while</span> ((line = br.readLine())!=<span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.print(line);</span><br><span class="line">            System.out.println(<span class="string">&quot;------&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾èµ„æº</span></span><br><span class="line">        br.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="76a42036-3cc4-4933-9695-5f84eea8bb52-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BufferedWriterDemo</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException  &#123;</span><br><span class="line">      <span class="comment">// åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line"><span class="type">BufferedWriter</span> <span class="variable">bw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;out.txt&quot;</span>));</span><br><span class="line">      <span class="comment">// å†™å‡ºæ•°æ®</span></span><br><span class="line">        bw.write(<span class="string">&quot;é»‘é©¬&quot;</span>);</span><br><span class="line">      <span class="comment">// å†™å‡ºæ¢è¡Œ</span></span><br><span class="line">        bw.newLine();</span><br><span class="line">        bw.write(<span class="string">&quot;ç¨‹åº&quot;</span>);</span><br><span class="line">        bw.newLine();</span><br><span class="line">        bw.write(<span class="string">&quot;å‘˜&quot;</span>);</span><br><span class="line">        bw.newLine();</span><br><span class="line"><span class="comment">// é‡Šæ”¾èµ„æº</span></span><br><span class="line">        bw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¾“å‡ºæ•ˆæœ:</span></span><br><span class="line">é»‘é©¬</span><br><span class="line">ç¨‹åº</span><br><span class="line">å‘˜</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h4 id="ç»ƒä¹ ">ç»ƒä¹ </h4><p>è¯·å°†æ–‡æœ¬ä¿¡æ¯æ¢å¤é¡ºåºã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">3.ä¾ä¸­ã€ä¾éƒéƒ­æ”¸ä¹‹ã€è´¹ç¥ã€è‘£å…ç­‰ï¼Œæ­¤çš†è‰¯å®ï¼Œå¿—è™‘å¿ çº¯ï¼Œæ˜¯ä»¥å…ˆå¸ç®€æ‹”ä»¥é—é™›ä¸‹ã€‚æ„šä»¥ä¸ºå®«ä¸­ä¹‹äº‹ï¼Œäº‹æ— å¤§å°ï¼Œæ‚‰ä»¥å’¨ä¹‹ï¼Œç„¶åæ–½è¡Œï¼Œå¿…å¾—è£¨è¡¥é˜™æ¼ï¼Œæœ‰æ‰€å¹¿ç›Šã€‚</span><br><span class="line">8.æ„¿é™›ä¸‹æ‰˜è‡£ä»¥è®¨è´¼å…´å¤ä¹‹æ•ˆï¼Œä¸æ•ˆï¼Œåˆ™æ²»è‡£ä¹‹ç½ªï¼Œä»¥å‘Šå…ˆå¸ä¹‹çµã€‚è‹¥æ— å…´å¾·ä¹‹è¨€ï¼Œåˆ™è´£æ”¸ä¹‹ã€ç¥ã€å…ç­‰ä¹‹æ…¢ï¼Œä»¥å½°å…¶å’ï¼›é™›ä¸‹äº¦å®œè‡ªè°‹ï¼Œä»¥å’¨è¯¹å–„é“ï¼Œå¯Ÿçº³é›…è¨€ï¼Œæ·±è¿½å…ˆå¸é—è¯ï¼Œè‡£ä¸èƒœå—æ©æ„Ÿæ¿€ã€‚</span><br><span class="line">4.å°†å†›å‘å® ï¼Œæ€§è¡Œæ·‘å‡ï¼Œæ™“ç•…å†›äº‹ï¼Œè¯•ç”¨ä¹‹äºæ˜”æ—¥ï¼Œå…ˆå¸ç§°ä¹‹æ›°èƒ½ï¼Œæ˜¯ä»¥ä¼—è®®ä¸¾å® ä¸ºç£ã€‚æ„šä»¥ä¸ºè¥ä¸­ä¹‹äº‹ï¼Œæ‚‰ä»¥å’¨ä¹‹ï¼Œå¿…èƒ½ä½¿è¡Œé˜µå’Œç¦ï¼Œä¼˜åŠ£å¾—æ‰€ã€‚</span><br><span class="line">2.å®«ä¸­åºœä¸­ï¼Œä¿±ä¸ºä¸€ä½“ï¼Œé™Ÿç½šè‡§å¦ï¼Œä¸å®œå¼‚åŒã€‚è‹¥æœ‰ä½œå¥¸çŠ¯ç§‘åŠä¸ºå¿ å–„è€…ï¼Œå®œä»˜æœ‰å¸è®ºå…¶åˆ‘èµï¼Œä»¥æ˜­é™›ä¸‹å¹³æ˜ä¹‹ç†ï¼Œä¸å®œåç§ï¼Œä½¿å†…å¤–å¼‚æ³•ä¹Ÿã€‚</span><br><span class="line">1.å…ˆå¸åˆ›ä¸šæœªåŠè€Œä¸­é“å´©æ®‚ï¼Œä»Šå¤©ä¸‹ä¸‰åˆ†ï¼Œç›Šå·ç–²å¼Šï¼Œæ­¤è¯šå±æ€¥å­˜äº¡ä¹‹ç§‹ä¹Ÿã€‚ç„¶ä¾å«ä¹‹è‡£ä¸æ‡ˆäºå†…ï¼Œå¿ å¿—ä¹‹å£«å¿˜èº«äºå¤–è€…ï¼Œç›–è¿½å…ˆå¸ä¹‹æ®Šé‡ï¼Œæ¬²æŠ¥ä¹‹äºé™›ä¸‹ä¹Ÿã€‚è¯šå®œå¼€å¼ åœ£å¬ï¼Œä»¥å…‰å…ˆå¸é—å¾·ï¼Œæ¢å¼˜å¿—å£«ä¹‹æ°”ï¼Œä¸å®œå¦„è‡ªè²è–„ï¼Œå¼•å–»å¤±ä¹‰ï¼Œä»¥å¡å¿ è°ä¹‹è·¯ä¹Ÿã€‚</span><br><span class="line">9.ä»Šå½“è¿œç¦»ï¼Œä¸´è¡¨æ¶•é›¶ï¼Œä¸çŸ¥æ‰€è¨€ã€‚</span><br><span class="line">6.è‡£æœ¬å¸ƒè¡£ï¼Œèº¬è€•äºå—é˜³ï¼Œè‹Ÿå…¨æ€§å‘½äºä¹±ä¸–ï¼Œä¸æ±‚é—»è¾¾äºè¯¸ä¾¯ã€‚å…ˆå¸ä¸ä»¥è‡£å‘é„™ï¼ŒçŒ¥è‡ªæ‰å±ˆï¼Œä¸‰é¡¾è‡£äºè‰åºä¹‹ä¸­ï¼Œå’¨è‡£ä»¥å½“ä¸–ä¹‹äº‹ï¼Œç”±æ˜¯æ„Ÿæ¿€ï¼Œé‚è®¸å…ˆå¸ä»¥é©±é©°ã€‚åå€¼å€¾è¦†ï¼Œå—ä»»äºè´¥å†›ä¹‹é™…ï¼Œå¥‰å‘½äºå±éš¾ä¹‹é—´ï¼Œå°”æ¥äºŒåæœ‰ä¸€å¹´çŸ£ã€‚</span><br><span class="line">7.å…ˆå¸çŸ¥è‡£è°¨æ…ï¼Œæ•…ä¸´å´©å¯„è‡£ä»¥å¤§äº‹ä¹Ÿã€‚å—å‘½ä»¥æ¥ï¼Œå¤™å¤œå¿§å¹ï¼Œæä»˜æ‰˜ä¸æ•ˆï¼Œä»¥ä¼¤å…ˆå¸ä¹‹æ˜ï¼Œæ•…äº”æœˆæ¸¡æ³¸ï¼Œæ·±å…¥ä¸æ¯›ã€‚ä»Šå—æ–¹å·²å®šï¼Œå…µç”²å·²è¶³ï¼Œå½“å¥–ç‡ä¸‰å†›ï¼ŒåŒ—å®šä¸­åŸï¼Œåº¶ç«­é©½é’ï¼Œæ”˜é™¤å¥¸å‡¶ï¼Œå…´å¤æ±‰å®¤ï¼Œè¿˜äºæ—§éƒ½ã€‚æ­¤è‡£æ‰€ä»¥æŠ¥å…ˆå¸è€Œå¿ é™›ä¸‹ä¹‹èŒåˆ†ä¹Ÿã€‚è‡³äºæ–Ÿé…ŒæŸç›Šï¼Œè¿›å°½å¿ è¨€ï¼Œåˆ™æ”¸ä¹‹ã€ç¥ã€å…ä¹‹ä»»ä¹Ÿã€‚</span><br><span class="line">5.äº²è´¤è‡£ï¼Œè¿œå°äººï¼Œæ­¤å…ˆæ±‰æ‰€ä»¥å…´éš†ä¹Ÿï¼›äº²å°äººï¼Œè¿œè´¤è‡£ï¼Œæ­¤åæ±‰æ‰€ä»¥å€¾é¢“ä¹Ÿã€‚å…ˆå¸åœ¨æ—¶ï¼Œæ¯ä¸è‡£è®ºæ­¤äº‹ï¼Œæœªå°ä¸å¹æ¯ç—›æ¨äºæ¡“ã€çµä¹Ÿã€‚ä¾ä¸­ã€å°šä¹¦ã€é•¿å²ã€å‚å†›ï¼Œæ­¤æ‚‰è´è‰¯æ­»èŠ‚ä¹‹è‡£ï¼Œæ„¿é™›ä¸‹äº²ä¹‹ä¿¡ä¹‹ï¼Œåˆ™æ±‰å®¤ä¹‹éš†ï¼Œå¯è®¡æ—¥è€Œå¾…ä¹Ÿã€‚</span><br></pre></td></tr></table></figure><ol><li>é€è¡Œè¯»å–æ–‡æœ¬ä¿¡æ¯ã€‚</li><li>æŠŠè¯»å–åˆ°çš„æ–‡æœ¬å­˜å‚¨åˆ°é›†åˆä¸­</li><li>å¯¹é›†åˆä¸­çš„æ–‡æœ¬è¿›è¡Œæ’åº</li><li>éå†é›†åˆï¼ŒæŒ‰é¡ºåºï¼Œå†™å‡ºæ–‡æœ¬ä¿¡æ¯ã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo05Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//1.åˆ›å»ºArrayListé›†åˆ,æ³›å‹ä½¿ç”¨String</span></span><br><span class="line">        ArrayList&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//2.åˆ›å»ºBufferedReaderå¯¹è±¡,æ„é€ æ–¹æ³•ä¸­ä¼ é€’FileReaderå¯¹è±¡</span></span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;10_IO\\in.txt&quot;</span>));</span><br><span class="line">        <span class="comment">//3.åˆ›å»ºBufferedWriterå¯¹è±¡,æ„é€ æ–¹æ³•ä¸­ä¼ é€’FileWriterå¯¹è±¡</span></span><br><span class="line">        <span class="type">BufferedWriter</span> <span class="variable">bw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;10_IO\\out.txt&quot;</span>));</span><br><span class="line">        <span class="comment">//4.ä½¿ç”¨BufferedReaderå¯¹è±¡ä¸­çš„æ–¹æ³•readLine,ä»¥è¡Œçš„æ–¹å¼è¯»å–æ–‡æœ¬</span></span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">while</span>((line = br.readLine())!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//5.æŠŠè¯»å–åˆ°çš„æ–‡æœ¬å­˜å‚¨åˆ°ArrayListé›†åˆä¸­</span></span><br><span class="line">            list.add(line);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//6.ä½¿ç”¨Collectionsé›†åˆå·¥å…·ç±»ä¸­çš„æ–¹æ³•sort,å¯¹é›†åˆä¸­çš„å…ƒç´ æŒ‰ç…§è‡ªå®šä¹‰è§„åˆ™æ’åº</span></span><br><span class="line">        Collections.sort(list, <span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;String&gt;() &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                o1-o2:å‡åº</span></span><br><span class="line"><span class="comment">                o2-o1:é™åº</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(String o1, String o2)</span> &#123;</span><br><span class="line">                <span class="comment">//ä¾æ¬¡æ¯”è¾ƒé›†åˆä¸­ä¸¤ä¸ªå…ƒç´ çš„é¦–å­—æ¯,å‡åºæ’åº</span></span><br><span class="line">                <span class="keyword">return</span> o1.charAt(<span class="number">0</span>)-o2.charAt(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//7.éå†ArrayListé›†åˆ,è·å–æ¯ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">        <span class="keyword">for</span> (String s : list) &#123;</span><br><span class="line">            <span class="comment">//8.ä½¿ç”¨BufferedWriterå¯¹è±¡ä¸­çš„æ–¹æ³•wirte,æŠŠéå†å¾—åˆ°çš„å…ƒç´ å†™å…¥åˆ°æ–‡æœ¬ä¸­(å†…å­˜ç¼“å†²åŒºä¸­)</span></span><br><span class="line">            bw.write(s);</span><br><span class="line">            <span class="comment">//9.å†™æ¢è¡Œ</span></span><br><span class="line">            bw.newLine();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//10.é‡Šæ”¾èµ„æº</span></span><br><span class="line">        bw.close();</span><br><span class="line">        br.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="8-è½¬æ¢æµ">8. è½¬æ¢æµ</h2><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605142703576.png" alt="image-20230605142703576" style="zoom:67%;" /><h3 id="8-1-InputStreamReaderç±»">8.1 InputStreamReaderç±»</h3><p>è½¬æ¢æµ<code>java.io.InputStreamReader</code>ï¼Œæ˜¯Readerçš„å­ç±»ï¼Œæ˜¯ä»å­—èŠ‚æµåˆ°å­—ç¬¦æµçš„æ¡¥æ¢ã€‚å®ƒè¯»å–å­—èŠ‚ï¼Œå¹¶ä½¿ç”¨æŒ‡å®šçš„å­—ç¬¦é›†å°†å…¶è§£ç ä¸ºå­—ç¬¦ã€‚å®ƒçš„å­—ç¬¦é›†å¯ä»¥ç”±åç§°æŒ‡å®šï¼Œä¹Ÿå¯ä»¥æ¥å—å¹³å°çš„é»˜è®¤å­—ç¬¦é›†ã€‚</p><h4 id="æ„é€ æ–¹æ³•-7">æ„é€ æ–¹æ³•</h4><ul><li><code>InputStreamReader(InputStream in)</code>: åˆ›å»ºä¸€ä¸ªä½¿ç”¨é»˜è®¤å­—ç¬¦é›†çš„å­—ç¬¦æµã€‚</li><li><code>InputStreamReader(InputStream in, String charsetName)</code>: åˆ›å»ºä¸€ä¸ªæŒ‡å®šå­—ç¬¦é›†çš„å­—ç¬¦æµã€‚</li></ul><p>æ„é€ ä¸¾ä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InputStreamReader</span> <span class="variable">isr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;in.txt&quot;</span>));</span><br><span class="line"><span class="type">InputStreamReader</span> <span class="variable">isr2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;in.txt&quot;</span>) , <span class="string">&quot;GBK&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="æŒ‡å®šç¼–ç è¯»å–">æŒ‡å®šç¼–ç è¯»å–</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReaderDemo2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// å®šä¹‰æ–‡ä»¶è·¯å¾„,æ–‡ä»¶ä¸ºgbkç¼–ç </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">FileName</span> <span class="operator">=</span> <span class="string">&quot;E:\\file_gbk.txt&quot;</span>;</span><br><span class="line">        <span class="comment">// åˆ›å»ºæµå¯¹è±¡,é»˜è®¤UTF8ç¼–ç </span></span><br><span class="line">        <span class="type">InputStreamReader</span> <span class="variable">isr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(FileName));</span><br><span class="line">        <span class="comment">// åˆ›å»ºæµå¯¹è±¡,æŒ‡å®šGBKç¼–ç </span></span><br><span class="line">        <span class="type">InputStreamReader</span> <span class="variable">isr2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(FileName) , <span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">        <span class="comment">// å®šä¹‰å˜é‡,ä¿å­˜å­—ç¬¦</span></span><br><span class="line">        <span class="type">int</span> read;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨é»˜è®¤ç¼–ç å­—ç¬¦æµè¯»å–,ä¹±ç </span></span><br><span class="line">        <span class="keyword">while</span> ((read = isr.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">            System.out.print((<span class="type">char</span>)read); <span class="comment">// ï¿½ï¿½Òºï¿½</span></span><br><span class="line">        &#125;</span><br><span class="line">        isr.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä½¿ç”¨æŒ‡å®šç¼–ç å­—ç¬¦æµè¯»å–,æ­£å¸¸è§£æ</span></span><br><span class="line">        <span class="keyword">while</span> ((read = isr2.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">            System.out.print((<span class="type">char</span>)read);<span class="comment">// å¤§å®¶å¥½</span></span><br><span class="line">        &#125;</span><br><span class="line">        isr2.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="8-2-OutputStreamWriterç±»">8.2 OutputStreamWriterç±»</h3><p>è½¬æ¢æµ<code>java.io.OutputStreamWriter</code> ï¼Œæ˜¯Writerçš„å­ç±»ï¼Œæ˜¯ä»å­—ç¬¦æµåˆ°å­—èŠ‚æµçš„æ¡¥æ¢ã€‚ä½¿ç”¨æŒ‡å®šçš„å­—ç¬¦é›†å°†å­—ç¬¦ç¼–ç ä¸ºå­—èŠ‚ã€‚å®ƒçš„å­—ç¬¦é›†å¯ä»¥ç”±åç§°æŒ‡å®šï¼Œä¹Ÿå¯ä»¥æ¥å—å¹³å°çš„é»˜è®¤å­—ç¬¦é›†ã€‚</p><hr><h4 id="æ„é€ æ–¹æ³•-8">æ„é€ æ–¹æ³•</h4><ul><li><code>OutputStreamWriter(OutputStream in)</code>: åˆ›å»ºä¸€ä¸ªä½¿ç”¨é»˜è®¤å­—ç¬¦é›†çš„å­—ç¬¦æµã€‚</li><li><code>OutputStreamWriter(OutputStream in, String charsetName)</code>: åˆ›å»ºä¸€ä¸ªæŒ‡å®šå­—ç¬¦é›†çš„å­—ç¬¦æµã€‚</li></ul><p>æ„é€ ä¸¾ä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">OutputStreamWriter</span> <span class="variable">isr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;out.txt&quot;</span>));</span><br><span class="line"><span class="type">OutputStreamWriter</span> <span class="variable">isr2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;out.txt&quot;</span>) , <span class="string">&quot;GBK&quot;</span>);</span><br></pre></td></tr></table></figure><hr><h4 id="æŒ‡å®šç¼–ç å†™å‡º">æŒ‡å®šç¼–ç å†™å‡º</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OutputDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">      <span class="comment">// å®šä¹‰æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">FileName</span> <span class="operator">=</span> <span class="string">&quot;E:\\out.txt&quot;</span>;</span><br><span class="line">      <span class="comment">// åˆ›å»ºæµå¯¹è±¡,é»˜è®¤UTF8ç¼–ç </span></span><br><span class="line">        <span class="type">OutputStreamWriter</span> <span class="variable">osw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(FileName));</span><br><span class="line">        <span class="comment">// å†™å‡ºæ•°æ®</span></span><br><span class="line">      osw.write(<span class="string">&quot;ä½ å¥½&quot;</span>); <span class="comment">// ä¿å­˜ä¸º6ä¸ªå­—èŠ‚</span></span><br><span class="line">        osw.close();</span><br><span class="line">      </span><br><span class="line"><span class="comment">// å®šä¹‰æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="type">String</span> <span class="variable">FileName2</span> <span class="operator">=</span> <span class="string">&quot;E:\\out2.txt&quot;</span>;</span><br><span class="line">     <span class="comment">// åˆ›å»ºæµå¯¹è±¡,æŒ‡å®šGBKç¼–ç </span></span><br><span class="line">        <span class="type">OutputStreamWriter</span> <span class="variable">osw2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(FileName2),<span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">        <span class="comment">// å†™å‡ºæ•°æ®</span></span><br><span class="line">      osw2.write(<span class="string">&quot;ä½ å¥½&quot;</span>);<span class="comment">// ä¿å­˜ä¸º4ä¸ªå­—èŠ‚</span></span><br><span class="line">        osw2.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="8-3-è½¬æ¢æµç†è§£å›¾è§£">8.3 è½¬æ¢æµç†è§£å›¾è§£</h3><p><strong><span class='p blue'>è½¬æ¢æµæ˜¯å­—èŠ‚ä¸å­—ç¬¦é—´çš„æ¡¥æ¢ï¼</span></strong></p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2_zhuanhuan.jpg" alt=""></p><hr><h3 id="8-4-ç»ƒä¹ ">8.4 ç»ƒä¹ </h3><p>è½¬æ¢æ–‡ä»¶ç¼–ç :å°†GBKç¼–ç çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè½¬æ¢ä¸ºUTF-8ç¼–ç çš„æ–‡æœ¬æ–‡ä»¶ã€‚</p><ol><li>æŒ‡å®šGBKç¼–ç çš„è½¬æ¢æµï¼Œè¯»å–æ–‡æœ¬æ–‡ä»¶ã€‚</li><li>ä½¿ç”¨UTF-8ç¼–ç çš„è½¬æ¢æµï¼Œå†™å‡ºæ–‡æœ¬æ–‡ä»¶ã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.å®šä¹‰æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">srcFile</span> <span class="operator">=</span> <span class="string">&quot;file_gbk.txt&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">destFile</span> <span class="operator">=</span> <span class="string">&quot;file_utf8.txt&quot;</span>;</span><br><span class="line">        <span class="comment">// 2.åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="comment">// 2.1 è½¬æ¢è¾“å…¥æµ,æŒ‡å®šGBKç¼–ç </span></span><br><span class="line">        <span class="type">InputStreamReader</span> <span class="variable">isr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(srcFile) , <span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.2 è½¬æ¢è¾“å‡ºæµ,é»˜è®¤utf8ç¼–ç </span></span><br><span class="line">        <span class="type">OutputStreamWriter</span> <span class="variable">osw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(destFile));</span><br><span class="line">        <span class="comment">// 3.è¯»å†™æ•°æ®</span></span><br><span class="line">        <span class="comment">// 3.1 å®šä¹‰æ•°ç»„</span></span><br><span class="line">        <span class="type">char</span>[] cbuf = <span class="keyword">new</span> <span class="title class_">char</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="comment">// 3.2 å®šä¹‰é•¿åº¦</span></span><br><span class="line">        <span class="type">int</span> len;</span><br><span class="line">        <span class="comment">// 3.3 å¾ªç¯è¯»å–</span></span><br><span class="line">        <span class="keyword">while</span> ((len = isr.read(cbuf))!=-<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// å¾ªç¯å†™å‡º</span></span><br><span class="line">            osw.write(cbuf,<span class="number">0</span>,len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.é‡Šæ”¾èµ„æº</span></span><br><span class="line">        osw.close();</span><br><span class="line">        isr.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="9-åºåˆ—åŒ–æµ">9. åºåˆ—åŒ–æµ</h2><h3 id="9-1-æ¦‚è¿°">9.1 æ¦‚è¿°</h3><p>Java æä¾›äº†ä¸€ç§å¯¹è±¡<span class='p blue'>åºåˆ—åŒ–</span>çš„æœºåˆ¶ã€‚ç”¨ä¸€ä¸ªå­—èŠ‚åºåˆ—å¯ä»¥è¡¨ç¤ºä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å­—èŠ‚åºåˆ—åŒ…å«è¯¥<code>å¯¹è±¡çš„æ•°æ®</code>ã€<code>å¯¹è±¡çš„ç±»å‹</code>å’Œ<code>å¯¹è±¡ä¸­å­˜å‚¨çš„å±æ€§</code>ç­‰ä¿¡æ¯ã€‚å­—èŠ‚åºåˆ—å†™å‡ºåˆ°æ–‡ä»¶ä¹‹åï¼Œç›¸å½“äºæ–‡ä»¶ä¸­<span class='p red'>æŒä¹…ä¿å­˜</span>äº†ä¸€ä¸ªå¯¹è±¡çš„ä¿¡æ¯ã€‚</p><p>åä¹‹ï¼Œè¯¥å­—èŠ‚åºåˆ—è¿˜å¯ä»¥ä»æ–‡ä»¶ä¸­è¯»å–å›æ¥ï¼Œé‡æ„å¯¹è±¡ï¼Œå¯¹å®ƒè¿›è¡Œ<span class='p green'>ååºåˆ—åŒ–</span>ã€‚<code>å¯¹è±¡çš„æ•°æ®</code>ã€<code>å¯¹è±¡çš„ç±»å‹</code>å’Œ<code>å¯¹è±¡ä¸­å­˜å‚¨çš„æ•°æ®</code>ä¿¡æ¯ï¼Œéƒ½å¯ä»¥ç”¨æ¥åœ¨å†…å­˜ä¸­åˆ›å»ºå¯¹è±¡ã€‚çœ‹å›¾ç†è§£åºåˆ—åŒ–ï¼š <img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/3_xuliehua.jpg" alt=""></p><hr><h3 id="9-2-ObjectOutputStreamç±»">9.2 ObjectOutputStreamç±»</h3><p><code>java.io.ObjectOutputStream </code> ç±»ï¼Œå°†Javaå¯¹è±¡çš„åŸå§‹æ•°æ®ç±»å‹å†™å‡ºåˆ°æ–‡ä»¶,å®ç°å¯¹è±¡çš„æŒä¹…å­˜å‚¨ã€‚</p><h4 id="æ„é€ æ–¹æ³•-9">æ„é€ æ–¹æ³•</h4><p><code>public ObjectOutputStream(OutputStream out) </code>ï¼š åˆ›å»ºä¸€ä¸ªæŒ‡å®šOutputStreamçš„ObjectOutputStreamã€‚</p><p>æ„é€ ä¸¾ä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FileOutputStream</span> <span class="variable">fileOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;employee.txt&quot;</span>);</span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOut);</span><br></pre></td></tr></table></figure><h4 id="åºåˆ—åŒ–æ“ä½œ">åºåˆ—åŒ–æ“ä½œ</h4><ol><li>ä¸€ä¸ªå¯¹è±¡è¦æƒ³åºåˆ—åŒ–ï¼Œå¿…é¡»æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶:</li></ol><ul><li>è¯¥ç±»å¿…é¡»å®ç°<code>java.io.Serializable </code> æ¥å£ï¼Œ<code>Serializable</code> æ˜¯ä¸€ä¸ªæ ‡è®°æ¥å£ï¼Œä¸å®ç°æ­¤æ¥å£çš„ç±»å°†ä¸ä¼šä½¿ä»»ä½•çŠ¶æ€åºåˆ—åŒ–æˆ–ååºåˆ—åŒ–ï¼Œä¼šæŠ›å‡º<code>NotSerializableException</code> ã€‚</li><li>è¯¥ç±»çš„æ‰€æœ‰å±æ€§å¿…é¡»æ˜¯å¯åºåˆ—åŒ–çš„ã€‚å¦‚æœæœ‰ä¸€ä¸ªå±æ€§ä¸éœ€è¦å¯åºåˆ—åŒ–çš„ï¼Œåˆ™è¯¥å±æ€§å¿…é¡»æ³¨æ˜æ˜¯ç¬æ€çš„ï¼Œä½¿ç”¨<code>transient</code> å…³é”®å­—ä¿®é¥°ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Employee</span> <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> String address;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">transient</span> <span class="type">int</span> age; <span class="comment">// transientç¬æ€ä¿®é¥°æˆå‘˜,ä¸ä¼šè¢«åºåˆ—åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addressCheck</span><span class="params">()</span> &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;Address  check : &quot;</span> + name + <span class="string">&quot; -- &quot;</span> + address);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>serializableæ¥å£é‡Œé¢æ˜¯æ²¡æœ‰æŠ½è±¡æ–¹æ³•ï¼Œæ ‡è®°å‹æ¥å£</p><p>ä¸€æ—¦å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œé‚£ä¹ˆå°±è¡¨ç¤ºå½“å‰ç±»å¯ä»¥è¢«åºåˆ—åŒ–</p><p>2.å†™å‡ºå¯¹è±¡æ–¹æ³•</p><ul><li><code>public final void writeObject (Object obj)</code> : å°†æŒ‡å®šçš„å¯¹è±¡å†™å‡ºã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializeDemo</span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String [] args)</span>   &#123;</span><br><span class="line">    <span class="type">Employee</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Employee</span>();</span><br><span class="line">    e.name = <span class="string">&quot;zhangsan&quot;</span>;</span><br><span class="line">    e.address = <span class="string">&quot;beiqinglu&quot;</span>;</span><br><span class="line">    e.age = <span class="number">20</span>; </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// åˆ›å»ºåºåˆ—åŒ–æµå¯¹è±¡</span></span><br><span class="line">          <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;employee.txt&quot;</span>));</span><br><span class="line">        <span class="comment">// å†™å‡ºå¯¹è±¡</span></span><br><span class="line">        out.writeObject(e);</span><br><span class="line">        <span class="comment">// é‡Šæ”¾èµ„æº</span></span><br><span class="line">        out.close();</span><br><span class="line">        fileOut.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;Serialized data is saved&quot;</span>); <span class="comment">// å§“åï¼Œåœ°å€è¢«åºåˆ—åŒ–ï¼Œå¹´é¾„æ²¡æœ‰è¢«åºåˆ—åŒ–ã€‚</span></span><br><span class="line">        &#125; <span class="keyword">catch</span>(IOException i)   &#123;</span><br><span class="line">            i.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¾“å‡ºç»“æœï¼š</span></span><br><span class="line">Serialized data is saved</span><br></pre></td></tr></table></figure><hr><h3 id="9-3-ObjectInputStreamç±»">9.3 ObjectInputStreamç±»</h3><p>ObjectInputStreamååºåˆ—åŒ–æµï¼Œå°†ä¹‹å‰ä½¿ç”¨ObjectOutputStreamåºåˆ—åŒ–çš„åŸå§‹æ•°æ®æ¢å¤ä¸ºå¯¹è±¡ã€‚</p><hr><h4 id="æ„é€ æ–¹æ³•-10">æ„é€ æ–¹æ³•</h4><p><code>public ObjectInputStream(InputStream in) </code>ï¼š åˆ›å»ºä¸€ä¸ªæŒ‡å®šInputStreamçš„ObjectInputStream</p><hr><h4 id="ååºåˆ—åŒ–æ“ä½œ">ååºåˆ—åŒ–æ“ä½œ</h4><div class="tabs" id="2b2d4f12-f62d-4af1-abb9-0995ae782e8b"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2b2d4f12-f62d-4af1-abb9-0995ae782e8b-1"><i class="fas fa-atom"></i>1</button></li><li class="tab"><button type="button" data-href="#2b2d4f12-f62d-4af1-abb9-0995ae782e8b-2"><i class="far fa-sun"></i>2</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2b2d4f12-f62d-4af1-abb9-0995ae782e8b-1"><p>å¦‚æœèƒ½æ‰¾åˆ°ä¸€ä¸ªå¯¹è±¡çš„classæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œè°ƒç”¨<code>ObjectInputStream</code>è¯»å–å¯¹è±¡çš„æ–¹æ³•ï¼š</p><p><code>public final Object readObject ()</code> : è¯»å–ä¸€ä¸ªå¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeserializeDemo</span> &#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String [] args)</span>   &#123;</span><br><span class="line">        <span class="type">Employee</span> <span class="variable">e</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="comment">// åˆ›å»ºååºåˆ—åŒ–æµ</span></span><br><span class="line">             <span class="type">FileInputStream</span> <span class="variable">fileIn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;employee.txt&quot;</span>);</span><br><span class="line">             <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileIn);</span><br><span class="line">             <span class="comment">// è¯»å–ä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line">             e = (Employee) in.readObject();</span><br><span class="line">             <span class="comment">// é‡Šæ”¾èµ„æº</span></span><br><span class="line">             in.close();</span><br><span class="line">             fileIn.close();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(IOException i) &#123;</span><br><span class="line">             <span class="comment">// æ•è·å…¶ä»–å¼‚å¸¸</span></span><br><span class="line">             i.printStackTrace();</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(ClassNotFoundException c)  &#123;</span><br><span class="line">        <span class="comment">// æ•è·ç±»æ‰¾ä¸åˆ°å¼‚å¸¸</span></span><br><span class="line">             System.out.println(<span class="string">&quot;Employee class not found&quot;</span>);</span><br><span class="line">             c.printStackTrace();</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ— å¼‚å¸¸,ç›´æ¥æ‰“å°è¾“å‡º</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Name: &quot;</span> + e.name);<span class="comment">// zhangsan</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Address: &quot;</span> + e.address); <span class="comment">// beiqinglu</span></span><br><span class="line">        System.out.println(<span class="string">&quot;age: &quot;</span> + e.age); <span class="comment">// 0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2b2d4f12-f62d-4af1-abb9-0995ae782e8b-2"><p>**å¦å¤–ï¼Œå½“JVMååºåˆ—åŒ–å¯¹è±¡æ—¶ï¼Œèƒ½æ‰¾åˆ°classæ–‡ä»¶ï¼Œä½†æ˜¯classæ–‡ä»¶åœ¨åºåˆ—åŒ–å¯¹è±¡ä¹‹åå‘ç”Ÿäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆååºåˆ—åŒ–æ“ä½œä¹Ÿä¼šå¤±è´¥ï¼ŒæŠ›å‡ºä¸€ä¸ª<code>InvalidClassException</code>å¼‚å¸¸ã€‚**å‘ç”Ÿè¿™ä¸ªå¼‚å¸¸çš„åŸå› å¦‚ä¸‹ï¼š</p><ul><li>è¯¥ç±»çš„åºåˆ—ç‰ˆæœ¬å·ä¸ä»æµä¸­è¯»å–çš„ç±»æè¿°ç¬¦çš„ç‰ˆæœ¬å·ä¸åŒ¹é…</li><li>è¯¥ç±»åŒ…å«æœªçŸ¥æ•°æ®ç±»å‹</li><li>è¯¥ç±»æ²¡æœ‰å¯è®¿é—®çš„æ— å‚æ•°æ„é€ æ–¹æ³•</li></ul><p><code>Serializable</code> æ¥å£ç»™éœ€è¦åºåˆ—åŒ–çš„ç±»ï¼Œæ ¹æ®æˆå‘˜å˜é‡ã€é™æ€å˜é‡ã€æ–¹æ³•ï¼Œæä¾›äº†ä¸€ä¸ªåºåˆ—ç‰ˆæœ¬å·ã€‚</p><p><code>serialVersionUID</code> è¯¥ç‰ˆæœ¬å·çš„ç›®çš„åœ¨äºéªŒè¯åºåˆ—åŒ–çš„å¯¹è±¡å’Œå¯¹åº”ç±»æ˜¯å¦ç‰ˆæœ¬åŒ¹é…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Employee</span> <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line">     <span class="comment">// åŠ å…¥åºåˆ—ç‰ˆæœ¬å·</span></span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">     <span class="keyword">public</span> String name;</span><br><span class="line">     <span class="keyword">public</span> String address;</span><br><span class="line">     <span class="comment">// æ·»åŠ æ–°çš„å±æ€§ ,é‡æ–°ç¼–è¯‘, å¯ä»¥ååºåˆ—åŒ–,è¯¥å±æ€§èµ‹ä¸ºé»˜è®¤å€¼.</span></span><br><span class="line">     <span class="keyword">public</span> <span class="type">int</span> eid; </span><br><span class="line"></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addressCheck</span><span class="params">()</span> &#123;</span><br><span class="line">         System.out.println(<span class="string">&quot;Address  check : &quot;</span> + name + <span class="string">&quot; -- &quot;</span> + address);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æå‰å®šå›ºå®šå¥½serialVersionUIDï¼Œåé¢å†æ·»åŠ å­—æ®µä¹Ÿèƒ½ååºåˆ—åŒ–ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <mark class="hl-label blue">ç»†èŠ‚æ±‡æ€»</mark> <p>â‘ ä½¿ç”¨åºåˆ—åŒ–æµå°†å¯¹è±¡å†™åˆ°æ–‡ä»¶æ—¶ï¼Œéœ€è¦è®©Javabeanç±»å®ç°Serializableæ¥å£ã€‚å¦åˆ™ï¼Œä¼šå‡ºç°NotSerializableExceptionå¼‚å¸¸</p><p>â‘¡ åºåˆ—åŒ–æµå†™åˆ°æ–‡ä»¶ä¸­çš„æ•°æ®æ˜¯ä¸èƒ½ä¿®æ”¹çš„ï¼Œä¸€æ—¦ä¿®æ”¹å°±æ— æ³•å†æ¬¡è¯»å›æ¥äº†</p><p>â‘¢åºåˆ—åŒ–å¯¹è±¡åï¼Œä¿®æ”¹äº†Javabeanç±»ï¼Œå†æ¬¡ååºåˆ—åŒ–ï¼Œä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿ</p><p>ä¼šå‡ºé—®é¢˜ï¼Œä¼šæŠ›å‡ºInvalidclassExceptionå¼‚å¸¸</p><p>è§£å†³æ–¹æ¡ˆï¼šç»™Javabeanç±»æ·»åŠ serialversionUIDï¼ˆåºåˆ—å·ã€ç‰ˆæœ¬å·ï¼‰</p><p>â‘£å¦‚æœä¸€ä¸ªå¯¹è±¡ä¸­çš„æŸä¸ªæˆå‘˜å˜é‡çš„å€¼ä¸æƒ³è¢«åºåˆ—åŒ–ï¼Œåˆè¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ</p><p>è§£å†³æ–¹æ¡ˆï¼šç»™è¯¥æˆå‘˜å˜é‡åŠ transientå…³é”®å­—ä¿®é¥°ï¼Œè¯¥å…³é”®å­—æ ‡è®°çš„æˆå‘˜å˜é‡ä¸å‚ä¸åºåˆ—åŒ–è¿‡ç¨‹</p><hr><h3 id="9-4-ç»ƒä¹ ">9.4 ç»ƒä¹ </h3><p>åºåˆ—åŒ–é›†åˆ</p><ol><li>å°†å­˜æœ‰å¤šä¸ªè‡ªå®šä¹‰å¯¹è±¡çš„é›†åˆåºåˆ—åŒ–æ“ä½œï¼Œä¿å­˜åˆ°<code>list.txt</code>æ–‡ä»¶ä¸­ã€‚</li><li>ååºåˆ—åŒ–<code>list.txt</code> ï¼Œå¹¶éå†é›†åˆï¼Œæ‰“å°å¯¹è±¡ä¿¡æ¯ã€‚</li></ol><blockquote><p>åˆ†æ</p></blockquote><ol><li>æŠŠè‹¥å¹²å­¦ç”Ÿå¯¹è±¡ ï¼Œä¿å­˜åˆ°é›†åˆä¸­ã€‚</li><li>æŠŠé›†åˆåºåˆ—åŒ–ã€‚</li><li>ååºåˆ—åŒ–è¯»å–æ—¶ï¼Œåªéœ€è¦è¯»å–ä¸€æ¬¡ï¼Œè½¬æ¢ä¸ºé›†åˆç±»å‹ã€‚</li><li>éå†é›†åˆï¼Œå¯ä»¥æ‰“å°æ‰€æœ‰çš„å­¦ç”Ÿä¿¡æ¯</li></ol><div class="tabs" id="3e032854-f16e-4c94-96cd-b7f5d280e943"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#3e032854-f16e-4c94-96cd-b7f5d280e943-1"><i class="fas fa-bug"></i>åºåˆ—åŒ–</button></li><li class="tab"><button type="button" data-href="#3e032854-f16e-4c94-96cd-b7f5d280e943-2"><i class="fas fa-cannabis"></i>ååºåˆ—åŒ–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="3e032854-f16e-4c94-96cd-b7f5d280e943-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;è€ç‹&quot;</span>, <span class="string">&quot;laow&quot;</span>);</span><br><span class="line"><span class="type">Student</span> <span class="variable">student2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;è€å¼ &quot;</span>, <span class="string">&quot;laoz&quot;</span>);</span><br><span class="line"><span class="type">Student</span> <span class="variable">student3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;è€æ&quot;</span>, <span class="string">&quot;laol&quot;</span>);</span><br><span class="line">ArrayList&lt;Student&gt; arrayList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">arrayList.add(student);</span><br><span class="line">arrayList.add(student2);</span><br><span class="line">arrayList.add(student3);</span><br><span class="line"><span class="comment">// åˆ›å»º åºåˆ—åŒ–æµ </span></span><br><span class="line">ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;list.txt&quot;</span>));</span><br><span class="line"><span class="comment">// å†™å‡ºå¯¹è±¡</span></span><br><span class="line">oos.writeObject(arrayList);</span><br><span class="line"><span class="comment">// é‡Šæ”¾èµ„æº</span></span><br><span class="line">oos.close();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="3e032854-f16e-4c94-96cd-b7f5d280e943-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;list.txt&quot;</span>));</span><br><span class="line"><span class="comment">// è¯»å–å¯¹è±¡,å¼ºè½¬ä¸ºArrayListç±»å‹</span></span><br><span class="line">ArrayList&lt;Student&gt; list = (ArrayList&lt;Student&gt;) ois.readObject();</span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;list.size();i++)&#123;</span><br><span class="line">    Student s=list.get(i);</span><br><span class="line">    System.out.println(s.getName()+<span class="string">&quot;--&quot;</span>+s.getPwd());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="10-æ‰“å°æµ">10. æ‰“å°æµ</h2><h3 id="10-1-æ¦‚è¿°">10.1 æ¦‚è¿°</h3><p>å¹³æ—¶æˆ‘ä»¬åœ¨æ§åˆ¶å°æ‰“å°è¾“å‡ºï¼Œæ˜¯è°ƒç”¨<code>print</code>æ–¹æ³•å’Œ<code>println</code>æ–¹æ³•å®Œæˆçš„ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ¥è‡ªäº<code>java.io.PrintStream</code>ç±»ï¼Œè¯¥ç±»èƒ½å¤Ÿæ–¹ä¾¿åœ°æ‰“å°å„ç§æ•°æ®ç±»å‹çš„å€¼ï¼Œæ˜¯ä¸€ç§ä¾¿æ·çš„è¾“å‡ºæ–¹å¼ã€‚</p><p>æ‰“å°æµåªæœ‰è¾“å‡ºæµï¼Œæ²¡æœ‰è¾“å…¥æµã€‚</p><p>æ‰“å°æµåˆ†ä¸ºä¸¤ç§PrintStreamå­—èŠ‚æ‰“å°æµï¼ŒPrintWriterå­—ç¬¦æ‰“å°æµã€‚</p><hr><h3 id="10-2-PrintStreamç±»">10.2 PrintStreamç±»</h3><h4 id="æ„é€ æ–¹æ³•-11">æ„é€ æ–¹æ³•</h4><p><code>public PrintStream(String fileName)  </code>ï¼š ä½¿ç”¨æŒ‡å®šçš„æ–‡ä»¶ååˆ›å»ºä¸€ä¸ªæ–°çš„æ‰“å°æµã€‚</p><p>æ„é€ ä¸¾ä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">PrintStream</span> <span class="variable">ps</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintStream</span>(<span class="string">&quot;ps.txt&quot;</span>)ï¼›</span><br></pre></td></tr></table></figure><hr><h4 id="æˆå‘˜æ–¹æ³•">æˆå‘˜æ–¹æ³•</h4><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>public void write(int b)</code></td><td>å¸¸è§„æ–¹æ³•ï¼šè§„åˆ™å’Œä¹‹å‰ä¸€æ ·ï¼Œå°†æŒ‡å®šçš„å­—èŠ‚å†™å‡º</td></tr><tr><td><code>public void println(Xxx xx)</code></td><td>ç‰¹æœ‰æ–¹æ³•ï¼šæ‰“å°ä»»æ„æ•°æ®ï¼Œè‡ªåŠ¨åˆ·æ–°ï¼Œè‡ªåŠ¨æ¢è¡Œ</td></tr><tr><td><code>public void print(Xxx xx)</code></td><td>ç‰¹æœ‰æ–¹æ³•ï¼šæ‰“å°ä»»æ„æ•°æ®ï¼Œä¸æ¢è¡Œ</td></tr><tr><td><code>public void printf(String format,Object... args)</code></td><td>ç‰¹æœ‰æ–¹æ³•ï¼šå¸¦æœ‰å ä½ç¬¦çš„æ‰“å°è¯­å¥ï¼Œä¸æ¢è¡Œ</td></tr></tbody></table><hr><h4 id="æ”¹å˜æ‰“å°æµå‘">æ”¹å˜æ‰“å°æµå‘</h4><p><code>System.out</code>å°±æ˜¯<code>PrintStream</code>ç±»å‹çš„ï¼Œåªä¸è¿‡å®ƒçš„æµå‘æ˜¯ç³»ç»Ÿè§„å®šçš„ï¼Œæ‰“å°åœ¨æ§åˆ¶å°ä¸Šã€‚ä¸è¿‡ï¼Œæ—¢ç„¶æ˜¯æµå¯¹è±¡ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç©ä¸€ä¸ª&quot;å°æŠŠæˆ&quot;ï¼Œæ”¹å˜å®ƒçš„æµå‘ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//è·å–æ‰“å°æµçš„å¯¹è±¡ï¼Œæ­¤æ‰“å°æµåœ¨è™šæ‹Ÿæœºå¯åŠ¨çš„æ—¶å€™ï¼Œç”±è™šæ‹Ÿæœºåˆ›å»ºï¼Œé»˜è®¤æŒ‡å‘æ§åˆ¶å°</span></span><br><span class="line">    <span class="comment">//ç‰¹æ®Šçš„æ‰“å°æµï¼Œç³»ç»Ÿä¸­çš„æ ‡å‡†è¾“å‡ºæµ</span></span><br><span class="line">    <span class="type">PrintStream</span> <span class="variable">ps</span> <span class="operator">=</span> System.out;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è°ƒç”¨æ‰“å°æµä¸­çš„æ–¹æ³•println</span></span><br><span class="line">    <span class="comment">// å†™å‡ºæ•°æ®ï¼Œè‡ªåŠ¨æ¢è¡Œï¼Œè‡ªåŠ¨åˆ·æ–°</span></span><br><span class="line">    ps.println(<span class="string">&quot;123&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ‰“å°æµ,æŒ‡å®šæ–‡ä»¶çš„åç§°</span></span><br><span class="line">    <span class="type">PrintStream</span> <span class="variable">ps1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintStream</span>(<span class="string">&quot;ps.txt&quot;</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½®ç³»ç»Ÿçš„æ‰“å°æµæµå‘,è¾“å‡ºåˆ°ps.txt</span></span><br><span class="line">    System.setOut(ps1);</span><br><span class="line">    <span class="comment">// è°ƒç”¨ç³»ç»Ÿçš„æ‰“å°æµ,ps.txtä¸­è¾“å‡º97</span></span><br><span class="line">    System.out.println(<span class="number">97</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h3 id="10-3-PrintWriterç±»">10.3 PrintWriterç±»</h3><h4 id="æ„é€ æ–¹æ³•-12">æ„é€ æ–¹æ³•</h4><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605151225339.png" alt="image-20230605151225339" style="zoom:67%;" /><hr><h4 id="æˆå‘˜æ–¹æ³•-2">æˆå‘˜æ–¹æ³•</h4><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605151421711.png" alt="image-20230605151421711" style="zoom:67%;" /><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//1.åˆ›å»ºå­—ç¬¦æ‰“å°æµå¯¹è±¡</span></span><br><span class="line">    <span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(<span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;myio\\a.txt&quot;</span>), <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//2.å†™å‡ºæ•°æ®</span></span><br><span class="line">    pw.println(<span class="string">&quot;ä»Šå¤©ä½ ç»ˆäºæ¥äº†&quot;</span>);</span><br><span class="line">    pw.print(<span class="string">&quot;ä½ å¥½&quot;</span>);</span><br><span class="line">    pw.printf(<span class="string">&quot;%sçˆ±ä¸Šäº†%s&quot;</span>,<span class="string">&quot;é˜¿ç&quot;</span>,<span class="string">&quot;é˜¿å¼º&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="10-4-æ€»ç»“">10.4 æ€»ç»“</h3><ol><li>æ‰“å°æµæœ‰å‡ ç§ï¼Ÿå„æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ</li></ol><p>æœ‰å­—èŠ‚æ‰“å°æµå’Œå­—ç¬¦æ‰“å°æµä¸¤ç§</p><p>æ‰“å°æµä¸æ“ä½œæ•°æ®æºï¼Œåªèƒ½æ“ä½œç›®çš„åœ°</p><p>å­—èŠ‚æ‰“å°æµï¼šé»˜è®¤è‡ªåŠ¨åˆ·æ–°ï¼Œç‰¹æœ‰çš„printlnè‡ªåŠ¨æ¢è¡Œ</p><p>å­—ç¬¦æ‰“å°æµï¼šè‡ªåŠ¨åˆ·æ–°éœ€è¦å¼€å¯ï¼Œç‰¹æœ‰çš„printlnè‡ªåŠ¨æ¢è¡Œ</p><hr><hr><h2 id="11-å‹ç¼©æµå’Œè§£å‹ç¼©æµ">11. å‹ç¼©æµå’Œè§£å‹ç¼©æµ</h2><p>å‹ç¼©æµï¼š</p><p>â€‹è´Ÿè´£å‹ç¼©æ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹</p><p>è§£å‹ç¼©æµï¼š</p><p>â€‹è´Ÿè´£æŠŠå‹ç¼©åŒ…ä¸­çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹è§£å‹å‡ºæ¥</p><div class="tabs" id="68286546-a105-4ead-9347-4855a17501be"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#68286546-a105-4ead-9347-4855a17501be-1"><i class="fas fa-cat"></i>å‹ç¼©æµ1</button></li><li class="tab"><button type="button" data-href="#68286546-a105-4ead-9347-4855a17501be-2"><i class="fas fa-horse"></i>å‹ç¼©æµ2</button></li><li class="tab"><button type="button" data-href="#68286546-a105-4ead-9347-4855a17501be-3"><i class="fas fa-dove"></i>è§£å‹ç¼©æµ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="68286546-a105-4ead-9347-4855a17501be-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZipStreamDemo2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         *   å‹ç¼©æµ</span></span><br><span class="line"><span class="comment">         *      éœ€æ±‚ï¼š</span></span><br><span class="line"><span class="comment">         *          æŠŠD:\\a.txtæ‰“åŒ…æˆä¸€ä¸ªå‹ç¼©åŒ…</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">//1.åˆ›å»ºFileå¯¹è±¡è¡¨ç¤ºè¦å‹ç¼©çš„æ–‡ä»¶</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">src</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\a.txt&quot;</span>);</span><br><span class="line">        <span class="comment">//2.åˆ›å»ºFileå¯¹è±¡è¡¨ç¤ºå‹ç¼©åŒ…çš„ä½ç½®</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">dest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\&quot;</span>);</span><br><span class="line">        <span class="comment">//3.è°ƒç”¨æ–¹æ³•ç”¨æ¥å‹ç¼©</span></span><br><span class="line">        toZip(src,dest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    *   ä½œç”¨ï¼šå‹ç¼©</span></span><br><span class="line"><span class="comment">    *   å‚æ•°ä¸€ï¼šè¡¨ç¤ºè¦å‹ç¼©çš„æ–‡ä»¶</span></span><br><span class="line"><span class="comment">    *   å‚æ•°äºŒï¼šè¡¨ç¤ºå‹ç¼©åŒ…çš„ä½ç½®</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">toZip</span><span class="params">(File src,File dest)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//1.åˆ›å»ºå‹ç¼©æµå…³è”å‹ç¼©åŒ…</span></span><br><span class="line">        <span class="type">ZipOutputStream</span> <span class="variable">zos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(dest,<span class="string">&quot;a.zip&quot;</span>)));</span><br><span class="line">        <span class="comment">//2.åˆ›å»ºZipEntryå¯¹è±¡ï¼Œè¡¨ç¤ºå‹ç¼©åŒ…é‡Œé¢çš„æ¯ä¸€ä¸ªæ–‡ä»¶å’Œæ–‡ä»¶å¤¹</span></span><br><span class="line">        <span class="comment">//å‚æ•°ï¼šå‹ç¼©åŒ…é‡Œé¢çš„è·¯å¾„</span></span><br><span class="line">        <span class="type">ZipEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipEntry</span>(<span class="string">&quot;aaa\\bbb\\a.txt&quot;</span>);</span><br><span class="line">        <span class="comment">//3.æŠŠZipEntryå¯¹è±¡æ”¾åˆ°å‹ç¼©åŒ…å½“ä¸­</span></span><br><span class="line">        zos.putNextEntry(entry);</span><br><span class="line">        <span class="comment">//4.æŠŠsrcæ–‡ä»¶ä¸­çš„æ•°æ®å†™åˆ°å‹ç¼©åŒ…å½“ä¸­</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(src);</span><br><span class="line">        <span class="type">int</span> b;</span><br><span class="line">        <span class="keyword">while</span>((b = fis.read()) != -<span class="number">1</span>)&#123;</span><br><span class="line">            zos.write(b);</span><br><span class="line">        &#125;</span><br><span class="line">        zos.closeEntry();</span><br><span class="line">        zos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="68286546-a105-4ead-9347-4855a17501be-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZipStreamDemo3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         *   å‹ç¼©æµ</span></span><br><span class="line"><span class="comment">         *      éœ€æ±‚ï¼š</span></span><br><span class="line"><span class="comment">         *          æŠŠD:\\aaaæ–‡ä»¶å¤¹å‹ç¼©æˆä¸€ä¸ªå‹ç¼©åŒ…</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">//1.åˆ›å»ºFileå¯¹è±¡è¡¨ç¤ºè¦å‹ç¼©çš„æ–‡ä»¶å¤¹</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">src</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\aaa&quot;</span>);</span><br><span class="line">        <span class="comment">//2.åˆ›å»ºFileå¯¹è±¡è¡¨ç¤ºå‹ç¼©åŒ…æ”¾åœ¨å“ªé‡Œï¼ˆå‹ç¼©åŒ…çš„çˆ¶çº§è·¯å¾„ï¼‰</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">destParent</span> <span class="operator">=</span> src.getParentFile();<span class="comment">//D:\\</span></span><br><span class="line">        <span class="comment">//3.åˆ›å»ºFileå¯¹è±¡è¡¨ç¤ºå‹ç¼©åŒ…çš„è·¯å¾„</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">dest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(destParent,src.getName() + <span class="string">&quot;.zip&quot;</span>);</span><br><span class="line">        <span class="comment">//4.åˆ›å»ºå‹ç¼©æµå…³è”å‹ç¼©åŒ…</span></span><br><span class="line">        <span class="type">ZipOutputStream</span> <span class="variable">zos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(dest));</span><br><span class="line">        <span class="comment">//5.è·å–srcé‡Œé¢çš„æ¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå˜æˆZipEntryå¯¹è±¡ï¼Œæ”¾å…¥åˆ°å‹ç¼©åŒ…å½“ä¸­</span></span><br><span class="line">        toZip(src,zos,src.getName());<span class="comment">//aaa</span></span><br><span class="line">        <span class="comment">//6.é‡Šæ”¾èµ„æº</span></span><br><span class="line">        zos.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    *   ä½œç”¨ï¼šè·å–srcé‡Œé¢çš„æ¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå˜æˆZipEntryå¯¹è±¡ï¼Œæ”¾å…¥åˆ°å‹ç¼©åŒ…å½“ä¸­</span></span><br><span class="line"><span class="comment">    *   å‚æ•°ä¸€ï¼šæ•°æ®æº</span></span><br><span class="line"><span class="comment">    *   å‚æ•°äºŒï¼šå‹ç¼©æµ</span></span><br><span class="line"><span class="comment">    *   å‚æ•°ä¸‰ï¼šå‹ç¼©åŒ…å†…éƒ¨çš„è·¯å¾„</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">toZip</span><span class="params">(File src,ZipOutputStream zos,String name)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//1.è¿›å…¥srcæ–‡ä»¶å¤¹</span></span><br><span class="line">        File[] files = src.listFiles();</span><br><span class="line">        <span class="comment">//2.éå†æ•°ç»„</span></span><br><span class="line">        <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">            <span class="keyword">if</span>(file.isFile())&#123;</span><br><span class="line">                <span class="comment">//3.åˆ¤æ–­-æ–‡ä»¶ï¼Œå˜æˆZipEntryå¯¹è±¡ï¼Œæ”¾å…¥åˆ°å‹ç¼©åŒ…å½“ä¸­</span></span><br><span class="line">                <span class="type">ZipEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipEntry</span>(name + <span class="string">&quot;\\&quot;</span> + file.getName());<span class="comment">//aaa\\no1\\a.txt</span></span><br><span class="line">                zos.putNextEntry(entry);</span><br><span class="line">                <span class="comment">//è¯»å–æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œå†™åˆ°å‹ç¼©åŒ…</span></span><br><span class="line">                <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">                <span class="type">int</span> b;</span><br><span class="line">                <span class="keyword">while</span>((b = fis.read()) != -<span class="number">1</span>)&#123;</span><br><span class="line">                    zos.write(b);</span><br><span class="line">                &#125;</span><br><span class="line">                fis.close();</span><br><span class="line">                zos.closeEntry();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//4.åˆ¤æ–­-æ–‡ä»¶å¤¹ï¼Œé€’å½’</span></span><br><span class="line">                toZip(file,zos,name + <span class="string">&quot;\\&quot;</span> + file.getName());</span><br><span class="line">                <span class="comment">//     no1            aaa   \\   no1</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="68286546-a105-4ead-9347-4855a17501be-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZipStreamDemo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1.åˆ›å»ºä¸€ä¸ªFileè¡¨ç¤ºè¦è§£å‹çš„å‹ç¼©åŒ…</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">src</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\aaa.zip&quot;</span>);</span><br><span class="line">        <span class="comment">//2.åˆ›å»ºä¸€ä¸ªFileè¡¨ç¤ºè§£å‹çš„ç›®çš„åœ°</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">dest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è°ƒç”¨æ–¹æ³•</span></span><br><span class="line">        unzip(src,dest);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®šä¹‰ä¸€ä¸ªæ–¹æ³•ç”¨æ¥è§£å‹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unzip</span><span class="params">(File src,File dest)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//è§£å‹çš„æœ¬è´¨ï¼šæŠŠå‹ç¼©åŒ…é‡Œé¢çš„æ¯ä¸€ä¸ªæ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹è¯»å–å‡ºæ¥ï¼ŒæŒ‰ç…§å±‚çº§æ‹·è´åˆ°ç›®çš„åœ°å½“ä¸­</span></span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªè§£å‹ç¼©æµç”¨æ¥è¯»å–å‹ç¼©åŒ…ä¸­çš„æ•°æ®</span></span><br><span class="line">        <span class="type">ZipInputStream</span> <span class="variable">zip</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(src));</span><br><span class="line">        <span class="comment">//è¦å…ˆè·å–åˆ°å‹ç¼©åŒ…é‡Œé¢çš„æ¯ä¸€ä¸ªzipentryå¯¹è±¡</span></span><br><span class="line">        <span class="comment">//è¡¨ç¤ºå½“å‰åœ¨å‹ç¼©åŒ…ä¸­è·å–åˆ°çš„æ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹</span></span><br><span class="line">        ZipEntry entry;</span><br><span class="line">        <span class="keyword">while</span>((entry = zip.getNextEntry()) != <span class="literal">null</span>)&#123;</span><br><span class="line">            System.out.println(entry);</span><br><span class="line">            <span class="keyword">if</span>(entry.isDirectory())&#123;</span><br><span class="line">                <span class="comment">//æ–‡ä»¶å¤¹ï¼šéœ€è¦åœ¨ç›®çš„åœ°destå¤„åˆ›å»ºä¸€ä¸ªåŒæ ·çš„æ–‡ä»¶å¤¹</span></span><br><span class="line">                <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(dest,entry.toString());</span><br><span class="line">                file.mkdirs();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//æ–‡ä»¶ï¼šéœ€è¦è¯»å–åˆ°å‹ç¼©åŒ…ä¸­çš„æ–‡ä»¶ï¼Œå¹¶æŠŠä»–å­˜æ”¾åˆ°ç›®çš„åœ°destæ–‡ä»¶å¤¹ä¸­ï¼ˆæŒ‰ç…§å±‚çº§ç›®å½•è¿›è¡Œå­˜æ”¾ï¼‰</span></span><br><span class="line">                <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(dest,entry.toString()));</span><br><span class="line">                <span class="type">int</span> b;</span><br><span class="line">                <span class="keyword">while</span>((b = zip.read()) != -<span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="comment">//å†™åˆ°ç›®çš„åœ°</span></span><br><span class="line">                    fos.write(b);</span><br><span class="line">                &#125;</span><br><span class="line">                fos.close();</span><br><span class="line">                <span class="comment">//è¡¨ç¤ºåœ¨å‹ç¼©åŒ…ä¸­çš„ä¸€ä¸ªæ–‡ä»¶å¤„ç†å®Œæ¯•äº†ã€‚</span></span><br><span class="line">                zip.closeEntry();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        zip.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="12-å·¥å…·åŒ…">12. å·¥å…·åŒ…</h2><h3 id="Commons-io">Commons-io</h3><p>ä»‹ç»ï¼š</p><p>â€‹Commonsæ˜¯apacheå¼€æºåŸºé‡‘ç»„ç»‡æä¾›çš„å·¥å…·åŒ…ï¼Œé‡Œé¢æœ‰å¾ˆå¤šå¸®åŠ©æˆ‘ä»¬æé«˜å¼€å‘æ•ˆç‡çš„API</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605152735412.png" alt="image-20230605152735412" style="zoom:67%;" /><blockquote><p>å¸¸è§æ–¹æ³•</p></blockquote><div class="tabs" id="99950581-ffc1-4236-b396-1a2789bddfe2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#99950581-ffc1-4236-b396-1a2789bddfe2-1"><i class="fas fa-seedling"></i>FileUtils</button></li><li class="tab"><button type="button" data-href="#99950581-ffc1-4236-b396-1a2789bddfe2-2"><i class="fas fa-leaf"></i>IOUtils</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="99950581-ffc1-4236-b396-1a2789bddfe2-1"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605152935221.png" alt="image-20230605152935221"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="99950581-ffc1-4236-b396-1a2789bddfe2-2"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605153001115.png" alt="image-20230605153001115"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsIODemo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">          FileUtilsç±»</span></span><br><span class="line"><span class="comment">                static void copyFile(File srcFile, File destFile)                   å¤åˆ¶æ–‡ä»¶</span></span><br><span class="line"><span class="comment">                static void copyDirectory(File srcDir, File destDir)                å¤åˆ¶æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="comment">                static void copyDirectoryToDirectory(File srcDir, File destDir)     å¤åˆ¶æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="comment">                static void deleteDirectory(File directory)                         åˆ é™¤æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="comment">                static void cleanDirectory(File directory)                          æ¸…ç©ºæ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="comment">                static String readFileToString(File file, Charset encoding)         è¯»å–æ–‡ä»¶ä¸­çš„æ•°æ®å˜æˆæˆå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment">                static void write(File file, CharSequence data, String encoding)    å†™å‡ºæ•°æ®</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            IOUtilsç±»</span></span><br><span class="line"><span class="comment">                public static int copy(InputStream input, OutputStream output)      å¤åˆ¶æ–‡ä»¶</span></span><br><span class="line"><span class="comment">                public static int copyLarge(Reader input, Writer output)            å¤åˆ¶å¤§æ–‡ä»¶</span></span><br><span class="line"><span class="comment">                public static String readLines(Reader input)                        è¯»å–æ•°æ®</span></span><br><span class="line"><span class="comment">                public static void write(String data, OutputStream output)          å†™å‡ºæ•°æ®</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* File src = new File(&quot;myio\\a.txt&quot;);</span></span><br><span class="line"><span class="comment">        File dest = new File(&quot;myio\\copy.txt&quot;);</span></span><br><span class="line"><span class="comment">        FileUtils.copyFile(src,dest);*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*File src = new File(&quot;D:\\aaa&quot;);</span></span><br><span class="line"><span class="comment">        File dest = new File(&quot;D:\\bbb&quot;);</span></span><br><span class="line"><span class="comment">        FileUtils.copyDirectoryToDirectory(src,dest);*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*File src = new File(&quot;D:\\bbb&quot;);</span></span><br><span class="line"><span class="comment">        FileUtils.cleanDirectory(src);*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="hutool">hutool</h3><p>ä»‹ç»ï¼š</p><p>â€‹Commonsæ˜¯å›½äººå¼€å‘çš„å¼€æºå·¥å…·åŒ…ï¼Œé‡Œé¢æœ‰å¾ˆå¤šå¸®åŠ©æˆ‘ä»¬æé«˜å¼€å‘æ•ˆç‡çš„API</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605153252059.png" alt="image-20230605153252059"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        FileUtilç±»:</span></span><br><span class="line"><span class="comment">                fileï¼šæ ¹æ®å‚æ•°åˆ›å»ºä¸€ä¸ªfileå¯¹è±¡</span></span><br><span class="line"><span class="comment">                touchï¼šæ ¹æ®å‚æ•°åˆ›å»ºæ–‡ä»¶</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                writeLinesï¼šæŠŠé›†åˆä¸­çš„æ•°æ®å†™å‡ºåˆ°æ–‡ä»¶ä¸­ï¼Œè¦†ç›–æ¨¡å¼ã€‚</span></span><br><span class="line"><span class="comment">                appendLinesï¼šæŠŠé›†åˆä¸­çš„æ•°æ®å†™å‡ºåˆ°æ–‡ä»¶ä¸­ï¼Œç»­å†™æ¨¡å¼ã€‚</span></span><br><span class="line"><span class="comment">                readLinesï¼šæŒ‡å®šå­—ç¬¦ç¼–ç ï¼ŒæŠŠæ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œè¯»åˆ°é›†åˆä¸­ã€‚</span></span><br><span class="line"><span class="comment">                readUtf8Linesï¼šæŒ‰ç…§UTF-8çš„å½¢å¼ï¼ŒæŠŠæ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œè¯»åˆ°é›†åˆä¸­</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                copyï¼šæ‹·è´æ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="comment">/* File file1 = FileUtil.file(&quot;D:\\&quot;, &quot;aaa&quot;, &quot;bbb&quot;, &quot;a.txt&quot;);</span></span><br><span class="line"><span class="comment">        System.out.println(file1);//D:\aaa\bbb\a.txt</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        File touch = FileUtil.touch(file1);</span></span><br><span class="line"><span class="comment">        System.out.println(touch);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        ArrayList&lt;String&gt; list = new ArrayList&lt;&gt;();</span></span><br><span class="line"><span class="comment">        list.add(&quot;aaa&quot;);</span></span><br><span class="line"><span class="comment">        list.add(&quot;aaa&quot;);</span></span><br><span class="line"><span class="comment">        list.add(&quot;aaa&quot;);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        File file2 = FileUtil.writeLines(list, &quot;D:\\a.txt&quot;, &quot;UTF-8&quot;);</span></span><br><span class="line"><span class="comment">        System.out.println(file2);*/</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/*  ArrayList&lt;String&gt; list = new ArrayList&lt;&gt;();</span></span><br><span class="line"><span class="comment">        list.add(&quot;aaa&quot;);</span></span><br><span class="line"><span class="comment">        list.add(&quot;aaa&quot;);</span></span><br><span class="line"><span class="comment">        list.add(&quot;aaa&quot;);</span></span><br><span class="line"><span class="comment">        File file3 = FileUtil.appendLines(list, &quot;D:\\a.txt&quot;, &quot;UTF-8&quot;);</span></span><br><span class="line"><span class="comment">        System.out.println(file3);*/</span></span><br><span class="line">        List&lt;String&gt; list = FileUtil.readLines(<span class="string">&quot;D:\\a.txt&quot;</span>, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">å­—èŠ‚æµã€å­—ç¬¦æµã€å…¶ä»–æµã€å·¥å…·åŒ…</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>MyBatisPlusåŸç†è§£æ</title>
    <link href="https://wuwawawa.github.io/posts/66abc186.html"/>
    <id>https://wuwawawa.github.io/posts/66abc186.html</id>
    <published>2023-06-01T00:53:00.000Z</published>
    <updated>2023-06-02T09:25:22.213Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä½¿ç”¨MyBatis Plusæ—¶ï¼Œæˆ‘ä»¬çš„Mapperæ¥å£ç»§æ‰¿çˆ¶æ¥å£ï¼šBaseMapperã€‚BaseMapperä¸­å®šä¹‰äº†ä¸€ç³»åˆ—CRUDæ–¹æ³•ï¼Œå­æ¥å£å¯ä»¥ç»§æ‰¿ã€‚ä½†æ˜¯é¡¹ç›®ä¸­å¹¶æ²¡æœ‰ç¼–å†™ CRUD SQLè¯­å¥ï¼Œä¸ºä»€ä¹ˆå¯ä»¥å¯¹æ•°æ®åº“è¿›è¡ŒCRUDæ“ä½œå‘¢ï¼Ÿ MyBatis Plusæ˜¯æ€ä¹ˆè¿›è¡ŒSQL è¯­å¥æ‹¼æ¥çš„ï¼Ÿ</p><mark class="hl-label blue">åˆ†æ</mark> <blockquote><p>Mybatis Pluså¦‚ä½•æ„ŸçŸ¥è¦æ“ä½œå“ªå¼ è¡¨ï¼Œå“ªäº›åˆ—å‘¢ï¼Ÿ</p></blockquote><p>å®ä½“å¯¹è±¡ä¸è¡¨æ˜¯å¯ä»¥è¿›è¡Œæ˜ å°„çš„ï¼Œåœ¨å®šä¹‰Mapperæ¥å£æ—¶ï¼ŒBaseMapperä¸­æ˜ç¡®æŒ‡å®šäº†æ³›å‹ä¸ºå¯¹åº”å®ä½“å¯¹è±¡ï¼Œé‚£ä¹ˆå¯ä»¥å€ŸåŠ©åå°„è·å–å®ä½“ç±»å­—èŠ‚ç å¯¹è±¡ã€‚è·å–åˆ°å­—èŠ‚ç å¯¹è±¡åï¼Œå°±å¯ä»¥é€šè¿‡åå°„è·å–å®ä½“ç±»çš„ç±»åå’Œå­—æ®µåã€‚</p><blockquote><p>SQLæ‹¼æ¥éœ€è¦è€ƒè™‘å“ªäº›æ ¸å¿ƒç‚¹ï¼Ÿ</p></blockquote><p>å¢ï¼šinsert into è¡¨(åˆ—1ï¼Œåˆ—2 â€¦) values(â€¦)</p><p>åˆ ï¼šdelete from è¡¨</p><p>æ”¹ï¼šupdate è¡¨ set åˆ—1 = xxx,åˆ—2 = xxx</p><p>æŸ¥ï¼š select åˆ—1ï¼Œåˆ—2 from è¡¨</p><ul><li>è¡¨å</li><li>åˆ—å</li></ul><p>äºŒè€…å¯¹åº”MyBatis Plusä¸­<code>TableInfo</code>ç±»ã€‚</p><hr><hr><h2 id="ä»Springbootè‡ªåŠ¨è£…é…ç±»å¼€å§‹">ä»Springbootè‡ªåŠ¨è£…é…ç±»å¼€å§‹</h2><p>ä» mybatis-plus æºç ä¸­çš„ spring.factories æ–‡ä»¶ä¸­æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ï¼Œå…¶åŠ è½½å…¥å£ä¸º <code>MybatisPlusAutoConfiguration</code>ã€‚ ç‚¹è¿›å»è¿™ä¸ªç±»å¯ä»¥å‘ç°é‡Œé¢æœ‰å‡ ä¸ªæ ¸å¿ƒçš„ bean:</p><div class="tabs" id="8ca46c6e-24e7-41ac-be61-0cafadeb370e"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#8ca46c6e-24e7-41ac-be61-0cafadeb370e-1"><i class="fas fa-seedling"></i>SqlSessionFactory</button></li><li class="tab"><button type="button" data-href="#8ca46c6e-24e7-41ac-be61-0cafadeb370e-2"><i class="fas fa-leaf"></i>SqlSessionTemplate</button></li><li class="tab"><button type="button" data-href="#8ca46c6e-24e7-41ac-be61-0cafadeb370e-3"><i class="fab fa-apple"></i>MapperScannerConfigurer</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="8ca46c6e-24e7-41ac-be61-0cafadeb370e-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="keyword">public</span> SqlSessionFactory <span class="title function_">sqlSessionFactory</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// mybatisplus é‡å†™çš„ SqlSessionFactoryBean</span></span><br><span class="line">    <span class="type">MybatisSqlSessionFactoryBean</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisSqlSessionFactoryBean</span>();</span><br><span class="line">    factory.setDataSource(dataSource);</span><br><span class="line">    applyConfiguration(factory); <span class="comment">// setConfiguration</span></span><br><span class="line">    <span class="comment">// set ï¼šinterceptorsï¼ŒtypeHandlersï¼Œ</span></span><br><span class="line">    <span class="comment">//      mapperLocationsï¼ŒtypeEnumsPackageï¼ŒglobalConfig ç­‰</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> factory.getObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8ca46c6e-24e7-41ac-be61-0cafadeb370e-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="keyword">public</span> SqlSessionTemplate <span class="title function_">sqlSessionTemplate</span><span class="params">(SqlSessionFactory sqlSessionFactory)</span> &#123;</span><br><span class="line">    <span class="type">ExecutorType</span> <span class="variable">executorType</span> <span class="operator">=</span> <span class="built_in">this</span>.properties.getExecutorType();</span><br><span class="line">    <span class="keyword">if</span> (executorType != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SqlSessionTemplate</span>(sqlSessionFactory, executorType);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SqlSessionTemplate</span>(sqlSessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8ca46c6e-24e7-41ac-be61-0cafadeb370e-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ³¨å†Œä¸€ä¸ª MapperScannerConfigurer beanDefinition</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AutoConfiguredMapperScannerRegistrar</span> <span class="keyword">implements</span> <span class="title class_">BeanFactoryAware</span>, ImportBeanDefinitionRegistrar &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">// å®šä¹‰ MapperScannerConfigurer</span></span><br><span class="line">        <span class="type">BeanDefinitionBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(MapperScannerConfigurer.class);</span><br><span class="line">        <span class="comment">// addPropertyValue: basePackageç­‰</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        registry.registerBeanDefinition(MapperScannerConfigurer.class.getName(), builder.getBeanDefinition());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="MapperScannerConfigurer">MapperScannerConfigurer</h2><p>é¦–å…ˆçœ‹<code>MapperScannerConfigurer</code>è¿™ä¸ª beanï¼Œè¿™æ˜¯ä¸€ä¸ªæ‰«æ mapper çš„é…ç½®ç±»ï¼Œå®ç°äº†<code>BeanDefinitionRegistryPostProcessor</code>æ¥å£ï¼Œæ˜¯ä¸€ä¸ªBeanå·¥å‚åå¤„ç†å™¨ï¼Œå†…éƒ¨ä½¿ç”¨ <code>ClassPathMapperScanner</code> æ ¹æ®é…ç½®æ‰«æ mapper æ¥å£å¹¶å°†æ¥å£æ³¨å†Œä¸º <code>MapperFactoryBean</code>ã€‚</p><p>åˆ›å»º MapperScannerConfigurer beançš„æ–¹å¼ä¸€èˆ¬æœ‰ä¸¤ç§:</p><ul><li>é€šè¿‡MyBatisPlusçš„è‡ªåŠ¨è£…é…ç±»æ³¨å†Œï¼Œé»˜è®¤æ‰«æé»˜è®¤åŒ…ä¸‹çš„å¸¦ <code>@Mapper</code> æ³¨è§£çš„æ¥å£ã€‚</li><li>é€šè¿‡è§£æ <code>@MapperScan</code> æ³¨è§£çš„å±æ€§åœ¨ spring ä¸­æ³¨å†Œ <code>MapperScannerConfigurer</code> çš„ beanDefinitionï¼Œæ‰«æ@MapperScanæ³¨è§£è®¾ç½®çš„basepackageã€‚</li></ul><div class="tabs" id="25546681-aa8c-4e11-94a2-92f95721ebc3"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#25546681-aa8c-4e11-94a2-92f95721ebc3-1"><i class="fas fa-cat"></i>1</button></li><li class="tab"><button type="button" data-href="#25546681-aa8c-4e11-94a2-92f95721ebc3-2"><i class="fas fa-horse"></i>2</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="25546681-aa8c-4e11-94a2-92f95721ebc3-1"><p><mark class="hl-label blue">MapperScannerConfigurer#postProcessBeanDefinitionRegistry</mark></p><p>åˆ›å»º <code>ClassPathMapperScanner</code> å¯¹è±¡ï¼ˆç»§æ‰¿ <code>ClassPathBeanDefinitionScanner</code>ï¼‰ï¼Œè®¾ç½®ç›¸å…³å±æ€§ï¼ˆå‚è€ƒ<code>MapperScan</code>å±æ€§ï¼‰ï¼Œæ ¹æ®è®¾ç½®çš„å±æ€§æ³¨å†Œæ‰«æè¿‡æ»¤å™¨ï¼Œå¼€å§‹æ‰§è¡Œæ‰«æ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.processPropertyPlaceHolders) &#123;</span><br><span class="line">      processPropertyPlaceHolders();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">ClassPathMapperScanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathMapperScanner</span>(registry);</span><br><span class="line">    <span class="comment">// set ç›¸å…³å±æ€§  æ‰«æè¿‡æ»¤è§„åˆ™ã€æŒ‡å®š sqlSessionxxxã€‚ã€‚</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">// æ ¹æ® set çš„å±æ€§ï¼Œæ³¨å†Œæ‰«æè¿‡æ»¤å™¨</span></span><br><span class="line">    scanner.registerFilters();</span><br><span class="line">    <span class="comment">// æ‰«æ mapper æ¥å£ï¼Œå¹¶æ³¨å†Œ beanDefinitionï¼Œ åº•å±‚æ˜¯ doScan</span></span><br><span class="line">    scanner.scan(</span><br><span class="line">        StringUtils.tokenizeToStringArray(<span class="built_in">this</span>.basePackage, ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="25546681-aa8c-4e11-94a2-92f95721ebc3-2"><p><mark class="hl-label green">ClassPathMapperScanner#doScan</mark></p><ul><li>æ ¹æ®<code>@MapperScan(&quot;com.example.mybatisplus.mapper&quot;)</code>é…ç½®çš„basePackageæ‰«æmapperï¼Œå¹¶æ³¨å†Œ beanDifinition</li><li>ä¿®æ”¹æ‰«æåˆ°çš„ beanDefinition ç±»å‹ä¸º <code>MapperFactoryBean</code> (æˆ–<code>@MapperScan</code> æŒ‡å®šçš„è‡ªå®šä¹‰ç±»å‹)</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Set&lt;BeanDefinitionHolder&gt; <span class="title function_">doScan</span><span class="params">(String... basePackages)</span> &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨çˆ¶ç±» ClassPathBeanDefinitionScanner æ–¹æ³•æ‰«æå¹¶æ³¨å†Œ beanDifinition</span></span><br><span class="line">    Set&lt;BeanDefinitionHolder&gt; beanDefinitions = <span class="built_in">super</span>.doScan(basePackages);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (beanDefinitions.isEmpty()) &#123;</span><br><span class="line">      LOGGER.warn(() -&gt; <span class="string">&quot;No MyBatis mapper was found in &#x27;&quot;</span> + Arrays.toString(basePackages)</span><br><span class="line">          + <span class="string">&quot;&#x27; package. Please check your configuration.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å¯¹ mapper çš„ beanDefinition è¿›è¡Œå¤„ç†: ä¿®æ”¹ beanClass ç±»å‹ç­‰ã€‚</span></span><br><span class="line">      processBeanDefinitions(beanDefinitions);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> beanDefinitions;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processBeanDefinitions</span><span class="params">(Set&lt;BeanDefinitionHolder&gt; beanDefinitions)</span> &#123;</span><br><span class="line">    GenericBeanDefinition definition;</span><br><span class="line">    <span class="keyword">for</span> (BeanDefinitionHolder holder : beanDefinitions) &#123;</span><br><span class="line">      definition = (GenericBeanDefinition) holder.getBeanDefinition();</span><br><span class="line">      <span class="type">String</span> <span class="variable">beanClassName</span> <span class="operator">=</span> definition.getBeanClassName();</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// æ„é€ æ–¹æ³•ä¸­ä¼ å…¥åŸ mapper bean ç±»å‹</span></span><br><span class="line">      definition.getConstructorArgumentValues().addGenericArgumentValue(beanClassName);</span><br><span class="line">      <span class="comment">// ä¿®æ”¹ bean ç±»å‹ä¸º MapperFactoryBean</span></span><br><span class="line">      definition.setBeanClass(<span class="built_in">this</span>.mapperFactoryBeanClass);</span><br><span class="line">      ... <span class="comment">// set sqlSessionFactory, sqlSessionTemplate (å¦‚æœå­˜åœ¨çš„è¯)</span></span><br><span class="line">      <span class="comment">// è®¾ç½®æ‡’åŠ è½½</span></span><br><span class="line">      definition.setLazyInit(lazyInitialization);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>æ‰«æ Mapper åä¼šå°†å…¶ beanDefinition.beanClass ä¿®æ”¹ä¸º <code>MapperFactoryBean</code>ã€‚ æ‰€ä»¥åœ¨åç»­ spring å°† mapper beanåˆå§‹åŒ–æ—¶ï¼Œä¼šé€šè¿‡è°ƒç”¨ <code>MapperFactoryBean.getObject</code> è·å–å…¶å¯¹è±¡ã€‚</p><p>æŸ¥çœ‹æºç å¯ä»¥å‘ç°ï¼Œæœ€ç»ˆæ˜¯è°ƒç”¨ sqlSession çš„ getMapper æ–¹æ³•è·å–mapperä»£ç†å¯¹è±¡ã€‚å…·ä½“å®ç°åé¢å†çœ‹ã€‚</p><hr><hr><h2 id="SqlSessionFactory">SqlSessionFactory</h2><p>è‡ªåŠ¨è£…é…ç±»é‡Œçš„sqlSessionFactory beanæ˜¯ mybatis plusçš„ç”¨æ¥è·å– sqlSession (ç”¨æ¥æ‰§è¡Œ sql ç®¡ç†äº‹åŠ¡çš„å¯¹è±¡)çš„å·¥å‚ç±»ã€‚</p><p>åˆ›å»º sqlSessionFactory çš„é€»è¾‘åœ¨ <code>MybatisSqlSessionFactoryBean#buildSqlSessionFactory</code> æ–¹æ³•ä¸­ï¼Œé‡Œé¢ä¸»è¦æ˜¯</p><ul><li>è®¾ç½®é…ç½®æ–‡ä»¶é‡Œé…ç½®çš„å±æ€§ï¼šglobalConfigï¼ŒtypeHandlersï¼Œinterceptorâ€¦</li><li>è§£æ mapper.xml å¹¶ä¿å­˜åˆ° configuration ä¸­</li><li>åˆ›å»ºsqlSessionFactory</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> SqlSessionFactory <span class="title function_">buildSqlSessionFactory</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">final</span> Configuration targetConfiguration;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.configuration != <span class="literal">null</span>) &#123;  <span class="comment">// AutoConfig  é‡Œé¢ set çš„ configuration</span></span><br><span class="line">        targetConfiguration = <span class="built_in">this</span>.configuration;</span><br><span class="line">        ...</span><br><span class="line">    &#125; </span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// åŠ è½½å‰é¢çš„é…ç½® å¹¶ set åˆ° targetConfiguration ä¸­, </span></span><br><span class="line">    <span class="comment">//      å¦‚ï¼šset globalConfig, register typeHandlersï¼Œ addInterceptorï¼Œ parse xmlMapper</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// è§£æ mapper.xml, å¹¶å°†è§£æçš„ç»“æœå­˜åœ¨ targetConfiguration ä¸­</span></span><br><span class="line">    <span class="keyword">for</span> (Resource mapperLocation : <span class="built_in">this</span>.mapperLocations) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="type">Builder</span> <span class="variable">xmlMapperBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLMapperBuilder</span>(mapperLocation.getInputStream(),</span><br><span class="line">                            targetConfiguration, mapperLocation.toString(), targetConfiguration.getSqlFragments());</span><br><span class="line">        xmlMapperBuilder.parse();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// æ„å»º SqlSessionFactoryï¼Œ å®ç°ç±»ä¸º DefaultSqlSessionFactory</span></span><br><span class="line">    <span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisSqlSessionFactoryBuilder</span>().build(targetConfiguration);</span><br><span class="line">    <span class="keyword">return</span> sqlSessionFactory;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h3 id="è§£æmapper-xml">è§£æmapper.xml</h3><p>XMLMapperBuilder ä¸»è¦ç”¨äºè§£æ mapper.xml æ–‡ä»¶ï¼Œå…¥å£ä¸º <code>XMLMapperBuilder#parse</code>ï¼Œ XMLMapperBuilder ä¼šè§£æ mapper.xml æ–‡ä»¶ä¸­é…ç½®çš„ statementsã€resultMapã€parameter ç­‰ä¿¡æ¯ï¼Œ å¹¶å°†å…¶å­˜æ”¾äº Configuration çš„ å¯¹åº” map ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// XMLMapperBuilder.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// resourceï¼š file /../xxxMapper.xml åˆ¤æ–­æ˜¯å¦åŠ è½½è¿‡</span></span><br><span class="line">    <span class="keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line">        <span class="comment">// 1 è§£æ mapper.xml æ–‡ä»¶</span></span><br><span class="line">        configurationElement(parser.evalNode(<span class="string">&quot;/mapper&quot;</span>));</span><br><span class="line">        configuration.addLoadedResource(resource);</span><br><span class="line">        <span class="comment">// 2  æ³¨å†Œ Mapper åº•å±‚è°ƒç”¨ MybatisMapperRegistry#addMapper æ³¨å†Œ Mapper</span></span><br><span class="line">        bindMapperForNamespace();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‰é¢æ²¡è§£æå®Œæˆçš„ ç»§ç»­è§£æï¼Œ çœ‹ä»£ç ä¸»è¦æ˜¯é’ˆå¯¹å‰é¢è§£æå‡ºé”™çš„</span></span><br><span class="line">    parsePendingResultMaps();</span><br><span class="line">    parsePendingCacheRefs();</span><br><span class="line">    parsePendingStatements();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£æ mapper.xml å Configuration å¯¹è±¡ç¤ºä¾‹ï¼šå½“å‰åªåŒ…å« mapper.xml ä¸­çš„ sql è¯­å¥ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230602155859233.png" alt="image-20230602155859233" style="zoom: 50%;" /><p>XMLMapperBuilder è§£æå®Œ xml æ–‡ä»¶åï¼Œå°±ä¼šåœ¨ <code>MybatisMapperRegistry</code> ä¸­æ·»åŠ å¯¹åº”çš„ Mapper ä»£ç†å·¥å‚ <code>MybatisMapperProxyFactory</code>ã€‚åŒæ—¶ä½¿ç”¨ <code>MybatisMapperAnnotationBuilder</code> è§£æ mapper æ¥å£ä¸­ä½¿ç”¨æ³¨è§£å†™çš„ sql è¯­å¥ã€‚</p><p><code>MybatisMapperProxyFactory</code> å°±æ˜¯ç”¨æ¥è·å– Mapper ä»£ç†ï¼ˆ<code>MybatisMapperProxy</code>ï¼‰çš„å·¥å‚ç±»ã€‚ åœ¨è°ƒç”¨ Mapper ä¸­æ–¹æ³•çš„æ—¶å€™å…¶å®å°±æ˜¯è°ƒç”¨çš„ <code>MybatisMapperProxy#invoke</code> æ–¹æ³•ã€‚</p><mark class="hl-label blue">MybatisMapperRegistry#addMappe</mark> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// type ä¸º mapper æ¥å£</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">addMapper</span><span class="params">(Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (type.isInterface()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hasMapper(type)) &#123;</span><br><span class="line">            <span class="comment">// TODO å¦‚æœä¹‹å‰æ³¨å…¥ ç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">loadCompleted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ³¨å†Œ Mapper çš„ä»£ç†å·¥å‚</span></span><br><span class="line">            knownMappers.put(type, <span class="keyword">new</span> <span class="title class_">MybatisMapperProxyFactory</span>&lt;&gt;(type));</span><br><span class="line">            <span class="comment">// å†è§£æMapperæ¥å£ä¸­ä½¿ç”¨æ³¨è§£å†™çš„ sql è¯­å¥</span></span><br><span class="line">            <span class="type">MybatisMapperAnnotationBuilder</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisMapperAnnotationBuilder</span>(config, type);</span><br><span class="line">            <span class="comment">// é‡Œé¢ä¼šç»§ç»­è°ƒç”¨ AbstractSqlInjector#inspectInject æ³¨å…¥ mybatisPlus çš„åŠ¨æ€ curd æ–¹æ³•</span></span><br><span class="line">            parser.parse();</span><br><span class="line">            loadCompleted = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!loadCompleted) &#123;</span><br><span class="line">                knownMappers.remove(type);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="æ³¨å…¥åŠ¨æ€SQL">æ³¨å…¥åŠ¨æ€SQL</h3><p><code>MybatisMapperAnnotationBuilder</code> åœ¨è§£æå®Œæ³¨è§£ sql åï¼Œä¼šæ³¨å…¥ mybatis-plus çš„çš„ curd åŠ¨æ€ sqlã€‚å¹³æ—¶è°ƒç”¨ mybatis-plus çš„ BaseMapper çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨çš„è¿™é‡Œæ³¨å…¥çš„åŠ¨æ€ sqlã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MybatisMapperAnnotationBuilder.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">resource</span> <span class="operator">=</span> type.toString();</span><br><span class="line">    <span class="keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// éå†Mapper æ¥å£ä¸­çš„æ–¹æ³•ï¼Œè§£ææ–¹æ³•ä¸Šçš„æ³¨è§£ sqlï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰</span></span><br><span class="line">        <span class="keyword">for</span> (Method method : type.getMethods()) &#123;</span><br><span class="line">            ...</span><br><span class="line">            parseStatement(method);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// å¦‚æœç»§æ‰¿äº† baseMapperï¼Œå°±æ³¨å…¥ CURD åŠ¨æ€ SQL</span></span><br><span class="line">        <span class="keyword">if</span> (GlobalConfigUtils.isSupperMapperChildren(configuration, type)) &#123;</span><br><span class="line">            parserInjector();</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    parsePendingMethods();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å…¥åŠ¨æ€ sqlï¼Œ AbstractSqlInjector</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">parserInjector</span><span class="params">()</span> &#123;</span><br><span class="line">    GlobalConfigUtils.getSqlInjector(configuration).inspectInject(assistant, type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>abstractSqlInjector æ³¨å…¥çš„ sql é»˜è®¤ä¸º DefaultSqlInjector ä¸­çš„æ–¹æ³•ï¼ˆä¹Ÿå°±æ˜¯ BaseMapper ä¸­çš„æ–¹æ³•ï¼‰ã€‚ æ³¨å…¥çš„æ–¹å¼ä¸ºï¼šæ ¹æ®ä¸åŒæ–¹æ³•çš„æ¨¡æ¿æ„å»ºå¯¹åº”çš„ sql è„šæœ¬ï¼ˆåŒ xmlï¼‰ï¼Œå¹¶å¡«å……å¯¹åº”çš„æ•°æ®è¡¨å’Œå®ä½“ç±»çš„å­—æ®µã€‚è¿™é‡Œçš„æ•°æ®è¡¨å­—æ®µæ˜¯é€šè¿‡ <code>TableInfoHelper</code> è·å¾—å¯¹åº”å®ä½“ç±»çš„<code>TableInfo</code>ç±»æ¨æ–­å‡ºæ¥çš„ï¼Œå¦‚æ ¹æ® <code>@TableField</code>/<code>@TableId</code> æ³¨è§£æŒ‡å®šå­—æ®µåï¼Œæˆ–æ ¹æ®é©¼å³°ä¸‹åˆ’çº¿è½¬æ¢è§„åˆ™æ¨æ–­ã€‚</p><div class="tabs" id="f8f09fe7-2eec-4be1-8965-8c1be1e1c20d"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#f8f09fe7-2eec-4be1-8965-8c1be1e1c20d-1"><i class="fas fa-bug"></i>1</button></li><li class="tab"><button type="button" data-href="#f8f09fe7-2eec-4be1-8965-8c1be1e1c20d-2"><i class="fas fa-cannabis"></i>2</button></li><li class="tab"><button type="button" data-href="#f8f09fe7-2eec-4be1-8965-8c1be1e1c20d-3"><i class="fas fa-candy-cane"></i>3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="f8f09fe7-2eec-4be1-8965-8c1be1e1c20d-1"><p><mark class="hl-label blue">AbstractSqlInjector#inspectInject</mark></p><p><code>ISqlInjector</code>æ¥å£åªæœ‰ä¸€ä¸ªinspectInjectæ–¹æ³•æ¥æä¾›SQLæ³¨å…¥çš„æ“ä½œï¼Œåœ¨<code>AbstractSqlInjector</code>æŠ½è±¡ç±»æ¥æä¾›å…·ä½“çš„æ“ä½œï¼Œæœ€ç»ˆå¯¹å¤–çš„é»˜è®¤å®ç°ç±»æ˜¯<code>DefaultSqlInjector</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">inspectInject</span><span class="params">(MapperBuilderAssistant builderAssistant, Class&lt;?&gt; mapperClass)</span> &#123;</span><br><span class="line">    Class&lt;?&gt; modelClass = extractModelClass(mapperClass);</span><br><span class="line">    <span class="keyword">if</span> (modelClass != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> mapperClass.toString();</span><br><span class="line">        Set&lt;String&gt; mapperRegistryCache = GlobalConfigUtils.getMapperRegistryCache(builderAssistant.getConfiguration());</span><br><span class="line">        <span class="keyword">if</span> (!mapperRegistryCache.contains(className)) &#123;</span><br><span class="line">            <span class="comment">//è·å¾—CRUDä¸€ç³»åˆ—çš„æ“ä½œæ–¹æ³•</span></span><br><span class="line">            List&lt;AbstractMethod&gt; methodList = <span class="built_in">this</span>.getMethodList(mapperClass);<span class="comment">//-&gt;2</span></span><br><span class="line">            <span class="keyword">if</span> (CollectionUtils.isNotEmpty(methodList)) &#123;</span><br><span class="line">                <span class="comment">//å–å¾—å¯¹åº”TableEntity</span></span><br><span class="line">                <span class="type">TableInfo</span> <span class="variable">tableInfo</span> <span class="operator">=</span> TableInfoHelper.initTableInfo(builderAssistant, modelClass);</span><br><span class="line">                <span class="comment">// å¾ªç¯æ³¨å…¥è‡ªå®šä¹‰æ–¹æ³•</span></span><br><span class="line">                methodList.forEach(m -&gt; m.inject(builderAssistant, mapperClass, modelClass, tableInfo));<span class="comment">//-&gt;3</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.debug(mapperClass.toString() + <span class="string">&quot;, No effective injection method was found.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mapperRegistryCache.add(className);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f8f09fe7-2eec-4be1-8965-8c1be1e1c20d-2"><p><mark class="hl-label green">DefaultSqlInjector#getMethodList</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultSqlInjector</span> <span class="keyword">extends</span> <span class="title class_">AbstractSqlInjector</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;AbstractMethod&gt; <span class="title function_">getMethodList</span><span class="params">(Class&lt;?&gt; mapperClass, TableInfo tableInfo)</span> &#123;</span><br><span class="line">        Stream.Builder&lt;AbstractMethod&gt; builder = Stream.&lt;AbstractMethod&gt;builder()</span><br><span class="line">            .add(<span class="keyword">new</span> <span class="title class_">Insert</span>())</span><br><span class="line">            .add(<span class="keyword">new</span> <span class="title class_">Delete</span>())</span><br><span class="line">            .add(<span class="keyword">new</span> <span class="title class_">DeleteByMap</span>())</span><br><span class="line">            .add(<span class="keyword">new</span> <span class="title class_">Update</span>())</span><br><span class="line">            .add(<span class="keyword">new</span> <span class="title class_">SelectByMap</span>())</span><br><span class="line">            .add(<span class="keyword">new</span> <span class="title class_">SelectCount</span>())</span><br><span class="line">            .add(<span class="keyword">new</span> <span class="title class_">SelectMaps</span>())</span><br><span class="line">            .add(<span class="keyword">new</span> <span class="title class_">SelectMapsPage</span>())</span><br><span class="line">            .add(<span class="keyword">new</span> <span class="title class_">SelectObjs</span>())</span><br><span class="line">            .add(<span class="keyword">new</span> <span class="title class_">SelectList</span>())</span><br><span class="line">            .add(<span class="keyword">new</span> <span class="title class_">SelectPage</span>());</span><br><span class="line">        <span class="keyword">if</span> (tableInfo.havePK()) &#123;</span><br><span class="line">            builder.add(<span class="keyword">new</span> <span class="title class_">DeleteById</span>())</span><br><span class="line">                .add(<span class="keyword">new</span> <span class="title class_">DeleteBatchByIds</span>())</span><br><span class="line">                .add(<span class="keyword">new</span> <span class="title class_">UpdateById</span>())</span><br><span class="line">                .add(<span class="keyword">new</span> <span class="title class_">SelectById</span>())</span><br><span class="line">                .add(<span class="keyword">new</span> <span class="title class_">SelectBatchByIds</span>());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.warn(String.format(<span class="string">&quot;%s ,Not found @TableId annotation, Cannot use Mybatis-Plus &#x27;xxById&#x27; Method.&quot;</span>,</span><br><span class="line">                tableInfo.getEntityType()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> builder.build().collect(toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f8f09fe7-2eec-4be1-8965-8c1be1e1c20d-3"><p>ä»¥deleteByIdä¸ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeleteById</span> <span class="keyword">extends</span> <span class="title class_">AbstractMethod</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DeleteById</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(<span class="string">&quot;deleteById&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name æ–¹æ³•å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 3.5.0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DeleteById</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MappedStatement <span class="title function_">injectMappedStatement</span><span class="params">(Class&lt;?&gt; mapperClass, Class&lt;?&gt; modelClass, TableInfo tableInfo)</span> &#123;</span><br><span class="line">        String sql;</span><br><span class="line">        <span class="type">SqlMethod</span> <span class="variable">sqlMethod</span> <span class="operator">=</span> SqlMethod.LOGIC_DELETE_BY_ID;</span><br><span class="line">        <span class="keyword">if</span> (tableInfo.isWithLogicDelete()) &#123;</span><br><span class="line">            List&lt;TableFieldInfo&gt; fieldInfos = tableInfo.getFieldList().stream()</span><br><span class="line">                .filter(TableFieldInfo::isWithUpdateFill)</span><br><span class="line">                .filter(f -&gt; !f.isLogicDelete())</span><br><span class="line">                .collect(toList());</span><br><span class="line">            <span class="keyword">if</span> (CollectionUtils.isNotEmpty(fieldInfos)) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">sqlSet</span> <span class="operator">=</span> <span class="string">&quot;SET &quot;</span> + SqlScriptUtils.convertIf(fieldInfos.stream()</span><br><span class="line">                    .map(i -&gt; i.getSqlSet(EMPTY)).collect(joining(EMPTY)), <span class="string">&quot;!@org.apache.ibatis.type.SimpleTypeRegistry@isSimpleType(_parameter.getClass())&quot;</span>, <span class="literal">true</span>)</span><br><span class="line">                    + tableInfo.getLogicDeleteSql(<span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">                sql = String.format(sqlMethod.getSql(), tableInfo.getTableName(), sqlSet, tableInfo.getKeyColumn(),</span><br><span class="line">                    tableInfo.getKeyProperty(), tableInfo.getLogicDeleteSql(<span class="literal">true</span>, <span class="literal">true</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sql = String.format(sqlMethod.getSql(), tableInfo.getTableName(), sqlLogicSet(tableInfo),</span><br><span class="line">                    tableInfo.getKeyColumn(), tableInfo.getKeyProperty(),</span><br><span class="line">                    tableInfo.getLogicDeleteSql(<span class="literal">true</span>, <span class="literal">true</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">SqlSource</span> <span class="variable">sqlSource</span> <span class="operator">=</span> languageDriver.createSqlSource(configuration, sql, Object.class);</span><br><span class="line">            <span class="keyword">return</span> addUpdateMappedStatement(mapperClass, modelClass, getMethod(sqlMethod), sqlSource);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sqlMethod = SqlMethod.DELETE_BY_ID;</span><br><span class="line">            sql = String.format(sqlMethod.getSql(), tableInfo.getTableName(), tableInfo.getKeyColumn(),</span><br><span class="line">                tableInfo.getKeyProperty());</span><br><span class="line">            <span class="type">SqlSource</span> <span class="variable">sqlSource</span> <span class="operator">=</span> languageDriver.createSqlSource(configuration, sql, Object.class);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.addDeleteMappedStatement(mapperClass, getMethod(sqlMethod), sqlSource);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="SqlSessionTemplate">SqlSessionTemplate</h2><p><code>SqlSessionTemplate</code> å®ç°äº† <code>SqlSession</code> æ¥å£ï¼Œä½†æ˜¯å†…éƒ¨æŒæœ‰ä¸€ä¸ª sqlSessionProxy ä»£ç†å¯¹è±¡ï¼Œæœ€åéƒ½æ˜¯è°ƒç”¨çš„ä»£ç†å¯¹è±¡çš„æ–¹æ³•ã€‚ è€Œä»£ç†å¯¹è±¡ä¸­æœ€ç»ˆè°ƒç”¨çš„ sqlSession ä¹Ÿæ˜¯é€šè¿‡ <code>sqlSessionFactory.openSession</code> æ¥è·å–çš„ã€‚åªä¸è¿‡åœ¨ openSession å‰ä¼šä» spring äº‹åŠ¡åŒæ­¥ç®¡ç†å™¨ä¸­è·å–ä¸€éï¼Œä¸å­˜åœ¨æ‰åˆ›å»ºä¸€ä¸ªæ–°çš„ sqlSessionï¼Œå¹¶ä¸”å†æ‰§è¡Œå®Œæˆåå…³é—­æˆ–é‡Šæ”¾ï¼ˆå¼•ç”¨æ•°é‡-1ï¼‰ã€‚</p><p>è¿™æ ·å°±å¯ä»¥åœ¨éœ€è¦ä½¿ç”¨ sqlSession æ—¶ç›´æ¥ä½¿ç”¨ sqlSessionTemplateï¼Œè€Œä¸æ˜¯éœ€è¦æ¯æ¬¡éƒ½é€šè¿‡ sqlSessinFactory è·å– sqlSessionï¼Œä¹Ÿä¸éœ€è¦è€ƒè™‘ sqlSesion çš„å…³é—­ã€‚åŒæ—¶ä¿è¯äº†åœ¨åŒä¸€ä¸ª spring äº‹åŠ¡ä¸­ä½¿ç”¨åŒä¸€ä¸ª sqlSession å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlSessionTemplate</span> <span class="keyword">implements</span> <span class="title class_">SqlSession</span>, DisposableBean &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlSessionTemplate</span><span class="params">(SqlSessionFactory sqlSessionFactory, ExecutorType executorType,</span></span><br><span class="line"><span class="params">          PersistenceExceptionTranslator exceptionTranslator)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="built_in">this</span>.sqlSessionFactory = sqlSessionFactory;</span><br><span class="line">        <span class="built_in">this</span>.executorType = executorType;</span><br><span class="line">        <span class="built_in">this</span>.exceptionTranslator = exceptionTranslator;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ª sqlSession çš„ä»£ç†ï¼Œ å®ç°ä¸ºä¸€ä¸ªå†…éƒ¨ç±»</span></span><br><span class="line">        <span class="built_in">this</span>.sqlSessionProxy = (SqlSession) newProxyInstance(SqlSessionFactory.class.getClassLoader(),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; SqlSession.class &#125;, <span class="keyword">new</span> <span class="title class_">SqlSessionInterceptor</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ•°æ®åº“çš„ç›¸å…³æ“ä½œå‡ç”±ä»£ç†å¯¹è±¡å®ç°, ä½†æ˜¯ä¸æ”¯æŒ commitï¼Œå› ä¸ºä»£ç†å¯¹è±¡ä¸­æˆ·å®ç°</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">selectOne</span><span class="params">(String statement)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.sqlSessionProxy.selectOne(statement);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‰é¢æåˆ°çš„ getMapper æ–¹æ³•ï¼Œæœ€ç»ˆåˆ° Configuration ä¸­è·å–</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getMapper</span><span class="params">(Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getConfiguration().getMapper(type, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * sqlSession çš„ä»£ç†å®ç°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">SqlSessionInterceptor</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// è·å–çœŸæ­£çš„ sqlSessionï¼Œé€»è¾‘å‚è€ƒï¼šSqlSessionUtils#getSqlSessionï¼‰ </span></span><br><span class="line">      <span class="comment">//    ä» spring çš„ TransactionSynchronizationManager äº‹åŠ¡åŒæ­¥ç®¡ç†å™¨ (ä¸­çš„ threadlocal) è·å– sqlSession</span></span><br><span class="line">      <span class="comment">//    ä¸å­˜åœ¨åˆ™é€šè¿‡ sqlSessionFactory.openSession åˆ›å»ºæ–°çš„ sqlSession å¯¹è±¡ï¼Œå¹¶ä¿å­˜åˆ° spring ä¸­</span></span><br><span class="line">      </span><br><span class="line">      <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> getSqlSession(SqlSessionTemplate.<span class="built_in">this</span>.sqlSessionFactory,</span><br><span class="line">          SqlSessionTemplate.<span class="built_in">this</span>.executorType, SqlSessionTemplate.<span class="built_in">this</span>.exceptionTranslator);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨ sqlSession æ‰§è¡Œå¯¹åº”æ–¹æ³•</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(sqlSession, args);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="comment">// unwrapThrowable</span></span><br><span class="line">        <span class="comment">// SqlSessionUtils.closeSqlSession</span></span><br><span class="line">        <span class="keyword">throw</span> unwrapped;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//  å¦‚æœæ˜¯ spring ç®¡ç†çš„åˆ™ releaseï¼ˆå¼•ç”¨æ•°é‡-1ï¼‰ï¼Œ ä¸æ˜¯åˆ™ close</span></span><br><span class="line">        <span class="comment">// SqlSessionUtils.closeSqlSession</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="è·å–-Mapper-å¯¹è±¡">è·å– Mapper å¯¹è±¡</h2><p>å‰é¢æˆ‘ä»¬æåˆ°ï¼Œå°†æ‰«æåˆ°çš„Mapperæ¥å£å°†å…¶ beanDefinition.beanClass ä¿®æ”¹ä¸º <code>MapperFactoryBean</code>ã€‚ æ‰€ä»¥åœ¨åç»­ spring å°† mapper beanåˆå§‹åŒ–æ—¶ï¼Œä¼šé€šè¿‡è°ƒç”¨ <code>MapperFactoryBean#getObject</code> è·å–å…¶å¯¹è±¡æ³¨å…¥åˆ°Springå®¹å™¨ä¸­ã€‚</p><p>æœ€ç»ˆçš„è°ƒç”¨é“¾å°±æ˜¯</p><p><code>MapperFactoryBean#getObject</code>-&gt;<code>SqlSessionTemplate#getMapper</code>-&gt;<code>configuration#getMapper</code>-&gt;<code>MybatisMapperRegistry#getMapper</code> -&gt;<code>MybatisMapperProxyFactory#newInstance</code></p><p>å‰é¢è§£æ mapper æ—¶æåˆ°äº† <code>MybatisMapperRegistry</code> æä¾›äº†ä¸€ä¸ª getMapper æ–¹æ³•ç”¨æ¥è·å– mapper ä»£ç†å¯¹è±¡ã€‚</p><p>åœ¨è¿™ä¸ª getMapper æ–¹æ³•ä¸­ä¹‹å‰æ³¨å†Œçš„ä»£ç†å·¥å‚ <code>MybatisMapperProxyFactory</code> ä½¿ç”¨ é€šè¿‡ <code>MybatisMapperProxy</code> ç”Ÿæˆäº† mapper çš„ä»£ç†å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sqlSessionTempalte</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getMapper</span><span class="params">(Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getConfiguration().getMapper(type, <span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MybatisConfiguration </span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getMapper</span><span class="params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mybatisMapperRegistry.getMapper(type, sqlSession);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MybatisMapperRegistry </span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getMapper</span><span class="params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> &#123;</span><br><span class="line">    <span class="comment">// knownMappers ä¸ºå‰é¢è§£æ mapper åæ³¨å†Œçš„ mapper ä»£ç†å·¥å‚å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">final</span> MybatisMapperProxyFactory&lt;T&gt; mapperProxyFactory = (MybatisMapperProxyFactory&lt;T&gt;) knownMappers.get(type);</span><br><span class="line">    <span class="keyword">if</span> (mapperProxyFactory == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindingException</span>(<span class="string">&quot;Type &quot;</span> + type + <span class="string">&quot; is not known to the MybatisPlusMapperRegistry.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ä¼ å…¥ sqlSession åˆ›å»ºä»£ç†å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> mapperProxyFactory.newInstance(sqlSession);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindingException</span>(<span class="string">&quot;Error getting mapper instance. Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// MybatisMapperProxyFactory</span></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">newInstance</span><span class="params">(SqlSession sqlSession)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> MybatisMapperProxy&lt;T&gt; mapperProxy = <span class="keyword">new</span> <span class="title class_">MybatisMapperProxy</span>&lt;&gt;(sqlSession, mapperInterface, methodCache);</span><br><span class="line">    <span class="keyword">return</span> newInstance(mapperProxy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è°ƒç”¨æ–¹æ³•</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®ç°InvocationHandleræ¥å£çš„invokeæ–¹æ³•ï¼Œç”¨äºä»£ç†æ–¹æ³•çš„è°ƒç”¨</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> proxy ä»£ç†å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> method è¢«ä»£ç†çš„æ–¹æ³•</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> args æ–¹æ³•å‚æ•°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Throwable</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Object è¿”å›æ–¹æ³•è°ƒç”¨ç»“æœ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœè°ƒç”¨çš„æ˜¯Objectç±»çš„æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨è¢«ä»£ç†å¯¹è±¡çš„å¯¹åº”æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">            <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦åˆ™ç¼“å­˜è·å–æ–¹æ³•è°ƒç”¨å™¨ï¼Œä½¿ç”¨æ–¹æ³•è°ƒç”¨å™¨è°ƒç”¨æ–¹æ³•</span></span><br><span class="line">            <span class="keyword">return</span> cachedInvoker(method).invoke(proxy, method, args, sqlSession);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“">æ€»ç»“</h2><p>mybatisPlus çš„æ•´ä¸ªåŠ è½½è¿‡ç¨‹æ¦‚æ‹¬å¦‚ä¸‹ï¼š</p><ol><li><code>MapperScannerConfigurer</code> æ‰«æ mapper æ¥å£ï¼Œå¹¶åœ¨ spring ä¸­æ³¨å†Œ beanDefinitionï¼Œç±»å‹ä¸º <code>MapperFactoryBean</code></li><li><code>SqlSessionFactory</code> è§£æ mapper.xml å’Œ mapper æ¥å£ ä¸­çš„ sql è¯­å¥ä¿å­˜åˆ° Configuration ä¸­ï¼ŒåŒæ—¶åŠ å…¥ MybatisPlus æä¾›çš„åŠ¨æ€ sqlã€‚ æœ€ååœ¨ Configuration æ³¨å†Œ mapper çš„ <code>MybatisMapperProxyFactory</code>ã€‚</li><li><code>SqlSessionTemplate</code> ä½¿ç”¨ <code>SqlSessionInterceptor</code> ä»£ç†å®ç°ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ spring ç®¡ç†çš„ SqlSessionï¼Œå¹¶æœ€ç»ˆé€šè¿‡ <code>MybatisMapperProxyFactory</code> è·å– mapper çš„ä»£ç†å¯¹è±¡ <code>MybatisMapperProxy</code>.</li></ol>]]></content>
    
    
    <summary type="html">MyBatisPlusåŸç†è§£æ</summary>
    
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="MyBatisPlus" scheme="https://wuwawawa.github.io/tags/MyBatisPlus/"/>
    
  </entry>
  
  <entry>
    <title>MyBatisPlus</title>
    <link href="https://wuwawawa.github.io/posts/8086094.html"/>
    <id>https://wuwawawa.github.io/posts/8086094.html</id>
    <published>2023-06-01T00:52:30.000Z</published>
    <updated>2023-06-01T15:02:03.362Z</updated>
    
    <content type="html"><![CDATA[<h2 id="MyBatisPlusç®€ä»‹">MyBatisPlusç®€ä»‹</h2><p>MyBatis-Plusï¼ˆç®€ç§° MPï¼‰æ˜¯ä¸€ä¸ª MyBatisçš„å¢å¼ºå·¥å…·ï¼Œåœ¨ MyBatis çš„åŸºç¡€ä¸Šåªåšå¢å¼ºä¸åšæ”¹å˜ï¼Œä¸ºç®€åŒ–å¼€å‘ã€æé«˜æ•ˆç‡è€Œç”Ÿã€‚</p><div class="tabs" id="b9764d6e-cd05-4c3b-ae17-8b448107dcb9"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#b9764d6e-cd05-4c3b-ae17-8b448107dcb9-1"><i class="fas fa-seedling"></i>ç‰¹æ€§</button></li><li class="tab"><button type="button" data-href="#b9764d6e-cd05-4c3b-ae17-8b448107dcb9-2"><i class="fas fa-leaf"></i>æ”¯æŒæ•°æ®åº“</button></li><li class="tab"><button type="button" data-href="#b9764d6e-cd05-4c3b-ae17-8b448107dcb9-3"><i class="fab fa-apple"></i>æ¡†æ¶ç»“æ„</button></li><li class="tab"><button type="button" data-href="#b9764d6e-cd05-4c3b-ae17-8b448107dcb9-4"><i class="fas fa-tree"></i>ä»£ç åŠæ–‡æ¡£åœ°å€</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="b9764d6e-cd05-4c3b-ae17-8b448107dcb9-1"><ul><li>æ— ä¾µå…¥ï¼šåªåšå¢å¼ºä¸åšæ”¹å˜ï¼Œå¼•å…¥å®ƒä¸ä¼šå¯¹ç°æœ‰å·¥ç¨‹äº§ç”Ÿå½±å“ï¼Œå¦‚ä¸èˆ¬é¡ºæ»‘</li><li>æŸè€—å°ï¼šå¯åŠ¨å³ä¼šè‡ªåŠ¨æ³¨å…¥åŸºæœ¬ CURDï¼Œæ€§èƒ½åŸºæœ¬æ— æŸè€—ï¼Œç›´æ¥é¢å‘å¯¹è±¡æ“ä½œ</li><li>å¼ºå¤§çš„ CRUD æ“ä½œï¼šå†…ç½®é€šç”¨ Mapperã€é€šç”¨ Serviceï¼Œä»…ä»…é€šè¿‡å°‘é‡é…ç½®å³å¯å®ç°å•è¡¨å¤§éƒ¨åˆ†CRUD æ“ä½œï¼Œæ›´æœ‰å¼ºå¤§çš„æ¡ä»¶æ„é€ å™¨ï¼Œæ»¡è¶³å„ç±»ä½¿ç”¨éœ€æ±‚</li><li>æ”¯æŒ Lambda å½¢å¼è°ƒç”¨ï¼šé€šè¿‡ Lambda è¡¨è¾¾å¼ï¼Œæ–¹ä¾¿çš„ç¼–å†™å„ç±»æŸ¥è¯¢æ¡ä»¶ï¼Œæ— éœ€å†æ‹…å¿ƒå­—æ®µå†™é”™</li><li>æ”¯æŒä¸»é”®è‡ªåŠ¨ç”Ÿæˆï¼šæ”¯æŒå¤šè¾¾ 4 ç§ä¸»é”®ç­–ç•¥ï¼ˆå†…å«åˆ†å¸ƒå¼å”¯ä¸€ ID ç”Ÿæˆå™¨ - Sequenceï¼‰ï¼Œå¯è‡ªç”±é…ç½®ï¼Œå®Œç¾è§£å†³ä¸»é”®é—®é¢˜</li><li>æ”¯æŒ ActiveRecord æ¨¡å¼ï¼šæ”¯æŒ ActiveRecord å½¢å¼è°ƒç”¨ï¼Œå®ä½“ç±»åªéœ€ç»§æ‰¿ Model ç±»å³å¯è¿›è¡Œå¼ºå¤§çš„ CRUD æ“ä½œ</li><li>æ”¯æŒè‡ªå®šä¹‰å…¨å±€é€šç”¨æ“ä½œï¼šæ”¯æŒå…¨å±€é€šç”¨æ–¹æ³•æ³¨å…¥ï¼ˆ Write once, use anywhere ï¼‰</li><li>å†…ç½®ä»£ç ç”Ÿæˆå™¨ï¼šé‡‡ç”¨ä»£ç æˆ–è€… Maven æ’ä»¶å¯å¿«é€Ÿç”Ÿæˆ Mapper ã€ Model ã€ Service ã€Controller å±‚ä»£ç ï¼Œæ”¯æŒæ¨¡æ¿å¼•æ“ï¼Œæ›´æœ‰è¶…å¤šè‡ªå®šä¹‰é…ç½®ç­‰æ‚¨æ¥ä½¿ç”¨</li><li>å†…ç½®åˆ†é¡µæ’ä»¶ï¼šåŸºäº MyBatis ç‰©ç†åˆ†é¡µï¼Œå¼€å‘è€…æ— éœ€å…³å¿ƒå…·ä½“æ“ä½œï¼Œé…ç½®å¥½æ’ä»¶ä¹‹åï¼Œå†™åˆ†é¡µç­‰åŒäºæ™®é€š List æŸ¥è¯¢</li><li>åˆ†é¡µæ’ä»¶æ”¯æŒå¤šç§æ•°æ®åº“ï¼šæ”¯æŒ MySQLã€MariaDBã€Oracleã€DB2ã€H2ã€HSQLã€SQLiteã€Postgreã€SQLServer ç­‰å¤šç§æ•°æ®åº“</li><li>å†…ç½®æ€§èƒ½åˆ†ææ’ä»¶ï¼šå¯è¾“å‡º SQL è¯­å¥ä»¥åŠå…¶æ‰§è¡Œæ—¶é—´ï¼Œå»ºè®®å¼€å‘æµ‹è¯•æ—¶å¯ç”¨è¯¥åŠŸèƒ½ï¼Œèƒ½å¿«é€Ÿæªå‡ºæ…¢æŸ¥è¯¢</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b9764d6e-cd05-4c3b-ae17-8b448107dcb9-2"><p>ä»»ä½•èƒ½ä½¿ç”¨MyBatisè¿›è¡Œ CRUD, å¹¶ä¸”æ”¯æŒæ ‡å‡† SQL çš„æ•°æ®åº“ï¼Œå…·ä½“æ”¯æŒæƒ…å†µå¦‚ä¸‹</p><p>MySQLï¼ŒOracleï¼ŒDB2ï¼ŒH2ï¼ŒHSQLï¼ŒSQLiteï¼ŒPostgreSQLï¼ŒSQLServerï¼ŒPhoenixï¼ŒGauss ï¼ŒClickHouseï¼ŒSybaseï¼ŒOceanBaseï¼ŒFirebirdï¼ŒCubridï¼ŒGoldilocksï¼Œcsiidbè¾¾æ¢¦æ•°æ®åº“ï¼Œè™šè°·æ•°æ®åº“ï¼Œäººå¤§é‡‘ä»“æ•°æ®åº“ï¼Œå—å¤§é€šç”¨(ååº“)æ•°æ®åº“ï¼Œå—å¤§é€šç”¨æ•°æ®åº“ï¼Œç¥é€šæ•°æ®åº“ï¼Œç€šé«˜æ•°æ®åº“</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b9764d6e-cd05-4c3b-ae17-8b448107dcb9-3"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230601091718513.png" alt="image-20230601091718513" style="zoom: 50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b9764d6e-cd05-4c3b-ae17-8b448107dcb9-4"><p>å®˜æ–¹åœ°å€:<a href="http://mp.baomidou.com">http://mp.baomidou.com</a></p><p>ä»£ç å‘å¸ƒåœ°å€:Github: <a href="https://github.com/baomidou/mybatis-plus">https://github.com/baomidou/mybatis-plus</a></p><p>Gitee: <a href="https://gitee.com/baomidou/mybatis-plus">https://gitee.com/baomidou/mybatis-plus</a></p><p>æ–‡æ¡£å‘å¸ƒåœ°å€:<a href="https://baomidou.com/pages/24112f">https://baomidou.com/pages/24112f</a></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="å…¥é—¨æ¡ˆä¾‹">å…¥é—¨æ¡ˆä¾‹</h2><p>ä»¥SpringBootæ•´åˆMyBatisPlusä¸ºä¾‹</p><div class="tabs" id="ed892188-277b-4746-87a0-c2638332eeb0"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ed892188-277b-4746-87a0-c2638332eeb0-1"><i class="fas fa-seedling"></i>åˆ›å»ºæ•°æ®åº“åŠè¡¨</button></li><li class="tab"><button type="button" data-href="#ed892188-277b-4746-87a0-c2638332eeb0-2"><i class="fas fa-leaf"></i>æ·»åŠ ä¾èµ–</button></li><li class="tab"><button type="button" data-href="#ed892188-277b-4746-87a0-c2638332eeb0-3"><i class="fab fa-apple"></i>é…ç½®æ–‡ä»¶</button></li><li class="tab"><button type="button" data-href="#ed892188-277b-4746-87a0-c2638332eeb0-4"><i class="fas fa-tree"></i>å¯åŠ¨ç±»</button></li><li class="tab"><button type="button" data-href="#ed892188-277b-4746-87a0-c2638332eeb0-5"><i class="fas fa-heartbeat"></i>æ·»åŠ å®ä½“</button></li><li class="tab"><button type="button" data-href="#ed892188-277b-4746-87a0-c2638332eeb0-6"><i class="fas fa-cookie-bite"></i>æ·»åŠ mapper</button></li><li class="tab"><button type="button" data-href="#ed892188-277b-4746-87a0-c2638332eeb0-7"><i class="fas fa-bug"></i>æµ‹è¯•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ed892188-277b-4746-87a0-c2638332eeb0-1"><p><mark class="hl-label blue">åˆ›å»ºè¡¨</mark></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE mybatis_plus;</span><br><span class="line">use mybatis_plus;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">user</span> (</span><br><span class="line">id <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ä¸»é”®ID&#x27;</span>,</span><br><span class="line">name <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;å§“å&#x27;</span>,</span><br><span class="line">age <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;å¹´é¾„&#x27;</span>,</span><br><span class="line">  email <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;é‚®ç®±&#x27;</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (id)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure><p><mark class="hl-label green">æ·»åŠ æ•°æ®</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO <span class="title function_">user</span> <span class="params">(id, name, age, email)</span> VALUES</span><br><span class="line">(<span class="number">1</span>, <span class="string">&#x27;Jone&#x27;</span>, <span class="number">18</span>, <span class="string">&#x27;test1@baomidou.com&#x27;</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">&#x27;Jack&#x27;</span>, <span class="number">20</span>, <span class="string">&#x27;test2@baomidou.com&#x27;</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">&#x27;Tom&#x27;</span>, <span class="number">28</span>, <span class="string">&#x27;test3@baomidou.com&#x27;</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">&#x27;Sandy&#x27;</span>, <span class="number">21</span>, <span class="string">&#x27;test4@baomidou.com&#x27;</span>),</span><br><span class="line">(<span class="number">5</span>, <span class="string">&#x27;Billie&#x27;</span>, <span class="number">24</span>, <span class="string">&#x27;test5@baomidou.com&#x27;</span>);</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ed892188-277b-4746-87a0-c2638332eeb0-2"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--mybatis-pluså¯åŠ¨å™¨--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--lombokç”¨äºç®€åŒ–å®ä½“ç±»å¼€å‘--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--mysqlé©±åŠ¨--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ed892188-277b-4746-87a0-c2638332eeb0-3"><p>é…ç½®application.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># é…ç½®æ•°æ®æºä¿¡æ¯</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="comment"># é…ç½®æ•°æ®æºç±»å‹</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line">    <span class="comment"># é…ç½®è¿æ¥æ•°æ®åº“çš„å„ä¸ªä¿¡æ¯</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://8.130.68.59:3306/mybatis_plus?serverTimezone=GMT%2B8&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line"><span class="comment"># é…ç½®MyBatisæ—¥å¿—</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„</p></blockquote><p>1ã€é©±åŠ¨ç±»driver-class-name</p><p>spring boot 2.0ï¼ˆå†…ç½®jdbc5é©±åŠ¨ï¼‰ï¼Œé©±åŠ¨ç±»ä½¿ç”¨ï¼š<code>driver-class-name: com.mysql.jdbc.Driver</code></p><p>spring boot 2.1åŠä»¥ä¸Šï¼ˆå†…ç½®jdbc8é©±åŠ¨ï¼‰ï¼Œé©±åŠ¨ç±»ä½¿ç”¨ï¼š<code>driver-class-name: com.mysql.cj.jdbc.Driver</code></p><p>å¦åˆ™è¿è¡Œæµ‹è¯•ç”¨ä¾‹çš„æ—¶å€™ä¼šæœ‰ WARN ä¿¡æ¯</p><p>2ã€è¿æ¥åœ°å€url</p><p>MySQL5.7ç‰ˆæœ¬çš„urlï¼šjdbc:mysql://localhost:3306/mybatis_plus?characterEncoding=utf-8&amp;useSSL=false</p><p>MySQL8.0ç‰ˆæœ¬çš„urlï¼šjdbc:mysql://localhost:3306/mybatis_plus?serverTimezone=GMT%2B8&amp;characterEncoding=utf-8&amp;useSSL=false</p><p>å¦åˆ™è¿è¡Œæµ‹è¯•ç”¨ä¾‹æŠ¥å‘Šå¦‚ä¸‹é”™è¯¯ï¼šjava.sql.SQLException: The server time zone value â€˜Ã–ÃÂ¹ÃºÂ±ÃªÃ—Â¼ÃŠÂ±Â¼Ã¤â€™ is unrecognized orrepresents more</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ed892188-277b-4746-87a0-c2638332eeb0-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.atguigu.mybatisplus.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisplusApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(MybatisplusApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ed892188-277b-4746-87a0-c2638332eeb0-5"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ed892188-277b-4746-87a0-c2638332eeb0-6"><p>BaseMapperæ˜¯MyBatis-Plusæä¾›çš„æ¨¡æ¿mapperï¼Œå…¶ä¸­åŒ…å«äº†åŸºæœ¬çš„CRUDæ–¹æ³•ï¼Œæ³›å‹ä¸ºæ“ä½œçš„å®ä½“ç±»å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ed892188-277b-4746-87a0-c2638332eeb0-7"><p>IDEAåœ¨ userMapper å¤„æŠ¥é”™ï¼Œå› ä¸ºæ‰¾ä¸åˆ°æ³¨å…¥çš„å¯¹è±¡ï¼Œå› ä¸ºç±»æ˜¯åŠ¨æ€åˆ›å»ºçš„ï¼Œä½†æ˜¯ç¨‹åºå¯ä»¥æ­£ç¡®çš„æ‰§è¡Œã€‚ä¸ºäº†é¿å…æŠ¥é”™ï¼Œå¯ä»¥åœ¨mapperæ¥å£ä¸Šæ·»åŠ  @Repository æ³¨è§£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBatisPlusTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSelectList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//é€šè¿‡æ¡ä»¶æ„é€ å™¨æŸ¥è¯¢ä¸€ä¸ªlisté›†åˆï¼Œè‹¥æ²¡æœ‰æ¡ä»¶ï¼Œåˆ™å¯ä»¥è®¾ç½®nullä¸ºå‚æ•°</span></span><br><span class="line">        List&lt;User&gt; list = userMapper.selectList(<span class="literal">null</span>);</span><br><span class="line">        list.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="åŸºæœ¬CRUD">åŸºæœ¬CRUD</h2><h3 id="BaseMapper">BaseMapper</h3><p>MyBatis-Plusä¸­çš„åŸºæœ¬CRUDåœ¨å†…ç½®çš„BaseMapperä¸­éƒ½å·²å¾—åˆ°äº†å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæ¥å£å¦‚ä¸‹ï¼š</p><p>é€šè¿‡è§‚å¯ŸBaseMapperä¸­çš„æ–¹æ³•ï¼Œå¤§å¤šæ–¹æ³•ä¸­éƒ½æœ‰Wrapperç±»å‹çš„å½¢å‚ï¼Œæ­¤ä¸ºæ¡ä»¶æ„é€ å™¨ï¼Œå¯é’ˆå¯¹äºSQLè¯­å¥è®¾ç½®ä¸åŒçš„æ¡ä»¶ï¼Œè‹¥æ²¡æœ‰æ¡ä»¶ï¼Œåˆ™å¯ä»¥ä¸ºè¯¥å½¢å‚èµ‹å€¼nullï¼Œå³æŸ¥è¯¢ï¼ˆåˆ é™¤/ä¿®æ”¹ï¼‰æ‰€æœ‰æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Mapper ç»§æ‰¿è¯¥æ¥å£åï¼Œæ— éœ€ç¼–å†™ mapper.xml æ–‡ä»¶ï¼Œå³å¯è·å¾—CRUDåŠŸèƒ½</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BaseMapper</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">Mapper</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ’å…¥ä¸€æ¡è®°å½•</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insert</span><span class="params">(T entity)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ® ID åˆ é™¤</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">deleteById</span><span class="params">(Serializable id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®å®ä½“(ID)åˆ é™¤</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">deleteById</span><span class="params">(T entity)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ® columnMap æ¡ä»¶ï¼Œåˆ é™¤è®°å½•</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">deleteByMap</span><span class="params">(<span class="meta">@Param(Constants.COLUMN_MAP)</span> Map&lt;String, Object&gt; columnMap)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ® entity æ¡ä»¶ï¼Œåˆ é™¤è®°å½•</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">delete</span><span class="params">(<span class="meta">@Param(Constants.WRAPPER)</span> Wrapper&lt;T&gt; queryWrapper)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ é™¤ï¼ˆæ ¹æ®IDæˆ–å®ä½“ æ‰¹é‡åˆ é™¤ï¼‰</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">deleteBatchIds</span><span class="params">(<span class="meta">@Param(Constants.COLLECTION)</span> Collection&lt;?&gt; idList)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ® ID ä¿®æ”¹</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">updateById</span><span class="params">(<span class="meta">@Param(Constants.ENTITY)</span> T entity)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ® whereEntity æ¡ä»¶ï¼Œæ›´æ–°è®°å½•</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">update</span><span class="params">(<span class="meta">@Param(Constants.ENTITY)</span> T entity, <span class="meta">@Param(Constants.WRAPPER)</span> Wrapper&lt;T&gt; updateWrapper)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ® ID æŸ¥è¯¢</span></span><br><span class="line">    T <span class="title function_">selectById</span><span class="params">(Serializable id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æŸ¥è¯¢ï¼ˆæ ¹æ®ID æ‰¹é‡æŸ¥è¯¢ï¼‰</span></span><br><span class="line">    List&lt;T&gt; <span class="title function_">selectBatchIds</span><span class="params">(<span class="meta">@Param(Constants.COLLECTION)</span> Collection&lt;? extends Serializable&gt; idList)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æŸ¥è¯¢ï¼ˆæ ¹æ® columnMap æ¡ä»¶ï¼‰</span></span><br><span class="line">    List&lt;T&gt; <span class="title function_">selectByMap</span><span class="params">(<span class="meta">@Param(Constants.COLUMN_MAP)</span> Map&lt;String, Object&gt; columnMap)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ® entity æ¡ä»¶ï¼ŒæŸ¥è¯¢ä¸€æ¡è®°å½•</span></span><br><span class="line">    <span class="keyword">default</span> T <span class="title function_">selectOne</span><span class="params">(<span class="meta">@Param(Constants.WRAPPER)</span> Wrapper&lt;T&gt; queryWrapper)</span> &#123;</span><br><span class="line">        List&lt;T&gt; ts = <span class="built_in">this</span>.selectList(queryWrapper);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(ts)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ts.size() != <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ExceptionUtils.mpe(<span class="string">&quot;One record is expected, but the query result is multiple records&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ts.get(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ® Wrapper æ¡ä»¶ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨è®°å½•</span></span><br><span class="line">    <span class="keyword">default</span> <span class="type">boolean</span> <span class="title function_">exists</span><span class="params">(Wrapper&lt;T&gt; queryWrapper)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> <span class="built_in">this</span>.selectCount(queryWrapper);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span> != count &amp;&amp; count &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ® Wrapper æ¡ä»¶ï¼ŒæŸ¥è¯¢æ€»è®°å½•æ•°</span></span><br><span class="line">    Long <span class="title function_">selectCount</span><span class="params">(<span class="meta">@Param(Constants.WRAPPER)</span> Wrapper&lt;T&gt; queryWrapper)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ® entity æ¡ä»¶ï¼ŒæŸ¥è¯¢å…¨éƒ¨è®°å½•</span></span><br><span class="line">    List&lt;T&gt; <span class="title function_">selectList</span><span class="params">(<span class="meta">@Param(Constants.WRAPPER)</span> Wrapper&lt;T&gt; queryWrapper)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ® Wrapper æ¡ä»¶ï¼ŒæŸ¥è¯¢å…¨éƒ¨è®°å½•</span></span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">selectMaps</span><span class="params">(<span class="meta">@Param(Constants.WRAPPER)</span> Wrapper&lt;T&gt; queryWrapper)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ® Wrapper æ¡ä»¶ï¼ŒæŸ¥è¯¢å…¨éƒ¨è®°å½•</span></span><br><span class="line">    List&lt;Object&gt; <span class="title function_">selectObjs</span><span class="params">(<span class="meta">@Param(Constants.WRAPPER)</span> Wrapper&lt;T&gt; queryWrapper)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ® entity æ¡ä»¶ï¼ŒæŸ¥è¯¢å…¨éƒ¨è®°å½•ï¼ˆå¹¶ç¿»é¡µï¼‰</span></span><br><span class="line">    &lt;P <span class="keyword">extends</span> <span class="title class_">IPage</span>&lt;T&gt;&gt; P <span class="title function_">selectPage</span><span class="params">(P page, <span class="meta">@Param(Constants.WRAPPER)</span> Wrapper&lt;T&gt; queryWrapper)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ® Wrapper æ¡ä»¶ï¼ŒæŸ¥è¯¢å…¨éƒ¨è®°å½•ï¼ˆå¹¶ç¿»é¡µï¼‰</span></span><br><span class="line">    &lt;P <span class="keyword">extends</span> <span class="title class_">IPage</span>&lt;Map&lt;String, Object&gt;&gt;&gt; P <span class="title function_">selectMapsPage</span><span class="params">(P page, <span class="meta">@Param(Constants.WRAPPER)</span> Wrapper&lt;T&gt; queryWrapper)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="æ’å…¥">æ’å…¥</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testInsert</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//å®ç°æ–°å¢ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="literal">null</span>,<span class="string">&quot;å¼ ä¸‰&quot;</span>,<span class="number">23</span>,<span class="string">&quot;zhangsan@atguigu.com&quot;</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> userMapper.insert(user);</span><br><span class="line">    System.out.println(<span class="string">&quot;result:&quot;</span>+result);</span><br><span class="line">    System.out.println(<span class="string">&quot;id:&quot;</span>+user.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæ‰§è¡Œçš„ç»“æœï¼Œæ‰€è·å–çš„idä¸º1475754982694199298</p><p>è¿™æ˜¯å› ä¸ºï¼Œæˆ‘ä»¬æ²¡æœ‰ç»™æ•°æ®åº“idå­—æ®µè®¾ç½®è‡ªå¢ï¼Œå¹¶ä¸”MyBatis-Plusåœ¨å®ç°æ’å…¥æ•°æ®æ—¶ï¼Œä¼šé»˜è®¤åŸºäºé›ªèŠ±ç®—æ³•çš„ç­–ç•¥ç”Ÿæˆidã€‚</p><p>åœ¨MyBatisPluså‘æ•°æ®åº“è¡¨ä¸­æ’å…¥æ•°æ®çš„æ—¶å€™</p><p>å¦‚æœä¸»é”®ä¸ºid,å¹¶ä¸”åœ¨æ•°æ®åº“çš„è¡¨ä¸­å·²ç»è®¾ç½®äº†idä¸ºè‡ªå¢åˆ—ï¼Œå¦‚æœåœ¨javaå®ä½“çš„å¯¹åº”å±æ€§ä¸Šé¢å·²ç»å†™äº†<code>@Tableld(value=â€œidâ€,type=IdType.Auto)</code>æ³¨è§£ï¼Œé‚£ä¹ˆæ’å…¥æ•°æ®çš„æ—¶å€™å¯ä»¥ä¸å†™idçš„å€¼ï¼Œç¨‹åºä¼šæŒ‰ç…§è‡ªå¢è§„åˆ™ç»™idè¡¥ä¸€ä¸ªå€¼æ’å…¥æ•°æ®åº“ã€‚</p><p>ä½†æ˜¯å¦‚æœæ²¡åœ¨javaå®ä½“çš„idå±æ€§ä¸Šå†™ä¸Šæ³¨è§£<code>@TableId(value=â€œidâ€,type=IdType.Auto)</code>ï¼Œé‚£ä¹ˆæ’å…¥çš„æ—¶å€™è™½ç„¶ä¹Ÿä¼šç»™idè¡¥ä¸€ä¸ªå€¼ï¼Œä½†æ˜¯å´ä¸æ˜¯æŒ‰ç…§è‡ªå¢çš„è§„åˆ™è€Œæ˜¯æŒ‰ç…§é›ªèŠ±ç®—æ³•çš„è§„åˆ™ã€‚</p><hr><h3 id="åˆ é™¤">åˆ é™¤</h3><div class="tabs" id="90690d89-b991-4c45-804d-9388f76e105c"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#90690d89-b991-4c45-804d-9388f76e105c-1"><i class="fas fa-cat"></i>é€šè¿‡idåˆ é™¤è®°å½•</button></li><li class="tab"><button type="button" data-href="#90690d89-b991-4c45-804d-9388f76e105c-2"><i class="fas fa-horse"></i>é€šè¿‡idæ‰¹é‡åˆ é™¤è®°å½•</button></li><li class="tab"><button type="button" data-href="#90690d89-b991-4c45-804d-9388f76e105c-3"><i class="fas fa-dove"></i>é€šè¿‡mapæ¡ä»¶åˆ é™¤è®°å½•</button></li><li class="tab"><button type="button" data-href="#90690d89-b991-4c45-804d-9388f76e105c-4"><i class="fas fa-heartbeat"></i>é€šè¿‡warpperåˆ é™¤</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="90690d89-b991-4c45-804d-9388f76e105c-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDeleteById</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//DELETE FROM user WHERE id=?</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> userMapper.deleteById(<span class="number">4L</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;result:&quot;</span> + result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="90690d89-b991-4c45-804d-9388f76e105c-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDeleteByIdList</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//DELETE FROM user WHERE id IN ( ? , ? , ? )</span></span><br><span class="line">    List&lt;Long&gt; list = Arrays.asList(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">3L</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> userMapper.deleteBatchIds(list);</span><br><span class="line">    System.out.println(<span class="string">&quot;result:&quot;</span> + result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="90690d89-b991-4c45-804d-9388f76e105c-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDeleteByIdMap</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//DELETE FROM user WHERE name = ? AND age = ?</span></span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;å¼ ä¸‰&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;age&quot;</span>, <span class="number">20</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> userMapper.deleteByMap(map);</span><br><span class="line">    System.out.println(<span class="string">&quot;result:&quot;</span> + result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="90690d89-b991-4c45-804d-9388f76e105c-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDeleteByWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//DELETE FROM user WHERE (age = ?)</span></span><br><span class="line">    QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(<span class="string">&quot;age&quot;</span>,<span class="number">20</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">delete</span> <span class="operator">=</span> userMapper.delete(queryWrapper);</span><br><span class="line">    System.out.println(<span class="string">&quot;åˆ é™¤çš„è¡Œæ•° = &quot;</span> + delete);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="ä¿®æ”¹">ä¿®æ”¹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//UPDATE user SET name=?, age=? WHERE id=?</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">5L</span>, <span class="string">&quot;æå››&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;lisi@atguigu.com&quot;</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> userMapper.updateById(user);</span><br><span class="line">    System.out.println(<span class="string">&quot;result:&quot;</span> + result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="æŸ¥è¯¢">æŸ¥è¯¢</h3><div class="tabs" id="71b80dc8-57b7-4ca8-981a-08ffa2a2f1d3"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#71b80dc8-57b7-4ca8-981a-08ffa2a2f1d3-1"><i class="fas fa-award"></i>æ ¹æ®idæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</button></li><li class="tab"><button type="button" data-href="#71b80dc8-57b7-4ca8-981a-08ffa2a2f1d3-2"><i class="fas fa-baseball-ball"></i>æ ¹æ®å¤šä¸ªidæŸ¥è¯¢å¤šä¸ªç”¨æˆ·ä¿¡æ¯</button></li><li class="tab"><button type="button" data-href="#71b80dc8-57b7-4ca8-981a-08ffa2a2f1d3-3"><i class="fas fa-bone"></i>é€šè¿‡mapæ¡ä»¶æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</button></li><li class="tab"><button type="button" data-href="#71b80dc8-57b7-4ca8-981a-08ffa2a2f1d3-4"><i class="fas fa-heartbeat"></i>é€šè¿‡WrapperæŸ¥è¯¢</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="71b80dc8-57b7-4ca8-981a-08ffa2a2f1d3-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSelectById</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//æ ¹æ®idæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">//SELECT id,name,age,email FROM user WHERE id=?</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectById(<span class="number">4L</span>);</span><br><span class="line">    System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="71b80dc8-57b7-4ca8-981a-08ffa2a2f1d3-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSelectByIdList</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//SELECT id,name,age,email FROM user WHERE id IN ( ? , ? , ? )</span></span><br><span class="line">    List&lt;Long&gt; list = Arrays.asList(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">3L</span>);</span><br><span class="line">    List&lt;User&gt; users = userMapper.selectBatchIds(list);</span><br><span class="line">    users.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="71b80dc8-57b7-4ca8-981a-08ffa2a2f1d3-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSelectByMap</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//SELECT id,name,age,email FROM user WHERE name = ? AND age = ?</span></span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;Jack&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;age&quot;</span>, <span class="number">20</span>);</span><br><span class="line">    List&lt;User&gt; users = userMapper.selectByMap(map);</span><br><span class="line">    users.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="71b80dc8-57b7-4ca8-981a-08ffa2a2f1d3-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSelectByWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//SELECT id,name,age,email FROM user WHERE (age = ?)</span></span><br><span class="line">    QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(<span class="string">&quot;age&quot;</span>,<span class="number">20</span>);</span><br><span class="line">    List&lt;User&gt; userList = userMapper.selectList(queryWrapper);</span><br><span class="line">    userList.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><hr><h2 id="é€šç”¨Service">é€šç”¨Service</h2><p>è¯´æ˜:</p><ul><li>é€šç”¨ Service CRUD å°è£…IServiceæ¥å£ï¼Œè¿›ä¸€æ­¥å°è£… CRUD é‡‡ç”¨ get æŸ¥è¯¢å•è¡Œ remove åˆ é™¤ list æŸ¥è¯¢é›†åˆ page åˆ†é¡µ å‰ç¼€å‘½åæ–¹å¼åŒºåˆ† Mapper å±‚é¿å…æ··æ·†</li><li>æ³›å‹ T ä¸ºä»»æ„å®ä½“å¯¹è±¡</li><li>å»ºè®®å¦‚æœå­˜åœ¨è‡ªå®šä¹‰é€šç”¨ Service æ–¹æ³•çš„å¯èƒ½ï¼Œè¯·åˆ›å»ºè‡ªå·±çš„ IBaseService ç»§æ‰¿Mybatis-Plus æä¾›çš„åŸºç±»</li><li>å®˜ç½‘åœ°å€ï¼š<a href="https://baomidou.com/pages/49cc81/#service-crud-%E6%8E%A5%E5%8F%A3">https://baomidou.com/pages/49cc81/#service-crud-æ¥å£</a></li></ul><p>MyBatis-Plusä¸­æœ‰ä¸€ä¸ªæ¥å£ IServiceå’Œå…¶å®ç°ç±» ServiceImplï¼Œå°è£…äº†å¸¸è§çš„ä¸šåŠ¡å±‚é€»è¾‘è¯¦æƒ…æŸ¥çœ‹æºç IServiceå’ŒServiceImpl</p><div class="tabs" id="17c1b30e-9733-4d48-afeb-7ab700f6184c"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#17c1b30e-9733-4d48-afeb-7ab700f6184c-1"><i class="fas fa-cat"></i>åˆ›å»ºServiceæ¥å£å’Œå®ç°ç±»</button></li><li class="tab"><button type="button" data-href="#17c1b30e-9733-4d48-afeb-7ab700f6184c-2"><i class="fas fa-horse"></i>æµ‹è¯•æŸ¥è¯¢è®°å½•æ•°</button></li><li class="tab"><button type="button" data-href="#17c1b30e-9733-4d48-afeb-7ab700f6184c-3"><i class="fas fa-dove"></i>æµ‹è¯•æ‰¹é‡æ’å…¥</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="17c1b30e-9733-4d48-afeb-7ab700f6184c-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;User&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="17c1b30e-9733-4d48-afeb-7ab700f6184c-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetCount</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> userService.count();</span><br><span class="line">    System.out.println(<span class="string">&quot;æ€»è®°å½•æ•°ï¼š&quot;</span> + count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="17c1b30e-9733-4d48-afeb-7ab700f6184c-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSaveBatch</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// SQLé•¿åº¦æœ‰é™åˆ¶ï¼Œæµ·é‡æ•°æ®æ’å…¥å•æ¡SQLæ— æ³•å®è¡Œï¼Œ</span></span><br><span class="line">    <span class="comment">// å› æ­¤MPå°†æ‰¹é‡æ’å…¥æ”¾åœ¨äº†é€šç”¨Serviceä¸­å®ç°ï¼Œè€Œä¸æ˜¯é€šç”¨Mapper</span></span><br><span class="line">    ArrayList&lt;User&gt; users = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setName(<span class="string">&quot;ybc&quot;</span> + i);</span><br><span class="line">        user.setAge(<span class="number">20</span> + i);</span><br><span class="line">        users.add(user);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//SQL:INSERT INTO t_user ( username, age ) VALUES ( ?, ? )</span></span><br><span class="line">    userService.saveBatch(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="å¸¸ç”¨æ³¨è§£">å¸¸ç”¨æ³¨è§£</h2><h3 id="TableName">@TableName</h3><p>ç»è¿‡ä¸Šé¢çš„æµ‹è¯•ï¼Œåœ¨ä½¿ç”¨MyBatis-Pluså®ç°åŸºæœ¬çš„CRUDæ—¶ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰æŒ‡å®šè¦æ“ä½œçš„è¡¨ï¼Œåªæ˜¯åœ¨Mapperæ¥å£ç»§æ‰¿BaseMapperæ—¶ï¼Œè®¾ç½®äº†æ³›å‹Userï¼Œè€Œæ“ä½œçš„è¡¨ä¸ºuserè¡¨ã€‚</p><p>ç”±æ­¤å¾—å‡ºç»“è®ºï¼ŒMyBatis-Plusåœ¨ç¡®å®šæ“ä½œçš„è¡¨æ—¶ï¼Œç”±BaseMapperçš„æ³›å‹å†³å®šï¼Œå³å®ä½“ç±»å‹å†³å®šï¼Œä¸”é»˜è®¤æ“ä½œçš„è¡¨åå’Œå®ä½“ç±»å‹çš„ç±»åä¸€è‡´</p><blockquote><p>è‹¥å®ä½“ç±»ç±»å‹çš„ç±»åå’Œè¦æ“ä½œçš„è¡¨çš„è¡¨åä¸ä¸€è‡´ï¼Œä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p></blockquote><p>æˆ‘ä»¬å°†è¡¨useræ›´åä¸ºt_userï¼Œæµ‹è¯•æŸ¥è¯¢åŠŸèƒ½ç¨‹åºæŠ›å‡ºå¼‚å¸¸ï¼ŒTable â€˜mybatis_plus.userâ€™ doesnâ€™t existï¼Œå› ä¸ºç°åœ¨çš„è¡¨åä¸ºt_userï¼Œè€Œé»˜è®¤æ“ä½œçš„è¡¨åå’Œå®ä½“ç±»å‹çš„ç±»åä¸€è‡´ï¼Œå³userè¡¨</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230601163952677.png" alt="image-20230601163952677" style="zoom:67%;" /><mark class="hl-label green">è§£å†³æ–¹æ³•</mark> <p>åœ¨å®ä½“ç±»ç±»å‹ä¸Šæ·»åŠ <code>@TableName(&quot;t_user&quot;)</code>ï¼Œæ ‡è¯†å®ä½“ç±»å¯¹åº”çš„è¡¨ï¼Œå³å¯æˆåŠŸæ‰§è¡ŒSQLè¯­å¥</p><p>åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸é‡åˆ°ä»¥ä¸Šçš„é—®é¢˜ï¼Œå³å®ä½“ç±»æ‰€å¯¹åº”çš„è¡¨éƒ½æœ‰å›ºå®šçš„å‰ç¼€ï¼Œä¾‹å¦‚<code>t_</code>æˆ–<code>tbl_</code>æ­¤æ—¶ï¼Œå¯ä»¥ä½¿ç”¨MyBatis-Plusæä¾›çš„å…¨å±€é…ç½®ï¼Œä¸ºå®ä½“ç±»æ‰€å¯¹åº”çš„è¡¨åè®¾ç½®é»˜è®¤çš„å‰ç¼€ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦åœ¨æ¯ä¸ªå®ä½“ç±»ä¸Šé€šè¿‡@TableNameæ ‡è¯†å®ä½“ç±»å¯¹åº”çš„è¡¨</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line">  <span class="comment"># è®¾ç½®MyBatis-Plusçš„å…¨å±€é…ç½®</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="comment"># è®¾ç½®å®ä½“ç±»æ‰€å¯¹åº”çš„è¡¨çš„ç»Ÿä¸€å‰ç¼€</span></span><br><span class="line">      <span class="attr">table-prefix:</span> <span class="string">t_</span></span><br></pre></td></tr></table></figure><hr><h3 id="TableId">@TableId</h3><p>ç»è¿‡ä»¥ä¸Šçš„æµ‹è¯•ï¼ŒMyBatis-Plusåœ¨å®ç°CRUDæ—¶ï¼Œä¼šé»˜è®¤å°†idä½œä¸ºä¸»é”®åˆ—ï¼Œå¹¶åœ¨æ’å…¥æ•°æ®æ—¶ï¼Œé»˜è®¤åŸºäºé›ªèŠ±ç®—æ³•çš„ç­–ç•¥ç”Ÿæˆid</p><blockquote><p>è‹¥å®ä½“ç±»å’Œè¡¨ä¸­è¡¨ç¤ºä¸»é”®çš„ä¸æ˜¯idï¼Œè€Œæ˜¯å…¶ä»–å­—æ®µï¼Œä¾‹å¦‚uidï¼ŒMyBatis-Plusä¼šè‡ªåŠ¨è¯†åˆ«uidä¸ºä¸»é”®åˆ—å—ï¼Ÿæˆ‘ä»¬å®ä½“ç±»ä¸­çš„å±æ€§idæ”¹ä¸ºuidï¼Œå°†è¡¨ä¸­çš„å­—æ®µidä¹Ÿæ”¹ä¸ºuidï¼Œæµ‹è¯•æ·»åŠ åŠŸèƒ½</p></blockquote><p>ç¨‹åºæŠ›å‡ºå¼‚å¸¸ï¼ŒField â€˜uidâ€™ doesnâ€™t have a default valueï¼Œè¯´æ˜MyBatis-Plusæ²¡æœ‰å°†uidä½œä¸ºä¸»é”®èµ‹å€¼</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230601164651390.png" alt="image-20230601164651390" style="zoom:67%;" /><mark class="hl-label green">è§£å†³æ–¹æ³•</mark> <p>åœ¨å®ä½“ç±»ä¸­uidå±æ€§ä¸Šé€šè¿‡@TableIdå°†å…¶æ ‡è¯†ä¸ºä¸»é”®ï¼Œå³å¯æˆåŠŸæ‰§è¡ŒSQLè¯­å¥</p><blockquote><p>@TableIdçš„valueå±æ€§</p></blockquote><p>è‹¥å®ä½“ç±»ä¸­ä¸»é”®å¯¹åº”çš„å±æ€§ä¸ºidï¼Œè€Œè¡¨ä¸­è¡¨ç¤ºä¸»é”®çš„å­—æ®µä¸ºuidï¼Œæ­¤æ—¶è‹¥åªåœ¨å±æ€§idä¸Šæ·»åŠ æ³¨è§£@TableIdï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸Unknown column â€˜idâ€™ in â€˜field listâ€™ï¼Œå³MyBatis-Plusä»ç„¶ä¼šå°†idä½œä¸ºè¡¨çš„ä¸»é”®æ“ä½œï¼Œè€Œè¡¨ä¸­è¡¨ç¤ºä¸»é”®çš„æ˜¯å­—æ®µuidæ­¤æ—¶éœ€è¦é€šè¿‡@TableIdæ³¨è§£çš„valueå±æ€§ï¼ŒæŒ‡å®šè¡¨ä¸­çš„ä¸»é”®å­—æ®µï¼Œ@TableId(â€œuidâ€)æˆ–@TableId(value=â€œuidâ€)</p><blockquote><p>TableIdçš„typeå±æ€§</p></blockquote><p>typeå±æ€§ç”¨æ¥å®šä¹‰ä¸»é”®ç­–ç•¥</p><p>å¸¸ç”¨çš„ä¸»é”®ç­–ç•¥ï¼š</p><table><thead><tr><th>å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>IdType.ASSIGN_ID</code>(é»˜è®¤)</td><td>åŸºäºé›ªèŠ±ç®—æ³•çš„ç­–ç•¥ç”Ÿæˆæ•°æ®idï¼Œä¸æ•°æ®åº“idæ˜¯å¦è®¾ç½®è‡ªå¢æ— å…³</td></tr><tr><td><code>IdType.AUTO</code></td><td>ä½¿ç”¨æ•°æ®åº“çš„è‡ªå¢ç­–ç•¥ï¼Œæ³¨æ„ï¼Œè¯¥ç±»å‹è¯·ç¡®ä¿æ•°æ®åº“è®¾ç½®äº†idè‡ªå¢ï¼Œå¦åˆ™æ— æ•ˆ</td></tr></tbody></table><hr><h3 id="TableField">@TableField</h3><p>ç»è¿‡ä»¥ä¸Šçš„æµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼ŒMyBatis-Plusåœ¨æ‰§è¡ŒSQLè¯­å¥æ—¶ï¼Œè¦ä¿è¯å®ä½“ç±»ä¸­çš„å±æ€§åå’Œè¡¨ä¸­çš„å­—æ®µåä¸€è‡´å¦‚æœå®ä½“ç±»ä¸­çš„å±æ€§åå’Œå­—æ®µåä¸ä¸€è‡´çš„æƒ…å†µï¼Œä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</p><blockquote><p>æƒ…å†µ1:è‹¥å®ä½“ç±»ä¸­çš„å±æ€§ä½¿ç”¨çš„æ˜¯é©¼å³°å‘½åé£æ ¼ï¼Œè€Œè¡¨ä¸­çš„å­—æ®µä½¿ç”¨çš„æ˜¯ä¸‹åˆ’çº¿å‘½åé£æ ¼</p></blockquote><p>ä¾‹å¦‚å®ä½“ç±»å±æ€§userNameï¼Œè¡¨ä¸­å­—æ®µuser_name</p><p>æ­¤æ—¶MyBatis-Plusä¼šè‡ªåŠ¨å°†ä¸‹åˆ’çº¿å‘½åé£æ ¼è½¬åŒ–ä¸ºé©¼å³°å‘½åé£æ ¼ï¼Œç›¸å½“äºåœ¨MyBatisä¸­é…ç½®ã€‚</p><blockquote><p>æƒ…å†µ2:è‹¥å®ä½“ç±»ä¸­çš„å±æ€§å’Œè¡¨ä¸­çš„å­—æ®µä¸æ»¡è¶³æƒ…å†µ1</p></blockquote><p>ä¾‹å¦‚å®ä½“ç±»å±æ€§nameï¼Œè¡¨ä¸­å­—æ®µusernameæ­¤æ—¶éœ€è¦åœ¨å®ä½“ç±»å±æ€§ä¸Šä½¿ç”¨@TableField(â€œusernameâ€)è®¾ç½®å±æ€§æ‰€å¯¹åº”çš„å­—æ®µå</p><hr><h3 id="TableLogic">@TableLogic</h3><ul><li>ç‰©ç†åˆ é™¤ï¼šçœŸå®åˆ é™¤ï¼Œå°†å¯¹åº”æ•°æ®ä»æ•°æ®åº“ä¸­åˆ é™¤ï¼Œä¹‹åæŸ¥è¯¢ä¸åˆ°æ­¤æ¡è¢«åˆ é™¤çš„æ•°æ®</li><li>é€»è¾‘åˆ é™¤ï¼šå‡åˆ é™¤ï¼Œå°†å¯¹åº”æ•°æ®ä¸­ä»£è¡¨æ˜¯å¦è¢«åˆ é™¤å­—æ®µçš„çŠ¶æ€ä¿®æ”¹ä¸ºâ€œè¢«åˆ é™¤çŠ¶æ€â€ï¼Œä¹‹ååœ¨æ•°æ®åº“ä¸­ä»æ—§èƒ½çœ‹åˆ°æ­¤æ¡æ•°æ®è®°å½•</li><li>ä½¿ç”¨åœºæ™¯ï¼šå¯ä»¥è¿›è¡Œæ•°æ®æ¢å¤</li></ul><mark class="hl-label blue">å®ç°é€»è¾‘åˆ é™¤</mark> <div class="tabs" id="8a4fc660-7590-48f8-a6a6-81eb410561e6"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#8a4fc660-7590-48f8-a6a6-81eb410561e6-1"><i class="fas fa-seedling"></i>step1</button></li><li class="tab"><button type="button" data-href="#8a4fc660-7590-48f8-a6a6-81eb410561e6-2"><i class="fas fa-leaf"></i>step2</button></li><li class="tab"><button type="button" data-href="#8a4fc660-7590-48f8-a6a6-81eb410561e6-3"><i class="fab fa-apple"></i>step3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="8a4fc660-7590-48f8-a6a6-81eb410561e6-1"><p>æ•°æ®åº“ä¸­åˆ›å»ºé€»è¾‘åˆ é™¤çŠ¶æ€åˆ—ï¼Œè®¾ç½®é»˜è®¤å€¼ä¸º0</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8a4fc660-7590-48f8-a6a6-81eb410561e6-2"><p>å®ä½“ç±»ä¸­æ·»åŠ é€»è¾‘åˆ é™¤å±æ€§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@TableId(value = &quot;id&quot;,type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="meta">@TableLogic</span></span><br><span class="line">    <span class="keyword">private</span> Integer isDeleted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8a4fc660-7590-48f8-a6a6-81eb410561e6-3"><p>æµ‹è¯•åˆ é™¤åŠŸèƒ½ï¼ŒçœŸæ­£æ‰§è¡Œçš„æ˜¯ä¿®æ”¹</p><p><code>UPDATE t_user SET is_deleted=1 WHERE id=? AND is_deleted=0</code></p><p>æµ‹è¯•æŸ¥è¯¢åŠŸèƒ½ï¼Œè¢«é€»è¾‘åˆ é™¤çš„æ•°æ®é»˜è®¤ä¸ä¼šè¢«æŸ¥è¯¢</p><p><code>SELECT id,username AS name,age,email,is_deleted FROM t_user WHERE is_deleted=0</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="æ¡ä»¶æ„é€ å™¨Wrapper">æ¡ä»¶æ„é€ å™¨Wrapper</h2><h3 id="wrapperä»‹ç»">wrapperä»‹ç»</h3><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230601170956747.png" alt="image-20230601170956747"></p><p>Wrapper ï¼š æ¡ä»¶æ„é€ æŠ½è±¡ç±»ï¼Œæœ€é¡¶ç«¯çˆ¶ç±»</p><ul><li>AbstractWrapper ï¼š ç”¨äºæŸ¥è¯¢æ¡ä»¶å°è£…ï¼Œç”Ÿæˆ sql çš„ where æ¡ä»¶<ul><li>QueryWrapper ï¼š æŸ¥è¯¢æ¡ä»¶å°è£…</li><li>UpdateWrapper ï¼š Update æ¡ä»¶å°è£…</li><li>AbstractLambdaWrapper ï¼š ä½¿ç”¨Lambda è¯­æ³•<ul><li>LambdaQueryWrapper ï¼šç”¨äºLambdaè¯­æ³•ä½¿ç”¨çš„æŸ¥è¯¢Wrapper</li><li>LambdaUpdateWrapper ï¼š Lambda æ›´æ–°å°è£…Wrapper</li></ul></li></ul></li></ul><hr><h3 id="QueryWrapper">QueryWrapper</h3><div class="tabs" id="a76fa2b7-22ae-4dc0-b6e7-d6fc03245680"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#a76fa2b7-22ae-4dc0-b6e7-d6fc03245680-1"><i class="fas fa-atom"></i>ç»„è£…æŸ¥è¯¢æ¡ä»¶</button></li><li class="tab"><button type="button" data-href="#a76fa2b7-22ae-4dc0-b6e7-d6fc03245680-2"><i class="far fa-sun"></i>ç»„è£…æ’åºæ¡ä»¶</button></li><li class="tab"><button type="button" data-href="#a76fa2b7-22ae-4dc0-b6e7-d6fc03245680-3"><i class="fas fa-wind"></i>ç»„è£…åˆ é™¤æ¡ä»¶</button></li><li class="tab"><button type="button" data-href="#a76fa2b7-22ae-4dc0-b6e7-d6fc03245680-4"><i class="fas fa-cookie-bite"></i>æ¡ä»¶çš„ä¼˜å…ˆçº§</button></li><li class="tab"><button type="button" data-href="#a76fa2b7-22ae-4dc0-b6e7-d6fc03245680-5"><i class="fas fa-fire-alt"></i>ç»„è£…selectå­å¥</button></li><li class="tab"><button type="button" data-href="#a76fa2b7-22ae-4dc0-b6e7-d6fc03245680-6"><i class="fas fa-heartbeat"></i>å®ç°å­æŸ¥è¯¢</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="a76fa2b7-22ae-4dc0-b6e7-d6fc03245680-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wrapperSelect</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//æŸ¥è¯¢ç”¨æˆ·ååŒ…å«oï¼Œå¹´é¾„åœ¨20åˆ°30ä¹‹é—´ï¼Œå¹¶ä¸”é‚®ç®±ä¸ä¸ºnullçš„ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">//SELECT id,name,age,email,is_deleted FROM user WHERE is_deleted=0 AND (username LIKE ? AND age BETWEEN ? AND ? AND email IS NOT NULL)</span></span><br><span class="line">    QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.like(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;o&quot;</span>)</span><br><span class="line">            .between(<span class="string">&quot;age&quot;</span>, <span class="number">20</span>, <span class="number">30</span>)</span><br><span class="line">            .isNotNull(<span class="string">&quot;email&quot;</span>);</span><br><span class="line">    List&lt;User&gt; list = userMapper.selectList(queryWrapper);</span><br><span class="line">    list.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a76fa2b7-22ae-4dc0-b6e7-d6fc03245680-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wrapperOrder</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//æŒ‰å¹´é¾„é™åºæŸ¥è¯¢ç”¨æˆ·ï¼Œå¦‚æœå¹´é¾„ç›¸åŒåˆ™æŒ‰idå‡åºæ’åˆ—</span></span><br><span class="line">    <span class="comment">//SELECT id,name,age,email,is_deleted FROM t_user WHERE is_deleted=0 ORDER BY age DESC,id ASC</span></span><br><span class="line">    QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper</span><br><span class="line">            .orderByDesc(<span class="string">&quot;age&quot;</span>)</span><br><span class="line">            .orderByAsc(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    List&lt;User&gt; users = userMapper.selectList(queryWrapper);</span><br><span class="line">    users.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a76fa2b7-22ae-4dc0-b6e7-d6fc03245680-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wrapperDelete</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//åˆ é™¤emailä¸ºç©ºçš„ç”¨æˆ·</span></span><br><span class="line">    <span class="comment">//DELETE FROM t_user WHERE (email IS NULL)</span></span><br><span class="line">    QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.isNull(<span class="string">&quot;email&quot;</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> userMapper.delete(queryWrapper);</span><br><span class="line">    System.out.println(<span class="string">&quot;å—å½±å“çš„è¡Œæ•°ï¼š&quot;</span> + result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a76fa2b7-22ae-4dc0-b6e7-d6fc03245680-4"><blockquote><p>å°†ï¼ˆå¹´é¾„å¤§äº20å¹¶ä¸”ç”¨æˆ·åä¸­åŒ…å«æœ‰aï¼‰æˆ–é‚®ç®±ä¸ºnullçš„ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">queryWrapper</span><br><span class="line">        .like(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">        .gt(<span class="string">&quot;age&quot;</span>, <span class="number">20</span>)</span><br><span class="line">        .or()</span><br><span class="line">        .isNull(<span class="string">&quot;email&quot;</span>);</span><br></pre></td></tr></table></figure><blockquote><p>å°†ç”¨æˆ·åä¸­åŒ…å«æœ‰aå¹¶ä¸”ï¼ˆå¹´é¾„å¤§äº20æˆ–é‚®ç®±ä¸ºnullï¼‰çš„ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹</p></blockquote><p>å¯ä»¥ä½¿ç”¨lambdaè¡¨è¾¾å¼ï¼Œå…¶å†…éƒ¨çš„é€»è¾‘ä¼˜å…ˆè¿ç®—</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">queryWrapper</span><br><span class="line">        .like(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">        .and(i -&gt; i.gt(<span class="string">&quot;age&quot;</span>, <span class="number">20</span>).or().isNull(<span class="string">&quot;email&quot;</span>));</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a76fa2b7-22ae-4dc0-b6e7-d6fc03245680-5"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wrapperSelects</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯çš„usernameå’Œageå­—æ®µ</span></span><br><span class="line">    <span class="comment">//SELECT username,age FROM t_user</span></span><br><span class="line">    QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.select(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;age&quot;</span>);</span><br><span class="line">    <span class="comment">//selectMaps()è¿”å›Mapé›†åˆåˆ—è¡¨ï¼Œé€šå¸¸é…åˆselect()ä½¿ç”¨ï¼Œé¿å…Userå¯¹è±¡ä¸­æ²¡æœ‰è¢«æŸ¥è¯¢åˆ°çš„åˆ—å€¼ä¸ºnull</span></span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; maps = userMapper.selectMaps(queryWrapper);</span><br><span class="line">    maps.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a76fa2b7-22ae-4dc0-b6e7-d6fc03245680-6"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wrapperSubquery</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//æŸ¥è¯¢idå°äºç­‰äº3çš„ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">//SELECT id,name,age,email,is_deleted FROM t_user WHERE (id IN(select id from t_user where id &lt;= 3))</span></span><br><span class="line">    QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.inSql(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;select id from user where id &lt;= 3&quot;</span>);</span><br><span class="line">    List&lt;User&gt; list = userMapper.selectList(queryWrapper);</span><br><span class="line">    list.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="UpdateWrapper">UpdateWrapper</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wrapperUpdate</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//å°†ï¼ˆå¹´é¾„å¤§äº20æˆ–é‚®ç®±ä¸ºnullï¼‰å¹¶ä¸”ç”¨æˆ·åä¸­åŒ…å«æœ‰açš„ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹</span></span><br><span class="line">    <span class="comment">//ç»„è£…setå­å¥ä»¥åŠä¿®æ”¹æ¡ä»¶</span></span><br><span class="line">    UpdateWrapper&lt;User&gt; updateWrapper = <span class="keyword">new</span> <span class="title class_">UpdateWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//lambdaè¡¨è¾¾å¼å†…çš„é€»è¾‘ä¼˜å…ˆè¿ç®—</span></span><br><span class="line">    updateWrapper</span><br><span class="line">            .set(<span class="string">&quot;age&quot;</span>, <span class="number">18</span>)</span><br><span class="line">            .set(<span class="string">&quot;email&quot;</span>, <span class="string">&quot;user@atguigu.com&quot;</span>)</span><br><span class="line">            .like(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">            .and(i -&gt; i.gt(<span class="string">&quot;age&quot;</span>, <span class="number">20</span>).or().isNull(<span class="string">&quot;email&quot;</span>));</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> userMapper.update(<span class="literal">null</span>, updateWrapper);</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="condition">condition</h3><p>åœ¨çœŸæ­£å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œç»„è£…æ¡ä»¶æ˜¯å¸¸è§çš„åŠŸèƒ½ï¼Œè€Œè¿™äº›æ¡ä»¶æ•°æ®æ¥æºäºç”¨æˆ·è¾“å…¥ï¼Œæ˜¯å¯é€‰çš„ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ç»„è£…è¿™äº›æ¡ä»¶æ—¶ï¼Œå¿…é¡»å…ˆåˆ¤æ–­ç”¨æˆ·æ˜¯å¦é€‰æ‹©äº†è¿™äº›æ¡ä»¶ï¼Œè‹¥é€‰æ‹©åˆ™éœ€è¦ç»„è£…è¯¥æ¡ä»¶ï¼Œè‹¥æ²¡æœ‰é€‰æ‹©åˆ™ä¸€å®šä¸èƒ½ç»„è£…ï¼Œä»¥å…å½±å“SQLæ‰§è¡Œçš„ç»“æœã€‚</p><div class="tabs" id="f81f127f-6787-48b2-8375-870545f157a2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#f81f127f-6787-48b2-8375-870545f157a2-1"><i class="fas fa-seedling"></i>æ€è·¯ä¸€</button></li><li class="tab"><button type="button" data-href="#f81f127f-6787-48b2-8375-870545f157a2-2"><i class="fas fa-leaf"></i>æ€è·¯äºŒ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="f81f127f-6787-48b2-8375-870545f157a2-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testQuery</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//å®šä¹‰æŸ¥è¯¢æ¡ä»¶ï¼Œæœ‰å¯èƒ½ä¸ºnullï¼ˆç”¨æˆ·æœªè¾“å…¥æˆ–æœªé€‰æ‹©ï¼‰</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">ageBegin</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">ageEnd</span> <span class="operator">=</span> <span class="number">24</span>;</span><br><span class="line">    QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//StringUtils.isNotBlank()åˆ¤æ–­æŸå­—ç¬¦ä¸²æ˜¯å¦ä¸ä¸ºç©ºä¸”é•¿åº¦ä¸ä¸º0ä¸”ä¸ç”±ç©ºç™½ç¬¦(whitespace)æ„æˆ</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotBlank(name)) &#123;</span><br><span class="line">        queryWrapper.like(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;a&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ageBegin != <span class="literal">null</span>) &#123;</span><br><span class="line">        queryWrapper.ge(<span class="string">&quot;age&quot;</span>, ageBegin);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ageEnd != <span class="literal">null</span>) &#123;</span><br><span class="line">        queryWrapper.le(<span class="string">&quot;age&quot;</span>, ageEnd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//SELECT id,name,age,email,is_deleted FROM t_user WHERE (age &gt;=?AND age &lt;= ?)</span></span><br><span class="line">    List&lt;User&gt; users = userMapper.selectList(queryWrapper);</span><br><span class="line">    users.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f81f127f-6787-48b2-8375-870545f157a2-2"><p>ä½†æ˜¯ä»£ç æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¸¦conditionå‚æ•°çš„é‡è½½æ–¹æ³•æ„å»ºæŸ¥è¯¢æ¡ä»¶ï¼Œç®€åŒ–ä»£ç çš„ç¼–å†™ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">UseCondition</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//å®šä¹‰æŸ¥è¯¢æ¡ä»¶ï¼Œæœ‰å¯èƒ½ä¸ºnullï¼ˆç”¨æˆ·æœªè¾“å…¥æˆ–æœªé€‰æ‹©ï¼‰</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">ageBegin</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">ageEnd</span> <span class="operator">=</span> <span class="number">24</span>;</span><br><span class="line">    QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//StringUtils.isNotBlank()åˆ¤æ–­æŸå­—ç¬¦ä¸²æ˜¯å¦ä¸ä¸ºç©ºä¸”é•¿åº¦ä¸ä¸º0ä¸”ä¸ç”±ç©ºç™½ç¬¦(whitespace)æ„æˆ</span></span><br><span class="line">    queryWrapper</span><br><span class="line">            .like(StringUtils.isNotBlank(name), <span class="string">&quot;name&quot;</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">            .ge(ageBegin != <span class="literal">null</span>, <span class="string">&quot;age&quot;</span>, ageBegin)</span><br><span class="line">            .le(ageEnd != <span class="literal">null</span>, <span class="string">&quot;age&quot;</span>, ageEnd);</span><br><span class="line">    <span class="comment">//SELECT id,name,age,email,is_deleted FROM t_user WHERE (age &gt;=? AND age &lt;= ?)</span></span><br><span class="line">    List&lt;User&gt; users = userMapper.selectList(queryWrapper);</span><br><span class="line">    users.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="LambdaQueryWrapper">LambdaQueryWrapper</h3><p>å­—æ®µåå¾ˆå®¹æ˜“å†™é”™ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨LambdaQueryWrapperå’ŒLambdaUpdateWrapperã€‚</p><p>è¿™æ—¶å€™æŒ‡å®šå­—æ®µåå°±ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ã€‚</p><p>ä¾‹å¦‚ï¼šUser::getNameè·å–å­—æ®µåã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test09</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//å®šä¹‰æŸ¥è¯¢æ¡ä»¶ï¼Œæœ‰å¯èƒ½ä¸ºnullï¼ˆç”¨æˆ·æœªè¾“å…¥ï¼‰</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;a&quot;</span>;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">ageBegin</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">ageEnd</span> <span class="operator">=</span> <span class="number">24</span>;</span><br><span class="line">    LambdaQueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//é¿å…ä½¿ç”¨å­—ç¬¦ä¸²è¡¨ç¤ºå­—æ®µï¼Œé˜²æ­¢è¿è¡Œæ—¶é”™è¯¯</span></span><br><span class="line">    queryWrapper</span><br><span class="line">            .like(StringUtils.isNotBlank(name), User::getName, name)</span><br><span class="line">            .ge(ageBegin != <span class="literal">null</span>, User::getAge, ageBegin)</span><br><span class="line">            .le(ageEnd != <span class="literal">null</span>, User::getAge, ageEnd);</span><br><span class="line">    List&lt;User&gt; users = userMapper.selectList(queryWrapper);</span><br><span class="line">    users.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="LambdaUpdateWrapper">LambdaUpdateWrapper</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test10</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//ç»„è£…setå­å¥</span></span><br><span class="line">    LambdaUpdateWrapper&lt;User&gt; updateWrapper = <span class="keyword">new</span> <span class="title class_">LambdaUpdateWrapper</span>&lt;&gt;();</span><br><span class="line">    updateWrapper</span><br><span class="line">            .set(User::getAge, <span class="number">18</span>)</span><br><span class="line">            .set(User::getEmail, <span class="string">&quot;user@atguigu.com&quot;</span>)</span><br><span class="line">            .like(User::getName, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">            .and(i -&gt; i.lt(User::getAge, <span class="number">24</span>).or().isNull(User::getEmail)); <span class="comment">//lambda</span></span><br><span class="line">    <span class="comment">//è¡¨è¾¾å¼å†…çš„é€»è¾‘ä¼˜å…ˆè¿ç®—</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> userMapper.update(user, updateWrapper);</span><br><span class="line">    System.out.println(<span class="string">&quot;å—å½±å“çš„è¡Œæ•°ï¼š&quot;</span> + result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="æ’ä»¶">æ’ä»¶</h2><h3 id="åˆ†é¡µæ’ä»¶">åˆ†é¡µæ’ä»¶</h3><p>MyBatis Plusè‡ªå¸¦åˆ†é¡µæ’ä»¶ï¼Œåªè¦ç®€å•çš„é…ç½®å³å¯å®ç°åˆ†é¡µåŠŸèƒ½</p><div class="tabs" id="bbec77b7-5802-49d0-8357-81d3f0e1be85"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#bbec77b7-5802-49d0-8357-81d3f0e1be85-1"><i class="fas fa-atom"></i>æ·»åŠ é…ç½®ç±»</button></li><li class="tab"><button type="button" data-href="#bbec77b7-5802-49d0-8357-81d3f0e1be85-2"><i class="far fa-sun"></i>æµ‹è¯•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="bbec77b7-5802-49d0-8357-81d3f0e1be85-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//æ‰«æmapperæ¥å£æ‰€åœ¨çš„åŒ…</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.example.mybatisplus.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBatisPlusConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">        <span class="comment">//æ·»åŠ åˆ†é¡µæ’ä»¶</span></span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="bbec77b7-5802-49d0-8357-81d3f0e1be85-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPage</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//è®¾ç½®åˆ†é¡µå‚æ•°</span></span><br><span class="line">    Page&lt;User&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(<span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line">    userMapper.selectPage(page, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//è·å–åˆ†é¡µæ•°æ®</span></span><br><span class="line">    List&lt;User&gt; list = page.getRecords();</span><br><span class="line">    list.forEach(System.out::println);</span><br><span class="line">    System.out.println(<span class="string">&quot;å½“å‰é¡µï¼š&quot;</span>+page.getCurrent());</span><br><span class="line">    System.out.println(<span class="string">&quot;æ¯é¡µæ˜¾ç¤ºçš„æ¡æ•°ï¼š&quot;</span>+page.getSize());</span><br><span class="line">    System.out.println(<span class="string">&quot;æ€»è®°å½•æ•°ï¼š&quot;</span>+page.getTotal());</span><br><span class="line">    System.out.println(<span class="string">&quot;æ€»é¡µæ•°ï¼š&quot;</span>+page.getPages());</span><br><span class="line">    System.out.println(<span class="string">&quot;æ˜¯å¦æœ‰ä¸Šä¸€é¡µï¼š&quot;</span>+page.hasPrevious());</span><br><span class="line">    System.out.println(<span class="string">&quot;æ˜¯å¦æœ‰ä¸‹ä¸€é¡µï¼š&quot;</span>+page.hasNext());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç»“æœï¼š</p><p>User(id=1, name=Jone, age=18, <a href="mailto:email=test1@baomidou.com">email=test1@baomidou.com</a>, isDeleted=0)</p><p>User(id=2,name=Jack, age=20, <a href="mailto:email=test2@baomidou.com">email=test2@baomidou.com</a>, isDeleted=0)</p><p>User(id=3, name=Tom,age=28, <a href="mailto:email=test3@baomidou.com">email=test3@baomidou.com</a>, isDeleted=0)</p><p>User(id=4, name=Sandy, <a href="mailto:age=21,email=test4@baomidou.com">age=21,email=test4@baomidou.com</a>, isDeleted=0)</p><p>User(id=5, name=Billie, age=24, <a href="mailto:email=test5@baomidou.com">email=test5@baomidou.com</a>, isDeleted=0)</p><p>å½“å‰é¡µï¼š1 æ¯é¡µæ˜¾ç¤ºçš„æ¡æ•°ï¼š5 æ€»è®°å½•æ•°ï¼š17 æ€»é¡µæ•°ï¼š4 æ˜¯å¦æœ‰ä¸Šä¸€é¡µï¼šfalse æ˜¯å¦æœ‰ä¸‹ä¸€é¡µï¼štrue</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="ä¹è§‚é”">ä¹è§‚é”</h3><p>ä¸€ä»¶å•†å“ï¼Œæˆæœ¬ä»·æ˜¯80å…ƒï¼Œå”®ä»·æ˜¯100å…ƒã€‚è€æ¿å…ˆæ˜¯é€šçŸ¥å°æï¼Œè¯´ä½ å»æŠŠå•†å“ä»·æ ¼å¢åŠ 50å…ƒã€‚å°ææ­£åœ¨ç©æ¸¸æˆï¼Œè€½æäº†ä¸€ä¸ªå°æ—¶ã€‚æ­£å¥½ä¸€ä¸ªå°æ—¶åï¼Œè€æ¿è§‰å¾—å•†å“ä»·æ ¼å¢åŠ åˆ°150å…ƒï¼Œä»·æ ¼å¤ªé«˜ï¼Œå¯èƒ½ä¼šå½±å“é”€é‡ã€‚åˆé€šçŸ¥å°ç‹ï¼Œä½ æŠŠå•†å“ä»·æ ¼é™ä½30å…ƒã€‚æ­¤æ—¶ï¼Œå°æå’Œå°ç‹åŒæ—¶æ“ä½œå•†å“åå°ç³»ç»Ÿã€‚å°ææ“ä½œçš„æ—¶å€™ï¼Œç³»ç»Ÿå…ˆå–å‡ºå•†å“ä»·æ ¼100å…ƒï¼›å°ç‹ä¹Ÿåœ¨æ“ä½œï¼Œå–å‡ºçš„å•†å“ä»·æ ¼ä¹Ÿæ˜¯100å…ƒã€‚å°æå°†ä»·æ ¼åŠ äº†50å…ƒï¼Œå¹¶å°†100+50=150å…ƒå­˜å…¥äº†æ•°æ®åº“ï¼›å°ç‹å°†å•†å“å‡äº†30å…ƒï¼Œå¹¶å°†100-30=70å…ƒå­˜å…¥äº†æ•°æ®åº“ã€‚æ˜¯çš„ï¼Œå¦‚æœæ²¡æœ‰é”ï¼Œå°æçš„æ“ä½œå°±å®Œå…¨è¢«å°ç‹çš„è¦†ç›–äº†ã€‚ç°åœ¨å•†å“ä»·æ ¼æ˜¯70å…ƒï¼Œæ¯”æˆæœ¬ä»·ä½10å…ƒã€‚å‡ åˆ†é’Ÿåï¼Œè¿™ä¸ªå•†å“å¾ˆå¿«å‡ºå”®äº†1åƒå¤šä»¶å•†å“ï¼Œè€æ¿äº1ä¸‡å¤šã€‚</p><p>ä¸Šé¢çš„æ•…äº‹ï¼Œå¦‚æœæ˜¯ä¹è§‚é”ï¼Œå°ç‹ä¿å­˜ä»·æ ¼å‰ï¼Œä¼šæ£€æŸ¥ä¸‹ä»·æ ¼æ˜¯å¦è¢«äººä¿®æ”¹è¿‡äº†ã€‚å¦‚æœè¢«ä¿®æ”¹è¿‡äº†ï¼Œåˆ™é‡æ–°å–å‡ºçš„è¢«ä¿®æ”¹åçš„ä»·æ ¼ï¼Œ150å…ƒï¼Œè¿™æ ·ä»–ä¼šå°†120å…ƒå­˜å…¥æ•°æ®åº“ã€‚å¦‚æœæ˜¯æ‚²è§‚é”ï¼Œå°æå–å‡ºæ•°æ®åï¼Œå°ç‹åªèƒ½ç­‰å°ææ“ä½œå®Œä¹‹åï¼Œæ‰èƒ½å¯¹ä»·æ ¼è¿›è¡Œæ“ä½œï¼Œä¹Ÿä¼šä¿è¯æœ€ç»ˆçš„ä»·æ ¼æ˜¯120å…ƒã€‚</p><blockquote><p>æ¨¡æ‹Ÿä¿®æ”¹å†²çª</p></blockquote><div class="tabs" id="05b62ba5-c9a9-4180-adde-e16cf31d3a46"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#05b62ba5-c9a9-4180-adde-e16cf31d3a46-1"><i class="fas fa-bug"></i>å¢åŠ å•†å“è¡¨</button></li><li class="tab"><button type="button" data-href="#05b62ba5-c9a9-4180-adde-e16cf31d3a46-2"><i class="fas fa-cannabis"></i>æ·»åŠ å®ä½“</button></li><li class="tab"><button type="button" data-href="#05b62ba5-c9a9-4180-adde-e16cf31d3a46-3"><i class="fas fa-candy-cane"></i>æ·»åŠ mapper</button></li><li class="tab"><button type="button" data-href="#05b62ba5-c9a9-4180-adde-e16cf31d3a46-4"><i class="fas fa-child"></i>æµ‹è¯•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="05b62ba5-c9a9-4180-adde-e16cf31d3a46-1"><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> product</span><br><span class="line">(</span><br><span class="line">id <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ä¸»é”®ID&#x27;</span>,</span><br><span class="line">NAME <span class="type">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;å•†å“åç§°&#x27;</span>,</span><br><span class="line">price <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;ä»·æ ¼&#x27;</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (id)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_product (id, NAME, price) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;å¤–æ˜Ÿäººç¬”è®°æœ¬&#x27;</span>, <span class="number">100</span>);</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="05b62ba5-c9a9-4180-adde-e16cf31d3a46-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Product</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer price;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="05b62ba5-c9a9-4180-adde-e16cf31d3a46-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ProductMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;Product&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="05b62ba5-c9a9-4180-adde-e16cf31d3a46-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testProduct01</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//å°ææŸ¥è¯¢å•†å“ä»·æ ¼</span></span><br><span class="line">    <span class="type">Product</span> <span class="variable">productLi</span> <span class="operator">=</span> productMapper.selectById(<span class="number">1</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;å°ææŸ¥è¯¢çš„å•†å“ä»·æ ¼ï¼š&quot;</span>+productLi.getPrice());</span><br><span class="line">    <span class="comment">//å°ç‹æŸ¥è¯¢å•†å“ä»·æ ¼</span></span><br><span class="line">    <span class="type">Product</span> <span class="variable">productWang</span> <span class="operator">=</span> productMapper.selectById(<span class="number">1</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;å°ç‹æŸ¥è¯¢çš„å•†å“ä»·æ ¼ï¼š&quot;</span>+productWang.getPrice());</span><br><span class="line">    <span class="comment">//å°æå°†å•†å“ä»·æ ¼+50</span></span><br><span class="line">    productLi.setPrice(productLi.getPrice()+<span class="number">50</span>);</span><br><span class="line">    productMapper.updateById(productLi);</span><br><span class="line">    <span class="comment">//å°ç‹å°†å•†å“ä»·æ ¼-30</span></span><br><span class="line">    productWang.setPrice(productWang.getPrice()-<span class="number">30</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> productMapper.updateById(productWang);</span><br><span class="line">    <span class="keyword">if</span>(result == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">//æ“ä½œå¤±è´¥ï¼Œé‡è¯•</span></span><br><span class="line">        <span class="type">Product</span> <span class="variable">productNew</span> <span class="operator">=</span> productMapper.selectById(<span class="number">1</span>);</span><br><span class="line">        productNew.setPrice(productNew.getPrice()-<span class="number">30</span>);</span><br><span class="line">        productMapper.updateById(productNew);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è€æ¿æŸ¥è¯¢å•†å“ä»·æ ¼</span></span><br><span class="line">    <span class="type">Product</span> <span class="variable">productLaoban</span> <span class="operator">=</span> productMapper.selectById(<span class="number">1</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;è€æ¿æŸ¥è¯¢çš„å•†å“ä»·æ ¼ï¼š&quot;</span>+productLaoban.getPrice());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><blockquote><p>ä¹è§‚é”å®ç°æµç¨‹</p></blockquote><p>æ•°æ®åº“ä¸­æ·»åŠ versionå­—æ®µ</p><p>å–å‡ºè®°å½•æ—¶ï¼Œè·å–å½“å‰version</p><p><code>SELECT id,name,price,version FROM product WHERE id=1</code></p><p>æ›´æ–°æ—¶ï¼Œversion + 1ï¼Œå¦‚æœwhereè¯­å¥ä¸­çš„versionç‰ˆæœ¬ä¸å¯¹ï¼Œåˆ™æ›´æ–°å¤±è´¥</p><p><code>UPDATE product SET price=price+50, version=version + 1 WHERE id=1 AND version=1</code></p><blockquote><p>Mybatis-Pluså®ç°ä¹è§‚é”</p></blockquote><div class="tabs" id="d89e1f27-24b2-4fda-99e4-69df0c77eed2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d89e1f27-24b2-4fda-99e4-69df0c77eed2-1"><i class="fas fa-atom"></i>ä¿®æ”¹å®ä½“ç±»</button></li><li class="tab"><button type="button" data-href="#d89e1f27-24b2-4fda-99e4-69df0c77eed2-2"><i class="far fa-sun"></i>æ·»åŠ ä¹è§‚é”æ’ä»¶é…ç½®</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d89e1f27-24b2-4fda-99e4-69df0c77eed2-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Product</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer price;</span><br><span class="line">    <span class="meta">@Version</span></span><br><span class="line">    <span class="keyword">private</span> Integer version;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d89e1f27-24b2-4fda-99e4-69df0c77eed2-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//æ‰«æmapperæ¥å£æ‰€åœ¨çš„åŒ…</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.example.mybatisplus.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBatisPlusConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">        <span class="comment">//æ·»åŠ åˆ†é¡µæ’ä»¶</span></span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));</span><br><span class="line">        <span class="comment">//æ·»åŠ ä¹è§‚é”æ’ä»¶</span></span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">OptimisticLockerInnerInterceptor</span>());</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><hr><h2 id="é€šç”¨æšä¸¾">é€šç”¨æšä¸¾</h2><p>è¡¨ä¸­çš„æœ‰äº›å­—æ®µå€¼æ˜¯å›ºå®šçš„ï¼Œä¾‹å¦‚æ€§åˆ«ï¼ˆç”·æˆ–å¥³ï¼‰ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨MyBatis-Plusçš„é€šç”¨æšä¸¾æ¥å®ç°</p><div class="tabs" id="7d54946f-06ea-43b0-abbc-a36de518424a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#7d54946f-06ea-43b0-abbc-a36de518424a-1"><i class="fas fa-cat"></i>åˆ›å»ºé€šç”¨æšä¸¾ç±»å‹</button></li><li class="tab"><button type="button" data-href="#7d54946f-06ea-43b0-abbc-a36de518424a-2"><i class="fas fa-horse"></i>é…ç½®æ‰«æé€šç”¨æšä¸¾</button></li><li class="tab"><button type="button" data-href="#7d54946f-06ea-43b0-abbc-a36de518424a-3"><i class="fas fa-dove"></i>æµ‹è¯•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="7d54946f-06ea-43b0-abbc-a36de518424a-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">SexEnum</span> &#123;</span><br><span class="line">    MALE(<span class="number">1</span>, <span class="string">&quot;ç”·&quot;</span>),</span><br><span class="line">    FEMALE(<span class="number">2</span>, <span class="string">&quot;å¥³&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EnumValue</span> <span class="comment">//å°†æ³¨è§£æ‰€æ ‡è¯†çš„å±æ€§çš„å€¼å­˜å‚¨åˆ°æ•°æ®åº“ä¸­</span></span><br><span class="line">    <span class="keyword">private</span> Integer sex;</span><br><span class="line">    <span class="keyword">private</span> String sexName;</span><br><span class="line"></span><br><span class="line">    SexEnum(Integer sex, String sexName) &#123;</span><br><span class="line">        <span class="built_in">this</span>.sex = sex;</span><br><span class="line">        <span class="built_in">this</span>.sexName = sexName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="7d54946f-06ea-43b0-abbc-a36de518424a-2"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line">  <span class="comment"># è®¾ç½®MyBatis-Plusçš„å…¨å±€é…ç½®</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="comment"># è®¾ç½®å®ä½“ç±»æ‰€å¯¹åº”çš„è¡¨çš„ç»Ÿä¸€å‰ç¼€</span></span><br><span class="line">      <span class="attr">table-prefix:</span> <span class="string">t_</span></span><br><span class="line">      <span class="comment"># è®¾ç½®ç»Ÿä¸€çš„ä¸»é”®ç”Ÿæˆç­–ç•¥</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br><span class="line">  <span class="comment"># é…ç½®ç±»å‹åˆ«åæ‰€å¯¹åº”çš„åŒ…</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.atguigu.mybatisplus.pojo</span></span><br><span class="line">  <span class="comment"># æ‰«æé€šç”¨æšä¸¾çš„åŒ…</span></span><br><span class="line">  <span class="attr">type-enums-package:</span> <span class="string">com.atguigu.mybatisplus.enums</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="7d54946f-06ea-43b0-abbc-a36de518424a-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setName(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    user.setAge(<span class="number">33</span>);</span><br><span class="line">    user.setSex(SexEnum.MALE);</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> userMapper.insert(user);</span><br><span class="line">    System.out.println(<span class="string">&quot;result:&quot;</span>+result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="å¤šæ•°æ®æº">å¤šæ•°æ®æº</h2><p>é€‚ç”¨äºå¤šç§åœºæ™¯ï¼šçº¯ç²¹å¤šåº“ã€ è¯»å†™åˆ†ç¦»ã€ ä¸€ä¸»å¤šä»ã€ æ··åˆæ¨¡å¼ç­‰</p><p>ç›®å‰æˆ‘ä»¬å°±æ¥æ¨¡æ‹Ÿä¸€ä¸ªçº¯ç²¹å¤šåº“çš„ä¸€ä¸ªåœºæ™¯ï¼Œå…¶ä»–åœºæ™¯ç±»ä¼¼</p><p>åœºæ™¯è¯´æ˜ï¼š</p><p>æˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªåº“ï¼Œåˆ†åˆ«ä¸ºï¼šmybatis_plusï¼ˆä»¥å‰çš„åº“ä¸åŠ¨ï¼‰ä¸mybatis_plus_1ï¼ˆæ–°å»ºï¼‰ï¼Œå°†mybatis_plusåº“çš„productè¡¨ç§»åŠ¨åˆ°mybatis_plus_1åº“ï¼Œè¿™æ ·æ¯ä¸ªåº“ä¸€å¼ è¡¨ï¼Œé€šè¿‡ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹åˆ†åˆ«è·å–ç”¨æˆ·æ•°æ®ä¸å•†å“æ•°æ®ï¼Œå¦‚æœè·å–åˆ°è¯´æ˜å¤šåº“æ¨¡æ‹ŸæˆåŠŸ</p><div class="tabs" id="029b1c3d-8fd6-406d-8594-e613dc66d952"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#029b1c3d-8fd6-406d-8594-e613dc66d952-1"><i class="fas fa-bug"></i>åˆ›å»ºæ•°æ®åº“åŠè¡¨</button></li><li class="tab"><button type="button" data-href="#029b1c3d-8fd6-406d-8594-e613dc66d952-2"><i class="fas fa-cannabis"></i>å¼•å…¥ä¾èµ–</button></li><li class="tab"><button type="button" data-href="#029b1c3d-8fd6-406d-8594-e613dc66d952-3"><i class="fas fa-candy-cane"></i>é…ç½®å¤šæ•°æ®æº</button></li><li class="tab"><button type="button" data-href="#029b1c3d-8fd6-406d-8594-e613dc66d952-4"><i class="fas fa-child"></i>åˆ›å»ºServiceservice</button></li><li class="tab"><button type="button" data-href="#029b1c3d-8fd6-406d-8594-e613dc66d952-5"><i class="fas fa-cat"></i>æµ‹è¯•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="029b1c3d-8fd6-406d-8594-e613dc66d952-1"><blockquote><p>åˆ›å»ºæ•°æ®åº“mybatis_plus_1å’Œè¡¨product</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE `mybatis_plus_1` <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8mb4 */</span>;</span><br><span class="line">use `mybatis_plus_1`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> product</span><br><span class="line">(</span><br><span class="line">id <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ä¸»é”®ID&#x27;</span>,</span><br><span class="line">name <span class="type">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;å•†å“åç§°&#x27;</span>,</span><br><span class="line">price <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;ä»·æ ¼&#x27;</span>,</span><br><span class="line">version <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;ä¹è§‚é”ç‰ˆæœ¬å·&#x27;</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><blockquote><p>æ·»åŠ æµ‹è¯•æ•°æ®</p></blockquote><p><code>INSERT INTO product (id, NAME, price) VALUES (1, 'å¤–æ˜Ÿäººç¬”è®°æœ¬', 100);</code></p><blockquote><p>åˆ é™¤mybatis_plusåº“productè¡¨</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use mybatis_plus;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> product;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="029b1c3d-8fd6-406d-8594-e613dc66d952-2"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dynamic-datasource-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="029b1c3d-8fd6-406d-8594-e613dc66d952-3"><p>è¯´æ˜ï¼šæ³¨é‡Šæ‰ä¹‹å‰çš„æ•°æ®åº“è¿æ¥ï¼Œæ·»åŠ æ–°é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  # é…ç½®æ•°æ®æºä¿¡æ¯</span><br><span class="line">  datasource:</span><br><span class="line">    dynamic:</span><br><span class="line">      # è®¾ç½®é»˜è®¤çš„æ•°æ®æºæˆ–è€…æ•°æ®æºç»„,é»˜è®¤å€¼å³ä¸ºmaster</span><br><span class="line">      primary: master</span><br><span class="line">      # ä¸¥æ ¼åŒ¹é…æ•°æ®æº,é»˜è®¤<span class="literal">false</span>.<span class="literal">true</span>æœªåŒ¹é…åˆ°æŒ‡å®šæ•°æ®æºæ—¶æŠ›å¼‚å¸¸,<span class="literal">false</span>ä½¿ç”¨é»˜è®¤æ•°æ®æº</span><br><span class="line">      strict: <span class="literal">false</span></span><br><span class="line">      datasource:</span><br><span class="line">        master:</span><br><span class="line">          url: jdbc:mysql:<span class="comment">//localhost:3306/mybatis_plus?characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">          driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">          username: root</span><br><span class="line">          password: <span class="number">123456</span></span><br><span class="line">        slave_1:</span><br><span class="line">          url: jdbc:mysql:<span class="comment">//localhost:3306/mybatis_plus_1?characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">          driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">          username: root</span><br><span class="line">          password: <span class="number">123456</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="029b1c3d-8fd6-406d-8594-e613dc66d952-4"><blockquote><p>åˆ›å»ºç”¨æˆ·service</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;User&gt; &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@DS(&quot;master&quot;)</span> <span class="comment">//æŒ‡å®šæ‰€æ“ä½œçš„æ•°æ®æº</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>åˆ›å»ºå•†å“service</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ProductService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;Product&gt; &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@DS(&quot;slave_1&quot;)</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;ProductMapper, Product&gt; <span class="keyword">implements</span> <span class="title class_">ProductService</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="029b1c3d-8fd6-406d-8594-e613dc66d952-5"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ProductService productService;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDynamicDataSource</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(userService.getById(<span class="number">1L</span>));</span><br><span class="line">    System.out.println(productService.getById(<span class="number">1L</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœï¼š</p><p>1ã€éƒ½èƒ½é¡ºåˆ©è·å–å¯¹è±¡ï¼Œåˆ™æµ‹è¯•æˆåŠŸ</p><p>2ã€å¦‚æœæˆ‘ä»¬å®ç°è¯»å†™åˆ†ç¦»ï¼Œå°†å†™æ“ä½œæ–¹æ³•åŠ ä¸Šä¸»åº“æ•°æ®æºï¼Œè¯»æ“ä½œæ–¹æ³•åŠ ä¸Šä»åº“æ•°æ®æºï¼Œè‡ªåŠ¨åˆ‡æ¢ï¼Œæ˜¯ä¸æ˜¯å°±èƒ½å®ç°è¯»å†™åˆ†ç¦»ï¼Ÿ</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="MyBatisX">MyBatisX</h2><p>MyBatis-Plusä¸ºæˆ‘ä»¬æä¾›äº†å¼ºå¤§çš„mapperå’Œserviceæ¨¡æ¿ï¼Œèƒ½å¤Ÿå¤§å¤§çš„æé«˜å¼€å‘æ•ˆç‡ä½†æ˜¯åœ¨çœŸæ­£å¼€å‘è¿‡ç¨‹ä¸­ï¼ŒMyBatis-Pluså¹¶ä¸èƒ½ä¸ºæˆ‘ä»¬è§£å†³æ‰€æœ‰é—®é¢˜ï¼Œä¾‹å¦‚ä¸€äº›å¤æ‚çš„SQLï¼Œå¤šè¡¨è”æŸ¥ï¼Œæˆ‘ä»¬å°±éœ€è¦è‡ªå·±å»ç¼–å†™ä»£ç å’ŒSQLè¯­å¥ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å¿«é€Ÿçš„è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨MyBatisXæ’ä»¶ã€‚<span class='p green'>MyBatisXæ’ä»¶å¯ä»¥æ ¹æ®æ–¹æ³•åç”Ÿæˆæ˜ å°„æ–‡ä»¶é‡Œçš„SQLè¯­å¥ã€‚</span></p><p>MyBatisXæ’ä»¶ç”¨æ³•ï¼š<a href="https://baomidou.com/pages/ba5b24/">https://baomidou.com/pages/ba5b24/</a></p><p>åŠŸèƒ½</p><div class="tabs" id="0e604186-f6b6-4d7c-86c8-e16f914a3c48"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#0e604186-f6b6-4d7c-86c8-e16f914a3c48-1"><i class="fas fa-cat"></i>xmlè·³è½¬</button></li><li class="tab"><button type="button" data-href="#0e604186-f6b6-4d7c-86c8-e16f914a3c48-2"><i class="fas fa-horse"></i>ç”Ÿæˆä»£ç </button></li><li class="tab"><button type="button" data-href="#0e604186-f6b6-4d7c-86c8-e16f914a3c48-3"><i class="fas fa-dove"></i>ç”Ÿæˆæ–°å¢</button></li><li class="tab"><button type="button" data-href="#0e604186-f6b6-4d7c-86c8-e16f914a3c48-4"><i class="fas fa-dragon"></i>ç”ŸæˆæŸ¥è¯¢</button></li><li class="tab"><button type="button" data-href="#0e604186-f6b6-4d7c-86c8-e16f914a3c48-5"><i class="fas fa-heartbeat"></i>ç”Ÿæˆä¿®æ”¹</button></li><li class="tab"><button type="button" data-href="#0e604186-f6b6-4d7c-86c8-e16f914a3c48-6"><i class="fas fa-cookie-bite"></i>ç”Ÿæˆåˆ é™¤</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="0e604186-f6b6-4d7c-86c8-e16f914a3c48-1"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/mybatisx-jump.gif" alt="è·³è½¬"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0e604186-f6b6-4d7c-86c8-e16f914a3c48-2"><p><strong>(éœ€å…ˆåœ¨ idea é…ç½® Database é…ç½®æ•°æ®æº)</strong></p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/mybatisx-generate.gif" alt="ç”Ÿæˆä»£ç "></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0e604186-f6b6-4d7c-86c8-e16f914a3c48-3"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/mybatisx-tip-insert.gif" alt="ç”Ÿæˆæ–°å¢"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0e604186-f6b6-4d7c-86c8-e16f914a3c48-4"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/mybatisx-tip-select.gif" alt="ç”ŸæˆæŸ¥è¯¢"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0e604186-f6b6-4d7c-86c8-e16f914a3c48-5"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/mybatisx-tip-update.gif" alt="ç”Ÿæˆä¿®æ”¹"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0e604186-f6b6-4d7c-86c8-e16f914a3c48-6"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/mybatisx-tip-delete.gif" alt="ç”Ÿæˆåˆ é™¤"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>]]></content>
    
    
    <summary type="html">MyBatisPlusä½¿ç”¨</summary>
    
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="MyBatisPlus" scheme="https://wuwawawa.github.io/tags/MyBatisPlus/"/>
    
  </entry>
  
  <entry>
    <title>ä»£ç†æ¨¡å¼</title>
    <link href="https://wuwawawa.github.io/posts/7b510e10.html"/>
    <id>https://wuwawawa.github.io/posts/7b510e10.html</id>
    <published>2023-05-26T05:25:16.000Z</published>
    <updated>2023-05-31T06:50:25.080Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2><p>ç”±äºæŸäº›åŸå› éœ€è¦ç»™æŸå¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†ä»¥æ§åˆ¶å¯¹è¯¥å¯¹è±¡çš„è®¿é—®ã€‚è¿™æ—¶ï¼Œè®¿é—®å¯¹è±¡ä¸é€‚åˆæˆ–è€…ä¸èƒ½ç›´æ¥å¼•ç”¨ç›®æ ‡å¯¹è±¡ï¼Œä»£ç†å¯¹è±¡ä½œä¸ºè®¿é—®å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡ä¹‹é—´çš„ä¸­ä»‹ã€‚</p><p>Javaä¸­çš„ä»£ç†æŒ‰ç…§ä»£ç†ç±»ç”Ÿæˆæ—¶æœºä¸åŒåˆåˆ†ä¸º<code>é™æ€ä»£ç†</code>å’Œ<code>åŠ¨æ€ä»£ç†</code>ã€‚é™æ€ä»£ç†ä»£ç†ç±»åœ¨ç¼–è¯‘æœŸå°±ç”Ÿæˆï¼Œè€ŒåŠ¨æ€ä»£ç†ä»£ç†ç±»åˆ™æ˜¯åœ¨Javaè¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆã€‚åŠ¨æ€ä»£ç†åˆæœ‰<code>JDKä»£ç†</code>å’Œ<code>CGLibä»£ç†</code>ä¸¤ç§ã€‚</p><p>ç›¸æ¯”äºé™æ€ä»£ç†æ¥è¯´ï¼ŒåŠ¨æ€ä»£ç†æ›´åŠ çµæ´»ã€‚æˆ‘ä»¬ä¸éœ€è¦é’ˆå¯¹æ¯ä¸ªç›®æ ‡ç±»éƒ½å•ç‹¬åˆ›å»ºä¸€ä¸ªä»£ç†ç±»ï¼Œå¹¶ä¸”ä¹Ÿä¸éœ€è¦æˆ‘ä»¬å¿…é¡»å®ç°æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä»£ç†å®ç°ç±»( CGLIB åŠ¨æ€ä»£ç†æœºåˆ¶)ã€‚</p><p>ä» JVM è§’åº¦æ¥è¯´ï¼ŒåŠ¨æ€ä»£ç†æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆç±»å­—èŠ‚ç ï¼Œå¹¶åŠ è½½åˆ° JVM ä¸­çš„ã€‚</p><p>è¯´åˆ°åŠ¨æ€ä»£ç†ï¼ŒSpring AOPã€RPC æ¡†æ¶åº”è¯¥æ˜¯ä¸¤ä¸ªä¸å¾—ä¸æçš„ï¼Œå®ƒä»¬çš„å®ç°éƒ½ä¾èµ–äº†åŠ¨æ€ä»£ç†ã€‚</p><p>åŠ¨æ€ä»£ç†åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ä½¿ç”¨çš„ç›¸å¯¹è¾ƒå°‘ï¼Œä½†æ˜¯åœ¨æ¡†æ¶ä¸­çš„å‡ ä¹æ˜¯å¿…ç”¨çš„ä¸€é—¨æŠ€æœ¯ã€‚å­¦ä¼šäº†åŠ¨æ€ä»£ç†ä¹‹åï¼Œå¯¹äºæˆ‘ä»¬ç†è§£å’Œå­¦ä¹ å„ç§æ¡†æ¶çš„åŸç†ä¹Ÿéå¸¸æœ‰å¸®åŠ©ã€‚</p><p>å°± Java æ¥è¯´ï¼ŒåŠ¨æ€ä»£ç†çš„å®ç°æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚ JDK åŠ¨æ€ä»£ç†ã€CGLIB åŠ¨æ€ä»£ç†ç­‰ç­‰ã€‚</p><hr><hr><h2 id="ç»“æ„">ç»“æ„</h2><p>ä»£ç†ï¼ˆProxyï¼‰æ¨¡å¼åˆ†ä¸ºä¸‰ç§è§’è‰²ï¼š</p><ul><li>æŠ½è±¡ä¸»é¢˜ï¼ˆSubjectï¼‰ç±»ï¼š é€šè¿‡æ¥å£æˆ–æŠ½è±¡ç±»å£°æ˜çœŸå®ä¸»é¢˜å’Œä»£ç†å¯¹è±¡å®ç°çš„ä¸šåŠ¡æ–¹æ³•ã€‚</li><li>çœŸå®ä¸»é¢˜ï¼ˆReal Subjectï¼‰ç±»ï¼š å®ç°äº†æŠ½è±¡ä¸»é¢˜ä¸­çš„å…·ä½“ä¸šåŠ¡ï¼Œæ˜¯ä»£ç†å¯¹è±¡æ‰€ä»£è¡¨çš„çœŸå®å¯¹è±¡ï¼Œæ˜¯æœ€ç»ˆè¦å¼•ç”¨çš„å¯¹è±¡ã€‚</li><li>ä»£ç†ï¼ˆProxyï¼‰ç±» ï¼š æä¾›äº†ä¸çœŸå®ä¸»é¢˜ç›¸åŒçš„æ¥å£ï¼Œå…¶å†…éƒ¨å«æœ‰å¯¹çœŸå®ä¸»é¢˜çš„å¼•ç”¨ï¼Œå®ƒå¯ä»¥è®¿é—®ã€æ§åˆ¶æˆ–æ‰©å±•çœŸå®ä¸»é¢˜çš„åŠŸèƒ½ã€‚</li></ul><hr><hr><h2 id="é™æ€ä»£ç†">é™æ€ä»£ç†</h2><p>é™æ€ä»£ç†ä¸­ï¼Œæˆ‘ä»¬å¯¹ç›®æ ‡å¯¹è±¡çš„æ¯ä¸ªæ–¹æ³•çš„å¢å¼ºéƒ½æ˜¯æ‰‹åŠ¨å®Œæˆçš„ï¼Œéå¸¸ä¸çµæ´»ï¼ˆæ¯”å¦‚æ¥å£ä¸€æ—¦æ–°å¢åŠ æ–¹æ³•ï¼Œç›®æ ‡å¯¹è±¡å’Œä»£ç†å¯¹è±¡éƒ½è¦è¿›è¡Œä¿®æ”¹ï¼‰ä¸”éº»çƒ¦(éœ€è¦å¯¹æ¯ä¸ªç›®æ ‡ç±»éƒ½å•ç‹¬å†™ä¸€ä¸ªä»£ç†ç±»ï¼‰ã€‚å®é™…åº”ç”¨åœºæ™¯éå¸¸éå¸¸å°‘ï¼Œæ—¥å¸¸å¼€å‘å‡ ä¹çœ‹ä¸åˆ°ä½¿ç”¨é™æ€ä»£ç†çš„åœºæ™¯ã€‚</p><p>ä¸Šé¢æˆ‘ä»¬æ˜¯ä»å®ç°å’Œåº”ç”¨è§’åº¦æ¥è¯´çš„é™æ€ä»£ç†ï¼Œä» JVM å±‚é¢æ¥è¯´ï¼Œ é™æ€ä»£ç†åœ¨ç¼–è¯‘æ—¶å°±å°†æ¥å£ã€å®ç°ç±»ã€ä»£ç†ç±»è¿™äº›éƒ½å˜æˆäº†ä¸€ä¸ªä¸ªå®é™…çš„ class æ–‡ä»¶ã€‚</p><p>é™æ€ä»£ç†å®ç°æ­¥éª¤:</p><ul><li><p>å®šä¹‰ä¸€ä¸ªæ¥å£åŠå…¶å®ç°ç±»ï¼›</p></li><li><p>åˆ›å»ºä¸€ä¸ªä»£ç†ç±»åŒæ ·å®ç°è¿™ä¸ªæ¥å£</p></li><li><p>å°†ç›®æ ‡å¯¹è±¡æ³¨å…¥è¿›ä»£ç†ç±»ï¼Œç„¶ååœ¨ä»£ç†ç±»çš„å¯¹åº”æ–¹æ³•è°ƒç”¨ç›®æ ‡ç±»ä¸­çš„å¯¹åº”æ–¹æ³•ã€‚è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä»£ç†ç±»å±è”½å¯¹ç›®æ ‡å¯¹è±¡çš„è®¿é—®ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œå‰ååšä¸€äº›è‡ªå·±æƒ³åšçš„äº‹æƒ…ã€‚</p></li></ul><p>æˆ‘ä»¬é€šè¿‡æ¡ˆä¾‹æ¥æ„Ÿå—ä¸€ä¸‹é™æ€ä»£ç†ã€‚</p><p>ã€ä¾‹ã€‘ç«è½¦ç«™å–ç¥¨</p><p>å¦‚æœè¦ä¹°ç«è½¦ç¥¨çš„è¯ï¼Œéœ€è¦å»ç«è½¦ç«™ä¹°ç¥¨ï¼Œåè½¦åˆ°ç«è½¦ç«™ï¼Œæ’é˜Ÿç­‰ä¸€ç³»åˆ—çš„æ“ä½œï¼Œæ˜¾ç„¶æ¯”è¾ƒéº»çƒ¦ã€‚è€Œç«è½¦ç«™åœ¨å¤šä¸ªåœ°æ–¹éƒ½æœ‰ä»£å”®ç‚¹ï¼Œæˆ‘ä»¬å»ä»£å”®ç‚¹ä¹°ç¥¨å°±æ–¹ä¾¿å¾ˆå¤šäº†ã€‚è¿™ä¸ªä¾‹å­å…¶å®å°±æ˜¯å…¸å‹çš„ä»£ç†æ¨¡å¼ï¼Œç«è½¦ç«™æ˜¯ç›®æ ‡å¯¹è±¡ï¼Œä»£å”®ç‚¹æ˜¯ä»£ç†å¯¹è±¡ã€‚ç±»å›¾å¦‚ä¸‹ï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86.png" alt="é™æ€ä»£ç†" style="zoom:80%;" /><div class="tabs" id="859270a0-7fac-4da2-8445-fb689759324d"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#859270a0-7fac-4da2-8445-fb689759324d-1"><i class="fas fa-seedling"></i>å–ç¥¨æ¥å£</button></li><li class="tab"><button type="button" data-href="#859270a0-7fac-4da2-8445-fb689759324d-2"><i class="fas fa-leaf"></i>ç«è½¦ç«™</button></li><li class="tab"><button type="button" data-href="#859270a0-7fac-4da2-8445-fb689759324d-3"><i class="fab fa-apple"></i>ä»£å”®ç‚¹</button></li><li class="tab"><button type="button" data-href="#859270a0-7fac-4da2-8445-fb689759324d-4"><i class="fas fa-tree"></i>Client</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="859270a0-7fac-4da2-8445-fb689759324d-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SellTickets</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">sell</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="859270a0-7fac-4da2-8445-fb689759324d-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç«è½¦ç«™å…·æœ‰å–ç¥¨åŠŸèƒ½ï¼Œæ‰€ä»¥éœ€è¦å®ç°SellTicketsæ¥å£</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TrainStation</span> <span class="keyword">implements</span> <span class="title class_">SellTickets</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sell</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç«è½¦ç«™å–ç¥¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="859270a0-7fac-4da2-8445-fb689759324d-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProxyPoint</span> <span class="keyword">implements</span> <span class="title class_">SellTickets</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">TrainStation</span> <span class="variable">station</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrainStation</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sell</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ä»£ç†ç‚¹æ”¶å–ä¸€äº›æœåŠ¡è´¹ç”¨&quot;</span>);</span><br><span class="line">        station.sell();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="859270a0-7fac-4da2-8445-fb689759324d-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ProxyPoint</span> <span class="variable">pp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProxyPoint</span>();</span><br><span class="line">        pp.sell();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>ä»ä¸Šé¢ä»£ç ä¸­å¯ä»¥çœ‹å‡ºæµ‹è¯•ç±»ç›´æ¥è®¿é—®çš„æ˜¯ProxyPointç±»å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´ProxyPointä½œä¸ºè®¿é—®å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡çš„ä¸­ä»‹ã€‚åŒæ—¶ä¹Ÿå¯¹sellæ–¹æ³•è¿›è¡Œäº†å¢å¼ºï¼ˆä»£ç†ç‚¹æ”¶å–ä¸€äº›æœåŠ¡è´¹ç”¨ï¼‰ã€‚</p><hr><hr><h2 id="JDKåŠ¨æ€ä»£ç†">JDKåŠ¨æ€ä»£ç†</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨åŠ¨æ€ä»£ç†å®ç°ä¸Šé¢æ¡ˆä¾‹ï¼Œå…ˆè¯´è¯´JDKæä¾›çš„åŠ¨æ€ä»£ç†ã€‚Javaä¸­æä¾›äº†ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»Proxyï¼ŒProxyå¹¶ä¸æ˜¯æˆ‘ä»¬ä¸Šè¿°æ‰€è¯´çš„ä»£ç†å¯¹è±¡çš„ç±»ï¼Œè€Œæ˜¯æä¾›äº†ä¸€ä¸ªåˆ›å»ºä»£ç†å¯¹è±¡çš„é™æ€æ–¹æ³•ï¼ˆnewProxyInstanceæ–¹æ³•ï¼‰æ¥è·å–ä»£ç†å¯¹è±¡ã€‚</p><p>javaåŠ¨æ€ä»£ç†æœºåˆ¶ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„ç±»å’Œæ¥å£ï¼š<code>InvocationHandler</code>å’Œ<code>Proxy</code>ï¼Œè¿™ä¸€ä¸ªç±»Proxyå’Œæ¥å£InvocationHandleræ˜¯æˆ‘ä»¬å®ç°åŠ¨æ€ä»£ç†çš„æ ¸å¿ƒ</p><hr><h3 id="InvocationHandler">InvocationHandler</h3><p>æ¯ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»çš„è°ƒç”¨å¤„ç†ç¨‹åºéƒ½å¿…é¡»å®ç°<code>InvocationHandleræ¥å£</code>ï¼Œå¹¶ä¸”æ¯ä¸ªä»£ç†ç±»çš„å®ä¾‹éƒ½å…³è”åˆ°äº†å®ç°è¯¥æ¥å£çš„åŠ¨æ€ä»£ç†ç±»è°ƒç”¨å¤„ç†ç¨‹åºä¸­ï¼Œå½“æˆ‘ä»¬é€šè¿‡åŠ¨æ€ä»£ç†å¯¹è±¡è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶å€™ï¼Œè¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨å°±ä¼šè¢«è½¬å‘åˆ°å®ç°InvocationHandleræ¥å£ç±»çš„invokeæ–¹æ³•æ¥è°ƒç”¨ï¼Œçœ‹å¦‚ä¸‹invokeæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * proxy:ä»£ç†ç±»ä»£ç†çš„çœŸå®ä»£ç†å¯¹è±¡com.sun.proxy.$Proxy0</span></span><br><span class="line"><span class="comment">     * method:æˆ‘ä»¬æ‰€è¦è°ƒç”¨æŸä¸ªå¯¹è±¡çœŸå®çš„æ–¹æ³•çš„Methodå¯¹è±¡</span></span><br><span class="line"><span class="comment">     * args:æŒ‡ä»£ä»£ç†å¯¹è±¡æ–¹æ³•ä¼ é€’çš„å‚æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span><br><span class="line">            <span class="keyword">throws</span> Throwable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="Proxy">Proxy</h3><p>Proxyç±»å°±æ˜¯ç”¨æ¥åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡çš„ç±»ï¼Œå®ƒæä¾›äº†å¾ˆå¤šæ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬æœ€å¸¸ç”¨çš„æ˜¯newProxyInstanceæ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">newProxyInstance</span><span class="params">(ClassLoader loader, </span></span><br><span class="line"><span class="params">                                        Class&lt;?&gt;[] interfaces, </span></span><br><span class="line"><span class="params">                                        InvocationHandler h)</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯åˆ›å»ºä¸€ä¸ªä»£ç†ç±»å¯¹è±¡ï¼Œå®ƒæ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å‡ ä¸ªå‚æ•°çš„å«ä¹‰ï¼š</p><ul><li>loaderï¼šä¸€ä¸ªclassloaderå¯¹è±¡ï¼Œå®šä¹‰äº†ç”±å“ªä¸ªclassloaderå¯¹è±¡å¯¹ç”Ÿæˆçš„ä»£ç†ç±»è¿›è¡ŒåŠ è½½</li><li>interfacesï¼šä¸€ä¸ªinterfaceå¯¹è±¡æ•°ç»„ï¼Œè¡¨ç¤ºæˆ‘ä»¬å°†è¦ç»™æˆ‘ä»¬çš„ä»£ç†å¯¹è±¡æä¾›ä¸€ç»„ä»€ä¹ˆæ ·çš„æ¥å£ï¼Œå¦‚æœæˆ‘ä»¬æä¾›äº†è¿™æ ·ä¸€ä¸ªæ¥å£å¯¹è±¡æ•°ç»„ï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯å£°æ˜äº†ä»£ç†ç±»å®ç°äº†è¿™äº›æ¥å£ï¼Œä»£ç†ç±»å°±å¯ä»¥è°ƒç”¨æ¥å£ä¸­å£°æ˜çš„æ‰€æœ‰æ–¹æ³•ã€‚</li><li>hï¼šä¸€ä¸ªInvocationHandlerå¯¹è±¡ï¼Œè¡¨ç¤ºçš„æ˜¯å½“åŠ¨æ€ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•çš„æ—¶å€™ä¼šå…³è”åˆ°å“ªä¸€ä¸ªInvocationHandlerå¯¹è±¡ä¸Šï¼Œå¹¶æœ€ç»ˆç”±å…¶è°ƒç”¨ã€‚</li></ul><blockquote><p>newProxyInstanceæ–¹æ³•ï¼ˆçœç•¥ç‰ˆï¼‰</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">newProxyInstance</span><span class="params">(ClassLoader loader,</span></span><br><span class="line"><span class="params">                                       Class&lt;?&gt;[] interfaces,</span></span><br><span class="line"><span class="params">                                       InvocationHandler h)</span> &#123;</span><br><span class="line">     <span class="comment">//æ£€æŸ¥hå‚æ•°æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™æŠ›å‡ºNullPointerExceptionå¼‚å¸¸ã€‚</span></span><br><span class="line">     Objects.requireNonNull(h);</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//åˆ›å»ºä¸€ä¸ªinterfacesæ•°ç»„çš„å…‹éš†å‰¯æœ¬ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™intfsã€‚</span></span><br><span class="line">     <span class="keyword">final</span> Class&lt;?&gt;[] intfs = interfaces.clone();</span><br><span class="line"></span><br><span class="line">     <span class="comment">//è°ƒç”¨getProxyClass0æ–¹æ³•ï¼Œæ ¹æ®ç±»åŠ è½½å™¨ï¼ˆloaderï¼‰å’Œæ¥å£æ•°ç»„ï¼ˆintfsï¼‰ç”Ÿæˆæˆ–æŸ¥æ‰¾æŒ‡å®šçš„ä»£ç†ç±»ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™clã€‚</span></span><br><span class="line">     Class&lt;?&gt; cl = getProxyClass0(loader, intfs);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//è·å–ä»£ç†ç±»clçš„æ„é€ å‡½æ•°ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™consã€‚å°†InvocationHandler hèµ‹å€¼ç»™ ihã€‚</span></span><br><span class="line">     <span class="keyword">final</span> Class&lt;?&gt;[] constructorParams =</span><br><span class="line">             &#123; InvocationHandler.class &#125;;</span><br><span class="line">     <span class="keyword">final</span> Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);</span><br><span class="line">     <span class="keyword">final</span> <span class="type">InvocationHandler</span> <span class="variable">ih</span> <span class="operator">=</span> h;</span><br><span class="line">     <span class="comment">//å¦‚æœä»£ç†ç±»clä¸æ˜¯å…¬å¼€çš„ï¼Œé€šè¿‡AccessController.doPrivilegedæ–¹æ³•å°†ä»£ç†ç±»çš„æ„é€ å‡½æ•°è®¾ç½®ä¸ºå¯è®¿é—®ã€‚</span></span><br><span class="line">     <span class="keyword">if</span> (!Modifier.isPublic(cl.getModifiers())) &#123;</span><br><span class="line">         AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>&lt;Void&gt;() &#123;</span><br><span class="line">             <span class="keyword">public</span> Void <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                 cons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                 <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">//é€šè¿‡æ„é€ å‡½æ•°consåˆ›å»ºä»£ç†ç±»çš„å®ä¾‹ï¼Œå¹¶å°†è°ƒç”¨å¤„ç†å™¨hä½œä¸ºå‚æ•°ä¼ é€’ã€‚è¿”å›åˆ›å»ºçš„ä»£ç†å®ä¾‹ã€‚</span></span><br><span class="line">     <span class="keyword">return</span> cons.newInstance(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;h&#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><hr><h3 id="ç¤ºä¾‹">ç¤ºä¾‹</h3><div class="tabs" id="f86f9d87-0b24-463f-9fbb-851a7622ccba"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#f86f9d87-0b24-463f-9fbb-851a7622ccba-1"><i class="fas fa-cat"></i>å–ç¥¨æ¥å£</button></li><li class="tab"><button type="button" data-href="#f86f9d87-0b24-463f-9fbb-851a7622ccba-2"><i class="fas fa-horse"></i>ç«è½¦ç«™</button></li><li class="tab"><button type="button" data-href="#f86f9d87-0b24-463f-9fbb-851a7622ccba-3"><i class="fas fa-dove"></i>ä»£ç†å·¥å‚</button></li><li class="tab"><button type="button" data-href="#f86f9d87-0b24-463f-9fbb-851a7622ccba-4"><i class="fas fa-dragon"></i>Client</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="f86f9d87-0b24-463f-9fbb-851a7622ccba-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SellTickets</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">sell</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f86f9d87-0b24-463f-9fbb-851a7622ccba-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç«è½¦ç«™  ç«è½¦ç«™å…·æœ‰å–ç¥¨åŠŸèƒ½ï¼Œæ‰€ä»¥éœ€è¦å®ç°SellTicketsæ¥å£</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TrainStation</span> <span class="keyword">implements</span> <span class="title class_">SellTickets</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sell</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç«è½¦ç«™å–ç¥¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f86f9d87-0b24-463f-9fbb-851a7622ccba-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä»£ç†å·¥å‚ï¼Œç”¨æ¥åˆ›å»ºä»£ç†å¯¹è±¡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProxyFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">TrainStation</span> <span class="variable">station</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrainStation</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SellTickets <span class="title function_">getProxyObject</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//ä½¿ç”¨Proxyè·å–stationä»£ç†å¯¹è±¡</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            newProxyInstance()æ–¹æ³•å‚æ•°è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">                ClassLoader loader ï¼š ç±»åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½ä»£ç†ç±»ï¼Œä½¿ç”¨çœŸå®å¯¹è±¡çš„ç±»åŠ è½½å™¨å³å¯</span></span><br><span class="line"><span class="comment">                Class&lt;?&gt;[] interfaces ï¼š çœŸå®å¯¹è±¡æ‰€å®ç°çš„æ¥å£ï¼Œä»£ç†æ¨¡å¼çœŸå®å¯¹è±¡å’Œä»£ç†å¯¹è±¡å®ç°ç›¸åŒçš„æ¥å£</span></span><br><span class="line"><span class="comment">                InvocationHandler h ï¼š ä»£ç†å¯¹è±¡çš„è°ƒç”¨å¤„ç†ç¨‹åº</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">SellTickets</span> <span class="variable">sellTickets</span> <span class="operator">=</span> (SellTickets) Proxy.newProxyInstance(station.getClass().getClassLoader(),</span><br><span class="line">                station.getClass().getInterfaces(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvocationHandler</span>() &#123;</span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                        InvocationHandlerä¸­invokeæ–¹æ³•å‚æ•°è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">                            proxy ï¼š ä»£ç†å¯¹è±¡</span></span><br><span class="line"><span class="comment">                            method ï¼š å¯¹åº”äºåœ¨ä»£ç†å¯¹è±¡ä¸Šè°ƒç”¨çš„æ¥å£æ–¹æ³•çš„ Method å®ä¾‹</span></span><br><span class="line"><span class="comment">                            args ï¼š ä»£ç†å¯¹è±¡è°ƒç”¨æ¥å£æ–¹æ³•æ—¶ä¼ é€’çš„å®é™…å‚æ•°</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"></span><br><span class="line">                        System.out.println(<span class="string">&quot;ä»£ç†ç‚¹æ”¶å–ä¸€äº›æœåŠ¡è´¹ç”¨(JDKåŠ¨æ€ä»£ç†æ–¹å¼)&quot;</span>);</span><br><span class="line">                        <span class="comment">//åå°„æœºåˆ¶è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•</span></span><br><span class="line">                        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(station, args);</span><br><span class="line">                        <span class="keyword">return</span> result;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="keyword">return</span> sellTickets;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f86f9d87-0b24-463f-9fbb-851a7622ccba-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">        <span class="type">ProxyFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProxyFactory</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="type">SellTickets</span> <span class="variable">proxyObject</span> <span class="operator">=</span> factory.getProxyObject();</span><br><span class="line">        proxyObject.sell();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>ProxyFactoryä¸æ˜¯ä»£ç†æ¨¡å¼ä¸­æ‰€è¯´çš„ä»£ç†ç±»ï¼Œè€Œä»£ç†ç±»æ˜¯ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€çš„åœ¨å†…å­˜ä¸­ç”Ÿæˆçš„ç±»ã€‚é€šè¿‡é˜¿é‡Œå·´å·´å¼€æºçš„ Java è¯Šæ–­å·¥å…·ï¼ˆArthasã€é˜¿å°”è¨æ–¯ã€‘ï¼‰æŸ¥çœ‹ä»£ç†ç±»çš„ç»“æ„ï¼š</p><div class="tabs" id="0f0ce109-dfef-40d9-ba15-7d5dff81d5fb"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#0f0ce109-dfef-40d9-ba15-7d5dff81d5fb-1"><i class="fas fa-atom"></i>é‡ç‚¹éƒ¨åˆ†</button></li><li class="tab"><button type="button" data-href="#0f0ce109-dfef-40d9-ba15-7d5dff81d5fb-2"><i class="far fa-sun"></i>ä»£ç†ç±»å®Œæ•´ä»£ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="0f0ce109-dfef-40d9-ba15-7d5dff81d5fb-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">$Proxy0</span> <span class="keyword">extends</span> <span class="title class_">Proxy</span> <span class="keyword">implements</span> <span class="title class_">SellTickets</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m3;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $Proxy0(InvocationHandler invocationHandler) &#123;</span><br><span class="line">        <span class="built_in">super</span>(invocationHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        m3 = Class.forName(<span class="string">&quot;com.itheima.proxy.dynamic.jdk.SellTickets&quot;</span>).getMethod(<span class="string">&quot;sell&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">sell</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.h.invoke(<span class="built_in">this</span>, m3, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Javaæä¾›çš„åŠ¨æ€ä»£ç†ç›¸å…³ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Proxy</span> <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line"><span class="keyword">protected</span> InvocationHandler h;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">Proxy</span><span class="params">(InvocationHandler h)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.h = h;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0f0ce109-dfef-40d9-ba15-7d5dff81d5fb-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">$Proxy0</span> <span class="keyword">extends</span> <span class="title class_">Proxy</span> <span class="keyword">implements</span> <span class="title class_">SellTickets</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m1;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m2;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m3;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m0;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $Proxy0(InvocationHandler invocationHandler) &#123;</span><br><span class="line">        <span class="built_in">super</span>(invocationHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            m1 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;equals&quot;</span>, Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>));</span><br><span class="line">            m2 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;toString&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]);</span><br><span class="line">            m3 = Class.forName(<span class="string">&quot;com.itheima.proxy.dynamic.jdk.SellTickets&quot;</span>).getMethod(<span class="string">&quot;sell&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]);</span><br><span class="line">            m0 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;hashCode&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchMethodException noSuchMethodException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodError</span>(noSuchMethodException.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (ClassNotFoundException classNotFoundException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoClassDefFoundError</span>(classNotFoundException.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Boolean)<span class="built_in">this</span>.h.invoke(<span class="built_in">this</span>, m1, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;object&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Error | RuntimeException throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> throwable;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UndeclaredThrowableException</span>(throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (String)<span class="built_in">this</span>.h.invoke(<span class="built_in">this</span>, m2, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Error | RuntimeException throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> throwable;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UndeclaredThrowableException</span>(throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Integer)<span class="built_in">this</span>.h.invoke(<span class="built_in">this</span>, m0, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Error | RuntimeException throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> throwable;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UndeclaredThrowableException</span>(throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">sell</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.h.invoke(<span class="built_in">this</span>, m3, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Error | RuntimeException throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> throwable;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UndeclaredThrowableException</span>(throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <p>ä»ä¸Šé¢çš„ç±»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»¥ä¸‹å‡ ä¸ªä¿¡æ¯ï¼š</p><ul><li>ä»£ç†ç±»ï¼ˆ$Proxy0ï¼‰å®ç°äº†SellTicketsã€‚è¿™ä¹Ÿå°±å°è¯äº†æˆ‘ä»¬ä¹‹å‰è¯´çš„çœŸå®ç±»å’Œä»£ç†ç±»å®ç°åŒæ ·çš„æ¥å£ã€‚</li><li>ä»£ç†ç±»ï¼ˆ$Proxy0ï¼‰å°†æˆ‘ä»¬æä¾›äº†çš„åŒ¿åå†…éƒ¨ç±»å¯¹è±¡ï¼ˆInvocationHandler hï¼‰ä¼ é€’ç»™äº†çˆ¶ç±»ã€‚</li></ul><p>æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>åœ¨Clientç±»ä¸­é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨sell()æ–¹æ³•</li><li>æ ¹æ®å¤šæ€çš„ç‰¹æ€§ï¼Œæ‰§è¡Œçš„æ˜¯ä»£ç†ç±»ï¼ˆ$Proxy0ï¼‰ä¸­çš„sell()æ–¹æ³•</li><li>ä»£ç†ç±»ï¼ˆ$Proxy0ï¼‰ä¸­çš„sell()æ–¹æ³•ä¸­åˆè°ƒç”¨äº†InvocationHandleræ¥å£çš„å­å®ç°ç±»å¯¹è±¡çš„invokeæ–¹æ³•</li><li>invokeæ–¹æ³•é€šè¿‡åå°„æ‰§è¡Œäº†çœŸå®å¯¹è±¡æ‰€å±ç±»(TrainStation)ä¸­çš„sell()æ–¹æ³•</li></ol><hr><hr><h2 id="CGLIBåŠ¨æ€ä»£ç†">CGLIBåŠ¨æ€ä»£ç†</h2><ol><li><p>é™æ€ä»£ç†å’Œ JDK ä»£ç†æ¨¡å¼éƒ½è¦æ±‚ç›®æ ‡å¯¹è±¡æ˜¯å®ç°ä¸€ä¸ªæ¥å£,ä½†æ˜¯æœ‰æ—¶å€™ç›®æ ‡å¯¹è±¡åªæ˜¯ä¸€ä¸ªå•ç‹¬çš„å¯¹è±¡,å¹¶æ²¡æœ‰å®ç°ä»»ä½•çš„æ¥å£,è¿™ä¸ªæ—¶å€™å¯ä½¿ç”¨ç›®æ ‡å¯¹è±¡å­ç±»æ¥å®ç°ä»£ç†-è¿™å°±æ˜¯Cglibä»£ç†</p></li><li><p>Cglibä»£ç†ä¹Ÿå«ä½œå­ç±»ä»£ç†,å®ƒæ˜¯åœ¨å†…å­˜ä¸­æ„å»ºä¸€ä¸ªå­ç±»å¯¹è±¡ä»è€Œå®ç°å¯¹ç›®æ ‡å¯¹è±¡åŠŸèƒ½æ‰©å±•, æœ‰äº›ä¹¦ä¹Ÿå°†Cglibä»£ç†å½’å±åˆ°åŠ¨æ€ä»£ç†ã€‚</p></li><li><p>Cglib æ˜¯ä¸€ä¸ªå¼ºå¤§çš„é«˜æ€§èƒ½çš„ä»£ç ç”ŸæˆåŒ…,å®ƒå¯ä»¥åœ¨è¿è¡ŒæœŸæ‰©å±• java ç±»ä¸å®ç° java æ¥å£.å®ƒå¹¿æ³›çš„è¢«è®¸å¤š AOP çš„ æ¡†æ¶ä½¿ç”¨,ä¾‹å¦‚ Spring AOPï¼Œå®ç°æ–¹æ³•æ‹¦æˆª</p></li><li><p>åœ¨ AOP ç¼–ç¨‹ä¸­å¦‚ä½•é€‰æ‹©ä»£ç†æ¨¡å¼ï¼š</p><ul><li><p>ç›®æ ‡å¯¹è±¡éœ€è¦å®ç°æ¥å£ï¼Œç”¨ JDK ä»£ç†</p></li><li><p>ç›®æ ‡å¯¹è±¡ä¸éœ€è¦å®ç°æ¥å£ï¼Œç”¨ Cglib ä»£ç†</p></li></ul></li><li><p>Cglib åŒ…çš„åº•å±‚æ˜¯é€šè¿‡ä½¿ç”¨å­—èŠ‚ç å¤„ç†æ¡†æ¶ ASM æ¥è½¬æ¢å­—èŠ‚ç å¹¶ç”Ÿæˆæ–°çš„ç±»</p></li><li><p>éœ€è¦å¼•å…¥ cglib çš„ jar æ–‡ä»¶ï¼Œåœ¨å†…å­˜ä¸­åŠ¨æ€æ„å»ºå­ç±»ï¼Œæ³¨æ„ä»£ç†çš„ç±»ä¸èƒ½ä¸º finalï¼Œå¦åˆ™æŠ¥é”™ï¼Œç›®æ ‡å¯¹è±¡çš„æ–¹æ³•å¦‚æœä¸º final/static,é‚£ä¹ˆå°±ä¸ä¼šè¢«æ‹¦æˆª,å³ä¸ä¼šæ‰§è¡Œç›®æ ‡å¯¹è±¡é¢å¤–çš„ä¸šåŠ¡æ–¹æ³•.</p></li><li><p>CGLIBä¹Ÿè¦æ±‚ä»£ç†å¯¹è±¡å¿…é¡»è¦å®ç°<code>MethodInterceptor</code>æ¥å£ï¼Œå¹¶é‡å†™å…¶å”¯ä¸€çš„æ–¹æ³•<code>intercept</code>ã€‚</p></li></ol><hr><h3 id="MethodInterceptor">MethodInterceptor</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MethodInterceptor</span> <span class="keyword">extends</span> <span class="title class_">Callback</span> &#123;</span><br><span class="line">    Object <span class="title function_">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>objï¼šåŠ¨æ€ç”Ÿæˆçš„ä»£ç†å¯¹è±¡</p><p>method:å®é™…è°ƒç”¨çš„æ–¹æ³•</p><p>argsï¼šè°ƒç”¨æ–¹æ³•å…¥å‚</p><p>MethodProxyï¼šjava Methodç±»çš„ä»£ç†ç±»ï¼Œå¯ä»¥å®ç°å§”æ‰˜ç±»å¯¹è±¡çš„æ–¹æ³•çš„è°ƒç”¨ï¼›å¸¸ç”¨æ–¹æ³•ï¼šmethodProxy.invokeSuper(proxy, args)ï¼›åœ¨æ‹¦æˆªæ–¹æ³•å†…å¯ä»¥è°ƒç”¨å¤šæ¬¡ã€‚</p><hr><h3 id="ç¤ºä¾‹-2">ç¤ºä¾‹</h3><p>åŒæ ·æ˜¯ä¸Šé¢çš„æ¡ˆä¾‹ï¼Œæˆ‘ä»¬å†æ¬¡ä½¿ç”¨CGLIBä»£ç†å®ç°ã€‚</p><p>å¦‚æœæ²¡æœ‰å®šä¹‰SellTicketsæ¥å£ï¼Œåªå®šä¹‰äº†TrainStation(ç«è½¦ç«™ç±»)ã€‚å¾ˆæ˜¾ç„¶JDKä»£ç†æ˜¯æ— æ³•ä½¿ç”¨äº†ï¼Œå› ä¸ºJDKåŠ¨æ€ä»£ç†è¦æ±‚å¿…é¡»å®šä¹‰æ¥å£ï¼Œå¯¹æ¥å£è¿›è¡Œä»£ç†ã€‚</p><div class="tabs" id="259db4f6-6212-454f-8612-62e6d5e96892"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#259db4f6-6212-454f-8612-62e6d5e96892-1"><i class="fas fa-bug"></i>å¼•å…¥ä¾èµ–</button></li><li class="tab"><button type="button" data-href="#259db4f6-6212-454f-8612-62e6d5e96892-2"><i class="fas fa-cannabis"></i>ç«è½¦ç«™</button></li><li class="tab"><button type="button" data-href="#259db4f6-6212-454f-8612-62e6d5e96892-3"><i class="fas fa-candy-cane"></i>ä»£ç†å·¥å‚</button></li><li class="tab"><button type="button" data-href="#259db4f6-6212-454f-8612-62e6d5e96892-4"><i class="fas fa-child"></i>Client</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="259db4f6-6212-454f-8612-62e6d5e96892-1"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cglib<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cglib<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="259db4f6-6212-454f-8612-62e6d5e96892-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TrainStation</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sell</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç«è½¦ç«™å–ç¥¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="259db4f6-6212-454f-8612-62e6d5e96892-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProxyFactory</span> <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">TrainStation</span> <span class="variable">target</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrainStation</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> TrainStation <span class="title function_">getProxyObject</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºEnhancerå¯¹è±¡ï¼Œç±»ä¼¼äºJDKåŠ¨æ€ä»£ç†çš„Proxyç±»ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯è®¾ç½®å‡ ä¸ªå‚æ•°</span></span><br><span class="line">        <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">        <span class="comment">//è®¾ç½®çˆ¶ç±»çš„å­—èŠ‚ç å¯¹è±¡</span></span><br><span class="line">        enhancer.setSuperclass(target.getClass());</span><br><span class="line">        <span class="comment">//è®¾ç½®å›è°ƒå‡½æ•°</span></span><br><span class="line">        enhancer.setCallback(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">//åˆ›å»ºä»£ç†å¯¹è±¡</span></span><br><span class="line">        <span class="type">TrainStation</span> <span class="variable">obj</span> <span class="operator">=</span> (TrainStation) enhancer.create();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        interceptæ–¹æ³•å‚æ•°è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">            o ï¼š ä»£ç†å¯¹è±¡</span></span><br><span class="line"><span class="comment">            method ï¼š çœŸå®å¯¹è±¡ä¸­çš„æ–¹æ³•çš„Methodå®ä¾‹</span></span><br><span class="line"><span class="comment">            args ï¼š å®é™…å‚æ•°</span></span><br><span class="line"><span class="comment">            methodProxy ï¼šä»£ç†å¯¹è±¡ä¸­çš„æ–¹æ³•çš„methodå®ä¾‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> TrainStation <span class="title function_">intercept</span><span class="params">(Object o, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ä»£ç†ç‚¹æ”¶å–ä¸€äº›æœåŠ¡è´¹ç”¨(CGLIBåŠ¨æ€ä»£ç†æ–¹å¼)&quot;</span>);</span><br><span class="line">        <span class="type">TrainStation</span> <span class="variable">result</span> <span class="operator">=</span> (TrainStation) methodProxy.invokeSuper(o, args);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="259db4f6-6212-454f-8612-62e6d5e96892-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºä»£ç†å·¥å‚å¯¹è±¡</span></span><br><span class="line">        <span class="type">ProxyFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProxyFactory</span>();</span><br><span class="line">        <span class="comment">//è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">        <span class="type">TrainStation</span> <span class="variable">proxyObject</span> <span class="operator">=</span> factory.getProxyObject();</span><br><span class="line"></span><br><span class="line">        proxyObject.sell();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="ä¸‰ç§ä»£ç†æ¨¡å¼å¯¹æ¯”">ä¸‰ç§ä»£ç†æ¨¡å¼å¯¹æ¯”</h2><blockquote><p>JDKä»£ç†å’ŒCGLIBä»£ç†</p></blockquote><p>ä½¿ç”¨CGLibå®ç°åŠ¨æ€ä»£ç†ï¼ŒCGLibåº•å±‚é‡‡ç”¨ASMå­—èŠ‚ç ç”Ÿæˆæ¡†æ¶ï¼Œä½¿ç”¨å­—èŠ‚ç æŠ€æœ¯ç”Ÿæˆä»£ç†ç±»ï¼Œåœ¨JDK1.6ä¹‹å‰æ¯”ä½¿ç”¨Javaåå°„æ•ˆç‡è¦é«˜ã€‚å”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCGLibä¸èƒ½å¯¹å£°æ˜ä¸ºfinalçš„ç±»æˆ–è€…æ–¹æ³•è¿›è¡Œä»£ç†ï¼Œå› ä¸ºCGLibåŸç†æ˜¯åŠ¨æ€ç”Ÿæˆè¢«ä»£ç†ç±»çš„å­ç±»ã€‚</p><p>åœ¨JDK1.6ã€JDK1.7ã€JDK1.8é€æ­¥å¯¹JDKåŠ¨æ€ä»£ç†ä¼˜åŒ–ä¹‹åï¼Œåœ¨è°ƒç”¨æ¬¡æ•°è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼ŒJDKä»£ç†æ•ˆç‡é«˜äºCGLibä»£ç†æ•ˆç‡ï¼Œåªæœ‰å½“è¿›è¡Œå¤§é‡è°ƒç”¨çš„æ—¶å€™ï¼ŒJDK1.6å’ŒJDK1.7æ¯”CGLibä»£ç†æ•ˆç‡ä½ä¸€ç‚¹ï¼Œä½†æ˜¯åˆ°JDK1.8çš„æ—¶å€™ï¼ŒJDKä»£ç†æ•ˆç‡é«˜äºCGLibä»£ç†ã€‚æ‰€ä»¥å¦‚æœæœ‰æ¥å£ä½¿ç”¨JDKåŠ¨æ€ä»£ç†ï¼Œå¦‚æœæ²¡æœ‰æ¥å£ä½¿ç”¨CGLIBä»£ç†ã€‚</p><p>JDKåŠ¨æ€ä»£ç†ï¼šéœ€è¦è¢«ä»£ç†å¯¹è±¡çš„ç±»å®ç°äº†æŸäº›æ¥å£ï¼ˆæ²¡æœ‰å®ç°ç±»ä¹Ÿèƒ½ä»£ç†ï¼‰ï¼Œç”Ÿæˆçš„ä»£ç†ç±»ä¹Ÿä¼šå®ç°ç›¸åº”çš„æ¥å£</p><p>CGLIBåŠ¨æ€ä»£ç†ï¼šä¸éœ€è¦è¢«ä»£ç†å¯¹è±¡çš„ç±»å®ç°äº†æŸäº›æ¥å£ï¼Œç”Ÿæˆçš„ä»£ç†ç±»ä¸ºç›®æ ‡å¯¹è±¡çš„ç±»çš„å­ç±»</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/14eb2dd78bac59281c7c84f291bdfb1b.png" alt="åŠ¨æ€ä»£ç†â€”â€”JDKåŠ¨æ€ä»£ç†åŸç†&amp;ç¤ºä¾‹è§£æï¼ˆå›¾æ–‡å¹¶èŒ‚ï¼‰"></p><blockquote><p>åŠ¨æ€ä»£ç†å’Œé™æ€ä»£ç†</p></blockquote><p>åŠ¨æ€ä»£ç†ä¸é™æ€ä»£ç†ç›¸æ¯”è¾ƒï¼Œæœ€å¤§çš„å¥½å¤„æ˜¯æ¥å£ä¸­å£°æ˜çš„æ‰€æœ‰æ–¹æ³•éƒ½è¢«è½¬ç§»åˆ°è°ƒç”¨å¤„ç†å™¨ä¸€ä¸ªé›†ä¸­çš„æ–¹æ³•ä¸­å¤„ç†ï¼ˆInvocationHandler.invokeï¼‰ã€‚è¿™æ ·ï¼Œåœ¨æ¥å£æ–¹æ³•æ•°é‡æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œçµæ´»å¤„ç†ï¼Œè€Œä¸éœ€è¦åƒé™æ€ä»£ç†é‚£æ ·æ¯ä¸€ä¸ªæ–¹æ³•è¿›è¡Œä¸­è½¬ã€‚</p><p>å¦‚æœæ¥å£å¢åŠ ä¸€ä¸ªæ–¹æ³•ï¼Œé™æ€ä»£ç†æ¨¡å¼é™¤äº†æ‰€æœ‰å®ç°ç±»éœ€è¦å®ç°è¿™ä¸ªæ–¹æ³•å¤–ï¼Œæ‰€æœ‰ä»£ç†ç±»ä¹Ÿéœ€è¦å®ç°æ­¤æ–¹æ³•ã€‚å¢åŠ äº†ä»£ç ç»´æŠ¤çš„å¤æ‚åº¦ã€‚è€ŒåŠ¨æ€ä»£ç†ä¸ä¼šå‡ºç°è¯¥é—®é¢˜</p><blockquote><p>ä¼˜ç¼ºç‚¹</p></blockquote><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>ä»£ç†æ¨¡å¼åœ¨å®¢æˆ·ç«¯ä¸ç›®æ ‡å¯¹è±¡ä¹‹é—´èµ·åˆ°ä¸€ä¸ªä¸­ä»‹ä½œç”¨å’Œä¿æŠ¤ç›®æ ‡å¯¹è±¡çš„ä½œç”¨ï¼›</li><li>ä»£ç†å¯¹è±¡å¯ä»¥æ‰©å±•ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½ï¼›</li><li>ä»£ç†æ¨¡å¼èƒ½å°†å®¢æˆ·ç«¯ä¸ç›®æ ‡å¯¹è±¡åˆ†ç¦»ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šé™ä½äº†ç³»ç»Ÿçš„è€¦åˆåº¦ï¼›</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li>å¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚åº¦ï¼›</li></ul><hr><hr><h2 id="JDKåŠ¨æ€ä»£ç†è¡¥å……">JDKåŠ¨æ€ä»£ç†è¡¥å……</h2><p>JDKä»£ç†ï¼Œä»£ç†çš„æ˜¯æ¥å£ï¼Œæ—¢ç„¶ä»£ç†çš„æ˜¯æ¥å£ï¼Œé‚£å¦‚æœæ²¡æœ‰å®ç°ç±»æ€ä¹ˆåŠï¼Œèƒ½ä¸èƒ½ä»£ç†ã€‚ç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼ŒMybatiså°±æ˜¯è¿™æ ·çš„ã€‚</p><p>Mybatisä½¿ç”¨JDKåŠ¨æ€ä»£ç†æ¥å®ç°Mapperæ¥å£ï¼Œäº‹å…ˆä¿å­˜å¥½Mapperæ¥å£ï¼Œå’Œæ¥å£å£°æ˜çš„æ–¹æ³•ï¼Œè¿”å›å€¼ï¼Œå‚æ•°ç±»å‹ï¼Œç„¶åä»£ç†ç±»çš„æ–¹æ³•è°ƒç”¨çš„æ—¶å€™ä½¿ç”¨MapperMethodè¿™ä¸ªäº‹å…ˆæ”¾å…¥æ–¹æ³•ç¼“å­˜é‡Œçš„å¯¹è±¡æ¥çœŸå®è°ƒç”¨åŠŸèƒ½ã€‚</p><blockquote><p>ä¾‹å­</p></blockquote><div class="tabs" id="c5d0f5d3-10a8-409d-b70f-b260ae6e9bb1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c5d0f5d3-10a8-409d-b70f-b260ae6e9bb1-1"><i class="fas fa-cat"></i>è¢«ä»£ç†çš„æ¥å£</button></li><li class="tab"><button type="button" data-href="#c5d0f5d3-10a8-409d-b70f-b260ae6e9bb1-2"><i class="fas fa-horse"></i>ä»£ç†å¯¹è±¡</button></li><li class="tab"><button type="button" data-href="#c5d0f5d3-10a8-409d-b70f-b260ae6e9bb1-3"><i class="fas fa-dove"></i>æµ‹è¯•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c5d0f5d3-10a8-409d-b70f-b260ae6e9bb1-1"><p>è¿™ä¸ªæ¥å£å¯ä»¥çœ‹æˆæ˜¯Mapperæ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    User <span class="title function_">selectById</span><span class="params">(<span class="type">int</span> id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c5d0f5d3-10a8-409d-b70f-b260ae6e9bb1-2"><p>è¿™ä¸ªä»£ç†ç±»ä½¿ç”¨äº†æ³›å‹ï¼Œè¯´æ˜è¿™ä¸ªä»£ç†ç±»å¯ä»¥ä»£ç†æ‰€æœ‰çš„mapperæ¥å£ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapperProxyFactory</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Class&lt;T&gt; proxyInterface;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MapperProxyFactory</span><span class="params">(Class&lt;T&gt; proxyInterface)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.proxyInterface = proxyInterface;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;selectById&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//è·å–å‚æ•°</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> (<span class="type">int</span>) args[<span class="number">0</span>];</span><br><span class="line">            <span class="comment">//å‡è£…è¿›è¡Œäº†æŸ¥è¯¢</span></span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(id, <span class="string">&quot;111&quot;</span>, <span class="string">&quot;222&quot;</span>, <span class="number">11</span>, <span class="string">&quot;ç”·&quot;</span>, <span class="string">&quot;test@qq.com&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;selectByIdè°ƒç”¨æˆåŠŸ&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> user;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getProxy</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(proxyInterface.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;proxyInterface&#125;,<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c5d0f5d3-10a8-409d-b70f-b260ae6e9bb1-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    MapperProxyFactory&lt;UserMapper&gt; mapperFactory = <span class="keyword">new</span> <span class="title class_">MapperProxyFactory</span>&lt;&gt;(UserMapper.class);</span><br><span class="line">    <span class="type">UserMapper</span> <span class="variable">userMapper</span> <span class="operator">=</span> mapperFactory.getProxy();</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectById(<span class="number">1</span>);</span><br><span class="line">    System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">selectByIdè°ƒç”¨æˆåŠŸ</span><br><span class="line">User&#123;<span class="built_in">id</span>=1, username=<span class="string">&#x27;111&#x27;</span>, password=<span class="string">&#x27;222&#x27;</span>, age=11, sex=<span class="string">&#x27;ç”·&#x27;</span>, email=<span class="string">&#x27;test@qq.com&#x27;</span>&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><blockquote><p>ä½¿ç”¨é˜¿å°”è¨æ–¯ç”ŸæˆMapperæ¥å£çš„ä»£ç†å¯¹è±¡</p></blockquote><div class="tabs" id="6f4aa4a4-1ec9-4df4-8bd7-254808a5e2b4"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6f4aa4a4-1ec9-4df4-8bd7-254808a5e2b4-1"><i class="fas fa-cat"></i>Mapperæ¥å£</button></li><li class="tab"><button type="button" data-href="#6f4aa4a4-1ec9-4df4-8bd7-254808a5e2b4-2"><i class="fas fa-horse"></i>ä»£ç†å¯¹è±¡ï¼ˆçœç•¥ç‰ˆï¼‰</button></li><li class="tab"><button type="button" data-href="#6f4aa4a4-1ec9-4df4-8bd7-254808a5e2b4-3"><i class="fas fa-dove"></i>ä»£ç†å¯¹è±¡ï¼ˆå®Œæ•´ç‰ˆï¼‰</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6f4aa4a4-1ec9-4df4-8bd7-254808a5e2b4-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®idæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    User <span class="title function_">getUserById</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> Integer id)</span> <span class="keyword">throws</span> Throwable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6f4aa4a4-1ec9-4df4-8bd7-254808a5e2b4-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">$Proxy7</span></span><br><span class="line">        <span class="keyword">extends</span> <span class="title class_">Proxy</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m3;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> User <span class="title function_">getUserById</span><span class="params">(Integer n)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">return</span> (User) <span class="built_in">this</span>.h.invoke(<span class="built_in">this</span>, m3, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;n&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $Proxy7(InvocationHandler invocationHandler) &#123;</span><br><span class="line">        <span class="built_in">super</span>(invocationHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            m3 = Class.forName(<span class="string">&quot;com.atguigu.mybatis.mapper.UserMapper&quot;</span>).getMethod(<span class="string">&quot;getUserById&quot;</span>, Class.forName(<span class="string">&quot;java.lang.Integer&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Proxy</span> <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line">    <span class="keyword">protected</span> InvocationHandler h;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">Proxy</span><span class="params">(InvocationHandler h)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.h = h;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6f4aa4a4-1ec9-4df4-8bd7-254808a5e2b4-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sun.proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.mybatis.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.mybatis.pojo.User;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.UndeclaredThrowableException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">$Proxy7</span></span><br><span class="line"><span class="keyword">extends</span> <span class="title class_">Proxy</span></span><br><span class="line"><span class="keyword">implements</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m1;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m2;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m3;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m0;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> User <span class="title function_">getUserById</span><span class="params">(Integer n)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (User)<span class="built_in">this</span>.h.invoke(<span class="built_in">this</span>, m3, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;n&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Error | RuntimeException throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> throwable;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UndeclaredThrowableException</span>(throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $Proxy7(InvocationHandler invocationHandler) &#123;</span><br><span class="line">        <span class="built_in">super</span>(invocationHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            m1 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;equals&quot;</span>, Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>));</span><br><span class="line">            m2 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;toString&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]);</span><br><span class="line">            m3 = Class.forName(<span class="string">&quot;com.atguigu.mybatis.mapper.UserMapper&quot;</span>).getMethod(<span class="string">&quot;getUserById&quot;</span>, Class.forName(<span class="string">&quot;java.lang.Integer&quot;</span>));</span><br><span class="line">            m0 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;hashCode&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchMethodException noSuchMethodException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodError</span>(noSuchMethodException.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (ClassNotFoundException classNotFoundException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoClassDefFoundError</span>(classNotFoundException.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Boolean)<span class="built_in">this</span>.h.invoke(<span class="built_in">this</span>, m1, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;object&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Error | RuntimeException throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> throwable;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UndeclaredThrowableException</span>(throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (String)<span class="built_in">this</span>.h.invoke(<span class="built_in">this</span>, m2, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Error | RuntimeException throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> throwable;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UndeclaredThrowableException</span>(throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Integer)<span class="built_in">this</span>.h.invoke(<span class="built_in">this</span>, m0, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Error | RuntimeException throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> throwable;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UndeclaredThrowableException</span>(throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>Javaä¸­InvocationHandleræ¥å£ä¸­ç¬¬ä¸€ä¸ªå‚æ•°proxyè¯¦è§£</p><p><a href="https://blog.csdn.net/yaomingyang/article/details/81040390">https://blog.csdn.net/yaomingyang/article/details/81040390</a></p>]]></content>
    
    
    <summary type="html">é™æ€ä»£ç†ã€åŠ¨æ€ä»£ç†ã€cglibä»£ç†ã€åŸç†è§£æ</summary>
    
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="https://wuwawawa.github.io/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="https://wuwawawa.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>MyBatisæºç è§£æ</title>
    <link href="https://wuwawawa.github.io/posts/acfac54a.html"/>
    <id>https://wuwawawa.github.io/posts/acfac54a.html</id>
    <published>2023-05-25T03:27:31.000Z</published>
    <updated>2023-05-31T14:38:52.356Z</updated>
    
    <content type="html"><![CDATA[<table><thead><tr><th style="text-align:left">åŒ…å</th><th style="text-align:left">åŒ…ä½œç”¨</th></tr></thead><tbody><tr><td style="text-align:left"><code>annotations</code></td><td style="text-align:left">åœ¨mapperæ¥å£ä¸­ä½¿ç”¨çš„æ‰€æœ‰æ³¨è§£</td></tr><tr><td style="text-align:left"><code>binding</code></td><td style="text-align:left">å°†mapperæ¥å£å’Œæ˜ å°„è¯­å¥è¿›è¡Œå…³è”</td></tr><tr><td style="text-align:left"><code>builder</code></td><td style="text-align:left">é…ç½®æ„å»ºåŒ…ï¼Œé€šè¿‡xmlå’Œæ³¨è§£æ„å»ºconfiguration</td></tr><tr><td style="text-align:left"><code>cache</code></td><td style="text-align:left">ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜å¤„ç†</td></tr><tr><td style="text-align:left"><code>cursor</code></td><td style="text-align:left">æ¸¸æ ‡å¤„ç†ç›¸å…³ï¼Œå¯ä»¥å¤„ç†å¤„ç†ç™¾ä¸‡çº§åˆ«çš„æ•°æ®</td></tr><tr><td style="text-align:left"><code>datasource</code></td><td style="text-align:left">æ•°æ®æºç›¸å…³</td></tr><tr><td style="text-align:left"><code>exceptions</code></td><td style="text-align:left">å¼‚å¸¸æœºåˆ¶</td></tr><tr><td style="text-align:left"><code>io</code></td><td style="text-align:left">è¯»å–æ•°æ®æºçš„IOå·¥å…·ç±»</td></tr><tr><td style="text-align:left"><code>jdbc</code></td><td style="text-align:left">JDBCçš„å·¥å…·ç±»</td></tr><tr><td style="text-align:left"><code>logging</code></td><td style="text-align:left">æ—¥å¿—ç›¸å…³</td></tr><tr><td style="text-align:left"><code>mapping</code></td><td style="text-align:left">æ˜ å°„ç›¸å…³</td></tr><tr><td style="text-align:left"><code>parsing</code></td><td style="text-align:left">è§£æé…ç½®ç›¸å…³</td></tr><tr><td style="text-align:left"><code>plugin</code></td><td style="text-align:left">æ’ä»¶ç›¸å…³</td></tr><tr><td style="text-align:left"><code>reflection</code></td><td style="text-align:left">åå°„ç›¸å…³</td></tr><tr><td style="text-align:left"><code>session</code></td><td style="text-align:left">ä¼šè¯ç›¸å…³</td></tr><tr><td style="text-align:left"><code>transaction</code></td><td style="text-align:left">äº‹ç‰©ç›¸å…³</td></tr></tbody></table><h2 id="MyBatisæ ¸å¿ƒç»„ä»¶">MyBatisæ ¸å¿ƒç»„ä»¶</h2><p>åœ¨è§£è¯»æºç ä¹‹å‰ï¼Œæˆ‘ä»¬å¾ˆæœ‰å¿…è¦å…ˆäº†è§£ MyBatis ä¸ƒå¤§æ ¸å¿ƒç»„ä»¶ï¼ŒçŸ¥é“ä»–ä»¬éƒ½æ˜¯åšä»€ä¹ˆç”¨çš„ã€‚</p><p>æ ¸å¿ƒç»„ä»¶æœ‰ï¼šConfigurationã€SqlSessionã€Executorã€StatementHandlerã€ParameterHandlerã€TypeHandlerã€ResultSethandlerã€‚</p><p>ä¸‹é¢ç®€å•ä»‹ç»ä¸€ä¸‹ä»–ä»¬ï¼š</p><div class="tabs" id="5a861bcc-7dc7-4511-b5f3-5ebcfe19c8be"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#5a861bcc-7dc7-4511-b5f3-5ebcfe19c8be-1"><i class="fas fa-seedling"></i>1</button></li><li class="tab"><button type="button" data-href="#5a861bcc-7dc7-4511-b5f3-5ebcfe19c8be-2"><i class="fas fa-leaf"></i>2</button></li><li class="tab"><button type="button" data-href="#5a861bcc-7dc7-4511-b5f3-5ebcfe19c8be-3"><i class="fab fa-apple"></i>3</button></li><li class="tab"><button type="button" data-href="#5a861bcc-7dc7-4511-b5f3-5ebcfe19c8be-4"><i class="fas fa-tree"></i>4</button></li><li class="tab"><button type="button" data-href="#5a861bcc-7dc7-4511-b5f3-5ebcfe19c8be-5"><i class="fas fa-cat"></i>5</button></li><li class="tab"><button type="button" data-href="#5a861bcc-7dc7-4511-b5f3-5ebcfe19c8be-6"><i class="fas fa-horse"></i>6</button></li><li class="tab"><button type="button" data-href="#5a861bcc-7dc7-4511-b5f3-5ebcfe19c8be-7"><i class="fas fa-dove"></i>7</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="5a861bcc-7dc7-4511-b5f3-5ebcfe19c8be-1"><p><mark class="hl-label blue">SqlSession</mark></p><p>å®ƒåŒ…å«äº†æ‰€æœ‰æ‰§è¡Œè¯­å¥ã€æäº¤æˆ–å›æ»šäº‹åŠ¡ä»¥åŠè·å–æ˜ å°„å™¨å®ä¾‹çš„æ–¹æ³•ã€‚</p><p>SqlSessionæ˜¯MyBatisæä¾›çš„é¢å‘ç”¨æˆ·çš„APIï¼Œè¡¨ç¤ºå’Œæ•°æ®åº“äº¤äº’æ—¶çš„ä¼šè¯å¯¹è±¡ï¼Œç”¨äºå®Œæˆæ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥åŠŸèƒ½ã€‚SqlSessionæ˜¯Executorç»„ä»¶çš„å¤–è§‚ï¼Œç›®çš„æ˜¯å¯¹å¤–æä¾›æ˜“äºç†è§£å’Œä½¿ç”¨çš„æ•°æ®åº“æ“ä½œæ¥å£ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5a861bcc-7dc7-4511-b5f3-5ebcfe19c8be-2"><p><mark class="hl-label green">Configuration</mark></p><p>ç”¨äºæè¿° MyBatis ä¸»é…ç½®æ–‡ä»¶ä¿¡æ¯ï¼ŒMyBatis æ¡†æ¶åœ¨å¯åŠ¨æ—¶ä¼šåŠ è½½ä¸»é…ç½®æ–‡ä»¶ï¼Œå°†é…ç½®ä¿¡æ¯è½¬æ¢ä¸º Configuration å¯¹è±¡ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼ŒMyBatisåœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼Œå°†Mapperé…ç½®ä¿¡æ¯ã€ç±»å‹åˆ«åã€TypeHandlerç­‰æ³¨å†Œåˆ°Configurationç»„ä»¶ä¸­ï¼Œå…¶ä»–ç»„ä»¶éœ€è¦è¿™äº›ä¿¡æ¯æ—¶ï¼Œä¹Ÿå¯ä»¥ä»Configurationå¯¹è±¡ä¸­è·å–ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5a861bcc-7dc7-4511-b5f3-5ebcfe19c8be-3"><p><mark class="hl-label blue">Executor</mark></p><p>SQL æ‰§è¡Œå™¨ï¼Œç”¨äºå’Œæ•°æ®åº“äº¤äº’ã€‚SqlSession å¯ä»¥ç†è§£ä¸º Executor ç»„ä»¶çš„å¤–è§‚ï¼ˆå¤–è§‚æ¨¡å¼ï¼‰ï¼ŒçœŸæ­£æ‰§è¡Œ SQL çš„æ˜¯ Executor ç»„ä»¶ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1617638902287-25c47fa7-93ad-4e39-84e2-2905756c61e5.png" alt="image.png" style="zoom: 50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5a861bcc-7dc7-4511-b5f3-5ebcfe19c8be-4"><p><mark class="hl-label green">StatementHandler</mark></p><p>StatementHandlerç»„ä»¶å°è£…äº†å¯¹JDBC Statementçš„æ“ä½œï¼Œä¾‹å¦‚è®¾ç½®Statementå¯¹è±¡çš„fetchSizeå±æ€§ã€è®¾ç½®æŸ¥è¯¢è¶…æ—¶æ—¶é—´ã€è°ƒç”¨JDBC Statementä¸æ•°æ®åº“äº¤äº’ç­‰ã€‚</p><p>ä¸‹é¢æ˜¯StatementHandlerçš„ä¸‰ä¸ªå®ç°ç±»</p><p>SimpleStatementHandler ï¼šå°è£…äº†JDBCçš„ Statement å¯¹è±¡</p><p>PreparedStatementHandlerï¼šå°è£…äº†JDBCçš„ PreparedStatement å¯¹è±¡ ï¼ˆå¯æ·»åŠ sqlå‚æ•°ï¼‰</p><p>CallableStatementHandlerï¼šå°è£…äº†JDBCçš„ CallableStatement å¯¹è±¡</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5a861bcc-7dc7-4511-b5f3-5ebcfe19c8be-5"><p><mark class="hl-label blue">ParameterHandler</mark></p><p>ç”¨äºå¤„ç† SQL ä¸­çš„å‚æ•°å ä½ç¬¦ï¼Œä¸ºå‚æ•°å ä½ç¬¦è®¾ç½®å€¼ã€‚</p><p>å½“MyBatisæ¡†æ¶ä½¿ç”¨çš„Statementç±»å‹ä¸ºCallableStatementå’ŒPreparedStatementæ—¶ï¼ŒParameterHandlerç”¨äºä¸ºStatementå¯¹è±¡å‚æ•°å ä½ç¬¦è®¾ç½®å€¼ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5a861bcc-7dc7-4511-b5f3-5ebcfe19c8be-6"><p><mark class="hl-label green">TypeHandler</mark></p><p>ç±»å‹å¤„ç†å™¨ï¼Œç”¨äº Java ç±»å‹ä¸ JDBC ç±»å‹ä¹‹é—´çš„è½¬æ¢ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5a861bcc-7dc7-4511-b5f3-5ebcfe19c8be-7"><p><mark class="hl-label blue">ResultSetHandler</mark></p><p>å°è£…äº†å¯¹ ResultSet å¯¹è±¡çš„å¤„ç†é€»è¾‘ï¼Œå°†ç»“æœé›†è½¬æ¢ä¸º Java å®ä½“å¯¹è±¡ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>SqlSessionç»„ä»¶ï¼Œå®ƒæ˜¯ç”¨æˆ·å±‚é¢çš„APIã€‚ç”¨æˆ·å¯åˆ©ç”¨ SqlSession è·å–æƒ³è¦çš„ Mapper å¯¹è±¡ï¼ˆMapperProxy ä»£ç†å¯¹è±¡ï¼‰ï¼›å½“æ‰§è¡Œ Mapper çš„æ–¹æ³•ï¼ŒMapperProxy ä¼šåˆ›å»ºå¯¹åº”çš„ MapperMetohdï¼Œç„¶å MapperMethod åº•å±‚å…¶å®æ˜¯åˆ©ç”¨ SqlSession æ¥æ‰§è¡Œ SQLã€‚</p><p>ä½†æ˜¯çœŸæ­£æ‰§è¡Œ SQL æ“ä½œçš„åº”è¯¥æ˜¯ Executorç»„ä»¶ï¼ŒExecutor å¯ä»¥ç†è§£ä¸º SQLæ‰§è¡Œå™¨ï¼Œå®ƒä¼šä½¿ç”¨ StatementHandler ç»„ä»¶å¯¹ JDBC çš„ Statement å¯¹è±¡è¿›è¡Œæ“ä½œã€‚å½“ Statement ç±»å‹ä¸º CallableStatement å’Œ PreparedStatement æ—¶ï¼Œä¼šé€šè¿‡ ParameterHandler ç»„ä»¶ä¸ºå‚æ•°å ä½ç¬¦èµ‹å€¼ã€‚</p><p>ParameterHandler ç»„ä»¶ä¸­ä¼šæ ¹æ® Java ç±»å‹æ‰¾åˆ°å¯¹åº”çš„ TypeHandler å¯¹è±¡ï¼ŒTypeHandler ä¸­ä¼šé€šè¿‡ Statement å¯¹è±¡æä¾›çš„ setXXX() æ–¹æ³•ï¼ˆä¾‹å¦‚setString()æ–¹æ³•ï¼‰ä¸º Statement å¯¹è±¡ä¸­çš„å‚æ•°å ä½ç¬¦è®¾ç½®å€¼ã€‚</p><p>StatementHandler ç»„ä»¶ä½¿ç”¨ JDBC ä¸­çš„ Statement å¯¹è±¡ä¸æ•°æ®åº“å®Œæˆäº¤äº’åï¼Œå½“ SQL è¯­å¥ç±»å‹ä¸º SELECT æ—¶ï¼ŒMyBatis é€šè¿‡ ResultSetHandler ç»„ä»¶ä» Statement å¯¹è±¡ä¸­è·å– ResultSet å¯¹è±¡ï¼Œç„¶åå°† ResultSet å¯¹è±¡è½¬æ¢ä¸º Java å¯¹è±¡ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ç”¨ä¸€å¹…å›¾æ¥æè¿°ä¸Šé¢å„ä¸ªæ ¸å¿ƒç»„ä»¶ä¹‹é—´çš„å…³ç³»ï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1617635030060-035d7ee6-b901-4e3f-9797-5397c7453508.png" alt="image.png" style="zoom:67%;" /><hr><hr><h2 id="MyBatiså¯åŠ¨ä»£ç ">MyBatiså¯åŠ¨ä»£ç </h2><p>ä½¿ç”¨mybatisçš„éƒ¨åˆ†ä»£ç ï¼ŒåŒ…æ‹¬ä¸ƒæ­¥ã€‚æ¯æ­¥è™½ç„¶éƒ½æ˜¯ä¸€è¡Œä»£ç ï¼Œä½†æ˜¯éšè—äº†å¾ˆå¤šç»†èŠ‚ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†å›´ç»•è¿™ä¸ƒæ­¥å±•å¼€äº†è§£ã€‚</p><div class="tabs" id="81ce6ac1-b903-44eb-a267-8101c100e87c"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#81ce6ac1-b903-44eb-a267-8101c100e87c-1"><i class="fas fa-seedling"></i>å¯åŠ¨ä»£ç </button></li><li class="tab"><button type="button" data-href="#81ce6ac1-b903-44eb-a267-8101c100e87c-2"><i class="fas fa-leaf"></i>mybatis-config.xml</button></li><li class="tab"><button type="button" data-href="#81ce6ac1-b903-44eb-a267-8101c100e87c-3"><i class="fab fa-apple"></i>UserMapper</button></li><li class="tab"><button type="button" data-href="#81ce6ac1-b903-44eb-a267-8101c100e87c-4"><i class="fas fa-tree"></i>UserMapper.xml</button></li><li class="tab"><button type="button" data-href="#81ce6ac1-b903-44eb-a267-8101c100e87c-5"><i class="fas fa-heartbeat"></i>User</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="81ce6ac1-b903-44eb-a267-8101c100e87c-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1. è¯»å–é…ç½®</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(<span class="string">&quot;mybatis-config.xml&quot;</span>);</span><br><span class="line">        <span class="comment">// 2. åˆ›å»ºSqlSessionFactoryå·¥å‚</span></span><br><span class="line">        <span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(inputStream);</span><br><span class="line">        <span class="comment">// 3. è·å–sqlSession</span></span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> sqlSessionFactory.openSession();</span><br><span class="line">        <span class="comment">// 4. è·å–Mapper</span></span><br><span class="line">        <span class="type">UserMapper</span> <span class="variable">userMapper</span> <span class="operator">=</span> sqlSession.getMapper(UserMapper.class);</span><br><span class="line">        <span class="comment">// 5. æ‰§è¡Œæ¥å£æ–¹æ³•</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">userInfo</span> <span class="operator">=</span> userMapper.getUserById(<span class="number">1</span>);</span><br><span class="line">        System.out.println(userInfo);</span><br><span class="line">        <span class="comment">// 6. æäº¤äº‹ç‰©</span></span><br><span class="line">        sqlSession.commit();</span><br><span class="line">        <span class="comment">// 7. å…³é—­èµ„æº</span></span><br><span class="line">        sqlSession.close();</span><br><span class="line">        inputStream.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        log.error(e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="81ce6ac1-b903-44eb-a267-8101c100e87c-2"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">&quot;jdbc.properties&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.atguigu.mybatis.pojo&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.atguigu.mybatis.mapper&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="81ce6ac1-b903-44eb-a267-8101c100e87c-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®idæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    User <span class="title function_">getUserById</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> Integer id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="81ce6ac1-b903-44eb-a267-8101c100e87c-4"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.atguigu.mybatis.mapper.UserMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;BaseResultMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;INTEGER&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;username&quot;</span> <span class="attr">property</span>=<span class="string">&quot;username&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;VARCHAR&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;password&quot;</span> <span class="attr">property</span>=<span class="string">&quot;password&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;VARCHAR&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;age&quot;</span> <span class="attr">property</span>=<span class="string">&quot;age&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;INTEGER&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;sex&quot;</span> <span class="attr">property</span>=<span class="string">&quot;sex&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;VARCHAR&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;email&quot;</span> <span class="attr">property</span>=<span class="string">&quot;email&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;VARCHAR&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;Base_Column_List&quot;</span>&gt;</span></span><br><span class="line">        id, username, password, age, sex, email</span><br><span class="line">    <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--User getUserById(@Param(&quot;id&quot;) Integer id);--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getUserById&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;BaseResultMap&quot;</span>&gt;</span></span><br><span class="line">        select<span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;Base_Column_List&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">        from t_user</span><br><span class="line">        where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="81ce6ac1-b903-44eb-a267-8101c100e87c-5"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="1-è¯»å–é…ç½®">1.è¯»å–é…ç½®</h2><p><code>InputStream inputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</code></p><p>åœ¨<code>mybatis-config.xml</code>ä¸­æˆ‘ä»¬é…ç½®äº†å±æ€§ï¼Œç¯å¢ƒï¼Œæ˜ å°„æ–‡ä»¶è·¯å¾„ç­‰ï¼Œå…¶å®ä¸ä»…å¯ä»¥é…ç½®ä»¥ä¸Šå†…å®¹ï¼Œè¿˜å¯ä»¥é…ç½®æ’ä»¶ï¼Œåå°„å·¥å‚ï¼Œç±»å‹å¤„ç†å™¨ç­‰ç­‰å…¶å®ƒå†…å®¹ã€‚åœ¨å¯åŠ¨æµç¨‹ä¸­çš„ç¬¬ä¸€æ­¥æˆ‘ä»¬å°±éœ€è¦è¯»å–è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œå¹¶è·å–ä¸€ä¸ªè¾“å…¥æµä¸ºä¸‹ä¸€æ­¥è§£æé…ç½®æ–‡ä»¶ä½œå‡†å¤‡ã€‚</p><hr><hr><h2 id="2-åˆ›å»ºSqlSessionFactoryå·¥å‚">2.åˆ›å»ºSqlSessionFactoryå·¥å‚</h2><p><code>SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);</code></p><p>åœ¨ Mybatis ä¸­ï¼Œæ¯ä¸€ä¸ªåº”ç”¨éƒ½æ˜¯åŸºäº<code>SqlSessionFactory</code>ä¸ºæ ¸å¿ƒã€‚SqlSessionFactory çš„å®ä¾‹å¯ä»¥é€šè¿‡ SqlSessionFactoryBuilder è·å¾—ã€‚è€Œ SqlSessionFactoryBuilder åˆ™å¯ä»¥ä» XML é…ç½®æ–‡ä»¶æˆ–ä¸€ä¸ªé¢„å…ˆé…ç½®çš„ Configuration å®ä¾‹æ¥æ„å»ºå‡º SqlSessionFactory å®ä¾‹ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1624267923708-cfabfb25-50a2-4da9-8342-205800c8afc3.png" alt="image.png" style="zoom: 60%;" /><hr><h3 id="SqlSessionFactoryå’ŒSqlSession">SqlSessionFactoryå’ŒSqlSession</h3><p>SqlSessionFactoryå·¥å‚æ˜¯ä¸ºäº†åˆ›å»ºä¸€ä¸ªå¯¹è±¡è€Œç”Ÿçš„ï¼Œå…¶äº§å‡ºçš„å¯¹è±¡å°±æ˜¯SqlSessionå¯¹è±¡ã€‚</p><p>SqlSessionFactoryBuilderçš„build()æ–¹æ³•ä½¿ç”¨å»ºé€ è€…æ¨¡å¼åˆ›å»ºäº†SqlSessionFactoryæ¥å£å¯¹è±¡ã€‚<span class='p green'>SqlSessionFactoryæ¥å£çš„é»˜è®¤å®ç°æ˜¯DefaultSqlSessionFactoryã€‚</span><span class='p blue'>SqlSessionæ¥å£çš„é»˜è®¤å®ç°åˆ™æ˜¯DefaultSqlSessionã€‚</span>SqlSessionFactoryä½¿ç”¨å®ä¾‹å·¥å‚æ¨¡å¼æ¥åˆ›å»ºSqlSessionå¯¹è±¡ã€‚</p><p>SqlSessionæ˜¯é«˜çº§æ¥å£ï¼Œç±»ä¼¼äºJDBCæ“ä½œçš„connectionå¯¹è±¡ï¼Œå®ƒåŒ…è£…äº†æ•°æ®åº“è¿æ¥ï¼Œé€šè¿‡è¿™ä¸ªæ¥å£æˆ‘ä»¬å¯ä»¥å®ç°å¢åˆ æ”¹æŸ¥ï¼Œæäº¤/å›æ»šäº‹ç‰©ï¼Œå…³é—­è¿æ¥ï¼Œè·å–ä»£ç†ç±»ç­‰æ“ä½œã€‚SqlSessionæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è‡ªå·±å”¯ä¸€çš„SqlSessionï¼Œä¸åŒçº¿ç¨‹é—´è°ƒç”¨åŒä¸€ä¸ªSqlSessionä¼šå‡ºç°é—®é¢˜ï¼Œå› æ­¤åœ¨ä½¿ç”¨å®Œåéœ€è¦closeæ‰ã€‚</p><p>ä¸‹é¢åˆ—å‡ºäº†SqlSessionFactoryå’ŒSqlSessionçš„ä¸»è¦æ–¹æ³•ï¼Œä¸€äº›é‡è½½çš„æ–¹æ³•å°±è¿‡æ»¤æ‰äº†ã€‚</p><div class="tabs" id="e3b840d3-52a0-4f80-b193-eb707bc2dada"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e3b840d3-52a0-4f80-b193-eb707bc2dada-1"><i class="fas fa-cat"></i>SqlSessionFactory</button></li><li class="tab"><button type="button" data-href="#e3b840d3-52a0-4f80-b193-eb707bc2dada-2"><i class="fas fa-horse"></i>SqlSession</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e3b840d3-52a0-4f80-b193-eb707bc2dada-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SqlSessionFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">  SqlSession <span class="title function_">openSession</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">  SqlSession <span class="title function_">openSession</span><span class="params">(<span class="type">boolean</span> autoCommit)</span>;</span><br><span class="line"></span><br><span class="line">  SqlSession <span class="title function_">openSession</span><span class="params">(Connection connection)</span>;</span><br><span class="line"></span><br><span class="line">  SqlSession <span class="title function_">openSession</span><span class="params">(TransactionIsolationLevel level)</span>;</span><br><span class="line"></span><br><span class="line">  SqlSession <span class="title function_">openSession</span><span class="params">(ExecutorType execType)</span>;</span><br><span class="line"></span><br><span class="line">  SqlSession <span class="title function_">openSession</span><span class="params">(ExecutorType execType, <span class="type">boolean</span> autoCommit)</span>;</span><br><span class="line"></span><br><span class="line">  SqlSession <span class="title function_">openSession</span><span class="params">(ExecutorType execType, TransactionIsolationLevel level)</span>;</span><br><span class="line"></span><br><span class="line">  SqlSession <span class="title function_">openSession</span><span class="params">(ExecutorType execType, Connection connection)</span>;</span><br><span class="line"></span><br><span class="line">  Configuration <span class="title function_">getConfiguration</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e3b840d3-52a0-4f80-b193-eb707bc2dada-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SqlSession</span> <span class="keyword">extends</span> <span class="title class_">Closeable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * æŸ¥è¯¢ä¸€ä¸ªç»“æœå¯¹è±¡</span></span><br><span class="line"><span class="comment">  **/</span> </span><br><span class="line">  &lt;T&gt; T <span class="title function_">selectOne</span><span class="params">(String statement, Object parameter)</span>;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * æŸ¥è¯¢ä¸€ä¸ªç»“æœé›†åˆ</span></span><br><span class="line"><span class="comment">  **/</span> </span><br><span class="line">  &lt;E&gt; List&lt;E&gt; <span class="title function_">selectList</span><span class="params">(String statement, Object parameter, RowBounds rowBounds)</span>;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * æŸ¥è¯¢ä¸€ä¸ªmap</span></span><br><span class="line"><span class="comment">  **/</span> </span><br><span class="line">  &lt;K, V&gt; Map&lt;K, V&gt; <span class="title function_">selectMap</span><span class="params">(String statement, Object parameter, String mapKey, RowBounds rowBounds)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * æŸ¥è¯¢æ¸¸æ ‡</span></span><br><span class="line"><span class="comment">  **/</span> </span><br><span class="line">  &lt;T&gt; Cursor&lt;T&gt; <span class="title function_">selectCursor</span><span class="params">(String statement, Object parameter, RowBounds rowBounds)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">select</span><span class="params">(String statement, Object parameter, RowBounds rowBounds, ResultHandler handler)</span>;</span><br><span class="line">  </span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * æ’å…¥</span></span><br><span class="line"><span class="comment">  **/</span> </span><br><span class="line">  <span class="type">int</span> <span class="title function_">insert</span><span class="params">(String statement, Object parameter)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * ä¿®æ”¹</span></span><br><span class="line"><span class="comment">  **/</span> </span><br><span class="line">  <span class="type">int</span> <span class="title function_">update</span><span class="params">(String statement, Object parameter)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * åˆ é™¤</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  <span class="type">int</span> <span class="title function_">delete</span><span class="params">(String statement, Object parameter)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * æäº¤äº‹ç‰©</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(<span class="type">boolean</span> force)</span>;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * å›æ»šäº‹ç‰©</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">rollback</span><span class="params">(<span class="type">boolean</span> force)</span>;</span><br><span class="line"></span><br><span class="line">  List&lt;BatchResult&gt; <span class="title function_">flushStatements</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">clearCache</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">  Configuration <span class="title function_">getConfiguration</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * è·å–æ˜ å°„ä»£ç†ç±»</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  &lt;T&gt; T <span class="title function_">getMapper</span><span class="params">(Class&lt;T&gt; type)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * è·å–æ•°æ®åº“è¿æ¥</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  Connection <span class="title function_">getConnection</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="æ ¸å¿ƒæºç â­ï¸">æ ¸å¿ƒæºç â­ï¸</h3><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230531101220358.png" alt="image-20230531101220358" style="zoom:67%;" /><p>é€šè¿‡æºç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°SqlSessionFactoryBuilderé€šè¿‡XMLConfigBuilderå»è§£ææˆ‘ä»¬ä¼ å…¥çš„mybatisçš„é…ç½®æ–‡ä»¶ï¼Œæ„é€ å‡ºConfigurationï¼Œæœ€ç»ˆè¿”å›new DefaultSqlSessionFactory(config)çš„SqlSessionFactoryå®ä¾‹ã€‚</p><div class="tabs" id="9842058c-f078-42b2-a3be-991f253c7169"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#9842058c-f078-42b2-a3be-991f253c7169-1"><i class="fas fa-atom"></i>1</button></li><li class="tab"><button type="button" data-href="#9842058c-f078-42b2-a3be-991f253c7169-2"><i class="far fa-sun"></i>2</button></li><li class="tab"><button type="button" data-href="#9842058c-f078-42b2-a3be-991f253c7169-3"><i class="fas fa-wind"></i>3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="9842058c-f078-42b2-a3be-991f253c7169-1"><p><mark class="hl-label blue">SqlSessionFactoryBuilder#build</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SqlSessionFactory <span class="title function_">build</span><span class="params">(InputStream inputStream, String environment, Properties properties)</span> &#123;</span><br><span class="line">    <span class="type">XMLConfigBuilder</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLConfigBuilder</span>(inputStream, environment, properties);</span><br><span class="line">    <span class="keyword">return</span> build(parser.parse());<span class="comment">//è·³è½¬2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> SqlSessionFactory <span class="title function_">build</span><span class="params">(Configuration config)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultSqlSessionFactory</span>(config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9842058c-f078-42b2-a3be-991f253c7169-2"><p><mark class="hl-label green">XMLConfigBuilder#parse</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Configuration <span class="title function_">parse</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (parsed) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Each XMLConfigBuilder can only be used once.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  parsed = <span class="literal">true</span>;</span><br><span class="line">  parseConfiguration(parser.evalNode(<span class="string">&quot;/configuration&quot;</span>));<span class="comment">//è·³è½¬3</span></span><br><span class="line">  <span class="keyword">return</span> configuration;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9842058c-f078-42b2-a3be-991f253c7169-3"><p><mark class="hl-label blue">XMLConfigBuilder#parseConfiguration</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">parseConfiguration</span><span class="params">(XNode root)</span> &#123;</span><br><span class="line">    propertiesElement(root.evalNode(<span class="string">&quot;properties&quot;</span>));</span><br><span class="line">    <span class="type">Properties</span> <span class="variable">settings</span> <span class="operator">=</span> settingsAsProperties(root.evalNode(<span class="string">&quot;settings&quot;</span>));</span><br><span class="line">    loadCustomVfs(settings);</span><br><span class="line">    loadCustomLogImpl(settings);</span><br><span class="line">    typeAliasesElement(root.evalNode(<span class="string">&quot;typeAliases&quot;</span>));</span><br><span class="line">    pluginElement(root.evalNode(<span class="string">&quot;plugins&quot;</span>));</span><br><span class="line">    objectFactoryElement(root.evalNode(<span class="string">&quot;objectFactory&quot;</span>));</span><br><span class="line">    objectWrapperFactoryElement(root.evalNode(<span class="string">&quot;objectWrapperFactory&quot;</span>));</span><br><span class="line">    reflectorFactoryElement(root.evalNode(<span class="string">&quot;reflectorFactory&quot;</span>));</span><br><span class="line">    settingsElement(settings);</span><br><span class="line">    environmentsElement(root.evalNode(<span class="string">&quot;environments&quot;</span>));</span><br><span class="line">    databaseIdProviderElement(root.evalNode(<span class="string">&quot;databaseIdProvider&quot;</span>));</span><br><span class="line">    typeHandlerElement(root.evalNode(<span class="string">&quot;typeHandlers&quot;</span>));</span><br><span class="line">    <span class="comment">//è§£æmappers ä¸»è¦çš„crudæ“ä½œéƒ½æ˜¯åœ¨mappersä¸­å®šä¹‰çš„</span></span><br><span class="line">    mapperElement(root.evalNode(<span class="string">&quot;mappers&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºå¯ä»¥é…ç½®10ä¸ªå­èŠ‚ç‚¹ï¼Œ åˆ†åˆ«ä¸ºï¼špropertiesã€settingsã€typeAliasesã€pluginsã€objectFactoryã€objectWrapperFactoryã€environmentsã€databaseIdProviderã€typeHandlersã€mappersã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="Configuration">Configuration</h3><p>XMLConfigBuilderè°ƒç”¨parse()æ–¹æ³•è§£æMybatisé…ç½®æ–‡ä»¶ï¼Œç”ŸæˆConfigurationå¯¹è±¡ã€‚</p><p>Configurationç±»ä¸»è¦æ˜¯ç”¨æ¥å­˜å‚¨å¯¹Mybatisçš„é…ç½®æ–‡ä»¶åŠmapperæ–‡ä»¶è§£æåçš„æ•°æ®ï¼ŒConfigurationå¯¹è±¡ä¼šè´¯ç©¿æ•´ä¸ªMybatisçš„æ‰§è¡Œæµç¨‹ï¼Œä¸ºMybatisçš„æ‰§è¡Œè¿‡ç¨‹æä¾›å¿…è¦çš„é…ç½®ä¿¡æ¯ã€‚</p><p>æˆ‘ä»¬å…ˆè´´å‡ºä¸€ä¸ªåŒ…å«äº†æ‰€æœ‰å±æ€§çš„mybatis-Config.xmlå®ä¾‹ï¼Œå†å¯¹ç…§çœ‹ä¸€çœ‹Configurationç±»çš„ä¸»è¦æˆå‘˜å˜é‡</p><div class="tabs" id="0a864dc3-6239-422f-8f7b-e73cf7167fda"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#0a864dc3-6239-422f-8f7b-e73cf7167fda-1"><i class="fas fa-bug"></i>Configuration</button></li><li class="tab"><button type="button" data-href="#0a864dc3-6239-422f-8f7b-e73cf7167fda-2"><i class="fas fa-cannabis"></i>mybatis-config.xml</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="0a864dc3-6239-422f-8f7b-e73cf7167fda-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Configuration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * MyBatis å¯ä»¥é…ç½®æˆé€‚åº”å¤šç§ç¯å¢ƒï¼Œè¿™ç§æœºåˆ¶æœ‰åŠ©äºå°† SQL æ˜ å°„åº”ç”¨äºå¤šç§æ•°æ®åº“ä¹‹ä¸­,</span></span><br><span class="line"><span class="comment">     * æ¯”å¦‚è®¾ç½®ä¸åŒçš„å¼€å‘ã€æµ‹è¯•ã€çº¿ä¸Šé…ç½®ï¼Œåœ¨æ¯ä¸ªé…ç½®ä¸­å¯ä»¥é…ç½®äº‹åŠ¡ç®¡ç†å™¨å’Œæ•°æ®æºå¯¹è±¡.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Environment environment;</span><br><span class="line">    <span class="comment">//æ˜¯å¦å¼€å¯è‡ªåŠ¨é©¼å³°å‘½åè§„åˆ™ï¼ˆcamel caseï¼‰æ˜ å°„</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">mapUnderscoreToCamelCase</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//é…ç½®å…¨å±€æ€§çš„cacheå¼€å…³</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">cacheEnabled</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">//æŒ‡å®š MyBatis æ‰€ç”¨æ—¥å¿—çš„å…·ä½“å®ç°ï¼ŒæœªæŒ‡å®šæ—¶å°†è‡ªåŠ¨æŸ¥æ‰¾</span></span><br><span class="line">    Class&lt;? <span class="keyword">extends</span> <span class="title class_">Log</span>&gt; logImpl;</span><br><span class="line">    <span class="comment">//MyBatis åˆ©ç”¨æœ¬åœ°ç¼“å­˜æœºåˆ¶</span></span><br><span class="line">    <span class="type">LocalCacheScope</span> <span class="variable">localCacheScope</span> <span class="operator">=</span> LocalCacheScope.SESSION;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå®ƒå†³å®šé©±åŠ¨ç­‰å¾…æ•°æ®åº“å“åº”çš„ç§’æ•°ã€‚</span></span><br><span class="line">    Integer defaultStatementTimeout;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®é»˜è®¤çš„æ‰§è¡Œå™¨ã€‚</span></span><br><span class="line"><span class="comment">     * SIMPLE å°±æ˜¯æ™®é€šçš„æ‰§è¡Œå™¨ï¼›REUSE æ‰§è¡Œå™¨ä¼šé‡ç”¨é¢„å¤„ç†è¯­å¥ï¼ˆprepared statementsï¼‰</span></span><br><span class="line"><span class="comment">     * BATCH æ‰§è¡Œå™¨å°†é‡ç”¨è¯­å¥å¹¶æ‰§è¡Œæ‰¹é‡æ›´æ–°ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">ExecutorType</span> <span class="variable">defaultExecutorType</span> <span class="operator">=</span> ExecutorType.SIMPLE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯¹è±¡åˆ›å»ºå·¥å‚ï¼Œé»˜è®¤çš„å®ç°ç±»DefaultObjectFactoryï¼Œç”¨æ¥åˆ›å»ºå¯¹è±¡ï¼Œæ¯”å¦‚ä¼ å…¥List.classï¼Œåˆ©ç”¨åå°„è¿”å›ArrayListçš„å®ä¾‹</span></span><br><span class="line">    <span class="type">ObjectFactory</span> <span class="variable">objectFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultObjectFactory</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯¹è±¡åŒ…è£…å·¥å‚ï¼Œé»˜è®¤å®ç°ç±»æ˜¯DefaultObjectWrapperFactoryï¼ŒåŒ…è£…Objectå®ä¾‹</span></span><br><span class="line">    <span class="type">ObjectWrapperFactory</span> <span class="variable">objectWrapperFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultObjectWrapperFactory</span>();</span><br><span class="line">    <span class="comment">//æ³¨å†ŒMapper</span></span><br><span class="line">    <span class="type">MapperRegistry</span> <span class="variable">mapperRegistry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MapperRegistry</span>(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ‹¦æˆªå™¨é“¾</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">InterceptorChain</span> <span class="variable">interceptorChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterceptorChain</span>();</span><br><span class="line">    <span class="comment">//TypeHandleræ³¨å†Œ</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">TypeHandlerRegistry</span> <span class="variable">typeHandlerRegistry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TypeHandlerRegistry</span>();</span><br><span class="line">    <span class="comment">//åˆ«åå’Œå…·ä½“ç±»æ³¨å†Œ</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">TypeAliasRegistry</span> <span class="variable">typeAliasRegistry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TypeAliasRegistry</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯¹åº”Mapper.xmlé‡Œé…ç½®çš„Statement</span></span><br><span class="line">    <span class="keyword">final</span> Map&lt;String, MappedStatement&gt; mappedStatements = <span class="keyword">new</span> <span class="title class_">StrictMap</span>&lt;MappedStatement&gt;(<span class="string">&quot;Mapped Statements collection&quot;</span>);</span><br><span class="line">    <span class="comment">//å¯¹åº”Mapper.xmlé‡Œé…ç½®çš„cache</span></span><br><span class="line">    <span class="keyword">final</span> Map&lt;String, Cache&gt; caches = <span class="keyword">new</span> <span class="title class_">StrictMap</span>&lt;Cache&gt;(<span class="string">&quot;Caches collection&quot;</span>);</span><br><span class="line">    <span class="comment">//å¯¹åº”Mapper.xmlé‡Œçš„ResultMap</span></span><br><span class="line">    <span class="keyword">final</span> Map&lt;String, ResultMap&gt; resultMaps = <span class="keyword">new</span> <span class="title class_">StrictMap</span>&lt;ResultMap&gt;(<span class="string">&quot;Result Maps collection&quot;</span>);</span><br><span class="line">    <span class="comment">//å¯¹åº”Mapper.xmlé‡Œçš„ParameterMap</span></span><br><span class="line">    <span class="keyword">final</span> Map&lt;String, ParameterMap&gt; parameterMaps = <span class="keyword">new</span> <span class="title class_">StrictMap</span>&lt;ParameterMap&gt;(<span class="string">&quot;Parameter Maps collection&quot;</span>);</span><br><span class="line">    <span class="comment">//ä¸»é”®ç”Ÿæˆå™¨</span></span><br><span class="line">    <span class="keyword">final</span> Map&lt;String, KeyGenerator&gt; keyGenerators = <span class="keyword">new</span> <span class="title class_">StrictMap</span>&lt;KeyGenerator&gt;(<span class="string">&quot;Key Generators collection&quot;</span>);</span><br><span class="line">    <span class="comment">//å­˜å‚¨å·²ç»åŠ è½½è¿‡çš„mapper.xmlèµ„æºï¼Œè§MapperAnnotationBuilder#loadXmlResource</span></span><br><span class="line">    <span class="keyword">final</span> Set&lt;String&gt; loadedResources = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;();</span><br><span class="line">    <span class="comment">//å­˜å‚¨å·²ç»è§£æè¿‡çš„mapperå¯¹åº”çš„xmlèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Map&lt;String, XNode&gt; sqlFragments = <span class="keyword">new</span> <span class="title class_">StrictMap</span>&lt;XNode&gt;(<span class="string">&quot;XML fragments parsed from previous mappers&quot;</span>);</span><br><span class="line">    <span class="comment">//å­˜å‚¨æ‰€æœ‰æœªå¤„ç†çš„</span></span><br><span class="line">    <span class="keyword">final</span> Collection&lt;XMLStatementBuilder&gt; incompleteStatements = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;XMLStatementBuilder&gt;();</span><br><span class="line">    <span class="comment">//å­˜å‚¨æ‰€æœ‰æœªå¤„ç†çš„ç¼“å­˜ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">final</span> Collection&lt;CacheRefResolver&gt; incompleteCacheRefs = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;CacheRefResolver&gt;();</span><br><span class="line">    <span class="comment">//å­˜å‚¨æ‰€æœ‰æœªå¤„ç†ResultMapçš„æ˜ å°„ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">final</span> Collection&lt;ResultMapResolver&gt; incompleteResultMaps = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;ResultMapResolver&gt;();</span><br><span class="line">    <span class="keyword">final</span> Collection&lt;MethodResolver&gt; incompleteMethods = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;MethodResolver&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0a864dc3-6239-422f-8f7b-e73cf7167fda-2"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">&quot;org/apache/ibatis/databases/blog/blog-derby.properties&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;cacheEnabled&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;mapUnderscoreToCamelCase&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">&quot;Author&quot;</span> <span class="attr">type</span>=<span class="string">&quot;org.apache.ibatis.domain.blog.Author&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">&quot;Blog&quot;</span> <span class="attr">type</span>=<span class="string">&quot;org.apache.ibatis.domain.blog.Blog&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeHandlers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">javaType</span>=<span class="string">&quot;String&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;VARCHAR&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">handler</span>=<span class="string">&quot;org.apache.ibatis.builder.CustomStringTypeHandler&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeHandlers</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">objectFactory</span> <span class="attr">type</span>=<span class="string">&quot;org.apache.ibatis.builder.ExampleObjectFactory&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;objectFactoryProperty&quot;</span> <span class="attr">value</span>=<span class="string">&quot;100&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">objectFactory</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">&quot;org.apache.ibatis.builder.ExamplePlugin&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;pluginProperty&quot;</span> <span class="attr">value</span>=<span class="string">&quot;100&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">transactionManager</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;UNPOOLED&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;driver&#125;&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;url&#125;&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;username&#125;&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;password&#125;&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">databaseIdProvider</span> <span class="attr">type</span>=<span class="string">&quot;DB_VENDOR&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;SQL Server&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sqlserver&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;DB2&quot;</span> <span class="attr">value</span>=<span class="string">&quot;db2&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;Oracle&quot;</span> <span class="attr">value</span>=<span class="string">&quot;oracle&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">databaseIdProvider</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;org/apache/ibatis/builder/AuthorMapper.xml&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;org/apache/ibatis/builder/BlogMapper.xml&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="è§£æmapper-xmlâ­ï¸">è§£æmapper.xmlâ­ï¸</h3><p>ç”±æ ¸å¿ƒæºç 3ä¸­æˆ‘ä»¬å¯çŸ¥ï¼Œè§£æmapperæ–‡ä»¶æ˜¯ä»<code>mapperElement(root.evalNode(&quot;mappers&quot;));</code> å¼€å§‹å¤„ç†çš„ã€‚</p><div class="tabs" id="c58fa038-9a9a-4df6-af2c-b602640abac1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c58fa038-9a9a-4df6-af2c-b602640abac1-1"><i class="fas fa-seedling"></i>1</button></li><li class="tab"><button type="button" data-href="#c58fa038-9a9a-4df6-af2c-b602640abac1-2"><i class="fas fa-leaf"></i>2</button></li><li class="tab"><button type="button" data-href="#c58fa038-9a9a-4df6-af2c-b602640abac1-3"><i class="fab fa-apple"></i>3</button></li><li class="tab"><button type="button" data-href="#c58fa038-9a9a-4df6-af2c-b602640abac1-4"><i class="fas fa-tree"></i>4</button></li><li class="tab"><button type="button" data-href="#c58fa038-9a9a-4df6-af2c-b602640abac1-5"><i class="fas fa-cat"></i>5</button></li><li class="tab"><button type="button" data-href="#c58fa038-9a9a-4df6-af2c-b602640abac1-6"><i class="fas fa-horse"></i>6</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c58fa038-9a9a-4df6-af2c-b602640abac1-1"><p><mark class="hl-label blue">XMLConfigBuilder#mapperElement()</mark></p><p>ä»ä»£ç æ¥çœ‹ï¼Œä¸»è¦æ˜¯å°†æ ‡ç­¾åˆ†ä¸º<code>&lt;package&gt;</code>å’Œ<code>&lt;mapper&gt;</code>æ¥è§£æï¼Œè€Œå†ç»†ä¸€ç‚¹å¯ä»¥åˆ†ä¸ºä¸¤ç§è§£ææƒ…å†µï¼šä¸€ç§æ˜¯æŒ‡å®šäº†Mapperæ¥å£çš„ XML æ–‡ä»¶ï¼Œè€Œå¦å¤–ä¸€ç§æ˜¯æŒ‡å®šäº† Mapperæ¥å£ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">mapperElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123;</span><br><span class="line">            <span class="comment">// é€šè¿‡&lt;package&gt;æ ‡ç­¾æŒ‡å®šåŒ…å</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;package&quot;</span>.equals(child.getName())) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">mapperPackage</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">                configuration.addMappers(mapperPackage);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">resource</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;resource&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">mapperClass</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;class&quot;</span>);</span><br><span class="line">                <span class="comment">// é€šè¿‡resourceå±æ€§æŒ‡å®šXMLæ–‡ä»¶è·¯å¾„</span></span><br><span class="line">                <span class="keyword">if</span> (resource != <span class="literal">null</span> &amp;&amp; url == <span class="literal">null</span> &amp;&amp; mapperClass == <span class="literal">null</span>) &#123;</span><br><span class="line">                    ErrorContext.instance().resource(resource);</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(resource);</span><br><span class="line">                    <span class="type">XMLMapperBuilder</span> <span class="variable">mapperParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLMapperBuilder</span>(inputStream, configuration, resource, configuration.getSqlFragments());</span><br><span class="line">                    mapperParser.parse();<span class="comment">//-&gt;2</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="literal">null</span> &amp;&amp; url != <span class="literal">null</span> &amp;&amp; mapperClass == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// é€šè¿‡urlå±æ€§æŒ‡å®šXMLæ–‡ä»¶è·¯å¾„</span></span><br><span class="line">                    ErrorContext.instance().resource(url);</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getUrlAsStream(url);</span><br><span class="line">                    <span class="type">XMLMapperBuilder</span> <span class="variable">mapperParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLMapperBuilder</span>(inputStream, configuration, url, configuration.getSqlFragments());</span><br><span class="line">                    mapperParser.parse();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="literal">null</span> &amp;&amp; url == <span class="literal">null</span> &amp;&amp; mapperClass != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// é€šè¿‡classå±æ€§æŒ‡å®šæ¥å£çš„å®Œå…¨é™å®šå</span></span><br><span class="line">                    Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);</span><br><span class="line">                    configuration.addMapper(mapperInterface);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;A mapper element may only specify a url, resource or class, but not more than one.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c58fa038-9a9a-4df6-af2c-b602640abac1-2"><p><mark class="hl-label green">XMLMapperBuilder#parse()</mark></p><p>æˆ‘ä»¬å¯ä»¥å…ˆçœ‹çœ‹æŒ‡å®š XML æ–‡ä»¶æ˜¯å¦‚ä½•è§£æä¸åŠ è½½ Mapper çš„ã€‚Mapper æ¥å£çš„ XML æ–‡ä»¶çš„è§£æå½“ç„¶ä¹Ÿæ˜¯åˆ©ç”¨ XPathParserï¼Œä½†æ­¤æ—¶ä¸å†æ˜¯ XMLConfigBuilder æ¥è´Ÿè´£äº†ï¼Œè€Œæ˜¯éœ€è¦åˆ›å»ºä¸€ä¸ª XMLMapperBuilder å¯¹è±¡ï¼Œè€Œ XMLMapperBuilder éœ€è¦ä¼ å…¥ XML æ–‡ä»¶çš„æ–‡ä»¶è¾“å…¥æµã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line">      <span class="comment">// è°ƒç”¨XPathParserçš„evalNodeï¼ˆï¼‰æ–¹æ³•è·å–æ ¹èŠ‚ç‚¹å¯¹åº”çš„XNodeå¯¹è±¡</span></span><br><span class="line">      configurationElement(parser.evalNode(<span class="string">&quot;/mapper&quot;</span>));<span class="comment">//-&gt;3</span></span><br><span class="line">      <span class="comment">// å°‡èµ„æºè·¯å¾„æ·»åŠ åˆ°Configurationå¯¹è±¡ä¸­</span></span><br><span class="line">      configuration.addLoadedResource(resource);</span><br><span class="line">      bindMapperForNamespace();<span class="comment">//-&gt;æ³¨å†Œmapperæ¥å£</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç»§ç»­è§£æä¹‹å‰è§£æå‡ºç°å¼‚å¸¸çš„ResultMapå¯¹è±¡</span></span><br><span class="line">    parsePendingResultMaps();</span><br><span class="line">    <span class="comment">// ç»§ç»­è§£æä¹‹å‰è§£æå‡ºç°å¼‚å¸¸çš„CacheRefå¯¹è±¡</span></span><br><span class="line">    parsePendingCacheRefs();</span><br><span class="line">    <span class="comment">// ç»§ç»­è§£æä¹‹å‰è§£æå‡ºç°å¼‚å¸¸&lt;select|update|delete|insert&gt;æ ‡ç­¾é…ç½®</span></span><br><span class="line">    parsePendingStatements();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£æå‰ï¼Œä¼šå…ˆåˆ¤æ–­ Configuratin æ˜¯å¦å·²ç»åŠ è½½è¿™ä¸ª XML èµ„æºï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨<code>configurationElement() æ–¹æ³•</code>ï¼›åœ¨æ–¹æ³•é‡Œé¢ä¼šè§£ææ‰€æœ‰çš„<code>&lt;cache-ref&gt;</code>ã€<code>&lt;cache&gt;</code>ã€<code>&lt;parameterMap&gt;</code>ã€<code>&lt;resultMap&gt;</code>ã€<code>&lt;sql&gt;</code> å’Œ <code>&lt;select|insert|update|delete&gt;</code> æ ‡ç­¾ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c58fa038-9a9a-4df6-af2c-b602640abac1-3"><p><mark class="hl-label blue">XMLMapperBuilder#configuratinElement()</mark></p><p>æˆ‘ä»¬å°†æ‰€æœ‰æ³¨æ„åŠ›é›†ä¸­åœ¨ buildStatementFromContext æ–¹æ³•å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">configurationElement</span><span class="params">(XNode context)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// è·å–å‘½åç©ºé—´</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">namespace</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;namespace&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (namespace == <span class="literal">null</span> || namespace.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Mapper&#x27;s namespace cannot be empty&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// è®¾ç½®å½“å‰æ­£åœ¨è§£æçš„Mapperé…ç½®çš„å‘½åç©ºé—´</span></span><br><span class="line">      builderAssistant.setCurrentNamespace(namespace);</span><br><span class="line">      <span class="comment">// è§£æ&lt;cache-ref&gt;æ ‡ç­¾</span></span><br><span class="line">      cacheRefElement(context.evalNode(<span class="string">&quot;cache-ref&quot;</span>));</span><br><span class="line">      <span class="comment">// è§£æ&lt;cache&gt;æ ‡ç­¾</span></span><br><span class="line">      cacheElement(context.evalNode(<span class="string">&quot;cache&quot;</span>));</span><br><span class="line">      <span class="comment">// è§£ææ‰€æœ‰çš„&lt;parameterMap&gt;æ ‡ç­¾</span></span><br><span class="line">      parameterMapElement(context.evalNodes(<span class="string">&quot;/mapper/parameterMap&quot;</span>));</span><br><span class="line">      <span class="comment">// è§£ææ‰€æœ‰çš„&lt;resultMap&gt;æ ‡ç­¾</span></span><br><span class="line">      resultMapElements(context.evalNodes(<span class="string">&quot;/mapper/resultMap&quot;</span>));</span><br><span class="line">      <span class="comment">// è§£ææ‰€æœ‰çš„&lt;sql&gt;æ ‡ç­¾</span></span><br><span class="line">      sqlElement(context.evalNodes(<span class="string">&quot;/mapper/sql&quot;</span>));</span><br><span class="line">      <span class="comment">// è§£ææ‰€æœ‰çš„&lt;select|insert|update|delete&gt;æ ‡ç­¾</span></span><br><span class="line">      buildStatementFromContext(context.evalNodes(<span class="string">&quot;select|insert|update|delete&quot;</span>));<span class="comment">//-&gt;4</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Error parsing Mapper XML. The XML location is &#x27;&quot;</span> + resource + <span class="string">&quot;&#x27;. Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c58fa038-9a9a-4df6-af2c-b602640abac1-4"><p><mark class="hl-label green">XMLMapperBuilder#buildStatementFromContext()</mark></p><p>åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ï¼Œä¼šè°ƒç”¨é‡è½½çš„ buildStatementFromContext æ–¹æ³•ï¼›ä½†æ˜¯è¿™é‡Œè¿˜ä¸æ˜¯çœŸæ­£è§£æçš„åœ°æ–¹ï¼Œè€Œæ˜¯éå†æ‰€æœ‰æ ‡ç­¾ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª XMLStatementBuilder å¯¹è±¡ï¼Œå¯¹æ ‡ç­¾è¿›è¡Œè§£æã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">buildStatementFromContext</span><span class="params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (XNode context : list) &#123;</span><br><span class="line">    <span class="comment">// é€šè¿‡XMLStatementBuilderå¯¹è±¡ï¼Œå¯¹&lt;select|update|insert|delete&gt;æ ‡ç­¾è¿›è¡Œè§£æ</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">XMLStatementBuilder</span> <span class="variable">statementParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLStatementBuilder</span>(configuration, builderAssistant, context, requiredDatabaseId);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// è°ƒç”¨parseStatementNodeï¼ˆï¼‰æ–¹æ³•è§£æ</span></span><br><span class="line">      statementParser.parseStatementNode();<span class="comment">//-&gt;5</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</span><br><span class="line">      configuration.addIncompleteStatement(statementParser);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c58fa038-9a9a-4df6-af2c-b602640abac1-5"><p><mark class="hl-label blue">XMLStatementBuilder#parseStatementNode()</mark></p><p>ä»ä»£ç å¯å¾—ï¼Œé¦–å…ˆä¼šè§£ææ ‡ç­¾é‡Œçš„æ‰€æœ‰å±æ€§ï¼›ç„¶ååˆ›å»º LanguageDriver æ¥è§£ææ ‡ç­¾é‡Œé¢çš„ SQL é…ç½®ï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„ SqlSource å¯¹è±¡ï¼›æœ€åï¼Œåˆ©ç”¨å·¥å…·ç±» MapperBuilderAssistant æ¥å°†ä¸Šé¢è§£æçš„å†…å®¹ç»„è£…æˆ MappedStatement å¯¹è±¡ï¼Œå¹¶ä¸”æ³¨å†Œåˆ° Configuration ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parseStatementNode</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">  <span class="type">String</span> <span class="variable">databaseId</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;databaseId&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!databaseIdMatchesCurrent(id, databaseId, <span class="built_in">this</span>.requiredDatabaseId)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è§£æ&lt;select|update|delete|insert&gt;æ ‡ç­¾å±æ€§</span></span><br><span class="line">  <span class="type">Integer</span> <span class="variable">fetchSize</span> <span class="operator">=</span> context.getIntAttribute(<span class="string">&quot;fetchSize&quot;</span>);</span><br><span class="line">  <span class="type">Integer</span> <span class="variable">timeout</span> <span class="operator">=</span> context.getIntAttribute(<span class="string">&quot;timeout&quot;</span>);</span><br><span class="line">  <span class="type">String</span> <span class="variable">parameterMap</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;parameterMap&quot;</span>);</span><br><span class="line">  <span class="type">String</span> <span class="variable">parameterType</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;parameterType&quot;</span>);</span><br><span class="line">  Class&lt;?&gt; parameterTypeClass = resolveClass(parameterType);</span><br><span class="line">  <span class="type">String</span> <span class="variable">resultMap</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;resultMap&quot;</span>);</span><br><span class="line">  <span class="type">String</span> <span class="variable">resultType</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;resultType&quot;</span>);</span><br><span class="line">  <span class="comment">// è·å–LanguageDriverå¯¹è±¡</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">lang</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;lang&quot;</span>);</span><br><span class="line">  <span class="type">LanguageDriver</span> <span class="variable">langDriver</span> <span class="operator">=</span> getLanguageDriver(lang);</span><br><span class="line">  <span class="comment">// è·å–Mapperè¿”å›ç»“æœç±»å‹Classå¯¹è±¡</span></span><br><span class="line">  Class&lt;?&gt; resultTypeClass = resolveClass(resultType);</span><br><span class="line">  <span class="type">String</span> <span class="variable">resultSetType</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;resultSetType&quot;</span>);</span><br><span class="line">  <span class="comment">// é»˜è®¤Statementç±»å‹ä¸ºPREPARED</span></span><br><span class="line">  <span class="type">StatementType</span> <span class="variable">statementType</span> <span class="operator">=</span> StatementType.valueOf(context.getStringAttribute(<span class="string">&quot;statementType&quot;</span>,</span><br><span class="line">          StatementType.PREPARED.toString()));</span><br><span class="line">  <span class="type">ResultSetType</span> <span class="variable">resultSetTypeEnum</span> <span class="operator">=</span> resolveResultSetType(resultSetType);</span><br><span class="line"></span><br><span class="line">  <span class="type">String</span> <span class="variable">nodeName</span> <span class="operator">=</span> context.getNode().getNodeName();</span><br><span class="line">  <span class="type">SqlCommandType</span> <span class="variable">sqlCommandType</span> <span class="operator">=</span> SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));</span><br><span class="line">  <span class="type">boolean</span> <span class="variable">isSelect</span> <span class="operator">=</span> sqlCommandType == SqlCommandType.SELECT;</span><br><span class="line">  <span class="type">boolean</span> <span class="variable">flushCache</span> <span class="operator">=</span> context.getBooleanAttribute(<span class="string">&quot;flushCache&quot;</span>, !isSelect);</span><br><span class="line">  <span class="type">boolean</span> <span class="variable">useCache</span> <span class="operator">=</span> context.getBooleanAttribute(<span class="string">&quot;useCache&quot;</span>, isSelect);</span><br><span class="line">  <span class="type">boolean</span> <span class="variable">resultOrdered</span> <span class="operator">=</span> context.getBooleanAttribute(<span class="string">&quot;resultOrdered&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°‡&lt;include&gt;æ ‡ç­¾å†…å®¹ï¼Œæ›¿æ¢ä¸º&lt;sql&gt;æ ‡ç­¾å®šä¹‰çš„SQLç‰‡æ®µ</span></span><br><span class="line">  <span class="type">XMLIncludeTransformer</span> <span class="variable">includeParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLIncludeTransformer</span>(configuration, builderAssistant);</span><br><span class="line">  includeParser.applyIncludes(context.getNode());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ&lt;selectKey&gt;æ ‡ç­¾</span></span><br><span class="line">  processSelectKeyNodes(id, parameterTypeClass, langDriver);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// é€šè¿‡LanguageDriverè§£æSQLå†…å®¹ï¼Œç”ŸæˆSqlSourceå¯¹è±¡</span></span><br><span class="line">  <span class="type">SqlSource</span> <span class="variable">sqlSource</span> <span class="operator">=</span> langDriver.createSqlSource(configuration, context, parameterTypeClass);</span><br><span class="line">  <span class="type">String</span> <span class="variable">resultSets</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;resultSets&quot;</span>);</span><br><span class="line">  <span class="type">String</span> <span class="variable">keyProperty</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;keyProperty&quot;</span>);</span><br><span class="line">  <span class="type">String</span> <span class="variable">keyColumn</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;keyColumn&quot;</span>);</span><br><span class="line">  KeyGenerator keyGenerator;</span><br><span class="line">  <span class="type">String</span> <span class="variable">keyStatementId</span> <span class="operator">=</span> id + SelectKeyGenerator.SELECT_KEY_SUFFIX;</span><br><span class="line">  keyStatementId = builderAssistant.applyCurrentNamespace(keyStatementId, <span class="literal">true</span>);</span><br><span class="line">  <span class="comment">// è·å–ä¸»é”®ç”Ÿæˆç­–ç•¥</span></span><br><span class="line">  <span class="keyword">if</span> (configuration.hasKeyGenerator(keyStatementId)) &#123;</span><br><span class="line">    keyGenerator = configuration.getKeyGenerator(keyStatementId);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    keyGenerator = context.getBooleanAttribute(<span class="string">&quot;useGeneratedKeys&quot;</span>,</span><br><span class="line">        configuration.isUseGeneratedKeys() &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType))</span><br><span class="line">        ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,</span><br><span class="line">      fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,</span><br><span class="line">      resultSetTypeEnum, flushCache, useCache, resultOrdered, </span><br><span class="line">      keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);<span class="comment">//-&gt;6</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c58fa038-9a9a-4df6-af2c-b602640abac1-6"><p><mark class="hl-label green">XMLStatementBuilder#addMappedStatement</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> MappedStatement <span class="title function_">addMappedStatement</span><span class="params">(String id, SqlSource sqlSource, StatementType statementType,</span></span><br><span class="line"><span class="params">                                          SqlCommandType sqlCommandType, Integer fetchSize, Integer timeout,</span></span><br><span class="line"><span class="params">                                          String parameterMap, Class&lt;?&gt; parameterType, String resultMap,</span></span><br><span class="line"><span class="params">                                          Class&lt;?&gt; resultType, ResultSetType resultSetType, <span class="type">boolean</span> flushCache,</span></span><br><span class="line"><span class="params">                                          <span class="type">boolean</span> useCache, <span class="type">boolean</span> resultOrdered, KeyGenerator keyGenerator,</span></span><br><span class="line"><span class="params">                                          String keyProperty, String keyColumn, String databaseId, LanguageDriver lang, String resultSets)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unresolvedCacheRef) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IncompleteElementException</span>(<span class="string">&quot;Cache-ref not yet resolved&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    id = applyCurrentNamespace(id, <span class="literal">false</span>);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isSelect</span> <span class="operator">=</span> sqlCommandType == SqlCommandType.SELECT;</span><br><span class="line"></span><br><span class="line">    MappedStatement.<span class="type">Builder</span> <span class="variable">statementBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MappedStatement</span>.Builder(configuration, id, sqlSource, sqlCommandType).resource(resource).fetchSize(fetchSize)</span><br><span class="line">            .timeout(timeout).statementType(statementType).keyGenerator(keyGenerator).keyProperty(keyProperty).keyColumn(keyColumn)</span><br><span class="line">            .databaseId(databaseId).lang(lang).resultOrdered(resultOrdered).resultSets(resultSets).resultMaps(getStatementResultMaps(resultMap, resultType, id))</span><br><span class="line">            .resultSetType(resultSetType).flushCacheRequired(valueOrDefault(flushCache, !isSelect)).useCache(valueOrDefault(useCache, isSelect)).cache(currentCache);</span><br><span class="line">    <span class="type">ParameterMap</span> <span class="variable">statementParameterMap</span> <span class="operator">=</span> getStatementParameterMap(parameterMap, parameterType, id);</span><br><span class="line">    <span class="keyword">if</span> (statementParameterMap != <span class="literal">null</span>) &#123;</span><br><span class="line">        statementBuilder.parameterMap(statementParameterMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">MappedStatement</span> <span class="variable">statement</span> <span class="operator">=</span> statementBuilder.build();</span><br><span class="line">    configuration.addMappedStatement(statement);</span><br><span class="line">    <span class="keyword">return</span> statement;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="æ³¨å†Œmapperæ¥å£">æ³¨å†Œmapperæ¥å£</h3><div class="tabs" id="a8613243-570f-4ac3-ad1f-5c6f485f58ba"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#a8613243-570f-4ac3-ad1f-5c6f485f58ba-1"><i class="fas fa-cat"></i>1</button></li><li class="tab"><button type="button" data-href="#a8613243-570f-4ac3-ad1f-5c6f485f58ba-2"><i class="fas fa-horse"></i>2</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="a8613243-570f-4ac3-ad1f-5c6f485f58ba-1"><p><mark class="hl-label blue">XMLMapperBuilder#bindMapperForNameSpace()</mark></p><p>é‡æ–°å›åˆ° XMLMapperBuilder#parse() æ–¹æ³•ä¸­ã€‚è§£æmapper.xmlä¸­tab2</p><p>æ¥ç€é‡Œé¢çš„ configurationElement() æ–¹æ³•ç»§ç»­å¾€ä¸‹èµ°ã€‚</p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå…ˆè°ƒç”¨ Configuration#hasMapper() æ–¹æ³•æ¥åˆ¤æ–­ Mapper æ¥å£æ˜¯å¦æ³¨å†Œè¿‡äº†ï¼Œå¦‚æœæ²¡æ³¨å†Œè¿‡å°±è°ƒç”¨ Configuration#addMapper() æ–¹æ³•æ¥æ³¨å†Œ Mapper æ¥å£ï¼Œæ‰€ä»¥è¯´ï¼Œç”ŸæˆåŠ¨æ€ä»£ç†ç±»çš„é‡ç‚¹åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">bindMapperForNamespace</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">namespace</span> <span class="operator">=</span> builderAssistant.getCurrentNamespace();</span><br><span class="line">  <span class="keyword">if</span> (namespace != <span class="literal">null</span>) &#123;</span><br><span class="line">    Class&lt;?&gt; boundType = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      boundType = Resources.classForName(namespace);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">      <span class="comment">//ignore, bound type is not required</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (boundType != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!configuration.hasMapper(boundType)) &#123;</span><br><span class="line">        configuration.addLoadedResource(<span class="string">&quot;namespace:&quot;</span> + namespace);</span><br><span class="line">        configuration.addMapper(boundType);<span class="comment">//-&gt;2</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a8613243-570f-4ac3-ad1f-5c6f485f58ba-2"><p><mark class="hl-label green">MapperRegistr#addMapper</mark></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ–¹æ³•é‡Œé¢ä¼šè°ƒç”¨ Configurationä¸­mapperRegistryä¸­ knownMappers çš„ put æ–¹æ³•ï¼Œå°† key ä¸º Mapperæ¥å£å¯¹åº” Classå¯¹è±¡ï¼Œvalue ä¸º Mapper æ¥å£çš„ä»£ç†å·¥å‚ç±» MapperProxyFactoryã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">addMapper</span><span class="params">(Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (type.isInterface()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (hasMapper(type)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindingException</span>(<span class="string">&quot;Type &quot;</span> + type + <span class="string">&quot; is already known to the MapperRegistry.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">loadCompleted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      knownMappers.put(type, <span class="keyword">new</span> <span class="title class_">MapperProxyFactory</span>&lt;T&gt;(type));</span><br><span class="line">      <span class="type">MapperAnnotationBuilder</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MapperAnnotationBuilder</span>(config, type);</span><br><span class="line">      parser.parse();</span><br><span class="line">      loadCompleted = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!loadCompleted) &#123;</span><br><span class="line">        knownMappers.remove(type);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å¤‡æ³¨ï¼šå½“æ‰§è¡Œ Mapper æ—¶ï¼ŒMapperProxyFactoryä¼šæ ¹æ® SqlSession ä¸º Mapper æ¥å£åˆ›å»ºä¸€ä¸ª MapperProxy ä»£ç†å®ä¾‹ã€‚</p></blockquote><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>è‡³æ­¤ï¼Œå…³äºæŒ‡å®š XML æ–‡ä»¶è§£æå’ŒåŠ è½½ Mapper æ¥å£çš„æ•´ä¸ªæµç¨‹å·²ç»å®Œæ¯•ã€‚åœ¨è¿™é‡Œæ€»ç»“ä¸€ä¸‹æµç¨‹ã€‚</p><ol><li>æ ¹æ® XML æ–‡ä»¶çš„è¾“å…¥æµåˆ›å»º XMLMapperBuilder å¯¹è±¡ï¼Œè°ƒç”¨ parse() æ–¹æ³•ä½œä¸ºè§£æ<code>&lt;mapper&gt;</code>æ ‡ç­¾çš„å…¥å£ã€‚</li><li>XMLMapperBuilder#configurationElement() æ–¹æ³•è§£æ<code>&lt;cache-ref&gt;</code>ã€<code>&lt;cache&gt;</code>ã€<code>&lt;parameterMap&gt;</code>ã€<code>&lt;resultMap&gt;</code>ã€<code>&lt;sql&gt; </code>å’Œ <code>&lt;select|insert|update|delete&gt; </code>ç­‰æ‰€æœ‰æ ‡ç­¾ï¼Œè€Œ <code>&lt;select|insert|update|delete&gt; </code>æ ‡ç­¾çš„è§£æå…¥å£ä¸º XMLMapperBuilder#buildStatementFromContext() æ–¹æ³•ã€‚</li><li>XMLMapperBuilder#buildStatementFromContext() æ–¹æ³•ä¸­ä¼šéå†æ‰€æœ‰ <code>&lt;select|insert|update|delete&gt; </code>æ ‡ç­¾ï¼Œç„¶ååˆ›å»ºå¯¹åº”çš„ XMLStatementBuilder å¯¹è±¡ï¼Œè¿›è¡Œæ ‡ç­¾è§£æã€‚</li><li>XMLStatementBuilder#parseStatementNode() æ–¹æ³•é‡Œé¢é¦–å…ˆä¼šè§£æ<code>&lt;select|insert|update|delete&gt;</code>æ ‡ç­¾é‡Œçš„æ‰€æœ‰å±æ€§ï¼Œç„¶ååˆ©ç”¨ LanguageDriver æ¥è§£æ SQL é…ç½®ï¼Œå°† SQL çš„æ‰€æœ‰ç‰‡æ®µï¼ˆåŒ…æ‹¬é™æ€SQLå’ŒåŠ¨æ€SQLï¼‰è§£ææˆå¯¹åº”çš„ SqlNode å¯¹è±¡ï¼Œç„¶åä½¿ç”¨ MixedSqlNode æ¥ä¿å­˜èµ·æ¥ï¼Œæœ€åæ ¹æ®æ˜¯å¦ä¸ºåŠ¨æ€ SQL æ¥åˆ›å»º DynamicSqlSource å¯¹è±¡æˆ–è€… RawSqlSource å¯¹è±¡ã€‚</li><li>å½“ <code>&lt;select|insert|update|delete&gt; </code>æ ‡ç­¾è§£æå®Œåï¼Œä¼šåˆ©ç”¨å·¥å…·ç±» MapperBuilderAssistant çš„ addMappedStatement() æ–¹æ³•æ¥å°†è§£æçš„æ‰€æœ‰ä¿¡æ¯å°è£…ä¸ºå¯¹åº”çš„ MappedStatement å¯¹è±¡ï¼Œç„¶åæ³¨å†Œåˆ° Configuration ä¸­ã€‚</li><li>XML æ–‡ä»¶è§£æå®Œåï¼ŒXMLMapperBuilder#parse() æ–¹æ³•ä¼šè°ƒç”¨ Configuration#addLoadedResource() æ–¹æ³•å°† XML æ–‡ä»¶çš„èµ„æºè·¯å¾„æ³¨å†Œåˆ°Configuration ä¸­ã€‚</li><li>æœ€åï¼Œåœ¨ XMLMapperBuilder#parse() æ–¹æ³•ä¸­è¿˜ä¼šè°ƒç”¨ XMLMapperBuilder#bindMapperForNamespace() æ–¹æ³•ï¼Œå°† Mapper æ¥å£æ³¨å†Œåˆ° Configuration ä¸­ã€‚æ¥å£æ³¨å†Œåº•å±‚æ˜¯ä½¿ç”¨ MapperRegistry ç±»ï¼Œè¿™ä¸ªç±»ä¼šä¿å­˜ç€æ‰€æœ‰ Mapper æ¥å£çš„æ³¨å†Œä¿¡æ¯ã€‚åœ¨æ³¨å†Œæ—¶ï¼Œä¼šä¸º Mapper æ¥å£åˆ›å»ºå¯¹åº”çš„ MapperFactoryBeanï¼›å½“æ‰§è¡Œ Mapper æ—¶ï¼Œå¯ä»¥æ ¹æ®å½“å‰ SqlSession åˆ›å»º Mapper æ¥å£å¯¹åº”çš„ MapperProxy ä»£ç†å®ä¾‹ã€‚</li><li>XMLMapperBuilder#bindMapperForNamespace() æ–¹æ³•åœ¨ Mapper æ¥å£æ³¨å†Œåï¼Œè¿˜ä¼šåˆ›å»º MapperAnnotationBuilder å¯¹è±¡æ¥è§£æ Mapper æ¥å£å¸¦ SQL æ³¨è§£æ–¹æ³•ï¼Œä¹Ÿæ˜¯ç”Ÿæˆå¯¹åº”çš„ MappedStatement ç„¶åæ³¨å†Œåˆ° Configuration ä¸­ã€‚</li></ol><hr><hr><h2 id="3-è·å–sqlSession">3.è·å–sqlSession</h2><p><code>SqlSession sqlSession = sqlSessionFactory.openSession();</code></p><p>sqlSessionæ˜¯æ“ä½œæ•°æ®åº“çš„é«˜çº§æ¥å£ï¼Œæˆ‘ä»¬æ“ä½œæ•°æ®åº“éƒ½æ˜¯é€šè¿‡è¿™ä¸ªæ¥å£æ“ä½œçš„ã€‚è·å–sqlSessionæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ä»æ•°æ®æºä¸­è·å–çš„ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯ä»è¿æ¥ä¸­è·å–ã€‚ è·å–åˆ°çš„éƒ½æ˜¯DefaultSqlSessionå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯sqlSessionçš„é»˜è®¤å®ç°ã€‚</p><p>DefaultSqlSessionFactoryä¸­openSessionæ˜¯æœ‰ä¸¤ç§æ–¹æ³•å®ç°</p><p>ä¸€ç§æ˜¯openSessionFromDataSourceï¼Œå¦ä¸€ç§æ˜¯openSessionFromConnectionã€‚</p><p>è¿™ä¸¤ç§æ˜¯ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿä»å­—é¢æ„ä¹‰ä¸Šå°†ï¼Œä¸€ç§æ˜¯ä»æ•°æ®æºä¸­è·å–SqlSessionå¯¹è±¡ï¼Œä¸€ç§æ˜¯ç”±å·²æœ‰è¿æ¥è·å–SqlSessionã€‚SqlSessionå®é™…æ˜¯å¯¹æ•°æ®åº“è¿æ¥çš„ä¸€å±‚åŒ…è£…ï¼Œæ•°æ®åº“è¿æ¥æ˜¯ä¸ªçè´µçš„èµ„æºï¼Œå¦‚æœé¢‘ç¹çš„åˆ›å»ºé”€æ¯å°†ä¼šå½±å“ååé‡ï¼Œå› æ­¤ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± åŒ–æŠ€æœ¯å°±å¯ä»¥å¤ç”¨æ•°æ®åº“è¿æ¥äº†ã€‚å› æ­¤openSessionFromDataSourceä¼šä»æ•°æ®åº“è¿æ¥æ± ä¸­è·å–ä¸€ä¸ªè¿æ¥ï¼Œç„¶ååŒ…è£…æˆä¸€ä¸ªSqlSessionå¯¹åƒã€‚openSessionFromConnectionåˆ™æ˜¯ç›´æ¥åŒ…è£…å·²æœ‰çš„è¿æ¥å¹¶è¿”å›SqlSessionå¯¹è±¡ã€‚</p><p>openSessionFromDataSource ä¸»è¦ç»å†äº†ä»¥ä¸‹å‡ æ­¥ï¼š</p><ol><li>ä»è·å–configurationä¸­è·å–Environmentå¯¹è±¡ï¼ŒEnvironmentåŒ…å«äº†æ•°æ®åº“é…ç½®</li><li>ä»Environmentè·å–DataSourceæ•°æ®æº</li><li>ä»DataSourceæ•°æ®æºä¸­è·å–Connectionè¿æ¥å¯¹è±¡</li><li>ä»DataSourceæ•°æ®æºä¸­è·å–TransactionFactoryäº‹ç‰©å·¥å‚</li><li>ä»TransactionFactoryä¸­åˆ›å»ºäº‹ç‰©Transactionå¯¹è±¡</li><li>åˆ›å»ºExecutorå¯¹è±¡</li><li>åŒ…è£…configurationå’ŒExecutorå¯¹è±¡æˆDefaultSqlSessionå¯¹è±¡</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> SqlSession <span class="title function_">openSessionFromDataSource</span><span class="params">(ExecutorType execType, TransactionIsolationLevel level, <span class="type">boolean</span> autoCommit)</span> &#123;</span><br><span class="line">  <span class="type">Transaction</span> <span class="variable">tx</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> configuration.getEnvironment();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">TransactionFactory</span> <span class="variable">transactionFactory</span> <span class="operator">=</span> getTransactionFactoryFromEnvironment(environment);</span><br><span class="line">    tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Executor</span> <span class="variable">executor</span> <span class="operator">=</span> configuration.newExecutor(tx, execType);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultSqlSession</span>(configuration, executor, autoCommit);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    closeTransaction(tx); <span class="comment">// may have fetched a connection so lets call close()</span></span><br><span class="line">    <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">&quot;Error opening session.  Cause: &quot;</span> + e, e);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ErrorContext.instance().reset();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="4-è·å–mapperä»£ç†ç±»">4.è·å–mapperä»£ç†ç±»</h2><p><code>UserMapper userMapper = sqlSession.getMapper(UserMapper.class);</code></p><p>åœ¨åˆ›å»ºSqlSessionFactoryå·¥å‚ï¼Œå°†mapperæ¥å£æ³¨å†Œåˆ°MapperRegistryä¸­ã€‚</p><p>DefaultSqlSessionçš„getMapperæ–¹æ³•ï¼Œå°±æ˜¯é€šè¿‡MapperRegistryå¯¹è±¡è·å¾—Mapperå®ä¾‹ã€‚</p><div class="tabs" id="af74caa2-0e72-4103-b522-80bb5ac3bd3b"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#af74caa2-0e72-4103-b522-80bb5ac3bd3b-1"><i class="fas fa-bug"></i>1</button></li><li class="tab"><button type="button" data-href="#af74caa2-0e72-4103-b522-80bb5ac3bd3b-2"><i class="fas fa-cannabis"></i>2</button></li><li class="tab"><button type="button" data-href="#af74caa2-0e72-4103-b522-80bb5ac3bd3b-3"><i class="fas fa-candy-cane"></i>3</button></li><li class="tab"><button type="button" data-href="#af74caa2-0e72-4103-b522-80bb5ac3bd3b-4"><i class="fas fa-child"></i>4</button></li><li class="tab"><button type="button" data-href="#af74caa2-0e72-4103-b522-80bb5ac3bd3b-5"><i class="fas fa-heartbeat"></i>MapperProxy</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="af74caa2-0e72-4103-b522-80bb5ac3bd3b-1"><p><mark class="hl-label blue">DefaultSqlSession#getMapper</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getMapper</span><span class="params">(Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> configuration.getMapper(type, <span class="built_in">this</span>);<span class="comment">//-&gt;2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="af74caa2-0e72-4103-b522-80bb5ac3bd3b-2"><p><mark class="hl-label green">Configuration#getMapper</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getMapper</span><span class="params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> mapperRegistry.getMapper(type, sqlSession);<span class="comment">//-&gt;3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="af74caa2-0e72-4103-b522-80bb5ac3bd3b-3"><p><mark class="hl-label blue">mapperRegistry#getMapper</mark></p><p><code>MapperRegistry</code> ä¸­æœ‰ä¸ªgetMapperæ–¹æ³•ï¼Œå®é™…ä¸Šæ˜¯ä»æˆå‘˜å˜é‡<code>knownMappers</code>ä¸­è·å–çš„ï¼Œè¿™ä¸ª<code>knownMappers</code>æ˜¯ä¸ªkey-valueå½¢å¼çš„ç¼“å­˜ï¼Œkeyæ˜¯mapperæ¥å£çš„classå¯¹è±¡ï¼Œvalueæ˜¯<code>MapperProxyFactory</code>ä»£ç†å·¥å‚ï¼Œè¿™ä¸ªå·¥å‚å°±æ˜¯ç”¨æ¥åˆ›å»ºMapperProxyä»£ç†ç±»çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getMapper</span><span class="params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> &#123;</span><br><span class="line">  <span class="keyword">final</span> MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);</span><br><span class="line">  <span class="keyword">if</span> (mapperProxyFactory == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindingException</span>(<span class="string">&quot;Type &quot;</span> + type + <span class="string">&quot; is not known to the MapperRegistry.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mapperProxyFactory.newInstance(sqlSession);<span class="comment">//-&gt;4</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindingException</span>(<span class="string">&quot;Error getting mapper instance. Cause: &quot;</span> + e, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="af74caa2-0e72-4103-b522-80bb5ac3bd3b-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T <span class="title function_">newInstance</span><span class="params">(SqlSession sqlSession)</span> &#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªMapperxyå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å®ç°äº†JDKåŠ¨æ€ä»£ç†ä¸­çš„InvocationHandleræ¥å£</span></span><br><span class="line">    <span class="keyword">final</span> MapperProxy&lt;T&gt; mapperProxy = <span class="keyword">new</span> <span class="title class_">MapperProxy</span>&lt;T&gt;(sqlSession, mapperInterface, methodCache);</span><br><span class="line">    <span class="keyword">return</span> newInstance(mapperProxy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> T <span class="title function_">newInstance</span><span class="params">(MapperProxy&lt;T&gt; mapperProxy)</span> &#123;</span><br><span class="line">    <span class="comment">//æ–¹æ³•è¢«è°ƒç”¨æ—¶ä¼šè¢«mapperProxyæ‹¦æˆª,ä¹Ÿå°±æ˜¯æ‰§è¡ŒmapperProxy.invoke()æ–¹æ³•Â  </span></span><br><span class="line">    <span class="keyword">return</span> (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;mapperInterface&#125;, mapperProxy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="af74caa2-0e72-4103-b522-80bb5ac3bd3b-5"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapperProxy</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span>, Serializable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">6424540398559729838L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SqlSession sqlSession;</span><br><span class="line">    <span class="comment">//Mapperæ¥å£</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; mapperInterface;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Mapperæ¥å£ä¸­çš„æ¯ä¸ªæ–¹æ³•éƒ½ä¼šç”Ÿæˆä¸€ä¸ªMapperMethodå¯¹è±¡, methodCacheç»´æŠ¤ç€ä»–ä»¬çš„å¯¹åº”å…³ç³»</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Method, MapperMethod&gt; methodCache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MapperProxy</span><span class="params">(SqlSession sqlSession, Class&lt;T&gt; mapperInterface, Map&lt;Method, MapperMethod&gt; methodCache)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sqlSession = sqlSession;</span><br><span class="line">        <span class="built_in">this</span>.mapperInterface = mapperInterface;</span><br><span class="line">        <span class="built_in">this</span>.methodCache = methodCache;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿™é‡Œä¼šæ‹¦æˆªMapperæ¥å£çš„æ‰€æœ‰æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯Objectä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œç›´æ¥æ‰§è¡Œã€‚å¦‚toString(),hashCode()ç­‰</span></span><br><span class="line">        <span class="keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>, args);<span class="comment">//</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å…¶ä»–Mapperæ¥å£å®šä¹‰çš„æ–¹æ³•äº¤ç”±mapperMethodæ¥æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">MapperMethod</span> <span class="variable">mapperMethod</span> <span class="operator">=</span> cachedMapperMethod(method);</span><br><span class="line">        <span class="keyword">return</span> mapperMethod.execute(sqlSession, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MapperMethod <span class="title function_">cachedMapperMethod</span><span class="params">(Method method)</span> &#123;</span><br><span class="line">        <span class="type">MapperMethod</span> <span class="variable">mapperMethod</span> <span class="operator">=</span> methodCache.get(method);</span><br><span class="line">        <span class="keyword">if</span> (mapperMethod == <span class="literal">null</span>) &#123;</span><br><span class="line">            mapperMethod = <span class="keyword">new</span> <span class="title class_">MapperMethod</span>(mapperInterface, method, sqlSession.getConfiguration());</span><br><span class="line">            methodCache.put(method, mapperMethod);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mapperMethod;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><blockquote><p>ä¸‹é¢æ˜¯ä½¿ç”¨é˜¿å°”è¨æ–¯æŸ¥çœ‹åç¼–è¯‘ç”Ÿæˆçš„ä»£ç†ç±»å¯¹è±¡</p></blockquote><div class="tabs" id="6f4aa4a4-1ec9-4df4-8bd7-254808a5e2b4"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6f4aa4a4-1ec9-4df4-8bd7-254808a5e2b4-1"><i class="fas fa-cat"></i>Mapperæ¥å£</button></li><li class="tab"><button type="button" data-href="#6f4aa4a4-1ec9-4df4-8bd7-254808a5e2b4-2"><i class="fas fa-horse"></i>ä»£ç†å¯¹è±¡ï¼ˆçœç•¥ç‰ˆï¼‰</button></li><li class="tab"><button type="button" data-href="#6f4aa4a4-1ec9-4df4-8bd7-254808a5e2b4-3"><i class="fas fa-dove"></i>ä»£ç†å¯¹è±¡ï¼ˆå®Œæ•´ç‰ˆï¼‰</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6f4aa4a4-1ec9-4df4-8bd7-254808a5e2b4-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®idæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    User <span class="title function_">getUserById</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> Integer id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6f4aa4a4-1ec9-4df4-8bd7-254808a5e2b4-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">$Proxy7</span></span><br><span class="line">        <span class="keyword">extends</span> <span class="title class_">Proxy</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m3;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> User <span class="title function_">getUserById</span><span class="params">(Integer n)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (User) <span class="built_in">this</span>.h.invoke(<span class="built_in">this</span>, m3, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;n&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $Proxy7(InvocationHandler invocationHandler) &#123;</span><br><span class="line">        <span class="built_in">super</span>(invocationHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            m3 = Class.forName(<span class="string">&quot;com.atguigu.mybatis.mapper.UserMapper&quot;</span>).getMethod(<span class="string">&quot;getUserById&quot;</span>, Class.forName(<span class="string">&quot;java.lang.Integer&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Proxy</span> <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line">    <span class="keyword">protected</span> InvocationHandler h;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">Proxy</span><span class="params">(InvocationHandler h)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.h = h;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6f4aa4a4-1ec9-4df4-8bd7-254808a5e2b4-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sun.proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.mybatis.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.mybatis.pojo.User;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.UndeclaredThrowableException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">$Proxy7</span></span><br><span class="line"><span class="keyword">extends</span> <span class="title class_">Proxy</span></span><br><span class="line"><span class="keyword">implements</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m1;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m2;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m3;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m0;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> User <span class="title function_">getUserById</span><span class="params">(Integer n)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (User)<span class="built_in">this</span>.h.invoke(<span class="built_in">this</span>, m3, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;n&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Error | RuntimeException throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> throwable;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UndeclaredThrowableException</span>(throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $Proxy7(InvocationHandler invocationHandler) &#123;</span><br><span class="line">        <span class="built_in">super</span>(invocationHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            m1 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;equals&quot;</span>, Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>));</span><br><span class="line">            m2 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;toString&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]);</span><br><span class="line">            m3 = Class.forName(<span class="string">&quot;com.atguigu.mybatis.mapper.UserMapper&quot;</span>).getMethod(<span class="string">&quot;getUserById&quot;</span>, Class.forName(<span class="string">&quot;java.lang.Integer&quot;</span>));</span><br><span class="line">            m0 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;hashCode&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchMethodException noSuchMethodException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodError</span>(noSuchMethodException.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (ClassNotFoundException classNotFoundException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoClassDefFoundError</span>(classNotFoundException.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Boolean)<span class="built_in">this</span>.h.invoke(<span class="built_in">this</span>, m1, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;object&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Error | RuntimeException throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> throwable;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UndeclaredThrowableException</span>(throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (String)<span class="built_in">this</span>.h.invoke(<span class="built_in">this</span>, m2, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Error | RuntimeException throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> throwable;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UndeclaredThrowableException</span>(throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Integer)<span class="built_in">this</span>.h.invoke(<span class="built_in">this</span>, m0, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Error | RuntimeException throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> throwable;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UndeclaredThrowableException</span>(throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h2 id="5-æ‰§è¡Œmapperæ¥å£æ–¹æ³•">5.æ‰§è¡Œmapperæ¥å£æ–¹æ³•</h2><p><code>User userInfo = userMapper.getUserById(1);</code></p><p>getUserByIdæ˜¯UserMapperæ¥å£ä¸­å®šä¹‰çš„ä¸€ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰ç¼–å†™UserMapperæ¥å£çš„çš„å®ç°ç±»ï¼Œé‚£ä¹ˆMybatisæ˜¯æ€ä¹ˆå¸®æˆ‘ä»¬æ‰§è¡Œçš„å‘¢ï¼Ÿ</p><p>å‰é¢è®²åˆ°ï¼Œè·å–mapperå¯¹è±¡æ—¶ï¼Œæ˜¯ä¼šè·å–åˆ°ä¸€ä¸ªMapperProxyFactoryå·¥å‚ç±»ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªMapperProxyä»£ç†ç±»ï¼Œåœ¨æ‰§è¡ŒMapperæ¥å£çš„æ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨MapperProxyçš„invokeæ–¹æ³•ã€‚</p><p>è¿™æ®µä»£ç åˆ¤æ–­æ­£åœ¨è¢«è°ƒç”¨çš„æ–¹æ³•æ˜¯å¦æ˜¯å£°æ˜åœ¨Objectç±»ä¸­æˆ–å…¶çˆ¶ç±»/æ¥å£ä¸­çš„æ–¹æ³•ã€‚å¦‚æœæ˜¯ï¼Œåˆ™æ‰§è¡Œifè¯­å¥å—å†…çš„ä»£ç æ¥å¤„ç†è¯¥æ–¹æ³•çš„è°ƒç”¨ï¼Œå¦åˆ™æ‰§è¡Œifè¯­å¥å—åé¢çš„ä»£ç æ¥å¤„ç†MapperMethodæ¥å£ä¸­çš„æ–¹æ³•è°ƒç”¨ã€‚</p><p>è¿™æ˜¯åŠ¨æ€ä»£ç†ä¸­å¸¸è§çš„æ¨¡å¼ï¼Œinvoke()æ–¹æ³•è´Ÿè´£å¤„ç†ä»£ç†å¯¹è±¡ä¸Šçš„æ–¹æ³•è°ƒç”¨ã€‚ifè¯­å¥å…è®¸ä»£ç†å¯¹è±¡ä»¥ä¸åŒçš„æ–¹å¼å¤„ç†æŸäº›ç‰¹å®šçš„æ–¹æ³•ï¼Œä¾‹å¦‚å°†æŸäº›æ–¹æ³•è°ƒç”¨è½¬å‘åˆ°ä»£ç†å¯¹è±¡çš„ç›®æ ‡å®ç°ä¸­ã€‚</p><p>å½“mapperæ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™å¯¹åº”çš„MapperProxyä¼šç”Ÿæˆç›¸åº”çš„MapperMethodå¹¶ä¸”ä¼šç¼“å­˜èµ·æ¥ï¼Œè¿™æ ·å½“å¤šæ¬¡è°ƒç”¨åŒä¸€ä¸ªmapperæ–¹æ³•æ—¶å€™åªä¼šç”Ÿæˆä¸€ä¸ªMapperMethodï¼Œæé«˜äº†æ—¶é—´å’Œå†…å­˜æ•ˆç‡ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1624267900596-1e05c90c-380e-439c-be2c-1c505ae5f283.png" alt="image.png"  /><h3 id="æ‰§è¡Œæµç¨‹">æ‰§è¡Œæµç¨‹</h3><div class="tabs" id="956d2f31-c54d-4609-88c6-5a7931978471"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#956d2f31-c54d-4609-88c6-5a7931978471-1"><i class="fas fa-bug"></i>MapperProxy#invoke</button></li><li class="tab"><button type="button" data-href="#956d2f31-c54d-4609-88c6-5a7931978471-2"><i class="fas fa-cannabis"></i>MapperMethod#execute</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="956d2f31-c54d-4609-88c6-5a7931978471-1"><p><mark class="hl-label green">MapperProxy#invoke</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿™é‡Œä¼šæ‹¦æˆªMapperæ¥å£çš„æ‰€æœ‰æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯Objectä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œç›´æ¥æ‰§è¡Œã€‚å¦‚toString(),hashCode()ç­‰</span></span><br><span class="line">    <span class="keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>, args);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿”å›ç¼“å­˜çš„MapperMethodInvokerå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">MapperMethod</span> <span class="variable">mapperMethod</span> <span class="operator">=</span> cachedMapperMethod(method);</span><br><span class="line">    <span class="comment">//å…¶ä»–Mapperæ¥å£å®šä¹‰çš„æ–¹æ³•äº¤ç”±mapperMethodæ¥æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">return</span> mapperMethod.execute(sqlSession, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> MapperMethod <span class="title function_">cachedMapperMethod</span><span class="params">(Method method)</span> &#123;</span><br><span class="line">    <span class="type">MapperMethod</span> <span class="variable">mapperMethod</span> <span class="operator">=</span> methodCache.get(method);</span><br><span class="line">    <span class="keyword">if</span> (mapperMethod == <span class="literal">null</span>) &#123;</span><br><span class="line">        mapperMethod = <span class="keyword">new</span> <span class="title class_">MapperMethod</span>(mapperInterface, method, sqlSession.getConfiguration());</span><br><span class="line">        methodCache.put(method, mapperMethod);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mapperMethod;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="956d2f31-c54d-4609-88c6-5a7931978471-2"><p><mark class="hl-label green">MapperMethod#execute</mark></p><p>è€Œå½“æ‰§è¡ŒMapperMethodçš„executeæ–¹æ³•çš„æ—¶å€™ï¼Œæ ¹æ®å½“å‰MapperMethodå¯¹åº”çš„mapperé…ç½®ä¼šæ‰§è¡ŒSessionçš„insert, update, delete, select, selectList, selectMap, selectCursor, selectOneæˆ–flushStatementsæ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">(SqlSession sqlSession, Object[] args)</span> &#123;</span><br><span class="line">  Object result;</span><br><span class="line">  <span class="keyword">switch</span> (command.getType()) &#123;</span><br><span class="line">    <span class="keyword">case</span> INSERT: &#123;</span><br><span class="line">      <span class="type">Object</span> <span class="variable">param</span> <span class="operator">=</span> method.convertArgsToSqlCommandParam(args);</span><br><span class="line">      result = rowCountResult(sqlSession.insert(command.getName(), param));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> UPDATE: &#123;</span><br><span class="line">      <span class="type">Object</span> <span class="variable">param</span> <span class="operator">=</span> method.convertArgsToSqlCommandParam(args);</span><br><span class="line">      result = rowCountResult(sqlSession.update(command.getName(), param));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> DELETE: &#123;</span><br><span class="line">      <span class="type">Object</span> <span class="variable">param</span> <span class="operator">=</span> method.convertArgsToSqlCommandParam(args);</span><br><span class="line">      result = rowCountResult(sqlSession.delete(command.getName(), param));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> SELECT:</span><br><span class="line">      <span class="keyword">if</span> (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123;</span><br><span class="line">        executeWithResultHandler(sqlSession, args);</span><br><span class="line">        result = <span class="literal">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsMany()) &#123;</span><br><span class="line">        result = executeForMany(sqlSession, args);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsMap()) &#123;</span><br><span class="line">        result = executeForMap(sqlSession, args);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsCursor()) &#123;</span><br><span class="line">        result = executeForCursor(sqlSession, args);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">param</span> <span class="operator">=</span> method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = sqlSession.selectOne(command.getName(), param);</span><br><span class="line">        <span class="keyword">if</span> (method.returnsOptional()</span><br><span class="line">            &amp;&amp; (result == <span class="literal">null</span> || !method.getReturnType().equals(result.getClass()))) &#123;</span><br><span class="line">          result = Optional.ofNullable(result);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FLUSH:</span><br><span class="line">      result = sqlSession.flushStatements();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindingException</span>(<span class="string">&quot;Unknown execution method for: &quot;</span> + command.getName());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (result == <span class="literal">null</span> &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindingException</span>(<span class="string">&quot;Mapper method &#x27;&quot;</span> + command.getName()</span><br><span class="line">        + <span class="string">&quot; attempted to return null from a method with a primitive return type (&quot;</span> + method.getReturnType() + <span class="string">&quot;).&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="Executor">Executor</h3><p>æˆ‘ä»¬æ¥çœ‹DefaultSqlSessionä¸€ä¸ªå…·ä½“çš„å®ç°æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">selectList</span><span class="params">(String statement, Object parameter, RowBounds rowBounds)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">MappedStatement</span> <span class="variable">ms</span> <span class="operator">=</span> configuration.getMappedStatement(statement);</span><br><span class="line">      List&lt;E&gt; result = executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">&quot;Error querying database.  Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>çœŸæ­£æ‰§è¡Œçš„ä»£ç ä¸»ä½“åœ¨Executorå¯¹è±¡é‡Œé¢ã€‚</p><p>Mybatiså¯¹å¤–ç»Ÿä¸€æä¾›äº†ä¸€ä¸ªæ“ä½œæ¥å£ç±»Executorï¼Œæä¾›çš„æ¥å£æ–¹æ³•æœ‰updateã€queryã€flushStatementsã€commitã€rollbackç­‰æ¥å£å‡½æ•°ï¼Œæºç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Executor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">ResultHandler</span> <span class="variable">NO_RESULT_HANDLER</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">update</span><span class="params">(MappedStatement ms, Object parameter)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">    &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey cacheKey, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">    &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">    List&lt;BatchResult&gt; <span class="title function_">flushStatements</span><span class="params">()</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//äº‹ç‰©æäº¤</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(<span class="type">boolean</span> required)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//äº‹ç‰©å›æ»š</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">rollback</span><span class="params">(<span class="type">boolean</span> required)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºCacheKey</span></span><br><span class="line">    CacheKey <span class="title function_">createCacheKey</span><span class="params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ˜¯å¦å¼€å¯ç¼“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isCached</span><span class="params">(MappedStatement ms, CacheKey key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ¸…é™¤æœ¬åœ°ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">clearLocalCache</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å»¶è¿ŸåŠ è½½</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deferLoad</span><span class="params">(MappedStatement ms, MetaObject resultObject, String property, CacheKey key, Class&lt;?&gt; targetType)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–äº‹ç‰©ç®¡ç†å™¨</span></span><br><span class="line">    Transaction <span class="title function_">getTransaction</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å…³é—­è¿æ¥</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">close</span><span class="params">(<span class="type">boolean</span> forceRollback)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Executoræ˜¯å¦å…³é—­</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isClosed</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setExecutorWrapper</span><span class="params">(Executor executor)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“å®ç°ç±»æœ‰æŠ½è±¡ç±»BaseExecutorã€å®ç°ç±»CachingExecutorã€å®ç°ç±»BatchExecutorã€å®ç°ç±»ReuseExecutorå’Œå®ç°ç±»SimpleExecutorã€‚</p><p>å…·ä½“é€‰ç”¨å“ªä¸ªå­ç±»SimpleExecutorã€ReuseExecutorå’ŒBatchExecutorå®ç°ï¼Œå¯ä»¥åœ¨Mybatisçš„é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p><p>ä¸é…ç½®é»˜è®¤ä½¿ç”¨SimpleExecutor</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;defaultExecutorType&quot;</span> <span class="attr">value</span>=<span class="string">&quot;REUSE&quot;</span>/&gt;</span> <span class="comment">&lt;!--SIMPLEã€REUSEã€BATCH--&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span>  </span><br></pre></td></tr></table></figure><p>Executoråˆ†æˆä¸¤å¤§ç±»ï¼Œä¸€ç±»æ˜¯CacheExecutorï¼Œå¦ä¸€ç±»æ˜¯æ™®é€šExecutorã€‚</p><p>æ™®é€šç±»åˆåˆ†ä¸ºï¼š</p><p>ExecutorType.SIMPLE: è¿™ä¸ªæ‰§è¡Œå™¨ç±»å‹ä¸åšç‰¹æ®Šçš„äº‹æƒ…ã€‚å®ƒä¸ºæ¯ä¸ªè¯­å¥çš„æ‰§è¡Œåˆ›å»ºä¸€ä¸ªæ–°çš„é¢„å¤„ç†è¯­å¥ã€‚<br>ExecutorType.REUSE: è¿™ä¸ªæ‰§è¡Œå™¨ç±»å‹ä¼šå¤ç”¨é¢„å¤„ç†è¯­å¥ã€‚<br>ExecutorType.BATCH: è¿™ä¸ªæ‰§è¡Œå™¨ä¼šæ‰¹é‡æ‰§è¡Œæ‰€æœ‰æ›´æ–°è¯­å¥,å¦‚æœ SELECT åœ¨å®ƒä»¬ä¸­é—´æ‰§è¡Œè¿˜ä¼šæ ‡å®šå®ƒä»¬æ˜¯ å¿…é¡»çš„,æ¥ä¿è¯ä¸€ä¸ªç®€å•å¹¶æ˜“äºç†è§£çš„è¡Œä¸ºã€‚</p><p>åˆ†åˆ«å¯¹åº”SimpleExecutorï¼ŒReuseExecutorï¼ŒBatchExecutorï¼Œä»–ä»¬éƒ½ç»§æ‰¿äºBaseExecutorï¼ŒBatchExecutorä¸“é—¨ç”¨äºæ‰§è¡Œæ‰¹é‡sqlæ“ä½œï¼ŒReuseExecutorä¼šé‡ç”¨statementæ‰§è¡Œsqlæ“ä½œï¼ŒSimpleExecutoråªæ˜¯ç®€å•æ‰§è¡Œsqlæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1617638902287-25c47fa7-93ad-4e39-84e2-2905756c61e5.png" alt="image.png" style="zoom: 50%;" /><p>CacheExecutoræœ‰ä¸€ä¸ªé‡è¦å±æ€§delegateï¼Œå®ƒä¿å­˜çš„æ˜¯æŸç±»æ™®é€šçš„Executorï¼Œå€¼åœ¨æ„é€ æ—¶ä¼ å…¥ã€‚æ‰§è¡Œæ•°æ®åº“updateæ“ä½œæ—¶ï¼Œå®ƒç›´æ¥è°ƒç”¨delegateçš„updateæ–¹æ³•ï¼Œæ‰§è¡Œqueryæ–¹æ³•æ—¶å…ˆå°è¯•ä»cacheä¸­å–å€¼ï¼Œå–ä¸åˆ°å†è°ƒç”¨delegateçš„æŸ¥è¯¢æ–¹æ³•ï¼Œå¹¶å°†æŸ¥è¯¢ç»“æœå­˜å…¥cacheä¸­ã€‚</p><hr><h3 id="StatementHandler">StatementHandler</h3><p>è¿™4ä¸ªExcecutoræ‰§è¡Œsqlæ“ä½œçš„æœ€ç»ˆéƒ½è°ƒç”¨äº†StatementHandler æ¥æ‰§è¡Œï¼Œæˆ‘ä»¬ä»¥SimpleExecutorä¸ºä¾‹</p><div class="tabs" id="da133ce1-5f38-4a60-a5c9-2a6b72921f73"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#da133ce1-5f38-4a60-a5c9-2a6b72921f73-1"><i class="fas fa-seedling"></i>1</button></li><li class="tab"><button type="button" data-href="#da133ce1-5f38-4a60-a5c9-2a6b72921f73-2"><i class="fas fa-leaf"></i>statementHandleræ¥å£</button></li><li class="tab"><button type="button" data-href="#da133ce1-5f38-4a60-a5c9-2a6b72921f73-3"><i class="fab fa-apple"></i>3</button></li><li class="tab"><button type="button" data-href="#da133ce1-5f38-4a60-a5c9-2a6b72921f73-4"><i class="fas fa-tree"></i>4</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="da133ce1-5f38-4a60-a5c9-2a6b72921f73-1"><p><mark class="hl-label blue">SimpleExecutor#doQuery</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">doQuery</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">  <span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> ms.getConfiguration();</span><br><span class="line">    <span class="type">StatementHandler</span> <span class="variable">handler</span> <span class="operator">=</span> configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">    stmt = prepareStatement(handler, ms.getStatementLog());<span class="comment">//-&gt;3</span></span><br><span class="line">    <span class="keyword">return</span> handler.query(stmt, resultHandler);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    closeStatement(stmt);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="da133ce1-5f38-4a60-a5c9-2a6b72921f73-2"><p>å¯ä»¥çœ‹å‡ºï¼ŒExecutoræœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸ªä¸­ä»‹ï¼Œå…·ä½“çš„äº‹æƒ…åŸæ¥æ˜¯StatementHandleræ¥å®Œæˆçš„ã€‚åœ¨å®ƒè¿™é‡Œä¼šä½¿ç”¨parameterHandlerå’ŒResultHandlerå¯¹è±¡ä¸ºæˆ‘ä»¬ç»‘å®šSQLå‚æ•°å’Œç»„è£…æœ€åçš„ç»“æœè¿”å›ã€‚</p><p>æ¥çœ‹çœ‹statementHandleræ¥å£çš„å®šä¹‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StatementHandler</span> &#123;</span><br><span class="line">    <span class="comment">//è·å–Statement</span></span><br><span class="line">    Statement <span class="title function_">prepare</span><span class="params">(Connection connection, Integer transactionTimeout)</span>;</span><br><span class="line">    <span class="comment">//è®¾ç½®å‚æ•°</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">parameterize</span><span class="params">(Statement statement)</span>;</span><br><span class="line">    <span class="comment">//æ‰¹å¤„ç†</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">batch</span><span class="params">(Statement statement)</span>;</span><br><span class="line">    <span class="comment">//æ›´æ–°å¤„ç†</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">update</span><span class="params">(Statement statement)</span>;</span><br><span class="line">    <span class="comment">//æŸ¥æ‰¾å¤„ç†</span></span><br><span class="line">    &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">(Statement statement, ResultHandler resultHandler)</span>;</span><br><span class="line">    &lt;E&gt; Cursor&lt;E&gt; <span class="title function_">queryCursor</span><span class="params">(Statement statement)</span>;</span><br><span class="line">    <span class="comment">//è·å¾—BoundSql</span></span><br><span class="line">    BoundSql <span class="title function_">getBoundSql</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">//è·å¾—ParameterHandler</span></span><br><span class="line">    ParameterHandler <span class="title function_">getParameterHandler</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨MyBatiså®ç°äº†StatementHandler çš„æœ‰å››ä¸ªç±»ï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1515111-20190803171258049-449567015.png" alt="img" style="zoom: 33%;" /><p>æœ‰æ²¡æœ‰æ„Ÿè§‰å’Œ <code>Executor</code> çš„ç»§æ‰¿ä½“ç³»å¾ˆç›¸ä¼¼å‘¢ï¼Ÿ</p><p>åˆ†åˆ«æœ‰ä¸¤ä¸ªå®ç°ç±» <code>BaseStatementHandler</code> å’Œ <code>RoutingStatementHandler</code>ï¼ŒBaseStatementHandler æœ‰ä¸‰ä¸ªå®ç°ç±», ä»–ä»¬åˆ†åˆ«æ˜¯ SimpleStatementHandlerã€PreparedStatementHandler å’Œ CallableStatementHandlerã€‚</p><p>RoutingStatementHandler: RoutingStatementHandler å¹¶æ²¡æœ‰å¯¹ Statement å¯¹è±¡è¿›è¡Œä½¿ç”¨ï¼Œåªæ˜¯æ ¹æ®StatementType æ¥åˆ›å»ºä¸€ä¸ªä»£ç†ï¼Œä»£ç†çš„å°±æ˜¯å¯¹åº”Handlerçš„ä¸‰ç§å®ç°ç±»ã€‚åœ¨MyBatiså·¥ä½œæ—¶,ä½¿ç”¨çš„StatementHandler æ¥å£å¯¹è±¡å®é™…ä¸Šå°±æ˜¯ RoutingStatementHandler å¯¹è±¡.æˆ‘ä»¬å¯ä»¥ç†è§£ä¸º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">StatementHandler</span> <span class="variable">statmentHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RountingStatementHandler</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">RoutingStatementHandler</span><span class="params">(Executor executor, MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ® statementType åˆ›å»ºå¯¹åº”çš„ Statement å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">switch</span> (ms.getStatementType()) &#123;</span><br><span class="line">    <span class="keyword">case</span> STATEMENT:</span><br><span class="line">      delegate = <span class="keyword">new</span> <span class="title class_">SimpleStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> PREPARED:</span><br><span class="line">      delegate = <span class="keyword">new</span> <span class="title class_">PreparedStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> CALLABLE:</span><br><span class="line">      delegate = <span class="keyword">new</span> <span class="title class_">CallableStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExecutorException</span>(<span class="string">&quot;Unknown statement type: &quot;</span> + ms.getStatementType());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>BaseStatementHandler: æ˜¯ StatementHandler æ¥å£çš„å¦ä¸€ä¸ªå®ç°ç±».æœ¬èº«æ˜¯ä¸€ä¸ªæŠ½è±¡ç±».ç”¨äºç®€åŒ–StatementHandler æ¥å£å®ç°çš„éš¾åº¦,å±äºé€‚é…å™¨è®¾è®¡æ¨¡å¼ä½“ç°ï¼Œå®ƒä¸»è¦æœ‰ä¸‰ä¸ªå®ç°ç±»</p><ul><li>SimpleStatementHandler: ç®¡ç† Statement å¯¹è±¡å¹¶å‘æ•°æ®åº“ä¸­æ¨é€ä¸éœ€è¦é¢„ç¼–è¯‘çš„SQLè¯­å¥</li><li>PreparedStatementHandler: ç®¡ç† Statement å¯¹è±¡å¹¶å‘æ•°æ®ä¸­æ¨é€éœ€è¦é¢„ç¼–è¯‘çš„SQLè¯­å¥ï¼Œ</li><li>CallableStatementHandlerï¼šç®¡ç† Statement å¯¹è±¡å¹¶è°ƒç”¨æ•°æ®åº“ä¸­çš„å­˜å‚¨è¿‡ç¨‹</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="da133ce1-5f38-4a60-a5c9-2a6b72921f73-3"><p><mark class="hl-label green">SimpleExecutor#prepareStatement</mark></p><p>prepareæ–¹æ³•é‡Œé¢é¢„ç¼–è¯‘äº†SQLã€‚é‚£ä¹ˆæˆ‘ä»¬è¿™ä¸ªæ—¶å€™å¸Œæœ›è®¾ç½®å‚æ•°ã€‚</p><p>åœ¨Statementä¸­æˆ‘ä»¬æ˜¯ä½¿ç”¨parameterizeæ–¹æ³•è¿›è¡Œè®¾ç½®å‚æ•°çš„ã€‚è®©æˆ‘ä»¬çœ‹çœ‹PreparedStatementHandlerä¸­çš„parameterizeæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Statement <span class="title function_">prepareStatement</span><span class="params">(StatementHandler handler, Log statementLog)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">  Statement stmt;</span><br><span class="line">  <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> getConnection(statementLog);</span><br><span class="line">  stmt = handler.prepare(connection, transaction.getTimeout());</span><br><span class="line">  handler.parameterize(stmt);<span class="comment">//-&gt;4</span></span><br><span class="line">  <span class="keyword">return</span> stmt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="da133ce1-5f38-4a60-a5c9-2a6b72921f73-4"><p><mark class="hl-label blue">PreparedStatementHandler#parameterize</mark></p><p>parametersize æ–¹æ³•ä¹Ÿæ˜¯ç»ç”±æ‰§è¡Œå™¨æ¥ç®¡ç† parametersize çš„æ–¹æ³•è°ƒç”¨ï¼Œè¿™æ¬¡è¿˜æƒ³ä»¥SimpleStatementHandler ä¸ºä¾‹ä½†æ˜¯å´ä¸è¡Œäº†ï¼Ÿä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸º SimpleStatementHandler æ˜¯ä¸ªç©ºå®ç°äº†ï¼Œä¸ºä»€ä¹ˆæ˜¯nullå‘¢ï¼Ÿå› ä¸º SimpleStatementHandler åªè´Ÿè´£å¤„ç†ç®€å•SQLï¼Œèƒ½å¤Ÿç›´æ¥æŸ¥è¯¢å¾—åˆ°ç»“æœçš„SQLï¼Œä¾‹å¦‚:</p><p><code>select studenname from Student</code></p><p>è€Œ SimpleStatementHandler åˆä¸æ¶‰åŠåˆ°å‚æ•°çš„èµ‹å€¼é—®é¢˜ï¼Œé‚£ä¹ˆå‚æ•°èµ‹å€¼è¯¥åœ¨å“ªé‡Œè¿›è¡Œå‘¢ï¼Ÿå®é™…ä¸Šä¸ºå‚æ•°èµ‹å€¼è¿™æ­¥æ“ä½œæ˜¯åœ¨ <code>PreparedStatementHandler</code> ä¸­è¿›è¡Œçš„ï¼Œå› æ­¤æˆ‘ä»¬çš„ä¸»è¦å…³æ³¨ç‚¹åœ¨ PreparedStatementHandler ä¸­çš„parameterize æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parameterize</span><span class="params">(Statement statement)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">  parameterHandler.setParameters((PreparedStatement) statement);<span class="comment">//-&gt;5</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸ºå‚æ•°èµ‹å€¼çš„å·¥ä½œæ˜¯ç”±ä¸€ä¸ªå«åš parameterHandler å¯¹è±¡å®Œæˆçš„ï¼Œé‚£ä¹ˆè¿™ä¸ª parameterHandler åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰§è¡Œå™¨çš„ç¬¬ä¸‰ä¸ªç»„ä»¶ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1515111-20190803171333257-1822082319.png" alt="img" style="zoom:50%;" /><p>ç®€å•æè¿°ä¸€ä¸‹update æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ï¼š</p><ol><li>MyBatis æ¥æ”¶åˆ° update è¯·æ±‚åä¼šå…ˆæ‰¾åˆ° CachingExecutor ç¼“å­˜æ‰§è¡Œå™¨æŸ¥è¯¢æ˜¯å¦éœ€è¦åˆ·æ–°ç¼“å­˜ï¼Œç„¶åæ‰¾åˆ°BaseExecutor æ‰§è¡Œ update æ–¹æ³•ï¼›</li><li>BaseExecutor åŸºç¡€æ‰§è¡Œå™¨ä¼šæ¸…ç©ºä¸€çº§ç¼“å­˜ï¼Œç„¶åäº¤ç»™å†æ ¹æ®æ‰§è¡Œå™¨çš„ç±»å‹æ‰¾åˆ°å¯¹åº”çš„æ‰§è¡Œå™¨ï¼Œç»§ç»­æ‰§è¡Œ update æ–¹æ³•ï¼›</li><li>å…·ä½“çš„æ‰§è¡Œå™¨ä¼šå…ˆåˆ›å»º Configuration å¯¹è±¡ï¼Œæ ¹æ® Configuration å¯¹è±¡è°ƒç”¨ newStatementHandler æ–¹æ³•ï¼Œè¿”å› statementHandler çš„å¥æŸ„ï¼›</li><li>å…·ä½“çš„æ‰§è¡Œå™¨ä¼šè°ƒç”¨ prepareStatement æ–¹æ³•ï¼Œæ‰¾åˆ°æœ¬ç±»çš„ prepareStatement æ–¹æ³•åï¼Œå†æœ‰prepareStatement æ–¹æ³•è°ƒç”¨ StatementHandler çš„å­ç±» BaseStatementHandler ä¸­çš„ prepare æ–¹æ³•</li><li>BaseStatementHandler ä¸­çš„ prepare æ–¹æ³•ä¼šè°ƒç”¨ instantiateStatement å®ä¾‹åŒ–å…·ä½“çš„ Statement å¯¹è±¡å¹¶è¿”å›ç»™å…·ä½“çš„æ‰§è¡Œå™¨å¯¹è±¡</li><li>ç”±å…·ä½“çš„æ‰§è¡Œå™¨å¯¹è±¡è°ƒç”¨ parameterize æ–¹æ³•ç»™å‚æ•°è¿›è¡Œèµ‹å€¼ã€‚</li></ol><p>ç»­ä¸Šä¸Šé¢çš„ <code>parameter</code>æ–¹æ³•ï¼Œå…·ä½“äº¤ç»™ <code>ParameterHandler</code> è¿›è¡Œè¿›ä¸€æ­¥çš„èµ‹å€¼å¤„ç†</p><hr><h3 id="ParameterHandler">ParameterHandler</h3><p>ParameterHandler è¯‘ä¸ºå‚æ•°å¤„ç†å™¨ï¼Œè´Ÿè´£ä¸º PreparedStatement çš„ sql è¯­å¥å‚æ•°åŠ¨æ€èµ‹å€¼ï¼Œè¿™ä¸ªæ¥å£å¾ˆç®€å•åªæœ‰ä¸¤ä¸ªæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ParameterHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">  Object <span class="title function_">getParameterObject</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">setParameters</span><span class="params">(PreparedStatement ps)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ParameterHandler åªæœ‰ä¸€ä¸ªå®ç°ç±» <code>DefaultParameterHandler</code> ï¼Œ å®ƒå®ç°äº†è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚</p><ul><li>getParameterObjectï¼š ç”¨äºè¯»å–å‚æ•°</li><li>setParameters: ç”¨äºå¯¹ PreparedStatement çš„å‚æ•°èµ‹å€¼</li></ul><p>å‚æ•°å¤„ç†å™¨å¯¹è±¡æ˜¯åœ¨åˆ›å»º StatementHandler å¯¹è±¡çš„åŒæ—¶è¢«åˆ›å»ºçš„ï¼Œç”± Configuration å¯¹è±¡è´Ÿè´£åˆ›å»ºã€‚</p><p>åˆ›å»º ParameterHandler æ—¶ï¼Œéœ€è¦ä¼ å…¥SQLçš„mappedStatement å¯¹è±¡ï¼Œè¯»å–çš„å‚æ•°å’ŒSQLè¯­å¥</p><blockquote><p>æ³¨æ„ï¼šä¸€ä¸ª BoundSql å¯¹è±¡ï¼Œå°±ä»£è¡¨äº†ä¸€æ¬¡sqlè¯­å¥çš„å®é™…æ‰§è¡Œï¼Œè€Œ SqlSource å¯¹è±¡çš„è´£ä»»ï¼Œå°±æ˜¯æ ¹æ®ä¼ å…¥çš„å‚æ•°å¯¹è±¡ï¼ŒåŠ¨æ€è®¡ç®—è¿™ä¸ª BoundSqlï¼Œ ä¹Ÿå°±æ˜¯ Mapper æ–‡ä»¶ä¸­èŠ‚ç‚¹çš„è®¡ç®—ï¼Œæ˜¯ç”± SqlSource å®Œæˆçš„ï¼ŒSqlSource æœ€å¸¸ç”¨çš„å®ç°ç±»æ˜¯ DynamicSqlSource</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setParameters</span><span class="params">(PreparedStatement ps)</span> &#123;</span><br><span class="line">  ErrorContext.instance().activity(<span class="string">&quot;setting parameters&quot;</span>).object(mappedStatement.getParameterMap().getId());</span><br><span class="line">  <span class="comment">// parameterMappings å°±æ˜¯å¯¹ #&#123;&#125; æˆ–è€… $&#123;&#125; é‡Œé¢å‚æ•°çš„å°è£…</span></span><br><span class="line">  List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class="line">  <span class="keyword">if</span> (parameterMappings != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯å‚æ•°åŒ–çš„SQLï¼Œä¾¿éœ€è¦å¾ªç¯å–å‡ºå¹¶è®¾ç½®å‚æ•°çš„å€¼</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; parameterMappings.size(); i++) &#123;</span><br><span class="line">      <span class="type">ParameterMapping</span> <span class="variable">parameterMapping</span> <span class="operator">=</span> parameterMappings.get(i);</span><br><span class="line">      <span class="comment">// å¦‚æœå‚æ•°ç±»å‹ä¸æ˜¯ OUT ï¼Œè¿™ä¸ªç±»å‹ä¸ CallableStatementHandler æœ‰å…³</span></span><br><span class="line">      <span class="comment">// å› ä¸ºå­˜å‚¨è¿‡ç¨‹ä¸å­˜åœ¨è¾“å‡ºå‚æ•°ï¼Œæ‰€ä»¥å‚æ•°ä¸æ˜¯è¾“å‡ºå‚æ•°çš„æ—¶å€™ï¼Œå°±éœ€è¦è®¾ç½®ã€‚</span></span><br><span class="line">      <span class="keyword">if</span> (parameterMapping.getMode() != ParameterMode.OUT) &#123;</span><br><span class="line">        Object value;</span><br><span class="line">        <span class="comment">// å¾—åˆ°#&#123;&#125;  ä¸­çš„å±æ€§å</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">propertyName</span> <span class="operator">=</span> parameterMapping.getProperty();</span><br><span class="line">        <span class="comment">// å¦‚æœ propertyName æ˜¯ Map ä¸­çš„key</span></span><br><span class="line">        <span class="keyword">if</span> (boundSql.hasAdditionalParameter(propertyName)) &#123; <span class="comment">// issue #448 ask first for additional params</span></span><br><span class="line">          <span class="comment">// é€šè¿‡key æ¥å¾—åˆ° additionalParameter ä¸­çš„valueå€¼</span></span><br><span class="line">          value = boundSql.getAdditionalParameter(propertyName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœä¸æ˜¯ additionalParameters ä¸­çš„keyï¼Œè€Œä¸”ä¼ å…¥å‚æ•°æ˜¯ nullï¼Œ åˆ™value å°±æ˜¯null</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (parameterObject == <span class="literal">null</span>) &#123;</span><br><span class="line">          value = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœ typeHandlerRegistry ä¸­å·²ç»æ³¨å†Œäº†è¿™ä¸ªå‚æ•°çš„ Classå¯¹è±¡ï¼Œå³å®ƒæ˜¯Primitive æˆ–è€…æ˜¯String çš„è¯</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;</span><br><span class="line">          value = parameterObject;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// å¦åˆ™å°±æ˜¯ Map</span></span><br><span class="line">          <span class="type">MetaObject</span> <span class="variable">metaObject</span> <span class="operator">=</span> configuration.newMetaObject(parameterObject);</span><br><span class="line">          value = metaObject.getValue(propertyName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åœ¨é€šè¿‡SqlSource çš„parse æ–¹æ³•å¾—åˆ°parameterMappings çš„å…·ä½“å®ç°ä¸­ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°parameterMappingsçš„typeHandler</span></span><br><span class="line">        <span class="type">TypeHandler</span> <span class="variable">typeHandler</span> <span class="operator">=</span> parameterMapping.getTypeHandler();</span><br><span class="line">        <span class="comment">// è·å–typeHandler çš„jdbc type</span></span><br><span class="line">        <span class="type">JdbcType</span> <span class="variable">jdbcType</span> <span class="operator">=</span> parameterMapping.getJdbcType();</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="literal">null</span> &amp;&amp; jdbcType == <span class="literal">null</span>) &#123;</span><br><span class="line">          jdbcType = configuration.getJdbcTypeForNull();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          typeHandler.setParameter(ps, i + <span class="number">1</span>, value, jdbcType);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TypeException e) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeException</span>(<span class="string">&quot;Could not set parameters for mapping: &quot;</span> + parameterMapping + <span class="string">&quot;. Cause: &quot;</span> + e, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeException</span>(<span class="string">&quot;Could not set parameters for mapping: &quot;</span> + parameterMapping + <span class="string">&quot;. Cause: &quot;</span> + e, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h3 id="ResultSetHandler">ResultSetHandler</h3><p>å›æƒ³ä¸€ä¸‹ï¼Œä¸€æ¡ SQL çš„è¯·æ±‚è¿‡ç¨‹ä¼šç»è¿‡å“ªå‡ ä¸ªæ­¥éª¤ï¼Ÿ é¦–å…ˆä¼šç»è¿‡ Executor æ‰§è¡Œå™¨ï¼Œå®ƒä¸»è¦è´Ÿè´£ç®¡ç†åˆ›å»º StatementHandler å¯¹è±¡ï¼Œç„¶åç”± StatementHandler å¯¹è±¡åšæ•°æ®åº“çš„è¿æ¥ä»¥åŠç”Ÿæˆ Statement å¯¹è±¡ï¼Œå¹¶è§£æ SQL å‚æ•°ï¼Œç”± ParameterHandler å¯¹è±¡è´Ÿè´£æŠŠ Mapper æ–¹æ³•ä¸­çš„å‚æ•°æ˜ å°„åˆ° XML ä¸­çš„ SQL è¯­å¥ä¸­ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯è¿˜å°‘äº†ä¸€ä¸ªæ­¥éª¤ï¼Œå°±èƒ½å®Œæˆä¸€ä¸ªå®Œæ•´çš„ SQL è¯·æ±‚äº†ï¼Ÿæ²¡é”™ï¼Œè¿™æœ€åä¸€æ­¥å°±æ˜¯ SQL ç»“æœé›†çš„å¤„ç†å·¥ä½œï¼Œä¹Ÿå°±æ˜¯ <code>ResultSetHandler</code> çš„ä¸»è¦å·¥ä½œ</p><p>è¦äº†è§£ ResultSetHandler ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦äº†è§£ ResultSetHandlerçš„ç»§æ‰¿å…³ç³»ä»¥åŠåŸºæœ¬æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ResultSetHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†ç»“æœé›†</span></span><br><span class="line">  &lt;E&gt; List&lt;E&gt; <span class="title function_">handleResultSets</span><span class="params">(Statement stmt)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‰¹é‡å¤„ç†ç»“æœé›†</span></span><br><span class="line">  &lt;E&gt; Cursor&lt;E&gt; <span class="title function_">handleCursorResultSets</span><span class="params">(Statement stmt)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†å­˜å‚¨è¿‡ç¨‹çš„ç»“æœé›†</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">handleOutputParameters</span><span class="params">(CallableStatement cs)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ResultSetHandler æ˜¯åœ¨å¤„ç†æŸ¥è¯¢è¯·æ±‚çš„æ—¶å€™ç”± Configuration å¯¹è±¡è´Ÿè´£åˆ›å»ºã€‚</p><p>å›æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬åœ¨è¿›è¡Œä¼ ç»Ÿcrudæ“ä½œçš„æ—¶å€™ï¼Œå“ªäº›æ–¹æ³•æ˜¯éœ€è¦è¿”å›å€¼çš„ï¼Ÿå½“ç„¶æˆ‘ä»¬è¯´çš„è¿”å›å€¼æŒ‡çš„æ˜¯ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥çš„å€¼ï¼Œè€Œä¸æ˜¯æ ‡è¯†ç¬¦ï¼Œåº”è¯¥åªæœ‰æŸ¥è¯¢æ–¹æ³•å§ï¼Ÿæ‰€ä»¥ MyBatis åªé’ˆå¯¹ query æ–¹æ³•åšäº†è¿”å›å€¼çš„æ˜ å°„ã€‚</p><p>MyBatis åªæœ‰ä¸€ä¸ªé»˜è®¤çš„å®ç°ç±»å°±æ˜¯ <code>DefaultResultSetHandler</code>ï¼ŒResultSetHandler ä¸»è¦è´Ÿè´£å¤„ç†ä¸¤ä»¶äº‹</p><ol><li>å¤„ç† Statement æ‰§è¡Œåäº§ç”Ÿçš„ç»“æœé›†ï¼Œç”Ÿæˆç»“æœåˆ—è¡¨</li><li>å¤„ç†å­˜å‚¨è¿‡ç¨‹æ‰§è¡Œåçš„è¾“å‡ºå‚æ•°</li></ol><p>æŒ‰ç…§ Mapper æ–‡ä»¶ä¸­é…ç½®çš„ ResultType æˆ– ResultMap æ¥å°è£…æˆå¯¹åº”çš„å¯¹è±¡ï¼Œæœ€åå°†å°è£…çš„å¯¹è±¡è¿”å›å³å¯ã€‚</p><p>æ¥çœ‹ä¸€ä¸‹ä¸»è¦çš„æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Object&gt; <span class="title function_">handleResultSets</span><span class="params">(Statement stmt)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">  ErrorContext.instance().activity(<span class="string">&quot;handling results&quot;</span>).object(mappedStatement.getId());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> List&lt;Object&gt; multipleResults = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Object&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> <span class="variable">resultSetCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// è·å–ç¬¬ä¸€ä¸ªç»“æœé›†</span></span><br><span class="line">  <span class="type">ResultSetWrapper</span> <span class="variable">rsw</span> <span class="operator">=</span> getFirstResultSet(stmt);</span><br><span class="line">  <span class="comment">// è·å–ç»“æœæ˜ å°„</span></span><br><span class="line">  List&lt;ResultMap&gt; resultMaps = mappedStatement.getResultMaps();</span><br><span class="line">  <span class="comment">// ç»“æœæ˜ å°„çš„å¤§å°</span></span><br><span class="line">  <span class="type">int</span> <span class="variable">resultMapCount</span> <span class="operator">=</span> resultMaps.size();</span><br><span class="line">  <span class="comment">// æ ¡éªŒç»“æœæ˜ å°„çš„æ•°é‡</span></span><br><span class="line">  validateResultMapsCount(rsw, resultMapCount);</span><br><span class="line">  <span class="comment">// å¦‚æœResultSet åŒ…è£…å™¨ä¸æ˜¯nullï¼Œ å¹¶ä¸” resultmap çš„æ•°é‡  &gt;  resultSet çš„æ•°é‡çš„è¯</span></span><br><span class="line">  <span class="comment">// å› ä¸º resultSetCount ç¬¬ä¸€æ¬¡è‚¯å®šæ˜¯0ï¼Œæ‰€ä»¥ç›´æ¥åˆ¤æ–­ ResultSetWrapper æ˜¯å¦ä¸º 0 å³å¯</span></span><br><span class="line">  <span class="keyword">while</span> (rsw != <span class="literal">null</span> &amp;&amp; resultMapCount &gt; resultSetCount) &#123;</span><br><span class="line">    <span class="comment">// ä» resultMap ä¸­å–å‡º resultSet æ•°é‡</span></span><br><span class="line">    <span class="type">ResultMap</span> <span class="variable">resultMap</span> <span class="operator">=</span> resultMaps.get(resultSetCount);</span><br><span class="line">    <span class="comment">// å¤„ç†ç»“æœé›†, å…³é—­ç»“æœé›†</span></span><br><span class="line">    handleResultSet(rsw, resultMap, multipleResults, <span class="literal">null</span>);</span><br><span class="line">    rsw = getNextResultSet(stmt);</span><br><span class="line">    cleanUpAfterHandlingResultSet();</span><br><span class="line">    resultSetCount++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä» mappedStatement å–å‡ºç»“æœé›†</span></span><br><span class="line">  String[] resultSets = mappedStatement.getResultSets();</span><br><span class="line">  <span class="keyword">if</span> (resultSets != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (rsw != <span class="literal">null</span> &amp;&amp; resultSetCount &lt; resultSets.length) &#123;</span><br><span class="line">      <span class="type">ResultMapping</span> <span class="variable">parentMapping</span> <span class="operator">=</span> nextResultMaps.get(resultSets[resultSetCount]);</span><br><span class="line">      <span class="keyword">if</span> (parentMapping != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">nestedResultMapId</span> <span class="operator">=</span> parentMapping.getNestedResultMapId();</span><br><span class="line">        <span class="type">ResultMap</span> <span class="variable">resultMap</span> <span class="operator">=</span> configuration.getResultMap(nestedResultMapId);</span><br><span class="line">        handleResultSet(rsw, resultMap, <span class="literal">null</span>, parentMapping);</span><br><span class="line">      &#125;</span><br><span class="line">      rsw = getNextResultSet(stmt);</span><br><span class="line">      cleanUpAfterHandlingResultSet();</span><br><span class="line">      resultSetCount++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> collapseSingleResultList(multipleResults);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="6-æäº¤äº‹ç‰©">6.æäº¤äº‹ç‰©</h2><p><code>sqlSession.commit();</code></p><p>äº‹ç‰©å°±æ˜¯å°†è‹¥å¹²æ•°æ®åº“æ“ä½œçœ‹æˆä¸€ä¸ªå•å…ƒï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œå¦‚æœå¤±è´¥äº†ï¼Œåˆ™ä¼šæ‰§è¡Œæ‰§è¡Œå›æ»šæ“ä½œï¼Œæ¢å¤åˆ°å¼€å§‹æ‰§è¡Œçš„æ•°æ®åº“çŠ¶æ€ã€‚</p><hr><hr><h2 id="7-å…³é—­èµ„æº">7.å…³é—­èµ„æº</h2><p><code>sqlSession.close();</code></p><p>sqlSessionæ˜¯ç§å…±ç”¨èµ„æºï¼Œç”¨å®Œäº†è¦è¿”å›åˆ°æ± å­ä¸­ï¼Œä»¥ä¾›å…¶å®ƒåœ°æ–¹ä½¿ç”¨ã€‚</p><hr><hr><h2 id="BoundSql">BoundSql</h2><p>ä»å¯åŠ¨æµç¨‹åˆ°<code>SqlSession</code>å†åˆ°<code>Executor</code>æ‰§è¡Œå™¨ï¼Œä»¥åŠåœ¨æ‰§è¡Œæ•°æ®åº“æ“ä½œçš„æ—¶å€™éƒ½ä¼šé€šè¿‡<code>StatementHandler</code>è¿›è¡Œ<code>Statement</code>å¤„ç†ï¼Œå¹¶ä¸”ä¼šç”¨åˆ°<code>BoundSql</code>ï¼Œè¿™ä¸ª<code>BoundSql</code>åˆ°åº•æ˜¯ä½•ä½œç”¨ã€‚</p><p><code>BoundSql </code>ä¸­å°±æ˜¯å¯¹è§£æåçš„sqlæè¿°ï¼ŒåŒ…æ‹¬å¯¹åŠ¨æ€æ ‡ç­¾çš„è§£æï¼Œå¹¶ä¸”å°† <strong>#{}</strong> è§£æä¸ºå ä½ç¬¦ <strong>?</strong> ï¼Œè¿˜åŒ…å«å‚æ•°çš„æè¿°ä¿¡æ¯ã€‚è¿™ä¸ªç±»æ²¡æœ‰ä»€ä¹ˆå¤æ‚æ“ä½œï¼Œå¯ä»¥çœ‹ä½œæ˜¯è§£æåçš„sqlæè¿°å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BoundSql</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æœ€ç»ˆè§£æçš„sqlï¼ŒMybatiså°†#&#123;&#125;å’Œ$&#123;&#125;è§£æåçš„sqlï¼Œå…¶ä¸­#&#123;&#125;ä¼šè¢«è§£æä¸º?</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String sql;</span><br><span class="line">  <span class="comment">// å‚æ•°æ˜ å°„</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ParameterMapping&gt; parameterMappings;</span><br><span class="line">  <span class="comment">// å‚æ•°å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Object parameterObject;</span><br><span class="line">  <span class="comment">// é¢å¤–çš„å‚æ•°</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; additionalParameters;</span><br><span class="line">  <span class="comment">// å…ƒæ•°æ®å‚æ•°</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> MetaObject metaParameters;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">BoundSql</span><span class="params">(Configuration configuration, String sql, List&lt;ParameterMapping&gt; parameterMappings, Object parameterObject)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.sql = sql;</span><br><span class="line">    <span class="built_in">this</span>.parameterMappings = parameterMappings;</span><br><span class="line">    <span class="built_in">this</span>.parameterObject = parameterObject;</span><br><span class="line">    <span class="built_in">this</span>.additionalParameters = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="built_in">this</span>.metaParameters = configuration.newMetaObject(additionalParameters);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getSql</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> sql;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> List&lt;ParameterMapping&gt; <span class="title function_">getParameterMappings</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> parameterMappings;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">getParameterObject</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> parameterObject;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasAdditionalParameter</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">paramName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PropertyTokenizer</span>(name).getName();</span><br><span class="line">    <span class="keyword">return</span> additionalParameters.containsKey(paramName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAdditionalParameter</span><span class="params">(String name, Object value)</span> &#123;</span><br><span class="line">    metaParameters.setValue(name, value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">getAdditionalParameter</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> metaParameters.getValue(name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºæµç¨‹">åˆ›å»ºæµç¨‹</h3><p><code>BaseExecutor</code>çš„queryæ–¹æ³•ä¸ºä¾‹ï¼Œé¦–å…ˆä¼šä»<code>MappedStatement</code>å¯¹è±¡ä¸­è·å–<code>BoundSql</code>å¯¹è±¡ï¼Œè€Œ<code>MappedStatement</code>å¯¹è±¡å…¶å®æ˜¯sqlæ ‡ç­¾çš„æè¿°ï¼Œ<code>BoundSql</code>å°±æ˜¯è§£æåçš„sqlè¯­å¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BaseExecutor çš„query()æ–¹æ³•</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">   <span class="comment">// ä»MappedStatementå¯¹è±¡ä¸­è·å–BoundSqlå¯¹è±¡</span></span><br><span class="line">   <span class="type">BoundSql</span> <span class="variable">boundSql</span> <span class="operator">=</span> ms.getBoundSql(parameter);</span><br><span class="line">   <span class="type">CacheKey</span> <span class="variable">key</span> <span class="operator">=</span> createCacheKey(ms, parameter, rowBounds, boundSql);</span><br><span class="line">   <span class="keyword">return</span> query(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>è·å–<code>BoundSql</code>å¯¹è±¡å…¶å®æ˜¯ä»<code>MappedStatement</code>çš„æˆå‘˜å˜é‡<code>sqlSource</code>ä¸­è·å–çš„ã€‚ è€Œ<code>SqlSource</code>ä½œä¸ºä¸€ä¸ªæ¥å£ï¼Œå®ƒåªæœ‰ä¸€ä¸ªä½œç”¨å°±æ˜¯è·å–<code>BoundSql</code>å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MappedStatement çš„ getBoundSql() æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> BoundSql <span class="title function_">getBoundSql</span><span class="params">(Object parameterObject)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–BoundSqlå¯¹è±¡ï¼ŒBoundSqlå¯¹è±¡æ˜¯å¯¹åŠ¨æ€sqlçš„è§£æ</span></span><br><span class="line">    <span class="type">BoundSql</span> <span class="variable">boundSql</span> <span class="operator">=</span> sqlSource.getBoundSql(parameterObject);</span><br><span class="line">    <span class="comment">// è·å–å‚æ•°æ˜ å°„</span></span><br><span class="line">    List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class="line">    <span class="keyword">if</span> (parameterMappings == <span class="literal">null</span> || parameterMappings.isEmpty()) &#123;</span><br><span class="line">      boundSql = <span class="keyword">new</span> <span class="title class_">BoundSql</span>(configuration, boundSql.getSql(), parameterMap.getParameterMappings(), parameterObject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check for nested result maps in parameter mappings (issue #30)</span></span><br><span class="line">    <span class="keyword">for</span> (ParameterMapping pm : boundSql.getParameterMappings()) &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">rmId</span> <span class="operator">=</span> pm.getResultMapId();</span><br><span class="line">      <span class="keyword">if</span> (rmId != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">ResultMap</span> <span class="variable">rm</span> <span class="operator">=</span> configuration.getResultMap(rmId);</span><br><span class="line">        <span class="keyword">if</span> (rm != <span class="literal">null</span>) &#123;</span><br><span class="line">          hasNestedResultMaps |= rm.hasNestedResultMaps();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> boundSql;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><code>SqlSource</code> æ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯è·å–<code>BoundSql</code>å¯¹è±¡ï¼Œ<code>SqlSource</code>æ¥å£çš„è®¾è®¡æ»¡è¶³å•ä¸€èŒè´£åŸåˆ™ã€‚<code>SqlSource</code>æœ‰äº”ä¸ªå®ç°ç±»ï¼š<code>ProviderSqlSource</code>ï¼Œ<code>DynamicSqlSource</code>ï¼Œ<code>RawSqlSource</code>ï¼Œ<code>StaticSqlSource</code>ï¼Œ<code>StaticSqlSource </code>å…¶ä¸­æ¯”è¾ƒå¸¸ç”¨çš„å°±æ˜¯<code>DynamicSqlSource</code>ï¼Œ<code>RawSqlSource</code>å’Œ<code>StaticSqlSource</code>ã€‚</p><p>å¦‚æœsqlä¸­åªåŒ…å«#{}å‚æ•°ï¼Œä¸åŒ…å«${}æˆ–è€…å…¶å®ƒåŠ¨æ€æ ‡ç­¾ï¼Œé‚£ä¹ˆåˆ›å»º<code>SqlSource</code>å¯¹è±¡æ—¶åˆ™ä¼šåˆ›å»º<code>RawSqlSource</code>ï¼Œå¦åˆ™åˆ›å»º<code>DynamicSqlSource</code>å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Represents the content of a mapped statement read from an XML file or an annotation.</span></span><br><span class="line"><span class="comment"> * It creates the SQL that will be passed to the database out of the input parameter received from the user.</span></span><br><span class="line"><span class="comment"> * è¡¨ç¤ºä¸€ä¸ªä»xmlæ–‡ä»¶å’Œæ³¨è§£ä¸­è¯»å–çš„ä¸€ä¸ªæ˜ å°„è¯­å¥</span></span><br><span class="line"><span class="comment"> * å¯ä»¥åˆ›å»ºä¸€ä¸ªåŒ…å«ç”¨æˆ·è¾“å…¥çš„å‚æ•°çš„ï¼Œå¹¶å¯ä»¥å‘é€åˆ°æ•°æ®åº“sql</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SqlSource</span> &#123;</span><br><span class="line"></span><br><span class="line">  BoundSql <span class="title function_">getBoundSql</span><span class="params">(Object parameterObject)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DynamicSqlSourceä¼šä¼˜å…ˆè§£æ${}æ ‡ç­¾ï¼Œç„¶åè§£æ#{}æ ‡ç­¾ã€‚å…¶ä¸­${}ä¼šè¢«è§£æä¸ºå‚æ•°å†…å®¹ï¼Œä¸ä¼šåŠ ä¸ŠåŒå¼•å·ï¼Œè€Œ#{}ä¼šè¢«è§£æä¸º?ï¼Œå¹¶ä¸”å‚æ•°ä¼šåŠ ä¸ŠåŒå¼•å·ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicSqlSource</span> <span class="keyword">implements</span> <span class="title class_">SqlSource</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Configuration configuration;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> SqlNode rootSqlNode;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">DynamicSqlSource</span><span class="params">(Configuration configuration, SqlNode rootSqlNode)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.configuration = configuration;</span><br><span class="line">    <span class="built_in">this</span>.rootSqlNode = rootSqlNode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> BoundSql <span class="title function_">getBoundSql</span><span class="params">(Object parameterObject)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¼˜å…ˆè§£æ$&#123;&#125;æ ‡ç­¾</span></span><br><span class="line">    <span class="type">DynamicContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DynamicContext</span>(configuration, parameterObject);</span><br><span class="line">    rootSqlNode.apply(context);</span><br><span class="line">    <span class="comment">// åˆ›å»ºsqlSourceå¯¹è±¡ï¼Œå¹¶ä¸”è§£æ#&#123;&#125;ä¸º?</span></span><br><span class="line">    <span class="type">SqlSourceBuilder</span> <span class="variable">sqlSourceParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSourceBuilder</span>(configuration);</span><br><span class="line">    Class&lt;?&gt; parameterType = parameterObject == <span class="literal">null</span> ? Object.class : parameterObject.getClass();</span><br><span class="line">    <span class="type">SqlSource</span> <span class="variable">sqlSource</span> <span class="operator">=</span> sqlSourceParser.parse(context.getSql(), parameterType, context.getBindings());</span><br><span class="line">    <span class="type">BoundSql</span> <span class="variable">boundSql</span> <span class="operator">=</span> sqlSource.getBoundSql(parameterObject);</span><br><span class="line">    context.getBindings().forEach(boundSql::setAdditionalParameter);</span><br><span class="line">    <span class="keyword">return</span> boundSql;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="è‡ªå®šä¹‰æ’ä»¶">è‡ªå®šä¹‰æ’ä»¶</h2><p>MyBatisçš„ä¸€ä¸ªé‡è¦çš„ç‰¹ç‚¹å°±æ˜¯æ’ä»¶æœºåˆ¶ï¼Œä½¿å¾—MyBatisçš„å…·å¤‡è¾ƒå¼ºçš„æ‰©å±•æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®MyBatisçš„æ’ä»¶æœºåˆ¶å®ç°è‡ªå·±çš„ä¸ªæ€§åŒ–ä¸šåŠ¡éœ€æ±‚ã€‚</p><hr><h3 id="åˆè¯†æ’ä»¶">åˆè¯†æ’ä»¶</h3><p>æˆ‘ä»¬åœ¨æ‰§è¡ŒæŸ¥è¯¢çš„æ—¶å€™ï¼Œå¦‚æœsqlæ²¡æœ‰åŠ ä¸Šåˆ†é¡µæ¡ä»¶ï¼Œæ•°æ®é‡è¿‡å¤§çš„è¯ä¼šé€ æˆå†…å­˜æº¢å‡ºï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡MyBatisæä¾›çš„æ’ä»¶æœºåˆ¶æ¥æ‹¦æˆªsqlï¼Œå¹¶è¿›è¡Œsqlæ”¹å†™ã€‚MyBatisçš„æ’ä»¶æ˜¯é€šè¿‡åŠ¨æ€ä»£ç†æ¥å®ç°çš„ï¼Œå¹¶ä¸”ä¼šå½¢æˆä¸€ä¸ªæ’ä»¶é“¾ã€‚åŸç†ç±»ä¼¼äºæ‹¦æˆªå™¨ï¼Œæ‹¦æˆªæˆ‘ä»¬éœ€è¦å¤„ç†çš„å¯¹è±¡ï¼Œè¿›è¡Œè‡ªå®šä¹‰é€»è¾‘åï¼Œè¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè¿›è¡Œä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨çš„å¤„ç†ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ä¸€ä¸ªç®€å•æ’ä»¶çš„æ¨¡æ¿ï¼Œé¦–å…ˆè¦å®ç°ä¸€ä¸ªInterceptoræ¥å£ï¼Œå¹¶å®ç°ä¸‰ä¸ªæ–¹æ³•ã€‚å¹¶åŠ ä¸Š@Interceptsæ³¨è§£ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä»¥åˆ†é¡µæ’ä»¶ä¸ºä¾‹å°†å¯¹æ¯ä¸ªç»†èŠ‚è¿›è¡Œè®²è§£ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Intercepts(&#123;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PagePlugin</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Properties properties;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">plugin</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Plugin.wrap(target, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">(Properties properties)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.properties = properties;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h3 id="æ‹¦æˆªå¯¹è±¡">æ‹¦æˆªå¯¹è±¡</h3><p>åœ¨è¿›è¡Œæ’ä»¶åˆ›å»ºçš„æ—¶å€™ï¼Œéœ€è¦æŒ‡å®šæ‹¦æˆªå¯¹è±¡ã€‚<code>@Intercepts</code>æ³¨è§£æŒ‡å®šéœ€è¦æ‹¦æˆªçš„æ–¹æ³•ç­¾åï¼Œå†…å®¹æ˜¯ä¸ª<code>Signature</code>ç±»å‹çš„æ•°ç»„ï¼Œè€Œ<code>Signature</code>å°±æ˜¯å¯¹æ‹¦æˆªå¯¹è±¡çš„æè¿°ã€‚</p><p>åœ¨MyBatisä¸­ï¼Œæˆ‘ä»¬åªèƒ½å¯¹ä»¥ä¸‹å››ç§ç±»å‹çš„å¯¹è±¡è¿›è¡Œæ‹¦æˆª</p><ul><li><code>ParameterHandler </code>: å¯¹sqlå‚æ•°è¿›è¡Œå¤„ç†</li><li><code>ResultSetHandler</code> : å¯¹ç»“æœé›†å¯¹è±¡è¿›è¡Œå¤„ç†</li><li><code>StatementHandler</code> : å¯¹sqlè¯­å¥è¿›è¡Œå¤„ç†</li><li><code>Executor</code> : æ‰§è¡Œå™¨ï¼Œæ‰§è¡Œå¢åˆ æ”¹æŸ¥</li></ul><p>ç°åœ¨æˆ‘ä»¬éœ€è¦å¯¹sqlè¿›è¡Œæ”¹å†™ï¼Œå› æ­¤å¯ä»¥éœ€è¦æ‹¦æˆªExecutorçš„queryæ–¹æ³•è¿›è¡Œæ‹¦æˆª</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Intercepts(&#123;@Signature(type = Executor.class, </span></span><br><span class="line"><span class="meta">                        method = &quot;query&quot;, </span></span><br><span class="line"><span class="meta">                        args = &#123;MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class&#125;)&#125;)</span></span><br></pre></td></tr></table></figure><hr><h3 id="æ‹¦æˆªå®ç°">æ‹¦æˆªå®ç°</h3><p>æ¯ä¸ªæ’ä»¶é™¤äº†æŒ‡å®šæ‹¦æˆªçš„æ–¹æ³•åï¼Œè¿˜éœ€è¦å®ç°Interceptoræ¥å£ã€‚Interceptoræ¥å£æœ‰ä»¥ä¸‹ä¸‰ä¸ªæ–¹æ³•ã€‚å…¶ä¸­interceptæ˜¯æˆ‘ä»¬å¿…é¡»è¦å®ç°çš„æ–¹æ³•ï¼Œåœ¨è¿™é‡Œé¢æˆ‘ä»¬éœ€è¦å®ç°è‡ªå®šä¹‰é€»è¾‘ã€‚å…¶å®ƒä¸¤ä¸ªæ–¹æ³•ç»™å‡ºäº†é»˜è®¤å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Intercepts(&#123;@Signature(type = Executor.class,</span></span><br><span class="line"><span class="meta">        method = &quot;query&quot;,</span></span><br><span class="line"><span class="meta">        args = &#123;MappedStatement.class, Object.class, RowBounds.class , ResultHandler.class&#125;)&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PagePlugin</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Properties properties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Object[] args = invocation.getArgs();</span><br><span class="line">        <span class="type">RowBounds</span> <span class="variable">rowBounds</span> <span class="operator">=</span> (RowBounds)args[<span class="number">2</span>];</span><br><span class="line">        log.info(<span class="string">&quot;æ‰§è¡Œå‰ï¼Œ rowBounds = [&#123;&#125;]&quot;</span>, JSONUtil.toJsonStr(rowBounds));</span><br><span class="line">        <span class="keyword">if</span>(rowBounds != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(rowBounds.getLimit() &gt; <span class="number">1000</span>)&#123;</span><br><span class="line">                <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> rowBounds.getClass().getDeclaredField(<span class="string">&quot;limit&quot;</span>);</span><br><span class="line">                field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                field.set(rowBounds, <span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            rowBounds = <span class="keyword">new</span> <span class="title class_">RowBounds</span>(<span class="number">0</span> ,<span class="number">100</span>);</span><br><span class="line">            args[<span class="number">2</span>] = rowBounds;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;æ‰§è¡Œåï¼Œ rowBounds = [&#123;&#125;]&quot;</span>, JSONUtil.toJsonStr(rowBounds));</span><br><span class="line">        <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">plugin</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Plugin.wrap(target, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">(Properties properties)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.properties = properties;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="é…ç½®æ’ä»¶">é…ç½®æ’ä»¶</h3><p>ä»¥ä¸Šæˆ‘ä»¬å·²ç»å®ç°äº†ä¸€ä¸ªç®€å•çš„æ’ä»¶ï¼Œåœ¨æ‰§è¡ŒæŸ¥è¯¢çš„æ—¶å€™å¯¹queryæ–¹æ³•è¿›è¡Œæ‹¦æˆªï¼Œå¹¶ä¸”ä¿®æ”¹åˆ†é¡µå‚æ•°ã€‚ä½†æ˜¯æˆ‘ä»¬ç°åœ¨è¿˜æ²¡æœ‰è¿›è¡Œæ’ä»¶é…ç½®ï¼Œåªæœ‰é…ç½®äº†æ’ä»¶ï¼ŒMyBatisæ‰èƒ½å¯åŠ¨è¿‡ç¨‹ä¸­åŠ è½½æ’ä»¶ã€‚</p><p>åœ¨mybatis-config.xmlä¸­æ·»åŠ pluginsæ ‡ç­¾ï¼Œå¹¶ä¸”é…ç½®æˆ‘ä»¬ä¸Šé¢å®ç°çš„plugin.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">&quot;com.example.demo.mybatis.PagePlugin&quot;</span></span></span><br><span class="line"><span class="tag">     &lt;/<span class="attr">plugin</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>XMLConfigBuilder</code>è¿™ä¸ªè§£æå™¨ä¸­çš„<code>parse()</code>æ–¹æ³•å°±ä¼šè¯»å–pluginsæ ‡ç­¾ä¸‹çš„æ’ä»¶ï¼Œå¹¶åŠ è½½<code>Configuration</code>ä¸­çš„<code>InterceptorChain</code>ä¸­ã€‚</p><hr><h3 id="åˆ›å»ºæ’ä»¶å¯¹è±¡">åˆ›å»ºæ’ä»¶å¯¹è±¡</h3><p>ä»¥Executorä¸ºä¾‹ï¼Œåœ¨åˆ›å»ºExecutorå¯¹è±¡çš„æ—¶å€™ï¼Œä¼šæœ‰ä»¥ä¸‹ä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Configuration</span></span><br><span class="line"><span class="keyword">public</span> Executor <span class="title function_">newExecutor</span><span class="params">(Transaction transaction, ExecutorType executorType)</span> &#123;</span><br><span class="line">  executorType = executorType == <span class="literal">null</span> ? defaultExecutorType : executorType;</span><br><span class="line">  executorType = executorType == <span class="literal">null</span> ? ExecutorType.SIMPLE : executorType;</span><br><span class="line">  Executor executor;</span><br><span class="line">  <span class="keyword">if</span> (ExecutorType.BATCH == executorType) &#123;</span><br><span class="line">    executor = <span class="keyword">new</span> <span class="title class_">BatchExecutor</span>(<span class="built_in">this</span>, transaction);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ExecutorType.REUSE == executorType) &#123;</span><br><span class="line">    executor = <span class="keyword">new</span> <span class="title class_">ReuseExecutor</span>(<span class="built_in">this</span>, transaction);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    executor = <span class="keyword">new</span> <span class="title class_">SimpleExecutor</span>(<span class="built_in">this</span>, transaction);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (cacheEnabled) &#123;</span><br><span class="line">    executor = <span class="keyword">new</span> <span class="title class_">CachingExecutor</span>(executor);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆ›å»ºæ’ä»¶å¯¹è±¡</span></span><br><span class="line">  executor = (Executor) interceptorChain.pluginAll(executor);</span><br><span class="line">  <span class="keyword">return</span> executor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå®ŒExecutorå¯¹è±¡åï¼Œå°±ä¼šè°ƒç”¨<code>interceptorChain.pluginAll()</code>æ–¹æ³•ï¼Œå®é™…è°ƒç”¨çš„æ˜¯æ¯ä¸ª<code>Interceptor</code>çš„plugin()æ–¹æ³•ã€‚plugin()å°±æ˜¯å¯¹ç›®æ ‡å¯¹è±¡çš„ä¸€ä¸ªä»£ç†ï¼Œå¹¶ä¸”ç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹è±¡è¿”å›ã€‚è€ŒPlugin.wrap()å°±æ˜¯è¿›è¡ŒåŒ…è£…çš„æ“ä½œã€‚</p><hr><hr><h2 id="ç¼“å­˜">ç¼“å­˜</h2><p>MyBatisæä¾›çš„ç¼“å­˜åŠŸèƒ½åŒ…å«ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜ï¼Œ</p><p>ä¸€çº§ç¼“å­˜æ˜¯é»˜è®¤å¼€å¯çš„ï¼ŒäºŒçº§ç¼“å­˜é»˜è®¤å…³é—­ã€‚å®ƒä»¬çš„ä½œç”¨èŒƒå›´ä¹Ÿæ˜¯ä¸åŒçš„ã€‚</p><p>MyBatisçš„ç¼“å­˜æ˜¯åŸºäºcacheæ¥å£çš„ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/Cache.png" alt="Cache"></p><p>cacheä½œä¸ºé¡¶å±‚æ¥å£ï¼Œå®šä¹‰äº†ç¼“å­˜çš„åŸºæœ¬æ“ä½œï¼Œæ¯”å¦‚è®¾ç½®ç¼“å­˜ï¼Œè·å–ç¼“å­˜çš„æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Cache</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å”¯ä¸€æ ‡ç¤ºç¼“å­˜</span></span><br><span class="line">    String <span class="title function_">getId</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä»¥key valueå½¢å¼è®¾ç½®ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">putObject</span><span class="params">(Object key, Object value)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–ç¼“å­˜</span></span><br><span class="line">    Object <span class="title function_">getObject</span><span class="params">(Object key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ é™¤ç¼“å­˜</span></span><br><span class="line">    Object <span class="title function_">removeObject</span><span class="params">(Object key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ¸…ç©ºç¼“å­˜å®ä¾‹</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç¼“å­˜ä¸­å…ƒç´ çš„æ•°é‡</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">getSize</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¯»å†™é”</span></span><br><span class="line">    <span class="keyword">default</span> ReadWriteLock <span class="title function_">getReadWriteLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>PerpetualCache</code> æ˜¯cacheçš„é»˜è®¤å®ç°ï¼Œä¹Ÿæ˜¯æœ€ç®€å•çš„å®ç°ï¼Œå®ƒä»¥<code>HashMap</code>ä½œä¸ºç¼“å­˜å®¹å™¨ï¼Œå­˜å‚¨ç¼“å­˜ã€‚å…¶å®ƒç±»å‹çš„ç¼“å­˜æ˜¯å¯¹<code>PerpetualCache</code>çš„åŒ…è£…ã€‚</p><div class="tabs" id="95c31993-a5b9-4f38-a759-a47c52f6c008"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#95c31993-a5b9-4f38-a759-a47c52f6c008-1"><i class="fas fa-award"></i>PerpetualCache</button></li><li class="tab"><button type="button" data-href="#95c31993-a5b9-4f38-a759-a47c52f6c008-2"><i class="fas fa-baseball-ball"></i>LruCache</button></li><li class="tab"><button type="button" data-href="#95c31993-a5b9-4f38-a759-a47c52f6c008-3"><i class="fas fa-bone"></i>FifoCache</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="95c31993-a5b9-4f38-a759-a47c52f6c008-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PerpetualCache</span> <span class="keyword">implements</span> <span class="title class_">Cache</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, Object&gt; cache = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">PerpetualCache</span><span class="params">(String id)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.id = id;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSize</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cache.size();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putObject</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">    cache.put(key, value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cache.get(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">removeObject</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cache.remove(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">    cache.clear();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (getId() == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CacheException</span>(<span class="string">&quot;Cache instances require an ID.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span> == o) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Cache)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Cache</span> <span class="variable">otherCache</span> <span class="operator">=</span> (Cache) o;</span><br><span class="line">    <span class="keyword">return</span> getId().equals(otherCache.getId());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (getId() == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CacheException</span>(<span class="string">&quot;Cache instances require an ID.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getId().hashCode();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="95c31993-a5b9-4f38-a759-a47c52f6c008-2"><p>å½“ä½¿ç”¨ <code>LinkedHashMap</code> çš„æ—¶å€™ï¼Œé»˜è®¤æƒ…å†µä¸‹å…ƒç´ çš„é¡ºåºæ˜¯æŒ‰ç…§æ’å…¥é¡ºåºæ¥ç»´æŠ¤çš„ã€‚ä½†å¦‚æœåœ¨åˆ›å»º <code>LinkedHashMap</code> æ—¶è®¾ç½®äº† <code>accessOrder</code> ä¸º <code>true</code>ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨ <code>get</code> æ–¹æ³•æ—¶ï¼Œä¼šå°†è®¿é—®åˆ°çš„å…ƒç´ ç§»åŠ¨åˆ°é“¾è¡¨çš„é˜Ÿå°¾ï¼Œè¿™æ ·é“¾è¡¨ä¸­çš„å…ƒç´ é¡ºåºå°±ä¼šæŒ‰ç…§è®¿é—®é¡ºåºæ¥ç»´æŠ¤ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LruCache</span> <span class="keyword">implements</span> <span class="title class_">Cache</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¢«ä»£ç†çš„å¯¹è±¡ï¼Œä¸€èˆ¬æ¥è¯´PerpetualCache</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Cache delegate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//keyMapå®ç°LRUçš„å…³é”®</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Object, Object&gt; keyMap;</span><br><span class="line">    <span class="comment">//æœ€è€çš„key</span></span><br><span class="line">    <span class="keyword">private</span> Object eldestKey;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–ï¼Œæ³¨æ„ï¼Œè¿™æ„é€ æ–¹æ³•çš„å‚æ•°å¯ä¸æ˜¯ä¸€ä¸ªStringï¼Œè€Œæ˜¯ä¸€ä¸ªCacheï¼Œä¸“é—¨ç”¨äºåŒ…è£…Cacheçš„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LruCache</span><span class="params">(Cache delegate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.delegate = delegate;</span><br><span class="line">        <span class="comment">//é»˜è®¤å¤§å°ä¸º1024</span></span><br><span class="line">        setSize(<span class="number">1024</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–idï¼Œå…¶å®å°±æ˜¯NameSpace</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> delegate.getId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿˜æ˜¯å°†æ“ä½œå§”æ‰˜ç»™delegate</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> delegate.getSize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®å¤§å°ï¼ŒLRUç®—æ³•æ˜¯ç”¨LinkedHashMapæ¥å®ç°çš„ï¼Œæ³¨æ„æ„é€ æ–¹æ³•çš„æœ€åä¸€ä¸ªå‚æ•°ï¼ŒaccessOrderä¸ºtrue</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSize</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> size)</span> &#123;</span><br><span class="line">        keyMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;Object, Object&gt;(size, <span class="number">.75F</span>, <span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">4267176411845948333L</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//è¿™ä¸ªæ–¹æ³•è¿”å›ä¸ºtrueï¼Œå°±ä¼šå°†å¤´ç»“ç‚¹å‰”é™¤å‡ºå»ã€‚</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">removeEldestEntry</span><span class="params">(Map.Entry&lt;Object, Object&gt; eldest)</span> &#123;</span><br><span class="line">                <span class="comment">// æ˜¯å¦è¶…è¿‡äº†é™åˆ¶</span></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">tooBig</span> <span class="operator">=</span> size() &gt; size;</span><br><span class="line">                <span class="keyword">if</span> (tooBig) &#123;</span><br><span class="line">                    <span class="comment">// eldestå°±æ˜¯LinkHahsMapçš„å¤´èŠ‚ç‚¹</span></span><br><span class="line">                    eldestKey = eldest.getKey();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> tooBig;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//putçš„æ—¶å€™ç›´æ¥æ”¾ï¼Œæ³¨æ„åœ¨cycleKeyListé‡Œé¢ä¹Ÿæœ‰æ“ä½œï¼Œç­‰ä¼šçœ‹çœ‹</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putObject</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">        delegate.putObject(key, value);</span><br><span class="line">        cycleKeyList(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="comment">// æ€è€ƒä¸€ä¸‹ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆè¦getä¸€ä¸‹ï¼Œ å´æ²¡æœ‰èµ‹å€¼æ“ä½œï¼Œ</span></span><br><span class="line">        <span class="comment">// å› ä¸ºgetæ“ä½œè¦ä¿æŒæ•°æ®çš„æ–°ã€‚å…·ä½“çœ‹çœ‹linkHashMapå®ç°LRUçš„åˆ†ææŠŠ</span></span><br><span class="line">        keyMap.get(key);</span><br><span class="line">        <span class="keyword">return</span> delegate.getObject(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">removeObject</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> delegate.removeObject(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">        delegate.clear();</span><br><span class="line">        keyMap.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//çœ‹è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨putObjectçš„æ—¶å€™è°ƒç”¨ï¼Œä¸»è¦æ˜¯ä»delegateé‡Œé¢ç§»é™¤æ‰æœ€è€çš„keyã€‚</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cycleKeyList</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        keyMap.put(key, key);</span><br><span class="line">        <span class="keyword">if</span> (eldestKey != <span class="literal">null</span>) &#123;</span><br><span class="line">            delegate.removeObject(eldestKey);</span><br><span class="line">            eldestKey = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="95c31993-a5b9-4f38-a759-a47c52f6c008-3"><p>FifoCacheçš„å®ç°æ¯”è¾ƒç®€å•ï¼Œåˆ©ç”¨é˜Ÿåˆ—æ¥å®ç°FIFOï¼Œé™åˆ¶çš„å¤§å°é»˜è®¤æ˜¯1024ï¼Œåªæœ‰åœ¨putçš„æ—¶å€™æ‰ä¼šæœ‰æ“ä½œé˜Ÿåˆ—ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FifoCache</span> <span class="keyword">implements</span> <span class="title class_">Cache</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Cache delegate;</span><br><span class="line">    <span class="comment">// åˆ©ç”¨é˜Ÿåˆ—æ¥å®ç°FIFO</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;Object&gt; keyList;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FifoCache</span><span class="params">(Cache delegate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.delegate = delegate;</span><br><span class="line">        <span class="built_in">this</span>.keyList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        <span class="built_in">this</span>.size = <span class="number">1024</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> delegate.getId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> delegate.getSize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSize</span><span class="params">(<span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.size = size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putObject</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">        cycleKeyList(key);</span><br><span class="line">        delegate.putObject(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> delegate.getObject(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">removeObject</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> delegate.removeObject(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">        delegate.clear();</span><br><span class="line">        keyList.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡ç‚¹æ˜¯è¿™ä¸ªæ–¹æ³•ï¼Œå°†å…ƒç´ æ·»åŠ åˆ°é˜Ÿåˆ—é‡Œé¢ï¼Œåˆ¤æ–­é˜Ÿåˆ—çš„å¤§å°æ˜¯å¦è¶…è¿‡è§„å®šçš„sizeï¼Œå¦‚æœè¶…è¿‡å¤§å°ï¼Œå°±ä»é˜Ÿåˆ—ä¸­è·å–å¤´èŠ‚ç‚¹ï¼Œç„¶åç§»é™¤æ‰ã€‚</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cycleKeyList</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        keyList.addLast(key);</span><br><span class="line">        <span class="keyword">if</span> (keyList.size() &gt; size) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">oldestKey</span> <span class="operator">=</span> keyList.removeFirst();</span><br><span class="line">            delegate.removeObject(oldestKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="ä¸€çº§ç¼“å­˜">ä¸€çº§ç¼“å­˜</h3><h4 id="ä¸€çº§ç¼“å­˜å¼€å¯">ä¸€çº§ç¼“å­˜å¼€å¯</h4><p><code>MyBatis</code>ä¸€çº§ç¼“å­˜æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œå¹¶ä¸”å®ƒçš„ä½œç”¨èŒƒå›´æ˜¯<code>SqlSession</code>çº§åˆ«çš„ã€‚æˆ‘ä¹ˆçŸ¥é“<code>SqlSession</code>æ˜¯é¡¶å±‚çš„æ¥å£ï¼Œæœ€ç»ˆçš„æ•°æ®åº“æ“ä½œéƒ½æ˜¯äº¤ç”±ç»™æ‰§è¡Œå™¨è¿›è¡Œæ“ä½œçš„ã€‚äº†è§£å‰é¢çš„<code>Executor</code>çš„åŒå­¦å¯çŸ¥ï¼Œç¼“å­˜å°±æ˜¯åœ¨æ‰§è¡ŒExecutorä¸­è¿›è¡Œç»´æŠ¤çš„ï¼Œå…¶ä¸­<code>localCache</code>æˆå‘˜å˜é‡å°±æ˜¯ä¸€çº§ç¼“å­˜å¯¹è±¡ï¼Œå…¶ç±»å‹å°±æ˜¯<code>PerpetualCache</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseExecutor</span> <span class="keyword">implements</span> <span class="title class_">Executor</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Log</span> <span class="variable">log</span> <span class="operator">=</span> LogFactory.getLog(BaseExecutor.class);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> Transaction transaction;</span><br><span class="line">  <span class="keyword">protected</span> Executor wrapper;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> ConcurrentLinkedQueue&lt;DeferredLoad&gt; deferredLoads;</span><br><span class="line">  <span class="keyword">protected</span> PerpetualCache localCache;</span><br><span class="line">  <span class="keyword">protected</span> PerpetualCache localOutputParameterCache;</span><br><span class="line">  <span class="keyword">protected</span> Configuration configuration;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="type">int</span> queryStack;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">boolean</span> closed;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="title function_">BaseExecutor</span><span class="params">(Configuration configuration, Transaction transaction)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.transaction = transaction;</span><br><span class="line">    <span class="built_in">this</span>.deferredLoads = <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedQueue</span>&lt;&gt;();</span><br><span class="line">    <span class="built_in">this</span>.localCache = <span class="keyword">new</span> <span class="title class_">PerpetualCache</span>(<span class="string">&quot;LocalCache&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.localOutputParameterCache = <span class="keyword">new</span> <span class="title class_">PerpetualCache</span>(<span class="string">&quot;LocalOutputParameterCache&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.closed = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">this</span>.configuration = configuration;</span><br><span class="line">    <span class="built_in">this</span>.wrapper = <span class="built_in">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€çº§ç¼“å­˜æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œ<code>Configuration</code>çš„æˆå‘˜å˜é‡<code>localCacheScope</code>çš„é»˜è®¤å°±æ˜¯<code>Sesssion</code>çº§åˆ«çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Configurationç±»</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">LocalCacheScope</span> <span class="variable">localCacheScope</span> <span class="operator">=</span> LocalCacheScope.SESSION;</span><br></pre></td></tr></table></figure><p>å¦‚æœè¦å…³é—­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨mybatis-config.xmlä¸­çš„settingsæ ‡ç­¾ä¸­å°†è¿™ä¸ªé…ç½®è®¾ç½®æˆStatementç±»å‹çš„</p><p><code>&lt;setting name=&quot;localCacheScope&quot; value=&quot;STATEMENT&quot;/&gt;</code></p><p>å¦‚æœæŸä¸ªselectæ ‡ç­¾æŸ¥è¯¢ä¸éœ€è¦ç¼“å­˜ï¼Œåœ¨selectæ ‡ç­¾åŠ ä¸Š<code>flushCache=&quot;true&quot;</code>ä¹Ÿå¯ä»¥è®¾ç½®å•ä¸ªæŸ¥è¯¢å…³é—­ç¼“å­˜</p><hr><h4 id="ä¸€çº§ç¼“å­˜å­˜å–">ä¸€çº§ç¼“å­˜å­˜å–</h4><p>ç¼“å­˜åœ¨æŸ¥è¯¢ä¸­æ‰ä¼šç”¨åˆ°ï¼Œä¾‹å¦‚æˆ‘ä»¬ç”¨åŒä¸€ä¸ªsqlè¯­å¥åå¤å»æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶ä¸”åœ¨æ­¤æœŸé—´æ²¡æœ‰è¿›è¡Œè¿‡æ•°æ®ä¿®æ”¹æ“ä½œï¼Œé¢„æœŸæ˜¯è¿”å›ç›¸åŒçš„ç»“æœã€‚å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œæˆ‘ä»¬å°†æ¯æ¬¡éƒ½è¦è®¿é—®æ•°æ®åº“è¿”å›ç»“æœï¼Œè¿™ä¸ªè¿‡ç¨‹æ— ç–‘æ˜¯æµªè´¹èµ„æºå’Œæ¶ˆè€—æ€§èƒ½çš„ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å°†ç¬¬ä¸€æ¬¡æŸ¥è¯¢çš„ç»“æœç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œç¬¬äºŒæ¬¡ç”¨ç›¸åŒçš„sqlè¯­å¥æŸ¥è¯¢çš„æ—¶å€™ï¼Œå…ˆå»ç¼“å­˜ä¸­æŸ¥è¯¢ï¼Œå¦‚æœå‘½ä¸­åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™å»æ•°æ®åº“æŸ¥è¯¢å¹¶æ”¾åˆ°ç¼“å­˜ä¸­è¿”å›ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹çœ‹BaseExecutorçš„queryæ–¹æ³•æ˜¯æ€ä¹ˆåšçš„å§ã€‚</p><div class="tabs" id="dcb515a9-d9d3-4ec5-82fa-dd016f8cf49f"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#dcb515a9-d9d3-4ec5-82fa-dd016f8cf49f-1"><i class="fas fa-cat"></i>query</button></li><li class="tab"><button type="button" data-href="#dcb515a9-d9d3-4ec5-82fa-dd016f8cf49f-2"><i class="fas fa-horse"></i>queryFromDatabase</button></li><li class="tab"><button type="button" data-href="#dcb515a9-d9d3-4ec5-82fa-dd016f8cf49f-3"><i class="fas fa-dove"></i>createCacheKey</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="dcb515a9-d9d3-4ec5-82fa-dd016f8cf49f-1"><p><mark class="hl-label blue">BaseExecutor#query</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">  <span class="type">BoundSql</span> <span class="variable">boundSql</span> <span class="operator">=</span> ms.getBoundSql(parameter);</span><br><span class="line">  <span class="type">CacheKey</span> <span class="variable">key</span> <span class="operator">=</span> createCacheKey(ms, parameter, rowBounds, boundSql);</span><br><span class="line">  <span class="keyword">return</span> query(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    ErrorContext.instance().resource(ms.getResource()).activity(<span class="string">&quot;executing a query&quot;</span>).object(ms.getId());</span><br><span class="line">    <span class="comment">// Executoræ˜¯å¦å…³é—­</span></span><br><span class="line">    <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExecutorException</span>(<span class="string">&quot;Executor was closed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// selectæ ‡ç­¾æ˜¯å¦é…ç½®äº†flushCache=true</span></span><br><span class="line">    <span class="keyword">if</span> (queryStack == <span class="number">0</span> &amp;&amp; ms.isFlushCacheRequired()) &#123;</span><br><span class="line">        <span class="comment">// æ¸…é™¤ä¸€çº§ç¼“å­˜</span></span><br><span class="line">        clearLocalCache();</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;E&gt; list;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        queryStack++;</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢ä¸€çº§ç¼“å­˜</span></span><br><span class="line">        list = resultHandler == <span class="literal">null</span> ? (List&lt;E&gt;) localCache.getObject(key) : <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (list != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†ç¼“å­˜çš„ç»“æœ</span></span><br><span class="line">            handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ç¼“å­˜ä¸­æ²¡æœ‰åˆ™æŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">            list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        queryStack--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (queryStack == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (DeferredLoad deferredLoad : deferredLoads) &#123;</span><br><span class="line">            deferredLoad.load();</span><br><span class="line">        &#125;</span><br><span class="line">        deferredLoads.clear();</span><br><span class="line">        <span class="comment">// å¦‚æœå…³é—­äº†ä¸€çº§ç¼“å­˜ï¼ŒæŸ¥è¯¢å®Œåæ¸…é™¤ä¸€çº§ç¼“å­˜</span></span><br><span class="line">        <span class="keyword">if</span> (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) &#123;</span><br><span class="line">            clearLocalCache();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="dcb515a9-d9d3-4ec5-82fa-dd016f8cf49f-2"><p><mark class="hl-label green">BaseExecutor#queryFromDatabase</mark></p><p>ç¬¬ä¸€æ¬¡æŸ¥è¯¢è‚¯å®šä»ç¼“å­˜ä¸­æŸ¥è¯¢ä¸åˆ°ä¸œè¥¿ï¼Œäºæ˜¯èµ°å‘äº†<code>queryFromDatabase</code>åˆ†æ”¯ï¼Œè¿™ä¸ªæ–¹æ³•å°±ç›´æ¥ä»æ•°æ®åº“ä¸­å»æŸ¥è¯¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">queryFromDatabase</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    List&lt;E&gt; list;</span><br><span class="line">    <span class="comment">// æ·»åŠ å ä½ç¬¦ï¼Œæ ‡ç¤ºæ­£åœ¨æ‰§è¡Œ</span></span><br><span class="line">    localCache.putObject(key, EXECUTION_PLACEHOLDER);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// è°ƒç”¨å­ç±»çš„æŸ¥è¯¢æ–¹æ³•è·å–ç»“æœ</span></span><br><span class="line">      list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      localCache.removeObject(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†æŸ¥è¯¢ç»“æœæ”¾åˆ°ç¼“å­˜ä¸­</span></span><br><span class="line">    localCache.putObject(key, list);</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯å­˜å‚¨è¿‡ç¨‹åˆ™éœ€è¦å¤„ç†è¾“å‡ºå‚æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (ms.getStatementType() == StatementType.CALLABLE) &#123;</span><br><span class="line">      localOutputParameterCache.putObject(key, parameter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="dcb515a9-d9d3-4ec5-82fa-dd016f8cf49f-3"><p><mark class="hl-label blue">BaseExecutor#createCacheKey</mark></p><p>æ³¨æ„è¿™ä¸ªç¼“å­˜çœŸçš„æ˜¯æŸ¥è¯¢sqlå®Œå…¨ä¸€æ ·ï¼Œè¿™ä¸ªä¸€æ ·è¿˜åŒ…æ‹¬å‚æ•°çš„ä¸€è‡´ï¼Œæ‰ä¼šä»ç¼“å­˜ä¸­è·å–åˆ°ç»“æœï¼Œé‚£ä¹ˆå¦‚ä½•åˆ¤æ–­ä¸¤ä¸ªæŸ¥è¯¢sqlæ˜¯å¦ä¸€æ ·å‘¢ã€‚<code>createCacheKey</code>å°±å¸®å¿™è§£ç­”äº†è¿™ä¸ªç–‘æƒ‘ï¼Œå®ƒä¼šç»™æ¯ä¸ªsqléƒ½ç”Ÿæˆä¸€ä¸ªkeyï¼Œå¦‚æœä¸¤ä¸ªç”Ÿæˆçš„keyä¸€è‡´ï¼Œé‚£å°±è¡¨æ˜ä¸ç®¡æ˜¯sqlè¿˜æ˜¯å‚æ•°éƒ½æ˜¯ä¸€è‡´çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> CacheKey <span class="title function_">createCacheKey</span><span class="params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql)</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExecutorException</span>(<span class="string">&quot;Executor was closed.&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="type">CacheKey</span> <span class="variable">cacheKey</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CacheKey</span>();</span><br><span class="line">   cacheKey.update(ms.getId());</span><br><span class="line">   cacheKey.update(rowBounds.getOffset());</span><br><span class="line">   cacheKey.update(rowBounds.getLimit());</span><br><span class="line">   cacheKey.update(boundSql.getSql());</span><br><span class="line">   List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class="line">   <span class="type">TypeHandlerRegistry</span> <span class="variable">typeHandlerRegistry</span> <span class="operator">=</span> ms.getConfiguration().getTypeHandlerRegistry();</span><br><span class="line">   <span class="comment">// mimic DefaultParameterHandler logic</span></span><br><span class="line">   <span class="keyword">for</span> (ParameterMapping parameterMapping : parameterMappings) &#123;</span><br><span class="line">     <span class="keyword">if</span> (parameterMapping.getMode() != ParameterMode.OUT) &#123;</span><br><span class="line">       Object value;</span><br><span class="line">       <span class="type">String</span> <span class="variable">propertyName</span> <span class="operator">=</span> parameterMapping.getProperty();</span><br><span class="line">       <span class="keyword">if</span> (boundSql.hasAdditionalParameter(propertyName)) &#123;</span><br><span class="line">         value = boundSql.getAdditionalParameter(propertyName);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parameterObject == <span class="literal">null</span>) &#123;</span><br><span class="line">         value = <span class="literal">null</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;</span><br><span class="line">         value = parameterObject;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="type">MetaObject</span> <span class="variable">metaObject</span> <span class="operator">=</span> configuration.newMetaObject(parameterObject);</span><br><span class="line">         value = metaObject.getValue(propertyName);</span><br><span class="line">       &#125;</span><br><span class="line">       cacheKey.update(value);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (configuration.getEnvironment() != <span class="literal">null</span>) &#123;</span><br><span class="line">     <span class="comment">// issue #176</span></span><br><span class="line">     cacheKey.update(configuration.getEnvironment().getId());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> cacheKey;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h4 id="ä¸€çº§ç¼“å­˜æ¸…é™¤">ä¸€çº§ç¼“å­˜æ¸…é™¤</h4><p>åœ¨æ‰§è¡Œupdateï¼Œcommitï¼Œæˆ–è€…rollbackæ“ä½œçš„æ—¶å€™éƒ½ä¼šè¿›è¡Œæ¸…é™¤ç¼“å­˜æ“ä½œï¼Œæ‰€æœ‰çš„ç¼“å­˜éƒ½å°†å¤±æ•ˆã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">update</span><span class="params">(MappedStatement ms, Object parameter)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">  ErrorContext.instance().resource(ms.getResource()).activity(<span class="string">&quot;executing an update&quot;</span>).object(ms.getId());</span><br><span class="line">  <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExecutorException</span>(<span class="string">&quot;Executor was closed.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ¸…é™¤ä¸€çº§ç¼“å­˜</span></span><br><span class="line">  clearLocalCache();</span><br><span class="line">  <span class="keyword">return</span> doUpdate(ms, parameter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="äºŒçº§ç¼“å­˜">äºŒçº§ç¼“å­˜</h3><h4 id="äºŒçº§ç¼“å­˜å¼€å¯">äºŒçº§ç¼“å­˜å¼€å¯</h4><p>ä¸€çº§ç¼“å­˜çš„ä½œç”¨èŒƒå›´æ˜¯<code>SqlSession</code>çº§åˆ«çš„ï¼Œä½†æ˜¯<code>SqlSession</code>æ˜¯å•çº¿ç¨‹çš„ï¼Œä¸åŒçº¿ç¨‹é—´çš„æ“ä½œä¼šæœ‰ä¸€äº›è„æ•°æ®çš„é—®é¢˜ã€‚</p><p>äºŒçº§ç¼“å­˜çš„ä½œç”¨èŒƒå›´æ˜¯<code>SqlSessionFactory</code>çº§åˆ«ï¼Œé€šè¿‡åŒä¸€ä¸ª<code>SqlSessionFactory</code>åˆ›å»ºçš„<code>SqlSession</code>æŸ¥è¯¢çš„ç»“æœä¼šè¢«ç¼“å­˜ã€‚</p><p>äºŒçº§ç¼“å­˜å¼€å¯çš„æ¡ä»¶ï¼š</p><ol><li>åœ¨æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸­ï¼Œè®¾ç½®å…¨å±€é…ç½®å±æ€§cacheEnabled=â€œtrueâ€ï¼Œé»˜è®¤ä¸ºtrueï¼Œä¸éœ€è¦è®¾ç½®</li><li>åœ¨æ˜ å°„æ–‡ä»¶ä¸­è®¾ç½®æ ‡ç­¾<code>&lt;cache /&gt;</code></li><li>äºŒçº§ç¼“å­˜å¿…é¡»åœ¨SqlSessionå…³é—­æˆ–æäº¤ä¹‹åæœ‰æ•ˆ</li><li>æŸ¥è¯¢çš„æ•°æ®æ‰€è½¬æ¢çš„å®ä½“ç±»ç±»å‹å¿…é¡»å®ç°åºåˆ—åŒ–çš„æ¥å£</li></ol><p>éœ€è¦è¿›è¡Œå¼€å¯äºŒçº§ç¼“å­˜çš„mapperä¸­æ–°å¢cacheé…ç½®ï¼Œcacheé…ç½®æœ‰å¾ˆå¤šå±æ€§ã€‚</p><p><strong>type</strong> : ç¼“å­˜å®ç°ç±»ï¼Œé»˜è®¤æ˜¯PerpetualCacheï¼Œä¹Ÿå¯ä»¥æ˜¯ç¬¬ä¸‰æ–¹ç¼“å­˜çš„å®ç°</p><p><strong>size</strong>ï¼šæœ€å¤šç¼“å­˜å¯¹è±¡çš„ä¸ªæ•°</p><p><strong>eviction</strong>ï¼šç¼“å­˜å›æ”¶ç­–ç•¥ï¼Œé»˜è®¤æ˜¯LRU LRUï¼šæœ€è¿‘æœ€å°‘ä½¿ç”¨ç­–ç•¥ï¼Œå›æ”¶æœ€é•¿æ—¶é—´ä¸è¢«ä½¿ç”¨çš„ç¼“å­˜ FIFOï¼šå…ˆè¿›å…ˆå‡ºç­–ç•¥ï¼Œå›æ”¶æœ€æ–°è¿›å…¥çš„ç¼“å­˜ SOFT - è½¯å¼•ç”¨ï¼šç§»é™¤åŸºäºåƒåœ¾å›æ”¶å™¨çŠ¶æ€å’Œè½¯å¼•ç”¨è§„åˆ™çš„å¯¹è±¡ WEAK - å¼±å¼•ç”¨ï¼šæ›´ç§¯æåœ°ç§»é™¤åŸºäºåƒåœ¾æ”¶é›†å™¨çŠ¶æ€å’Œå¼±å¼•ç”¨è§„åˆ™çš„å¯¹è±¡</p><p><strong>flushInterval</strong>ï¼šç¼“å­˜åˆ·æ–°çš„é—´éš”æ—¶é—´ï¼Œé»˜è®¤æ˜¯ä¸åˆ·æ–°çš„</p><p><strong>readOnly</strong> ï¼š æ˜¯å¦åªè¯»ï¼Œtrue åªä¼šè¿›è¡Œè¯»å–æ“ä½œï¼Œä¿®æ”¹æ“ä½œäº¤ç”±ç”¨æˆ·å¤„ç† false å¯ä»¥è¿›è¡Œè¯»å–æ“ä½œï¼Œä¹Ÿå¯ä»¥è¿›è¡Œä¿®æ”¹æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;cache type=<span class="string">&quot;org.apache.ibatis.cache.impl.PerpetualCache&quot;</span></span><br><span class="line">       size=<span class="string">&quot;1024&quot;</span></span><br><span class="line">       eviction=<span class="string">&quot;LRU&quot;</span></span><br><span class="line">       flushInterval=<span class="string">&quot;120000&quot;</span></span><br><span class="line">       readOnly=<span class="string">&quot;false&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å¯¹å•ä¸ªStatementæ ‡ç­¾è¿›è¡Œå…³é—­å’Œå¼€å¯æ“ä½œï¼Œé€šè¿‡é…ç½®<code>useCache=&quot;true&quot;</code>æ¥å¼€å¯ç¼“å­˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=<span class="string">&quot;selectByPrimaryKey&quot;</span> parameterType=<span class="string">&quot;java.lang.Long&quot;</span></span><br><span class="line">        resultMap=<span class="string">&quot;BaseResultMap&quot;</span> useCache=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">  select </span><br><span class="line">  &lt;include refid=<span class="string">&quot;Base_Column_List&quot;</span> /&gt;</span><br><span class="line">  from t_test_user</span><br><span class="line">  <span class="type">where</span> <span class="variable">id</span> <span class="operator">=</span> #&#123;id,jdbcType=BIGINT&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure><hr><h4 id="äºŒçº§ç¼“å­˜å­˜å–">äºŒçº§ç¼“å­˜å­˜å–</h4><p>äºŒçº§ç¼“å­˜æ˜¯<code>SqlSessionFactory</code>çº§åˆ«çš„ç¼“å­˜ï¼Œå› æ­¤<code>SqlSession</code>æ˜¯ä¸å¯ä»¥ç®¡ç†çš„ï¼Œæˆ‘ä»¬å†æŠŠç›®å…‰è½¬å‘<code>Executor</code>ï¼Œ<code>Executor</code>åœ¨ä»‹ç»çš„æ—¶å€™æ¶‰åŠåˆ°äº†<code>CachingExecutor</code>ï¼Œåœ¨<code>Configuration</code>åˆ›å»º<code>Executor</code>çš„æ—¶å€™ï¼Œå¦‚æœå¼€å¯äº†äºŒçº§ç¼“å­˜ï¼Œå°±ä½¿ç”¨åˆ°äº†<code>CachingExecutor</code>è¿›è¡Œäº†åŒ…è£…ã€‚</p><div class="tabs" id="f2d9f129-8771-4134-a2a9-380761fd0eff"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#f2d9f129-8771-4134-a2a9-380761fd0eff-1"><i class="fas fa-bug"></i>Configuration#newExecutor</button></li><li class="tab"><button type="button" data-href="#f2d9f129-8771-4134-a2a9-380761fd0eff-2"><i class="fas fa-cannabis"></i>CachingExecutor</button></li><li class="tab"><button type="button" data-href="#f2d9f129-8771-4134-a2a9-380761fd0eff-3"><i class="fas fa-candy-cane"></i>CachingExecutor#query</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="f2d9f129-8771-4134-a2a9-380761fd0eff-1"><p><mark class="hl-label blue">Configuration#newExecutor</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Executor <span class="title function_">newExecutor</span><span class="params">(Transaction transaction, ExecutorType executorType)</span> &#123;</span><br><span class="line">    executorType = executorType == <span class="literal">null</span> ? defaultExecutorType : executorType;</span><br><span class="line">    executorType = executorType == <span class="literal">null</span> ? ExecutorType.SIMPLE : executorType;</span><br><span class="line">    Executor executor;</span><br><span class="line">    <span class="keyword">if</span> (ExecutorType.BATCH == executorType) &#123;</span><br><span class="line">        executor = <span class="keyword">new</span> <span class="title class_">BatchExecutor</span>(<span class="built_in">this</span>, transaction);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ExecutorType.REUSE == executorType) &#123;</span><br><span class="line">        executor = <span class="keyword">new</span> <span class="title class_">ReuseExecutor</span>(<span class="built_in">this</span>, transaction);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        executor = <span class="keyword">new</span> <span class="title class_">SimpleExecutor</span>(<span class="built_in">this</span>, transaction);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å¼€å¯äº†äºŒçº§ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">if</span> (cacheEnabled) &#123;</span><br><span class="line">        executor = <span class="keyword">new</span> <span class="title class_">CachingExecutor</span>(executor);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ›å»ºæ’ä»¶å¯¹è±¡</span></span><br><span class="line">    executor = (Executor) interceptorChain.pluginAll(executor);</span><br><span class="line">    <span class="keyword">return</span> executor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f2d9f129-8771-4134-a2a9-380761fd0eff-2"><p><code>CachingExecutor</code> ä¸­åªæœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼Œå…¶ä¸­ä¸€ä¸ªå°±æ˜¯<code>TransactionalCacheManager</code>ç”¨æ¥ç®¡ç†ç¼“å­˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. å§”æ‰˜æ‰§è¡Œå™¨ï¼Œä¹Ÿå°±æ˜¯è¢«åŒ…è£…çš„ä¸‰ç§æ‰§è¡Œå™¨çš„ä¸­çš„ä¸€ç§</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> Executor delegate;</span><br><span class="line"> <span class="comment">// 2. ç¼“å­˜ç®¡ç†ç±»ï¼Œç”¨æ¥ç®¡ç†TransactionalCache</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">TransactionalCacheManager</span> <span class="variable">tcm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransactionalCacheManager</span>();</span><br></pre></td></tr></table></figure><p><code>TransactionalCacheManager</code> ç»“æ„ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå†…éƒ¨ä¹Ÿç»´æŠ¤ç€ä¸€ä¸ªHashMapç¼“å­˜ï¼Œå…¶ä¸­<code>TransactionalCache</code>å®ç°äº†Cacheæ¥å£ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionalCacheManager</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¼“å­˜ï¼ŒTransactionalCacheå®ç°äº†Cacheæ¥å£</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Cache, TransactionalCache&gt; transactionalCaches = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">(Cache cache)</span> &#123;</span><br><span class="line">    getTransactionalCache(cache).clear();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(Cache cache, CacheKey key)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getTransactionalCache(cache).getObject(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putObject</span><span class="params">(Cache cache, CacheKey key, Object value)</span> &#123;</span><br><span class="line">    getTransactionalCache(cache).putObject(key, value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æäº¤</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (TransactionalCache txCache : transactionalCaches.values()) &#123;</span><br><span class="line">      txCache.commit();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å›æ»š</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rollback</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (TransactionalCache txCache : transactionalCaches.values()) &#123;</span><br><span class="line">      txCache.rollback();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–ç¼“å­˜</span></span><br><span class="line">  <span class="keyword">private</span> TransactionalCache <span class="title function_">getTransactionalCache</span><span class="params">(Cache cache)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> transactionalCaches.computeIfAbsent(cache, TransactionalCache::<span class="keyword">new</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f2d9f129-8771-4134-a2a9-380761fd0eff-3"><p><mark class="hl-label blue">CachingExecutor#query</mark></p><p>äºŒçº§ç¼“å­˜çš„çš„å­˜å–è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹<code>CachingExecutor</code>çš„queryæ–¹æ³•ã€‚å¦‚æœStatementæ ‡ç­¾é…ç½®äº†å¼€å¯ç¼“å­˜ï¼Œåˆ™ä»ç¼“å­˜ä¸­å»å–ï¼Œå¦åˆ™æ‰§è¡Œæ‰§è¡Œä¸€çº§ç¼“å­˜çš„æŸ¥è¯¢é€»è¾‘ã€‚å¦‚æœå¼€å¯äº†ç¼“å­˜ï¼Œåˆ™å…ˆä»äºŒçº§ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœå‘½ä¸­ç›´æ¥è¿”å›ï¼Œå¦åˆ™æ‰§è¡Œä¸€çº§ç¼“å­˜çš„é€»è¾‘ã€‚å› æ­¤å½“äºŒçº§ç¼“å­˜å¼€å¯æ—¶ï¼Œä¼˜å…ˆä»äºŒçº§ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œå†å»ä»ä¸€çº§ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œæœ€åä»æ•°æ®åº“æŸ¥æ‰¾ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span></span><br><span class="line">           <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">       <span class="comment">// è·å–äºŒçº§ç¼“å­˜é…ç½®æ ‡ç­¾</span></span><br><span class="line">       <span class="type">Cache</span> <span class="variable">cache</span> <span class="operator">=</span> ms.getCache();</span><br><span class="line">       <span class="keyword">if</span> (cache != <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="comment">// selectæ ‡ç­¾æ˜¯å¦é…ç½®äº†flushCacheå±æ€§</span></span><br><span class="line">           flushCacheIfRequired(ms);</span><br><span class="line">           <span class="comment">// å¦‚æœselectæ ‡ç­¾é…ç½®äº†useCacheå±æ€§</span></span><br><span class="line">           <span class="keyword">if</span> (ms.isUseCache() &amp;&amp; resultHandler == <span class="literal">null</span>) &#123;</span><br><span class="line">               <span class="comment">// äºŒçº§ç¼“å­˜ä¸èƒ½ç¼“å­˜è¾“å‡ºç±»å‹çš„å‚æ•°</span></span><br><span class="line">               ensureNoOutParams(ms, boundSql);</span><br><span class="line">               <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">               <span class="comment">// è·å–äºŒçº§ç¼“å­˜  </span></span><br><span class="line">               List&lt;E&gt; list = (List&lt;E&gt;) tcm.getObject(cache, key);</span><br><span class="line">               <span class="keyword">if</span> (list == <span class="literal">null</span>) &#123;</span><br><span class="line">                   <span class="comment">// å¦‚æœäºŒçº§ç¼“å­˜ä¸ºç©ºï¼Œåˆ™å†å»æŸ¥è¯¢ä¸€çº§ç¼“å­˜ï¼Œå¦‚æœä¸€çº§ç¼“å­˜ä¹Ÿæ²¡å‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“æ”¾åˆ°ç¼“å­˜ä¸­</span></span><br><span class="line">                   list = delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">                   <span class="comment">// äºŒçº§ç¼“å­˜å­˜å‚¨æ—¶å…ˆä¿å­˜åœ¨ä¸´æ—¶å±æ€§ä¸­ï¼Œç­‰äº‹åŠ¡æäº¤å†ä¿å­˜åˆ°çœŸå®çš„äºŒçº§ç¼“å­˜</span></span><br><span class="line">                   <span class="comment">// ç¼“å­˜åœ¨ä¸€ä¸ªä¸­é—´å˜é‡</span></span><br><span class="line">                   tcm.putObject(cache, key, list); <span class="comment">// issue #578 and #116</span></span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> list;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// æ²¡å¼€å¯ç¼“å­˜</span></span><br><span class="line">       <span class="keyword">return</span> delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h4 id="äºŒçº§ç¼“å­˜æ¸…é™¤">äºŒçº§ç¼“å­˜æ¸…é™¤</h4><p>æ¸…ç©ºç¼“å­˜ä¹Ÿæ˜¯åœ¨æ‰§è¡Œæ›´æ–°æ“ä½œçš„æ—¶å€™è¿›è¡Œåˆ é™¤ç¼“å­˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">update</span><span class="params">(MappedStatement ms, Object parameterObject)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">  <span class="comment">// æ¸…ç©ºç¼“å­˜</span></span><br><span class="line">  flushCacheIfRequired(ms);</span><br><span class="line">  <span class="comment">// è°ƒç”¨å®é™…æ‰§è¡Œå™¨çš„updateæ–¹æ³•</span></span><br><span class="line">  <span class="keyword">return</span> delegate.update(ms, parameterObject);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="æ€»ç»“">æ€»ç»“</h3><p>MyBatis ä¸­åŒ…å«ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜ï¼Œä¸€çº§ç¼“å­˜çš„ä½œç”¨èŒƒå›´æ˜¯SqlSessionçº§åˆ«çš„ï¼ŒäºŒçº§ç¼“å­˜æ˜¯SqlSessionFactoryçº§åˆ«çš„ã€‚</p><p>MyBatis ä¸­çš„ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜éƒ½æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œä¸è¿‡äºŒçº§ç¼“å­˜è¿˜è¦é¢å¤–åœ¨mapperå’Œstatementä¸­é…ç½®ç¼“å­˜å±æ€§</p><p>ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œå¦‚æœé¢‘ç¹çš„æ›´æ–°æ•°æ®ï¼Œå°†é™ä½æŸ¥è¯¢æ€§èƒ½ã€‚</p><hr><hr><h2 id="äº‹åŠ¡ç®¡ç†">äº‹åŠ¡ç®¡ç†</h2><h3 id="äº‹åŠ¡æ¦‚è¿°">äº‹åŠ¡æ¦‚è¿°</h3><p>æ•°æ®åº“äº‹åŠ¡çš„å®šä¹‰å°±æ˜¯å°†å¤šä¸ªæ‰§è¡Œå•å…ƒçœ‹ä½œä¸€ä¸ªæ•´ä½“ï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸï¼Œè¦ä¹ˆæ‰§è¡Œå¤±è´¥ã€‚äº‹åŠ¡å…·æœ‰ACIDå±æ€§ï¼Œäº‹åŠ¡çš„éš”ç¦»çº§åˆ«æœ‰è¯»æœªæäº¤ï¼Œè¯»æäº¤ï¼Œå¯é‡å¤è¯»ï¼Œä¸²è¡Œç­‰ç­‰ï¼Œè¿™äº›æ¶‰åŠåˆ°æ•°æ®åº“çš„çŸ¥è¯†æˆ‘ä»¬åœ¨æ­¤ä¸åšå±•å¼€ï¼Œå¸Œæœ›åŒå­¦ä»¬æœ‰è¿™æ–¹é¢çš„åŸºç¡€ã€‚</p><p>MyBatis äº‹åŠ¡ç®¡ç†çš„æ¥å£æ˜¯<code>Transaction</code>ï¼Œå®ƒå…¶å®åŒ…è£…çš„å°±æ˜¯ä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼Œå¤„ç†è¿™ä¸ªè¿æ¥çš„ç”Ÿå‘½å‘¨æœŸï¼Œå®ƒçš„æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åŒ…è£…ä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼Œå¤„ç†ä¸€ä¸ªæ•°æ®åº“è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬åˆ›å»ºï¼Œå‡†å¤‡ï¼Œæäº¤ï¼Œå›æ»šï¼Œå…³é—­</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Transaction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–å†…éƒ¨çš„æ•°æ®åº“è¿æ¥</span></span><br><span class="line">    Connection <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æäº¤</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å›æ»š</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">rollback</span><span class="params">()</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å…³é—­è¿æ¥</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    Integer <span class="title function_">getTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Transaction</code>æœ‰ä¸¤ä¸ªå®ç°<code>JdbcTransaction</code>å’Œ<code>ManagedTransaction</code>ï¼Œæä¾›çš„è¿™ä¸¤ç§ç®¡ç†æœºåˆ¶æ¥ç®¡ç†äº‹åŠ¡</p><ul><li><code>JdbcTransaction</code>ï¼šä½¿ç”¨Jdbcä¸­çš„java.sql.Connectionæ¥ç®¡ç†äº‹åŠ¡ï¼ŒåŒ…æ‹¬æäº¤å›æ»š</li><li><code>ManagedTransaction</code>ï¼šåœ¨è¿™ç§æœºåˆ¶ä¸‹ï¼ŒMyBatisä¸ä¼šç®¡ç†äº‹åŠ¡ï¼Œè€Œæ˜¯äº¤ç”±ç¨‹åºçš„è¿è¡Œå®¹å™¨(weblogicï¼Œtomcat)æ¥è¿›è¡Œç®¡ç†ã€‚</li></ul><hr><h3 id="åˆ›å»ºäº‹åŠ¡">åˆ›å»ºäº‹åŠ¡</h3><p>åœ¨mybatis-config.xmlä¸­å¯ä»¥é…ç½®äº‹åŠ¡ç®¡ç†çš„ç±»å‹ï¼Œå…¶ä¸­transactionManagerçš„ç±»å‹é…ç½®ä¸ºJDBCï¼Œå°†ä¼šä»¥JdbcTransactionç®¡ç†æœºåˆ¶æ¥ç®¡ç†äº‹åŠ¡ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://xxxx:3306/xxxx?useUnicode=true&quot;</span>/&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;xxxx&quot;</span>/&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;xxxx&quot;</span>/&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>XMLConfigBuilder</code> ä¸­çš„<code>environmentsElement</code>ä¼šè§£æ<code>transactionManager</code>ç±»å‹ï¼Œå¹¶ä¸”ä¼šåˆ›å»ºä¸€ä¸ª<code>TransactionFactory</code>ç±»å‹çš„äº‹åŠ¡å·¥å‚ï¼Œè¿™ä¸ªå·¥å‚çš„ä½œç”¨å°±æ˜¯æ¥åˆ›å»ºTransactionäº‹åŠ¡å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// XMLConfigBuilder</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">environmentsElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (context != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (environment == <span class="literal">null</span>) &#123;</span><br><span class="line">        environment = context.getStringAttribute(<span class="string">&quot;default&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (XNode child : context.getChildren()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (isSpecifiedEnvironment(id)) &#123;</span><br><span class="line">          <span class="type">TransactionFactory</span> <span class="variable">txFactory</span> <span class="operator">=</span> transactionManagerElement(child.evalNode(<span class="string">&quot;transactionManager&quot;</span>));</span><br><span class="line">          <span class="type">DataSourceFactory</span> <span class="variable">dsFactory</span> <span class="operator">=</span> dataSourceElement(child.evalNode(<span class="string">&quot;dataSource&quot;</span>));</span><br><span class="line">          <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> dsFactory.getDataSource();</span><br><span class="line">          Environment.<span class="type">Builder</span> <span class="variable">environmentBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Environment</span>.Builder(id)</span><br><span class="line">              .transactionFactory(txFactory)</span><br><span class="line">              .dataSource(dataSource);</span><br><span class="line">          configuration.setEnvironment(environmentBuilder.build());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>TransactionFactory</code> ä½œä¸ºå¯¹è±¡å·¥å‚ï¼Œå…¶åŠŸèƒ½å°±æ˜¯åˆ›å»ºä¸€ä¸ª<code>Transaction</code>å¯¹è±¡ã€‚åˆ›å»ºæ–¹å¼æœ‰ä¸¤ç§</p><ul><li>ä»å·²æœ‰çš„è¿æ¥ä¸­åˆ›å»ºTransactionå¯¹è±¡</li><li>æ ¹æ®æ•°æ®æºï¼Œæ•°æ®åº“éš”ç¦»çº§åˆ«ï¼Œè‡ªåŠ¨æäº¤åˆ›å»ºTransactionå¯¹è±¡</li></ul><p><code>TransactionFactory</code> æœ‰ä¸¤ä¸ªå®ç°ï¼Œä¸€ä¸ªæ˜¯<code>JdbcTransactionFactory</code>ï¼Œå¦ä¸€ä¸ªæ˜¯<code>ManagedTransactionFactory</code>ï¼Œä»–ä»¬åˆ†åˆ«åˆ›å»ºå‡ºæ¥çš„å°±æ˜¯<code>JdbcTransaction</code>å’Œ<code>ManagedTransaction</code>å¯¹è±¡ã€‚ä»¥<code>JdbcTransactionFactory</code>ä¸ºä¾‹ï¼Œå…¶å®ç°ä¹Ÿæ˜¯å¾ˆç®€å•çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcTransactionFactory</span> <span class="keyword">implements</span> <span class="title class_">TransactionFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Transaction <span class="title function_">newTransaction</span><span class="params">(Connection conn)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdbcTransaction</span>(conn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Transaction <span class="title function_">newTransaction</span><span class="params">(DataSource ds, TransactionIsolationLevel level, <span class="type">boolean</span> autoCommit)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdbcTransaction</span>(ds, level, autoCommit);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢åˆ›å»ºå®Œ<code>TransactionFactory</code>åï¼Œå°±ä¼šè¢«Environmentå¼•ç”¨ã€‚æ¥ä¸‹æ¥åœ¨è·å–SqlSessionçš„æ—¶å€™ï¼Œä¼šæ ¹æ®äº‹åŠ¡å·¥å‚åˆ›å»ºä¸€ä¸ª<code>Transaction</code>äº‹åŠ¡å¯¹è±¡ï¼Œæ ¹æ®è¿™ä¸ªå¯¹è±¡ï¼Œå†åˆ›å»ºå…·ä½“çš„<code>Executor</code>ï¼Œæœ€ç»ˆåˆ›å»ºå‡ºåˆ›å»ºSqlSessionå¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DefaultSqlSessionFactory</span></span><br><span class="line"><span class="keyword">private</span> SqlSession <span class="title function_">openSessionFromDataSource</span><span class="params">(ExecutorType execType, TransactionIsolationLevel level, <span class="type">boolean</span> autoCommit)</span> &#123;</span><br><span class="line">    <span class="type">Transaction</span> <span class="variable">tx</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> configuration.getEnvironment();</span><br><span class="line">        <span class="comment">// è·å–äº‹åŠ¡å·¥å‚</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">TransactionFactory</span> <span class="variable">transactionFactory</span> <span class="operator">=</span> getTransactionFactoryFromEnvironment(environment);</span><br><span class="line">        <span class="comment">// åˆ›å»ºäº‹åŠ¡å¯¹è±¡</span></span><br><span class="line">        tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);</span><br><span class="line">        <span class="comment">// åˆ›å»ºæ‰§è¡Œå™¨</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Executor</span> <span class="variable">executor</span> <span class="operator">=</span> configuration.newExecutor(tx, execType);</span><br><span class="line">        <span class="comment">// åˆ›å»ºSqlSessionå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultSqlSession</span>(configuration, executor, autoCommit);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        closeTransaction(tx); <span class="comment">// may have fetched a connection so lets call close()</span></span><br><span class="line">        <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">&quot;Error opening session.  Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">MyBatisæºç è§£æ</summary>
    
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="MyBatis" scheme="https://wuwawawa.github.io/tags/MyBatis/"/>
    
  </entry>
  
  <entry>
    <title>dockeré…ç½®å®¹å™¨</title>
    <link href="https://wuwawawa.github.io/posts/9a884145.html"/>
    <id>https://wuwawawa.github.io/posts/9a884145.html</id>
    <published>2023-05-24T05:52:16.000Z</published>
    <updated>2023-05-24T07:02:03.574Z</updated>
    
    <content type="html"><![CDATA[<h2 id="MySQL">MySQL</h2><div class="tabs" id="4943f5c8-2100-494b-94ef-04f8b7b0491d"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#4943f5c8-2100-494b-94ef-04f8b7b0491d-1"><i class="fas fa-seedling"></i>æ‹‰å–é•œåƒ</button></li><li class="tab"><button type="button" data-href="#4943f5c8-2100-494b-94ef-04f8b7b0491d-2"><i class="fas fa-leaf"></i>é…ç½®æ–‡ä»¶</button></li><li class="tab"><button type="button" data-href="#4943f5c8-2100-494b-94ef-04f8b7b0491d-3"><i class="fab fa-apple"></i>å®¹å™¨å¯åŠ¨å‘½ä»¤</button></li><li class="tab"><button type="button" data-href="#4943f5c8-2100-494b-94ef-04f8b7b0491d-4"><i class="fas fa-tree"></i>è¿œç¨‹è¿æ¥é…ç½®</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="4943f5c8-2100-494b-94ef-04f8b7b0491d-1"><p>å®‰è£…mysql5.7.25</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql:5.7.25</span><br></pre></td></tr></table></figure><p>å®‰è£…mysql8.0.27</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql:8.0.27</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4943f5c8-2100-494b-94ef-04f8b7b0491d-2"><p>åˆ›å»ºè¦æŒ‚è½½çš„æ–‡ä»¶å¤¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/docker/mysql8/conf/</span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/docker/mysql8/logs/</span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/docker/mysql8/data/</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ‹·è´ä¸€ä»½é…ç½®æ–‡ä»¶ï¼Œå…ˆéšä¾¿å¯åŠ¨ä¸€ä¸ªé•œåƒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p <span class="number">3306</span>:<span class="number">3306</span> --name mysql8 -e MYSQL_ROOT_PASSWORD=<span class="number">123456</span>  -d mysql:<span class="number">8.0</span><span class="number">.27</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨æˆåŠŸåï¼Œè¿è¡Œä¸‹é¢å‘½ä»¤æ‹·è´é…ç½®æ–‡ä»¶ï¼Œåˆ°å®¿ä¸»ä¸»æœº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span>  mysql8:/etc/mysql /opt/docker/mysql8/conf</span><br></pre></td></tr></table></figure><p>åˆ é™¤åˆšæ‰çš„å®¹å™¨ï¼Œé‡æ–°åˆ›å»ºå®¹å™¨ï¼Œå…ˆåœæ­¢å®¹å™¨ï¼Œå†åˆ é™¤å®¹å™¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker stop mysql8</span><br><span class="line">docker <span class="built_in">rm</span> mysql8</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4943f5c8-2100-494b-94ef-04f8b7b0491d-3"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">--name mysql8 \</span><br><span class="line">--privileged=<span class="literal">true</span> \</span><br><span class="line">--restart unless-stopped \</span><br><span class="line">-v /opt/docker/mysql8/conf/mysql:/etc/mysql \</span><br><span class="line">-v /opt/docker/mysql8/logs:/logs \</span><br><span class="line">-v /opt/docker/mysql8/data:/var/lib/mysql \</span><br><span class="line">-v /etc/localtime:/etc/localtime \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123456 \</span><br><span class="line">-d mysql:8.0.27</span><br></pre></td></tr></table></figure><p>å‘½ä»¤è§£é‡Š</p><p>-p ç«¯å£æ˜ å°„<br>â€“name å®¹å™¨åå­—ï¼Œè‡ªå®šä¹‰<br>â€“privileged=true æŒ‚è½½æ–‡ä»¶æƒé™è®¾ç½®<br>â€“restart unless-stopped è®¾ç½® å¼€æœºåè‡ªåŠ¨é‡å¯å®¹å™¨<br>-v /opt/docker/mysql8/conf/mysql:/etc/mysql æŒ‚è½½é…ç½®æ–‡ä»¶<br>-v /opt/docker/mysql8/logs:/logs \ æŒ‚è½½æ—¥å¿—<br>-v /opt/docker/mysql8/data:/var/lib/mysql \ æŒ‚è½½æ•°æ®æ–‡ä»¶ æŒä¹…åŒ–åˆ°ä¸»æœºï¼Œ<br>-v /etc/localtime:/etc/localtime å®¹å™¨æ—¶é—´ä¸å®¿ä¸»æœºåŒæ­¥<br>-e MYSQL_ROOT_PASSWORD=123456 è®¾ç½®å¯†ç <br>-d mysql:8.0.27 åå°å¯åŠ¨,mysql</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4943f5c8-2100-494b-94ef-04f8b7b0491d-4"><p>å¦‚æœå·²ç»èƒ½è¿œç¨‹è¿æ¥ï¼Œä»¥ä¸‹å¯å¿½ç•¥</p><p>è¿›å…¥å®¹å™¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it mysql8 bash</span><br></pre></td></tr></table></figure><p>ç™»å½•mysqlï¼Œ-påé¢è·Ÿä½ è‡ªå·±è®¾ç½®çš„å¯†ç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p123456</span><br></pre></td></tr></table></figure><p>æˆæƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER user <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;123456&#x27;</span>;</span><br></pre></td></tr></table></figure><p>åˆ·æ–°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h2 id="Redis">Redis</h2><div class="tabs" id="bddd351f-baa7-4f08-80d1-edddd01c219d"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#bddd351f-baa7-4f08-80d1-edddd01c219d-1"><i class="fas fa-cat"></i>æ‹‰å–é•œåƒ</button></li><li class="tab"><button type="button" data-href="#bddd351f-baa7-4f08-80d1-edddd01c219d-2"><i class="fas fa-horse"></i>é…ç½®æ–‡ä»¶</button></li><li class="tab"><button type="button" data-href="#bddd351f-baa7-4f08-80d1-edddd01c219d-3"><i class="fas fa-dove"></i>å¯åŠ¨å‘½ä»¤</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="bddd351f-baa7-4f08-80d1-edddd01c219d-1"><p>æ²¡æœ‰æŒ‡å®šç‰ˆæœ¬ï¼Œé»˜è®¤ä¸ºæœ€æ–°ç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull redis</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="bddd351f-baa7-4f08-80d1-edddd01c219d-2"><p>åˆ›å»ºè¦æŒ‚è½½çš„æ–‡ä»¶å¤¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/docker/redis/data</span><br><span class="line">vim /opt/docker/redis/redis.conf</span><br></pre></td></tr></table></figure><p>redis.conf</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bind 192.168.1.100 10.0.0.1</span></span><br><span class="line"><span class="comment"># bind 127.0.0.1 ::1</span></span><br><span class="line"><span class="comment">#bind 127.0.0.1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">protected-mode</span> <span class="string">no</span></span><br><span class="line"><span class="attr">port</span> <span class="string">6379</span></span><br><span class="line"><span class="attr">tcp-backlog</span> <span class="string">511</span></span><br><span class="line"><span class="attr">requirepass</span> <span class="string">000415</span></span><br><span class="line"><span class="attr">timeout</span> <span class="string">0</span></span><br><span class="line"><span class="attr">tcp-keepalive</span> <span class="string">300</span></span><br><span class="line"><span class="attr">daemonize</span> <span class="string">no</span></span><br><span class="line"><span class="attr">supervised</span> <span class="string">no</span></span><br><span class="line"><span class="attr">pidfile</span> <span class="string">/var/run/redis_6379.pid</span></span><br><span class="line"><span class="attr">loglevel</span> <span class="string">notice</span></span><br><span class="line"><span class="attr">logfile</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="attr">databases</span> <span class="string">30</span></span><br><span class="line"><span class="attr">always-show-logo</span> <span class="string">yes</span></span><br><span class="line"><span class="attr">save</span> <span class="string">900 1</span></span><br><span class="line"><span class="attr">save</span> <span class="string">300 10</span></span><br><span class="line"><span class="attr">save</span> <span class="string">60 10000</span></span><br><span class="line"><span class="attr">stop-writes-on-bgsave-error</span> <span class="string">yes</span></span><br><span class="line"><span class="attr">rdbcompression</span> <span class="string">yes</span></span><br><span class="line"><span class="attr">rdbchecksum</span> <span class="string">yes</span></span><br><span class="line"><span class="attr">dbfilename</span> <span class="string">dump.rdb</span></span><br><span class="line"><span class="attr">dir</span> <span class="string">./</span></span><br><span class="line"><span class="attr">replica-serve-stale-data</span> <span class="string">yes</span></span><br><span class="line"><span class="attr">replica-read-only</span> <span class="string">yes</span></span><br><span class="line"><span class="attr">repl-diskless-sync</span> <span class="string">no</span></span><br><span class="line"><span class="attr">repl-disable-tcp-nodelay</span> <span class="string">no</span></span><br><span class="line"><span class="attr">replica-priority</span> <span class="string">100</span></span><br><span class="line"><span class="attr">lazyfree-lazy-eviction</span> <span class="string">no</span></span><br><span class="line"><span class="attr">lazyfree-lazy-expire</span> <span class="string">no</span></span><br><span class="line"><span class="attr">lazyfree-lazy-server-del</span> <span class="string">no</span></span><br><span class="line"><span class="attr">replica-lazy-flush</span> <span class="string">no</span></span><br><span class="line"><span class="attr">appendonly</span> <span class="string">yes</span></span><br><span class="line"><span class="attr">appendfilename</span> <span class="string">&quot;appendonly.aof&quot;</span></span><br><span class="line"><span class="attr">no-appendfsync-on-rewrite</span> <span class="string">no</span></span><br><span class="line"><span class="attr">auto-aof-rewrite-percentage</span> <span class="string">100</span></span><br><span class="line"><span class="attr">auto-aof-rewrite-min-size</span> <span class="string">64mb</span></span><br><span class="line"><span class="attr">aof-load-truncated</span> <span class="string">yes</span></span><br><span class="line"><span class="attr">aof-use-rdb-preamble</span> <span class="string">yes</span></span><br><span class="line"><span class="attr">lua-time-limit</span> <span class="string">5000</span></span><br><span class="line"><span class="attr">slowlog-max-len</span> <span class="string">128</span></span><br><span class="line"><span class="attr">notify-keyspace-events</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="attr">hash-max-ziplist-entries</span> <span class="string">512</span></span><br><span class="line"><span class="attr">hash-max-ziplist-value</span> <span class="string">64</span></span><br><span class="line"><span class="attr">list-max-ziplist-size</span> <span class="string">-2</span></span><br><span class="line"><span class="attr">list-compress-depth</span> <span class="string">0</span></span><br><span class="line"><span class="attr">set-max-intset-entries</span> <span class="string">512</span></span><br><span class="line"><span class="attr">zset-max-ziplist-entries</span> <span class="string">128</span></span><br><span class="line"><span class="attr">zset-max-ziplist-value</span> <span class="string">64</span></span><br><span class="line"><span class="attr">hll-sparse-max-bytes</span> <span class="string">3000</span></span><br><span class="line"><span class="attr">stream-node-max-bytes</span> <span class="string">4096</span></span><br><span class="line"><span class="attr">stream-node-max-entries</span> <span class="string">100</span></span><br><span class="line"><span class="attr">activerehashing</span> <span class="string">yes</span></span><br><span class="line"><span class="attr">hz</span> <span class="string">10</span></span><br><span class="line"><span class="attr">dynamic-hz</span> <span class="string">yes</span></span><br><span class="line"><span class="attr">aof-rewrite-incremental-fsync</span> <span class="string">yes</span></span><br><span class="line"><span class="attr">rdb-save-incremental-fsync</span> <span class="string">yes</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="bddd351f-baa7-4f08-80d1-edddd01c219d-3"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --restart=always --log-opt max-size=100m --log-opt max-file=2 -p 6379:6379 --name redis -v /opt/docker/redis/redis.conf:/etc/redis/redis.conf -v /opt/docker/redis/data:/data -d redis redis-server /etc/redis/redis.conf  --appendonly <span class="built_in">yes</span>  --requirepass root123</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h2 id="Nacos">Nacos</h2><div class="tabs" id="557326db-5293-404d-a832-cca071d104ca"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#557326db-5293-404d-a832-cca071d104ca-1"><i class="fas fa-atom"></i>æ‹‰å–é•œåƒ</button></li><li class="tab"><button type="button" data-href="#557326db-5293-404d-a832-cca071d104ca-2"><i class="far fa-sun"></i>åˆ›å»ºæ•°æ®åº“</button></li><li class="tab"><button type="button" data-href="#557326db-5293-404d-a832-cca071d104ca-3"><i class="fas fa-wind"></i>é…ç½®æ–‡ä»¶</button></li><li class="tab"><button type="button" data-href="#557326db-5293-404d-a832-cca071d104ca-4"><i class="fas fa-fire-alt"></i>å¯åŠ¨å‘½ä»¤</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="557326db-5293-404d-a832-cca071d104ca-1"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull nacos/nacos-server</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="557326db-5293-404d-a832-cca071d104ca-2"><p><a href="https://github.com/alibaba/nacos/blob/master/config/src/main/resources/META-INF/nacos-db.sql">https://github.com/alibaba/nacos/blob/master/config/src/main/resources/META-INF/nacos-db.sql</a></p><p>mysqlæ–°å»ºnacosçš„æ•°æ®åº“,ï¼Œå¹¶æ‰§è¡Œä¸‹é¢çš„SQLè„šæœ¬</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE nacos;</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright 1999-2018 Alibaba Group Holding Ltd.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   è¡¨åç§° = config_info   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;content&#x27;</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;md5&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;2010-05-05 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;åˆ›å»ºæ—¶é—´&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;2010-05-05 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;ä¿®æ”¹æ—¶é—´&#x27;</span>,</span><br><span class="line">  `src_user` text COMMENT <span class="string">&#x27;source user&#x27;</span>,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;source ip&#x27;</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;ç§Ÿæˆ·å­—æ®µ&#x27;</span>,</span><br><span class="line">  `c_desc` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `c_use` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `effect` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `type` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `c_schema` text,</span><br><span class="line">  `encrypted_data_key` text <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ç§˜é’¥&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfo_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;config_info&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   è¡¨åç§° = config_info_aggr   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info_aggr` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;group_id&#x27;</span>,</span><br><span class="line">  `datum_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;datum_id&#x27;</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;å†…å®¹&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ä¿®æ”¹æ—¶é—´&#x27;</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;ç§Ÿæˆ·å­—æ®µ&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfoaggr_datagrouptenantdatum` (`data_id`,`group_id`,`tenant_id`,`datum_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;å¢åŠ ç§Ÿæˆ·å­—æ®µ&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   è¡¨åç§° = config_info_beta   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info_beta` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;group_id&#x27;</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;app_name&#x27;</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;content&#x27;</span>,</span><br><span class="line">  `beta_ips` <span class="type">varchar</span>(<span class="number">1024</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;betaIps&#x27;</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;md5&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;2010-05-05 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;åˆ›å»ºæ—¶é—´&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;2010-05-05 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;ä¿®æ”¹æ—¶é—´&#x27;</span>,</span><br><span class="line">  `src_user` text COMMENT <span class="string">&#x27;source user&#x27;</span>,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;source ip&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;ç§Ÿæˆ·å­—æ®µ&#x27;</span>,</span><br><span class="line">  `encrypted_data_key` text <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ç§˜é’¥&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfobeta_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;config_info_beta&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   è¡¨åç§° = config_info_tag   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info_tag` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;group_id&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;tenant_id&#x27;</span>,</span><br><span class="line">  `tag_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;tag_id&#x27;</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;app_name&#x27;</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;content&#x27;</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;md5&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;2010-05-05 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;åˆ›å»ºæ—¶é—´&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;2010-05-05 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;ä¿®æ”¹æ—¶é—´&#x27;</span>,</span><br><span class="line">  `src_user` text COMMENT <span class="string">&#x27;source user&#x27;</span>,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;source ip&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfotag_datagrouptenanttag` (`data_id`,`group_id`,`tenant_id`,`tag_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;config_info_tag&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   è¡¨åç§° = config_tags_relation   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_tags_relation` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `tag_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;tag_name&#x27;</span>,</span><br><span class="line">  `tag_type` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;tag_type&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;group_id&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;tenant_id&#x27;</span>,</span><br><span class="line">  `nid` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`nid`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configtagrelation_configidtag` (`id`,`tag_name`,`tag_type`),</span><br><span class="line">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;config_tag_relation&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   è¡¨åç§° = group_capacity   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `group_capacity` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;ä¸»é”®ID&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;Group IDï¼Œç©ºå­—ç¬¦è¡¨ç¤ºæ•´ä¸ªé›†ç¾¤&#x27;</span>,</span><br><span class="line">  `quota` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;é…é¢ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼&#x27;</span>,</span><br><span class="line">  `usage` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;ä½¿ç”¨é‡&#x27;</span>,</span><br><span class="line">  `max_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;å•ä¸ªé…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼&#x27;</span>,</span><br><span class="line">  `max_aggr_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;èšåˆå­é…ç½®æœ€å¤§ä¸ªæ•°ï¼Œï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼&#x27;</span>,</span><br><span class="line">  `max_aggr_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;å•ä¸ªèšåˆæ•°æ®çš„å­é…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼&#x27;</span>,</span><br><span class="line">  `max_history_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;æœ€å¤§å˜æ›´å†å²æ•°é‡&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;2010-05-05 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;åˆ›å»ºæ—¶é—´&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;2010-05-05 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;ä¿®æ”¹æ—¶é—´&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_group_id` (`group_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;é›†ç¾¤ã€å„Groupå®¹é‡ä¿¡æ¯è¡¨&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   è¡¨åç§° = his_config_info   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `his_config_info` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">64</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `nid` <span class="type">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;app_name&#x27;</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;2010-05-05 00:00:00&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;2010-05-05 00:00:00&#x27;</span>,</span><br><span class="line">  `src_user` text,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `op_type` <span class="type">char</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;ç§Ÿæˆ·å­—æ®µ&#x27;</span>,</span><br><span class="line">  `encrypted_data_key` text <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ç§˜é’¥&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`nid`),</span><br><span class="line">  KEY `idx_gmt_create` (`gmt_create`),</span><br><span class="line">  KEY `idx_gmt_modified` (`gmt_modified`),</span><br><span class="line">  KEY `idx_did` (`data_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;å¤šç§Ÿæˆ·æ”¹é€ &#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   è¡¨åç§° = tenant_capacity   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tenant_capacity` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;ä¸»é”®ID&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;Tenant ID&#x27;</span>,</span><br><span class="line">  `quota` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;é…é¢ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼&#x27;</span>,</span><br><span class="line">  `usage` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;ä½¿ç”¨é‡&#x27;</span>,</span><br><span class="line">  `max_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;å•ä¸ªé…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼&#x27;</span>,</span><br><span class="line">  `max_aggr_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;èšåˆå­é…ç½®æœ€å¤§ä¸ªæ•°&#x27;</span>,</span><br><span class="line">  `max_aggr_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;å•ä¸ªèšåˆæ•°æ®çš„å­é…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼&#x27;</span>,</span><br><span class="line">  `max_history_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;æœ€å¤§å˜æ›´å†å²æ•°é‡&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;2010-05-05 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;åˆ›å»ºæ—¶é—´&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;2010-05-05 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;ä¿®æ”¹æ—¶é—´&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;ç§Ÿæˆ·å®¹é‡ä¿¡æ¯è¡¨&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tenant_info` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `kp` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;kp&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;tenant_id&#x27;</span>,</span><br><span class="line">  `tenant_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;tenant_name&#x27;</span>,</span><br><span class="line">  `tenant_desc` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;tenant_desc&#x27;</span>,</span><br><span class="line">  `create_source` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;create_source&#x27;</span>,</span><br><span class="line">  `gmt_create` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;åˆ›å»ºæ—¶é—´&#x27;</span>,</span><br><span class="line">  `gmt_modified` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ä¿®æ”¹æ—¶é—´&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_tenant_info_kptenantid` (`kp`,`tenant_id`),</span><br><span class="line">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;tenant_info&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> users (</span><br><span class="line">username <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">password <span class="type">varchar</span>(<span class="number">500</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">enabled <span class="type">boolean</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> roles (</span><br><span class="line">username <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">role <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="keyword">constraint</span> uk_username_role <span class="keyword">UNIQUE</span> (username,role)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> permissions (</span><br><span class="line">    role <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    resource <span class="type">varchar</span>(<span class="number">512</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    action <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">constraint</span> uk_role_permission <span class="keyword">UNIQUE</span> (role,resource,action)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> users (username, password, enabled) <span class="keyword">VALUES</span> (<span class="string">&#x27;nacos&#x27;</span>, <span class="string">&#x27;$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu&#x27;</span>, <span class="literal">TRUE</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> roles (username, role) <span class="keyword">VALUES</span> (<span class="string">&#x27;nacos&#x27;</span>, <span class="string">&#x27;ROLE_ADMIN&#x27;</span>);</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="557326db-5293-404d-a832-cca071d104ca-3"><p>åˆ›å»ºæŒ‚è½½ç›®å½•ï¼Œç”¨äºæ˜ å°„åˆ°å®¹å™¨ï¼Œç›®å½•æŒ‰è‡ªå·±çš„æƒ…å†µåˆ›å»º</p><p>æ–°å»ºlogsç›®å½•</p><p>ä¿®æ”¹é…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/docker/nacos/logs/                      </span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/docker/nacos/init.d/         </span><br><span class="line">vim /opt/docker/nacos/init.d/custom.properties       </span><br></pre></td></tr></table></figure><p>ä¿®æ”¹é…ç½®æ–‡ä»¶custom.properties</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.contextPath</span>=<span class="string">/nacos</span></span><br><span class="line"><span class="attr">server.servlet.contextPath</span>=<span class="string">/nacos</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">8848</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">spring.datasource.platform</span>=<span class="string">mysql</span></span><br><span class="line"><span class="attr">db.num</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">db.url.0</span>=<span class="string">jdbc:mysql://8.130.68.59:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true</span></span><br><span class="line"><span class="attr">db.user</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">db.password</span>=<span class="string">123456</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">nacos.cmdb.dumpTaskInterval</span>=<span class="string">3600</span></span><br><span class="line"><span class="attr">nacos.cmdb.eventTaskInterval</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">nacos.cmdb.labelTaskInterval</span>=<span class="string">300</span></span><br><span class="line"><span class="attr">nacos.cmdb.loadDataAtStart</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">management.metrics.export.elastic.enabled</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">management.metrics.export.influx.enabled</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">server.tomcat.accesslog.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">server.tomcat.accesslog.pattern</span>=<span class="string">%h %l %u %t &quot;%r&quot; %s %b %D %&#123;User-Agent&#125;i</span></span><br><span class="line"><span class="attr">nacos.security.ignore.urls</span>=<span class="string">/,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.ico,/console-fe/public/**,/v1/auth/login,/v1/console/health/**,/v1/cs/**,/v1/ns/**,/v1/cmdb/**,/actuator/**,/v1/console/server/**</span></span><br><span class="line"><span class="attr">nacos.naming.distro.taskDispatchThreadCount</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">nacos.naming.distro.taskDispatchPeriod</span>=<span class="string">200</span></span><br><span class="line"><span class="attr">nacos.naming.distro.batchSyncKeyCount</span>=<span class="string">1000</span></span><br><span class="line"><span class="attr">nacos.naming.distro.initDataRatio</span>=<span class="string">0.9</span></span><br><span class="line"><span class="attr">nacos.naming.distro.syncRetryDelay</span>=<span class="string">5000</span></span><br><span class="line"><span class="attr">nacos.naming.data.warmup</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">nacos.naming.expireInstance</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="557326db-5293-404d-a832-cca071d104ca-4"><p>å¯åŠ¨åå¯è®¿é—®</p><p><a href="http://8.130.68.59:8848/nacos/index.html">http://8.130.68.59:8848/nacos/index.html</a></p><p>ç”¨æˆ·åï¼šnacos</p><p>å¯†ç ï¼šnacos</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker  run \</span><br><span class="line">--name nacos -d \</span><br><span class="line">-p 8848:8848 \</span><br><span class="line">--privileged=<span class="literal">true</span> \</span><br><span class="line">--restart=always \</span><br><span class="line">-e JVM_XMS=256m \</span><br><span class="line">-e JVM_XMX=256m \</span><br><span class="line">-e MODE=standalone \</span><br><span class="line">-e PREFER_HOST_MODE=hostname \</span><br><span class="line">-v /mydata/nacos/logs:/home/nacos/logs \</span><br><span class="line">-v /mydata/nacos/init.d/custom.properties:/home/nacos/init.d/custom.properties \</span><br><span class="line">nacos/nacos-server</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> ]]></content>
    
    
    <summary type="html">dockerå¯åŠ¨å„å®¹å™¨çš„å‘½ä»¤ã€æ“ä½œæ±‡æ€»</summary>
    
    
    
    <category term="æ¼”ç¤º" scheme="https://wuwawawa.github.io/categories/%E6%BC%94%E7%A4%BA/"/>
    
    
    <category term="docker" scheme="https://wuwawawa.github.io/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>MyBatisä½¿ç”¨</title>
    <link href="https://wuwawawa.github.io/posts/da3e1361.html"/>
    <id>https://wuwawawa.github.io/posts/da3e1361.html</id>
    <published>2023-05-24T04:02:50.000Z</published>
    <updated>2023-06-01T00:41:43.742Z</updated>
    
    <content type="html"><![CDATA[<h2 id="MyBatisç®€ä»‹">MyBatisç®€ä»‹</h2><p><a href="https://github.com/mybatis/mybatis-3">https://github.com/mybatis/mybatis-3</a></p><p>1ï¼‰ MyBatis æ˜¯æ”¯æŒå®šåˆ¶åŒ– SQLã€å­˜å‚¨è¿‡ç¨‹ä»¥åŠé«˜çº§æ˜ å°„çš„ä¼˜ç§€çš„æŒä¹…å±‚æ¡†æ¶</p><p>2ï¼‰ MyBatis é¿å…äº†å‡ ä¹æ‰€æœ‰çš„ JDBC ä»£ç å’Œæ‰‹åŠ¨è®¾ç½®å‚æ•°ä»¥åŠè·å–ç»“æœé›†</p><p>3ï¼‰ MyBatiså¯ä»¥ä½¿ç”¨ç®€å•çš„XMLæˆ–æ³¨è§£ç”¨äºé…ç½®å’ŒåŸå§‹æ˜ å°„ï¼Œå°†æ¥å£å’ŒJavaçš„POJOï¼ˆPlain Old JavaObjectsï¼Œæ™®é€šçš„Javaå¯¹è±¡ï¼‰æ˜ å°„æˆæ•°æ®åº“ä¸­çš„è®°å½•</p><p>4ï¼‰ MyBatis æ˜¯ä¸€ä¸ª åŠè‡ªåŠ¨çš„ORMï¼ˆObject Relation Mappingï¼‰æ¡†æ¶</p><blockquote><p>å’Œå…¶å®ƒæŒä¹…åŒ–å±‚æŠ€æœ¯å¯¹æ¯”JDBC</p></blockquote><p>JDBC</p><ul><li>SQL å¤¹æ‚åœ¨Javaä»£ç ä¸­è€¦åˆåº¦é«˜ï¼Œå¯¼è‡´ç¡¬ç¼–ç å†…ä¼¤</li><li>ç»´æŠ¤ä¸æ˜“ä¸”å®é™…å¼€å‘éœ€æ±‚ä¸­ SQL æœ‰å˜åŒ–ï¼Œé¢‘ç¹ä¿®æ”¹çš„æƒ…å†µå¤šè§</li><li>ä»£ç å†—é•¿ï¼Œå¼€å‘æ•ˆç‡ä½</li></ul><p>Hibernate å’Œ JPA</p><ul><li>æ“ä½œç®€ä¾¿ï¼Œå¼€å‘æ•ˆç‡é«˜</li><li>ç¨‹åºä¸­çš„é•¿éš¾å¤æ‚ SQL éœ€è¦ç»•è¿‡æ¡†æ¶</li><li>å†…éƒ¨è‡ªåŠ¨ç”Ÿäº§çš„ SQLï¼Œä¸å®¹æ˜“åšç‰¹æ®Šä¼˜åŒ–</li><li>åŸºäºå…¨æ˜ å°„çš„å…¨è‡ªåŠ¨æ¡†æ¶ï¼Œå¤§é‡å­—æ®µçš„ POJO è¿›è¡Œéƒ¨åˆ†æ˜ å°„æ—¶æ¯”è¾ƒå›°éš¾ã€‚</li><li>åå°„æ“ä½œå¤ªå¤šï¼Œå¯¼è‡´æ•°æ®åº“æ€§èƒ½ä¸‹é™</li></ul><p>MyBatis</p><ul><li>è½»é‡çº§ï¼Œæ€§èƒ½å‡ºè‰²</li><li>SQL å’Œ Java ç¼–ç åˆ†å¼€ï¼ŒåŠŸèƒ½è¾¹ç•Œæ¸…æ™°ã€‚Javaä»£ç ä¸“æ³¨ä¸šåŠ¡ã€SQLè¯­å¥ä¸“æ³¨æ•°æ®</li><li>å¼€å‘æ•ˆç‡ç¨é€ŠäºHIbernateï¼Œä½†æ˜¯å®Œå…¨èƒ½å¤Ÿæ¥å—</li></ul><hr><hr><h2 id="æ­å»ºMyBatis">æ­å»ºMyBatis</h2><div class="tabs" id="b9589100-ad1b-43b1-ac50-49e9663afe48"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#b9589100-ad1b-43b1-ac50-49e9663afe48-1"><i class="fas fa-seedling"></i>å¼•å…¥ä¾èµ–</button></li><li class="tab"><button type="button" data-href="#b9589100-ad1b-43b1-ac50-49e9663afe48-2"><i class="fas fa-leaf"></i>åˆ›å»ºé…ç½®æ–‡ä»¶</button></li><li class="tab"><button type="button" data-href="#b9589100-ad1b-43b1-ac50-49e9663afe48-3"><i class="fab fa-apple"></i>åˆ›å»ºmapperæ¥å£</button></li><li class="tab"><button type="button" data-href="#b9589100-ad1b-43b1-ac50-49e9663afe48-4"><i class="fas fa-tree"></i>åˆ›å»ºæ˜ å°„æ–‡ä»¶</button></li><li class="tab"><button type="button" data-href="#b9589100-ad1b-43b1-ac50-49e9663afe48-5"><i class="fas fa-cookie-bite"></i>åŠ å…¥æ—¥å¿—åŠŸèƒ½</button></li><li class="tab"><button type="button" data-href="#b9589100-ad1b-43b1-ac50-49e9663afe48-6"><i class="fas fa-heartbeat"></i>æµ‹è¯•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="b9589100-ad1b-43b1-ac50-49e9663afe48-1"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Mybatisæ ¸å¿ƒ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- junitæµ‹è¯• --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- MySQLé©±åŠ¨ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- log4jæ—¥å¿— --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b9589100-ad1b-43b1-ac50-49e9663afe48-2"><p>ä¹ æƒ¯ä¸Šå‘½åä¸ºmybatis-config.xmlï¼Œè¿™ä¸ªæ–‡ä»¶åä»…ä»…åªæ˜¯å»ºè®®ï¼Œå¹¶éå¼ºåˆ¶è¦æ±‚ã€‚å°†æ¥æ•´åˆSpringä¹‹åï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶å¯ä»¥çœç•¥ï¼Œæ‰€ä»¥å¤§å®¶æ“ä½œæ—¶å¯ä»¥ç›´æ¥å¤åˆ¶ã€ç²˜è´´ã€‚æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸»è¦ç”¨äºé…ç½®è¿æ¥æ•°æ®åº“çš„ç¯å¢ƒä»¥åŠMyBatisçš„å…¨å±€é…ç½®ä¿¡æ¯ã€‚æ ¸å¿ƒé…ç½®æ–‡ä»¶å­˜æ”¾çš„ä½ç½®æ˜¯src/main/resourcesç›®å½•ä¸‹ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--è®¾ç½®è¿æ¥æ•°æ®åº“çš„ç¯å¢ƒ--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span><span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/MyBatis&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123456&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--å¼•å…¥æ˜ å°„æ–‡ä»¶--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;mappers/UserMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b9589100-ad1b-43b1-ac50-49e9663afe48-3"><p>MyBatisä¸­çš„mapperæ¥å£ç›¸å½“äºä»¥å‰çš„daoã€‚ä½†æ˜¯åŒºåˆ«åœ¨äºï¼Œmapperä»…ä»…æ˜¯æ¥å£ï¼Œæˆ‘ä»¬ä¸éœ€è¦æä¾›å®ç°ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ·»åŠ ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insertUser</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b9589100-ad1b-43b1-ac50-49e9663afe48-4"><p>ç›¸å…³æ¦‚å¿µï¼šORMï¼ˆObject Relationship Mappingï¼‰å¯¹è±¡å…³ç³»æ˜ å°„ã€‚</p><p>å¯¹è±¡ï¼šJavaçš„å®ä½“ç±»å¯¹è±¡</p><p>å…³ç³»ï¼šå…³ç³»å‹æ•°æ®åº“</p><p>æ˜ å°„ï¼šäºŒè€…ä¹‹é—´çš„å¯¹åº”å…³ç³»</p><table><thead><tr><th style="text-align:left">Javaæ¦‚å¿µ</th><th style="text-align:left">æ•°æ®åº“æ¦‚å¿µ</th></tr></thead><tbody><tr><td style="text-align:left">ç±»</td><td style="text-align:left">è¡¨</td></tr><tr><td style="text-align:left">å±æ€§</td><td style="text-align:left">å­—æ®µ/åˆ—</td></tr><tr><td style="text-align:left">å¯¹è±¡</td><td style="text-align:left">è®°å½•/è¡Œ</td></tr></tbody></table><p>1ã€æ˜ å°„æ–‡ä»¶çš„å‘½åè§„åˆ™ï¼š</p><p>è¡¨æ‰€å¯¹åº”çš„å®ä½“ç±»çš„ç±»å+Mapper.xml</p><p>ä¾‹å¦‚ï¼šè¡¨t_userï¼Œæ˜ å°„çš„å®ä½“ç±»ä¸ºUserï¼Œæ‰€å¯¹åº”çš„æ˜ å°„æ–‡ä»¶ä¸ºUserMapper.xml</p><p>å› æ­¤ä¸€ä¸ªæ˜ å°„æ–‡ä»¶å¯¹åº”ä¸€ä¸ªå®ä½“ç±»ï¼Œå¯¹åº”ä¸€å¼ è¡¨çš„æ“ä½œ</p><p>MyBatisæ˜ å°„æ–‡ä»¶ç”¨äºç¼–å†™SQLï¼Œè®¿é—®ä»¥åŠæ“ä½œè¡¨ä¸­çš„æ•°æ®</p><p>MyBatisæ˜ å°„æ–‡ä»¶å­˜æ”¾çš„ä½ç½®æ˜¯src/main/resources/mappersç›®å½•ä¸‹</p><p>2ã€MyBatisä¸­å¯ä»¥é¢å‘æ¥å£æ“ä½œæ•°æ®ï¼Œè¦ä¿è¯ä¸¤ä¸ªä¸€è‡´ï¼š</p><p><span class='p red'>mapperæ¥å£çš„å…¨ç±»åå’Œæ˜ å°„æ–‡ä»¶çš„å‘½åç©ºé—´ï¼ˆnamespaceï¼‰ä¿æŒä¸€è‡´</span></p><p><span class='p green'>mapperæ¥å£ä¸­æ–¹æ³•çš„æ–¹æ³•åå’Œæ˜ å°„æ–‡ä»¶ä¸­ç¼–å†™SQLçš„æ ‡ç­¾çš„idå±æ€§ä¿æŒä¸€è‡´</span></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.atguigu.mybatis.mapper.UserMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--int insertUser();--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertUser&quot;</span>&gt;</span></span><br><span class="line">        insert into t_user values(null,&#x27;å¼ ä¸‰&#x27;,&#x27;123&#x27;,23,&#x27;å¥³&#x27;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b9589100-ad1b-43b1-ac50-49e9663afe48-5"><p>log4jçš„é…ç½®æ–‡ä»¶åä¸ºlog4j.xmlï¼Œå­˜æ”¾çš„ä½ç½®æ˜¯src/main/resourcesç›®å½•ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">log4j</span>:configuration <span class="keyword">SYSTEM</span> <span class="string">&quot;log4j.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">log4j:configuration</span> <span class="attr">xmlns:log4j</span>=<span class="string">&quot;http://jakarta.apache.org/log4j/&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.log4j.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;Encoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">layout</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.log4j.PatternLayout&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;ConversionPattern&quot;</span> <span class="attr">value</span>=<span class="string">&quot;%-5p %d&#123;MM-dd HH:mm:ss,SSS&#125; %m  (%F:%L) \n&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;java.sql&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">value</span>=<span class="string">&quot;debug&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;org.apache.ibatis&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">value</span>=<span class="string">&quot;info&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">value</span>=<span class="string">&quot;debug&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">log4j:configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b9589100-ad1b-43b1-ac50-49e9663afe48-6"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¯»å–MyBatisçš„æ ¸å¿ƒé…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> Resources.getResourceAsStream(<span class="string">&quot;mybatis-config.xml&quot;</span>);</span><br><span class="line"><span class="comment">//åˆ›å»ºSqlSessionFactoryBuilderå¯¹è±¡</span></span><br><span class="line"><span class="type">SqlSessionFactoryBuilder</span> <span class="variable">sqlSessionFactoryBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>();</span><br><span class="line"><span class="comment">//é€šè¿‡æ ¸å¿ƒé…ç½®æ–‡ä»¶æ‰€å¯¹åº”çš„å­—èŠ‚è¾“å…¥æµåˆ›å»ºå·¥å‚ç±»SqlSessionFactoryï¼Œç”Ÿäº§SqlSessionå¯¹è±¡</span></span><br><span class="line"><span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> sqlSessionFactoryBuilder.build(is);</span><br><span class="line"><span class="comment">//åˆ›å»ºSqlSessionå¯¹è±¡ï¼Œæ­¤æ—¶é€šè¿‡SqlSessionå¯¹è±¡æ‰€æ“ä½œçš„sqléƒ½å¿…é¡»æ‰‹åŠ¨æäº¤æˆ–å›æ»šäº‹åŠ¡</span></span><br><span class="line"><span class="comment">//SqlSession sqlSession = sqlSessionFactory.openSession();</span></span><br><span class="line"><span class="comment">//åˆ›å»ºSqlSessionå¯¹è±¡ï¼Œæ­¤æ—¶é€šè¿‡SqlSessionå¯¹è±¡æ‰€æ“ä½œçš„sqléƒ½ä¼šè‡ªåŠ¨æäº¤</span></span><br><span class="line"><span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> sqlSessionFactory.openSession(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">//é€šè¿‡ä»£ç†æ¨¡å¼åˆ›å»ºUserMapperæ¥å£çš„ä»£ç†å®ç°ç±»å¯¹è±¡</span></span><br><span class="line"><span class="type">UserMapper</span> <span class="variable">userMapper</span> <span class="operator">=</span> sqlSession.getMapper(UserMapper.class);</span><br><span class="line"><span class="comment">//è°ƒç”¨UserMapperæ¥å£ä¸­çš„æ–¹æ³•ï¼Œå°±å¯ä»¥æ ¹æ®UserMapperçš„å…¨ç±»ååŒ¹é…å…ƒç´ æ–‡ä»¶ï¼Œé€šè¿‡è°ƒç”¨çš„æ–¹æ³•ååŒ¹é…</span></span><br><span class="line">æ˜ å°„æ–‡ä»¶ä¸­çš„SQLæ ‡ç­¾ï¼Œå¹¶æ‰§è¡Œæ ‡ç­¾ä¸­çš„SQLè¯­å¥</span><br><span class="line"><span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> userMapper.insertUser();</span><br><span class="line"><span class="comment">//sqlSession.commit();</span></span><br></pre></td></tr></table></figure><ul><li>SqlSessionï¼šä»£è¡¨Javaç¨‹åºå’Œæ•°æ®åº“ä¹‹é—´çš„ä¼šè¯ã€‚ï¼ˆHttpSessionæ˜¯Javaç¨‹åºå’Œæµè§ˆå™¨ä¹‹é—´çš„ä¼šè¯)</li><li>SqlSessionFactoryï¼šæ˜¯â€œç”Ÿäº§â€SqlSessionçš„â€œå·¥å‚â€ã€‚</li><li>å·¥å‚æ¨¡å¼ï¼šå¦‚æœåˆ›å»ºæŸä¸€ä¸ªå¯¹è±¡ï¼Œä½¿ç”¨çš„è¿‡ç¨‹åŸºæœ¬å›ºå®šï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æŠŠåˆ›å»ºè¿™ä¸ªå¯¹è±¡çš„ç›¸å…³ä»£ç å°è£…åˆ°ä¸€ä¸ªâ€œå·¥å‚ç±»â€ä¸­ï¼Œä»¥åéƒ½ä½¿ç”¨è¿™ä¸ªå·¥å‚ç±»æ¥â€œç”Ÿäº§â€æˆ‘ä»¬éœ€è¦çš„å¯¹è±¡ã€‚</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="MyBatisçš„å¢åˆ æ”¹æŸ¥">MyBatisçš„å¢åˆ æ”¹æŸ¥</h2><div class="tabs" id="af4343a3-125d-40b3-be51-03e956cfc71b"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#af4343a3-125d-40b3-be51-03e956cfc71b-1"><i class="fas fa-dragon"></i>æŸ¥è¯¢</button></li><li class="tab"><button type="button" data-href="#af4343a3-125d-40b3-be51-03e956cfc71b-2"><i class="fas fa-cat"></i>æ·»åŠ </button></li><li class="tab"><button type="button" data-href="#af4343a3-125d-40b3-be51-03e956cfc71b-3"><i class="fas fa-horse"></i>åˆ é™¤</button></li><li class="tab"><button type="button" data-href="#af4343a3-125d-40b3-be51-03e956cfc71b-4"><i class="fas fa-dove"></i>ä¿®æ”¹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="af4343a3-125d-40b3-be51-03e956cfc71b-1"><p>æŸ¥è¯¢ä¸€ä¸ªå®ä½“ç±»å¯¹è±¡</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--User getUserById();--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getUserById&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.atguigu.mybatis.pojo.User&quot;</span>&gt;</span></span><br><span class="line">    select * from t_user where id = 2</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span>s</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢é›†åˆ</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--List&lt;User&gt; getAllUser();--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getAllUser&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.atguigu.mybatis.pojo.User&quot;</span>&gt;</span></span><br><span class="line">    select * from t_user</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼š</p><p>1ã€æŸ¥è¯¢çš„æ ‡ç­¾selectå¿…é¡»è®¾ç½®å±æ€§resultTypeæˆ–resultMapï¼Œç”¨äºè®¾ç½®å®ä½“ç±»å’Œæ•°æ®åº“è¡¨çš„æ˜ å°„å…³ç³»</p><p>resultTypeï¼šè‡ªåŠ¨æ˜ å°„ï¼Œç”¨äºå±æ€§åå’Œè¡¨ä¸­å­—æ®µåä¸€è‡´çš„æƒ…å†µ</p><p>resultMapï¼šè‡ªå®šä¹‰æ˜ å°„ï¼Œç”¨äºä¸€å¯¹å¤šæˆ–å¤šå¯¹ä¸€æˆ–å­—æ®µåå’Œå±æ€§åä¸ä¸€è‡´çš„æƒ…å†µ</p><p>2ã€å½“æŸ¥è¯¢çš„æ•°æ®ä¸ºå¤šæ¡æ—¶ï¼Œä¸èƒ½ä½¿ç”¨å®ä½“ç±»ä½œä¸ºè¿”å›å€¼ï¼Œåªèƒ½ä½¿ç”¨é›†åˆï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸TooManyResultsExceptionï¼›ä½†æ˜¯è‹¥æŸ¥è¯¢çš„æ•°æ®åªæœ‰ä¸€æ¡ï¼Œå¯ä»¥ä½¿ç”¨å®ä½“ç±»æˆ–é›†åˆä½œä¸ºè¿”å›å€¼</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="af4343a3-125d-40b3-be51-03e956cfc71b-2"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--int insertUser();--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertUser&quot;</span>&gt;</span></span><br><span class="line">    insert into t_user values(null,&#x27;admin&#x27;,&#x27;123456&#x27;,23,&#x27;ç”·&#x27;,&#x27;12345@qq.com&#x27;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="af4343a3-125d-40b3-be51-03e956cfc71b-3"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--int deleteUser();--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteUser&quot;</span>&gt;</span></span><br><span class="line">    delete from t_user where id = 5</span><br><span class="line"><span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="af4343a3-125d-40b3-be51-03e956cfc71b-4"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--int updateUser();--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateUser&quot;</span>&gt;</span></span><br><span class="line">    update t_user set username = &#x27;å¼ ä¸‰&#x27; where id = 4</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="é…ç½®æ–‡ä»¶è¯¦è§£">é…ç½®æ–‡ä»¶è¯¦è§£</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        MyBatisæ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸­ï¼Œæ ‡ç­¾çš„é¡ºåºï¼š</span></span><br><span class="line"><span class="comment">        properties?,settings?,typeAliases?,typeHandlers?,</span></span><br><span class="line"><span class="comment">        objectFactory?,objectWrapperFactory?,reflectorFactory?,</span></span><br><span class="line"><span class="comment">        plugins?,environments?,databaseIdProvider?,mappers?</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--å¼•å…¥propertiesæ–‡ä»¶--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">&quot;jdbc.properties&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--è®¾ç½®ç±»å‹åˆ«å--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">            typeAliasï¼šè®¾ç½®æŸä¸ªç±»å‹çš„åˆ«å</span></span><br><span class="line"><span class="comment">            å±æ€§ï¼š</span></span><br><span class="line"><span class="comment">                typeï¼šè®¾ç½®éœ€è¦è®¾ç½®åˆ«åçš„ç±»å‹</span></span><br><span class="line"><span class="comment">                aliasï¼šè®¾ç½®æŸä¸ªç±»å‹çš„åˆ«åï¼Œè‹¥ä¸è®¾ç½®è¯¥å±æ€§ï¼Œé‚£ä¹ˆè¯¥ç±»å‹æ‹¥æœ‰é»˜è®¤çš„åˆ«åå³ç±»å,ä¸”ä¸åŒºåˆ†å¤§å°å†™</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;typeAlias type=&quot;com.atguigu.mybatis.pojo.User&quot; alias=&quot;User&quot;&gt;&lt;/typeAlias&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--ä»¥åŒ…ä¸ºå•ä½ï¼Œå°†åŒ…ä¸‹æ‰€æœ‰çš„ç±»å‹è®¾ç½®é»˜è®¤çš„ç±»å‹åˆ«åï¼Œå³ç±»åä¸”ä¸åŒºåˆ†å¤§å°å†™--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.atguigu.mybatis.pojo&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        environmentsï¼šé…ç½®å¤šä¸ªè¿æ¥æ•°æ®åº“çš„ç¯å¢ƒ</span></span><br><span class="line"><span class="comment">        å±æ€§ï¼š</span></span><br><span class="line"><span class="comment">            defaultï¼šè®¾ç½®é»˜è®¤ä½¿ç”¨çš„ç¯å¢ƒçš„id</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">            environmentï¼šé…ç½®æŸä¸ªå…·ä½“çš„ç¯å¢ƒ</span></span><br><span class="line"><span class="comment">            å±æ€§ï¼š</span></span><br><span class="line"><span class="comment">                idï¼šè¡¨ç¤ºè¿æ¥æ•°æ®åº“çš„ç¯å¢ƒçš„å”¯ä¸€æ ‡è¯†ï¼Œä¸èƒ½é‡å¤</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">                transactionManagerï¼šè®¾ç½®äº‹åŠ¡ç®¡ç†æ–¹å¼</span></span><br><span class="line"><span class="comment">                å±æ€§ï¼š</span></span><br><span class="line"><span class="comment">                    type=&quot;JDBC|MANAGED&quot;</span></span><br><span class="line"><span class="comment">                    JDBCï¼šè¡¨ç¤ºå½“å‰ç¯å¢ƒä¸­ï¼Œæ‰§è¡ŒSQLæ—¶ï¼Œä½¿ç”¨çš„æ˜¯JDBCä¸­åŸç”Ÿçš„äº‹åŠ¡ç®¡ç†æ–¹å¼ï¼Œäº‹åŠ¡çš„æäº¤æˆ–å›æ»šéœ€è¦æ‰‹åŠ¨å¤„ç†</span></span><br><span class="line"><span class="comment">                    MANAGEDï¼šè¢«ç®¡ç†ï¼Œä¾‹å¦‚Spring</span></span><br><span class="line"><span class="comment">            --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">                dataSourceï¼šé…ç½®æ•°æ®æº</span></span><br><span class="line"><span class="comment">                å±æ€§ï¼š</span></span><br><span class="line"><span class="comment">                    typeï¼šè®¾ç½®æ•°æ®æºçš„ç±»å‹</span></span><br><span class="line"><span class="comment">                    type=&quot;POOLED|UNPOOLED|JNDI&quot;</span></span><br><span class="line"><span class="comment">                    POOLEDï¼šè¡¨ç¤ºä½¿ç”¨æ•°æ®åº“è¿æ¥æ± ç¼“å­˜æ•°æ®åº“è¿æ¥</span></span><br><span class="line"><span class="comment">                    UNPOOLEDï¼šè¡¨ç¤ºä¸ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± </span></span><br><span class="line"><span class="comment">                    JNDIï¼šè¡¨ç¤ºä½¿ç”¨ä¸Šä¸‹æ–‡ä¸­çš„æ•°æ®æº</span></span><br><span class="line"><span class="comment">            --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--è®¾ç½®è¿æ¥æ•°æ®åº“çš„é©±åŠ¨--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--è®¾ç½®è¿æ¥æ•°æ®åº“çš„è¿æ¥åœ°å€--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--è®¾ç½®è¿æ¥æ•°æ®åº“çš„ç”¨æˆ·å--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--è®¾ç½®è¿æ¥æ•°æ®åº“çš„å¯†ç --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;test&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/mybatis&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123456&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--å¼•å…¥æ˜ å°„æ–‡ä»¶--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;mapper resource=&quot;mappers/UserMapper.xml&quot;/&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">            ä»¥åŒ…ä¸ºå•ä½å¼•å…¥æ˜ å°„æ–‡ä»¶</span></span><br><span class="line"><span class="comment">            è¦æ±‚ï¼š</span></span><br><span class="line"><span class="comment">            1ã€mapperæ¥å£æ‰€åœ¨çš„åŒ…è¦å’Œæ˜ å°„æ–‡ä»¶æ‰€åœ¨çš„åŒ…ä¸€è‡´</span></span><br><span class="line"><span class="comment">            2ã€mapperæ¥å£è¦å’Œæ˜ å°„æ–‡ä»¶çš„åå­—ä¸€è‡´</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.atguigu.mybatis.mapper&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><hr><h2 id="åŠ¨æ€å‚æ•°â­ï¸">åŠ¨æ€å‚æ•°â­ï¸</h2><p>MyBatisè·å–å‚æ•°å€¼çš„ä¸¤ç§æ–¹å¼ï¼š<code>$&#123;&#125;</code>å’Œ<code>#&#123;&#125;</code></p><p><code>$&#123;&#125;</code>çš„æœ¬è´¨å°±æ˜¯å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œ<code>#&#123;&#125;</code>çš„æœ¬è´¨å°±æ˜¯å ä½ç¬¦èµ‹å€¼</p><p>å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼å¯èƒ½ä¼šå‡ºç°SQLæ³¨å…¥ï¼Œå°½é‡ä½¿ç”¨å ä½ç¬¦èµ‹å€¼çš„æ–¹å¼ã€‚</p><p><code>$&#123;&#125;</code>ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼æ‹¼æ¥sqlï¼Œè‹¥ä¸ºå­—ç¬¦ä¸²ç±»å‹æˆ–æ—¥æœŸç±»å‹çš„å­—æ®µè¿›è¡Œèµ‹å€¼æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨åŠ å•å¼•å·</p><p><code>#&#123;&#125;</code>ä½¿ç”¨å ä½ç¬¦èµ‹å€¼çš„æ–¹å¼æ‹¼æ¥sqlï¼Œæ­¤æ—¶ä¸ºå­—ç¬¦ä¸²ç±»å‹æˆ–æ—¥æœŸç±»å‹çš„å­—æ®µè¿›è¡Œèµ‹å€¼æ—¶ï¼Œä¼šè‡ªåŠ¨æ·»åŠ å•å¼•å·</p><div class="tabs" id="fc2038e7-e664-461d-97bb-e12bfd7ea027"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#fc2038e7-e664-461d-97bb-e12bfd7ea027-1"><i class="fas fa-atom"></i>1</button></li><li class="tab"><button type="button" data-href="#fc2038e7-e664-461d-97bb-e12bfd7ea027-2"><i class="far fa-sun"></i>2</button></li><li class="tab"><button type="button" data-href="#fc2038e7-e664-461d-97bb-e12bfd7ea027-3"><i class="fas fa-wind"></i>3</button></li><li class="tab"><button type="button" data-href="#fc2038e7-e664-461d-97bb-e12bfd7ea027-4"><i class="fas fa-fire-alt"></i>4â­ï¸</button></li><li class="tab"><button type="button" data-href="#fc2038e7-e664-461d-97bb-e12bfd7ea027-5"><i class="fas fa-cookie-bite"></i>5â­ï¸</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="fc2038e7-e664-461d-97bb-e12bfd7ea027-1"><blockquote><p>Mapperæ¥å£æ–¹æ³•çš„å‚æ•°ä¸ºå•ä¸ªå­—é¢é‡ç±»å‹çš„å‚æ•°</p></blockquote><p>è‹¥mapperæ¥å£ä¸­çš„æ–¹æ³•å‚æ•°ä¸ºå•ä¸ªçš„å­—é¢é‡ç±»å‹æ­¤æ—¶å¯ä»¥ä½¿ç”¨${}å’Œ#{}ä»¥ä»»æ„çš„åç§°è·å–å‚æ•°çš„å€¼ï¼Œæ³¨æ„${}éœ€è¦æ‰‹åŠ¨åŠ å•å¼•å·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">User <span class="title function_">getUserByUsername</span><span class="params">(String username)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--User getUserByUsername(String username);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getUserByUsername&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--select * from t_user where username = #&#123;username&#125;--&gt;</span></span><br><span class="line">    select * from t_user where username = &#x27;$&#123;username&#125;&#x27;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="fc2038e7-e664-461d-97bb-e12bfd7ea027-2"><blockquote><p>Mapperæ¥å£æ–¹æ³•çš„å‚æ•°ä¸ºå¤šä¸ªå­—é¢é‡ç±»å‹çš„å‚æ•°</p></blockquote><p>è‹¥mapperæ¥å£ä¸­çš„æ–¹æ³•å‚æ•°ä¸ºå¤šä¸ªæ—¶æ­¤æ—¶MyBatisä¼šè‡ªåŠ¨å°†è¿™äº›å‚æ•°æ”¾åœ¨ä¸€ä¸ªmapé›†åˆä¸­ï¼Œä¼šä»¥ä¸¤ç§æ–¹å¼å­˜å‚¨æ•°æ®</p><ul><li><p>ä»¥arg0,arg1â€¦ä¸ºé”®ï¼Œä»¥å‚æ•°ä¸ºå€¼ï¼›</p></li><li><p>ä»¥param1,param2â€¦ä¸ºé”®ï¼Œä»¥å‚æ•°ä¸ºå€¼ï¼›</p></li></ul><p>å› æ­¤åªéœ€è¦é€šè¿‡${}å’Œ#{}è®¿é—®mapé›†åˆçš„é”®å°±å¯ä»¥è·å–ç›¸å¯¹åº”çš„å€¼ï¼Œæ³¨æ„${}éœ€è¦æ‰‹åŠ¨åŠ å•å¼•å·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * éªŒè¯ç™»å½•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">User <span class="title function_">checkLogin</span><span class="params">(String username, String password)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--User checkLogin(String username, String password);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;checkLogin&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--select * from t_user where username = #&#123;arg0&#125; and password = #&#123;arg1&#125;--&gt;</span></span><br><span class="line">    select * from t_user where username = &#x27;$&#123;param1&#125;&#x27; and password = &#x27;$&#123;param2&#125;&#x27;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="fc2038e7-e664-461d-97bb-e12bfd7ea027-3"><blockquote><p>Mapperæ¥å£æ–¹æ³•çš„å‚æ•°ä¸ºmapé›†åˆç±»å‹çš„å‚æ•°</p></blockquote><p>è‹¥mapperæ¥å£ä¸­çš„æ–¹æ³•éœ€è¦çš„å‚æ•°ä¸ºå¤šä¸ªæ—¶ï¼Œæ­¤æ—¶å¯ä»¥æ‰‹åŠ¨åˆ›å»ºmapé›†åˆï¼Œå°†è¿™äº›æ•°æ®æ”¾åœ¨mapä¸­åªéœ€è¦é€šè¿‡${}å’Œ#{}è®¿é—®mapé›†åˆçš„é”®å°±å¯ä»¥è·å–ç›¸å¯¹åº”çš„å€¼ï¼Œæ³¨æ„${}éœ€è¦æ‰‹åŠ¨åŠ å•å¼•å·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * éªŒè¯ç™»å½•ï¼ˆå‚æ•°ä¸ºmapï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">User <span class="title function_">checkLoginByMap</span><span class="params">(Map&lt;String, Object&gt; map)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--User checkLoginByMap(Map&lt;String, Object&gt; map);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;checkLoginByMap&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">    select * from t_user where username = #&#123;username&#125; and password = #&#123;password&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="fc2038e7-e664-461d-97bb-e12bfd7ea027-4"><blockquote><p>Mapperæ¥å£æ–¹æ³•çš„å‚æ•°ä¸ºå®ä½“ç±»ç±»å‹çš„å‚æ•°</p></blockquote><p>è‹¥mapperæ¥å£ä¸­çš„æ–¹æ³•å‚æ•°ä¸ºå®ä½“ç±»å¯¹è±¡æ—¶æ­¤æ—¶å¯ä»¥ä½¿ç”¨${}å’Œ#{}ï¼Œé€šè¿‡è®¿é—®å®ä½“ç±»å¯¹è±¡ä¸­çš„å±æ€§åè·å–å±æ€§å€¼ï¼Œæ³¨æ„${}éœ€è¦æ‰‹åŠ¨åŠ å•å¼•å·</p><p><mark class="hl-label red">æ³¨æ„ï¼š</mark> è¿™ä¸ªå±æ€§çœ‹çš„æ˜¯getå’Œsetæ–¹æ³•ï¼Œå–å€¼æ‰¾getï¼Œèµ‹å€¼æ‰¾set</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ·»åŠ ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">insertUser</span><span class="params">(User user)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--int insertUser(User user);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertUser&quot;</span>&gt;</span></span><br><span class="line">    insert into t_user values(null,#&#123;username&#125;,#&#123;password&#125;,#&#123;age&#125;,#&#123;sex&#125;,#&#123;email&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="fc2038e7-e664-461d-97bb-e12bfd7ea027-5"><blockquote><p>å¯ä»¥é€šè¿‡@Paramæ³¨è§£æ ‡è¯†mapperæ¥å£ä¸­çš„æ–¹æ³•å‚æ•°</p></blockquote><p>æ­¤æ—¶ï¼Œä¼šå°†è¿™äº›å‚æ•°æ”¾åœ¨mapé›†åˆä¸­</p><ul><li>ä»¥@Paramæ³¨è§£çš„valueå±æ€§å€¼ä¸ºé”®ï¼Œä»¥å‚æ•°ä¸ºå€¼</li><li>ä»¥param1,param2â€¦ä¸ºé”®ï¼Œä»¥å‚æ•°ä¸ºå€¼</li></ul><p>åªéœ€è¦é€šè¿‡${}å’Œ#{}è®¿é—®mapé›†åˆçš„é”®å°±å¯ä»¥è·å–ç›¸å¯¹åº”çš„å€¼ï¼Œæ³¨æ„${}éœ€è¦æ‰‹åŠ¨åŠ å•å¼•å·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * éªŒè¯ç™»å½•ï¼ˆä½¿ç”¨<span class="doctag">@Param</span>ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">User <span class="title function_">checkLoginByParam</span><span class="params">(<span class="meta">@Param(&quot;username&quot;)</span> String username, <span class="meta">@Param(&quot;password&quot;)</span> String password)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--User checkLoginByParam(@Param(&quot;username&quot;) String username, @Param(&quot;password&quot;) String password);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;checkLoginByParam&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">    select * from t_user where username = #&#123;username&#125; and password = #&#123;password&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><hr><h2 id="å„ç§æŸ¥è¯¢åŠŸèƒ½">å„ç§æŸ¥è¯¢åŠŸèƒ½</h2><ul><li>è‹¥æŸ¥è¯¢å‡ºçš„æ•°æ®åªæœ‰ä¸€æ¡<ul><li>å¯ä»¥é€šè¿‡å®ä½“ç±»å¯¹è±¡æ¥æ”¶</li><li>å¯ä»¥é€šè¿‡listé›†åˆæ¥æ”¶</li><li>å¯ä»¥é€šè¿‡mapé›†åˆæ¥æ”¶</li></ul></li><li>è‹¥æŸ¥è¯¢å‡ºçš„æ•°æ®æœ‰å¤šæ¡<ul><li>å¯ä»¥é€šè¿‡listé›†åˆæ¥æ”¶</li><li>å¯ä»¥é€šè¿‡mapé›†åˆçš„listé›†åˆæ¥æ”¶</li><li>å¯ä»¥åœ¨mapperæ¥å£çš„æ–¹æ³•ä¸Šæ·»åŠ @MapKeyæ³¨è§£ï¼Œæ­¤æ—¶å°±å¯ä»¥å°†æ¯æ¡æ•°æ®è½¬æ¢çš„mapé›†åˆä½œä¸ºå€¼ï¼Œä»¥æŸä¸ªå­—æ®µçš„å€¼ä½œä¸ºé”®ï¼Œæ”¾åœ¨åŒä¸€ä¸ªmapé›†åˆä¸­</li><li>ä¸€å®šä¸èƒ½é€šè¿‡å®ä½“ç±»å¯¹è±¡æ¥æ”¶ï¼Œæ­¤æ—¶ä¼šæŠ›å¼‚å¸¸TooManyResultsException</li></ul></li></ul><div class="tabs" id="053b5256-67aa-48af-84e8-ebdd472e1c46"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#053b5256-67aa-48af-84e8-ebdd472e1c46-1"><i class="fas fa-award"></i>1</button></li><li class="tab"><button type="button" data-href="#053b5256-67aa-48af-84e8-ebdd472e1c46-2"><i class="fas fa-baseball-ball"></i>2</button></li><li class="tab"><button type="button" data-href="#053b5256-67aa-48af-84e8-ebdd472e1c46-3"><i class="fas fa-bone"></i>3</button></li><li class="tab"><button type="button" data-href="#053b5256-67aa-48af-84e8-ebdd472e1c46-4"><i class="fas fa-anchor"></i>4</button></li><li class="tab"><button type="button" data-href="#053b5256-67aa-48af-84e8-ebdd472e1c46-5"><i class="fas fa-heartbeat"></i>5</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="053b5256-67aa-48af-84e8-ebdd472e1c46-1"><blockquote><p>æŸ¥è¯¢ä¸€ä¸ªå®ä½“ç±»å¯¹è±¡</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">User <span class="title function_">getUserById</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> <span class="type">int</span> id)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--User getUserById(@Param(&quot;id&quot;) int id);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getUserById&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">    select * from t_user where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="053b5256-67aa-48af-84e8-ebdd472e1c46-2"><blockquote><p>æŸ¥è¯¢ä¸€ä¸ªlisté›†åˆ</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">List&lt;User&gt; <span class="title function_">getUserList</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--List&lt;User&gt; getUserList();--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getUserList&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">    select * from t_user</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="053b5256-67aa-48af-84e8-ebdd472e1c46-3"><blockquote><p>æŸ¥è¯¢å•ä¸ªæ•°æ®</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* æŸ¥è¯¢ç”¨æˆ·çš„æ€»è®°å½•æ•°</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">* åœ¨MyBatisä¸­ï¼Œå¯¹äºJavaä¸­å¸¸ç”¨çš„ç±»å‹éƒ½è®¾ç½®äº†ç±»å‹åˆ«å</span></span><br><span class="line"><span class="comment">* ä¾‹å¦‚ï¼šjava.lang.Integer--&gt;int|integer</span></span><br><span class="line"><span class="comment">* ä¾‹å¦‚ï¼šint--&gt;_int|_integer</span></span><br><span class="line"><span class="comment">* ä¾‹å¦‚ï¼šMap--&gt;map,List--&gt;list</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">getCount</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--<span class="type">int</span> <span class="title function_">getCount</span><span class="params">()</span>;--&gt;</span><br><span class="line">&lt;select id=<span class="string">&quot;getCount&quot;</span> resultType=<span class="string">&quot;_integer&quot;</span>&gt;</span><br><span class="line">    select <span class="title function_">count</span><span class="params">(id)</span> from t_user</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="053b5256-67aa-48af-84e8-ebdd472e1c46-4"><p>æŸ¥è¯¢ä¸€æ¡æ•°æ®ä¸ºmapé›†åˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ä¸ºmapé›†åˆ</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">Map&lt;String, Object&gt; <span class="title function_">getUserToMap</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> <span class="type">int</span> id)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Map&lt;String, Object&gt; getUserToMap(@Param(&quot;id&quot;) int id);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getUserToMap&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;map&quot;</span>&gt;</span></span><br><span class="line">    select * from t_user where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--ç»“æœï¼š&#123;password=123456, sex=ç”·, id=1, age=23, username=admin&#125;--&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="053b5256-67aa-48af-84e8-ebdd472e1c46-5"><blockquote><p>æŸ¥è¯¢å¤šæ¡æ•°æ®ä¸ºmapé›†åˆ</p></blockquote><p>æ–¹å¼ä¸€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯ä¸ºmapé›†åˆ</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">* å°†è¡¨ä¸­çš„æ•°æ®ä»¥mapé›†åˆçš„æ–¹å¼æŸ¥è¯¢ï¼Œä¸€æ¡æ•°æ®å¯¹åº”ä¸€ä¸ªmapï¼›è‹¥æœ‰å¤šæ¡æ•°æ®ï¼Œå°±ä¼šäº§ç”Ÿå¤šä¸ªmapé›†åˆï¼Œæ­¤</span></span><br><span class="line"><span class="comment">æ—¶å¯ä»¥å°†è¿™äº›mapæ”¾åœ¨ä¸€ä¸ªlisté›†åˆä¸­è·å–</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">List&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">getAllUserToMap</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Map&lt;String, Object&gt; getAllUserToMap();--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getAllUserToMap&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;map&quot;</span>&gt;</span></span><br><span class="line">    select * from t_user</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ–¹å¼äºŒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯ä¸ºmapé›†åˆ</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">* å°†è¡¨ä¸­çš„æ•°æ®ä»¥mapé›†åˆçš„æ–¹å¼æŸ¥è¯¢ï¼Œä¸€æ¡æ•°æ®å¯¹åº”ä¸€ä¸ªmapï¼›è‹¥æœ‰å¤šæ¡æ•°æ®ï¼Œå°±ä¼šäº§ç”Ÿå¤šä¸ªmapé›†åˆï¼Œå¹¶</span></span><br><span class="line"><span class="comment">ä¸”æœ€ç»ˆè¦ä»¥ä¸€ä¸ªmapçš„æ–¹å¼è¿”å›æ•°æ®ï¼Œæ­¤æ—¶éœ€è¦é€šè¿‡<span class="doctag">@MapKey</span>æ³¨è§£è®¾ç½®mapé›†åˆçš„é”®ï¼Œå€¼æ˜¯æ¯æ¡æ•°æ®æ‰€å¯¹åº”çš„</span></span><br><span class="line"><span class="comment">mapé›†åˆ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@MapKey(&quot;id&quot;)</span></span><br><span class="line">Map&lt;String, Object&gt; <span class="title function_">getAllUserToMap</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Map&lt;String, Object&gt; getAllUserToMap();--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getAllUserToMap&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;map&quot;</span>&gt;</span></span><br><span class="line">    select * from t_user</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">ç»“æœï¼š</span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">1=&#123;password=123456, sex=ç”·, id=1, age=23, username=admin&#125;,</span></span><br><span class="line"><span class="comment">2=&#123;password=123456, sex=ç”·, id=2, age=23, username=å¼ ä¸‰&#125;,</span></span><br><span class="line"><span class="comment">3=&#123;password=123456, sex=ç”·, id=3, age=23, username=å¼ ä¸‰&#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <table><thead><tr><th>åˆ«å</th><th>æ˜ å°„çš„ç±»å‹</th></tr></thead><tbody><tr><td>_byte</td><td>byte</td></tr><tr><td>byte</td><td>Byte</td></tr><tr><td>_long</td><td>long</td></tr><tr><td>long</td><td>Long</td></tr><tr><td>_short</td><td>short</td></tr><tr><td>short</td><td>Short</td></tr><tr><td>_int</td><td>int</td></tr><tr><td>_integer</td><td>int</td></tr><tr><td>int</td><td>Integer</td></tr><tr><td>integer</td><td>Integer</td></tr><tr><td>_double</td><td>double</td></tr><tr><td>double</td><td>Double</td></tr><tr><td>_float</td><td>float</td></tr><tr><td>float</td><td>Float</td></tr><tr><td>_boolean</td><td>boolean</td></tr><tr><td>boolean</td><td>Boolean</td></tr><tr><td>string</td><td>String</td></tr><tr><td>date</td><td>Date</td></tr><tr><td>decimal</td><td>BigDecimal</td></tr><tr><td>bigdecimal</td><td>BigDecimal</td></tr><tr><td>object</td><td>Object</td></tr><tr><td>map</td><td>Map</td></tr><tr><td>hashmap</td><td>HashMap</td></tr><tr><td>list</td><td>List</td></tr><tr><td>arraylist</td><td>ArrayList</td></tr><tr><td>collection</td><td>Collection</td></tr><tr><td>iterator</td><td>Iterator</td></tr></tbody></table><hr><hr><h2 id="ç‰¹æ®ŠSQLæ‰§è¡Œ">ç‰¹æ®ŠSQLæ‰§è¡Œ</h2><p>ä¹‹å‰æåˆ°MyBatisè·å–å‚æ•°å€¼çš„ä¸¤ç§æ–¹å¼ï¼š<code>$&#123;&#125;</code>å’Œ<code>#&#123;&#125;</code>ã€‚</p><p><code>$&#123;&#125;</code>çš„æœ¬è´¨å°±æ˜¯å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œ<code>#&#123;&#125;</code>çš„æœ¬è´¨å°±æ˜¯å ä½ç¬¦èµ‹å€¼ã€‚</p><p>å› æ­¤<code>#&#123;&#125;</code>æ˜¯ä¼šè‡ªåŠ¨åŠ å•å¼•å·çš„ï¼Œè€Œ<code>$&#123;&#125;</code>æ˜¯ä¸ä¼šæ˜¯ä¸ä¼šè‡ªåŠ¨åŠ å•å¼•å·çš„ã€‚</p><p>å»ºè®®ä½¿ç”¨<code>#&#123;&#125;</code>ï¼Œä½†å¯¹äºä¸€äº›ç‰¹æ®Šçš„SQLæ¥è¯´ï¼Œä½¿ç”¨<code>#&#123;&#125;</code>æ˜¯ä¼šå‡ºç°ä¸€äº›é—®é¢˜çš„ã€‚æ¯”å¦‚è¯´æ¨¡ç³ŠæŸ¥è¯¢ï¼Œæ‰¹é‡åˆ é™¤å’ŒåŠ¨æ€è®¾ç½®è¡¨åã€‚</p><div class="tabs" id="399fa9cd-2a35-4f43-b528-872ffca8ebf9"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#399fa9cd-2a35-4f43-b528-872ffca8ebf9-1"><i class="fas fa-bug"></i>æ¨¡ç³ŠæŸ¥è¯¢</button></li><li class="tab"><button type="button" data-href="#399fa9cd-2a35-4f43-b528-872ffca8ebf9-2"><i class="fas fa-cannabis"></i>æ‰¹é‡åˆ é™¤</button></li><li class="tab"><button type="button" data-href="#399fa9cd-2a35-4f43-b528-872ffca8ebf9-3"><i class="fas fa-candy-cane"></i>åŠ¨æ€è®¾ç½®è¡¨å</button></li><li class="tab"><button type="button" data-href="#399fa9cd-2a35-4f43-b528-872ffca8ebf9-4"><i class="fas fa-child"></i>æ·»åŠ åŠŸèƒ½è·å–è‡ªå¢çš„ä¸»é”®</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="399fa9cd-2a35-4f43-b528-872ffca8ebf9-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æµ‹è¯•æ¨¡ç³ŠæŸ¥è¯¢</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mohu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;User&gt; <span class="title function_">testMohu</span><span class="params">(<span class="meta">@Param(&quot;mohu&quot;)</span> String mohu)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--List&lt;User&gt; testMohu(@Param(&quot;mohu&quot;) String mohu);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;testMohu&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--select * from t_user where username like &#x27;%#&#123;mohu&#125;%&#x27; ä¼šæŠ¥é”™ --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--select * from t_user where username like &#x27;%$&#123;mohu&#125;%&#x27;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--select * from t_user where username like concat(&#x27;%&#x27;,#&#123;mohu&#125;,&#x27;%&#x27;)--&gt;</span></span><br><span class="line">    select * from t_user where username like &quot;%&quot;#&#123;mohu&#125;&quot;%&quot;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="399fa9cd-2a35-4f43-b528-872ffca8ebf9-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* æ‰¹é‡åˆ é™¤</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> ids</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">deleteMore</span><span class="params">(<span class="meta">@Param(&quot;ids&quot;)</span> String ids)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--int deleteMore(@Param(&quot;ids&quot;) String ids);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteMore&quot;</span>&gt;</span></span><br><span class="line">    delete from t_user where id in ($&#123;ids&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>#{ids}</code>ä¼šè‡ªåŠ¨æ·»åŠ å•å¼•å·ï¼Œä¸ä¼šåˆ é™¤æˆåŠŸ</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="399fa9cd-2a35-4f43-b528-872ffca8ebf9-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* åŠ¨æ€è®¾ç½®è¡¨åï¼ŒæŸ¥è¯¢æ‰€æœ‰çš„ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> tableName</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">List&lt;User&gt; <span class="title function_">getAllUser</span><span class="params">(<span class="meta">@Param(&quot;tableName&quot;)</span> String tableName)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--List&lt;User&gt; getAllUser(@Param(&quot;tableName&quot;) String tableName);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getAllUser&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">    select * from $&#123;tableName&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¡¨åä¸å¯ä»¥åŠ å•å¼•å·ï¼ŒåŒç†ä¸èƒ½ä½¿ç”¨<code>#{}</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="399fa9cd-2a35-4f43-b528-872ffca8ebf9-4"><p>t_clazz(clazz_id,clazz_name)</p><p>t_student(student_id,student_name,clazz_id)</p><p>1ã€æ·»åŠ ç­çº§ä¿¡æ¯</p><p>2ã€è·å–æ–°æ·»åŠ çš„ç­çº§çš„id</p><p>3ã€ä¸ºç­çº§åˆ†é…å­¦ç”Ÿï¼Œå³å°†æŸå­¦çš„ç­çº§idä¿®æ”¹ä¸ºæ–°æ·»åŠ çš„ç­çº§çš„id</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* æ·»åŠ ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">* useGeneratedKeysï¼šè®¾ç½®ä½¿ç”¨è‡ªå¢çš„ä¸»é”®</span></span><br><span class="line"><span class="comment">* keyPropertyï¼šå› ä¸ºå¢åˆ æ”¹æœ‰ç»Ÿä¸€çš„è¿”å›å€¼æ˜¯å—å½±å“çš„è¡Œæ•°ï¼Œå› æ­¤åªèƒ½å°†è·å–çš„è‡ªå¢çš„ä¸»é”®æ”¾åœ¨ä¼ è¾“çš„å‚</span></span><br><span class="line"><span class="comment">æ•°userå¯¹è±¡çš„æŸä¸ªå±æ€§ä¸­</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">insertUser</span><span class="params">(User user)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--int insertUser(User user);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertUser&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">    insert into t_user values(null,#&#123;username&#125;,#&#123;password&#125;,#&#123;age&#125;,#&#123;sex&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="è‡ªå®šä¹‰æ˜ å°„resultMap">è‡ªå®šä¹‰æ˜ å°„resultMap</h2><h3 id="è‡ªå®šä¹‰æ˜ å°„å…³ç³»">è‡ªå®šä¹‰æ˜ å°„å…³ç³»</h3><p>è‹¥å­—æ®µåå’Œå®ä½“ç±»ä¸­çš„å±æ€§åä¸ä¸€è‡´ï¼Œåˆ™å¯ä»¥é€šè¿‡resultMapè®¾ç½®è‡ªå®šä¹‰æ˜ å°„</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">resultMapï¼šè®¾ç½®è‡ªå®šä¹‰æ˜ å°„</span></span><br><span class="line"><span class="comment">å±æ€§ï¼š</span></span><br><span class="line"><span class="comment">idï¼šè¡¨ç¤ºè‡ªå®šä¹‰æ˜ å°„çš„å”¯ä¸€æ ‡è¯†</span></span><br><span class="line"><span class="comment">typeï¼šæŸ¥è¯¢çš„æ•°æ®è¦æ˜ å°„çš„å®ä½“ç±»çš„ç±»å‹</span></span><br><span class="line"><span class="comment">å­æ ‡ç­¾ï¼š</span></span><br><span class="line"><span class="comment">idï¼šè®¾ç½®ä¸»é”®çš„æ˜ å°„å…³ç³»</span></span><br><span class="line"><span class="comment">resultï¼šè®¾ç½®æ™®é€šå­—æ®µçš„æ˜ å°„å…³ç³»</span></span><br><span class="line"><span class="comment">associationï¼šè®¾ç½®å¤šå¯¹ä¸€çš„æ˜ å°„å…³ç³»</span></span><br><span class="line"><span class="comment">collectionï¼šè®¾ç½®ä¸€å¯¹å¤šçš„æ˜ å°„å…³ç³»</span></span><br><span class="line"><span class="comment">å±æ€§ï¼š</span></span><br><span class="line"><span class="comment">propertyï¼šè®¾ç½®æ˜ å°„å…³ç³»ä¸­å®ä½“ç±»ä¸­çš„å±æ€§å</span></span><br><span class="line"><span class="comment">columnï¼šè®¾ç½®æ˜ å°„å…³ç³»ä¸­è¡¨ä¸­çš„å­—æ®µå</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;userMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;userName&quot;</span> <span class="attr">column</span>=<span class="string">&quot;user_name&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;password&quot;</span> <span class="attr">column</span>=<span class="string">&quot;password&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;age&quot;</span> <span class="attr">column</span>=<span class="string">&quot;age&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;sex&quot;</span> <span class="attr">column</span>=<span class="string">&quot;sex&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--List&lt;User&gt; testMohu(@Param(&quot;mohu&quot;) String mohu);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;testMohu&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;userMap&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--select * from t_user where username like &#x27;%$&#123;mohu&#125;%&#x27;--&gt;</span></span><br><span class="line">    select id,user_name,password,age,sex from t_user where user_name like</span><br><span class="line">    concat(&#x27;%&#x27;,#&#123;mohu&#125;,&#x27;%&#x27;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è‹¥å­—æ®µåå’Œå®ä½“ç±»ä¸­çš„å±æ€§åä¸ä¸€è‡´ï¼Œä½†æ˜¯å­—æ®µåç¬¦åˆæ•°æ®åº“çš„è§„åˆ™ï¼ˆä½¿ç”¨_ï¼‰ï¼Œå®ä½“ç±»ä¸­çš„å±æ€§åç¬¦åˆJavaçš„è§„åˆ™ï¼ˆä½¿ç”¨é©¼å³°ï¼‰</p><p>æ­¤æ—¶ä¹Ÿå¯é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼å¤„ç†å­—æ®µåå’Œå®ä½“ç±»ä¸­çš„å±æ€§çš„æ˜ å°„å…³ç³»</p><p>a&gt;å¯ä»¥é€šè¿‡ä¸ºå­—æ®µèµ·åˆ«åçš„æ–¹å¼ï¼Œä¿è¯å’Œå®ä½“ç±»ä¸­çš„å±æ€§åä¿æŒä¸€è‡´</p><p>b&gt;å¯ä»¥åœ¨MyBatisçš„æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸­è®¾ç½®ä¸€ä¸ªå…¨å±€é…ç½®ä¿¡æ¯mapUnderscoreToCamelCaseï¼Œå¯ä»¥åœ¨æŸ¥è¯¢è¡¨ä¸­æ•°æ®æ—¶ï¼Œè‡ªåŠ¨å°†_ç±»å‹çš„å­—æ®µåè½¬æ¢ä¸ºé©¼å³°</p><p>ä¾‹å¦‚ï¼šå­—æ®µåuser_nameï¼Œè®¾ç½®äº†mapUnderscoreToCamelCaseï¼Œæ­¤æ—¶å­—æ®µåå°±ä¼šè½¬æ¢ä¸ºuserName</p><hr><h3 id="å¤šå¯¹ä¸€æ˜ å°„å¤„ç†">å¤šå¯¹ä¸€æ˜ å°„å¤„ç†</h3><p>è¡¨å’Œè¡¨æ˜¯å­˜åœ¨å…³ç³»çš„ï¼Œé‚£ä¹ˆå¯¹åº”çš„å®ä½“ç±»ä¹Ÿæ˜¯å­˜åœ¨å…³ç³»çš„ã€‚</p><p>æŸ¥è¯¢å‘˜å·¥ä¿¡æ¯ä»¥åŠå‘˜å·¥æ‰€å¯¹åº”çš„éƒ¨é—¨ä¿¡æ¯</p><p>å…ˆåœ¨å‘˜å·¥ç±»ä¸­æ·»åŠ deptæˆå‘˜å˜é‡ã€‚</p><div class="tabs" id="50cb64ca-1de1-474a-82fc-ee3111c8ccd9"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#50cb64ca-1de1-474a-82fc-ee3111c8ccd9-1"><i class="fas fa-cat"></i>çº§è”æ–¹å¼å¤„ç†æ˜ å°„å…³ç³»</button></li><li class="tab"><button type="button" data-href="#50cb64ca-1de1-474a-82fc-ee3111c8ccd9-2"><i class="fas fa-horse"></i>associationå¤„ç†æ˜ å°„å…³ç³»</button></li><li class="tab"><button type="button" data-href="#50cb64ca-1de1-474a-82fc-ee3111c8ccd9-3"><i class="fas fa-dove"></i>åˆ†æ­¥æŸ¥è¯¢</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="50cb64ca-1de1-474a-82fc-ee3111c8ccd9-1"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;empDeptMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Emp&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;eid&quot;</span> <span class="attr">property</span>=<span class="string">&quot;eid&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;ename&quot;</span> <span class="attr">property</span>=<span class="string">&quot;ename&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;age&quot;</span> <span class="attr">property</span>=<span class="string">&quot;age&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;sex&quot;</span> <span class="attr">property</span>=<span class="string">&quot;sex&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;did&quot;</span> <span class="attr">property</span>=<span class="string">&quot;dept.did&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;dname&quot;</span> <span class="attr">property</span>=<span class="string">&quot;dept.dname&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Emp getEmpAndDeptByEid(@Param(&quot;eid&quot;) int eid);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getEmpAndDeptByEid&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;empDeptMap&quot;</span>&gt;</span></span><br><span class="line">    select emp.*,dept.* from t_emp emp left join t_dept dept on emp.did =</span><br><span class="line">                                                                dept.did where emp.eid = #&#123;eid&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="50cb64ca-1de1-474a-82fc-ee3111c8ccd9-2"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;empDeptMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Emp&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;eid&quot;</span> <span class="attr">property</span>=<span class="string">&quot;eid&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;ename&quot;</span> <span class="attr">property</span>=<span class="string">&quot;ename&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;age&quot;</span> <span class="attr">property</span>=<span class="string">&quot;age&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;sex&quot;</span> <span class="attr">property</span>=<span class="string">&quot;sex&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">&quot;dept&quot;</span> <span class="attr">javaType</span>=<span class="string">&quot;Dept&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;did&quot;</span> <span class="attr">property</span>=<span class="string">&quot;did&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;dname&quot;</span> <span class="attr">property</span>=<span class="string">&quot;dname&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">association</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Emp getEmpAndDeptByEid(@Param(&quot;eid&quot;) int eid);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getEmpAndDeptByEid&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;empDeptMap&quot;</span>&gt;</span></span><br><span class="line">    select emp.*,dept.* from t_emp emp left join t_dept dept on emp.did =</span><br><span class="line">                                                                dept.did where emp.eid = #&#123;eid&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="50cb64ca-1de1-474a-82fc-ee3111c8ccd9-3"><p>1ï¼‰æŸ¥è¯¢å‘˜å·¥ä¿¡æ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* é€šè¿‡åˆ†æ­¥æŸ¥è¯¢æŸ¥è¯¢å‘˜å·¥ä¿¡æ¯</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> eid</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">Emp <span class="title function_">getEmpByStep</span><span class="params">(<span class="meta">@Param(&quot;eid&quot;)</span> <span class="type">int</span> eid)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;empDeptStepMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Emp&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;eid&quot;</span> <span class="attr">property</span>=<span class="string">&quot;eid&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;ename&quot;</span> <span class="attr">property</span>=<span class="string">&quot;ename&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;age&quot;</span> <span class="attr">property</span>=<span class="string">&quot;age&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;sex&quot;</span> <span class="attr">property</span>=<span class="string">&quot;sex&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        selectï¼šè®¾ç½®åˆ†æ­¥æŸ¥è¯¢ï¼ŒæŸ¥è¯¢æŸä¸ªå±æ€§çš„å€¼çš„sqlçš„æ ‡è¯†ï¼ˆnamespace.sqlIdï¼‰</span></span><br><span class="line"><span class="comment">        columnï¼šå°†sqlä»¥åŠæŸ¥è¯¢ç»“æœä¸­çš„æŸä¸ªå­—æ®µè®¾ç½®ä¸ºåˆ†æ­¥æŸ¥è¯¢çš„æ¡ä»¶</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">&quot;dept&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">select</span>=<span class="string">&quot;com.atguigu.MyBatis.mapper.DeptMapper.getEmpDeptByStep&quot;</span> <span class="attr">column</span>=<span class="string">&quot;did&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">association</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Emp getEmpByStep(@Param(&quot;eid&quot;) int eid);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getEmpByStep&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;empDeptStepMap&quot;</span>&gt;</span></span><br><span class="line">    select * from t_emp where eid = #&#123;eid&#125;</span><br><span class="line"> <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2ï¼‰æ ¹æ®å‘˜å·¥æ‰€å¯¹åº”çš„éƒ¨é—¨idæŸ¥è¯¢éƒ¨é—¨ä¿¡æ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* åˆ†æ­¥æŸ¥è¯¢çš„ç¬¬äºŒæ­¥ï¼šæ ¹æ®å‘˜å·¥æ‰€å¯¹åº”çš„didæŸ¥è¯¢éƒ¨é—¨ä¿¡æ¯</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> did</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">Dept <span class="title function_">getEmpDeptByStep</span><span class="params">(<span class="meta">@Param(&quot;did&quot;)</span> <span class="type">int</span> did)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Dept getEmpDeptByStep(@Param(&quot;did&quot;) int did);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getEmpDeptByStep&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Dept&quot;</span>&gt;</span></span><br><span class="line">    select * from t_dept where did = #&#123;did&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="ä¸€å¯¹å¤šæ˜ å°„å¤„ç†">ä¸€å¯¹å¤šæ˜ å°„å¤„ç†</h3><p>ç°åœ¨deptç±»ä¸­æ·»åŠ <code>List&lt;Emp&gt; list</code>æˆå‘˜å˜é‡</p><div class="tabs" id="6ac153d5-2917-47eb-97e8-32bcdd9d9ea8"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6ac153d5-2917-47eb-97e8-32bcdd9d9ea8-1"><i class="fas fa-award"></i>collection</button></li><li class="tab"><button type="button" data-href="#6ac153d5-2917-47eb-97e8-32bcdd9d9ea8-2"><i class="fas fa-baseball-ball"></i>åˆ†æ­¥æŸ¥è¯¢</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6ac153d5-2917-47eb-97e8-32bcdd9d9ea8-1"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    * æ ¹æ®éƒ¨é—¨idæŸ¥æ–°éƒ¨é—¨ä»¥åŠéƒ¨é—¨ä¸­çš„å‘˜å·¥ä¿¡æ¯</span></span><br><span class="line"><span class="comment">    * @param did</span></span><br><span class="line"><span class="comment">    * @return</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    Dept getDeptEmpByDid(@Param(&quot;did&quot;) int did);</span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;deptEmpMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Dept&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;did&quot;</span> <span class="attr">column</span>=<span class="string">&quot;did&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;dname&quot;</span> <span class="attr">column</span>=<span class="string">&quot;dname&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        ofTypeï¼šè®¾ç½®collectionæ ‡ç­¾æ‰€å¤„ç†çš„é›†åˆå±æ€§ä¸­å­˜å‚¨æ•°æ®çš„ç±»å‹</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;emps&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;Emp&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;eid&quot;</span> <span class="attr">column</span>=<span class="string">&quot;eid&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;ename&quot;</span> <span class="attr">column</span>=<span class="string">&quot;ename&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;age&quot;</span> <span class="attr">column</span>=<span class="string">&quot;age&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;sex&quot;</span> <span class="attr">column</span>=<span class="string">&quot;sex&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Dept getDeptEmpByDid(@Param(&quot;did&quot;) int did);--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getDeptEmpByDid&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;deptEmpMap&quot;</span>&gt;</span></span><br><span class="line">        select dept.*,emp.* from t_dept dept left join t_emp emp on dept.did =</span><br><span class="line">                                                              emp.did where dept.did = #&#123;did&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6ac153d5-2917-47eb-97e8-32bcdd9d9ea8-2"><p>1ï¼‰æŸ¥è¯¢éƒ¨é—¨ä¿¡æ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* åˆ†æ­¥æŸ¥è¯¢éƒ¨é—¨å’Œéƒ¨é—¨ä¸­çš„å‘˜å·¥</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> did</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">Dept <span class="title function_">getDeptByStep</span><span class="params">(<span class="meta">@Param(&quot;did&quot;)</span> <span class="type">int</span> did)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;deptEmpStep&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Dept&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;did&quot;</span> <span class="attr">column</span>=<span class="string">&quot;did&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;dname&quot;</span> <span class="attr">column</span>=<span class="string">&quot;dname&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;emps&quot;</span> <span class="attr">fetchType</span>=<span class="string">&quot;eager&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">select</span>=<span class="string">&quot;com.atguigu.MyBatis.mapper.EmpMapper.getEmpListByDid&quot;</span> <span class="attr">column</span>=<span class="string">&quot;did&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Dept getDeptByStep(@Param(&quot;did&quot;) int did);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getDeptByStep&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;deptEmpStep&quot;</span>&gt;</span></span><br><span class="line">    select * from t_dept where did = #&#123;did&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2ï¼‰æ ¹æ®éƒ¨é—¨idæŸ¥è¯¢éƒ¨é—¨ä¸­çš„æ‰€æœ‰å‘˜å·¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* æ ¹æ®éƒ¨é—¨idæŸ¥è¯¢å‘˜å·¥ä¿¡æ¯</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> did</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">List&lt;Emp&gt; <span class="title function_">getEmpListByDid</span><span class="params">(<span class="meta">@Param(&quot;did&quot;)</span> <span class="type">int</span> did)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--List&lt;Emp&gt; getEmpListByDid(@Param(&quot;did&quot;) int did);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getEmpListByDid&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Emp&quot;</span>&gt;</span></span><br><span class="line">    select * from t_emp where did = #&#123;did&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åˆ†æ­¥æŸ¥è¯¢çš„ä¼˜ç‚¹ï¼šå¯ä»¥å®ç°å»¶è¿ŸåŠ è½½ï¼Œä½†æ˜¯å¿…é¡»åœ¨æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸­è®¾ç½®å…¨å±€é…ç½®ä¿¡æ¯ï¼š</p><p>lazyLoadingEnabledï¼šå»¶è¿ŸåŠ è½½çš„å…¨å±€å¼€å…³ã€‚å½“å¼€å¯æ—¶ï¼Œæ‰€æœ‰å…³è”å¯¹è±¡éƒ½ä¼šå»¶è¿ŸåŠ è½½</p><p>aggressiveLazyLoadingï¼šå½“å¼€å¯æ—¶ï¼Œä»»ä½•æ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šåŠ è½½è¯¥å¯¹è±¡çš„æ‰€æœ‰å±æ€§ã€‚ å¦åˆ™ï¼Œæ¯ä¸ªå±æ€§ä¼šæŒ‰éœ€åŠ è½½æ­¤æ—¶å°±å¯ä»¥å®ç°æŒ‰éœ€åŠ è½½ï¼Œè·å–çš„æ•°æ®æ˜¯ä»€ä¹ˆï¼Œå°±åªä¼šæ‰§è¡Œç›¸åº”çš„sqlã€‚</p><p>æ­¤æ—¶å¯é€šè¿‡associationå’Œcollectionä¸­çš„fetchTypeå±æ€§è®¾ç½®å½“å‰çš„åˆ†æ­¥æŸ¥è¯¢æ˜¯å¦ä½¿ç”¨å»¶è¿ŸåŠ è½½ï¼ŒfetchType=â€œlazy(å»¶è¿ŸåŠ è½½)|eager(ç«‹å³åŠ è½½)â€</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><hr><h2 id="åŠ¨æ€SQL">åŠ¨æ€SQL</h2><p>Mybatisæ¡†æ¶çš„åŠ¨æ€SQLæŠ€æœ¯æ˜¯ä¸€ç§æ ¹æ®ç‰¹å®šæ¡ä»¶åŠ¨æ€æ‹¼è£…SQLè¯­å¥çš„åŠŸèƒ½ï¼Œå®ƒå­˜åœ¨çš„æ„ä¹‰æ˜¯ä¸ºäº†è§£å†³æ‹¼æ¥SQLè¯­å¥å­—ç¬¦ä¸²æ—¶çš„ç—›ç‚¹é—®é¢˜ã€‚</p><div class="tabs" id="5e89583b-2796-482c-a04f-c19391cfd02c"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#5e89583b-2796-482c-a04f-c19391cfd02c-1"><i class="fas fa-seedling"></i>if</button></li><li class="tab"><button type="button" data-href="#5e89583b-2796-482c-a04f-c19391cfd02c-2"><i class="fas fa-leaf"></i>where</button></li><li class="tab"><button type="button" data-href="#5e89583b-2796-482c-a04f-c19391cfd02c-3"><i class="fab fa-apple"></i>trim</button></li><li class="tab"><button type="button" data-href="#5e89583b-2796-482c-a04f-c19391cfd02c-4"><i class="fas fa-tree"></i>foreach</button></li><li class="tab"><button type="button" data-href="#5e89583b-2796-482c-a04f-c19391cfd02c-5"><i class="fas fa-heartbeat"></i>SQLç‰‡æ®µ</button></li><li class="tab"><button type="button" data-href="#5e89583b-2796-482c-a04f-c19391cfd02c-6"><i class="fas fa-cookie-bite"></i>chooseã€whenã€otherwise</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="5e89583b-2796-482c-a04f-c19391cfd02c-1"><p>ifæ ‡ç­¾å¯é€šè¿‡testå±æ€§çš„è¡¨è¾¾å¼è¿›è¡Œåˆ¤æ–­ï¼Œè‹¥è¡¨è¾¾å¼çš„ç»“æœä¸ºtrueï¼Œåˆ™æ ‡ç­¾ä¸­çš„å†…å®¹ä¼šæ‰§è¡Œï¼›åä¹‹æ ‡ç­¾ä¸­çš„å†…å®¹ä¸ä¼šæ‰§è¡Œ</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--List&lt;Emp&gt; getEmpListByMoreTJ(Emp emp);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getEmpListByMoreTJ&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Emp&quot;</span>&gt;</span></span><br><span class="line">    select * from t_emp where 1=1</span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;ename != &#x27;&#x27; and ename != null&quot;</span>&gt;</span></span><br><span class="line">        and ename = #&#123;ename&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;age != &#x27;&#x27; and age != null&quot;</span>&gt;</span></span><br><span class="line">        and age = #&#123;age&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;sex != &#x27;&#x27; and sex != null&quot;</span>&gt;</span></span><br><span class="line">        and sex = #&#123;sex&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5e89583b-2796-482c-a04f-c19391cfd02c-2"><p>whereå’Œifä¸€èˆ¬ç»“åˆä½¿ç”¨ï¼š</p><p>è‹¥whereæ ‡ç­¾ä¸­çš„ifæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œåˆ™whereæ ‡ç­¾æ²¡æœ‰ä»»ä½•åŠŸèƒ½ï¼Œå³ä¸ä¼šæ·»åŠ whereå…³é”®å­—</p><p>è‹¥whereæ ‡ç­¾ä¸­çš„ifæ¡ä»¶æ»¡è¶³ï¼Œåˆ™whereæ ‡ç­¾ä¼šè‡ªåŠ¨æ·»åŠ whereå…³é”®å­—ï¼Œå¹¶å°†æ¡ä»¶æœ€å‰æ–¹å¤šä½™çš„andå»æ‰</p><p>æ³¨æ„ï¼šwhereæ ‡ç­¾ä¸èƒ½å°†å…¶ä¸­å†…å®¹åé¢å¤šä½™çš„andæˆ–orå»æ‰</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getEmpListByMoreTJ2&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Emp&quot;</span>&gt;</span></span><br><span class="line">    select * from t_emp</span><br><span class="line">    <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;ename != &#x27;&#x27; and ename != null&quot;</span>&gt;</span></span><br><span class="line">            ename = #&#123;ename&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;age != &#x27;&#x27; and age != null&quot;</span>&gt;</span></span><br><span class="line">            and age = #&#123;age&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;sex != &#x27;&#x27; and sex != null&quot;</span>&gt;</span></span><br><span class="line">            and sex = #&#123;sex&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5e89583b-2796-482c-a04f-c19391cfd02c-3"><p>trimç”¨äºå»æ‰æˆ–æ·»åŠ æ ‡ç­¾ä¸­çš„å†…å®¹</p><p>å¸¸ç”¨å±æ€§ï¼š</p><p>prefixï¼šåœ¨trimæ ‡ç­¾ä¸­çš„å†…å®¹çš„å‰é¢æ·»åŠ æŸäº›å†…å®¹</p><p>prefixOverridesï¼šåœ¨trimæ ‡ç­¾ä¸­çš„å†…å®¹çš„å‰é¢å»æ‰æŸäº›å†…å®¹</p><p>suffixï¼šåœ¨trimæ ‡ç­¾ä¸­çš„å†…å®¹çš„åé¢æ·»åŠ æŸäº›å†…å®¹</p><p>suffixOverridesï¼šåœ¨trimæ ‡ç­¾ä¸­çš„å†…å®¹çš„åé¢å»æ‰æŸäº›å†…å®¹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getEmpListByMoreTJ&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Emp&quot;</span>&gt;</span></span><br><span class="line">    select * from t_emp</span><br><span class="line">    <span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">&quot;where&quot;</span> <span class="attr">suffixOverrides</span>=<span class="string">&quot;and&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;ename != &#x27;&#x27; and ename != null&quot;</span>&gt;</span></span><br><span class="line">            ename = #&#123;ename&#125; and</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;age != &#x27;&#x27; and age != null&quot;</span>&gt;</span></span><br><span class="line">            age = #&#123;age&#125; and</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;sex != &#x27;&#x27; and sex != null&quot;</span>&gt;</span></span><br><span class="line">            sex = #&#123;sex&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5e89583b-2796-482c-a04f-c19391cfd02c-4"><p>å±æ€§ï¼š</p><p>collectionï¼šè®¾ç½®è¦å¾ªç¯çš„æ•°ç»„æˆ–é›†åˆ</p><p>itemï¼šè¡¨ç¤ºé›†åˆæˆ–æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªæ•°æ®s</p><p>eparatorï¼šè®¾ç½®å¾ªç¯ä½“ä¹‹é—´çš„åˆ†éš”ç¬¦</p><p>openï¼šè®¾ç½®foreachæ ‡ç­¾ä¸­çš„å†…å®¹çš„å¼€å§‹ç¬¦</p><p>closeï¼šè®¾ç½®foreachæ ‡ç­¾ä¸­çš„å†…å®¹çš„ç»“æŸç¬¦</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--int insertMoreEmp(List&lt;Emp&gt; emps);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertMoreEmp&quot;</span>&gt;</span></span><br><span class="line">    insert into t_emp values</span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;emps&quot;</span> <span class="attr">item</span>=<span class="string">&quot;emp&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span><br><span class="line">        (null,#&#123;emp.ename&#125;,#&#123;emp.age&#125;,#&#123;emp.sex&#125;,#&#123;emp.email&#125;,null)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--int deleteMoreByArray(int[] eids);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteMoreByArray&quot;</span>&gt;</span></span><br><span class="line">    delete from t_emp where</span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;eids&quot;</span> <span class="attr">item</span>=<span class="string">&quot;eid&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;or&quot;</span>&gt;</span></span><br><span class="line">        eid = #&#123;eid&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--int deleteMoreByArray(int[] eids);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteMoreByArray&quot;</span>&gt;</span></span><br><span class="line">    delete from t_emp where eid in</span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;eids&quot;</span> <span class="attr">item</span>=<span class="string">&quot;eid&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span>&gt;</span></span><br><span class="line">        #&#123;eid&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5e89583b-2796-482c-a04f-c19391cfd02c-5"><p>sqlç‰‡æ®µï¼Œå¯ä»¥è®°å½•ä¸€æ®µå…¬å…±sqlç‰‡æ®µï¼Œåœ¨ä½¿ç”¨çš„åœ°æ–¹é€šè¿‡includeæ ‡ç­¾è¿›è¡Œå¼•å…¥</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;empColumns&quot;</span>&gt;</span></span><br><span class="line">    eid,ename,age,sex,did</span><br><span class="line"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line">select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;empColumns&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span> from t_emp</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5e89583b-2796-482c-a04f-c19391cfd02c-6"><p>chooseã€whenã€otherwiseç›¸å½“äºifâ€¦else ifâ€¦else</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--List&lt;Emp&gt; getEmpListByChoose(Emp emp);--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getEmpListByChoose&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Emp&quot;</span>&gt;</span></span><br><span class="line">    select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;empColumns&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span> from t_emp</span><br><span class="line">    <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">choose</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">&quot;ename != &#x27;&#x27; and ename != null&quot;</span>&gt;</span></span><br><span class="line">                ename = #&#123;ename&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">when</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">&quot;age != &#x27;&#x27; and age != null&quot;</span>&gt;</span></span><br><span class="line">                age = #&#123;age&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">when</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">&quot;sex != &#x27;&#x27; and sex != null&quot;</span>&gt;</span></span><br><span class="line">                sex = #&#123;sex&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">when</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">&quot;email != &#x27;&#x27; and email != null&quot;</span>&gt;</span></span><br><span class="line">                email = #&#123;email&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">when</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">choose</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="MyBatisç¼“å­˜">MyBatisç¼“å­˜</h2><h3 id="ä¸€çº§ç¼“å­˜">ä¸€çº§ç¼“å­˜</h3><p>ä¸€çº§ç¼“å­˜æ˜¯é»˜è®¤å¼€å¯çš„ã€‚</p><p>ä¸€çº§ç¼“å­˜æ˜¯SqlSessionçº§åˆ«çš„ï¼Œé€šè¿‡åŒä¸€ä¸ªSqlSessionæŸ¥è¯¢çš„æ•°æ®ä¼šè¢«ç¼“å­˜ï¼Œä¸‹æ¬¡æŸ¥è¯¢ç›¸åŒçš„æ•°æ®ï¼Œå°±ä¼šä»ç¼“å­˜ä¸­ç›´æ¥è·å–ï¼Œä¸ä¼šä»æ•°æ®åº“é‡æ–°è®¿é—®ã€‚</p><p>ä½¿ä¸€çº§ç¼“å­˜å¤±æ•ˆçš„å››ç§æƒ…å†µï¼š</p><ol><li>ä¸åŒçš„SqlSessionå¯¹åº”ä¸åŒçš„ä¸€çº§ç¼“å­˜</li><li>åŒä¸€ä¸ªSqlSessionä½†æ˜¯æŸ¥è¯¢æ¡ä»¶ä¸åŒ</li><li>åŒä¸€ä¸ªSqlSessionä¸¤æ¬¡æŸ¥è¯¢æœŸé—´æ‰§è¡Œäº†ä»»ä½•ä¸€æ¬¡å¢åˆ æ”¹æ“ä½œ</li><li>åŒä¸€ä¸ªSqlSessionä¸¤æ¬¡æŸ¥è¯¢æœŸé—´æ‰‹åŠ¨æ¸…ç©ºäº†ç¼“å­˜</li></ol><hr><h3 id="äºŒçº§ç¼“å­˜">äºŒçº§ç¼“å­˜</h3><p>äºŒçº§ç¼“å­˜æ˜¯SqlSessionFactoryçº§åˆ«ï¼Œé€šè¿‡åŒä¸€ä¸ªSqlSessionFactoryåˆ›å»ºçš„SqlSessionæŸ¥è¯¢çš„ç»“æœä¼šè¢«ç¼“å­˜ï¼›æ­¤åè‹¥å†æ¬¡æ‰§è¡Œç›¸åŒçš„æŸ¥è¯¢è¯­å¥ï¼Œç»“æœå°±ä¼šä»ç¼“å­˜ä¸­è·å–ã€‚</p><p>äºŒçº§ç¼“å­˜å¼€å¯çš„æ¡ä»¶ï¼š</p><ol><li>åœ¨æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸­ï¼Œè®¾ç½®å…¨å±€é…ç½®å±æ€§cacheEnabled=â€œtrueâ€ï¼Œé»˜è®¤ä¸ºtrueï¼Œä¸éœ€è¦è®¾ç½®</li><li>åœ¨æ˜ å°„æ–‡ä»¶ä¸­è®¾ç½®æ ‡ç­¾<code>&lt;cache /&gt;</code></li><li>äºŒçº§ç¼“å­˜å¿…é¡»åœ¨SqlSessionå…³é—­æˆ–æäº¤ä¹‹åæœ‰æ•ˆ</li><li>æŸ¥è¯¢çš„æ•°æ®æ‰€è½¬æ¢çš„å®ä½“ç±»ç±»å‹å¿…é¡»å®ç°åºåˆ—åŒ–çš„æ¥å£</li></ol><p>ä½¿äºŒçº§ç¼“å­˜å¤±æ•ˆçš„æƒ…å†µï¼šä¸¤æ¬¡æŸ¥è¯¢ä¹‹é—´æ‰§è¡Œäº†ä»»æ„çš„å¢åˆ æ”¹ï¼Œä¼šä½¿ä¸€çº§å’ŒäºŒçº§ç¼“å­˜åŒæ—¶å¤±æ•ˆ</p><blockquote><p>äºŒçº§ç¼“å­˜çš„ç›¸å…³é…ç½®</p></blockquote><p>åœ¨mapperé…ç½®æ–‡ä»¶ä¸­æ·»åŠ çš„cacheæ ‡ç­¾å¯ä»¥è®¾ç½®ä¸€äº›å±æ€§ï¼š</p><ul><li><p>evictionå±æ€§ï¼šç¼“å­˜å›æ”¶ç­–ç•¥</p><p>LRUï¼ˆLeast Recently Usedï¼‰ â€“ æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ï¼šç§»é™¤æœ€é•¿æ—¶é—´ä¸è¢«ä½¿ç”¨çš„å¯¹è±¡ã€‚</p><p>FIFOï¼ˆFirst in First outï¼‰ â€“ å…ˆè¿›å…ˆå‡ºï¼šæŒ‰å¯¹è±¡è¿›å…¥ç¼“å­˜çš„é¡ºåºæ¥ç§»é™¤å®ƒä»¬ã€‚</p><p>SOFT â€“ è½¯å¼•ç”¨ï¼šç§»é™¤åŸºäºåƒåœ¾å›æ”¶å™¨çŠ¶æ€å’Œè½¯å¼•ç”¨è§„åˆ™çš„å¯¹è±¡ã€‚</p><p>WEAK â€“ å¼±å¼•ç”¨ï¼šæ›´ç§¯æåœ°ç§»é™¤åŸºäºåƒåœ¾æ”¶é›†å™¨çŠ¶æ€å’Œå¼±å¼•ç”¨è§„åˆ™çš„å¯¹è±¡ã€‚é»˜è®¤çš„æ˜¯ LRUã€‚</p></li><li><p>flushIntervalå±æ€§ï¼šåˆ·æ–°é—´éš”ï¼Œå•ä½æ¯«ç§’</p><p>é»˜è®¤æƒ…å†µæ˜¯ä¸è®¾ç½®ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰åˆ·æ–°é—´éš”ï¼Œç¼“å­˜ä»…ä»…è°ƒç”¨è¯­å¥æ—¶åˆ·æ–°</p></li><li><p>sizeå±æ€§ï¼šå¼•ç”¨æ•°ç›®ï¼Œæ­£æ•´æ•°</p><p>ä»£è¡¨ç¼“å­˜æœ€å¤šå¯ä»¥å­˜å‚¨å¤šå°‘ä¸ªå¯¹è±¡ï¼Œå¤ªå¤§å®¹æ˜“å¯¼è‡´å†…å­˜æº¢å‡º</p></li><li><p>readOnlyå±æ€§ï¼šåªè¯»ï¼Œtrue/false</p><p>trueï¼šåªè¯»ç¼“å­˜ï¼›ä¼šç»™æ‰€æœ‰è°ƒç”¨è€…è¿”å›ç¼“å­˜å¯¹è±¡çš„ç›¸åŒå®ä¾‹ã€‚å› æ­¤è¿™äº›å¯¹è±¡ä¸èƒ½è¢«ä¿®æ”¹ã€‚è¿™æä¾›äº†å¾ˆé‡è¦çš„æ€§èƒ½ä¼˜åŠ¿ã€‚</p><p>falseï¼šè¯»å†™ç¼“å­˜ï¼›ä¼šè¿”å›ç¼“å­˜å¯¹è±¡çš„æ‹·è´ï¼ˆé€šè¿‡åºåˆ—åŒ–ï¼‰ã€‚è¿™ä¼šæ…¢ä¸€äº›ï¼Œä½†æ˜¯å®‰å…¨ï¼Œå› æ­¤é»˜è®¤æ˜¯falseã€‚</p></li></ul><hr><h3 id="ç¼“å­˜æŸ¥è¯¢é¡ºåº">ç¼“å­˜æŸ¥è¯¢é¡ºåº</h3><ul><li>å…ˆæŸ¥è¯¢äºŒçº§ç¼“å­˜ï¼Œå› ä¸ºäºŒçº§ç¼“å­˜ä¸­å¯èƒ½ä¼šæœ‰å…¶ä»–ç¨‹åºå·²ç»æŸ¥å‡ºæ¥çš„æ•°æ®ï¼Œå¯ä»¥æ‹¿æ¥ç›´æ¥ä½¿ç”¨ã€‚</li><li>å¦‚æœäºŒçº§ç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œå†æŸ¥è¯¢ä¸€çº§ç¼“å­˜</li><li>å¦‚æœä¸€çº§ç¼“å­˜ä¹Ÿæ²¡æœ‰å‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“</li><li>SqlSessionå…³é—­ä¹‹åï¼Œä¸€çº§ç¼“å­˜ä¸­çš„æ•°æ®ä¼šå†™å…¥äºŒçº§ç¼“å­˜</li></ul><hr><h3 id="æ•´åˆEHCache">æ•´åˆEHCache</h3><div class="tabs" id="b0ff2a19-b6cd-4cca-9fae-871cdee52976"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#b0ff2a19-b6cd-4cca-9fae-871cdee52976-1"><i class="fas fa-cat"></i>æ·»åŠ ä¾èµ–</button></li><li class="tab"><button type="button" data-href="#b0ff2a19-b6cd-4cca-9fae-871cdee52976-2"><i class="fas fa-horse"></i>é…ç½®æ–‡ä»¶</button></li><li class="tab"><button type="button" data-href="#b0ff2a19-b6cd-4cca-9fae-871cdee52976-3"><i class="fas fa-dragon"></i>é…ç½®æ–‡ä»¶è¯´æ˜</button></li><li class="tab"><button type="button" data-href="#b0ff2a19-b6cd-4cca-9fae-871cdee52976-4"><i class="fas fa-dove"></i>åŠ å…¥logbackæ—¥å¿—</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="b0ff2a19-b6cd-4cca-9fae-871cdee52976-1"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Mybatis EHCacheæ•´åˆåŒ… --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.caches<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-ehcache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- slf4jæ—¥å¿—é—¨é¢çš„ä¸€ä¸ªå…·ä½“å®ç° --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å„jaråŒ…åŠŸèƒ½</p><table><thead><tr><th>jaråŒ…åç§°</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>mybatis-ehcache</td><td>Mybatiså’ŒEHCacheçš„æ•´åˆåŒ…</td></tr><tr><td>ehcache</td><td>EHCacheæ ¸å¿ƒåŒ…</td></tr><tr><td>slf4j-api</td><td>SLF4Jæ—¥å¿—é—¨é¢åŒ…</td></tr><tr><td>logback-classic</td><td>æ”¯æŒSLF4Jé—¨é¢æ¥å£çš„ä¸€ä¸ªå…·ä½“å®ç°</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b0ff2a19-b6cd-4cca-9fae-871cdee52976-2"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ehcache</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">&quot;../config/ehcache.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ç£ç›˜ä¿å­˜è·¯å¾„ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">diskStore</span> <span class="attr">path</span>=<span class="string">&quot;D:\atguigu\ehcache&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">defaultCache</span></span></span><br><span class="line"><span class="tag">        <span class="attr">maxElementsInMemory</span>=<span class="string">&quot;1000&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">maxElementsOnDisk</span>=<span class="string">&quot;10000000&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">eternal</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">overflowToDisk</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">timeToIdleSeconds</span>=<span class="string">&quot;120&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">timeToLiveSeconds</span>=<span class="string">&quot;120&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">diskExpiryThreadIntervalSeconds</span>=<span class="string">&quot;120&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">memoryStoreEvictionPolicy</span>=<span class="string">&quot;LRU&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">defaultCache</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ehcache</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è®¾ç½®äºŒçº§ç¼“å­˜çš„ç±»å‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache</span> <span class="attr">type</span>=<span class="string">&quot;org.mybatis.caches.ehcache.EhcacheCache&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b0ff2a19-b6cd-4cca-9fae-871cdee52976-3"><table><thead><tr><th style="text-align:left">å±æ€§å</th><th>æ˜¯å¦å¿…é¡»</th><th style="text-align:left">ä½œç”¨</th></tr></thead><tbody><tr><td style="text-align:left">maxElementsInMemory</td><td>æ˜¯</td><td style="text-align:left">åœ¨å†…å­˜ä¸­ç¼“å­˜çš„elementçš„æœ€å¤§æ•°ç›®</td></tr><tr><td style="text-align:left">maxElementsOnDisk</td><td>æ˜¯</td><td style="text-align:left">åœ¨ç£ç›˜ä¸Šç¼“å­˜çš„elementçš„æœ€å¤§æ•°ç›®ï¼Œè‹¥æ˜¯0è¡¨ç¤ºæ— ç©·å¤§</td></tr><tr><td style="text-align:left">eternal</td><td>æ˜¯</td><td style="text-align:left">è®¾å®šç¼“å­˜çš„elementsæ˜¯å¦æ°¸è¿œä¸è¿‡æœŸã€‚ å¦‚æœä¸ºtrueï¼Œåˆ™ç¼“å­˜çš„æ•°æ®å§‹ç»ˆæœ‰æ•ˆï¼Œ å¦‚æœä¸ºfalseé‚£ä¹ˆè¿˜è¦æ ¹æ®timeToIdleSecondsã€timeToLiveSecondsåˆ¤æ–­</td></tr><tr><td style="text-align:left">overflowToDisk</td><td>æ˜¯</td><td style="text-align:left">è®¾å®šå½“å†…å­˜ç¼“å­˜æº¢å‡ºçš„æ—¶å€™æ˜¯å¦å°†è¿‡æœŸçš„elementç¼“å­˜åˆ°ç£ç›˜ä¸Š</td></tr><tr><td style="text-align:left">timeToIdleSeconds</td><td>å¦</td><td style="text-align:left">å½“ç¼“å­˜åœ¨EhCacheä¸­çš„æ•°æ®å‰åä¸¤æ¬¡è®¿é—®çš„æ—¶é—´è¶…è¿‡timeToIdleSecondsçš„å±æ€§å–å€¼æ—¶ï¼Œ è¿™äº›æ•°æ®ä¾¿ä¼šåˆ é™¤ï¼Œé»˜è®¤å€¼æ˜¯0,ä¹Ÿå°±æ˜¯å¯é—²ç½®æ—¶é—´æ— ç©·å¤§</td></tr><tr><td style="text-align:left">timeToLiveSeconds</td><td>å¦</td><td style="text-align:left">ç¼“å­˜elementçš„æœ‰æ•ˆç”Ÿå‘½æœŸï¼Œé»˜è®¤æ˜¯0.,ä¹Ÿå°±æ˜¯elementå­˜æ´»æ—¶é—´æ— ç©·å¤§</td></tr><tr><td style="text-align:left">diskSpoolBufferSizeMB</td><td>å¦</td><td style="text-align:left">DiskStore(ç£ç›˜ç¼“å­˜)çš„ç¼“å­˜åŒºå¤§å°ã€‚é»˜è®¤æ˜¯30MBã€‚æ¯ä¸ªCacheéƒ½åº”è¯¥æœ‰è‡ªå·±çš„ä¸€ä¸ªç¼“å†²åŒº</td></tr><tr><td style="text-align:left">diskPersistent</td><td>å¦</td><td style="text-align:left">åœ¨VMé‡å¯çš„æ—¶å€™æ˜¯å¦å¯ç”¨ç£ç›˜ä¿å­˜EhCacheä¸­çš„æ•°æ®ï¼Œé»˜è®¤æ˜¯falseã€‚</td></tr><tr><td style="text-align:left">diskExpiryThreadIntervalSeconds</td><td>å¦</td><td style="text-align:left">ç£ç›˜ç¼“å­˜çš„æ¸…ç†çº¿ç¨‹è¿è¡Œé—´éš”ï¼Œé»˜è®¤æ˜¯120ç§’ã€‚æ¯ä¸ª120sï¼Œ ç›¸åº”çš„çº¿ç¨‹ä¼šè¿›è¡Œä¸€æ¬¡EhCacheä¸­æ•°æ®çš„æ¸…ç†å·¥ä½œ</td></tr><tr><td style="text-align:left">memoryStoreEvictionPolicy</td><td>å¦</td><td style="text-align:left">å½“å†…å­˜ç¼“å­˜è¾¾åˆ°æœ€å¤§ï¼Œæœ‰æ–°çš„elementåŠ å…¥çš„æ—¶å€™ï¼Œ ç§»é™¤ç¼“å­˜ä¸­elementçš„ç­–ç•¥ã€‚ é»˜è®¤æ˜¯LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ï¼Œå¯é€‰çš„æœ‰LFUï¼ˆæœ€ä¸å¸¸ä½¿ç”¨ï¼‰å’ŒFIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b0ff2a19-b6cd-4cca-9fae-871cdee52976-4"><p>å­˜åœ¨SLF4Jæ—¶ï¼Œä½œä¸ºç®€æ˜“æ—¥å¿—çš„log4jå°†å¤±æ•ˆï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦å€ŸåŠ©SLF4Jçš„å…·ä½“å®ç°logbackæ¥æ‰“å°æ—¥å¿—ã€‚åˆ›å»ºlogbackçš„é…ç½®æ–‡ä»¶logback.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">debug</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- æŒ‡å®šæ—¥å¿—è¾“å‡ºçš„ä½ç½® --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- æ—¥å¿—è¾“å‡ºçš„æ ¼å¼ --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- æŒ‰ç…§é¡ºåºåˆ†åˆ«æ˜¯ï¼šæ—¶é—´ã€æ—¥å¿—çº§åˆ«ã€çº¿ç¨‹åç§°ã€æ‰“å°æ—¥å¿—çš„ç±»ã€æ—¥å¿—ä¸»ä½“å†…å®¹ã€æ¢è¡Œ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>[%d&#123;HH:mm:ss.SSS&#125;] [%-5level] [%thread] [%logger] [%msg]%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- è®¾ç½®å…¨å±€æ—¥å¿—çº§åˆ«ã€‚æ—¥å¿—çº§åˆ«æŒ‰é¡ºåºåˆ†åˆ«æ˜¯ï¼šDEBUGã€INFOã€WARNã€ERROR --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- æŒ‡å®šä»»ä½•ä¸€ä¸ªæ—¥å¿—çº§åˆ«éƒ½åªæ‰“å°å½“å‰çº§åˆ«å’Œåé¢çº§åˆ«çš„æ—¥å¿—ã€‚ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- æŒ‡å®šæ‰“å°æ—¥å¿—çš„appenderï¼Œè¿™é‡Œé€šè¿‡â€œSTDOUTâ€å¼•ç”¨äº†å‰é¢é…ç½®çš„appender --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- æ ¹æ®ç‰¹æ®Šéœ€æ±‚æŒ‡å®šå±€éƒ¨æ—¥å¿—çº§åˆ« --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;com.atguigu.crowd.mapper&quot;</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="MyBatisé€†å‘å·¥ç¨‹">MyBatisé€†å‘å·¥ç¨‹</h2><p>æ­£å‘å·¥ç¨‹ï¼šå…ˆåˆ›å»ºJavaå®ä½“ç±»ï¼Œç”±æ¡†æ¶è´Ÿè´£æ ¹æ®å®ä½“ç±»ç”Ÿæˆæ•°æ®åº“è¡¨ã€‚Hibernateæ˜¯æ”¯æŒæ­£å‘å·¥ç¨‹çš„ã€‚</p><p>é€†å‘å·¥ç¨‹ï¼šå…ˆåˆ›å»ºæ•°æ®åº“è¡¨ï¼Œç”±æ¡†æ¶è´Ÿè´£æ ¹æ®æ•°æ®åº“è¡¨ï¼Œåå‘ç”Ÿæˆå¦‚ä¸‹èµ„æºï¼š</p><ul><li>Javaå®ä½“ç±»</li><li>Mapperæ¥å£</li><li>Mapperæ˜ å°„æ–‡ä»¶</li></ul><blockquote><p>åˆ›å»ºé€†å‘å·¥ç¨‹çš„æ­¥éª¤</p></blockquote><div class="tabs" id="8d5e3e9c-1181-4513-8549-1a47848e7cee"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#8d5e3e9c-1181-4513-8549-1a47848e7cee-1"><i class="fas fa-award"></i>æ·»åŠ ä¾èµ–å’Œæ’ä»¶</button></li><li class="tab"><button type="button" data-href="#8d5e3e9c-1181-4513-8549-1a47848e7cee-2"><i class="fas fa-baseball-ball"></i>åˆ›å»ºé…ç½®æ–‡ä»¶</button></li><li class="tab"><button type="button" data-href="#8d5e3e9c-1181-4513-8549-1a47848e7cee-3"><i class="fas fa-bone"></i>æ‰§è¡ŒMBGæ’ä»¶çš„generateç›®æ ‡</button></li><li class="tab"><button type="button" data-href="#8d5e3e9c-1181-4513-8549-1a47848e7cee-4"><i class="fas fa-anchor"></i>æ•ˆæœ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="8d5e3e9c-1181-4513-8549-1a47848e7cee-1"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ä¾èµ–MyBatisæ ¸å¿ƒåŒ… --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- æ§åˆ¶Mavenåœ¨æ„å»ºè¿‡ç¨‹ä¸­ç›¸å…³é…ç½® --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- æ„å»ºè¿‡ç¨‹ä¸­ç”¨åˆ°çš„æ’ä»¶ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- å…·ä½“æ’ä»¶ï¼Œé€†å‘å·¥ç¨‹çš„æ“ä½œæ˜¯ä»¥æ„å»ºè¿‡ç¨‹ä¸­æ’ä»¶å½¢å¼å‡ºç°çš„ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.generator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-generator-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- æ’ä»¶çš„ä¾èµ– --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- é€†å‘å·¥ç¨‹çš„æ ¸å¿ƒä¾èµ– --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.generator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-generator-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- æ•°æ®åº“è¿æ¥æ±  --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mchange<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- MySQLé©±åŠ¨ --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8d5e3e9c-1181-4513-8549-1a47848e7cee-2"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">generatorConfiguration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">generatorConfiguration</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">targetRuntime: æ‰§è¡Œç”Ÿæˆçš„é€†å‘å·¥ç¨‹çš„ç‰ˆæœ¬</span></span><br><span class="line"><span class="comment">MyBatis3Simple: ç”ŸæˆåŸºæœ¬çš„CRUDï¼ˆæ¸…æ–°ç®€æ´ç‰ˆï¼‰</span></span><br><span class="line"><span class="comment">MyBatis3: ç”Ÿæˆå¸¦æ¡ä»¶çš„CRUDï¼ˆå¥¢åå°Šäº«ç‰ˆï¼‰</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context</span> <span class="attr">id</span>=<span class="string">&quot;DB2Tables&quot;</span> <span class="attr">targetRuntime</span>=<span class="string">&quot;MyBatis3Simple&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- æ•°æ®åº“çš„è¿æ¥ä¿¡æ¯ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdbcConnection</span> <span class="attr">driverClass</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">connectionURL</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/mybatis&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">userId</span>=<span class="string">&quot;root&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">jdbcConnection</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- javaBeançš„ç”Ÿæˆç­–ç•¥--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">javaModelGenerator</span> <span class="attr">targetPackage</span>=<span class="string">&quot;com.atguigu.mybatis.bean&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">targetProject</span>=<span class="string">&quot;.\src\main\java&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;enableSubPackages&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;trimStrings&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">javaModelGenerator</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- SQLæ˜ å°„æ–‡ä»¶çš„ç”Ÿæˆç­–ç•¥ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sqlMapGenerator</span> <span class="attr">targetPackage</span>=<span class="string">&quot;com.atguigu.mybatis.mapper&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">targetProject</span>=<span class="string">&quot;.\src\main\resources&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;enableSubPackages&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sqlMapGenerator</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Mapperæ¥å£çš„ç”Ÿæˆç­–ç•¥ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">javaClientGenerator</span> <span class="attr">type</span>=<span class="string">&quot;XMLMAPPER&quot;</span></span></span><br><span class="line"><span class="tag">                         <span class="attr">targetPackage</span>=<span class="string">&quot;com.atguigu.mybatis.mapper&quot;</span> <span class="attr">targetProject</span>=<span class="string">&quot;.\src\main\java&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;enableSubPackages&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">javaClientGenerator</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- é€†å‘åˆ†æçš„è¡¨ --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- tableNameè®¾ç½®ä¸º*å·ï¼Œå¯ä»¥å¯¹åº”æ‰€æœ‰è¡¨ï¼Œæ­¤æ—¶ä¸å†™domainObjectName --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- domainObjectNameå±æ€§æŒ‡å®šç”Ÿæˆå‡ºæ¥çš„å®ä½“ç±»çš„ç±»å --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">tableName</span>=<span class="string">&quot;t_emp&quot;</span> <span class="attr">domainObjectName</span>=<span class="string">&quot;Emp&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">tableName</span>=<span class="string">&quot;t_dept&quot;</span> <span class="attr">domainObjectName</span>=<span class="string">&quot;Dept&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">generatorConfiguration</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8d5e3e9c-1181-4513-8549-1a47848e7cee-3"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230527193554700.png" alt="image-20230527193554700"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8d5e3e9c-1181-4513-8549-1a47848e7cee-4"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230527193608791.png" alt="image-20230527193608791"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><hr><h2 id="åˆ†é¡µæ’ä»¶">åˆ†é¡µæ’ä»¶</h2><div class="tabs" id="1fa9541b-3576-4dc5-82b6-976a1c503bd6"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#1fa9541b-3576-4dc5-82b6-976a1c503bd6-1"><i class="fas fa-seedling"></i>æ·»åŠ ä¾èµ–</button></li><li class="tab"><button type="button" data-href="#1fa9541b-3576-4dc5-82b6-976a1c503bd6-2"><i class="fas fa-leaf"></i>é…ç½®åˆ†é¡µæ’ä»¶</button></li><li class="tab"><button type="button" data-href="#1fa9541b-3576-4dc5-82b6-976a1c503bd6-3"><i class="fab fa-apple"></i>åˆ†é¡µæ’ä»¶çš„ä½¿ç”¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="1fa9541b-3576-4dc5-82b6-976a1c503bd6-1"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.github.pagehelper/pagehelper --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="1fa9541b-3576-4dc5-82b6-976a1c503bd6-2"><p>åœ¨MyBatisçš„æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸­é…ç½®æ’ä»¶</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--è®¾ç½®åˆ†é¡µæ’ä»¶--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">&quot;com.github.pagehelper.PageInterceptor&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="1fa9541b-3576-4dc5-82b6-976a1c503bd6-3"><blockquote><p>åœ¨æŸ¥è¯¢åŠŸèƒ½ä¹‹å‰ä½¿ç”¨<code>PageHelper.startPage(int pageNum, int pageSize)</code>å¼€å¯åˆ†é¡µåŠŸèƒ½</p></blockquote><p>pageNumï¼šå½“å‰é¡µçš„é¡µç </p><p>pageSizeï¼šæ¯é¡µæ˜¾ç¤ºçš„æ¡æ•°</p><blockquote><p>åœ¨æŸ¥è¯¢è·å–listé›†åˆä¹‹åï¼Œä½¿ç”¨<code>PageInfo&lt;T&gt; pageInfo = new PageInfo&lt;&gt;(List&lt;T&gt; list, intnavigatePages)</code>è·å–åˆ†é¡µç›¸å…³æ•°æ®</p></blockquote><p>listï¼šåˆ†é¡µä¹‹åçš„æ•°æ®</p><p>navigatePagesï¼šå¯¼èˆªåˆ†é¡µçš„é¡µç æ•°</p><blockquote><p>å¸¸ç”¨æ•°æ®</p></blockquote><p>pageNumï¼šå½“å‰é¡µçš„é¡µç </p><p>pageSizeï¼šæ¯é¡µæ˜¾ç¤ºçš„æ¡æ•°</p><p>sizeï¼šå½“å‰é¡µæ˜¾ç¤ºçš„çœŸå®æ¡æ•°</p><p>totalï¼šæ€»è®°å½•æ•°</p><p>pagesï¼šæ€»é¡µæ•°</p><p>prePageï¼šä¸Šä¸€é¡µçš„é¡µç </p><p>nextPageï¼šä¸‹ä¸€é¡µçš„é¡µç </p><p>isFirstPage/isLastPageï¼šæ˜¯å¦ä¸ºç¬¬ä¸€é¡µ/æœ€åä¸€é¡µ</p><p>hasPreviousPage/hasNextPageï¼šæ˜¯å¦å­˜åœ¨ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µ</p><p>navigatePagesï¼šå¯¼èˆªåˆ†é¡µçš„é¡µç æ•°</p><p>navigatepageNumsï¼šå¯¼èˆªåˆ†é¡µçš„é¡µç ï¼Œ[1,2,3,4,5]æ›´</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>]]></content>
    
    
    <summary type="html">MyBatisä½¿ç”¨</summary>
    
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="MyBatis" scheme="https://wuwawawa.github.io/tags/MyBatis/"/>
    
  </entry>
  
  <entry>
    <title>HashMapå’ŒTreeMap</title>
    <link href="https://wuwawawa.github.io/posts/9a196584.html"/>
    <id>https://wuwawawa.github.io/posts/9a196584.html</id>
    <published>2023-05-22T09:47:10.000Z</published>
    <updated>2023-05-22T14:49:55.102Z</updated>
    
    <content type="html"><![CDATA[<h2 id="HashMapç»§æ‰¿ä½“ç³»">HashMapç»§æ‰¿ä½“ç³»</h2><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230522184524368.png" alt="image-20230522184524368"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashMap</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">AbstractMap</span>&lt;K,V&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">Map</span>&lt;K,V&gt;, Cloneable, Serializable</span><br></pre></td></tr></table></figure><p>HashMapæ˜¯Mapé‡Œé¢çš„ä¸€ä¸ªå®ç°ç±»ã€‚</p><p>æ²¡æœ‰é¢å¤–éœ€è¦å­¦ä¹ çš„ç‰¹æœ‰æ–¹æ³•ï¼Œç›´æ¥ä½¿ç”¨Mapé‡Œé¢çš„æ–¹æ³•å°±å¯ä»¥äº†ã€‚</p><p>ç‰¹ç‚¹éƒ½æ˜¯ç”±é”®å†³å®šçš„ï¼šæ— åºã€ä¸é‡å¤ã€æ— ç´¢å¼•</p><p>HashMapè·ŸHashSetåº•å±‚åŸç†æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œéƒ½æ˜¯å“ˆå¸Œè¡¨ç»“æ„</p><h2 id="HashMapåº•å±‚åŸç†">HashMapåº•å±‚åŸç†</h2><div class="tabs" id="d8861ef8-b02e-43e2-925f-acf859a71222"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d8861ef8-b02e-43e2-925f-acf859a71222-1"><i class="fas fa-atom"></i>1</button></li><li class="tab"><button type="button" data-href="#d8861ef8-b02e-43e2-925f-acf859a71222-2"><i class="far fa-sun"></i>2</button></li><li class="tab"><button type="button" data-href="#d8861ef8-b02e-43e2-925f-acf859a71222-3"><i class="fas fa-wind"></i>3</button></li><li class="tab"><button type="button" data-href="#d8861ef8-b02e-43e2-925f-acf859a71222-4"><i class="fas fa-fire-alt"></i>4</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d8861ef8-b02e-43e2-925f-acf859a71222-1"><p>å½“åˆ›å»ºä¸€ä¸ªHashMapå¯¹è±¡çš„æ—¶å€™ï¼Œåœ¨åº•å±‚åˆ›å»ºäº†ä¸€ä¸ªé•¿åº¦ä¸º16ï¼Œè´Ÿè½½å› å­ä¸º0.75çš„<code>Node&lt;K,V&gt;[] table</code>æ•°ç»„ã€‚</p><p>åœ¨åˆ©ç”¨putæ–¹æ³•å°±å¯ä»¥æ·»åŠ æ•°æ®äº†ï¼Œputæ–¹æ³•çš„åº•å±‚ä¼šåˆ›å»ºä¸€ä¸ªEntryå¯¹è±¡ï¼ŒEntryå¯¹è±¡è®°å½•çš„å°±æ˜¯è¦æ·»åŠ çš„é”®å’Œå€¼ã€‚</p><p><span class='p red'>å†åˆ©ç”¨é”®è®¡ç®—å‡ºé”®çš„Hashå€¼ï¼Œåªè¦é”®çš„Hashå€¼ï¼Œå’Œå€¼æ— å…³ã€‚</span></p><p>ç„¶åå†è®¡ç®—å‡ºæ•°ç»„ä¸­è¯¥å­˜å…¥çš„ç´¢å¼•4ï¼Œå¦‚æœè¯¥ä½ç½®ä¸ºnullï¼Œå°±ç›´æ¥æ·»åŠ è¿›å»ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230522195854184.png" alt="image-20230522195854184" style="zoom:50%;" /><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230522200359353.png" alt="image-20230522200359353" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d8861ef8-b02e-43e2-925f-acf859a71222-2"><p>å†æ·»åŠ ä¸€ä¸ªEntryå¯¹è±¡ï¼Œè®¡ç®—å‡ºæ¥çš„ç´¢å¼•è¿˜æ˜¯4ï¼Œé‚£æ­¤æ—¶4ç´¢å¼•å¤„å°±ä¸æ˜¯nulläº†ã€‚</p><p>è°ƒç”¨equalsæ–¹æ³•æ¯”è¾ƒé”®çš„å±æ€§å€¼ï¼Œåªæ¯”è¾ƒé”®çš„å±æ€§å€¼ï¼Œ</p><p>å¦‚æœé”®é‡Œé¢çš„æ•°æ®æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè¦†ç›–åŸæœ‰çš„Entryå¯¹è±¡ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230522200427206.png" alt="image-20230522200427206" style="zoom:67%;" /><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230522200447565.png" alt="image-20230522200447565" style="zoom: 67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d8861ef8-b02e-43e2-925f-acf859a71222-3"><p>å¦‚æœequalæ¯”è¾ƒå®Œåï¼Œå‘ç°é”®ä¸ä¸€æ ·ï¼Œå°±ä¼šæ·»åŠ æ–°çš„Entryå¯¹è±¡</p><p>åœ¨JDK8ä»¥å‰ï¼Œæ–°å…ƒç´ æ·»åŠ åˆ°æ•°ç»„å½“ä¸­ï¼Œæ—§å…ƒç´ æŒ‚åœ¨ä¸‹é¢ï¼Œå½¢æˆä¸€æ¡é“¾è¡¨</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230522200715009.png" alt="image-20230522200715009" style="zoom:67%;" /><p>åœ¨JDK8ä»¥åå°±æ²¡æœ‰é‚£ä¹ˆå¤æ‚äº†</p><p>æ–°çš„å…ƒç´ ç›´æ¥æŒ‚åœ¨è€å…ƒç´ çš„ä¸‹é¢ï¼Œå½¢æˆä¸€æ¡é“¾è¡¨</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230522200803368.png" alt="image-20230522200803368" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d8861ef8-b02e-43e2-925f-acf859a71222-4"><p>é¢å¤–çš„ï¼Œåœ¨JDK8çš„æ—¶å€™ï¼Œä¸ºäº†æå‡æ€§èƒ½ï¼Œå½“é“¾è¡¨çš„é•¿åº¦è¶…è¿‡8ä¸”æ•°ç»„çš„é•¿åº¦å¤§äºç­‰äº64çš„æ—¶å€™ï¼Œé“¾è¡¨å°±ä¼šè‡ªåŠ¨è½¬æˆçº¢é»‘æ ‘ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230522201115466.png" alt="image-20230522201115466" style="zoom:67%;" /><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230522201131434.png" alt="image-20230522201131434" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <blockquote><p>æ€»ç»“</p></blockquote><ol><li><p>HashMapåº•å±‚æ˜¯å“ˆå¸Œè¡¨ç»“æ„çš„</p></li><li><p>ä¾èµ–hashCodeæ–¹æ³•å’Œequalsæ–¹æ³•ä¿è¯<span class='p red'>é”®çš„å”¯ä¸€</span></p></li><li><p>å¦‚æœé”®å­˜å‚¨çš„æ˜¯è‡ªå®šä¹‰å¯¹è±¡ï¼Œéœ€è¦é‡å†™hashCodeå’Œequalsæ–¹æ³•</p></li><li><p>å¦‚æœå€¼å­˜å‚¨è‡ªå®šä¹‰å¯¹è±¡ï¼Œä¸éœ€è¦é‡å†™hashCodeå’Œequalsæ–¹æ³•</p></li></ol><hr><hr><h2 id="HashMapå…³é”®å­—æ®µåˆ†æ">HashMapå…³é”®å­—æ®µåˆ†æ</h2><div class="tabs" id="77fc3bbe-ef4c-40d7-8b63-40523f4490a0"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#77fc3bbe-ef4c-40d7-8b63-40523f4490a0-1"><i class="fas fa-bug"></i>1</button></li><li class="tab"><button type="button" data-href="#77fc3bbe-ef4c-40d7-8b63-40523f4490a0-2"><i class="fas fa-cannabis"></i>2</button></li><li class="tab"><button type="button" data-href="#77fc3bbe-ef4c-40d7-8b63-40523f4490a0-3"><i class="fas fa-candy-cane"></i>3</button></li><li class="tab"><button type="button" data-href="#77fc3bbe-ef4c-40d7-8b63-40523f4490a0-4"><i class="fas fa-child"></i>4</button></li><li class="tab"><button type="button" data-href="#77fc3bbe-ef4c-40d7-8b63-40523f4490a0-5"><i class="fas fa-seedling"></i>5</button></li><li class="tab"><button type="button" data-href="#77fc3bbe-ef4c-40d7-8b63-40523f4490a0-6"><i class="fas fa-leaf"></i>6</button></li><li class="tab"><button type="button" data-href="#77fc3bbe-ef4c-40d7-8b63-40523f4490a0-7"><i class="fab fa-apple"></i>7</button></li><li class="tab"><button type="button" data-href="#77fc3bbe-ef4c-40d7-8b63-40523f4490a0-8"><i class="fas fa-tree"></i>8</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="77fc3bbe-ef4c-40d7-8b63-40523f4490a0-1"><p>è¿™ä¸ªå­—æ®µè¡¨ç¤ºé»˜è®¤çš„å“ˆå¸Œè¡¨çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯<code>HashMap</code>åº•å±‚ä½¿ç”¨æ•°ç»„çš„é»˜è®¤é•¿åº¦ï¼Œåœ¨<code>HashMap</code>å½“ä¸­åº•å±‚æ‰€ä½¿ç”¨çš„çš„æ•°ç»„çš„é•¿åº¦å¿…é¡»æ˜¯<code>2</code>çš„æ•´æ•°æ¬¡å¹‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The default initial capacity - MUST be a power of two.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_INITIAL_CAPACITY</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">4</span>; <span class="comment">// aka 16</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="77fc3bbe-ef4c-40d7-8b63-40523f4490a0-2"><p>è¿™ä¸ªå­—æ®µè¡¨ç¤ºå“ˆå¸Œè¡¨å½“ä¸­æ•°ç»„çš„æœ€å¤§é•¿åº¦ï¼Œ<code>HashMap</code>åº•å±‚ä½¿ç”¨çš„æ•°ç»„é•¿åº¦ä¸èƒ½è¶…è¿‡è¿™ä¸ªå€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The maximum capacity, used if a higher value is implicitly specified</span></span><br><span class="line"><span class="comment"> * by either of the constructors with arguments.</span></span><br><span class="line"><span class="comment"> * MUST be a power of two &lt;= 1&lt;&lt;30.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAXIMUM_CAPACITY</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="77fc3bbe-ef4c-40d7-8b63-40523f4490a0-3"><p>å­—æ®µ<code>DEFAULT_LOAD_FACTOR</code>çš„ä½œç”¨è¡¨ç¤ºåœ¨<code>HashMap</code>å½“ä¸­é»˜è®¤çš„è´Ÿè½½å› å­çš„å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The load factor used when none specified in constructor.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">float</span> <span class="variable">DEFAULT_LOAD_FACTOR</span> <span class="operator">=</span> <span class="number">0.75f</span>;</span><br></pre></td></tr></table></figure><p>åœ¨å®é™…æƒ…å†µå½“ä¸­æˆ‘ä»¬å¹¶ä¸æ˜¯å½“<code>HashMap</code>å½“ä¸­çš„æ•°ç»„å®Œå…¨è¢«ä½¿ç”¨å®Œä¹‹åæ‰è¿›è¡Œæ‰©å®¹ï¼Œå› ä¸ºå¦‚æœæ•°ç»„å¿«è¢«ä½¿ç”¨å®Œä¹‹åï¼Œå†åŠ å…¥æ•°æ®äº§ç”Ÿå“ˆå¸Œå†²çªçš„å¯èƒ½æ€§å°±ä¼šå¾ˆå¤§ï¼Œå› æ­¤æˆ‘ä»¬é€šå¸¸ä¼šè®¾ç½®ä¸€ä¸ªè´Ÿè½½å› å­<code>(load factor)</code>ï¼Œå½“æ•°ç»„çš„ä½¿ç”¨ç‡è¶…è¿‡è¿™ä¸ªå€¼çš„æ—¶å€™å°±è¿›è¡Œæ‰©å®¹ï¼Œå³å½“(æ•°ç»„é•¿åº¦ä¸º<code>L</code>ï¼Œæ•°ç»„å½“ä¸­æ•°æ®ä¸ªæ•°ä¸º<code>S</code>ï¼Œè´Ÿè½½å› å­ä¸º<code>F</code>)ï¼š</p><p>S&gt;=L*F</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="77fc3bbe-ef4c-40d7-8b63-40523f4490a0-4"><p><code>TREEIFY_THRESHOLD</code> è¿™ä¸ªå­—æ®µä¸»è¦è¡¨ç¤ºå°†é“¾è¡¨ï¼ˆåœ¨<code>JDK</code>å½“ä¸­æ˜¯é‡‡ç”¨é“¾åœ°å€æ³•å»è§£å†³å“ˆå¸Œå†²çªçš„é—®é¢˜ï¼‰å˜æˆä¸€ä¸ªçº¢é»‘æ ‘çš„æ¡ä»¶ï¼Œåœ¨<code>JDK1.8</code>ä¹‹å<code>JDK</code>ä¸­å®ç°<code>HashMap</code>ä¸ä»…é‡‡ç”¨é“¾åœ°å€æ³•å»è§£å†³å“ˆå¸Œå†²çªï¼Œè€Œä¸”é“¾è¡¨æ»¡è¶³ä¸€å®šæ¡ä»¶ä¹‹åä¼šå°†é“¾è¡¨å˜æˆä¸€é¢—çº¢é»‘æ ‘ã€‚è€Œå°†é“¾è¡¨å˜æˆä¸€é¢—çº¢é»‘æ ‘çš„<code>å¿…è¦æ¡ä»¶</code>æ˜¯é“¾è¡¨å½“ä¸­æ•°æ®çš„ä¸ªæ•°è¦å¤§äºç­‰äº<code>TREEIFY_THRESHOLD</code>ï¼Œè¯·å¤§å®¶æ³¨æ„æ˜¯<code>å¿…è¦æ¡ä»¶</code>ä¸æ˜¯<code>å……åˆ†æ¡ä»¶</code>ï¼Œä¹Ÿå°±æ˜¯è¯´æ»¡è¶³è¿™ä¸ªæ¡ä»¶è¿˜ä¸è¡Œï¼Œå®ƒè¿˜éœ€è¦æ»¡è¶³å¦å¤–ä¸€ä¸ªæ¡ä»¶ï¼Œå°±æ˜¯å“ˆå¸Œè¡¨ä¸­æ•°ç»„çš„é•¿åº¦è¦å¤§äºç­‰äº<code>MIN_TREEIFY_CAPACITY</code>ï¼Œ<code>MIN_TREEIFY_CAPACITY</code>åœ¨<code>JDK</code>å½“ä¸­çš„é»˜è®¤å€¼æ˜¯64ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The bin count threshold for using a tree rather than list for a</span></span><br><span class="line"><span class="comment"> * bin.  Bins are converted to trees when adding an element to a</span></span><br><span class="line"><span class="comment"> * bin with at least this many nodes. The value must be greater</span></span><br><span class="line"><span class="comment"> * than 2 and should be at least 8 to mesh with assumptions in</span></span><br><span class="line"><span class="comment"> * tree removal about conversion back to plain bins upon</span></span><br><span class="line"><span class="comment"> * shrinkage.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TREEIFY_THRESHOLD</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The smallest table capacity for which bins may be treeified.</span></span><br><span class="line"><span class="comment"> * (Otherwise the table is resized if too many nodes in a bin.)</span></span><br><span class="line"><span class="comment"> * Should be at least 4 * TREEIFY_THRESHOLD to avoid conflicts</span></span><br><span class="line"><span class="comment"> * between resizing and treeification thresholds.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MIN_TREEIFY_CAPACITY</span> <span class="operator">=</span> <span class="number">64</span>;</span><br><span class="line"> </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="77fc3bbe-ef4c-40d7-8b63-40523f4490a0-5"><p><code>UNTREEIFY_THRESHOLD</code>è¡¨ç¤ºå½“åœ¨è¿›è¡Œ<code>resize</code>æ“ä½œçš„è¿‡ç¨‹å½“ä¸­ï¼Œçº¢é»‘æ ‘å½“ä¸­çš„èŠ‚ç‚¹ä¸ªæ•°å°äº<code>UNTREEIFY_THRESHOLD</code>æ—¶ï¼Œå°±éœ€è¦å°†ä¸€é¢—çº¢é»‘æ ‘é‡æ–°æ¢å¤æˆé“¾è¡¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The bin count threshold for untreeifying a (split) bin during a</span></span><br><span class="line"><span class="comment"> * resize operation. Should be less than TREEIFY_THRESHOLD, and at</span></span><br><span class="line"><span class="comment"> * most 6 to mesh with shrinkage detection under removal.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">UNTREEIFY_THRESHOLD</span> <span class="operator">=</span> <span class="number">6</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="77fc3bbe-ef4c-40d7-8b63-40523f4490a0-6"><p><code>table</code>æ•°ç»„å¯¹è±¡å°±æ˜¯<code>HashMap</code>åº•å±‚å½“ä¸­çœŸæ­£ç”¨äºå­˜å‚¨æ•°æ®çš„æ•°ç»„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The table, initialized on first use, and resized as</span></span><br><span class="line"><span class="comment"> * necessary. When allocated, length is always a power of two.</span></span><br><span class="line"><span class="comment"> * (We also tolerate length zero in some operations to allow</span></span><br><span class="line"><span class="comment"> * bootstrapping mechanics that are currently not needed.)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">transient</span> Node&lt;K,V&gt;[] table;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="77fc3bbe-ef4c-40d7-8b63-40523f4490a0-7"><p><code>size</code>è¡¨ç¤ºå“ˆå¸Œè¡¨ä¸­å­˜å‚¨çš„<code>key-value</code>å¯¹è±¡çš„ä¸ªæ•°ï¼Œä¹Ÿå°±æ˜¯æ”¾å…¥äº†å¤šå°‘ä¸ªé”®å€¼å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The number of key-value mappings contained in this map.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">transient</span> <span class="type">int</span> size;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="77fc3bbe-ef4c-40d7-8b63-40523f4490a0-8"><p><code>threshold</code>è¡¨ç¤ºå®¹å™¨å½“ä¸­èƒ½å¤Ÿå­˜å‚¨çš„æ•°æ®ä¸ªæ•°çš„é˜ˆå€¼ï¼Œå½“<code>HashMap</code>å½“ä¸­å­˜å‚¨çš„æ•°æ®çš„ä¸ªæ•°è¶…è¿‡è¿™ä¸ªå€¼çš„æ—¶å€™ï¼Œ<code>HashMap</code>åº•å±‚ä½¿ç”¨çš„æ•°ç»„å°±éœ€è¦è¿›è¡Œæ‰©å®¹ã€‚ä¸‹åˆ—å…¬å¼ä¸­<code>Capacity</code>è¡¨ç¤ºåº•å±‚æ•°ç»„çš„é•¿åº¦ï¼ˆ<code>2</code>çš„æ•´æ•°æ¬¡å¹‚ï¼Œæ³¨æ„ä¸<code>size</code>è¿›è¡ŒåŒºåˆ†ï¼‰ã€‚</p><p>threshold = LoadFactor * Capacity</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><blockquote><p>HashMapåº•å±‚èŠ‚ç‚¹ç±»</p></blockquote><p><code>Node&lt;K,V&gt;[] table</code>åº•å±‚å½“ä¸­çœŸæ­£ç”¨äºå­˜å‚¨æ•°æ®çš„æ•°ç»„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">Map</span>.Entry&lt;K,V&gt; &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> hash;</span><br><span class="line">        <span class="keyword">final</span> K key;</span><br><span class="line">        V value;</span><br><span class="line">        Node&lt;K,V&gt; next;</span><br><span class="line"></span><br><span class="line">        Node(<span class="type">int</span> hash, K key, V value, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">            <span class="built_in">this</span>.hash = hash;</span><br><span class="line">            <span class="built_in">this</span>.key = key;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">            <span class="built_in">this</span>.next = next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> K <span class="title function_">getKey</span><span class="params">()</span>        &#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> V <span class="title function_">getValue</span><span class="params">()</span>      &#123; <span class="keyword">return</span> value; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">toString</span><span class="params">()</span> &#123; <span class="keyword">return</span> key + <span class="string">&quot;=&quot;</span> + value; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> V <span class="title function_">setValue</span><span class="params">(V newValue)</span> &#123;</span><br><span class="line">            <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> value;</span><br><span class="line">            value = newValue;</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (o == <span class="built_in">this</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Map.Entry) &#123;</span><br><span class="line">                Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;)o;</span><br><span class="line">                <span class="keyword">if</span> (Objects.equals(key, e.getKey()) &amp;&amp;</span><br><span class="line">                    Objects.equals(value, e.getValue()))</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="HashMapä¸»è¦æ–¹æ³•åˆ†æ">HashMapä¸»è¦æ–¹æ³•åˆ†æ</h2><h3 id="æ„é€ æ–¹æ³•">æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">HashMap</span><span class="params">(<span class="type">int</span> initialCapacity)</span> &#123;</span><br><span class="line">    <span class="comment">// æŒ‡å®šåˆå§‹å®¹é‡çš„æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="built_in">this</span>(initialCapacity, DEFAULT_LOAD_FACTOR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">HashMap</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.loadFactor = DEFAULT_LOAD_FACTOR; <span class="comment">// all other fields defaulted</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">HashMap</span><span class="params">(<span class="type">int</span> initialCapacity, <span class="type">float</span> loadFactor)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Illegal initial capacity: &quot;</span> +</span><br><span class="line">                initialCapacity);</span><br><span class="line">    <span class="comment">// å¦‚æœå¤§äºå…è®¸çš„æœ€å¤§å®¹é‡ï¼Œå°±å°†æ•°ç»„çš„é•¿åº¦è¿™æ˜¯ä¸ºæœ€å¤§å®¹é‡</span></span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">        initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Illegal load factor: &quot;</span> +</span><br><span class="line">                loadFactor);</span><br><span class="line">    <span class="built_in">this</span>.loadFactor = loadFactor;</span><br><span class="line">    <span class="comment">//å› ä¸ºæˆ‘ä»¬éœ€è¦åº•å±‚ä½¿ç”¨çš„æ•°ç»„tableçš„é•¿åº¦æ˜¯2çš„æ•´æ•°æ¬¡å¹‚ï¼Œè€Œæˆ‘ä»¬ä¹‹ååœ¨åˆå§‹åŒ–å‡½æ•°å½“ä¸­ä¼šå…è®¸ç”¨æˆ·è¾“å…¥ä¸€ä¸ªæ•°ç»„é•¿åº¦çš„å¤§å°</span></span><br><span class="line">    <span class="comment">//ä½†æ˜¯ç”¨æˆ·è¾“å…¥çš„æ•°å­—å¯èƒ½ä¸æ˜¯2çš„æ•´æ•°æ¬¡å¹‚ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†ç”¨æˆ·è¾“å…¥çš„æ•°æ®å˜æˆ2çš„æ•´æ•°æ¬¡å¹‚</span></span><br><span class="line">    <span class="comment">//tableSizeForæ–¹æ³•å¯ä»¥å°†ç”¨æˆ·è¾“å…¥çš„æ•°æ®å˜æˆå¤§äºç­‰äºè¿™ä¸ªæ•°çš„æœ€å°çš„2çš„æ•´æ•°æ¬¡å¹‚ã€‚</span></span><br><span class="line">    <span class="built_in">this</span>.threshold = tableSizeFor(initialCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="put">put</h3><div class="tabs" id="e79f4da6-a38b-4729-ab7b-06e2c986f535"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e79f4da6-a38b-4729-ab7b-06e2c986f535-1"><i class="fas fa-bug"></i>put</button></li><li class="tab"><button type="button" data-href="#e79f4da6-a38b-4729-ab7b-06e2c986f535-2"><i class="fas fa-cannabis"></i>putVal</button></li><li class="tab"><button type="button" data-href="#e79f4da6-a38b-4729-ab7b-06e2c986f535-3"><i class="fas fa-candy-cane"></i>resize</button></li><li class="tab"><button type="button" data-href="#e79f4da6-a38b-4729-ab7b-06e2c986f535-4"><i class="fas fa-child"></i>4</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e79f4da6-a38b-4729-ab7b-06e2c986f535-1"><p>åœ¨<code>put</code>å‡½æ•°å½“ä¸­é¦–å…ˆè®¡ç®—å‚æ•°<code>key</code>çš„å“ˆå¸Œå€¼ï¼Œç„¶åè°ƒç”¨<code>putVal</code>å‡½æ•°çœŸæ­£çš„å°†è¾“å…¥æ’å…¥åˆ°æ•°æ®å½“ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å‚æ•°ä¸€ï¼šé”®</span></span><br><span class="line"><span class="comment">//å‚æ•°äºŒï¼šå€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼šè¢«è¦†ç›–å…ƒç´ çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰è¦†ç›–ï¼Œè¿”å›null</span></span><br><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ©ç”¨é”®è®¡ç®—å‡ºå¯¹åº”çš„å“ˆå¸Œå€¼ï¼Œå†æŠŠå“ˆå¸Œå€¼è¿›è¡Œä¸€äº›é¢å¤–çš„å¤„ç†</span></span><br><span class="line"><span class="comment">//ç®€å•ç†è§£ï¼šè¿”å›å€¼å°±æ˜¯è¿”å›é”®çš„å“ˆå¸Œå€¼</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><mark class="hl-label green">æ•´ä½“æµç¨‹</mark></p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2519003-20220712235514945-220342780.png" alt="img" style="zoom:60%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e79f4da6-a38b-4729-ab7b-06e2c986f535-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å‚æ•°ä¸€ï¼šé”®çš„å“ˆå¸Œå€¼</span></span><br><span class="line">    <span class="comment">//å‚æ•°äºŒï¼šé”®</span></span><br><span class="line">    <span class="comment">//å‚æ•°ä¸‰ï¼šå€¼</span></span><br><span class="line">    <span class="comment">//å‚æ•°å››ï¼šå¦‚æœé”®é‡å¤äº†æ˜¯å¦ä¿ç•™</span></span><br><span class="line">    <span class="comment">//   trueï¼Œè¡¨ç¤ºè€å…ƒç´ çš„å€¼ä¿ç•™ï¼Œä¸ä¼šè¦†ç›–</span></span><br><span class="line">    <span class="comment">//   falseï¼Œè¡¨ç¤ºè€å…ƒç´ çš„å€¼ä¸ä¿ç•™ï¼Œä¼šè¿›è¡Œè¦†ç›–</span></span><br><span class="line">    <span class="keyword">final</span> V <span class="title function_">putVal</span><span class="params">(<span class="type">int</span> hash, K key, V value, <span class="type">boolean</span> onlyIfAbsent, <span class="type">boolean</span> evict)</span> &#123;</span><br><span class="line">        <span class="comment">//å®šä¹‰ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œç”¨æ¥è®°å½•å“ˆå¸Œè¡¨ä¸­æ•°ç»„çš„åœ°å€å€¼ã€‚</span></span><br><span class="line">        Node&lt;K, V&gt;[] tab;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä¸´æ—¶çš„ç¬¬ä¸‰æ–¹å˜é‡ï¼Œç”¨æ¥è®°å½•é”®å€¼å¯¹å¯¹è±¡çš„åœ°å€å€¼</span></span><br><span class="line">        Node&lt;K, V&gt; p;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è¡¨ç¤ºå½“å‰æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line">        <span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è¡¨ç¤ºç´¢å¼•</span></span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æŠŠå“ˆå¸Œè¡¨ä¸­æ•°ç»„çš„åœ°å€å€¼ï¼Œèµ‹å€¼ç»™å±€éƒ¨å˜é‡tab</span></span><br><span class="line">        tab = table;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//1.å¦‚æœå½“å‰æ˜¯ç¬¬ä¸€æ¬¡æ·»åŠ æ•°æ®ï¼Œåº•å±‚ä¼šåˆ›å»ºä¸€ä¸ªé»˜è®¤é•¿åº¦ä¸º16ï¼ŒåŠ è½½å› å­ä¸º0.75çš„æ•°ç»„</span></span><br><span class="line">            <span class="comment">//2.å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡æ·»åŠ æ•°æ®ï¼Œä¼šçœ‹æ•°ç»„ä¸­çš„å…ƒç´ æ˜¯å¦è¾¾åˆ°äº†æ‰©å®¹çš„æ¡ä»¶</span></span><br><span class="line">            <span class="comment">//å¦‚æœæ²¡æœ‰è¾¾åˆ°æ‰©å®¹æ¡ä»¶ï¼Œåº•å±‚ä¸ä¼šåšä»»ä½•æ“ä½œ</span></span><br><span class="line">            <span class="comment">//å¦‚æœè¾¾åˆ°äº†æ‰©å®¹æ¡ä»¶ï¼Œåº•å±‚ä¼šæŠŠæ•°ç»„æ‰©å®¹ä¸ºåŸå…ˆçš„ä¸¤å€ï¼Œå¹¶æŠŠæ•°æ®å…¨éƒ¨è½¬ç§»åˆ°æ–°çš„å“ˆå¸Œè¡¨ä¸­</span></span><br><span class="line">            tab = resize();</span><br><span class="line">            <span class="comment">//è¡¨ç¤ºæŠŠå½“å‰æ•°ç»„çš„é•¿åº¦èµ‹å€¼ç»™n</span></span><br><span class="line">            n = tab.length;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ‹¿ç€æ•°ç»„çš„é•¿åº¦è·Ÿé”®çš„å“ˆå¸Œå€¼è¿›è¡Œè®¡ç®—ï¼Œè®¡ç®—å‡ºå½“å‰é”®å€¼å¯¹å¯¹è±¡ï¼Œåœ¨æ•°ç»„ä¸­åº”å­˜å…¥çš„ä½ç½®</span></span><br><span class="line">        i = (n - <span class="number">1</span>) &amp; hash;<span class="comment">//index</span></span><br><span class="line">        <span class="comment">//è·å–æ•°ç»„ä¸­å¯¹åº”å…ƒç´ çš„æ•°æ®</span></span><br><span class="line">        p = tab[i];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//åº•å±‚ä¼šåˆ›å»ºä¸€ä¸ªé”®å€¼å¯¹å¯¹è±¡ï¼Œç›´æ¥æ”¾åˆ°æ•°ç»„å½“ä¸­</span></span><br><span class="line">            tab[i] = newNode(hash, key, value, <span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Node&lt;K, V&gt; e;</span><br><span class="line">            K k;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//ç­‰å·çš„å·¦è¾¹ï¼šæ•°ç»„ä¸­é”®å€¼å¯¹çš„å“ˆå¸Œå€¼</span></span><br><span class="line">            <span class="comment">//ç­‰å·çš„å³è¾¹ï¼šå½“å‰è¦æ·»åŠ é”®å€¼å¯¹çš„å“ˆå¸Œå€¼</span></span><br><span class="line">            <span class="comment">//å¦‚æœé”®ä¸ä¸€æ ·ï¼Œæ­¤æ—¶è¿”å›false</span></span><br><span class="line">            <span class="comment">//å¦‚æœé”®ä¸€æ ·ï¼Œè¿”å›true</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">b1</span> <span class="operator">=</span> p.hash == hash;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (b1 &amp;&amp; ((k = p.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                e = p;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode) &#123;</span><br><span class="line">                <span class="comment">//åˆ¤æ–­æ•°ç»„ä¸­è·å–å‡ºæ¥çš„é”®å€¼å¯¹æ˜¯ä¸æ˜¯çº¢é»‘æ ‘ä¸­çš„èŠ‚ç‚¹</span></span><br><span class="line">                <span class="comment">//å¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨æ–¹æ³•putTreeValï¼ŒæŠŠå½“å‰çš„èŠ‚ç‚¹æŒ‰ç…§çº¢é»‘æ ‘çš„è§„åˆ™æ·»åŠ åˆ°æ ‘å½“ä¸­ã€‚</span></span><br><span class="line">                e = ((TreeNode&lt;K, V&gt;) p).putTreeVal(<span class="built_in">this</span>, tab, hash, key, value);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//å¦‚æœä»æ•°ç»„ä¸­è·å–å‡ºæ¥çš„é”®å€¼å¯¹ä¸æ˜¯çº¢é»‘æ ‘ä¸­çš„èŠ‚ç‚¹</span></span><br><span class="line">                <span class="comment">//è¡¨ç¤ºæ­¤æ—¶ä¸‹é¢æŒ‚çš„æ˜¯é“¾è¡¨</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">binCount</span> <span class="operator">=</span> <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((e = p.next) == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//æ­¤æ—¶å°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ï¼ŒæŒ‚åœ¨ä¸‹é¢å½¢æˆé“¾è¡¨</span></span><br><span class="line">                        p.next = newNode(hash, key, value, <span class="literal">null</span>);</span><br><span class="line">                        <span class="comment">//åˆ¤æ–­å½“å‰é“¾è¡¨é•¿åº¦æ˜¯å¦è¶…è¿‡8ï¼Œå¦‚æœè¶…è¿‡8ï¼Œå°±ä¼šè°ƒç”¨æ–¹æ³•treeifyBin</span></span><br><span class="line">                        <span class="comment">//treeifyBinæ–¹æ³•çš„åº•å±‚è¿˜ä¼šç»§ç»­åˆ¤æ–­</span></span><br><span class="line">                        <span class="comment">//åˆ¤æ–­æ•°ç»„çš„é•¿åº¦æ˜¯å¦å¤§äºç­‰äº64</span></span><br><span class="line">                        <span class="comment">//å¦‚æœåŒæ—¶æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶ï¼Œå°±ä¼šæŠŠè¿™ä¸ªé“¾è¡¨è½¬æˆçº¢é»‘æ ‘</span></span><br><span class="line">                        <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>)</span><br><span class="line">                            treeifyBin(tab, hash);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//eï¼š  0x0044  ddd  444</span></span><br><span class="line">                    <span class="comment">//è¦æ·»åŠ çš„å…ƒç´ ï¼š 0x0055   ddd   555</span></span><br><span class="line">                    <span class="comment">//å¦‚æœå“ˆå¸Œå€¼ä¸€æ ·ï¼Œå°±ä¼šè°ƒç”¨equalsæ–¹æ³•æ¯”è¾ƒå†…éƒ¨çš„å±æ€§å€¼æ˜¯å¦ç›¸åŒ</span></span><br><span class="line">                    <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    p = e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//å¦‚æœeä¸ºnullï¼Œè¡¨ç¤ºå½“å‰ä¸éœ€è¦è¦†ç›–ä»»ä½•å…ƒç´ </span></span><br><span class="line">            <span class="comment">//å¦‚æœeä¸ä¸ºnullï¼Œè¡¨ç¤ºå½“å‰çš„é”®æ˜¯ä¸€æ ·çš„ï¼Œå€¼ä¼šè¢«è¦†ç›–</span></span><br><span class="line">            <span class="comment">//e:0x0044  ddd  555</span></span><br><span class="line">            <span class="comment">//è¦æ·»åŠ çš„å…ƒç´ ï¼š 0x0055   ddd   555</span></span><br><span class="line">            <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> e.value;</span><br><span class="line">                <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//ç­‰å·çš„å³è¾¹ï¼šå½“å‰è¦æ·»åŠ çš„å€¼</span></span><br><span class="line">                    <span class="comment">//ç­‰å·çš„å·¦è¾¹ï¼š0x0044çš„å€¼</span></span><br><span class="line">                    e.value = value;</span><br><span class="line">                &#125;</span><br><span class="line">                afterNodeAccess(e);</span><br><span class="line">                <span class="keyword">return</span> oldValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//thresholdï¼šè®°å½•çš„å°±æ˜¯æ•°ç»„çš„é•¿åº¦ * 0.75ï¼Œå“ˆå¸Œè¡¨çš„æ‰©å®¹æ—¶æœº  16 * 0.75 = 12</span></span><br><span class="line">        <span class="keyword">if</span> (++size &gt; threshold) &#123;</span><br><span class="line">            resize();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è¡¨ç¤ºå½“å‰æ²¡æœ‰è¦†ç›–ä»»ä½•å…ƒç´ ï¼Œè¿”å›null</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e79f4da6-a38b-4729-ab7b-06e2c986f535-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line">    <span class="comment">// æ—§æ•°ç»„çš„æ•°ç»„é•¿åº¦</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">oldCap</span> <span class="operator">=</span> (oldTab == <span class="literal">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">    <span class="comment">// æ—§çš„æ‰©å®¹çš„é˜ˆå€¼</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">oldThr</span> <span class="operator">=</span> threshold;</span><br><span class="line">    <span class="type">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            threshold = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span> oldTab;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">                 oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">            newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></span><br><span class="line">        newCap = oldThr;</span><br><span class="line">    <span class="keyword">else</span> &#123;               <span class="comment">// zero initial threshold signifies using defaults</span></span><br><span class="line">        newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">        newThr = (<span class="type">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">float</span> <span class="variable">ft</span> <span class="operator">=</span> (<span class="type">float</span>)newCap * loadFactor;</span><br><span class="line">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="type">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">                  (<span class="type">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸Šé¢çš„ä»£ç ä¸»è¦æ˜¯è®¡ç®—å¾—åˆ°æ–°çš„é˜ˆå€¼ newThr å’Œæ•°ç»„é•¿åº¦ newCap</span></span><br><span class="line">    </span><br><span class="line">    threshold = newThr;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class="line">    <span class="comment">// å¼€è¾Ÿæ–°çš„æ•°ç»„ç©ºé—´</span></span><br><span class="line">    Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>[newCap];</span><br><span class="line">    table = newTab;</span><br><span class="line">    <span class="comment">// ç°åœ¨éœ€è¦å°†æ—§æ•°ç»„å½“ä¸­çš„æ•°æ®åŠ å…¥åˆ°æ–°æ•°ç»„</span></span><br><span class="line">    <span class="keyword">if</span> (oldTab != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">            Node&lt;K,V&gt; e;</span><br><span class="line">            <span class="keyword">if</span> ((e = oldTab[j]) != <span class="literal">null</span>) &#123;</span><br><span class="line">                oldTab[j] = <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">// e.next == null è¡¨ç¤ºåªæœ‰ä¸€ä¸ªæ•°æ®ï¼Œå¹¶æ²¡æœ‰å½¢æˆ 2 ä¸ª</span></span><br><span class="line">                <span class="comment">// æ•°æ®ä»¥ä¸Šçš„é“¾è¡¨ï¼Œå› æ­¤å¯ä»¥ç›´æ¥åŠ å…¥åˆ°å¿ƒå¾—æ•°ç»„ å½“ä¸­</span></span><br><span class="line">                <span class="keyword">if</span> (e.next == <span class="literal">null</span>)</span><br><span class="line">                    newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                    <span class="comment">// å¦‚æœèŠ‚ç‚¹æ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹ï¼Œåˆ™åœ¨å°†çº¢é»‘æ ‘å½“ä¸­çš„èŠ‚ç‚¹åŠ å…¥åˆ°æ–°æ•°ç»„å½“ä¸­</span></span><br><span class="line">                    ((TreeNode&lt;K,V&gt;)e).split(<span class="built_in">this</span>, newTab, j, oldCap);</span><br><span class="line">                <span class="keyword">else</span> &#123; <span class="comment">// preserve order</span></span><br><span class="line">                    <span class="comment">// é“¾è¡¨çš„ä»£ç æ¯”è¾ƒå¤æ‚ï¼Œå¤§å®¶å¯ä»¥çœ‹ä¸‹é¢çš„åˆ†æ</span></span><br><span class="line">                    Node&lt;K,V&gt; loHead = <span class="literal">null</span>, loTail = <span class="literal">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; hiHead = <span class="literal">null</span>, hiTail = <span class="literal">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; next;</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        next = e.next;</span><br><span class="line">                        <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (loTail == <span class="literal">null</span>)</span><br><span class="line">                                loHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                loTail.next = e;</span><br><span class="line">                            loTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (hiTail == <span class="literal">null</span>)</span><br><span class="line">                                hiHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hiTail.next = e;</span><br><span class="line">                            hiTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((e = next) != <span class="literal">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (loTail != <span class="literal">null</span>) &#123;</span><br><span class="line">                        loTail.next = <span class="literal">null</span>;</span><br><span class="line">                        newTab[j] = loHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (hiTail != <span class="literal">null</span>) &#123;</span><br><span class="line">                        hiTail.next = <span class="literal">null</span>;</span><br><span class="line">                        newTab[j + oldCap] = hiHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e79f4da6-a38b-4729-ab7b-06e2c986f535-4"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="remove">remove</h3><p>æ•´ä¸ªå‡½æ•°åˆ†æˆä¸€ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š</p><ul><li>å…ˆæ‰¾åˆ°è¦åˆ é™¤çš„èŠ‚ç‚¹ã€‚</li><li>åˆ é™¤æ‰¾åˆ°çš„èŠ‚ç‚¹ã€‚</li></ul><div class="tabs" id="893ebc87-56df-4723-a233-b33f7144b79e"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#893ebc87-56df-4723-a233-b33f7144b79e-1"><i class="fas fa-seedling"></i>remove</button></li><li class="tab"><button type="button" data-href="#893ebc87-56df-4723-a233-b33f7144b79e-2"><i class="fas fa-leaf"></i>removeNode</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="893ebc87-56df-4723-a233-b33f7144b79e-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">remove</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">return</span> (e = removeNode(hash(key), key, <span class="literal">null</span>, <span class="literal">false</span>, <span class="literal">true</span>)) == <span class="literal">null</span> ?</span><br><span class="line">        <span class="literal">null</span> : e.value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="893ebc87-56df-4723-a233-b33f7144b79e-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title function_">removeNode</span><span class="params">(<span class="type">int</span> hash, Object key, Object value,</span></span><br><span class="line"><span class="params">                           <span class="type">boolean</span> matchValue, <span class="type">boolean</span> movable)</span> &#123;</span><br><span class="line">    <span class="comment">// matchValue è¿™ä¸ªå‚æ•°å¦‚æœä¸º true è¡¨ç¤ºä¼ å…¥çš„å‚æ•° value</span></span><br><span class="line">    <span class="comment">// å’ŒæŸ¥æ‰¾åˆ°çš„æ•°æ®çš„ value ç›¸ç­‰æ‰è¿›è¡Œåˆ é™¤</span></span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="type">int</span> n, index;</span><br><span class="line">    <span class="comment">// å…ˆæ‰¾åˆ°èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (p = tab[index = (n - <span class="number">1</span>) &amp; hash]) != <span class="literal">null</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt; node = <span class="literal">null</span>, e; K k; V v;</span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            node = p;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((e = p.next) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                node = ((TreeNode&lt;K,V&gt;)p).getTreeNode(hash, key);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                        ((k = e.key) == key ||</span><br><span class="line">                         (key != <span class="literal">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                        node = e;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    p = e;</span><br><span class="line">                &#125; <span class="keyword">while</span> ((e = e.next) != <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ é™¤èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (node != <span class="literal">null</span> &amp;&amp; (!matchValue || (v = node.value) == value ||</span><br><span class="line">                             (value != <span class="literal">null</span> &amp;&amp; value.equals(v)))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (node <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                ((TreeNode&lt;K,V&gt;)node).removeTreeNode(<span class="built_in">this</span>, tab, movable);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (node == p)</span><br><span class="line">                tab[index] = node.next;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                p.next = node.next;</span><br><span class="line">            ++modCount;</span><br><span class="line">            --size;</span><br><span class="line">            afterNodeRemoval(node);</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="LinkedHashMap">LinkedHashMap</h2><p>LinkedHashMapæ˜¯HashMapçš„å­ç±»ï¼Œä¸LinkedHashMapç±»ä¼¼</p><ul><li><p>ç”±é”®å†³å®šï¼š<span class='p red'>æœ‰åº</span>ã€ä¸é‡å¤ã€æ— ç´¢å¼•ã€‚</p></li><li><p>è¿™é‡Œçš„æœ‰åºæŒ‡çš„æ˜¯ä¿è¯å­˜å‚¨å’Œå–å‡ºçš„å…ƒç´ é¡ºåºä¸€è‡´</p></li><li><p>åŸç†ï¼šåº•å±‚æ•°æ®ç»“æ„æ˜¯ä¾ç„¶å“ˆå¸Œè¡¨ï¼Œåªæ˜¯æ¯ä¸ªé”®å€¼å¯¹å…ƒç´ åˆé¢å¤–çš„å¤šäº†ä¸€ä¸ªåŒé“¾è¡¨çš„æœºåˆ¶è®°å½•å­˜å‚¨çš„é¡ºåºã€‚</p></li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230521133546661.png" alt="image-20230521133546661"></p><div class="tag link"><a class="link-card" title="LinkedHashSet" href="/posts/edc5fe5c.html#LinkedHashSet"><div class="left"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/favicon.png"/></div><div class="right"><p class="text">LinkedHashSet</p><p class="url">/posts/edc5fe5c.html#LinkedHashSet</p></div></a></div><hr><hr><h2 id="TreeMap">TreeMap</h2><ul><li><p>TreeMapè·ŸTreeSetåº•å±‚åŸç†ä¸€æ ·ï¼Œéƒ½æ˜¯çº¢é»‘æ ‘ç»“æ„çš„ã€‚</p></li><li><p>ç”±é”®å†³å®šç‰¹æ€§ï¼šä¸é‡å¤ã€æ— ç´¢å¼•ã€å¯æ’åº</p></li><li><p>å¯æ’åºï¼š<span class='p red'>å¯¹é”®è¿›è¡Œæ’åº</span>ã€‚</p></li><li><p>æ³¨æ„ï¼šé»˜è®¤æŒ‰ç…§é”®çš„ä»å°åˆ°å¤§è¿›è¡Œæ’åºï¼Œä¹Ÿå¯ä»¥è‡ªå·±è§„å®šé”®çš„æ’åºè§„åˆ™</p></li></ul><blockquote><p>æ¯”è¾ƒè§„åˆ™</p></blockquote><ul><li><p>å®ç°Comparableæ¥å£ï¼ŒæŒ‡å®šæ¯”è¾ƒè§„åˆ™ã€‚</p></li><li><p>åˆ›å»ºé›†åˆæ—¶ä¼ é€’Comparatoræ¯”è¾ƒå™¨å¯¹è±¡ï¼ŒæŒ‡å®šæ¯”è¾ƒè§„åˆ™ã€‚</p></li></ul><blockquote><p>TreeMapæ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œé”®æ˜¯å¦éœ€è¦é‡å†™hashCodeå’Œequalsæ–¹æ³•ï¼Ÿ</p></blockquote><p>æ­¤æ—¶æ˜¯ä¸éœ€è¦é‡å†™çš„</p><p>åœ¨Javaä¸­ï¼Œ<code>TreeMap</code> æ˜¯åŸºäºçº¢é»‘æ ‘å®ç°çš„ï¼Œå®ƒçš„å…ƒç´ æ’åºæ˜¯æ ¹æ® key çš„è‡ªç„¶é¡ºåºæˆ–è€…æ ¹æ®æä¾›çš„æ¯”è¾ƒå™¨ï¼ˆ<code>Comparator</code>ï¼‰æ¥å®ç°çš„ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨ <code>TreeMap</code> æ—¶ï¼Œæ— éœ€é‡å†™ key çš„ <code>hashCode</code> å’Œ <code>equals</code> æ–¹æ³•ã€‚ç›¸åï¼Œä½ éœ€è¦ç¡®ä¿ key ç±»å®ç°äº† <code>Comparable</code> æ¥å£æˆ–è€…å‘ <code>TreeMap</code> æä¾›ä¸€ä¸ª <code>Comparator</code> å®ä¾‹ã€‚</p><hr><h3 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.åˆ›å»ºé›†åˆå¯¹è±¡</span></span><br><span class="line">TreeMap&lt;Integer, String&gt; treeMap = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;(((o1, o2) -&gt; o2 - o1));</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.æ·»åŠ å…ƒç´ </span></span><br><span class="line">treeMap.put(<span class="number">1</span>,<span class="string">&quot;å¥¥åˆ©å¥¥&quot;</span>);</span><br><span class="line">treeMap.put(<span class="number">2</span>,<span class="string">&quot;é›ªç¢§&quot;</span>);</span><br><span class="line">treeMap.put(<span class="number">3</span>,<span class="string">&quot;å…­ä¸ªæ ¸æ¡ƒ&quot;</span>);</span><br><span class="line">treeMap.put(<span class="number">4</span>,<span class="string">&quot;åº·å¸ˆå‚…&quot;</span>);</span><br><span class="line">treeMap.put(<span class="number">5</span>,<span class="string">&quot;å¯å£å¯ä¹&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.éå†å…ƒç´ </span></span><br><span class="line">treeMap.forEach((k,v)-&gt;&#123;</span><br><span class="line">    System.out.println(k+<span class="string">&quot;=&quot;</span>+v);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><p>5=å¯å£å¯ä¹<br>4=åº·å¸ˆå‚…<br>3=å…­ä¸ªæ ¸æ¡ƒ<br>2=é›ªç¢§<br>1=å¥¥åˆ©å¥¥</p><hr><h3 id="åº•å±‚åŸç†">åº•å±‚åŸç†</h3><blockquote><p>TreeMapä¸­æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„å†…éƒ¨å±æ€§</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">K key;<span class="comment">//é”®</span></span><br><span class="line">V value;<span class="comment">//å€¼</span></span><br><span class="line">Entry&lt;K,V&gt; left;<span class="comment">//å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">Entry&lt;K,V&gt; right;<span class="comment">//å³å­èŠ‚ç‚¹</span></span><br><span class="line">Entry&lt;K,V&gt; parent;<span class="comment">//çˆ¶èŠ‚ç‚¹</span></span><br><span class="line"><span class="type">boolean</span> color;<span class="comment">//èŠ‚ç‚¹çš„é¢œè‰²</span></span><br></pre></td></tr></table></figure><blockquote><p>TreeMapç±»ä¸­ä¸­è¦çŸ¥é“çš„ä¸€äº›æˆå‘˜å˜é‡å’Œæ–¹æ³•</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TreeMap</span>&lt;K,V&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ¯”è¾ƒå™¨å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Comparator&lt;? <span class="built_in">super</span> K&gt; comparator;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Entry&lt;K,V&gt; root;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é›†åˆçš„é•¿åº¦</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç©ºå‚æ„é€ å°±æ˜¯æ²¡æœ‰ä¼ é€’æ¯”è¾ƒå™¨å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TreeMap</span><span class="params">()</span> &#123;</span><br><span class="line">        comparator = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¸¦å‚æ„é€ å°±æ˜¯ä¼ é€’äº†æ¯”è¾ƒå™¨å¯¹è±¡ã€‚</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TreeMap</span><span class="params">(Comparator&lt;? <span class="built_in">super</span> K&gt; comparator)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.comparator = comparator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> put(key, value, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><mark class="hl-label blue">æ·»åŠ å…ƒç´ è¿‡ç¨‹</mark> <div class="tabs" id="5bf345b5-27ff-4798-bc80-e63b974c626f"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#5bf345b5-27ff-4798-bc80-e63b974c626f-1"><i class="fas fa-seedling"></i>put</button></li><li class="tab"><button type="button" data-href="#5bf345b5-27ff-4798-bc80-e63b974c626f-2"><i class="fas fa-leaf"></i>put</button></li><li class="tab"><button type="button" data-href="#5bf345b5-27ff-4798-bc80-e63b974c626f-3"><i class="fab fa-apple"></i>addEntry</button></li><li class="tab"><button type="button" data-href="#5bf345b5-27ff-4798-bc80-e63b974c626f-4"><i class="fas fa-tree"></i>fixAfterInsertion</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="5bf345b5-27ff-4798-bc80-e63b974c626f-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> put(key, value, <span class="literal">true</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5bf345b5-27ff-4798-bc80-e63b974c626f-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> V <span class="title function_">put</span><span class="params">(K key, V value, <span class="type">boolean</span> replaceOld)</span> &#123;</span><br><span class="line">    <span class="comment">//è·å–æ ¹èŠ‚ç‚¹çš„åœ°å€å€¼ï¼Œèµ‹å€¼ç»™å±€éƒ¨å˜é‡t</span></span><br><span class="line">    Entry&lt;K,V&gt; t = root;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ ¹èŠ‚ç‚¹æ˜¯å¦ä¸ºnull</span></span><br><span class="line">    <span class="comment">//å¦‚æœä¸ºnullï¼Œè¡¨ç¤ºå½“å‰æ˜¯ç¬¬ä¸€æ¬¡æ·»åŠ ï¼Œä¼šæŠŠå½“å‰è¦æ·»åŠ çš„å…ƒç´ ï¼Œå½“åšæ ¹èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">//å¦‚æœä¸ä¸ºnullï¼Œè¡¨ç¤ºå½“å‰ä¸æ˜¯ç¬¬ä¸€æ¬¡æ·»åŠ ï¼Œè·³è¿‡è¿™ä¸ªåˆ¤æ–­ç»§ç»­æ‰§è¡Œä¸‹é¢çš„ä»£ç </span></span><br><span class="line">    <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//æ–¹æ³•çš„åº•å±‚ï¼Œä¼šåˆ›å»ºä¸€ä¸ªEntryå¯¹è±¡ï¼ŒæŠŠä»–å½“åšæ ¹èŠ‚ç‚¹</span></span><br><span class="line">        addEntryToEmptyMap(key, value);</span><br><span class="line">        <span class="comment">//è¡¨ç¤ºæ­¤æ—¶æ²¡æœ‰è¦†ç›–ä»»ä½•çš„å…ƒç´ </span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¡¨ç¤ºä¸¤ä¸ªå…ƒç´ çš„é”®æ¯”è¾ƒä¹‹åçš„ç»“æœ</span></span><br><span class="line">    <span class="type">int</span> cmp;</span><br><span class="line">    <span class="comment">//è¡¨ç¤ºå½“å‰è¦æ·»åŠ èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">    Entry&lt;K,V&gt; parent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¡¨ç¤ºå½“å‰çš„æ¯”è¾ƒè§„åˆ™</span></span><br><span class="line">    <span class="comment">//å¦‚æœæˆ‘ä»¬æ˜¯é‡‡å–é»˜è®¤çš„è‡ªç„¶æ’åºï¼Œé‚£ä¹ˆæ­¤æ—¶comparatorè®°å½•çš„æ˜¯nullï¼Œcprè®°å½•çš„ä¹Ÿæ˜¯null</span></span><br><span class="line">    <span class="comment">//å¦‚æœæˆ‘ä»¬æ˜¯é‡‡å–æ¯”è¾ƒå»æ’åºæ–¹å¼ï¼Œé‚£ä¹ˆæ­¤æ—¶comparatorè®°å½•çš„æ˜¯å°±æ˜¯æ¯”è¾ƒå™¨</span></span><br><span class="line">    Comparator&lt;? <span class="built_in">super</span> K&gt; cpr = comparator;</span><br><span class="line">    <span class="comment">//è¡¨ç¤ºåˆ¤æ–­å½“å‰æ˜¯å¦æœ‰æ¯”è¾ƒå™¨å¯¹è±¡</span></span><br><span class="line">    <span class="comment">//å¦‚æœä¼ é€’äº†æ¯”è¾ƒå™¨å¯¹è±¡ï¼Œå°±æ‰§è¡Œifé‡Œé¢çš„ä»£ç ï¼Œæ­¤æ—¶ä»¥æ¯”è¾ƒå™¨çš„è§„åˆ™ä¸ºå‡†</span></span><br><span class="line">    <span class="comment">//å¦‚æœæ²¡æœ‰ä¼ é€’æ¯”è¾ƒå™¨å¯¹è±¡ï¼Œå°±æ‰§è¡Œelseé‡Œé¢çš„ä»£ç ï¼Œæ­¤æ—¶ä»¥è‡ªç„¶æ’åºçš„è§„åˆ™ä¸ºå‡†</span></span><br><span class="line">    <span class="keyword">if</span> (cpr != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            parent = t;</span><br><span class="line">            cmp = cpr.compare(key, t.key);</span><br><span class="line">            <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>)</span><br><span class="line">                t = t.left;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>)</span><br><span class="line">                t = t.right;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> t.value;</span><br><span class="line">                <span class="keyword">if</span> (replaceOld || oldValue == <span class="literal">null</span>) &#123;</span><br><span class="line">                    t.value = value;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> oldValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (t != <span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//æŠŠé”®è¿›è¡Œå¼ºè½¬ï¼Œå¼ºè½¬æˆComparableç±»å‹çš„</span></span><br><span class="line">        <span class="comment">//è¦æ±‚ï¼šé”®å¿…é¡»è¦å®ç°Comparableæ¥å£ï¼Œå¦‚æœæ²¡æœ‰å®ç°è¿™ä¸ªæ¥å£</span></span><br><span class="line">        <span class="comment">//æ­¤æ—¶åœ¨å¼ºè½¬çš„æ—¶å€™ï¼Œå°±ä¼šæŠ¥é”™ã€‚</span></span><br><span class="line">        Comparable&lt;? <span class="built_in">super</span> K&gt; k = (Comparable&lt;? <span class="built_in">super</span> K&gt;) key;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">//æŠŠæ ¹èŠ‚ç‚¹å½“åšå½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">            parent = t;</span><br><span class="line">            <span class="comment">//è°ƒç”¨compareToæ–¹æ³•ï¼Œæ¯”è¾ƒæ ¹èŠ‚ç‚¹å’Œå½“å‰è¦æ·»åŠ èŠ‚ç‚¹çš„å¤§å°å…³ç³»</span></span><br><span class="line">            cmp = k.compareTo(t.key);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="comment">//å¦‚æœæ¯”è¾ƒçš„ç»“æœä¸ºè´Ÿæ•°</span></span><br><span class="line">                <span class="comment">//é‚£ä¹ˆç»§ç»­åˆ°æ ¹èŠ‚ç‚¹çš„å·¦è¾¹å»æ‰¾</span></span><br><span class="line">                t = t.left;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>)</span><br><span class="line">                <span class="comment">//å¦‚æœæ¯”è¾ƒçš„ç»“æœä¸ºæ­£æ•°</span></span><br><span class="line">                <span class="comment">//é‚£ä¹ˆç»§ç»­åˆ°æ ¹èŠ‚ç‚¹çš„å³è¾¹å»æ‰¾</span></span><br><span class="line">                t = t.right;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//å¦‚æœæ¯”è¾ƒçš„ç»“æœä¸º0ï¼Œä¼šè¦†ç›–</span></span><br><span class="line">                <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> t.value;</span><br><span class="line">                <span class="keyword">if</span> (replaceOld || oldValue == <span class="literal">null</span>) &#123;</span><br><span class="line">                    t.value = value;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> oldValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (t != <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å°±ä¼šæŠŠå½“å‰èŠ‚ç‚¹æŒ‰ç…§æŒ‡å®šçš„è§„åˆ™è¿›è¡Œæ·»åŠ </span></span><br><span class="line">    addEntry(key, value, parent, cmp &lt; <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5bf345b5-27ff-4798-bc80-e63b974c626f-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addEntry</span><span class="params">(K key, V value, Entry&lt;K, V&gt; parent, <span class="type">boolean</span> addToLeft)</span> &#123;</span><br><span class="line">    Entry&lt;K,V&gt; e = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(key, value, parent);</span><br><span class="line">    <span class="keyword">if</span> (addToLeft)</span><br><span class="line">        parent.left = e;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        parent.right = e;</span><br><span class="line">    <span class="comment">//æ·»åŠ å®Œæ¯•ä¹‹åï¼Œéœ€è¦æŒ‰ç…§çº¢é»‘æ ‘çš„è§„åˆ™è¿›è¡Œè°ƒæ•´</span></span><br><span class="line">    fixAfterInsertion(e);</span><br><span class="line">    size++;</span><br><span class="line">    modCount++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5bf345b5-27ff-4798-bc80-e63b974c626f-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fixAfterInsertion</span><span class="params">(Entry&lt;K,V&gt; x)</span> &#123;</span><br><span class="line">    <span class="comment">//å› ä¸ºçº¢é»‘æ ‘çš„èŠ‚ç‚¹é»˜è®¤å°±æ˜¯çº¢è‰²çš„</span></span><br><span class="line">    x.color = RED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æŒ‰ç…§çº¢é»‘è§„åˆ™è¿›è¡Œè°ƒæ•´</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//parentOf:è·å–xçš„çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">//parentOf(parentOf(x)):è·å–xçš„çˆ·çˆ·èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">//leftOf:è·å–å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">while</span> (x != <span class="literal">null</span> &amp;&amp; x != root &amp;&amp; x.parent.color == RED) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æ˜¯çˆ·çˆ·èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹è¿˜æ˜¯å³å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">//ç›®çš„ï¼šä¸ºäº†è·å–å½“å‰èŠ‚ç‚¹çš„å”å”èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (parentOf(x) == leftOf(parentOf(parentOf(x)))) &#123;</span><br><span class="line">            <span class="comment">//è¡¨ç¤ºå½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æ˜¯çˆ·çˆ·èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">            <span class="comment">//é‚£ä¹ˆä¸‹é¢å°±å¯ä»¥ç”¨rightOfè·å–åˆ°å½“å‰èŠ‚ç‚¹çš„å”å”èŠ‚ç‚¹</span></span><br><span class="line">            Entry&lt;K,V&gt; y = rightOf(parentOf(parentOf(x)));</span><br><span class="line">            <span class="keyword">if</span> (colorOf(y) == RED) &#123;</span><br><span class="line">                <span class="comment">//å”å”èŠ‚ç‚¹ä¸ºçº¢è‰²çš„å¤„ç†æ–¹æ¡ˆ</span></span><br><span class="line">                <span class="comment">//æŠŠçˆ¶èŠ‚ç‚¹è®¾ç½®ä¸ºé»‘è‰²</span></span><br><span class="line">                setColor(parentOf(x), BLACK);</span><br><span class="line">                <span class="comment">//æŠŠå”å”èŠ‚ç‚¹è®¾ç½®ä¸ºé»‘è‰²</span></span><br><span class="line">                setColor(y, BLACK);</span><br><span class="line">                <span class="comment">//æŠŠçˆ·çˆ·èŠ‚ç‚¹è®¾ç½®ä¸ºçº¢è‰²</span></span><br><span class="line">                setColor(parentOf(parentOf(x)), RED);</span><br><span class="line">                <span class="comment">//æŠŠçˆ·çˆ·èŠ‚ç‚¹è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹</span></span><br><span class="line">                x = parentOf(parentOf(x));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//å”å”èŠ‚ç‚¹ä¸ºé»‘è‰²çš„å¤„ç†æ–¹æ¡ˆ</span></span><br><span class="line">                <span class="comment">//è¡¨ç¤ºåˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºçˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> (x == rightOf(parentOf(x))) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//è¡¨ç¤ºå½“å‰èŠ‚ç‚¹æ˜¯çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹</span></span><br><span class="line">                    x = parentOf(x);</span><br><span class="line">                    <span class="comment">//å·¦æ—‹</span></span><br><span class="line">                    rotateLeft(x);</span><br><span class="line">                &#125;</span><br><span class="line">                setColor(parentOf(x), BLACK);</span><br><span class="line">                setColor(parentOf(parentOf(x)), RED);</span><br><span class="line">                rotateRight(parentOf(parentOf(x)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//è¡¨ç¤ºå½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æ˜¯çˆ·çˆ·èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹</span></span><br><span class="line">            <span class="comment">//é‚£ä¹ˆä¸‹é¢å°±å¯ä»¥ç”¨leftOfè·å–åˆ°å½“å‰èŠ‚ç‚¹çš„å”å”èŠ‚ç‚¹</span></span><br><span class="line">            Entry&lt;K,V&gt; y = leftOf(parentOf(parentOf(x)));</span><br><span class="line">            <span class="keyword">if</span> (colorOf(y) == RED) &#123;</span><br><span class="line">                setColor(parentOf(x), BLACK);</span><br><span class="line">                setColor(y, BLACK);</span><br><span class="line">                setColor(parentOf(parentOf(x)), RED);</span><br><span class="line">                x = parentOf(parentOf(x));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (x == leftOf(parentOf(x))) &#123;</span><br><span class="line">                    x = parentOf(x);</span><br><span class="line">                    rotateRight(x);</span><br><span class="line">                &#125;</span><br><span class="line">                setColor(parentOf(x), BLACK);</span><br><span class="line">                setColor(parentOf(parentOf(x)), RED);</span><br><span class="line">                rotateLeft(parentOf(parentOf(x)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æŠŠæ ¹èŠ‚ç‚¹è®¾ç½®ä¸ºé»‘è‰²</span></span><br><span class="line">    root.color = BLACK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="æ€è€ƒé¢˜">æ€è€ƒé¢˜</h3><blockquote><p>TreeMapæ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œé”®æ˜¯å¦éœ€è¦é‡å†™hashCodeå’Œequalsæ–¹æ³•ï¼Ÿ</p></blockquote><p>æ­¤æ—¶æ˜¯ä¸éœ€è¦é‡å†™çš„</p><p>åœ¨Javaä¸­ï¼Œ<code>TreeMap</code> æ˜¯åŸºäºçº¢é»‘æ ‘å®ç°çš„ï¼Œå®ƒçš„å…ƒç´ æ’åºæ˜¯æ ¹æ® key çš„è‡ªç„¶é¡ºåºæˆ–è€…æ ¹æ®æä¾›çš„æ¯”è¾ƒå™¨ï¼ˆ<code>Comparator</code>ï¼‰æ¥å®ç°çš„ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨ <code>TreeMap</code> æ—¶ï¼Œæ— éœ€é‡å†™ key çš„ <code>hashCode</code> å’Œ <code>equals</code> æ–¹æ³•ã€‚ç›¸åï¼Œä½ éœ€è¦ç¡®ä¿ key ç±»å®ç°äº† <code>Comparable</code> æ¥å£æˆ–è€…å‘ <code>TreeMap</code> æä¾›ä¸€ä¸ª <code>Comparator</code> å®ä¾‹ã€‚</p><blockquote><p>HashMapæ˜¯å“ˆå¸Œè¡¨ç»“æ„çš„ï¼ŒJDK8å¼€å§‹ç”±æ•°ç»„ï¼Œé“¾è¡¨ï¼Œçº¢é»‘æ ‘ç»„æˆçš„ï¼Œæ—¢ç„¶æœ‰çº¢é»‘æ ‘ï¼ŒHashMapçš„é”®æ˜¯å¦éœ€è¦å®ç°Compareableæ¥å£æˆ–è€…ä¼ é€’æ¯”è¾ƒå™¨å¯¹è±¡å‘¢ï¼Ÿ</p></blockquote><p>ä¸éœ€è¦çš„ã€‚</p><p>å› ä¸ºåœ¨HashMapçš„åº•å±‚ï¼Œé»˜è®¤æ˜¯åˆ©ç”¨å“ˆå¸Œå€¼çš„å¤§å°å…³ç³»æ¥åˆ›å»ºçº¢é»‘æ ‘çš„</p><blockquote><p>TreeMapå’ŒHashMapè°çš„æ•ˆç‡æ›´é«˜ï¼Ÿ</p></blockquote><p>å¦‚æœæ˜¯æœ€åæƒ…å†µï¼Œæ·»åŠ äº†8ä¸ªå…ƒç´ ï¼Œè¿™8ä¸ªå…ƒç´ å½¢æˆäº†é“¾è¡¨ï¼Œæ­¤æ—¶TreeMapçš„æ•ˆç‡è¦æ›´é«˜</p><p>ä½†æ˜¯è¿™ç§æƒ…å†µå‡ºç°çš„å‡ ç‡éå¸¸çš„å°‘ã€‚</p><p>ä¸€èˆ¬è€Œè¨€ï¼Œè¿˜æ˜¯HashMapçš„æ•ˆç‡è¦æ›´é«˜ã€‚</p><blockquote><p>ä½ è§‰å¾—åœ¨Mapé›†åˆä¸­ï¼Œjavaä¼šæä¾›ä¸€ä¸ªå¦‚æœé”®é‡å¤äº†ï¼Œä¸ä¼šè¦†ç›–çš„putæ–¹æ³•å‘¢ï¼Ÿ</p></blockquote><p>putIfAbsent</p><p>ä¼ é€’ä¸€ä¸ªæ€æƒ³ï¼š</p><p>â€‹    ä»£ç ä¸­çš„é€»è¾‘éƒ½æœ‰ä¸¤é¢æ€§ï¼Œå¦‚æœæˆ‘ä»¬åªçŸ¥é“äº†å…¶ä¸­çš„Aé¢ï¼Œè€Œä¸”ä»£ç ä¸­è¿˜å‘ç°äº†æœ‰å˜é‡å¯ä»¥æ§åˆ¶ä¸¤é¢æ€§çš„å‘ç”Ÿã€‚</p><p>â€‹    é‚£ä¹ˆè¯¥é€»è¾‘ä¸€å®šä¼šæœ‰Bé¢ã€‚</p><p>â€‹    ä¹ æƒ¯ï¼š</p><p>â€‹        booleanç±»å‹çš„å˜é‡æ§åˆ¶ï¼Œä¸€èˆ¬åªæœ‰ABä¸¤é¢ï¼Œå› ä¸ºbooleanåªæœ‰ä¸¤ä¸ªå€¼</p><p>â€‹        intç±»å‹çš„å˜é‡æ§åˆ¶ï¼Œä¸€èˆ¬è‡³å°‘æœ‰ä¸‰é¢ï¼Œå› ä¸ºintå¯ä»¥å–å¤šä¸ªå€¼ã€‚</p><p>â€‹</p><blockquote><p>ä¸‰ç§åŒåˆ—é›†åˆï¼Œä»¥åå¦‚ä½•é€‰æ‹©ï¼Ÿ</p></blockquote><p>â€‹    HashMap LinkedHashMap TreeMap</p><p>â€‹    é»˜è®¤ï¼šHashMapï¼ˆæ•ˆç‡æœ€é«˜ï¼‰</p><p>â€‹    å¦‚æœè¦ä¿è¯å­˜å–æœ‰åºï¼šLinkedHashMap</p><p>â€‹    å¦‚æœè¦è¿›è¡Œæ’åºï¼šTreeMap</p>]]></content>
    
    
    <summary type="html">HashMapã€TreeMapè§£æ</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/tags/Java/"/>
    
    <category term="å®¹å™¨" scheme="https://wuwawawa.github.io/tags/%E5%AE%B9%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>åŒåˆ—é›†åˆæ¥å£Map</title>
    <link href="https://wuwawawa.github.io/posts/eee6e16.html"/>
    <id>https://wuwawawa.github.io/posts/eee6e16.html</id>
    <published>2023-05-22T08:08:46.000Z</published>
    <updated>2023-05-22T09:56:58.464Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Mapç»§æ‰¿ä½“ç³»">Mapç»§æ‰¿ä½“ç³»</h2><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230522164255312.png" alt="image-20230522164255312" style="zoom:67%;" /><p>åŒåˆ—é›†åˆçš„ç‰¹ç‚¹</p><p>â‘  åŒåˆ—é›†åˆä¸€æ¬¡éœ€è¦å­˜ä¸€å¯¹æ•°æ®ï¼Œåˆ†åˆ«ä¸ºé”®å’Œå€¼</p><p>â‘¡ é”®ä¸èƒ½é‡å¤ï¼Œå€¼å¯ä»¥é‡å¤</p><p>â‘¢ é”®å’Œå€¼æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œæ¯ä¸€ä¸ªé”®åªèƒ½æ‰¾åˆ°è‡ªå·±å¯¹åº”çš„å€¼</p><p>â‘£ é”®+å€¼è¿™ä¸ªæ•´ä½“æˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œé”®å€¼å¯¹â€æˆ–è€…â€œé”®å€¼å¯¹å¯¹è±¡â€ï¼Œåœ¨Javaä¸­å«åš â€œEntryå¯¹è±¡â€</p><hr><hr><h2 id="Mapæ¥å£å¸¸è§æ–¹æ³•">Mapæ¥å£å¸¸è§æ–¹æ³•</h2><p>Mapæ˜¯åŒåˆ—é›†åˆçš„é¡¶å±‚æ¥å£ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯å…¨éƒ¨åŒåˆ—é›†åˆéƒ½å¯ä»¥ç»§æ‰¿ä½¿ç”¨çš„</p><p>å¾€Mapé›†åˆä¸­æ·»åŠ keyå·²ç»å­˜åœ¨çš„æ–°é”®å€¼å¯¹ï¼Œä¼šè¦†ç›–åŸæ¥çš„é”®å€¼å¯¹ã€‚</p><table><thead><tr><th style="text-align:left">æ–¹æ³•åç§°</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left"><code>V put(K key, V value)</code></td><td style="text-align:left">æ·»åŠ å…ƒç´ </td></tr><tr><td style="text-align:left"><code>V remove(Object key)</code></td><td style="text-align:left">æ ¹æ®é”®åˆ é™¤é”®å€¼å¯¹å…ƒç´ </td></tr><tr><td style="text-align:left"><code>V get(Object key)</code></td><td style="text-align:left">æ ¹æ®keyè·å–value</td></tr><tr><td style="text-align:left"><code>V getOrDefault(Object key, V defaultValue)</code></td><td style="text-align:left">æ ¹æ®keyè·å–valueï¼Œå¸¦é»˜è®¤å€¼</td></tr><tr><td style="text-align:left"><code>void clear()</code></td><td style="text-align:left">ç§»é™¤æ‰€æœ‰çš„é”®å€¼å¯¹å…ƒç´ </td></tr><tr><td style="text-align:left"><code>boolean containsKey(Object key)</code></td><td style="text-align:left">åˆ¤æ–­é›†åˆæ˜¯å¦åŒ…å«æŒ‡å®šçš„é”®</td></tr><tr><td style="text-align:left"><code>boolean containsValue(Object value)</code></td><td style="text-align:left">åˆ¤æ–­é›†åˆæ˜¯å¦åŒ…å«æŒ‡å®šçš„å€¼</td></tr><tr><td style="text-align:left"><code>boolean isEmpty()</code></td><td style="text-align:left">åˆ¤æ–­é›†åˆæ˜¯å¦ä¸ºç©º</td></tr><tr><td style="text-align:left"><code>int size()</code></td><td style="text-align:left">é›†åˆçš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯é›†åˆä¸­é”®å€¼å¯¹çš„ä¸ªæ•°</td></tr><tr><td style="text-align:left"><code>void putAll(Map&lt;? extends K, ? extends V&gt; m)</code></td><td style="text-align:left">æ·»åŠ å¤šä¸ªé”®å€¼å¯¹</td></tr><tr><td style="text-align:left"><code>Set&lt;K&gt; keySet()</code></td><td style="text-align:left">è¿”å›ä¸€ä¸ªåŒ…å«æ‰€æœ‰keyå…ƒç´ çš„Seté›†åˆ</td></tr><tr><td style="text-align:left"><code>Collection&lt;V&gt; values()</code></td><td style="text-align:left">è¿”å›ä¸€ä¸ªåŒ…å«æ‰€æœ‰valueå…ƒç´ çš„Collectioné›†åˆ</td></tr><tr><td style="text-align:left"><code>Set&lt;Map.Entry&lt;K, V&gt;&gt; entrySet()</code></td><td style="text-align:left">è¿”å›Mapé›†åˆä¸­æ‰€æœ‰é”®å€¼å¯¹çš„ä¸€ä¸ªSeté›†åˆ</td></tr><tr><td style="text-align:left"><code>void forEach(BiConsumer&lt;? super K, ? super V&gt; action)</code></td><td style="text-align:left">ç»“åˆlambdaéå†é›†åˆ</td></tr></tbody></table><blockquote><p>æ·»åŠ å…ƒç´ V put(K key, V value)</p></blockquote><p>åœ¨æ·»åŠ æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœé”®ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆç›´æŒ‰æŠŠé”®å€¼å¯¹å¯¹è±¡æ·»åŠ åˆ°mapé›†åˆå½“ä¸­ï¼Œæ–¹æ³•è¿”å›nullã€‚</p><p>åœ¨æ·»åŠ æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœå¥æ˜¯å­˜åœ¨çš„ï¼Œé‚£ä¹ˆä¼šæŠŠåŸæœ‰çš„é”®å€¼å¯¹å¯¹è±¡è¦†ç›–ã€‚ä¼šæŠŠè¢«è¦†ç›–çš„å€¼è¿›è¡Œè¿”å›ã€‚</p><hr><hr><h2 id="Mapéå†æ–¹å¼">Mapéå†æ–¹å¼</h2><div class="tabs" id="cc6a501f-d013-469f-bffd-54511506df74"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#cc6a501f-d013-469f-bffd-54511506df74-1"><i class="fas fa-cat"></i>é”®æ‰¾å€¼</button></li><li class="tab"><button type="button" data-href="#cc6a501f-d013-469f-bffd-54511506df74-2"><i class="fas fa-horse"></i>é”®å€¼å¯¹</button></li><li class="tab"><button type="button" data-href="#cc6a501f-d013-469f-bffd-54511506df74-3"><i class="fas fa-dove"></i>Lambdaè¡¨è¾¾å¼</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="cc6a501f-d013-469f-bffd-54511506df74-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.åˆ›å»ºMapé›†åˆçš„å¯¹è±¡</span></span><br><span class="line">HashMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.æ·»åŠ å…ƒç´ </span></span><br><span class="line">map.put(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;2&quot;</span>,<span class="string">&quot;22&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;3&quot;</span>,<span class="string">&quot;333&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.é€šè¿‡é”®æ‰¾å€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//3.1è·å–æ‰€æœ‰çš„é”®</span></span><br><span class="line">Set&lt;String&gt; keySet = map.keySet();</span><br><span class="line"><span class="comment">//3.2éå†å•åˆ—é›†åˆï¼Œè·å–value</span></span><br><span class="line"><span class="keyword">for</span> (String key : keySet) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">    System.out.println(<span class="string">&quot;key = &quot;</span> + key);</span><br><span class="line">    System.out.println(<span class="string">&quot;value = &quot;</span> + value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>key = 1<br>value = 1<br>key = 2<br>value = 22<br>key = 3<br>value = 333</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cc6a501f-d013-469f-bffd-54511506df74-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.åˆ›å»ºMapé›†åˆçš„å¯¹è±¡</span></span><br><span class="line">HashMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.æ·»åŠ å…ƒç´ </span></span><br><span class="line">map.put(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;2&quot;</span>,<span class="string">&quot;22&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;3&quot;</span>,<span class="string">&quot;333&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.é€šè¿‡é”®å€¼å¯¹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//3.1è·å–æ‰€æœ‰çš„é”®å€¼å¯¹</span></span><br><span class="line">Set&lt;Map.Entry&lt;String, String&gt;&gt; entrySet = map.entrySet();</span><br><span class="line"><span class="comment">//3.2éå†å•åˆ—é›†åˆï¼Œè·å–keyå’Œvalue</span></span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : entrySet) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">    System.out.println(<span class="string">&quot;key = &quot;</span> + key);</span><br><span class="line">    System.out.println(<span class="string">&quot;value = &quot;</span> + value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cc6a501f-d013-469f-bffd-54511506df74-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.åˆ›å»ºMapé›†åˆçš„å¯¹è±¡</span></span><br><span class="line">HashMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.æ·»åŠ å…ƒç´ </span></span><br><span class="line">map.put(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;2&quot;</span>,<span class="string">&quot;22&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;3&quot;</span>,<span class="string">&quot;333&quot;</span>);</span><br><span class="line"></span><br><span class="line">map.forEach((key,value)-&gt;&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;key = &quot;</span> + key);</span><br><span class="line">    System.out.println(<span class="string">&quot;value = &quot;</span> + value);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="Map-Entryè¯´æ˜">Map.Entryè¯´æ˜</h2><p>Mapæ˜¯javaä¸­çš„æ¥å£ï¼Œ<code>Map.Entry</code>æ˜¯Mapçš„ä¸€ä¸ªå†…éƒ¨æ¥å£ã€‚ç‚¹è¿›Mapä¸­ï¼Œåœ¨æºç 375è¡Œçš„ä½ç½®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Entry</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">        K <span class="title function_">getKey</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">        V <span class="title function_">getValue</span><span class="params">()</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Mapæä¾›äº†ä¸€äº›å¸¸ç”¨æ–¹æ³•ï¼Œå¦‚<code>keySet()</code>ã€<code>entrySet()</code>ç­‰æ–¹æ³•ï¼Œ<code>keySet()</code>æ–¹æ³•è¿”å›å€¼æ˜¯Mapä¸­keyå€¼çš„é›†åˆï¼›<code>entrySet()</code>çš„è¿”å›å€¼ä¹Ÿæ˜¯è¿”å›ä¸€ä¸ªSeté›†åˆï¼Œæ­¤é›†åˆçš„ç±»å‹ä¸º<code>Map.Entry</code>ã€‚</p><p><code>Map.Entry</code>æ˜¯Mapå£°æ˜çš„ä¸€ä¸ªå†…éƒ¨æ¥å£ï¼Œæ­¤æ¥å£ä¸ºæ³›å‹æ¥å£ï¼Œå®šä¹‰ä¸º<code>Entry&lt;K,V&gt;</code>ã€‚å®ƒè¡¨ç¤ºMapä¸­çš„ä¸€ä¸ªå®ä½“ï¼ˆä¸€ä¸ªkey-valueå¯¹ï¼‰ã€‚æ¥å£ä¸­æœ‰getKey(),getValueæ–¹æ³•ã€‚</p><blockquote><p>Map.Entryä½¿ç”¨</p></blockquote><p>é€šå¸¸æ˜¯éå†æ—¶ä¼šä½¿ç”¨å®ƒï¼ŒMapå¹¶æ²¡ç”¨ç»§æ‰¿Collectionæ¥å£ï¼Œå¹¶ä¸èƒ½ä½¿ç”¨è¿­ä»£å™¨éå†ã€‚</p><p>ä»¥å‰ï¼Œæˆ‘ä»¬ä¾¿åˆ©ä¸€ä¸ªMapé›†åˆæ—¶ï¼Œéœ€è¦è·å–keyçš„å€¼ï¼Œç„¶åå†è·å–valueçš„å€¼ï¼Œç¨å¾®æœ‰äº¿ç‚¹ç‚¹éº»çƒ¦ï¼Œéº»çƒ¦è¿˜æ˜¯æ¬¡è¦çš„ï¼Œä¸»è¦æ˜¯ä»Mapä¸­å–å¾—å…³é”®å­—ä¹‹åï¼Œæˆ‘ä»¬å¿…é¡»æ¯æ¬¡é‡å¤è¿”å›åˆ°Mapä¸­å–å¾—ç›¸å¯¹çš„å€¼ï¼Œè¿™æ˜¯å¾ˆç¹çå’Œè´¹æ—¶çš„ã€‚å¹¸è¿çš„æ˜¯ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæ›´åŠ ç®€å•çš„é€”å¾„ã€‚Mapç±»æä¾›äº†ä¸€ä¸ªç§°ä¸ºentrySet()çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ª<code>Set&lt;Map.Entry&lt;K, V&gt;&gt;</code>ã€‚æ¥ç€ï¼Œ<code>Map.Entry</code>ç±»æä¾›äº†ä¸€ä¸ª<code>getKey()</code>æ–¹æ³•å’Œä¸€ä¸ª<code>getValue()</code>æ–¹æ³•ï¼Œå› æ­¤ï¼Œä¸Šé¢çš„ä»£ç å¯ä»¥è¢«ç»„ç»‡å¾—æ›´ç¬¦åˆé€»è¾‘ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;Integer, Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">map.put(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">map.put(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">map.put(<span class="number">5</span>,<span class="number">6</span>);</span><br><span class="line">map.put(<span class="number">7</span>,<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">Set&lt;Map.Entry&lt;Integer, Integer&gt;&gt; entrySet = map.entrySet();</span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;Integer, Integer&gt; next : entrySet) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">key</span> <span class="operator">=</span> next.getKey();</span><br><span class="line">    <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> next.getValue();</span><br><span class="line">    System.out.println(<span class="string">&quot;key = &quot;</span> + key);</span><br><span class="line">    System.out.println(<span class="string">&quot;value = &quot;</span> + value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Mapç»§æ‰¿ä½“ç³»ã€æ¥å£æ–¹æ³•ã€éå†æ–¹å¼</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/tags/Java/"/>
    
    <category term="å®¹å™¨" scheme="https://wuwawawa.github.io/tags/%E5%AE%B9%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>å †PriorityQueueå’ŒArrayDeque</title>
    <link href="https://wuwawawa.github.io/posts/c320ea51.html"/>
    <id>https://wuwawawa.github.io/posts/c320ea51.html</id>
    <published>2023-05-22T00:21:06.000Z</published>
    <updated>2023-05-23T12:27:33.433Z</updated>
    
    <content type="html"><![CDATA[<img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230521200611562.png" alt="image-20230521200611562" style="zoom: 50%;" /><h2 id="PriorityQueue">PriorityQueue</h2><h3 id="æ•°æ®ç»“æ„-å †">æ•°æ®ç»“æ„-å †</h3><p>å‰é¢ä»‹ç»è¿‡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—æ˜¯ä¸€ç§å…ˆè¿›å…ˆå‡º(FIFO)çš„æ•°æ®ç»“æ„ï¼Œä½†æœ‰äº›æƒ…å†µä¸‹ï¼Œæ“ä½œçš„æ•°æ®å¯èƒ½å¸¦æœ‰ä¼˜å…ˆçº§ï¼Œä¸€èˆ¬å‡ºé˜Ÿåˆ—æ—¶ï¼Œå¯èƒ½éœ€è¦ä¼˜å…ˆçº§é«˜çš„å…ƒç´ å…ˆå‡ºé˜Ÿåˆ—ï¼Œè¯¥åœºæ™¯ä¸‹ï¼Œä½¿ç”¨é˜Ÿåˆ—æ˜¾ç„¶ä¸åˆé€‚ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ•°æ®ç»“æ„åº”è¯¥æä¾›ä¸¤ä¸ªæœ€åŸºæœ¬çš„æ“ä½œï¼Œä¸€ä¸ªæ˜¯è¿”å›æœ€é«˜ä¼˜å…ˆçº§å¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯æ·»åŠ æ–°çš„å¯¹è±¡ã€‚è¿™ç§æ•°æ®ç»“æ„å°±æ˜¯ä¼˜å…ˆçº§é˜Ÿåˆ—(Priority Queue)ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PriorityQueue&lt;Integer&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;();</span><br><span class="line">queue.offer(<span class="number">50</span>);</span><br><span class="line">queue.offer(<span class="number">60</span>);</span><br><span class="line">queue.offer(<span class="number">30</span>);</span><br><span class="line">queue.offer(<span class="number">25</span>);</span><br><span class="line">queue.offer(<span class="number">70</span>);</span><br><span class="line">queue.offer(<span class="number">20</span>);</span><br><span class="line">queue.offer(<span class="number">10</span>);</span><br><span class="line">queue.offer(<span class="number">40</span>);</span><br><span class="line">System.out.println(queue);</span><br><span class="line"><span class="comment">//è¾“å‡ºï¼š[10, 30, 20, 40, 70, 50, 25, 60]</span></span><br></pre></td></tr></table></figure><blockquote><p>è§‚å¯Ÿä¸€ä¸‹å…ƒç´ æ‰“å°é¡ºåºæœ‰æ²¡æœ‰ä»€ä¹ˆç‰¹ç‚¹å‘¢ï¼Ÿèƒ½ä¸èƒ½ç”¨å·²çŸ¥çš„æŸç§çš„æ•°æ®ç»“æ„æ¥æè¿°PriorityQueueè¿™æ ·çš„é›†åˆå‘¢ï¼Ÿ</p></blockquote><p>é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°è¿™äº›å…ƒç´ å¹¶ä¸æ˜¯æŒ‰æ·»åŠ é¡ºåºæ‰“å°çš„ï¼Œæ’é™¤äº†çº¿æ€§è¡¨ã€é“¾è¡¨ã€é˜Ÿåˆ—è¿™ä¸‰ç§çš„å¯èƒ½æ€§ã€‚</p><p>å…¶æ¬¡ï¼Œæ‰“å°çš„é¡ºåºå¹¶ä¸æ˜¯æŒ‰ç…§å…ƒç´ çš„å‡åºæˆ–é™åºæ’åˆ—çš„ï¼Œæ‰€ä»¥ä¹Ÿå°±æ’é™¤äº†æœ‰åºæ•°ç»„ã€äºŒå‰æ’åºæ ‘çš„å¯èƒ½æ€§ã€‚</p><p>é‚£ä¹ˆå‰©ä¸‹çš„å°±åªå‰©ä¸‹å“ˆå¸Œè¡¨å’Œ<span class='p green'>å †</span>äº†ã€‚</p><blockquote><mark class="hl-label green">å †çš„æ€§è´¨</mark> </blockquote><p>å †æ˜¯ä¸€ç§<span class='p blue'>ç‰¹æ®Šçš„æ ‘</span>ã€‚</p><p>åªè¦æ»¡è¶³ä»¥ä¸‹ä¸¤ç‚¹ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªå †ï¼š</p><ul><li>å †æ˜¯ä¸€ä¸ª<span class='p green'>å®Œå…¨äºŒå‰æ ‘</span></li><li>å †ä¸­æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„å€¼éƒ½å¿…é¡»å¤§äºç­‰äºï¼ˆæˆ–å°äºç­‰äºï¼‰å…¶å­æ ‘ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„å€¼</li></ul><p>ç¬¬ä¸€ç‚¹ï¼Œå †å¿…é¡»æ˜¯ä¸€ä¸ªå®Œå…¨äºŒå‰æ ‘ã€‚å®Œå…¨äºŒå‰æ ‘è¦æ±‚ï¼Œé™¤äº†æœ€åä¸€å±‚ï¼Œå…¶ä»–å±‚çš„èŠ‚ç‚¹ä¸ªæ•°éƒ½æ˜¯æ»¡çš„ï¼Œæœ€åä¸€å±‚çš„èŠ‚ç‚¹éƒ½é å·¦æ’åˆ—ï¼Œè‡ªç„¶å †ä¹Ÿå…·æœ‰å®Œå…¨äºŒå‰æ ‘çš„æ‰€æœ‰æ€§è´¨</p><p>ç¬¬äºŒç‚¹ï¼Œå †ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹çš„å€¼å¿…é¡»å¤§äºç­‰äºï¼ˆæˆ–è€…å°äºç­‰äºï¼‰å…¶å­æ ‘ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„å€¼ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ¢ä¸€ç§è¯´æ³•ï¼Œå †ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„å€¼éƒ½å¤§äºç­‰äºï¼ˆæˆ–è€…å°äºç­‰äºï¼‰å…¶å·¦å³å­èŠ‚ç‚¹çš„å€¼ã€‚è¿™ä¸¤ç§è¡¨è¿°æ˜¯ç­‰ä»·çš„ã€‚</p><p>å¯¹äºæ¯ä¸ªèŠ‚ç‚¹çš„å€¼éƒ½å¤§äºç­‰äºå­æ ‘ä¸­æ¯ä¸ªèŠ‚ç‚¹å€¼çš„å †ï¼Œæˆ‘ä»¬å«åš<code>å¤§é¡¶å †</code>ã€‚</p><p>å¯¹äºæ¯ä¸ªèŠ‚ç‚¹çš„å€¼éƒ½å°äºç­‰äºå­æ ‘ä¸­æ¯ä¸ªèŠ‚ç‚¹å€¼çš„å †ï¼Œæˆ‘ä»¬å«åš<code>å°é¡¶å †</code>ã€‚</p><p>å¦‚æœè¦è·å¾—æœ‰åºçš„ç‰¹æ€§ï¼Œ é€ä¸ªå‡ºé˜Ÿ(poll) ï¼šè¡Œ! ç”¨è¿­ä»£å™¨ï¼šä¸è¡Œ!</p><hr><h3 id="æºç å®ç°">æºç å®ç°</h3><blockquote><p>å­˜å‚¨æ–¹å¼</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é»˜è®¤æ•°ç»„å¤§å°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_INITIAL_CAPACITY</span> <span class="operator">=</span> <span class="number">11</span>;</span><br><span class="line"><span class="comment">//å­˜å‚¨å…ƒç´ çš„æ•°ç»„</span></span><br><span class="line"><span class="keyword">transient</span> Object[] queue;</span><br><span class="line"><span class="comment">//é˜Ÿåˆ—ä¸­å…ƒç´ çš„æ•°é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">//å¦‚æœcomparatorä¸ºnullï¼Œåˆ™é˜Ÿåˆ—æŒ‰ç…§å…ƒç´ è‡ªç„¶é¡ºåºè¿›è¡Œæ’åºï¼Œå¦åˆ™æŒ‰ç…§comparatoræŒ‡å®šçš„é¡ºåºè¿›è¡Œæ’åº</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Comparator&lt;? <span class="built_in">super</span> E&gt; comparator;</span><br><span class="line"><span class="comment">//é˜Ÿåˆ—è¢«ä¿®æ”¹çš„æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">transient</span> <span class="type">int</span> <span class="variable">modCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>å †åº•å±‚æ˜¯ç”¨æ•°ç»„å®ç°ï¼Œå…¶ä¸­queue[n]çš„ä¸¤ä¸ªå­èŠ‚ç‚¹ä¸ºqueue[2n+1]å’Œqueue[2(n+1)]ã€‚</p><hr><h4 id="å †çš„æ’å…¥">å †çš„æ’å…¥</h4><p>offerå‡½æ•°æœ‰ä¸¤ä¸ªè¦ç‚¹ï¼š</p><ul><li><p>å¦‚æœå †ä¸ºç©ºï¼Œåˆ™æ— éœ€æ‰©å®¹ï¼Œä¹Ÿæ— éœ€è°ƒæ•´</p></li><li><p>å¦åˆ™ï¼š</p><p>1ã€åˆ¤æ–­æ•°ç»„æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œå¦‚éœ€è¦è°ƒç”¨growæ–¹æ³•<br>2ã€æ’å…¥å…ƒç´ åï¼Œæœ‰å¯èƒ½ç ´åäº†å †çš„å¹³è¡¡ï¼Œè°ƒç”¨siftUp(ä¸Šæ»¤)æ–¹æ³•è°ƒæ•´å †è‡³å¹³è¡¡</p></li></ul><div class="tabs" id="eddc6051-32c1-445c-8877-50ed82a70a46"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#eddc6051-32c1-445c-8877-50ed82a70a46-1"><i class="fas fa-cat"></i>offerå‡½æ•°</button></li><li class="tab"><button type="button" data-href="#eddc6051-32c1-445c-8877-50ed82a70a46-2"><i class="fas fa-horse"></i>growå‡½æ•°</button></li><li class="tab"><button type="button" data-href="#eddc6051-32c1-445c-8877-50ed82a70a46-3"><i class="fas fa-dove"></i>siftUpå‡½æ•°</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="eddc6051-32c1-445c-8877-50ed82a70a46-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (e == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> size;</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= queue.length)</span><br><span class="line">        grow(i + <span class="number">1</span>);</span><br><span class="line">    size = i + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">        queue[<span class="number">0</span>] = e;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        siftUp(i, e);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="eddc6051-32c1-445c-8877-50ed82a70a46-2"><p>å †çš„æ‰©å®¹ä¸ArrayListç›¸ä¼¼ï¼š</p><ul><li>è‹¥æ•°ç»„å®¹é‡å°äº64ï¼Œæ‰©å¤§ä¸ºåŸæ¥å®¹é‡çš„2å€+2</li><li>è‹¥æ•°ç»„å®¹é‡å¤§äºç­‰äº64ï¼Œæ‰©å¤§ä¸ºåŸæ¥çš„1.5å€</li><li>å°†åŸæ¥çš„æ•°ç»„æ‹·è´åˆ°æ–°çš„æ•°ç»„ï¼Œå¹¶ä¸¢å¼ƒåŸæ¥çš„æ•°ç»„</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">grow</span><span class="params">(<span class="type">int</span> minCapacity)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldCapacity</span> <span class="operator">=</span> queue.length;</span><br><span class="line">    <span class="comment">// Double size if small; else grow by 50%</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">newCapacity</span> <span class="operator">=</span> oldCapacity + ((oldCapacity &lt; <span class="number">64</span>) ?</span><br><span class="line">                                     (oldCapacity + <span class="number">2</span>) :</span><br><span class="line">                                     (oldCapacity &gt;&gt; <span class="number">1</span>));</span><br><span class="line">    <span class="comment">// overflow-conscious code</span></span><br><span class="line">    <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">    queue = Arrays.copyOf(queue, newCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="eddc6051-32c1-445c-8877-50ed82a70a46-3"><p>ä»¥å°æ ¹å †ä¸ºä¾‹ï¼š</p><p>è‡ªåº•å‘ä¸Šï¼Œä¸æ–­æ¯”è¾ƒã€äº¤æ¢</p><p>å‡è®¾æ’å…¥å…ƒç´ E,æŠŠEæ’å…¥åˆ°å †çš„æœ«å°¾,å‡è®¾åœ¨æ•°ç»„queueçš„kä½ç½®æ’å…¥å…ƒç´ key</p><ul><li><p>ä¸æ–­çš„æ¯”è¾ƒkeyä¸kçš„çˆ¶èŠ‚ç‚¹eï¼ˆå³queue[(k-1)/2]) çš„å…³ç³»</p><p>1ã€è‹¥key&lt;eï¼Œåˆ™queue[k]=eï¼Œkå›æº¯è‡³e<br>2ã€è‹¥key&gt;=eæˆ–è€…kå·²ç»åˆ°è¾¾æ ¹èŠ‚ç‚¹ï¼Œåˆ™ç»“æŸå¾ªç¯</p></li><li><p>queue[k]=E</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftUpUsingComparator</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (k &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">parent</span> <span class="operator">=</span> (k - <span class="number">1</span>) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">e</span> <span class="operator">=</span> queue[parent];</span><br><span class="line">        <span class="keyword">if</span> (comparator.compare(x, (E) e) &gt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        queue[k] = e;</span><br><span class="line">        k = parent;</span><br><span class="line">    &#125;</span><br><span class="line">    queue[k] = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><mark class="hl-label green">æ’å…¥ç¤ºæ„å›¾</mark> <div class="tabs" id="2c1a2338-21d1-4774-a1a4-409ddc8ad324"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2c1a2338-21d1-4774-a1a4-409ddc8ad324-1"><i class="fas fa-cat"></i>1</button></li><li class="tab"><button type="button" data-href="#2c1a2338-21d1-4774-a1a4-409ddc8ad324-2"><i class="fas fa-horse"></i>2</button></li><li class="tab"><button type="button" data-href="#2c1a2338-21d1-4774-a1a4-409ddc8ad324-3"><i class="fas fa-dove"></i>3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2c1a2338-21d1-4774-a1a4-409ddc8ad324-1"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230522095612801.png" alt="image-20230522095612801" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2c1a2338-21d1-4774-a1a4-409ddc8ad324-2"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230522095647563.png" alt="image-20230522095647563" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2c1a2338-21d1-4774-a1a4-409ddc8ad324-3"><p>æ­¤æ—¶å·²ç»ç¬¦åˆå°æ ¹å †çš„è¦æ±‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230522095717386.png" alt="image-20230522095717386" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h4 id="å †çš„åˆ é™¤">å †çš„åˆ é™¤</h4><p>è°ƒç”¨pollæ–¹æ³•ï¼Œä¼šåˆ é™¤å †é¡¶å…ƒç´ </p><p>åˆ é™¤ä¹‹åï¼ŒæŠŠæœ«å°¾å…ƒç´ ç›´æ¥æ”¾åˆ°å †é¡¶ï¼Œåˆ™ç ´åäº†å †çš„å¹³è¡¡</p><p>è°ƒç”¨siftDownï¼ˆä¸‹å ï¼‰å‡½æ•°ä½¿å †é‡æ–°æ¢å¤å¹³è¡¡</p><p>siftDownä¸siftUpç±»ä¼¼ï¼Œåªä¸è¿‡æ˜¯è‡ªé¡¶å‘ä¸‹</p><p>è¢«åˆ é™¤çš„å…ƒç´ ç”¨å †åº•å…ƒç´ æ›¿ä»£ï¼Œç„¶åè®©è¯¥å…ƒç´ ä¸æ–­â€œä¸‹å â€ï¼Œç›´åˆ°æ— æ³•ä¸‹å ä¸ºæ­¢</p><blockquote><p>siftDownåŸç†</p></blockquote><p>ä»¥å°æ ¹å †ä¸ºä¾‹ï¼š</p><p>è‡ªé¡¶å‘ä¸‹ï¼Œé€‰æ‹©è¾ƒå°çš„å­èŠ‚ç‚¹ï¼Œä¸æ–­æ¯”è¾ƒã€äº¤æ¢ç›´åˆ°ï¼š</p><p>1ã€ä¸‹æ ‡è¶Šç•Œ<br>2ã€èŠ‚ç‚¹çš„å€¼åŒæ—¶å°äºç­‰äºå·¦å­©å­å’Œå³å­©å­</p><p>å‡è®¾æ•°ç»„queueæœ€åä¸€ä¸ªå…ƒç´ çš„å€¼ä¸ºkeyï¼Œä¸‹æ ‡kä»0ï¼ˆå †é¡¶ï¼‰å¼€å§‹å½“kå­˜åœ¨å·¦å­©å­æ—¶ï¼Œæ‰§è¡Œä»¥ä¸‹å¾ªç¯ï¼š</p><p>è‹¥kæœ‰å³å­©å­ï¼Œåˆ™æ¯”è¾ƒå·¦å­©å­å’Œå³å­©å­çš„å¤§å°ï¼Œå¹¶é€‰å‡ºè¾ƒå°å­©å­child æ¯”è¾ƒkeyä¸c=queuelchila]çš„å¤§å°ï¼š</p><p>1ã€ è‹¥key&lt;=cï¼Œç»“æŸå¾ªç¯<br>2ã€è‹¥key&gt;cï¼Œåˆ™queue[k]=c,k=childï¼Œç»§ç»­å¾ªç¯</p><p>æœ€åqueue[k]=key</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDownUsingComparator</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">half</span> <span class="operator">=</span> size &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (k &lt; half) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">child</span> <span class="operator">=</span> (k &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">c</span> <span class="operator">=</span> queue[child];</span><br><span class="line">        <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> child + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (right &lt; size &amp;&amp;</span><br><span class="line">            comparator.compare((E) c, (E) queue[right]) &gt; <span class="number">0</span>)</span><br><span class="line">            c = queue[child = right];</span><br><span class="line">        <span class="keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        queue[k] = c;</span><br><span class="line">        k = child;</span><br><span class="line">    &#125;</span><br><span class="line">    queue[k] = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="å †çš„å»ºç«‹">å †çš„å»ºç«‹</h4><p>å½“æ„é€ å‡½æ•°ä¼ å…¥ä¸€ä¸ªé›†åˆçš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ heapifyæ–¹æ³•è¿›è¡Œå †çš„è°ƒæ•´</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initFromCollection</span><span class="params">(Collection&lt;? extends E&gt; c)</span> &#123;</span><br><span class="line">    initElementsFromCollection(c);</span><br><span class="line">    heapify();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (size &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">        siftDown(i, (E) queue[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><mark class="hl-label blue">æ¼”ç¤º</mark> <p>è°ƒæ•´ä¸ºæœ€å°å †</p><p>i = (size &gt;&gt;&gt; 1) - 1æ‰¾åˆ°ç¬¬ä¸€ä¸ªéå¶å­èŠ‚ç‚¹è¿›è¡Œè°ƒæ•´</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230522101817238.png" alt="image-20230522101817238" style="zoom:67%;" /><hr><h3 id="å †æ’åº">å †æ’åº</h3><p>ç»™å®šæ— åºæ•°ç»„arrayï¼Œé•¿åº¦ä¸ºnï¼Œå°†æ•°ç»„æ’æˆæœ‰åºåºåˆ—</p><p>è¦æ±‚æ—¶é—´å¤æ‚åº¦ä¸ºO(NlogN)ï¼Œç©ºé—´å¤æ‚åº¦ä¸ºO(1ï¼‰</p><div class="tabs" id="c4068611-0241-463f-bdf4-6d2e574df7e0"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c4068611-0241-463f-bdf4-6d2e574df7e0-1"><i class="fas fa-award"></i>æ–¹æ¡ˆä¸€</button></li><li class="tab"><button type="button" data-href="#c4068611-0241-463f-bdf4-6d2e574df7e0-2"><i class="fas fa-baseball-ball"></i>æ–¹æ¡ˆäºŒ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c4068611-0241-463f-bdf4-6d2e574df7e0-1"><p>åˆ©ç”¨PriorityQueue</p><p>1ã€æ–°å»ºå¦å¤–ä¸€ä¸ªæœ€å°å †<br>2ã€è°ƒç”¨Næ¬¡offeræ–¹æ³•ï¼Œå°†å…ƒç´ ä¾æ¬¡æ’å…¥æœ€å°å †T1 (N)=O(NlogN)ï¼ŒS1(N)=O(N)<br>3ã€æ‰§è¡Œnæ¬¡pollï¼ŒæŠŠå †é¡¶å…ƒç´ ä¾æ¬¡å¤åˆ¶è¿›åŸæ•°ç»„ï¼ŒT2(N)=O(NlogN)ï¼ŒS(N)=0(1)</p><p>æ€»æ—¶é—´å¤æ‚åº¦T(N)=O(NlogN)+O(NlogN)=O(NlogN)</p><p>æ€»ç©ºé—´å¤æ‚åº¦S(N)=O(N)+0(1)+O(N)</p><p>é¢è¯•å®˜å¯èƒ½ä¼šé—®ä½ </p><p>å¯å¦æŠŠç©ºé—´å¤æ‚åº¦ä¼˜åŒ–ä¸ºO(1)ï¼Ÿ</p><p>é‚£å°±éœ€è¦ç”¨åˆ°æ–¹æ¡ˆäºŒ</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c4068611-0241-463f-bdf4-6d2e574df7e0-2"><p>å †æ’åºï¼ŒHeapSort</p><p>å°†æ•°ç»„æœ¬èº«çœ‹æˆæœ€å¤§å †ï¼Œå€ŸåŠ©heapifyå‡½æ•°ï¼Œå°†æ•°ç»„æ„é€ æˆæœ€å¤§å †</p><p>1ã€åˆ©ç”¨heapifyå‡½æ•°æ€è·¯ï¼Œæ„å»º<span class='p green'>æœ€å¤§å †</span><br>2ã€ç§»é™¤å †é¡¶å…ƒç´ ï¼Œäº¤æ¢åˆ°æ•°ç»„çš„æœ«å°¾ï¼Œ<span class='p red'>å¹¶è®©å †çš„å¤§å°å‡å°‘1</span>ï¼Œå†è°ƒç”¨siftDown<br>3ã€ä¸æ–­æ‰§è¡Œ2ï¼Œç›´åˆ°å †çš„å¤§å°ä¸º1ï¼Œæ’åºå®Œæ¯•</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="å¤§é¡¶å †å°é¡¶å †">å¤§é¡¶å †å°é¡¶å †</h3><p>ä»¥å­˜å‚¨Integerä¸ºä¾‹</p><div class="tabs" id="e0dd0eb7-e5ae-435c-8a2e-e0c5133de091"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e0dd0eb7-e5ae-435c-8a2e-e0c5133de091-1"><i class="fas fa-cat"></i>å¤§é¡¶å †çš„å®ç°</button></li><li class="tab"><button type="button" data-href="#e0dd0eb7-e5ae-435c-8a2e-e0c5133de091-2"><i class="fas fa-horse"></i>å°é¡¶å †çš„å®ç°</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e0dd0eb7-e5ae-435c-8a2e-e0c5133de091-1"><p><code>å¤§é¡¶å †</code>ï¼šå¯¹äºæ¯ä¸ªèŠ‚ç‚¹çš„å€¼éƒ½<span class='p red'>å¤§äº</span>ç­‰äºå­æ ‘ä¸­æ¯ä¸ªèŠ‚ç‚¹å€¼çš„å †</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PriorityQueue&lt;Integer&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(</span><br><span class="line">        ((o1, o2) -&gt; o2-o1)</span><br><span class="line">);</span><br><span class="line">queue.offer(<span class="number">50</span>);</span><br><span class="line">queue.offer(<span class="number">60</span>);</span><br><span class="line">queue.offer(<span class="number">30</span>);</span><br><span class="line">queue.offer(<span class="number">25</span>);</span><br><span class="line">queue.offer(<span class="number">70</span>);</span><br><span class="line">queue.offer(<span class="number">20</span>);</span><br><span class="line">queue.offer(<span class="number">10</span>);</span><br><span class="line">queue.offer(<span class="number">40</span>);</span><br><span class="line">System.out.println(queue);</span><br><span class="line"><span class="comment">//è¾“å‡ºï¼š[70, 60, 30, 40, 50, 20, 10, 25]</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e0dd0eb7-e5ae-435c-8a2e-e0c5133de091-2"><p><code>å°é¡¶å †</code>ï¼šå¯¹äºæ¯ä¸ªèŠ‚ç‚¹çš„å€¼éƒ½<span class='p green'>å°äº</span>ç­‰äºå­æ ‘ä¸­æ¯ä¸ªèŠ‚ç‚¹å€¼çš„å †</p><p>é»˜è®¤çš„PriorityQueueå°±æ˜¯ä¸€ä¸ªå°é¡¶å †</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="ArrayDeque">ArrayDeque</h2><p>è¿™é‡Œä¸»è¦è·Ÿä»‹ç»<code>JDK</code>ç»™æˆ‘ä»¬æä¾›çš„ä¸€ç§ç”¨æ•°ç»„å®ç°çš„<span class='p green'>åŒç«¯é˜Ÿåˆ—</span>ï¼Œåœ¨ä¹‹å‰çš„æ–‡ç« æˆ‘ä»¬å·²ç»ä»‹ç»äº†ä¸€ç§<strong>åŒç«¯é˜Ÿåˆ—</strong>ï¼Œä¸è¿‡ä¸<code>ArrayDeque</code>ä¸åŒçš„æ˜¯ï¼Œ<code>LinkedList</code>çš„åŒç«¯é˜Ÿåˆ—ä½¿ç”¨åŒå‘é“¾è¡¨å®ç°çš„ã€‚</p><div class="tag link"><a class="link-card" title="LinkedListç»§æ‰¿ä½“ç³»" href="/posts/7ec37ec5.html#LinkedListç»§æ‰¿ä½“ç³»"><div class="left"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/favicon.png"/></div><div class="right"><p class="text">LinkedListç»§æ‰¿ä½“ç³»</p><p class="url">/posts/7ec37ec5.html#LinkedListç»§æ‰¿ä½“ç³»</p></div></a></div><blockquote><p>æ•´ä½“åˆ†æ</p></blockquote><p>æˆ‘ä»¬é€šå¸¸æ‰€è°ˆè®ºåˆ°çš„é˜Ÿåˆ—éƒ½æ˜¯ä¸€ç«¯è¿›ä¸€ç«¯å‡ºï¼Œè€ŒåŒç«¯é˜Ÿåˆ—çš„ä¸¤ç«¯åˆ™éƒ½æ˜¯å¯è¿›å¯å‡ºã€‚</p><p><code>ArrayDeque</code>åº•å±‚æ˜¯ä½¿ç”¨æ•°ç»„å®ç°çš„ï¼Œè€Œä¸”æ•°ç»„çš„é•¿åº¦å¿…é¡»æ˜¯<code>2</code>çš„æ•´æ•°æ¬¡å¹‚ï¼Œè¿™ä¹ˆæ“ä½œçš„åŸå› æ˜¯ä¸ºäº†åé¢ä½è¿ç®—å¥½æ“ä½œã€‚åœ¨<code>ArrayDeque</code>å½“ä¸­æœ‰ä¸¤ä¸ªæ•´å½¢å˜é‡<code>head</code>å’Œ<code>tail</code>ï¼Œåˆ†åˆ«æŒ‡å‘å³ä¾§çš„ç¬¬ä¸€ä¸ªè¿›å…¥é˜Ÿåˆ—çš„æ•°æ®å’Œå·¦ä¾§ç¬¬ä¸€ä¸ªè¿›è¡Œé˜Ÿåˆ—çš„æ•°æ®ï¼Œæ•´ä¸ªå†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2519003-20220715010318405-150064473.png" alt="img" style="zoom: 67%;" /><p>å…¶ä¸­<code>tail</code>æŒ‡çš„ä½ç½®æ²¡æœ‰æ•°æ®ï¼Œ<code>head</code>æŒ‡çš„ä½ç½®å­˜åœ¨æ•°æ®ã€‚</p><div class="tabs" id="6960b700-7eac-4d0a-babe-81852ff7156c"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6960b700-7eac-4d0a-babe-81852ff7156c-1"><i class="fas fa-award"></i>1</button></li><li class="tab"><button type="button" data-href="#6960b700-7eac-4d0a-babe-81852ff7156c-2"><i class="fas fa-baseball-ball"></i>2</button></li><li class="tab"><button type="button" data-href="#6960b700-7eac-4d0a-babe-81852ff7156c-3"><i class="fas fa-bone"></i>3</button></li><li class="tab"><button type="button" data-href="#6960b700-7eac-4d0a-babe-81852ff7156c-4"><i class="fas fa-anchor"></i>4</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6960b700-7eac-4d0a-babe-81852ff7156c-1"><p>å‘é˜Ÿåˆ—å°¾éƒ¨æ·»åŠ æ•°æ®ï¼Œå†…å­˜å½“ä¸­æ•°æ®å˜åŒ–æƒ…å†µå¦‚ä¸‹ï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2519003-20220715010328930-112988730.png" alt="img" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6960b700-7eac-4d0a-babe-81852ff7156c-2"><p>é˜Ÿåˆ—å¤´éƒ¨æ·»åŠ æ•°æ®ï¼Œå†…å­˜å½“ä¸­æ•°æ®å˜åŒ–æƒ…å†µå¦‚ä¸‹ï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2519003-20220715010339150-1082019999.png" alt="img" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6960b700-7eac-4d0a-babe-81852ff7156c-3"><p>é˜Ÿå°¾å…ƒç´ åˆ é™¤ï¼Œå†…å­˜å½“ä¸­æ•°æ®å˜åŒ–æƒ…å†µå¦‚ä¸‹ï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2519003-20220715010352215-1154696099.png" alt="img" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6960b700-7eac-4d0a-babe-81852ff7156c-4"><p>é˜Ÿé¦–å…ƒç´ åˆ é™¤</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2519003-20220715010402157-1785624671.png" alt="img" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="æºç åˆ†æ">æºç åˆ†æ</h3><h4 id="å…³é”®å­—æ®µ">å…³é”®å­—æ®µ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åº•å±‚ç”¨äºå­˜å‚¨å…·ä½“æ•°æ®çš„æ•°ç»„</span></span><br><span class="line"><span class="keyword">transient</span> Object[] elements;</span><br><span class="line"><span class="comment">// è¿™å°±æ˜¯å‰é¢è°ˆåˆ°çš„ head</span></span><br><span class="line"><span class="keyword">transient</span> <span class="type">int</span> head;</span><br><span class="line"><span class="comment">// ä¸ä¸Šæ–‡è°ˆåˆ°çš„ tail å«ä¹‰ä¸€æ ·</span></span><br><span class="line"><span class="keyword">transient</span> <span class="type">int</span> tail;</span><br><span class="line"><span class="comment">// MIN_INITIAL_CAPACITY è¡¨ç¤ºæ•°ç»„ elements çš„æœ€çŸ­é•¿åº¦</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MIN_INITIAL_CAPACITY</span> <span class="operator">=</span> <span class="number">8</span>;</span><br></pre></td></tr></table></figure><hr><h4 id="æ„é€ å‡½æ•°">æ„é€ å‡½æ•°</h4><ul><li>é»˜è®¤æ„é€ å‡½æ•°ï¼Œæ•°ç»„é»˜è®¤ç”³è¯·çš„é•¿åº¦ä¸º<code>16</code>ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ArrayDeque</span><span class="params">()</span> &#123;</span><br><span class="line">    elements = <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">16</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="å…³é”®å‡½æ•°">å…³é”®å‡½æ•°</h4><div class="tabs" id="e0ae5b59-a787-48a2-b770-38f92dae3c98"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e0ae5b59-a787-48a2-b770-38f92dae3c98-1"><i class="fas fa-seedling"></i>addLast</button></li><li class="tab"><button type="button" data-href="#e0ae5b59-a787-48a2-b770-38f92dae3c98-2"><i class="fas fa-leaf"></i>addFirst</button></li><li class="tab"><button type="button" data-href="#e0ae5b59-a787-48a2-b770-38f92dae3c98-3"><i class="fab fa-apple"></i>doubleCapacity</button></li><li class="tab"><button type="button" data-href="#e0ae5b59-a787-48a2-b770-38f92dae3c98-4"><i class="fas fa-tree"></i>æ‰©å®¹å›¾ç¤º</button></li><li class="tab"><button type="button" data-href="#e0ae5b59-a787-48a2-b770-38f92dae3c98-5"><i class="fas fa-heartbeat"></i>pollFirst</button></li><li class="tab"><button type="button" data-href="#e0ae5b59-a787-48a2-b770-38f92dae3c98-6"><i class="fas fa-cookie-bite"></i>pollLast</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e0ae5b59-a787-48a2-b770-38f92dae3c98-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tail çš„åˆå§‹å€¼ä¸º 0 </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addLast</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (e == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    elements[tail] = e;</span><br><span class="line">    <span class="comment">// è¿™é‡Œè¿›è¡Œçš„ &amp; ä½è¿ç®— ç›¸å½“äºå–ä½™æ•°æ“ä½œ</span></span><br><span class="line">    <span class="comment">// (tail + 1) &amp; (elements.length - 1) == (tail + 1) % elements.length</span></span><br><span class="line">    <span class="comment">// è¿™ä¸ªæ“ä½œä¸»è¦æ˜¯ç”¨äºåˆ¤æ–­æ•°ç»„æ˜¯å¦æ»¡äº†ï¼Œå¦‚æœæ»¡äº†åˆ™éœ€è¦æ‰©å®¹</span></span><br><span class="line">    <span class="comment">// åŒæ—¶è¿™ä¸ªæ“ä½œå°† tail + 1ï¼Œå³ tail = tail + 1</span></span><br><span class="line">    <span class="keyword">if</span> ( (tail = (tail + <span class="number">1</span>) &amp; (elements.length - <span class="number">1</span>)) == head)</span><br><span class="line">        doubleCapacity();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e0ae5b59-a787-48a2-b770-38f92dae3c98-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// head çš„åˆå§‹å€¼ä¸º 0 </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addFirst</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (e == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">// è‹¥æ­¤æ—¶æ•°ç»„é•¿åº¦elements.length = 16</span></span><br><span class="line">    <span class="comment">// é‚£ä¹ˆä¸‹é¢ä»£ç æ‰§è¡Œè¿‡å head = 15</span></span><br><span class="line">    <span class="comment">// ä¸‹é¢ä»£ç çš„æ“ä½œç»“æœå’Œä¸‹é¢ä¸¤è¡Œä»£ç å«ä¹‰ä¸€è‡´</span></span><br><span class="line">    <span class="comment">// elements[(head - 1 + elements.length) % elements.length] = e</span></span><br><span class="line">    <span class="comment">// head = (head - 1 + elements.length) % elements.length</span></span><br><span class="line">    elements[head = (head - <span class="number">1</span>) &amp; (elements.length - <span class="number">1</span>)] = e;</span><br><span class="line">    <span class="keyword">if</span> (head == tail)</span><br><span class="line">        doubleCapacity();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e0ae5b59-a787-48a2-b770-38f92dae3c98-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doubleCapacity</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">assert</span> head == tail;</span><br><span class="line">    <span class="type">int</span> <span class="variable">p</span> <span class="operator">=</span> head;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> elements.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> n - p; <span class="comment">// number of elements to the right of p</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">newCapacity</span> <span class="operator">=</span> n &lt;&lt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (newCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Sorry, deque too big&quot;</span>);</span><br><span class="line">    Object[] a = <span class="keyword">new</span> <span class="title class_">Object</span>[newCapacity];</span><br><span class="line">    <span class="comment">// ä¸Šé¢æ˜¯å‡½æ•° System.arraycopy çš„å‡½æ•°å‚æ•°åˆ—è¡¨</span></span><br><span class="line">    System.arraycopy(elements, p, a, <span class="number">0</span>, r);</span><br><span class="line">    System.arraycopy(elements, <span class="number">0</span>, a, r, p);</span><br><span class="line">    elements = a;</span><br><span class="line">    head = <span class="number">0</span>;</span><br><span class="line">    tail = n;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e0ae5b59-a787-48a2-b770-38f92dae3c98-4"><p>æ‰©å®¹ä¹‹åå°†åŸæ¥æ•°ç»„çš„æ•°æ®æ‹·è´åˆ°äº†æ–°æ•°ç»„å½“ä¸­ï¼Œè™½ç„¶æ•°æ®åœ¨æ—§æ•°ç»„å’Œæ–°æ•°ç»„å½“ä¸­çš„é¡ºåºå‘ç”Ÿå˜åŒ–äº†ï¼Œä½†æ˜¯ä»–ä»¬çš„ç›¸å¯¹é¡ºåºå´æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä»–ä»¬çš„é€»è¾‘é¡ºåºä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œçš„é€»è¾‘å¯èƒ½æœ‰ç‚¹ç»•ï¼Œå¤§å®¶åœ¨è¿™é‡Œå¯ä»¥å¥½å¥½æ€è€ƒä¸€ä¸‹ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2519003-20220715185849697-121038371.png" alt="img" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e0ae5b59-a787-48a2-b770-38f92dae3c98-5"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">pollFirst</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="type">E</span> <span class="variable">result</span> <span class="operator">=</span> (E) elements[h];</span><br><span class="line">    <span class="comment">// Element is null if deque empty</span></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    elements[h] = <span class="literal">null</span>;     <span class="comment">// Must null out slot</span></span><br><span class="line">    head = (h + <span class="number">1</span>) &amp; (elements.length - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e0ae5b59-a787-48a2-b770-38f92dae3c98-6"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">pollLast</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è®¡ç®—å‡ºå¾…åˆ é™¤çš„æ•°æ®çš„ä¸‹æ ‡</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">t</span> <span class="operator">=</span> (tail - <span class="number">1</span>) &amp; (elements.length - <span class="number">1</span>);</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="type">E</span> <span class="variable">result</span> <span class="operator">=</span> (E) elements[t];</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// å°†éœ€è¦åˆ é™¤çš„æ•°æ®çš„ä¸‹æ ‡å€¼è®¾ç½®ä¸º null è¿™æ ·è¿™å—å†…å­˜å°±</span></span><br><span class="line">    <span class="comment">// å¯ä»¥è¢«å›æ”¶äº†</span></span><br><span class="line">    elements[t] = <span class="literal">null</span>;</span><br><span class="line">    tail = t;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>]]></content>
    
    
    <summary type="html">å †ï¼šPriorityQueueã€ArrayDequeå’ŒLinkedList</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/tags/Java/"/>
    
    <category term="å®¹å™¨" scheme="https://wuwawawa.github.io/tags/%E5%AE%B9%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>é˜Ÿåˆ—æ¥å£Queue</title>
    <link href="https://wuwawawa.github.io/posts/54307854.html"/>
    <id>https://wuwawawa.github.io/posts/54307854.html</id>
    <published>2023-05-21T11:58:41.000Z</published>
    <updated>2023-05-21T14:14:35.891Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Queueä½“ç³»æ¶æ„">Queueä½“ç³»æ¶æ„</h2><p>Queueæ¥å£æä¾›äº†é˜Ÿåˆ—æ•°æ®ç»“æ„çš„åŠŸèƒ½ã€‚å®ƒç»§æ‰¿äº†Collectionæ¥å£ï¼Œ ç”¨äºä¿å­˜å°†è¦æŒ‰FIFO(å…ˆè¿›å…ˆå‡º)é¡ºåºå¤„ç†çš„å…ƒç´ ã€‚</p><p>å®ƒæ˜¯ä¸€ä¸ªæœ‰åºçš„å¯¹è±¡åˆ—è¡¨ï¼Œå…¶ç”¨é€”ä»…é™äºåœ¨åˆ—è¡¨æœ«å°¾æ’å…¥å…ƒç´ å’Œä»åˆ—è¡¨å¼€å¤´åˆ é™¤å…ƒç´ ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230521200611562.png" alt="image-20230521200611562" style="zoom: 50%;" /><hr><hr><h2 id="Queueæ¥å£çš„æ–¹æ³•">Queueæ¥å£çš„æ–¹æ³•</h2><p>Queueæ¥å£åŒ…æ‹¬Collectionæ¥å£çš„æ‰€æœ‰æ–¹æ³•ã€‚</p><table><thead><tr><th style="text-align:left">æ–¹æ³•å</th><th style="text-align:left">æ¥æº</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left"><code>boolean add(E e)</code></td><td style="text-align:left"><span class='p blue'>Collection</span></td><td style="text-align:left">å°†æŒ‡å®šçš„å…ƒç´ æ’å…¥åˆ°é˜Ÿåˆ—å°¾éƒ¨ï¼Œå¹¶åœ¨æˆåŠŸæ—¶è¿”å›trueã€‚</td></tr><tr><td style="text-align:left"><code>boolean addAll(Collection&lt;? extends E&gt; c)</code></td><td style="text-align:left"><span class='p blue'>Collection</span></td><td style="text-align:left">æ·»åŠ å¤šä¸ªå…ƒç´ è‡³é˜Ÿåˆ—å°¾éƒ¨</td></tr><tr><td style="text-align:left"><code>int size()</code></td><td style="text-align:left"><span class='p blue'>Collection</span></td><td style="text-align:left">è¿”å›é›†åˆçš„é•¿åº¦</td></tr><tr><td style="text-align:left"><code>boolean isEmpty()</code></td><td style="text-align:left"><span class='p blue'>Collection</span></td><td style="text-align:left">åˆ¤æ–­é›†åˆæ˜¯å¦ä¸ºç©º</td></tr><tr><td style="text-align:left"><code>boolean remove(Object o)</code></td><td style="text-align:left"><span class='p blue'>Collection</span></td><td style="text-align:left">ç§»é™¤æŒ‡å®šçš„å…ƒç´ </td></tr><tr><td style="text-align:left"><code>boolean removeIf(Predicate&lt;? super E&gt; filter)</code></td><td style="text-align:left"><span class='p blue'>Collection</span></td><td style="text-align:left">æ ¹æ®æ¡ä»¶è¿›è¡Œç§»é™¤</td></tr><tr><td style="text-align:left"><code>boolean removeAll(Collection&lt;?&gt; c)</code></td><td style="text-align:left"><span class='p blue'>Collection</span></td><td style="text-align:left">ç§»é™¤å¤šä¸ªå…ƒç´ </td></tr><tr><td style="text-align:left"><code>void clear()</code></td><td style="text-align:left"><span class='p blue'>Collection</span></td><td style="text-align:left">æ¸…ç©ºé›†åˆä¸­çš„å…ƒç´ </td></tr><tr><td style="text-align:left"><code>boolean contains(Object o)</code></td><td style="text-align:left"><span class='p blue'>Collection</span></td><td style="text-align:left">åˆ¤æ–­é›†åˆä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„å…ƒç´ </td></tr><tr><td style="text-align:left"><code>Iterator&lt; E &gt; iterator()</code></td><td style="text-align:left"><span class='p blue'>Collection</span></td><td style="text-align:left">è¿”å›è¿­ä»£å™¨å¯¹è±¡</td></tr><tr><td style="text-align:left"><code>boolean offer(E e)</code></td><td style="text-align:left"><span class='p green'>Queue</span></td><td style="text-align:left">æ·»åŠ åˆ°é˜Ÿåˆ—å°¾éƒ¨</td></tr><tr><td style="text-align:left"><code>E remove()</code></td><td style="text-align:left"><span class='p green'>Queue</span></td><td style="text-align:left">åˆ é™¤å¹¶è¿”å›è¯¥é˜Ÿåˆ—çš„å¤´éƒ¨å…ƒç´ ,å¦‚æœé˜Ÿåˆ—ä¸ºç©º,åˆ™å¼•å‘å¼‚å¸¸</td></tr><tr><td style="text-align:left"><code>E poll()</code></td><td style="text-align:left"><span class='p green'>Queue</span></td><td style="text-align:left">è¿”å›å¹¶åˆ é™¤è¯¥é˜Ÿåˆ—çš„å¤´éƒ¨å…ƒç´ , å¦‚æœé˜Ÿåˆ—ä¸ºç©º,åˆ™è¿”å›null</td></tr><tr><td style="text-align:left"><code>E peek()</code></td><td style="text-align:left"><span class='p green'>Queue</span></td><td style="text-align:left">è¿”å›é˜Ÿåˆ—å¤´éƒ¨å…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å›null</td></tr><tr><td style="text-align:left"><code>E element()</code></td><td style="text-align:left"><span class='p green'>Queue</span></td><td style="text-align:left">è¿”å›é˜Ÿåˆ—å¤´éƒ¨å…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™å¼•å‘å¼‚å¸¸</td></tr></tbody></table><mark class="hl-label blue">åˆ†ç±»</mark> <div class="tabs" id="30fb45ed-f2eb-4ed0-8f0f-7555fff212e1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#30fb45ed-f2eb-4ed0-8f0f-7555fff212e1-1"><i class="fas fa-cat"></i>å‹å…¥å…ƒç´ (æ·»åŠ )</button></li><li class="tab"><button type="button" data-href="#30fb45ed-f2eb-4ed0-8f0f-7555fff212e1-2"><i class="fas fa-horse"></i>å¼¹å‡ºå…ƒç´ (åˆ é™¤)</button></li><li class="tab"><button type="button" data-href="#30fb45ed-f2eb-4ed0-8f0f-7555fff212e1-3"><i class="fas fa-dove"></i>è·å–é˜Ÿå¤´å…ƒç´ (ä¸åˆ é™¤)</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="30fb45ed-f2eb-4ed0-8f0f-7555fff212e1-1"><blockquote><p><strong>add()ã€offer()</strong></p></blockquote><ul><li>ç›¸åŒï¼šæœªè¶…å‡ºå®¹é‡ï¼Œä»é˜Ÿå°¾å‹å…¥å…ƒç´ ï¼Œè¿”å›å‹å…¥çš„é‚£ä¸ªå…ƒç´ ã€‚</li><li>åŒºåˆ«ï¼šåœ¨è¶…å‡ºå®¹é‡æ—¶ï¼Œadd()æ–¹æ³•ä¼šå¯¹æŠ›å‡ºå¼‚å¸¸ï¼Œoffer()è¿”å›false</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="30fb45ed-f2eb-4ed0-8f0f-7555fff212e1-2"><blockquote><p><strong>remove()ã€poll()</strong></p></blockquote><ul><li>ç›¸åŒï¼šå®¹é‡å¤§äº0çš„æ—¶å€™ï¼Œåˆ é™¤å¹¶è¿”å›é˜Ÿå¤´è¢«åˆ é™¤çš„é‚£ä¸ªå…ƒç´ ã€‚</li><li>åŒºåˆ«ï¼šåœ¨å®¹é‡ä¸º0çš„æ—¶å€™ï¼Œremove()ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œpoll()è¿”å›false</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="30fb45ed-f2eb-4ed0-8f0f-7555fff212e1-3"><blockquote><p><strong>element()ã€peek()</strong></p></blockquote><ul><li>ç›¸åŒï¼šå®¹é‡å¤§äº0çš„æ—¶å€™ï¼Œéƒ½è¿”å›é˜Ÿå¤´å…ƒç´ ã€‚ä½†æ˜¯ä¸åˆ é™¤ã€‚</li><li>åŒºåˆ«ï¼šå®¹é‡ä¸º0çš„æ—¶å€™ï¼Œelement()ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œpeek()è¿”å›nullã€‚</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="Dequeæ¥å£çš„æ–¹æ³•">Dequeæ¥å£çš„æ–¹æ³•</h2><p>Dequeæ¥å£æä¾›äº†åŒç«¯é˜Ÿåˆ—(Deque)çš„åŠŸèƒ½ã€‚å®ƒç»§æ‰¿äº†Queueæ¥å£ï¼ŒåŒ…æ‹¬Collectionå’ŒQueueæ¥å£çš„æ‰€æœ‰æ–¹æ³•ã€‚</p><p>Dequeæ˜¯ä¸€ä¸ªçº¿æ€§collectionï¼Œæ”¯æŒåœ¨ä¸¤ç«¯æ’å…¥å’Œç§»é™¤å…ƒç´ ã€‚Dequeçš„å®ç°ç±»æ˜¯LinkedListã€ArrayDequeã€LinkedBlockingDequeï¼Œå…¶ä¸­LinkedListæ˜¯æœ€å¸¸ç”¨çš„ã€‚</p><p>é™¤äº†Queueæ¥å£ä¸­å¯ç”¨çš„æ–¹æ³•ä¹‹å¤–ï¼ŒDequeè¿˜åŒ…æ‹¬ä»¥ä¸‹æ–¹æ³•ï¼š</p><table><thead><tr><th style="text-align:left">æ–¹æ³•å</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left"><code>void addFirst(E e)</code></td><td style="text-align:left">åœ¨åŒç«¯é˜Ÿåˆ—çš„å¼€å¤´æ·»åŠ æŒ‡å®šçš„å…ƒç´ ã€‚å¦‚æœåŒç«¯é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™å¼•å‘å¼‚å¸¸</td></tr><tr><td style="text-align:left"><code>void addLast(E e)</code></td><td style="text-align:left">åœ¨åŒç«¯é˜Ÿåˆ—çš„æœ«å°¾æ·»åŠ æŒ‡å®šçš„å…ƒç´ ã€‚å¦‚æœåŒç«¯é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™å¼•å‘å¼‚å¸¸</td></tr><tr><td style="text-align:left"><code>boolean offerFirst(E e)</code></td><td style="text-align:left">åœ¨åŒç«¯é˜Ÿåˆ—çš„å¼€å¤´æ·»åŠ æŒ‡å®šçš„å…ƒç´ ã€‚å¦‚æœåŒç«¯é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™è¿”å›false</td></tr><tr><td style="text-align:left"><code>boolean offerLast(E e)</code></td><td style="text-align:left">åœ¨åŒç«¯é˜Ÿåˆ—çš„æœ«å°¾æ·»åŠ æŒ‡å®šçš„å…ƒç´ ã€‚å¦‚æœåŒç«¯é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™è¿”å›false</td></tr><tr><td style="text-align:left"><code>E removeFirst()</code></td><td style="text-align:left">è¿”å›å¹¶åˆ é™¤åŒç«¯é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚å¦‚æœåŒç«¯é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™å¼•å‘å¼‚å¸¸</td></tr><tr><td style="text-align:left"><code>E removeLast()</code></td><td style="text-align:left">è¿”å›å¹¶åˆ é™¤åŒç«¯é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚å¦‚æœåŒç«¯é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™å¼•å‘å¼‚å¸¸</td></tr><tr><td style="text-align:left"><code>E pollFirst()</code></td><td style="text-align:left">è¿”å›å¹¶åˆ é™¤åŒç«¯é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚å¦‚æœåŒç«¯é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å›null</td></tr><tr><td style="text-align:left"><code>E pollLast()</code></td><td style="text-align:left">è¿”å›å¹¶åˆ é™¤åŒç«¯é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚å¦‚æœåŒç«¯é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å›null</td></tr><tr><td style="text-align:left"><code>E getFirst()</code></td><td style="text-align:left">è¿”å›åŒç«¯é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚å¦‚æœåŒç«¯é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™å¼•å‘å¼‚å¸¸</td></tr><tr><td style="text-align:left"><code>E getLast()</code></td><td style="text-align:left">è¿”å›åŒç«¯é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚å¦‚æœåŒç«¯é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™å¼•å‘å¼‚å¸¸</td></tr><tr><td style="text-align:left"><code>E peekFirst()</code></td><td style="text-align:left">è¿”å›åŒç«¯é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚å¦‚æœåŒç«¯é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å›null</td></tr><tr><td style="text-align:left"><code>E peekLast()</code></td><td style="text-align:left">è¿”å›åŒç«¯é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚å¦‚æœåŒç«¯é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å›null</td></tr><tr><td style="text-align:left"><code>boolean removeFirstOccurrence(Object o)</code></td><td style="text-align:left">åˆ é™¤ç¬¬ä¸€æ¬¡å‡ºç°çš„æŒ‡å®šå…ƒç´ ,ä¸å­˜åœ¨æ—¶è¿”å›false</td></tr><tr><td style="text-align:left"><code>boolean removeLastOccurrence(Object o)</code></td><td style="text-align:left">åˆ é™¤æœ€åä¸€æ¬¡å‡ºç°çš„æŒ‡å®šå…ƒç´ ,ä¸å­˜åœ¨æ—¶è¿”å›false</td></tr></tbody></table><hr><p>Javaå †æ ˆStackç±»å·²ç»è¿‡æ—¶ï¼ŒJavaå®˜æ–¹æ¨èä½¿ç”¨Dequeæ›¿ä»£Stackä½¿ç”¨ã€‚</p><p>ä»¥ä¸‹æ˜¯Dequeæ¥å£æä¾›çš„ç”¨äºå®ç°æ ˆçš„æ–¹æ³•ï¼š</p><table><thead><tr><th style="text-align:left">æ–¹æ³•å</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left"><code>void push(E e)</code></td><td style="text-align:left">åœ¨åŒç«¯é˜Ÿåˆ—çš„å¼€å¤´æ·»åŠ å…ƒç´ </td></tr><tr><td style="text-align:left"><code>E pop()</code></td><td style="text-align:left">ä»åŒç«¯é˜Ÿåˆ—çš„å¼€å¤´åˆ é™¤å…ƒç´ </td></tr><tr><td style="text-align:left"><code>E peek()</code></td><td style="text-align:left">è¿”å›é˜Ÿåˆ—å¤´éƒ¨å…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å›null</td></tr></tbody></table><p>push = addFirst</p><p>pop = removeFirst</p><p>åªæ˜¯ä½¿ç”¨äº†ä¸åŒçš„æ–¹æ³•åä½“ç°é˜Ÿåˆ—è¡¨ç¤ºæ ˆç»“æ„æ—¶çš„ç‰¹ç‚¹</p><p>å½“æˆ‘ä»¬æŠŠDequeä½œä¸ºStackä½¿ç”¨æ—¶ï¼Œæ³¨æ„åªè°ƒç”¨push()/pop()/peek()æ–¹æ³•ï¼Œä¸è¦è°ƒç”¨addFirst()/removeFirst()/peekFirst()æ–¹æ³•ï¼Œè¿™æ ·ä»£ç æ›´åŠ æ¸…æ™°ã€‚</p><hr><p>å½“ peek() poll() peek() remove()è¿™äº›æ“ä½œä¸å¸¦Firstæ—¶ï¼Œé»˜è®¤æ˜¯firstï¼Œæ“ä½œå¯¹è±¡æ˜¯é˜Ÿé¦–</p><p>add()å’Œoffer()é»˜è®¤æ˜¯é˜Ÿå°¾</p><table><thead><tr><th style="text-align:left">Queueæ–¹æ³•</th><th style="text-align:left">ç­‰æ•ˆDequeæ–¹æ³•</th></tr></thead><tbody><tr><td style="text-align:left"><code>add(e)</code></td><td style="text-align:left"><code>addLast(e)</code></td></tr><tr><td style="text-align:left"><code>offer(e)</code></td><td style="text-align:left"><code>offerLast(e)</code></td></tr><tr><td style="text-align:left"><code>remove()</code></td><td style="text-align:left"><code>removeFirst()</code></td></tr><tr><td style="text-align:left"><code>poll()</code></td><td style="text-align:left"><code>pollFirst()</code></td></tr><tr><td style="text-align:left"><code>element()</code></td><td style="text-align:left"><code>getFirst()</code></td></tr><tr><td style="text-align:left"><code>peek()</code></td><td style="text-align:left"><code>peekFirst()</code></td></tr></tbody></table><hr><hr><h2 id="Queueéå†æ–¹å¼">Queueéå†æ–¹å¼</h2><p>Queueéå†æ–¹æ³•ä¸ŠåŸºæœ¬ä¸Šä¸Collectionçš„ä¸€è‡´ã€‚</p><ol><li>è¿­ä»£å™¨éå†</li><li>å¢å¼ºforéå†</li><li>Lambdaè¡¨è¾¾å¼</li></ol><div class="tag link"><a class="link-card" title="Collectioné›†åˆçš„éå†æ–¹å¼" href="/posts/71c14870.html#Collectionéå†æ–¹å¼"><div class="left"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/favicon.png"/></div><div class="right"><p class="text">Collectioné›†åˆçš„éå†æ–¹å¼</p><p class="url">/posts/71c14870.html#Collectionéå†æ–¹å¼</p></div></a></div>]]></content>
    
    
    <summary type="html">Queueä½“ç³»æ¶æ„ã€Queueæ¥å£æ–¹æ³•ã€Dequeæ¥å£æ–¹æ³•</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/tags/Java/"/>
    
    <category term="å®¹å™¨" scheme="https://wuwawawa.github.io/tags/%E5%AE%B9%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>HashSetå’ŒTreeSet</title>
    <link href="https://wuwawawa.github.io/posts/edc5fe5c.html"/>
    <id>https://wuwawawa.github.io/posts/edc5fe5c.html</id>
    <published>2023-05-20T03:29:18.000Z</published>
    <updated>2023-05-24T01:28:09.820Z</updated>
    
    <content type="html"><![CDATA[<img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/Set%E4%BD%93%E7%B3%BB%E5%9B%BE1.jpg" alt="Setä½“ç³»å›¾1" style="zoom:50%;" /><h2 id="HashSet">HashSet</h2><p>HashSeté›†åˆåº•å±‚é‡‡å–å“ˆå¸Œè¡¨(HashMap)å­˜å‚¨æ•°æ®,<s>èº«åœ¨Collectionå¿ƒåœ¨ Map</s></p><p>å“ˆå¸Œè¡¨æ˜¯ä¸€ç§å¯¹äºå¢åˆ æ”¹æŸ¥æ•°æ®æ€§èƒ½éƒ½è¾ƒå¥½çš„ç»“æ„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">HashSet</span><span class="params">()</span> &#123;</span><br><span class="line">    map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="å“ˆå¸Œè¡¨ç»„æˆ">å“ˆå¸Œè¡¨ç»„æˆ</h3><p>JDK8ä¹‹å‰ï¼šæ•°ç»„+é“¾è¡¨</p><p>JDK8å¼€å§‹ï¼šæ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘</p><p>åœ¨å“ˆå¸Œè¡¨ä¸­ï¼Œæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„å€¼å«åšå“ˆå¸Œå€¼ï¼Œæ˜¯å“ˆå¸Œè¡¨çš„çµé­‚æ‰€åœ¨ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230520194828555.png" alt="image-20230520194828555" style="zoom:67%;" /><p>å¦‚æœå·²ç»é‡å†™hashcodeæ–¹æ³•ï¼Œä¸åŒçš„å¯¹è±¡åªè¦å±æ€§å€¼ç›¸åŒï¼Œè®¡ç®—å‡ºçš„å“ˆå¸Œå€¼å°±æ˜¯ä¸€æ ·çš„ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230520195353131.png" alt="image-20230520195353131" style="zoom:75%;" /><p>åœ¨å°éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œä¸åŒçš„å±æ€§å€¼æˆ–è€…ä¸åŒçš„åœ°å€å€¼è®¡ç®—å‡ºæ¥çš„å“ˆå¸Œå€¼ä¹Ÿæœ‰å¯èƒ½ä¸€æ ·ã€‚ï¼ˆ<span class='p red'>å“ˆå¸Œç¢°æ’</span>ï¼‰</p><hr><h3 id="åº•å±‚åŸç†">åº•å±‚åŸç†</h3><div class="tabs" id="515cce44-45a3-4097-8f7e-6ad0a4ce246a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#515cce44-45a3-4097-8f7e-6ad0a4ce246a-1"><i class="fas fa-cat"></i>HashSetJDK8ä»¥å‰åº•å±‚åŸç†</button></li><li class="tab"><button type="button" data-href="#515cce44-45a3-4097-8f7e-6ad0a4ce246a-2"><i class="fas fa-horse"></i>HashSetJDK8åº•å±‚åŸç†</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="515cce44-45a3-4097-8f7e-6ad0a4ce246a-1"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/14_JKD8%E4%BB%A5%E5%89%8D%E5%93%88%E5%B8%8C%E8%A1%A8.png" alt="14_JKD8ä»¥å‰å“ˆå¸Œè¡¨"  /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="515cce44-45a3-4097-8f7e-6ad0a4ce246a-2"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/15_JKD8%E4%BB%A5%E5%90%8E%E5%93%88%E5%B8%8C%E8%A1%A8.png" alt="15_JKD8ä»¥åå“ˆå¸Œè¡¨"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><ol><li><p><code>HashSet&lt;String&gt; hm = new HashSet&lt;&gt;();</code></p></li><li><p><code>int index = (æ•°ç»„é•¿åº¦-1) &amp; å“ˆå¸Œå€¼;</code></p></li><li><p>ä¸€æ ·ï¼šä¸å­˜</p><p>ä¸ä¸€æ ·ï¼šå­˜å…¥æ•°ç»„ï¼Œå½¢æˆé“¾è¡¨</p><ul><li><p>JDK8ä»¥å‰ï¼šæ–°æ•°ç»„å­˜å…¥æ•°ç»„ï¼Œè€å…ƒç´ æŒ‚åœ¨æ–°å…ƒç´ ä¸‹é¢</p></li><li><p>JDK8ä»¥åï¼šæ–°å…ƒç´ ç›´æ¥æŒ‚åœ¨è€å…ƒç´ ä¸‹é¢</p></li></ul></li></ol><p>æ‰©å®¹æ—¶æœºï¼š</p><ul><li>å½“æ•°ç»„ä¸­å­˜äº†16*0.75=12ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œé‚£ä¹ˆæ•°ç»„å°±ä¼šæ‰©å®¹æˆåŸå…ˆçš„ä¸¤å€ã€‚</li><li>JDK8ä»¥åï¼Œå½“è”è¡¨é•¿åº¦<span class='p red'>è¶…è¿‡8</span>ï¼Œä¸”æ•°ç»„é•¿åº¦<span class='p red'>å¤§äºç­‰äº64</span>ï¼Œé‚£ä¹ˆå½“å‰çš„é“¾è¡¨å°±ä¼šè‡ªåŠ¨è½¬æˆçº¢é»‘æ ‘ã€‚</li></ul><blockquote><p>æ³¨æ„</p></blockquote><p>å¦‚æœé›†åˆä¸­å­˜å‚¨çš„æ˜¯è‡ªå®šä¹‰å¯¹è±¡ï¼Œå¿…é¡»è¦é‡å†™<span class='p red'>hashCode</span>å’Œ<span class='p red'>equals</span>æ–¹æ³•</p><hr><h3 id="HashSetçš„ä¸‰ä¸ªé—®é¢˜">HashSetçš„ä¸‰ä¸ªé—®é¢˜</h3><div class="tabs" id="eddb45d3-b9a7-4d4c-8827-37b9acb7a487"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#eddb45d3-b9a7-4d4c-8827-37b9acb7a487-1"><i class="fas fa-cat"></i>é—®é¢˜1</button></li><li class="tab"><button type="button" data-href="#eddb45d3-b9a7-4d4c-8827-37b9acb7a487-2"><i class="fas fa-horse"></i>é—®é¢˜2</button></li><li class="tab"><button type="button" data-href="#eddb45d3-b9a7-4d4c-8827-37b9acb7a487-3"><i class="fas fa-dove"></i>é—®é¢˜3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="eddb45d3-b9a7-4d4c-8827-37b9acb7a487-1"><blockquote><p>é—®é¢˜1ï¼šHashSetä¸ºä»€ä¹ˆå­˜å’Œå–çš„é¡ºåºä¸ä¸€æ ·ï¼Ÿ</p></blockquote><p>HashSet éå†å…ƒç´ çš„é¡ºåºæ˜¯åŸºäºå“ˆå¸Œè¡¨ä¸­å…ƒç´ çš„å­˜å‚¨ä½ç½®æ¥è¿›è¡Œçš„ï¼Œä»æ•°ç»„çš„0ç´¢å¼•å¼€å§‹ï¼Œä¸€æ¡é“¾è¡¨ä¸€æ¡é“¾è¡¨è¿™æ ·éå†çš„ã€‚ï¼Œè€Œå“ˆå¸Œè¡¨ä¸­å…ƒç´ çš„å­˜å‚¨ä½ç½®æ˜¯ç”±å“ˆå¸Œå€¼å†³å®šçš„ï¼Œå› æ­¤ï¼Œå…ƒç´ çš„éå†é¡ºåºä¸å…ƒç´ æ·»åŠ çš„é¡ºåºæ— å…³ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230520212602484.png" alt="image-20230520212602484" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="eddb45d3-b9a7-4d4c-8827-37b9acb7a487-2"><blockquote><p>é—®é¢˜2ï¼šHashSetä¸ºä»€ä¹ˆæ²¡æœ‰ç´¢å¼•ï¼Ÿ</p></blockquote><p>ç´¢å¼•æ²¡æœ‰æ„ä¹‰</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="eddb45d3-b9a7-4d4c-8827-37b9acb7a487-3"><blockquote><p>HashSetæ˜¯åˆ©ç”¨ä»€ä¹ˆæœºåˆ¶ä¿è¯æ•°æ®å»é‡çš„ï¼Ÿ</p></blockquote><p>HashCodeæ–¹æ³•+equalsæ–¹æ³•</p><p>åˆ©ç”¨HashCodeæ–¹æ³•å¾—åˆ°Hashå€¼ï¼Œå¾—åˆ°Hashå€¼åå°±å¯ä»¥çŸ¥é“å½“å‰å…ƒç´ æ˜¯æ·»åŠ åˆ°æ•°ç»„ä¸­çš„å“ªä¸ªä½ç½®ã€‚</p><p>å¦‚æœè¯¥ä½ç½®å·²ç»å­˜åœ¨å…ƒç´ ï¼ŒHashSetä¼šequalsæ–¹æ³•æ¯”è¾ƒè¯¥å…ƒç´ ä¸å·²å­˜åœ¨å…ƒç´ çš„å€¼å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰åˆ™ä¸è¿›è¡Œæ“ä½œï¼Œå¦‚æœä¸ç›¸ç­‰åˆ™å°†è¯¥å…ƒç´ åŠ å…¥ HashSet ä¸­ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="æ¡ˆä¾‹æ¼”ç¤º">æ¡ˆä¾‹æ¼”ç¤º</h3><div class="tabs" id="b39c48bf-8146-47ec-b2a0-8db90e8ab7c8"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#b39c48bf-8146-47ec-b2a0-8db90e8ab7c8-1"><i class="fas fa-bug"></i>1</button></li><li class="tab"><button type="button" data-href="#b39c48bf-8146-47ec-b2a0-8db90e8ab7c8-2"><i class="fas fa-cannabis"></i>2</button></li><li class="tab"><button type="button" data-href="#b39c48bf-8146-47ec-b2a0-8db90e8ab7c8-3"><i class="fas fa-candy-cane"></i>3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="b39c48bf-8146-47ec-b2a0-8db90e8ab7c8-1"><p>æ­¤æ—¶å¹¶æ²¡æœ‰é‡å†™equalså’ŒHashcodeæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b39c48bf-8146-47ec-b2a0-8db90e8ab7c8-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.åˆ›å»ºä¸‰ä¸ªå­¦ç”Ÿå¯¹è±¡</span></span><br><span class="line"><span class="type">Student</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;zhangsan&quot;</span>, <span class="number">23</span>);</span><br><span class="line"><span class="type">Student</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;zhangsan&quot;</span>, <span class="number">23</span>);</span><br><span class="line"><span class="type">Student</span> <span class="variable">s3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;lisi&quot;</span>, <span class="number">24</span>);</span><br><span class="line"><span class="type">Student</span> <span class="variable">s4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;wangwu&quot;</span>, <span class="number">25</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.åˆ›å»ºé›†åˆæ·»åŠ å…ƒç´ </span></span><br><span class="line">HashSet&lt;Student&gt; hs = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.æ·»åŠ å…ƒç´ </span></span><br><span class="line">System.out.println(hs.add(s1));</span><br><span class="line">System.out.println(hs.add(s2));</span><br><span class="line">System.out.println(hs.add(s3));</span><br><span class="line">System.out.println(hs.add(s4));</span><br><span class="line"><span class="comment">//4.æ‰“å°é›†åˆ</span></span><br><span class="line">System.out.println(hs);</span><br></pre></td></tr></table></figure><p>true<br>true<br>true<br>true<br>[Student(name=zhangsan, age=23), Student(name=lisi, age=24), Student(name=zhangsan, age=23), Student(name=wangwu, age=25)]</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b39c48bf-8146-47ec-b2a0-8db90e8ab7c8-3"><p>åœ¨Studentç±»æ·»åŠ ä¸Š@EqualsAndHashCodeåè¾“å‡ºï¼š</p><p>true<br>false<br>true<br>true<br>[Student(name=zhangsan, age=23), Student(name=lisi, age=24), Student(name=wangwu, age=25)]</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="LinkedHashSet">LinkedHashSet</h2><p>LinkedHashSetç»§æ‰¿äºHashSetï¼Œæ–¹æ³•ä¸HashSetä¸€è‡´ã€‚</p><p>LinkedHashSetåº•å±‚æ˜¯ä¸€ä¸ª LinkedHashMapï¼Œåº•å±‚ç»´æŠ¤äº†ä¸€ä¸ª<span class='p green'>æ•°ç»„+åŒå‘é“¾è¡¨</span></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">LinkedHashSet</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="built_in">super</span>(<span class="number">16</span>, <span class="number">.75f</span>, <span class="literal">true</span>);</span><br><span class="line">   &#125;</span><br><span class="line">HashSet(<span class="type">int</span> initialCapacity, <span class="type">float</span> loadFactor, <span class="type">boolean</span> dummy) &#123;</span><br><span class="line">       map = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;(initialCapacity, loadFactor);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><ul><li><span class='p red'>æœ‰åº</span>ã€ä¸é‡å¤ã€æ— ç´¢å¼•ã€‚</li><li>è¿™é‡Œçš„æœ‰åºæŒ‡çš„æ˜¯ä¿è¯å­˜å‚¨å’Œå–å‡ºçš„å…ƒç´ é¡ºåºä¸€è‡´ã€‚</li><li><span class='p red'>åŸç†</span>ï¼šåº•å±‚æ•°æ®ç»“æ„æ˜¯ä¾ç„¶å“ˆå¸Œè¡¨ï¼Œåªæ˜¯æ¯ä¸ªå…ƒç´ åˆé¢å¤–çš„å¤šäº†ä¸€ä¸ªåŒé“¾è¡¨çš„æœºåˆ¶è®°å½•å­˜å‚¨çš„é¡ºåºã€‚</li></ul><p>ä¾‹å­</p><ul><li>ç¬¬ä¸€ä¸ªå…ƒç´ æ ¹æ®Hashå€¼å¾—åˆ°æ•°ç»„ä¸­è¯¥å­˜å…¥çš„ä½ç½®ä¸º8ï¼Œè¯¥ä½ç½®æ²¡æœ‰å…ƒç´ ä¸ºnullï¼Œç›´æ¥æ·»åŠ è¿›å»ï¼Œäºæ­¤åŒæ—¶åº•å±‚è¿˜å¤šäº†åŒå‘é“¾è¡¨ï¼Œå¤´ç»“ç‚¹å°±ä¸ºåˆšåˆšæ·»åŠ çš„å…ƒç´ </li><li>ç»§ç»­æ·»åŠ ç¬¬äºŒä¸ªå…ƒç´ ï¼Œè®¡ç®—å‡ºç¬¬äºŒä¸ªå…ƒç´ è¯¥å­˜å…¥çš„ç´¢å¼•ä¸º3ç´¢å¼•ï¼Œæ²¡æœ‰å…ƒç´ ç›´æ¥æ·»åŠ ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ ç¬¬äºŒä¸ªå…ƒç´ ç›´æ¥å½¢æˆåŒå‘é“¾è¡¨</li><li>ç»§ç»­æ·»åŠ ç¬¬ä¸‰ä¸ªå…ƒç´ ï¼Œæ ¹æ®Hashå€¼è®¡ç®—å‡ºç¬¬ä¸‰ä¸ªå…ƒç´ è¯¥å­˜å…¥çš„ç´¢å¼•ä¸º3ç´¢å¼•ï¼Œå­˜åœ¨å…ƒç´ ï¼Œæ ¹æ®equalsæ–¹æ³•ï¼Œæ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡å±æ€§å€¼æ˜¯å¦ç›¸ç­‰ï¼Œä¸ä¸€æ ·ï¼Œæ ¹æ®JDK8ä»¥åçš„è§„åˆ™ï¼Œæ–°çš„å…ƒç´ æŒ‚åœ¨ä¸‹é¢ï¼Œäºæ­¤åŒæ—¶ï¼Œç¬¬äºŒä¸ªå…ƒç´ å’Œç¬¬ä¸‰ä¸ªå…ƒç´ è¿˜è¦å†å½¢æˆåŒå‘é“¾è¡¨</li><li>ç»§ç»­æ·»åŠ ç¬¬å››ä¸ªå…ƒç´ ï¼Œè®¡ç®—å‡ºç¬¬äºŒä¸ªå…ƒç´ è¯¥å­˜å…¥çš„ç´¢å¼•ä¸º0ç´¢å¼•ï¼Œä¸ç¬¬ä¸‰ä¸ªå…ƒç´ å½¢æˆåŒå‘é“¾è¡¨</li><li>æ·»åŠ å®Œæˆï¼Œæ­¤æ—¶å¤´ç»“ç‚¹å°±ä¸º8å…ƒç´ ï¼Œå°¾èŠ‚ç‚¹ä¸º0å…ƒç´ </li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230521133546661.png" alt="image-20230521133546661"></p><p>åœ¨éå†çš„æ—¶å€™å°±å’ŒHashSetä¸ä¸€æ ·äº†ï¼ˆä»æ•°ç»„çš„0ç´¢å¼•å¼€å§‹ä¸€æ¡é“¾è¡¨ä¸€æ¡é“¾è¡¨éå†ï¼‰ï¼Œåœ¨LinkedHashSetä¸­ï¼Œä»å¤´ç»“ç‚¹å¼€å§‹ä»¥æ­¤éå†ï¼Œç›´è‡³å°¾èŠ‚ç‚¹ã€‚</p><p>è¿™æ—¶å€™è·å¾—çš„æ•°æ®ï¼Œå°±å’Œæ·»åŠ å…ƒç´ çš„é¡ºåºä¸€æ ·äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.åˆ›å»ºä¸‰ä¸ªå­¦ç”Ÿå¯¹è±¡</span></span><br><span class="line"><span class="type">Student</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;zhangsan&quot;</span>, <span class="number">23</span>);</span><br><span class="line"><span class="type">Student</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;zhangsan&quot;</span>, <span class="number">23</span>);</span><br><span class="line"><span class="type">Student</span> <span class="variable">s3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;lisi&quot;</span>, <span class="number">24</span>);</span><br><span class="line"><span class="type">Student</span> <span class="variable">s4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;wangwu&quot;</span>, <span class="number">25</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.åˆ›å»ºé›†åˆæ·»åŠ å…ƒç´ </span></span><br><span class="line">LinkedHashSet&lt;Student&gt; lhs = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.æ·»åŠ å…ƒç´ </span></span><br><span class="line">System.out.println(lhs.add(s1));</span><br><span class="line">System.out.println(lhs.add(s2));</span><br><span class="line">System.out.println(lhs.add(s3));</span><br><span class="line">System.out.println(lhs.add(s4));</span><br><span class="line"><span class="comment">//4.æ‰“å°é›†åˆ</span></span><br><span class="line">System.out.println(lhs);</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><p>true<br>false<br>true<br>true<br>[Student(name=zhangsan, age=23), Student(name=lisi, age=24), Student(name=wangwu, age=25)]</p><hr><hr><h2 id="TreeSet">TreeSet</h2><h3 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h3><p>å»¶ç»­äº†Seté›†åˆä¸¤ä¸ªç‰¹ç‚¹ï¼šä¸é‡å¤ã€æ— ç´¢å¼•</p><p>ä½†æ˜¯TreeSetå¤šäº†ä¸€ä¸ªç‰¹ç‚¹ï¼š<span class='p red'>å¯æ’åº</span></p><p>å¯æ’åºï¼šæŒ‰ç…§å…ƒç´ çš„é»˜è®¤è§„åˆ™ï¼ˆæœ‰å°åˆ°å¤§ï¼‰æ’åºã€‚</p><p>TreeSeté›†åˆåº•å±‚æ˜¯åŸºäº<span class='p red'>çº¢é»‘æ ‘</span>çš„æ•°æ®ç»“æ„å®ç°æ’åºçš„ï¼Œå¢åˆ æ”¹æŸ¥æ€§èƒ½éƒ½è¾ƒå¥½ã€‚</p><p>ä¸ä¾èµ–Hashcodeå’Œequalsæ–¹æ³•</p><hr><h3 id="æ–¹æ³•">æ–¹æ³•</h3><p>TreeSetå®ç°äº†NavigableSetï¼ŒNavigableSetæ˜¯ä¸€ä¸ªæ¥å£ï¼Œç»§æ‰¿è‡ªSortedSetæ¥å£ï¼Œç”¨äºå®ç°å¯å¯¼èˆªçš„Setã€‚å®ƒå…·æœ‰SortedSetæ‰€æ‹¥æœ‰çš„ä¸€äº›åŠŸèƒ½ï¼Œæ¯”å¦‚èƒ½å¤Ÿè‡ªåŠ¨è¿›è¡Œæ’åºã€å»é‡ç­‰ï¼ŒåŒæ—¶è¿˜å…·å¤‡ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼Œæ¯”å¦‚é¡ºåºéå†å…ƒç´ ã€è·å–ç‰¹å®šåŒºé—´å†…çš„å…ƒç´ ç­‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TreeSet</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">AbstractSet</span>&lt;E&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">NavigableSet</span>&lt;E&gt;, Cloneable, java.io.Serializable</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left">æ–¹æ³•å</th><th style="text-align:left">æ¥æº</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left"><code>E first()</code></td><td style="text-align:left"><code>SortedSet</code></td><td style="text-align:left">è·å–å½“å‰é›†åˆçš„é¦–å…ƒç´ </td></tr><tr><td style="text-align:left"><code>E last()</code></td><td style="text-align:left"><code>SortedSet</code></td><td style="text-align:left">è·å–å½“å‰é›†åˆçš„å°¾å…ƒç´ </td></tr><tr><td style="text-align:left"><code>SortedSet&lt;E&gt; headSet(E toElement)</code></td><td style="text-align:left"><code>SortedSet</code></td><td style="text-align:left">è¿”å›å€¼å°äºçš„toElementå­é›†</td></tr><tr><td style="text-align:left"><code>SortedSet&lt;E&gt; tailSet(E fromElement)</code></td><td style="text-align:left"><code>SortedSet</code></td><td style="text-align:left">è¿”å›å€¼å¤§äºæˆ–ç­‰äºfromElementçš„å­é›†</td></tr><tr><td style="text-align:left"><code>SortedSet&lt;E&gt; subSet(E fromElement, E toElement)</code></td><td style="text-align:left"><code>SortedSet</code></td><td style="text-align:left">è¿”å›å€¼èŒƒå›´ä¸º[fromElement,toElement)èŒƒå›´çš„å­é›†</td></tr><tr><td style="text-align:left"><code>Iterator&lt;E&gt; iterator()</code></td><td style="text-align:left"><code>SortedSet</code></td><td style="text-align:left">è¿”å›è¿­ä»£å™¨</td></tr><tr><td style="text-align:left"><code>E lower(E e)</code></td><td style="text-align:left"><code>NavigableSet</code></td><td style="text-align:left">è¿”å›å°äºæŒ‡å®šå…ƒç´ çš„é‚£äº›å…ƒç´ ä¸­æœ€å¤§çš„å…ƒç´ </td></tr><tr><td style="text-align:left"><code>E floor(E e)</code></td><td style="text-align:left"><code>NavigableSet</code></td><td style="text-align:left">å›å°äºæˆ–ç­‰äºæŒ‡å®šå…ƒç´ çš„é‚£äº›å…ƒç´ ä¸­æœ€å¤§çš„å…ƒç´ </td></tr><tr><td style="text-align:left"><code>E ceiling(E e)</code></td><td style="text-align:left"><code>NavigableSet</code></td><td style="text-align:left">è¿”å›å¤§äºæˆ–ç­‰äºæŒ‡å®šå…ƒç´ çš„é‚£äº›å…ƒç´ ä¸­çš„æœ€å°å…ƒç´ </td></tr><tr><td style="text-align:left"><code>E higher(E e)</code></td><td style="text-align:left"><code>NavigableSet</code></td><td style="text-align:left">è¿”å›å¤§äºæŒ‡å®šå…ƒç´ çš„é‚£äº›å…ƒç´ ä¸­çš„æœ€å°å…ƒç´ </td></tr><tr><td style="text-align:left"><code>E pollFirst()</code></td><td style="text-align:left"><code>NavigableSet</code></td><td style="text-align:left">è¿”å›å¹¶ä»é›†åˆä¸­åˆ é™¤ç¬¬ä¸€ä¸ªå…ƒç´ </td></tr><tr><td style="text-align:left"><code>E pollLast()</code></td><td style="text-align:left"><code>NavigableSet</code></td><td style="text-align:left">è¿”å›å¹¶ä»é›†åˆä¸­åˆ é™¤æœ€åä¸€ä¸ªå…ƒç´ </td></tr><tr><td style="text-align:left"><code>Iterator&lt;E&gt; descendingIterator()</code></td><td style="text-align:left"><code>NavigableSet</code></td><td style="text-align:left">è¿”å›å¯ç”¨äºä»¥ç›¸åé¡ºåºè¿­ä»£é›†åˆçš„è¿­ä»£å™¨</td></tr></tbody></table><hr><h3 id="é»˜è®¤æ’åºè§„åˆ™">é»˜è®¤æ’åºè§„åˆ™</h3><ul><li><p>å¯¹äºæ•°å€¼ç±»å‹ï¼šIntegerï¼ŒDoubleï¼Œé»˜è®¤æŒ‰ç…§ä»å°åˆ°å¤§çš„é¡ºåºè¿›è¡Œæ’åºã€‚</p></li><li><p>å¯¹äºå­—ç¬¦ã€å­—ç¬¦ä¸²ç±»å‹ï¼šæŒ‰ç…§å­—ç¬¦åœ¨ASCIç è¡¨ä¸­çš„æ•°å­—å‡åºè¿›è¡Œæ’åºã€‚</p></li><li><p>å¦‚æœè¦ä½¿ç”¨è‡ªå®šä¹‰çš„æ’åºè§„åˆ™æ¥æ’åºå…ƒç´ ï¼Œå¯ä»¥åœ¨åˆ›å»ºTreeSetæ—¶ä¼ å…¥ä¸€ä¸ªComparatorå¯¹è±¡ï¼Œå®ç°è‡ªå®šä¹‰çš„æ¯”è¾ƒé€»è¾‘ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒTreeSetä¼šæ ¹æ®Comparatorå¯¹è±¡çš„æ¯”è¾ƒç»“æœæ¥æ’åºå…ƒç´ ã€‚</p></li></ul><hr><h3 id="æ¡ˆä¾‹æ¼”ç¤º-2">æ¡ˆä¾‹æ¼”ç¤º</h3><p>éœ€æ±‚ï¼šåˆ›å»ºTreeSeté›†åˆï¼Œå¹¶æ·»åŠ 3ä¸ªå­¦ç”Ÿå¯¹è±¡</p><p>å­¦ç”Ÿå¯¹è±¡å±æ€§ï¼šå§“åï¼Œå¹´é¾„ã€‚</p><p>è¦æ±‚æŒ‰ç…§å­¦ç”Ÿçš„å¹´é¾„è¿›è¡Œæ’åºï¼ŒåŒå¹´é¾„æŒ‰ç…§å§“åå­—æ¯æ’åˆ—ï¼ˆæš‚ä¸è€ƒè™‘ä¸­æ–‡ï¼‰ åŒå§“åï¼ŒåŒå¹´é¾„è®¤ä¸ºæ˜¯åŒä¸€ä¸ªäºº</p><div class="tabs" id="876ca747-d446-48f5-8a59-9b81d6730fb3"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#876ca747-d446-48f5-8a59-9b81d6730fb3-1"><i class="fas fa-cat"></i>Studentç±»</button></li><li class="tab"><button type="button" data-href="#876ca747-d446-48f5-8a59-9b81d6730fb3-2"><i class="fas fa-dove"></i>æ¯”è¾ƒå™¨æ’åº</button></li><li class="tab"><button type="button" data-href="#876ca747-d446-48f5-8a59-9b81d6730fb3-3"><i class="fas fa-horse"></i>beanç±»å®ç°Comparableæ¥å£æŒ‡å®šæ¯”è¾ƒè§„åˆ™</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="876ca747-d446-48f5-8a59-9b81d6730fb3-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="876ca747-d446-48f5-8a59-9b81d6730fb3-2"><p>åˆ›å»ºTreeSetå¯¹è±¡æ—¶å€™ï¼Œä¼ é€’æ¯”è¾ƒå™¨ComparatoræŒ‡å®šè§„åˆ™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.åˆ›å»ºä¸‰ä¸ªå­¦ç”Ÿå¯¹è±¡</span></span><br><span class="line"><span class="type">Student</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;zhangsan&quot;</span>, <span class="number">23</span>);</span><br><span class="line"><span class="type">Student</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;zhangsan&quot;</span>, <span class="number">24</span>);</span><br><span class="line"><span class="type">Student</span> <span class="variable">s3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;wangwu&quot;</span>, <span class="number">25</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.åˆ›å»ºé›†åˆæ·»åŠ å…ƒç´ </span></span><br><span class="line">TreeSet&lt;Student&gt; ts = <span class="keyword">new</span> <span class="title class_">TreeSet</span>&lt;&gt;((stu1,stu2)-&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span> (stu1.getAge()==stu2.getAge())&#123;</span><br><span class="line">        <span class="keyword">return</span> stu1.getName().compareTo(stu2.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> stu1.getAge()-stu2.getAge();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//3.æ·»åŠ å…ƒç´ </span></span><br><span class="line">ts.add(s1);</span><br><span class="line">ts.add(s2);</span><br><span class="line">ts.add(s3);</span><br><span class="line"><span class="comment">//4.æ‰“å°é›†åˆ</span></span><br><span class="line">System.out.println(ts);</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><p>[Student(name=zhangsan, age=23), Student(name=zhangsan, age=24), Student(name=wangwu, age=25)]</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="876ca747-d446-48f5-8a59-9b81d6730fb3-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">implements</span> <span class="title class_">Comparable</span>&lt;Student&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compareTo</span><span class="params">(Student o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.getAge()==o.getAge())&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.getName().compareTo(o.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getAge()-o.getAge();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š[Student(name=zhangsan, age=23), Student(name=zhangsan, age=24), Student(name=wangwu, age=25)]</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><span class='p red'>æ³¨æ„</span><p>å¦‚æœä¸¤ç§æ–¹å¼éƒ½å­˜åœ¨ï¼Œä¼˜å…ˆé€‰æ‹©ä¼ å…¥çš„æ¯”è¾ƒå™¨</p><hr><h3 id="æ€»ç»“">æ€»ç»“</h3><blockquote><p>Tree Seté›†åˆçš„ç‰¹ç‚¹æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ</p></blockquote><p>å¯æ’åºã€ä¸é‡å¤ã€æ— ç´¢å¼•</p><p>åº•å±‚åŸºäºçº¢é»‘æ ‘å®ç°æ’åºï¼Œå¢åˆ æ”¹æŸ¥æ€§èƒ½è¾ƒå¥½</p><blockquote><p>TreeSeté›†åˆè‡ªå®šä¹‰æ’åºè§„åˆ™æœ‰å‡ ç§æ–¹å¼</p></blockquote><p>æ–¹å¼ä¸€ï¼šJavabeanç±»å®ç°Comparableæ¥å£ï¼ŒæŒ‡å®šæ¯”è¾ƒè§„åˆ™</p><p>æ–¹å¼äºŒï¼šåˆ›å»ºé›†åˆæ—¶ï¼Œè‡ªå®šä¹‰Comparatoræ¯”è¾ƒå™¨å¯¹è±¡ï¼ŒæŒ‡å®šæ¯”è¾ƒè§„åˆ™</p><blockquote><p>æ–¹æ³•è¿”å›å€¼çš„ç‰¹ç‚¹</p></blockquote><p>è´Ÿæ•°ï¼šè¡¨ç¤ºå½“å‰è¦æ·»åŠ çš„å…ƒç´ æ˜¯å°çš„ï¼Œå­˜å·¦è¾¹</p><p>æ­£æ•°ï¼šè¡¨ç¤ºå½“å‰è¦æ·»åŠ çš„å…ƒç´ æ˜¯å¤§çš„ï¼Œå­˜å³è¾¹</p><p>0ï¼šè¡¨ç¤ºå½“å‰è¦æ·»åŠ çš„å…ƒç´ å·²ç»å­˜åœ¨ï¼Œèˆå¼ƒ</p><hr><hr><h2 id="æ€»ç»“-2">æ€»ç»“</h2><ol><li><p>å¦‚æœæƒ³è¦é›†åˆä¸­çš„å…ƒç´ å¯é‡å¤</p><ul><li>ç”¨ArrayListé›†åˆï¼ŒåŸºäºæ•°ç»„çš„ã€‚<span class='p red'>ï¼ˆç”¨çš„æœ€å¤šï¼‰</span></li></ul></li><li><p>å¦‚æœæƒ³è¦é›†åˆä¸­çš„å…ƒç´ å¯é‡å¤ï¼Œè€Œä¸”å½“å‰çš„<span class='p red'>å¢åˆ æ“ä½œæ˜æ˜¾å¤šäºæŸ¥è¯¢</span></p><ul><li>ç”¨LinkedListé›†åˆï¼ŒåŸºäºé“¾è¡¨çš„ã€‚</li></ul></li><li><p>å¦‚æœæƒ³å¯¹é›†åˆä¸­çš„å…ƒç´ å»é‡</p><ul><li>ç”¨HashSeté›†åˆï¼ŒåŸºäºå“ˆå¸Œè¡¨çš„ã€‚<span class='p red'>ï¼ˆç”¨çš„æœ€å¤šï¼‰</span></li></ul></li><li><p>å¦‚æœæƒ³å¯¹é›†åˆä¸­çš„å…ƒç´ å»é‡ï¼Œè€Œä¸”<span class='p red'>ä¿è¯å­˜å–é¡ºåº</span></p><ul><li>ç”¨LinkedHashSeté›†åˆï¼ŒåŸºäºå“ˆå¸Œè¡¨å’ŒåŒé“¾è¡¨ï¼Œæ•ˆç‡ä½äºHashSetã€‚</li></ul></li><li><p>å¦‚æœæƒ³å¯¹é›†åˆä¸­çš„å…ƒç´ è¿›è¡Œ<span class='p red'>æ’åº</span></p><ul><li>ç”¨TreeSeté›†åˆï¼ŒåŸºäºçº¢é»‘æ ‘ã€‚åç»­ä¹Ÿå¯ä»¥ç”¨Listé›†åˆå®ç°æ’åºã€‚</li></ul></li></ol>]]></content>
    
    
    <summary type="html">HashSetã€LinkedHashSetå’ŒTreeSetè§£æ</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/tags/Java/"/>
    
    <category term="å®¹å™¨" scheme="https://wuwawawa.github.io/tags/%E5%AE%B9%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>æ— åºé›†åˆæ¥å£Set</title>
    <link href="https://wuwawawa.github.io/posts/c6185e82.html"/>
    <id>https://wuwawawa.github.io/posts/c6185e82.html</id>
    <published>2023-05-20T02:36:16.000Z</published>
    <updated>2023-05-20T03:30:16.226Z</updated>
    
    <content type="html"><![CDATA[<img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/Set%E4%BD%93%E7%B3%BB%E5%9B%BE1.jpg" alt="Setä½“ç³»å›¾1" style="zoom:50%;" /><h2 id="Seté›†åˆçš„æ¦‚è¿°å’Œç‰¹ç‚¹">Seté›†åˆçš„æ¦‚è¿°å’Œç‰¹ç‚¹</h2><blockquote><p>Seté›†åˆçš„æ¦‚è¿°</p></blockquote><ul><li>æ— åºé›†åˆ,è¿™é‡Œçš„æ— åºæŒ‡çš„æ˜¯å­˜å–é¡ºåº</li><li>ç”¨æˆ·ä¸å¯ä»¥ç²¾ç¡®æ§åˆ¶åˆ—è¡¨ä¸­æ¯ä¸ªå…ƒç´ çš„æ’å…¥ä½ç½®</li><li>ä¸Listé›†åˆä¸åŒ,åˆ—è¡¨ä¸å…è®¸é‡å¤çš„å…ƒç´ </li></ul><blockquote><p>Seté›†åˆçš„ç‰¹ç‚¹</p></blockquote><ul><li>æ— åºï¼š å­˜å’Œå–çš„å…ƒç´ é¡ºåºä¸ä¸€è‡´</li><li>æ— ç´¢å¼•ï¼š æ²¡æœ‰å¸¦ç´¢å¼•çš„æ–¹æ³•ï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨æ™®é€šforå¾ªç¯éå†ï¼Œä¹Ÿä¸èƒ½é€šè¿‡ç´¢å¼•æ¥è·å–å…ƒç´ </li><li>ä¸é‡å¤ï¼š å¯ä»¥å»é™¤é‡å¤</li></ul><blockquote><p>Seté›†åˆçš„å®ç°ç±»</p></blockquote><ul><li>HashSetï¼šæ— åºã€ä¸é‡å¤ã€æ— ç´¢å¼•</li><li>LinkedHashSetï¼š<span class='p blue'>æœ‰åº</span>ã€ä¸é‡å¤ã€æ— ç´¢å¼•</li><li>TreeSetï¼š<span class='p green'>å¯æ’åº</span>ã€ä¸é‡å¤ã€æ— ç´¢å¼•</li></ul><h2 id="Seté›†åˆæ–¹æ³•">Seté›†åˆæ–¹æ³•</h2><p>Setæ¥å£ä¸­çš„æ–¹æ³•ä¸ŠåŸºæœ¬ä¸Šä¸Collectionçš„APIä¸€è‡´ã€‚</p><table><thead><tr><th style="text-align:left">æ–¹æ³•å</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left">boolean add(E e)</td><td style="text-align:left">æ·»åŠ å…ƒç´ </td></tr><tr><td style="text-align:left">boolean addAll(Collection&lt;? extends E&gt; c)</td><td style="text-align:left">æ·»åŠ å¤šä¸ªå…ƒç´ </td></tr><tr><td style="text-align:left">boolean remove(Object o)</td><td style="text-align:left">ç§»é™¤æŒ‡å®šçš„å…ƒç´ </td></tr><tr><td style="text-align:left">boolean removeIf(Predicate&lt;? super E&gt; filter)</td><td style="text-align:left">æ ¹æ®æ¡ä»¶è¿›è¡Œç§»é™¤</td></tr><tr><td style="text-align:left">boolean removeAll(Collection&lt;?&gt; c);</td><td style="text-align:left">ç§»é™¤å¤šä¸ªå…ƒç´ </td></tr><tr><td style="text-align:left">void clear()</td><td style="text-align:left">æ¸…ç©ºé›†åˆä¸­çš„å…ƒç´ </td></tr><tr><td style="text-align:left">boolean contains(Object o)</td><td style="text-align:left">åˆ¤æ–­é›†åˆä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„å…ƒç´ </td></tr><tr><td style="text-align:left">boolean isEmpty()</td><td style="text-align:left">åˆ¤æ–­é›†åˆæ˜¯å¦ä¸ºç©º</td></tr><tr><td style="text-align:left">int size()</td><td style="text-align:left">é›†åˆçš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯é›†åˆä¸­å…ƒç´ çš„ä¸ªæ•°</td></tr></tbody></table><h2 id="Setéå†æ–¹å¼">Setéå†æ–¹å¼</h2><p>Setéå†æ–¹æ³•ä¸ŠåŸºæœ¬ä¸Šä¸Collectionçš„ä¸€è‡´ã€‚</p><ol><li>è¿­ä»£å™¨éå†</li><li>å¢å¼ºforéå†</li><li>Lambdaè¡¨è¾¾å¼</li></ol><div class="tag link"><a class="link-card" title="Collectioné›†åˆçš„éå†æ–¹å¼" href="/posts/71c14870.html#Collectionéå†æ–¹å¼"><div class="left"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/favicon.png"/></div><div class="right"><p class="text">Collectioné›†åˆçš„éå†æ–¹å¼</p><p class="url">/posts/71c14870.html#Collectionéå†æ–¹å¼</p></div></a></div>]]></content>
    
    
    <summary type="html">Setä¸­å¸¸è§çš„æ–¹æ³•å’Œéå†æ–¹å¼</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/tags/Java/"/>
    
    <category term="å®¹å™¨" scheme="https://wuwawawa.github.io/tags/%E5%AE%B9%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>ArrayListå’ŒLinkedList</title>
    <link href="https://wuwawawa.github.io/posts/7ec37ec5.html"/>
    <id>https://wuwawawa.github.io/posts/7ec37ec5.html</id>
    <published>2023-05-16T13:40:28.000Z</published>
    <updated>2023-05-24T00:23:13.248Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ArrayListç»§æ‰¿ä½“ç³»åˆ†æ">ArrayListç»§æ‰¿ä½“ç³»åˆ†æ</h2><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2519003-20220707231107149-2112590708.png" alt="img" style="zoom:67%;" /><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArrayList</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">AbstractList</span>&lt;E&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">List</span>&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable</span><br></pre></td></tr></table></figure><div class="tabs" id="41484376-eb71-4843-b44f-05f3c2bd6ccd"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#41484376-eb71-4843-b44f-05f3c2bd6ccd-1"><i class="fas fa-cookie-bite"></i>AbstractList</button></li><li class="tab"><button type="button" data-href="#41484376-eb71-4843-b44f-05f3c2bd6ccd-2"><i class="fas fa-dragon"></i>List</button></li><li class="tab"><button type="button" data-href="#41484376-eb71-4843-b44f-05f3c2bd6ccd-3"><i class="fas fa-cat"></i>RandomAccess</button></li><li class="tab"><button type="button" data-href="#41484376-eb71-4843-b44f-05f3c2bd6ccd-4"><i class="fas fa-dove"></i>Cloneable</button></li><li class="tab"><button type="button" data-href="#41484376-eb71-4843-b44f-05f3c2bd6ccd-5"><i class="fas fa-horse"></i>Serializable</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="41484376-eb71-4843-b44f-05f3c2bd6ccd-1"><p>è¿™ä¸ªæŠ½è±¡ç±»ä¹Ÿå®ç°äº†<code>List</code>æ¥å£é‡Œé¢çš„æ–¹æ³•ï¼Œå¹¶ä¸”ä¸ºå…¶æä¾›äº†é»˜è®¤ä»£ç å®ç°ï¼Œæ¯”å¦‚è¯´<code>AbstractList</code>ä¸­å¯¹<code>indexOf</code>çš„å®ç°å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯è¿”å›å¯¹è±¡ o åœ¨å®¹å™¨å½“ä¸­çš„ä¸‹æ ‡</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">indexOf</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="comment">// é€šè¿‡è¿­ä»£å™¨å»éå†æ•°æ®</span></span><br><span class="line">    ListIterator&lt;E&gt; it = listIterator();</span><br><span class="line">    <span class="keyword">if</span> (o==<span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext())</span><br><span class="line">            <span class="keyword">if</span> (it.next()==<span class="literal">null</span>)</span><br><span class="line">                <span class="comment">// è¿”å›æ•°æ® o çš„ä¸‹æ ‡</span></span><br><span class="line">                <span class="keyword">return</span> it.previousIndex();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext())</span><br><span class="line">            <span class="keyword">if</span> (o.equals(it.next()))</span><br><span class="line">                <span class="comment">// è¿”å›æ•°æ® o çš„ä¸‹æ ‡</span></span><br><span class="line">                <span class="keyword">return</span> it.previousIndex();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="41484376-eb71-4843-b44f-05f3c2bd6ccd-2"><p>è¿™ä¸ªæ¥å£ä¸»è¦å®šä¹‰äº†ä¸€äº›listé›†åˆå¸¸ç”¨çš„æ–¹æ³•è®©<code>ArrayList</code>è¿›è¡Œå®ç°ï¼Œ</p><p>æ¯”å¦‚<code>add</code>ï¼Œ<code>addAll</code>ï¼Œ<code>contains</code>ï¼Œ<code>remove</code>ï¼Œ<code>set</code>ï¼Œ<code>get</code>ï¼Œ<code>size</code>ï¼Œ<code>indexOf</code>ï¼Œ<code>listIterator</code>ç­‰ç­‰æ–¹æ³•ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="41484376-eb71-4843-b44f-05f3c2bd6ccd-3"><p>æ ‡è®°æ¥å£ï¼Œå†…éƒ¨å¹¶æ²¡æœ‰æŠ½è±¡æ–¹æ³•ã€‚</p><p>è¿™ä¸ªæ¥å£çš„å«ä¹‰è¡¨ç¤ºå¯ä»¥éšæœºè®¿é—®<code>ArrayList</code>å½“ä¸­çš„æ•°æ®ï¼Œæ‹¿ä»€ä¹ˆæ˜¯éšæœºè®¿é—®å‘¢ï¼Ÿéšæœºè®¿é—®å°±æ˜¯è¡¨ç¤ºæˆ‘ä»¬å¯ä»¥åœ¨å¸¸é‡æ—¶é—´å¤æ‚åº¦å†…è®¿é—®æ•°æ®ï¼Œä¹Ÿå°±æ˜¯æ—¶é—´å¤æ‚åº¦æ˜¯<code>O(1)</code>ã€‚å› ä¸ºåœ¨<code>ArrayList</code>å½“ä¸­æˆ‘ä»¬ä½¿ç”¨çš„æœ€åŸºæœ¬çš„æ•°æ®ç±»å‹æ˜¯<code>æ•°ç»„</code>ï¼Œè€Œæ•°ç»„æ˜¯å¯ä»¥éšæœºè®¿é—®çš„ã€‚</p><p>è€Œé“¾è¡¨æ˜¯ä¸å¯ä»¥éšæœºè®¿é—®çš„ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬æƒ³é€šè¿‡ä¸‹æ ‡è®¿é—®é“¾è¡¨å½“ä¸­çš„æŸä¸ªæ•°æ®ï¼Œéœ€è¦ä»å¤´ç»“ç‚¹æˆ–è€…å°¾èŠ‚ç‚¹å¼€å§‹éå†ï¼Œç›´åˆ°éå†åˆ°ä¸‹æ ‡å¯¹åº”çš„æ•°æ®ï¼Œæ¯”å¦‚ä¸‹å›¾ä¸­çš„å•é“¾è¡¨æ‰¾åˆ°ç¬¬3ä¸ªæ•°æ®ï¼Œéœ€è¦ä»å¤´å¼€å§‹éå†ï¼Œè€Œè¿™ä¸ªæ—¶é—´å¤æ‚åº¦ä¸º<code>O(n)</code>ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2519003-20220707231535445-1718441250.png" alt="img"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="41484376-eb71-4843-b44f-05f3c2bd6ccd-4"><p>å®ç°<code>Cloneable</code>æ¥å£é‚£ä¹ˆå®ç°<code>Cloneable</code>çš„ç±»å°±èƒ½å¤Ÿè°ƒç”¨<code>clone</code>è¿™ä¸ªæ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰å®ç°<code>Cloneable</code>æ¥å£å°±è°ƒç”¨æ–¹æ³•ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸<code>java.lang.CloneNotSupportedException</code>ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="41484376-eb71-4843-b44f-05f3c2bd6ccd-5"><p>Serializableæ¥å£ä¸»è¦ç”¨äºåºåˆ—åŒ–ï¼Œæ‰€è°“åºåˆ—åŒ–å°±æ˜¯èƒ½å°†å¯¹è±¡å†™å…¥ç£ç›˜ï¼Œååºåˆ—åŒ–å°±æ˜¯èƒ½å¤Ÿå°†å¯¹è±¡ä»ç£ç›˜å½“ä¸­è¯»å–å‡ºæ¥ï¼Œå¦‚æœæƒ³åºåˆ—åŒ–å’Œååºåˆ—åŒ–<code>ArrayList</code>çš„å®ä¾‹å¯¹è±¡å°±å¿…é¡»å®ç°è¿™ä¸ªæ¥å£ï¼Œå¦‚æœæ²¡æœ‰å®ç°è¿™ä¸ªæ¥å£ï¼Œåœ¨å®ä¾‹åŒ–çš„æ—¶å€™ç¨‹åºæ‰§è¡Œä¼šæŠ¥é”™ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="ArrayListå…³é”®å­—æ®µåˆ†æ">ArrayListå…³é”®å­—æ®µåˆ†æ</h2><p>åœ¨<code>ArrayList</code>å½“ä¸­ä¸»è¦æœ‰ä»¥ä¸‹è¿™äº›å­—æ®µï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ArrayListå½“ä¸­é»˜è®¤åˆå§‹åŒ–å®¹é‡,ä½¿ç”¨æ— å‚æ„é€ å™¨ï¼Œåˆ™elementData[]åˆå§‹å®¹é‡ä¸º0,ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ æ‰©å®¹ä¸º10</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_CAPACITY</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"><span class="comment">// å­˜æ”¾å…·ä½“æ•°æ®çš„æ•°ç»„ ArrayList åº•å±‚å°±æ˜¯ä½¿ç”¨æ•°ç»„è¿›è¡Œå­˜å‚¨çš„</span></span><br><span class="line"><span class="keyword">transient</span> Object[] elementData;</span><br><span class="line"><span class="comment">// size è¡¨ç¤ºå®¹å™¨å½“ä¸­æ•°æ®çš„ä¸ªæ•° æ³¨æ„å’Œå®¹å™¨çš„é•¿åº¦åŒºåˆ†å¼€æ¥</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> size;</span><br><span class="line"><span class="comment">// å½“å®¹å™¨å½“ä¸­æ²¡æœ‰å…ƒç´ çš„æ—¶å€™å°† elementData èµ‹å€¼ä¸ºä»¥ä¸‹æ•°æ®ï¼ˆä¸åŒæƒ…å†µä¸ä¸€æ ·ï¼‰</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object[] EMPTY_ELEMENTDATA = &#123;&#125;;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸‹é¢ä¸¤ä¸ªå‡½æ•°æ˜¯ ArrayList çš„æ„é€ å‡½æ•°ï¼Œä»ä¸‹é¢ä¸¤ä¸ªå‡½æ•°å½“ä¸­</span></span><br><span class="line"><span class="comment">// æˆ‘ä»¬å¯ä»¥çœ‹å‡º EMPTY_ELEMENTDATA å’Œ DEFAULTCAPACITY_EMPTY_ELEMENTDATA ä½¿ç”¨åŒºåˆ«</span></span><br><span class="line"><span class="comment">// EMPTY_ELEMENTDATA æ˜¯å®¹å™¨å®¹é‡ä¸º0æ—¶ä½¿ç”¨ï¼ŒDEFAULTCAPACITY_EMPTY_ELEMENTDATAæ˜¯é»˜è®¤æ„é€ çš„æ—¶å€™ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ArrayList</span><span class="params">(<span class="type">int</span> initialCapacity)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.elementData = <span class="keyword">new</span> <span class="title class_">Object</span>[initialCapacity];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (initialCapacity == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.elementData = EMPTY_ELEMENTDATA;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Illegal Capacity: &quot;</span>+</span><br><span class="line">                initialCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ArrayList</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//åˆ›å»º ArrayList å¯¹è±¡æ—¶ï¼Œå¦‚æœä½¿ç”¨æ— å‚æ„é€ å™¨ï¼Œåˆ™ elementData[] åˆå§‹å®¹é‡ä¸º 0</span></span><br><span class="line">    <span class="built_in">this</span>.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="ArrayListä¸»è¦æ–¹æ³•åˆ†æ">ArrayListä¸»è¦æ–¹æ³•åˆ†æ</h2><h3 id="add">add</h3><p><code>add</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨äºå¾€å®¹å™¨çš„æœ«å°¾å¢åŠ æ•°æ®ï¼Œä¹Ÿæ˜¯<code>ArrayList</code>å½“ä¸­æœ€æ ¸å¿ƒçš„æ–¹æ³•ã€‚ä¸»è¦å·¥ä½œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2519003-20220707231130867-1867898666.png" alt="img" style="zoom:67%;" /><p>é¦–å…ˆè°ƒç”¨å‡½æ•°<code>ensureCapacityInternal</code>ç¡®ä¿<code>ArrayList</code>å½“ä¸­çš„æ•°ç»„é•¿åº¦èƒ½å¤Ÿæ»¡è¶³éœ€æ±‚ï¼Œä¸ç„¶æ•°ç»„ä¼šæŠ¥æ•°ç»„ä¸‹æ ‡è¶Šç•Œå¼‚å¸¸ï¼Œ<code>add</code>å‡½æ•°è°ƒç”¨è¿‡ç¨‹å½“ä¸­æ‰€æ¶‰åŠåˆ°çš„å‡½æ•°å¦‚ä¸‹ã€‚</p><div class="tabs" id="6a318352-1ba6-4cb9-9bbe-84d380a0a3cf"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6a318352-1ba6-4cb9-9bbe-84d380a0a3cf-1">add</button></li><li class="tab"><button type="button" data-href="#6a318352-1ba6-4cb9-9bbe-84d380a0a3cf-2">ensureCapacityInternal</button></li><li class="tab"><button type="button" data-href="#6a318352-1ba6-4cb9-9bbe-84d380a0a3cf-3">calculateCapacity</button></li><li class="tab"><button type="button" data-href="#6a318352-1ba6-4cb9-9bbe-84d380a0a3cf-4">ensureExplicitCapacity</button></li><li class="tab"><button type="button" data-href="#6a318352-1ba6-4cb9-9bbe-84d380a0a3cf-5">growâ­ï¸</button></li><li class="tab"><button type="button" data-href="#6a318352-1ba6-4cb9-9bbe-84d380a0a3cf-6">hugeCapacity</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6a318352-1ba6-4cb9-9bbe-84d380a0a3cf-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™ä¸ªå‡½æ•°çš„ä¸»è¦ç›®çš„æ˜¯ç¡®ä¿ elementData çš„å®¹é‡æœ‰ size + 1 ï¼Œå¦åˆ™å­˜å‚¨æ•°æ®çš„æ—¶å€™æ•°ç»„å°±ä¼šè¶Šç•Œ</span></span><br><span class="line">    ensureCapacityInternal(size + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// size è¡¨ç¤ºå®¹å™¨å½“ä¸­æ•°æ®çš„ä¸ªæ•° æ³¨æ„å’Œå®¹å™¨çš„é•¿åº¦åŒºåˆ†å¼€æ¥</span></span><br><span class="line">    <span class="comment">// åŠ å…¥æ•°æ®ä¹‹å å®¹å™¨å½“ä¸­æ•°æ®çš„ä¸ªæ•°ä¹Ÿè¦ + 1</span></span><br><span class="line">    elementData[size++] = e;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6a318352-1ba6-4cb9-9bbe-84d380a0a3cf-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// minCapacity è¡¨ç¤º ArrayList ä¸­çš„æ•°ç»„æœ€å°çš„é•¿åº¦</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">ensureCapacityInternal</span><span class="params">(<span class="type">int</span> minCapacity)</span> &#123;</span><br><span class="line">    ensureExplicitCapacity(</span><br><span class="line">        <span class="comment">// è¿™ä¸ªå‡½æ•°è®¡ç®—æ•°ç»„çš„æœ€å°é•¿åº¦</span></span><br><span class="line">        calculateCapacity(elementData, minCapacity)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6a318352-1ba6-4cb9-9bbe-84d380a0a3cf-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">calculateCapacity</span><span class="params">(Object[] elementData, <span class="type">int</span> minCapacity)</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯æ— å‚æ„é€ çš„è¯ï¼Œå–é»˜è®¤é•¿åº¦å’Œéœ€æ±‚é•¿åº¦ minCapacity ä¸­æ¯”è¾ƒå¤§çš„å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123;</span><br><span class="line">        <span class="keyword">return</span> Math.max(DEFAULT_CAPACITY, minCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> minCapacity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6a318352-1ba6-4cb9-9bbe-84d380a0a3cf-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">ensureExplicitCapacity</span><span class="params">(<span class="type">int</span> minCapacity)</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™ä¸ªè¡¨ç¤ºå®¹å™¨å‘ç”Ÿæ”¹å˜çš„æ¬¡æ•°ï¼Œæˆ‘ä»¬åœ¨åç»­åˆ†æè¿­ä»£å™¨çš„æ—¶å€™è¿›è¡Œåˆ†æ</span></span><br><span class="line">    modCount++;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// å¦‚æœæœ€å°çš„éœ€æ±‚å®¹é‡ minCapacity å¤§äºç°åœ¨å®¹å™¨å½“ä¸­æ•°ç»„çš„é•¿åº¦ï¼Œåˆ™éœ€è¦è¿›è¡Œæ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (minCapacity - elementData.length &gt; <span class="number">0</span>)</span><br><span class="line">        grow(minCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6a318352-1ba6-4cb9-9bbe-84d380a0a3cf-5"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">grow</span><span class="params">(<span class="type">int</span> minCapacity)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldCapacity</span> <span class="operator">=</span> elementData.length;</span><br><span class="line">    <span class="comment">// æ–°æ•°ç»„çš„é•¿åº¦ä¸ºåŸæ•°ç»„çš„é•¿åº¦çš„1.5å€ï¼Œå³ç§»ä¸€ä½ç›¸å½“äºé™¤ä»¥2</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">newCapacity</span> <span class="operator">=</span> oldCapacity + (oldCapacity &gt;&gt; <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// å¦‚æœæ–°æ•°ç»„çš„é•¿åº¦ï¼Œå°äºéœ€è¦çš„æœ€å°çš„å®¹é‡ï¼Œåˆ™æ›´æ–°æ•°ç»„çš„é•¿åº¦ä¸º minCapacity</span></span><br><span class="line">    <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = minCapacity;</span><br><span class="line">    <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// è¿™ä¸ªå‡½æ•°çš„ä¸»è¦ç›®çš„æ˜¯åˆ¤æ–­æ•´æ•°æ˜¯å¦å‘ç”Ÿæº¢å‡º</span></span><br><span class="line">        newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">    <span class="comment">// minCapacity is usually close to size, so this is a win:</span></span><br><span class="line">    elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6a318352-1ba6-4cb9-9bbe-84d380a0a3cf-6"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">hugeCapacity</span><span class="params">(<span class="type">int</span> minCapacity)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (minCapacity &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OutOfMemoryError</span>();</span><br><span class="line">    <span class="keyword">return</span> (minCapacity &gt; MAX_ARRAY_SIZE) ?</span><br><span class="line">        Integer.MAX_VALUE :</span><br><span class="line">    MAX_ARRAY_SIZE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>ä¸Šè¿°ä»£ç çš„è°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2519003-20220707231142437-124193873.png" alt="img" style="zoom: 50%;" /><hr><hr><h3 id="getå’Œset">getå’Œset</h3><div class="tabs" id="c18f7a24-21a8-44ee-ae7e-1a8287cc5f76"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c18f7a24-21a8-44ee-ae7e-1a8287cc5f76-1"><i class="fas fa-atom"></i>get</button></li><li class="tab"><button type="button" data-href="#c18f7a24-21a8-44ee-ae7e-1a8287cc5f76-2"><i class="far fa-sun"></i>set</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c18f7a24-21a8-44ee-ae7e-1a8287cc5f76-1"><p>è·å–å¯¹åº”ä¸‹æ ‡çš„æ•°æ®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">get</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    <span class="comment">// è¿›è¡Œæ•°ç»„ä¸‹æ ‡çš„æ£€æŸ¥ï¼Œå¦‚æœä¸‹æ ‡è¶…è¿‡ ArrayList ä¸­æ•°æ®çš„ä¸ªæ•°ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="comment">// æ³¨æ„è¿™é‡Œæ˜¯å®¹å™¨å½“ä¸­æ•°æ®çš„ä¸ªæ•° ä¸æ˜¯æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line">    rangeCheck(index);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> elementData(index);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">rangeCheck</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= size)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IndexOutOfBoundsException</span>(outOfBoundsMsg(index));</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">E <span class="title function_">elementData</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    <span class="comment">// è¿”å›å¯¹åº”ä¸‹æ ‡çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">return</span> (E) elementData[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c18f7a24-21a8-44ee-ae7e-1a8287cc5f76-2"><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯ç”¨äºè®¾ç½®æŒ‡å®šä¸‹æ ‡çš„æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">set</span><span class="params">(<span class="type">int</span> index, E element)</span> &#123;</span><br><span class="line">    rangeCheck(index);</span><br><span class="line"> </span><br><span class="line">    <span class="type">E</span> <span class="variable">oldValue</span> <span class="operator">=</span> elementData(index);</span><br><span class="line">    elementData[index] = element;</span><br><span class="line">    <span class="keyword">return</span> oldValue;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="remove">remove</h3><p>åˆ é™¤<code>ArrayList</code>å½“ä¸­çš„æ•°æ®</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2519003-20220707231154448-1597746352.png" alt="img" style="zoom:80%;" /><div class="tabs" id="7a56d341-394e-4470-add8-6e8a906bebcf"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#7a56d341-394e-4470-add8-6e8a906bebcf-1">remove(int index)</button></li><li class="tab"><button type="button" data-href="#7a56d341-394e-4470-add8-6e8a906bebcf-2">remove(Object o)</button></li><li class="tab"><button type="button" data-href="#7a56d341-394e-4470-add8-6e8a906bebcf-3">fastRemove(int index)</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="7a56d341-394e-4470-add8-6e8a906bebcf-1"><p>é€šè¿‡ä¸‹æ ‡åˆ é™¤æ•°æ®ï¼Œè¿™ä¸ªå‡½æ•°çš„æ„ä¹‰æ˜¯åˆ é™¤ä¸‹æ ‡ä¸º index çš„æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">remove</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    <span class="comment">// é¦–å…ˆæ£€æŸ¥ä¸‹æ ‡æ˜¯å¦åˆæ³•ï¼Œå¦‚æœä¸åˆæ³•ï¼ŒæŠ›å‡ºä¸‹æ ‡è¶Šç•Œå¼‚å¸¸</span></span><br><span class="line">    rangeCheck(index);</span><br><span class="line"> </span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="type">E</span> <span class="variable">oldValue</span> <span class="operator">=</span> elementData(index);</span><br><span class="line">  <span class="comment">// å› ä¸ºåˆ é™¤æŸä¸ªæ•°æ®ï¼Œéœ€è¦å°†è¯¥æ•°æ®åé¢çš„æ•°æ®å¾€æ•°ç»„å‰é¢ç§»åŠ¨</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œéœ€è¦è®¡ç®—éœ€è¦ç§»åŠ¨çš„æ•°æ®çš„ä¸ªæ•°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">numMoved</span> <span class="operator">=</span> size - index - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (numMoved &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// é€šè¿‡æ‹·è´ç§»åŠ¨æ•°æ®</span></span><br><span class="line">        <span class="comment">// è¿™ä¸ªå‡½æ•°çš„æ„ä¹‰æ˜¯å°† index + 1å’Œå…¶ä¹‹åçš„æ•°æ®æ•´ä½“ç§»åŠ¨åˆ° index</span></span><br><span class="line">        <span class="comment">// çš„ä½ç½®</span></span><br><span class="line">        System.arraycopy(elementData, index+<span class="number">1</span>, elementData, index,</span><br><span class="line">                         numMoved);</span><br><span class="line">    <span class="comment">// å› ä¸ºæœ€åä¸€ä¸ªæ•°æ®å·²ç»æ‹·è´åˆ°å‰ä¸€ä¸ªä½ç½®äº†ï¼Œæ‰€ä»¥å¯ä»¥è®¾ç½®ä¸º null</span></span><br><span class="line">    <span class="comment">// å¯ä»¥åšåƒåœ¾å›æ”¶äº†</span></span><br><span class="line">    elementData[--size] = <span class="literal">null</span>; </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> oldValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="7a56d341-394e-4470-add8-6e8a906bebcf-2"><p>åˆ é™¤å®¹å™¨å½“ä¸­çš„ç¬¬ä¸€ä¸ªç­‰äº o çš„æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; size; index++)</span><br><span class="line">            <span class="keyword">if</span> (elementData[index] == <span class="literal">null</span>) &#123;</span><br><span class="line">                fastRemove(index);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; size; index++)</span><br><span class="line">            <span class="keyword">if</span> (o.equals(elementData[index])) &#123;</span><br><span class="line">                fastRemove(index);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="7a56d341-394e-4470-add8-6e8a906bebcf-3"><p>è¿™ä¸ªæ–¹æ³•å’Œç¬¬ä¸€ä¸ª remove æ–¹æ³•åŸç†ä¸€è‡´</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fastRemove</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="type">int</span> <span class="variable">numMoved</span> <span class="operator">=</span> size - index - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (numMoved &gt; <span class="number">0</span>)</span><br><span class="line">        System.arraycopy(elementData, index+<span class="number">1</span>, elementData, index,</span><br><span class="line">                         numMoved);</span><br><span class="line">    elementData[--size] = <span class="literal">null</span>; <span class="comment">// clear to let GC do its work</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="toString">toString</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LinkedList&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    list.add(i);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(list);</span><br><span class="line"><span class="comment">// è¾“å‡ºç»“æœï¼š</span></span><br><span class="line"><span class="comment">// [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</span></span><br></pre></td></tr></table></figure><p><code>toString</code>æ–¹æ³•æ²¡æœ‰ç›´æ¥åœ¨<code>ArrayList</code>å½“ä¸­å®ç°ï¼Œè€Œæ˜¯åœ¨å®ƒç»§æ‰¿çš„ç±»<code>AbstractCollection</code>å½“ä¸­å®ç°çš„ï¼Œ<code>toString</code>çš„æºä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å¾—åˆ° ArrayList çš„è¿­ä»£å™¨ </span></span><br><span class="line">    Iterator&lt;E&gt; it = iterator();</span><br><span class="line">    <span class="comment">// å¦‚æœå®¹å™¨å½“ä¸­æ²¡æœ‰æ•°æ®åˆ™è¿”å›ç©º</span></span><br><span class="line">    <span class="keyword">if</span> (! it.hasNext())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[]&quot;</span>;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    sb.append(<span class="string">&#x27;[&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">E</span> <span class="variable">e</span> <span class="operator">=</span> it.next();</span><br><span class="line">        <span class="comment">// å°†å¯¹è±¡åŠ å…¥åˆ° StringBuilder å½“ä¸­ï¼Œè¿™é‡ŒåŠ å…¥çš„ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line">        <span class="comment">// ä½†æ˜¯åœ¨ append æºä»£ç å½“ä¸­ä¼šåŒæ ·ä¼šä½¿ç”¨ String.ValueOf </span></span><br><span class="line">        <span class="comment">// å¾—åˆ°å¯¹è±¡çš„ toString æ–¹æ³•çš„ç»“æœ</span></span><br><span class="line">        sb.append(e == <span class="built_in">this</span> ? <span class="string">&quot;(this Collection)&quot;</span> : e);</span><br><span class="line">        <span class="keyword">if</span> (! it.hasNext())</span><br><span class="line">            <span class="keyword">return</span> sb.append(<span class="string">&#x27;]&#x27;</span>).toString();</span><br><span class="line">        sb.append(<span class="string">&#x27;,&#x27;</span>).append(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœå®¹å™¨å½“ä¸­æ²¡æœ‰æ•°æ®ï¼Œç›´æ¥è¿”å›[]ã€‚</li><li>å¦‚æœå®¹å™¨å½“ä¸­æœ‰æ•°æ®çš„è¯ï¼Œé‚£ä¹ˆé€šè¿‡è¿­ä»£æ¯ä¸ªæ•°æ®ï¼Œè°ƒç”¨<code>StringBuilder</code>çš„<code>append</code>æ–¹æ³•ï¼Œå°†æ•°æ®åŠ å…¥åˆ°è¾“å‡ºçš„<code>StringBuilder</code>å¯¹è±¡å½“ä¸­ã€‚åœ¨<code>append</code>æ–¹æ³•ä¸­æ·»åŠ åˆ°<code>StringBuilder</code>å½“ä¸­çš„å­—ç¬¦ä¸²ä»ç„¶æ˜¯<code>ArrayList</code>å½“ä¸­æ•°æ®å¯¹è±¡çš„<code>toString</code>æ–¹æ³•è¿”å›çš„æ•°æ®ã€‚</li></ul><hr><h3 id="equals">equals</h3><p>åœ¨<code>ArrayList</code>å½“ä¸­çš„<code>equals</code>æ–¹æ³•å’Œ<code>toString</code>æ–¹æ³•ä¸ä¸€æ ·ï¼Œ</p><p><code>equlas</code>æ–¹æ³•æ˜¯åœ¨ç±»<code>AbstractList</code>å½“ä¸­å®ç°çš„ï¼Œå…¶æºä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="built_in">this</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> List))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"> </span><br><span class="line">    ListIterator&lt;E&gt; e1 = listIterator();</span><br><span class="line">    ListIterator&lt;?&gt; e2 = ((List&lt;?&gt;) o).listIterator();</span><br><span class="line">    <span class="keyword">while</span> (e1.hasNext() &amp;&amp; e2.hasNext()) &#123;</span><br><span class="line">        <span class="type">E</span> <span class="variable">o1</span> <span class="operator">=</span> e1.next();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o2</span> <span class="operator">=</span> e2.next();</span><br><span class="line">        <span class="keyword">if</span> (!(o1==<span class="literal">null</span> ? o2==<span class="literal">null</span> : o1.equals(o2)))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> !(e1.hasNext() || e2.hasNext());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç çš„ä¸»è¦æµç¨‹ï¼š</p><ul><li>é¦–å…ˆåˆ¤æ–­<code>o</code>å’Œ<code>this</code>æ˜¯å¦æ˜¯åŒä¸€ä¸ªå¯¹è±¡</li><li>å¦‚æœå¯¹è±¡æ²¡æœ‰å®ç°<code>List</code>æ¥å£è¿”å›<code>false</code>ã€‚</li><li>é€ä¸ªåˆ¤æ–­è¿­ä»£å™¨é‡Œé¢çš„å¯¹è±¡æ˜¯å¦ç›¸ç­‰ï¼ˆè°ƒequalsï¼‰ï¼Œå¦‚æœä¸¤ä¸ªé“¾è¡¨å½“ä¸­èŠ‚ç‚¹æ•°ç›®ä¸€æ ·è€Œä¸”éƒ½ç›¸ç­‰åˆ™è¿”å›<code>true</code>å¦åˆ™è¿”å›<code>false</code>ã€‚</li></ul><hr><h3 id="clone">clone</h3><p>é›†åˆçš„ <code>clone</code> æ–¹æ³•æ‰§è¡Œçš„æ˜¯æµ…æ‹·è´ã€‚è¿™æ„å‘³ç€ï¼Œæ–°åˆ›å»ºçš„é›†åˆå¯¹è±¡ä¼šåŒ…å«åŸå§‹é›†åˆä¸­çš„åŒä¸€ç»„å¯¹è±¡å¼•ç”¨ã€‚å¦‚æœåŸå§‹é›†åˆä¸­çš„å¯¹è±¡æ˜¯å¯å˜çš„ï¼Œé‚£ä¹ˆåœ¨æ–°é›†åˆä¸­å¯¹è¿™äº›å¯¹è±¡æ‰€åšçš„æ›´æ”¹ä¹Ÿä¼šåæ˜ åœ¨åŸå§‹é›†åˆä¸­ã€‚</p><p>å¦‚æœéœ€è¦æ‰§è¡Œæ·±æ‹·è´ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–æŠ€æœ¯æˆ–æ‰‹åŠ¨å¤åˆ¶å¯¹è±¡å¹¶åˆ›å»ºæ–°çš„å¯¹è±¡å¼•ç”¨æ¥å®ç°ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ Java åºåˆ—åŒ– API æˆ–ç¬¬ä¸‰æ–¹åº“ï¼ˆå¦‚ Apache Commons Lang åº“ï¼‰æ¥æ‰§è¡Œæ·±æ‹·è´ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">clone</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ArrayList&lt;?&gt; v = (ArrayList&lt;?&gt;) <span class="built_in">super</span>.clone();</span><br><span class="line">        v.elementData = Arrays.copyOf(elementData, size);</span><br><span class="line">        v.modCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">        <span class="comment">// this shouldn&#x27;t happen, since we are Cloneable</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InternalError</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªæ‹·è´è¿‡ç¨‹å¦‚ä¸‹å¦‚æ‰€ç¤ºï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2519003-20220707231203740-1128103203.png" alt="img" style="zoom:50%;" /><p>è™½ç„¶å‘ç”Ÿäº†æ•°ç»„çš„æ‹·è´ï¼Œä½†æ˜¯æ‹·è´ä¹‹åçš„æ•°ç»„ä¸­æ•°æ®çš„æŒ‡å‘å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸¤ä¸ªæ•°ç»„æŒ‡å‘çš„å†…å®¹æ˜¯ä¸€æ ·çš„ã€‚</p><hr><hr><h2 id="ArrayListè¿­ä»£å™¨Iterator">ArrayListè¿­ä»£å™¨Iterator</h2><h3 id="Iteratorå­—æ®µåˆ†æ">Iteratorå­—æ®µåˆ†æ</h3><p><code>Itr</code>ç±»æ˜¯<code>ArrayList</code>çš„å†…éƒ¨ç±»ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä»”ç»†åˆ†æ<code>Itr</code>ç±»çš„å®ç°ã€‚</p><p>åœ¨<code>Itr</code>ç±»å½“ä¸­ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªå­—æ®µï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸‹ä¸€ä¸ªå…ƒç´ çš„ä¸‹æ ‡ å½“æˆ‘ä»¬ new è¿™ä¸ªå¯¹è±¡çš„æ—¶å€™è¿™ä¸ªå€¼é»˜è®¤åˆå§‹åŒ–ä¸º0</span></span><br><span class="line"><span class="type">int</span> cursor;       </span><br><span class="line"><span class="comment">// ä¸Šä¸€ä¸ªé€šè¿‡ next æ–¹æ³•è¿”å›çš„å…ƒç´ çš„ä¸‹æ ‡  </span></span><br><span class="line"><span class="type">int</span> <span class="variable">lastRet</span> <span class="operator">=</span> -<span class="number">1</span>; </span><br><span class="line"><span class="type">int</span> <span class="variable">expectedModCount</span> <span class="operator">=</span> modCount; </span><br></pre></td></tr></table></figure><p><code>modCount</code>è¡¨ç¤ºæ•°ç»„å½“ä¸­æ•°æ®æ”¹å˜çš„æ¬¡æ•° ,æ˜¯<code>ArrayList</code>å½“ä¸­çš„ç±»å˜é‡ã€‚</p><p><code>expectedModCount </code>æ˜¯<code>ArrayListå†…éƒ¨ç±» Itr</code>ä¸­çš„ç±»å˜é‡ ç„¶åå°†è¿™ä¸ªå˜é‡ä¿å­˜åˆ° expectedModCountå½“ä¸­ã€‚ä½¿ç”¨ expectedModCount ä¸»è¦ç”¨äº fast-fail æœºåˆ¶ã€‚</p><p><code>modCount</code>ï¼ˆè‹±æ–‡å…¨ç§°ä¸ºï¼šmodifications countï¼Œä¿®æ”¹æ¬¡æ•°ï¼‰è¿™ä¸ªå­—æ®µã€‚å½“<code>ArrayList</code>å½“ä¸­å‘ç”Ÿä¸€æ¬¡<strong>ç»“æ„ä¿®æ”¹</strong>(<code>Structural modifications</code>)æ—¶ï¼Œ<code>modCount</code>å°±++ã€‚æ‰€è°“<strong>ç»“æ„ä¿®æ”¹</strong>å°±æ˜¯é‚£äº›è®©<code>ArrayList</code>å½“ä¸­æ•°ç»„çš„æ•°æ®ä¸ªæ•°<code>size</code>å‘ç”Ÿå˜åŒ–çš„æ“ä½œï¼Œæ¯”å¦‚è¯´<code>add</code>ã€<code>remove</code>æ–¹æ³•ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªæ–¹æ³•ä¸€ä¸ªæ˜¯å¢åŠ æ•°æ®ï¼Œä¸€ä¸ªæ˜¯åˆ é™¤æ•°æ®ï¼Œéƒ½ä¼šå¯¼è‡´å®¹å™¨å½“ä¸­æ•°æ®ä¸ªæ•°å‘ç”Ÿå˜åŒ–ã€‚è€Œ<code>set</code>æ–¹æ³•å°±ä¸ä¼šæ˜¯çš„<code>modCount</code>å‘ç”Ÿå˜åŒ–ï¼Œå› ä¸ºæ²¡æœ‰æ”¹å˜å®¹å™¨å½“ä¸­æ•°æ®çš„ä¸ªæ•°ã€‚</p><hr><h3 id="nextå’Œhasnext">nextå’Œhasnext</h3><div class="tabs" id="b80a58c5-9f6c-45f6-ac2d-8de41ea96561"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#b80a58c5-9f6c-45f6-ac2d-8de41ea96561-1"><i class="fas fa-atom"></i>hasNext()</button></li><li class="tab"><button type="button" data-href="#b80a58c5-9f6c-45f6-ac2d-8de41ea96561-2"><i class="far fa-sun"></i>next()</button></li><li class="tab"><button type="button" data-href="#b80a58c5-9f6c-45f6-ac2d-8de41ea96561-3"><i class="fas fa-wind"></i>checkForComodification()</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="b80a58c5-9f6c-45f6-ac2d-8de41ea96561-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™ä¸ª size æ˜¯å¤–éƒ¨ç±» ArrayList å½“ä¸­çš„ size è¡¨ç¤ºçš„æ˜¯ ArrayListå½“ä¸­æ•°æ®å…ƒç´ çš„ä¸ªæ•°ï¼Œ</span></span><br><span class="line">    <span class="comment">// cursor çš„åˆå§‹å€¼ä¸º 0 æ¯è°ƒç”¨ä¸€ä¸ª next cursorçš„å€¼å°±+1ï¼Œå½“ç­‰äº size æ˜¯å®¹å™¨å½“ä¸­çš„æ•°æ®å·²ç»éå†å®Œæˆäº† hasNext å°±è¿”å› false äº†</span></span><br><span class="line">    <span class="keyword">return</span> cursor != size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b80a58c5-9f6c-45f6-ac2d-8de41ea96561-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">public</span> E <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯ç”¨äºæ£€æµ‹åœ¨æ•°æ®è¿­ä»£çš„è¿‡ç¨‹å½“ä¸­ ArrayList æ˜¯å¦å‘ç”Ÿ ç»“æ„ä¿®æ”¹</span></span><br><span class="line">    <span class="comment">// å¦‚æœå‘ç”Ÿç»“æ„ä¿®æ”¹å°±æŠ›å‡º ConcurrentModificationException å¼‚å¸¸</span></span><br><span class="line">    checkForComodification();</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> cursor;</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= size)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>();</span><br><span class="line">    Object[] elementData = ArrayList.<span class="built_in">this</span>.elementData;</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= elementData.length)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConcurrentModificationException</span>();</span><br><span class="line">    <span class="comment">// æ›´æ”¹ cursor çš„å€¼ å¹¶å°†å…¶è®¾ç½®ä¸ºä¸‹ä¸€ä¸ªè¿”å›å…ƒç´ çš„ä¸‹æ ‡ è¿™ä¸€ç‚¹æˆ‘ä»¬åœ¨</span></span><br><span class="line">    <span class="comment">// å­—æ®µåˆ†æçš„æ—¶å€™å·²ç»è°ˆåˆ°è¿‡äº†</span></span><br><span class="line">    cursor = i + <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// è¿”å›æ•°æ® è¡¨è¾¾å¼ lastRet = i çš„è¿”å›å€¼ä¸º i </span></span><br><span class="line">    <span class="comment">// è¿™ä¸ªè¡¨è¾¾å¼ä¸ä»…å°† lastRet çš„å€¼èµ‹å€¼ä¸º i åŒæ—¶è¿”å› i</span></span><br><span class="line">    <span class="comment">// å› æ­¤å¯ä»¥è¿”å›ä¸‹æ ‡ä¸º i çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">return</span> (E) elementData[lastRet = i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b80a58c5-9f6c-45f6-ac2d-8de41ea96561-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">checkForComodification</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå‘ç”Ÿ ç»“æ„ä¿®æ”¹é‚£ä¹ˆ modCount çš„å€¼ä¼š++ é‚£ä¹ˆå°±å’Œ expectedModCount ä¸ç›¸ç­‰äº†</span></span><br><span class="line">    <span class="comment">// expectedModCount åˆå§‹åŒ–çš„æ—¶å€™ä»¤å…¶ç­‰äº expectedModCount</span></span><br><span class="line">    <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConcurrentModificationException</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <p>ä¸ºä»€ä¹ˆè¦æŠ›å‡º<code>ConcurrentModificationException</code>å¼‚å¸¸å‘¢ï¼Œæˆ‘ä»¬å…ˆæƒ³æƒ³æ˜¯ä»€ä¹ˆå¯¼è‡´<code>modCount</code>å‘ç”Ÿå˜åŒ–ã€‚è‚¯å®šè¿­ä»£å™¨åœ¨è¿›è¡Œéå†çš„åŒæ—¶ï¼Œä¿®æ”¹äº†<code>modCount</code>çš„å€¼ï¼Œé€šå¸¸è¿™ç§ç°è±¡çš„å‘ç”Ÿå‡ºç°åœ¨å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œå› æ­¤æŠ›å‡º<code>ConcurrentModificationException</code>å¼‚å¸¸ã€‚åƒè¿™ç§é€šè¿‡è¿­ä»£å™¨éå†è¿‡ç¨‹è¿›è¡Œæ£€æŸ¥å¹¶ä¸”å½“å‘ç”Ÿä¸ç¬¦åˆæ¡ä»¶çš„æƒ…å†µä¸‹æŠ›å‡ºå¼‚å¸¸çš„ç°è±¡å°±ç§°ä½œ<code>Fast-fail</code>ã€‚</p><hr><h3 id="remove-2">remove</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (lastRet &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>();</span><br><span class="line">    <span class="comment">// è¿›è¡Œåˆæ³•æ€§æ£€æŸ¥ï¼Œçœ‹æ˜¯å¦éœ€è¦æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    checkForComodification();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ ArrayList çš„removeæ–¹æ³•å®ç°</span></span><br><span class="line">        ArrayList.<span class="built_in">this</span>.remove(lastRet);</span><br><span class="line">        cursor = lastRet;</span><br><span class="line">        lastRet = -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// å› ä¸º remove ä¼šæ”¹å˜ modCount çš„å€¼ï¼Œå› æ­¤éœ€è¦å°† expectedModCount é‡æ–°èµ‹å€¼</span></span><br><span class="line">        expectedModCount = modCount;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IndexOutOfBoundsException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConcurrentModificationException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="ArrayListæ€»ç»“">ArrayListæ€»ç»“</h2><h3 id="æ—¶é—´å¤æ‚åº¦åˆ†æ">æ—¶é—´å¤æ‚åº¦åˆ†æ</h3><ul><li>å› ä¸º<code>ArrayList</code>æ˜¯éšæœºå­˜å–çš„ï¼Œå› æ­¤æˆ‘ä»¬é€šè¿‡ä¸‹æ ‡æŸ¥æ‰¾æ•°æ®çš„æ—¶é—´å¤æ‚åº¦æ˜¯<code>O(1)</code>ã€‚</li><li>æ’å…¥æ•°æ®çš„æ—¶é—´å¤æ‚åº¦æ˜¯<code>O(n)</code>ã€‚</li></ul><h3 id="æ‰©å®¹æœºåˆ¶">æ‰©å®¹æœºåˆ¶</h3><p>â‘  åˆ©ç”¨ç©ºå‚åˆ›å»ºçš„é›†åˆï¼Œåœ¨åº•å±‚åˆ›å»ºä¸€ä¸ªé»˜è®¤é•¿åº¦ä¸º0çš„æ•°ç»„</p><p>â‘¡ æ·»åŠ ç¬¬ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œåº•å±‚ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„é•¿åº¦ä¸º10çš„æ•°ç»„</p><p>â‘¢ å­˜æ»¡æ—¶ï¼Œä¼šæ‰©å®¹1.5å€</p><p>â‘£ å¦‚æœä¸€æ¬¡æ·»åŠ å¤šä¸ªå…ƒç´ ï¼Œ1.5å€è¿˜æ”¾ä¸ä¸‹ï¼Œåˆ™æ–°åˆ›å»ºæ•°ç»„çš„é•¿åº¦ä»¥å®é™…ä¸ºå‡†</p><blockquote><p>ä¸ºä»€ä¹ˆæ˜¯1.5å€</p></blockquote><p>å‡è®¾æˆ‘ä»¬åœ¨ä½¿ç”¨<code>ArrayList</code>çš„æ—¶å€™æ²¡æœ‰æŒ‡å®šåˆå§‹åŒ–çš„æ—¶å€™æ•°ç»„çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¯´åˆå§‹é•¿åº¦ä¸º<code>ArrayList</code>çš„é»˜è®¤é•¿åº¦ä¹Ÿå°±æ˜¯10ã€‚é‚£ä¹ˆå½“æˆ‘ä»¬ä¸åœåœ°å¾€å®¹å™¨å½“ä¸­å¢åŠ æ•°æ®ï¼Œæ‰©å®¹å¯¼è‡´çš„æ•°ç»„é•¿åº¦çš„å˜åŒ–å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ¨ªè½´è¡¨ç¤ºæ‰©å®¹æ¬¡æ•°ï¼Œçºµè½´è¡¨ç¤ºæ•°ç»„é•¿åº¦ï¼Œè“è‰²çš„æ‰©å®¹ä¸ºåŸæ•°ç»„é•¿åº¦çš„1.5å€ï¼Œå¦å¤–ä¸€æ¡æ˜¯2å€ã€‚æˆ‘ä»¬å¾ˆæ¸…æ™°çš„å‘ç°æ‰©å®¹ä¸ºåŸæ¥çš„<code>2å€</code>åœ¨åæœŸçš„æ•°ç»„é•¿åº¦å°†ä¼šè¿œå¤§äºæ‰©å®¹<code>1.5å€</code>ã€‚è¿™å¾ˆå¯èƒ½ä¼šå¯¼è‡´æˆ‘ä»¬ä¼šæµªè´¹å¾ˆå¤§çš„æ•°ç»„ç©ºé—´ï¼Œæ¯”å¦‚è¯´åˆšå¥½åŠ å…¥æœ€åä¸€ä¸ªæ•°æ®çš„æ—¶å€™å¯¼è‡´<code>ArrayList</code>è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œè¿™å¯èƒ½æ˜¯<code>ArrayList</code>åœ¨è®¾è®¡æ—¶å€™çš„è€ƒé‡ã€‚</p><img src="https://img2022.cnblogs.com/blog/2519003/202207/2519003-20220707231216216-531592090.png" alt="img" style="zoom:67%;" /><p>1.5^8=25.6</p><p>2^8=256</p><hr><hr><h2 id="LinkedListç»§æ‰¿ä½“ç³»">LinkedListç»§æ‰¿ä½“ç³»</h2><p>é¦–å…ˆå…ˆç›´è§‚çš„çœ‹ä¸€ä¸‹<code>LinedList</code>çš„ç»§æ‰¿ä½“ç³»å’Œå®ç°çš„æ¥å£</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2519003-20220704233923694-1289934053.png" alt="img" style="zoom:67%;" /><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkedList</span>&lt;E&gt;</span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">AbstractSequentialList</span>&lt;E&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">List</span>&lt;E&gt;, Deque&lt;E&gt;, Cloneable, java.io.Serializable</span><br></pre></td></tr></table></figure><ul><li>å®ç°äº†<code>List</code>æ¥å£ï¼Œè¿™ä¸ªæ¥å£å®šä¹‰äº†ä¸€äº›å¸¸è§çš„å®¹å™¨çš„æ–¹æ³•ï¼Œæ¯”å¦‚<code>add</code>ã€<code>addAll</code>ã€<code>get</code>ã€<code>set</code>ã€<code>contains</code>ã€<code>sort</code>ç­‰ç­‰ã€‚</li><li>å®ç°äº†<code>Deque</code>æ¥å£ï¼Œè¿™ä¸ªæ¥å£ä½ å¯ä»¥ç®€å•çš„è®¤ä¸ºæ˜¯ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—ï¼Œä¸¤å¤´éƒ½å¯ä»¥è¿›å¯ä»¥å‡ºï¼Œå®ƒå®šä¹‰çš„æ–¹æ³•æœ‰<code>getFirst</code>ã€<code>getLast</code>ã€<code>addFirst</code>ã€<code>addLast</code>ã€<code>removeFirst</code>ã€<code>removeLast</code>ã€<code>peekFirst</code>ã€<code>peekLast</code>ç­‰ç­‰ã€‚</li><li>å®ç°<code>Cloneable</code>å’Œ<code>Serializable</code>æ¥å£ä¸»è¦æ˜¯ä¸ºäº†èƒ½å¤Ÿè¿›è¡Œæ·±æ‹·è´å’Œåºåˆ—åŒ–ã€‚</li><li><code>AbstractSequentialList</code>ä¸»è¦æ˜¯ç»™ä¸€äº›æ¥å£æ–¹æ³•æä¾›é»˜è®¤å®ç°ã€‚</li></ul><p>é“¾è¡¨ä½œä¸ºä¸€ä¸ªå®¹å™¨è‚¯å®šéœ€è¦å°†æ•°æ®åŠ å…¥åˆ°å®¹å™¨å½“ä¸­ï¼Œä¹Ÿéœ€è¦ä»å®¹å™¨å½“ä¸­å¾—åˆ°æŸä¸ªæ•°æ®ï¼Œåˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨å®¹å™¨å½“ä¸­ï¼Œå› æ­¤æœ‰<code>add</code>ã€<code>addAll</code>ã€<code>get</code>ã€<code>set</code>ã€<code>contains</code>ã€<code>sort</code>è¿™äº›æ–¹æ³•æ˜¯å¾ˆè‡ªç„¶çš„ã€‚æ­¤å¤–<code>LinedList</code>å®ç°çš„æ˜¯åŒå‘é“¾è¡¨ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“åœ¨é“¾è¡¨çš„ä»»æ„ä½ç½®è¿›è¡Œæ’å…¥å’Œåˆ é™¤ï¼Œå½“æˆ‘ä»¬åœ¨é“¾è¡¨çš„å¤´éƒ¨å’Œå°¾éƒ¨è¿›è¡Œæ’å…¥å’Œåˆ é™¤çš„æ—¶å€™å°±å¯ä»¥æ»¡è¶³<code>Deque</code>çš„éœ€æ±‚äº†ï¼ˆåŒç«¯é˜Ÿåˆ—éœ€è¦èƒ½å¤Ÿåœ¨é˜Ÿåˆ—çš„å¤´å’Œå°¾è¿›è¡Œå‡ºé˜Ÿå’Œå…¥é˜Ÿï¼Œå°±ç›¸å½“äºæ’å…¥å’Œåˆ é™¤ï¼‰ï¼Œå› æ­¤<code>LinedList</code>å®ç°<code>getFirst</code>ã€<code>getLast</code>ã€<code>addFirst</code>ã€<code>addLast</code>ã€<code>removeFirst</code>ã€<code>removeLast</code>ä¹Ÿå°±å¾ˆå®¹æ˜“ç†è§£äº†ã€‚</p><hr><hr><h2 id="LinkedListæ•´ä½“ç»“æ„">LinkedListæ•´ä½“ç»“æ„</h2><mark class="hl-label blue">ä¸»è¦å­—æ®µ</mark> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// ç”¨äºè®°å½•é“¾è¡¨å½“ä¸­èŠ‚ç‚¹çš„ä¸ªæ•°ï¼Œä¹Ÿå°±æ˜¯æœ‰å‡ ä¸ªæ•°æ®</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Pointer to first node.</span></span><br><span class="line"><span class="comment">    * Invariant: (first == null &amp;&amp; last == null) ||</span></span><br><span class="line"><span class="comment">    *            (first.prev == null &amp;&amp; first.item != null)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">transient</span> Node&lt;E&gt; first; <span class="comment">// æŒ‡å‘åŒå‘é“¾è¡¨çš„å¤´ç»“ç‚¹</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Pointer to last node.</span></span><br><span class="line"><span class="comment">    * Invariant: (first == null &amp;&amp; last == null) ||</span></span><br><span class="line"><span class="comment">    *            (last.next == null &amp;&amp; last.item != null)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">transient</span> Node&lt;E&gt; last; <span class="comment">// æŒ‡å‘åŒå‘é“¾è¡¨çš„å°¾èŠ‚ç‚¹</span></span><br></pre></td></tr></table></figure><mark class="hl-label green">å†…éƒ¨èŠ‚ç‚¹çš„å½¢å¼</mark> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;E&gt; &#123;</span><br><span class="line">    E item;</span><br><span class="line">    Node&lt;E&gt; next;</span><br><span class="line">    Node&lt;E&gt; prev;</span><br><span class="line"> </span><br><span class="line">    Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) &#123;</span><br><span class="line">        <span class="built_in">this</span>.item = element;</span><br><span class="line">        <span class="built_in">this</span>.next = next;</span><br><span class="line">        <span class="built_in">this</span>.prev = prev;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®ä¸Šé¢çš„å­—æ®µåˆ†æï¼Œ<code>LinkedList</code>å†…éƒ¨ç»“æ„ä¸»è¦å¦‚ä¸‹ï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2519003-20220704233936333-32626593.png" alt="img" style="zoom:67%;" /><p>é“¾è¡¨å½“ä¸­æœ‰<code>first</code>å’Œ<code>last</code>å­—æ®µä¸»è¦æŒ‡å‘é“¾è¡¨å½“ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å’Œæœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœé“¾è¡¨å½“ä¸­æ²¡æœ‰èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä»–ä»¬éƒ½æ˜¯<code>null</code>ï¼Œå¦‚æœé“¾è¡¨å½“ä¸­æœ‰ä¸€ä¸ªèŠ‚ç‚¹ä»–ä»¬æŒ‡å‘åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœé“¾è¡¨ä¸­èŠ‚ç‚¹ä¸ªæ•°å¤§äº2ï¼Œä»–ä»¬åˆ†åˆ«æŒ‡å‘ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å’Œæœ€åä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><hr><h2 id="LinkedListä¸»è¦æ–¹æ³•">LinkedListä¸»è¦æ–¹æ³•</h2><h3 id="add-2">add</h3><p><code>add</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯å‘é“¾è¡¨å°¾éƒ¨å¢åŠ ä¸€ä¸ªå…ƒç´ ã€‚</p><div class="tabs" id="f35b9d04-2acd-45e7-b0f1-fd07df6de800"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#f35b9d04-2acd-45e7-b0f1-fd07df6de800-1"><i class="fas fa-cat"></i>add</button></li><li class="tab"><button type="button" data-href="#f35b9d04-2acd-45e7-b0f1-fd07df6de800-2"><i class="fas fa-horse"></i>linkLast</button></li><li class="tab"><button type="button" data-href="#f35b9d04-2acd-45e7-b0f1-fd07df6de800-3"><i class="fas fa-heartbeat"></i>linkBefore</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="f35b9d04-2acd-45e7-b0f1-fd07df6de800-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯å‘é“¾è¡¨å°¾éƒ¨å¢åŠ ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">    linkLast(e);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f35b9d04-2acd-45e7-b0f1-fd07df6de800-2"><p>å‘é“¾è¡¨å°¾éƒ¨å¢åŠ ä¸€ä¸ªå…ƒç´ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">linkLast</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; l = last;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(l, e, <span class="literal">null</span>);</span><br><span class="line">    last = newNode;</span><br><span class="line">    <span class="keyword">if</span> (l == <span class="literal">null</span>)</span><br><span class="line">        first = newNode;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        l.next = newNode;</span><br><span class="line">    size++;</span><br><span class="line">    modCount++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f35b9d04-2acd-45e7-b0f1-fd07df6de800-3"><p><code>linkBefore</code>å’Œ<code>linkLast</code>çš„ä½œç”¨ç›¸åï¼Œæ˜¯åœ¨æŸä¸ªèŠ‚ç‚¹å‰é¢æ’å…¥æ•°æ®<code>e</code>ï¼Œå¤§ä½“å’Œå‰é¢çš„<code>linkLast</code>æ–¹æ³•ä¸€è‡´ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Inserts element e before non-null Node succ.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">linkBefore</span><span class="params">(E e, Node&lt;E&gt; succ)</span> &#123;</span><br><span class="line">    <span class="comment">// assert succ != null;</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; pred = succ.prev;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(pred, e, succ);</span><br><span class="line">    succ.prev = newNode;</span><br><span class="line">    <span class="keyword">if</span> (pred == <span class="literal">null</span>)</span><br><span class="line">        first = newNode;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        pred.next = newNode;</span><br><span class="line">    size++;</span><br><span class="line">    modCount++;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="getå’Œset-2">getå’Œset</h3><div class="tabs" id="2ca762ce-3adb-46d9-b490-59bdef0bbc39"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2ca762ce-3adb-46d9-b490-59bdef0bbc39-1"><i class="fas fa-award"></i>get</button></li><li class="tab"><button type="button" data-href="#2ca762ce-3adb-46d9-b490-59bdef0bbc39-2"><i class="fas fa-baseball-ball"></i>set</button></li><li class="tab"><button type="button" data-href="#2ca762ce-3adb-46d9-b490-59bdef0bbc39-3"><i class="fas fa-bone"></i>node</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2ca762ce-3adb-46d9-b490-59bdef0bbc39-1"><p>é€šè¿‡ä¸‹æ ‡è·å–æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">get</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    checkElementIndex(index); <span class="comment">// åˆ¤æ–­ä¸‹æ ‡æ˜¯å¦åˆæ³•</span></span><br><span class="line">    <span class="keyword">return</span> node(index).item; <span class="comment">// å–å‡ºå¯¹åº”çš„æ•°æ®</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2ca762ce-3adb-46d9-b490-59bdef0bbc39-2"><p>æ›´æ–°æŸä¸ªä¸‹æ ‡çš„æ•°æ®<code>item</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">set</span><span class="params">(<span class="type">int</span> index, E element)</span> &#123;</span><br><span class="line">       checkElementIndex(index); <span class="comment">// åˆ¤æ–­ä¸‹æ ‡æ˜¯å¦åˆæ³•</span></span><br><span class="line">       Node&lt;E&gt; x = node(index);</span><br><span class="line">       <span class="type">E</span> <span class="variable">oldVal</span> <span class="operator">=</span> x.item;</span><br><span class="line">       x.item = element; <span class="comment">// æ›´æ–°æ•°æ®</span></span><br><span class="line">       <span class="keyword">return</span> oldVal; <span class="comment">// è¿”å›æ—§æ•°æ®</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2ca762ce-3adb-46d9-b490-59bdef0bbc39-3"><p>æ ¹æ®ä¸‹æ ‡æ‰¾åˆ°å¯¹åº”çš„å…ƒç´ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Node&lt;E&gt; <span class="title function_">node</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    <span class="comment">// æ‰¾åˆ°ç¬¬ index + 1 ä¸ªå…ƒç´ </span></span><br><span class="line">    <span class="comment">// åˆ¤æ–­å¯¹åº”ä½ç½®çš„å…ƒç´ æ˜¯ç¦»é“¾è¡¨å¤´éƒ¨è¿‘è¿˜æ˜¯ç¦»é“¾è¡¨å°¾éƒ¨è¿‘ï¼Œå“ªå¤´è¿‘å°±ä»å“ªå¤´éå†</span></span><br><span class="line">    <span class="keyword">if</span> (index &lt; (size &gt;&gt; <span class="number">1</span>)) &#123;</span><br><span class="line">        Node&lt;E&gt; x = first;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; index; i++)</span><br><span class="line">            x = x.next;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;E&gt; x = last;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> size - <span class="number">1</span>; i &gt; index; i--)</span><br><span class="line">            x = x.prev;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="remove-3">remove</h3><div class="tabs" id="c97870d9-78a0-4bce-98ab-0dca438c346f"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c97870d9-78a0-4bce-98ab-0dca438c346f-1"><i class="fas fa-atom"></i>remove</button></li><li class="tab"><button type="button" data-href="#c97870d9-78a0-4bce-98ab-0dca438c346f-2"><i class="far fa-sun"></i>unlink</button></li><li class="tab"><button type="button" data-href="#c97870d9-78a0-4bce-98ab-0dca438c346f-3"><i class="fas fa-wind"></i>unlinkFirst</button></li><li class="tab"><button type="button" data-href="#c97870d9-78a0-4bce-98ab-0dca438c346f-4"><i class="fas fa-fire-alt"></i>unlinkLast</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c97870d9-78a0-4bce-98ab-0dca438c346f-1"><p>åˆ é™¤é“¾è¡¨å½“ä¸­çš„æŸä¸ªå…ƒç´ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå…ƒç´ ä¸º nullï¼Œå°±åˆ é™¤é“¾è¡¨å½“ä¸­ç¬¬ä¸€ä¸ªå€¼ä¸º null çš„å…ƒç´ </span></span><br><span class="line">    <span class="comment">// ä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡º LinkedList æ”¯æŒå€¼ä¸º null çš„å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (o == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; x = first; x != <span class="literal">null</span>; x = x.next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (x.item == <span class="literal">null</span>) &#123;</span><br><span class="line">                unlink(x);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; x = first; x != <span class="literal">null</span>; x = x.next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (o.equals(x.item)) &#123;</span><br><span class="line">                unlink(x);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c97870d9-78a0-4bce-98ab-0dca438c346f-2"><p>åˆ é™¤æŸä¸ªèŠ‚ç‚¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Unlinks non-null node x.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">E <span class="title function_">unlink</span><span class="params">(Node&lt;E&gt; x)</span> &#123;</span><br><span class="line">    <span class="comment">// assert x != null;</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">E</span> <span class="variable">element</span> <span class="operator">=</span> x.item;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; next = x.next;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; prev = x.prev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹ä¸º null è¯´æ˜è¢«åˆ é™¤çš„å°±æ˜¯é¦–èŠ‚ç‚¹ï¼Œå› æ­¤éœ€è¦è·Ÿæ–°é¦–èŠ‚ç‚¹ä¸ºåŸæ¥èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ next</span></span><br><span class="line">    <span class="keyword">if</span> (prev == <span class="literal">null</span>) &#123;</span><br><span class="line">        first = next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        prev.next = next;</span><br><span class="line">        x.prev = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// åŒæ ·çš„ï¼Œå¦‚æœ next ä¸º null ï¼Œé‚£ä¹ˆè¢«åˆ é™¤çš„èŠ‚ç‚¹å°±æ˜¯ä¸ºèŠ‚ç‚¹ï¼Œå› æ­¤éœ€è¦æ›´æ–° last ä¸ºè¢«åˆ é™¤èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (next == <span class="literal">null</span>) &#123;</span><br><span class="line">        last = prev;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        next.prev = prev;</span><br><span class="line">        x.next = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    x.item = <span class="literal">null</span>;</span><br><span class="line">    size--;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">return</span> element;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c97870d9-78a0-4bce-98ab-0dca438c346f-3"><p>åˆ é™¤é“¾è¡¨å½“ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> E <span class="title function_">unlinkFirst</span><span class="params">(Node&lt;E&gt; f)</span> &#123;</span><br><span class="line">    <span class="comment">// f è¡¨ç¤ºå¤´ç»“ç‚¹ï¼Œä¸” f ä¸ç­‰äº null</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">E</span> <span class="variable">element</span> <span class="operator">=</span> f.item;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; next = f.next;</span><br><span class="line">    f.item = <span class="literal">null</span>;</span><br><span class="line">    f.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">    first = next; <span class="comment">// å¤´ç»“ç‚¹å˜æˆfçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (next == <span class="literal">null</span>)</span><br><span class="line">        last = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        next.prev = <span class="literal">null</span>;</span><br><span class="line">    size--; <span class="comment">// åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹é“¾è¡¨å½“ä¸­æ•°æ®å°‘äº†ä¸€ä¸ªï¼Œå› æ­¤size--</span></span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">return</span> element;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c97870d9-78a0-4bce-98ab-0dca438c346f-4"><p>åˆ é™¤é“¾è¡¨å½“ä¸­æœ€åä¸€ä¸ªèŠ‚ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> E <span class="title function_">unlinkLast</span><span class="params">(Node&lt;E&gt; l)</span> &#123;</span><br><span class="line">    <span class="comment">// assert l == last &amp;&amp; l != null;</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">E</span> <span class="variable">element</span> <span class="operator">=</span> l.item;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; prev = l.prev;</span><br><span class="line">    l.item = <span class="literal">null</span>;</span><br><span class="line">    l.prev = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">    last = prev;</span><br><span class="line">    <span class="keyword">if</span> (prev == <span class="literal">null</span>)</span><br><span class="line">        first = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        prev.next = <span class="literal">null</span>;</span><br><span class="line">    size--;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">return</span> element;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="clone-2">clone</h3><p>å½“æˆ‘ä»¬æƒ³è¦å…‹éš†ä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™æˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•é€šå¸¸æ˜¯å°†è¢«å…‹éš†çš„å¯¹è±¡å¤åˆ¶ä¸€ä»½ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<code>LinkedList</code>çš„<code>clone</code>æ–¹æ³•ã€‚</p><p>æˆ‘ä»¬å¯ä»¥çŸ¥é“<code>LinkedList</code>çš„å…‹éš†æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„é“¾è¡¨ä½†æ˜¯æ²¡æœ‰æ”¹å˜é‡Œé¢çš„æ•°æ®ï¼Œå› æ­¤å¦‚æœä½ ä¿®æ”¹å…‹éš†é“¾è¡¨ä¸­çš„æ•°æ®çš„è¯ï¼ŒåŸæ¥çš„é“¾è¡¨é‡Œé¢çš„æ•°æ®ä¹Ÿä¼šæ”¹ã€‚</p><div class="tabs" id="ce746b79-24bb-4517-9916-86e9830c22b2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ce746b79-24bb-4517-9916-86e9830c22b2-1"><i class="fas fa-bug"></i>clone</button></li><li class="tab"><button type="button" data-href="#ce746b79-24bb-4517-9916-86e9830c22b2-2"><i class="fas fa-cannabis"></i>superClone</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ce746b79-24bb-4517-9916-86e9830c22b2-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">clone</span><span class="params">()</span> &#123;</span><br><span class="line">    LinkedList&lt;E&gt; clone = superClone();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Put clone into &quot;virgin&quot; state</span></span><br><span class="line">    clone.first = clone.last = <span class="literal">null</span>;</span><br><span class="line">    clone.size = <span class="number">0</span>;</span><br><span class="line">    clone.modCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize clone with our elements</span></span><br><span class="line">    <span class="keyword">for</span> (Node&lt;E&gt; x = first; x != <span class="literal">null</span>; x = x.next)</span><br><span class="line">        clone.add(x.item);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> clone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ce746b79-24bb-4517-9916-86e9830c22b2-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> LinkedList&lt;E&gt; <span class="title function_">superClone</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (LinkedList&lt;E&gt;) <span class="built_in">super</span>.clone();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InternalError</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>]]></content>
    
    
    <summary type="html">ArrayListå’ŒLinkedListè®¾è®¡åˆ†æ</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/tags/Java/"/>
    
    <category term="å®¹å™¨" scheme="https://wuwawawa.github.io/tags/%E5%AE%B9%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>æœ‰åºé›†åˆæ¥å£List</title>
    <link href="https://wuwawawa.github.io/posts/494ad091.html"/>
    <id>https://wuwawawa.github.io/posts/494ad091.html</id>
    <published>2023-05-16T11:22:46.000Z</published>
    <updated>2023-05-20T03:04:35.445Z</updated>
    
    <content type="html"><![CDATA[<img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/List%E4%BD%93%E7%B3%BB%E5%9B%BE1.jpg" alt="Listä½“ç³»å›¾1" style="zoom:50%;" /><h2 id="Listé›†åˆçš„æ¦‚è¿°å’Œç‰¹ç‚¹">Listé›†åˆçš„æ¦‚è¿°å’Œç‰¹ç‚¹</h2><blockquote><p>Listé›†åˆçš„æ¦‚è¿°</p></blockquote><ul><li>æœ‰åºé›†åˆ,è¿™é‡Œçš„æœ‰åºæŒ‡çš„æ˜¯å­˜å–é¡ºåº</li><li>ç”¨æˆ·å¯ä»¥ç²¾ç¡®æ§åˆ¶åˆ—è¡¨ä¸­æ¯ä¸ªå…ƒç´ çš„æ’å…¥ä½ç½®,ç”¨æˆ·å¯ä»¥é€šè¿‡æ•´æ•°ç´¢å¼•è®¿é—®å…ƒç´ ,å¹¶æœç´¢åˆ—è¡¨ä¸­çš„å…ƒç´ </li><li>ä¸Seté›†åˆä¸åŒ,åˆ—è¡¨é€šå¸¸å…è®¸é‡å¤çš„å…ƒç´ </li></ul><blockquote><p>Listé›†åˆçš„ç‰¹ç‚¹</p></blockquote><ul><li>æœ‰åºï¼š å­˜å’Œå–çš„å…ƒç´ é¡ºåºä¸€è‡´</li><li>æœ‰ç´¢å¼•ï¼š å¯ä»¥é€šè¿‡ç´¢å¼•æ“ä½œå…ƒç´ </li><li>å¯é‡å¤ï¼šå­˜å‚¨çš„å…ƒç´ å¯ä»¥é‡å¤</li></ul><hr><hr><h2 id="Listé›†åˆçš„ç‰¹æœ‰æ–¹æ³•">Listé›†åˆçš„ç‰¹æœ‰æ–¹æ³•</h2><ul><li>Collectionçš„æ–¹æ³•Listéƒ½ç»§æ‰¿äº†</li><li>Listé›†åˆå› ä¸ºæœ‰ç´¢å¼•ï¼Œç´¢å¼•å¤šäº†å¾ˆå¤šç´¢å¼•æ“ä½œçš„æ–¹æ³•</li></ul><table><thead><tr><th>æ–¹æ³•å</th><th>æè¿°</th></tr></thead><tbody><tr><td>void add(int index,E element)</td><td>åœ¨æ­¤é›†åˆä¸­çš„æŒ‡å®šä½ç½®æ’å…¥æŒ‡å®šçš„å…ƒç´ </td></tr><tr><td>E remove(int index)</td><td>åˆ é™¤æŒ‡å®šç´¢å¼•å¤„çš„å…ƒç´ ï¼Œè¿”å›è¢«åˆ é™¤çš„å…ƒç´ </td></tr><tr><td>E set(int index,E element)</td><td>ä¿®æ”¹æŒ‡å®šç´¢å¼•å¤„çš„å…ƒç´ ï¼Œè¿”å›è¢«ä¿®æ”¹çš„å…ƒç´ </td></tr><tr><td>E get(int index)</td><td>è¿”å›æŒ‡å®šç´¢å¼•å¤„çš„å…ƒç´ </td></tr><tr><td>int indexOf(Object o);</td><td>è¿”å›æŒ‡å®šå…ƒç´ çš„ç´¢å¼•</td></tr><tr><td>ListIterator&lt; E &gt; listIterator();</td><td>è¿”å›åˆ—è¡¨è¿­ä»£å™¨</td></tr></tbody></table><blockquote><p>Listç³»åˆ—é›†åˆä¸­ä¸¤ä¸ªå¢åŠ çš„æ–¹æ³•</p></blockquote><p>ç¬¬ä¸€ä¸ªCollectionæ¥å£ä¸­æ–¹æ³• <code> boolean add(E e);</code>æ·»åŠ æŒ‡å®šçš„å…ƒç´ ,è¿”å›å€¼è¡¨ç¤ºå½“å‰å…ƒç´ æ˜¯å¦æ·»åŠ æˆåŠŸ</p><p>ç¬¬äºŒä¸ªListæ¥å£ä¸­æ–¹æ³• <code> void add(int index,E element)</code> æ·»åŠ æŒ‡å®šç´¢å¼•çš„å…ƒç´ ï¼Œæ— è¿”å›å€¼</p><blockquote><p>Listç³»åˆ—é›†åˆä¸­ä¸¤ä¸ªåˆ é™¤çš„æ–¹æ³•</p></blockquote><p>ç¬¬ä¸€ä¸ªCollectionæ¥å£ä¸­æ–¹æ³•  <code> boolean remove(Object o)</code>åˆ é™¤æŒ‡å®šçš„å…ƒç´ ,è¿”å›å€¼è¡¨ç¤ºå½“å‰å…ƒç´ æ˜¯å¦åˆ é™¤æˆåŠŸ</p><p>ç¬¬äºŒä¸ªListæ¥å£ä¸­æ–¹æ³• <code> E remove(int index)</code> åˆ é™¤æŒ‡å®šç´¢å¼•çš„å…ƒç´ ,è¿”å›å€¼è¡¨ç¤ºå®é™…åˆ é™¤çš„å…ƒç´ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1. åˆ›å»ºé›†åˆå¹¶æ·»åŠ å…ƒç´ </span></span><br><span class="line">List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">list.add(<span class="number">1</span>);</span><br><span class="line">list.add(<span class="number">2</span>);</span><br><span class="line">list.add(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//2. åˆ é™¤å…ƒç´ </span></span><br><span class="line"><span class="comment">//è¯·é—®ï¼šæ­¤æ—¶åˆ é™¤çš„æ˜¯1è¿™ä¸ªå…ƒç´ ï¼Œè¿˜æ˜¯1ç´¢å¼•ä¸Šçš„å…ƒç´  ä¸ºä»€ä¹ˆ</span></span><br><span class="line"><span class="comment">//åœ¨è°ƒç”¨æ–¹æ³•çš„æ—¶å€™ï¼Œå¦‚æœå‡ºç°äº†é‡è½½ç°è±¡</span></span><br><span class="line"><span class="comment">//ä¼˜å…ˆè°ƒç”¨ï¼Œå®å‚å’Œå½¢å‚ç±»å‹ä¸€è‡´çš„é‚£ä¸ªæ–¹æ³•</span></span><br><span class="line">list.remove(<span class="number">1</span>);</span><br><span class="line">System.out.println(list);</span><br><span class="line"><span class="comment">//[1, 3]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰‹åŠ¨è£…ç®±,æ‰‹åŠ¨æŠŠåŸºæœ¬æ•°æ®ç±»å‹çš„1ï¼Œå˜æˆIntegerç±»å‹</span></span><br><span class="line"><span class="comment">// æ­¤æ—¶åˆ é™¤çš„å°±æ˜¯1è¿™ä¸ªå…ƒç´ </span></span><br><span class="line"><span class="type">Integer</span> <span class="variable">i</span> <span class="operator">=</span> Integer.valueOf(<span class="number">1</span>);</span><br><span class="line">list.remove(i);</span><br><span class="line">System.out.println(list);</span><br><span class="line"><span class="comment">//[3]</span></span><br></pre></td></tr></table></figure><hr><h2 id="Listé›†åˆçš„éå†æ–¹å¼">Listé›†åˆçš„éå†æ–¹å¼</h2><p>Listç»§æ‰¿äºCollectionï¼Œä¸‰ç§éå†æ–¹å¼ä¹Ÿéƒ½å¯ä»¥ç”¨</p><ul><li>è¿­ä»£å™¨éå†</li><li>å¢å¼ºforéå†</li><li>Lambdaè¡¨è¾¾å¼éå†</li></ul><p>åœ¨æ­¤åŸºç¡€ä¸Šï¼Œè¿˜æœ‰ä¸¤ç§å•ç‹¬çš„éå†æ–¹å¼</p><ul><li>åˆ—è¡¨è¿­ä»£å™¨éå†</li><li>æ™®é€šforå¾ªç¯ï¼ˆå› ä¸ºListé›†åˆå­˜åœ¨ç´¢å¼•ï¼‰</li></ul><p>åˆ›å»ºé›†åˆå¹¶æ·»åŠ å…ƒç´ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1. åˆ›å»ºé›†åˆå¹¶æ·»åŠ å…ƒç´ </span></span><br><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">list.add(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;ccc&quot;</span>);</span><br></pre></td></tr></table></figure><div class="tabs" id="1c246663-c60c-42f3-ba8d-77e38f358527"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#1c246663-c60c-42f3-ba8d-77e38f358527-1"><i class="fas fa-child"></i>è¿­ä»£å™¨</button></li><li class="tab"><button type="button" data-href="#1c246663-c60c-42f3-ba8d-77e38f358527-2"><i class="fas fa-child"></i>å¢å¼ºfor</button></li><li class="tab"><button type="button" data-href="#1c246663-c60c-42f3-ba8d-77e38f358527-3"><i class="fas fa-child"></i>Lambdaè¡¨è¾¾å¼</button></li><li class="tab"><button type="button" data-href="#1c246663-c60c-42f3-ba8d-77e38f358527-4"><i class="fas fa-cookie-bite"></i>åˆ—è¡¨è¿­ä»£å™¨</button></li><li class="tab"><button type="button" data-href="#1c246663-c60c-42f3-ba8d-77e38f358527-5"><i class="fas fa-cookie-bite"></i>æ™®é€šfor</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="1c246663-c60c-42f3-ba8d-77e38f358527-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.è¿­ä»£å™¨</span></span><br><span class="line">Iterator&lt;String&gt; iterator = list.iterator();</span><br><span class="line"><span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">    System.out.println(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="1c246663-c60c-42f3-ba8d-77e38f358527-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2.å¢å¼ºfor</span></span><br><span class="line"><span class="keyword">for</span> (String str : list) &#123;</span><br><span class="line">    System.out.println(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="1c246663-c60c-42f3-ba8d-77e38f358527-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//3.Lambdaè¡¨è¾¾å¼</span></span><br><span class="line"> list.forEach(System.out::println);</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="1c246663-c60c-42f3-ba8d-77e38f358527-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//4.åˆ—è¡¨è¿­ä»£å™¨</span></span><br><span class="line">ListIterator&lt;String&gt; stringListIterator = list.listIterator();</span><br><span class="line"><span class="keyword">while</span> (stringListIterator.hasNext()) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span>  stringListIterator.next();</span><br><span class="line">    System.out.println(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="1c246663-c60c-42f3-ba8d-77e38f358527-5"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//5.æ™®é€šforå¾ªç¯</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">    System.out.println(list.get(i));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p><code>ListIterator</code>æ¥å£ç»§æ‰¿äº†<code>Iterator</code>æ¥å£</p><p><code>interface ListIterator&lt;E&gt; extends Iterator&lt;E&gt;</code></p><p><code>Iterator</code>åŸæœ‰æ–¹æ³•<code>boolean hasNext()</code> å’Œ <code>E next()</code></p><p><code>ListIterator</code>æ–°åŠ äº†<code>boolean hasPrevious();</code>å’Œ<code>E previous()</code>å‘å‰éå†</p><p>å’Œ<code>void add(E e)</code>æ·»åŠ å…ƒç´ çš„æ–¹æ³•</p><blockquote><p>äº”ç§éå†æ–¹å¼å¯¹æ¯”</p></blockquote><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230516205838333.png" alt="image-20230516205838333" style="zoom:67%;" />]]></content>
    
    
    <summary type="html">Listä¸­å¸¸è§çš„æ–¹æ³•å’Œäº”ç§éå†æ–¹å¼</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/tags/Java/"/>
    
    <category term="å®¹å™¨" scheme="https://wuwawawa.github.io/tags/%E5%AE%B9%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>é¡¶å±‚æ¥å£Collection</title>
    <link href="https://wuwawawa.github.io/posts/71c14870.html"/>
    <id>https://wuwawawa.github.io/posts/71c14870.html</id>
    <published>2023-05-16T06:05:20.000Z</published>
    <updated>2023-05-23T12:33:19.927Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é›†åˆä½“ç³»ç»“æ„">é›†åˆä½“ç³»ç»“æ„</h2><p>Javaçš„å®¹å™¨ä¸»è¦åˆ†ä¸º2ä¸ªå¤§ç±»ï¼Œå³<code>Collection</code>å’Œ<code>Map</code>ã€‚</p><ul><li><span class='p red'>Collection æ¥å£ï¼ˆå•åˆ—é›†åˆï¼‰</span>ï¼šå¯ä»¥å­˜æ”¾å¤šä¸ªå…ƒç´ ã€‚æ¯ä¸ªå…ƒç´ å¯ä»¥æ˜¯ Object<p>Collection æ¥å£æœ‰ä¸¤ä¸ªé‡è¦å­æ¥å£ï¼šListï¼ˆæœ‰åºé›†åˆï¼‰å’Œ Setï¼ˆæ— åºé›†åˆï¼‰</p></li><li><span class='p blue'>Map æ¥å£ï¼ˆåŒåˆ—é›†åˆï¼‰</span>ï¼šç”¨äºä¿å­˜å…·æœ‰æ˜ å°„å…³ç³»çš„æ•°æ®ï¼škey - valueï¼ˆåŒåˆ—å…ƒç´ ï¼‰<p>key å’Œ value å¯ä»¥æ˜¯ä»»ä½•ç±»å‹çš„å¼•ç”¨æ•°æ®ç±»å‹ã€‚å…¶ä¸­ key ä¸èƒ½é‡å¤ï¼Œvalue å¯ä»¥é‡å¤</p><p>key å’Œ value å­˜åœ¨å•ä¸€å¯¹åº”å…³ç³»ã€‚é€šè¿‡ç‰¹å®šçš„ key ä¸€å®šèƒ½æ‰¾åˆ°æŒ‡å®šçš„ value</p></li></ul><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230516142001202.png" alt="image-20230516142001202" style="zoom:67%;" /><hr><hr><h2 id="Collectionç»§æ‰¿ä½“ç³»">Collectionç»§æ‰¿ä½“ç³»</h2><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230516142842394.png" alt="image-20230516142842394" style="zoom:67%;" /><p>æ ¹æ®å›¾ï¼Œé¦–å…ˆæä¸€ä¸‹<code>List</code> <code>Queue</code> <code>Set</code> è¿™ä¸‰ä¸ªçš„åŒºåˆ«ã€‚</p><p><code>List(å¯¹ä»˜é¡ºåºçš„å¥½å¸®æ‰‹)</code>: æ·»åŠ çš„å…ƒç´ æ˜¯æœ‰åºã€å¯é‡å¤ã€æœ‰ç´¢å¼•çš„ã€‚<br><code>Set(æ³¨é‡ç‹¬ä¸€æ— äºŒçš„æ€§è´¨)</code>ï¼šæ·»åŠ çš„å…ƒç´ æ˜¯æ— åºçš„ã€ä¸å¯é‡å¤ã€æ— ç´¢å¼•çš„ã€‚<br><code>Queue(å®ç°æ’é˜ŸåŠŸèƒ½çš„å«å·æœº)</code>:æŒ‰ç‰¹å®šçš„æ’é˜Ÿè§„åˆ™æ¥ç¡®å®šå…ˆåé¡ºåºï¼Œå­˜å‚¨çš„å…ƒç´ æ˜¯æœ‰åºçš„ã€å¯é‡å¤çš„ã€‚</p><hr><hr><h2 id="Collectionæ¥å£æ–¹æ³•">Collectionæ¥å£æ–¹æ³•</h2><p>Collectionæ˜¯å•åˆ—é›†åˆçš„ç¥–å®—æ¥å£ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯å…¨éƒ¨å•åˆ—é›†åˆéƒ½å¯ä»¥ç»§æ‰¿ä½¿ç”¨çš„ã€‚</p><p>JDKä¸æä¾›æ­¤æ¥å£çš„ä»»ä½•ç›´æ¥å®ç°.å®ƒæä¾›æ›´å…·ä½“çš„å­æ¥å£(å¦‚Setå’ŒList)å®ç°</p><table><thead><tr><th style="text-align:left">æ–¹æ³•å</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left">boolean add(E e)</td><td style="text-align:left">æ·»åŠ å…ƒç´ </td></tr><tr><td style="text-align:left">boolean addAll(Collection&lt;? extends E&gt; c)</td><td style="text-align:left">æ·»åŠ å¤šä¸ªå…ƒç´ </td></tr><tr><td style="text-align:left">boolean remove(Object o)</td><td style="text-align:left">ç§»é™¤æŒ‡å®šçš„å…ƒç´ </td></tr><tr><td style="text-align:left">boolean removeIf(Predicate&lt;? super E&gt; filter)</td><td style="text-align:left">æ ¹æ®æ¡ä»¶è¿›è¡Œç§»é™¤</td></tr><tr><td style="text-align:left">boolean removeAll(Collection&lt;?&gt; c)</td><td style="text-align:left">ç§»é™¤å¤šä¸ªå…ƒç´ </td></tr><tr><td style="text-align:left">void clear()</td><td style="text-align:left">æ¸…ç©ºé›†åˆä¸­çš„å…ƒç´ </td></tr><tr><td style="text-align:left">boolean contains(Object o)</td><td style="text-align:left">åˆ¤æ–­é›†åˆä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„å…ƒç´ </td></tr><tr><td style="text-align:left">boolean isEmpty()</td><td style="text-align:left">åˆ¤æ–­é›†åˆæ˜¯å¦ä¸ºç©º</td></tr><tr><td style="text-align:left">int size()</td><td style="text-align:left">é›†åˆçš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯é›†åˆä¸­å…ƒç´ çš„ä¸ªæ•°</td></tr></tbody></table><blockquote><p>æ·»åŠ å…ƒç´  boolean add(E e)</p></blockquote><p>ç»†èŠ‚1ï¼šå¦‚æœæˆ‘ä»¬è¦å¾€Listç³»åˆ—é›†åˆæ·»åŠ æ•°æ®ï¼Œé‚£ä¹ˆæ–¹æ³•æ°¸è¿œè¿”å›tureï¼Œå› ä¸ºListç³»åˆ—æ˜¯å…è®¸å…ƒç´ é‡å¤çš„ã€‚</p><p>ç»†èŠ‚2ï¼šå¦‚æœæˆ‘ä»¬è¦å¾€Setç³»åˆ—é›†åˆæ·»åŠ æ•°æ®</p><p>å¦‚æœå½“å‰è¦æ·»åŠ çš„å…ƒç´ ä¸å­˜åœ¨ï¼Œæ–¹æ³•è¿”å›trueï¼Œè¡¨ç¤ºæ·»åŠ æˆåŠŸã€‚</p><p>å¦‚æœå½“å‰è¦æ·»åŠ çš„å…ƒç´ å­˜åœ¨ï¼Œæ–¹æ³•è¿”å›falseï¼Œè¡¨ç¤ºæ·»åŠ å¤±è´¥ã€‚</p><p>å› ä¸ºSetç³»åˆ—é›†åˆä¸å…è®¸é‡å¤ã€‚</p><blockquote><p>ç§»é™¤å…ƒç´  boolean remove(Object o)</p></blockquote><p>ç»†èŠ‚1ï¼šæ ¹æ®å…ƒç´ çš„å¯¹è±¡è¿›è¡Œåˆ é™¤ï¼Œä¸èƒ½é€šè¿‡ç´¢å¼•åˆ ï¼Œå› ä¸ºSetç³»åˆ—æ˜¯æ²¡æœ‰ç´¢å¼•çš„ï¼Œåœ¨Collectionä¸­å®šä¹‰çš„æ˜¯å…±æ€§çš„æ–¹æ³•ã€‚</p><p>ç»†èŠ‚2ï¼šæ–¹æ³•ä¼šæœ‰ä¸€ä¸ªå¸ƒå°”ç±»å‹çš„è¿”å›å€¼ï¼Œåˆ é™¤æˆåŠŸè¿”å›trueï¼Œåˆ é™¤å¤±è´¥è¿”å›falseã€‚å¦‚æœè¦åˆ é™¤çš„å…ƒç´ ä¸å­˜åœ¨ï¼Œå°±ä¼šåˆ é™¤å¤±è´¥ã€‚</p><blockquote><p>åˆ¤æ–­å…ƒç´ æ˜¯å¦åŒ…å« boolean contains(Object o)</p></blockquote><p>åº•å±‚æ˜¯ä¾èµ–equalsæ–¹æ³•è¿›è¡Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨çš„ã€‚æ‰€ä»¥ï¼Œå¦‚æœé›†åˆä¸­å­˜å‚¨çš„æ˜¯è‡ªå®šä¹‰å¯¹è±¡ï¼Œä¹Ÿæƒ³é€šè¿‡containsæ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦åŒ…å«ï¼Œé‚£ä¹ˆåœ¨è‡ªå®šä¹‰ç±»ä¸­ï¼Œä¸€å®šè¦é‡å†™equalsæ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.åˆ›å»ºé›†åˆçš„å¯¹è±¡</span></span><br><span class="line">Collection&lt;Studebt&gt; coll = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.åˆ›å»ºä¸‰ä¸ªå­¦ç”Ÿå¯¹è±¡</span></span><br><span class="line"><span class="type">Student</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;zhangsan&quot;</span>,<span class="number">23</span>);</span><br><span class="line"><span class="type">Student</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;lisi&quot;</span>,<span class="number">24</span>);</span><br><span class="line"><span class="type">Student</span> <span class="variable">s3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;wangwu&quot;</span>,<span class="number">23</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.æŠŠå­¦ç”Ÿå¯¹è±¡æ·»åŠ åˆ°é›†åˆå½“ä¸­</span></span><br><span class="line">coll.add(s1);</span><br><span class="line">coll.add(s2);</span><br><span class="line">coll.add(s3);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.åˆ¤æ–­é›†åˆä¸­æŸä¸€ä¸ªå­¦ç”Ÿå¯¹è±¡æ˜¯å¦åŒ…å«ï¼Œå¦‚æœåŒå§“ååŒå¹´é¾„ï¼Œå°±è®¤ä¸ºæ˜¯</span></span><br><span class="line"><span class="type">Student</span> <span class="variable">s4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;zhangsan&quot;</span>,<span class="number">23</span>);</span><br><span class="line"><span class="comment">// å› ä¸ºcontainsæ–¹æ³•åœ¨åº•å±‚ä¾èµ–equalsæ–¹æ³•åˆ¤æ–­å¯¹è±¡æ˜¯å¦ä¸€è‡´çš„ã€‚</span></span><br><span class="line"><span class="comment">// å¦‚æœå­˜çš„æ˜¯è‡ªå®šä¹‰å¯¹è±¡ï¼Œæ²¡æœ‰é‡å†™equalsæ–¹æ³•ï¼Œé‚£ä¹ˆé»˜è®¤ä½¿ç”¨Objectç±»ä¸­çš„equalsæ–¹æ³•è¿›è¡Œåˆ¤æ–­</span></span><br><span class="line"><span class="comment">// è€ŒObjectç±»ä¸­equalsæ–¹æ³•ï¼Œä¾èµ–åœ°å€å€¼å°±è¡Œåˆ¤æ–­ã€‚</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥ï¼Œéœ€è¦åœ¨è‡ªå®šä¹‰çš„ç±»ä¸­ï¼Œé‡å†™equalsæ–¹æ³•å°±å¯ä»¥äº†ã€‚</span></span><br><span class="line">System.out.println(coll.contains(s4));</span><br></pre></td></tr></table></figure><hr><hr><h2 id="Collectionéå†æ–¹å¼">Collectionéå†æ–¹å¼</h2><p>Collectioné€šç”¨éå†æ–¹å¼æœ‰ä¸‰ç§ï¼š</p><ol><li>è¿­ä»£å™¨éå†</li><li>å¢å¼ºforéå†</li><li>Lambdaè¡¨è¾¾å¼</li></ol><hr><h3 id="è¿­ä»£å™¨éå†">è¿­ä»£å™¨éå†</h3><p>è¿­ä»£å™¨åœ¨Javaä¸­çš„ç±»æ˜¯<span class='p red'>Iterator</span>ï¼Œè¿­ä»£å™¨æ˜¯é›†åˆä¸“ç”¨çš„éå†æ–¹å¼ã€‚</p><mark class="hl-label blue">Collectioné›†åˆè·å–è¿­ä»£å™¨</mark> <table><thead><tr><th style="text-align:left">æ–¹æ³•åç§°</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left">Iterator&lt; E &gt; iterator()</td><td style="text-align:left">è¿”å›è¿­ä»£å™¨å¯¹è±¡ï¼Œé»˜è®¤æŒ‡å‘å½“å‰é›†åˆçš„0ç´¢å¼•</td></tr></tbody></table><mark class="hl-label green">iteratorä¸­çš„å¸¸ç”¨æ–¹æ³•</mark> <table><thead><tr><th>æ–¹æ³•åç§°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>boolean hasNext()</td><td>åˆ¤æ–­å½“å‰ä½ç½®æ˜¯å¦æœ‰å…ƒç´ ï¼Œæœ‰å…ƒç´ è¿”å›trueï¼Œæ²¡æœ‰å…ƒç´ è¿”å›false</td></tr><tr><td>E next()</td><td>è·å–å½“å‰ä½ç½®çš„å…ƒç´ ï¼Œå¹¶å°†è¿­ä»£å™¨å¯¹è±¡ç§»å‘ä¸‹ä¸€ä¸ªä½ç½®</td></tr></tbody></table><div class="tabs" id="453454f2-6b5c-4dc3-a93a-77c2d76544de"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#453454f2-6b5c-4dc3-a93a-77c2d76544de-1"><i class="fas fa-cat"></i>å¼€å§‹æƒ…å†µ</button></li><li class="tab"><button type="button" data-href="#453454f2-6b5c-4dc3-a93a-77c2d76544de-2"><i class="fas fa-horse"></i>ç»“æŸæƒ…å†µ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="453454f2-6b5c-4dc3-a93a-77c2d76544de-1"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230516170605737.png" alt="image-20230516170605737" style="zoom: 50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="453454f2-6b5c-4dc3-a93a-77c2d76544de-2"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230516172114394.png" alt="image-20230516172114394"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><mark class="hl-label red">ç»†èŠ‚æ³¨æ„ç‚¹</mark> <ol><li>å½“ä¸Šé¢çš„å¾ªç¯ç»“æŸåï¼Œè¿­ä»£å™¨æŒ‡å‘é›†åˆçš„æœ«å°¾ï¼Œå†å¼ºè¡Œè°ƒç”¨nextæ–¹æ³•è·å–å…ƒç´ çš„è¯ï¼Œå°±ä¼šæŠ¥é”™NoSuchElementException</li><li>è¿­ä»£å™¨éå†å®Œæ¯•åï¼Œè¿­ä»£å™¨æ˜¯ä¸ä¼šå¤ä½çš„ï¼Œå¦‚æœè¦æƒ³é‡æ–°éå†ä¸€æ¬¡ï¼Œå¯ä»¥é‡æ–°è·å–è¿­ä»£å™¨å¯¹è±¡</li><li>å¾ªç¯ä¸­åªèƒ½ä½¿ç”¨ä¸€æ¬¡nextæ–¹æ³•ï¼Œå› ä¸ºåœ¨whileåˆ¤æ–­æ¡ä»¶ä¸­åªåˆ¤æ–­äº†ä¸€æ¬¡hasNextï¼ŒhasNextå’Œnextè¦ä¸€ä¸€å¯¹åº”</li><li>è¿­ä»£å™¨éå†æ—¶ï¼Œä¸èƒ½ä½¿ç”¨é›†åˆçš„æ–¹æ³•è¿›è¡Œå¢åŠ æˆ–è€…åˆ é™¤(ä¼šå¯¼è‡´expectedModCountå’ŒmodCountä¸ç›¸ç­‰)ï¼Œå¦‚æœå®åœ¨è¦åˆ é™¤ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨è¿­ä»£å™¨æä¾›çš„removeæ–¹æ³•è¿›è¡Œåˆ é™¤</li></ol><hr><h3 id="å¢å¼ºforéå†">å¢å¼ºforéå†</h3><p>å¢å¼ºforçš„åº•å±‚å°±æ˜¯è¿­ä»£å™¨ï¼Œä¸ºäº†ç®€åŒ–è¿­ä»£å™¨çš„ä»£ç ä¹¦å†™çš„ã€‚</p><p>å®ƒæ˜¯JDK5ä¹‹åå‡ºç°çš„ï¼Œå…¶å†…éƒ¨åŸç†å°±æ˜¯ä¸€ä¸ªIteratorè¿­ä»£å™¨</p><p>å¢å¼ºforå¾ªç¯å¯ä»¥ç”¨æ¥éå†æ•°ç»„å’Œå®ç°äº†<code>Iterable</code>æ¥å£çš„é›†åˆå¯¹è±¡ã€‚</p><p>åœ¨Javaä¸­ï¼Œæ‰€æœ‰çš„å•åˆ—é›†åˆéƒ½å®ç°äº†<code>Iterable</code>æ¥å£ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨å¢å¼ºforå¾ªç¯éå†è¿™äº›é›†åˆã€‚</p><p>å•åˆ—é›†åˆåŒ…æ‹¬<code>List</code>ã€<code>Set</code>ã€<code>Queue</code>ç­‰ï¼Œä½†ä¸åŒ…æ‹¬<code>Map</code>ï¼Œå› ä¸º<code>Map</code>æ˜¯åŒåˆ—é›†åˆã€‚</p><mark class="hl-label green">æ ¼å¼</mark> <p>idea å¿«é€Ÿç”Ÿæˆæ–¹å¼   <code>é›†åˆçš„åå­—.for</code></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">for</span>(å…ƒç´ æ•°æ®ç±»å‹ å˜é‡å : æ•°ç»„æˆ–è€…é›†åˆ)&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">for</span>(String s in coll)&#123;</span><br><span class="line">System<span class="selector-class">.out</span><span class="selector-class">.println</span>(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><mark class="hl-label red">æ³¨æ„ç‚¹</mark> <p>så…¶å®å°±æ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹å˜é‡ï¼Œåœ¨å¾ªç¯çš„è¿‡ç¨‹ä¸­ä¾æ¬¡è¡¨ç¤ºé›†åˆä¸­çš„æ¯ä¸€ä¸ªæ•°æ®</p><p>ä¿®æ”¹å¢å¼ºforä¸­çš„å˜é‡ï¼Œä¸ä¼šæ”¹å˜é›†åˆä¸­åŸæœ¬çš„æ•°æ®</p><hr><h3 id="Lambdaè¡¨è¾¾å¼éå†">Lambdaè¡¨è¾¾å¼éå†</h3><p>å¾—ç›ŠäºJDK 8å¼€å§‹çš„æ–°æŠ€æœ¯Lambdaè¡¨è¾¾å¼ï¼Œæä¾›äº†ä¸€ç§æ›´ç®€å•ã€æ›´ç›´æ¥çš„éå†é›†åˆçš„æ–¹å¼ã€‚</p><table><thead><tr><th>æ–¹æ³•åç§°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>defalut void forEach(Consumer&lt;? super T&gt; action)</td><td>ç»“åˆlambdaéå†é›†åˆ</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åŒ¿åå†…éƒ¨ç±»çš„å½¢å¼</span></span><br><span class="line">coll.forEach(<span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//lambdaè¡¨è¾¾å¼</span></span><br><span class="line">coll.forEach(s -&gt; System.out.println(s));</span><br></pre></td></tr></table></figure><mark class="hl-label blue">åº•å±‚åŸç†</mark> <p>æ–¹æ³•å†…éƒ¨ä¹Ÿä¼šå¾ªç¯éå†é›†åˆï¼Œä¾æ¬¡å¾—åˆ°æ¯ä¸€ä¸ªå…ƒç´ ï¼ŒæŠŠå¾—åˆ°çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œä¼ é€’ç»™acceptæ–¹æ³•æ¶ˆè´¹</p><hr><hr><h2 id="Collectionéå†è§„å¾‹">Collectionéå†è§„å¾‹</h2><ol><li>éå†é¡ºåºä¸å…ƒç´ æ·»åŠ çš„é¡ºåºæœ‰å…³çš„é›†åˆï¼šArrayListã€LinkedListã€LinkedHashSetã€ArrayDequeã€LinkedListã€‚</li><li>éå†é¡ºåºä¸Comparatoræœ‰å…³çš„é›†åˆï¼šPriorityQueueã€TreeSetã€‚</li></ol><p>PriorityQueueéå†å¹¶æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œå› ä¸ºPriorityQueueæ˜¯ä¸€ç§åŸºäºå †çš„æ•°æ®ç»“æ„ï¼Œå †é¡¶å…ƒç´ æ°¸è¿œæ˜¯ä¼˜å…ˆçº§æœ€é«˜çš„å…ƒç´ ï¼Œè€Œéå†PriorityQueueéœ€è¦è®¿é—®æ‰€æœ‰å…ƒç´ ï¼Œå› æ­¤ä¼šæµªè´¹å¾ˆå¤šæ—¶é—´è®¿é—®é‚£äº›ä¼˜å…ˆçº§è¾ƒä½çš„å…ƒç´ ã€‚</p><p>PriorityQueue ä½¿ç”¨æ•°ç»„å­˜å‚¨ï¼Œä½œä¸ºå †ï¼Œä½ åªèƒ½è·å¾—ä»–çš„æœ€å¤§ï¼Œæœ€å°å€¼ï¼Œå¯ä»¥å­˜å‚¨é‡å¤çš„å€¼ã€‚</p><p>TreeSetå¯ä»¥ä¿è¯æ•°æ®å…¨éƒ¨æŒ‰ç…§æŸä¸ªé¡ºåºæ’åˆ—ï¼Œä¸å…è®¸é‡å¤ï¼Œå¯è·å¾—å…¶ä¸­çš„ä»»æ„å€¼ï¼Œæä¾›æ¯”ä¼˜å…ˆé˜Ÿåˆ—æ›´å¤šçš„ç‰¹æ€§ï¼Œä½†åŒæ ·æ„å‘³ç€éœ€è¦è¿›è¡Œæ›´å¤šçš„è®¡ç®—ã€‚</p>]]></content>
    
    
    <summary type="html">é›†åˆä½“ç³»ç»“æ„å’Œé¡¶å±‚æ¥å£Collection</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/tags/Java/"/>
    
    <category term="å®¹å™¨" scheme="https://wuwawawa.github.io/tags/%E5%AE%B9%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>Java8æ–°ç‰¹æ€§</title>
    <link href="https://wuwawawa.github.io/posts/397c083a.html"/>
    <id>https://wuwawawa.github.io/posts/397c083a.html</id>
    <published>2023-05-10T08:05:42.000Z</published>
    <updated>2023-05-29T01:22:01.553Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Java8æ–°ç‰¹æ€§çš„å¥½å¤„">Java8æ–°ç‰¹æ€§çš„å¥½å¤„</h2><ol><li>é€Ÿåº¦æ›´å¿«</li><li>ä»£ç æ›´å°‘ï¼ˆLambdaç®€åŒ–ä»£ç ä¹¦å†™ï¼‰</li><li>å¼ºå¤§çš„Stream API</li><li>ä¾¿äºå¹¶è¡Œ</li><li>æœ€å¤§åŒ–å‡å°‘ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼šOptional</li><li>Nashornå¼•æ“ï¼Œå…è®¸åœ¨JVMä¸Šè¿è¡ŒJSåº”ç”¨</li></ol><hr><hr><h2 id="æ¥å£å˜åŒ–">æ¥å£å˜åŒ–</h2><p>åœ¨JDK 8 ä»¥å‰ï¼Œæ¥å£ä¸­åªæœ‰æŠ½è±¡æ–¹æ³•å’Œé™æ€å¸¸é‡ï¼Œä¼šå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼šåœ¨æ¥å£ä¸­æ–°å¢æ–¹æ³•ï¼Œæ‰€æœ‰å®ç°ç±»éƒ½è¦é‡å†™è¯¥æ–¹æ³•ï¼Œä¸åˆ©äºæ¥å£çš„æ‰©å±•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">interface æ¥å£å&#123;</span><br><span class="line">é™æ€å¸¸é‡ï¼ˆ<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span>ï¼‰;</span><br><span class="line">æŠ½è±¡æ–¹æ³•ï¼ˆ<span class="keyword">public</span> <span class="keyword">abstract</span>ï¼‰;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨JDK 8 ä¹‹åï¼Œæ¥å£ä¸­å¢åŠ äº†defaultæ–¹æ³•å’Œstaticæ–¹æ³•ï¼Œåˆ†åˆ«ä½¿ç”¨ static å’Œ default å…³é”®å­—ä¿®é¥°ï¼Œè¿™ä¸¤ç§æ–¹æ³•å¯ä»¥æœ‰æ–¹æ³•ä½“ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">interface æ¥å£å&#123;</span><br><span class="line">é™æ€å¸¸é‡ï¼ˆ<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span>ï¼‰;</span><br><span class="line">æŠ½è±¡æ–¹æ³•ï¼ˆ<span class="keyword">public</span> <span class="keyword">abstract</span>ï¼‰;</span><br><span class="line">é»˜è®¤æ–¹æ³•</span><br><span class="line">é™æ€æ–¹æ³•</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><mark class="hl-label blue">åŒºåˆ«</mark> <ol><li>é»˜è®¤æ–¹æ³•é€šè¿‡å®ä¾‹è°ƒç”¨ï¼Œé™æ€æ–¹æ³•é€šè¿‡æ¥å£åè°ƒç”¨</li><li>é»˜è®¤æ–¹æ³•å¯ä»¥è¢«ç»§æ‰¿ï¼Œå®ç°ç±»å¯ä»¥ç›´æ¥è°ƒç”¨æ¥å£é»˜è®¤æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥é‡å†™æ¥å£é»˜è®¤æ–¹æ³•</li><li>é™æ€æ–¹æ³•ä¸èƒ½è¢«ç»§æ‰¿ï¼Œå®ç°ç±»ä¸èƒ½é‡å†™æ¥å£çš„é™æ€æ–¹æ³•ï¼Œåªèƒ½ä½¿ç”¨æ¥å£åè°ƒç”¨</li></ol><hr><h3 id="é»˜è®¤æ–¹æ³•">é»˜è®¤æ–¹æ³•</h3><p>åœ¨JDK8ä»¥å‰æ¥å£ä¸­åªèƒ½æœ‰æŠ½è±¡æ–¹æ³•å’Œé™æ€å¸¸é‡ï¼Œä¼šå­˜åœ¨ä»¥ä¸‹çš„é—®é¢˜ï¼š<br>å¦‚æœæ¥å£ä¸­æ–°å¢æŠ½è±¡æ–¹æ³•ï¼Œé‚£ä¹ˆå®ç°ç±»éƒ½å¿…é¡»è¦æŠ½è±¡è¿™ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œéå¸¸ä¸åˆ©äºæ¥å£çš„æ‰©å±•çš„ã€‚</p><div class="tabs" id="ca8a7413-161b-4f1e-a04b-8bf7f205b9aa"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ca8a7413-161b-4f1e-a04b-8bf7f205b9aa-1"><i class="fas fa-cat"></i>è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#ca8a7413-161b-4f1e-a04b-8bf7f205b9aa-2"><i class="fas fa-horse"></i>ä½¿ç”¨</button></li><li class="tab"><button type="button" data-href="#ca8a7413-161b-4f1e-a04b-8bf7f205b9aa-3"><i class="fas fa-dove"></i>æ ·ä¾‹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ca8a7413-161b-4f1e-a04b-8bf7f205b9aa-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">interface æ¥å£å&#123;</span><br><span class="line">ä¿®é¥°ç¬¦ <span class="keyword">default</span> è¿”å›å€¼ç±»å‹ æ–¹æ³•å&#123;</span><br><span class="line">æ–¹æ³•ä½“;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ca8a7413-161b-4f1e-a04b-8bf7f205b9aa-2"><ol><li>å®ç°ç±»ç›´æ¥è°ƒç”¨æ¥å£çš„é»˜è®¤æ–¹æ³•</li><li>å®ç°ç±»é‡å†™æ¥å£çš„é»˜è®¤æ–¹æ³•</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ca8a7413-161b-4f1e-a04b-8bf7f205b9aa-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åœ¨æ¥å£ä¸­æ–°å¢æ–¹æ³•ï¼Œæ‰€æœ‰å®ç°ç±»éƒ½è¦é‡å†™è¯¥æ–¹æ³•ï¼Œä¸åˆ©äºæ¥å£çš„æ‰©å±•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test02</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">default</span> String <span class="title function_">testDefaultMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ¥å£ä¸­çš„é»˜è®¤æ–¹æ³•æ‰§è¡Œäº†&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="é™æ€æ–¹æ³•">é™æ€æ–¹æ³•</h3><p>JDK8ä¸­ä¸ºæ¥å£æ–°å¢äº†é™æ€æ–¹æ³•ï¼Œä½œç”¨ä¹Ÿæ˜¯ä¸ºäº†æ¥å£çš„æ‰©å±•<div class="tabs" id="2bbf712d-0e57-4b42-aaec-bfc43b69f6a5"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2bbf712d-0e57-4b42-aaec-bfc43b69f6a5-1"><i class="fas fa-atom"></i>è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#2bbf712d-0e57-4b42-aaec-bfc43b69f6a5-2"><i class="far fa-sun"></i>ä½¿ç”¨</button></li><li class="tab"><button type="button" data-href="#2bbf712d-0e57-4b42-aaec-bfc43b69f6a5-3"><i class="fas fa-wind"></i>æ ·ä¾‹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2bbf712d-0e57-4b42-aaec-bfc43b69f6a5-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">interface æ¥å£å&#123;</span><br><span class="line">    ä¿®é¥°ç¬¦ <span class="keyword">static</span> è¿”å›å€¼ç±»å‹ æ–¹æ³•å&#123;</span><br><span class="line">    æ–¹æ³•ä½“;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2bbf712d-0e57-4b42-aaec-bfc43b69f6a5-2"><p>æ¥å£ä¸­çš„é™æ€æ–¹æ³•åœ¨å®ç°ç±»ä¸­æ˜¯ä¸èƒ½è¢«é‡å†™çš„ï¼Œè°ƒç”¨çš„è¯åªèƒ½é€šè¿‡æ¥å£ç±»å‹æ¥å®ç°: æ¥å£å.é™æ€æ–¹æ³•å();</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2bbf712d-0e57-4b42-aaec-bfc43b69f6a5-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TestInterA</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åœ¨æ¥å£ä¸­æ–°å¢æ–¹æ³•ï¼Œæ‰€æœ‰å®ç°ç±»éƒ½è¦é‡å†™è¯¥æ–¹æ³•ï¼Œä¸åˆ©äºæ¥å£çš„æ‰©å±•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testAbstract01</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testAbstract02</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">testStaticMethod</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;TestInterAé‡Œé¢çš„é™æ€æ–¹æ³•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">testDefaultMethod</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;TestInterAé‡Œé¢çš„é»˜è®¤æ–¹æ³•testDefaultMethod&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></p><hr><hr><h2 id="Comparatoræ¥å£">Comparatoræ¥å£</h2><h3 id="åº•å±‚åŸç†åˆ†æ">åº•å±‚åŸç†åˆ†æ</h3><p>Comparatoræ¥å£ç”¨æ¥å®šä¹‰ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´çš„æ¯”è¾ƒæ–¹æ³•ï¼Œå®ƒæœ‰ä¸€ä¸ªå«åš<code>compare</code>çš„æ–¹æ³•ï¼Œå‡½æ•°ç­¾åå¦‚ä¸‹ï¼š</p><p><code>int compare(T o1,T o2)</code></p><p>æŸ¥çœ‹sortæ–¹æ³•çš„ç›¸å…³æºç ï¼šå¦‚æœcompareçš„è¿”å›å€¼ä¸ºæ­£æ•°ï¼Œå°±äº¤æ¢è¿›è¡Œæ¯”è¾ƒçš„ä¸¤ä¸ªå…ƒç´ çš„ä½ç½®ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/cbcf171cd6bc494abfe61be71508287a.png" alt="img" style="zoom:67%;" /><p>ç»“è®º</p><ul><li>å¦‚æœ o1 &gt; o2 æ—¶compare(o1,o2)è¿”å›æ­£æ•°ï¼Œé‚£ä¹ˆäº¤æ¢ä½ç½®åå¤§çš„å…ƒç´ åœ¨åï¼Œè¿™å°±å®ç°äº†å‡åºæ’åºï¼›</li><li>å¦‚æœ o1 &lt; o2 æ—¶compare(o1,o2)è¿”å›è´Ÿæ•°ï¼Œé‚£ä¹ˆäº¤æ¢ä½ç½®åå°çš„å…ƒç´ åœ¨åï¼Œè¿™å°±å®ç°äº†é™åºæ’åºã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡åºã€‚</span></span><br><span class="line"><span class="comment">// è‹¥o1 - o2 &lt; 0ï¼Œåˆ™o1å°äºo2ï¼Œä¸ç”¨äº¤æ¢ï¼Œå³ä¸ºå‡åºã€‚</span></span><br><span class="line"><span class="comment">// è‹¥o1 - o2 &gt; 0ï¼Œåˆ™o1å¤§äºo2ï¼Œäº¤æ¢åå°çš„åœ¨å‰ï¼Œå¤§çš„åœ¨åï¼Œå³ä¸ºå‡åºã€‚</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">compare</span><span class="params">(<span class="type">int</span> o1, <span class="type">int</span> o2)</span>&#123;</span><br><span class="line">     <span class="keyword">return</span> o1 -o2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é™åºã€‚</span></span><br><span class="line"><span class="comment">// è‹¥o2 - o1 &lt; 0ï¼Œåˆ™o2å°äºo1ï¼Œä¸ç”¨äº¤æ¢ï¼Œå³é™åºã€‚</span></span><br><span class="line"><span class="comment">// è‹¥o2 - o1 &gt; 0ï¼Œåˆ™o2å¤§äºo1ï¼Œäº¤æ¢åå¤§çš„åœ¨å‰ï¼Œå°çš„åœ¨åï¼Œå³ä¸ºé™åºã€‚</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">compare</span><span class="params">(<span class="type">int</span> o1, <span class="type">int</span> o2)</span>&#123;</span><br><span class="line">     <span class="keyword">return</span> o2 -o1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¯”è¾ƒå™¨çš„ä½¿ç”¨">æ¯”è¾ƒå™¨çš„ä½¿ç”¨</h3><p>ä¸ºäº†å¯¹ä¸€ä¸ªé›†åˆè¿›è¡Œæ’åºï¼Œæˆ‘ä»¬å°†æ¯”è¾ƒå™¨(Comparator)å®ä¾‹ä¼ é€’ç»™<code>Stream.sorted</code>ã€<code>Collections.sort</code>ã€<code>List.sort</code>å’Œ<code>Arrays.sort</code>æ–¹æ³•ã€‚</p><p>æ¯”è¾ƒå™¨(Comparator)è¿˜å¯ä»¥æ§åˆ¶<code>SortedSet</code>çš„é¡ºåºå’Œ<code>SortedMap</code>æ•°æ®ç»“æ„çš„é”®é¡ºåºã€‚</p><h3 id="æ¯”è¾ƒå™¨çš„æ–¹æ³•">æ¯”è¾ƒå™¨çš„æ–¹æ³•</h3><p>åœ¨<code>Java 8</code>ä¸­ï¼Œæ¯”è¾ƒå™¨æ¥å£å¼•å…¥äº†ä¸€äº›é™æ€å’Œé»˜è®¤çš„æ–¹æ³•ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å°†æ¯”è¾ƒå™¨ä¸<code>Stream.sorted</code>ã€<code>List.sort</code>ã€<code>Collections.sort</code>å’Œ<code>Arrays.sort</code>ä¸€èµ·ä½¿ç”¨æ¥å¯¹é›†åˆå’Œ<code>Map</code>è¿›è¡Œæ’åºã€‚</p><div class="tabs" id="061c08cf-c9fe-4314-ae92-e318b541721f"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#061c08cf-c9fe-4314-ae92-e318b541721f-1"><i class="fas fa-seedling"></i>reversed</button></li><li class="tab"><button type="button" data-href="#061c08cf-c9fe-4314-ae92-e318b541721f-2"><i class="fas fa-leaf"></i>reverseOrder</button></li><li class="tab"><button type="button" data-href="#061c08cf-c9fe-4314-ae92-e318b541721f-3"><i class="fab fa-apple"></i>3</button></li><li class="tab"><button type="button" data-href="#061c08cf-c9fe-4314-ae92-e318b541721f-4"><i class="fas fa-tree"></i>4</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="061c08cf-c9fe-4314-ae92-e318b541721f-1"><p>reversedæ˜¯Javaæ¯”è¾ƒå™¨åŠŸèƒ½æ¥å£çš„é»˜è®¤æ–¹æ³•ã€‚reversedè¿”å›ä¸€ä¸ªæ¯”è¾ƒå™¨ï¼Œè¯¥æ¯”è¾ƒå™¨å¼ºåˆ¶æ‰§è¡Œåå‘æ’åºã€‚å‡½æ•°ç­¾åå¦‚ä¸‹ï¼š</p><p><code>default Comparator&lt;T&gt; reversed() </code></p><p>è¦ä½¿ç”¨<code>reversed</code>æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦å®ä¾‹åŒ–æˆ‘ä»¬çš„æ¯”è¾ƒå™¨å¹¶è°ƒç”¨è¯¥æ–¹æ³•ã€‚</p><p><code>reversed</code>å°†è¿”å›æ–°çš„æ¯”è¾ƒå™¨å®ä¾‹ï¼Œè¯¥å®ä¾‹å°†å¼ºåŠ è¯¥æ¯”è¾ƒå™¨çš„åå‘æ’åºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Comparator&lt;Student&gt; nameComparator = (s1, s2) -&gt; s1.getName().compareTo(s2.getName());</span><br><span class="line">Collections.sort(list, nameComparator.reversed()); </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="061c08cf-c9fe-4314-ae92-e318b541721f-2"><p>reverseOrderæ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œè¿”å›æ¯”è¾ƒå™¨ï¼Œå¯¹å¯¹è±¡é›†åˆè¿›è¡Œåå‘è‡ªç„¶æ’åºã€‚</p><p>å¯¹äºè‡ªç„¶æ’åºï¼Œä¸€ä¸ªç±»éœ€è¦å®ç°æ¯”è¾ƒå™¨å¹¶å®šä¹‰compareToæ–¹æ³•ã€‚</p><p>ä¸€ä¸ªå¯¹è±¡é›†åˆæ ¹æ®è‡ªç„¶æ’åºä¸­çš„compareToè¿›è¡Œæ’åºã€‚</p><p>Comparator.reverseOrderåè½¬äº†è‡ªç„¶æ’åºã€‚</p><p>å®ƒåœ¨å†…éƒ¨è°ƒç”¨Collections.reverseOrder()å¹¶è¿”å›æ¯”è¾ƒå™¨å®ä¾‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;? <span class="built_in">super</span> T&gt;&gt; Comparator&lt;T&gt; <span class="title function_">reverseOrder</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Collections.reverseOrder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="061c08cf-c9fe-4314-ae92-e318b541721f-3"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="061c08cf-c9fe-4314-ae92-e318b541721f-4"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="å¹¶è¡Œæµä¸ä¸²è¡Œæµ">å¹¶è¡Œæµä¸ä¸²è¡Œæµ</h2><ul><li>å¹¶è¡Œæµå°±æ˜¯æŠŠä¸€ä¸ªå†…å®¹åˆ†ä¸ºå¤šä¸ªæ•°æ®å—ï¼Œå¹¶ç”¨ä¸åŒçš„çº¿ç¨‹åˆ†åˆ«å¤„ç†æ¯ä¸ªæ•°æ®å—çš„æµï¼Œç›¸æ¯”è¾ƒäºä¸²è¡Œæµï¼Œå¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡</li><li>Java8ä¸­å°†å…¶è¿›è¡Œäº†ä¼˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å¯¹æ•°æ®è¿›è¡Œå¹¶è¡Œæ“ä½œã€‚</li><li>Stream API å¯ä»¥å£°æ˜æ€§åœ°é€šè¿‡parallel()å’Œsequential()åœ¨å¹¶è¡Œæµä¸é¡ºåºæµä¹‹é—´è¿›è¡Œåˆ‡æ¢</li></ul><hr><hr><h2 id="Lambdaè¡¨è¾¾å¼">Lambdaè¡¨è¾¾å¼</h2><ul><li>Lambdaæ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠLambdaè¡¨è¾¾å¼ç†è§£ä¸ºæ˜¯ä¸€æ®µå¯ä»¥ä¼ é€’çš„ä»£ç ï¼ˆå°†ä»£ç åƒæ•°æ®ä¸€æ ·è¿›è¡Œä¼ é€’ï¼‰ã€‚</li><li>ä½¿ç”¨å®ƒå¯ä»¥å†™å‡ºæ›´ç®€æ´ã€æ›´çµæ´»çš„ä»£ç ã€‚ä½œä¸ºä¸€ç§æ›´ç´§å‡‘çš„ä»£ç é£æ ¼ï¼Œæ˜¯Javaçš„è¯­è¨€è¡¨è¾¾èƒ½åŠ›å¾—åˆ°äº†æå‡</li></ul><blockquote><span class='p red'>lambdaè¡¨è¾¾å¼ä½¿ç”¨å‰æ</span></blockquote><p>å¿…é¡»æœ‰æ¥å£,æ¥å£ä¸­æœ‰ä¸”åªèƒ½æœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•(å‡½æ•°å¼æ¥å£)</p><p>Lambdaè¡¨è¾¾å¼æ˜¯å¯æ¨å¯¼å¯ä»¥çœç•¥çš„ï¼ŒLambdaè¡¨è¾¾å¼å¯ä»¥æ¨å¯¼å‡ºæ¥ï¼Œçœç•¥å°±æ˜¯é‡å†™å”¯ä¸€çš„æŠ½è±¡æ–¹æ³•è¿›è€Œå¯ä»¥è¿›ä¸€æ­¥å¯¹å‚æ•°å’Œè¿”å›å€¼è¿›è¡Œç®€åŒ–</p><ol><li><p>ä¸¾ä¾‹ï¼š (o1,o2) -&gt; Integer.compare(o1,o2);</p></li><li><p>æ ¼å¼ï¼š</p><ul><li><code>-&gt;ï¼š</code>lambdaæ“ä½œç¬¦æˆ–ç®­å¤´æ“ä½œç¬¦</li><li><code>-&gt;å·¦è¾¹ï¼š</code>lambdaå½¢å‚åˆ—è¡¨ï¼ˆå…¶å®å°±æ˜¯æ¥å£ä¸­çš„æŠ½è±¡æ–¹æ³•çš„å½¢å‚åˆ—è¡¨ï¼‰</li><li><code>-&gt;å³è¾¹ï¼š</code>lambdaä½“ï¼ˆå…¶å®å°±æ˜¯é‡å†™çš„æŠ½è±¡æ–¹æ³•çš„æ–¹æ³•ä½“ï¼‰</li></ul></li><li><p>Lambdaè¡¨è¾¾å¼çš„ä½¿ç”¨ï¼š</p><ul><li><p>Lambdaå½¢å‚åˆ—è¡¨çš„å‚æ•°ç±»å‹å¯ä»¥çœç•¥</p></li><li><p>å¦‚æœLambdaå½¢å‚åˆ—è¡¨åªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œå…¶ä¸€å¯¹()ä¹Ÿå¯ä»¥çœç•¥</p></li><li><p>Lambdaä½“åº”è¯¥ä½¿ç”¨ä¸€å¯¹{}åŒ…è£¹</p></li><li><p>å¦‚æœLambdaä½“åªæœ‰ä¸€æ¡æ‰§è¡Œè¯­å¥(å¯èƒ½æ˜¯returnè¯­å¥),å¯ä»¥çœç•¥è¿™ä¸€å¯¹{}å’Œreturnå…³é”®å­—</p></li></ul></li></ol><p>åˆ†ä¸º6ç§æƒ…å†µä»‹ç»</p><div class="tabs" id="a8a76b8b-df65-4a0a-a2c4-660e9341c1fe"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#a8a76b8b-df65-4a0a-a2c4-660e9341c1fe-1"><i class="fas fa-bug"></i>æ ¼å¼ä¸€</button></li><li class="tab"><button type="button" data-href="#a8a76b8b-df65-4a0a-a2c4-660e9341c1fe-2"><i class="fas fa-cannabis"></i>æ ¼å¼äºŒ</button></li><li class="tab"><button type="button" data-href="#a8a76b8b-df65-4a0a-a2c4-660e9341c1fe-3"><i class="fas fa-candy-cane"></i>æ ¼å¼ä¸‰</button></li><li class="tab"><button type="button" data-href="#a8a76b8b-df65-4a0a-a2c4-660e9341c1fe-4"><i class="fas fa-child"></i>æ ¼å¼å››</button></li><li class="tab"><button type="button" data-href="#a8a76b8b-df65-4a0a-a2c4-660e9341c1fe-5"><i class="fas fa-heartbeat"></i>æ ¼å¼äº”</button></li><li class="tab"><button type="button" data-href="#a8a76b8b-df65-4a0a-a2c4-660e9341c1fe-6"><i class="fas fa-cookie-bite"></i>æ ¼å¼å…­</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="a8a76b8b-df65-4a0a-a2c4-660e9341c1fe-1"><p><code>è¯­æ³•æ ¼å¼ä¸€ï¼š</code>æ— å‚æ— è¿”å›å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//1. ä»¥å‰çš„å†™æ³•</span></span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">runnable01</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ä½  çš„ åŸ å¸‚ å¥½ åƒ ä¸ æ¬¢ è¿ æˆ‘&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    runnable01.run();</span><br><span class="line">    System.out.println(<span class="string">&quot;-------------------------&quot;</span>);</span><br><span class="line">    <span class="comment">//2. Lambdaè¡¨è¾¾å¼</span></span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">runnable02</span> <span class="operator">=</span> () -&gt; System.out.println(<span class="string">&quot;æ‰€ ä»¥ æˆ‘ åª å¥½ è½¬ èº« ç¦» å¼€ äº†&quot;</span>);</span><br><span class="line">    runnable02.run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a8a76b8b-df65-4a0a-a2c4-660e9341c1fe-2"><p><code>è¯­æ³•æ ¼å¼äºŒï¼š</code>Lambdaéœ€è¦ä¸€ä¸ªå‚æ•°ï¼Œä½†æ˜¯æ²¡æœ‰è¿”å›å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test03</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//1. ä»¥å‰çš„å†™æ³•</span></span><br><span class="line">    Consumer&lt;String&gt; consumer01 = <span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(String s)</span> &#123;</span><br><span class="line">            System.out.println(s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    consumer01.accept(<span class="string">&quot;å…¶å®æˆ‘å­˜è¿‡ä½ ç…§ç‰‡ ä¹Ÿç ”ç©¶è¿‡ä½ çš„æ˜Ÿåº§&quot;</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;-------------------------&quot;</span>);</span><br><span class="line">    <span class="comment">//2. Lambdaè¡¨è¾¾å¼</span></span><br><span class="line">    Consumer&lt;String&gt; consumer02 = (String s) -&gt; &#123;System.out.println(s);&#125;;</span><br><span class="line">    consumer02.accept(<span class="string">&quot;ä½ å–œæ¬¢çš„æ­Œæˆ‘ä¹Ÿä¼šå»å¬ ä½ å–œæ¬¢çš„äº‹ç‰©æˆ‘ä¹Ÿä¼šæƒ³å»äº†è§£&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a8a76b8b-df65-4a0a-a2c4-660e9341c1fe-3"><p><code>è¯­æ³•æ ¼å¼ä¸‰ï¼š</code>æ•°æ®ç±»å‹å¯ä»¥çœç•¥ï¼Œå› ä¸ºå¯ç”±<code>ç±»å‹æ¨æ–­</code>å¾—å‡º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test04</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//1. ä»¥å‰çš„å†™æ³•</span></span><br><span class="line">    Consumer&lt;String&gt; consumer01 = <span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(String s)</span> &#123;</span><br><span class="line">            System.out.println(s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    consumer01.accept(<span class="string">&quot;æˆ‘è¿œæ¯”è¡¨é¢ä¸Šæ›´å–œæ¬¢ä½ &quot;</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;-------------------------&quot;</span>);</span><br><span class="line">    <span class="comment">//2. Lambdaè¡¨è¾¾å¼</span></span><br><span class="line">    Consumer&lt;String&gt; consumer02 = (s) -&gt; &#123;System.out.println(s);&#125;;</span><br><span class="line">    consumer02.accept(<span class="string">&quot;ä½†æˆ‘æ²¡æœ‰è¯´&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a8a76b8b-df65-4a0a-a2c4-660e9341c1fe-4"><p><code>è¯­æ³•æ ¼å¼å››ï¼š</code>Lambdaè‹¥åªéœ€è¦ä¸€ä¸ªå‚æ•°ï¼Œå‚æ•°çš„å°æ‹¬å·å¯ä»¥çœç•¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test04</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//1. ä»¥å‰çš„å†™æ³•</span></span><br><span class="line">    Consumer&lt;String&gt; consumer01 = <span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(String s)</span> &#123;</span><br><span class="line">            System.out.println(s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    consumer01.accept(<span class="string">&quot;æˆ‘è¿œæ¯”è¡¨é¢ä¸Šæ›´å–œæ¬¢ä½ &quot;</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;-------------------------&quot;</span>);</span><br><span class="line">    <span class="comment">//2. Lambdaè¡¨è¾¾å¼</span></span><br><span class="line">    Consumer&lt;String&gt; consumer02 = s -&gt; &#123;System.out.println(s);&#125;;</span><br><span class="line">    consumer02.accept(<span class="string">&quot;ä½†æˆ‘æ²¡æœ‰è¯´&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a8a76b8b-df65-4a0a-a2c4-660e9341c1fe-5"><p><code>è¯­æ³•æ ¼å¼äº”ï¼š</code>Lambdaéœ€è¦ä¸¤ä¸ªæˆ–ä»¥ä¸Šå‚æ•°ï¼Œå¤šæ¡æ‰§è¡Œè¯­å¥ï¼Œå¹¶ä¸”æœ‰è¿”å›å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test02</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1. ä»¥å‰çš„å†™æ³•</span></span><br><span class="line">    Comparator&lt;Integer&gt; comparator01 = <span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;Integer&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(Integer o1, Integer o2)</span> &#123;</span><br><span class="line">            System.out.println(o1);</span><br><span class="line">            System.out.println(o2);</span><br><span class="line">            <span class="keyword">return</span> o1.compareTo(o2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    System.out.println(comparator01.compare(<span class="number">95</span>, <span class="number">27</span>));</span><br><span class="line">    System.out.println(<span class="string">&quot;-------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. Lambdaè¡¨è¾¾å¼</span></span><br><span class="line">    Comparator&lt;Integer&gt; comparator02 = (o1, o2) -&gt; &#123;</span><br><span class="line">        System.out.println(o1);</span><br><span class="line">        System.out.println(o2);</span><br><span class="line">        <span class="keyword">return</span> o1.compareTo(o2);</span><br><span class="line">    &#125;;</span><br><span class="line">    System.out.println(comparator02.compare(<span class="number">12</span>, <span class="number">21</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a8a76b8b-df65-4a0a-a2c4-660e9341c1fe-6"><p><code>è¯­æ³•æ ¼å¼å…­ï¼š</code>å½“Lambdaä½“åªæœ‰ä¸€æ¡è¯­å¥æ—¶ï¼Œreturnä¸{}è‹¥æœ‰ï¼Œåˆ™éƒ½å¯ä»¥çœç•¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test02</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1. ä»¥å‰çš„å†™æ³•</span></span><br><span class="line">    Comparator&lt;Integer&gt; comparator01 = <span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;Integer&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(Integer o1, Integer o2)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> o1.compareTo(o2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    System.out.println(comparator01.compare(<span class="number">95</span>, <span class="number">27</span>));</span><br><span class="line">    System.out.println(<span class="string">&quot;-------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. Lambdaè¡¨è¾¾å¼</span></span><br><span class="line">    Comparator&lt;Integer&gt; comparator02 = (o1, o2) -&gt; o1.compareTo(o2);</span><br><span class="line">    System.out.println(comparator02.compare(<span class="number">12</span>, <span class="number">21</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="å‡½æ•°å¼æ¥å£">å‡½æ•°å¼æ¥å£</h2><ul><li>Lambdaè¡¨è¾¾å¼çš„æœ¬è´¨ï¼šä½œä¸ºå‡½æ•°å¼æ¥å£çš„å®ä¾‹</li><li>å¦‚æœåœ¨ä¸€ä¸ªæ¥å£ä¸­ï¼Œåªå£°æ˜äº†ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œåˆ™æ­¤æ¥å£å°±è¢«ç§°ä¸ºå‡½æ•°å¼æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªæ¥å£ä¸Šä½¿ç”¨@FunctionalInterfaceæ³¨è§£æ¥éªŒè¯è¯¥æ¥å£æ˜¯å¦ä¸ºå‡½æ•°å¼æ¥å£ï¼ˆå¦‚æœä½ åœ¨è¯¥æ¥å£ä¸­å†™äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ™ç¼–è¯‘æœŸå°±ä¼šæŠ¥é”™ï¼‰</li><li>æ­£æ˜¯å› ä¸ºæŠ½è±¡æ–¹æ³•ä¸­åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰å¯ä»¥çœç•¥@Overrideå‡½æ•°å£°æ˜ç­‰å†…å®¹</li><li>åœ¨<code>java.util.function</code>åŒ…ä¸‹å®šä¹‰äº†Java 8 çš„ä¸°å¯Œçš„å‡½æ•°å¼æ¥å£</li><li>Javaä»è¯ç”Ÿæ—¥èµ·å°±æ˜¯ä¸€ç›´å€¡å¯¼â€œä¸€åˆ‡çš†å¯¹è±¡â€ï¼Œåœ¨Javaé‡Œé¢é¢å‘å¯¹è±¡(OOP)ç¼–ç¨‹æ˜¯ä¸€åˆ‡ã€‚ä½†æ˜¯éšç€Pythonã€Scalaç­‰è¯­è¨€çš„å…´èµ·å’Œæ–°æŠ€æœ¯çš„æŒ‘æˆ˜ï¼ŒJavaä¸å¾—ä¸åšå‡ºè°ƒæ•´ä»¥ä¾¿æ”¯æŒæ›´åŠ å¹¿æ³›çš„æŠ€æœ¯è¦æ±‚ï¼Œä¹Ÿå³javaä¸ä½†å¯ä»¥æ”¯æŒOOPè¿˜å¯ä»¥æ”¯æŒOOFï¼ˆé¢å‘å‡½æ•°ç¼–ç¨‹ï¼‰</li><li>åœ¨å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€å½“ä¸­ï¼Œå‡½æ•°è¢«å½“åšä¸€ç­‰å…¬æ°‘å¯¹å¾…ã€‚åœ¨å°†å‡½æ•°ä½œä¸ºä¸€ç­‰å…¬æ°‘çš„ç¼–ç¨‹è¯­è¨€ä¸­ï¼ŒLambdaè¡¨è¾¾å¼çš„ç±»å‹æ˜¯å‡½æ•°ã€‚ä½†æ˜¯åœ¨Java8ä¸­ï¼Œæœ‰æ‰€ä¸åŒã€‚åœ¨Java8ä¸­ï¼ŒLambdaè¡¨è¾¾å¼æ˜¯å¯¹è±¡ï¼Œè€Œä¸æ˜¯å‡½æ•°ï¼Œå®ƒä»¬å¿…é¡»ä¾é™„äºä¸€ç±»ç‰¹åˆ«çš„å¯¹è±¡ç±»å‹â€”â€”å‡½æ•°å¼æ¥å£ã€‚</li><li>ç®€å•çš„è¯´ï¼Œåœ¨Java8ä¸­ï¼ŒLambdaè¡¨è¾¾å¼å°±æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£çš„å®ä¾‹ã€‚è¿™å°±æ˜¯Lambdaè¡¨è¾¾å¼å’Œå‡½æ•°å¼æ¥å£çš„å…³ç³»ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦ä¸€ä¸ªå¯¹è±¡æ˜¯å‡½æ•°å¼æ¥å£çš„å®ä¾‹ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å°±å¯ä»¥ç”¨Lambdaè¡¨è¾¾å¼æ¥è¡¨ç¤ºã€‚</li><li>æ‰€ä»¥ä»¥å‰ç”¨åŒ¿åå®ç°ç±»è¡¨ç¤ºçš„ç°åœ¨éƒ½å¯ä»¥ç”¨Lambdaè¡¨è¾¾å¼æ¥å†™ã€‚</li></ul><blockquote><p>Javaå†…ç½®çš„å‡½æ•°å¼æ¥å£ä»‹ç»åŠä½¿ç”¨ä¸¾ä¾‹</p></blockquote><table><thead><tr><th style="text-align:center">å‡½æ•°å¼æ¥å£</th><th style="text-align:center">æ–¹æ³•</th><th style="text-align:center">ç”¨é€”</th></tr></thead><tbody><tr><td style="text-align:center">Consumer æ¶ˆè´¹å‹æ¥å£</td><td style="text-align:center">void accept(T t)</td><td style="text-align:center">å¯¹ç±»å‹ä¸ºTçš„å¯¹è±¡åº”ç”¨æ“ä½œ</td></tr><tr><td style="text-align:center">Supplier ä¾›ç»™å‹æ¥å£</td><td style="text-align:center">T get()</td><td style="text-align:center">è¿”å›ç±»å‹ä¸ºTçš„å¯¹è±¡</td></tr><tr><td style="text-align:center">Function å‡½æ•°å‹æ¥å£</td><td style="text-align:center">R apply(T t)</td><td style="text-align:center">å¯¹ç±»å‹ä¸ºTçš„å¯¹è±¡åº”ç”¨æ“ä½œè¿”å›ç»“æœ</td></tr><tr><td style="text-align:center">Predicate æ–­å®šå‹æ¥å£</td><td style="text-align:center">boolean test(T t)</td><td style="text-align:center">ç¡®å®šç±»å‹ä¸ºTçš„å¯¹è±¡æ˜¯å¦æ»¡è¶³æŸçº¦æŸ</td></tr><tr><td style="text-align:center">BiConsumer</td><td style="text-align:center">void accept(T t,U u)</td><td style="text-align:center">å¯¹ç±»å‹ä¸ºT,Uå‚æ•°åº”ç”¨æ“ä½œ</td></tr><tr><td style="text-align:center">BiPredicate</td><td style="text-align:center">boolean</td><td style="text-align:center">åŒ…å«æ–¹æ³•ä¸ºï¼šboolean test(T t,U u)</td></tr><tr><td style="text-align:center">BiFunction</td><td style="text-align:center">R apply(T t,U u)</td><td style="text-align:center">å¯¹ç±»å‹ä¸ºT,Uå‚æ•°åº”ç”¨æ“ä½œï¼Œè¿”å›Rç±»å‹çš„ç»“æœ</td></tr><tr><td style="text-align:center">UnaryOperator(Functionå­æ¥å£)</td><td style="text-align:center">T apply(T t)</td><td style="text-align:center">å¯¹ç±»å‹ä¸ºTçš„å¯¹è±¡è¿›è¡Œä¸€å…ƒè¿ç®—</td></tr><tr><td style="text-align:center">BinaryOperator(BiFunctionå­æ¥å£)</td><td style="text-align:center">T apply(T t1,T t2)</td><td style="text-align:center">å¯¹ç±»å‹ä¸ºTçš„å¯¹è±¡è¿›è¡ŒäºŒå…ƒè¿ç®—</td></tr></tbody></table><div class="tabs" id="10d20ccf-24f3-4841-8532-22635d831135"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#10d20ccf-24f3-4841-8532-22635d831135-1"><i class="fas fa-cat"></i>æ¶ˆè´¹å‹</button></li><li class="tab"><button type="button" data-href="#10d20ccf-24f3-4841-8532-22635d831135-2"><i class="fas fa-horse"></i>æ–­å®šå‹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="10d20ccf-24f3-4841-8532-22635d831135-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">happyTime</span><span class="params">(<span class="type">double</span> money, Consumer&lt;Double&gt; consumer)</span> &#123;</span><br><span class="line">    consumer.accept(money);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test04</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1. ä»¥å‰çš„å†™æ³•</span></span><br><span class="line">    happyTime(<span class="number">1241</span>, <span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;Double&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(Double money)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;çªç„¶æƒ³å›ä¸€è¶Ÿæˆéƒ½äº†ï¼Œæœºç¥¨èŠ±è´¹&quot;</span> + money);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. Lambdaè¡¨è¾¾å¼ï¼Œå°†ä¹‹å‰çš„6è¡Œä»£ç å‹ç¼©åˆ°äº†1è¡Œ</span></span><br><span class="line">    happyTime(<span class="number">648</span>, money -&gt; System.out.println(<span class="string">&quot;å­¦ä¹ å¤ªç´¯äº†ï¼Œå¥–åŠ±è‡ªå·±ä¸€å‘648ï¼ŒèŠ±è´¹&quot;</span> + money));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">çªç„¶æƒ³å›ä¸€è¶Ÿæˆéƒ½äº†ï¼Œæœºç¥¨èŠ±è´¹1241.0</span></span><br><span class="line"><span class="comment">------------------------</span></span><br><span class="line"><span class="comment">å­¦ä¹ å¤ªç´¯äº†ï¼Œå¥–åŠ±è‡ªå·±ä¸€å‘648ï¼ŒèŠ±è´¹648.0</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="10d20ccf-24f3-4841-8532-22635d831135-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ ¹æ®ç»™å®šçš„è§„åˆ™ï¼Œè¿‡æ»¤é›†åˆä¸­çš„å­—ç¬¦ä¸²ã€‚æ­¤è§„åˆ™ç”±Predicateçš„æ–¹æ³•å†³å®š</span></span><br><span class="line"><span class="keyword">public</span> List&lt;String&gt; <span class="title function_">filterString</span><span class="params">(List&lt;String&gt; strings, Predicate&lt;String&gt; predicate)</span> &#123;</span><br><span class="line">    ArrayList&lt;String&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String string : strings) &#123;</span><br><span class="line">        <span class="keyword">if</span> (predicate.test(string))</span><br><span class="line">            res.add(string);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test05</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;String&gt; strings = Arrays.asList(<span class="string">&quot;ä¸œäº¬&quot;</span>, <span class="string">&quot;è¥¿äº¬&quot;</span>, <span class="string">&quot;å—äº¬&quot;</span>, <span class="string">&quot;åŒ—äº¬&quot;</span>, <span class="string">&quot;å¤©æ´¥&quot;</span>, <span class="string">&quot;ä¸­äº¬&quot;</span>);</span><br><span class="line">    <span class="comment">//1. ä»¥å‰çš„å†™æ³•</span></span><br><span class="line">    List&lt;String&gt; list = filterString(string s, <span class="keyword">new</span> <span class="title class_">Predicate</span>&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">test</span><span class="params">(String s)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> s.contains(<span class="string">&quot;äº¬&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    System.out.println(list);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. ç°åœ¨çš„å†™æ³•ï¼Œç›¸æ¯”è¾ƒä¹‹å‰çš„ä»£ç ä¼˜é›…äº†è®¸å¤š</span></span><br><span class="line">    List&lt;String&gt; res = filterString(string s, s -&gt; s.contains(<span class="string">&quot;äº¬&quot;</span>));</span><br><span class="line">    System.out.println(res);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">[ä¸œäº¬, è¥¿äº¬, å—äº¬, åŒ—äº¬, ä¸­äº¬]</span></span><br><span class="line"><span class="comment">------------------------</span></span><br><span class="line"><span class="comment">[ä¸œäº¬, è¥¿äº¬, å—äº¬, åŒ—äº¬, ä¸­äº¬]</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="æ–¹æ³•å¼•ç”¨å’Œæ„é€ å™¨å¼•ç”¨">æ–¹æ³•å¼•ç”¨å’Œæ„é€ å™¨å¼•ç”¨</h2><ul><li>å½“è¦ä¼ é€’ç»™Lambdaä½“çš„æ“ä½œï¼Œå·²ç»æœ‰å®ç°çš„æ–¹æ³•äº†ï¼Œå¯ä»¥ä½¿ç”¨æ–¹æ³•å¼•ç”¨</li><li>æ–¹æ³•å¼•ç”¨å¯ä»¥çœ‹åšä¼šLambdaè¡¨è¾¾å¼çš„æ·±å±‚æ¬¡è¡¨è¾¾ï¼Œæ¢å¥è¯è¯´ï¼Œæ–¹æ³•å¼•ç”¨å°±æ˜¯Lambdaè¡¨è¾¾å¼ï¼Œä¹Ÿå°±æ˜¯å‡½æ•°å¼æ¥å£çš„ä¸€ä¸ªå®ä¾‹ï¼Œé€šè¿‡æ–¹æ³•çš„åå­—æ¥æŒ‡å‘ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯Lambdaè¡¨è¾¾å¼çš„ä¸€ä¸ªè¯­æ³•ç³–</li><li>è¦æ±‚ï¼šå®ç°æ¥å£çš„æŠ½è±¡æ–¹æ³•çš„å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼ç±»å‹ï¼Œå¿…é¡»ä¸æ–¹æ³•å¼•ç”¨çš„æ–¹æ³•çš„å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼ç±»å‹ä¿æŒä¸€è‡´</li><li>æ ¼å¼ï¼šä½¿ç”¨æ“ä½œç¬¦<code>::</code>å°†ç±»æˆ–å¯¹è±¡ä¸æ–¹æ³•ååˆ†å‰²å¼€æ¥</li><li>æœ‰å¦‚ä¸‹ä¸‰ç§ä½¿ç”¨æƒ…å†µ<ol><li>å¯¹è±¡::å®ä¾‹æ–¹æ³•å</li><li>ç±»::é™æ€æ–¹æ³•å</li><li>ç±»::å®ä¾‹æ–¹æ³•å</li></ol></li></ul><hr><h3 id="æ–¹æ³•å¼•ç”¨">æ–¹æ³•å¼•ç”¨</h3><p>æ–¹æ³•å¼•ç”¨çš„ä½¿ç”¨</p><ol><li>ä½¿ç”¨æƒ…å¢ƒï¼šå½“è¦ä¼ é€’ç»™Lambdaä½“çš„æ“ä½œï¼Œå·²ç»æœ‰å®ç°çš„æ–¹æ³•äº†ï¼Œå¯ä»¥ä½¿ç”¨æ–¹æ³•å¼•ç”¨ï¼</li><li>æ–¹æ³•å¼•ç”¨ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯Lambdaè¡¨è¾¾å¼ï¼Œè€ŒLambdaè¡¨è¾¾å¼ä½œä¸ºå‡½æ•°å¼æ¥å£çš„å®ä¾‹ã€‚æ‰€ä»¥æ–¹æ³•å¼•ç”¨ï¼Œä¹Ÿæ˜¯å‡½æ•°å¼æ¥å£çš„å®ä¾‹ã€‚</li><li>ä½¿ç”¨æ ¼å¼ï¼š ç±»(æˆ–å¯¹è±¡) :: æ–¹æ³•å</li><li>å…·ä½“åˆ†ä¸ºå¦‚ä¸‹çš„ä¸‰ç§æƒ…å†µï¼š<ul><li>æƒ…å†µ1ï¼šå¯¹è±¡ :: éé™æ€æ–¹æ³•</li><li>æƒ…å†µ2ï¼šç±» :: é™æ€æ–¹æ³•</li><li>æƒ…å†µ3ï¼šç±» :: éé™æ€æ–¹æ³•</li></ul></li><li>æ–¹æ³•å¼•ç”¨ä½¿ç”¨çš„è¦æ±‚ï¼šè¦æ±‚æ¥å£ä¸­çš„æŠ½è±¡æ–¹æ³•çš„å½¢å‚åˆ—è¡¨å’Œè¿”å›å€¼ç±»å‹ä¸æ–¹æ³•å¼•ç”¨çš„æ–¹æ³•çš„å½¢å‚åˆ—è¡¨å’Œè¿”å›å€¼ç±»å‹ç›¸åŒï¼ï¼ˆé’ˆå¯¹äºæƒ…å†µ1å’Œæƒ…å†µ2ï¼‰</li></ol><div class="tabs" id="5a1398c5-f32b-470b-81f3-16840cd41579"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#5a1398c5-f32b-470b-81f3-16840cd41579-1"><i class="far fa-sun"></i>å¯¹è±¡::éé™æ€æ–¹æ³•</button></li><li class="tab"><button type="button" data-href="#5a1398c5-f32b-470b-81f3-16840cd41579-2"><i class="fas fa-wind"></i>ç±»::é™æ€æ–¹æ³•</button></li><li class="tab"><button type="button" data-href="#5a1398c5-f32b-470b-81f3-16840cd41579-3"><i class="fas fa-fire-alt"></i>ç±»::å®ä¾‹æ–¹æ³•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="5a1398c5-f32b-470b-81f3-16840cd41579-1"><p>æŠ½è±¡æ–¹æ³•çš„<code>å½¢å‚åˆ—è¡¨</code>å’Œ<code>è¿”å›å€¼ç±»å‹</code>ä¸<code>æ–¹æ³•å¼•ç”¨</code>çš„æ–¹æ³•çš„<code>å½¢å‚åˆ—è¡¨</code>å’Œè¿”å›å€¼ç±»å‹ç›¸åŒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Consumerä¸­çš„void accept(T t)</span></span><br><span class="line"><span class="comment">//PrintStreamä¸­çš„void println(T t)</span></span><br><span class="line"><span class="comment">//å½¢å‚åˆ—è¡¨å‡ä¸º(T t)ï¼Œè¿”å›å€¼å‡ä¸ºvoidï¼Œå¯ä»¥ä½¿ç”¨æ–¹æ³•å¼•ç”¨</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test06</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1. Lambda</span></span><br><span class="line">    Consumer&lt;String&gt; consumer01 = s -&gt; System.out.println(s);</span><br><span class="line">    consumer01.accept(<span class="string">&quot;å¥¹çš„æ‰‹åªæœ‰æˆ‘çš„æ‰‹å››åˆ†ä¹‹ä¸‰é‚£éº¼å¤§&quot;</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;-----------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. æ–¹æ³•å¼•ç”¨</span></span><br><span class="line">    <span class="type">PrintStream</span> <span class="variable">printStream</span> <span class="operator">=</span> System.out;</span><br><span class="line">    Consumer&lt;String&gt; consumer02 = printStream::println;</span><br><span class="line">    consumer02.accept(<span class="string">&quot;å¯æˆ‘é‚„æ˜¯æ²’èƒ½æŠ“ä½&quot;</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;-----------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. ä½†è²Œä¼¼ä¹Ÿå¯ä»¥è¿™ä¹ˆå†™</span></span><br><span class="line">    Consumer&lt;String&gt; consumer03 = System.out::println;</span><br><span class="line">    consumer03.accept(<span class="string">&quot;èŠ±è½ä¸‹çš„æ—¶å€™æ²¡æ­» é£æ¡èµ·èŠ± åˆä¸¢ä¸‹ èŠ±æ‰æ­»äº†&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">å¥¹çš„æ‰‹åªæœ‰æˆ‘çš„æ‰‹å››åˆ†ä¹‹ä¸‰é‚£éº¼å¤§</span></span><br><span class="line"><span class="comment">-----------------------------</span></span><br><span class="line"><span class="comment">å¯æˆ‘é‚„æ˜¯æ²’èƒ½æŠ“ä½</span></span><br><span class="line"><span class="comment">-----------------------------</span></span><br><span class="line"><span class="comment">èŠ±è½ä¸‹çš„æ—¶å€™æ²¡æ­» é£æ¡èµ·èŠ± åˆä¸¢ä¸‹ èŠ±æ‰æ­»äº†</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5a1398c5-f32b-470b-81f3-16840cd41579-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Comparatorä¸­çš„int compare(T t1,T t2)</span></span><br><span class="line"><span class="comment">//Integerä¸­çš„int compare(T t1,T t2)</span></span><br><span class="line"><span class="comment">//å½¢å‚åˆ—è¡¨å‡ä¸º(T t1,T t2)ï¼Œè¿”å›å€¼å‡ä¸ºintï¼Œå¯ä»¥ä½¿ç”¨æ–¹æ³•å¼•ç”¨</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test07</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1. Lambda</span></span><br><span class="line">    Comparator&lt;Integer&gt; comparator01 = (o1, o2) -&gt; Integer.compare(o1, o2);</span><br><span class="line">    System.out.println(comparator01.compare(<span class="number">20</span>, <span class="number">77</span>));</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;----------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. æ–¹æ³•å¼•ç”¨</span></span><br><span class="line">    Comparator&lt;Integer&gt; comparator02 = Integer::compare;</span><br><span class="line">    System.out.println(comparator02.compare(<span class="number">94</span>, <span class="number">21</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">-1</span></span><br><span class="line"><span class="comment">----------------------------</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Functionä¸­çš„R apply(T t)</span></span><br><span class="line"><span class="comment">//Mathä¸­çš„Long round(Double d)</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼å’Œå‚æ•°åˆ—è¡¨ä¸ºæ³›å‹ï¼Œä¹Ÿå¯ä»¥åŒ¹é…ä¸Šï¼Œå¯ä»¥ä½¿ç”¨æ–¹æ³•å¼•ç”¨</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test08</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//1. Lambda</span></span><br><span class="line">    Function&lt;Double,Long&gt; function01 = aDouble -&gt; Math.round(aDouble);</span><br><span class="line">    System.out.println(function01.apply(<span class="number">3.141</span>));</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;------------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. æ–¹æ³•å¼•ç”¨</span></span><br><span class="line">    Function&lt;Double,Long&gt; function02 = Math::round;</span><br><span class="line">    System.out.println(function02.apply(<span class="number">2.717</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment">------------------------------</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5a1398c5-f32b-470b-81f3-16840cd41579-3"><p>ä¸€ä¸ªå‚æ•°ä½œä¸ºè°ƒç”¨è€…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Comparatorä¸­çš„int comapre(T t1,T t2)</span></span><br><span class="line"><span class="comment">// Stringä¸­çš„int t1.compareTo(t2)</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test09</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1. Lambda</span></span><br><span class="line">    Comparator&lt;Integer&gt; comparator01 = (o1, o2) -&gt; o1.compareTo(o2);</span><br><span class="line">    System.out.println(comparator01.compare(<span class="number">94</span>, <span class="number">21</span>));</span><br><span class="line">    </span><br><span class="line">    System.out.println(<span class="string">&quot;---------------------------&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//2. æ–¹æ³•å¼•ç”¨</span></span><br><span class="line">    Comparator&lt;Integer&gt; comparator02 = Integer::compareTo;</span><br><span class="line">    System.out.println(comparator02.compare(<span class="number">43</span>, <span class="number">96</span>));</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">---------------------------</span></span><br><span class="line"><span class="comment">-1</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//BiPredicateä¸­çš„boolean test(T t1, T t2);</span></span><br><span class="line"><span class="comment">//Stringä¸­çš„boolean t1.equals(t2)</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test10</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//1. Lambda</span></span><br><span class="line">    BiPredicate&lt;String,String&gt; biPredicate01 = (o1, o2) -&gt; o1.equals(o2);</span><br><span class="line">    System.out.println(biPredicate01.test(<span class="string">&quot;Kyle&quot;</span>, <span class="string">&quot;Kyle&quot;</span>));</span><br><span class="line">    System.out.println(<span class="string">&quot;----------------------------------&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//2. æ–¹æ³•å¼•ç”¨</span></span><br><span class="line">    BiPredicate&lt;String,String&gt; biPredicate02 = String::equals;</span><br><span class="line">    System.out.println(biPredicate02.test(<span class="string">&quot;Violet&quot;</span>, <span class="string">&quot;Violet&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">true</span></span><br><span class="line"><span class="comment">----------------------------------</span></span><br><span class="line"><span class="comment">true</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Functionä¸­çš„R apply(T t)</span></span><br><span class="line"><span class="comment">// Employeeä¸­çš„String toString();</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test11</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">Stu</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Stu</span>(<span class="string">&quot;Kyle&quot;</span>, <span class="number">9527</span>);</span><br><span class="line">    <span class="comment">//1. Lambda</span></span><br><span class="line">    Function&lt;Stu,String&gt; function01 = stu -&gt; stu.toString();</span><br><span class="line">    System.out.println(function01.apply(student));</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;------------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. æ–¹æ³•å¼•ç”¨</span></span><br><span class="line">    Function&lt;Stu,String&gt; function02 = Stu::toString;</span><br><span class="line">    System.out.println(function02.apply(student));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Stu&#123;name=&#x27;Kyle&#x27;, id=9527&#125;</span></span><br><span class="line"><span class="comment">------------------------------</span></span><br><span class="line"><span class="comment">Stu&#123;name=&#x27;Kyle&#x27;, id=9527&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="æ„é€ å™¨å¼•ç”¨å’Œæ•°ç»„å¼•ç”¨">æ„é€ å™¨å¼•ç”¨å’Œæ•°ç»„å¼•ç”¨</h3><ul><li>ä¸å‡½æ•°å¼æ¥å£ç›¸ç»“åˆï¼Œè‡ªåŠ¨ä¸å‡½æ•°å¼æ¥å£ä¸­æ–¹æ³•å…¼å®¹ã€‚</li><li>å¯ä»¥æŠŠæ„é€ å™¨å¼•ç”¨èµ‹å€¼ç»™å®šä¹‰çš„æ–¹æ³•ï¼Œè¦æ±‚æ„é€ å™¨å‚æ•°åˆ—è¡¨è¦ä¸æ¥å£ä¸­æŠ½è±¡æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ä¸€è‡´ï¼ä¸”æ–¹æ³•çš„è¿”å›å€¼å³ä¸ºæ„é€ å™¨å¯¹åº”ç±»çš„å¯¹è±¡ã€‚</li></ul><div class="tabs" id="a1dd04d3-232a-4861-a5b8-a514f0e242d6"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#a1dd04d3-232a-4861-a5b8-a514f0e242d6-1"><i class="fas fa-atom"></i>æ„é€ å™¨å¼•ç”¨</button></li><li class="tab"><button type="button" data-href="#a1dd04d3-232a-4861-a5b8-a514f0e242d6-2"><i class="far fa-sun"></i>æ•°ç»„å¼•ç”¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="a1dd04d3-232a-4861-a5b8-a514f0e242d6-1"><p>å’Œæ–¹æ³•å¼•ç”¨ç±»ä¼¼ï¼Œå‡½æ•°å¼æ¥å£çš„æŠ½è±¡æ–¹æ³•çš„å½¢å‚åˆ—è¡¨å’Œæ„é€ å™¨çš„å½¢å‚åˆ—è¡¨ä¸€è‡´ã€‚</p><p>æŠ½è±¡æ–¹æ³•çš„è¿”å›å€¼ç±»å‹å³ä¸ºæ„é€ å™¨æ‰€å±çš„ç±»çš„ç±»å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test12</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1. Lambda</span></span><br><span class="line">    BiFunction&lt;String, Integer, Stu&gt; function01 = (string, integer) -&gt; <span class="keyword">new</span> <span class="title class_">Stu</span>(string, integer);</span><br><span class="line">    System.out.println(function01.apply(<span class="string">&quot;Kyle&quot;</span>, <span class="number">9527</span>));</span><br><span class="line">    </span><br><span class="line">    System.out.println(<span class="string">&quot;-------------------------------&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//2. æ„é€ å™¨å¼•ç”¨</span></span><br><span class="line">    BiFunction&lt;String, Integer, Stu&gt; function02 = Stu::<span class="keyword">new</span>;</span><br><span class="line">    System.out.println(function02.apply(<span class="string">&quot;Lucy&quot;</span>, <span class="number">9421</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Stu&#123;name=&#x27;Kyle&#x27;, id=9527&#125;</span></span><br><span class="line"><span class="comment">-------------------------------</span></span><br><span class="line"><span class="comment">Stu&#123;name=&#x27;Lucy&#x27;, id=9421&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a1dd04d3-232a-4861-a5b8-a514f0e242d6-2"><p>å¯ä»¥æŠŠæ•°ç»„çœ‹åšæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç±»ï¼Œåˆ™å†™æ³•ä¸æ„é€ å™¨å¼•ç”¨ä¸€è‡´ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test13</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1. Lambda åˆ›å»ºä¸€ä¸ªæŒ‡å®šé•¿åº¦çš„stringæ•°ç»„</span></span><br><span class="line">    Function&lt;Integer, String[]&gt; function01 = (integer -&gt; <span class="keyword">new</span> <span class="title class_">String</span>[integer]);</span><br><span class="line">    System.out.println(Arrays.toString(function01.apply(<span class="number">5</span>)));</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;-----------------------------&quot;</span>);</span><br><span class="line">    <span class="comment">//2. æ•°ç»„å¼•ç”¨</span></span><br><span class="line">    Function&lt;Integer, String[]&gt; function02 = String[]::<span class="keyword">new</span>;</span><br><span class="line">    System.out.println(Arrays.toString(function02.apply(<span class="number">7</span>)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">[null, null, null, null, null]</span></span><br><span class="line"><span class="comment">-----------------------------</span></span><br><span class="line"><span class="comment">[null, null, null, null, null, null, null]</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><hr><h2 id="å¼ºå¤§çš„Stream-APIâ­ï¸">å¼ºå¤§çš„Stream APIâ­ï¸</h2><h3 id="Stream-APIæ¦‚è¿°">Stream APIæ¦‚è¿°</h3><ul><li>Java8ä¸­æœ‰ä¸¤ä¸ªæœ€ä¸ºé‡è¦çš„æ”¹å˜ï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯Lambdaè¡¨è¾¾å¼ï¼Œå¦å¤–ä¸€ä¸ªåˆ™æ˜¯Stream API</li><li>Stream API(java.util.stream)æŠŠçœŸæ­£çš„å‡½æ•°å¼ç¼–ç¨‹é£æ ¼å¼•å…¥åˆ°Javaä¸­ï¼Œè¿™æ˜¯ç›®å‰ä¸ºæ­¢å¯¹Javaç±»åº“æœ€å¥½çš„è¡¥å……ï¼Œå› ä¸ºStream APIå¯ä»¥æå¤§åœ°æé«˜ç¨‹åºå‘˜ç”Ÿäº§åŠ›ï¼Œè®©ç¨‹åºå‘˜å†™å‡ºé«˜æ•ˆã€ç®€ä»‹çš„ä»£ç </li><li>Streamæ˜¯Java8 ä¸­å¤„ç†é›†åˆçš„å…³é”®æŠ½è±¡æ¦‚å¿µï¼Œå®ƒå¯ä»¥æŒ‡å®šä½ å¸Œæœ›å¯¹é›†åˆè¿›è¡Œçš„æ“ä½œï¼Œå¯ä»¥æ‰§è¡Œéå¸¸å¤æ‚çš„æŸ¥æ‰¾ã€è¿‡æ»¤å’Œæ˜ å°„æ•°æ®ç­‰æ“ä½œã€‚</li><li>ä½¿ç”¨Stream API å¯¹é›†åˆæ•°æ®è¿›è¡Œæ“ä½œï¼Œå°±ç±»ä¼¼äºä½¿ç”¨SQL æ‰§è¡Œçš„æ•°æ®åº“æŸ¥è¯¢ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Stream API æ¥å¹¶è¡Œæ‰§è¡Œæ“ä½œã€‚ç®€è¨€ä¹‹ï¼ŒStream API æä¾›äº†ä¸€ç§é«˜æ•ˆä¸”æ˜“äºä½¿ç”¨çš„å¤„ç†æ•°æ®çš„æ–¹å¼</li><li>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Stream API<ul><li>å®é™…å¼€å‘ä¸­ï¼Œé¡¹ç›®ä¸­å¤šæ•°æ•°æ®æºéƒ½æ˜¯æ¥è‡ªMySQLã€Oracle ç­‰ã€‚ä½†ç°åœ¨æ•°æ®æºå¯ä»¥æ›´å¤šäº†ï¼Œæœ‰MongDBã€Redisç­‰ï¼Œè€Œè¿™äº›NoSQLçš„æ•°æ®å°±éœ€è¦Javaå±‚é¢å»å¤„ç†ã€‚</li><li>Stream å’ŒCollectioné›†åˆçš„åŒºåˆ«ï¼šCollection æ˜¯ä¸€ç§é™æ€çš„å†…å­˜æ•°æ®ç»“æ„ï¼Œè€ŒStream æ˜¯æœ‰å…³è®¡ç®—çš„ã€‚å‰è€…æ˜¯ä¸»è¦é¢å‘å†…å­˜ï¼Œå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œåè€…ä¸»è¦æ˜¯é¢å‘CPUï¼Œé€šè¿‡CPU å®ç°è®¡ç®—ï¼ˆè¿™ä¹Ÿå°±æ˜¯ä¸ºå•¥ä¸€æ—¦æ‰§è¡Œç»ˆæ­¢æ“ä½œä¹‹åï¼ŒStream å°±ä¸èƒ½è¢«å†æ¬¡ä½¿ç”¨ï¼Œå¾—é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„æµæ‰è¡Œï¼‰</li></ul></li></ul><blockquote><p>å°ç»“</p></blockquote><ol><li>Stream å…³æ³¨çš„æ˜¯å¯¹æ•°æ®çš„è¿ç®—ï¼Œä¸CPU æ‰“äº¤é“ï¼›<br>é›†åˆå…³æ³¨çš„æ˜¯æ•°æ®çš„å­˜å‚¨ï¼Œä¸å†…å­˜æ‰“äº¤é“</li><li>Stream è‡ªå·±ä¸ä¼šå­˜å‚¨æ•°æ®ï¼›<br>Stream ä¸ä¼šæ”¹å˜æºå¯¹è±¡ï¼Œç›¸åï¼Œä»–ä»¬ä¼šè¿”å›ä¸€ä¸ªæŒæœ‰ç»“æœçš„æ–°Stream<br>Stream æ“ä½œæ˜¯å»¶è¿Ÿæ‰§è¡Œçš„ï¼Œè¿™æ„å‘³ç€ä»–ä»¬ä¼šç­‰åˆ°éœ€è¦ç»“æœçš„æ—¶å€™æ‰æ‰§è¡Œ</li><li>Stream æ‰§è¡Œæµç¨‹<ul><li>Streamå®ä¾‹åŒ–</li><li>ä¸€ç³»åˆ—ä¸­é—´æ“ä½œï¼ˆè¿‡æ»¤ã€æ˜ å°„ã€â€¦ï¼‰</li><li>ç»ˆæ­¢æ“ä½œ</li></ul></li><li>è¯´æ˜<ul><li>ä¸€ç³»åˆ—ä¸­é—´æ“ä½œè¿ï¼Œå¯¹æ•°æ®æºçš„æ•°æ®è¿›è¡Œå¤„ç†</li><li>ä¸€æ—¦æ‰§è¡Œç»ˆæ­¢æ“ä½œï¼Œå°±æ‰§è¡Œä¸­é—´æ“ä½œè¿ï¼Œå¹¶äº§ç”Ÿç»“æœï¼Œä¹‹åï¼Œä¸ä¼šå†è¢«ä½¿ç”¨</li></ul></li></ol><hr><h3 id="Streamçš„å®ä¾‹åŒ–">Streamçš„å®ä¾‹åŒ–</h3><div class="tabs" id="495d7dff-9394-4804-8bf5-e1083ed7e664"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#495d7dff-9394-4804-8bf5-e1083ed7e664-1"><i class="fas fa-baseball-ball"></i>æ–¹å¼ä¸€</button></li><li class="tab"><button type="button" data-href="#495d7dff-9394-4804-8bf5-e1083ed7e664-2"><i class="fas fa-bone"></i>æ–¹å¼äºŒ</button></li><li class="tab"><button type="button" data-href="#495d7dff-9394-4804-8bf5-e1083ed7e664-3"><i class="fas fa-heartbeat"></i>æ–¹å¼ä¸‰</button></li><li class="tab"><button type="button" data-href="#495d7dff-9394-4804-8bf5-e1083ed7e664-4"><i class="fas fa-cookie-bite"></i>æ–¹å¼å››</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="495d7dff-9394-4804-8bf5-e1083ed7e664-1"><p>é€šè¿‡é›†åˆåˆ›å»ºStream,ä½¿ç”¨ <code>Collection</code> æ¥å£çš„ <code>stream()</code> æ–¹æ³•æˆ– <code>parallelStream()</code> æ–¹æ³•åˆ›å»ºæµã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = Arrays.asList(<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;banana&quot;</span>, <span class="string">&quot;orange&quot;</span>);</span><br><span class="line">Stream&lt;String&gt; stream = list.stream(); <span class="comment">// åˆ›å»ºä¸²è¡Œæµ</span></span><br><span class="line">Stream&lt;String&gt; parallelStream = list.parallelStream(); <span class="comment">// åˆ›å»ºå¹¶è¡Œæµ</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„</p><p>Map æ¥å£æ˜¯ä¸ç»§æ‰¿ Collection æ¥å£çš„ï¼Œå› æ­¤ Map æ²¡æœ‰æä¾› stream() æ–¹æ³•ç”¨äºç”Ÿæˆæµå¯¹è±¡ã€‚</p><p>å¯ä»¥é€šè¿‡ Map çš„ entrySet() æ–¹æ³•è·å–ä¸€ä¸ª<code>Set&lt;Map.Entry&lt;K, V&gt;&gt;</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«äº† Map ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹ã€‚å› ä¸º Set å®ç°äº† Collection æ¥å£ï¼Œå› æ­¤å¯ä»¥é€šè¿‡è¯¥ Set å¯¹è±¡ç”Ÿæˆæµå¯¹è±¡ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="495d7dff-9394-4804-8bf5-e1083ed7e664-2"><p>é€šè¿‡æ•°ç»„åˆ›å»ºStringï¼Œä½¿ç”¨ <code>Arrays</code> ç±»çš„ <code>stream(T[] array)</code> æ–¹æ³•åˆ›å»ºæµã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] arr = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"><span class="type">IntStream</span> <span class="variable">stream</span> <span class="operator">=</span> Arrays.stream(arr); <span class="comment">// åˆ›å»ºåŸºæœ¬ç±»å‹æµ</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="495d7dff-9394-4804-8bf5-e1083ed7e664-3"><p>é€šè¿‡è‡ªå®šä¹‰åˆ›å»ºæµï¼šä½¿ç”¨ <code>Stream</code> æ¥å£æä¾›çš„é™æ€æ–¹æ³• <code>of()</code>ã€<code>iterate()</code>ã€<code>generate()</code> åˆ›å»ºæµã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Stream&lt;String&gt; stream = Stream.of(<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;banana&quot;</span>, <span class="string">&quot;orange&quot;</span>); <span class="comment">// åˆ›å»ºæµï¼ŒåŒ…å«æŒ‡å®šçš„å…ƒç´ </span></span><br><span class="line">Stream&lt;Integer&gt; stream = Stream.iterate(<span class="number">1</span>, n -&gt; n + <span class="number">1</span>).limit(<span class="number">5</span>); <span class="comment">// åˆ›å»ºæµï¼ŒåŒ…å« 1 åˆ° 5 çš„æ•´æ•°</span></span><br><span class="line">Stream&lt;Double&gt; stream = Stream.generate(Math::random).limit(<span class="number">5</span>); <span class="comment">// åˆ›å»ºæµï¼ŒåŒ…å« 5 ä¸ªéšæœºæ•°</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="495d7dff-9394-4804-8bf5-e1083ed7e664-4"><p>é€šè¿‡æ•°å€¼èŒƒå›´åˆ›å»ºæµï¼šä½¿ç”¨ <code>IntStream</code>ã€<code>LongStream</code> æˆ– <code>DoubleStream</code> æ¥å£æä¾›çš„ <code>range()</code>ã€<code>rangeClosed()</code> æ–¹æ³•åˆ›å»ºæµã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">IntStream</span> <span class="variable">stream</span> <span class="operator">=</span> IntStream.range(<span class="number">1</span>, <span class="number">5</span>); <span class="comment">// åˆ›å»ºèŒƒå›´æµï¼ŒåŒ…æ‹¬ 1 ä¸åŒ…æ‹¬ 5</span></span><br><span class="line"><span class="type">IntStream</span> <span class="variable">stream</span> <span class="operator">=</span> IntStream.rangeClosed(<span class="number">1</span>, <span class="number">5</span>); <span class="comment">// åˆ›å»ºèŒƒå›´æµï¼ŒåŒ…æ‹¬ 1 å’Œ 5</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="Streamçš„ä¸­é—´æ“ä½œ">Streamçš„ä¸­é—´æ“ä½œ</h3><blockquote><mark class="hl-label blue">åŒ…è£…</mark> </blockquote><p><code>boxed()</code> æ–¹æ³•ä½œç”¨æ˜¯å°†åŸºæœ¬ç±»å‹æµè½¬æ¢æˆå¯¹åº”çš„åŒ…è£…ç±»å‹æµã€‚ä¾‹å¦‚ï¼Œå°† <code>IntStream</code> è½¬æ¢æˆ <code>Stream&lt;Integer&gt;</code>ï¼Œå°† <code>DoubleStream</code> è½¬æ¢æˆ <code>Stream&lt;Double&gt;</code> ç­‰ã€‚</p><p>è¿™é€šå¸¸æ˜¯ä¸ºäº†åœ¨æµå¤„ç†è¿‡ç¨‹ä¸­ä½¿ç”¨æŸäº›ä¸é€‚ç”¨äºåŸºæœ¬ç±»å‹çš„åŠŸèƒ½ï¼Œä¾‹å¦‚å°†åŸºæœ¬ç±»å‹å…ƒç´ æ”¶é›†åˆ°æŸç§é›†åˆä¸­æˆ–éœ€è¦ä½¿ç”¨å¯¹è±¡å¼•ç”¨æ—¶ã€‚</p><p>ä¾‹å¦‚åŸºæœ¬æ•°æ®ç±»å‹æµçš„æ’åºä¸èƒ½ä¼ å…¥æ¯”è¾ƒå™¨ï¼Œå¾—ä½¿ç”¨åŒ…è£…ç±»å‹æµã€‚</p><blockquote><mark class="hl-label blue">ç­›é€‰ä¸åˆ‡ç‰‡</mark> </blockquote><p>ç­›é€‰ä¸åˆ‡ç‰‡æ“ä½œç”¨äºå¯¹æµä¸­çš„å…ƒç´ è¿›è¡Œè¿‡æ»¤å’Œæˆªå–ï¼Œå¸¸ç”¨çš„æ–¹æ³•åŒ…æ‹¬:</p><p><code>filter(Predicate&lt;T&gt; predicate)</code>ï¼šè¿‡æ»¤æµä¸­ä¸ç¬¦åˆæ¡ä»¶çš„å…ƒç´ ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„æµã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line">Stream&lt;Integer&gt; stream = list.stream().filter(n -&gt; n % <span class="number">2</span> == <span class="number">0</span>); <span class="comment">// è¿‡æ»¤å¶æ•°</span></span><br></pre></td></tr></table></figure><p><code>distinct()</code>ï¼šå»é™¤æµä¸­é‡å¤çš„å…ƒç´ ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„æµã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">1</span>);</span><br><span class="line">Stream&lt;Integer&gt; stream = list.stream().distinct(); <span class="comment">// å»é‡</span></span><br></pre></td></tr></table></figure><p><code>limit(long maxSize)</code>ï¼šæˆªå–æµä¸­çš„å‰ <code>maxSize</code> ä¸ªå…ƒç´ ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„æµã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line">Stream&lt;Integer&gt; stream = list.stream().limit(<span class="number">3</span>); <span class="comment">// æˆªå–å‰ä¸‰ä¸ªå…ƒç´ </span></span><br></pre></td></tr></table></figure><p><code>skip(long n)</code>ï¼šè·³è¿‡æµä¸­çš„å‰ <code>n</code> ä¸ªå…ƒç´ ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„æµã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line">Stream&lt;Integer&gt; stream = list.stream().skip(<span class="number">2</span>); <span class="comment">// è·³è¿‡å‰ä¸¤ä¸ªå…ƒç´ </span></span><br></pre></td></tr></table></figure><blockquote><mark class="hl-label blue">æ˜ å°„</mark> </blockquote><table><thead><tr><th style="text-align:center">æ–¹æ³•</th><th style="text-align:center">æè¿°</th></tr></thead><tbody><tr><td style="text-align:center">map(Function f)</td><td style="text-align:center">æ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¯¥å‡½æ•°ä¼šè¢«åº”ç”¨åˆ°æ¯ä¸ªå…ƒç´ ä¸Šï¼Œå¹¶å°†å…¶æ˜ å°„æˆä¸€ä¸ªæ–°çš„å…ƒç´ ã€‚</td></tr><tr><td style="text-align:center">mapToDouble(ToDoubleFunction f)</td><td style="text-align:center">æ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¯¥å‡½æ•°ä¼šè¢«åº”ç”¨åˆ°æ¯ä¸ªå…ƒç´ ä¸Šï¼Œäº§ç”Ÿä¸€ä¸ªæ–°çš„DoubleStreamã€‚</td></tr><tr><td style="text-align:center">mapToInt(ToIntFunction f)</td><td style="text-align:center">æ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¯¥å‡½æ•°ä¼šè¢«åº”ç”¨åˆ°æ¯ä¸ªå…ƒç´ ä¸Šï¼Œäº§ç”Ÿä¸€ä¸ªæ–°çš„IntStreamã€‚</td></tr><tr><td style="text-align:center">mapToLong(ToLongFunction f)</td><td style="text-align:center">æ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¯¥å‡½æ•°ä¼šè¢«åº”ç”¨åˆ°æ¯ä¸ªå…ƒç´ ä¸Šï¼Œäº§ç”Ÿä¸€ä¸ªæ–°çš„LongStreamã€‚</td></tr><tr><td style="text-align:center">flatMap(Function f)</td><td style="text-align:center">æ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå°†æµä¸­çš„æ¯ä¸ªå€¼éƒ½æ¢æˆå¦ä¸€ä¸ªæµï¼Œç„¶åæŠŠæ‰€æœ‰æµè¿æ¥æˆä¸€ä¸ªæµ</td></tr></tbody></table><p>æ˜ å°„æ“ä½œç”¨äºå¯¹æµä¸­çš„å…ƒç´ è¿›è¡Œè½¬æ¢å’Œæå–ï¼Œå¸¸ç”¨çš„æ–¹æ³•åŒ…æ‹¬ï¼š</p><p><code>map(Function&lt;T, R&gt; mapper)</code>ï¼šå°†æµä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜ å°„æˆå¦å¤–ä¸€ä¸ªå…ƒç´ ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„æµã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = Arrays.asList(<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;banana&quot;</span>, <span class="string">&quot;orange&quot;</span>);</span><br><span class="line">Stream&lt;Integer&gt; stream = list.stream().map(s -&gt; s.length()); <span class="comment">// å°†å­—ç¬¦ä¸²è½¬æ¢æˆé•¿åº¦</span></span><br></pre></td></tr></table></figure><p><code>flatMap(Function&lt;T, Stream&lt;R&gt;&gt; mapper)</code>ï¼šå°†æµä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜ å°„æˆä¸€ä¸ªæµï¼Œç„¶åå°†è¿™äº›æµåˆå¹¶æˆä¸€ä¸ªæµï¼Œè¿”å›ä¸€ä¸ªæ–°çš„æµ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;List&lt;Integer&gt;&gt; list = Arrays.asList(Arrays.asList(<span class="number">1</span>, <span class="number">2</span>), Arrays.asList(<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>), Arrays.asList(<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>));</span><br><span class="line">Stream&lt;Integer&gt; stream = list.stream().flatMap(Collection::stream); <span class="comment">// å°†å¤šä¸ªåˆ—è¡¨åˆå¹¶æˆä¸€ä¸ªæµ</span></span><br></pre></td></tr></table></figure><blockquote><mark class="hl-label blue">æ’åº</mark> </blockquote><p><code>sorted()</code>ï¼šæŒ‰è‡ªç„¶é¡ºåºå¯¹æµä¸­çš„å…ƒç´ è¿›è¡Œæ’åºï¼Œè¿”å›ä¸€ä¸ªæ–°çš„æµã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; list = Arrays.asList(<span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">5</span>);</span><br><span class="line">Stream&lt;Integer&gt; stream = list.stream().sorted(); <span class="comment">// å¯¹æ•´æ•°åˆ—è¡¨è¿›è¡Œæ’åº å¢åº</span></span><br></pre></td></tr></table></figure><p><code>sorted(Comparator&lt;T&gt; comparator)</code>ï¼šæŒ‰æŒ‡å®šçš„æ¯”è¾ƒå™¨å¯¹æµä¸­çš„å…ƒç´ è¿›è¡Œæ’åºï¼Œè¿”å›ä¸€ä¸ªæ–°çš„æµã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = Arrays.asList(<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;banana&quot;</span>, <span class="string">&quot;orange&quot;</span>, <span class="string">&quot;pear&quot;</span>);</span><br><span class="line">Stream&lt;String&gt; stream = list.stream().sorted(Comparator.comparing(String::length)); <span class="comment">// å¯¹å­—ç¬¦ä¸²åˆ—è¡¨æŒ‰é•¿åº¦è¿›è¡Œæ’åº</span></span><br><span class="line"></span><br><span class="line">List&lt;Integer&gt; list = Arrays.asList(<span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">5</span>);</span><br><span class="line">Stream&lt;Integer&gt; stream = list.stream().sorted(Comparator.reverseOrder()); <span class="comment">// å¯¹æ•´æ•°åˆ—è¡¨è¿›è¡Œæ’åº é™åº</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé€†åºæ¯”è¾ƒå™¨åªå¯¹å®ç°äº† <code>Comparable</code> æ¥å£çš„ç±»å‹æœ‰æ•ˆï¼Œå¯¹äºå…¶ä»–ç±»å‹çš„å…ƒç´ ï¼Œéœ€è¦æä¾›è‡ªå®šä¹‰çš„æ¯”è¾ƒå™¨ã€‚</p><hr><h3 id="Streamçš„ç»ˆæ­¢æ“ä½œ">Streamçš„ç»ˆæ­¢æ“ä½œ</h3><p>æµçš„ç»ˆæ­¢æ“ä½œç”¨äºè§¦å‘æµçš„è®¡ç®—ï¼Œå¹¶äº§ç”Ÿä¸€ä¸ªæœ€ç»ˆçš„ç»“æœæˆ–å‰¯ä½œç”¨ã€‚å¸¸ç”¨çš„ç»ˆæ­¢æ“ä½œåŒ…æ‹¬ï¼š</p><blockquote><mark class="hl-label blue">åŒ¹é…ä¸æŸ¥æ‰¾</mark> </blockquote><table><thead><tr><th style="text-align:center">æ–¹æ³•</th><th style="text-align:center">æè¿°</th></tr></thead><tbody><tr><td style="text-align:center">allMatch(Predicate p)</td><td style="text-align:center">æ£€æŸ¥æ˜¯å¦åŒ¹é…æ‰€æœ‰å…ƒç´ </td></tr><tr><td style="text-align:center">anyMatch(Predicate p)</td><td style="text-align:center">æ£€æŸ¥æ˜¯å¦è‡³å°‘åŒ¹é…ä¸€ä¸ªå…ƒç´ </td></tr><tr><td style="text-align:center">noneMatch(Predicate p)</td><td style="text-align:center">æ£€æŸ¥æ˜¯å¦æ²¡æœ‰åŒ¹é…æ‰€æœ‰å…ƒç´ </td></tr><tr><td style="text-align:center">findFirst()</td><td style="text-align:center">è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ </td></tr><tr><td style="text-align:center">findAny()</td><td style="text-align:center">è¿”å›å½“å‰æµä¸­çš„ä»»æ„å…ƒç´ </td></tr><tr><td style="text-align:center">count()</td><td style="text-align:center">è¿”å›æµä¸­å…ƒç´ æ€»æ•°</td></tr><tr><td style="text-align:center">max(Comparator c)</td><td style="text-align:center">è¿”å›æµä¸­æœ€å¤§å€¼</td></tr><tr><td style="text-align:center">min(Comparator c)</td><td style="text-align:center">è¿”å›æµä¸­æœ€å°å€¼</td></tr><tr><td style="text-align:center">forEach(Consumer c)</td><td style="text-align:center">å†…éƒ¨è¿­ä»£(ä½¿ç”¨Collection æ¥å£éœ€è¦ç”¨æˆ·å»åšè¿­ä»£ï¼Œç§°ä¸ºå¤–éƒ¨è¿­ä»£ã€‚ç›¸åï¼ŒStream API ä½¿ç”¨å†…éƒ¨è¿­ä»£â€”â€”å®ƒå¸®ä½ æŠŠè¿­ä»£åšäº†)</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Employee&gt; employees = EmployeeData.getEmployees();</span><br><span class="line"><span class="comment">// allMatch(Predicate p)â€”â€”æ£€æŸ¥æ˜¯å¦åŒ¹é…æ‰€æœ‰å…ƒç´ ã€‚</span></span><br><span class="line">System.out.println(<span class="string">&quot;æ˜¯å¦æ‰€æœ‰çš„å‘˜å·¥çš„å·¥èµ„æ˜¯å¦éƒ½å¤§äº5000ï¼š&quot;</span>+employees.stream().allMatch(employee -&gt; employee.getSalary() &gt; <span class="number">5000</span>));</span><br><span class="line"><span class="comment">// anyMatch(Predicate p)â€”â€”æ£€æŸ¥æ˜¯å¦è‡³å°‘åŒ¹é…ä¸€ä¸ªå…ƒç´ ã€‚</span></span><br><span class="line">System.out.println(<span class="string">&quot;æ˜¯å¦å­˜åœ¨å‘˜å·¥å¹´é¾„å°äº15ï¼š&quot;</span>+employees.stream().anyMatch(employee -&gt; employee.getAge() &lt; <span class="number">15</span>));</span><br><span class="line"><span class="comment">// noneMatch(Predicate p)â€”â€”æ£€æŸ¥æ˜¯å¦æ²¡æœ‰åŒ¹é…çš„å…ƒç´ ã€‚</span></span><br><span class="line">System.out.println(<span class="string">&quot;æ˜¯å¦ä¸å­˜åœ¨å‘˜å·¥å§“é©¬ï¼š&quot;</span>+employees.stream().noneMatch(employee -&gt; employee.getName().startsWith(<span class="string">&quot;é©¬&quot;</span>)));</span><br><span class="line"><span class="comment">//findFirstâ€”â€”è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">System.out.println(<span class="string">&quot;è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ ï¼š&quot;</span>+employees.stream().findFirst());</span><br><span class="line"><span class="comment">//findAnyâ€”â€”è¿”å›å½“å‰æµä¸­çš„ä»»æ„å…ƒç´ </span></span><br><span class="line">System.out.println(<span class="string">&quot;è¿”å›å½“å‰æµä¸­çš„ä»»æ„å…ƒç´ &quot;</span>+employees.stream().findAny());</span><br><span class="line"><span class="comment">//countâ€”â€”è¿”å›æµä¸­å…ƒç´ çš„æ€»ä¸ªæ•°</span></span><br><span class="line">System.out.println(<span class="string">&quot;è¿”å›å…ƒç´ æ€»æ•°ï¼š&quot;</span>+employees.stream().count());</span><br><span class="line"><span class="comment">//max(Comparator c)â€”â€”è¿”å›æµä¸­æœ€å¤§å€¼</span></span><br><span class="line">System.out.println(<span class="string">&quot;è¿”å›æœ€é«˜å·¥èµ„ï¼š&quot;</span>+employees.stream().map(Employee::getSalary).max(Double::compare));</span><br><span class="line"><span class="comment">//min(Comparator c)â€”â€”è¿”å›æµä¸­æœ€å°å€¼</span></span><br><span class="line">System.out.println(<span class="string">&quot;è¿”å›æœ€å°å¹´é¾„ï¼š&quot;</span>+employees.stream().map(Employee::getAge).min(Integer::compare));</span><br><span class="line"><span class="comment">//forEach(Consumer c)â€”â€”å†…éƒ¨è¿­ä»£</span></span><br><span class="line">employees.stream().forEach(System.out::println);</span><br><span class="line">System.out.println(<span class="string">&quot;-------------&quot;</span>);</span><br><span class="line"><span class="comment">////ä½¿ç”¨é›†åˆçš„éå†æ“ä½œ</span></span><br><span class="line">employees.forEach(System.out::println);</span><br></pre></td></tr></table></figure><blockquote><mark class="hl-label blue">å½’çº¦</mark> </blockquote><table><thead><tr><th style="text-align:center">æ–¹æ³•</th><th style="text-align:center">æè¿°</th></tr></thead><tbody><tr><td style="text-align:center">reduce(T iden, BinaryOperator b)</td><td style="text-align:center">å¯ä»¥å°†æµä¸­å…ƒç´ åå¤ç»“åˆèµ·æ¥ï¼Œå¾—åˆ°ä¸€ä¸ªå€¼ã€‚è¿”å›T</td></tr><tr><td style="text-align:center">reduce(BinaryOperator b)</td><td style="text-align:center">å¯ä»¥å°†æµä¸­å…ƒç´ åå¤ç»“åˆèµ·æ¥ï¼Œå¾—åˆ°ä¸€ä¸ªå€¼ã€‚è¿”å›Optional</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test22</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Integer&gt; nums = Arrays.asList(<span class="number">13</span>, <span class="number">32</span>, <span class="number">23</span>, <span class="number">31</span>, <span class="number">94</span>, <span class="number">20</span>, <span class="number">77</span>, <span class="number">21</span>, <span class="number">17</span>);</span><br><span class="line">    List&lt;Employee&gt; employees = EmployeeData.getEmployees();</span><br><span class="line">    <span class="comment">// reduce(T identity, BinaryOperator)â€”â€”å¯ä»¥å°†æµä¸­å…ƒç´ åå¤ç»“åˆèµ·æ¥ï¼Œå¾—åˆ°ä¸€ä¸ªå€¼ã€‚è¿”å› T</span></span><br><span class="line">    <span class="comment">// ç»ƒä¹ 1ï¼šè®¡ç®—1-10çš„è‡ªç„¶æ•°çš„å’Œ</span></span><br><span class="line">    System.out.println(nums.stream().reduce(<span class="number">0</span>, Integer::sum));</span><br><span class="line">    <span class="comment">//reduce(BinaryOperator) â€”â€”å¯ä»¥å°†æµä¸­å…ƒç´ åå¤ç»“åˆèµ·æ¥ï¼Œå¾—åˆ°ä¸€ä¸ªå€¼ã€‚è¿”å› Optional&lt;T&gt;</span></span><br><span class="line">    <span class="comment">// ç»ƒä¹ 2ï¼šè®¡ç®—å…¬å¸æ‰€æœ‰å‘˜å·¥å·¥èµ„æ€»å’Œ</span></span><br><span class="line">    System.out.println(employees.stream().map(Employee::getSalary).reduce((o1, o2) -&gt; o1 + o2));</span><br><span class="line">    <span class="comment">// åˆ«çš„å†™æ³•ï¼Œè®¡ç®—å¹´é¾„æ€»å’Œ</span></span><br><span class="line">    System.out.println(employees.stream().map(Employee::getAge).reduce(Integer::sum));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">328</span></span><br><span class="line"><span class="comment">Optional[48424.08]</span></span><br><span class="line"><span class="comment">Optional[273]</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><blockquote><mark class="hl-label blue">æ”¶é›†</mark> </blockquote><p><code>collect(Collector&lt;T, A, R&gt; collector)</code>ï¼šå°†æµä¸­çš„å…ƒç´ æ”¶é›†åˆ°ä¸€ä¸ªé›†åˆä¸­ï¼Œè¿”å›ä¸€ä¸ªæœ€ç»ˆçš„ç»“æœã€‚</p><p>Collector æ¥å£ä¸­æ–¹æ³•çš„å®ç°å†³å®šäº†å¦‚ä½•å¯¹æµæ‰§è¡Œæ”¶é›†çš„æ“ä½œ(å¦‚æ”¶é›†åˆ°Listã€Setã€Map)ã€‚</p><p>Collectorså®ç”¨ç±»æä¾›äº†å¾ˆå¤šé™æ€æ–¹æ³•ï¼Œå¯ä»¥æ–¹ä¾¿åœ°åˆ›å»ºå¸¸è§æ”¶é›†å™¨å®ä¾‹ï¼Œå…·ä½“æ–¹æ³•ä¸å®ä¾‹å¦‚ä¸‹è¡¨</p><table>  <tbody>    <tr style="text-align:center">      <td bgcolor="3366ff" style="color:white">æ–¹æ³•</td>      <td bgcolor="3366ff" style="color:white">è¿”å›ç±»å‹</td>      <td bgcolor="3366ff" style="color:white">ä½œç”¨</td>    </tr>    <tr style="text-align:center">      <td bgcolor="3399ff" style="color:white">toList</td>      <td bgcolor="3399ff" style="color:white">List&lt;T&gt;</td>      <td bgcolor="3399ff" style="color:white">æŠŠæµä¸­å…ƒç´ æ”¶é›†åˆ°List</td>    </tr>    <tr style="text-align:center">      <td colspan="3" bgcolor="33ccff" style="color:white">List&lt;Employee&gt; emps= list.stream().collect(Collectors.toList());</td>    </tr>    <tr style="text-align:center">      <td bgcolor="3399ff" style="color:white">toSet</td>      <td bgcolor="3399ff" style="color:white">List&lt;T&gt;</td>      <td bgcolor="3399ff" style="color:white">æŠŠæµä¸­å…ƒç´ æ”¶é›†åˆ°List</td>    </tr>    <tr style="text-align:center">      <td colspan="3" bgcolor="33ccff" style="color:white">Set&lt;Employee&gt; emps= list.stream().collect(Collectors.toSet());</td>    </tr>    <tr style="text-align:center">      <td bgcolor="3399ff" style="color:white">toCollection</td>      <td bgcolor="3399ff" style="color:white"> Collection&lt;T&gt;</td>      <td bgcolor="3399ff" style="color:white">æŠŠæµä¸­å…ƒç´ æ”¶é›†åˆ°åˆ›å»ºçš„é›†åˆ</td>    </tr>    <tr style="text-align:center">      <td colspan="3" bgcolor="33ccff" style="color:white">Collection&lt;Employee&gt; emps =list.stream().collect(Collectors.toCollection(ArrayList::new));</td>    </tr>    <tr style="text-align:center">      <td bgcolor="3399ff" style="color:white">counting</td>      <td bgcolor="3399ff" style="color:white">Long</td>      <td bgcolor="3399ff" style="color:white">è®¡ç®—æµä¸­å…ƒç´ çš„ä¸ªæ•°</td>    </tr>    <tr style="text-align:center">      <td colspan="3" bgcolor="33ccff" style="color:white">long count = list.stream().collect(Collectors.counting());</td>    </tr>    <tr style="text-align:center">      <td bgcolor="3399ff" style="color:white">summinglnt</td>      <td bgcolor="3399ff" style="color:white">Integer</td>      <td bgcolor="3399ff" style="color:white">å¯¹æµä¸­å…ƒç´ çš„æ•´æ•°å±æ€§æ±‚å’Œ</td>    </tr>    <tr style="text-align:center">      <td colspan="3" bgcolor="33ccff" style="color:white">int total=list.stream().collect(Collectors.summingInt(Employee::getSalary));</td>    </tr>    <tr style="text-align:center">      <td bgcolor="3399ff" style="color:white">averagingInt</td>      <td bgcolor="3399ff" style="color:white">Double</td>      <td bgcolor="3399ff" style="color:white">è®¡ç®—æµä¸­å…ƒç´ Integerå±æ€§çš„å¹³å‡å€¼</td>    </tr>    <tr style="text-align:center">      <td colspan="3" bgcolor="33ccff" style="color:white">double avg = list.stream().collect(Collectors.averagingInt(Employee::getSalary));</td>    </tr>    <tr style="text-align:center">      <td bgcolor="3399ff" style="color:white">summarizinglnt</td>      <td bgcolor="3399ff" style="color:white">IntSummaryStatistics</td>      <td bgcolor="3399ff" style="color:white">æ”¶é›†æµä¸­Integerå±æ€§çš„ç»Ÿè®¡å€¼ã€‚å¦‚:å¹³å‡å€¼</td>    </tr>    <tr style="text-align:center">      <td colspan="3" bgcolor="33ccff" style="color:white">int SummaryStatisticsiss=list.stream().collect(Collectors.summarizingInt(Employee::getSalary));</td>    </tr>    <tr style="text-align:center">      <td bgcolor="3399ff" style="color:white">joining</td>      <td bgcolor="3399ff" style="color:white">String</td>      <td bgcolor="3399ff" style="color:white">è¿æ¥æµä¸­æ¯ä¸ªå­—ç¬¦ä¸²</td>    </tr>    <tr style="text-align:center">      <td colspan="3" bgcolor="33ccff" style="color:white">String str= list.stream().map(Employee::getName).collect(Collectors.joining());</td>    </tr>    <tr style="text-align:center">      <td bgcolor="3399ff" style="color:white">maxBy</td>      <td bgcolor="3399ff" style="color:white">Optional&lt;T&gt;</td>      <td bgcolor="3399ff" style="color:white">æ ¹æ®æ¯”è¾ƒå™¨é€‰æ‹©æœ€å¤§å€¼</td>    </tr>    <tr style="text-align:center">      <td colspan="3" bgcolor="33ccff" style="color:white">optional&lt;Emp&gt;max=list.stream().collect(Collectors.maxBy(comparingInt(Employee::getSalary));</td>    </tr>    <tr style="text-align:center">      <td bgcolor="3399ff" style="color:white">minBy</td>      <td bgcolor="3399ff" style="color:white">Optional&lt;T&gt;</td>      <td bgcolor="3399ff" style="color:white">æ ¹æ®æ¯”è¾ƒå™¨é€‰æ‹©æœ€å°å€¼</td>    </tr>    <tr style="text-align:center">      <td colspan="3" bgcolor="33ccff" style="color:white">Optional&lt;Emp&gt;min = list.stream().collect(Collectors.minBy(comparingInt(Employee::getSalary));</td>    </tr>    <tr style="text-align:center">      <td bgcolor="3399ff" style="color:white">reducing</td>      <td bgcolor="3399ff" style="color:white">å½’çº¦äº§ç”Ÿçš„ç±»å‹</td>      <td bgcolor="3399ff" style="color:white">ä»ä¸€ä¸ªä½œä¸ºç´¯åŠ å™¨çš„åˆå§‹å€¼å¼€å§‹ï¼Œåˆ©ç”¨BinaryOperatorä¸æµä¸­å…ƒç´ é€ä¸ªç»“åˆï¼Œä»è€Œå½’çº¦æˆå•ä¸ªå€¼</td>    </tr>    <tr style="text-align:center">      <td colspan="3" bgcolor="33ccff" style="color:white">int total=list.stream().collect(Collectors.reducing(0, Employe::getSalar, Integer::sum));</td>    </tr>    <tr style="text-align:center">      <td bgcolor="3399ff" style="color:white">collectingAndThen</td>      <td bgcolor="3399ff" style="color:white">è½¬æ¢å‡½æ•°è¿”å›çš„ç±»å‹</td>      <td bgcolor="3399ff" style="color:white">åŒ…è£¹å¦ä¸€ä¸ªæ”¶é›†å™¨ï¼Œå¯¹å…¶ç»“æœè½¬æ¢å‡½æ•°</td>    </tr>    <tr style="text-align:center">      <td colspan="3" bgcolor="33ccff" style="color:white">int how= list.stream().collect(Collectors.collectingAndThen(Collectors.toList(), List::size));</td>    </tr>    <tr style="text-align:center">      <td bgcolor="3399ff" style="color:white">groupingBy</td>      <td bgcolor="3399ff" style="color:white"> Map&lt;K, List&lt;T&gt;&gt;</td>      <td bgcolor="3399ff" style="color:white">æ ¹æ®æŸå±æ€§å€¼å¯¹æµåˆ†ç»„ï¼Œå±æ€§ä¸ºK,ç»“æœä¸ºV</td>    </tr>    <tr style="text-align:center">      <td colspan="3" bgcolor="33ccff" style="color:white">Map&lt;Emp.Status, List&lt;Emp&gt;&gt;map= list.stream().collect(Collectors.groupingBy(Employee::getStatus));</td>    </tr>    <tr style="text-align:center">      <td bgcolor="3399ff" style="color:white">partitioningBy</td>      <td bgcolor="3399ff" style="color:white">Map&lt;Boolean,List&lt;T&gt;&gt;</td>      <td bgcolor="3399ff" style="color:white">æ ¹æ®trueæˆ–falseè¿›è¡Œåˆ†åŒº</td>    </tr>    <tr style="text-align:center">      <td colspan="3" bgcolor="33ccff" style="color:white">Map&lt;Boolean,List&lt;Emp&gt;&gt;vd=list.stream().collect(Collectors.partitioningBy(Employee::getManage));</td>    </tr></tbody></table><hr><hr><h2 id="Streamçš„ä½¿ç”¨å®ä¾‹">Streamçš„ä½¿ç”¨å®ä¾‹</h2><blockquote><p>mapä¸­å­˜å‚¨äº†å„å…ƒç´ çš„å‡ºç°æ¬¡æ•°ã€‚</p></blockquote><p>k = 2 ï¼Œv = 3</p><p>è¯´æ˜æ•°å­—2 å‡ºç°äº†3æ¬¡</p><p>ç°åœ¨è¦å°†mapä¸­å„å…ƒç´ çš„å‡ºç°æ¬¡æ•°ï¼Œä»å¤§åˆ°å°æ’ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Integer, Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">List&lt;Map.Entry&lt;Integer, Integer&gt;&gt; mapList = map.entrySet().stream()</span><br><span class="line">            .sorted((c1, c2) -&gt; c2.getValue().compareTo(c1.getValue()))</span><br><span class="line">            .collect(Collectors.toList());</span><br></pre></td></tr></table></figure><blockquote><p>è·å¾—å·®å€¼åºåˆ—</p></blockquote><p>nums[1, 7, 4, 9, 2, 5]   å‰é¡¹å‡å»åé¡¹</p><p>å·®å€¼ [6, -3, 5, -7, 3]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] array = IntStream.range(<span class="number">1</span>, nums.length) <span class="comment">// åˆ›å»º 1åˆ° nums.length ä¸€å…± nums.length-1 å“¥</span></span><br><span class="line">                .map(i -&gt; nums[i-<span class="number">1</span>] - nums[i])<span class="comment">// æ˜ å°„</span></span><br><span class="line">                .toArray();</span><br></pre></td></tr></table></figure><blockquote><p>å–å¾—äºŒç»´Listçš„æœ€åä¸€ä¸ªå…ƒç´ å­˜å‚¨</p></blockquote><p>levels = [[3], [9, 20], [15, 7]]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">List&lt;List&lt;Integer&gt;&gt; levels =<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">Stream.of(levels)</span><br><span class="line">      .flatMap(List::stream)</span><br><span class="line">      .mapToInt(list -&gt; list.get(list.size() - <span class="number">1</span>))</span><br><span class="line">      .forEach(res::add);</span><br></pre></td></tr></table></figure><p>res = [3,20,7]</p><blockquote><p><code>List&lt;String&gt;</code>è½¬åŒ–æˆStringæ•°ç»„</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String[] res = IntStream.range(<span class="number">0</span>, length)</span><br><span class="line">        .mapToObj(i -&gt; map.get(score[i]))</span><br><span class="line">        .collect(Collectors.toList())</span><br><span class="line">        .toArray(<span class="keyword">new</span> <span class="title class_">String</span>[length]);</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Lambdaè¡¨è¾¾å¼ã€å‡½æ•°å¼æ¥å£ã€Stream API</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/tags/Java/"/>
    
  </entry>
  
</feed>
