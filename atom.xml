<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>LuckyBoyğŸ¥</title>
  
  
  <link href="https://wuwawawa.github.io/atom.xml" rel="self"/>
  
  <link href="https://wuwawawa.github.io/"/>
  <updated>2023-09-19T06:53:52.404Z</updated>
  <id>https://wuwawawa.github.io/</id>
  
  <author>
    <name>LuckyBoyğŸ¥</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ç­›è´¨æ•°</title>
    <link href="https://wuwawawa.github.io/posts/996e4f07.html"/>
    <id>https://wuwawawa.github.io/posts/996e4f07.html</id>
    <published>2023-09-19T00:51:18.000Z</published>
    <updated>2023-09-19T06:53:52.404Z</updated>
    
    <content type="html"><![CDATA[<p>ç»Ÿè®¡ [2,n] ä¸­è´¨æ•°çš„æ•°é‡æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„é¢˜ç›®ï¼Œä¹Ÿæœ‰å¾ˆå¤šå·§å¦™é«˜æ•ˆçš„åšæ³•ï¼Œæ¥ä¸‹æ¥çš„éƒ¨åˆ†åªä¼šè®²è¿°ä¸€äº›å¸¸è§çš„åšæ³•ã€‚</p><h2 id="æšä¸¾">æšä¸¾</h2><p>å¾ˆç›´è§‚çš„æ€è·¯æ˜¯æˆ‘ä»¬æšä¸¾æ¯ä¸ªæ•°åˆ¤æ–­å…¶æ˜¯ä¸æ˜¯è´¨æ•°ã€‚</p><p>è€ƒè™‘è´¨æ•°çš„å®šä¹‰ï¼šåœ¨å¤§äº 1 çš„è‡ªç„¶æ•°ä¸­ï¼Œé™¤äº† 1 å’Œå®ƒæœ¬èº«ä»¥å¤–ä¸å†æœ‰å…¶ä»–å› æ•°çš„è‡ªç„¶æ•°ã€‚å› æ­¤å¯¹äºæ¯ä¸ªæ•° xï¼Œæˆ‘ä»¬å¯ä»¥ä»å°åˆ°å¤§æšä¸¾ [2,x-1] ä¸­çš„æ¯ä¸ªæ•° yï¼Œåˆ¤æ–­ y æ˜¯å¦ä¸º x çš„å› æ•°ã€‚ä½†è¿™æ ·åˆ¤æ–­ä¸€ä¸ªæ•°æ˜¯å¦ä¸ºè´¨æ•°çš„æ—¶é—´å¤æ‚åº¦æœ€å·®æƒ…å†µä¸‹ä¼šåˆ° O(n)ï¼Œæ— æ³•é€šè¿‡æ‰€æœ‰æµ‹è¯•æ•°æ®ã€‚</p><p>è€ƒè™‘åˆ°å¦‚æœ y æ˜¯ x çš„å› æ•°ï¼Œé‚£ä¹ˆ x/y ä¹Ÿå¿…ç„¶æ˜¯x çš„å› æ•°ï¼Œå› æ­¤æˆ‘ä»¬åªè¦æ ¡éªŒ y æˆ–è€… x/y ã€‚ä¸éš¾å‘ç°æˆ‘ä»¬åªéœ€è¦æšä¸¾ [2,$\sqrt{x}$]å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">countPrimes</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        ans += isPrime(i) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isPrime</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>; i * i &lt;= x; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (x % i == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤æ‚åº¦åˆ†æï¼š</p><ul><li><p>æ—¶é—´å¤æ‚åº¦O(n$\sqrt{n}$)ã€‚å•ä¸ªæ•°æ£€æŸ¥çš„æ—¶é—´å¤æ‚åº¦ä¸ºO($\sqrt{n}$)ï¼Œä¸€å…±è¦æ£€æŸ¥nä¸ªæ•°ã€‚</p></li><li><p>ç©ºé—´å¤æ‚åº¦O(1)</p></li></ul><hr><hr><h2 id="åŸƒæ°ç­›">åŸƒæ°ç­›</h2><p>æšä¸¾æ²¡æœ‰è€ƒè™‘åˆ°æ•°ä¸æ•°çš„å…³è”æ€§ï¼Œå› æ­¤éš¾ä»¥å†ç»§ç»­ä¼˜åŒ–æ—¶é—´å¤æ‚åº¦ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç»ä¸€ä¸ªå¸¸è§çš„ç®—æ³•ï¼Œè¯¥ç®—æ³•ç”±å¸Œè…Šæ•°å­¦å®¶å„æ‹‰å¤šå¡æå‡ºï¼Œç§°ä¸ºå„æ‹‰å¤šå¡ç­›æ³•ï¼Œç®€ç§°åŸƒæ°ç­›ã€‚</p><p>æˆ‘ä»¬è€ƒè™‘è¿™æ ·ä¸€ä¸ªäº‹å®ï¼šå¦‚æœ x æ˜¯è´¨æ•°ï¼Œé‚£ä¹ˆå¤§äº x çš„ x çš„å€æ•° 2x,3x,â€¦ ä¸€å®šä¸æ˜¯è´¨æ•°ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä»è¿™é‡Œå…¥æ‰‹ã€‚</p><p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ•°ç»„ isPrime[n] , å…¶ä¸­ isPrime[i] è¡¨ç¤ºæ•° i æ˜¯ä¸æ˜¯è´¨æ•°ã€‚å¦‚æœæ˜¯è´¨æ•°åˆ™ä¸º 0 ï¼Œå¦åˆ™ä¸º 1 ã€‚</p><p>ä»å°åˆ°å¤§éå†æ¯ä¸ªæ•°ï¼Œå¦‚æœè¿™ä¸ªæ•°ä¸ºè´¨æ•°ï¼Œåˆ™å°†å…¶æ‰€æœ‰å€æ•°éƒ½æ ‡è®°ä¸ºåˆæ•°ï¼ˆé™¤äº†è¯¥è´¨æ•°æœ¬èº«ï¼‰ï¼Œè¿™æ ·åœ¨è¿è¡Œç»“æŸçš„æ—¶å€™æˆ‘ä»¬å°±èƒ½çŸ¥é“è´¨æ•°çš„ä¸ªæ•°ã€‚</p><p>å½“ç„¶è¿™é‡Œè¿˜å¯ä»¥ç»§ç»­ä¼˜åŒ–ï¼Œå¯¹äºä¸€ä¸ªè´¨æ•° xï¼Œå¦‚æœæŒ‰ä¸Šæ–‡è¯´çš„æˆ‘ä»¬ä» 2x å¼€å§‹æ ‡è®°å…¶å®æ˜¯å†—ä½™çš„ï¼Œåº”è¯¥ç›´æ¥ä» xâ‹…x å¼€å§‹æ ‡è®°ï¼Œå› ä¸º 2x,3x,â€¦è¿™äº›æ•°ä¸€å®šåœ¨ x ä¹‹å‰å°±è¢«å…¶ä»–æ•°çš„å€æ•°æ ‡è®°è¿‡äº†ï¼Œä¾‹å¦‚ 2 çš„æ‰€æœ‰å€æ•°ï¼Œ3 çš„æ‰€æœ‰å€æ•°ç­‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">countPrimes</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="type">int</span>[] isPrime = <span class="keyword">new</span> <span class="title class_">int</span>[n + <span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isPrime[i] == <span class="number">0</span>) &#123;</span><br><span class="line">            ans += <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> ((<span class="type">long</span>) i * i &lt;= n) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i * i; j &lt;= n; j += i) &#123;</span><br><span class="line">                    isPrime[j] = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤æ‚åº¦åˆ†æï¼š</p><ul><li>æ—¶é—´å¤æ‚åº¦O(nloglog n)ã€‚</li><li>ç©ºé—´å¤æ‚åº¦O(n)</li></ul><hr><hr><h2 id="çº¿æ€§ç­›">çº¿æ€§ç­›</h2><p>åŸƒæ°ç­›å…¶å®è¿˜æ˜¯å­˜åœ¨å†—ä½™çš„æ ‡è®°æ“ä½œï¼Œæ¯”å¦‚å¯¹äº 45 è¿™ä¸ªæ•°ï¼Œå®ƒä¼šåŒæ—¶è¢« 3,5 ä¸¤ä¸ªæ•°æ ‡è®°ä¸ºåˆæ•°ï¼Œå› æ­¤æˆ‘ä»¬ä¼˜åŒ–çš„ç›®æ ‡æ˜¯è®©æ¯ä¸ªåˆæ•°åªè¢«æ ‡è®°ä¸€æ¬¡ï¼Œè¿™æ ·æ—¶é—´å¤æ‚åº¦å³èƒ½ä¿è¯ä¸º O(n)ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦ä»‹ç»çš„çº¿æ€§ç­›ã€‚</p><p>ç›¸è¾ƒäºåŸƒæ°ç­›ï¼Œæˆ‘ä»¬å¤šç»´æŠ¤ä¸€ä¸ª primes æ•°ç»„è¡¨ç¤ºå½“å‰å¾—åˆ°çš„è´¨æ•°é›†åˆã€‚æˆ‘ä»¬ä»å°åˆ°å¤§éå†ï¼Œå¦‚æœå½“å‰çš„æ•° x æ˜¯è´¨æ•°ï¼Œå°±å°†å…¶åŠ å…¥ primes æ•°ç»„ã€‚</p><p>å¦ä¸€ç‚¹ä¸åŸƒæ°ç­›ä¸åŒçš„æ˜¯ï¼Œã€Œæ ‡è®°è¿‡ç¨‹ã€ä¸å†ä»…å½“ x ä¸ºè´¨æ•°æ—¶æ‰è¿›è¡Œï¼Œè€Œæ˜¯å¯¹æ¯ä¸ªæ•´æ•° x éƒ½è¿›è¡Œã€‚å¯¹äºæ•´æ•° xï¼Œæˆ‘ä»¬ä¸å†æ ‡è®°å…¶æ‰€æœ‰çš„å€æ•° xâ‹…x,xâ‹…(x+1),â€¦ï¼Œè€Œæ˜¯åªæ ‡è®°è´¨æ•°é›†åˆä¸­çš„æ•°ä¸ x ç›¸ä¹˜çš„æ•°ï¼Œå³ xâ‹…primes[0], xâ‹…primes[1] â€¦ ï¼Œä¸”åœ¨å‘ç° x mod primes[i] = 0 çš„æ—¶å€™ç»“æŸå½“å‰æ ‡è®°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">countPrimes</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    List&lt;Integer&gt; primes = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">int</span>[] isPrime = <span class="keyword">new</span> <span class="title class_">int</span>[n + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isPrime[i] == <span class="number">0</span>) &#123;</span><br><span class="line">            primes.add(i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> prime : primes) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i * prime &gt; n) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            isPrime[i * prime] = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (i % prime == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> primes.size();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="é¢„å¤„ç†è´¨æ•°">é¢„å¤„ç†è´¨æ•°</h2><p>åœ¨æœ‰äº›é¢˜ç›®ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é¢„å¤„ç†è´¨æ•°ï¼Œçœå»ä¸€äº›é‡å¤è®¡ç®—ã€‚</p><div class="tabs" id="c23a3bbc-d05e-4e05-abcf-62948c072c4e"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c23a3bbc-d05e-4e05-abcf-62948c072c4e-1"><i class="fas fa-cat"></i>åŸƒæ°ç­›é¢„å¤„ç†</button></li><li class="tab"><button type="button" data-href="#c23a3bbc-d05e-4e05-abcf-62948c072c4e-2"><i class="fas fa-horse"></i>çº¿æ€§ç­›é¢„å¤„ç†</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c23a3bbc-d05e-4e05-abcf-62948c072c4e-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MX</span> <span class="operator">=</span> (<span class="type">int</span>) <span class="number">1e6</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> ArrayList&lt;Integer&gt; primes = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="comment">// 0 è¡¨ç¤ºæ˜¯è´¨æ•° 1 è¡¨ç¤ºæ˜¯åˆæ•°</span></span><br><span class="line">    <span class="type">int</span>[] isPrime = <span class="keyword">new</span> <span class="title class_">int</span>[MX + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>; i &lt;= MX; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isPrime[i] == <span class="number">0</span>) &#123;</span><br><span class="line">            primes.add(i);</span><br><span class="line">            <span class="keyword">if</span> ((<span class="type">long</span>) i * i &lt;= MX) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i * i; j &lt;= MX; j += i) &#123;</span><br><span class="line">                    isPrime[j] = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c23a3bbc-d05e-4e05-abcf-62948c072c4e-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MX</span> <span class="operator">=</span> (<span class="type">int</span>) <span class="number">1e6</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> ArrayList&lt;Integer&gt; primes = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="comment">// 0 è¡¨ç¤ºæ˜¯è´¨æ•° 1 è¡¨ç¤ºæ˜¯åˆæ•°</span></span><br><span class="line">    <span class="type">int</span>[] isPrime = <span class="keyword">new</span> <span class="title class_">int</span>[MX + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>; i &lt;= MX; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isPrime[i] == <span class="number">0</span>) &#123;</span><br><span class="line">            primes.add(i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> prime : primes) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i * prime &gt; MX) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            isPrime[i * prime] = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (i % prime == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>]]></content>
    
    
    <summary type="html">æšä¸¾ã€åŸƒæ°ç­›ã€çº¿æ€§ç­›</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>å¹¶æŸ¥é›†</title>
    <link href="https://wuwawawa.github.io/posts/c517589e.html"/>
    <id>https://wuwawawa.github.io/posts/c517589e.html</id>
    <published>2023-09-14T01:33:46.000Z</published>
    <updated>2023-09-14T02:33:18.372Z</updated>
    
    <content type="html"><![CDATA[<h2 id="åŸºæœ¬åŸç†">åŸºæœ¬åŸç†</h2><p>å¹¶æŸ¥é›†æ˜¯ä¸€ç§ç”¨äºç®¡ç†å…ƒç´ æ‰€å±é›†åˆçš„æ•°æ®ç»“æ„ï¼Œå®ç°ä¸ºä¸€ä¸ªæ£®æ—ï¼Œå…¶ä¸­æ¯æ£µæ ‘è¡¨ç¤ºä¸€ä¸ªé›†åˆï¼Œæ ‘ä¸­çš„èŠ‚ç‚¹è¡¨ç¤ºå¯¹åº”é›†åˆä¸­çš„å…ƒç´ ã€‚</p><p>é¡¾åæ€ä¹‰ï¼Œå¹¶æŸ¥é›†æ”¯æŒä¸¤ç§æ“ä½œï¼š</p><ul><li>åˆå¹¶(Union)ï¼šåˆå¹¶ä¸¤ä¸ªå…ƒç´ æ‰€å±é›†åˆï¼ˆåˆå¹¶å¯¹åº”çš„æ ‘ï¼‰</li><li>æŸ¥è¯¢(Find)ï¼šæŸ¥è¯¢æŸä¸ªå…ƒç´ æ‰€å±é›†åˆï¼ˆæŸ¥è¯¢å¯¹åº”çš„æ ‘çš„æ ¹èŠ‚ç‚¹ï¼‰ï¼Œè¿™å¯ä»¥ç”¨äºåˆ¤æ–­ä¸¤ä¸ªå…ƒç´ æ˜¯å¦å±äºåŒä¸€é›†åˆ</li></ul><hr><hr><h2 id="å‡½æ•°æ¨¡ç‰ˆ">å‡½æ•°æ¨¡ç‰ˆ</h2><p>è¿ç”¨ä»¥ä¸‹è¿™ä¸‰ä¸ªå‡½æ•°å¯ä»¥æ„å»ºå¹¶æŸ¥é›†ç®—æ³•çš„åŸºæœ¬æ¡†æ¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnionFind</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span>[] parent;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> N;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å¹¶æŸ¥é›†çš„çˆ¶èŠ‚ç‚¹æ•°ç»„ï¼Œå°†æ¯ä¸ªå…ƒç´ çš„çˆ¶èŠ‚ç‚¹éƒ½åˆå§‹åŒ–ä¸ºè‡ªå·±</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UnionFind</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        N = n;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            parent[i] = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†å…ƒç´ xå’Œå…ƒç´ yæ‰€åœ¨çš„é›†åˆåˆå¹¶æˆä¸€ä¸ªé›†åˆã€‚</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">union</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">pra</span> <span class="operator">=</span> find(a);</span><br><span class="line">        <span class="type">int</span> <span class="variable">prb</span> <span class="operator">=</span> find(b);</span><br><span class="line">        <span class="keyword">if</span> (pra &lt; prb)</span><br><span class="line">            parent[prb] = pra;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            parent[pra] = prb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾å…ƒç´ xçš„çˆ¶èŠ‚ç‚¹ï¼Œåˆ¤æ–­å…ƒç´ xå±äºå“ªä¸ªé›†åˆ</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">find</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (parent[x] != x) &#123;</span><br><span class="line">            x = parent[x];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">å¹¶æŸ¥é›†</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>å¤§æ•°è¿ç®—</title>
    <link href="https://wuwawawa.github.io/posts/8878d18a.html"/>
    <id>https://wuwawawa.github.io/posts/8878d18a.html</id>
    <published>2023-09-09T05:44:29.000Z</published>
    <updated>2023-09-14T01:35:39.055Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¤§æ•°ç›¸åŠ ">å¤§æ•°ç›¸åŠ </h2><p>ç®—æ³•æµç¨‹ï¼š è®¾å®š iï¼Œj ä¸¤æŒ‡é’ˆåˆ†åˆ«æŒ‡å‘ num1ï¼Œnum2 å°¾éƒ¨ï¼Œæ¨¡æ‹Ÿäººå·¥åŠ æ³•ï¼›</p><p>è®¡ç®—è¿›ä½ï¼š è®¡ç®— carry = tmp // 10ï¼Œä»£è¡¨å½“å‰ä½ç›¸åŠ æ˜¯å¦äº§ç”Ÿè¿›ä½ï¼›</p><p>æ·»åŠ å½“å‰ä½ï¼š è®¡ç®— tmp = n1 + n2 + carryï¼Œå¹¶å°†å½“å‰ä½ tmp % 10 æ·»åŠ è‡³ res å¤´éƒ¨ï¼›</p><p>ç´¢å¼•æº¢å‡ºå¤„ç†ï¼š å½“æŒ‡é’ˆ iæˆ–j èµ°è¿‡æ•°å­—é¦–éƒ¨åï¼Œç»™ n1ï¼Œn2 èµ‹å€¼ä¸º 0ï¼Œç›¸å½“äºç»™ num1ï¼Œnum2 ä¸­é•¿åº¦è¾ƒçŸ­çš„æ•°å­—å‰é¢å¡« 0ï¼Œä»¥ä¾¿åç»­è®¡ç®—ã€‚</p><p>å½“éå†å®Œ num1ï¼Œnum2 åè·³å‡ºå¾ªç¯ï¼Œå¹¶æ ¹æ® carry å€¼å†³å®šæ˜¯å¦åœ¨å¤´éƒ¨æ·»åŠ è¿›ä½ 1ï¼Œæœ€ç»ˆè¿”å› res å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">addStrings</span><span class="params">(String num1, String num2)</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> num1.length() - <span class="number">1</span>, j = num2.length() - <span class="number">1</span>, carry = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &gt;= <span class="number">0</span> || j &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n1</span> <span class="operator">=</span> i &gt;= <span class="number">0</span> ? num1.charAt(i) - <span class="string">&#x27;0&#x27;</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n2</span> <span class="operator">=</span> j &gt;= <span class="number">0</span> ? num2.charAt(j) - <span class="string">&#x27;0&#x27;</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">tmp</span> <span class="operator">=</span> n1 + n2 + carry;</span><br><span class="line">        res.append(tmp % <span class="number">10</span>);</span><br><span class="line">        carry = tmp / <span class="number">10</span>;</span><br><span class="line">        i--;</span><br><span class="line">        j--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (carry == <span class="number">1</span>) &#123;</span><br><span class="line">        res.append(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.reverse().toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="å¤§æ•°ç›¸ä¹˜">å¤§æ•°ç›¸ä¹˜</h2><p>å¦‚æœ <code>num1</code> å’Œ <code>num2</code> ä¹‹ä¸€æ˜¯0 ï¼Œåˆ™ç›´æ¥å°†0ä½œä¸ºç»“æœè¿”å›å³å¯ã€‚</p><p>å¦‚æœ <code>num1</code> å’Œ <code>num2</code> éƒ½ä¸æ˜¯0ï¼Œåˆ™å¯ä»¥ç”¨è¿‡æ¨¡æ‹Ÿã€Œç«–å¼ä¹˜æ³•ã€çš„æ–¹æ³•è®¡ç®—ä¹˜ç§¯ã€‚ä»å³å¾€å·¦éå†ä¹˜æ•°ï¼Œå°†ä¹˜æ•°çš„æ¯ä¸€ä½ä¸è¢«ä¹˜æ•°ç›¸ä¹˜å¾—åˆ°å¯¹åº”çš„ç»“æœï¼Œå†å°†æ¯æ¬¡å¾—åˆ°çš„ç»“æœè¿›è¡Œç´¯åŠ ã€‚</p><p>è¿™é“é¢˜ä¸­ï¼Œè¢«ä¹˜æ•°æ˜¯ <code>nums1</code> ,ä¹˜æ•°æ˜¯ <code>num2</code>ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>num2</code> é™¤äº†æœ€ä½ä½ä»¥å¤–ï¼Œå…¶ä½™çš„æ¯ä¸€ä½çš„è¿ç®—ç»“æœéƒ½éœ€è¦è¡¥ 0ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/sol1.png" alt="fig1" style="zoom:48%;" /><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">multiply</span><span class="params">(String num1, String num2)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (num1.equals(<span class="string">&quot;0&quot;</span>) || num2.equals(<span class="string">&quot;0&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len1</span> <span class="operator">=</span> num1.length(), len2 = num2.length();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> len2 - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">curProduct</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¡¥0</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> len2 - <span class="number">1</span>; j &gt; i; j--) &#123;</span><br><span class="line">            curProduct.append(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">curNum2</span> <span class="operator">=</span> num2.charAt(i) - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">carry</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç”¨ curNum å»ä¹˜ num1</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> len1 - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">curNum1</span> <span class="operator">=</span> num1.charAt(j) - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">product</span> <span class="operator">=</span> curNum1 * curNum2 + carry;</span><br><span class="line"></span><br><span class="line">            curProduct.append(product % <span class="number">10</span>);</span><br><span class="line">            carry /= <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ans = addStrings(ans,curProduct.reverse().toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">addStrings</span><span class="params">(String num1, String num2)</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> num1.length() - <span class="number">1</span>, j = num2.length() - <span class="number">1</span>, carry = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &gt;= <span class="number">0</span> || j &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n1</span> <span class="operator">=</span> i &gt;= <span class="number">0</span> ? num1.charAt(i) - <span class="string">&#x27;0&#x27;</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n2</span> <span class="operator">=</span> j &gt;= <span class="number">0</span> ? num2.charAt(j) - <span class="string">&#x27;0&#x27;</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">tmp</span> <span class="operator">=</span> n1 + n2 + carry;</span><br><span class="line">        res.append(tmp % <span class="number">10</span>);</span><br><span class="line">        carry = tmp / <span class="number">10</span>;</span><br><span class="line">        i--;</span><br><span class="line">        j--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (carry == <span class="number">1</span>) &#123;</span><br><span class="line">        res.append(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.reverse().toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="å¤§æ•°ç›¸å‡">å¤§æ•°ç›¸å‡</h2><p>1ã€æ‰§è¡Œè®¡ç®—å‰é¦–å…ˆæ¯”è¾ƒå‡æ•°(num1)å’Œè¢«å‡æ•°(num2)çš„å¤§å°ï¼Œå¦‚æœnum1&gt;num2,é‚£ä¹ˆå°±æ¨¡æ‹Ÿnum1-num2çš„è¿‡ç¨‹ï¼Œå¦‚æœnum1&lt;num2ï¼Œé‚£ä¹ˆç»“æœå°±ä¸º-(num2-num1) ã€‚å½“ç„¶å¯ä»¥ä¸ºäº†ç¨³å®šæ¨¡æ‹Ÿæ—¶å€™ä¸€ä¸ªå¤§ä¸€ä¸ªå°ï¼Œå¯å°†num1å§‹ç»ˆæŒ‡å‘è¾ƒå¤§çš„é‚£ä¸ªæ•°ï¼Œå°‘å†™ä¸€ä¸ªif/else.</p><p>2ã€åœ¨æ¯”è¾ƒä¸¤ä¸ªæ•°å­—å¤§å°çš„æ—¶å€™ï¼Œå› ä¸ºæ˜¯å­—ç¬¦å½¢å¼ï¼Œé¦–å…ˆæ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œé•¿çš„é‚£ä¸ªæ›´å¤§çŸ­çš„é‚£ä¸ªæ›´å°ï¼Œå¦‚æœä¸¤ä¸ªå­—ç¬¦ä¸²ç­‰å¤§ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡å­—å…¸åºä»å‰å¾€åè¿›è¡Œæ¯”è¾ƒ(Javaå¯ç›´æ¥ä½¿ç”¨compareToæ–¹æ³•)ã€‚</p><p>3ã€å’ŒåŠ æ³•ä¸åŒçš„æ˜¯ï¼Œå‡æ³•å‰é¢å¯èƒ½äº§ç”Ÿè‹¥å¹²å‰ç¼€0ï¼Œè¿™äº›0æ˜¯éœ€è¦ä½ å»æ‰çš„ï¼Œä¾‹å¦‚&quot;1100&quot;-â€œ1000&quot;è®¡ç®—å¾—åˆ°çš„ç»“æœä¸º&quot;0100â€,ä½ å°±è¦æŠŠå‰é¢çš„0å»æ‰è¿”å›&quot;100&quot;ã€‚</p><p>4ã€å…·ä½“å®ç°çš„æ—¶å€™å’ŒåŠ æ³•ç›¸ä¼¼ï¼Œå¦‚æœä½¿ç”¨StringBuilderå­˜å‚¨ï¼Œéœ€è¦é€†ç½®é¡ºåºï¼Œå¦‚æœæ˜¯ä¸ªè´Ÿæ•°ï¼Œå‰é¢è¿˜è¦åŠ ä¸Šâ€™-'.</p><p>5ã€æ¯ä¸ªä½ç½®æ­£å¸¸è¿›è¡Œå‡æ³•è¿ç®—ï¼Œå¦‚æœå€¼å°äº0ï¼Œé‚£ä¹ˆå°±éœ€è¦å‘ä¸Šå€Ÿä½(+10),é‚£ä¹ˆå¤„ç†ä¸Šä¸€ä½è¿›è¡Œå‡æ³•æ—¶å€™è¿˜è¦å°†å€Ÿä½çš„å¤„ç†ä¸€ä¸‹ã€‚</p><img src="https://ask.qcloudimg.com/http-save/yehe-4372098/mlwn6ygdwd.png" alt="img" style="zoom: 67%;" /><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">compare</span><span class="params">(String num1, String num2)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (num1.length() &lt; num2.length())</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (num1.length() &gt; num2.length())</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> num1.compareTo(num2) &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">subtractString</span><span class="params">(String num1, String num2)</span> &#123;</span><br><span class="line">    <span class="type">char</span> <span class="variable">sign</span> <span class="operator">=</span> <span class="string">&#x27;+&#x27;</span>;<span class="comment">//æ­£è´Ÿå·</span></span><br><span class="line">    <span class="comment">//è®©num1&gt;num2 å¦‚æœnum1&lt;num2 é‚£ä¹ˆç»“æœå°±æ˜¯â€”(num2-num1)</span></span><br><span class="line">    <span class="comment">//å¯ä»¥å…ˆå°†num1å’Œnum2äº¤æ¢å’Œå‰é¢æƒ…å†µç»Ÿä¸€</span></span><br><span class="line">    <span class="keyword">if</span> (!compare(num1, num2)) &#123;</span><br><span class="line">        sign = <span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">team</span> <span class="operator">=</span> num2;</span><br><span class="line">        num2 = num1;</span><br><span class="line">        num1 = team;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> num1.length() - <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> num2.length() - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">borrow</span> <span class="operator">=</span> <span class="number">0</span>;<span class="comment">//å€Ÿä½</span></span><br><span class="line">    <span class="keyword">while</span> (i &gt;= <span class="number">0</span> || j &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n1</span> <span class="operator">=</span> i &gt;= <span class="number">0</span> ? (num1.charAt(i) - <span class="string">&#x27;0&#x27;</span>) : <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n2</span> <span class="operator">=</span> j &gt;= <span class="number">0</span> ? (num2.charAt(j) - <span class="string">&#x27;0&#x27;</span>) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> n1 - n2 - borrow;</span><br><span class="line">        borrow = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (num &lt; <span class="number">0</span>)<span class="comment">//éœ€è¦å‘å‰å€Ÿä½</span></span><br><span class="line">        &#123;</span><br><span class="line">            borrow = <span class="number">1</span>;</span><br><span class="line">            num += <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        i--;</span><br><span class="line">        j--;</span><br><span class="line">        sb.append(num);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sb = sb.reverse();<span class="comment">//éœ€è¦å…ˆç¿»è½¬</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;<span class="comment">//å»æ‰å‰é¢æ²¡ç”¨çš„â€™0â€˜</span></span><br><span class="line">    <span class="keyword">while</span> (index &lt; sb.length() &amp;&amp; sb.charAt(index) == <span class="string">&#x27;0&#x27;</span>) &#123;</span><br><span class="line">        index++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœä¸¤ä¸ªæ•°ç›¸åŒ ç›´æ¥è¿”å›&quot;0&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (index == sb.length())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (sign == <span class="string">&#x27;+&#x27;</span>)<span class="comment">//å¦‚æœæ­£æ•°</span></span><br><span class="line">        <span class="keyword">return</span> sb.substring(index);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> sign + sb.substring(index);<span class="comment">//è´Ÿæ•°éœ€è¦è¿”å›</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="å¤§æ•°ç›¸é™¤">å¤§æ•°ç›¸é™¤</h2><p>å¯¹äºå¤§æ•°a/bï¼Œä¸€èˆ¬æœ€å¤šè¦æ±‚æ±‚åˆ°å…¶æ•´æ•°è§£æˆ–è€…ä½™æ•°ï¼Œå³a/b=câ€¦â€¦dï¼ˆa,b,c,då‡ä¸ºæ•´ï¼‰;ä¹Ÿå°±æ˜¯<strong>aé‡Œé¢æœ‰cä¸ªb</strong>ï¼Œå¹¶ä¸”è¿˜å‰©ä¸‹dã€‚æ ¸å¿ƒæ˜¯å…ˆæ±‚cæ˜¯å¤šå°‘ï¼Œå¯¹äºç¨‹åºæ¥è¯´ï¼Œå¯ä»¥é€šè¿‡æšä¸¾å•Šï¼Œå°†é™¤æ³•å˜æˆå‡æ³•ï¼Œä»aä¸­ä¸æ–­å‡dï¼Œä¸€ç›´åˆ°ä¸èƒ½å‡ä¸ºæ­¢ã€‚</p><p>ä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœè¢«é™¤æ•°aå¾ˆå¤§å¾ˆå¤§ï¼Œå¯èƒ½æœ‰å±…å¤šä¸ªbï¼Œé‚£ä¹ˆè¿™æ ·æ—¶é—´å¤æ‚åº¦å¤ªé«˜äº†ï¼Œä¸å¯èƒ½æ‰§è¡Œé‚£ä¹ˆå¤šæ¬¡ï¼Œé‚£ä¹ˆéœ€è¦æ€ä¹ˆæ ·å»ä¼˜åŒ–è¿™ä¸ªæ–¹æ³•å‘¢ï¼Ÿ</p><p>é‚£å°±è¦åŠ é€Ÿå¯»æ‰¾æ¬¡æ•°ï¼Œå‡å°‘è¿™ä¸ªå‡æ³•çš„æ¬¡æ•°äº†ï¼Œå‡æ³•æ¬¡æ•°å‡å°çš„ä¸€ä¸ªæœ€å¥½æ–¹æ¡ˆå°±æ˜¯èƒ½ä¸èƒ½<strong>æ‰©å¤§é™¤æ•°b</strong>ã€‚å¦‚æœbåé¢åŠ ä¸ª<code>'0'</code>ï¼Œé‚£ä¹ˆç®—å‡ºæ¥çš„ç»“æœå°±ä¹˜ä»¥10ï¼Œå‡æ³•çš„æ¬¡æ•°å˜æˆåŸæ¥ååˆ†ä¹‹ä¸€ã€‚æ ¹æ®è¿™ä¸ªæ€æƒ³æˆ‘ä»¬å¯ä»¥ä¸€ç›´æ¯æ¬¡æ‰¾åˆ°bçš„æœ€å¤§10çš„å€æ•°(å°äºa)è®¡ç®—å‡çš„æ¬¡æ•°å†æ¢ç®—æˆå‡bçš„æ€»è¯æ•°ï¼Œå°†ç»“æœè¦ä»¥å­—ç¬¦ä¸²æ–¹å¼ä¿ç•™ï¼Œåé¢ä¸€ç›´è¿­ä»£åˆ°æœ€åä¸ºæ­¢,è¿™è™½ç„¶æ˜¯ä¸€é“é™¤æ³•è¿ç®—çš„é¢˜ï¼Œä½†æ˜¯ä¹Ÿè•´å«å‡æ³•å’ŒåŠ æ³•(æ¬¡æ•°å åŠ åˆ°ç»“æœä¸­)ã€‚</p>]]></content>
    
    
    <summary type="html">å¤§æ•°ç›¸åŠ ã€å¤§æ•°ç›¸å‡ã€å¤§æ•°ç›¸ä¹˜ã€</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>é™æµç®—æ³•</title>
    <link href="https://wuwawawa.github.io/posts/32609cb8.html"/>
    <id>https://wuwawawa.github.io/posts/32609cb8.html</id>
    <published>2023-09-02T05:04:36.000Z</published>
    <updated>2023-09-02T07:37:52.667Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å›ºå®šçª—å£ç®—æ³•">å›ºå®šçª—å£ç®—æ³•</h2><h3 id="å®ç°åŸç†">å®ç°åŸç†</h3><p>å›ºå®šçª—å£é™æµç®—æ³•ï¼Œä¹Ÿå«<span class='p green'>è®¡æ•°å™¨é™æµç®—æ³•</span>ï¼Œæ˜¯æœ€ç®€å•çš„ä¸€ç§é™æµç®—æ³•ã€‚</p><p><strong>å®ç°åŸç†æ˜¯ï¼š</strong> åœ¨ä¸€ä¸ªå›ºå®šé•¿åº¦çš„æ—¶é—´çª—å£å†…é™åˆ¶è¯·æ±‚æ•°é‡ï¼Œæ¯æ¥ä¸€ä¸ªè¯·æ±‚ï¼Œè¯·æ±‚æ¬¡æ•°åŠ ä¸€ï¼Œå¦‚æœè¯·æ±‚æ•°é‡è¶…è¿‡æœ€å¤§é™åˆ¶ï¼Œå°±æ‹’ç»è¯¥è¯·æ±‚ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230902132700830.png" alt="image-20230902132700830" style="zoom: 50%;" /><hr><h3 id="ä»£ç å®ç°">ä»£ç å®ç°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å›ºå®šçª—å£é™æµ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FixWindowLimiter</span> <span class="keyword">implements</span> <span class="title class_">Limiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">threshold</span> <span class="operator">=</span> <span class="number">10L</span>; <span class="comment">// æ¯ä¸ªçª—å£çš„æœ€å¤§è¯·æ±‚æ•°é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">windowUnit</span> <span class="operator">=</span> <span class="number">1000L</span>; <span class="comment">// çª—å£å¤§å°ï¼Œå•ä½ms</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">reqCount</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// çª—å£å†…çš„å½“å‰è¯·æ±‚æ•°é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">lastTime</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// çª—å£å¼€å§‹æ—¶é—´</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é™æµæ–¹æ³•ï¼Œè¿”å›trueè¡¨ç¤ºé™æµ</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> Boolean <span class="title function_">limit</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰æ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦åœ¨å½“å‰æ—¶é—´çª—å£å†…ï¼Œå¦‚æœä¸åœ¨å°±å¼€å¯ä¸€ä¸ªæ–°çš„æ—¶é—´çª—å£</span></span><br><span class="line">        <span class="keyword">if</span> (currentTime - lastTime &gt; windowUnit) &#123;</span><br><span class="line">            <span class="comment">// é‡ç½®è®¡æ•°å™¨</span></span><br><span class="line">            reqCount = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// å¼€å¯æ–°çª—å£</span></span><br><span class="line">            lastTime = currentTime;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// // åˆ¤æ–­æ˜¯å¦è¶…è¿‡æœ€å¤§è¯·æ±‚é‡</span></span><br><span class="line">        <span class="keyword">if</span> (reqCount &lt; threshold) &#123;</span><br><span class="line">            reqCount++;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="ä¼˜ç¼ºç‚¹">ä¼˜ç¼ºç‚¹</h3><p><strong>ä¼˜ç‚¹ï¼š</strong> å®ç°ç®€å•ï¼Œå®¹æ˜“ç†è§£ã€‚</p><p><strong>ç¼ºç‚¹ï¼š</strong></p><ol><li>é™æµä¸å¤Ÿå¹³æ»‘ã€‚ä¾‹å¦‚ï¼šé™æµæ˜¯æ¯ç§’3ä¸ªï¼Œåœ¨ç¬¬ä¸€æ¯«ç§’å‘é€äº†3ä¸ªè¯·æ±‚ï¼Œè¾¾åˆ°é™æµï¼Œçª—å£å‰©ä½™æ—¶é—´çš„è¯·æ±‚éƒ½å°†ä¼šè¢«æ‹’ç»ï¼Œä½“éªŒä¸å¥½ã€‚</li><li>æ— æ³•å¤„ç†çª—å£è¾¹ç•Œé—®é¢˜ã€‚å› ä¸ºæ˜¯åœ¨æŸä¸ªæ—¶é—´çª—å£å†…è¿›è¡Œæµé‡æ§åˆ¶ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå‡ºç°çª—å£è¾¹ç•Œæ•ˆåº”ï¼Œå³åœ¨æ—¶é—´çª—å£çš„è¾¹ç•Œå¤„å¯èƒ½ä¼šæœ‰å¤§é‡çš„è¯·æ±‚è¢«å…è®¸é€šè¿‡ï¼Œä»è€Œå¯¼è‡´çªå‘æµé‡ã€‚</li></ol><p>ä¾‹å¦‚ï¼šé™æµæ˜¯æ¯ç§’3ä¸ªï¼Œåœ¨ç¬¬ä¸€ç§’çš„æœ€åä¸€æ¯«ç§’å‘é€äº†3ä¸ªè¯·æ±‚ï¼Œåœ¨ç¬¬äºŒç§’çš„ç¬¬ä¸€æ¯«ç§’åˆå‘é€äº†3ä¸ªè¯·æ±‚ã€‚åœ¨è¿™ä¸¤æ¯«ç±³å†…å¤„ç†äº†6ä¸ªè¯·æ±‚ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è§¦å‘é™æµã€‚å¦‚æœå‡ºç°çªå‘æµé‡ï¼Œå¯èƒ½ä¼šå‹å®æœåŠ¡å™¨ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230902134743416.png" alt="image-20230902134743416" style="zoom: 50%;" /><hr><hr><h2 id="æ»‘åŠ¨çª—å£ç®—æ³•">æ»‘åŠ¨çª—å£ç®—æ³•</h2><h3 id="å®ç°åŸç†-2">å®ç°åŸç†</h3><p>ä¸ºäº†è§£å†³å›ºå®šçª—å£ç®—æ³•ç»Ÿè®¡ç²¾åº¦å¤ªä½çš„é—®é¢˜ï¼Œå¼•å…¥äº†æ»‘åŠ¨çª—å£ç®—æ³•ã€‚åœ¨æ»‘åŠ¨çª—å£ç®—æ³•ä¸­ï¼Œçª—å£çš„èµ·æ­¢æ—¶é—´æ˜¯åŠ¨æ€çš„ï¼Œçª—å£çš„å¤§å°å›ºå®šã€‚è¿™ç§ç®—æ³•èƒ½å¤Ÿè¾ƒå¥½åœ°å¤„ç†çª—å£è¾¹ç•Œé—®é¢˜ï¼Œä½†æ˜¯å®ç°ç›¸å¯¹å¤æ‚ï¼Œéœ€è¦è®°å½•æ¯ä¸ªè¯·æ±‚çš„æ—¶é—´æˆ³ã€‚</p><p><strong>å®ç°åŸç†æ˜¯ï¼š</strong> æ¯æ¥ä¸€ä¸ªè¯·æ±‚ï¼Œå°±å‘åæ¨ä¸€ä¸ªæ—¶é—´çª—å£ï¼Œè®¡ç®—è¿™ä¸ªçª—å£å†…çš„è¯·æ±‚æ•°é‡ã€‚å¦‚æœè¯·æ±‚æ•°é‡è¶…è¿‡é™åˆ¶å°±æ‹’ç»è¯·æ±‚ï¼Œå¦åˆ™å°±å¤„ç†è¯·æ±‚ï¼Œå¹¶è®°å½•è¯·æ±‚çš„æ—¶é—´æˆ³ã€‚å¦å¤–è¿˜éœ€è¦ä¸€ä¸ªä»»åŠ¡æ¸…ç†è¿‡æœŸçš„æ—¶é—´æˆ³ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230902135306151.png" alt="image-20230902135306151" style="zoom:50%;" /><hr><h3 id="ä»£ç å®ç°-2">ä»£ç å®ç°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SlidingWindowLimiter</span> <span class="keyword">implements</span> <span class="title class_">Limiter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">threshold</span> <span class="operator">=</span> <span class="number">10</span>; <span class="comment">// æ¯ä¸ªçª—å£çš„æœ€å¤§è¯·æ±‚æ•°é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">windowUnit</span> <span class="operator">=</span> <span class="number">1000</span>; <span class="comment">// çª—å£å¤§å°ï¼Œ1000ms</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Long&gt; requestList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(); <span class="comment">//  è¯·æ±‚é›†åˆï¼Œç”¨æ¥å­˜å‚¨çª—å£å†…çš„è¯·æ±‚æ•°é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é™æµæ–¹æ³•ï¼Œè¿”å›trueè¡¨ç¤ºæ‹¦æˆª</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">limit</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–ç³»ç»Ÿå½“å‰æ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// ç»Ÿè®¡å½“å‰çª—å£å†…ï¼Œæœ‰æ•ˆçš„è¯·æ±‚æ•°é‡</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">sizeOfValid</span> <span class="operator">=</span> <span class="built_in">this</span>.sizeOfValid(currentTime);</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦è¶…è¿‡æœ€å¤§è¯·æ±‚æ•°é‡</span></span><br><span class="line">        <span class="keyword">if</span> (sizeOfValid &lt; threshold) &#123;</span><br><span class="line">            <span class="comment">// æŠŠå½“å‰è¯·æ±‚æ·»åŠ åˆ°è¯·æ±‚é›†åˆé‡Œ</span></span><br><span class="line">            requestList.add(currentTime);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç»Ÿè®¡å½“å‰çª—å£å†…ï¼Œæœ‰æ•ˆçš„è¯·æ±‚æ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">sizeOfValid</span><span class="params">(<span class="type">long</span> currentTime)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sizeOfValid</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Long requestTime : requestList) &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯å¦åœ¨å½“å‰æ—¶é—´çª—å£å†…</span></span><br><span class="line">            <span class="keyword">if</span> (currentTime - requestTime &lt;= windowUnit) &#123;</span><br><span class="line">                sizeOfValid++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sizeOfValid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¸…ç†è¿‡æœŸçš„è¯·æ±‚ï¼ˆå•ç‹¬å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å¤„ç†ï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">clean</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦è¶…å‡ºå½“å‰æ—¶é—´çª—å£å†…</span></span><br><span class="line">        requestList.removeIf(requestTime -&gt; System.currentTimeMillis() - requestTime &gt; windowUnit);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="ä¼˜ç¼ºç‚¹-2">ä¼˜ç¼ºç‚¹</h3><p><strong>ä¼˜ç‚¹ï¼š</strong> è§£å†³äº†å›ºå®šçª—å£ç®—æ³•çš„çª—å£è¾¹ç•Œé—®é¢˜ï¼Œé¿å…çªå‘æµé‡å‹å®æœåŠ¡å™¨ã€‚</p><p><strong>ç¼ºç‚¹ï¼š</strong> è¿˜æ˜¯å­˜åœ¨é™æµä¸å¤Ÿå¹³æ»‘çš„é—®é¢˜ã€‚ä¾‹å¦‚ï¼šé™æµæ˜¯æ¯ç§’3ä¸ªï¼Œåœ¨ç¬¬ä¸€æ¯«ç§’å‘é€äº†3ä¸ªè¯·æ±‚ï¼Œè¾¾åˆ°é™æµï¼Œå‰©ä½™çª—å£æ—¶é—´çš„è¯·æ±‚éƒ½å°†ä¼šè¢«æ‹’ç»ï¼Œä½“éªŒä¸å¥½ã€‚</p><hr><hr><h2 id="æ¼æ¡¶ç®—æ³•">æ¼æ¡¶ç®—æ³•</h2><h3 id="å®ç°åŸç†-3">å®ç°åŸç†</h3><p>æ¼æ¡¶é™æµç®—æ³•æ˜¯ä¸€ç§å¸¸ç”¨çš„æµé‡æ•´å½¢ï¼ˆTraffic Shapingï¼‰å’Œæµé‡æ§åˆ¶ï¼ˆTraffic Policingï¼‰çš„ç®—æ³•ï¼Œå®ƒå¯ä»¥æœ‰æ•ˆåœ°æ§åˆ¶æ•°æ®çš„ä¼ è¾“é€Ÿç‡ä»¥åŠé˜²æ­¢ç½‘ç»œæ‹¥å¡ã€‚</p><p>å®ç°åŸç†æ˜¯ï¼š</p><ol><li>ä¸€ä¸ªå›ºå®šå®¹é‡çš„æ¼æ¡¶ï¼ŒæŒ‰ç…§å›ºå®šé€Ÿç‡å‡ºæ°´ï¼ˆå¤„ç†è¯·æ±‚ï¼‰ï¼›</li><li>å½“æµå…¥æ°´ï¼ˆè¯·æ±‚æ•°é‡ï¼‰çš„é€Ÿåº¦è¿‡å¤§ä¼šç›´æ¥æº¢å‡ºï¼ˆè¯·æ±‚æ•°é‡è¶…è¿‡é™åˆ¶åˆ™ç›´æ¥æ‹’ç»ï¼‰ã€‚</li><li>æ¡¶é‡Œçš„æ°´ï¼ˆè¯·æ±‚ï¼‰ä¸å¤Ÿåˆ™æ— æ³•å‡ºæ°´ï¼ˆæ¡¶å†…æ²¡æœ‰è¯·æ±‚åˆ™ä¸å¤„ç†ï¼‰ã€‚</li></ol><p>å½“è¯·æ±‚æµé‡æ­£å¸¸æˆ–è€…è¾ƒå°çš„æ—¶å€™ï¼Œè¯·æ±‚èƒ½å¤Ÿå¾—åˆ°æ­£å¸¸çš„å¤„ç†ã€‚å½“è¯·æ±‚æµé‡è¿‡å¤§æ—¶ï¼Œæ¼æ¡¶é™æµç®—æ³•å¯ä»¥é€šè¿‡ä¸¢å¼ƒéƒ¨åˆ†è¯·æ±‚æ¥é˜²æ­¢ç³»ç»Ÿè¿‡è½½ã€‚</p><p>è¿™ç§ç®—æ³•çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§æ˜¯ï¼Œè¾“å‡ºæ•°æ®çš„é€Ÿç‡å§‹ç»ˆæ˜¯ç¨³å®šçš„ï¼Œæ— è®ºè¾“å…¥çš„æ•°æ®æµé‡å¦‚ä½•å˜åŒ–ã€‚è¿™å°±ç¡®ä¿äº†ç³»ç»Ÿçš„è´Ÿè½½ä¸ä¼šè¶…è¿‡é¢„è®¾çš„é˜ˆå€¼ã€‚ä½†æ˜¯ï¼Œç”±äºæ¼æ¡¶çš„å‡ºå£é€Ÿåº¦æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥æ— æ³•å¤„ç†çªå‘æµé‡ã€‚æ­¤å¤–ï¼Œå¦‚æœå…¥å£æµé‡è¿‡å¤§ï¼Œæ¼æ¡¶å¯èƒ½ä¼šæº¢å‡ºï¼Œå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230902144242297.png" alt="image-20230902144242297" style="zoom:50%;" /><hr><h3 id="ç®—æ³•å®ç°">ç®—æ³•å®ç°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeakyBucketLimiter</span> <span class="keyword">implements</span> <span class="title class_">Limiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">threshold</span> <span class="operator">=</span> <span class="number">100</span>; <span class="comment">// æ¡¶çš„æœ€å¤§å®¹é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">20</span>; <span class="comment">// æ¡¶å†…å½“å‰æ°´é‡(å½“å‰ç´¯è®¡çš„è¯·æ±‚æ•°)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">leakRate</span> <span class="operator">=</span> <span class="number">5</span>; <span class="comment">// æ¼æ°´é€Ÿç‡(æ¯ç§’ç³»ç»Ÿèƒ½å¤„ç†çš„è¯·æ±‚æ•°)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">lastLeakTime</span> <span class="operator">=</span> System.currentTimeMillis(); <span class="comment">// ä¸Šæ¬¡æ¼æ°´æ—¶é—´</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›trueï¼Œè¡¨ç¤ºé™æµ</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">limit</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨æ¼æ°´æ–¹æ³•</span></span><br><span class="line">        <span class="built_in">this</span>.leak();</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦è¶…è¿‡æœ€å¤§è¯·æ±‚æ•°é‡</span></span><br><span class="line">        <span class="keyword">if</span> (count &lt; threshold) &#123;</span><br><span class="line">            count++;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¼æ°´æ–¹æ³•ï¼Œè®¡ç®—å¹¶æ›´æ–°è¿™æ®µæ—¶é—´å†…æ¼æ°´é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">leak</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–ç³»ç»Ÿå½“å‰æ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// è®¡ç®—è¿™æ®µæ—¶é—´å†…ï¼Œéœ€è¦æµå‡ºçš„æ°´é‡</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">leakWater</span> <span class="operator">=</span> (currentTime - lastLeakTime) * leakRate / <span class="number">1000</span>;</span><br><span class="line">        count = Math.max(count - leakWater, <span class="number">0</span>);</span><br><span class="line">        lastLeakTime = currentTime;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="ä¼˜ç¼ºç‚¹-3">ä¼˜ç¼ºç‚¹</h3><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ol><li>**å¹³æ»‘æµé‡ã€‚**ç”±äºæ¼æ¡¶ç®—æ³•ä»¥å›ºå®šçš„é€Ÿç‡å¤„ç†è¯·æ±‚ï¼Œå¯ä»¥æœ‰æ•ˆåœ°å¹³æ»‘å’Œæ•´å½¢æµé‡ï¼Œé¿å…æµé‡çš„çªå‘å’Œæ³¢åŠ¨ï¼ˆç±»ä¼¼äºæ¶ˆæ¯é˜Ÿåˆ—çš„å‰Šå³°å¡«è°·çš„ä½œç”¨ï¼‰ã€‚</li><li>**é˜²æ­¢è¿‡è½½ã€‚**å½“æµå…¥çš„è¯·æ±‚è¶…è¿‡æ¡¶çš„å®¹é‡æ—¶ï¼Œå¯ä»¥ç›´æ¥ä¸¢å¼ƒè¯·æ±‚ï¼Œé˜²æ­¢ç³»ç»Ÿè¿‡è½½ã€‚</li></ol><p><strong>ç¼ºç‚¹ï¼š</strong></p><ol><li><strong>æ— æ³•å¤„ç†çªå‘æµé‡</strong>ï¼šç”±äºæ¼æ¡¶çš„å‡ºå£é€Ÿåº¦æ˜¯å›ºå®šçš„ï¼Œæ— æ³•å¤„ç†çªå‘æµé‡ã€‚é¢å¯¹çªå‘æµé‡çš„æ—¶å€™ï¼Œæ¼æ¡¶ç®—æ³•è¿˜æ˜¯å¾ªè§„è¹ˆçŸ©åœ°å¤„ç†è¯·æ±‚ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³çœ‹åˆ°çš„ã€‚æµé‡å˜çªå‘æ—¶ï¼Œæˆ‘ä»¬è‚¯å®šå¸Œæœ›ç³»ç»Ÿå°½é‡å¿«ç‚¹å¤„ç†è¯·æ±‚ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚</li><li><strong>å¯èƒ½ä¼šä¸¢å¤±æ•°æ®</strong>ï¼šå¦‚æœå…¥å£æµé‡è¿‡å¤§ï¼Œè¶…è¿‡äº†æ¡¶çš„å®¹é‡ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸¢å¼ƒéƒ¨åˆ†è¯·æ±‚ã€‚åœ¨ä¸€äº›ä¸èƒ½æ¥å—ä¸¢å¤±è¯·æ±‚çš„åœºæ™¯ä¸­ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚</li><li><strong>ä¸é€‚åˆé€Ÿç‡å˜åŒ–å¤§çš„åœºæ™¯</strong>ï¼šå¦‚æœé€Ÿç‡å˜åŒ–å¤§ï¼Œæˆ–è€…éœ€è¦åŠ¨æ€è°ƒæ•´é€Ÿç‡ï¼Œé‚£ä¹ˆæ¼æ¡¶ç®—æ³•å°±æ— æ³•æ»¡è¶³éœ€æ±‚ã€‚</li></ol><hr><hr><h2 id="ä»¤ç‰Œæ¡¶ç®—æ³•">ä»¤ç‰Œæ¡¶ç®—æ³•</h2><h3 id="å®ç°åŸç†-4">å®ç°åŸç†</h3><p>ä»¤ç‰Œæ¡¶é™æµç®—æ³•æ˜¯ä¸€ç§å¸¸ç”¨çš„æµé‡æ•´å½¢å’Œé€Ÿç‡é™åˆ¶ç®—æ³•ã€‚ä¸æ¼æ¡¶ç®—æ³•ä¸€æ ·ï¼Œä»¤ç‰Œæ¡¶ç®—æ³•ä¹Ÿæ˜¯ç”¨æ¥æ§åˆ¶å‘é€åˆ°ç½‘ç»œä¸Šçš„æ•°æ®çš„æ•°é‡ã€‚</p><p>å®ç°åŸç†ï¼š</p><ol><li>ç³»ç»Ÿä»¥å›ºå®šçš„é€Ÿç‡å‘æ¡¶ä¸­æ·»åŠ ä»¤ç‰Œï¼›</li><li>å½“æœ‰è¯·æ±‚åˆ°æ¥æ—¶ï¼Œä¼šå°è¯•ä»æ¡¶ä¸­ç§»é™¤ä¸€ä¸ªä»¤ç‰Œï¼Œå¦‚æœæ¡¶ä¸­æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œï¼Œåˆ™è¯·æ±‚å¯ä»¥è¢«å¤„ç†æˆ–æ•°æ®åŒ…å¯ä»¥è¢«å‘é€ï¼›</li><li>å¦‚æœæ¡¶ä¸­æ²¡æœ‰ä»¤ç‰Œï¼Œé‚£ä¹ˆè¯·æ±‚å°†è¢«æ‹’ç»ï¼›</li><li>æ¡¶ä¸­çš„ä»¤ç‰Œæ•°ä¸èƒ½è¶…è¿‡æ¡¶çš„å®¹é‡ï¼Œå¦‚æœæ–°ç”Ÿæˆçš„ä»¤ç‰Œè¶…è¿‡äº†æ¡¶çš„å®¹é‡ï¼Œé‚£ä¹ˆæ–°çš„ä»¤ç‰Œä¼šè¢«ä¸¢å¼ƒã€‚</li></ol><p>ä»¤ç‰Œæ¡¶ç®—æ³•çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§æ˜¯ï¼Œå®ƒèƒ½å¤Ÿåº”å¯¹çªå‘æµé‡ã€‚å½“æ¡¶ä¸­æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œæ—¶ï¼Œå¯ä»¥ä¸€æ¬¡æ€§å¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œè¿™å¯¹äºéœ€è¦å¤„ç†çªå‘æµé‡çš„åº”ç”¨åœºæ™¯éå¸¸æœ‰ç”¨ã€‚ä½†æ˜¯åˆä¸ä¼šæ— é™åˆ¶çš„å¢åŠ å¤„ç†é€Ÿç‡å¯¼è‡´å‹å®æœåŠ¡å™¨ï¼Œå› ä¸ºæ¡¶å†…ä»¤ç‰Œæ•°é‡æ˜¯æœ‰é™åˆ¶çš„ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230902150018034.png" alt="image-20230902150018034" style="zoom:50%;" /><hr><h3 id="ä»£ç å®ç°-3">ä»£ç å®ç°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenBucketLimiter</span> <span class="keyword">implements</span> <span class="title class_">Limiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">threshold</span> <span class="operator">=</span> <span class="number">100</span>; <span class="comment">// æ¡¶çš„æœ€å¤§å®¹é‡</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// æ¡¶å†…å½“å‰çš„ä»¤ç‰Œæ•°é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">tokenRate</span> <span class="operator">=</span> <span class="number">10</span>; <span class="comment">// ä»¤ç‰Œç”Ÿæˆé€Ÿç‡ï¼ˆæ¯ç§’5æ¬¡ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">lastRefillTime</span> <span class="operator">=</span> System.currentTimeMillis(); <span class="comment">// ä¸Šæ¬¡ç”Ÿæˆä»¤ç‰Œçš„æ—¶é—´</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›trueè¡¨ç¤ºé™æµ</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">limit</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ç”Ÿæˆä»¤ç‰Œæ–¹æ³•</span></span><br><span class="line">        <span class="built_in">this</span>.refillTokens();</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ¡¶å†…æ˜¯å¦è¿˜æœ‰ä»¤ç‰Œ</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            count--;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”Ÿæˆä»¤ç‰Œæ–¹æ³•ï¼Œè®¡ç®—å¹¶æ›´æ–°è¿™æ®µæ—¶é—´å†…ç”Ÿæˆçš„ä»¤ç‰Œæ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refillTokens</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// è®¡ç®—è¿™æ®µæ—¶é—´å†…ï¼Œéœ€è¦ç”Ÿæˆçš„ä»¤ç‰Œæ•°é‡</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">refillTokens</span> <span class="operator">=</span> (currentTime - lastRefillTime) * tokenRate / <span class="number">1000</span>;</span><br><span class="line">        count = Math.min(count + refillTokens, threshold);</span><br><span class="line">        lastRefillTime = currentTime;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="ä¼˜ç¼ºç‚¹-4">ä¼˜ç¼ºç‚¹</h3><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ol><li><strong>å¯ä»¥å¤„ç†çªå‘æµé‡</strong>ï¼šä»¤ç‰Œæ¡¶ç®—æ³•å¯ä»¥å¤„ç†çªå‘æµé‡ã€‚å½“æ¡¶æ»¡æ—¶ï¼Œèƒ½å¤Ÿä»¥æœ€å¤§é€Ÿåº¦å¤„ç†è¯·æ±‚ã€‚è¿™å¯¹äºéœ€è¦å¤„ç†çªå‘æµé‡çš„åº”ç”¨åœºæ™¯éå¸¸æœ‰ç”¨ã€‚</li><li><strong>é™åˆ¶å¹³å‡é€Ÿç‡</strong>ï¼šåœ¨é•¿æœŸè¿è¡Œä¸­ï¼Œæ•°æ®çš„ä¼ è¾“ç‡ä¼šè¢«é™åˆ¶åœ¨é¢„å®šä¹‰çš„å¹³å‡é€Ÿç‡ï¼ˆå³ç”Ÿæˆä»¤ç‰Œçš„é€Ÿç‡ï¼‰ã€‚</li><li><strong>çµæ´»æ€§</strong>ï¼šä¸æ¼æ¡¶ç®—æ³•ç›¸æ¯”ï¼Œä»¤ç‰Œæ¡¶ç®—æ³•æä¾›äº†æ›´å¤§çš„çµæ´»æ€§ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥åŠ¨æ€åœ°è°ƒæ•´ç”Ÿæˆä»¤ç‰Œçš„é€Ÿç‡ã€‚</li></ol><p><strong>ç¼ºç‚¹ï¼š</strong></p><ol><li><strong>å¯èƒ½å¯¼è‡´è¿‡è½½</strong>ï¼šå¦‚æœä»¤ç‰Œäº§ç”Ÿçš„é€Ÿåº¦è¿‡å¿«ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¤§é‡çš„çªå‘æµé‡ï¼Œè¿™å¯èƒ½ä¼šä½¿ç½‘ç»œæˆ–æœåŠ¡è¿‡è½½ã€‚</li><li><strong>éœ€è¦å­˜å‚¨ç©ºé—´</strong>ï¼šä»¤ç‰Œæ¡¶éœ€è¦ä¸€å®šçš„å­˜å‚¨ç©ºé—´æ¥ä¿å­˜ä»¤ç‰Œï¼Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜èµ„æºçš„æµªè´¹ã€‚</li><li><strong>å®ç°ç¨å¤æ‚</strong>ï¼šç›¸æ¯”äºè®¡æ•°å™¨ç®—æ³•ï¼Œä»¤ç‰Œæ¡¶ç®—æ³•çš„å®ç°ç¨å¾®å¤æ‚ä¸€äº›ã€‚</li></ol><hr><hr><h2 id="æ€»ç»“">æ€»ç»“</h2><p><strong>å›ºå®šçª—å£ç®—æ³•</strong>å®ç°ç®€å•ï¼Œä½†æ˜¯é™æµä¸å¤Ÿå¹³æ»‘ï¼Œå­˜åœ¨çª—å£è¾¹ç•Œé—®é¢˜ï¼Œé€‚ç”¨äºéœ€è¦ç®€å•å®ç°é™æµçš„åœºæ™¯ã€‚</p><p><strong>æ»‘åŠ¨çª—å£ç®—æ³•</strong>è§£å†³äº†çª—å£è¾¹ç•Œé—®é¢˜ï¼Œä½†æ˜¯è¿˜æ˜¯å­˜åœ¨é™æµä¸å¤Ÿå¹³æ»‘çš„é—®é¢˜ï¼Œé€‚ç”¨äºéœ€è¦æ§åˆ¶å¹³å‡è¯·æ±‚é€Ÿç‡çš„åœºæ™¯ã€‚</p><p><strong>æ¼æ¡¶ç®—æ³•</strong>çš„ä¼˜ç‚¹æ˜¯æµé‡å¤„ç†æ›´å¹³æ»‘ï¼Œä½†æ˜¯æ— æ³•åº”å¯¹çªå‘æµé‡ï¼Œé€‚ç”¨äºéœ€è¦å¹³æ»‘æµé‡çš„åœºæ™¯ã€‚</p><p><strong>ä»¤ç‰Œæ¡¶ç®—æ³•</strong>æ—¢èƒ½å¹³æ»‘æµé‡ï¼Œåˆèƒ½å¤„ç†çªå‘æµé‡ï¼Œé€‚ç”¨äºéœ€è¦å¤„ç†çªå‘æµé‡çš„åœºæ™¯ã€‚</p>]]></content>
    
    
    <summary type="html">å›ºå®šçª—å£ã€æ»‘åŠ¨çª—å£ã€æ¼æ¡¶å’Œä»¤ç‰Œæ¡¶é™æµ</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="é™æµç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>äºŒåˆ†æŸ¥æ‰¾-çº¢è“è¾¹ç•Œæ³•</title>
    <link href="https://wuwawawa.github.io/posts/c1110203.html"/>
    <id>https://wuwawawa.github.io/posts/c1110203.html</id>
    <published>2023-08-11T06:49:12.000Z</published>
    <updated>2023-09-14T13:32:08.638Z</updated>
    
    <content type="html"><![CDATA[<p>äºŒåˆ†æŸ¥æ‰¾æ˜¯ä¸€ç§åœ¨æœ‰åºæ•°ç»„ä¸­æŸ¥æ‰¾æŸä¸€ç‰¹å®šå…ƒç´ çš„æœç´¢ç®—æ³•ã€‚åœ¨å¾ˆå¤šäººçš„å°è±¡é‡Œï¼ŒäºŒåˆ†æŸ¥æ‰¾æ˜¯ä¸€ç§æ¯”è¾ƒç®€å•çš„ç®—æ³•ã€‚ç„¶è€Œåœ¨å®é™…ä¸­ï¼ŒäºŒåˆ†æŸ¥æ‰¾ç»å¸¸å®¹æ˜“å†™é”™ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†è¾¹ç•Œæ¡ä»¶çš„æ—¶å€™ã€‚ç®—æ³•å¤§ç¥é«˜å¾·çº³æ›¾ç»è¯´è¿‡ï¼Œâ€œè™½ç„¶äºŒåˆ†æŸ¥æ‰¾çš„åŸºæœ¬æ€æƒ³ç›¸å¯¹ç®€å•ç›´ç™½ï¼Œä½†æ˜¯ç»†èŠ‚ä¸Šå´æƒŠäººçš„trickyâ€ã€‚</p><h2 id="é—®é¢˜">é—®é¢˜</h2><p>ç»™å®šæœ‰åºæ•°ç»„<code>1 2 3 5 5 5 8 9</code>ï¼Œæœ‰4ä¸ªå°é—®é¢˜åˆ†åˆ«æ˜¯ï¼š</p><ol><li><p>æ‰¾åˆ°ç¬¬ä¸€ä¸ª<code>&gt;=5</code>çš„å…ƒç´ </p></li><li><p>æ‰¾åˆ°æœ€åä¸€ä¸ª<code>&lt;5</code>çš„å…ƒç´ </p></li><li><p>æ‰¾åˆ°ç¬¬ä¸€ä¸ª<code>&gt;5</code>çš„å…ƒç´ </p></li><li><p>æ‰¾åˆ°æœ€åä¸€ä¸ª<code>&lt;=5</code>çš„å…ƒç´ </p></li></ol><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230715195248912.png" alt="image-20230715195248912" style="zoom: 50%;" /><p>å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºè¿™å››ä¸ªé—®é¢˜æ¥è¯´ï¼Œå®ƒä»¬è¡¨é¢ä¸Šæ˜¯æ¯”è¾ƒç›¸ä¼¼çš„ï¼Œä½†æ˜¯ç»†èŠ‚ä¸Šå´æœ‰äº›å¾®çš„ä¸åŒï¼Œå®ƒä»¬çš„ç­”æ¡ˆä¹Ÿæ˜¯å®Œå…¨ä¸åŒçš„ã€‚</p><p>å¯æƒ³è€ŒçŸ¥ï¼Œå¦‚æœæˆ‘ä»¬ç”¨äºŒåˆ†æŸ¥æ‰¾æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç»†èŠ‚å¤„ç†å¹¶ä¸å®¹æ˜“ï¼Œä¸€ä¸å°å¿ƒå¯èƒ½å°±ä¼šå‡ºé”™ã€‚</p><hr><hr><h2 id="æ–°çš„è§’åº¦">æ–°çš„è§’åº¦</h2><p>è®©æˆ‘ä»¬æš‚æ—¶å¿˜æ‰åˆšæ‰çš„é—®é¢˜ï¼Œä»ä¸€ä¸ªå…¨æ–°çš„è§’åº¦æ¥å®¡è§†äºŒåˆ†æŸ¥æ‰¾ã€‚</p><p>å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢ä¸€å…±æœ‰Nä¸ªå…ƒç´ ï¼Œè¿™äº›å…ƒç´ çš„ç¼–å·æ˜¯0åˆ°N-1ã€‚åœ¨è¿™Nä¸ªå…ƒç´ é‡Œé¢ï¼Œå‰Kä¸ªå…ƒç´ é¢œè‰²æ˜¯è“è‰²ï¼Œåé¢çš„å…ƒç´ æ˜¯çº¢è‰²ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716093005464.png" alt="image-20230716093005464" style="zoom:80%;" /><p>ç„¶è€Œï¼Œåœ¨è¿™ä¸ªé—®é¢˜ä¸­ï¼Œè“çº¢è¾¹ç•Œçš„ä½ç½®æ˜¯æœªçŸ¥çš„ï¼Œå³Kæ˜¯æœªçŸ¥çš„ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨æˆ‘ä»¬ä¸€å¼€å§‹æ‹¿åˆ°æ•°ç»„çš„æ—¶å€™ï¼Œæ•´ä¸ªæ•°ç»„éƒ½æ˜¯ç°è‰²çš„ã€‚è¿™ä¸ªé—®é¢˜çš„æœ€ç»ˆç›®æ ‡ï¼Œæ˜¯æŠŠè“çº¢è¾¹ç•Œæ‰¾å‡ºæ¥ï¼Œå³æ±‚å‡ºæœªçŸ¥æ•°Kã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716093139742.png" alt="image-20230716093139742" style="zoom:80%;" /><hr><h2 id="æœ´ç´ ç®—æ³•">æœ´ç´ ç®—æ³•</h2><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å‡è®¾ä¸€å…±æœ‰9ä¸ªå…ƒç´ ï¼Œå‰é¢5ä¸ªå…ƒç´ æ˜¯è“è‰²ï¼Œåé¢4ä¸ªå…ƒç´ æ˜¯çº¢è‰²</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716093644294.png" alt="image-20230716093644294"></p><p>åœ¨æˆ‘ä»¬ä¸€å¼€å§‹æ‹¿åˆ°æ•°ç»„çš„æ—¶å€™ï¼Œæ•´ä¸ªæ•°ç»„éƒ½æ˜¯ç°è‰²çš„ã€‚</p><p>æˆ‘ä»¬å¯ä»¥è®¾è®¡ä¸€ä¸ªè“è‰²æŒ‡é’ˆï¼Œä¸€å¼€å§‹æŒ‡å‘æœ€å·¦é¢ï¼Œéšåä¸æ–­å‘å³ç§»åŠ¨ï¼Œç›´åˆ°ç§»åŠ¨åˆ°è“çº¢è¾¹ç•Œã€‚æˆ–è€…è®¾è®¡ä¸€ä¸ªçº¢è‰²æŒ‡é’ˆï¼Œä¸€å¼€å§‹æŒ‡å‘æœ€å³é¢ï¼Œç„¶åä¸æ–­å‘å·¦ç§»åŠ¨ï¼Œç›´åˆ°ç§»åŠ¨åˆ°è“çº¢è¾¹ç•Œã€‚</p><p>è¿™æ ·å°±æ±‚å¾—äº†è“çº¢è¾¹ç•Œæ‰€åœ¨çš„ä½ç½®ã€‚</p><p>å½“ç„¶ï¼Œè¿™ç§ç®—æ³•æ˜¯éå¸¸ä½æ•ˆçš„ï¼Œå®ƒçš„ç®—æ³•å¤æ‚åº¦æ˜¯O(nï¼‰</p><hr><h2 id="äºŒåˆ†æŸ¥æ‰¾">äºŒåˆ†æŸ¥æ‰¾</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä½•é€šè¿‡äºŒåˆ†æŸ¥æ‰¾é«˜æ•ˆçš„å¯»æ‰¾åˆ°è“çº¢è¾¹ç•Œï¼Œåœ¨åˆšæ‰çš„æœ´ç´ ç®—æ³•ä¸­ï¼Œæˆ‘ä»¬æŒç»­ä¸æ–­çš„å°†è“è‰²æŒ‡é’ˆå‘å³ç§»åŠ¨ã€‚å¯¹äºè¿™ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒç†è§£ä¸ºè“è‰²åŒºåŸŸä¸æ–­è¢«æ‹“å±•ã€‚åŒç†ï¼Œçº¢è‰²æŒ‡é’ˆä¸æ–­å‘å·¦ç§»åŠ¨ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªè¿‡ç¨‹ç†è§£ä¸ºçº¢è‰²åŒºåŸŸä¸æ–­è¢«æ‹“å±•ã€‚</p><p>æœ´ç´ ç®—æ³•ä¹‹æ‰€ä»¥æ•ˆç‡ä½ä¸‹ï¼Œæ˜¯å› ä¸ºè“è‰²åŒºåŸŸå’Œçº¢è‰²åŒºåŸŸçš„æ‹“å±•æ˜¯ç¼“æ…¢è¿›è¡Œçš„ï¼Œæ¯æ¬¡åªèƒ½æ‹“å±•ä¸€ä¸ªå…ƒç´ ã€‚</p><hr><h3 id="åŸºæœ¬æ­¥éª¤">åŸºæœ¬æ­¥éª¤</h3><blockquote><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•æ¥åŠ é€Ÿä¸¤ä¸ªåŒºåŸŸçš„æ‹“å±•è¿‡ç¨‹å‘¢ï¼Ÿ</p></blockquote><div class="tabs" id="c747378e-3702-44cf-8e98-a9f5063d2056"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c747378e-3702-44cf-8e98-a9f5063d2056-1"><i class="fas fa-seedling"></i>å¾ªç¯æ¬¡æ•°1</button></li><li class="tab"><button type="button" data-href="#c747378e-3702-44cf-8e98-a9f5063d2056-2"><i class="fas fa-leaf"></i>å¾ªç¯æ¬¡æ•°2</button></li><li class="tab"><button type="button" data-href="#c747378e-3702-44cf-8e98-a9f5063d2056-3"><i class="fab fa-apple"></i>å¾ªç¯æ¬¡æ•°3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c747378e-3702-44cf-8e98-a9f5063d2056-1"><p>æˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥çœ‹ä¸€ä¸‹ç°è‰²åŒºåŸŸæœ€ä¸­é—´çš„é‚£ä¸ªå…ƒç´ é¢œè‰²ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716094245363.png" alt="image-20230716094245363"></p><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å‘ç°è¿™ä¸ªå…ƒç´ é¢œè‰²ä¸ºè“è‰²ã€‚å®ƒå°±æ„å‘³ç€ï¼Œè¿™ä¸ªå…ƒç´ ï¼Œä»¥åŠè¿™ä¸ªå…ƒç´ ä¹‹å‰æ‰€æœ‰çš„å…ƒç´ éƒ½æ˜¯è“è‰²ã€‚è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥ç›´æ´å°†è“è‰²åŒºåŸŸæ‹“å±•åˆ°è¿™ä¸ªå…ƒç´ æ‰€åœ¨ä½ç½®ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716094329526.png" alt="image-20230716094329526"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c747378e-3702-44cf-8e98-a9f5063d2056-2"><p>è®©æˆ‘ä»¬ç»§ç»­è¿™æ ·çš„æ“ä½œã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716094455062.png" alt="image-20230716094455062"></p><p>è§‚å¯Ÿç°è‰²åŒºåŸŸä¸­æœ€ä¸­é—´çš„é‚£ä¸ªå…ƒç´ é¢œè‰²ï¼Œæˆ‘ä»¬å‘ç°å®ƒæ˜¯çº¢è‰²ï¼Œè¿™ä¹Ÿå°±è¯´æ˜äº†ï¼Œè¿™ä¸ªå…ƒç´ ä»¥åŠè¿™ä¸ªå…ƒç´ åé¢çš„å…ƒç´ éƒ½æ˜¯çº¢è‰²ã€‚è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥ç›´æ¥å°†çº¢è‰²åŒºåŸŸæ‹“å±•åˆ°è¿™ä¸ªå…ƒç´ æ‰€åœ¨çš„ä½ç½®ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716094652765.png" alt="image-20230716094652765"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c747378e-3702-44cf-8e98-a9f5063d2056-3"><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸æ–­çš„é‡å¤è¿™ç§æ“ä½œ</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716094835833.png" alt="image-20230716094835833"></p><p>ç›´åˆ°æœ€åï¼Œæˆ‘ä»¬ä¾¿æ‰¾åˆ°äº†è“çº¢è¾¹ç•Œ</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716094859442.png" alt="image-20230716094859442"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="ä¼ªä»£ç å®ç°">ä¼ªä»£ç å®ç°</h3><div class="tabs" id="33539071-8bba-4bca-a801-0931002f5bff"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#33539071-8bba-4bca-a801-0931002f5bff-1"><i class="fas fa-seedling"></i>1</button></li><li class="tab"><button type="button" data-href="#33539071-8bba-4bca-a801-0931002f5bff-2"><i class="fas fa-leaf"></i>2</button></li><li class="tab"><button type="button" data-href="#33539071-8bba-4bca-a801-0931002f5bff-3"><i class="fab fa-apple"></i>3</button></li><li class="tab"><button type="button" data-href="#33539071-8bba-4bca-a801-0931002f5bff-4"><i class="fas fa-tree"></i>4</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="33539071-8bba-4bca-a801-0931002f5bff-1"><p>ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬è®¾è®¡Lï¼ŒRä¸¤ä¸ªæŒ‡é’ˆï¼ŒLæŒ‡å‘-1,RæŒ‡å‘N</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716095333538.png" alt="image-20230716095333538"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="33539071-8bba-4bca-a801-0931002f5bff-2"><p>å½“L+1ï¼=Rçš„æ—¶å€™ï¼Œå°±ä¼šè¿›å…¥å¾ªç¯ä½“ã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬æ±‚å¾—ç°è‰²åŒºåŸŸä¸­é—´çš„é‚£ä¸ªå…ƒç´ ä½ç½®Mï¼ŒM=(L+R) /2å¹¶ä¸”å‘ä¸‹å–æ•´ã€‚å¦‚æœMçš„é¢œè‰²æ˜¯è“è‰²ï¼Œæˆ‘ä»¬å°±å°†Lèµ‹å€¼ä¸ºMï¼Œä¹Ÿå°±æ˜¯å°†è“è‰²åŒºåŸŸæ‹“å±•åˆ°Mã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716095536554.png" alt="image-20230716095536554"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="33539071-8bba-4bca-a801-0931002f5bff-3"><p>å¦‚æœMçš„é¢œè‰²æ˜¯çº¢è‰²ï¼Œæˆ‘ä»¬ä¾¿å°†Rèµ‹å€¼ä¸ºMï¼Œä¹Ÿå°±æ˜¯å°†çº¢è‰²åŒºåŸŸæ‹“å±•åˆ°M</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716095650860.png" alt="image-20230716095650860"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="33539071-8bba-4bca-a801-0931002f5bff-4"><p>æˆ‘ä»¬æŒç»­ä¸æ–­çš„é‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œç›´åˆ°è¾¾æˆL+1=Rè¿™ä¸ªæ¡ä»¶ï¼Œä¾¿é€€å‡ºå¾ªç¯ã€‚</p><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼ŒLå’ŒRåˆšåˆšå¥½æŒ‡å‘è“çº¢è¾¹ç•Œï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å®é™…æƒ…å†µæ¥å†³å®šè¿”å›Lè¿˜æ˜¯Rã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716095837237.png" alt="image-20230716095837237"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="ç»†èŠ‚é—®é¢˜">ç»†èŠ‚é—®é¢˜</h3><p>åˆšåˆšæˆ‘ç»çš„äºŒåˆ†æŸ¥æ‰¾ä¼ªä»£ç ï¼Œå¯èƒ½å’Œå¤§å®¶åœ¨å…¶ä»–åœ°æ–¹æ‰€çœ‹åˆ°çš„ç‰ˆæœ¬æœ‰æ‰€ä¸åŒã€‚ä¸ºäº†è¿›ä¸€æ­¥è¯æ˜ç®—æ³•çš„æ­£ç¡®æ€§ï¼Œè®©æˆ‘ä»¬çœ‹å‡ ä¸ªç»†èŠ‚é—®é¢˜ã€‚</p><blockquote><p>ä¸ºä»€ä¹ˆ<span class='p blue'>L</span>çš„åˆå§‹å€¼ä¸º-1ï¼Œ<span class='p red'>R</span>çš„åˆå§‹å€¼ä¸ºN?</p></blockquote><p>éš¾é“æˆ‘ä»¬ä¸èƒ½å°†Låˆå§‹åŒ–ä¸º0ï¼Œæˆ–è€…è®©Råˆå§‹åŒ–ä¸ºN-1ä¹ˆ?</p><p>ç­”æ¡ˆæ˜¯ä¸å¯ä»¥</p><p>è¯•æƒ³ä¸€ä¸‹ï¼Œå‡å¦‚æ•´ä¸ªæ•°ç»„éƒ½æ˜¯çº¢è‰²,é‚£ä¹ˆå¦‚æœè®©Låˆå§‹åŒ–ä¸º0ï¼ŒLä¸€å¼€å§‹ä¾¿å¤„äºçº¢è‰²åŒºåŸŸå†…ï¼Œè¿™ä¹Ÿä¾¿ä¼šé€ æˆé”™è¯¯ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716100233717.png" alt="image-20230716100233717"></p><p>åŒç†ï¼Œå¦‚æœæ•´ä¸ªæ•°ç»„éƒ½æ˜¯è“è‰²ï¼Œé‚£ä¹ˆå¦‚æœè®©Råˆå§‹åŒ–ä¸ºN-1ï¼ŒRä¸€å¼€å§‹ä¾¿å¤„äºè“è‰²åŒºåŸŸï¼Œä¹Ÿå°±é€ æˆäº†é”™è¯¯ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716100344067.png" alt="image-20230716100344067"></p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦è®©Låˆå§‹åŒ–ä¸º-1ï¼ŒRåˆå§‹åŒ–ä¸ºNã€‚</p><hr><blockquote><p>æ›´æ–°æŒ‡é’ˆæ—¶ï¼Œèƒ½ä¸èƒ½å†™æˆL=m+1ï¼Œæˆ–è€…R=m-1?</p></blockquote><p>æ¯”å¦‚è¯´ï¼Œå¯¹äºè¿™æ ·ä¸€ç§æƒ…å†µï¼Œåœ¨æŸæ¬¡å¾ªç¯ä¸­ï¼ŒMåˆšåˆšå¥½æŒ‡å‘è“è‰²åŒºåŸŸçš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬è®©Lå˜æˆM+1ï¼Œå°±ä¼šè®©LæŒ‡å‘çº¢è‰²åŒºåŸŸï¼Œè¿™æ ·å°±é€ æˆäº†é”™è¯¯ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716100809314.png" alt="image-20230716100809314"></p><hr><h2 id="é—®é¢˜ç­”æ¡ˆ">é—®é¢˜ç­”æ¡ˆ</h2><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716100920458.png" alt="image-20230716100920458"></p><hr><h2 id="ä¸€èˆ¬æµç¨‹">ä¸€èˆ¬æµç¨‹</h2><ul><li>å»ºæ¨¡ï¼šåˆ’åˆ†<span class='p blue'>è“</span><span class='p red'>çº¢</span>åŒºåŸŸï¼Œç¡®å®š<code>isBlue()</code>å‡½æ•°</li><li>ç¡®å®šè¿”å›<span class='p blue'>L</span>è¿˜æ˜¯<span class='p red'>R</span></li><li>å¥—ç”¨ç®—æ³•æ¨¡ç‰ˆ</li><li>åå¤„ç†é€»è¾‘</li></ul>]]></content>
    
    
    <summary type="html">äºŒåˆ†æŸ¥æ‰¾</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>äºŒåˆ†æŸ¥æ‰¾</title>
    <link href="https://wuwawawa.github.io/posts/e8eb0480.html"/>
    <id>https://wuwawawa.github.io/posts/e8eb0480.html</id>
    <published>2023-08-10T02:28:21.000Z</published>
    <updated>2023-09-14T13:32:14.856Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¯»æ‰¾ä¸€ä¸ªæ•°-åŸºæœ¬çš„äºŒåˆ†æŸ¥æ‰¾">å¯»æ‰¾ä¸€ä¸ªæ•°(åŸºæœ¬çš„äºŒåˆ†æŸ¥æ‰¾)</h2><p>è¿™ä¸ªåœºæ™¯æ˜¯æœ€ç®€å•çš„ï¼Œè‚¯èƒ½ä¹Ÿæ˜¯å¤§å®¶æœ€ç†Ÿæ‚‰çš„ï¼Œå³æœç´¢ä¸€ä¸ªæ•°ï¼Œå¦‚æœå­˜åœ¨ï¼Œè¿”å›å…¶ç´¢å¼•ï¼Œå¦åˆ™è¿”å› -1ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">binarySearch</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> nums.length - <span class="number">1</span>; <span class="comment">// æ³¨æ„</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(left &lt;= right) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> left + (right - left) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span>(nums[mid] == target)</span><br><span class="line">            <span class="keyword">return</span> mid;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nums[mid] &lt; target)</span><br><span class="line">            left = mid + <span class="number">1</span>; <span class="comment">// æ³¨æ„</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nums[mid] &gt; target)</span><br><span class="line">            right = mid - <span class="number">1</span>; <span class="comment">// æ³¨æ„</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ç‚¹åˆ†æ</p></blockquote><div class="tabs" id="5c9537ee-7214-4745-8b2a-37749be89f75"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#5c9537ee-7214-4745-8b2a-37749be89f75-1"><i class="fas fa-seedling"></i>whileå¾ªç¯é€€å‡ºæ¡ä»¶</button></li><li class="tab"><button type="button" data-href="#5c9537ee-7214-4745-8b2a-37749be89f75-2"><i class="fas fa-leaf"></i>lå’Œræ›´æ–°</button></li><li class="tab"><button type="button" data-href="#5c9537ee-7214-4745-8b2a-37749be89f75-3"><i class="fab fa-apple"></i>ç¼ºé™·</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="5c9537ee-7214-4745-8b2a-37749be89f75-1"><p><mark class="hl-label blue">ä¸ºä»€ä¹ˆwhileå¾ªç¯çš„æ¡ä»¶ä¸­æ˜¯&lt;=è€Œä¸æ˜¯&lt;</mark></p><p>å› ä¸ºåˆå§‹åŒ– <code>right</code> çš„èµ‹å€¼æ˜¯ <code>nums.length - 1</code>ï¼Œå³æœ€åä¸€ä¸ªå…ƒç´ çš„ç´¢å¼•ï¼Œè€Œä¸æ˜¯ <code>nums.length</code></p><p>è¿™äºŒè€…å¯èƒ½å‡ºç°åœ¨ä¸åŒåŠŸèƒ½çš„äºŒåˆ†æŸ¥æ‰¾ä¸­ï¼ŒåŒºåˆ«æ˜¯ï¼šå‰è€…ç›¸å½“äºä¸¤ç«¯éƒ½é—­åŒºé—´ <code>[left, right]</code>ï¼Œåè€…ç›¸å½“äºå·¦é—­å³å¼€åŒºé—´ <code>[left, right)</code>ï¼Œå› ä¸ºç´¢å¼•å¤§å°ä¸º <code>nums.length</code> æ˜¯è¶Šç•Œçš„ã€‚</p><p>æˆ‘ä»¬è¿™ä¸ªç®—æ³•ä¸­ä½¿ç”¨çš„æ˜¯å‰è€… <code>[left, right]</code> ä¸¤ç«¯éƒ½é—­çš„åŒºé—´ã€‚</p><p><code>while(left &lt;= right)</code> çš„ç»ˆæ­¢æ¡ä»¶æ˜¯ <code>left == right + 1</code>ï¼Œå†™æˆåŒºé—´çš„å½¢å¼å°±æ˜¯ <code>[right + 1, right]</code>ï¼Œæˆ–è€…å¸¦ä¸ªå…·ä½“çš„æ•°å­—è¿›å» <code>[3, 2]</code>ï¼Œå¯è§<strong>è¿™æ—¶å€™åŒºé—´ä¸ºç©º</strong>ï¼Œå› ä¸ºæ²¡æœ‰ç´¢å¼•æ—¢å¤§äºç­‰äº 3 åˆå°äºç­‰äº 2 çš„å§ã€‚æ‰€ä»¥è¿™æ—¶å€™ while å¾ªç¯ç»ˆæ­¢æ˜¯æ­£ç¡®çš„ï¼Œç›´æ¥è¿”å› -1 å³å¯ã€‚</p><p><code>while(left &lt; right)</code> çš„ç»ˆæ­¢æ¡ä»¶æ˜¯ <code>left == right</code>ï¼Œå†™æˆåŒºé—´çš„å½¢å¼å°±æ˜¯ <code>[left, right]</code>ï¼Œæˆ–è€…å¸¦ä¸ªå…·ä½“çš„æ•°å­—è¿›å» <code>[2, 2]</code>ï¼Œ<strong>è¿™æ—¶å€™åŒºé—´éç©º</strong>ï¼Œè¿˜æœ‰ä¸€ä¸ªæ•° 2ï¼Œä½†æ­¤æ—¶ while å¾ªç¯ç»ˆæ­¢äº†ã€‚ä¹Ÿå°±æ˜¯è¯´è¿™åŒºé—´ <code>[2, 2]</code> è¢«æ¼æ‰äº†ï¼Œç´¢å¼• 2 æ²¡æœ‰è¢«æœç´¢ï¼Œå¦‚æœè¿™æ—¶å€™ç›´æ¥è¿”å› -1 å°±æ˜¯é”™è¯¯çš„ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5c9537ee-7214-4745-8b2a-37749be89f75-2"><p>ä»€ä¹ˆ <code>left = mid + 1</code>ï¼Œ<code>right = mid - 1</code>ï¼Ÿæˆ‘çœ‹æœ‰çš„ä»£ç æ˜¯ <code>right = mid</code> æˆ–è€… <code>left = mid</code>ï¼Œæ²¡æœ‰è¿™äº›åŠ åŠ å‡å‡ï¼Œåˆ°åº•æ€ä¹ˆå›äº‹ï¼Œæ€ä¹ˆåˆ¤æ–­ï¼Ÿ</p><p>åˆšæ‰æ˜ç¡®äº†ã€Œæœç´¢åŒºé—´ã€è¿™ä¸ªæ¦‚å¿µï¼Œè€Œä¸”æœ¬ç®—æ³•çš„æœç´¢åŒºé—´æ˜¯ä¸¤ç«¯éƒ½é—­çš„ï¼Œå³ <code>[left, right]</code>ã€‚é‚£ä¹ˆå½“æˆ‘ä»¬å‘ç°ç´¢å¼• <code>mid</code> ä¸æ˜¯è¦æ‰¾çš„ <code>target</code> æ—¶ï¼Œä¸‹ä¸€æ­¥åº”è¯¥å»æœç´¢å“ªé‡Œå‘¢ï¼Ÿ</p><p>å½“ç„¶æ˜¯å»æœç´¢ <code>[left, mid-1]</code> æˆ–è€… <code>[mid+1, right]</code> å¯¹ä¸å¯¹ï¼Ÿå› ä¸º <code>mid</code> å·²ç»æœç´¢è¿‡ï¼Œåº”è¯¥ä»æœç´¢åŒºé—´ä¸­å»é™¤ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5c9537ee-7214-4745-8b2a-37749be89f75-3"><p>æ¯”å¦‚è¯´ç»™ä½ æœ‰åºæ•°ç»„ <code>nums = [1,2,2,2,3]</code>ï¼Œ<code>target</code> ä¸º 2ï¼Œæ­¤ç®—æ³•è¿”å›çš„ç´¢å¼•æ˜¯ 2ï¼Œæ²¡é”™ã€‚ä½†æ˜¯å¦‚æœæˆ‘æƒ³å¾—åˆ° <code>target</code> çš„å·¦ä¾§è¾¹ç•Œï¼Œå³ç´¢å¼• 1ï¼Œæˆ–è€…æˆ‘æƒ³å¾—åˆ° <code>target</code> çš„å³ä¾§è¾¹ç•Œï¼Œå³ç´¢å¼• 3ï¼Œè¿™æ ·çš„è¯æ­¤ç®—æ³•æ˜¯æ— æ³•å¤„ç†çš„ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="å¯»æ‰¾ç¬¬ä¸€ä¸ªæ»¡è¶³è¯¥æ¡ä»¶çš„å€¼">å¯»æ‰¾ç¬¬ä¸€ä¸ªæ»¡è¶³è¯¥æ¡ä»¶çš„å€¼</h2><p>å½“ check(mid) == true è°ƒæ•´çš„æ˜¯ r æ—¶ï¼šè®¡ç®— mid çš„æ–¹å¼åº”è¯¥ä¸º mid = l + r &gt;&gt; 1</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">   <span class="built_in">int</span> l = <span class="number">0</span>, r = <span class="built_in">n</span> - <span class="number">1</span>;</span><br><span class="line">while (l &lt; r) &#123;</span><br><span class="line">       <span class="built_in">int</span> <span class="built_in">mid</span> = l + r &gt;&gt; <span class="number">1</span>; //æ¨èå†™æ³• <span class="built_in">int</span> <span class="built_in">mid</span> = l +( r - l) / <span class="number">2</span>;</span><br><span class="line">       <span class="built_in">if</span> (check(<span class="built_in">mid</span>)) &#123;</span><br><span class="line">           //åç§»r, æ±‚ç¬¬ä¸€ä¸ªæ»¡è¶³è¯¥æ¡ä»¶çš„å€¼</span><br><span class="line">           r = <span class="built_in">mid</span>;</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           l = <span class="built_in">mid</span> + <span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2 id="å¯»æ‰¾æœ€åä¸€ä¸ªæ»¡è¶³è¯¥æ¡ä»¶çš„å€¼">å¯»æ‰¾æœ€åä¸€ä¸ªæ»¡è¶³è¯¥æ¡ä»¶çš„å€¼</h2><p>å½“ check(mid) == true è°ƒæ•´çš„æ˜¯ l æ—¶ï¼šè®¡ç®— mid çš„æ–¹å¼åº”è¯¥ä¸º mid = l + r + 1 &gt;&gt; 1</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="type">int</span> <span class="variable">l</span> <span class="operator">=</span> <span class="number">0</span>, r = n - <span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span> (l &lt; r) &#123;</span><br><span class="line">       <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> l + r + <span class="number">1</span> &gt;&gt; <span class="number">1</span>;<span class="comment">//å‘ä¸Šå–æ•´ï¼Œ +1 æ“ä½œä¸»è¦æ˜¯ä¸ºäº†é¿å…å‘ç”Ÿã€Œæ­»å¾ªç¯ã€</span></span><br><span class="line">       <span class="keyword">if</span> (check(mid)) &#123;</span><br><span class="line">           <span class="comment">//åç§»l, æ±‚æœ€åä¸€ä¸ªæ»¡è¶³è¯¥æ¡ä»¶çš„å€¼</span></span><br><span class="line">           l = mid;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           r = mid - <span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">äºŒåˆ†æŸ¥æ‰¾</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>å›æº¯</title>
    <link href="https://wuwawawa.github.io/posts/f92eff5d.html"/>
    <id>https://wuwawawa.github.io/posts/f92eff5d.html</id>
    <published>2023-08-02T04:06:11.000Z</published>
    <updated>2023-09-14T01:35:44.175Z</updated>
    
    <content type="html"><![CDATA[<h2 id="åˆ’åˆ†kä¸ªç›¸ç­‰çš„å­é›†">åˆ’åˆ†kä¸ªç›¸ç­‰çš„å­é›†</h2><div class="tabs" id="a5be2cec-b383-4537-9ec2-3406ea64a6ae"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#a5be2cec-b383-4537-9ec2-3406ea64a6ae-1"><i class="fas fa-seedling"></i>ç«æŸ´æ‹¼æ­£æ–¹å½¢</button></li><li class="tab"><button type="button" data-href="#a5be2cec-b383-4537-9ec2-3406ea64a6ae-2"><i class="fas fa-leaf"></i>åˆ’åˆ†ä¸ºkä¸ªç›¸ç­‰çš„å­é›†</button></li><li class="tab"><button type="button" data-href="#a5be2cec-b383-4537-9ec2-3406ea64a6ae-3"><i class="fab fa-apple"></i>3</button></li><li class="tab"><button type="button" data-href="#a5be2cec-b383-4537-9ec2-3406ea64a6ae-4"><i class="fas fa-tree"></i>4</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="a5be2cec-b383-4537-9ec2-3406ea64a6ae-1"><div class="tag link"><a class="link-card" title="473. ç«æŸ´æ‹¼æ­£æ–¹å½¢" href="https://leetcode.cn/problems/matchsticks-to-square/"><div class="left"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/leetcode.jpg"/></div><div class="right"><p class="text">473. ç«æŸ´æ‹¼æ­£æ–¹å½¢</p><p class="url">https://leetcode.cn/problems/matchsticks-to-square/</p></div></a></div><p>ä½ å°†å¾—åˆ°ä¸€ä¸ªæ•´æ•°æ•°ç»„ matchsticks ï¼Œå…¶ä¸­ matchsticks[i] æ˜¯ç¬¬ i ä¸ªç«æŸ´æ£’çš„é•¿åº¦ã€‚ä½ è¦ç”¨ æ‰€æœ‰çš„ç«æŸ´æ£ æ‹¼æˆä¸€ä¸ªæ­£æ–¹å½¢ã€‚ä½  ä¸èƒ½æŠ˜æ–­ ä»»ä½•ä¸€æ ¹ç«æŸ´æ£’ï¼Œä½†ä½ å¯ä»¥æŠŠå®ƒä»¬è¿åœ¨ä¸€èµ·ï¼Œè€Œä¸”æ¯æ ¹ç«æŸ´æ£’å¿…é¡» ä½¿ç”¨ä¸€æ¬¡ ã€‚</p><p>å¦‚æœä½ èƒ½ä½¿è¿™ä¸ªæ­£æ–¹å½¢ï¼Œåˆ™è¿”å› true ï¼Œå¦åˆ™è¿”å› false ã€‚</p><div class="tabs" id="10b05bf4-7acc-4492-a4d8-1a859f0abe58"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#10b05bf4-7acc-4492-a4d8-1a859f0abe58-1"><i class="fas fa-cat"></i>è§£æ³•ä¸€</button></li><li class="tab"><button type="button" data-href="#10b05bf4-7acc-4492-a4d8-1a859f0abe58-2"><i class="fas fa-horse"></i>è§£æ³•äºŒ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="10b05bf4-7acc-4492-a4d8-1a859f0abe58-1"><p>è¾¹ç•Œæ¡ä»¶æ—¶ä¸éœ€è¦å¯¹æ¯ä¸ªæ¡¶æ˜¯å¦éƒ½è¾¾åˆ°targetè¿›è¡Œåˆ¤æ–­ã€‚</p><p>è‹¥æŸä¸ªæ¡¶çš„é•¿åº¦å°äºtargetï¼Œé‚£è¾¾åˆ°æœ«å°¾æ—¶ï¼Œå°±å¿…ç„¶ä¼šæœ‰æ¡¶é•¿åº¦å¤§äºtargetã€‚è€Œè¿™ç§æƒ…å†µä¸ä¼šè¿›å…¥ä¸‹ä¸€æ¬¡é€’å½’çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] matchsticks;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> target;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">makesquare</span><span class="params">(<span class="type">int</span>[] _matchsticks)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> Arrays.stream(_matchsticks).sum();</span><br><span class="line">    <span class="keyword">if</span>(sum % <span class="number">4</span> != <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    target = sum/<span class="number">4</span>;</span><br><span class="line">    <span class="comment">// æ’åº</span></span><br><span class="line">    matchsticks = Arrays.stream(_matchsticks).boxed().sorted(Comparator.reverseOrder()).mapToInt(Integer::intValue).toArray();</span><br><span class="line">    <span class="keyword">return</span> dfs(<span class="number">0</span> , <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">4</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">dfs</span><span class="params">(<span class="type">int</span> idx ,<span class="type">int</span>[] edges)</span>&#123;</span><br><span class="line">    <span class="comment">// è¾¹ç•Œæ¡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span>(idx == matchsticks.length) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†å½“å‰çš„æœ¨æ£æ”¾ç½®åˆ°4ä¸ªæ¡¶ä¸­</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;i &lt; <span class="number">4</span>;i++)&#123;</span><br><span class="line">        edges[i] += matchsticks[idx];</span><br><span class="line">        <span class="keyword">if</span>(edges[i] &lt;= target &amp;&amp; dfs(idx + <span class="number">1</span>,edges))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        edges[i] -= matchsticks[idx];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="10b05bf4-7acc-4492-a4d8-1a859f0abe58-2"><p>çŠ¶æ€å‹ç¼©+è®°å¿†åŒ–</p><p>ä½¿ç”¨<code>curSum + matchsticks[i] &lt;= side</code>å’Œ<code>int newSum = (curSum + matchsticks[i]) % side;</code></p><p>ä¸¤ç§æ–¹å¼å·§å¦™å®ç°å•è¾¹çš„å¢é•¿ä»¥åŠå½“è¾¾åˆ°sideæ—¶è¿›è¡Œä¸‹ä¸€æ¡è¾¹çš„é€‰æ‹©ã€‚</p><p>å½“sum&lt;sideæ—¶ï¼Œsumä¼šä¸€ç›´ç´¯ç§¯ã€‚å½“åˆšå¥½è¾¾åˆ°sideæ—¶ï¼Œæ¸…0ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> side; <span class="comment">// è¾¹é•¿</span></span><br><span class="line"><span class="type">int</span>[] cache;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span>[] matchsticks;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">makesquare</span><span class="params">(<span class="type">int</span>[] _matchsticks)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> Arrays.stream(_matchsticks).sum();</span><br><span class="line">    <span class="keyword">if</span> (sum % <span class="number">4</span> != <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    side = sum / <span class="number">4</span>;</span><br><span class="line">    <span class="comment">// æ’åº</span></span><br><span class="line">    matchsticks = Arrays.stream(_matchsticks).boxed().sorted(Comparator.reverseOrder()).mapToInt(Integer::intValue).toArray();</span><br><span class="line">    n = _matchsticks.length;</span><br><span class="line"></span><br><span class="line">    cache = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">1</span> &lt;&lt; n];</span><br><span class="line">    cache[(<span class="number">1</span> &lt;&lt; n) - <span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> dfs(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">dfs</span><span class="params">(<span class="type">int</span> state, <span class="type">int</span> curSum)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache[state] != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> cache[state] == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (((state &gt;&gt; i) &amp; <span class="number">1</span>) == <span class="number">0</span> &amp;&amp; curSum + matchsticks[i] &lt;= side) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">newSum</span> <span class="operator">=</span> (curSum + matchsticks[i]) % side;</span><br><span class="line">            <span class="keyword">if</span> (dfs(state | (<span class="number">1</span> &lt;&lt; i), newSum)) &#123;</span><br><span class="line">                ans = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cache[state] = ans ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a5be2cec-b383-4537-9ec2-3406ea64a6ae-2"><div class="tag link"><a class="link-card" title="698. ç«æŸ´æ‹¼æ­£æ–¹å½¢" href="https://leetcode.cn/problems/partition-to-k-equal-sum-subsets/"><div class="left"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/leetcode.jpg"/></div><div class="right"><p class="text">698. ç«æŸ´æ‹¼æ­£æ–¹å½¢</p><p class="url">https://leetcode.cn/problems/partition-to-k-equal-sum-subsets/</p></div></a></div><p>ç»™å®šä¸€ä¸ªæ•´æ•°æ•°ç»„ <code>nums</code> å’Œä¸€ä¸ªæ­£æ•´æ•° <code>k</code>ï¼Œæ‰¾å‡ºæ˜¯å¦æœ‰å¯èƒ½æŠŠè¿™ä¸ªæ•°ç»„åˆ†æˆ <code>k</code> ä¸ªéç©ºå­é›†ï¼Œå…¶æ€»å’Œéƒ½ç›¸ç­‰ã€‚</p><p>åŒä¸Šä¸€é¢˜å†™æ³•</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a5be2cec-b383-4537-9ec2-3406ea64a6ae-3"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a5be2cec-b383-4537-9ec2-3406ea64a6ae-4"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>]]></content>
    
    
    <summary type="html">å›æº¯</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>ä»æš´åŠ›é€’å½’åˆ°åŠ¨æ€è§„åˆ’</title>
    <link href="https://wuwawawa.github.io/posts/1d80917d.html"/>
    <id>https://wuwawawa.github.io/posts/1d80917d.html</id>
    <published>2023-07-05T13:11:40.000Z</published>
    <updated>2023-09-14T01:35:54.520Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2><h3 id="ä»€ä¹ˆæš´åŠ›é€’å½’å¯ä»¥ç»§ç»­ä¼˜åŒ–ï¼Ÿ">ä»€ä¹ˆæš´åŠ›é€’å½’å¯ä»¥ç»§ç»­ä¼˜åŒ–ï¼Ÿ</h3><p>æœ‰é‡å¤è°ƒç”¨åŒä¸€ä¸ªå­é—®é¢˜çš„è§£ï¼Œè¿™ç§é€’å½’å¯ä»¥ä¼˜åŒ–</p><p>å¦‚æœæ¯ä¸€ä¸ªå­é—®é¢˜éƒ½æ˜¯ä¸åŒçš„è§£ï¼Œæ— æ³•ä¼˜åŒ–ä¹Ÿä¸ç”¨ä¼˜åŒ–</p><hr><h3 id="æš´åŠ›é€’å½’å’ŒåŠ¨æ€è§„åˆ’çš„å…³ç³»">æš´åŠ›é€’å½’å’ŒåŠ¨æ€è§„åˆ’çš„å…³ç³»</h3><p>æŸä¸€ä¸ªæš´åŠ›é€’å½’ï¼Œæœ‰è§£çš„é‡å¤è°ƒç”¨ï¼Œå°±å¯ä»¥æŠŠè¿™ä¸ªæš´åŠ›é€’å½’ä¼˜åŒ–æˆåŠ¨æ€è§„åˆ’</p><p>ä»»ä½•åŠ¨æ€è§„åˆ’é—®é¢˜ï¼Œéƒ½ä¸€å®šå¯¹åº”ç€æŸä¸€ä¸ªæœ‰é‡å¤è¿‡ç¨‹çš„æš´åŠ›é€’å½’</p><p>ä½†ä¸æ˜¯æ‰€æœ‰çš„æš´åŠ›é€’å½’ï¼Œéƒ½ä¸€å®šå¯¹åº”ç€åŠ¨æ€è§„åˆ’</p><hr><h3 id="å¦‚ä½•æ‰¾åˆ°é—®é¢˜çš„åŠ¨æ€è§„åˆ’æ–¹å¼ï¼Ÿ">å¦‚ä½•æ‰¾åˆ°é—®é¢˜çš„åŠ¨æ€è§„åˆ’æ–¹å¼ï¼Ÿ</h3><ul><li>è®¾è®¡æš´åŠ›é€’å½’ï¼šåŸåˆ™+4ç§å¸¸è§å°è¯•æ¨¡å‹ï¼</li><li>åˆ†ææœ‰æ²¡æœ‰é‡å¤è§£</li><li>ç”¨è®°å¿†åŒ–æœç´¢-&gt;ç”¨ä¸¥æ ¼è¡¨ç»“æ„å®ç°åŠ¨æ€è§„åˆ’</li><li>çœ‹çœ‹èƒ½å¦ç»§ç»­ä¼˜åŒ–</li></ul><hr><h3 id="è®¾è®¡æš´åŠ›é€’å½’è¿‡ç¨‹çš„åŸåˆ™">è®¾è®¡æš´åŠ›é€’å½’è¿‡ç¨‹çš„åŸåˆ™</h3><p>1ï¼‰æ¯ä¸€ä¸ªå¯å˜å‚æ•°çš„ç±»å‹ï¼Œä¸€å®šä¸è¦æ¯”intç±»å‹æ›´åŠ å¤æ‚</p><p>2ï¼‰åŸåˆ™1ï¼‰å¯ä»¥è¿åï¼Œè®©ç±»å‹çªç ´åˆ°ä¸€ç»´çº¿æ€§ç»“æ„ï¼Œé‚£å¿…é¡»æ˜¯å•ä¸€å¯å˜å‚æ•°ï¼ˆè´´çº¸é—®é¢˜ï¼‰</p><p>3ï¼‰å¦‚æœå‘ç°åŸåˆ™1ï¼‰è¢«è¿åï¼Œä½†ä¸è¿ååŸåˆ™2ï¼‰ï¼Œåªéœ€è¦åšåˆ°è®°å¿†åŒ–æœç´¢å³å¯</p><p>4ï¼‰å¯å˜å‚æ•°çš„ä¸ªæ•°ï¼Œèƒ½å°‘åˆ™å°‘</p><p>ä¸€å®šè¦é€¼è‡ªå·±æ‰¾åˆ°ä¸è¿ååŸåˆ™æƒ…å†µä¸‹çš„æš´åŠ›å°è¯•ï¼</p><p>å¦‚æœä½ æ‰¾åˆ°çš„æš´åŠ›å°è¯•ï¼Œä¸ç¬¦åˆåŸåˆ™ï¼Œé©¬ä¸Šèˆå¼ƒï¼æ‰¾æ–°çš„ï¼</p><p>å¦‚æœæŸä¸ªé¢˜ç›®çªç ´äº†è®¾è®¡åŸåˆ™ï¼Œä¸€å®šæéš¾æéš¾ï¼Œé¢è¯•ä¸­å‡ºç°æ¦‚ç‡ä½äº5%ï¼</p><hr><h3 id="å¸¸è§çš„4ç§å°è¯•æ¨¡å‹">å¸¸è§çš„4ç§å°è¯•æ¨¡å‹</h3><p>1ï¼‰ä»å·¦å¾€å³çš„å°è¯•æ¨¡å‹ï¼šå…³æ³¨iä½ç½®ç»“å°¾ï¼Œæˆ–è€…iä½ç½®å¼€å¤´çš„æƒ…å†µï¼Œæˆ–è€…çœ‹iè”åˆi+1,i+2çš„æƒ…å†µï¼Œå¡«è¡¨å¾€å¾€æ˜¯ä¸Šåˆ°ä¸‹ï¼Œæˆ–è€…ä¸‹åˆ°ä¸Šï¼Œå·¦åˆ°å³ï¼Œå³åˆ°å·¦ã€‚</p><p>2ï¼‰èŒƒå›´ä¸Šçš„å°è¯•æ¨¡å‹ï¼šå…³æ³¨Lå’ŒRçš„æƒ…å†µï¼Œå¡«è¡¨æ ¼å¼éå¸¸å›ºå®šï¼Œä¸»å¯¹è§’ï¼Œå‰¯å¯¹è§’ï¼Œå€’å›æ¥å¡«</p><p>3ï¼‰å¤šæ ·æœ¬ä½ç½®å…¨å¯¹åº”çš„å°è¯•æ¨¡å‹ï¼š2ä¸ªæ ·æœ¬ï¼Œä¸€ä¸ªæ ·æœ¬åšè¡Œï¼Œä¸€ä¸ªæ ·æœ¬åšåˆ—ï¼Œå…³æ³¨iå’Œjå¯¹åº”ä½ç½®çš„æƒ…å†µï¼Œå…ˆå¡«è¾¹ç•Œï¼Œå†å¡«ä¸­é—´</p><p>4ï¼‰å¯»æ‰¾ä¸šåŠ¡é™åˆ¶çš„å°è¯•æ¨¡å‹ï¼šæ¯”å¦‚èµ°æ£‹ç›˜ï¼Œå›ºå®šçš„å‡ ä¸ªæ–¹å‘å¯ä»¥èµ°ï¼Œå…ˆå¡«è¾¹ç•Œï¼Œå†å¡«ä¸­é—´ã€‚</p><hr><h3 id="æš´åŠ›é€’å½’åˆ°åŠ¨æ€è§„åˆ’çš„å¥—è·¯">æš´åŠ›é€’å½’åˆ°åŠ¨æ€è§„åˆ’çš„å¥—è·¯</h3><p>1ï¼‰ä½ å·²ç»æœ‰äº†ä¸€ä¸ªä¸è¿ååŸåˆ™çš„æš´åŠ›é€’å½’ï¼Œè€Œä¸”çš„ç¡®å­˜åœ¨è§£çš„é‡å¤è°ƒç”¨<br>2ï¼‰æ‰¾åˆ°å“ªäº›å‚æ•°çš„å˜åŒ–ä¼šå½±å“è¿”å›å€¼ï¼Œå¯¹æ¯ä¸€ä¸ªåˆ—å‡ºå˜åŒ–èŒƒå›´<br>3ï¼‰å‚æ•°é—´çš„æ‰€æœ‰çš„ç»„åˆæ•°é‡ï¼Œæ„å‘³ç€è¡¨å¤§å°<br>4ï¼‰è®°å¿†åŒ–æœç´¢çš„æ–¹æ³•å°±æ˜¯å‚»ç¼“å­˜ï¼Œéå¸¸å®¹æ˜“å¾—åˆ°<br>5ï¼‰è§„å®šå¥½ä¸¥æ ¼è¡¨çš„å¤§å°ï¼Œåˆ†æä½ç½®çš„ä¾èµ–é¡ºåºï¼Œç„¶åä»åŸºç¡€å¡«å†™åˆ°æœ€ç»ˆè§£<br>6ï¼‰å¯¹äºæœ‰æšä¸¾è¡Œä¸ºçš„å†³ç­–è¿‡ç¨‹ï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–</p><hr><h3 id="åŠ¨æ€è§„åˆ’çš„è¿›ä¸€æ­¥ä¼˜åŒ–">åŠ¨æ€è§„åˆ’çš„è¿›ä¸€æ­¥ä¼˜åŒ–</h3><p>1ï¼‰ç©ºé—´å‹ç¼©<br>2ï¼‰çŠ¶æ€åŒ–ç®€<br>3ï¼‰å››è¾¹å½¢ä¸ç­‰å¼</p><p>4ï¼‰å…¶ä»–ä¼˜åŒ–æŠ€å·§</p><hr><hr><h2 id="ä»å·¦å¾€å³çš„å°è¯•æ¨¡å‹">ä»å·¦å¾€å³çš„å°è¯•æ¨¡å‹</h2><p>å…³æ³¨iä½ç½®ç»“å°¾ï¼Œæˆ–è€…iä½ç½®å¼€å¤´çš„æƒ…å†µï¼Œæˆ–è€…çœ‹iè”åˆi+1,i+2çš„æƒ…å†µï¼Œå¡«è¡¨å¾€å¾€æ˜¯ä¸Šåˆ°ä¸‹ï¼Œæˆ–è€…ä¸‹åˆ°ä¸Šï¼Œå·¦åˆ°å³ï¼Œå³åˆ°å·¦ã€‚</p><h3 id="é¢˜ç›®ä¸€">é¢˜ç›®ä¸€</h3><p>å‡è®¾æœ‰æ’æˆä¸€è¡Œçš„Nä¸ªä½ç½®ï¼Œè®°ä¸º1~Nï¼ŒN ä¸€å®šå¤§äºæˆ–ç­‰äº2</p><p>å¼€å§‹æ—¶æœºå™¨äººåœ¨å…¶ä¸­çš„Mä½ç½®ä¸Š(M ä¸€å®šæ˜¯1~N ä¸­çš„ä¸€ä¸ªï¼‰</p><p>å¦‚æœæœºå™¨äººæ¥åˆ°1ä½ç½®ï¼Œé‚£ä¹ˆä¸‹ä¸€æ­¥åªèƒ½å¾€å³æ¥åˆ°2ä½ç½®ï¼›</p><p>å¦‚æœæœºå™¨äººæ¥åˆ°Nä½ç½®ï¼Œé‚£ä¹ˆä¸‹ä¸€æ­¥åªèƒ½å¾€å·¦æ¥åˆ° N-1 ä½ç½®ï¼›</p><p>å¦‚æœæœºå™¨äººæ¥åˆ°ä¸­é—´ä½ç½®ï¼Œé‚£ä¹ˆä¸‹ä¸€æ­¥å¯ä»¥å¾€å·¦èµ°æˆ–è€…å¾€å³èµ°ï¼›</p><p>è§„å®šæœºå™¨äººå¿…é¡»èµ°Kæ­¥ï¼Œæœ€ç»ˆèƒ½æ¥åˆ°Pä½ç½®(Pä¹Ÿæ˜¯1~Nä¸­çš„ä¸€ä¸ªï¼‰çš„æ–¹æ³•æœ‰å¤šå°‘ç§</p><p>ç»™å®šå››ä¸ªå‚æ•°Nã€Mã€Kã€Pï¼Œè¿”å›æ–¹æ³•æ•°ã€‚</p><div class="tabs" id="6fc3a967-8198-4bf8-900f-bd039c7f5726"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6fc3a967-8198-4bf8-900f-bd039c7f5726-1"><i class="fas fa-seedling"></i>æš´åŠ›é€’å½’</button></li><li class="tab"><button type="button" data-href="#6fc3a967-8198-4bf8-900f-bd039c7f5726-2"><i class="fas fa-leaf"></i>é‡å¤è§£åˆ†æ</button></li><li class="tab"><button type="button" data-href="#6fc3a967-8198-4bf8-900f-bd039c7f5726-3"><i class="fab fa-apple"></i>å‚»ç¼“å­˜æ³•</button></li><li class="tab"><button type="button" data-href="#6fc3a967-8198-4bf8-900f-bd039c7f5726-4"><i class="fas fa-heartbeat"></i>ä½ç½®ä¾èµ–åˆ†æ</button></li><li class="tab"><button type="button" data-href="#6fc3a967-8198-4bf8-900f-bd039c7f5726-5"><i class="fas fa-tree"></i>ä¸¥æ ¼è¡¨ç»“æ„</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6fc3a967-8198-4bf8-900f-bd039c7f5726-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">ways1</span><span class="params">(<span class="type">int</span> N, <span class="type">int</span> start, <span class="type">int</span> aim, <span class="type">int</span> K)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (N &lt; <span class="number">2</span> || start &lt; <span class="number">1</span> || start &gt; N || aim &lt; <span class="number">1</span> || aim &gt; N || K &lt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> process1(start, K, aim, N);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœºå™¨äººå½“å‰æ¥åˆ°çš„ä½ç½®æ˜¯curï¼Œ</span></span><br><span class="line"><span class="comment">// æœºå™¨äººè¿˜æœ‰restæ­¥éœ€è¦å»èµ°ï¼Œ</span></span><br><span class="line"><span class="comment">// æœ€ç»ˆçš„ç›®æ ‡æ˜¯aimï¼Œ</span></span><br><span class="line"><span class="comment">// æœ‰å“ªäº›ä½ç½®ï¼Ÿ1~N</span></span><br><span class="line"><span class="comment">// è¿”å›ï¼šæœºå™¨äººä»curå‡ºå‘ï¼Œèµ°è¿‡restæ­¥ä¹‹åï¼Œæœ€ç»ˆåœåœ¨aimçš„æ–¹æ³•æ•°ï¼Œæ˜¯å¤šå°‘ï¼Ÿ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">process1</span><span class="params">(<span class="type">int</span> cur, <span class="type">int</span> rest, <span class="type">int</span> aim, <span class="type">int</span> N)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (rest == <span class="number">0</span>) &#123; <span class="comment">// å¦‚æœå·²ç»ä¸éœ€è¦èµ°äº†ï¼Œèµ°å®Œäº†ï¼</span></span><br><span class="line"><span class="keyword">return</span> cur == aim ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// (cur, rest)</span></span><br><span class="line"><span class="keyword">if</span> (cur == <span class="number">1</span>) &#123; <span class="comment">// 1 -&gt; 2</span></span><br><span class="line"><span class="keyword">return</span> process1(<span class="number">2</span>, rest - <span class="number">1</span>, aim, N);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// (cur, rest)</span></span><br><span class="line"><span class="keyword">if</span> (cur == N) &#123; <span class="comment">// N-1 &lt;- N</span></span><br><span class="line"><span class="keyword">return</span> process1(N - <span class="number">1</span>, rest - <span class="number">1</span>, aim, N);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// (cur, rest)</span></span><br><span class="line"><span class="keyword">return</span> process1(cur - <span class="number">1</span>, rest - <span class="number">1</span>, aim, N) + process1(cur + <span class="number">1</span>, rest - <span class="number">1</span>, aim, N);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6fc3a967-8198-4bf8-900f-bd039c7f5726-2"><p>å‡å¦‚ä»7ä½ç½®å‡ºå‘èµ°åˆ°13ï¼Œè¿˜æœ‰10æ­¥éœ€è¦èµ°ï¼Œå­˜åœ¨é‡å¤è§£ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230706110749520.png" alt="image-20230706110749520" style="zoom:67%;" /><p>curå’Œrestæ˜¯å†³å®šè¿”å›å€¼çš„key</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6fc3a967-8198-4bf8-900f-bd039c7f5726-3"><p>è®°å¿†åŒ–æœç´¢ï¼ˆä»é¡¶å‘ä¸‹çš„åŠ¨æ€è§„åˆ’ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">ways2</span><span class="params">(<span class="type">int</span> N, <span class="type">int</span> start, <span class="type">int</span> aim, <span class="type">int</span> K)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (N &lt; <span class="number">2</span> || start &lt; <span class="number">1</span> || start &gt; N || aim &lt; <span class="number">1</span> || aim &gt; N || K &lt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[N + <span class="number">1</span>][K + <span class="number">1</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= N; i++) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt;= K; j++) &#123;</span><br><span class="line">dp[i][j] = -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// dpå°±æ˜¯ç¼“å­˜è¡¨</span></span><br><span class="line"><span class="comment">// dp[cur][rest] == -1 -&gt; process1(cur, rest)ä¹‹å‰æ²¡ç®—è¿‡ï¼</span></span><br><span class="line"><span class="comment">// dp[cur][rest] != -1 -&gt; process1(cur, rest)ä¹‹å‰ç®—è¿‡ï¼è¿”å›å€¼ï¼Œdp[cur][rest]</span></span><br><span class="line"><span class="comment">// N+1 * K+1</span></span><br><span class="line"><span class="keyword">return</span> process2(start, K, aim, N, dp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// cur èŒƒ: 1 ~ N</span></span><br><span class="line"><span class="comment">// rest èŒƒï¼š0 ~ K</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">process2</span><span class="params">(<span class="type">int</span> cur, <span class="type">int</span> rest, <span class="type">int</span> aim, <span class="type">int</span> N, <span class="type">int</span>[][] dp)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (dp[cur][rest] != -<span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> dp[cur][rest];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä¹‹å‰æ²¡ç®—è¿‡ï¼</span></span><br><span class="line"><span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (rest == <span class="number">0</span>) &#123;</span><br><span class="line">ans = cur == aim ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur == <span class="number">1</span>) &#123;</span><br><span class="line">ans = process2(<span class="number">2</span>, rest - <span class="number">1</span>, aim, N, dp);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur == N) &#123;</span><br><span class="line">ans = process2(N - <span class="number">1</span>, rest - <span class="number">1</span>, aim, N, dp);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ans = process2(cur - <span class="number">1</span>, rest - <span class="number">1</span>, aim, N, dp) + process2(cur + <span class="number">1</span>, rest - <span class="number">1</span>, aim, N, dp);</span><br><span class="line">&#125;</span><br><span class="line">dp[cur][rest] = ans;</span><br><span class="line"><span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6fc3a967-8198-4bf8-900f-bd039c7f5726-4"><p>å‡è®¾ç°åœ¨æœ‰5ä¸ªä½ç½®ï¼Œæœºå™¨äººå½“å‰åœ¨2ä½ç½®ï¼Œè¦å‰å¾€4ä½ç½®ï¼Œæœ‰6æ­¥éœ€è¦èµ°</p><p>å³N = 5ï¼Œcur=2ï¼Œaim=4ï¼Œrest=6</p><div class="tabs" id="ada86bca-98db-41ea-ad53-a4296606c901"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ada86bca-98db-41ea-ad53-a4296606c901-1"><i class="fas fa-cat"></i>åˆå§‹æƒ…å†µ</button></li><li class="tab"><button type="button" data-href="#ada86bca-98db-41ea-ad53-a4296606c901-2"><i class="fas fa-horse"></i>basecaseå’Œans</button></li><li class="tab"><button type="button" data-href="#ada86bca-98db-41ea-ad53-a4296606c901-3"><i class="fas fa-dove"></i>æ™®éä½ç½®ä¾èµ–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ada86bca-98db-41ea-ad53-a4296606c901-1"><p>cur = 0ä½ç½®æ˜¯å¼ƒç”¨çš„ï¼Œcuråªèƒ½æ˜¯1-N</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E5%88%9D%E5%A7%8B%E6%83%85%E5%86%B51.png" alt="åˆå§‹æƒ…å†µ1"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ada86bca-98db-41ea-ad53-a4296606c901-2"><p>ä¸»å‡½æ•°ä¸­</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">return</span> <span class="title">process1</span><span class="params">(start, K, aim, N)</span></span>;</span><br></pre></td></tr></table></figure><p>æš´åŠ›é€’å½’å‡½æ•°ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (rest == <span class="number">0</span>) &#123; <span class="comment">// å¦‚æœå·²ç»ä¸éœ€è¦èµ°äº†ï¼Œèµ°å®Œäº†ï¼</span></span><br><span class="line"><span class="keyword">return</span> cur == aim ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“restç­‰äº0æ—¶ï¼Œåªæœ‰cur==aimæ˜¯ï¼Œæ‰æ˜¯1ï¼Œæœ€ç»ˆéœ€è¦process(2,6)</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/baseCase%E5%92%8Cans1.png" alt="baseCaseå’Œans1"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ada86bca-98db-41ea-ad53-a4296606c901-3"><p>æš´åŠ›é€’å½’ä¸­</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (cur, rest)</span></span><br><span class="line">if (cur == <span class="number">1</span>) &#123; <span class="comment">// 1 -&gt; 2</span></span><br><span class="line">return <span class="built_in">process1</span>(<span class="number">2</span>, rest - <span class="number">1</span>, aim, N);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// (cur, rest)</span></span><br><span class="line">if (cur == N) &#123; <span class="comment">// N-1 &lt;- N</span></span><br><span class="line">return <span class="built_in">process1</span>(N - <span class="number">1</span>, rest - <span class="number">1</span>, aim, N);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// (cur, rest)</span></span><br><span class="line">return <span class="built_in">process1</span>(cur - <span class="number">1</span>, rest - <span class="number">1</span>, aim, N) + <span class="built_in">process1</span>(cur + <span class="number">1</span>, rest - <span class="number">1</span>, aim, N);</span><br></pre></td></tr></table></figure><p>æ—¢ä¸æ˜¯ç¬¬ä¸€è¡Œï¼Œä¹Ÿä¸æœ€åä¸€è¡Œï¼Œæ™®éä½ç½®ä¾èµ–åä¸Šè§’çš„å€¼å’Œåä¸‹è§’çš„å€¼</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E6%99%AE%E9%81%8D%E4%BD%8D%E7%BD%AE1.png" alt="æ™®éä½ç½®1"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6fc3a967-8198-4bf8-900f-bd039c7f5726-5"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">ways3</span><span class="params">(<span class="type">int</span> N, <span class="type">int</span> start, <span class="type">int</span> aim, <span class="type">int</span> K)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (N &lt; <span class="number">2</span> || start &lt; <span class="number">1</span> || start &gt; N || aim &lt; <span class="number">1</span> || aim &gt; N || K &lt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[N + <span class="number">1</span>][K + <span class="number">1</span>];</span><br><span class="line">dp[aim][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">rest</span> <span class="operator">=</span> <span class="number">1</span>; rest &lt;= K; rest++) &#123;</span><br><span class="line">dp[<span class="number">1</span>][rest] = dp[<span class="number">2</span>][rest - <span class="number">1</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">cur</span> <span class="operator">=</span> <span class="number">2</span>; cur &lt; N; cur++) &#123;</span><br><span class="line">dp[cur][rest] = dp[cur - <span class="number">1</span>][rest - <span class="number">1</span>] + dp[cur + <span class="number">1</span>][rest - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line">dp[N][rest] = dp[N - <span class="number">1</span>][rest - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dp[start][K];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="é¢˜ç›®äºŒ">é¢˜ç›®äºŒ</h3><p>è§„å®š1å’ŒAå¯¹åº”ã€2å’ŒBå¯¹åº”ã€3å’ŒCå¯¹åº”â€¦</p><p>é‚£ä¹ˆä¸€ä¸ªæ•°å­—å­—ç¬¦ä¸²æ¯”å¦‚&quot;111&quot;å°±å¯ä»¥è½¬åŒ–ä¸ºï¼šâ€œAAAâ€ã€â€œKA&quot;å’Œ&quot;AKâ€</p><p>ç»™å®šä¸€ä¸ªåªæœ‰æ•°å­—å­—ç¬¦ç»„æˆçš„å­—ç¬¦ä¸²strï¼Œè¿”å›æœ‰å¤šå°‘ç§è½¬åŒ–ç»“æœ</p><div class="tabs" id="2b7683cc-3522-45ca-9ef3-7374aaed0b7a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2b7683cc-3522-45ca-9ef3-7374aaed0b7a-1"><i class="fas fa-cat"></i>æš´åŠ›å°è¯•</button></li><li class="tab"><button type="button" data-href="#2b7683cc-3522-45ca-9ef3-7374aaed0b7a-2"><i class="fas fa-horse"></i>é‡å¤é—®é¢˜åˆ†æ</button></li><li class="tab"><button type="button" data-href="#2b7683cc-3522-45ca-9ef3-7374aaed0b7a-3"><i class="fas fa-dragon"></i>ä¸¥æ ¼è¡¨ç»“æ„</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2b7683cc-3522-45ca-9ef3-7374aaed0b7a-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// stråªå«æœ‰æ•°å­—å­—ç¬¦0~9</span></span><br><span class="line"><span class="comment">// è¿”å›å¤šå°‘ç§è½¬åŒ–æ–¹æ¡ˆ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">number</span><span class="params">(String str)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (str == <span class="literal">null</span> || str.length() == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> process(str.toCharArray(), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// str[0..i-1]è½¬åŒ–æ— éœ€è¿‡é—®</span></span><br><span class="line"><span class="comment">// str[i.....]å»è½¬åŒ–ï¼Œè¿”å›æœ‰å¤šå°‘ç§è½¬åŒ–æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">process</span><span class="params">(<span class="type">char</span>[] str, <span class="type">int</span> i)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (i == str.length) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// iæ²¡åˆ°æœ€åï¼Œè¯´æ˜æœ‰å­—ç¬¦</span></span><br><span class="line"><span class="keyword">if</span> (str[i] == <span class="string">&#x27;0&#x27;</span>) &#123; <span class="comment">// ä¹‹å‰çš„å†³å®šæœ‰é—®é¢˜</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// str[i] != &#x27;0&#x27;</span></span><br><span class="line"><span class="comment">// å¯èƒ½æ€§ä¸€ï¼Œiå•è½¬</span></span><br><span class="line"><span class="type">int</span> <span class="variable">ways</span> <span class="operator">=</span> process(str, i + <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (i + <span class="number">1</span> &lt; str.length &amp;&amp; (str[i] - <span class="string">&#x27;0&#x27;</span>) * <span class="number">10</span> + str[i + <span class="number">1</span>] - <span class="string">&#x27;0&#x27;</span> &lt; <span class="number">27</span>) &#123;</span><br><span class="line">ways += process(str, i + <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ways;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2b7683cc-3522-45ca-9ef3-7374aaed0b7a-2"><p>å‡å¦‚str = â€œ111â€</p><p>ä¸¤ä¸ª1 è§£è¯»ä¸ºä¸¤ä¸ªå­—ç¬¦  p(0)-&gt;p(2)</p><p>ä¸¤ä¸ª1 è§£è¯»ä¸ºä¸€ä¸ªå­—ç¬¦  p(0)-&gt;p(2)</p><p>å­˜åœ¨é‡å¤é—®é¢˜</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2b7683cc-3522-45ca-9ef3-7374aaed0b7a-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">dp</span><span class="params">(String s)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (s == <span class="literal">null</span> || s.length() == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">char</span>[] str = s.toCharArray();</span><br><span class="line"><span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> str.length;</span><br><span class="line"><span class="type">int</span>[] dp = <span class="keyword">new</span> <span class="title class_">int</span>[N + <span class="number">1</span>];</span><br><span class="line">dp[N] = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> N - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line"><span class="keyword">if</span> (str[i] != <span class="string">&#x27;0&#x27;</span>) &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">ways</span> <span class="operator">=</span> dp[i + <span class="number">1</span>];</span><br><span class="line"><span class="keyword">if</span> (i + <span class="number">1</span> &lt; str.length &amp;&amp; (str[i] - <span class="string">&#x27;0&#x27;</span>) * <span class="number">10</span> + str[i + <span class="number">1</span>] - <span class="string">&#x27;0&#x27;</span> &lt; <span class="number">27</span>) &#123;</span><br><span class="line">ways += dp[i + <span class="number">2</span>];</span><br><span class="line">&#125;</span><br><span class="line">dp[i] = ways;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dp[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="èƒŒåŒ…é—®é¢˜">èƒŒåŒ…é—®é¢˜</h3><div class="tabs" id="46bf3a18-2b78-4cc8-9cdb-5b3488599afc"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#46bf3a18-2b78-4cc8-9cdb-5b3488599afc-1"><i class="fas fa-bug"></i>æš´åŠ›é€’å½’</button></li><li class="tab"><button type="button" data-href="#46bf3a18-2b78-4cc8-9cdb-5b3488599afc-2"><i class="fas fa-cannabis"></i>é‡å¤è§£åˆ†æ</button></li><li class="tab"><button type="button" data-href="#46bf3a18-2b78-4cc8-9cdb-5b3488599afc-3"><i class="fas fa-candy-cane"></i>ä½ç½®ä¾èµ–åˆ†æ</button></li><li class="tab"><button type="button" data-href="#46bf3a18-2b78-4cc8-9cdb-5b3488599afc-4"><i class="fas fa-child"></i>ä¸¥æ ¼ä½ç½®ä¾èµ–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="46bf3a18-2b78-4cc8-9cdb-5b3488599afc-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰€æœ‰çš„è´§ï¼Œé‡é‡å’Œä»·å€¼ï¼Œéƒ½åœ¨wå’Œvæ•°ç»„é‡Œ</span></span><br><span class="line"><span class="comment">// ä¸ºäº†æ–¹ä¾¿ï¼Œå…¶ä¸­æ²¡æœ‰è´Ÿæ•°</span></span><br><span class="line"><span class="comment">// bagèƒŒåŒ…å®¹é‡ï¼Œä¸èƒ½è¶…è¿‡è¿™ä¸ªè½½é‡</span></span><br><span class="line"><span class="comment">// è¿”å›ï¼šä¸è¶…é‡çš„æƒ…å†µä¸‹ï¼Œèƒ½å¤Ÿå¾—åˆ°çš„æœ€å¤§ä»·å€¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">maxValue</span><span class="params">(<span class="type">int</span>[] w, <span class="type">int</span>[] v, <span class="type">int</span> bag)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (w == <span class="literal">null</span> || v == <span class="literal">null</span> || w.length != v.length || w.length == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å°è¯•å‡½æ•°ï¼</span></span><br><span class="line"><span class="keyword">return</span> process(w, v, <span class="number">0</span>, bag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“å‰è€ƒè™‘åˆ°äº†indexå·è´§ç‰©ï¼Œindex...æ‰€æœ‰çš„è´§ç‰©å¯ä»¥è‡ªç”±é€‰æ‹©</span></span><br><span class="line"><span class="comment">// åšçš„é€‰æ‹©ä¸èƒ½è¶…è¿‡èƒŒåŒ…å®¹é‡</span></span><br><span class="line"><span class="comment">// è¿”å›æœ€å¤§ä»·å€¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">process</span><span class="params">(<span class="type">int</span>[] w, <span class="type">int</span>[] v, <span class="type">int</span> index, <span class="type">int</span> rest)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (rest &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (index == w.length) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// ä¸è¦å½“å‰çš„è´§</span></span><br><span class="line"><span class="type">int</span> <span class="variable">p1</span> <span class="operator">=</span> process(w, v, index + <span class="number">1</span>, rest);</span><br><span class="line">  <span class="comment">// è¦å½“å‰çš„è´§</span></span><br><span class="line"><span class="type">int</span> <span class="variable">p2</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> process(w, v, index + <span class="number">1</span>, rest - w[index]);</span><br><span class="line"><span class="keyword">if</span> (next != -<span class="number">1</span>) &#123;</span><br><span class="line">p2 = v[index] + next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> Math.max(p1, p2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="46bf3a18-2b78-4cc8-9cdb-5b3488599afc-2"><p>w = [3,2,5â€¦]</p><p>v = [7,4,6â€¦]</p><p>bag = 15</p><p>è¦äº†0ï¼Œ1å·è´§ï¼Œæ²¡è¦2å·è´§è°ƒç”¨è¿‡ç¨‹  p(0,15)-&gt;p(1,12)-p(2,10)-&gt;p(3,10)</p><p>æ²¡è¦0ï¼Œ1ï¼Œä½†æ˜¯è¦äº†2å·è´§è°ƒç”¨è¿‡ç¨‹ p(0,15)-&gt;p(1,15)-&gt;p(2,15)-&gt;p(3,10)</p><p>å­˜åœ¨é‡å¤è°ƒç”¨</p><p>index rest å³ä¸ºå˜é‡</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="46bf3a18-2b78-4cc8-9cdb-5b3488599afc-3"><p>å‡è®¾èƒŒåŒ…å¤§å°ä¸º10ï¼Œå…±æœ‰4ä»¶ç‰©å“</p><div class="tabs" id="e59b06c7-c7b9-4440-bffd-7640af43b5de"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e59b06c7-c7b9-4440-bffd-7640af43b5de-1"><i class="fas fa-seedling"></i>basecaseå’Œans</button></li><li class="tab"><button type="button" data-href="#e59b06c7-c7b9-4440-bffd-7640af43b5de-2"><i class="fas fa-leaf"></i>æ™®éä½ç½®åˆ†æ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e59b06c7-c7b9-4440-bffd-7640af43b5de-1"><p>index åœ¨é€’å½’ä¸­æ˜¯å¯ä»¥åˆ°w.lengthçš„</p><p>æœ€ç»ˆéœ€è¦process(0,bag)çŠ¶æ€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (rest &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (index == w.length) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E8%83%8C%E5%8C%85%E9%97%AE%E9%A2%98basecase.png" alt="èƒŒåŒ…é—®é¢˜basecase"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e59b06c7-c7b9-4440-bffd-7640af43b5de-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// ä¸è¦å½“å‰çš„è´§</span></span><br><span class="line"><span class="type">int</span> <span class="variable">p1</span> <span class="operator">=</span> process(w, v, index + <span class="number">1</span>, rest);</span><br><span class="line"> <span class="comment">// è¦å½“å‰çš„è´§</span></span><br><span class="line"><span class="type">int</span> <span class="variable">p2</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> process(w, v, index + <span class="number">1</span>, rest - w[index]);</span><br><span class="line"><span class="keyword">if</span> (next != -<span class="number">1</span>) &#123;</span><br><span class="line">p2 = v[index] + next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾</p><p>w[1] = 2 v[1] = 4ï¼Œåˆ™æ™®éä½ç½®ï¼Ÿä¾èµ–å¦‚å›¾æ‰€ç¤º</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E8%83%8C%E5%8C%85%E9%97%AE%E9%A2%98%E6%99%AE%E9%81%8D%E4%BD%8D%E7%BD%AE%E4%BE%9D%E8%B5%96.png" alt="èƒŒåŒ…é—®é¢˜æ™®éä½ç½®ä¾èµ–"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="46bf3a18-2b78-4cc8-9cdb-5b3488599afc-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">dp</span><span class="params">(<span class="type">int</span>[] w, <span class="type">int</span>[] v, <span class="type">int</span> bag)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (w == <span class="literal">null</span> || v == <span class="literal">null</span> || w.length != v.length || w.length == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> w.length;</span><br><span class="line"><span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[N + <span class="number">1</span>][bag + <span class="number">1</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> N - <span class="number">1</span>; index &gt;= <span class="number">0</span>; index--) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">rest</span> <span class="operator">=</span> <span class="number">0</span>; rest &lt;= bag; rest++) &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">p1</span> <span class="operator">=</span> dp[index + <span class="number">1</span>][rest];</span><br><span class="line"><span class="type">int</span> <span class="variable">p2</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> rest - w[index] &lt; <span class="number">0</span> ? -<span class="number">1</span> : dp[index + <span class="number">1</span>][rest - w[index]];</span><br><span class="line"><span class="keyword">if</span> (next != -<span class="number">1</span>) &#123;</span><br><span class="line">p2 = v[index] + next;</span><br><span class="line">&#125;</span><br><span class="line">dp[index][rest] = Math.max(p1, p2);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dp[<span class="number">0</span>][bag];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="é›¶é’±å…‘æ¢é—®é¢˜">é›¶é’±å…‘æ¢é—®é¢˜</h3><h4 id="é›¶é’±å…‘æ¢é—®é¢˜â… ">é›¶é’±å…‘æ¢é—®é¢˜â… </h4><p>arræ˜¯è´§å¸æ•°ç»„ï¼Œå…¶ä¸­çš„å€¼éƒ½æ˜¯æ­£æ•°ã€‚å†ç»™å®šä¸€ä¸ªæ­£æ•°aimã€‚</p><p>æ¯ä¸ªå€¼éƒ½è®¤ä¸ºæ˜¯ä¸€å¼ è´§å¸ï¼Œå³ä¾¿æ˜¯å€¼ç›¸åŒçš„è´§å¸ä¹Ÿè®¤ä¸ºæ¯ä¸€å¼ éƒ½æ˜¯ä¸åŒçš„ã€‚</p><p>è¿”å›ç»„æˆaimçš„æ–¹æ³•æ•°</p><p>ä¾‹å¦‚ï¼šart ={1,1,1} aim = 2</p><p>ç¬¬0ä¸ªå’Œç¬¬1ä¸ªèƒ½ç»„æˆ2ï¼Œç¬¬1ä¸ªå’Œç¬¬2ä¸ªèƒ½ç»„æˆ2ï¼Œç¬¬0ä¸ªå’Œç¬¬2ä¸ªèƒ½ç»„æˆ2 ä¸€å…±å°±3ç§æ–¹æ³•ï¼Œæ‰€ä»¥è¿”å›3</p><div class="tabs" id="183f6f4e-28dc-487b-81f9-db439f37ab9c"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#183f6f4e-28dc-487b-81f9-db439f37ab9c-1"><i class="fas fa-atom"></i>æš´åŠ›é€’å½’</button></li><li class="tab"><button type="button" data-href="#183f6f4e-28dc-487b-81f9-db439f37ab9c-2"><i class="far fa-sun"></i>ä¸¥æ ¼è¡¨ç»“æ„</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="183f6f4e-28dc-487b-81f9-db439f37ab9c-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">coinWays</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> aim)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> process(arr, <span class="number">0</span>, aim);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// arr[index....] ç»„æˆæ­£å¥½restè¿™ä¹ˆå¤šçš„é’±ï¼Œæœ‰å‡ ç§æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">process</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> index, <span class="type">int</span> rest)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (rest &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (index == arr.length) &#123; <span class="comment">// æ²¡é’±äº†ï¼</span></span><br><span class="line"><span class="keyword">return</span> rest == <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> process(arr, index + <span class="number">1</span>, rest) + process(arr, index + <span class="number">1</span>, rest - arr[index]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="183f6f4e-28dc-487b-81f9-db439f37ab9c-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">dp</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> aim)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (aim == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> arr.length;</span><br><span class="line"><span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[N + <span class="number">1</span>][aim + <span class="number">1</span>];</span><br><span class="line">dp[N][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> N - <span class="number">1</span>; index &gt;= <span class="number">0</span>; index--) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">rest</span> <span class="operator">=</span> <span class="number">0</span>; rest &lt;= aim; rest++) &#123;</span><br><span class="line">dp[index][rest] = dp[index + <span class="number">1</span>][rest] + (rest - arr[index] &gt;= <span class="number">0</span> ? dp[index + <span class="number">1</span>][rest - arr[index]] : <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dp[<span class="number">0</span>][aim];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h4 id="é›¶é’±å…‘æ¢é—®é¢˜â…¡-æ–œç‡ä¼˜åŒ–">é›¶é’±å…‘æ¢é—®é¢˜â…¡(æ–œç‡ä¼˜åŒ–)</h4><p>arræ˜¯é¢å€¼æ•°ç»„ï¼Œå…¶ä¸­çš„å€¼éƒ½æ˜¯æ­£æ•°ä¸”æ²¡æœ‰é‡å¤ã€‚å†ç»™å®šä¸€ä¸ªæ­£æ•°aimã€‚</p><p>æ¯ä¸ªå€¼éƒ½è®¤ä¸ºæ˜¯ä¸€ç§é¢å€¼ï¼Œä¸”è®¤ä¸ºå¼ æ•°æ˜¯æ— é™çš„ï¼Œè¿”å›ç»„æˆaimçš„æ–¹æ³•æ•°ã€‚</p><p>ä¾‹å¦‚ï¼šarr ={1,2)ï¼Œ aim = 4</p><p>æ–¹æ³•å¦‚ä¸‹ï¼š1+1+1+1ã€1+1+2ã€2+2ä¸€å…±å°±3ç§æ–¹æ³•ï¼Œæ‰€ä»¥è¿”å›3</p><div class="tabs" id="cb88b2dc-c5ff-4cd0-bb1d-d08fe7f92cb1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#cb88b2dc-c5ff-4cd0-bb1d-d08fe7f92cb1-1"><i class="fas fa-bug"></i>æš´åŠ›é€’å½’</button></li><li class="tab"><button type="button" data-href="#cb88b2dc-c5ff-4cd0-bb1d-d08fe7f92cb1-2"><i class="fas fa-cannabis"></i>ä½ç½®ä¾èµ–åˆ†æ</button></li><li class="tab"><button type="button" data-href="#cb88b2dc-c5ff-4cd0-bb1d-d08fe7f92cb1-3"><i class="fas fa-candy-cane"></i>ä¸¥æ ¼è¡¨ç»“æ„</button></li><li class="tab"><button type="button" data-href="#cb88b2dc-c5ff-4cd0-bb1d-d08fe7f92cb1-4"><i class="fas fa-child"></i>æ–œç‡ä¼˜åŒ–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="cb88b2dc-c5ff-4cd0-bb1d-d08fe7f92cb1-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">coinsWay</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> aim)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (arr == <span class="literal">null</span> || arr.length == <span class="number">0</span> || aim &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> process(arr, <span class="number">0</span>, aim);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// arr[index....] æ‰€æœ‰çš„é¢å€¼ï¼Œæ¯ä¸€ä¸ªé¢å€¼éƒ½å¯ä»¥ä»»æ„é€‰æ‹©å¼ æ•°ï¼Œç»„æˆæ­£å¥½restè¿™ä¹ˆå¤šé’±ï¼Œæ–¹æ³•æ•°å¤šå°‘ï¼Ÿ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">process</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> index, <span class="type">int</span> rest)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (index == arr.length) &#123; <span class="comment">// æ²¡é’±äº†</span></span><br><span class="line"><span class="keyword">return</span> rest == <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">ways</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">zhang</span> <span class="operator">=</span> <span class="number">0</span>; zhang * arr[index] &lt;= rest; zhang++) &#123;</span><br><span class="line">ways += process(arr, index + <span class="number">1</span>, rest - (zhang * arr[index]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ways;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cb88b2dc-c5ff-4cd0-bb1d-d08fe7f92cb1-2"><p>index = 2 æ—¶   é¢å€¼ä¸º3</p><p>f(2,10) -&gt; f(3,10)  f(3,7)  f(3,4)  f(3,1)</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E9%9B%B6%E9%92%B1%E5%85%91%E6%8D%A21111.png" alt="é›¶é’±å…‘æ¢1111"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cb88b2dc-c5ff-4cd0-bb1d-d08fe7f92cb1-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">dp1</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> aim)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (arr == <span class="literal">null</span> || arr.length == <span class="number">0</span> || aim &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> arr.length;</span><br><span class="line"><span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[N + <span class="number">1</span>][aim + <span class="number">1</span>];</span><br><span class="line">dp[N][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> N - <span class="number">1</span>; index &gt;= <span class="number">0</span>; index--) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">rest</span> <span class="operator">=</span> <span class="number">0</span>; rest &lt;= aim; rest++) &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">ways</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">zhang</span> <span class="operator">=</span> <span class="number">0</span>; zhang * arr[index] &lt;= rest; zhang++) &#123;</span><br><span class="line">ways += dp[index + <span class="number">1</span>][rest - (zhang * arr[index])];</span><br><span class="line">&#125;</span><br><span class="line">dp[index][rest] = ways;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dp[<span class="number">0</span>][aim];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cb88b2dc-c5ff-4cd0-bb1d-d08fe7f92cb1-4"><p>å½“ä¸€ä¸ªæ ¼å­æ²¡æœ‰æšä¸¾è¡Œä¸ºï¼Œåªä¾èµ–æœ‰é™çš„æ ¼å­æ—¶ï¼Œè®°å¿†åŒ–æœç´¢å’Œä¸¥æ ¼è¡¨ç»“æ„ä¸€æ ·çš„å¥½</p><p>å½“ä¸€ä¸ªæ ¼å­æœ‰æšä¸¾è¡Œä¸ºï¼Œå¯ä»¥æ ¹æ®ä½ç½®ä¾èµ–ä¸¥æ ¼è¡¨ç»“æ„è¿›è¡Œåˆ†æï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–</p><p>index = 2 æ—¶   é¢å€¼ä¸º3</p><p>p(2,10) = p(3,10) +p(3,7)+p(3,4) +p(3,1)</p><p>æ³¨æ„çœ‹</p><p>p(2,7) = p(3,7)+p(3,4) +p(3,1)</p><p>æ‰€ä»¥</p><p>p(2,10) = p(3,10) +p(2,7)</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E9%9B%B6%E9%92%B1%E5%85%91%E6%8D%A2222.png" alt="é›¶é’±å…‘æ¢222"></p><p><mark class="hl-label blue">ä¼˜åŒ–</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">dp2</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> aim)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (arr == <span class="literal">null</span> || arr.length == <span class="number">0</span> || aim &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> arr.length;</span><br><span class="line"><span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[N + <span class="number">1</span>][aim + <span class="number">1</span>];</span><br><span class="line">dp[N][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> N - <span class="number">1</span>; index &gt;= <span class="number">0</span>; index--) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">rest</span> <span class="operator">=</span> <span class="number">0</span>; rest &lt;= aim; rest++) &#123;</span><br><span class="line">dp[index][rest] = dp[index + <span class="number">1</span>][rest];</span><br><span class="line"><span class="keyword">if</span> (rest - arr[index] &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">dp[index][rest] += dp[index][rest - arr[index]];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dp[<span class="number">0</span>][aim];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h4 id="é›¶é’±å…‘æ¢é—®é¢˜â…¢-æ–œç‡ä¼˜åŒ–">é›¶é’±å…‘æ¢é—®é¢˜â…¢(æ–œç‡ä¼˜åŒ–)</h4><p>arræ˜¯è´§å¸æ•°ç»„ï¼Œå…¶ä¸­çš„å€¼éƒ½æ˜¯æ­£æ•°ã€‚å†ç»™å®šä¸€ä¸ªæ­£æ•°aimã€‚</p><p>æ¯ä¸ªå€¼éƒ½è®¤ä¸ºæ˜¯ä¸€å¼ è´§å¸ï¼Œè®¤ä¸ºå€¼ç›¸åŒçš„è´§å¸æ²¡æœ‰ä»»ä½•ä¸åŒï¼Œ</p><p>è¿”å›ç»„æˆaimçš„æ–¹æ³•æ•°</p><p>ä¾‹å¦‚ï¼šarr={1,2,1,1,2,1,2)ï¼Œ aim = 4</p><p>æ–¹æ³•ï¼š1+1+1+1ã€ 1+1+2ã€ 2+2 ä¸€å…±å°±3ç§æ–¹æ³•ï¼Œæ‰€ä»¥è¿”å›3</p><div class="tabs" id="ed4bd118-c42d-44f9-809e-8f2da4af85c0"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ed4bd118-c42d-44f9-809e-8f2da4af85c0-1"><i class="fas fa-cat"></i>æš´åŠ›é€’å½’</button></li><li class="tab"><button type="button" data-href="#ed4bd118-c42d-44f9-809e-8f2da4af85c0-2"><i class="fas fa-horse"></i>ä½ç½®ä¾èµ–åˆ†æ</button></li><li class="tab"><button type="button" data-href="#ed4bd118-c42d-44f9-809e-8f2da4af85c0-3"><i class="fas fa-dove"></i>ä¸¥æ ¼è¡¨ç»“æ„</button></li><li class="tab"><button type="button" data-href="#ed4bd118-c42d-44f9-809e-8f2da4af85c0-4"><i class="fas fa-dragon"></i>æ–œç‡ä¼˜åŒ–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ed4bd118-c42d-44f9-809e-8f2da4af85c0-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">coinsWay</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> aim)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (arr == <span class="literal">null</span> || arr.length == <span class="number">0</span> || aim &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    HashMap&lt;Integer, Integer&gt; counts = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> value : arr) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!counts.containsKey(value)) &#123;</span><br><span class="line">            counts.put(value, <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            counts.put(value, counts.get(value) + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> counts.size();</span><br><span class="line">    <span class="type">int</span>[] coins = <span class="keyword">new</span> <span class="title class_">int</span>[N];</span><br><span class="line">    <span class="type">int</span>[] zhangs = <span class="keyword">new</span> <span class="title class_">int</span>[N];</span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Integer, Integer&gt; entry : counts.entrySet()) &#123;</span><br><span class="line">        coins[index] = entry.getKey();</span><br><span class="line">        zhangs[index++] = entry.getValue();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> process(coins, zhangs, <span class="number">0</span>, aim);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// coins é¢å€¼æ•°ç»„ï¼Œæ­£æ•°ä¸”å»é‡</span></span><br><span class="line"><span class="comment">// zhangs æ¯ç§é¢å€¼å¯¹åº”çš„å¼ æ•°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">process</span><span class="params">(<span class="type">int</span>[] coins, <span class="type">int</span>[] zhangs, <span class="type">int</span> index, <span class="type">int</span> rest)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (index == coins.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> rest == <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ways</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">zhang</span> <span class="operator">=</span> <span class="number">0</span>; zhang * coins[index] &lt;= rest &amp;&amp; zhang &lt;= zhangs[index]; zhang++) &#123;</span><br><span class="line">        ways += process(coins, zhangs, index + <span class="number">1</span>, rest - (zhang * coins[index]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ways;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ed4bd118-c42d-44f9-809e-8f2da4af85c0-2"><p>å‡è®¾aim = 13</p><p>è´§å¸æ•°è®¾å¤„ç†åä¸º</p><p>coins = [1,3,4]</p><p>zhangs = [1,2,3]</p><p>p(2,10) = a +b+c</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E9%9B%B6%E9%92%B1%E5%85%91%E6%8D%A2444.png" alt="é›¶é’±å…‘æ¢444"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ed4bd118-c42d-44f9-809e-8f2da4af85c0-3"><pre><code>public static int dp1(int[] arr, int aim) {if (arr == null || arr.length == 0 || aim &lt; 0) {return 0;}Info info = getInfo(arr);int[] coins = info.coins;int[] zhangs = info.zhangs;int N = coins.length;int[][] dp = new int[N + 1][aim + 1];dp[N][0] = 1;for (int index = N - 1; index &gt;= 0; index--) {for (int rest = 0; rest &lt;= aim; rest++) {int ways = 0;for (int zhang = 0; zhang * coins[index] &lt;= rest &amp;&amp; zhang &lt;= zhangs[index]; zhang++) {ways += dp[index + 1][rest - (zhang * coins[index])];}dp[index][rest] = ways;}}return dp[0][aim];}</code></pre><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ed4bd118-c42d-44f9-809e-8f2da4af85c0-4"><p>p(2,10) = a+b+c</p><p>p(2,7) = b+c+d</p><p>p(2,10) = a+p(2,7)-d</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E9%A2%86%E5%8F%96%E5%85%91%E6%8D%A2333.png" alt="é¢†å–å…‘æ¢333"></p><p><mark class="hl-label blue">ä¼˜åŒ–</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">dp2</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> aim)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (arr == <span class="literal">null</span> || arr.length == <span class="number">0</span> || aim &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">Info</span> <span class="variable">info</span> <span class="operator">=</span> getInfo(arr);</span><br><span class="line"><span class="type">int</span>[] coins = info.coins;</span><br><span class="line"><span class="type">int</span>[] zhangs = info.zhangs;</span><br><span class="line"><span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> coins.length;</span><br><span class="line"><span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[N + <span class="number">1</span>][aim + <span class="number">1</span>];</span><br><span class="line">dp[N][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> N - <span class="number">1</span>; index &gt;= <span class="number">0</span>; index--) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">rest</span> <span class="operator">=</span> <span class="number">0</span>; rest &lt;= aim; rest++) &#123;</span><br><span class="line">dp[index][rest] = dp[index + <span class="number">1</span>][rest];</span><br><span class="line"><span class="keyword">if</span> (rest - coins[index] &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">dp[index][rest] += dp[index][rest - coins[index]];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (rest - coins[index] * (zhangs[index] + <span class="number">1</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">dp[index][rest] -= dp[index + <span class="number">1</span>][rest - coins[index] * (zhangs[index] + <span class="number">1</span>)];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dp[<span class="number">0</span>][aim];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h4 id="é›¶é’±å…‘æ¢é—®é¢˜â…£-æ–œç‡ä¼˜åŒ–">é›¶é’±å…‘æ¢é—®é¢˜â…£(æ–œç‡ä¼˜åŒ–)</h4><p>aræ˜¯é¢å€¼æ•°ç»„ï¼Œå…¶ä¸­çš„å€¼éƒ½æ˜¯æ­£æ•°ä¸”æ²¡æœ‰é‡å¤ã€‚å†ç»™å®šä¸€ä¸ªæ­£æ•°aimã€‚</p><p>æ¯ä¸ªå€¼éƒ½è®¤ä¸ºæ˜¯ä¸€ç§é¢å€¼ï¼Œä¸”è®¤ä¸ºå¼ æ•°æ˜¯æ— é™çš„ã€‚</p><p>è¿”å›ç»„æˆaimçš„æœ€å°‘è´§å¸æ•°</p><div class="tabs" id="69bebcec-3ab2-400d-9c32-73b3d2ad7ffb"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#69bebcec-3ab2-400d-9c32-73b3d2ad7ffb-1"><i class="fas fa-cat"></i>æš´åŠ›é€’å½’</button></li><li class="tab"><button type="button" data-href="#69bebcec-3ab2-400d-9c32-73b3d2ad7ffb-2"><i class="fas fa-horse"></i>ä½ç½®ä¾èµ–åˆ†æ</button></li><li class="tab"><button type="button" data-href="#69bebcec-3ab2-400d-9c32-73b3d2ad7ffb-3"><i class="fas fa-dove"></i>ä¸¥æ ¼è¡¨ä¾èµ–</button></li><li class="tab"><button type="button" data-href="#69bebcec-3ab2-400d-9c32-73b3d2ad7ffb-4"><i class="fas fa-dragon"></i>æ–œç‡ä¼˜åŒ–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="69bebcec-3ab2-400d-9c32-73b3d2ad7ffb-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">minCoins</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> aim)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> process(arr, <span class="number">0</span>, aim);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// arr[index...]é¢å€¼ï¼Œæ¯ç§é¢å€¼å¼ æ•°è‡ªç”±é€‰æ‹©ï¼Œ</span></span><br><span class="line"><span class="comment">// æå‡ºrestæ­£å¥½è¿™ä¹ˆå¤šé’±ï¼Œè¿”å›æœ€å°å¼ æ•°</span></span><br><span class="line"><span class="comment">// æ‹¿Integer.MAX_VALUEæ ‡è®°æ€ä¹ˆéƒ½æå®šä¸äº†</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">process</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> index, <span class="type">int</span> rest)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (index == arr.length) &#123;</span><br><span class="line"><span class="keyword">return</span> rest == <span class="number">0</span> ? <span class="number">0</span> : Integer.MAX_VALUE;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> Integer.MAX_VALUE;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">zhang</span> <span class="operator">=</span> <span class="number">0</span>; zhang * arr[index] &lt;= rest; zhang++) &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> process(arr, index + <span class="number">1</span>, rest - zhang * arr[index]);</span><br><span class="line"><span class="keyword">if</span> (next != Integer.MAX_VALUE) &#123;</span><br><span class="line">ans = Math.min(ans, zhang + next);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="69bebcec-3ab2-400d-9c32-73b3d2ad7ffb-2"><p>p(2,10) = min (a,b,c,d)</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E9%9B%B6%E9%92%B1666.png" alt="é›¶é’±666"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="69bebcec-3ab2-400d-9c32-73b3d2ad7ffb-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">dp1</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> aim)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (aim == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> arr.length;</span><br><span class="line"><span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[N + <span class="number">1</span>][aim + <span class="number">1</span>];</span><br><span class="line">dp[N][<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= aim; j++) &#123;</span><br><span class="line">dp[N][j] = Integer.MAX_VALUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> N - <span class="number">1</span>; index &gt;= <span class="number">0</span>; index--) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">rest</span> <span class="operator">=</span> <span class="number">0</span>; rest &lt;= aim; rest++) &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> Integer.MAX_VALUE;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">zhang</span> <span class="operator">=</span> <span class="number">0</span>; zhang * arr[index] &lt;= rest; zhang++) &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> dp[index + <span class="number">1</span>][rest - zhang * arr[index]];</span><br><span class="line"><span class="keyword">if</span> (next != Integer.MAX_VALUE) &#123;</span><br><span class="line">ans = Math.min(ans, zhang + next);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">dp[index][rest] = ans;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dp[<span class="number">0</span>][aim];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="69bebcec-3ab2-400d-9c32-73b3d2ad7ffb-4"><p>p(2,10) = min (a,b+1,c+2,d+3)</p><p>p(2,7) = min(b,c+1,d+2)</p><p>p(2,10) = min(a,p(2,7)+1)</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E9%9B%B6777.png" alt="é›¶777"></p><p><mark class="hl-label blue">ä¼˜åŒ–</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">dp2</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> aim)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (aim == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> arr.length;</span><br><span class="line"><span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[N + <span class="number">1</span>][aim + <span class="number">1</span>];</span><br><span class="line">dp[N][<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= aim; j++) &#123;</span><br><span class="line">dp[N][j] = Integer.MAX_VALUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> N - <span class="number">1</span>; index &gt;= <span class="number">0</span>; index--) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">rest</span> <span class="operator">=</span> <span class="number">0</span>; rest &lt;= aim; rest++) &#123;</span><br><span class="line">dp[index][rest] = dp[index + <span class="number">1</span>][rest];</span><br><span class="line"><span class="keyword">if</span> (rest - arr[index] &gt;= <span class="number">0</span> </span><br><span class="line">&amp;&amp; dp[index][rest - arr[index]] != Integer.MAX_VALUE) &#123;</span><br><span class="line">dp[index][rest] = Math.min(dp[index][rest], dp[index][rest - arr[index]] + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dp[<span class="number">0</span>][aim];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="æ•°å­—åˆ†å‰²é—®é¢˜">æ•°å­—åˆ†å‰²é—®é¢˜</h3><h4 id="æ•°å­—åˆ†å‰²é—®é¢˜â… -æ–œç‡ä¼˜åŒ–">æ•°å­—åˆ†å‰²é—®é¢˜â… (æ–œç‡ä¼˜åŒ–)</h4><p>å°†æ•°numè¿›è¡Œè£‚å¼€ï¼Œè¦æ±‚åé¢çš„æ•°ä¸èƒ½å°äºå‰é¢çš„æ•°ï¼Œè¿”å›è£‚å¼€çš„æ–¹å¼æ•°</p><p>ä¾‹å¦‚</p><p>3 = 1+1+1 = 1+2  = 3</p><p>ä¸èƒ½ 2+1è¿™æ ·è£‚å¼€</p><p>è¿”å› 3</p><div class="tabs" id="0ffe2f89-db64-4548-8e41-67e6895903cc"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#0ffe2f89-db64-4548-8e41-67e6895903cc-1"><i class="fas fa-award"></i>æš´åŠ›é€’å½’</button></li><li class="tab"><button type="button" data-href="#0ffe2f89-db64-4548-8e41-67e6895903cc-2"><i class="fas fa-baseball-ball"></i>ä½ç½®ä¾èµ–åˆ†æ</button></li><li class="tab"><button type="button" data-href="#0ffe2f89-db64-4548-8e41-67e6895903cc-3"><i class="fas fa-bone"></i>ä¸¥æ ¼è¡¨ç»“æ„</button></li><li class="tab"><button type="button" data-href="#0ffe2f89-db64-4548-8e41-67e6895903cc-4"><i class="fas fa-anchor"></i>æ–œç‡ä¼˜åŒ–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="0ffe2f89-db64-4548-8e41-67e6895903cc-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// nä¸ºæ­£æ•°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">ways</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (n == <span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> process(<span class="number">1</span>, n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸Šä¸€ä¸ªæ‹†å‡ºæ¥çš„æ•°æ˜¯pre</span></span><br><span class="line"><span class="comment">// è¿˜å‰©restéœ€è¦å»æ‹†</span></span><br><span class="line"><span class="comment">// è¿”å›æ‹†è§£çš„æ–¹æ³•æ•°</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">process</span><span class="params">(<span class="type">int</span> pre, <span class="type">int</span> rest)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (rest == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (pre &gt; rest) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">ways</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">first</span> <span class="operator">=</span> pre; first &lt;= rest; first++) &#123;</span><br><span class="line">ways += process(first, rest - first);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ways;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0ffe2f89-db64-4548-8e41-67e6895903cc-2"><p>å‡è®¾ num = 8</p><p>p(3,6) = p(3,3)+p(4,2)+p(5,1)+p(6,0)</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E5%88%86%E5%89%B2%E6%95%B0%E5%AD%974.png" alt="åˆ†å‰²æ•°å­—4"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0ffe2f89-db64-4548-8e41-67e6895903cc-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">dp1</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (n == <span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[n + <span class="number">1</span>][n + <span class="number">1</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">pre</span> <span class="operator">=</span> <span class="number">1</span>; pre &lt;= n; pre++) &#123;</span><br><span class="line">dp[pre][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">dp[pre][pre] = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">pre</span> <span class="operator">=</span> n - <span class="number">1</span>; pre &gt;= <span class="number">1</span>; pre--) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">rest</span> <span class="operator">=</span> pre + <span class="number">1</span>; rest &lt;= n; rest++) &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">ways</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">first</span> <span class="operator">=</span> pre; first &lt;= rest; first++) &#123;</span><br><span class="line">ways += dp[first][rest - first];</span><br><span class="line">&#125;</span><br><span class="line">dp[pre][rest] = ways;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dp[<span class="number">1</span>][n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0ffe2f89-db64-4548-8e41-67e6895903cc-4"><p>p(3,6) = p(3,3)+p(4,2)+p(5,1)+p(6,0)</p><p>p(4,6) = p(4,2)+p(5,1)+p(6,0)</p><p>p(3,6) = p(3,3)+p(4,6)</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E5%88%86%E5%89%B2%E6%95%B0%E5%AD%975.png" alt="åˆ†å‰²æ•°å­—5"></p><p><mark class="hl-label blue">ä¼˜åŒ–</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">dp2</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (n == <span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[n + <span class="number">1</span>][n + <span class="number">1</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">pre</span> <span class="operator">=</span> <span class="number">1</span>; pre &lt;= n; pre++) &#123;</span><br><span class="line">dp[pre][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">dp[pre][pre] = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">pre</span> <span class="operator">=</span> n - <span class="number">1</span>; pre &gt;= <span class="number">1</span>; pre--) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">rest</span> <span class="operator">=</span> pre + <span class="number">1</span>; rest &lt;= n; rest++) &#123;</span><br><span class="line">dp[pre][rest] = dp[pre + <span class="number">1</span>][rest];</span><br><span class="line">dp[pre][rest] += dp[pre][rest - pre];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dp[<span class="number">1</span>][n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h4 id="æ•°å­—åˆ†å‰²é—®é¢˜â…¡">æ•°å­—åˆ†å‰²é—®é¢˜â…¡</h4><p>ç»™å®šä¸€ä¸ªæ­£æ•°æ•°ç»„arr,è¯·æŠŠarrä¸­æ‰€æœ‰æ•°åˆ†æˆä¸¤ä¸ªé›†åˆï¼Œå°½é‡è®©ä¸¤ä¸ªé›†åˆçš„ç´¯åŠ å’Œæ¥è¿‘</p><p>è¿”å›ï¼š</p><p>æœ€æ¥è¿‘çš„æƒ…å†µä¸‹ï¼Œè¾ƒå°é›†åˆçš„ç´¯åŠ å’Œ</p><div class="tabs" id="0eff5d0c-f03d-475d-920c-1b6a8b3cc8e2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#0eff5d0c-f03d-475d-920c-1b6a8b3cc8e2-1"><i class="fas fa-seedling"></i>æš´åŠ›é€’å½’</button></li><li class="tab"><button type="button" data-href="#0eff5d0c-f03d-475d-920c-1b6a8b3cc8e2-2"><i class="fab fa-apple"></i>ä¸¥æ ¼è¡¨ç»“æ„</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="0eff5d0c-f03d-475d-920c-1b6a8b3cc8e2-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">right</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (arr == <span class="literal">null</span> || arr.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> num : arr) &#123;</span><br><span class="line">sum += num;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> process(arr, <span class="number">0</span>, sum / <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// arr[i...]å¯ä»¥è‡ªç”±é€‰æ‹©ï¼Œè¯·è¿”å›ç´¯åŠ å’Œå°½é‡æ¥è¿‘restï¼Œä½†ä¸èƒ½è¶…è¿‡restçš„æƒ…å†µä¸‹ï¼Œæœ€æ¥è¿‘çš„ç´¯åŠ å’Œæ˜¯å¤šå°‘ï¼Ÿ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">process</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> i, <span class="type">int</span> rest)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (i == arr.length) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// è¿˜æœ‰æ•°ï¼Œarr[i]è¿™ä¸ªæ•°</span></span><br><span class="line"><span class="comment">// å¯èƒ½æ€§1ï¼Œä¸ä½¿ç”¨arr[i]</span></span><br><span class="line"><span class="type">int</span> <span class="variable">p1</span> <span class="operator">=</span> process(arr, i + <span class="number">1</span>, rest);</span><br><span class="line"><span class="comment">// å¯èƒ½æ€§2ï¼Œè¦ä½¿ç”¨arr[i]</span></span><br><span class="line"><span class="type">int</span> <span class="variable">p2</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (arr[i] &lt;= rest) &#123;</span><br><span class="line">p2 = arr[i] + process(arr, i + <span class="number">1</span>, rest - arr[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> Math.max(p1, p2);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0eff5d0c-f03d-475d-920c-1b6a8b3cc8e2-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">dp</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (arr == <span class="literal">null</span> || arr.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> num : arr) &#123;</span><br><span class="line">sum += num;</span><br><span class="line">&#125;</span><br><span class="line">sum /= <span class="number">2</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> arr.length;</span><br><span class="line"><span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[N + <span class="number">1</span>][sum + <span class="number">1</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> N - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">rest</span> <span class="operator">=</span> <span class="number">0</span>; rest &lt;= sum; rest++) &#123;</span><br><span class="line"><span class="comment">// å¯èƒ½æ€§1ï¼Œä¸ä½¿ç”¨arr[i]</span></span><br><span class="line"><span class="type">int</span> <span class="variable">p1</span> <span class="operator">=</span> dp[i + <span class="number">1</span>][rest];</span><br><span class="line"><span class="comment">// å¯èƒ½æ€§2ï¼Œè¦ä½¿ç”¨arr[i]</span></span><br><span class="line"><span class="type">int</span> <span class="variable">p2</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (arr[i] &lt;= rest) &#123;</span><br><span class="line">p2 = arr[i] + dp[i + <span class="number">1</span>][rest - arr[i]];</span><br><span class="line">&#125;</span><br><span class="line">dp[i][rest] = Math.max(p1, p2);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dp[<span class="number">0</span>][sum];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h4 id="æ•°å­—åˆ†å‰²é—®é¢˜â…¢">æ•°å­—åˆ†å‰²é—®é¢˜â…¢</h4><p>ç»™å®šä¸€ä¸ªæ­£æ•°æ•°ç»„arrï¼Œè¯·æŠŠarrä¸­æ‰€æœ‰çš„æ•°åˆ†æˆä¸¤ä¸ªé›†åˆ</p><p>å¦‚æœarré•¿åº¦ä¸ºå¶æ•°ï¼Œä¸¤ä¸ªé›†åˆåŒ…å«æ•°çš„ä¸ªæ•°è¦ä¸€æ ·å¤š</p><p>å¦‚æœaré•¿åº¦ä¸ºå¥‡æ•°ï¼Œä¸¤ä¸ªé›†åˆåŒ…å«æ•°çš„ä¸ªæ•°å¿…é¡»åªå·®ä¸€ä¸ª</p><p>è¯·å°½é‡è®©ä¸¤ä¸ªé›†åˆçš„ç´¯åŠ å’Œæ¥è¿‘ã€‚</p><p>è¿”å›ï¼š</p><p>æœ€æ¥è¿‘çš„æƒ…å†µä¸‹ï¼Œè¾ƒå°é›†åˆçš„ç´¯åŠ å’Œ</p><div class="tabs" id="141151c9-b391-4995-af55-9e30d6dfa3c4"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#141151c9-b391-4995-af55-9e30d6dfa3c4-1"><i class="fas fa-award"></i>æš´åŠ›é€’å½’</button></li><li class="tab"><button type="button" data-href="#141151c9-b391-4995-af55-9e30d6dfa3c4-2"><i class="fas fa-baseball-ball"></i>ä¸¥æ ¼è¡¨ç»“æ„</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="141151c9-b391-4995-af55-9e30d6dfa3c4-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">right</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (arr == <span class="literal">null</span> || arr.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> num : arr) &#123;</span><br><span class="line">sum += num;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((arr.length &amp; <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> process(arr, <span class="number">0</span>, arr.length / <span class="number">2</span>, sum / <span class="number">2</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> Math.max(process(arr, <span class="number">0</span>, arr.length / <span class="number">2</span>, sum / <span class="number">2</span>), process(arr, <span class="number">0</span>, arr.length / <span class="number">2</span> + <span class="number">1</span>, sum / <span class="number">2</span>));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// arr[i....]è‡ªç”±é€‰æ‹©ï¼ŒæŒ‘é€‰çš„ä¸ªæ•°ä¸€å®šè¦æ˜¯picksä¸ªï¼Œç´¯åŠ å’Œ&lt;=rest, ç¦»restæœ€è¿‘çš„è¿”å›</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">process</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> i, <span class="type">int</span> picks, <span class="type">int</span> rest)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (i == arr.length) &#123;</span><br><span class="line"><span class="keyword">return</span> picks == <span class="number">0</span> ? <span class="number">0</span> : -<span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">p1</span> <span class="operator">=</span> process(arr, i + <span class="number">1</span>, picks, rest);</span><br><span class="line"><span class="comment">// å°±æ˜¯è¦ä½¿ç”¨arr[i]è¿™ä¸ªæ•°</span></span><br><span class="line"><span class="type">int</span> <span class="variable">p2</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (arr[i] &lt;= rest) &#123;</span><br><span class="line">next = process(arr, i + <span class="number">1</span>, picks - <span class="number">1</span>, rest - arr[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (next != -<span class="number">1</span>) &#123;</span><br><span class="line">p2 = arr[i] + next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> Math.max(p1, p2);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="141151c9-b391-4995-af55-9e30d6dfa3c4-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">dp</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (arr == <span class="literal">null</span> || arr.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> num : arr) &#123;</span><br><span class="line">sum += num;</span><br><span class="line">&#125;</span><br><span class="line">sum /= <span class="number">2</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> arr.length;</span><br><span class="line"><span class="type">int</span> <span class="variable">M</span> <span class="operator">=</span> (N + <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line"><span class="type">int</span>[][][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[N + <span class="number">1</span>][M + <span class="number">1</span>][sum + <span class="number">1</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= N; i++) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt;= M; j++) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt;= sum; k++) &#123;</span><br><span class="line">dp[i][j][k] = -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">rest</span> <span class="operator">=</span> <span class="number">0</span>; rest &lt;= sum; rest++) &#123;</span><br><span class="line">dp[N][<span class="number">0</span>][rest] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> N - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">picks</span> <span class="operator">=</span> <span class="number">0</span>; picks &lt;= M; picks++) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">rest</span> <span class="operator">=</span> <span class="number">0</span>; rest &lt;= sum; rest++) &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">p1</span> <span class="operator">=</span> dp[i + <span class="number">1</span>][picks][rest];</span><br><span class="line"><span class="comment">// å°±æ˜¯è¦ä½¿ç”¨arr[i]è¿™ä¸ªæ•°</span></span><br><span class="line"><span class="type">int</span> <span class="variable">p2</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (picks - <span class="number">1</span> &gt;= <span class="number">0</span> &amp;&amp; arr[i] &lt;= rest) &#123;</span><br><span class="line">next = dp[i + <span class="number">1</span>][picks - <span class="number">1</span>][rest - arr[i]];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (next != -<span class="number">1</span>) &#123;</span><br><span class="line">p2 = arr[i] + next;</span><br><span class="line">&#125;</span><br><span class="line">dp[i][picks][rest] = Math.max(p1, p2);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((arr.length &amp; <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> dp[<span class="number">0</span>][arr.length / <span class="number">2</span>][sum];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> Math.max(dp[<span class="number">0</span>][arr.length / <span class="number">2</span>][sum], dp[<span class="number">0</span>][(arr.length / <span class="number">2</span>) + <span class="number">1</span>][sum]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><hr><h2 id="èŒƒå›´ä¸Šçš„å°è¯•æ¨¡å‹">èŒƒå›´ä¸Šçš„å°è¯•æ¨¡å‹</h2><p>å…³æ³¨Lå’ŒRçš„æƒ…å†µï¼Œå¡«è¡¨æ ¼å¼éå¸¸å›ºå®šï¼Œä¸»å¯¹è§’ï¼Œå‰¯å¯¹è§’ï¼Œå€’å›æ¥å¡«</p><h3 id="é¢˜ç›®ä¸€-2">é¢˜ç›®ä¸€</h3><p>ç»™å®šä¸€ä¸ªæ•´å‹æ•°ç»„arrï¼Œä»£è¡¨æ•°å€¼ä¸åŒçš„çº¸ç‰Œæ’æˆä¸€æ¡çº¿</p><p>ç©å®¶Aå’Œç©å®¶Bä¾æ¬¡æ‹¿èµ°æ¯å¼ çº¸ç‰Œ</p><p>è§„å®šç©å®¶Aå…ˆæ‹¿ï¼Œç©å®¶Båæ‹¿</p><p>ä½†æ˜¯æ¯ä¸ªç©å®¶æ¯æ¬¡åªèƒ½æ‹¿èµ°æœ€å·¦æˆ–æœ€å³çš„çº¸ç‰Œ</p><p>ç©å®¶Aå’Œç©å®¶Béƒ½ç»é¡¶èªæ˜</p><p>è¯·è¿”å›æœ€åè·èƒœè€…çš„åˆ†æ•°ã€‚</p><div class="tabs" id="de9695fd-ab57-44ba-b16d-b2a5e39619e1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#de9695fd-ab57-44ba-b16d-b2a5e39619e1-1"><i class="fas fa-atom"></i>æš´åŠ›é€’å½’</button></li><li class="tab"><button type="button" data-href="#de9695fd-ab57-44ba-b16d-b2a5e39619e1-2"><i class="far fa-sun"></i>é‡å¤è§£åˆ†æ</button></li><li class="tab"><button type="button" data-href="#de9695fd-ab57-44ba-b16d-b2a5e39619e1-3"><i class="fas fa-wind"></i>å‚»ç¼“å­˜æ³•</button></li><li class="tab"><button type="button" data-href="#de9695fd-ab57-44ba-b16d-b2a5e39619e1-4"><i class="fas fa-heartbeat"></i>ä½ç½®ä¾èµ–åˆ†æ</button></li><li class="tab"><button type="button" data-href="#de9695fd-ab57-44ba-b16d-b2a5e39619e1-5"><i class="fas fa-fire-alt"></i>ä¸¥æ ¼è¡¨ç»“æ„</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="de9695fd-ab57-44ba-b16d-b2a5e39619e1-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ ¹æ®è§„åˆ™ï¼Œè¿”å›è·èƒœè€…çš„åˆ†æ•°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">win1</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (arr == <span class="literal">null</span> || arr.length == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">first</span> <span class="operator">=</span> f1(arr, <span class="number">0</span>, arr.length - <span class="number">1</span>);</span><br><span class="line"><span class="type">int</span> <span class="variable">second</span> <span class="operator">=</span> g1(arr, <span class="number">0</span>, arr.length - <span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> Math.max(first, second);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// arr[L..R]ï¼Œå…ˆæ‰‹è·å¾—çš„æœ€å¥½åˆ†æ•°è¿”å›</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">f1</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> L, <span class="type">int</span> R)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (L == R) &#123;</span><br><span class="line"><span class="keyword">return</span> arr[L];</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">p1</span> <span class="operator">=</span> arr[L] + g1(arr, L + <span class="number">1</span>, R);</span><br><span class="line"><span class="type">int</span> <span class="variable">p2</span> <span class="operator">=</span> arr[R] + g1(arr, L, R - <span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> Math.max(p1, p2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// // arr[L..R]ï¼Œåæ‰‹è·å¾—çš„æœ€å¥½åˆ†æ•°è¿”å›</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">g1</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> L, <span class="type">int</span> R)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (L == R) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">p1</span> <span class="operator">=</span> f1(arr, L + <span class="number">1</span>, R); <span class="comment">// å¯¹æ‰‹æ‹¿èµ°äº†Lä½ç½®çš„æ•°</span></span><br><span class="line"><span class="type">int</span> <span class="variable">p2</span> <span class="operator">=</span> f1(arr, L, R - <span class="number">1</span>); <span class="comment">// å¯¹æ‰‹æ‹¿èµ°äº†Rä½ç½®çš„æ•°</span></span><br><span class="line"><span class="keyword">return</span> Math.min(p1, p2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="de9695fd-ab57-44ba-b16d-b2a5e39619e1-2"><p>0-7å·çº¸ç‰Œ</p><p>å¯¹äºå…ˆæ‰‹æ¥è¯´ï¼Œåœ¨f(0,7)åšæœ€ä¼˜é€‰æ‹©</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230706120741650.png" alt="image-20230706120741650" style="zoom:67%;" /><p>å‡ºç°é‡å </p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="de9695fd-ab57-44ba-b16d-b2a5e39619e1-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">win2</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (arr == <span class="literal">null</span> || arr.length == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> arr.length;</span><br><span class="line"><span class="type">int</span>[][] fmap = <span class="keyword">new</span> <span class="title class_">int</span>[N][N];</span><br><span class="line"><span class="type">int</span>[][] gmap = <span class="keyword">new</span> <span class="title class_">int</span>[N][N];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; N; j++) &#123;</span><br><span class="line">fmap[i][j] = -<span class="number">1</span>;</span><br><span class="line">gmap[i][j] = -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">first</span> <span class="operator">=</span> f2(arr, <span class="number">0</span>, arr.length - <span class="number">1</span>, fmap, gmap);</span><br><span class="line"><span class="type">int</span> <span class="variable">second</span> <span class="operator">=</span> g2(arr, <span class="number">0</span>, arr.length - <span class="number">1</span>, fmap, gmap);</span><br><span class="line"><span class="keyword">return</span> Math.max(first, second);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// arr[L..R]ï¼Œå…ˆæ‰‹è·å¾—çš„æœ€å¥½åˆ†æ•°è¿”å›</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">f2</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> L, <span class="type">int</span> R, <span class="type">int</span>[][] fmap, <span class="type">int</span>[][] gmap)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (fmap[L][R] != -<span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> fmap[L][R];</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (L == R) &#123;</span><br><span class="line">ans = arr[L];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">p1</span> <span class="operator">=</span> arr[L] + g2(arr, L + <span class="number">1</span>, R, fmap, gmap);</span><br><span class="line"><span class="type">int</span> <span class="variable">p2</span> <span class="operator">=</span> arr[R] + g2(arr, L, R - <span class="number">1</span>, fmap, gmap);</span><br><span class="line">ans = Math.max(p1, p2);</span><br><span class="line">&#125;</span><br><span class="line">fmap[L][R] = ans;</span><br><span class="line"><span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// // arr[L..R]ï¼Œåæ‰‹è·å¾—çš„æœ€å¥½åˆ†æ•°è¿”å›</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">g2</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> L, <span class="type">int</span> R, <span class="type">int</span>[][] fmap, <span class="type">int</span>[][] gmap)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (gmap[L][R] != -<span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> gmap[L][R];</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (L != R) &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">p1</span> <span class="operator">=</span> f2(arr, L + <span class="number">1</span>, R, fmap, gmap); <span class="comment">// å¯¹æ‰‹æ‹¿èµ°äº†Lä½ç½®çš„æ•°</span></span><br><span class="line"><span class="type">int</span> <span class="variable">p2</span> <span class="operator">=</span> f2(arr, L, R - <span class="number">1</span>, fmap, gmap); <span class="comment">// å¯¹æ‰‹æ‹¿èµ°äº†Rä½ç½®çš„æ•°</span></span><br><span class="line">ans = Math.min(p1, p2);</span><br><span class="line">&#125;</span><br><span class="line">gmap[L][R] = ans;</span><br><span class="line"><span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="de9695fd-ab57-44ba-b16d-b2a5e39619e1-4"><p>å‡å¦‚arr = [7,4,16,15,1]</p><div class="tabs" id="d26e497e-188d-4de1-9c81-a51e2769de01"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d26e497e-188d-4de1-9c81-a51e2769de01-1"><i class="fas fa-award"></i>baseaseå’Œans</button></li><li class="tab"><button type="button" data-href="#d26e497e-188d-4de1-9c81-a51e2769de01-2"><i class="fas fa-baseball-ball"></i>æ™®éä½ç½®ä¾èµ–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d26e497e-188d-4de1-9c81-a51e2769de01-1"><p>fçš„basecase</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (L == R) &#123;</span><br><span class="line"><span class="keyword">return</span> arr[L];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>gçš„basecase</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (L == R) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆéœ€è¦çš„ç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">first</span> <span class="operator">=</span> f1(arr, <span class="number">0</span>, arr.length - <span class="number">1</span>);</span><br><span class="line"><span class="type">int</span> <span class="variable">second</span> <span class="operator">=</span> g1(arr, <span class="number">0</span>, arr.length - <span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> Math.max(first, second);</span><br></pre></td></tr></table></figure><p>å³<code>Math.max(fmap[0][4],gmap[0][4]);</code></p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/basecase%E5%92%8Cans2.png" alt="basecaseå’Œans2"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d26e497e-188d-4de1-9c81-a51e2769de01-2"><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int p1 = arr[L] + g1(arr, <span class="class">L + 1, R);</span><span class="built_in"></span></span><br><span class="line"><span class="built_in">int </span>p2 = arr[R] + g1(arr, <span class="class">L, R - 1);</span></span><br></pre></td></tr></table></figure><p>fmap ï¼Ÿä½ç½®ä¾èµ–</p><p>ä½œgmapä¸­ï¼Ÿä½ç½®å¯¹ç§°ç‚¹ï¼Ÿ'ï¼Œï¼Ÿä½ç½®ä¾èµ–gmapä¸­â–³ ä½ç½®ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E4%BD%8D%E7%BD%AE%E4%BE%9D%E8%B5%962-1.png" alt="ä½ç½®ä¾èµ–2-1"></p><p>åŒç†åˆ†ægmapä¸­ï¼Ÿä½ç½®çš„ä¾èµ–</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> p1 = f1(arr, L + <span class="number">1</span>, R); <span class="comment">// å¯¹æ‰‹æ‹¿èµ°äº†Lä½ç½®çš„æ•°</span></span><br><span class="line"><span class="built_in">int</span> p2 = f1(arr, L, R - <span class="number">1</span>); <span class="comment">// å¯¹æ‰‹æ‹¿èµ°äº†Rä½ç½®çš„æ•°</span></span><br></pre></td></tr></table></figure><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E4%BD%8D%E7%BD%AE%E4%BE%9D%E8%B5%962-2.png" alt="ä½ç½®ä¾èµ–2-2"></p><p>äº’æ¨å¯¹è§’çº¿</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="de9695fd-ab57-44ba-b16d-b2a5e39619e1-5"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">win3</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (arr == <span class="literal">null</span> || arr.length == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> arr.length;</span><br><span class="line"><span class="type">int</span>[][] fmap = <span class="keyword">new</span> <span class="title class_">int</span>[N][N];</span><br><span class="line"><span class="type">int</span>[][] gmap = <span class="keyword">new</span> <span class="title class_">int</span>[N][N];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">fmap[i][i] = arr[i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">startCol</span> <span class="operator">=</span> <span class="number">1</span>; startCol &lt; N; startCol++) &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">L</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">R</span> <span class="operator">=</span> startCol;</span><br><span class="line"><span class="keyword">while</span> (R &lt; N) &#123;</span><br><span class="line">fmap[L][R] = Math.max(arr[L] + gmap[L + <span class="number">1</span>][R], arr[R] + gmap[L][R - <span class="number">1</span>]);</span><br><span class="line">gmap[L][R] = Math.min(fmap[L + <span class="number">1</span>][R], fmap[L][R - <span class="number">1</span>]);</span><br><span class="line">L++;</span><br><span class="line">R++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> Math.max(fmap[<span class="number">0</span>][N - <span class="number">1</span>], gmap[<span class="number">0</span>][N - <span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="æœ€é•¿å›æ–‡å­åºåˆ—é•¿åº¦-å¸¦ä¼˜åŒ–">æœ€é•¿å›æ–‡å­åºåˆ—é•¿åº¦(å¸¦ä¼˜åŒ–)</h3><p>ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸²strï¼Œè¿”å›è¿™ä¸ªå­—ç¬¦ä¸²çš„æœ€é•¿å›æ–‡å­åºåˆ—é•¿åº¦</p><p>æ¯”å¦‚ï¼šstr = â€œa12b3c43def2ghi1kpmâ€</p><p>æœ€é•¿å›æ–‡å­åºåˆ—æ˜¯ â€œ1234321â€ æˆ–è€… â€œ123c321â€ï¼Œè¿”å›é•¿åº¦7</p><blockquote><p>è§£æ³•1</p></blockquote><p>ç”Ÿæˆstrçš„é€†åºä¸²</p><p>stré€† = â€œmpk1ihg2fed34cb21aâ€</p><p>åŸä¸²å’Œé€†åºä¸²çš„æœ€é•¿å…¬å…±å­åºåˆ—å³ä¸ºåŸä¸²çš„æœ€é•¿å›æ–‡å­åºåˆ—</p><blockquote><p>è§£æ³•2ï¼šèŒƒå›´å°è¯•æ¨¡å‹</p></blockquote><div class="tabs" id="bd07aba8-9097-4e19-bd74-af70a8555478"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#bd07aba8-9097-4e19-bd74-af70a8555478-1"><i class="fas fa-seedling"></i>æš´åŠ›é€’å½’</button></li><li class="tab"><button type="button" data-href="#bd07aba8-9097-4e19-bd74-af70a8555478-2"><i class="fab fa-apple"></i>ä½ç½®ä¾èµ–åˆ†æ</button></li><li class="tab"><button type="button" data-href="#bd07aba8-9097-4e19-bd74-af70a8555478-3"><i class="fas fa-leaf"></i>ä¸¥æ ¼è¡¨ç»“æ„</button></li><li class="tab"><button type="button" data-href="#bd07aba8-9097-4e19-bd74-af70a8555478-4"><i class="fas fa-heartbeat"></i>ç»§ç»­ä¼˜åŒ–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="bd07aba8-9097-4e19-bd74-af70a8555478-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">lpsl1</span><span class="params">(String s)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (s == <span class="literal">null</span> || s.length() == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">char</span>[] str = s.toCharArray();</span><br><span class="line"><span class="keyword">return</span> f(str, <span class="number">0</span>, str.length - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// str[L..R]æœ€é•¿å›æ–‡å­åºåˆ—é•¿åº¦è¿”å›</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">f</span><span class="params">(<span class="type">char</span>[] str, <span class="type">int</span> L, <span class="type">int</span> R)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (L == R) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (L == R - <span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> str[L] == str[R] ? <span class="number">2</span> : <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">p1</span> <span class="operator">=</span> f(str, L + <span class="number">1</span>, R - <span class="number">1</span>);</span><br><span class="line"><span class="type">int</span> <span class="variable">p2</span> <span class="operator">=</span> f(str, L, R - <span class="number">1</span>);</span><br><span class="line"><span class="type">int</span> <span class="variable">p3</span> <span class="operator">=</span> f(str, L + <span class="number">1</span>, R);</span><br><span class="line"><span class="type">int</span> <span class="variable">p4</span> <span class="operator">=</span> str[L] != str[R] ? <span class="number">0</span> : (<span class="number">2</span> + f(str, L + <span class="number">1</span>, R - <span class="number">1</span>));</span><br><span class="line"><span class="keyword">return</span> Math.max(Math.max(p1, p2), Math.max(p3, p4));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="bd07aba8-9097-4e19-bd74-af70a8555478-2"><p>basecase</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (L == R) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (L == R - <span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> str[L] == str[R] ? <span class="number">2</span> : <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ans</p><p>f(0,str.length - 1)</p><p>ä»åº•å¾€ä¸Šå¡«</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E6%9C%80%E9%95%BF%E5%9B%9E%E6%96%87%E5%AD%90%E5%BA%8F%E5%88%97222.png" alt="æœ€é•¿å›æ–‡å­åºåˆ—222"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="bd07aba8-9097-4e19-bd74-af70a8555478-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">lpsl2</span><span class="params">(String s)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (s == <span class="literal">null</span> || s.length() == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">char</span>[] str = s.toCharArray();</span><br><span class="line"><span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> str.length;</span><br><span class="line"><span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[N][N];</span><br><span class="line">dp[N - <span class="number">1</span>][N - <span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N - <span class="number">1</span>; i++) &#123;</span><br><span class="line">dp[i][i] = <span class="number">1</span>;</span><br><span class="line">dp[i][i + <span class="number">1</span>] = str[i] == str[i + <span class="number">1</span>] ? <span class="number">2</span> : <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">L</span> <span class="operator">=</span> N - <span class="number">3</span>; L &gt;= <span class="number">0</span>; L--) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">R</span> <span class="operator">=</span> L + <span class="number">2</span>; R &lt; N; R++) &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">p1</span> <span class="operator">=</span> dp[L+<span class="number">1</span>][R-<span class="number">1</span>];</span><br><span class="line">       <span class="type">int</span> <span class="variable">p2</span> <span class="operator">=</span> dp[L][R-<span class="number">1</span>];</span><br><span class="line">       <span class="type">int</span> <span class="variable">p3</span> <span class="operator">=</span> dp[L+<span class="number">1</span>][R];</span><br><span class="line">       <span class="type">int</span> <span class="variable">p4</span> <span class="operator">=</span> str[L] == stl[R] ? <span class="number">2</span> + dp[L + <span class="number">1</span>][R - <span class="number">1</span>] : <span class="number">0</span>;</span><br><span class="line">dp[L][R] = Math.max(Math.max(p1,p2),Math.max(p3,p4));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dp[<span class="number">0</span>][N - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="bd07aba8-9097-4e19-bd74-af70a8555478-4"><p>?æ ¼å­è¦æ±‚å‡ºæ¥ä¾èµ–å·¦ã€å·¦ä¸‹å’Œä¸‹ã€‚å¹¶æ˜¯å–æœ€å¤§å€¼ã€‚</p><p>é‚£ä¹ˆï¼Ÿæ ¼å­ç»ä¸æ¯”åä¸‹å’Œä¸‹æ ¼å­å°</p><p>åœ¨ä¹‹å‰æ±‚å·¦æ ¼å­æ—¶ï¼Œä¾èµ–å®ƒçš„å·¦ã€å·¦ä¸‹å’Œä¸‹</p><p>é‚£ä¹ˆåœ¨å›¾ä¸­ï¼Œå·¦æ ¼å­ä¸å¯èƒ½æ¯”å·¦ä¸‹æ ¼å­å°ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230706170257845.png" alt="image-20230706170257845"></p><p><mark class="hl-label blue">ä¼˜åŒ–</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">lpsl2</span><span class="params">(String s)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (s == <span class="literal">null</span> || s.length() == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">char</span>[] str = s.toCharArray();</span><br><span class="line"><span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> str.length;</span><br><span class="line"><span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[N][N];</span><br><span class="line">dp[N - <span class="number">1</span>][N - <span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N - <span class="number">1</span>; i++) &#123;</span><br><span class="line">dp[i][i] = <span class="number">1</span>;</span><br><span class="line">dp[i][i + <span class="number">1</span>] = str[i] == str[i + <span class="number">1</span>] ? <span class="number">2</span> : <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">L</span> <span class="operator">=</span> N - <span class="number">3</span>; L &gt;= <span class="number">0</span>; L--) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">R</span> <span class="operator">=</span> L + <span class="number">2</span>; R &lt; N; R++) &#123;</span><br><span class="line">dp[L][R] = Math.max(dp[L][R - <span class="number">1</span>], dp[L + <span class="number">1</span>][R]);</span><br><span class="line"><span class="keyword">if</span> (str[L] == str[R]) &#123;</span><br><span class="line">dp[L][R] = Math.max(dp[L][R], <span class="number">2</span> + dp[L + <span class="number">1</span>][R - <span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dp[<span class="number">0</span>][N - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="å¤šæ ·æœ¬ä½ç½®å…¨å¯¹åº”çš„å°è¯•æ¨¡å‹">å¤šæ ·æœ¬ä½ç½®å…¨å¯¹åº”çš„å°è¯•æ¨¡å‹</h2><p>å¤šä¸ªæ ·æœ¬ï¼Œä¸€ä¸ªæ ·æœ¬åšè¡Œï¼Œä¸€ä¸ªæ ·æœ¬åšåˆ—ï¼Œå…³æ³¨iå’Œjå¯¹åº”ä½ç½®çš„æƒ…å†µï¼Œå…ˆå¡«è¾¹ç•Œï¼Œå†å¡«ä¸­é—´</p><h3 id="æœ€é•¿å…¬å…±å­åºåˆ—">æœ€é•¿å…¬å…±å­åºåˆ—</h3><p>ç»™å®šä¸¤ä¸ªå­—ç¬¦ä¸² <code>text1</code> å’Œ <code>text2</code>ï¼Œè¿”å›è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²çš„æœ€é•¿å…¬å…±å­åºåˆ—çš„é•¿åº¦ã€‚å¦‚æœä¸å­˜åœ¨å…¬å…±å­åºåˆ— ï¼Œè¿”å› 0 ã€‚</p><p>è¾“å…¥ï¼štext1 = â€œabcdeâ€, text2 = â€œaceâ€<br>è¾“å‡ºï¼š3<br>è§£é‡Šï¼šæœ€é•¿å…¬å…±å­åºåˆ—æ˜¯ â€œaceâ€ ï¼Œå®ƒçš„é•¿åº¦ä¸º 3 ã€‚</p><div class="tabs" id="2ce89215-5f65-4349-8cf3-c2ca8eb27f51"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2ce89215-5f65-4349-8cf3-c2ca8eb27f51-1"><i class="fas fa-bug"></i>æš´åŠ›é€’å½’</button></li><li class="tab"><button type="button" data-href="#2ce89215-5f65-4349-8cf3-c2ca8eb27f51-2"><i class="fas fa-cannabis"></i>ä½ç½®ä¾èµ–åˆ†æ</button></li><li class="tab"><button type="button" data-href="#2ce89215-5f65-4349-8cf3-c2ca8eb27f51-3"><i class="fas fa-candy-cane"></i>ä¸¥æ ¼ä½ç½®ä¾èµ–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2ce89215-5f65-4349-8cf3-c2ca8eb27f51-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">longestCommonSubsequence1</span><span class="params">(String s1, String s2)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (s1 == <span class="literal">null</span> || s2 == <span class="literal">null</span> || s1.length() == <span class="number">0</span> || s2.length() == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">char</span>[] str1 = s1.toCharArray();</span><br><span class="line"><span class="type">char</span>[] str2 = s2.toCharArray();</span><br><span class="line"><span class="comment">// å°è¯•</span></span><br><span class="line"><span class="keyword">return</span> process1(str1, str2, str1.length - <span class="number">1</span>, str2.length - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// str1[0...i]ä¸str2[0...j]æœ€é•¿å…¬å…±å­åºåˆ—å¤šé•¿ï¼Ÿ</span></span><br><span class="line"><span class="comment">// è¿”å›</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">process1</span><span class="params">(<span class="type">char</span>[] str1, <span class="type">char</span>[] str2, <span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (i == <span class="number">0</span> &amp;&amp; j == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> str1[i] == str2[j] ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (str1[i] == str2[j]) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> process1(str1, str2, i, j - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (j == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (str1[i] == str2[j]) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> process1(str1, str2, i - <span class="number">1</span>, j);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// i != 0 &amp;&amp; j != 0</span></span><br><span class="line"><span class="type">int</span> <span class="variable">p1</span> <span class="operator">=</span> process1(str1, str2, i - <span class="number">1</span>, j);</span><br><span class="line"><span class="type">int</span> <span class="variable">p2</span> <span class="operator">=</span> process1(str1, str2, i, j - <span class="number">1</span>);</span><br><span class="line"><span class="type">int</span> <span class="variable">p3</span> <span class="operator">=</span> str1[i] == str2[j] ? (<span class="number">1</span> + process1(str1, str2, i - <span class="number">1</span>, j - <span class="number">1</span>)) : <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> Math.max(p1, Math.max(p2, p3));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2ce89215-5f65-4349-8cf3-c2ca8eb27f51-2"><p>å‡è®¾str1 = â€œa12c3dâ€,str2 = â€œefg123xyâ€</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E6%9C%80%E9%95%BF%E5%85%AC%E5%85%B1%E5%AD%90%E5%BA%8F%E5%88%9711.png" alt="æœ€é•¿å…¬å…±å­åºåˆ—11"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2ce89215-5f65-4349-8cf3-c2ca8eb27f51-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">longestCommonSubsequence2</span><span class="params">(String s1, String s2)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (s1 == <span class="literal">null</span> || s2 == <span class="literal">null</span> || s1.length() == <span class="number">0</span> || s2.length() == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">char</span>[] str1 = s1.toCharArray();</span><br><span class="line"><span class="type">char</span>[] str2 = s2.toCharArray();</span><br><span class="line"><span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> str1.length;</span><br><span class="line"><span class="type">int</span> <span class="variable">M</span> <span class="operator">=</span> str2.length;</span><br><span class="line"><span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[N][M];</span><br><span class="line">dp[<span class="number">0</span>][<span class="number">0</span>] = str1[<span class="number">0</span>] == str2[<span class="number">0</span>] ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt; M; j++) &#123;</span><br><span class="line">dp[<span class="number">0</span>][j] = str1[<span class="number">0</span>] == str2[j] ? <span class="number">1</span> : dp[<span class="number">0</span>][j - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; N; i++) &#123;</span><br><span class="line">dp[i][<span class="number">0</span>] = str1[i] == str2[<span class="number">0</span>] ? <span class="number">1</span> : dp[i - <span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; N; i++) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt; M; j++) &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">p1</span> <span class="operator">=</span> dp[i - <span class="number">1</span>][j];</span><br><span class="line"><span class="type">int</span> <span class="variable">p2</span> <span class="operator">=</span> dp[i][j - <span class="number">1</span>];</span><br><span class="line"><span class="type">int</span> <span class="variable">p3</span> <span class="operator">=</span> str1[i] == str2[j] ? (<span class="number">1</span> + dp[i - <span class="number">1</span>][j - <span class="number">1</span>]) : <span class="number">0</span>;</span><br><span class="line">dp[i][j] = Math.max(p1, Math.max(p2, p3));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dp[N - <span class="number">1</span>][M - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="è¡¨è¾¾å¼åŒ¹é…TODO">è¡¨è¾¾å¼åŒ¹é…TODO</h3><hr><hr><hr><h2 id="å¯»æ‰¾ä¸šåŠ¡é™åˆ¶çš„å°è¯•æ¨¡å‹">å¯»æ‰¾ä¸šåŠ¡é™åˆ¶çš„å°è¯•æ¨¡å‹</h2><p>æ¯”å¦‚èµ°æ£‹ç›˜ï¼Œå›ºå®šçš„å‡ ä¸ªæ–¹å‘å¯ä»¥èµ°ï¼Œå…ˆå¡«è¾¹ç•Œï¼Œå†å¡«ä¸­é—´ã€‚</p><h3 id="é¢˜ç›®ä¸€-3">é¢˜ç›®ä¸€</h3><p>è¯·åŒå­¦ä»¬è‡ªè¡Œæœç´¢æˆ–è€…æƒ³è±¡ä¸€ä¸ªè±¡æ£‹çš„æ£‹ç›˜ï¼Œ</p><p>ç„¶åæŠŠæ•´ä¸ªæ£‹ç›˜æ”¾å…¥ç¬¬ä¸€è±¡é™ï¼Œæ£‹ç›˜çš„æœ€å·¦ä¸‹è§’æ˜¯(0,0)ä½ç½®</p><p>é‚£ä¹ˆæ•´ä¸ªæ£‹ç›˜å°±æ˜¯æ¨ªåæ ‡ä¸Š9æ¡çº¿ã€çºµåæ ‡ä¸Š10æ¡çº¿çš„åŒºåŸŸç»™ä½ ä¸‰ä¸ªå‚æ•°xï¼Œyï¼Œk</p><p>è¿”å›é©¬ä»(0,0)ä½ç½®å‡ºå‘ï¼Œå¿…é¡»èµ°kæ­¥</p><p>æœ€åè½åœ¨(x,y)ä¸Šçš„æ–¹æ³•æ•°æœ‰å¤šå°‘ç§ï¼Ÿ</p><div class="tabs" id="8a6ec6f4-5750-429b-a121-5fd97fac79a3"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#8a6ec6f4-5750-429b-a121-5fd97fac79a3-1"><i class="fas fa-award"></i>æš´åŠ›é€’å½’</button></li><li class="tab"><button type="button" data-href="#8a6ec6f4-5750-429b-a121-5fd97fac79a3-2"><i class="fas fa-baseball-ball"></i>ä½ç½®ä¾èµ–åˆ†æ</button></li><li class="tab"><button type="button" data-href="#8a6ec6f4-5750-429b-a121-5fd97fac79a3-3"><i class="fas fa-bone"></i>ä¸¥æ ¼ä½ç½®åˆ†æ</button></li><li class="tab"><button type="button" data-href="#8a6ec6f4-5750-429b-a121-5fd97fac79a3-4"><i class="fas fa-anchor"></i>4</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="8a6ec6f4-5750-429b-a121-5fd97fac79a3-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å½“å‰æ¥åˆ°çš„ä½ç½®æ˜¯ï¼ˆx,yï¼‰</span></span><br><span class="line"><span class="comment">// è¿˜å‰©ä¸‹restæ­¥éœ€è¦è·³</span></span><br><span class="line"><span class="comment">// è·³å®Œrestæ­¥ï¼Œæ­£å¥½è·³åˆ°aï¼Œbçš„æ–¹æ³•æ•°æ˜¯å¤šå°‘ï¼Ÿ</span></span><br><span class="line"><span class="comment">// 10 * 9</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">jump</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b, <span class="type">int</span> k)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> process(<span class="number">0</span>, <span class="number">0</span>, k, a, b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">process</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">int</span> rest, <span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (x &lt; <span class="number">0</span> || x &gt; <span class="number">9</span> || y &lt; <span class="number">0</span> || y &gt; <span class="number">8</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (rest == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> (x == a &amp;&amp; y == b) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">ways</span> <span class="operator">=</span> process(x + <span class="number">2</span>, y + <span class="number">1</span>, rest - <span class="number">1</span>, a, b);</span><br><span class="line">ways += process(x + <span class="number">1</span>, y + <span class="number">2</span>, rest - <span class="number">1</span>, a, b);</span><br><span class="line">ways += process(x - <span class="number">1</span>, y + <span class="number">2</span>, rest - <span class="number">1</span>, a, b);</span><br><span class="line">ways += process(x - <span class="number">2</span>, y + <span class="number">1</span>, rest - <span class="number">1</span>, a, b);</span><br><span class="line">ways += process(x - <span class="number">2</span>, y - <span class="number">1</span>, rest - <span class="number">1</span>, a, b);</span><br><span class="line">ways += process(x - <span class="number">1</span>, y - <span class="number">2</span>, rest - <span class="number">1</span>, a, b);</span><br><span class="line">ways += process(x + <span class="number">1</span>, y - <span class="number">2</span>, rest - <span class="number">1</span>, a, b);</span><br><span class="line">ways += process(x + <span class="number">2</span>, y - <span class="number">1</span>, rest - <span class="number">1</span>, a, b);</span><br><span class="line"><span class="keyword">return</span> ways;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8a6ec6f4-5750-429b-a121-5fd97fac79a3-2"><p>ä»¥xyä¸ºxyè½´ï¼Œrestä¸ºè½´</p><p>ä»¥ä¸åŒrestä¸ºä¸åŒå±‚ï¼ŒåŒä¸€å±‚ä¹‹é—´æ˜¯ä¸ç›¸äº’ä¾èµ–çš„</p><p>ä»ç¬¬0å±‚æ¨ç¬¬ä¸€å±‚ã€‚ã€‚ã€‚ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8a6ec6f4-5750-429b-a121-5fd97fac79a3-3"><p>åœ¨é€’å½’æ—¶è¶Šç•Œæ—¶ï¼Œæˆ‘ä»¬è¿˜èƒ½è¿”å›0ã€‚åœ¨æ•°ç»„ä¸­è¶Šç•Œäº†å¯å°±æŠ¥é”™äº†ï¼Œæ‰€ä»¥å†™ä¸€ä¸ªå‡½æ•°ä»æ•°ç»„ä¸­å–å‡ºæ¥ã€‚</p><p>è¶Šç•Œäº†å°±è¿”å›0ï¼Œæ²¡è¶Šç•Œæ‰ç»™ä½ å»æ‹¿</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">dp</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b, <span class="type">int</span> k)</span> &#123;</span><br><span class="line"><span class="type">int</span>[][][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">10</span>][<span class="number">9</span>][k + <span class="number">1</span>];</span><br><span class="line">dp[a][b][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">rest</span> <span class="operator">=</span> <span class="number">1</span>; rest &lt;= k; rest++) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>; x &lt; <span class="number">10</span>; x++) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">0</span>; y &lt; <span class="number">9</span>; y++) &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">ways</span> <span class="operator">=</span> pick(dp, x + <span class="number">2</span>, y + <span class="number">1</span>, rest - <span class="number">1</span>);</span><br><span class="line">ways += pick(dp, x + <span class="number">1</span>, y + <span class="number">2</span>, rest - <span class="number">1</span>);</span><br><span class="line">ways += pick(dp, x - <span class="number">1</span>, y + <span class="number">2</span>, rest - <span class="number">1</span>);</span><br><span class="line">ways += pick(dp, x - <span class="number">2</span>, y + <span class="number">1</span>, rest - <span class="number">1</span>);</span><br><span class="line">ways += pick(dp, x - <span class="number">2</span>, y - <span class="number">1</span>, rest - <span class="number">1</span>);</span><br><span class="line">ways += pick(dp, x - <span class="number">1</span>, y - <span class="number">2</span>, rest - <span class="number">1</span>);</span><br><span class="line">ways += pick(dp, x + <span class="number">1</span>, y - <span class="number">2</span>, rest - <span class="number">1</span>);</span><br><span class="line">ways += pick(dp, x + <span class="number">2</span>, y - <span class="number">1</span>, rest - <span class="number">1</span>);</span><br><span class="line">dp[x][y][rest] = ways;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dp[<span class="number">0</span>][<span class="number">0</span>][k];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">pick</span><span class="params">(<span class="type">int</span>[][][] dp, <span class="type">int</span> x, <span class="type">int</span> y, <span class="type">int</span> rest)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (x &lt; <span class="number">0</span> || x &gt; <span class="number">9</span> || y &lt; <span class="number">0</span> || y &gt; <span class="number">8</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dp[x][y][rest];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8a6ec6f4-5750-429b-a121-5fd97fac79a3-4"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="é¢˜ç›®äºŒ-ç©ºé—´ä¼˜åŒ–">é¢˜ç›®äºŒ(ç©ºé—´ä¼˜åŒ–)</h3><p>ç»™å®šä¸€ä¸ªäºŒç»´æ•°ç»„matrixï¼Œä¸€ä¸ªäººå¿…é¡»ä»å·¦ä¸Šè§’å‡ºå‘ï¼Œæœ€ååˆ°è¾¾å³ä¸‹è§’æ²¿é€”åªå¯ä»¥å‘ä¸‹æˆ–è€…å‘å³èµ°ï¼Œæ²¿é€”çš„æ•°å­—éƒ½ç´¯åŠ å°±æ˜¯è·ç¦»ç´¯åŠ å’Œè¿”å›æœ€å°è·ç¦»ç´¯åŠ å’Œ</p><p>è‹¥<code>dp[i][j]</code>çš„æ„æ€è¡¨ç¤ºä¸º ä»(i , j)ç‚¹èµ°åˆ°å³ä¸‹è§’ï¼Œæœ€çœçš„è·¯å¾„å’Œæ˜¯å¤šå°‘ã€‚åˆ™<code>dp[0][0]</code>ä¸ºæœ€ç»ˆç­”æ¡ˆ</p><p>è‹¥<code>dp[i][j]</code>çš„æ„æ€è¡¨ç¤ºä¸º ä»(0 , 0)ç‚¹åˆ°(i , j)ç‚¹ï¼Œæœ€çœçš„è·¯å¾„å’Œæ˜¯å¤šå°‘ã€‚åˆ™<code>dp[row - 1][col - 1]</code>ä¸ºæœ€ç»ˆç­”æ¡ˆ</p><p>ä¸¤ç§å†™æ³•éƒ½å¯ä»¥</p><div class="tabs" id="da9a7f11-c005-4ef0-b17e-77c823fd07d9"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#da9a7f11-c005-4ef0-b17e-77c823fd07d9-1"><i class="fas fa-seedling"></i>ç©ºé—´ä¾èµ–åˆ†æ</button></li><li class="tab"><button type="button" data-href="#da9a7f11-c005-4ef0-b17e-77c823fd07d9-2"><i class="fas fa-leaf"></i>ä¸¥æ ¼è¡¨ä¾èµ–</button></li><li class="tab"><button type="button" data-href="#da9a7f11-c005-4ef0-b17e-77c823fd07d9-3"><i class="fab fa-apple"></i>ç©ºé—´ä¼˜åŒ–åˆ†æ</button></li><li class="tab"><button type="button" data-href="#da9a7f11-c005-4ef0-b17e-77c823fd07d9-4"><i class="fas fa-tree"></i>ä¼˜åŒ–ä»£ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="da9a7f11-c005-4ef0-b17e-77c823fd07d9-1"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84111.png" alt="æœ€çŸ­è·¯å¾„111"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="da9a7f11-c005-4ef0-b17e-77c823fd07d9-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">minPathSum1</span><span class="params">(<span class="type">int</span>[][] m)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (m == <span class="literal">null</span> || m.length == <span class="number">0</span> || m[<span class="number">0</span>] == <span class="literal">null</span> || m[<span class="number">0</span>].length == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> m.length;</span><br><span class="line"><span class="type">int</span> <span class="variable">col</span> <span class="operator">=</span> m[<span class="number">0</span>].length;</span><br><span class="line"><span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[row][col];</span><br><span class="line">dp[<span class="number">0</span>][<span class="number">0</span>] = m[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; row; i++) &#123;</span><br><span class="line">dp[i][<span class="number">0</span>] = dp[i - <span class="number">1</span>][<span class="number">0</span>] + m[i][<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt; col; j++) &#123;</span><br><span class="line">dp[<span class="number">0</span>][j] = dp[<span class="number">0</span>][j - <span class="number">1</span>] + m[<span class="number">0</span>][j];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; row; i++) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt; col; j++) &#123;</span><br><span class="line">dp[i][j] = Math.min(dp[i - <span class="number">1</span>][j], dp[i][j - <span class="number">1</span>]) + m[i][j];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dp[row - <span class="number">1</span>][col - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="da9a7f11-c005-4ef0-b17e-77c823fd07d9-3"><p>åœ¨æˆ‘ä»¬æ¨ç¬¬17è¡Œçš„å€¼æ—¶åªéœ€è¦16è¡Œçš„å€¼ï¼Œä¹‹å‰è¡Œçš„å€¼å·²ç»ä¸éœ€è¦äº†ã€‚</p><p>åœ¨æ›´æ–°cçš„æ—¶å€™ï¼Œå·¦è¾¹å·²ç»æ˜¯æ›´æ–°å¥½çš„ï¼Œå½“å‰ä½ç½®è¿˜æœªè·Ÿæ–°ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E7%A9%BA%E9%97%B4%E4%BC%98%E5%8C%96111.png" alt="ç©ºé—´ä¼˜åŒ–111"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="da9a7f11-c005-4ef0-b17e-77c823fd07d9-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">minPathSum2</span><span class="params">(<span class="type">int</span>[][] m)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (m == <span class="literal">null</span> || m.length == <span class="number">0</span> || m[<span class="number">0</span>] == <span class="literal">null</span> || m[<span class="number">0</span>].length == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> m.length;</span><br><span class="line"><span class="type">int</span> <span class="variable">col</span> <span class="operator">=</span> m[<span class="number">0</span>].length;</span><br><span class="line"><span class="type">int</span>[] dp = <span class="keyword">new</span> <span class="title class_">int</span>[col];</span><br><span class="line">dp[<span class="number">0</span>] = m[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt; col; j++) &#123;</span><br><span class="line">dp[j] = dp[j - <span class="number">1</span>] + m[<span class="number">0</span>][j];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; row; i++) &#123;</span><br><span class="line">dp[<span class="number">0</span>] += m[i][<span class="number">0</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt; col; j++) &#123;</span><br><span class="line">dp[j] = Math.min(dp[j - <span class="number">1</span>], dp[j]) + m[i][j];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dp[col - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="è´´çº¸é—®é¢˜">è´´çº¸é—®é¢˜</h3><p>ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸²strï¼Œç»™å®šä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„æ•°ç»„arrï¼Œå‡ºç°çš„å­—ç¬¦éƒ½æ˜¯å°å†™è‹±æ–‡</p><p>arræ¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä»£è¡¨ä¸€å¼ è´´çº¸ï¼Œä½ å¯ä»¥æŠŠå•ä¸ªå­—ç¬¦å‰ªå¼€ä½¿ç”¨ï¼Œç›®çš„æ˜¯æ‹¼å‡ºstræ¥</p><p>è¿”å›éœ€è¦è‡³å°‘å¤šå°‘å¼ è´´çº¸å¯ä»¥å®Œæˆè¿™ä¸ªä»»åŠ¡</p><p>ä¾‹å­ï¼šstr = â€œbabacâ€ ,arr={â€œbaâ€,â€œcâ€,â€œabcdâ€}</p><p>è‡³å°‘éœ€è¦ä¸¤å¼ è´´çº¸&quot;ba&quot;å’Œ&quot;abcd&quot;,å› ä¸ºä½¿ç”¨è¿™ä¸¤å¼ è´´çº¸ï¼ŒæŠŠæ¯ä¸€ä¸ªå­—ç¬¦å•ç‹¬å‰ªå¼€ï¼Œå«æœ‰2ä¸ªaã€2ä¸ªbã€1ä¸ªcã€‚æ˜¯å¯ä»¥æ‹¼å‡ºstrçš„ã€‚æ‰€ä»¥è¿”å›2ã€‚</p><div class="tabs" id="c5e51d73-18c3-429e-bba5-5f04a785aca8"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c5e51d73-18c3-429e-bba5-5f04a785aca8-1"><i class="fas fa-award"></i>æš´åŠ›é€’å½’</button></li><li class="tab"><button type="button" data-href="#c5e51d73-18c3-429e-bba5-5f04a785aca8-2"><i class="fas fa-baseball-ball"></i>è¯é¢‘è¡¨ä¼˜åŒ–</button></li><li class="tab"><button type="button" data-href="#c5e51d73-18c3-429e-bba5-5f04a785aca8-3"><i class="fas fa-bone"></i>å“ˆå¸Œè¡¨ä¼˜åŒ–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c5e51d73-18c3-429e-bba5-5f04a785aca8-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">minStickers1</span><span class="params">(String[] stickers, String target)</span> &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> process1(stickers, target);</span><br><span class="line"><span class="keyword">return</span> ans == Integer.MAX_VALUE ? -<span class="number">1</span> : ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰€æœ‰è´´çº¸stickersï¼Œæ¯ä¸€ç§è´´çº¸éƒ½æœ‰æ— ç©·å¼ </span></span><br><span class="line"><span class="comment">// target</span></span><br><span class="line"><span class="comment">// æœ€å°‘å¼ æ•°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">process1</span><span class="params">(String[] stickers, String target)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (target.length() == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">min</span> <span class="operator">=</span> Integer.MAX_VALUE;</span><br><span class="line"><span class="keyword">for</span> (String first : stickers) &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">rest</span> <span class="operator">=</span> minus(target, first);</span><br><span class="line"><span class="keyword">if</span> (rest.length() != target.length()) &#123;</span><br><span class="line">min = Math.min(min, process1(stickers, rest));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> min + (min == Integer.MAX_VALUE ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">minus</span><span class="params">(String s1, String s2)</span> &#123;</span><br><span class="line"><span class="type">char</span>[] str1 = s1.toCharArray();</span><br><span class="line"><span class="type">char</span>[] str2 = s2.toCharArray();</span><br><span class="line"><span class="type">int</span>[] count = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">26</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">char</span> cha : str1) &#123;</span><br><span class="line">count[cha - <span class="string">&#x27;a&#x27;</span>]++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">char</span> cha : str2) &#123;</span><br><span class="line">count[cha - <span class="string">&#x27;a&#x27;</span>]--;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">StringBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">26</span>; i++) &#123;</span><br><span class="line"><span class="keyword">if</span> (count[i] &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; count[i]; j++) &#123;</span><br><span class="line">builder.append((<span class="type">char</span>) (i + <span class="string">&#x27;a&#x27;</span>));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> builder.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c5e51d73-18c3-429e-bba5-5f04a785aca8-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">minStickers2</span><span class="params">(String[] stickers, String target)</span> &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> stickers.length;</span><br><span class="line"><span class="comment">// å…³é”®ä¼˜åŒ–(ç”¨è¯é¢‘è¡¨æ›¿ä»£è´´çº¸æ•°ç»„)</span></span><br><span class="line"><span class="type">int</span>[][] counts = <span class="keyword">new</span> <span class="title class_">int</span>[N][<span class="number">26</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line"><span class="type">char</span>[] str = stickers[i].toCharArray();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">char</span> cha : str) &#123;</span><br><span class="line">counts[i][cha - <span class="string">&#x27;a&#x27;</span>]++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> process2(counts, target);</span><br><span class="line"><span class="keyword">return</span> ans == Integer.MAX_VALUE ? -<span class="number">1</span> : ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// stickers[i] æ•°ç»„ï¼Œå½“åˆiå·è´´çº¸çš„å­—ç¬¦ç»Ÿè®¡ int[][] stickers -&gt; æ‰€æœ‰çš„è´´çº¸</span></span><br><span class="line"><span class="comment">// æ¯ä¸€ç§è´´çº¸éƒ½æœ‰æ— ç©·å¼ </span></span><br><span class="line"><span class="comment">// è¿”å›æå®štargetçš„æœ€å°‘å¼ æ•°</span></span><br><span class="line"><span class="comment">// æœ€å°‘å¼ æ•°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">process2</span><span class="params">(<span class="type">int</span>[][] stickers, String t)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (t.length() == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// targetåšå‡ºè¯é¢‘ç»Ÿè®¡</span></span><br><span class="line"><span class="comment">// target  aabbc  2 2 1..</span></span><br><span class="line"><span class="comment">//                0 1 2..</span></span><br><span class="line"><span class="type">char</span>[] target = t.toCharArray();</span><br><span class="line"><span class="type">int</span>[] tcounts = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">26</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">char</span> cha : target) &#123;</span><br><span class="line">tcounts[cha - <span class="string">&#x27;a&#x27;</span>]++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> stickers.length;</span><br><span class="line"><span class="type">int</span> <span class="variable">min</span> <span class="operator">=</span> Integer.MAX_VALUE;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line"><span class="comment">// å°è¯•ç¬¬ä¸€å¼ è´´çº¸æ˜¯è°</span></span><br><span class="line"><span class="type">int</span>[] sticker = stickers[i];</span><br><span class="line"><span class="comment">// æœ€å…³é”®çš„ä¼˜åŒ–(é‡è¦çš„å‰ªæ!è¿™ä¸€æ­¥ä¹Ÿæ˜¯è´ªå¿ƒ!)</span></span><br><span class="line"><span class="keyword">if</span> (sticker[target[<span class="number">0</span>] - <span class="string">&#x27;a&#x27;</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="type">StringBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">26</span>; j++) &#123;</span><br><span class="line"><span class="keyword">if</span> (tcounts[j] &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">nums</span> <span class="operator">=</span> tcounts[j] - sticker[j];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; nums; k++) &#123;</span><br><span class="line">builder.append((<span class="type">char</span>) (j + <span class="string">&#x27;a&#x27;</span>));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">String</span> <span class="variable">rest</span> <span class="operator">=</span> builder.toString();</span><br><span class="line">min = Math.min(min, process2(stickers, rest));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> min + (min == Integer.MAX_VALUE ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c5e51d73-18c3-429e-bba5-5f04a785aca8-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">minStickers3</span><span class="params">(String[] stickers, String target)</span> &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> stickers.length;</span><br><span class="line"><span class="type">int</span>[][] counts = <span class="keyword">new</span> <span class="title class_">int</span>[N][<span class="number">26</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line"><span class="type">char</span>[] str = stickers[i].toCharArray();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">char</span> cha : str) &#123;</span><br><span class="line">counts[i][cha - <span class="string">&#x27;a&#x27;</span>]++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">HashMap&lt;String, Integer&gt; dp = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">dp.put(<span class="string">&quot;&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> process3(counts, target, dp);</span><br><span class="line"><span class="keyword">return</span> ans == Integer.MAX_VALUE ? -<span class="number">1</span> : ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">process3</span><span class="params">(<span class="type">int</span>[][] stickers, String t, HashMap&lt;String, Integer&gt; dp)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (dp.containsKey(t)) &#123;</span><br><span class="line"><span class="keyword">return</span> dp.get(t);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">char</span>[] target = t.toCharArray();</span><br><span class="line"><span class="type">int</span>[] tcounts = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">26</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">char</span> cha : target) &#123;</span><br><span class="line">tcounts[cha - <span class="string">&#x27;a&#x27;</span>]++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> stickers.length;</span><br><span class="line"><span class="type">int</span> <span class="variable">min</span> <span class="operator">=</span> Integer.MAX_VALUE;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line"><span class="type">int</span>[] sticker = stickers[i];</span><br><span class="line"><span class="keyword">if</span> (sticker[target[<span class="number">0</span>] - <span class="string">&#x27;a&#x27;</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="type">StringBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">26</span>; j++) &#123;</span><br><span class="line"><span class="keyword">if</span> (tcounts[j] &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">nums</span> <span class="operator">=</span> tcounts[j] - sticker[j];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; nums; k++) &#123;</span><br><span class="line">builder.append((<span class="type">char</span>) (j + <span class="string">&#x27;a&#x27;</span>));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">String</span> <span class="variable">rest</span> <span class="operator">=</span> builder.toString();</span><br><span class="line">min = Math.min(min, process3(stickers, rest, dp));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> min + (min == Integer.MAX_VALUE ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">dp.put(t, ans);</span><br><span class="line"><span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> ]]></content>
    
    
    <summary type="html">æš´åŠ›é€’å½’ã€è®°å¿†åŒ–æœç´¢ã€ä¸¥æ ¼è¡¨ç»“æ„ã€æ–œç‡ä¼˜åŒ–</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>è¿è¡Œæ—¶æ•°æ®åŒº</title>
    <link href="https://wuwawawa.github.io/posts/11595de.html"/>
    <id>https://wuwawawa.github.io/posts/11595de.html</id>
    <published>2023-07-04T02:36:49.000Z</published>
    <updated>2023-07-11T13:18:23.708Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬èŠ‚ä¸»è¦è®²çš„æ˜¯è¿è¡Œæ—¶æ•°æ®åŒºï¼Œä¹Ÿå°±æ˜¯ä¸‹å›¾è¿™éƒ¨åˆ†ï¼Œå®ƒæ˜¯åœ¨ç±»åŠ è½½å®Œæˆåçš„é˜¶æ®µ</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/b5d91ce04cfef9a681bbed216732511a.png" alt="image-20200705111640511" style="zoom:67%;" /><p>å½“æˆ‘ä»¬é€šè¿‡å‰é¢çš„ï¼š<code>ç±»çš„åŠ è½½-&gt; éªŒè¯ -&gt; å‡†å¤‡ -&gt; è§£æ -&gt; åˆå§‹åŒ–</code> è¿™å‡ ä¸ªé˜¶æ®µå®Œæˆåï¼Œå°±ä¼šç”¨åˆ°æ‰§è¡Œå¼•æ“å¯¹æˆ‘ä»¬çš„ç±»è¿›è¡Œä½¿ç”¨ï¼ŒåŒæ—¶æ‰§è¡Œå¼•æ“å°†ä¼šä½¿ç”¨åˆ°æˆ‘ä»¬è¿è¡Œæ—¶æ•°æ®åŒºã€‚</p><p>æˆ‘ä»¬æŠŠå¤§å¨åé¢çš„ä¸œè¥¿ï¼ˆåˆ‡å¥½çš„èœï¼Œåˆ€ï¼Œè°ƒæ–™ï¼‰ï¼Œæ¯”ä½œæ˜¯è¿è¡Œæ—¶æ•°æ®åŒºã€‚è€Œå¨å¸ˆå¯ä»¥ç±»æ¯”äºæ‰§è¡Œå¼•æ“ï¼Œå°†é€šè¿‡å‡†å¤‡çš„ä¸œè¥¿è¿›è¡Œåˆ¶ä½œæˆç²¾ç¾çš„èœå“</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/bbf59f2544890b06cdb69b2d7719c060.png" alt="image-20210509174543026" style="zoom:67%;" /><hr><hr><h2 id="ç¨‹åºè®¡æ•°å™¨">ç¨‹åºè®¡æ•°å™¨</h2><h3 id="PCå¯„å­˜å™¨ä»‹ç»">PCå¯„å­˜å™¨ä»‹ç»</h3><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/pcRegister.png" alt="pcRegister"></p><ol><li>JVMä¸­çš„ç¨‹åºè®¡æ•°å¯„å­˜å™¨ï¼ˆProgram Counter Registerï¼‰ä¸­ï¼ŒRegisterçš„å‘½åæºäºCPUçš„å¯„å­˜å™¨ï¼Œå¯„å­˜å™¨å­˜å‚¨æŒ‡ä»¤ç›¸å…³çš„ç°åœºä¿¡æ¯ã€‚CPUåªæœ‰æŠŠæ•°æ®è£…è½½åˆ°å¯„å­˜å™¨æ‰èƒ½å¤Ÿè¿è¡Œã€‚</li><li>è¿™é‡Œï¼Œå¹¶éæ˜¯å¹¿ä¹‰ä¸Šæ‰€æŒ‡çš„ç‰©ç†å¯„å­˜å™¨ï¼Œæˆ–è®¸å°†å…¶ç¿»è¯‘ä¸ºPCè®¡æ•°å™¨ï¼ˆæˆ–æŒ‡ä»¤è®¡æ•°å™¨ï¼‰ä¼šæ›´åŠ è´´åˆ‡ï¼ˆä¹Ÿç§°ä¸ºç¨‹åºé’©å­ï¼‰ï¼Œå¹¶ä¸”ä¹Ÿä¸å®¹æ˜“å¼•èµ·ä¸€äº›ä¸å¿…è¦çš„è¯¯ä¼šJVMä¸­çš„PCå¯„å­˜å™¨æ˜¯å¯¹ç‰©ç†PCå¯„å­˜å™¨çš„ä¸€ç§æŠ½è±¡æ¨¡æ‹Ÿã€‚</li><li>å®ƒæ˜¯ä¸€å—å¾ˆå°çš„å†…å­˜ç©ºé—´ï¼Œå‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®°ã€‚ä¹Ÿæ˜¯è¿è¡Œé€Ÿåº¦æœ€å¿«çš„å­˜å‚¨åŒºåŸŸã€‚</li><li>åœ¨JVMè§„èŒƒä¸­ï¼Œ<span class='p red'>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å®ƒè‡ªå·±çš„ç¨‹åºè®¡æ•°å™¨ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´ã€‚</span></li><li>ä»»ä½•æ—¶é—´ä¸€ä¸ªçº¿ç¨‹éƒ½åªæœ‰ä¸€ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„å½“å‰æ–¹æ³•ã€‚ç¨‹åºè®¡æ•°å™¨ä¼šå­˜å‚¨å½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„Javaæ–¹æ³•çš„JVMæŒ‡ä»¤åœ°å€ï¼›æˆ–è€…ï¼Œå¦‚æœæ˜¯åœ¨æ‰§è¡Œnativeæ–¹æ³•ï¼Œåˆ™æ˜¯æœªæŒ‡å®šå€¼ï¼ˆundefnedï¼‰ã€‚</li><li>å®ƒæ˜¯ç¨‹åºæ§åˆ¶æµçš„æŒ‡ç¤ºå™¨ï¼Œåˆ†æ”¯ã€å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹æ¢å¤ç­‰åŸºç¡€åŠŸèƒ½éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªè®¡æ•°å™¨æ¥å®Œæˆã€‚</li><li>å­—èŠ‚ç è§£é‡Šå™¨å·¥ä½œæ—¶å°±æ˜¯<span class='p blue'>é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚</span></li><li>å®ƒæ˜¯<span class='p red'>å”¯ä¸€ä¸€ä¸ª</span>åœ¨Javaè™šæ‹Ÿæœºè§„èŒƒä¸­æ²¡æœ‰è§„å®šä»»ä½•OutofMemoryErroræƒ…å†µçš„åŒºåŸŸã€‚</li></ol><hr><h3 id="PCå¯„å­˜å™¨ä½œç”¨">PCå¯„å­˜å™¨ä½œç”¨</h3><p>PC å¯„å­˜å™¨ç”¨æ¥å­˜å‚¨æŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œä¹Ÿå³å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤ä»£ç ã€‚ç”±æ‰§è¡Œå¼•æ“è¯»å–ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230704110320570.png" alt="image-20230704110320570" style="zoom: 50%;" /><blockquote><p>ä½¿ç”¨ PC å¯„å­˜å™¨å­˜å‚¨å­—èŠ‚ç æŒ‡ä»¤åœ°å€æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ</p><p>ä¸ºä»€ä¹ˆä½¿ç”¨ PC å¯„å­˜å™¨è®°å½•å½“å‰çº¿ç¨‹çš„æ‰§è¡Œåœ°å€å‘¢ï¼Ÿ</p></blockquote><ol><li><p>å› ä¸º CPU éœ€è¦ä¸åœçš„åˆ‡æ¢å„ä¸ªçº¿ç¨‹ï¼Œè¿™æ—¶å€™åˆ‡æ¢å›æ¥ä»¥åï¼Œå°±å¾—çŸ¥é“æ¥ç€ä»å“ªå¼€å§‹ç»§ç»­æ‰§è¡Œã€‚</p></li><li><p>JVM çš„å­—èŠ‚ç è§£é‡Šå™¨å°±éœ€è¦é€šè¿‡æ”¹å˜ PC å¯„å­˜å™¨çš„å€¼æ¥æ˜ç¡®ä¸‹ä¸€æ¡åº”è¯¥æ‰§è¡Œä»€ä¹ˆæ ·çš„å­—èŠ‚ç æŒ‡ä»¤ã€‚</p></li></ol><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/68aa12d47725e4559e6b71489d91122e.png" alt="image-20200705161409533"></p><blockquote><p>PC å¯„å­˜å™¨ä¸ºä»€ä¹ˆè¢«è®¾å®šä¸ºç§æœ‰çš„ï¼Ÿ</p></blockquote><p>æˆ‘ä»¬éƒ½çŸ¥é“æ‰€è°“çš„å¤šçº¿ç¨‹åœ¨ä¸€ä¸ªç‰¹å®šçš„æ—¶é—´æ®µå†…åªä¼šæ‰§è¡Œå…¶ä¸­æŸä¸€ä¸ªçº¿ç¨‹çš„æ–¹æ³•ï¼ŒCPU ä¼šä¸åœåœ°åšä»»åŠ¡åˆ‡æ¢ï¼Œè¿™æ ·å¿…ç„¶å¯¼è‡´ç»å¸¸ä¸­æ–­æˆ–æ¢å¤ï¼Œå¦‚ä½•ä¿è¯åˆ†æ¯«æ— å·®å‘¢ï¼Ÿ<span class='p green'>ä¸ºäº†èƒ½å¤Ÿå‡†ç¡®åœ°è®°å½•å„ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„å½“å‰å­—èŠ‚ç æŒ‡ä»¤åœ°å€ï¼Œæœ€å¥½çš„åŠæ³•è‡ªç„¶æ˜¯ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½åˆ†é…ä¸€ä¸ª PC å¯„å­˜å™¨</span>ï¼Œè¿™æ ·ä¸€æ¥å„ä¸ªçº¿ç¨‹ä¹‹é—´ä¾¿å¯ä»¥è¿›è¡Œç‹¬ç«‹è®¡ç®—ï¼Œä»è€Œä¸ä¼šå‡ºç°ç›¸äº’å¹²æ‰°çš„æƒ…å†µã€‚</p><p>ç”±äº CPU æ—¶é—´ç‰‡è½®é™åˆ¶ï¼Œä¼—å¤šçº¿ç¨‹åœ¨å¹¶å‘æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä»»ä½•ä¸€ä¸ªç¡®å®šçš„æ—¶åˆ»ï¼Œä¸€ä¸ªå¤„ç†å™¨æˆ–è€…å¤šæ ¸å¤„ç†å™¨ä¸­çš„ä¸€ä¸ªå†…æ ¸ï¼Œåªä¼šæ‰§è¡ŒæŸä¸ªçº¿ç¨‹ä¸­çš„ä¸€æ¡æŒ‡ä»¤ã€‚</p><p>è¿™æ ·å¿…ç„¶å¯¼è‡´ç»å¸¸ä¸­æ–­æˆ–æ¢å¤ï¼Œå¦‚ä½•ä¿è¯åˆ†æ¯«æ— å·®å‘¢ï¼Ÿæ¯ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºåï¼Œéƒ½ä¼šäº§ç”Ÿè‡ªå·±çš„ç¨‹åºè®¡æ•°å™¨å’Œæ ˆå¸§ï¼Œç¨‹åºè®¡æ•°å™¨åœ¨å„ä¸ªçº¿ç¨‹ä¹‹é—´äº’ä¸å½±å“ã€‚</p><mark class="hl-label blue">CPUæ—¶é—´ç‰‡</mark> <p>CPU æ—¶é—´ç‰‡å³ CPU åˆ†é…ç»™å„ä¸ªç¨‹åºçš„æ—¶é—´ï¼Œæ¯ä¸ªçº¿ç¨‹è¢«åˆ†é…ä¸€ä¸ªæ—¶é—´æ®µï¼Œç§°ä½œå®ƒçš„æ—¶é—´ç‰‡ã€‚</p><p>åœ¨å®è§‚ä¸Šï¼šä¿„ä»¬å¯ä»¥åŒæ—¶æ‰“å¼€å¤šä¸ªåº”ç”¨ç¨‹åºï¼Œæ¯ä¸ªç¨‹åºå¹¶è¡Œä¸æ‚–ï¼ŒåŒæ—¶è¿è¡Œã€‚</p><p>ä½†åœ¨å¾®è§‚ä¸Šï¼šç”±äºåªæœ‰ä¸€ä¸ª CPUï¼Œä¸€æ¬¡åªèƒ½å¤„ç†ç¨‹åºè¦æ±‚çš„ä¸€éƒ¨åˆ†ï¼Œå¦‚ä½•å¤„ç†å…¬å¹³ï¼Œä¸€ç§æ–¹æ³•å°±æ˜¯å¼•å…¥æ—¶é—´ç‰‡ï¼Œæ¯ä¸ªç¨‹åºè½®æµæ‰§è¡Œã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/bbab7cdab74c493af70b423f06e6ff86.png" alt="image-20200705161849557"></p><hr><hr><h2 id="è™šæ‹Ÿæœºæ ˆ">è™šæ‹Ÿæœºæ ˆ</h2><h3 id="æ¦‚è¿°">æ¦‚è¿°</h3><blockquote><p>è™šæ‹Ÿæœºæ ˆå‡ºç°èƒŒæ™¯</p></blockquote><p>ç”±äºè·¨å¹³å°æ€§çš„è®¾è®¡ï¼ŒJava çš„æŒ‡ä»¤éƒ½æ˜¯æ ¹æ®æ ˆæ¥è®¾è®¡çš„ã€‚ä¸åŒå¹³å° CPU æ¶æ„ä¸åŒï¼Œæ‰€ä»¥ä¸èƒ½è®¾è®¡ä¸ºåŸºäºå¯„å­˜å™¨çš„ã€‚</p><p>ä¼˜ç‚¹æ˜¯è·¨å¹³å°ï¼ŒæŒ‡ä»¤é›†å°ï¼Œç¼–è¯‘å™¨å®¹æ˜“å®ç°</p><p>ç¼ºç‚¹æ˜¯æ€§èƒ½ä¸‹é™ï¼Œå®ç°åŒæ ·çš„åŠŸèƒ½éœ€è¦æ›´å¤šçš„æŒ‡ä»¤</p><blockquote><p>å†…å­˜ä¸­çš„æ ˆä¸å †</p></blockquote><span class='p red'>æ ˆæ˜¯è¿è¡Œæ—¶çš„å•ä½ï¼Œè€Œå †æ˜¯å­˜å‚¨çš„å•ä½</span><ul><li>æ ˆè§£å†³ç¨‹åºçš„è¿è¡Œé—®é¢˜ï¼Œå³ç¨‹åºå¦‚ä½•æ‰§è¡Œï¼Œæˆ–è€…è¯´å¦‚ä½•å¤„ç†æ•°æ®ã€‚</li><li>å †è§£å†³çš„æ˜¯æ•°æ®å­˜å‚¨çš„é—®é¢˜ï¼Œå³æ•°æ®æ€ä¹ˆæ”¾ï¼Œæ”¾å“ªé‡Œ</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/2d195f3aafd8b1f426efad75f0a52478.png" alt="image-20200705163928652"></p><hr><h3 id="åŸºæœ¬å†…å®¹">åŸºæœ¬å†…å®¹</h3><p>Java è™šæ‹Ÿæœºæ ˆï¼ˆJava Virtual Machine Stackï¼‰ï¼Œæ—©æœŸä¹Ÿå« Java æ ˆã€‚æ¯ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºæ ˆï¼Œå…¶å†…éƒ¨ä¿å­˜ä¸€ä¸ªä¸ªçš„<code>æ ˆå¸§ï¼ˆStack Frameï¼‰</code>ï¼Œå¯¹åº”ç€ä¸€æ¬¡æ¬¡çš„ Java æ–¹æ³•è°ƒç”¨ï¼Œæ˜¯<code>çº¿ç¨‹ç§æœ‰</code>çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StackTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">StackTest</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StackTest</span>();</span><br><span class="line">        test.methodA();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">methodA</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line">        methodB();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">methodB</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">30</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> <span class="number">40</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230704112513940.png" alt="image-20230704112513940" style="zoom: 33%;" /><div class="tabs" id="b83445ba-2a3a-4d66-a332-642943ddda1f"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#b83445ba-2a3a-4d66-a332-642943ddda1f-1"><i class="fas fa-cat"></i>ç”Ÿå‘½å‘¨æœŸ</button></li><li class="tab"><button type="button" data-href="#b83445ba-2a3a-4d66-a332-642943ddda1f-2"><i class="fas fa-horse"></i>ä½œç”¨</button></li><li class="tab"><button type="button" data-href="#b83445ba-2a3a-4d66-a332-642943ddda1f-3"><i class="fas fa-dove"></i>ç‰¹ç‚¹</button></li><li class="tab"><button type="button" data-href="#b83445ba-2a3a-4d66-a332-642943ddda1f-4"><i class="fas fa-dragon"></i>æ ˆä¸­å¯èƒ½å‡ºç°çš„å¼‚å¸¸</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="b83445ba-2a3a-4d66-a332-642943ddda1f-1"><p>ç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹ä¸€è‡´ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b83445ba-2a3a-4d66-a332-642943ddda1f-2"><p>ä¸»ç®¡ Java ç¨‹åºçš„è¿è¡Œï¼Œå®ƒä¿å­˜æ–¹æ³•çš„å±€éƒ¨å˜é‡ã€éƒ¨åˆ†ç»“æœï¼Œå¹¶å‚ä¸æ–¹æ³•çš„è°ƒç”¨å’Œè¿”å›ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b83445ba-2a3a-4d66-a332-642943ddda1f-3"><ul><li><p>æ ˆæ˜¯ä¸€ç§å¿«é€Ÿæœ‰æ•ˆçš„åˆ†é…å­˜å‚¨æ–¹å¼ï¼Œè®¿é—®é€Ÿåº¦ä»…æ¬¡äºç¨‹åºåºè®¡æ•°å™¨ã€‚</p></li><li><p>JVM ç›´æ¥å¯¹ Java æ ˆçš„æ“ä½œåªæœ‰ä¸¤ä¸ªï¼š</p><ul><li>æ¯ä¸ªæ–¹æ³•æ‰§è¡Œï¼Œä¼´éšç€è¿›æ ˆï¼ˆå…¥æ ˆã€å‹æ ˆï¼‰</li><li>æ‰§è¡Œç»“æŸåçš„å‡ºæ ˆå·¥ä½œ</li></ul></li><li><p>å¯¹äºæ ˆæ¥è¯´ä¸å­˜åœ¨åƒåœ¾å›æ”¶é—®é¢˜ï¼ˆæ ˆå­˜åœ¨æº¢å‡ºçš„æƒ…å†µï¼‰</p><ul><li>æ ˆä¸éœ€è¦GCï¼Œä½†æ˜¯å¯èƒ½å­˜åœ¨OOM</li></ul></li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/d4e4445f4faee685dc98d54129344bb3.png" alt="image-20200705165025382"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b83445ba-2a3a-4d66-a332-642943ddda1f-4"><p>Java è™šæ‹Ÿæœºè§„èŒƒå…è®¸Java æ ˆçš„å¤§å°æ˜¯åŠ¨æ€çš„æˆ–è€…æ˜¯å›ºå®šä¸å˜çš„ã€‚</p><ul><li><p>å¦‚æœé‡‡ç”¨å›ºå®šå¤§å°çš„ Java è™šæ‹Ÿæœºæ ˆï¼Œé‚£æ¯ä¸€ä¸ªçº¿ç¨‹çš„ Java è™šæ‹Ÿæœºæ ˆå®¹é‡å¯ä»¥åœ¨çº¿ç¨‹åˆ›å»ºçš„æ—¶å€™ç‹¬ç«‹é€‰å®šã€‚å¦‚æœçº¿ç¨‹è¯·æ±‚åˆ†é…çš„æ ˆå®¹é‡è¶…è¿‡ Java è™šæ‹Ÿæœºæ ˆå…è®¸çš„æœ€å¤§å®¹é‡ï¼ŒJava è™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ª<code>StackOverflowErrorå¼‚å¸¸</code>ã€‚</p></li><li><p>å¦‚æœ Java è™šæ‹Ÿæœºæ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œå¹¶ä¸”åœ¨å°è¯•æ‰©å±•çš„æ—¶å€™æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œæˆ–è€…åœ¨åˆ›å»ºæ–°çš„çº¿ç¨‹æ—¶æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å»åˆ›å»ºå¯¹åº”çš„è™šæ‹Ÿæœºæ ˆï¼Œé‚£ Java è™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ª<code>OutOfMemoryErrorå¼‚å¸¸</code>ã€‚</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    test();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    test();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æŠ›å‡ºå¼‚å¸¸ï¼šException in thread&quot;main&quot;java.lang.StackoverflowError</span></span><br><span class="line"><span class="comment">//ç¨‹åºä¸æ–­çš„è¿›è¡Œé€’å½’è°ƒç”¨ï¼Œè€Œä¸”æ²¡æœ‰é€€å‡ºæ¡ä»¶ï¼Œå°±ä¼šå¯¼è‡´ä¸æ–­åœ°è¿›è¡Œå‹æ ˆã€‚</span></span><br></pre></td></tr></table></figure><p><mark class="hl-label blue">è®¾ç½®æ ˆå†…å­˜å¤§å°</mark></p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‚æ•° <code>-Xss </code>é€‰é¡¹æ¥è®¾ç½®<code>çº¿ç¨‹çš„æœ€å¤§æ ˆç©ºé—´</code>ï¼Œæ ˆçš„å¤§å°ç›´æ¥å†³å®šäº†å‡½æ•°è°ƒç”¨çš„æœ€å¤§å¯è¾¾æ·±åº¦</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="å­˜å‚¨å•ä½æ ˆå¸§">å­˜å‚¨å•ä½æ ˆå¸§</h3><mark class="hl-label blue">æ ˆä¸­å­˜å‚¨ä»€ä¹ˆï¼Ÿ</mark> <p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ ˆï¼Œæ ˆä¸­çš„æ•°æ®éƒ½æ˜¯ä»¥<code>æ ˆå¸§ï¼ˆStack Frameï¼‰</code>çš„æ ¼å¼å­˜åœ¨ã€‚</p><p>åœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šæ­£åœ¨æ‰§è¡Œçš„æ¯ä¸ªæ–¹æ³•éƒ½å„è‡ªå¯¹åº”ä¸€ä¸ªæ ˆå¸§ï¼ˆStack Frameï¼‰ã€‚</p><p>æ ˆå¸§æ˜¯ä¸€ä¸ªå†…å­˜åŒºå—ï¼Œæ˜¯ä¸€ä¸ªæ•°æ®é›†ï¼Œç»´ç³»ç€æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å„ç§æ•°æ®ä¿¡æ¯ã€‚</p><mark class="hl-label blue">æ ˆè¿è¡ŒåŸç†</mark> <ol><li><p>JVMç›´æ¥å¯¹Javaæ ˆçš„æ“ä½œåªæœ‰ä¸¤ä¸ªï¼Œå°±æ˜¯å¯¹æ ˆå¸§çš„å‹æ ˆå’Œå‡ºæ ˆ</p></li><li><p>åœ¨ä¸€æ¡æ´»åŠ¨çº¿ç¨‹ä¸­ï¼Œä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œåªä¼šæœ‰ä¸€ä¸ªæ´»åŠ¨çš„æ ˆå¸§ã€‚å³åªæœ‰å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•çš„æ ˆå¸§ï¼ˆæ ˆé¡¶æ ˆå¸§ï¼‰æ˜¯æœ‰æ•ˆçš„ã€‚è¿™ä¸ªæ ˆå¸§è¢«ç§°ä¸º<span class='p green'>å½“å‰æ ˆå¸§ï¼ˆCurrent Frameï¼‰</span>ï¼Œä¸å½“å‰æ ˆå¸§ç›¸å¯¹åº”çš„æ–¹æ³•å°±æ˜¯<span class='p green'>å½“å‰æ–¹æ³•ï¼ˆCurrent Methodï¼‰</span>ï¼Œå®šä¹‰è¿™ä¸ªæ–¹æ³•çš„ç±»å°±æ˜¯<span class='p green'>å½“å‰ç±»ï¼ˆCurrent Classï¼‰</span></p></li><li><p>æ‰§è¡Œå¼•æ“è¿è¡Œçš„æ‰€æœ‰å­—èŠ‚ç æŒ‡ä»¤åªé’ˆå¯¹å½“å‰æ ˆå¸§è¿›è¡Œæ“ä½œã€‚</p></li><li><p>å¦‚æœåœ¨è¯¥æ–¹æ³•ä¸­è°ƒç”¨äº†å…¶ä»–æ–¹æ³•ï¼Œå¯¹åº”çš„æ–°çš„æ ˆå¸§ä¼šè¢«åˆ›å»ºå‡ºæ¥ï¼Œæ”¾åœ¨æ ˆçš„é¡¶ç«¯ï¼Œæˆä¸ºæ–°çš„å½“å‰å¸§ã€‚</p></li></ol><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/893126a7a33507917e11377fd3e4b639.png" alt="image-20200705203142545"></p><ol start="5"><li><p>ä¸åŒçº¿ç¨‹ä¸­æ‰€åŒ…å«çš„æ ˆå¸§æ˜¯ä¸å…è®¸å­˜åœ¨ç›¸äº’å¼•ç”¨çš„ï¼Œå³ä¸å¯èƒ½åœ¨ä¸€ä¸ªæ ˆå¸§ä¹‹ä¸­å¼•ç”¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„æ ˆå¸§ã€‚</p></li><li><p>å¦‚æœå½“å‰æ–¹æ³•è°ƒç”¨äº†å…¶ä»–æ–¹æ³•ï¼Œæ–¹æ³•è¿”å›ä¹‹é™…ï¼Œå½“å‰æ ˆå¸§ä¼šä¼ å›æ­¤æ–¹æ³•çš„æ‰§è¡Œç»“æœç»™å‰ä¸€ä¸ªæ ˆå¸§ï¼Œæ¥ç€ï¼Œè™šæ‹Ÿæœºä¼šä¸¢å¼ƒå½“å‰æ ˆå¸§ï¼Œä½¿å¾—å‰ä¸€ä¸ªæ ˆå¸§é‡æ–°æˆä¸ºå½“å‰æ ˆå¸§ã€‚</p></li><li><p>Javaæ–¹æ³•æœ‰ä¸¤ç§è¿”å›å‡½æ•°çš„æ–¹å¼ã€‚ä¸€ç§æ˜¯æ­£å¸¸çš„å‡½æ•°è¿”å›ï¼Œä½¿ç”¨returnæŒ‡ä»¤ï¼›å¦ä¸€ç§æ˜¯æ–¹æ³•æ‰§è¡Œä¸­å‡ºç°æœªæ•è·å¤„ç†çš„å¼‚å¸¸ï¼Œä»¥æŠ›å‡ºå¼‚å¸¸çš„æ–¹å¼ç»“æŸã€‚ä½†ä¸ç®¡ä½¿ç”¨å“ªç§æ–¹å¼ï¼Œéƒ½ä¼šå¯¼è‡´æ ˆå¸§è¢«å¼¹å‡ºã€‚</p></li></ol><mark class="hl-label blue">æ ˆå¸§çš„å†…éƒ¨ç»“æ„</mark> <p>æ¯ä¸ªæ ˆå¸§ä¸­å­˜å‚¨ç€ï¼š</p><ul><li><span class='p red'>å±€éƒ¨å˜é‡è¡¨ï¼ˆLocal Variablesï¼‰</span></li><li><span class='p red'>æ“ä½œæ•°æ ˆï¼ˆoperand Stackï¼‰ï¼ˆæˆ–è¡¨è¾¾å¼æ ˆï¼‰</span></li><li>åŠ¨æ€é“¾æ¥ï¼ˆDynamicLinkingï¼‰ï¼ˆæˆ–æŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„æ–¹æ³•å¼•ç”¨ï¼‰</li><li>æ–¹æ³•è¿”å›åœ°å€ï¼ˆReturn Addressï¼‰ï¼ˆæˆ–æ–¹æ³•æ­£å¸¸é€€å‡ºæˆ–è€…å¼‚å¸¸é€€å‡ºçš„å®šä¹‰ï¼‰</li><li>ä¸€äº›é™„åŠ ä¿¡æ¯</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/0ed2029b435d547547f32540077bb082.png" alt="image-20200705204836977"></p><p>å¹¶è¡Œæ¯ä¸ªçº¿ç¨‹ä¸‹çš„æ ˆéƒ½æ˜¯ç§æœ‰çš„ï¼Œå› æ­¤æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±å„è‡ªçš„æ ˆï¼Œå¹¶ä¸”æ¯ä¸ªæ ˆé‡Œé¢éƒ½æœ‰å¾ˆå¤šæ ˆå¸§ï¼Œæ ˆå¸§çš„å¤§å°ä¸»è¦ç”±å±€éƒ¨å˜é‡è¡¨å’Œæ“ä½œæ•°æ ˆå†³å®šçš„</p><hr><hr><h2 id="æœ¬åœ°æ–¹æ³•æ ˆ">æœ¬åœ°æ–¹æ³•æ ˆ</h2><h3 id="æœ¬åœ°æ–¹æ³•">æœ¬åœ°æ–¹æ³•</h3><p>ç®€å•åœ°è®²ï¼Œä¸€ä¸ª Native Method æ˜¯ä¸€ä¸ª Java è°ƒç”¨é Java ä»£ç çš„æ¥å›—ã€‚ä¸€ä¸ª Native Method æ˜¯è¿™æ ·ä¸€ä¸ª Java æ–¹æ³•ï¼šè¯¥æ–¹æ³•çš„å®ç°ç”±é Java è¯­è¨€å®ç°ï¼Œæ¯”å¦‚ Cã€‚è¿™ä¸ªç‰¹å¾å¹¶é Java æ‰€ç‰¹æœ‰ï¼Œå¾ˆå¤šå…¶å®ƒçš„ç¼–ç¨‹è¯­è¨€éƒ½æœ‰è¿™ä¸€æœºåˆ¶ï¼Œæ¯”å¦‚åœ¨ C++ä¸­ï¼Œä½ å¯ä»¥ç”¨ extern â€œcâ€ å‘ŠçŸ¥ c++ç¼–è¯‘å™¨å»è°ƒç”¨ä¸€ä¸ª c çš„å‡½æ•°ã€‚</p><p>A native method is a Java method whose implementation is provided by non-java code.</p><p>åœ¨å®šä¹‰ä¸€ä¸ª native method æ—¶ï¼Œå¹¶ä¸æä¾›å®ç°ä½“ï¼ˆæœ‰äº›åƒå®šä¹‰ä¸€ä¸ª Java interfaceï¼‰ï¼Œå› ä¸ºå…¶å®ç°ä½“æ˜¯ç”±é java è¯­è¨€åœ¨å¤–é¢å®ç°çš„ã€‚</p><p>æœ¬åœ°æ¥å£çš„ä½œç”¨æ˜¯èåˆä¸åŒçš„ç¼–ç¨‹è¯­è¨€ä¸º Java æ‰€ç”¨ï¼Œå®ƒçš„åˆè¡·æ˜¯èåˆ C/C++ç¨‹åºã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/7b36a8321e4c955f06220775c9c2cf4c.png" alt="image-20200706164139252"></p><hr><h3 id="æœ¬åœ°æ–¹æ³•æ ˆ-2">æœ¬åœ°æ–¹æ³•æ ˆ</h3><p>Java è™šæ‹Ÿæœºæ ˆäºç®¡ç† Java æ–¹æ³•çš„è°ƒç”¨ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆç”¨äºç®¡ç†æœ¬åœ°æ–¹æ³•çš„è°ƒç”¨ã€‚</p><p>æœ¬åœ°æ–¹æ³•æ ˆï¼Œä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚</p><p>å…è®¸è¢«å®ç°æˆå›ºå®šæˆ–è€…æ˜¯å¯åŠ¨æ€æ‰©å±•çš„å†…å­˜å¤§å°ã€‚ï¼ˆåœ¨å†…å­˜æº¢å‡ºæ–¹é¢æ˜¯ç›¸åŒçš„ï¼‰</p><ul><li>å¦‚æœçº¿ç¨‹è¯·æ±‚åˆ†é…çš„æ ˆå®¹é‡è¶…è¿‡æœ¬åœ°æ–¹æ³•æ ˆå…è®¸çš„æœ€å¤§å®¹é‡ï¼ŒJava è™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ª StackOverflowError å¼‚å¸¸ã€‚</li><li>å¦‚æœæœ¬åœ°æ–¹æ³•æ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œå¹¶ä¸”åœ¨å°è¯•æ‰©å±•çš„æ—¶å€™æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œæˆ–è€…åœ¨åˆ›å»ºæ–°çš„çº¿ç¨‹æ—¶æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å»åˆ›å»ºå¯¹åº”çš„æœ¬åœ°æ–¹æ³•æ ˆï¼Œé‚£ä¹ˆ Java è™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ª OutOfMemoryError å¼‚å¸¸ã€‚</li></ul><p>æœ¬åœ°æ–¹æ³•æ˜¯ä½¿ç”¨ C è¯­è¨€å®ç°çš„ã€‚</p><p>å®ƒçš„å…·ä½“åšæ³•æ˜¯ Native Method Stack ä¸­ç™»è®° native æ–¹æ³•ï¼Œåœ¨ Execution Engine æ‰§è¡Œæ—¶åŠ è½½æœ¬åœ°æ–¹æ³•åº“ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/b4aea15cec874411f749e336c8b5d8fd.png" alt="image-20200706174708418"></p><p>å½“æŸä¸ªçº¿ç¨‹è°ƒç”¨ä¸€ä¸ªæœ¬åœ°æ–¹æ³•æ—¶ï¼Œå®ƒå°±è¿›å…¥äº†ä¸€ä¸ªå…¨æ–°çš„å¹¶ä¸”ä¸å†å—è™šæ‹Ÿæœºé™åˆ¶çš„ä¸–ç•Œã€‚å®ƒå’Œè™šæ‹Ÿæœºæ‹¥æœ‰åŒæ ·çš„æƒé™ã€‚</p><ul><li>æœ¬åœ°æ–¹æ³•å¯ä»¥é€šè¿‡æœ¬åœ°æ–¹æ³•æ¥å£æ¥è®¿é—®è™šæ‹Ÿæœºå†…éƒ¨çš„è¿è¡Œæ—¶æ•°æ®åŒºã€‚</li><li>å®ƒç”šè‡³å¯ä»¥ç›´æ¥ä½¿ç”¨æœ¬åœ°å¤„ç†å™¨ä¸­çš„å¯„å­˜å™¨</li><li>ç›´æ¥ä»æœ¬åœ°å†…å­˜çš„å †ä¸­åˆ†é…ä»»æ„æ•°é‡çš„å†…å­˜ã€‚</li></ul><p>å¹¶ä¸æ˜¯æ‰€æœ‰çš„ JVM éƒ½æ”¯æŒæœ¬åœ°æ–¹æ³•ã€‚å› ä¸º Java è™šæ‹Ÿæœºè§„èŒƒå¹¶æ²¡æœ‰æ˜ç¡®è¦æ±‚æœ¬åœ°æ–¹æ³•æ ˆçš„ä½¿ç”¨è¯­è¨€ã€å…·ä½“å®ç°æ–¹å¼ã€æ•°æ®ç»“æ„ç­‰ã€‚å¦‚æœ JVM äº§å“ä¸æ‰“ç®—æ”¯æŒ native æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥æ— éœ€å®ç°æœ¬åœ°æ–¹æ³•æ ˆã€‚</p><p>åœ¨ Hotspot JVM ä¸­ï¼Œç›´æ¥å°†æœ¬åœ°æ–¹æ³•æ ˆå’Œè™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€ã€‚</p><hr><hr><h2 id="å †">å †</h2><h3 id="æ¦‚è¿°-2">æ¦‚è¿°</h3><ol><li>å †é’ˆå¯¹ä¸€ä¸ªJVMè¿›ç¨‹æ¥è¯´æ˜¯å”¯ä¸€çš„ã€‚ä¹Ÿå°±æ˜¯<span class='p red'>ä¸€ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªJVMå®ä¾‹</span>ï¼Œä¸€ä¸ªJVMå®ä¾‹ä¸­å°±æœ‰ä¸€ä¸ªè¿è¡Œæ—¶æ•°æ®åŒºï¼Œä¸€ä¸ªè¿è¡Œæ—¶æ•°æ®åŒºåªæœ‰ä¸€ä¸ªå †å’Œä¸€ä¸ªæ–¹æ³•åŒºã€‚</li><li>ä½†æ˜¯<span class='p blue'>è¿›ç¨‹åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼Œä»–ä»¬æ˜¯å…±äº«åŒä¸€å †ç©ºé—´çš„</span>ã€‚</li></ol><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/0be60cad417bedd46d651f710ae585ce.png" alt="image-20200706195127740"></p><ol start="3"><li><p>ä¸€ä¸ª JVM å®ä¾‹åªå­˜åœ¨ä¸€ä¸ªå †å†…å­˜ï¼Œå †ä¹Ÿæ˜¯ Java å†…å­˜ç®¡ç†çš„æ ¸å¿ƒåŒºåŸŸã€‚</p></li><li><p>Java å †åŒºåœ¨ JVM å¯åŠ¨çš„æ—¶å€™å³è¢«åˆ›å»ºï¼Œå…¶ç©ºé—´å¤§å°ä¹Ÿå°±ç¡®å®šäº†ã€‚<span class='p green'>æ˜¯ JVM ç®¡ç†çš„æœ€å¤§ä¸€å—å†…å­˜ç©ºé—´</span>ï¼Œå †å†…å­˜çš„å¤§å°æ˜¯å¯ä»¥è°ƒèŠ‚çš„ã€‚</p></li><li><p>ã€ŠJava è™šæ‹Ÿæœºè§„èŒƒã€‹è§„å®šï¼Œå †å¯ä»¥å¤„äºç‰©ç†ä¸Šä¸è¿ç»­çš„å†…å­˜ç©ºé—´ä¸­ï¼Œä½†åœ¨é€»è¾‘ä¸Šå®ƒåº”è¯¥è¢«è§†ä¸ºè¿ç»­çš„ã€‚</p></li><li><p>æ‰€æœ‰çš„çº¿ç¨‹å…±äº« Java å †ï¼Œåœ¨è¿™é‡Œè¿˜å¯ä»¥åˆ’åˆ†çº¿ç¨‹ç§æœ‰çš„ç¼“å†²åŒºï¼ˆThread Local Allocation Bufferï¼ŒTLABï¼‰ã€‚</p></li><li><p>ã€ŠJava è™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­å¯¹ Java å †çš„æè¿°æ˜¯ï¼šæ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ä»¥åŠæ•°ç»„éƒ½åº”å½“åœ¨è¿è¡Œæ—¶åˆ†é…åœ¨å †ä¸Šã€‚</p></li><li><p>æ•°ç»„å’Œå¯¹è±¡å¯èƒ½æ°¸è¿œä¸ä¼šå­˜å‚¨åœ¨æ ˆä¸Šï¼Œå› ä¸ºæ ˆå¸§ä¸­ä¿å­˜å¼•ç”¨ï¼Œè¿™ä¸ªå¼•ç”¨æŒ‡å‘å¯¹è±¡æˆ–è€…æ•°ç»„åœ¨å †ä¸­çš„ä½ç½®ã€‚</p></li><li><p>åœ¨æ–¹æ³•ç»“æŸåï¼Œå †ä¸­çš„å¯¹è±¡ä¸ä¼šé©¬ä¸Šè¢«ç§»é™¤ï¼Œä»…ä»…åœ¨åƒåœ¾æ”¶é›†çš„æ—¶å€™æ‰ä¼šè¢«ç§»é™¤ã€‚</p><ul><li>ä¹Ÿå°±æ˜¯è§¦å‘äº†GCçš„æ—¶å€™ï¼Œæ‰ä¼šè¿›è¡Œå›æ”¶</li><li>å¦‚æœå †ä¸­å¯¹è±¡é©¬ä¸Šè¢«å›æ”¶ï¼Œé‚£ä¹ˆç”¨æˆ·çº¿ç¨‹å°±ä¼šæ”¶åˆ°å½±å“ï¼Œå› ä¸ºæœ‰stop the word</li></ul></li><li><p>å †ï¼Œæ˜¯ GCï¼ˆGarbage Collectionï¼Œåƒåœ¾æ”¶é›†å™¨ï¼‰æ‰§è¡Œåƒåœ¾å›æ”¶çš„é‡ç‚¹åŒºåŸŸã€‚</p></li></ol><p><img src="https://img-blog.csdnimg.cn/img_convert/3ae9948d069bd58ccfcda730cc12bf0f.png" alt="image-20200706201904057"></p><hr><h3 id="å †å†…å­˜ç»†åˆ†">å †å†…å­˜ç»†åˆ†</h3><p>Java 7 åŠä¹‹å‰å †å†…å­˜é€»è¾‘ä¸Šåˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šæ–°ç”ŸåŒº+å…»è€åŒº+æ°¸ä¹…åŒº</p><ul><li>Young Generation Space æ–°ç”ŸåŒº Young/New åˆè¢«åˆ’åˆ†ä¸º Eden åŒºå’Œ Survivor åŒº</li><li>Tenure generation space å…»è€åŒº Old/Tenure</li><li>Permanent Space æ°¸ä¹…åŒº Perm</li></ul><p>Java 8 åŠä¹‹åå †å†…å­˜é€»è¾‘ä¸Šåˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šæ–°ç”ŸåŒº+å…»è€åŒº+å…ƒç©ºé—´</p><ul><li>Young Generation Space æ–°ç”ŸåŒº Young/New åˆè¢«åˆ’åˆ†ä¸º Eden åŒºå’Œ Survivor åŒº</li><li>Tenure generation space å…»è€åŒº Old/Tenure</li><li>Meta Space å…ƒç©ºé—´ Meta</li></ul><p>çº¦å®šï¼šæ–°ç”ŸåŒºï¼ˆä»£ï¼‰&lt;=&gt;å¹´è½»ä»£ ã€ å…»è€åŒº&lt;=&gt;è€å¹´åŒºï¼ˆä»£ï¼‰ã€ æ°¸ä¹…åŒº&lt;=&gt;æ°¸ä¹…ä»£</p><div class="tabs" id="821a3913-ff13-4e1a-9b3a-93dd49ed7d14"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#821a3913-ff13-4e1a-9b3a-93dd49ed7d14-1"><i class="fas fa-award"></i>å †ç©ºé—´å†…éƒ¨ç»“æ„ï¼ˆJDK7ï¼‰</button></li><li class="tab"><button type="button" data-href="#821a3913-ff13-4e1a-9b3a-93dd49ed7d14-2"><i class="fas fa-baseball-ball"></i>å †ç©ºé—´å†…éƒ¨ç»“æ„ï¼ˆJDK8ï¼‰</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="821a3913-ff13-4e1a-9b3a-93dd49ed7d14-1"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/deafdcce7cf88a496bc231820bb5b007.png" alt="image-20200706203419496" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="821a3913-ff13-4e1a-9b3a-93dd49ed7d14-2"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/ee2836af2e1d5387b4ac58f5eacabbb6.png" alt="image-20200706203835403" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="è®¾ç½®å †å†…å­˜å¤§å°">è®¾ç½®å †å†…å­˜å¤§å°</h3><ol><li><p>Javaå †åŒºç”¨äºå­˜å‚¨Javaå¯¹è±¡å®ä¾‹ï¼Œé‚£ä¹ˆå †çš„å¤§å°åœ¨JVMå¯åŠ¨æ—¶å°±å·²ç»è®¾å®šå¥½äº†ï¼Œå¤§å®¶å¯ä»¥é€šè¿‡é€‰é¡¹&quot;-Xms&quot;å’Œ&quot;-Xmx&quot;æ¥è¿›è¡Œè®¾ç½®ï¼Œ-X æ˜¯jvmçš„è¿è¡Œå‚æ•°ï¼Œ-X æ˜¯jvmçš„è¿è¡Œå‚æ•°ã€‚</p><ul><li><code>-Xms</code>ç”¨äºè¡¨ç¤ºå †åŒºï¼ˆå¹´è½»ä»£+è€å¹´ä»£ï¼‰çš„èµ·å§‹å†…å­˜ï¼Œç­‰ä»·äº<code>-XX:InitialHeapSize</code></li><li><code>-Xmx</code>åˆ™ç”¨äºè¡¨ç¤ºå †åŒºçš„æœ€å¤§å†…å­˜ï¼Œç­‰ä»·äº<code>-XX:MaxHeapSize</code></li></ul></li><li><p>ä¸€æ—¦å †åŒºä¸­çš„å†…å­˜å¤§å°è¶…è¿‡â€œ-Xmx&quot;æ‰€æŒ‡å®šçš„æœ€å¤§å†…å­˜æ—¶ï¼Œå°†ä¼šæŠ›å‡ºOutofMemoryErrorå¼‚å¸¸ã€‚</p></li><li><p>é€šå¸¸ä¼šå°†-Xmså’Œ-Xmxä¸¤ä¸ªå‚æ•°é…ç½®ç›¸åŒçš„å€¼</p></li></ol><ul><li>åŸå› ï¼šå‡è®¾ä¸¤ä¸ªä¸ä¸€æ ·ï¼Œåˆå§‹å†…å­˜å°ï¼Œæœ€å¤§å†…å­˜å¤§ã€‚åœ¨è¿è¡ŒæœŸé—´å¦‚æœå †å†…å­˜ä¸å¤Ÿç”¨äº†ï¼Œä¼šä¸€ç›´æ‰©å®¹ç›´åˆ°æœ€å¤§å†…å­˜ã€‚å¦‚æœå†…å­˜å¤Ÿç”¨ä¸”å¤šäº†ï¼Œä¹Ÿä¼šä¸æ–­çš„ç¼©å®¹é‡Šæ”¾ã€‚é¢‘ç¹çš„æ‰©å®¹å’Œé‡Šæ”¾é€ æˆä¸å¿…è¦çš„å‹åŠ›ï¼Œé¿å…åœ¨GCä¹‹åè°ƒæ•´å †å†…å­˜ç»™æœåŠ¡å™¨å¸¦æ¥å‹åŠ›ã€‚</li><li>å¦‚æœä¸¤ä¸ªè®¾ç½®ä¸€æ ·çš„å°±å°‘äº†é¢‘ç¹æ‰©å®¹å’Œç¼©å®¹çš„æ­¥éª¤ã€‚å†…å­˜ä¸å¤Ÿäº†å°±ç›´æ¥æŠ¥OOM</li></ul><ol start="4"><li><p>é»˜è®¤æƒ…å†µä¸‹:</p><ul><li>åˆå§‹å†…å­˜å¤§å°ï¼šç‰©ç†ç”µè„‘å†…å­˜å¤§å°/64</li><li>æœ€å¤§å†…å­˜å¤§å°ï¼šç‰©ç†ç”µè„‘å†…å­˜å¤§å°/4</li></ul></li></ol><hr><h3 id="å¹´è½»ä»£ä¸è€å¹´ä»£">å¹´è½»ä»£ä¸è€å¹´ä»£</h3><p>å­˜å‚¨åœ¨ JVM ä¸­çš„ Java å¯¹è±¡å¯ä»¥è¢«åˆ’åˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li>ä¸€ç±»æ˜¯ç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­çš„ç¬æ—¶å¯¹è±¡ï¼Œè¿™ç±»å¯¹è±¡çš„åˆ›å»ºå’Œæ¶ˆäº¡éƒ½éå¸¸è¿…é€Ÿ</li><li>å¦å¤–ä¸€ç±»å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå´éå¸¸é•¿ï¼Œåœ¨æŸäº›æç«¯çš„æƒ…å†µä¸‹è¿˜èƒ½å¤Ÿä¸ JVM çš„ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´</li></ul><p>Java å †åŒºè¿›ä¸€æ­¥ç»†åˆ†çš„è¯ï¼Œå¯ä»¥åˆ’åˆ†ä¸ºå¹´è½»ä»£ï¼ˆYoungGenï¼‰å’Œè€å¹´ä»£ï¼ˆoldGenï¼‰</p><p>å…¶ä¸­å¹´è½»ä»£åˆå¯ä»¥åˆ’åˆ†ä¸º Eden ç©ºé—´ã€Survivor0 ç©ºé—´å’Œ Survivor1 ç©ºé—´ï¼ˆæœ‰æ—¶ä¹Ÿå«åš from åŒºã€to åŒºï¼‰</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/f3ee86daaf5076fe22265ffcaa831175.png" alt="image-20200707075847954"></p><p>æ–°ç”Ÿä»£ä¸è€å¹´ä»£åœ¨å †ç»“æ„çš„å æ¯”ã€‚</p><ul><li>é»˜è®¤<code>-XX:NewRatio=2</code>ï¼Œè¡¨ç¤ºæ–°ç”Ÿä»£å  1ï¼Œè€å¹´ä»£å  2ï¼Œæ–°ç”Ÿä»£å æ•´ä¸ªå †çš„ 1/3</li><li>å¯ä»¥ä¿®æ”¹<code>-XX:NewRatio=4</code>ï¼Œè¡¨ç¤ºæ–°ç”Ÿä»£å  1ï¼Œè€å¹´ä»£å  4ï¼Œæ–°ç”Ÿä»£å æ•´ä¸ªå †çš„ 1/5</li></ul><p>åœ¨ HotSpot ä¸­ï¼ŒEden ç©ºé—´å’Œå¦å¤–ä¸¤ä¸ª survivor ç©ºé—´ç¼ºçœæ‰€å çš„æ¯”ä¾‹æ˜¯ 8ï¼š1ï¼š1</p><p>å½“ç„¶å¼€å‘äººå‘˜å¯ä»¥é€šè¿‡é€‰é¡¹<code>-xx:SurvivorRatio</code>è°ƒæ•´è¿™ä¸ªç©ºé—´æ¯”ä¾‹ã€‚æ¯”å¦‚<code>-xx:SurvivorRatio=8</code></p><p>å‡ ä¹æ‰€æœ‰çš„ Java å¯¹è±¡éƒ½æ˜¯åœ¨ Eden åŒºè¢« new å‡ºæ¥çš„ã€‚ç»å¤§éƒ¨åˆ†çš„ Java å¯¹è±¡çš„é”€æ¯éƒ½åœ¨æ–°ç”Ÿä»£è¿›è¡Œäº†ã€‚</p><ul><li>IBM å…¬å¸çš„ä¸“é—¨ç ”ç©¶è¡¨æ˜ï¼Œæ–°ç”Ÿä»£ä¸­ 80%çš„å¯¹è±¡éƒ½æ˜¯â€œæœç”Ÿå¤•æ­»â€çš„ã€‚</li></ul><p>å¯ä»¥ä½¿ç”¨é€‰é¡¹<code>-Xmn</code>è®¾ç½®æ–°ç”Ÿä»£æœ€å¤§å†…å­˜å¤§å°ï¼Œè¿™ä¸ªå‚æ•°ä¸€èˆ¬ä½¿ç”¨é»˜è®¤å€¼å°±å¯ä»¥äº†ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/31fd90d99565ec8ce0682a4468076f94.png" alt="image-20210510105849497"></p><hr><h3 id="å¯¹è±¡åˆ†é…è¿‡ç¨‹">å¯¹è±¡åˆ†é…è¿‡ç¨‹</h3><p>â€‹ä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜æ˜¯ä¸€ä»¶éå¸¸ä¸¥è°¨å’Œå¤æ‚çš„ä»»åŠ¡ï¼ŒJVM çš„è®¾è®¡è€…ä»¬ä¸ä»…éœ€è¦è€ƒè™‘å†…å­˜å¦‚ä½•åˆ†é…ã€åœ¨å“ªé‡Œåˆ†é…ç­‰é—®é¢˜ï¼Œå¹¶ä¸”ç”±äºå†…å­˜åˆ†é…ç®—æ³•ä¸å†…å­˜å›æ”¶ç®—æ³•å¯†åˆ‡ç›¸å…³ï¼Œæ‰€ä»¥è¿˜éœ€è¦è€ƒè™‘ GC æ‰§è¡Œå®Œå†…å­˜å›æ”¶åæ˜¯å¦ä¼šåœ¨å†…å­˜ç©ºé—´ä¸­äº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚</p><ol><li><p>new çš„å¯¹è±¡å…ˆæ”¾ä¼Šç”¸å›­åŒºã€‚æ­¤åŒºæœ‰å¤§å°é™åˆ¶ã€‚</p></li><li><p>å½“ä¼Šç”¸å›­çš„ç©ºé—´å¡«æ»¡æ—¶ï¼Œç¨‹åºåˆéœ€è¦åˆ›å»ºå¯¹è±¡ï¼ŒJVM çš„åƒåœ¾å›æ”¶å™¨å°†å¯¹ä¼Šç”¸å›­åŒºè¿›è¡Œåƒåœ¾å›æ”¶ï¼ˆMinorGCï¼‰ï¼Œå°†ä¼Šç”¸å›­åŒºä¸­çš„ä¸å†è¢«å…¶ä»–å¯¹è±¡æ‰€å¼•ç”¨çš„å¯¹è±¡è¿›è¡Œé”€æ¯ã€‚å†åŠ è½½æ–°çš„å¯¹è±¡æ”¾åˆ°ä¼Šç”¸å›­åŒº</p></li><li><p>ç„¶åå°†ä¼Šç”¸å›­ä¸­çš„å‰©ä½™å¯¹è±¡ç§»åŠ¨åˆ°å¹¸å­˜è€… 0 åŒºã€‚</p></li><li><p>å¦‚æœå†æ¬¡è§¦å‘åƒåœ¾å›æ”¶ï¼Œæ­¤æ—¶ä¸Šæ¬¡å¹¸å­˜ä¸‹æ¥çš„æ”¾åˆ°å¹¸å­˜è€… 0 åŒºçš„ï¼Œå¦‚æœæ²¡æœ‰å›æ”¶ï¼Œå°±ä¼šæ”¾åˆ°å¹¸å­˜è€… 1 åŒºã€‚</p></li><li><p>å¦‚æœå†æ¬¡ç»å†åƒåœ¾å›æ”¶ï¼Œæ­¤æ—¶ä¼šé‡æ–°æ”¾å›å¹¸å­˜è€… 0 åŒºï¼Œæ¥ç€å†å»å¹¸å­˜è€… 1 åŒºã€‚</p></li><li><p>å•¥æ—¶å€™èƒ½å»å…»è€åŒºå‘¢ï¼Ÿå¯ä»¥è®¾ç½®æ¬¡æ•°ã€‚é»˜è®¤æ˜¯ 15 æ¬¡ã€‚</p><ul><li>å¯ä»¥è®¾ç½®å‚æ•°ï¼š<code>-Xx:MaxTenuringThreshold= N</code>è¿›è¡Œè®¾ç½®</li></ul></li><li><p>åœ¨å…»è€åŒºï¼Œç›¸å¯¹æ‚ é—²ã€‚å½“å…»è€åŒºå†…å­˜ä¸è¶³æ—¶ï¼Œå†æ¬¡è§¦å‘ GCï¼šMajor GCï¼Œè¿›è¡Œå…»è€åŒºçš„å†…å­˜æ¸…ç†</p></li><li><p>è‹¥å…»è€åŒºæ‰§è¡Œäº† Major GC ä¹‹åï¼Œå‘ç°ä¾ç„¶æ— æ³•è¿›è¡Œå¯¹è±¡çš„ä¿å­˜ï¼Œå°±ä¼šäº§ç”Ÿ OOM å¼‚å¸¸ã€‚</p></li></ol><mark class="hl-label blue">å¯¹è±¡åˆ†é…çš„ç‰¹æ®Šæƒ…å†µ</mark> <ol><li>å¦‚æœæ¥äº†ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œå…ˆçœ‹çœ‹ Eden æ˜¯å¦æ”¾çš„ä¸‹ï¼Ÿ<ul><li>å¦‚æœ Eden æ”¾å¾—ä¸‹ï¼Œåˆ™ç›´æ¥æ”¾åˆ° Eden åŒº</li><li>å¦‚æœ Eden æ”¾ä¸ä¸‹ï¼Œåˆ™è§¦å‘ YGC ï¼Œæ‰§è¡Œåƒåœ¾å›æ”¶ï¼Œçœ‹çœ‹è¿˜èƒ½ä¸èƒ½æ”¾ä¸‹ï¼Ÿ</li></ul></li><li>å°†å¯¹è±¡æ”¾åˆ°è€å¹´åŒºåˆæœ‰ä¸¤ç§æƒ…å†µï¼š<ul><li>å¦‚æœ Eden æ‰§è¡Œäº† YGC è¿˜æ˜¯æ— æ³•æ”¾ä¸ä¸‹è¯¥å¯¹è±¡ï¼Œé‚£æ²¡å¾—åŠæ³•ï¼Œåªèƒ½è¯´æ˜æ˜¯è¶…å¤§å¯¹è±¡ï¼Œåªèƒ½ç›´æ¥æ”¾åˆ°è€å¹´ä»£</li><li>é‚£ä¸‡ä¸€è€å¹´ä»£éƒ½æ”¾ä¸ä¸‹ï¼Œåˆ™å…ˆè§¦å‘FullGC ï¼Œå†çœ‹çœ‹èƒ½ä¸èƒ½æ”¾ä¸‹ï¼Œæ”¾å¾—ä¸‹æœ€å¥½ï¼Œä½†å¦‚æœè¿˜æ˜¯æ”¾ä¸ä¸‹ï¼Œé‚£åªèƒ½æŠ¥ OOM</li></ul></li><li>å¦‚æœ Eden åŒºæ»¡äº†ï¼Œå°†å¯¹è±¡å¾€å¹¸å­˜åŒºæ‹·è´æ—¶ï¼Œå‘ç°å¹¸å­˜åŒºæ”¾ä¸ä¸‹å•¦ï¼Œé‚£åªèƒ½ä¾¿å®œäº†æŸäº›æ–°å¯¹è±¡ï¼Œè®©ä»–ä»¬ç›´æ¥æ™‹å‡è‡³è€å¹´åŒº</li></ol><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/23b91eb543fc0072cb628365267f0089.png" alt="image-20200707091058346"></p><h3 id="GCåˆ†ç±»">GCåˆ†ç±»</h3><ol><li><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒJVMçš„è°ƒä¼˜çš„ä¸€ä¸ªç¯èŠ‚ï¼Œä¹Ÿå°±æ˜¯åƒåœ¾æ”¶é›†ï¼Œæˆ‘ä»¬éœ€è¦å°½é‡çš„é¿å…åƒåœ¾å›æ”¶ï¼Œå› ä¸ºåœ¨åƒåœ¾å›æ”¶çš„è¿‡ç¨‹ä¸­ï¼Œå®¹æ˜“å‡ºç°STWï¼ˆStop the Worldï¼‰çš„é—®é¢˜ï¼Œ<strong>è€Œ Major GC å’Œ Full GCå‡ºç°STWçš„æ—¶é—´ï¼Œæ˜¯Minor GCçš„10å€ä»¥ä¸Š</strong></p></li><li><p>JVMåœ¨è¿›è¡ŒGCæ—¶ï¼Œå¹¶éæ¯æ¬¡éƒ½å¯¹ä¸Šé¢ä¸‰ä¸ªå†…å­˜åŒºåŸŸä¸€èµ·å›æ”¶çš„ï¼Œå¤§éƒ¨åˆ†æ—¶å€™å›æ”¶çš„éƒ½æ˜¯æŒ‡æ–°ç”Ÿä»£ã€‚é’ˆå¯¹Hotspot VMçš„å®ç°ï¼Œå®ƒé‡Œé¢çš„GCæŒ‰ç…§å›æ”¶åŒºåŸŸåˆåˆ†ä¸ºä¸¤å¤§ç§ç±»å‹ï¼šä¸€ç§æ˜¯éƒ¨åˆ†æ”¶é›†ï¼ˆPartial GCï¼‰ï¼Œä¸€ç§æ˜¯æ•´å †æ”¶é›†ï¼ˆFullGCï¼‰</p></li></ol><ul><li><p>éƒ¨åˆ†æ”¶é›†ï¼šä¸æ˜¯å®Œæ•´æ”¶é›†æ•´ä¸ªJavaå †çš„åƒåœ¾æ”¶é›†ã€‚å…¶ä¸­åˆåˆ†ä¸ºï¼š</p><ul><li><strong>æ–°ç”Ÿä»£æ”¶é›†</strong>ï¼ˆMinor GC/Young GCï¼‰ï¼šåªæ˜¯æ–°ç”Ÿä»£ï¼ˆEdenï¼Œs0ï¼Œs1ï¼‰çš„åƒåœ¾æ”¶é›†</li><li><strong>è€å¹´ä»£æ”¶é›†</strong>ï¼ˆMajor GC/Old GCï¼‰ï¼šåªæ˜¯è€å¹´ä»£çš„åƒåœ¾æ”¶é›†ã€‚</li><li>ç›®å‰ï¼Œåªæœ‰CMS GCä¼šæœ‰å•ç‹¬æ”¶é›†è€å¹´ä»£çš„è¡Œä¸ºã€‚</li><li>æ³¨æ„ï¼Œå¾ˆå¤šæ—¶å€™Major GCä¼šå’ŒFull GCæ··æ·†ä½¿ç”¨ï¼Œéœ€è¦å…·ä½“åˆ†è¾¨æ˜¯è€å¹´ä»£å›æ”¶è¿˜æ˜¯æ•´å †å›æ”¶ã€‚</li><li>æ··åˆæ”¶é›†ï¼ˆMixed GCï¼‰ï¼šæ”¶é›†æ•´ä¸ªæ–°ç”Ÿä»£ä»¥åŠéƒ¨åˆ†è€å¹´ä»£çš„åƒåœ¾æ”¶é›†ã€‚ç›®å‰ï¼Œåªæœ‰G1 GCä¼šæœ‰è¿™ç§è¡Œä¸º</li></ul></li><li><p><strong>æ•´å †æ”¶é›†</strong>ï¼ˆFull GCï¼‰ï¼šæ”¶é›†æ•´ä¸ªjavaå †å’Œæ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†ã€‚</p></li></ul><p>ç”±äºå†å²åŸå› ï¼Œå¤–ç•Œå„ç§è§£è¯»ï¼ŒmajorGCå’ŒFull GCæœ‰äº›æ··æ·†ã€‚</p><hr><hr><h2 id="æ–¹æ³•åŒº">æ–¹æ³•åŒº</h2><h3 id="æ ˆã€å †ã€æ–¹æ³•åŒºçš„äº¤äº’å…³ç³»">æ ˆã€å †ã€æ–¹æ³•åŒºçš„äº¤äº’å…³ç³»</h3><ol><li>Person ç±»çš„ .class ä¿¡æ¯å­˜æ”¾åœ¨æ–¹æ³•åŒºä¸­</li><li>person å˜é‡å­˜æ”¾åœ¨ Java æ ˆçš„å±€éƒ¨å˜é‡è¡¨ä¸­</li><li>çœŸæ­£çš„ person å¯¹è±¡å­˜æ”¾åœ¨ Java å †ä¸­</li><li>åœ¨ person å¯¹è±¡ä¸­ï¼Œæœ‰ä¸ªæŒ‡é’ˆæŒ‡å‘æ–¹æ³•åŒºä¸­çš„ person ç±»å‹æ•°æ®ï¼Œè¡¨æ˜è¿™ä¸ª person å¯¹è±¡æ˜¯ç”¨æ–¹æ³•åŒºä¸­çš„ Person ç±» new å‡ºæ¥çš„</li></ol><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/b9f11764ee47b28d37f7764dfd9c9f55.png" alt="image-20200708094747667"></p><hr><h3 id="æ–¹æ³•åŒºåŸºæœ¬æ¦‚è¿°">æ–¹æ³•åŒºåŸºæœ¬æ¦‚è¿°</h3><blockquote><p>æ–¹æ³•åŒºåœ¨å“ªé‡Œ</p></blockquote><ol><li>ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­æ˜ç¡®è¯´æ˜ï¼šå°½ç®¡æ‰€æœ‰çš„æ–¹æ³•åŒºåœ¨é€»è¾‘ä¸Šæ˜¯å±äºå †çš„ä¸€éƒ¨åˆ†ï¼Œä½†ä¸€äº›ç®€å•çš„å®ç°å¯èƒ½ä¸ä¼šé€‰æ‹©å»è¿›è¡Œåƒåœ¾æ”¶é›†æˆ–è€…è¿›è¡Œå‹ç¼©ã€‚ä½†å¯¹äºHotSpotJVMè€Œè¨€ï¼Œæ–¹æ³•åŒºè¿˜æœ‰ä¸€ä¸ªåˆ«åå«åšNon-Heapï¼ˆéå †ï¼‰ï¼Œç›®çš„å°±æ˜¯è¦å’Œå †åˆ†å¼€ã€‚</li><li>æ‰€ä»¥ï¼Œ<span class='p red'>æ–¹æ³•åŒºå¯ä»¥çœ‹ä½œæ˜¯ä¸€å—ç‹¬ç«‹äºJavaå †çš„å†…å­˜ç©ºé—´</span></li></ol><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/6a7f2350e0f4e0cde0ac246225e2acdd.png" alt="image-20200708095853544"></p><blockquote><p>æ–¹æ³•åŒºåŸºæœ¬ç†è§£</p></blockquote><span class='p green'>æ–¹æ³•åŒºä¸»è¦å­˜æ”¾çš„æ˜¯ Classï¼Œè€Œå †ä¸­ä¸»è¦å­˜æ”¾çš„æ˜¯å®ä¾‹åŒ–çš„å¯¹è±¡</span><ol><li>æ–¹æ³•åŒºï¼ˆMethod Areaï¼‰ä¸Javaå †ä¸€æ ·ï¼Œæ˜¯å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸã€‚å¤šä¸ªçº¿ç¨‹åŒæ—¶åŠ è½½ç»Ÿä¸€ä¸ªç±»æ—¶ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½åŠ è½½è¯¥ç±»ï¼Œå…¶ä»–çº¿ç¨‹åªèƒ½ç­‰ç­‰å¾…è¯¥çº¿ç¨‹åŠ è½½å®Œæ¯•ï¼Œç„¶åç›´æ¥ä½¿ç”¨è¯¥ç±»ï¼Œå³ç±»åªèƒ½åŠ è½½ä¸€æ¬¡ã€‚</li><li>æ–¹æ³•åŒºåœ¨JVMå¯åŠ¨çš„æ—¶å€™è¢«åˆ›å»ºï¼Œå¹¶ä¸”å®ƒçš„å®é™…çš„ç‰©ç†å†…å­˜ç©ºé—´ä¸­å’ŒJavaå †åŒºä¸€æ ·éƒ½å¯ä»¥æ˜¯ä¸è¿ç»­çš„ã€‚</li><li>æ–¹æ³•åŒºçš„å¤§å°ï¼Œè·Ÿå †ç©ºé—´ä¸€æ ·ï¼Œå¯ä»¥é€‰æ‹©å›ºå®šå¤§å°æˆ–è€…å¯æ‰©å±•ã€‚</li><li>æ–¹æ³•åŒºçš„å¤§å°å†³å®šäº†ç³»ç»Ÿå¯ä»¥ä¿å­˜å¤šå°‘ä¸ªç±»ï¼Œå¦‚æœç³»ç»Ÿå®šä¹‰äº†å¤ªå¤šçš„ç±»ï¼Œå¯¼è‡´æ–¹æ³•åŒºæº¢å‡ºï¼Œè™šæ‹ŸæœºåŒæ ·ä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºé”™è¯¯ï¼š<code>java.lang.OutofMemoryError:PermGen space</code>æˆ–è€…<code>java.lang.OutOfMemoryError:Metaspace</code><ul><li>åŠ è½½å¤§é‡çš„ç¬¬ä¸‰æ–¹çš„jaråŒ…</li><li>Tomcatéƒ¨ç½²çš„å·¥ç¨‹è¿‡å¤šï¼ˆ30~50ä¸ªï¼‰</li><li>å¤§é‡åŠ¨æ€çš„ç”Ÿæˆåå°„ç±»</li></ul></li><li>å…³é—­JVMå°±ä¼šé‡Šæ”¾è¿™ä¸ªåŒºåŸŸçš„å†…å­˜ã€‚</li></ol><hr><h3 id="è®¾ç½®æ–¹æ³•åŒºå¤§å°ä¸OOM">è®¾ç½®æ–¹æ³•åŒºå¤§å°ä¸OOM</h3><p>æ–¹æ³•åŒºçš„å¤§å°ä¸å¿…æ˜¯å›ºå®šçš„ï¼ŒJVMå¯ä»¥æ ¹æ®åº”ç”¨çš„éœ€è¦åŠ¨æ€è°ƒæ•´ã€‚</p><div class="tabs" id="19ef8671-1621-4661-a983-cba765878dba"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#19ef8671-1621-4661-a983-cba765878dba-1"><i class="fas fa-seedling"></i>jdk7åŠä»¥å‰</button></li><li class="tab"><button type="button" data-href="#19ef8671-1621-4661-a983-cba765878dba-2"><i class="fas fa-leaf"></i>JDK8ä»¥å</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="19ef8671-1621-4661-a983-cba765878dba-1"><ul><li>é€šè¿‡<code>-XX:Permsize</code>æ¥è®¾ç½®æ°¸ä¹…ä»£åˆå§‹åˆ†é…ç©ºé—´ã€‚é»˜è®¤å€¼æ˜¯ 20.75M</li><li>é€šè¿‡<code>-XX:MaxPermsize</code>æ¥è®¾å®šæ°¸ä¹…ä»£æœ€å¤§å¯åˆ†é…ç©ºé—´ã€‚32 ä½æœºå™¨é»˜è®¤æ˜¯ 64Mï¼Œ64 ä½æœºå™¨æ¨¡å¼æ˜¯ 82M</li><li>å½“ JVM åŠ è½½çš„ç±»ä¿¡æ¯å®¹é‡è¶…è¿‡äº†è¿™ä¸ªå€¼ï¼Œä¼šæŠ¥å¼‚å¸¸<code>OutOfMemoryError:PermGen space</code>ã€‚</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="19ef8671-1621-4661-a983-cba765878dba-2"><ul><li>å…ƒæ•°æ®åŒºå¤§å°å¯ä»¥ä½¿ç”¨å‚æ•° <code>-XX:MetaspaceSize</code> å’Œ <code>-XX:MaxMetaspaceSize</code>æŒ‡å®š</li><li>é»˜è®¤å€¼ä¾èµ–äºå¹³å°ã€‚windows ä¸‹ï¼Œ<code>-XX:MetaspaceSize=21M -XX:MaxMetaspaceSize=-1//å³æ²¡æœ‰é™åˆ¶</code>ã€‚</li><li>ä¸æ°¸ä¹…ä»£ä¸åŒï¼Œå¦‚æœä¸æŒ‡å®šå¤§å°ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè™šæ‹Ÿæœºä¼šè€—å°½æ‰€æœ‰çš„å¯ç”¨ç³»ç»Ÿå†…å­˜ã€‚å¦‚æœå…ƒæ•°æ®åŒºå‘ç”Ÿæº¢å‡ºï¼Œè™šæ‹Ÿæœºä¸€æ ·ä¼šæŠ›å‡ºå¼‚å¸¸<code>OutOfMemoryError:Metaspace</code></li><li><code>-XX:MetaspaceSize</code>ï¼šè®¾ç½®åˆå§‹çš„å…ƒç©ºé—´å¤§å°ã€‚å¯¹äºä¸€ä¸ª 64 ä½çš„æœåŠ¡å™¨ç«¯ JVM æ¥è¯´ï¼Œå…¶é»˜è®¤çš„<code>-XX:MetaspaceSize</code>å€¼ä¸º 21MBã€‚è¿™å°±æ˜¯åˆå§‹çš„é«˜æ°´ä½çº¿ï¼Œä¸€æ—¦è§¦åŠè¿™ä¸ªæ°´ä½çº¿ï¼ŒFull GC å°†ä¼šè¢«è§¦å‘å¹¶å¸è½½æ²¡ç”¨çš„ç±»ï¼ˆå³è¿™äº›ç±»å¯¹åº”çš„ç±»åŠ è½½å™¨ä¸å†å­˜æ´»ï¼‰ï¼Œç„¶åè¿™ä¸ªé«˜æ°´ä½çº¿å°†ä¼šé‡ç½®ã€‚æ–°çš„é«˜æ°´ä½çº¿çš„å€¼å–å†³äº GC åé‡Šæ”¾äº†å¤šå°‘å…ƒç©ºé—´ã€‚å¦‚æœé‡Šæ”¾çš„ç©ºé—´ä¸è¶³ï¼Œé‚£ä¹ˆåœ¨ä¸è¶…è¿‡<code>MaxMetaspaceSize</code>æ—¶ï¼Œé€‚å½“æé«˜è¯¥å€¼ã€‚å¦‚æœé‡Šæ”¾ç©ºé—´è¿‡å¤šï¼Œåˆ™é€‚å½“é™ä½è¯¥å€¼ã€‚</li><li>å¦‚æœåˆå§‹åŒ–çš„é«˜æ°´ä½çº¿è®¾ç½®è¿‡ä½ï¼Œä¸Šè¿°é«˜æ°´ä½çº¿è°ƒæ•´æƒ…å†µä¼šå‘ç”Ÿå¾ˆå¤šæ¬¡ã€‚é€šè¿‡åƒåœ¾å›æ”¶å™¨çš„æ—¥å¿—å¯ä»¥è§‚å¯Ÿåˆ° Full GC å¤šæ¬¡è°ƒç”¨ã€‚ä¸ºäº†é¿å…é¢‘ç¹åœ° GCï¼Œå»ºè®®å°†<code>-XX:MetaspaceSize</code>è®¾ç½®ä¸ºä¸€ä¸ªç›¸å¯¹è¾ƒé«˜çš„å€¼ã€‚</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="æ–¹æ³•åŒºå†…éƒ¨ç»“æ„">æ–¹æ³•åŒºå†…éƒ¨ç»“æ„</h3><p>ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹ä¹¦ä¸­å¯¹æ–¹æ³•åŒºï¼ˆMethod Areaï¼‰å­˜å‚¨å†…å®¹æè¿°å¦‚ä¸‹ï¼šå®ƒç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»å‹ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç¼“å­˜ç­‰ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/fbe3915506e7979c7d591d17c216fbb1.png" alt="image-20200708161856504"></p><div class="tabs" id="2bff9740-807b-47eb-bb97-ef0e276019eb"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2bff9740-807b-47eb-bb97-ef0e276019eb-1"><i class="fas fa-award"></i>ç±»å‹ä¿¡æ¯</button></li><li class="tab"><button type="button" data-href="#2bff9740-807b-47eb-bb97-ef0e276019eb-2"><i class="fas fa-baseball-ball"></i>åŸŸï¼ˆFieldï¼‰ä¿¡æ¯</button></li><li class="tab"><button type="button" data-href="#2bff9740-807b-47eb-bb97-ef0e276019eb-3"><i class="fas fa-bone"></i>æ–¹æ³•ï¼ˆMethodï¼‰ä¿¡æ¯</button></li><li class="tab"><button type="button" data-href="#2bff9740-807b-47eb-bb97-ef0e276019eb-4"><i class="fas fa-anchor"></i>non-finalçš„ç±»å˜é‡</button></li><li class="tab"><button type="button" data-href="#2bff9740-807b-47eb-bb97-ef0e276019eb-5"><i class="fas fa-heartbeat"></i>è¿è¡Œæ—¶å¸¸é‡æ± </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2bff9740-807b-47eb-bb97-ef0e276019eb-1"><p>å¯¹æ¯ä¸ªåŠ è½½çš„ç±»å‹ï¼ˆç±»classã€æ¥å£interfaceã€æšä¸¾enumã€æ³¨è§£annotationï¼‰ï¼ŒJVMå¿…é¡»åœ¨æ–¹æ³•åŒºä¸­å­˜å‚¨ä»¥ä¸‹ç±»å‹ä¿¡æ¯ï¼š</p><ol><li>è¿™ä¸ªç±»å‹çš„å®Œæ•´æœ‰æ•ˆåç§°ï¼ˆå…¨å=åŒ…å.ç±»åï¼‰</li><li>è¿™ä¸ªç±»å‹ç›´æ¥çˆ¶ç±»çš„å®Œæ•´æœ‰æ•ˆåï¼ˆå¯¹äºinterfaceæˆ–æ˜¯java.lang.Objectï¼Œéƒ½æ²¡æœ‰çˆ¶ç±»ï¼‰</li><li>è¿™ä¸ªç±»å‹çš„ä¿®é¥°ç¬¦ï¼ˆpublicï¼Œabstractï¼Œfinalçš„æŸä¸ªå­é›†ï¼‰</li><li>è¿™ä¸ªç±»å‹ç›´æ¥æ¥å£çš„ä¸€ä¸ªæœ‰åºåˆ—è¡¨</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2bff9740-807b-47eb-bb97-ef0e276019eb-2"><p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„æˆå‘˜å˜é‡ï¼ŒåŸŸä¿¡æ¯æ˜¯æ¯”è¾ƒå®˜æ–¹çš„ç§°å‘¼</p><ol><li><p>JVMå¿…é¡»åœ¨æ–¹æ³•åŒºä¸­ä¿å­˜ç±»å‹çš„æ‰€æœ‰åŸŸçš„ç›¸å…³ä¿¡æ¯ä»¥åŠåŸŸçš„å£°æ˜é¡ºåºã€‚</p></li><li><p>åŸŸçš„ç›¸å…³ä¿¡æ¯åŒ…æ‹¬ï¼šåŸŸåç§°ï¼ŒåŸŸç±»å‹ï¼ŒåŸŸä¿®é¥°ç¬¦ï¼ˆpublicï¼Œprivateï¼Œprotectedï¼Œstaticï¼Œfinalï¼Œvolatileï¼Œtransientçš„æŸä¸ªå­é›†ï¼‰</p></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2bff9740-807b-47eb-bb97-ef0e276019eb-3"><p>JVMå¿…é¡»ä¿å­˜æ‰€æœ‰æ–¹æ³•çš„ä»¥ä¸‹ä¿¡æ¯ï¼ŒåŒåŸŸä¿¡æ¯ä¸€æ ·åŒ…æ‹¬å£°æ˜é¡ºåºï¼š</p><ol><li>æ–¹æ³•åç§°</li><li>æ–¹æ³•çš„è¿”å›ç±»å‹ï¼ˆåŒ…æ‹¬ void è¿”å›ç±»å‹ï¼‰ï¼Œvoid åœ¨ Java ä¸­å¯¹åº”çš„ä¸º void.class</li><li>æ–¹æ³•å‚æ•°çš„æ•°é‡å’Œç±»å‹ï¼ˆæŒ‰é¡ºåºï¼‰</li><li>æ–¹æ³•çš„ä¿®é¥°ç¬¦ï¼ˆpublicï¼Œprivateï¼Œprotectedï¼Œstaticï¼Œfinalï¼Œsynchronizedï¼Œnativeï¼Œabstractçš„ä¸€ä¸ªå­é›†ï¼‰</li><li>æ–¹æ³•çš„å­—èŠ‚ç ï¼ˆbytecodesï¼‰ã€æ“ä½œæ•°æ ˆã€å±€éƒ¨å˜é‡è¡¨åŠå¤§å°ï¼ˆabstractå’Œnativeæ–¹æ³•é™¤å¤–ï¼‰</li><li>å¼‚å¸¸è¡¨ï¼ˆabstractå’Œnativeæ–¹æ³•é™¤å¤–ï¼‰ï¼Œå¼‚å¸¸è¡¨è®°å½•æ¯ä¸ªå¼‚å¸¸å¤„ç†çš„å¼€å§‹ä½ç½®ã€ç»“æŸä½ç½®ã€ä»£ç å¤„ç†åœ¨ç¨‹åºè®¡æ•°å™¨ä¸­çš„åç§»åœ°å€ã€è¢«æ•è·çš„å¼‚å¸¸ç±»çš„å¸¸é‡æ± ç´¢å¼•</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2bff9740-807b-47eb-bb97-ef0e276019eb-4"><ul><li>é™æ€å˜é‡å’Œç±»å…³è”åœ¨ä¸€èµ·ï¼Œéšç€ç±»çš„åŠ è½½è€ŒåŠ è½½ï¼Œä»–ä»¬æˆä¸ºç±»æ•°æ®åœ¨é€»è¾‘ä¸Šçš„ä¸€éƒ¨åˆ†</li><li>ç±»å˜é‡è¢«ç±»çš„æ‰€æœ‰å®ä¾‹å…±äº«ï¼Œå³ä½¿æ²¡æœ‰ç±»å®ä¾‹æ—¶ï¼Œä½ ä¹Ÿå¯ä»¥è®¿é—®å®ƒ</li></ul><p>è¡¥å……è¯´æ˜ï¼šå…¨å±€å¸¸é‡ï¼ˆstatic finalï¼‰</p><p>è¢«å£°æ˜ä¸º final çš„ç±»å˜é‡çš„å¤„ç†æ–¹æ³•åˆ™ä¸åŒï¼Œæ¯ä¸ªå…¨å±€å¸¸é‡åœ¨ç¼–è¯‘çš„æ—¶å€™å°±ä¼šè¢«åˆ†é…äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Order</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> count;</span><br><span class="line">    descriptor: I</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> number;</span><br><span class="line">    descriptor: I</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC, ACC_FINAL</span><br><span class="line">    ConstantValue: <span class="type">int</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç° staitcå’ŒfinalåŒæ—¶ä¿®é¥°çš„number çš„å€¼åœ¨ç¼–è¯‘ä¸Šçš„æ—¶å€™å·²ç»å†™æ­»åœ¨å­—èŠ‚ç æ–‡ä»¶ä¸­äº†ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2bff9740-807b-47eb-bb97-ef0e276019eb-5"><ul><li>è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRuntime Constant Poolï¼‰æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚</li><li>å¸¸é‡æ± è¡¨ï¼ˆConstant Pool Tableï¼‰æ˜¯ Class æ–‡ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡ä¸ç¬¦å·å¼•ç”¨ï¼Œè¿™éƒ¨åˆ†å†…å®¹å°†åœ¨ç±»åŠ è½½åå­˜æ”¾åˆ°æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ã€‚</li><li>è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œåœ¨åŠ è½½ç±»å’Œæ¥å£åˆ°è™šæ‹Ÿæœºåï¼Œå°±ä¼šåˆ›å»ºå¯¹åº”çš„è¿è¡Œæ—¶å¸¸é‡æ± ã€‚</li><li>JVM ä¸ºæ¯ä¸ªå·²åŠ è½½çš„ç±»å‹ï¼ˆç±»æˆ–æ¥å£ï¼‰éƒ½ç»´æŠ¤ä¸€ä¸ªå¸¸é‡æ± ã€‚æ± ä¸­çš„æ•°æ®é¡¹åƒæ•°ç»„é¡¹ä¸€æ ·ï¼Œæ˜¯é€šè¿‡ç´¢å¼•è®¿é—®çš„ã€‚</li><li>è¿è¡Œæ—¶å¸¸é‡æ± ä¸­åŒ…å«å¤šç§ä¸åŒçš„å¸¸é‡ï¼ŒåŒ…æ‹¬ç¼–è¯‘æœŸå°±å·²ç»æ˜ç¡®çš„æ•°å€¼å­—é¢é‡ï¼Œä¹ŸåŒ…æ‹¬åˆ°è¿è¡ŒæœŸè§£æåæ‰èƒ½å¤Ÿè·å¾—çš„æ–¹æ³•æˆ–è€…å­—æ®µå¼•ç”¨ã€‚æ­¤æ—¶ä¸å†æ˜¯å¸¸é‡æ± ä¸­çš„ç¬¦å·åœ°å€äº†ï¼Œè¿™é‡Œæ¢ä¸ºçœŸå®åœ°å€ã€‚</li><li>è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œç›¸å¯¹äº Class æ–‡ä»¶å¸¸é‡æ± çš„å¦ä¸€é‡è¦ç‰¹å¾æ˜¯ï¼šå…·å¤‡åŠ¨æ€æ€§ã€‚</li><li>è¿è¡Œæ—¶å¸¸é‡æ± ç±»ä¼¼äºä¼ ç»Ÿç¼–ç¨‹è¯­è¨€ä¸­çš„ç¬¦å·è¡¨ï¼ˆsymboltableï¼‰ï¼Œä½†æ˜¯å®ƒæ‰€åŒ…å«çš„æ•°æ®å´æ¯”ç¬¦å·è¡¨è¦æ›´åŠ ä¸°å¯Œä¸€äº›ã€‚</li><li>å½“åˆ›å»ºç±»æˆ–æ¥å£çš„è¿è¡Œæ—¶å¸¸é‡æ± æ—¶ï¼Œå¦‚æœæ„é€ è¿è¡Œæ—¶å¸¸é‡æ± æ‰€éœ€çš„å†…å­˜ç©ºé—´è¶…è¿‡äº†æ–¹æ³•åŒºæ‰€èƒ½æä¾›çš„æœ€å¤§å€¼ï¼Œåˆ™ JVM ä¼šæŠ› OutOfMemoryError å¼‚å¸¸ã€‚</li></ul><p>è¿è¡Œæ—¶å¸¸é‡æ±  VS å¸¸é‡æ± </p><ol><li>æ–¹æ³•åŒºï¼Œå†…éƒ¨åŒ…å«äº†è¿è¡Œæ—¶å¸¸é‡æ± </li><li>å­—èŠ‚ç æ–‡ä»¶ï¼Œå†…éƒ¨åŒ…å«äº†å¸¸é‡æ± ã€‚ï¼ˆä¹‹å‰çš„å­—èŠ‚ç æ–‡ä»¶ä¸­å·²ç»çœ‹åˆ°äº†å¾ˆå¤šConstant poolçš„ä¸œè¥¿ï¼Œè¿™ä¸ªå°±æ˜¯å¸¸é‡æ± ï¼‰</li><li>è¦å¼„æ¸…æ¥šæ–¹æ³•åŒºï¼Œéœ€è¦ç†è§£æ¸…æ¥šClassFileï¼Œå› ä¸ºåŠ è½½ç±»çš„ä¿¡æ¯éƒ½åœ¨æ–¹æ³•åŒºã€‚</li><li>è¦å¼„æ¸…æ¥šæ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œéœ€è¦ç†è§£æ¸…æ¥šClassFileä¸­çš„å¸¸é‡æ± ã€‚</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="æ–¹æ³•åŒºæ¼”è¿›ç»†èŠ‚">æ–¹æ³•åŒºæ¼”è¿›ç»†èŠ‚</h3><ol><li>é¦–å…ˆæ˜ç¡®ï¼šåªæœ‰ Hotspot æ‰æœ‰æ°¸ä¹…ä»£ã€‚BEA JRockitã€IBMJ9 ç­‰æ¥è¯´ï¼Œæ˜¯ä¸å­˜åœ¨æ°¸ä¹…ä»£çš„æ¦‚å¿µçš„ã€‚åŸåˆ™ä¸Šå¦‚ä½•å®ç°æ–¹æ³•åŒºå±äºè™šæ‹Ÿæœºå®ç°ç»†èŠ‚ï¼Œä¸å—ã€ŠJava è™šæ‹Ÿæœºè§„èŒƒã€‹ç®¡æŸï¼Œå¹¶ä¸è¦æ±‚ç»Ÿä¸€</li><li>Hotspot ä¸­æ–¹æ³•åŒºçš„å˜åŒ–ï¼š</li></ol><table><thead><tr><th style="text-align:center">JDKç‰ˆæœ¬</th><th style="text-align:center">æ–¹æ³•åŒºå˜åŒ–</th></tr></thead><tbody><tr><td style="text-align:center">JDK1.6 åŠä¹‹å‰</td><td style="text-align:center">æœ‰æ°¸ä¹…ä»£ï¼ˆpermanetï¼‰ï¼Œé™æ€å˜é‡å­˜å‚¨åœ¨æ°¸ä¹…ä»£ä¸Š</td></tr><tr><td style="text-align:center">JDK1.7</td><td style="text-align:center">æœ‰æ°¸ä¹…ä»£ï¼Œä½†å·²ç»é€æ­¥ â€œå»æ°¸ä¹…ä»£â€ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œé™æ€å˜é‡ç§»é™¤ï¼Œä¿å­˜åœ¨å †ä¸­</td></tr><tr><td style="text-align:center">JDK1.8</td><td style="text-align:center">æ— æ°¸ä¹…ä»£ï¼Œç±»å‹ä¿¡æ¯ï¼Œå­—æ®µï¼Œæ–¹æ³•ï¼Œå¸¸é‡ä¿å­˜åœ¨æœ¬åœ°å†…å­˜çš„å…ƒç©ºé—´ï¼Œä½†å­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ä»ç„¶åœ¨å †ä¸­ã€‚</td></tr></tbody></table><p>å­—ç¬¦ä¸²å¸¸é‡æ± å­˜çš„æ˜¯å­—ç¬¦ä¸²æœ¬èº«ï¼Œè¿è¡Œæ—¶å¸¸é‡æ± å­˜çš„æ˜¯å­—ç¬¦ä¸²å¼•ç”¨ï¼ŒæŒ‡å‘å­—ç¬¦ä¸²å¸¸é‡æ± ã€‚</p><blockquote><p>å­—ç¬¦ä¸²å¸¸é‡æ±  StringTable ä¸ºä»€ä¹ˆè¦è°ƒæ•´ä½ç½®ï¼Ÿ</p></blockquote><ul><li><p>JDK7ä¸­å°†StringTableæ”¾åˆ°äº†å †ç©ºé—´ä¸­ã€‚å› ä¸ºæ°¸ä¹…ä»£çš„å›æ”¶æ•ˆç‡å¾ˆä½ï¼Œåœ¨Full GCçš„æ—¶å€™æ‰ä¼šæ‰§è¡Œæ°¸ä¹…ä»£çš„åƒåœ¾å›æ”¶ï¼Œè€ŒFull GCæ˜¯è€å¹´ä»£çš„ç©ºé—´ä¸è¶³ã€æ°¸ä¹…ä»£ä¸è¶³æ—¶æ‰ä¼šè§¦å‘ã€‚</p></li><li><p>è¿™å°±å¯¼è‡´StringTableå›æ”¶æ•ˆç‡ä¸é«˜ï¼Œè€Œæˆ‘ä»¬å¼€å‘ä¸­ä¼šæœ‰å¤§é‡çš„å­—ç¬¦ä¸²è¢«åˆ›å»ºï¼Œå›æ”¶æ•ˆç‡ä½ï¼Œå¯¼è‡´æ°¸ä¹…ä»£å†…å­˜ä¸è¶³ã€‚æ”¾åˆ°å †é‡Œï¼Œèƒ½åŠæ—¶å›æ”¶å†…å­˜ã€‚</p></li></ul><div class="tabs" id="2b96576e-c020-4117-a205-5c2dfca56393"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2b96576e-c020-4117-a205-5c2dfca56393-1"><i class="fas fa-seedling"></i>JDK6</button></li><li class="tab"><button type="button" data-href="#2b96576e-c020-4117-a205-5c2dfca56393-2"><i class="fas fa-leaf"></i>JDK7</button></li><li class="tab"><button type="button" data-href="#2b96576e-c020-4117-a205-5c2dfca56393-3"><i class="fab fa-apple"></i>JDK8</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2b96576e-c020-4117-a205-5c2dfca56393-1"><p><img src="https://img-blog.csdnimg.cn/img_convert/1a3aa55257c3150d78327542e5ca230e.png" alt="image-20200708211541300"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2b96576e-c020-4117-a205-5c2dfca56393-2"><p><img src="https://img-blog.csdnimg.cn/img_convert/e0f65fc4228d9b6573ae1b23d9a1558b.png" alt="image-20200708211609911"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2b96576e-c020-4117-a205-5c2dfca56393-3"><p><img src="https://img-blog.csdnimg.cn/img_convert/c3ed969b0d2bad704c22481208e5dd10.png" alt="image-20200708211637952"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶">æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶</h3><p>æœ‰äº›äººè®¤ä¸ºæ–¹æ³•åŒºï¼ˆå¦‚ Hotspot è™šæ‹Ÿæœºä¸­çš„å…ƒç©ºé—´æˆ–è€…æ°¸ä¹…ä»£ï¼‰æ˜¯æ²¡æœ‰åƒåœ¾æ”¶é›†è¡Œä¸ºçš„ï¼Œå…¶å®ä¸ç„¶ã€‚ã€ŠJava è™šæ‹Ÿæœºè§„èŒƒã€‹å¯¹æ–¹æ³•åŒºçš„çº¦æŸæ˜¯éå¸¸å®½æ¾çš„ï¼Œæåˆ°è¿‡å¯ä»¥ä¸è¦æ±‚è™šæ‹Ÿæœºåœ¨æ–¹æ³•åŒºä¸­å®ç°åƒåœ¾æ”¶é›†ã€‚äº‹å®ä¸Šä¹Ÿç¡®å®æœ‰æœªå®ç°æˆ–æœªèƒ½å®Œæ•´å®ç°æ–¹æ³•åŒºç±»å‹å¸è½½çš„æ”¶é›†å™¨å­˜åœ¨ï¼ˆå¦‚ JDK11 æ—¶æœŸçš„ zGC æ”¶é›†å™¨å°±ä¸æ”¯æŒç±»å¸è½½ï¼‰ã€‚</p><p>ä¸€èˆ¬æ¥è¯´è¿™ä¸ªåŒºåŸŸçš„å›æ”¶æ•ˆæœæ¯”è¾ƒéš¾ä»¤äººæ»¡æ„ï¼Œå°¤å…¶æ˜¯ç±»å‹çš„å¸è½½ï¼Œæ¡ä»¶ç›¸å½“è‹›åˆ»ã€‚ä½†æ˜¯è¿™éƒ¨åˆ†åŒºåŸŸçš„å›æ”¶æœ‰æ—¶åˆç¡®å®æ˜¯å¿…è¦çš„ã€‚ä»¥å‰ sun å…¬å¸çš„ Bug åˆ—è¡¨ä¸­ï¼Œæ›¾å‡ºç°è¿‡çš„è‹¥å¹²ä¸ªä¸¥é‡çš„ Bug å°±æ˜¯ç”±äºä½ç‰ˆæœ¬çš„ HotSpot è™šæ‹Ÿæœºå¯¹æ­¤åŒºåŸŸæœªå®Œå…¨å›æ”¶è€Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p><p>æ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†ä¸»è¦å›æ”¶ä¸¤éƒ¨åˆ†å†…å®¹ï¼šå¸¸é‡æ± ä¸­åºŸå¼ƒçš„å¸¸é‡å’Œä¸å†ä½¿ç”¨çš„ç±»å‹ã€‚</p><p>å…ˆæ¥è¯´è¯´æ–¹æ³•åŒºå†…å¸¸é‡æ± ä¹‹ä¸­ä¸»è¦å­˜æ”¾çš„ä¸¤å¤§ç±»å¸¸é‡ï¼šå­—é¢é‡å’Œç¬¦å·å¼•ç”¨ã€‚å­—é¢é‡æ¯”è¾ƒæ¥è¿‘ Java è¯­è¨€å±‚æ¬¡çš„å¸¸é‡æ¦‚å¿µï¼Œå¦‚æ–‡æœ¬å­—ç¬¦ä¸²ã€è¢«å£°æ˜ä¸º final çš„å¸¸é‡å€¼ç­‰ã€‚è€Œç¬¦å·å¼•ç”¨åˆ™å±äºç¼–è¯‘åŸç†æ–¹é¢çš„æ¦‚å¿µï¼ŒåŒ…æ‹¬ä¸‹é¢ä¸‰ç±»å¸¸é‡ï¼š</p><ul><li>ç±»å’Œæ¥å£çš„å…¨é™å®šå</li><li>å­—æ®µçš„åç§°å’Œæè¿°ç¬¦</li><li>æ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦</li></ul><p>HotSpot è™šæ‹Ÿæœºå¯¹å¸¸é‡æ± çš„å›æ”¶ç­–ç•¥æ˜¯å¾ˆæ˜ç¡®çš„ï¼Œåªè¦å¸¸é‡æ± ä¸­çš„å¸¸é‡æ²¡æœ‰è¢«ä»»ä½•åœ°æ–¹å¼•ç”¨ï¼Œå°±å¯ä»¥è¢«å›æ”¶ã€‚</p><p>å›æ”¶åºŸå¼ƒå¸¸é‡ä¸å›æ”¶ Java å †ä¸­çš„å¯¹è±¡éå¸¸ç±»ä¼¼ã€‚</p><p>åˆ¤å®šä¸€ä¸ªå¸¸é‡æ˜¯å¦â€œåºŸå¼ƒâ€è¿˜æ˜¯ç›¸å¯¹ç®€å•ï¼Œè€Œè¦åˆ¤å®šä¸€ä¸ªç±»å‹æ˜¯å¦å±äºâ€œä¸å†è¢«ä½¿ç”¨çš„ç±»â€çš„æ¡ä»¶å°±æ¯”è¾ƒè‹›åˆ»äº†ã€‚éœ€è¦åŒæ—¶æ»¡è¶³ä¸‹é¢ä¸‰ä¸ªæ¡ä»¶ï¼š</p><ul><li><p>è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯ Java å †ä¸­ä¸å­˜åœ¨è¯¥ç±»åŠå…¶ä»»ä½•æ´¾ç”Ÿå­ç±»çš„å®ä¾‹ã€‚</p></li><li><p>åŠ è½½è¯¥ç±»çš„ç±»åŠ è½½å™¨å·²ç»è¢«å›æ”¶ï¼Œè¿™ä¸ªæ¡ä»¶é™¤éæ˜¯ç»è¿‡ç²¾å¿ƒè®¾è®¡çš„å¯æ›¿æ¢ç±»åŠ è½½å™¨çš„åœºæ™¯ï¼Œå¦‚ OSGiã€JSP çš„é‡åŠ è½½ç­‰ï¼Œå¦åˆ™é€šå¸¸æ˜¯å¾ˆéš¾è¾¾æˆçš„ã€‚</p></li><li><p>è¯¥ç±»å¯¹åº”çš„ java.lang.Class å¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ã€‚</p></li></ul><p>Java è™šæ‹Ÿæœºè¢«å…è®¸å¯¹æ»¡è¶³ä¸Šè¿°ä¸‰ä¸ªæ¡ä»¶çš„æ— ç”¨ç±»è¿›è¡Œå›æ”¶ï¼Œè¿™é‡Œè¯´çš„ä»…ä»…æ˜¯â€œè¢«å…è®¸â€ï¼Œè€Œå¹¶ä¸æ˜¯å’Œå¯¹è±¡ä¸€æ ·ï¼Œæ²¡æœ‰å¼•ç”¨äº†å°±å¿…ç„¶ä¼šå›æ”¶ã€‚å…³äºæ˜¯å¦è¦å¯¹ç±»å‹è¿›è¡Œå›æ”¶ï¼ŒHotSpot è™šæ‹Ÿæœºæä¾›äº†<code>-Xnoclassgc</code>å‚æ•°è¿›è¡Œæ§åˆ¶ï¼Œè¿˜å¯ä»¥ä½¿ç”¨<code>-verbose:class</code> ä»¥åŠ <code>-XX:+TraceClassLoading</code>ã€<code>-XX:+TraceClassUnLoading</code>æŸ¥çœ‹ç±»åŠ è½½å’Œå¸è½½ä¿¡æ¯</p><p>åœ¨å¤§é‡ä½¿ç”¨åå°„ã€åŠ¨æ€ä»£ç†ã€CGLib ç­‰å­—èŠ‚ç æ¡†æ¶ï¼ŒåŠ¨æ€ç”Ÿæˆ JSP ä»¥åŠ OSGi è¿™ç±»é¢‘ç¹è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„åœºæ™¯ä¸­ï¼Œ<u>é€šå¸¸éƒ½éœ€è¦ Java è™šæ‹Ÿæœºå…·å¤‡ç±»å‹å¸è½½çš„èƒ½åŠ›ï¼Œä»¥ä¿è¯ä¸ä¼šå¯¹æ–¹æ³•åŒºé€ æˆè¿‡å¤§çš„å†…å­˜å‹åŠ›</u>ã€‚</p>]]></content>
    
    
    <summary type="html">ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆã€å †ã€æ–¹æ³•åŒº</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="JVM" scheme="https://wuwawawa.github.io/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>ç±»åŠ è½½å­ç³»ç»Ÿ</title>
    <link href="https://wuwawawa.github.io/posts/13cb3a0e.html"/>
    <id>https://wuwawawa.github.io/posts/13cb3a0e.html</id>
    <published>2023-07-04T01:50:25.000Z</published>
    <updated>2023-07-04T02:32:49.370Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å†…å­˜ç»“æ„æ¦‚è¿°å›¾">å†…å­˜ç»“æ„æ¦‚è¿°å›¾</h2><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/e4bc9ed374db7f35e68f23f4813205bd.png" alt="image-20200705080719531" style="zoom:67%;" /><hr><hr><h2 id="ç±»åŠ è½½å™¨å­ç³»ç»Ÿ">ç±»åŠ è½½å™¨å­ç³»ç»Ÿ</h2><mark class="hl-label blue">ç±»åŠ è½½å™¨å­ç³»ç»Ÿä½œç”¨</mark> <p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/3569bfb903e80b66ee7e972a6b4a5036.png" alt="image-20200705081813409"></p><ul><li><p>ç±»åŠ è½½å™¨å­ç³»ç»Ÿè´Ÿè´£ä»æ–‡ä»¶ç³»ç»Ÿæˆ–è€…ç½‘ç»œä¸­åŠ è½½ Class æ–‡ä»¶ï¼Œclass æ–‡ä»¶åœ¨æ–‡ä»¶å¼€å¤´æœ‰ç‰¹å®šçš„æ–‡ä»¶æ ‡è¯†ã€‚</p></li><li><p>ClassLoader åªè´Ÿè´£ class æ–‡ä»¶çš„åŠ è½½ï¼Œè‡³äºå®ƒæ˜¯å¦å¯ä»¥è¿è¡Œï¼Œåˆ™ç”± Execution Engine å†³å®šã€‚</p></li><li><span class='p blue'>åŠ è½½çš„ç±»ä¿¡æ¯å­˜æ”¾äºä¸€å—ç§°ä¸ºæ–¹æ³•åŒºçš„å†…å­˜ç©ºé—´ã€‚</span>é™¤äº†ç±»çš„ä¿¡æ¯å¤–ï¼Œ<span class='p green'>æ–¹æ³•åŒºä¸­è¿˜ä¼šå­˜æ”¾è¿è¡Œæ—¶å¸¸é‡æ± ä¿¡æ¯</span>ï¼Œå¯èƒ½è¿˜åŒ…æ‹¬å­—ç¬¦ä¸²å­—é¢é‡å’Œæ•°å­—å¸¸é‡ï¼ˆè¿™éƒ¨åˆ†å¸¸é‡ä¿¡æ¯æ˜¯ Class æ–‡ä»¶ä¸­å¸¸é‡æ± éƒ¨åˆ†çš„å†…å­˜æ˜ å°„ï¼‰</li></ul><hr><hr><h2 id="ç±»åŠ è½½å™¨">ç±»åŠ è½½å™¨</h2><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/e8172076eaa7a152408633a353f06b2c.png" alt="image-20200705081913538"></p><ul><li>class file å­˜åœ¨äºæœ¬åœ°ç¡¬ç›˜ä¸Šï¼Œå¯ä»¥ç†è§£ä¸ºè®¾è®¡å¸ˆç”»åœ¨çº¸ä¸Šçš„æ¨¡æ¿ï¼Œè€Œæœ€ç»ˆè¿™ä¸ªæ¨¡æ¿åœ¨æ‰§è¡Œçš„æ—¶å€™æ˜¯è¦åŠ è½½åˆ° JVM å½“ä¸­æ¥æ ¹æ®è¿™ä¸ªæ–‡ä»¶å®ä¾‹åŒ–å‡º n ä¸ªä¸€æ¨¡ä¸€æ ·çš„å®ä¾‹ã€‚</li><li>class file åŠ è½½åˆ° JVM ä¸­ï¼Œè¢«ç§°ä¸º DNA å…ƒæ•°æ®æ¨¡æ¿ï¼Œæ”¾åœ¨<code>æ–¹æ³•åŒº</code>ã€‚</li><li>åœ¨.class æ–‡ä»¶-&gt; JVM -&gt;æœ€ç»ˆæˆä¸ºå…ƒæ•°æ®æ¨¡æ¿ï¼Œæ­¤è¿‡ç¨‹å°±è¦ä¸€ä¸ªè¿è¾“å·¥å…·ï¼ˆç±»è£…è½½å™¨ Class Loaderï¼‰ï¼Œæ‰®æ¼”ä¸€ä¸ªå¿«é€’å‘˜çš„è§’è‰²ã€‚</li></ul><mark class="hl-label blue">ClassLoaderç±»ä»‹ç»</mark> <p>ClassLoaderç±»ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…¶åæ‰€æœ‰çš„ç±»åŠ è½½å™¨éƒ½ç»§æ‰¿è‡ªClassLoaderï¼ˆä¸åŒ…æ‹¬å¯åŠ¨ç±»åŠ è½½å™¨ï¼‰</p><p>sun.misc.Launcher å®ƒæ˜¯ä¸€ä¸ªjavaè™šæ‹Ÿæœºçš„å…¥å£åº”ç”¨</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/a22114b608dffe484041b591d486a7fd.png" alt="image-20200705103636003"></p><hr><hr><h2 id="ç±»åŠ è½½è¿‡ç¨‹">ç±»åŠ è½½è¿‡ç¨‹</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *ç¤ºä¾‹ä»£ç </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloLoader</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒçš„åŠ è½½è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„å‘¢?</p><ul><li>æ‰§è¡Œ main() æ–¹æ³•ï¼ˆé™æ€æ–¹æ³•ï¼‰å°±éœ€è¦å…ˆåŠ è½½mainæ–¹æ³•æ‰€åœ¨ç±» HelloLoader</li><li>åŠ è½½æˆåŠŸï¼Œåˆ™è¿›è¡Œé“¾æ¥ã€åˆå§‹åŒ–ç­‰æ“ä½œã€‚å®Œæˆåè°ƒç”¨ HelloLoader ç±»ä¸­çš„é™æ€æ–¹æ³• main</li><li>åŠ è½½å¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/8cc54647114c456695ac352336c74600.png" alt="image-20200705082255746"></p><p>å®Œæ•´çš„æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/image-20230223144619053.png" alt="image-20230223144619053"></p><hr><h3 id="åŠ è½½é˜¶æ®µ">åŠ è½½é˜¶æ®µ</h3><ol><li><p>é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåè·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ</p></li><li><p>å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„</p></li><li><p><code>åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„java.lang.Classå¯¹è±¡</code>ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£</p></li></ol><p><strong>è¡¥å……ï¼šåŠ è½½classæ–‡ä»¶çš„æ–¹å¼</strong></p><ol><li>ä»æœ¬åœ°ç³»ç»Ÿä¸­ç›´æ¥åŠ è½½</li><li>é€šè¿‡ç½‘ç»œè·å–ï¼Œå…¸å‹åœºæ™¯ï¼šWeb Applet</li><li>ä»zipå‹ç¼©åŒ…ä¸­è¯»å–ï¼Œæˆä¸ºæ—¥åjarã€waræ ¼å¼çš„åŸºç¡€</li><li>è¿è¡Œæ—¶è®¡ç®—ç”Ÿæˆï¼Œä½¿ç”¨æœ€å¤šçš„æ˜¯ï¼šåŠ¨æ€ä»£ç†æŠ€æœ¯</li><li>ç”±å…¶ä»–æ–‡ä»¶ç”Ÿæˆï¼Œå…¸å‹åœºæ™¯ï¼šJSPåº”ç”¨ä»ä¸“æœ‰æ•°æ®åº“ä¸­æå–.classæ–‡ä»¶ï¼Œæ¯”è¾ƒå°‘è§</li><li>ä»åŠ å¯†æ–‡ä»¶ä¸­è·å–ï¼Œå…¸å‹çš„é˜²Classæ–‡ä»¶è¢«åç¼–è¯‘çš„ä¿æŠ¤æªæ–½</li></ol><hr><h3 id="é“¾æ¥é˜¶æ®µ">é“¾æ¥é˜¶æ®µ</h3><p>é“¾æ¥åˆ†ä¸ºä¸‰ä¸ªå­é˜¶æ®µï¼š<code>éªŒè¯ -&gt; å‡†å¤‡ -&gt; è§£æ</code></p><div class="tabs" id="b2447a71-06b7-461a-9870-39ae327efdc0"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#b2447a71-06b7-461a-9870-39ae327efdc0-1"><i class="fas fa-seedling"></i>éªŒè¯</button></li><li class="tab"><button type="button" data-href="#b2447a71-06b7-461a-9870-39ae327efdc0-2"><i class="fas fa-leaf"></i>å‡†å¤‡</button></li><li class="tab"><button type="button" data-href="#b2447a71-06b7-461a-9870-39ae327efdc0-3"><i class="fab fa-apple"></i>è§£æ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="b2447a71-06b7-461a-9870-39ae327efdc0-1"><p>ç¡®ä¿ Class æ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«ä¿¡æ¯ç¬¦åˆå½“å‰è™šæ‹Ÿæœºè¦æ±‚ï¼Œä¿è¯è¢«åŠ è½½ç±»çš„æ­£ç¡®æ€§ï¼Œä¸ä¼šå±å®³è™šæ‹Ÿæœºè‡ªèº«å®‰å…¨ã€‚</p><p>ä¸»è¦åŒ…æ‹¬å››ç§éªŒè¯ï¼Œ<span class='p green'>æ–‡ä»¶æ ¼å¼éªŒè¯ï¼Œå…ƒæ•°æ®éªŒè¯ï¼Œå­—èŠ‚ç éªŒè¯ï¼Œç¬¦å·å¼•ç”¨éªŒè¯</span>ã€‚</p><p><code>ä¸¾ä¾‹:</code></p><p>ä½¿ç”¨ BinaryViewerè½¯ä»¶æŸ¥çœ‹å­—èŠ‚ç æ–‡ä»¶ï¼Œå…¶å¼€å¤´å‡ä¸º CAFE BABE ï¼Œå¦‚æœå‡ºç°ä¸åˆæ³•çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œé‚£ä¹ˆå°†ä¼šéªŒè¯ä¸é€šè¿‡ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b2447a71-06b7-461a-9870-39ae327efdc0-2"><p>ä¸ºç±»å˜é‡<code>åˆ†é…å†…å­˜</code>å¹¶ä¸”è®¾ç½®è¯¥<code>ç±»å˜é‡</code>çš„é»˜è®¤åˆå§‹å€¼ï¼Œå³é›¶å€¼ï¼Œç±»å¸¸é‡çš„å€¼åœ¨ç¼–è¯‘æ—¶å°±å·²ç»åˆ†é…äº†</p><p><span class='p blue'>è¿™é‡Œä¸åŒ…å«ç”¨ final ä¿®é¥°çš„ staticï¼Œå› ä¸º final åœ¨ç¼–è¯‘çš„æ—¶å€™å°±ä¼šåˆ†é…äº†ï¼Œå‡†å¤‡é˜¶æ®µä¼šæ˜¾å¼åˆå§‹åŒ–</span></p><p>è¿™é‡Œä¸ä¼šä¸ºå®ä¾‹å˜é‡åˆ†é…åˆå§‹åŒ–ï¼Œç±»å˜é‡ä¼šåˆ†é…åœ¨æ–¹æ³•åŒºä¸­ï¼Œè€Œå®ä¾‹å˜é‡æ˜¯ä¼šéšç€å¯¹è±¡ä¸€èµ·åˆ†é…åˆ° Java å †ä¸­</p><p><code>ä¸¾ä¾‹ï¼š</code></p><p>ä»£ç ï¼šå˜é‡n2åœ¨å‡†å¤‡é˜¶æ®µä¼šèµ‹åˆå§‹å€¼ï¼Œä½†ä¸æ˜¯2ï¼Œè€Œæ˜¯0ï¼Œåœ¨åˆå§‹åŒ–é˜¶æ®µä¼šè¢«èµ‹å€¼ä¸º 2</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="number">1</span>;<span class="comment">//å®ä¾‹å±æ€§ï¼Œéé™æ€å˜é‡ï¼Œæ­¤é˜¶æ®µä¸åˆ†é…å†…å­˜ åœ¨&lt;init&gt; é˜¶æ®µèµ‹å€¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">n2</span> <span class="operator">=</span> <span class="number">2</span>;<span class="comment">//é™æ€å˜é‡ï¼Œé»˜è®¤åˆå§‹åŒ–ä¸º 0</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">n3</span> <span class="operator">=</span> <span class="number">3</span>;<span class="comment">//static final å¸¸é‡ï¼Œä¸º 3</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b2447a71-06b7-461a-9870-39ae327efdc0-3"><p>å°†å¸¸é‡æ± å†…çš„<span class='p red'>ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨</span>çš„è¿‡ç¨‹ã€‚</p><p>äº‹å®ä¸Šï¼Œè§£ææ“ä½œå¾€å¾€ä¼šä¼´éšç€ JVM åœ¨æ‰§è¡Œå®Œåˆå§‹åŒ–ä¹‹åå†æ‰§è¡Œã€‚</p><p>ç¬¦å·å¼•ç”¨å°±æ˜¯ä¸€ç»„ç¬¦å·æ¥æè¿°æ‰€å¼•ç”¨çš„ç›®æ ‡ã€‚ç¬¦å·å¼•ç”¨çš„å­—é¢é‡å½¢å¼æ˜ç¡®å®šä¹‰åœ¨ã€Šjava è™šæ‹Ÿæœºè§„èŒƒã€‹çš„ Class æ–‡ä»¶æ ¼å¼ä¸­ã€‚ç›´æ¥å¼•ç”¨å°±æ˜¯ç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–ä¸€ä¸ªé—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ã€‚</p><p>è§£æåŠ¨ä½œä¸»è¦é’ˆå¯¹ç±»æˆ–æ¥å£ã€å­—æ®µã€ç±»æ–¹æ³•ã€æ¥å£æ–¹æ³•ã€æ–¹æ³•ç±»å‹ç­‰ã€‚å¯¹åº”å¸¸é‡æ± ä¸­çš„ CONSTANT_Class_infoï¼ŒCONSTANT_Fieldref_infoã€CONSTANT_Methodref_info ç­‰ã€‚</p><p><code>ç¬¦å·å¼•ç”¨:</code></p><p>åç¼–è¯‘ class æ–‡ä»¶åå¯ä»¥æŸ¥çœ‹ç¬¦å·å¼•ç”¨ï¼Œä¸‹é¢å¸¦# çš„å°±æ˜¯ç¬¦å·å¼•ç”¨</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/image-20230223145236317.png" alt="image-20230223145236317" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="åˆå§‹åŒ–é˜¶æ®µ">åˆå§‹åŒ–é˜¶æ®µ</h3><p>ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å¼€å§‹ç±»åŠ è½½è¿‡ç¨‹çš„ç¬¬ä¸€ä¸ªé˜¶æ®µï¼šåŠ è½½ï¼Ÿ Javaè™šæ‹Ÿæœºè§„èŒƒä¸­å¹¶æ²¡æœ‰è¿›è¡Œå¼ºåˆ¶çº¦æŸï¼Œè¿™ç‚¹å¯ä»¥äº¤ç»™è™šæ‹Ÿæœºçš„å…·ä½“å®ç°æ¥è‡ªç”±æŠŠæ¡ã€‚ä½†æ˜¯å¯¹äºåˆå§‹åŒ–é˜¶æ®µï¼Œè™šæ‹Ÿæœºè§„èŒƒåˆ™æ˜¯ä¸¥æ ¼è§„å®šäº†ä¸‹é¢çš„å‡ ç§æƒ…å†µå¿…é¡»ç«‹å³å¯¹ç±»è¿›è¡Œâ€œåˆå§‹åŒ–â€(è€ŒåŠ è½½ã€éªŒè¯ã€å‡†å¤‡è‡ªç„¶éœ€è¦åœ¨æ­¤ä¹‹å‰å¼€å§‹)ï¼š</p><p><strong>ç±»åˆå§‹åŒ–é˜¶æ®µæ—¶æœº:</strong></p><ol><li><code>åˆ›å»ºç±»çš„å®ä¾‹</code></li><li><code>è®¿é—®æŸä¸ªç±»æˆ–æ¥å£çš„é™æ€å˜é‡</code>ï¼Œæˆ–è€…å¯¹è¯¥é™æ€å˜é‡èµ‹å€¼</li><li>è°ƒç”¨<code>ç±»çš„é™æ€æ–¹æ³•</code></li><li><code>åå°„</code>ï¼ˆæ¯”å¦‚ï¼šClass.forName(â€œcom.atguigu.Testâ€)ï¼‰</li><li><code>åˆå§‹åŒ–ä¸€ä¸ªç±»çš„å­ç±»</code></li><li>Javaè™šæ‹Ÿæœºå¯åŠ¨æ—¶è¢«æ ‡æ˜ä¸ºå¯åŠ¨ç±»çš„ç±»</li><li>JDK7å¼€å§‹æä¾›çš„åŠ¨æ€è¯­è¨€æ”¯æŒï¼šjava.lang.invoke.MethodHandleå®ä¾‹çš„è§£æç»“æœREF_getStaticã€REF putStaticã€REF_invokeStaticå¥æŸ„å¯¹åº”çš„ç±»æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ–</li></ol><p>é™¤äº†ä»¥ä¸Šä¸ƒç§æƒ…å†µï¼Œå…¶ä»–ä½¿ç”¨Javaç±»çš„æ–¹å¼éƒ½è¢«çœ‹ä½œæ˜¯å¯¹ç±»çš„è¢«åŠ¨ä½¿ç”¨ï¼Œéƒ½ä¸ä¼šå¯¼è‡´ç±»çš„åˆå§‹åŒ–ï¼Œå³ä¸ä¼šæ‰§è¡Œåˆå§‹åŒ–é˜¶æ®µï¼ˆä¸ä¼šè°ƒç”¨ clinit() æ–¹æ³•å’Œ init() æ–¹æ³•ï¼‰</p><p><strong>æ³¨æ„ï¼š</strong></p><p>1.é€šè¿‡å­ç±»è°ƒç”¨çˆ¶ç±»çš„é™æ€æˆå‘˜æ—¶ï¼Œåªä¼šåˆå§‹åŒ–çˆ¶ç±»è€Œä¸ä¼šåˆå§‹åŒ–å­ç±»ã€‚ å› ä¸ºæ²¡æœ‰è°ƒç”¨å­ç±»çš„ç›¸å…³é™æ€æˆå‘˜ã€‚</p><p>2.è°ƒç”¨é™æ€æˆå‘˜æ—¶ï¼Œä¼šåŠ è½½é™æ€æˆå‘˜çœŸæ­£æ‰€åœ¨çš„ç±»åŠå…¶çˆ¶ç±»ã€‚ è¿™ä¹Ÿå¥½ç†è§£ï¼Œå› ä¸ºæœ¬ç±»çš„çˆ¶ç±»æ²¡æœ‰åŠ è½½å°±ä¼šå…ˆå»åŠ è½½çˆ¶ç±»ã€‚</p><p>3.ç±»çš„åŠ è½½æˆåŠŸåï¼Œå³é™æ€æˆå‘˜éƒ½è¢«åŠ è½½åï¼Œæ˜¯ä¸ä¼šå†åŠ è½½ç¬¬äºŒæ¬¡çš„ã€‚åªæœ‰éé™æ€æˆå‘˜ï¼Œå¦‚éé™æ€æˆå‘˜å˜é‡ã€éé™æ€ä»£ç å—ã€éé™æ€æ–¹æ³•(ä¸è°ƒç”¨ä¸åŠ è½½)ã€æ„é€ æ–¹æ³•éƒ½ä¼šè¢«å¤šæ¬¡å®ä¾‹åŒ–çš„æ—¶å€™å¤šæ¬¡åŠ è½½ã€‚</p><p>4.å¦‚æœé™æ€å±æ€§æœ‰ final ä¿®é¥°æ—¶ï¼Œå³ç±»å¸¸é‡ï¼Œåˆ™ä¸ä¼šåŠ è½½ï¼Œå½“æˆå¸¸é‡ä½¿ç”¨ã€‚</p><blockquote><p>ä¾‹å¦‚ï¼šå­ç±»è°ƒç”¨çˆ¶ç±»çš„é™æ€æˆå‘˜æ—¶ï¼Œåªä¼šåˆå§‹åŒ–çˆ¶ç±»è€Œä¸ä¼šåˆå§‹åŒ–å­ç±»</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// çˆ¶ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SuperClass</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SuperClass Init!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> <span class="number">123</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å­ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubClass</span> <span class="keyword">extends</span> <span class="title class_">SuperClass</span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SubClass init!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NotInitialization</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="comment">// å¯¹äºé™æ€å­—æ®µï¼Œåªæœ‰ç›´æ¥å®šä¹‰äº†è¿™ä¸ªå­—æ®µçš„ç±»æ‰ä¼šè¢«åˆå§‹åŒ–</span></span><br><span class="line">        System.out.println(SubClass.value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SuperClass Init!</span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure><p>ä»è¾“å‡ºç»“æœä¸­å¯ä»¥å¾—å‡ºé€šè¿‡å­ç±»æ¥å¼•ç”¨çˆ¶ç±»ä¸­å®šä¹‰çš„é™æ€å­—æ®µï¼Œåªä¼šè§¦å‘çˆ¶ç±»çš„åˆå§‹åŒ–è€Œä¸ä¼šè§¦å‘å­ç±»çš„åˆå§‹åŒ–ã€‚<br>ä½†æ˜¯è§¦å‘äº†å­ç±»çš„åŠ è½½ã€‚é€šè¿‡-XX:+TraceClassLoadingå‚æ•°å¯ä»¥è§‚å¯Ÿã€‚ç»“æœå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/70.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><blockquote><p>ä¾‹å¦‚ï¼šè®¿é—®é™æ€å¸¸é‡å¹¶ä¸ä¼šå¯¼è‡´ç±»çš„åˆå§‹åŒ–</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;Begin:&quot;</span> + System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;å†…éƒ¨é™æ€å¸¸é‡ï¼š&quot;</span> + Out.Inner.in_val);</span><br><span class="line">Thread.sleep(<span class="number">10</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;å¤–éƒ¨é™æ€å¸¸é‡ï¼š&quot;</span> + Out.out_val);</span><br><span class="line">Thread.sleep(<span class="number">10</span>);</span><br><span class="line">System.out.println(Out.Inner.in_var);</span><br><span class="line">Thread.sleep(<span class="number">10</span>);</span><br><span class="line">System.out.println(Out.out_var);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Out</span> &#123;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">out_var</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">out_val</span> <span class="operator">=</span> <span class="number">111</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">System.out.println(<span class="string">&quot;Outter&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Inner</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">in_var</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">in_val</span> <span class="operator">=</span> <span class="number">222</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">static</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Inner&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Begin</span><span class="operator">:</span><span class="number">1533821440864</span></span><br><span class="line">å†…éƒ¨é™æ€å¸¸é‡ï¼š<span class="number">222</span></span><br><span class="line">å¤–éƒ¨é™æ€å¸¸é‡ï¼š<span class="number">111</span></span><br><span class="line"><span class="built_in">Inner</span></span><br><span class="line"><span class="number">1533821440884</span></span><br><span class="line"><span class="variable">Outter</span></span><br><span class="line"><span class="number">1533821440895</span></span><br></pre></td></tr></table></figure><p>ç”±ç»“æœå¯è§ï¼šå¸¸é‡ï¼ˆstatic final ä¿®é¥°çš„ï¼‰åœ¨ç¼–è¯‘é˜¶æ®µä¼šå­˜å…¥è°ƒç”¨ç±»çš„å¸¸é‡æ± ä¸­ï¼Œå› æ­¤è°ƒç”¨å…¶å¸¸é‡æœ¬è´¨ä¸Šå¹¶æ²¡æœ‰ç›´æ¥å¼•ç”¨åˆ°å®šä¹‰å¸¸é‡çš„ç±»ï¼Œå› æ­¤ä¸ä¼šè§¦å‘å¸¸é‡çš„ç±»çš„åˆå§‹åŒ–ã€‚</p><p>ä½†å¦‚æœä½¿ç”¨å‡½æ•°ç­‰è¿è¡Œæ—¶æ‰èƒ½è·å¾—ç»“æœçš„ä»£ç ï¼Œæ¥åˆå§‹åŒ–ç±»çš„é™æ€å¸¸é‡ï¼Œåˆ™ä½¿ç”¨æ­¤é™æ€å¸¸é‡æ—¶ä¼šå¯¼è‡´ç±»çš„åŠ è½½å’Œåˆå§‹åŒ–ï¼š</p><p><code>public static final long out_val = System.currentTimeMillis();</code></p><p>å½“ä½¿ç”¨åˆ°å†…éƒ¨ç±»\å¤–éƒ¨ç±»çš„é™æ€å˜é‡æ—¶ï¼Œå†…éƒ¨ç±»\å¤–éƒ¨ç±»æ‰å¼€å§‹æ—¶åˆå§‹åŒ–ã€‚</p><p>å†…éƒ¨ç±»çš„åˆå§‹åŒ–ä¸ä¼šä½¿å¤–éƒ¨ç±»åˆå§‹åŒ–ï¼Œå³å†…éƒ¨ç±»åŠ è½½å®Œæˆï¼Œå¤–éƒ¨ç±»å¯èƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼ŒåŠ è½½é™æ€å†…éƒ¨ç±»çš„æ—¶å€™ä¸ä¼šåŠ è½½å¤–éƒ¨ç±»ã€‚</p><p><strong>clinit()</strong></p><ol><li>åˆå§‹åŒ–é˜¶æ®µå°±æ˜¯æ‰§è¡Œç±»æ„é€ å™¨æ–¹æ³•<code>&lt;clinit&gt;()</code>çš„è¿‡ç¨‹</li><li>æ­¤æ–¹æ³•ä¸éœ€å®šä¹‰ï¼Œæ˜¯javacç¼–è¯‘å™¨è‡ªåŠ¨æ”¶é›†ç±»ä¸­çš„æ‰€æœ‰**<code>ç±»å˜é‡</code>**ï¼ˆé™æ€æˆå‘˜å˜é‡ï¼‰çš„èµ‹å€¼åŠ¨ä½œå’Œ<code>é™æ€ä»£ç å—</code>ä¸­çš„è¯­å¥åˆå¹¶è€Œæ¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬ä»£ç ä¸­åŒ…å«staticå˜é‡çš„æ—¶å€™ï¼Œå°±ä¼šæœ‰clinitæ–¹æ³•</li><li><code>&lt;clinit&gt;()</code>æ–¹æ³•ä¸­çš„æŒ‡ä»¤æŒ‰è¯­å¥åœ¨æºæ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºæ‰§è¡Œ</li><li><code>&lt;clinit&gt;()</code>ä¸åŒäºç±»çš„æ„é€ å™¨ã€‚</li><li>æ„é€ å™¨æ˜¯è™šæ‹Ÿæœºè§†è§’ä¸‹çš„<code>&lt;init&gt;()</code></li><li>è‹¥è¯¥ç±»å…·æœ‰çˆ¶ç±»ï¼ŒJVMä¼šä¿è¯å­ç±»çš„<code>&lt;clinit&gt;()</code>æ‰§è¡Œå‰ï¼Œçˆ¶ç±»çš„<code>&lt;clinit&gt;()</code>å·²ç»æ‰§è¡Œå®Œæ¯•</li><li>è™šæ‹Ÿæœºå¿…é¡»ä¿è¯ä¸€ä¸ªç±»çš„<code>&lt;clinit&gt;()</code>æ–¹æ³•åœ¨å¤šçº¿ç¨‹ä¸‹è¢«åŒæ­¥åŠ é”ï¼Œä¿è¯ä¸€ä¸ªç±»åªåŠ è½½ä¸€æ¬¡ã€‚</li></ol><blockquote><p>ä¾‹1:ä»£ç ä¸­æœ‰staticå˜é‡</p></blockquote><p>æŸ¥çœ‹ä¸‹é¢è¿™ä¸ªä»£ç çš„å­—èŠ‚ç ï¼Œå¯ä»¥å‘ç°æœ‰ä¸€ä¸ª<code>&lt;clinit&gt;()</code>æ–¹æ³•ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/image-20230223145612775.png" alt="image-20230223145612775"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassInitTest</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">static</span>&#123;</span><br><span class="line">       num = <span class="number">2</span>;</span><br><span class="line">       number = <span class="number">20</span>;</span><br><span class="line">       System.out.println(num);</span><br><span class="line">       <span class="comment">//System.out.println(number);//æŠ¥é”™ï¼šéæ³•çš„å‰å‘å¼•ç”¨ã€‚</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 1ã€linkingä¹‹prepare: number = 0 --&gt; initial: 20 --&gt; 10</span></span><br><span class="line"><span class="comment">    * 2ã€è¿™é‡Œå› ä¸ºé™æ€ä»£ç å—å‡ºç°åœ¨å£°æ˜å˜é‡è¯­å¥å‰é¢ï¼Œæ‰€ä»¥ä¹‹å‰è¢«å‡†å¤‡é˜¶æ®µä¸º0çš„numberå˜é‡ä¼š</span></span><br><span class="line"><span class="comment">    * é¦–å…ˆè¢«åˆå§‹åŒ–ä¸º20ï¼Œå†æ¥ç€è¢«åˆå§‹åŒ–æˆ10ï¼ˆè¿™ä¹Ÿæ˜¯é¢è¯•æ—¶å¸¸è€ƒçš„é—®é¢˜å“¦ï¼‰</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(ClassInitTest.num);<span class="comment">//2</span></span><br><span class="line">        System.out.println(ClassInitTest.number);<span class="comment">//10</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&lt;clinitå­—èŠ‚ç &gt;ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">0</span> iconst_1</span><br><span class="line"> <span class="number">1</span> putstatic #<span class="number">3</span> &lt;com/atguigu/java/ClassInitTest.num&gt;</span><br><span class="line"> <span class="number">4</span> iconst_2</span><br><span class="line"> <span class="number">5</span> putstatic #<span class="number">3</span> &lt;com/atguigu/java/ClassInitTest.num&gt;</span><br><span class="line"> <span class="number">8</span> bipush <span class="number">20</span> <span class="comment">//å…ˆèµ‹20</span></span><br><span class="line"><span class="number">10</span> putstatic #<span class="number">5</span> &lt;com/atguigu/java/ClassInitTest.number&gt;</span><br><span class="line"><span class="number">13</span> getstatic #<span class="number">2</span> &lt;java/lang/System.out&gt;</span><br><span class="line"><span class="number">16</span> getstatic #<span class="number">3</span> &lt;com/atguigu/java/ClassInitTest.num&gt;</span><br><span class="line"><span class="number">19</span> invokevirtual #<span class="number">4</span> &lt;java/io/PrintStream.println&gt;</span><br><span class="line"><span class="number">22</span> bipush <span class="number">10</span><span class="comment">//å†èµ‹10</span></span><br><span class="line"><span class="number">24</span> putstatic #<span class="number">5</span> &lt;com/atguigu/java/ClassInitTest.number&gt;</span><br><span class="line"><span class="number">27</span> <span class="keyword">return</span></span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬ä»£ç ä¸­åŒ…å«staticå˜é‡çš„æ—¶å€™ï¼Œå°±ä¼šæœ‰clinitæ–¹æ³•</p><p>æ²¡æœ‰staticå˜é‡æ—¶ï¼Œå°±ä¸ä¼šæœ‰cinitæ–¹æ³•ï¼ŒåŠ ä¸Šä¹‹åå°±æœ‰äº†</p><blockquote><p>ç¬¬å››ç‚¹è¯´æ˜</p></blockquote><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/image-20230223145728185.png" alt="image-20230223145728185"></p><p>åœ¨æ„é€ å™¨ä¸­ï¼š</p><ul><li>å…ˆå°†ç±»å˜é‡ a èµ‹å€¼ä¸º 10</li><li>å†å°†å±€éƒ¨å˜é‡èµ‹å€¼ä¸º 20</li></ul><blockquote><p>ç¬¬äº”ç‚¹è¯´æ˜</p></blockquote><p>è‹¥è¯¥ç±»å…·æœ‰çˆ¶ç±»ï¼ŒJVMä¼šä¿è¯å­ç±»çš„<code>&lt;clinit&gt;()</code>æ‰§è¡Œå‰ï¼Œçˆ¶ç±»çš„<code>&lt;clinit&gt;()</code>å·²ç»æ‰§è¡Œå®Œæ¯•</p><p>åŠ è½½æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>é¦–å…ˆï¼Œæ‰§è¡Œ main() æ–¹æ³•éœ€è¦åŠ è½½ ClinitTest1 ç±»</li><li>è·å– Son.B é™æ€å˜é‡ï¼Œéœ€è¦åŠ è½½ Son ç±»</li><li>Son ç±»çš„çˆ¶ç±»æ˜¯ Father ç±»ï¼Œæ‰€ä»¥éœ€è¦å…ˆæ‰§è¡Œ Father ç±»çš„åŠ è½½ï¼Œå†æ‰§è¡Œ Son ç±»çš„åŠ è½½</li></ul><blockquote><p>ç¬¬å…­ç‚¹è¯´æ˜</p></blockquote><p>å¿…é¡»ä¿è¯ä¸€ä¸ªç±»çš„<code>&lt;clinit&gt;()</code>æ–¹æ³•åœ¨å¤šçº¿ç¨‹ä¸‹è¢«åŒæ­¥åŠ é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadThreadTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">r</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;å¼€å§‹&quot;</span>);</span><br><span class="line">            <span class="type">DeadThread</span> <span class="variable">dead</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeadThread</span>();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;ç»“æŸ&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r,<span class="string">&quot;çº¿ç¨‹1&quot;</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r,<span class="string">&quot;çº¿ç¨‹2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DeadThread</span>&#123;</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;åˆå§‹åŒ–å½“å‰ç±»&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">çº¿ç¨‹2å¼€å§‹</span><br><span class="line">çº¿ç¨‹1å¼€å§‹</span><br><span class="line">çº¿ç¨‹2åˆå§‹åŒ–å½“å‰ç±»</span><br><span class="line"></span><br><span class="line">/ç„¶åç¨‹åºå¡æ­»äº†</span><br></pre></td></tr></table></figure><p>ç¨‹åºå¡æ­»ï¼Œåˆ†æåŸå› ï¼š</p><ul><li>ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å»åŠ è½½ DeadThread ç±»ï¼Œè€Œ DeadThread ç±»ä¸­é™æ€ä»£ç å—ä¸­æœ‰ä¸€å¤„æ­»å¾ªç¯</li><li>å…ˆåŠ è½½ DeadThread ç±»çš„çº¿ç¨‹æŠ¢åˆ°äº†åŒæ­¥é”ï¼Œç„¶ååœ¨ç±»çš„é™æ€ä»£ç å—ä¸­æ‰§è¡Œæ­»å¾ªç¯ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…åŒæ­¥é”çš„é‡Šæ”¾</li><li>æ‰€ä»¥æ— è®ºå“ªä¸ªçº¿ç¨‹å…ˆæ‰§è¡Œ DeadThread ç±»çš„åŠ è½½ï¼Œå¦å¤–ä¸€ä¸ªç±»ä¹Ÿä¸ä¼šç»§ç»­æ‰§è¡Œã€‚ï¼ˆä¸€ä¸ªç±»åªä¼šè¢«åŠ è½½ä¸€æ¬¡ï¼‰</li></ul><hr><hr><h2 id="ç±»åŠ è½½å™¨åˆ†ç±»">ç±»åŠ è½½å™¨åˆ†ç±»</h2><p>JVM æ”¯æŒä¸¤ç§ç±»å‹çš„ç±»åŠ è½½å™¨ ã€‚åˆ†åˆ«ä¸ºå¼•å¯¼ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰å’Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼ˆUser-Defined ClassLoaderï¼‰ã€‚</p><p>ä»æ¦‚å¿µä¸Šæ¥è®²ï¼Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸€èˆ¬æŒ‡çš„æ˜¯ç¨‹åºä¸­ç”±å¼€å‘äººå‘˜è‡ªå®šä¹‰çš„ä¸€ç±»ç±»åŠ è½½å™¨ï¼Œä½†æ˜¯ Java è™šæ‹Ÿæœºè§„èŒƒå´æ²¡æœ‰è¿™ä¹ˆå®šä¹‰ï¼Œè€Œæ˜¯å°†æ‰€æœ‰æ´¾ç”ŸäºæŠ½è±¡ç±» ClassLoader çš„ç±»åŠ è½½å™¨éƒ½åˆ’åˆ†ä¸ºè‡ªå®šä¹‰ç±»åŠ è½½å™¨ã€‚</p><p>æ— è®ºç±»åŠ è½½å™¨çš„ç±»å‹å¦‚ä½•åˆ’åˆ†ï¼Œåœ¨ç¨‹åºä¸­æˆ‘ä»¬æœ€å¸¸è§çš„ç±»åŠ è½½å™¨å§‹ç»ˆåªæœ‰ 3 ä¸ªï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1e553c6d5254f827d2dfab537bea3ab9.png" alt="image-20200705094149223"></p><p>è¿™é‡Œçš„å››è€…ä¹‹é—´çš„å…³ç³»æ˜¯åŒ…å«å…³ç³»ã€‚ä¸æ˜¯ä¸Šå±‚ä¸‹å±‚ï¼Œä¹Ÿä¸æ˜¯å­çˆ¶ç±»çš„ç»§æ‰¿å…³ç³»ã€‚</p><blockquote><p>è™šæ‹Ÿæœºè‡ªå¸¦çš„åŠ è½½å™¨</p></blockquote><p><strong>å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆå¼•å¯¼ç±»åŠ è½½å™¨ï¼ŒBootstrap ClassLoaderï¼‰</strong></p><ul><li>è¿™ä¸ªç±»åŠ è½½ä½¿ç”¨ C/C++è¯­è¨€å®ç°çš„ï¼ŒåµŒå¥—åœ¨ JVM å†…éƒ¨ã€‚</li><li>å®ƒç”¨æ¥åŠ è½½ Java çš„æ ¸å¿ƒåº“ï¼ˆJAVA_HOME/jre/lib/rt.jarã€resources.jar æˆ– sun.boot.class.path è·¯å¾„ä¸‹çš„å†…å®¹ï¼‰ï¼Œç”¨äºæä¾› JVM è‡ªèº«éœ€è¦çš„ç±»</li><li>å¹¶ä¸ç»§æ‰¿è‡ª ava.lang.ClassLoaderï¼Œæ²¡æœ‰çˆ¶åŠ è½½å™¨ã€‚</li><li>åŠ è½½æ‰©å±•ç±»å’Œåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼Œå¹¶æŒ‡å®šä¸ºä»–ä»¬çš„çˆ¶ç±»åŠ è½½å™¨ã€‚</li><li>å‡ºäºå®‰å…¨è€ƒè™‘ï¼ŒBootstrap å¯åŠ¨ç±»åŠ è½½å™¨åªåŠ è½½åŒ…åä¸º javaã€javaxã€sun ç­‰å¼€å¤´çš„ç±»</li></ul><p><strong>æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰</strong></p><ul><li>Java è¯­è¨€ç¼–å†™ï¼Œç”± sun.misc.Launcher$ExtClassLoader å®ç°ã€‚</li><li>æ´¾ç”Ÿäº ClassLoader ç±»</li><li>çˆ¶ç±»åŠ è½½å™¨ä¸ºå¯åŠ¨ç±»åŠ è½½å™¨</li><li>ä» java.ext.dirs ç³»ç»Ÿå±æ€§æ‰€æŒ‡å®šçš„ç›®å½•ä¸­åŠ è½½ç±»åº“ï¼Œæˆ–ä» JDK çš„å®‰è£…ç›®å½•çš„ jre/1ib/ext å­ç›®å½•ï¼ˆæ‰©å±•ç›®å½•ï¼‰ä¸‹åŠ è½½ç±»åº“ã€‚å¦‚æœç”¨æˆ·åˆ›å»ºçš„ JAR æ”¾åœ¨æ­¤ç›®å½•ä¸‹ï¼Œä¹Ÿä¼šè‡ªåŠ¨ç”±æ‰©å±•ç±»åŠ è½½å™¨åŠ è½½ã€‚</li></ul><p><strong>åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼ˆç³»ç»Ÿç±»åŠ è½½å™¨ï¼ŒAppClassLoaderï¼‰</strong></p><ul><li><p>java è¯­è¨€ç¼–å†™ï¼Œç”± sun.misc.LaunchersAppClassLoader å®ç°</p></li><li><p>æ´¾ç”Ÿäº ClassLoader ç±»</p></li><li><p>çˆ¶ç±»åŠ è½½å™¨ä¸ºæ‰©å±•ç±»åŠ è½½å™¨</p></li><li><p>å®ƒè´Ÿè´£åŠ è½½ç¯å¢ƒå˜é‡ classpath æˆ–ç³»ç»Ÿå±æ€§ java.class.path æŒ‡å®šè·¯å¾„ä¸‹çš„ç±»åº“</p></li><li><p>è¯¥ç±»åŠ è½½æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æ¥è¯´ï¼ŒJava åº”ç”¨çš„ç±»éƒ½æ˜¯ç”±å®ƒæ¥å®ŒæˆåŠ è½½</p></li><li><p>é€šè¿‡ ClassLoader#getSystemclassLoader() æ–¹æ³•å¯ä»¥è·å–åˆ°è¯¥ç±»åŠ è½½å™¨</p></li></ul><blockquote><p>ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨</p></blockquote><p><strong>ä»€ä¹ˆæ—¶å€™éœ€è¦è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Ÿ</strong></p><p>åœ¨Javaçš„æ—¥å¸¸åº”ç”¨ç¨‹åºå¼€å‘ä¸­ï¼Œç±»çš„åŠ è½½å‡ ä¹æ˜¯ç”±ä¸Šè¿°3ç§ç±»åŠ è½½å™¨ç›¸äº’é…åˆæ‰§è¡Œçš„ï¼Œåœ¨å¿…è¦æ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œæ¥å®šåˆ¶ç±»çš„åŠ è½½æ–¹å¼ã€‚é‚£ä¸ºä»€ä¹ˆè¿˜éœ€è¦è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Ÿ</p><ol><li>éš”ç¦»åŠ è½½ç±»ï¼ˆæ¯”å¦‚è¯´æˆ‘å‡è®¾ç°åœ¨Springæ¡†æ¶ï¼Œå’ŒRocketMQæœ‰åŒ…åè·¯å¾„å®Œå…¨ä¸€æ ·çš„ç±»ï¼Œç±»åä¹Ÿä¸€æ ·ï¼Œè¿™ä¸ªæ—¶å€™ç±»å°±å†²çªäº†ã€‚ä¸è¿‡ä¸€èˆ¬çš„ä¸»æµæ¡†æ¶å’Œä¸­é—´ä»¶éƒ½ä¼šè‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œå®ç°ä¸åŒçš„æ¡†æ¶ï¼Œä¸­é—´ä»·ä¹‹é—´æ˜¯éš”ç¦»çš„ï¼‰</li><li>ä¿®æ”¹ç±»åŠ è½½çš„æ–¹å¼</li><li>æ‰©å±•åŠ è½½æºï¼ˆè¿˜å¯ä»¥è€ƒè™‘ä»æ•°æ®åº“ä¸­åŠ è½½ç±»ï¼Œè·¯ç”±å™¨ç­‰ç­‰ä¸åŒçš„åœ°æ–¹ï¼‰</li><li>é˜²æ­¢æºç æ³„æ¼ï¼ˆå¯¹å­—èŠ‚ç æ–‡ä»¶è¿›è¡Œè§£å¯†ï¼Œè‡ªå·±ç”¨çš„æ—¶å€™é€šè¿‡è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¥å¯¹å…¶è¿›è¡Œè§£å¯†ï¼‰</li></ol><p><strong>å¦‚ä½•è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Ÿ</strong></p><ol><li>å¼€å‘äººå‘˜å¯ä»¥é€šè¿‡ç»§æ‰¿æŠ½è±¡ç±» ava.lang.ClassLoader ç±»çš„æ–¹å¼ï¼Œå®ç°è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä»¥æ»¡è¶³ä¸€äº›ç‰¹æ®Šçš„éœ€æ±‚</li><li>åœ¨ JDK1.2 ä¹‹å‰ï¼Œåœ¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œæ€»ä¼šå»ç»§æ‰¿ ClassLoader ç±»å¹¶é‡å†™ loadClass() æ–¹æ³•ï¼Œä»è€Œå®ç°è‡ªå®šä¹‰çš„ç±»åŠ è½½ç±»ï¼Œä½†æ˜¯åœ¨ JDK1.2 ä¹‹åå·²ä¸å†å»ºè®®ç”¨æˆ·å»è¦†ç›– loadclass() æ–¹æ³•ï¼Œè€Œæ˜¯å»ºè®®æŠŠè‡ªå®šä¹‰çš„ç±»åŠ è½½é€»è¾‘å†™åœ¨ findClass()æ–¹æ³•ä¸­</li><li>åœ¨ç¼–å†™è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¤ªè¿‡äºå¤æ‚çš„éœ€æ±‚ï¼Œå¯ä»¥ç›´æ¥ç»§æ‰¿ URLClassLoader ç±»ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…è‡ªå·±å»ç¼–å†™ findClass() æ–¹æ³•åŠå…¶è·å–å­—èŠ‚ç æµçš„æ–¹å¼ï¼Œä½¿è‡ªå®šä¹‰ç±»åŠ è½½å™¨ç¼–å†™æ›´åŠ ç®€æ´ã€‚</li></ol><p><code>ä»£ç ç¤ºä¾‹</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] result = getClassFromCustomPath(name);</span><br><span class="line">            <span class="keyword">if</span> (result == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//defineClasså’ŒfindClassæ­é…ä½¿ç”¨</span></span><br><span class="line">                <span class="keyword">return</span> defineClass(name, result, <span class="number">0</span>, result.length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//è‡ªå®šä¹‰æµçš„è·å–æ–¹å¼</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] getClassFromCustomPath(String name) &#123;</span><br><span class="line">        <span class="comment">//ä»è‡ªå®šä¹‰è·¯å¾„ä¸­åŠ è½½æŒ‡å®šç±»:ç»†èŠ‚ç•¥</span></span><br><span class="line">        <span class="comment">//å¦‚æœæŒ‡å®šè·¯å¾„çš„å­—èŠ‚ç æ–‡ä»¶è¿›è¡Œäº†åŠ å¯†ï¼Œåˆ™éœ€è¦åœ¨æ­¤æ–¹æ³•ä¸­è¿›è¡Œè§£å¯†æ“ä½œã€‚</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">CustomClassLoader</span> <span class="variable">customClassLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomClassLoader</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;One&quot;</span>, <span class="literal">true</span>, customClassLoader);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> clazz.newInstance();</span><br><span class="line">            System.out.println(obj.getClass().getClassLoader());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="åŒäº²å§”æ´¾æœºåˆ¶">åŒäº²å§”æ´¾æœºåˆ¶</h2><p>Java è™šæ‹Ÿæœºå¯¹ class æ–‡ä»¶é‡‡ç”¨çš„æ˜¯<code>æŒ‰éœ€åŠ è½½</code>çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´å½“éœ€è¦ä½¿ç”¨è¯¥ç±»æ—¶æ‰ä¼šå°†å®ƒçš„ class æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ç”Ÿæˆ class å¯¹è±¡ã€‚è€Œä¸”åŠ è½½æŸä¸ªç±»çš„ class æ–‡ä»¶æ—¶ï¼ŒJava è™šæ‹Ÿæœºé‡‡ç”¨çš„æ˜¯<code>åŒäº²å§”æ´¾æ¨¡å¼</code>ï¼Œå³æŠŠè¯·æ±‚äº¤ç”±çˆ¶ç±»å¤„ç†ï¼Œå®ƒæ˜¯ä¸€ç§ä»»åŠ¡å§”æ´¾æ¨¡å¼ã€‚</p><mark class="hl-label green">å·¥ä½œåŸç†</mark> <ul><li>1ï¼‰å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½è¯·æ±‚ï¼Œå®ƒå¹¶ä¸ä¼šè‡ªå·±å…ˆå»åŠ è½½ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ‰˜ç»™çˆ¶ç±»çš„åŠ è½½å™¨å»æ‰§è¡Œï¼›</li><li>2ï¼‰å¦‚æœçˆ¶ç±»åŠ è½½å™¨è¿˜å­˜åœ¨å…¶çˆ¶ç±»åŠ è½½å™¨ï¼Œåˆ™è¿›ä¸€æ­¥å‘ä¸Šå§”æ‰˜ï¼Œä¾æ¬¡é€’å½’ï¼Œè¯·æ±‚æœ€ç»ˆå°†åˆ°è¾¾é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ï¼›</li><li>3ï¼‰å¦‚æœçˆ¶ç±»åŠ è½½å™¨å¯ä»¥å®Œæˆç±»åŠ è½½ä»»åŠ¡ï¼Œå°±æˆåŠŸè¿”å›ï¼Œå€˜è‹¥çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®Œæˆæ­¤åŠ è½½ä»»åŠ¡ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ï¼Œè¿™å°±æ˜¯åŒäº²å§”æ´¾æ¨¡å¼ã€‚</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/05fa27fcc38eeaaa5babff55a00882a3.png" alt="image-20200705105151258"></p><mark class="hl-label blue">ä¸¾ä¾‹1</mark> <p>1ã€æˆ‘ä»¬è‡ªå·±å»ºç«‹ä¸€ä¸ª java.lang.String ç±»ï¼Œå†™ä¸Š static ä»£ç å—</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">String</span> &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æˆ‘æ˜¯è‡ªå®šä¹‰çš„Stringç±»çš„é™æ€ä»£ç å—&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2ã€åœ¨å¦å¤–çš„ç¨‹åºä¸­åŠ è½½ String ç±»ï¼Œçœ‹çœ‹åŠ è½½çš„ String ç±»æ˜¯ JDK è‡ªå¸¦çš„ String ç±»ï¼Œè¿˜æ˜¯æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„ String ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        java.lang.<span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.lang.String();</span><br><span class="line">        System.out.println(<span class="string">&quot;hello,atguigu.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">StringTest</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringTest</span>();</span><br><span class="line">        System.out.println(test.getClass().getClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hello,atguigu<span class="selector-class">.com</span></span><br><span class="line">sun<span class="selector-class">.misc</span>.Launcher<span class="variable">$AppClassLoader</span>@<span class="number">18</span>b4aac2</span><br></pre></td></tr></table></figure><p>ç¨‹åºå¹¶æ²¡æœ‰è¾“å‡ºæˆ‘ä»¬é™æ€ä»£ç å—ä¸­çš„å†…å®¹ï¼Œå¯è§ä»ç„¶åŠ è½½çš„æ˜¯ JDK è‡ªå¸¦çš„ String ç±»ã€‚</p><p>æŠŠåˆšåˆšçš„ç±»æ”¹ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.lang;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">String</span> &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æˆ‘æ˜¯è‡ªå®šä¹‰çš„Stringç±»çš„é™æ€ä»£ç å—&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//é”™è¯¯: åœ¨ç±» java.lang.String ä¸­æ‰¾ä¸åˆ° main æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello,String&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºåŒäº²å§”æ´¾æœºåˆ¶ä¸€ç›´æ‰¾çˆ¶ç±»ï¼Œæ‰€ä»¥æœ€åæ‰¾åˆ°äº†Bootstrap ClassLoaderï¼Œè¯¥åŠ è½½å™¨æ­£å¥½è´Ÿè´£Stringçš„åŠ è½½ï¼ŒBootstrap ClassLoaderæ‰¾åˆ°çš„æ˜¯ JDK è‡ªå¸¦çš„ String ç±»ï¼Œåœ¨é‚£ä¸ªStringç±»ä¸­å¹¶æ²¡æœ‰ main() æ–¹æ³•ï¼Œæ‰€ä»¥å°±æŠ¥äº†ä¸Šé¢çš„é”™è¯¯ã€‚</p><mark class="hl-label green">ä¸¾ä¾‹2</mark> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.lang;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShkStart</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">java.lang.SecurityException: Prohibited <span class="keyword">package</span> name: java.lang</span><br><span class="line">at java.lang.ClassLoader.preDefineClass(ClassLoader.java:<span class="number">662</span>)</span><br><span class="line">at java.lang.ClassLoader.defineClass(ClassLoader.java:<span class="number">761</span>)</span><br><span class="line">at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:<span class="number">142</span>)</span><br><span class="line">at java.net.URLClassLoader.defineClass(URLClassLoader.java:<span class="number">467</span>)</span><br><span class="line">at java.net.URLClassLoader.access$<span class="number">100</span>(URLClassLoader.java:<span class="number">73</span>)</span><br><span class="line">at java.net.URLClassLoader$<span class="number">1.</span>run(URLClassLoader.java:<span class="number">368</span>)</span><br><span class="line">at java.net.URLClassLoader$<span class="number">1.</span>run(URLClassLoader.java:<span class="number">362</span>)</span><br><span class="line">at java.security.AccessController.doPrivileged(Native Method)</span><br><span class="line">at java.net.URLClassLoader.findClass(URLClassLoader.java:<span class="number">361</span>)</span><br><span class="line">at java.lang.ClassLoader.loadClass(ClassLoader.java:<span class="number">424</span>)</span><br><span class="line">at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:<span class="number">335</span>)</span><br><span class="line">at java.lang.ClassLoader.loadClass(ClassLoader.java:<span class="number">357</span>)</span><br><span class="line">at sun.launcher.LauncherHelper.checkAndLoadMain(LauncherHelper.java:<span class="number">495</span>)</span><br><span class="line">Error: A JNI error has occurred, please check your installation and <span class="keyword">try</span> again</span><br><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> </span><br><span class="line">Process finished with exit code <span class="number">1</span></span><br></pre></td></tr></table></figure><p>å³ä½¿ç±»åæ²¡æœ‰é‡å¤ï¼Œä¹Ÿç¦æ­¢ä½¿ç”¨java.langè¿™ç§åŒ…åã€‚è¿™æ˜¯ä¸€ç§ä¿æŠ¤æœºåˆ¶</p><p><code>ä¸¾ä¾‹3</code></p><p>å½“æˆ‘ä»¬åŠ è½½jdbc.jar ç”¨äºå®ç°æ•°æ®åº“è¿æ¥çš„æ—¶å€™</p><ol><li>æˆ‘ä»¬ç°åœ¨ç¨‹åºä¸­éœ€è¦ç”¨åˆ°SPIæ¥å£ï¼Œè€ŒSPIæ¥å£å±äºrt.jaråŒ…ä¸­Javaæ ¸å¿ƒapi</li><li>ç„¶åä½¿ç”¨åŒæ¸…å§”æ´¾æœºåˆ¶ï¼Œå¼•å¯¼ç±»åŠ è½½å™¨æŠŠrt.jaråŒ…åŠ è½½è¿›æ¥ï¼Œè€Œrt.jaråŒ…ä¸­çš„SPIå­˜åœ¨ä¸€äº›æ¥å£ï¼Œæ¥å£æˆ‘ä»¬å°±éœ€è¦å…·ä½“çš„å®ç°ç±»äº†</li><li>å…·ä½“çš„å®ç°ç±»å°±æ¶‰åŠåˆ°äº†æŸäº›ç¬¬ä¸‰æ–¹çš„jaråŒ…äº†ï¼Œæ¯”å¦‚æˆ‘ä»¬åŠ è½½SPIçš„å®ç°ç±»jdbc.jaråŒ…ã€é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯ jdbc.jaræ˜¯åŸºäºSPIæ¥å£è¿›è¡Œå®ç°çš„ã€‘</li><li>ç¬¬ä¸‰æ–¹çš„jaråŒ…ä¸­çš„ç±»å±äºç³»ç»Ÿç±»åŠ è½½å™¨æ¥åŠ è½½</li><li>ä»è¿™é‡Œé¢å°±å¯ä»¥çœ‹åˆ°SPIæ ¸å¿ƒæ¥å£ç”±å¼•å¯¼ç±»åŠ è½½å™¨æ¥åŠ è½½ï¼ŒSPIå…·ä½“å®ç°ç±»ç”±ç³»ç»Ÿç±»åŠ è½½å™¨æ¥åŠ è½½</li></ol><p><strong>åŒäº²å§”æ´¾æœºåˆ¶ä¼˜åŠ¿</strong></p><p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒåŒäº²æœºåˆ¶å¯ä»¥</p><ol><li><p>é¿å…ç±»çš„é‡å¤åŠ è½½</p></li><li><p>ä¿æŠ¤ç¨‹åºå®‰å…¨ï¼Œé˜²æ­¢æ ¸å¿ƒAPIè¢«éšæ„ç¯¡æ”¹</p><ul><li>è‡ªå®šä¹‰ç±»ï¼šè‡ªå®šä¹‰java.lang.String æ²¡æœ‰è¢«åŠ è½½ã€‚</li><li>è‡ªå®šä¹‰ç±»ï¼šjava.lang.ShkStartï¼ˆæŠ¥é”™ï¼šé˜»æ­¢åˆ›å»º java.langå¼€å¤´çš„ç±»ï¼‰</li></ul></li></ol><blockquote><p><strong>æ²™ç®±å®‰å…¨æœºåˆ¶</strong></p></blockquote><ol><li>è‡ªå®šä¹‰Stringç±»æ—¶ï¼šåœ¨åŠ è½½è‡ªå®šä¹‰Stringç±»çš„æ—¶å€™ä¼šç‡å…ˆä½¿ç”¨å¼•å¯¼ç±»åŠ è½½å™¨åŠ è½½ï¼Œè€Œå¼•å¯¼ç±»åŠ è½½å™¨åœ¨åŠ è½½çš„è¿‡ç¨‹ä¸­ä¼šå…ˆåŠ è½½jdkè‡ªå¸¦çš„æ–‡ä»¶ï¼ˆrt.jaråŒ…ä¸­java.lang.String.classï¼‰ï¼ŒæŠ¥é”™ä¿¡æ¯è¯´æ²¡æœ‰mainæ–¹æ³•ï¼Œå°±æ˜¯å› ä¸ºåŠ è½½çš„æ˜¯rt.jaråŒ…ä¸­çš„Stringç±»ã€‚</li><li>è¿™æ ·å¯ä»¥ä¿è¯å¯¹javaæ ¸å¿ƒæºä»£ç çš„ä¿æŠ¤ï¼Œè¿™å°±æ˜¯æ²™ç®±å®‰å…¨æœºåˆ¶ã€‚</li></ol><hr><hr><h2 id="å…¶ä»–">å…¶ä»–</h2><blockquote><p>å¦‚ä½•åˆ¤æ–­ä¸¤ä¸ªclasså¯¹è±¡æ˜¯å¦ç›¸åŒï¼Ÿ</p></blockquote><p>åœ¨JVMä¸­è¡¨ç¤ºä¸¤ä¸ªclasså¯¹è±¡æ˜¯å¦ä¸ºåŒä¸€ä¸ªç±»å­˜åœ¨ä¸¤ä¸ªå¿…è¦æ¡ä»¶ï¼š</p><ol><li>ç±»çš„å®Œæ•´ç±»åå¿…é¡»ä¸€è‡´ï¼ŒåŒ…æ‹¬åŒ…å</li><li><strong>åŠ è½½è¿™ä¸ªç±»çš„ClassLoaderï¼ˆæŒ‡ClassLoaderå®ä¾‹å¯¹è±¡ï¼‰å¿…é¡»ç›¸åŒ</strong></li><li>æ¢å¥è¯è¯´ï¼Œåœ¨JVMä¸­ï¼Œå³ä½¿è¿™ä¸¤ä¸ªç±»å¯¹è±¡ï¼ˆclasså¯¹è±¡ï¼‰æ¥æºåŒä¸€ä¸ªClassæ–‡ä»¶ï¼Œè¢«åŒä¸€ä¸ªè™šæ‹Ÿæœºæ‰€åŠ è½½ï¼Œä½†åªè¦åŠ è½½å®ƒä»¬çš„ClassLoaderå®ä¾‹å¯¹è±¡ä¸åŒï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªç±»å¯¹è±¡ä¹Ÿæ˜¯ä¸ç›¸ç­‰çš„</li></ol><blockquote><p>å¯¹ç±»åŠ è½½å™¨çš„å¼•ç”¨</p></blockquote><ol><li>JVMå¿…é¡»çŸ¥é“ä¸€ä¸ªç±»å‹æ˜¯ç”±å¯åŠ¨åŠ è½½å™¨åŠ è½½çš„è¿˜æ˜¯ç”±ç”¨æˆ·ç±»åŠ è½½å™¨åŠ è½½çš„</li><li><strong>å¦‚æœä¸€ä¸ªç±»å‹æ˜¯ç”±ç”¨æˆ·ç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œé‚£ä¹ˆJVMä¼šå°†è¿™ä¸ªç±»åŠ è½½å™¨çš„ä¸€ä¸ªå¼•ç”¨ä½œä¸ºç±»å‹ä¿¡æ¯çš„ä¸€éƒ¨åˆ†ä¿å­˜åœ¨æ–¹æ³•åŒºä¸­</strong></li><li>å½“è§£æä¸€ä¸ªç±»å‹åˆ°å¦ä¸€ä¸ªç±»å‹çš„å¼•ç”¨çš„æ—¶å€™ï¼ŒJVMéœ€è¦ä¿è¯è¿™ä¸¤ä¸ªç±»å‹çš„ç±»åŠ è½½å™¨æ˜¯ç›¸åŒçš„ï¼ˆåé¢è®²ï¼‰</li></ol><blockquote><p><strong>newä¸€ä¸ªå¯¹è±¡çš„è¿‡ç¨‹ï¼Ÿ</strong></p></blockquote><p>å½“è™šæ‹Ÿæœºé‡è§newå…³é”®å­—çš„æ—¶å€™ï¼Œé¦–å…ˆåˆ¤æ–­è¯¥ç±»æ˜¯å¦å·²ç»åŠ è½½ï¼Œå¦‚æœç±»æ²¡æœ‰åŠ è½½ï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œç±»çš„åŠ è½½æœºåˆ¶ï¼ŒåŠ è½½å®Œæˆåå†ä¸ºå¯¹è±¡åˆ†é…ç©ºé—´ã€åˆå§‹åŒ–ç­‰ã€‚è¯¦ç»†è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p>1ã€åŠ è½½é˜¶æ®µï¼š</p><p>1ï¼‰é¦–å…ˆæ£€æŸ¥å½“å‰ç±»æ˜¯å¦è¢«åŠ è½½ï¼Œå¦‚æœæ²¡æœ‰è¢«åŠ è½½ï¼Œæ‰§è¡Œç±»çš„åŠ è½½æœºåˆ¶</p><p>2ï¼‰åŠ è½½ï¼šå°±æ˜¯å°†ç±»çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œå³classæ–‡ä»¶è¯»å…¥å†…å­˜ï¼Œå¹¶ä¸ºä¹‹åˆ›å»ºä¸€ä¸ªClasså¯¹è±¡</p><p>3ï¼‰éªŒè¯ï¼šæ ¡éªŒclassæ–‡ä»¶æ˜¯å¦ç¬¦åˆè™šæ‹Ÿæœºè§„èŒƒ</p><p>4ï¼‰å‡†å¤‡ï¼šä¸ºé™æ€å˜é‡èµ‹é»˜è®¤å€¼</p><p>5ï¼‰è§£æï¼šè™šæ‹Ÿæœºå°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹</p><p>6ï¼‰åˆå§‹åŒ–ï¼šç»™é™æ€å˜é‡èµ‹å®šä¹‰çš„å€¼ã€æ‰§è¡Œé™æ€ä»£ç å—ï¼Œå¦‚æœå­˜åœ¨çˆ¶ç±»ï¼Œå…ˆå¯¹çˆ¶ç±»è¿›è¡Œåˆå§‹åŒ–</p><p>2ã€åˆ›å»ºå¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´</p><p>1ï¼‰é¦–å…ˆä¸ºå¯¹è±¡åœ¨å †ä¸­åˆ†é…å¤§å°åˆé€‚çš„å†…å­˜ç©ºé—´</p><p>2ï¼‰æ¥ç€ä¸ºå®ä¾‹å˜é‡èµ‹é»˜è®¤å€¼</p><p>3ï¼‰è®¾ç½®å¯¹è±¡çš„å¤´ä¿¡æ¯ã€å¯¹è±¡hashç ã€GCåˆ†ä»£å¹´é¾„ã€å…ƒæ•°æ®ä¿¡æ¯ç­‰</p><p>4ï¼‰æ‰§è¡Œæ„é€ å™¨</p>]]></content>
    
    
    <summary type="html">ç±»åŠ è½½è¿‡ç¨‹ã€åŒäº²å§”æ´¾æœºåˆ¶</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="JVM" scheme="https://wuwawawa.github.io/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>ä½è¿ç®—</title>
    <link href="https://wuwawawa.github.io/posts/2633a26.html"/>
    <id>https://wuwawawa.github.io/posts/2633a26.html</id>
    <published>2023-06-29T00:53:14.000Z</published>
    <updated>2023-09-14T01:36:08.715Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼‚æˆ–è¿ç®—">å¼‚æˆ–è¿ç®—</h2><h3 id="è¿ç®—è§„åˆ™">è¿ç®—è§„åˆ™</h3><p>ç›¸åŒå–0ï¼Œç›¸å¼‚å–1</p><table><thead><tr><th style="text-align:center">A</th><th style="text-align:center">B</th><th style="text-align:center">P</th></tr></thead><tbody><tr><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">0</td></tr><tr><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">0</td></tr></tbody></table><p>å¼‚æˆ–ç®—æ³•æœ‰ä¸‰ä¸ªç‰¹å¾ï¼š<br>1ã€ä»»ä½•æ•°å’Œ0åšå¼‚æˆ–è¿ç®—ï¼Œç»“æœä»ç„¶æ˜¯åŸæ¥çš„æ•°ï¼Œå³a âŠ• 0 = aã€‚<br>2ã€ä»»ä½•æ•°å’Œè‡ªèº«åšå¼‚æˆ–è¿ç®—æ—¶ï¼Œç»“æœæ˜¯0ï¼Œå³a âŠ• a=0 ã€‚ æ³¨æ„a âŠ• a âŠ• a = a<br>3ã€å¼‚æˆ–è¿ç®—æ»¡è¶³äº¤æ¢å¾‹å’Œç»“åˆå¾‹ï¼Œå³a âŠ• b âŠ• b = b âŠ• a âŠ• b = a âŠ• ( b âŠ• b ) = a âŠ• 0 = a</p><hr><h3 id="è¿ç”¨åœºæ™¯">è¿ç”¨åœºæ™¯</h3><p>å¦‚æ±‚ä¸€ç»„æ•°æ®ä¸­åªæœ‰ä¸€ä¸ªæ•°å­—æ˜¯å¥‡æ•°é¡¹å…¶ä»–éƒ½æ˜¯å¶æ•°é¡¹ï¼Œæ€ä¹ˆæ‰¾å‡ºå®ƒï¼Œç”¨å¼‚æˆ–å°±å¾ˆæ–¹ä¾¿ã€‚</p><div class="tabs" id="e7ff58e0-e794-4c7c-8891-c48a79720b2c"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e7ff58e0-e794-4c7c-8891-c48a79720b2c-1"><i class="fas fa-seedling"></i>1</button></li><li class="tab"><button type="button" data-href="#e7ff58e0-e794-4c7c-8891-c48a79720b2c-2"><i class="fas fa-leaf"></i>2</button></li><li class="tab"><button type="button" data-href="#e7ff58e0-e794-4c7c-8891-c48a79720b2c-3"><i class="fab fa-apple"></i>3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e7ff58e0-e794-4c7c-8891-c48a79720b2c-1"><blockquote><p>ç»™ä½ ä¸€ä¸ª <strong>éç©º</strong> æ•´æ•°æ•°ç»„ <code>nums</code> ï¼Œé™¤äº†æŸä¸ªå…ƒç´ åªå‡ºç°ä¸€æ¬¡ä»¥å¤–ï¼Œå…¶ä½™æ¯ä¸ªå…ƒç´ å‡å‡ºç°ä¸¤æ¬¡ã€‚æ‰¾å‡ºé‚£ä¸ªåªå‡ºç°äº†ä¸€æ¬¡çš„å…ƒç´ ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">singleNumber</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">eor</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> num : nums)&#123;</span><br><span class="line">        eor ^= num;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> eor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e7ff58e0-e794-4c7c-8891-c48a79720b2c-2"><blockquote><p>è¿›ä¸€æ­¥ï¼Œæœ‰ä¸¤ä¸ªå…ƒç´ (ä¸¤å…ƒç´ ä¸åŒ)å‡ºç°äº†å¥‡æ•°æ¬¡ï¼Œå…¶ä½™å…ƒç´ å‡å‡ºç°å¶æ•°æ¬¡ã€‚æ‰¾åˆ°è¿™ä¸¤ä¸ªå…ƒç´ ã€‚</p></blockquote><p>å‡è®¾è¿™ä¸¤ä¸ªå…ƒç´ åˆ†åˆ«ä¸ºa,b,å…¶ä»–å…ƒç´ ä¸ºotherã€‚åˆ™æœ€åå¼‚æˆ–çš„ç»“æœ<code>eor = a^b</code>,ä¸”eorä¸€å®šä¸ç­‰äº0ã€‚</p><p>é‚£ä¹ˆeorä¸­è‚¯å®šæœ‰æŸä¸€ä½ä¸ç­‰äº0,ä¸º1ã€‚</p><p>å‡è®¾eoråœ¨ç¬¬ä¸‰ä½ä¸Šä¸º1ï¼Œè¯´æ˜aå’Œbåœ¨ç¬¬ä¸‰ä½ä¸Šä¸€å®šæ˜¯ä¸ä¸€æ ·çš„ã€‚</p><p>åœ¨å‡†å¤‡ä¸€ä¸ªå˜é‡eor1,è¿™æ—¶å€™åœ¨è®©eor1å»å¼‚æˆ–æ•°ç»„ä¸­ç¬¬ä¸‰ä½ä¸æ˜¯1çš„æ•°ã€‚è¿™æ—¶å€™çš„ eor1å°±ç­‰äºaæˆ–è€…bäº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span>[] singleNumber(<span class="type">int</span>[] nums) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">eor</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> num : nums)&#123;</span><br><span class="line">        eor ^= num;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">eor1</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">rightOne</span> <span class="operator">=</span> eor &amp; (~eor + <span class="number">1</span>); <span class="comment">// æå–å‡ºæœ€å³è¾¹çš„1</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> num : nums)&#123;</span><br><span class="line">        <span class="comment">// ==0 æˆ–è€… ==rightOne</span></span><br><span class="line">        <span class="keyword">if</span>((num &amp; rightOne) == rightOne)&#123;</span><br><span class="line">            eor1 ^= num;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;eor1,eor1^eor&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e7ff58e0-e794-4c7c-8891-c48a79720b2c-3"><blockquote><p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ <code>nums</code> ï¼Œé™¤æŸä¸ªå…ƒç´ ä»…å‡ºç° <strong>ä¸€æ¬¡</strong> å¤–ï¼Œå…¶ä½™æ¯ä¸ªå…ƒç´ éƒ½æ°å‡ºç° **ä¸‰æ¬¡ ã€‚**è¯·ä½ æ‰¾å‡ºå¹¶è¿”å›é‚£ä¸ªåªå‡ºç°äº†ä¸€æ¬¡çš„å…ƒç´ ã€‚</p></blockquote><p>å¯¹äºå‡ºç°3æ¬¡çš„æ•°å­—,å„äºŒè¿›åˆ¶å‡ºç°çš„æ¬¡æ•°æ˜¯3çš„å€æ•°,ç»Ÿè®¡æ‰€æœ‰æ•°å­—äºŒè¿›åˆ¶ä½ä¸­1å‡ºç°çš„æ¬¡æ•°,å¹¶å¯¹3æ±‚ä½™,ç»“æœåˆ™ä¸ºå‡ºç°ä¸€æ¬¡çš„æ•°å­—.</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1683774393-WZMBxV-image.png" alt="image.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">singleNumber</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">    <span class="type">int</span>[] counts=<span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">32</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;nums.length;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;<span class="number">32</span>;j++)&#123;</span><br><span class="line">            counts[j] += (nums[i] &amp; <span class="number">1</span>);</span><br><span class="line">            nums[i] &gt;&gt;&gt;=<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> ans=<span class="number">0</span>, t=<span class="number">3</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">32</span>;i++)&#123;</span><br><span class="line">        ans &lt;&lt;=<span class="number">1</span>;</span><br><span class="line">        ans |= counts[<span class="number">31</span>-i] % t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>æ‰¾ç¼ºå¤±æ•°</p><blockquote><p>ç»™å®šä¸€ä¸ªåŒ…å« <code>[0, n]</code> ä¸­ <code>n</code> ä¸ªæ•°çš„æ•°ç»„ <code>nums</code> ï¼Œæ‰¾å‡º <code>[0, n]</code> è¿™ä¸ªèŒƒå›´å†…æ²¡æœ‰å‡ºç°åœ¨æ•°ç»„ä¸­çš„é‚£ä¸ªæ•°ã€‚</p></blockquote><p>æˆ‘ä»¬å¯ä»¥å…ˆæ±‚å¾—1-nçš„å¼‚æˆ–xorï¼Œå†ç”¨xorå¯¹numsæ•°ç»„é€ä¸ªå¼‚æˆ–ï¼Œè¿™æ ·æœ€ç»ˆå¾—åˆ°çš„å¼‚æˆ–å’Œè¡¨è¾¾å¼ä¸­ï¼Œåªæœ‰ç¼ºå¤±å…ƒç´ å‡ºç°æ¬¡æ•°ä¸º 11 æ¬¡ï¼Œå…¶ä½™å…ƒç´ å‡å‡ºç°ä¸¤æ¬¡ï¼Œå³æœ€ç»ˆç­”æ¡ˆxorä¸ºç¼ºå¤±å…ƒç´ ã€‚</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">int</span> <span class="title">missingNumber</span><span class="params">(<span class="type">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> n = nums.length;</span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= n; i++) ans ^= i;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i : nums) ans ^= i;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Tip">Tip</h2><blockquote><p>å¯¹äºä¸€ä¸ªæ•´æ•°<code>n</code>ï¼Œ<code>n&amp;(n-1)</code>å¯ä»¥å°†<code>n</code>çš„äºŒè¿›åˆ¶æœ€å³è¾¹å€¼ä¸º<code>1</code>çš„<code>bit</code>ä½ç½®ä¸º<code>0</code>ã€‚</p></blockquote><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E4%BD%8D%E8%BF%90%E7%AE%97tip1.png" alt="ä½è¿ç®—tip1"></p><p>çŠ¶æ€è½¬ç§»çš„æ—¶å€™å¯ç”¨</p><blockquote><p>å­—æ¯å¤§å°å†™è½¬åŒ–</p></blockquote><p>å°å†™å˜å¤§å†™</p><p>å¤§å†™å˜å°å†™</p><p>å­—ç¬¦ ^= 32</p><p>(char) (ch ^ 32)</p>]]></content>
    
    
    <summary type="html">ä½è¿ç®—ã€äºŒè¿›åˆ¶æšä¸¾</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>RabbitMQé«˜çº§ç‰¹æ€§</title>
    <link href="https://wuwawawa.github.io/posts/e42a309a.html"/>
    <id>https://wuwawawa.github.io/posts/e42a309a.html</id>
    <published>2023-06-28T02:08:41.000Z</published>
    <updated>2023-06-29T00:54:17.617Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ¶ˆæ¯å¯é æ€§æŠ•é€’">æ¶ˆæ¯å¯é æ€§æŠ•é€’</h2><p>åœ¨ä½¿ç”¨ RabbitMQ çš„æ—¶å€™ï¼Œä½œä¸ºæ¶ˆæ¯å‘é€æ–¹å¸Œæœ›æœç»ä»»ä½•æ¶ˆæ¯ä¸¢å¤±æˆ–è€…æŠ•é€’å¤±è´¥åœºæ™¯ã€‚RabbitMQ ä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ç§æ–¹å¼ç”¨æ¥æ§åˆ¶æ¶ˆæ¯çš„æŠ•é€’å¯é æ€§æ¨¡å¼ã€‚</p><ul><li>confirm ç¡®è®¤æ¨¡å¼</li><li>return  é€€å›æ¨¡å¼</li></ul><p>rabbitmq æ•´ä¸ªæ¶ˆæ¯æŠ•é€’çš„è·¯å¾„ä¸ºï¼š<br>producerâ€”&gt;rabbitmq brokerâ€”&gt;exchangeâ€”&gt;queueâ€”&gt;consumer</p><p>æ¶ˆæ¯ä» producer åˆ° exchange åˆ™ä¼šè¿”å›ä¸€ä¸ª confirmCallback ã€‚</p><p>æ¶ˆæ¯ä» exchangeâ€“&gt;queue æŠ•é€’å¤±è´¥åˆ™ä¼šè¿”å›ä¸€ä¸ª returnCallback ã€‚</p><p>æˆ‘ä»¬å°†åˆ©ç”¨è¿™ä¸¤ä¸ª callback æ§åˆ¶æ¶ˆæ¯çš„å¯é æ€§æŠ•é€’</p><hr><h3 id="confirm-æ¨¡å¼">confirm æ¨¡å¼</h3><p>1ã€é…ç½®æ–‡ä»¶ publisher-confirm-type: correlated</p><p>2ã€åœ¨rabbitTemplateä¸Šå®šä¹‰ConfirmCallBackå›è°ƒå‡½æ•°</p><div class="tabs" id="6aa50741-31d0-421f-a6b5-56fcd2cf18ef"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6aa50741-31d0-421f-a6b5-56fcd2cf18ef-1"><i class="fas fa-seedling"></i>é…ç½®æ–‡ä»¶</button></li><li class="tab"><button type="button" data-href="#6aa50741-31d0-421f-a6b5-56fcd2cf18ef-2"><i class="fas fa-leaf"></i>ç”Ÿäº§è€…é…ç½®</button></li><li class="tab"><button type="button" data-href="#6aa50741-31d0-421f-a6b5-56fcd2cf18ef-3"><i class="fab fa-apple"></i>ç”Ÿäº§è€…æµ‹è¯•æ¨¡å—</button></li><li class="tab"><button type="button" data-href="#6aa50741-31d0-421f-a6b5-56fcd2cf18ef-4"><i class="fas fa-tree"></i>è¿è¡Œç»“æœ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6aa50741-31d0-421f-a6b5-56fcd2cf18ef-1"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">my_vhost</span></span><br><span class="line">    <span class="comment"># Add this sentence</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6aa50741-31d0-421f-a6b5-56fcd2cf18ef-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;boot_queue_confirm&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME=<span class="string">&quot;boot_exchange_confirm&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1ã€äº¤æ¢æœºçš„é…ç½®</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bootExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">exchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//durable(true) æŒä¹…åŒ–ï¼Œmqé‡å¯ä¹‹åäº¤æ¢æœºè¿˜åœ¨</span></span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.topicExchange(EXCHANGE_NAME).durable(<span class="literal">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2ã€é˜Ÿåˆ—çš„é…ç½®</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bootQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">bootQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_NAME).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3ã€ç»‘å®šå…³ç³»  Binging</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1ã€çŸ¥é“å“ªä¸ªé˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     * 2ã€çŸ¥é“å“ªä¸ªäº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     * 3ã€è®¾ç½®å¯¹åº”çš„ routing key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindQueueExchange</span><span class="params">(<span class="meta">@Qualifier(&quot;bootQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;bootExchange&quot;)</span> Exchange exchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;boot.#&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6aa50741-31d0-421f-a6b5-56fcd2cf18ef-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testConfirm</span><span class="params">()</span>&#123;</span><br><span class="line">    rabbitTemplate.setConfirmCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback() &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> correlationData ç›¸å…³çš„é…ç½®ä¿¡æ¯</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> ack  äº¤æ¢æœºæ˜¯å¦æˆåŠŸæ”¶åˆ°æ¶ˆæ¯ trueï¼šæˆåŠŸ</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> cause å¤±è´¥çš„åŸå› </span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;confirmæ–¹æ³•è¢«æ‰§è¡Œäº†....&quot;</span>);</span><br><span class="line">            <span class="comment">// æ¥æ”¶æˆåŠŸ</span></span><br><span class="line">            <span class="keyword">if</span> (ack)&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;æ¶ˆæ¯æ¥æ”¶æˆåŠŸ&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// æ¥æ”¶å¤±è´¥ï¼ˆæŠŠäº¤æ¢æœºçš„åå­—ï¼Œæ”¹æˆä¸å­˜åœ¨çš„ï¼Œç„¶ååœ¨è¿è¡Œï¼‰</span></span><br><span class="line">                System.out.println(<span class="string">&quot;æ¥æ”¶å¤±è´¥ï¼ŒåŸå› ï¼š&quot;</span>+cause );</span><br><span class="line">                <span class="comment">// å¯¹äºå¤±è´¥ï¼Œåšä¸€äº›å¤„ç†</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// EXCHANGE_NAME</span></span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_NAME,<span class="string">&quot;boot.confirm&quot;</span>,<span class="string">&quot;ä¼ çš„ä¿¡æ¯:message confirm&quot;</span>);</span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;exchange_not_exist&quot;</span>,<span class="string">&quot;boot.confirm&quot;</span>,<span class="string">&quot;message&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6aa50741-31d0-421f-a6b5-56fcd2cf18ef-4"><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">confirmæ–¹æ³•è¢«æ‰§è¡Œäº†....</span><br><span class="line">æ¶ˆæ¯æ¥æ”¶æˆåŠŸ</span><br><span class="line">confirmæ–¹æ³•è¢«æ‰§è¡Œäº†....</span><br><span class="line">æ¥æ”¶å¤±è´¥ï¼ŒåŸå› ï¼šchannel error<span class="punctuation">;</span> protocol <span class="keyword">method</span>: #<span class="keyword">method</span>&lt;<span class="title function_">channel</span>.<span class="title function_">close</span>&gt;<span class="params">(reply-code=404, reply-text=NOT_FOUND - no exchange <span class="string">&#x27;exchange_not_exist&#x27;</span> <span class="keyword">in</span> vhost <span class="string">&#x27;my_vhost&#x27;</span>, <span class="keyword">class</span>-id=60, <span class="keyword">method</span>-id=40)</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="returnæ¨¡å¼">returnæ¨¡å¼</h3><p>å›é€€æ¨¡å¼ï¼šå½“æ¶ˆæ¯å‘é€ç»™Exchangeåï¼Œè·¯ç”±å™¨è·¯ç”±åˆ°Queueå¤±è´¥ä¹‹åï¼Œæ‰ä¼šæ‰§è¡ŒReruenCallBack</p><ol><li><p>å¼€å¯å›é€€æ¨¡å¼</p><p>publisher-returns: true</p></li><li><p>è®¾ç½®ReturnCallBack</p></li><li><p>è®¾ç½®Exchangeå¤„ç†æ¶ˆæ¯çš„æ¨¡å¼</p><p>3.1 å¦‚æœæ¶ˆæ¯æ²¡æœ‰è·¯ç”±åˆ°Queueï¼Œåˆ™ä¸¢å¼ƒ(é»˜è®¤)</p><p>3.2 å¦‚æœæ¶ˆæ¯æ²¡æœ‰è·¯ç”±åˆ°Queueï¼Œè¿”å›ç»™æ¶ˆæ¯å‘é€</p><p>â€‹rabbitTemplate.setMandatory(true);</p></li></ol><mark class="hl-label blue">ç”Ÿäº§è€…æµ‹è¯•æ¨¡å—</mark> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testReturn</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®äº¤æ¢æœºå¤„ç†å¤±è´¥æ¶ˆæ¯æ¨¡å¼</span></span><br><span class="line">    rabbitTemplate.setMandatory(<span class="literal">true</span>);</span><br><span class="line">    rabbitTemplate.setReturnCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ReturnCallback()&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ¶ˆæ¯å¤±è´¥äº†ï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•</span></span><br><span class="line"><span class="comment">         * æ³¨æ„ï¼šè¦è¿›è¡Œå¤„ç†å¤±è´¥çš„å¤„ç†  rabbitTemplate.setMandatory(true);</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> message æ¶ˆæ¯å¯¹è±¡</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> replyCode é”™è¯¯ç </span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> replyText é”™è¯¯ä¿¡æ¯</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> exchange äº¤æ¢æœº</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> routingKey è·¯ç”±é”®</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(Message message, <span class="type">int</span> replyCode, String replyText, String exchange, String routingKey)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;return æ‰§è¡Œäº†&quot;</span>);</span><br><span class="line">            System.out.println(message);</span><br><span class="line">            System.out.println(replyCode);</span><br><span class="line">            System.out.println(replyText);</span><br><span class="line">            System.out.println(exchange);</span><br><span class="line">            System.out.println(routingKey);</span><br><span class="line">            <span class="comment">// å¤±è´¥çš„è¯ï¼Œå°±è¦è¿›è¡Œæƒ³å¯¹åº”çš„å¤„ç†</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„keyå¡«çš„æ˜¯é”™è¯¯çš„ï¼Œè¿™æ ·å°±ä¸èƒ½åˆ°Queue</span></span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_NAME,<span class="string">&quot;boot1.confirm&quot;</span>,<span class="string">&quot;ä¼ çš„ä¿¡æ¯:message confirm&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><mark class="hl-label red">è¾“å‡º</mark> <figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">return æ‰§è¡Œäº†</span><br><span class="line">(Body:<span class="string">&#x27;ä¼ çš„ä¿¡æ¯:message confirm&#x27;</span> MessageProperties [headers=&#123;&#125;, <span class="attribute">contentType</span>=text/plain, <span class="attribute">contentEncoding</span>=UTF-8, <span class="attribute">contentLength</span>=0, <span class="attribute">receivedDeliveryMode</span>=PERSISTENT, <span class="attribute">priority</span>=0, <span class="attribute">deliveryTag</span>=0])</span><br><span class="line">312</span><br><span class="line">NO_ROUTE</span><br><span class="line">boot_exchange_confirm</span><br><span class="line">boot1.confirm</span><br></pre></td></tr></table></figure><hr><h2 id="Consumer-ACK">Consumer ACK</h2><p>ackæŒ‡Acknowledgeï¼Œç¡®è®¤ã€‚ è¡¨ç¤ºæ¶ˆè´¹ç«¯æ”¶åˆ°æ¶ˆæ¯åçš„ç¡®è®¤æ–¹å¼ã€‚æœ‰ä¸‰ç§ç¡®è®¤æ–¹å¼ï¼š</p><ul><li>è‡ªåŠ¨ç¡®è®¤ï¼šacknowledge=â€œnoneâ€</li><li>æ‰‹åŠ¨ç¡®è®¤ï¼šacknowledge=â€œmanualâ€</li><li>æ ¹æ®å¼‚å¸¸æƒ…å†µç¡®è®¤ï¼šacknowledge=â€œautoâ€</li></ul><p>å…¶ä¸­è‡ªåŠ¨ç¡®è®¤æ˜¯æŒ‡ï¼Œå½“æ¶ˆæ¯ä¸€æ—¦è¢«Consumeræ¥æ”¶åˆ°ï¼Œåˆ™è‡ªåŠ¨ç¡®è®¤æ”¶åˆ°ï¼Œå¹¶å°†ç›¸åº” message ä» RabbitMQ çš„æ¶ˆæ¯ç¼“å­˜ä¸­ç§»é™¤ã€‚ä½†æ˜¯åœ¨å®é™…ä¸šåŠ¡å¤„ç†ä¸­ï¼Œå¾ˆå¯èƒ½æ¶ˆæ¯æ¥æ”¶åˆ°ï¼Œä¸šåŠ¡å¤„ç†å‡ºç°å¼‚å¸¸ï¼Œé‚£ä¹ˆè¯¥æ¶ˆæ¯å°±ä¼šä¸¢å¤±ã€‚å¦‚æœè®¾ç½®äº†æ‰‹åŠ¨ç¡®è®¤æ–¹å¼ï¼Œåˆ™éœ€è¦åœ¨ä¸šåŠ¡å¤„ç†æˆåŠŸåï¼Œè°ƒç”¨channel.basicAck()ï¼Œæ‰‹åŠ¨ç­¾æ”¶ï¼Œå¦‚æœå‡ºç°å¼‚å¸¸ï¼Œåˆ™è°ƒç”¨channel.basicNack()æ–¹æ³•ï¼Œè®©å…¶è‡ªåŠ¨é‡æ–°å‘é€æ¶ˆæ¯ã€‚</p><mark class="hl-label blue">å®ç°æ­¥éª¤</mark> <p>1ã€è®¾ç½®æ‰‹åŠ¨ç­¾æ”¶ã€‚ä¿®æ”¹é…ç½®æ–‡ä»¶<br>2ã€@RabbitListeneræ³¨è§£ä¸­ï¼Œè¦è¿›è¡ŒackMode = &quot;MANUAL&quot;çš„è®¾ç½®<br>3ã€ç›‘å¬å™¨ç±»å®ç°ï¼š ChannelAwareMessageListeneræ¥å£<br>4ã€å¤„ç†æˆåŠŸï¼Œè°ƒç”¨channelçš„basicNack()ç­¾æ”¶<br>5ã€å¦‚æœæ¶ˆæ¯å¤„ç†å¤±è´¥ï¼Œè°ƒç”¨channelçš„basicNack()æ‹’ç»ç­¾æ”¶</p><div class="tabs" id="2e047fe7-9461-4f2a-9a1d-de7b5111b398"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2e047fe7-9461-4f2a-9a1d-de7b5111b398-1"><i class="fas fa-award"></i>é…ç½®æ–‡ä»¶</button></li><li class="tab"><button type="button" data-href="#2e047fe7-9461-4f2a-9a1d-de7b5111b398-2"><i class="fas fa-baseball-ball"></i>æ¶ˆè´¹è€…ç±»</button></li><li class="tab"><button type="button" data-href="#2e047fe7-9461-4f2a-9a1d-de7b5111b398-3"><i class="fas fa-bone"></i>è¿è¡Œç»“æœ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2e047fe7-9461-4f2a-9a1d-de7b5111b398-1"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">my_vhost</span></span><br><span class="line">    <span class="comment"># Add this sentence</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">direct:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">manual</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2e047fe7-9461-4f2a-9a1d-de7b5111b398-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ²¡æœ‰å‡ºç°å¼‚å¸¸å°±ä½¿ç”¨basicAckæ¥è¿›è¡Œæ‰‹åŠ¨ç­¾æ”¶</span></span><br><span class="line"><span class="comment"> * å‡ºç°å¼‚å¸¸å°±è¿›è¡ŒbasicNackæ¥è¿›è¡Œé‡æ–°å°è¯•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AckListener</span> <span class="keyword">implements</span> <span class="title class_">ChannelAwareMessageListener</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ackMode = &quot;MANUAL&quot;è¦è¿›è¡Œè¿™ä¸ªçš„è®¾ç½®ï¼Œä¸ç„¶å°±è¿˜æ˜¯è‡ªåŠ¨çš„ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰å†²çªï¼Œä¼šå‡ºç°é”™è¯¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;boot_queue_confirm&quot;,ackMode = &quot;MANUAL&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> message.getMessageProperties().getDeliveryTag();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1ã€æ¥æ”¶æ¶ˆæ¯</span></span><br><span class="line">            System.out.println(message.getBody().toString());</span><br><span class="line">            <span class="comment">// 2ã€å¤„ç†ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">            System.out.println(<span class="string">&quot;å¤„ç†ä¸šåŠ¡é€»è¾‘&quot;</span>);</span><br><span class="line">            <span class="comment">// å¤±è´¥çš„å¤„ç†</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">3</span>/<span class="number">0</span>;</span><br><span class="line">            <span class="comment">// æ‰‹åŠ¨ç­¾æ”¶</span></span><br><span class="line">            channel.basicAck(deliveryTag,<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// æ‹’æ¥ç­¾æ”¶ ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šrequeueï¼šé‡å›é˜Ÿåˆ—ï¼Œè®¾ç½®æˆtrueï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¼šå›åˆ°queueï¼Œä¼šé‡æ–°å‘é€æ¶ˆæ¯ç»™æ¶ˆè´¹ç«¯ã€‚</span></span><br><span class="line">            <span class="comment">// å‡ºé”™çš„è¯ï¼Œå°±ä¼šä¸€ç›´è¿›è¡Œæ‰§è¡Œï¼Œé‡æ–°å°è¯•</span></span><br><span class="line">            channel.basicNack(deliveryTag,<span class="literal">true</span>,<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2e047fe7-9461-4f2a-9a1d-de7b5111b398-3"><p>è¿è¡Œint i = 3/0; ä¼šä¸€ç›´å‡ºé”™ï¼Œç„¶åå°±ä¼šè¿›è¡ŒæŠ¥é”™çš„å¤„ç†</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[B<span class="title">@4</span>a<span class="number">8688</span>bc</span><br><span class="line">å¤„ç†ä¸šåŠ¡é€»è¾‘</span><br><span class="line">[B<span class="title">@1843</span><span class="keyword">c</span><span class="number">046</span></span><br><span class="line">å¤„ç†ä¸šåŠ¡é€»è¾‘</span><br><span class="line">[B<span class="title">@7628</span><span class="keyword">c</span><span class="number">07</span></span><br><span class="line">å¤„ç†ä¸šåŠ¡é€»è¾‘</span><br><span class="line">[B<span class="title">@63</span>bc<span class="number">4756</span></span><br><span class="line">å¤„ç†ä¸šåŠ¡é€»è¾‘</span><br><span class="line">[B<span class="title">@1</span>d<span class="number">01e0</span>f<span class="number">5</span></span><br><span class="line">å¤„ç†ä¸šåŠ¡é€»è¾‘</span><br><span class="line">[B<span class="title">@1</span>b<span class="number">4652e3</span></span><br><span class="line">å¤„ç†ä¸šåŠ¡é€»è¾‘</span><br><span class="line">[B<span class="title">@857</span>e<span class="number">738</span></span><br><span class="line">å¤„ç†ä¸šåŠ¡é€»è¾‘</span><br><span class="line">[B<span class="title">@9509793</span></span><br><span class="line">å¤„ç†ä¸šåŠ¡é€»è¾‘</span><br><span class="line">[B<span class="title">@1</span>b<span class="number">44</span><span class="keyword">c</span><span class="number">804</span></span><br><span class="line">å¤„ç†ä¸šåŠ¡é€»è¾‘</span><br><span class="line">[B<span class="title">@32</span>bc<span class="number">40</span><span class="keyword">c</span><span class="number">5</span></span><br><span class="line">å¤„ç†ä¸šåŠ¡é€»è¾‘</span><br><span class="line">.....</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h2 id="æ¶ˆæ¯å¯é æ€§æ€»ç»“">æ¶ˆæ¯å¯é æ€§æ€»ç»“</h2><ol><li>æŒä¹…åŒ–<ul><li>exchangeè¦æŒä¹…åŒ–</li><li>queueè¦æŒä¹…åŒ–</li><li>messageè¦æŒä¹…åŒ–</li></ul></li><li>ç”Ÿäº§æ–¹ç¡®è®¤Confirm</li><li>æ¶ˆè´¹æ–¹ç¡®è®¤Ack</li><li>Brokeré«˜å¯ç”¨</li></ol><hr><h2 id="æ¶ˆè´¹ç«¯é™æµ">æ¶ˆè´¹ç«¯é™æµ</h2><p>å½“æˆ‘ä»¬å¤„ç†ä¿¡æ¯çš„Aç³»ç»Ÿæ¯ç§’åªèƒ½å¤„ç†1000ä¸ªè¯·æ±‚ï¼Œä½†æ˜¯ç”¨æˆ·çœŸæ­£çš„è¯·æ±‚æ¯ç§’å¯ä»¥è¾¾åˆ°5000æ¬¡ï¼Œä¸ºäº†é˜²æ­¢Aç³»ç»Ÿå®•æœºï¼Œæˆ‘ä»¬å…ˆæŠŠæ•°æ®å­˜æ”¾åœ¨MQä¸­ï¼Œç„¶åAç³»ç»Ÿæ¯ç§’ä»MQä¸­æ‹‰å–1000ä¸ªæ¥è¿›è¡Œå¤„ç†ã€‚</p><mark class="hl-label blue">å®ç°æ­¥éª¤</mark> <p>1ã€é…ç½®æ–‡ä»¶ä¸­è¦è®¾ç½®æˆæ‰‹åŠ¨ï¼š acknowledge-mode: manual<br>2ã€é…ç½®æ–‡ä»¶ä¸­è¦è®¾ç½®æ‹‰å–æ¡æ•°ï¼š prefetch: 1<br>3ã€æ¶ˆè´¹è€…è¿›è¡Œç­¾æ”¶å¤„ç†ï¼šchannel.basicAck</p><div class="tabs" id="218eee53-a59f-4896-958e-d12b3633ca8b"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#218eee53-a59f-4896-958e-d12b3633ca8b-1"><i class="fas fa-cat"></i>é…ç½®æ–‡ä»¶</button></li><li class="tab"><button type="button" data-href="#218eee53-a59f-4896-958e-d12b3633ca8b-2"><i class="fas fa-horse"></i>ç”Ÿäº§è€…å‘é€10æ¡æ•°æ®</button></li><li class="tab"><button type="button" data-href="#218eee53-a59f-4896-958e-d12b3633ca8b-3"><i class="fas fa-dove"></i>æ¶ˆè´¹è€…</button></li><li class="tab"><button type="button" data-href="#218eee53-a59f-4896-958e-d12b3633ca8b-4"><i class="fas fa-dragon"></i>ç»“æœ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="218eee53-a59f-4896-958e-d12b3633ca8b-1"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">my_vhost</span></span><br><span class="line">    <span class="comment"># Add this sentence</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">direct:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">manual</span></span><br><span class="line">        <span class="attr">prefetch:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="218eee53-a59f-4896-958e-d12b3633ca8b-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLimit</span><span class="params">()</span>&#123;</span><br><span class="line">    rabbitTemplate.setMandatory(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// 10æ¡æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(EXCHANGE_NAME,<span class="string">&quot;boot.confirm&quot;</span>,<span class="string">&quot;ä¼ çš„ä¿¡æ¯:message confirmï¼Œç¬¬&quot;</span>+i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="218eee53-a59f-4896-958e-d12b3633ca8b-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœåŠ¡è´¨é‡ä¿è¯</span></span><br><span class="line"><span class="comment"> * é™æµæœºåˆ¶ï¼š Consumer</span></span><br><span class="line"><span class="comment"> * 1ã€ackè®¾ç½®ä¸ºæ‰‹åŠ¨ç¡®è®¤</span></span><br><span class="line"><span class="comment"> * 2ã€listener-containeré…ç½®å±æ€§</span></span><br><span class="line"><span class="comment"> * prefetch = 2ï¼Œè¡¨ç¤ºæ¶ˆè´¹ç«¯æ¯æ¬¡ä»mqæ‹‰å–2æ¡æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ï¼Œæ¶ˆè´¹å®Œæ¯•ä¹‹åï¼Œåœ¨æ‹‰å–2æ¡</span></span><br><span class="line"><span class="comment"> * prefetch: 2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QosListener</span> <span class="keyword">implements</span> <span class="title class_">ChannelAwareMessageListener</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ackMode = &quot;MANUAL&quot;è¦è¿›è¡Œè¿™ä¸ªçš„è®¾ç½®ï¼Œä¸ç„¶å°±è¿˜æ˜¯è‡ªåŠ¨çš„ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰å†²çªï¼Œä¼šå‡ºç°é”™è¯¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;boot_queue_confirm&quot;,ackMode = &quot;MANUAL&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ä½¿ç”¨prefetchè·å–æ¶ˆæ¯ä¸º: &quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        <span class="comment">// ç­¾æ”¶å¤„ç†(å¦‚æœæ²¡æœ‰ç­¾æ”¶ï¼Œé‚£ä¹ˆå°±åªèƒ½æ¶ˆè´¹prefetchæ¡ä¿¡æ¯)</span></span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="218eee53-a59f-4896-958e-d12b3633ca8b-4"><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ä½¿ç”¨prefetchè·å–æ¶ˆæ¯ä¸º: ä¼ çš„ä¿¡æ¯:<span class="keyword">message</span> confirmï¼Œç¬¬<span class="number">1</span></span><br><span class="line">ä½¿ç”¨prefetchè·å–æ¶ˆæ¯ä¸º: ä¼ çš„ä¿¡æ¯:<span class="keyword">message</span> confirmï¼Œç¬¬<span class="number">3</span></span><br><span class="line">ä½¿ç”¨prefetchè·å–æ¶ˆæ¯ä¸º: ä¼ çš„ä¿¡æ¯:<span class="keyword">message</span> confirmï¼Œç¬¬<span class="number">5</span></span><br><span class="line">ä½¿ç”¨prefetchè·å–æ¶ˆæ¯ä¸º: ä¼ çš„ä¿¡æ¯:<span class="keyword">message</span> confirmï¼Œç¬¬<span class="number">7</span></span><br><span class="line">ä½¿ç”¨prefetchè·å–æ¶ˆæ¯ä¸º: ä¼ çš„ä¿¡æ¯:<span class="keyword">message</span> confirmï¼Œç¬¬<span class="number">9</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h2 id="TTL">TTL</h2><p>TTL å…¨ç§° Time To Liveï¼ˆå­˜æ´»æ—¶é—´/è¿‡æœŸæ—¶é—´ï¼‰ã€‚</p><p>å½“æ¶ˆæ¯åˆ°è¾¾å­˜æ´»æ—¶é—´åï¼Œè¿˜æ²¡æœ‰è¢«æ¶ˆè´¹ï¼Œä¼šè¢«è‡ªåŠ¨æ¸…é™¤ã€‚</p><p>RabbitMQå¯ä»¥å¯¹æ¶ˆæ¯è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä¹Ÿå¯ä»¥å¯¹æ•´ä¸ªé˜Ÿåˆ—ï¼ˆQueueï¼‰è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚</p><mark class="hl-label blue">å®ç°æ­¥éª¤</mark> <p>1ã€æŠŠé˜Ÿåˆ—è®¾ç½®æˆå¸¦æœ‰ttlæ—¶é—´çš„é˜Ÿåˆ—ï¼Œå¯¹æ•´ä¸ªé˜Ÿåˆ—æ¶ˆæ¯ç»Ÿä¸€è¿‡æœŸ<br>2ã€æ¶ˆæ¯çš„å•ç‹¬è¿‡æœŸå¤„ç†ï¼Œå½“æ¶ˆæ¯åœ¨é˜Ÿåˆ—å¤´éƒ¨æ—¶ï¼Œä¼šå•ç‹¬åˆ¤æ–­è¿™ä¸€æ¶ˆæ¯æ˜¯å¦è¿‡æœŸ<br>3ã€å¦‚æœä¸¤è€…éƒ½è¿›è¡Œè®¾ç½®äº†ï¼Œä¼šé€‰æ‹©æ—¶é—´çŸ­çš„é‚£ä¸ª</p><div class="tabs" id="ccf40020-d097-43b5-bea0-9b3ece411ec9"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ccf40020-d097-43b5-bea0-9b3ece411ec9-1"><i class="fas fa-seedling"></i>é…ç½®ç±»</button></li><li class="tab"><button type="button" data-href="#ccf40020-d097-43b5-bea0-9b3ece411ec9-2"><i class="fas fa-leaf"></i>ç”Ÿäº§è€…æ— å•ç‹¬è¿‡æœŸå¤„ç†</button></li><li class="tab"><button type="button" data-href="#ccf40020-d097-43b5-bea0-9b3ece411ec9-3"><i class="fab fa-apple"></i>ç”Ÿäº§è€…é˜Ÿåˆ—è¿‡æœŸå¤„ç†</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ccf40020-d097-43b5-bea0-9b3ece411ec9-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;boot_queue_confirm&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME=<span class="string">&quot;boot_exchange_confirm&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1ã€äº¤æ¢æœºçš„é…ç½®</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bootExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">exchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//durable(true) æŒä¹…åŒ–ï¼Œmqé‡å¯ä¹‹åäº¤æ¢æœºè¿˜åœ¨</span></span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.topicExchange(EXCHANGE_NAME).durable(<span class="literal">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2ã€é˜Ÿåˆ—çš„é…ç½®</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bootQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">bootQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//# Modify this sentence</span></span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_NAME).ttl(<span class="number">10000</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3ã€ç»‘å®šå…³ç³»  Binging</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1ã€çŸ¥é“å“ªä¸ªé˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     * 2ã€çŸ¥é“å“ªä¸ªäº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     * 3ã€è®¾ç½®å¯¹åº”çš„ routing key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindQueueExchange</span><span class="params">(<span class="meta">@Qualifier(&quot;bootQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;bootExchange&quot;)</span> Exchange exchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;boot.#&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ccf40020-d097-43b5-bea0-9b3ece411ec9-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testReturnttl1</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(EXCHANGE_NAME,<span class="string">&quot;boot.confirm&quot;</span>,<span class="string">&quot;ttlçš„å¤„ç†ï¼š&quot;</span>+i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ccf40020-d097-43b5-bea0-9b3ece411ec9-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testReturnttl2</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// æ¶ˆæ¯åå¤„ç†å¯¹è±¡ï¼Œè®¾ç½®ä¸€äº›æ¶ˆæ¯çš„å‚æ•°ä¿¡æ¯</span></span><br><span class="line">    <span class="type">MessagePostProcessor</span> <span class="variable">messagePostProcessor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessagePostProcessor</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Message <span class="title function_">postProcessMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> AmqpException &#123;</span><br><span class="line">            <span class="comment">// 1ã€è®¾ç½®messageçš„ä¿¡æ¯(æ¶ˆæ¯çš„è¿‡æœŸæ—¶é—´)</span></span><br><span class="line">            message.getMessageProperties().setExpiration(<span class="string">&quot;5000&quot;</span>);</span><br><span class="line">            <span class="comment">// 2ã€è¿”å›è¯¥æ¶ˆæ¯</span></span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// æ¶ˆæ¯å•ç‹¬è¿‡æœŸ</span></span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_NAME,<span class="string">&quot;boot.confirm&quot;</span>,<span class="string">&quot;ttlçš„å¤„ç†ï¼š&quot;</span>,messagePostProcessor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h2 id="æ­»ä¿¡é˜Ÿåˆ—">æ­»ä¿¡é˜Ÿåˆ—</h2><p>æ­»ä¿¡é˜Ÿåˆ—ï¼Œè‹±æ–‡ç¼©å†™ï¼šDLX  ã€‚Dead Letter Exchangeï¼ˆæ­»ä¿¡äº¤æ¢æœºï¼‰ï¼Œå½“æ¶ˆæ¯æˆä¸ºDead messageåï¼Œå¯ä»¥è¢«é‡æ–°å‘é€åˆ°å¦ä¸€ä¸ªäº¤æ¢æœºï¼Œè¿™ä¸ªäº¤æ¢æœºå°±æ˜¯DLXã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230627200803362.png" alt="image-20230627200803362"></p><p>æ¶ˆæ¯æˆä¸ºæ­»ä¿¡çš„ä¸‰ç§æƒ…å†µï¼š</p><ol><li>é˜Ÿåˆ—æ¶ˆæ¯é•¿åº¦åˆ°è¾¾é™åˆ¶</li><li>æ¶ˆè´¹è€…æ‹’æ¥æ¶ˆè´¹æ¶ˆæ¯ï¼ŒbasicNack/basicReject,å¹¶ä¸”ä¸æŠŠæ¶ˆæ¯é‡æ–°æ”¾å…¥åŸç›®æ ‡é˜Ÿåˆ—,requeue=false</li><li>åŸé˜Ÿåˆ—å­˜åœ¨æ¶ˆæ¯è¿‡æœŸè®¾ç½®ï¼Œæ¶ˆæ¯åˆ°è¾¾è¶…æ—¶æ—¶é—´æœªè¢«æ¶ˆè´¹</li></ol><p>ç”Ÿäº§è€… --&gt; æ­£å¸¸äº¤æ¢æœº --&gt;æ­£å¸¸é˜Ÿåˆ—â€“&gt;æ¶ˆæ¯æ­»ä¿¡å----&gt;æ­»ä¿¡äº¤æ¢æœº----&gt;æ­»ä¿¡é˜Ÿåˆ— ----&gt;æ¶ˆè´¹è€…</p><div class="tabs" id="0249cde2-f058-4100-9b70-fbee81d0e1f6"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#0249cde2-f058-4100-9b70-fbee81d0e1f6-1"><i class="fas fa-cat"></i>é…ç½®æ–‡ä»¶</button></li><li class="tab"><button type="button" data-href="#0249cde2-f058-4100-9b70-fbee81d0e1f6-2"><i class="fas fa-horse"></i>é…ç½®ç±»</button></li><li class="tab"><button type="button" data-href="#0249cde2-f058-4100-9b70-fbee81d0e1f6-3"><i class="fas fa-dragon"></i>æµ‹è¯•1</button></li><li class="tab"><button type="button" data-href="#0249cde2-f058-4100-9b70-fbee81d0e1f6-4"><i class="fas fa-heartbeat"></i>æµ‹è¯•2</button></li><li class="tab"><button type="button" data-href="#0249cde2-f058-4100-9b70-fbee81d0e1f6-5"><i class="fas fa-cookie-bite"></i>æµ‹è¯•3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="0249cde2-f058-4100-9b70-fbee81d0e1f6-1"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">my_vhost</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">direct:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">manual</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0249cde2-f058-4100-9b70-fbee81d0e1f6-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfigDLX</span> &#123;</span><br><span class="line">    <span class="comment">// æ­£å¸¸é˜Ÿåˆ—å’Œäº¤æ¢æœº</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;boot_queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME=<span class="string">&quot;boot_exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é…ç½®æ­»ä¿¡é˜Ÿåˆ—å’Œæ­»ä¿¡äº¤æ¢æœº</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME_DLX</span> <span class="operator">=</span> <span class="string">&quot;boot_queue_dlx&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME_DLX=<span class="string">&quot;boot_exchange_dlx&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1ã€äº¤æ¢æœºçš„é…ç½®</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bootExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">exchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//durable(true) æŒä¹…åŒ–ï¼Œmqé‡å¯ä¹‹åäº¤æ¢æœºè¿˜åœ¨</span></span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.topicExchange(EXCHANGE_NAME).durable(<span class="literal">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­»ä¿¡äº¤æ¢æœº</span></span><br><span class="line">    <span class="meta">@Bean(&quot;ExchangeDLX&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">exchangeDlx</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.topicExchange(EXCHANGE_NAME_DLX).durable(<span class="literal">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2ã€æ­£å¸¸é˜Ÿåˆ—å’Œæ­»ä¿¡äº¤æ¢æœº</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bootQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">bootQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">        <span class="comment">// 1ã€æ­»ä¿¡äº¤æ¢æœºåç§°</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, EXCHANGE_NAME_DLX);</span><br><span class="line">        <span class="comment">// 2ã€æ­»ä¿¡äº¤æ¢æœºçš„key</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;boot.dlx.hh&quot;</span>);</span><br><span class="line">        <span class="comment">// 3ã€è®¾ç½®é˜Ÿåˆ—çš„è¿‡æœŸæ—¶é—´</span></span><br><span class="line">        args.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">10000</span>);</span><br><span class="line">        <span class="comment">// 4ã€è®¾ç½®é˜Ÿåˆ—çš„é•¿åº¦é™åˆ¶</span></span><br><span class="line">        args.put(<span class="string">&quot;x-max-length&quot;</span>,<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_NAME).withArguments(args).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­»ä¿¡é˜Ÿåˆ—é…ç½®</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bootQueueDLX&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">bootQueueDLX</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_NAME_DLX).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ­£å¸¸äº¤æ¢æœºç»‘å®šæ­£å¸¸é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     * 1ã€çŸ¥é“å“ªä¸ªé˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     * 2ã€çŸ¥é“å“ªä¸ªäº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     * 3ã€è®¾ç½®å¯¹åº”çš„ routing key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindQueueExchange</span><span class="params">(<span class="meta">@Qualifier(&quot;bootQueue&quot;)</span> Queue queue,<span class="meta">@Qualifier(&quot;bootExchange&quot;)</span> Exchange exchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;boot.dlx.#&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­»ä¿¡äº¤æ¢æœºï¼Œå’Œæ­»ä¿¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindQueueExchangeDlx</span><span class="params">(<span class="meta">@Qualifier(&quot;bootQueueDLX&quot;)</span> Queue queue,<span class="meta">@Qualifier(&quot;ExchangeDLX&quot;)</span> Exchange exchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;boot.dlx.#&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0249cde2-f058-4100-9b70-fbee81d0e1f6-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 1ã€ä¸å¼€å¯æ¶ˆè´¹è€…ï¼Œæµ‹è¯•è¿‡æœŸæ—¶é—´ (10sï¼Œä¹‹åä¼šè·‘åˆ°æ­»ä¿¡é˜Ÿåˆ—ä¸­)</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;boot_exchange&quot;</span>,<span class="string">&quot;boot.dlx.hh&quot;</span>,<span class="string">&quot;æ­»ä¿¡æµ‹è¯•ï¼š&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>10sä¹‹å(æ­»ä¿¡é˜Ÿåˆ—ä¸­å¤šä¸€æ¡)</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230627202313086.png" alt="image-20230627202313086"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0249cde2-f058-4100-9b70-fbee81d0e1f6-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 2ã€ä¸å¼€å¯æ¶ˆè´¹è€…ï¼Œæµ‹è¯•é•¿åº¦ï¼Œæœ‰10ä¸ªæ¶ˆæ¯åœ¨æ­£å¸¸é˜Ÿåˆ—ï¼Œæœ‰10ä¸ªåœ¨æ­»ä¿¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;boot_exchange&quot;</span>,<span class="string">&quot;boot.dlx.hh&quot;</span>,<span class="string">&quot;æ­»ä¿¡æµ‹è¯•ï¼š&quot;</span>+i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰10ä¸ªæ¶ˆæ¯åœ¨æ­£å¸¸é˜Ÿåˆ—ï¼Œæœ‰10ä¸ªåœ¨æ­»ä¿¡é˜Ÿåˆ—</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230627202546934.png" alt="image-20230627202546934"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0249cde2-f058-4100-9b70-fbee81d0e1f6-5"><p>æ¶ˆæ¯æ‹’æ”¶ (è®©æ¶ˆè´¹è€…ä¸æ¥å—,æ¶ˆè´¹è€…å‡ºç°é”™è¯¯ç„¶åä¸é‡å›é˜Ÿåˆ—)</p><div class="tabs" id="d5b0d24e-8f0e-4b32-94c2-f8f9ffcdff31"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d5b0d24e-8f0e-4b32-94c2-f8f9ffcdff31-1"><i class="fas fa-dove"></i>æ¶ˆè´¹è€…æ‹’æ”¶</button></li><li class="tab"><button type="button" data-href="#d5b0d24e-8f0e-4b32-94c2-f8f9ffcdff31-2"><i class="fas fa-anchor"></i>å‘é€æ¶ˆæ¯</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d5b0d24e-8f0e-4b32-94c2-f8f9ffcdff31-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DLXListener</span> <span class="keyword">implements</span> <span class="title class_">ChannelAwareMessageListener</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ackMode = &quot;MANUAL&quot;è¦è¿›è¡Œè¿™ä¸ªçš„è®¾ç½®ï¼Œä¸ç„¶å°±è¿˜æ˜¯è‡ªåŠ¨çš„ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰å†²çªï¼Œä¼šå‡ºç°é”™è¯¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;boot_queue_dlx&quot;,ackMode = &quot;MANUAL&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> message.getMessageProperties().getDeliveryTag();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1ã€æ¥æ”¶æ¶ˆæ¯</span></span><br><span class="line">            System.out.println(<span class="string">&quot;è·å–åˆ°ï¼š &quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">            <span class="comment">// 2ã€å¤„ç†ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">            System.out.println(<span class="string">&quot;å¤„ç†ä¸šåŠ¡é€»è¾‘&quot;</span>);</span><br><span class="line">            <span class="comment">// add this sentence</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">10</span>/<span class="number">0</span>;</span><br><span class="line">            <span class="comment">// æ‰‹åŠ¨ç­¾æ”¶</span></span><br><span class="line">            channel.basicAck(deliveryTag,<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// æ‹’æ¥ç­¾æ”¶ ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šrequeueï¼šé‡å›é˜Ÿåˆ—ï¼Œè®¾ç½®æˆtrueï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¼šå›åˆ°queueï¼Œä¼šé‡æ–°å‘é€æ¶ˆæ¯ç»™æ¶ˆè´¹ç«¯ã€‚</span></span><br><span class="line">            System.out.println(<span class="string">&quot;å‡ºç°å¼‚å¸¸ï¼Œæ‹’ç»æ¥æ”¶ã€‚ã€‚ä¸é‡å›é˜Ÿåˆ—&quot;</span>);</span><br><span class="line">            <span class="comment">// å‡ºé”™çš„è¯ï¼Œå°±ä¼šä¸€ç›´è¿›è¡Œæ‰§è¡Œï¼Œé‡æ–°å°è¯•</span></span><br><span class="line">            channel.basicNack(deliveryTag,<span class="literal">true</span>,<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d5b0d24e-8f0e-4b32-94c2-f8f9ffcdff31-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 3ã€æ¶ˆæ¯æ‹’æ”¶ </span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;boot_exchange&quot;</span>,<span class="string">&quot;boot.dlx.hh&quot;</span>,<span class="string">&quot;æ­»ä¿¡æµ‹è¯•ï¼š&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h2 id="å»¶è¿Ÿé˜Ÿåˆ—">å»¶è¿Ÿé˜Ÿåˆ—</h2><p>å»¶è¿Ÿé˜Ÿåˆ—ï¼šæ¶ˆæ¯è¿›å…¥é˜Ÿåˆ—åä¸ä¼šç«‹å³è¢«æ¶ˆè´¹ï¼Œåªæœ‰åˆ°è¾¾æŒ‡å®šæ—¶é—´åï¼Œæ‰ä¼šè¢«æ¶ˆè´¹(TTL + æ­»ä¿¡é˜Ÿåˆ—)</p><p>éœ€æ±‚ï¼š</p><ol><li>ä¸‹å•åï¼Œ30åˆ†é’Ÿæœªæ”¯ä»˜ï¼Œå–æ¶ˆè®¢å•ï¼Œå›æ»šåº“å­˜ã€‚</li></ol><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230627203537136.png" alt="image-20230627203537136"></p><p>æµç¨‹ï¼š è®¢å•ç³»ç»Ÿ-&gt;MQå»¶è¿Ÿé˜Ÿåˆ—(30minåæ¶ˆè´¹)-&gt;åº“å­˜ç³»ç»Ÿ-&gt;åˆ¤æ–­è®¢å•çŠ¶æ€-&gt;æ”¯ä»˜ï¼Œæœªæ”¯ä»˜</p><p>MQå»¶è¿Ÿé˜Ÿåˆ—ï¼š<br>äº¤æ¢æœº -&gt;TTLé˜Ÿåˆ—-&gt;æ­»ä¿¡äº¤æ¢æœº-&gt;æ­»ä¿¡é˜Ÿåˆ—-&gt;åº“å­˜ç³»ç»Ÿ</p><mark class="hl-label blue">å®ç°</mark> <div class="tabs" id="b3eb00f1-d8cf-4d88-88f9-0e50f8975463"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#b3eb00f1-d8cf-4d88-88f9-0e50f8975463-1"><i class="fas fa-seedling"></i>é…ç½®ç±»</button></li><li class="tab"><button type="button" data-href="#b3eb00f1-d8cf-4d88-88f9-0e50f8975463-2"><i class="fas fa-leaf"></i>æ¶ˆè´¹è€…</button></li><li class="tab"><button type="button" data-href="#b3eb00f1-d8cf-4d88-88f9-0e50f8975463-3"><i class="fab fa-apple"></i>ç”Ÿäº§è€…æµ‹è¯•ç±»</button></li><li class="tab"><button type="button" data-href="#b3eb00f1-d8cf-4d88-88f9-0e50f8975463-4"><i class="fas fa-tree"></i>è¿è¡Œç»“æœ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="b3eb00f1-d8cf-4d88-88f9-0e50f8975463-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å»¶è¿Ÿé˜Ÿåˆ—ï¼š</span></span><br><span class="line"><span class="comment"> * 1ã€æ­£å¸¸äº¤æ¢æœºå’Œæ­£å¸¸é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> * 2ã€æ­»ä¿¡äº¤æ¢æœºå’Œæ­»ä¿¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> * 3ã€æ­£å¸¸é˜Ÿåˆ—å’Œæ­»ä¿¡äº¤æ¢æœºï¼ˆæ ¸å¿ƒé…ç½®ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfigDLXTTL</span> &#123;</span><br><span class="line">    <span class="comment">// æ­£å¸¸é˜Ÿåˆ—å’Œäº¤æ¢æœº</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;order_queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME=<span class="string">&quot;order_exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é…ç½®æ­»ä¿¡é˜Ÿåˆ—å’Œæ­»ä¿¡äº¤æ¢æœº</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME_DLX</span> <span class="operator">=</span> <span class="string">&quot;order_queue_dlx&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME_DLX=<span class="string">&quot;order_exchange_dlx&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1ã€äº¤æ¢æœºçš„é…ç½®</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bootExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">exchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.topicExchange(EXCHANGE_NAME).durable(<span class="literal">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­»ä¿¡äº¤æ¢æœº</span></span><br><span class="line">    <span class="meta">@Bean(&quot;ExchangeDLX&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">exchangeDlx</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.topicExchange(EXCHANGE_NAME_DLX).durable(<span class="literal">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2ã€æ­£å¸¸é˜Ÿåˆ—å’Œæ­»ä¿¡äº¤æ¢æœº</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bootQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">bootQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">        <span class="comment">// 1ã€æ­»ä¿¡äº¤æ¢æœºåç§°</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, EXCHANGE_NAME_DLX);</span><br><span class="line">        <span class="comment">// 2ã€æ­»ä¿¡äº¤æ¢æœºçš„key</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;dlx.order.cancel&quot;</span>);</span><br><span class="line">        <span class="comment">// 3ã€è®¾ç½®é˜Ÿåˆ—çš„è¿‡æœŸæ—¶é—´</span></span><br><span class="line">        args.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">10000</span>);</span><br><span class="line">        <span class="comment">// 4ã€è®¾ç½®é˜Ÿåˆ—çš„é•¿åº¦é™åˆ¶</span></span><br><span class="line">        args.put(<span class="string">&quot;x-max-length&quot;</span>,<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_NAME).withArguments(args).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­»ä¿¡é˜Ÿåˆ—é…ç½®</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bootQueueDLX&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">bootQueueDLX</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_NAME_DLX).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ­£å¸¸äº¤æ¢æœºç»‘å®šæ­£å¸¸é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     * 1ã€çŸ¥é“å“ªä¸ªé˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     * 2ã€çŸ¥é“å“ªä¸ªäº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     * 3ã€è®¾ç½®å¯¹åº”çš„ routing key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindQueueExchange</span><span class="params">(<span class="meta">@Qualifier(&quot;bootQueue&quot;)</span> Queue queue,<span class="meta">@Qualifier(&quot;bootExchange&quot;)</span> Exchange exchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;order.#&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­»ä¿¡äº¤æ¢æœºï¼Œå’Œæ­»ä¿¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindQueueExchangeDlx</span><span class="params">(<span class="meta">@Qualifier(&quot;bootQueueDLX&quot;)</span> Queue queue,<span class="meta">@Qualifier(&quot;ExchangeDLX&quot;)</span> Exchange exchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;dlx.order.#&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b3eb00f1-d8cf-4d88-88f9-0e50f8975463-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å»¶è¿Ÿé˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderListener</span> <span class="keyword">implements</span> <span class="title class_">ChannelAwareMessageListener</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ackMode = &quot;MANUAL&quot;è¦è¿›è¡Œè¿™ä¸ªçš„è®¾ç½®ï¼Œä¸ç„¶å°±è¿˜æ˜¯è‡ªåŠ¨çš„ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰å†²çªï¼Œä¼šå‡ºç°é”™è¯¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;order_queue_dlx&quot;,ackMode = &quot;MANUAL&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> message.getMessageProperties().getDeliveryTag();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1ã€æ¥æ”¶æ¶ˆæ¯</span></span><br><span class="line">            System.out.println(<span class="string">&quot;è·å–åˆ°ï¼š &quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">            <span class="comment">// 2ã€å¤„ç†ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">            System.out.println(<span class="string">&quot;æ•°æ®åº“å¤„ç†&quot;</span>);</span><br><span class="line">            <span class="comment">// æ‰‹åŠ¨ç­¾æ”¶</span></span><br><span class="line">            channel.basicAck(deliveryTag,<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// æ‹’æ¥ç­¾æ”¶ ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šrequeueï¼šé‡å›é˜Ÿåˆ—ï¼Œè®¾ç½®æˆtrueï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¼šå›åˆ°queueï¼Œä¼šé‡æ–°å‘é€æ¶ˆæ¯ç»™æ¶ˆè´¹ç«¯ã€‚</span></span><br><span class="line">            System.out.println(<span class="string">&quot;å‡ºç°å¼‚å¸¸ï¼Œæ‹’ç»æ¥æ”¶ã€‚ã€‚ä¸é‡å›é˜Ÿåˆ—&quot;</span>);</span><br><span class="line">            <span class="comment">// å‡ºé”™çš„è¯ï¼Œå°±ä¼šä¸€ç›´è¿›è¡Œæ‰§è¡Œï¼Œé‡æ–°å°è¯•</span></span><br><span class="line">            channel.basicNack(deliveryTag,<span class="literal">true</span>,<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b3eb00f1-d8cf-4d88-88f9-0e50f8975463-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”Ÿäº§è€…æµ‹è¯•ç±»</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// å»¶è¿Ÿé˜Ÿåˆ—ï¼Œ10sä¹‹åï¼Œæ‰ä¼šè¿›è¡Œæ¥æ”¶å¤„ç†</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;order_exchange&quot;</span>,<span class="string">&quot;order.message&quot;</span>,<span class="string">&quot;å»¶è¿Ÿé˜Ÿåˆ—ä¿¡æ¯ï¼šid=1&quot;</span>);</span><br><span class="line">    <span class="comment">//2.æ‰“å°å€’è®¡æ—¶10s</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">10</span>; i &gt;<span class="number">0</span> ; i--) &#123;</span><br><span class="line">        System.out.println(i+<span class="string">&quot;.........&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b3eb00f1-d8cf-4d88-88f9-0e50f8975463-4"><p>10såä¼šè¿›è¡Œæ¶ˆè´¹å¤„ç†</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10.</span><span class="params">...</span><span class="params">...</span>..</span><br><span class="line"><span class="number">9.</span><span class="params">...</span><span class="params">...</span>..</span><br><span class="line"><span class="number">8.</span><span class="params">...</span><span class="params">...</span>..</span><br><span class="line"><span class="number">7.</span><span class="params">...</span><span class="params">...</span>..</span><br><span class="line"><span class="number">6.</span><span class="params">...</span><span class="params">...</span>..</span><br><span class="line"><span class="number">5.</span><span class="params">...</span><span class="params">...</span>..</span><br><span class="line"><span class="number">4.</span><span class="params">...</span><span class="params">...</span>..</span><br><span class="line"><span class="number">3.</span><span class="params">...</span><span class="params">...</span>..</span><br><span class="line"><span class="number">2.</span><span class="params">...</span><span class="params">...</span>..</span><br><span class="line"><span class="number">1.</span><span class="params">...</span><span class="params">...</span>..</span><br><span class="line">è·å–åˆ°ï¼š å»¶è¿Ÿé˜Ÿåˆ—ä¿¡æ¯ï¼šid=<span class="number">1</span></span><br><span class="line">æ•°æ®åº“å¤„ç†</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><mark class="hl-label blue">å°ç»“</mark> <p>å»¶è¿Ÿé˜Ÿåˆ—æŒ‡æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ—åï¼Œå¯ä»¥è¢«å»¶è¿Ÿä¸€å®šæ—¶é—´ï¼Œå†è¿›è¡Œæ¶ˆè´¹ã€‚</p><p>RabbitMQæ²¡æœ‰æä¾›å»¶è¿Ÿé˜Ÿåˆ—åŠŸèƒ½ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨ï¼šTTL + DLX æ¥å®ç°å»¶è¿Ÿé˜Ÿåˆ—æ•ˆæœã€‚</p><hr><h2 id="æ¶ˆæ¯å¯é æ€§ä¿éšœ">æ¶ˆæ¯å¯é æ€§ä¿éšœ</h2><mark class="hl-label green">æ¶ˆæ¯è¡¥å¿</mark> <p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230627211647066.png" alt="image-20230627211647066"></p><p>æ­¥éª¤2å’Œæ­¥éª¤3å‘é€çš„æ¶ˆæ¯æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡é˜Ÿåˆ—ä¸ä¸€æ ·</p><hr><h2 id="æ¶ˆæ¯å¹‚ç­‰æ€§ä¿éšœ">æ¶ˆæ¯å¹‚ç­‰æ€§ä¿éšœ</h2><p>å¹‚ç­‰æ€§æŒ‡ä¸€æ¬¡å’Œå¤šæ¬¡è¯·æ±‚æŸä¸€ä¸ªèµ„æºï¼Œå¯¹äºèµ„æºæœ¬èº«åº”è¯¥å…·æœ‰åŒæ ·çš„ç»“æœã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œå¯¹èµ„æºæœ¬èº«æ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒã€‚</p><p>åœ¨MQä¸­æŒ‡ï¼Œæ¶ˆè´¹å¤šæ¡ç›¸åŒçš„æ¶ˆæ¯ï¼Œå¾—åˆ°ä¸æ¶ˆè´¹è¯¥æ¶ˆæ¯ä¸€æ¬¡ç›¸åŒçš„ç»“æœã€‚</p><mark class="hl-label green">ä¹è§‚é”æœºåˆ¶</mark> <p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230627212634855.png" alt="image-20230627212634855"></p>]]></content>
    
    
    <summary type="html">RabbitMQé«˜çº§ç‰¹æ€§</summary>
    
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="æ¶ˆæ¯é˜Ÿåˆ—" scheme="https://wuwawawa.github.io/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>RabbitMQäº¤æ¢æœºå’Œå·¥ä½œæ¨¡å¼</title>
    <link href="https://wuwawawa.github.io/posts/4e86ee1.html"/>
    <id>https://wuwawawa.github.io/posts/4e86ee1.html</id>
    <published>2023-06-28T01:54:34.000Z</published>
    <updated>2023-06-28T03:25:35.978Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Exchanges">Exchanges</h2><p>RabbitMQ æ¶ˆæ¯ä¼ é€’æ¨¡å‹çš„æ ¸å¿ƒæ€æƒ³æ˜¯: <strong>ç”Ÿäº§è€…ç”Ÿäº§çš„æ¶ˆæ¯ä»ä¸ä¼šç›´æ¥å‘é€åˆ°é˜Ÿåˆ—</strong>ã€‚å®é™…ä¸Šï¼Œé€šå¸¸ç”Ÿäº§è€…ç”šè‡³éƒ½ä¸çŸ¥é“è¿™äº›æ¶ˆæ¯ä¼ é€’ä¼ é€’åˆ°äº†å“ªäº›é˜Ÿåˆ—ä¸­ã€‚</p><p>ç›¸åï¼Œ<strong>ç”Ÿäº§è€…åªèƒ½å°†æ¶ˆæ¯å‘é€åˆ°äº¤æ¢æœº(exchange)</strong>ï¼Œäº¤æ¢æœºå·¥ä½œçš„å†…å®¹éå¸¸ç®€å•ï¼Œä¸€æ–¹é¢å®ƒæ¥æ”¶æ¥è‡ªç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œå¦ä¸€æ–¹é¢å°†å®ƒä»¬æ¨å…¥é˜Ÿåˆ—ã€‚äº¤æ¢æœºå¿…é¡»ç¡®åˆ‡çŸ¥é“å¦‚ä½•å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯ã€‚æ˜¯åº”è¯¥æŠŠè¿™äº›æ¶ˆæ¯æ”¾åˆ°ç‰¹å®šé˜Ÿåˆ—è¿˜æ˜¯è¯´æŠŠä»–ä»¬åˆ°è®¸å¤šé˜Ÿåˆ—ä¸­è¿˜æ˜¯è¯´åº”è¯¥ä¸¢å¼ƒå®ƒä»¬ã€‚è¿™å°±çš„ç”±äº¤æ¢æœºçš„ç±»å‹æ¥å†³å®šã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image.54tzwxwrqco.webp" alt="image" style="zoom: 50%;" /><hr><h3 id="Exchangesçš„ç±»å‹">Exchangesçš„ç±»å‹</h3><ul><li><p><strong>ç›´æ¥(direct)</strong>ï¼šå¤„ç†è·¯ç”±é”®ã€‚éœ€è¦å°†ä¸€ä¸ªé˜Ÿåˆ—ç»‘å®šåˆ°äº¤æ¢æœºä¸Šï¼Œè¦æ±‚è¯¥æ¶ˆæ¯ä¸ä¸€ä¸ªç‰¹å®šçš„è·¯ç”±é”®å®Œå…¨åŒ¹é…ã€‚è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„åŒ¹é…ã€‚å¦‚æœä¸€ä¸ªé˜Ÿåˆ—ç»‘å®šåˆ°è¯¥äº¤æ¢æœºä¸Šè¦æ±‚è·¯ç”±é”® abc ï¼Œåˆ™åªæœ‰è¢«æ ‡è®°ä¸º abc çš„æ¶ˆæ¯æ‰è¢«è½¬å‘ï¼Œä¸ä¼šè½¬å‘ abc.defï¼Œä¹Ÿä¸ä¼šè½¬å‘ dog.ghiï¼Œåªä¼šè½¬å‘ abcã€‚</p></li><li><p><strong>ä¸»é¢˜(topic)</strong>ï¼šå°†è·¯ç”±é”®å’ŒæŸæ¨¡å¼è¿›è¡ŒåŒ¹é…ã€‚æ­¤æ—¶é˜Ÿåˆ—éœ€è¦ç»‘å®šè¦ä¸€ä¸ªæ¨¡å¼ä¸Šã€‚ç¬¦å·â€œ#â€åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªè¯ï¼Œç¬¦å· * åŒ¹é…ä¸å¤šä¸å°‘ä¸€ä¸ªè¯ã€‚å› æ­¤ abc.# èƒ½å¤ŸåŒ¹é…åˆ° abc.def.ghiï¼Œä½†æ˜¯ abc.* åªä¼šåŒ¹é…åˆ° abc.defã€‚</p></li><li><p><strong>æ ‡é¢˜(headers)</strong>ï¼šä¸å¤„ç†è·¯ç”±é”®ã€‚è€Œæ˜¯æ ¹æ®å‘é€çš„æ¶ˆæ¯å†…å®¹ä¸­çš„headerså±æ€§è¿›è¡ŒåŒ¹é…ã€‚åœ¨ç»‘å®š Queue ä¸ Exchange æ—¶æŒ‡å®šä¸€ç»„é”®å€¼å¯¹ï¼›å½“æ¶ˆæ¯å‘é€åˆ°RabbitMQ æ—¶ä¼šå–åˆ°è¯¥æ¶ˆæ¯çš„ headers ä¸ Exchange ç»‘å®šæ—¶æŒ‡å®šçš„é”®å€¼å¯¹è¿›è¡ŒåŒ¹é…ï¼›å¦‚æœå®Œå…¨åŒ¹é…åˆ™æ¶ˆæ¯ä¼šè·¯ç”±åˆ°è¯¥é˜Ÿåˆ—ï¼Œå¦åˆ™ä¸ä¼šè·¯ç”±åˆ°è¯¥é˜Ÿåˆ—ã€‚headers å±æ€§æ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼Œå¯ä»¥æ˜¯ Hashtableï¼Œé”®å€¼å¯¹çš„å€¼å¯ä»¥æ˜¯ä»»ä½•ç±»å‹ã€‚è€Œ fanoutï¼Œdirectï¼Œtopic çš„è·¯ç”±é”®éƒ½éœ€è¦è¦å­—ç¬¦ä¸²å½¢å¼çš„ã€‚</p><p>åŒ¹é…è§„åˆ™ x-match æœ‰ä¸‹åˆ—ä¸¤ç§ç±»å‹ï¼š</p><p>x-match = all ï¼šè¡¨ç¤ºæ‰€æœ‰çš„é”®å€¼å¯¹éƒ½åŒ¹é…æ‰èƒ½æ¥å—åˆ°æ¶ˆæ¯</p><p>x-match = any ï¼šè¡¨ç¤ºåªè¦æœ‰é”®å€¼å¯¹åŒ¹é…å°±èƒ½æ¥å—åˆ°æ¶ˆæ¯</p></li><li><p><strong>æ‰‡å‡º(fanout)</strong>ï¼šä¸å¤„ç†è·¯ç”±é”®ã€‚ä½ åªéœ€è¦ç®€å•çš„å°†é˜Ÿåˆ—ç»‘å®šåˆ°äº¤æ¢æœºä¸Šã€‚ä¸€ä¸ªå‘é€åˆ°äº¤æ¢æœºçš„æ¶ˆæ¯éƒ½ä¼šè¢«è½¬å‘åˆ°ä¸è¯¥äº¤æ¢æœºç»‘å®šçš„æ‰€æœ‰é˜Ÿåˆ—ä¸Šã€‚å¾ˆåƒå­ç½‘å¹¿æ’­ï¼Œæ¯å°å­ç½‘å†…çš„ä¸»æœºéƒ½è·å¾—äº†ä¸€ä»½å¤åˆ¶çš„æ¶ˆæ¯ã€‚Fanout äº¤æ¢æœºè½¬å‘æ¶ˆæ¯æ˜¯æœ€å¿«çš„ã€‚</p></li></ul><hr><h3 id="é»˜è®¤exchange">é»˜è®¤exchange</h3><p>é€šè¿‡ç©ºå­—ç¬¦ä¸²(â€œâ€)è¿›è¡Œæ ‡è¯†çš„äº¤æ¢æœºæ˜¯é»˜è®¤äº¤æ¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.basicPublish(<span class="string">&quot;&quot;</span>, TASK_QUEUE_NAME, <span class="literal">null</span>, message.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯äº¤æ¢æœºçš„åç§°ã€‚ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºé»˜è®¤æˆ–æ— åç§°äº¤æ¢æœºï¼šæ¶ˆæ¯èƒ½è·¯ç”±å‘é€åˆ°é˜Ÿåˆ—ä¸­å…¶å®æ˜¯ç”± routingKey(bindingkey) ç»‘å®šæŒ‡å®šçš„ key</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image.2nq1gc53kik.webp" alt="image"></p><hr><p>RabbitMQæä¾›äº†6ç§å·¥ä½œæ¨¡å¼ï¼šç®€å•æ¨¡å¼ã€workqueuesã€Publish/Subscribeå‘å¸ƒä¸è®¢é˜…æ¨¡å¼ã€Routingè·¯ç”±æ¨¡å¼ã€Topicsä¸»é¢˜æ¨¡å¼ã€RPCè¿œç¨‹è°ƒç”¨æ¨¡å¼(ä¸ä»‹ç»)ã€‚</p><p>ä¸åŒçš„å·¥ä½œæ¨¡å¼å…¶å®æŒ‡çš„å°±æ˜¯æ¶ˆæ¯çš„è·¯ç”±ç­–ç•¥å’Œæ–¹å¼ä¸ä¸€æ ·</p><h2 id="ç®€å•æ¨¡å¼">ç®€å•æ¨¡å¼</h2><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230620194916643.png" alt="image-20230620194916643"></p><p>åœ¨ä¸Šå›¾çš„æ¨¡å‹ä¸­ï¼Œæœ‰ä»¥ä¸‹æ¦‚å¿µï¼š</p><p>ï¬Pï¼šç”Ÿäº§è€…ï¼Œä¹Ÿå°±æ˜¯è¦å‘é€æ¶ˆæ¯çš„ç¨‹åº</p><p>ï¬Cï¼šæ¶ˆè´¹è€…ï¼šæ¶ˆæ¯çš„æ¥æ”¶è€…ï¼Œä¼šä¸€ç›´ç­‰å¾…æ¶ˆæ¯åˆ°æ¥</p><p>ï¬queueï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå›¾ä¸­çº¢è‰²éƒ¨åˆ†ã€‚ç±»ä¼¼ä¸€ä¸ªé‚®ç®±ï¼Œå¯ä»¥ç¼“å­˜æ¶ˆæ¯ï¼›ç”Ÿäº§è€…å‘å…¶ä¸­æŠ•é€’æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ä»å…¶ä¸­å–å‡ºæ¶ˆæ¯</p><mark class="hl-label blue">æ­¥éª¤</mark> <p>æµç¨‹ï¼š<br>1ã€å»ºç«‹ç”Ÿäº§è€…ä¸æœåŠ¡å™¨çš„TCPé•¿è¿æ¥ã€‚<br>2ã€åœ¨TCPè¿æ¥ä¸­å†å»ºç«‹ç‹¬ç«‹çš„è½»é‡çº§çš„è™šæ‹Ÿè¿æ¥Channelã€‚<br>3ã€é€šè¿‡Channelè¿æ¥å»å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—å·²å­˜åœ¨åˆ™ç›´æ¥ä½¿ç”¨å­˜åœ¨çš„é˜Ÿåˆ—ã€‚<br>4ã€ç”Ÿäº§è€…é€šè¿‡Channelå¾€é˜Ÿåˆ—ä¸­å‘é€æ¶ˆæ¯ã€‚<br>5ã€æ¶ˆè´¹è€…åŒç”Ÿäº§è€…ä¸€æ ·å»ºç«‹ä¸æœåŠ¡å™¨çš„è¿æ¥ã€‚<br>6ã€æ¶ˆè´¹è€…å£°æ˜è™šæ‹Ÿè¿æ¥Channel.<br>7ã€æ¶ˆè´¹è€…é€šè¿‡Channelå£°æ˜ä¸€ä¸ªé˜Ÿåˆ—ï¼ˆå’Œç”Ÿäº§è€…å£°æ˜çš„é˜Ÿåˆ—åŒåï¼‰<br>8ã€æ¶ˆè´¹è€…ä»è¯¥é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ï¼Œå¹¶ä¸”è¿”å›ç¡®è®¤ã€‚æ”¶åˆ°ç¡®è®¤åï¼Œé˜Ÿåˆ—åˆ é™¤å·²è¯»æ¶ˆæ¯ã€‚</p><div class="tabs" id="d94d2eb8-be41-462b-a1f4-08e146d79702"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d94d2eb8-be41-462b-a1f4-08e146d79702-1"><i class="fas fa-heartbeat"></i>æ·»åŠ ä¾èµ–</button></li><li class="tab"><button type="button" data-href="#d94d2eb8-be41-462b-a1f4-08e146d79702-2"><i class="fas fa-anchor"></i>åˆ›å»ºè¿æ¥</button></li><li class="tab"><button type="button" data-href="#d94d2eb8-be41-462b-a1f4-08e146d79702-3"><i class="fas fa-seedling"></i>åˆ›å»ºæ¶ˆè´¹è€…</button></li><li class="tab"><button type="button" data-href="#d94d2eb8-be41-462b-a1f4-08e146d79702-4"><i class="fas fa-leaf"></i>å‘é€æ¶ˆæ¯</button></li><li class="tab"><button type="button" data-href="#d94d2eb8-be41-462b-a1f4-08e146d79702-5"><i class="fab fa-apple"></i>æ¥æ”¶æ¶ˆæ¯</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d94d2eb8-be41-462b-a1f4-08e146d79702-1"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--rabbitmq ä¾èµ–å®¢æˆ·ç«¯--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>amqp-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--æ“ä½œæ–‡ä»¶æµçš„ä¸€ä¸ªä¾èµ–--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--æŒ‡å®š jdk ç¼–è¯‘ç‰ˆæœ¬--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d94d2eb8-be41-462b-a1f4-08e146d79702-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">rabbitConnection</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);<span class="comment">//5672æ˜¯RabbitMQçš„é»˜è®¤ç«¯å£å·</span></span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;my_vhost&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> connectionFactory.newConnection();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getRabbitConnection</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);<span class="comment">//5672æ˜¯RabbitMQçš„é»˜è®¤ç«¯å£å·</span></span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;my_vhost&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> connectionFactory.newConnection();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d94d2eb8-be41-462b-a1f4-08e146d79702-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleConsumer</span> <span class="keyword">extends</span> <span class="title class_">DefaultConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Channel channel;</span><br><span class="line">    <span class="comment">//é‡å†™æ„é€ å‡½æ•°,Channelé€šé“å¯¹è±¡éœ€è¦ä»å¤–å±‚ä¼ å…¥ï¼Œåœ¨handleDeliveryä¸­è¦ç”¨åˆ°</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleConsumer</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(channel);</span><br><span class="line">        <span class="built_in">this</span>.channel = channel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body);</span><br><span class="line">        System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š&quot;</span>+message);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;æ¶ˆæ¯çš„TagIdï¼š&quot;</span>+envelope.getDeliveryTag());</span><br><span class="line">        <span class="comment">//falseåªç¡®è®¤ç­¾æ”¶å½“å‰çš„æ¶ˆæ¯ï¼Œè®¾ç½®ä¸ºtrueçš„æ—¶å€™åˆ™ä»£è¡¨ç­¾æ”¶è¯¥æ¶ˆè´¹è€…æ‰€æœ‰æœªç­¾æ”¶çš„æ¶ˆæ¯</span></span><br><span class="line">        channel.basicAck(envelope.getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d94d2eb8-be41-462b-a1f4-08e146d79702-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> Connection rabbitConnection;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessage2SimpleQueue</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºé€šä¿¡â€œé€šé“â€ï¼Œç›¸å½“äºTCPä¸­çš„è™šæ‹Ÿè¿æ¥</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> rabbitConnection.createChannel();</span><br><span class="line">    <span class="comment">//åˆ›å»ºé˜Ÿåˆ—,å£°æ˜å¹¶åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—å·²å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨è¿™ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">    <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°ï¼šé˜Ÿåˆ—åç§°ID</span></span><br><span class="line">    <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°ï¼šæ˜¯å¦æŒä¹…åŒ–ï¼Œfalseå¯¹åº”ä¸æŒä¹…åŒ–æ•°æ®ï¼ŒMQåœæ‰æ•°æ®å°±ä¼šä¸¢å¤±</span></span><br><span class="line">    <span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šæ˜¯å¦é˜Ÿåˆ—ç§æœ‰åŒ–ï¼Œfalseåˆ™ä»£è¡¨æ‰€æœ‰æ¶ˆè´¹è€…éƒ½å¯ä»¥è®¿é—®ï¼Œtrueä»£è¡¨åªæœ‰ç¬¬ä¸€æ¬¡æ‹¥æœ‰å®ƒçš„æ¶ˆè´¹è€…æ‰èƒ½ä¸€ç›´ä½¿ç”¨ï¼Œå…¶ä»–æ¶ˆè´¹è€…ä¸è®©è®¿é—®</span></span><br><span class="line">    <span class="comment">//ç¬¬å››ä¸ªï¼šæ˜¯å¦è‡ªåŠ¨åˆ é™¤,falseä»£è¡¨è¿æ¥åœæ‰åä¸è‡ªåŠ¨åˆ é™¤æ‰è¿™ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">    <span class="comment">//å…¶ä»–é¢å¤–çš„å‚æ•°, null</span></span><br><span class="line">    channel.queueDeclare(<span class="string">&quot;QUEUE-HELLO-WORLD&quot;</span>,<span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello666&quot;</span>;</span><br><span class="line">    <span class="comment">//å››ä¸ªå‚æ•°</span></span><br><span class="line">    <span class="comment">//exchange äº¤æ¢æœºï¼Œæš‚æ—¶ç”¨ä¸åˆ°ï¼Œåœ¨åé¢è¿›è¡Œå‘å¸ƒè®¢é˜…æ—¶æ‰ä¼šç”¨åˆ°</span></span><br><span class="line">    <span class="comment">//é˜Ÿåˆ—åç§°</span></span><br><span class="line">    <span class="comment">//é¢å¤–çš„è®¾ç½®å±æ€§</span></span><br><span class="line">    <span class="comment">//æœ€åä¸€ä¸ªå‚æ•°æ˜¯è¦ä¼ é€’çš„æ¶ˆæ¯å­—èŠ‚æ•°ç»„</span></span><br><span class="line">    channel.basicPublish(<span class="string">&quot;&quot;</span>, <span class="string">&quot;QUEUE-HELLO-WORLD&quot;</span>, <span class="literal">null</span>,message.getBytes());</span><br><span class="line">    channel.close();</span><br><span class="line">    rabbitConnection.close();</span><br><span class="line">    System.out.println(<span class="string">&quot;===å‘é€æˆåŠŸ===&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d94d2eb8-be41-462b-a1f4-08e146d79702-5"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testReceiveMessageFromSimpleQueue</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºé€šä¿¡â€œé€šé“â€ï¼Œç›¸å½“äºTCPä¸­çš„è™šæ‹Ÿè¿æ¥</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> rabbitConnection.createChannel();</span><br><span class="line">    <span class="comment">//åˆ›å»ºé˜Ÿåˆ—,å£°æ˜å¹¶åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—å·²å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨è¿™ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">    <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°ï¼šé˜Ÿåˆ—åç§°ID</span></span><br><span class="line">    <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°ï¼šæ˜¯å¦æŒä¹…åŒ–ï¼Œfalseå¯¹åº”ä¸æŒä¹…åŒ–æ•°æ®ï¼ŒMQåœæ‰æ•°æ®å°±ä¼šä¸¢å¤±</span></span><br><span class="line">    <span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šæ˜¯å¦é˜Ÿåˆ—ç§æœ‰åŒ–ï¼Œfalseåˆ™ä»£è¡¨æ‰€æœ‰æ¶ˆè´¹è€…éƒ½å¯ä»¥è®¿é—®ï¼Œtrueä»£è¡¨åªæœ‰ç¬¬ä¸€æ¬¡æ‹¥æœ‰å®ƒçš„æ¶ˆè´¹è€…æ‰èƒ½ä¸€ç›´ä½¿ç”¨ï¼Œå…¶ä»–æ¶ˆè´¹è€…ä¸è®©è®¿é—®</span></span><br><span class="line">    <span class="comment">//ç¬¬å››ä¸ªï¼šæ˜¯å¦è‡ªåŠ¨åˆ é™¤,falseä»£è¡¨è¿æ¥åœæ‰åä¸è‡ªåŠ¨åˆ é™¤æ‰è¿™ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">    <span class="comment">//å…¶ä»–é¢å¤–çš„å‚æ•°, null</span></span><br><span class="line">    channel.queueDeclare(<span class="string">&quot;QUEUE-HELLO-WORLD&quot;</span>,<span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//ä»MQæœåŠ¡å™¨ä¸­è·å–æ•°æ®</span></span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…</span></span><br><span class="line">    <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°ï¼šé˜Ÿåˆ—å</span></span><br><span class="line">    <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°ä»£è¡¨æ˜¯å¦è‡ªåŠ¨ç¡®è®¤æ”¶åˆ°æ¶ˆæ¯ï¼Œfalseä»£è¡¨æ‰‹åŠ¨ç¼–ç¨‹æ¥ç¡®è®¤æ¶ˆæ¯ï¼Œè¿™æ˜¯MQçš„æ¨èåšæ³•</span></span><br><span class="line">    <span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°è¦ä¼ å…¥DefaultConsumerçš„å®ç°ç±»</span></span><br><span class="line">    channel.basicConsume(<span class="string">&quot;QUEUE-HELLO-WORLD&quot;</span>, <span class="literal">false</span>, <span class="keyword">new</span> <span class="title class_">SimpleConsumer</span>(channel));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h2 id="Work-queueså·¥ä½œé˜Ÿåˆ—æ¨¡å¼">Work queueså·¥ä½œé˜Ÿåˆ—æ¨¡å¼</h2><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230627102745413.png" alt="image-20230627102745413"></p><p>ï¬</p><p>Work Queuesï¼šä¸å…¥é—¨ç¨‹åºçš„ç®€å•æ¨¡å¼ç›¸æ¯”ï¼Œå¤šäº†ä¸€ä¸ªæˆ–ä¸€äº›æ¶ˆè´¹ç«¯ï¼Œå¤šä¸ªæ¶ˆè´¹ç«¯å…±åŒæ¶ˆè´¹åŒä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚</p><p>åº”ç”¨åœºæ™¯ï¼šå¯¹äºä»»åŠ¡è¿‡é‡æˆ–ä»»åŠ¡è¾ƒå¤šæƒ…å†µä½¿ç”¨å·¥ä½œé˜Ÿåˆ—å¯ä»¥æé«˜ä»»åŠ¡å¤„ç†çš„é€Ÿåº¦ã€‚</p><span class='p red'>ä¸¤ä¸ªæ¶ˆè´¹è€…å±äºç«äº‰çš„å…³ç³»ï¼Œåªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥å–åˆ°æ¶ˆæ¯ã€‚</span><mark class="hl-label blue">ç¤ºä¾‹</mark> <div class="tabs" id="d8caf33f-f175-4fba-b9b9-c7a9ad9e28c2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d8caf33f-f175-4fba-b9b9-c7a9ad9e28c2-1"><i class="fas fa-horse"></i>åˆ›å»ºå¤šæ¶ˆè´¹è€…</button></li><li class="tab"><button type="button" data-href="#d8caf33f-f175-4fba-b9b9-c7a9ad9e28c2-2"><i class="fas fa-cat"></i>å‘é€æ¶ˆæ¯</button></li><li class="tab"><button type="button" data-href="#d8caf33f-f175-4fba-b9b9-c7a9ad9e28c2-3"><i class="fas fa-dragon"></i>è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d8caf33f-f175-4fba-b9b9-c7a9ad9e28c2-1"><p>åˆ†åˆ«å¯åŠ¨ä¸¤ä¸ªæ¶ˆè´¹è€…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WorkConsumer1</span> <span class="keyword">extends</span> <span class="title class_">DefaultConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Channel channel;</span><br><span class="line">    <span class="comment">//é‡å†™æ„é€ å‡½æ•°,Channelé€šé“å¯¹è±¡éœ€è¦ä»å¤–å±‚ä¼ å…¥ï¼Œåœ¨handleDeliveryä¸­è¦ç”¨åˆ°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WorkConsumer1</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(channel);</span><br><span class="line">        <span class="built_in">this</span>.channel = channel;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body);</span><br><span class="line">        System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…1æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š&quot;</span> + message);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;æ¶ˆæ¯çš„TagIdï¼š&quot;</span> + envelope.getDeliveryTag());</span><br><span class="line">        <span class="comment">//falseåªç¡®è®¤ç­¾æ”¶å½“å‰çš„æ¶ˆæ¯ï¼Œè®¾ç½®ä¸ºtrueçš„æ—¶å€™åˆ™ä»£è¡¨ç­¾æ”¶è¯¥æ¶ˆè´¹è€…æ‰€æœ‰æœªç­¾æ”¶çš„æ¶ˆæ¯</span></span><br><span class="line">        channel.basicAck(envelope.getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºé€šä¿¡â€œé€šé“â€ï¼Œç›¸å½“äºTCPä¸­çš„è™šæ‹Ÿè¿æ¥</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConfig.getRabbitConnection().createChannel();</span><br><span class="line">        <span class="comment">//åˆ›å»ºé˜Ÿåˆ—,å£°æ˜å¹¶åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—å·²å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨è¿™ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°ï¼šé˜Ÿåˆ—åç§°ID</span></span><br><span class="line">        <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°ï¼šæ˜¯å¦æŒä¹…åŒ–ï¼Œfalseå¯¹åº”ä¸æŒä¹…åŒ–æ•°æ®ï¼ŒMQåœæ‰æ•°æ®å°±ä¼šä¸¢å¤±</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šæ˜¯å¦é˜Ÿåˆ—ç§æœ‰åŒ–ï¼Œfalseåˆ™ä»£è¡¨æ‰€æœ‰æ¶ˆè´¹è€…éƒ½å¯ä»¥è®¿é—®ï¼Œtrueä»£è¡¨åªæœ‰ç¬¬ä¸€æ¬¡æ‹¥æœ‰å®ƒçš„æ¶ˆè´¹è€…æ‰èƒ½ä¸€ç›´ä½¿ç”¨ï¼Œå…¶ä»–æ¶ˆè´¹è€…ä¸è®©è®¿é—®</span></span><br><span class="line">        <span class="comment">//ç¬¬å››ä¸ªï¼šæ˜¯å¦è‡ªåŠ¨åˆ é™¤,falseä»£è¡¨è¿æ¥åœæ‰åä¸è‡ªåŠ¨åˆ é™¤æ‰è¿™ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">//å…¶ä»–é¢å¤–çš„å‚æ•°, null</span></span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;work_queues&quot;</span>,<span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//ä»MQæœåŠ¡å™¨ä¸­è·å–æ•°æ®</span></span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°ï¼šé˜Ÿåˆ—å</span></span><br><span class="line">        <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°ä»£è¡¨æ˜¯å¦è‡ªåŠ¨ç¡®è®¤æ”¶åˆ°æ¶ˆæ¯ï¼Œfalseä»£è¡¨æ‰‹åŠ¨ç¼–ç¨‹æ¥ç¡®è®¤æ¶ˆæ¯ï¼Œè¿™æ˜¯MQçš„æ¨èåšæ³•</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°è¦ä¼ å…¥DefaultConsumerçš„å®ç°ç±»</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;work_queues&quot;</span>, <span class="literal">false</span>, <span class="keyword">new</span> <span class="title class_">WorkConsumer1</span>(channel));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WorkConsumer1</span> <span class="keyword">extends</span> <span class="title class_">DefaultConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Channel channel;</span><br><span class="line">    <span class="comment">//é‡å†™æ„é€ å‡½æ•°,Channelé€šé“å¯¹è±¡éœ€è¦ä»å¤–å±‚ä¼ å…¥ï¼Œåœ¨handleDeliveryä¸­è¦ç”¨åˆ°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WorkConsumer1</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(channel);</span><br><span class="line">        <span class="built_in">this</span>.channel = channel;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body);</span><br><span class="line">        System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…1æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š&quot;</span> + message);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;æ¶ˆæ¯çš„TagIdï¼š&quot;</span> + envelope.getDeliveryTag());</span><br><span class="line">        <span class="comment">//falseåªç¡®è®¤ç­¾æ”¶å½“å‰çš„æ¶ˆæ¯ï¼Œè®¾ç½®ä¸ºtrueçš„æ—¶å€™åˆ™ä»£è¡¨ç­¾æ”¶è¯¥æ¶ˆè´¹è€…æ‰€æœ‰æœªç­¾æ”¶çš„æ¶ˆæ¯</span></span><br><span class="line">        channel.basicAck(envelope.getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºé€šä¿¡â€œé€šé“â€ï¼Œç›¸å½“äºTCPä¸­çš„è™šæ‹Ÿè¿æ¥</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConfig.getRabbitConnection().createChannel();</span><br><span class="line">        <span class="comment">//åˆ›å»ºé˜Ÿåˆ—,å£°æ˜å¹¶åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—å·²å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨è¿™ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°ï¼šé˜Ÿåˆ—åç§°ID</span></span><br><span class="line">        <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°ï¼šæ˜¯å¦æŒä¹…åŒ–ï¼Œfalseå¯¹åº”ä¸æŒä¹…åŒ–æ•°æ®ï¼ŒMQåœæ‰æ•°æ®å°±ä¼šä¸¢å¤±</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šæ˜¯å¦é˜Ÿåˆ—ç§æœ‰åŒ–ï¼Œfalseåˆ™ä»£è¡¨æ‰€æœ‰æ¶ˆè´¹è€…éƒ½å¯ä»¥è®¿é—®ï¼Œtrueä»£è¡¨åªæœ‰ç¬¬ä¸€æ¬¡æ‹¥æœ‰å®ƒçš„æ¶ˆè´¹è€…æ‰èƒ½ä¸€ç›´ä½¿ç”¨ï¼Œå…¶ä»–æ¶ˆè´¹è€…ä¸è®©è®¿é—®</span></span><br><span class="line">        <span class="comment">//ç¬¬å››ä¸ªï¼šæ˜¯å¦è‡ªåŠ¨åˆ é™¤,falseä»£è¡¨è¿æ¥åœæ‰åä¸è‡ªåŠ¨åˆ é™¤æ‰è¿™ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">//å…¶ä»–é¢å¤–çš„å‚æ•°, null</span></span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;work_queues&quot;</span>,<span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//ä»MQæœåŠ¡å™¨ä¸­è·å–æ•°æ®</span></span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°ï¼šé˜Ÿåˆ—å</span></span><br><span class="line">        <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°ä»£è¡¨æ˜¯å¦è‡ªåŠ¨ç¡®è®¤æ”¶åˆ°æ¶ˆæ¯ï¼Œfalseä»£è¡¨æ‰‹åŠ¨ç¼–ç¨‹æ¥ç¡®è®¤æ¶ˆæ¯ï¼Œè¿™æ˜¯MQçš„æ¨èåšæ³•</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°è¦ä¼ å…¥DefaultConsumerçš„å®ç°ç±»</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;work_queues&quot;</span>, <span class="literal">false</span>, <span class="keyword">new</span> <span class="title class_">WorkConsumer1</span>(channel));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d8caf33f-f175-4fba-b9b9-c7a9ad9e28c2-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessage2WorkQueue</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºé€šä¿¡â€œé€šé“â€ï¼Œç›¸å½“äºTCPä¸­çš„è™šæ‹Ÿè¿æ¥</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> rabbitConnection.createChannel();</span><br><span class="line">    <span class="comment">//åˆ›å»ºé˜Ÿåˆ—,å£°æ˜å¹¶åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—å·²å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨è¿™ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">    <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°ï¼šé˜Ÿåˆ—åç§°ID</span></span><br><span class="line">    <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°ï¼šæ˜¯å¦æŒä¹…åŒ–ï¼Œfalseå¯¹åº”ä¸æŒä¹…åŒ–æ•°æ®ï¼ŒMQåœæ‰æ•°æ®å°±ä¼šä¸¢å¤±</span></span><br><span class="line">    <span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šæ˜¯å¦é˜Ÿåˆ—ç§æœ‰åŒ–ï¼Œfalseåˆ™ä»£è¡¨æ‰€æœ‰æ¶ˆè´¹è€…éƒ½å¯ä»¥è®¿é—®ï¼Œtrueä»£è¡¨åªæœ‰ç¬¬ä¸€æ¬¡æ‹¥æœ‰å®ƒçš„æ¶ˆè´¹è€…æ‰èƒ½ä¸€ç›´ä½¿ç”¨ï¼Œå…¶ä»–æ¶ˆè´¹è€…ä¸è®©è®¿é—®</span></span><br><span class="line">    <span class="comment">//ç¬¬å››ä¸ªï¼šæ˜¯å¦è‡ªåŠ¨åˆ é™¤,falseä»£è¡¨è¿æ¥åœæ‰åä¸è‡ªåŠ¨åˆ é™¤æ‰è¿™ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">    <span class="comment">//å…¶ä»–é¢å¤–çš„å‚æ•°, null</span></span><br><span class="line">    channel.queueDeclare(<span class="string">&quot;work_queues&quot;</span>,<span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> i + <span class="string">&quot;hello rabbitmq~~~&quot;</span>;</span><br><span class="line">        <span class="comment">//å››ä¸ªå‚æ•°</span></span><br><span class="line">        <span class="comment">//exchange äº¤æ¢æœºï¼Œæš‚æ—¶ç”¨ä¸åˆ°ï¼Œåœ¨åé¢è¿›è¡Œå‘å¸ƒè®¢é˜…æ—¶æ‰ä¼šç”¨åˆ°</span></span><br><span class="line">        <span class="comment">//é˜Ÿåˆ—åç§°</span></span><br><span class="line">        <span class="comment">//é¢å¤–çš„è®¾ç½®å±æ€§</span></span><br><span class="line">        <span class="comment">//æœ€åä¸€ä¸ªå‚æ•°æ˜¯è¦ä¼ é€’çš„æ¶ˆæ¯å­—èŠ‚æ•°ç»„</span></span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>, <span class="string">&quot;work_queues&quot;</span>, <span class="literal">null</span>,message.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line">    channel.close();</span><br><span class="line">    rabbitConnection.close();</span><br><span class="line">    System.out.println(<span class="string">&quot;===å‘é€æˆåŠŸ===&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d8caf33f-f175-4fba-b9b9-c7a9ad9e28c2-3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">æ¶ˆè´¹è€…1æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š0hello rabbitmq<span class="code">~~~</span></span><br><span class="line"><span class="code">æ¶ˆæ¯çš„TagIdï¼š1</span></span><br><span class="line"><span class="code">æ¶ˆè´¹è€…1æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š2hello rabbitmq~~~</span></span><br><span class="line">æ¶ˆæ¯çš„TagIdï¼š2</span><br><span class="line">æ¶ˆè´¹è€…1æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š4hello rabbitmq<span class="code">~~~</span></span><br><span class="line"><span class="code">æ¶ˆæ¯çš„TagIdï¼š3</span></span><br><span class="line"><span class="code">æ¶ˆè´¹è€…1æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š6hello rabbitmq~~~</span></span><br><span class="line">æ¶ˆæ¯çš„TagIdï¼š4</span><br><span class="line">æ¶ˆè´¹è€…1æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š8hello rabbitmq<span class="code">~~~</span></span><br><span class="line"><span class="code">æ¶ˆæ¯çš„TagIdï¼š5</span></span><br></pre></td></tr></table></figure><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">æ¶ˆè´¹è€…2æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š1hello rabbitmq<span class="code">~~~</span></span><br><span class="line"><span class="code">æ¶ˆæ¯çš„TagIdï¼š1</span></span><br><span class="line"><span class="code">æ¶ˆè´¹è€…2æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š3hello rabbitmq~~~</span></span><br><span class="line">æ¶ˆæ¯çš„TagIdï¼š2</span><br><span class="line">æ¶ˆè´¹è€…2æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š5hello rabbitmq<span class="code">~~~</span></span><br><span class="line"><span class="code">æ¶ˆæ¯çš„TagIdï¼š3</span></span><br><span class="line"><span class="code">æ¶ˆè´¹è€…2æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š7hello rabbitmq~~~</span></span><br><span class="line">æ¶ˆæ¯çš„TagIdï¼š4</span><br><span class="line">æ¶ˆè´¹è€…2æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š9hello rabbitmq<span class="code">~~~</span></span><br><span class="line"><span class="code">æ¶ˆæ¯çš„TagIdï¼š5</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><mark class="hl-label green">å°ç»“</mark> <ol><li>åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­å¦‚æœæœ‰å¤šä¸ªæ¶ˆè´¹è€…ï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…ä¹‹é—´å¯¹äºåŒä¸€ä¸ªæ¶ˆæ¯çš„å…³ç³»æ˜¯<span class='p red'>ç«äº‰</span>çš„å…³ç³»ã€‚</li><li>Work Queueså¯¹äºä»»åŠ¡è¿‡é‡æˆ–ä»»åŠ¡è¾ƒå¤šæƒ…å†µä½¿ç”¨å·¥ä½œé˜Ÿåˆ—å¯ä»¥æé«˜ä»»åŠ¡å¤„ç†çš„é€Ÿåº¦ã€‚ä¾‹å¦‚ï¼šçŸ­ä¿¡æœåŠ¡éƒ¨ç½²å¤šä¸ªï¼Œåªéœ€è¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹æˆåŠŸå‘é€å³å¯ã€‚</li></ol><hr><h2 id="Pub-Subå‘å¸ƒè®¢é˜…æ¨¡å¼-fanout">Pub/Subå‘å¸ƒè®¢é˜…æ¨¡å¼(fanout)</h2><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230627105706546.png" alt="image-20230627105706546"></p><p>åœ¨è®¢é˜…æ¨¡å‹ä¸­ï¼Œå¤šäº†ä¸€ä¸ªExchange è§’è‰²ï¼Œè€Œä¸”è¿‡ç¨‹ç•¥æœ‰å˜åŒ–ï¼š</p><p>Pï¼šç”Ÿäº§è€…ï¼Œä¹Ÿå°±æ˜¯è¦å‘é€æ¶ˆæ¯çš„ç¨‹åºï¼Œä½†æ˜¯ä¸å†å‘é€åˆ°é˜Ÿåˆ—ä¸­ï¼Œè€Œæ˜¯å‘ç»™Xï¼ˆäº¤æ¢æœºï¼‰</p><p>ï¬Cï¼šæ¶ˆè´¹è€…ï¼Œæ¶ˆæ¯çš„æ¥æ”¶è€…ï¼Œä¼šä¸€ç›´ç­‰å¾…æ¶ˆæ¯åˆ°æ¥</p><p>ï¬Queueï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¥æ”¶æ¶ˆæ¯ã€ç¼“å­˜æ¶ˆæ¯</p><p>ï¬Xï¼šäº¤æ¢æœºï¼ˆExchangeï¼‰ã€‚ä¸€æ–¹é¢ï¼Œæ¥æ”¶ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ã€‚å¦ä¸€æ–¹é¢ï¼ŒçŸ¥é“å¦‚ä½•å¤„ç†æ¶ˆæ¯ï¼Œä¾‹å¦‚é€’äº¤ç»™æŸä¸ªç‰¹åˆ«é˜Ÿåˆ—ã€é€’äº¤ç»™æ‰€æœ‰é˜Ÿåˆ—ã€æˆ–æ˜¯å°†æ¶ˆæ¯ä¸¢å¼ƒã€‚åˆ°åº•å¦‚ä½•æ“ä½œï¼Œå–å†³äºExchangeçš„ç±»å‹ã€‚Exchangeæœ‰å¸¸è§ä»¥ä¸‹3ç§ç±»å‹ï¼š</p><ul><li>ïƒ˜Fanoutï¼šå¹¿æ’­ï¼Œå°†æ¶ˆæ¯äº¤ç»™æ‰€æœ‰ç»‘å®šåˆ°äº¤æ¢æœºçš„é˜Ÿåˆ—</li><li>Directï¼šå®šå‘ï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™ç¬¦åˆæŒ‡å®šrouting key çš„é˜Ÿåˆ—</li><li>Topicï¼šé€šé…ç¬¦ï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™ç¬¦åˆrouting patternï¼ˆè·¯ç”±æ¨¡å¼ï¼‰çš„é˜Ÿåˆ—</li></ul><p>äº¤æ¢æœºåªè´Ÿè´£è½¬å‘æ¶ˆæ¯ï¼Œä¸å…·å¤‡å­˜å‚¨æ¶ˆæ¯çš„èƒ½åŠ›ï¼Œå› æ­¤å¦‚æœæ²¡æœ‰ä»»ä½•é˜Ÿåˆ—ä¸Exchange ç»‘å®šï¼Œæˆ–è€…æ²¡æœ‰ç¬¦åˆè·¯ç”±è§„åˆ™çš„é˜Ÿåˆ—ï¼Œé‚£ä¹ˆ<span class='p red'>æ¶ˆæ¯ä¼šä¸¢å¤±</span>ï¼</p><p>éœ€æ±‚ï¼š</p><mark class="hl-label blue">ç¤ºä¾‹</mark> <div class="tabs" id="bd4946ed-095a-4851-8c36-886910201d08"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#bd4946ed-095a-4851-8c36-886910201d08-1"><i class="far fa-sun"></i>å‘é€æ¶ˆæ¯</button></li><li class="tab"><button type="button" data-href="#bd4946ed-095a-4851-8c36-886910201d08-2"><i class="fas fa-wind"></i>è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="bd4946ed-095a-4851-8c36-886910201d08-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> Connection rabbitConnection;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessage2PubSubQueue</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºé€šä¿¡â€œé€šé“â€ï¼Œç›¸å½“äºTCPä¸­çš„è™šæ‹Ÿè¿æ¥</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> rabbitConnection.createChannel();</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    åˆ›å»ºäº¤æ¢æœº</span></span><br><span class="line"><span class="comment">    exchangeDeclare(String exchange, BuiltinExchangeType type, boolean durable, boolean autoDelete, boolean internal, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">    å‚æ•°ï¼š</span></span><br><span class="line"><span class="comment">        1. exchange:äº¤æ¢æœºåç§°</span></span><br><span class="line"><span class="comment">        2. type:äº¤æ¢æœºç±»å‹</span></span><br><span class="line"><span class="comment">            DIRECT(&quot;direct&quot;),ï¼šå®šå‘</span></span><br><span class="line"><span class="comment">            FANOUT(&quot;fanout&quot;),ï¼šæ‰‡å½¢ï¼ˆå¹¿æ’­ï¼‰ï¼Œå‘é€æ¶ˆæ¯åˆ°æ¯ä¸€ä¸ªä¸ä¹‹ç»‘å®šé˜Ÿåˆ—ã€‚</span></span><br><span class="line"><span class="comment">            TOPIC(&quot;topic&quot;),é€šé…ç¬¦çš„æ–¹å¼</span></span><br><span class="line"><span class="comment">            HEADERS(&quot;headers&quot;);å‚æ•°åŒ¹é…</span></span><br><span class="line"><span class="comment">         3. durable:æ˜¯å¦æŒä¹…åŒ–</span></span><br><span class="line"><span class="comment">        4. autoDelete:è‡ªåŠ¨åˆ é™¤</span></span><br><span class="line"><span class="comment">        5. internalï¼šå†…éƒ¨ä½¿ç”¨ã€‚ ä¸€èˆ¬false</span></span><br><span class="line"><span class="comment">        6. argumentsï¼šå‚æ•°</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;test_fanout&quot;</span>;</span><br><span class="line">    channel.exchangeDeclare(exchangeName, BuiltinExchangeType.FANOUT,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//åˆ›å»ºé˜Ÿåˆ—</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">&quot;test_fanout_queue1&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">&quot;test_fanout_queue2&quot;</span>;</span><br><span class="line">    channel.queueDeclare(queue1Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">    channel.queueDeclare(queue2Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    queueBind(String queue, String exchange, String routingKey)</span></span><br><span class="line"><span class="comment">    å‚æ•°ï¼š</span></span><br><span class="line"><span class="comment">        1. queueï¼šé˜Ÿåˆ—åç§°</span></span><br><span class="line"><span class="comment">        2. exchangeï¼šäº¤æ¢æœºåç§°</span></span><br><span class="line"><span class="comment">        3. routingKeyï¼šè·¯ç”±é”®ï¼Œç»‘å®šè§„åˆ™</span></span><br><span class="line"><span class="comment">            å¦‚æœäº¤æ¢æœºçš„ç±»å‹ä¸ºfanout ï¼ŒroutingKeyè®¾ç½®ä¸º&quot;&quot;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    channel.queueBind(queue1Name,exchangeName,<span class="string">&quot;&quot;</span>);</span><br><span class="line">    channel.queueBind(queue2Name,exchangeName,<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="comment">//å‘é€æ¶ˆæ¯</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;æ—¥å¿—ä¿¡æ¯ï¼šå¼ ä¸‰è°ƒç”¨äº†findAllæ–¹æ³•...æ—¥å¿—çº§åˆ«ï¼šinfo...&quot;</span>;</span><br><span class="line">    channel.basicPublish(exchangeName,<span class="string">&quot;&quot;</span>,<span class="literal">null</span>,body.getBytes());</span><br><span class="line">    <span class="comment">//é‡Šæ”¾èµ„æº</span></span><br><span class="line">    channel.close();</span><br><span class="line">    rabbitConnection.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="bd4946ed-095a-4851-8c36-886910201d08-2"><p>C1</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bodyï¼šæ—¥å¿—ä¿¡æ¯ï¼šå¼ ä¸‰è°ƒç”¨äº†findAllæ–¹æ³•<span class="string">...</span>æ—¥å¿—çº§åˆ«ï¼šinfo.<span class="string">..</span></span><br><span class="line">å°†æ—¥å¿—ä¿¡æ¯æ‰“å°åˆ°æ§åˆ¶å°<span class="string">.....</span></span><br></pre></td></tr></table></figure><p>C2</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bodyï¼šæ—¥å¿—ä¿¡æ¯ï¼šå¼ ä¸‰è°ƒç”¨äº†findAllæ–¹æ³•<span class="string">...</span>æ—¥å¿—çº§åˆ«ï¼šinfo.<span class="string">..</span></span><br><span class="line">å°†æ—¥å¿—ä¿¡æ¯ä¿å­˜æ•°æ®åº“<span class="string">.....</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <mark class="hl-label green">å°ç»“</mark> <ol><li><p>äº¤æ¢æœºéœ€è¦ä¸é˜Ÿåˆ—è¿›è¡Œç»‘å®šï¼Œç»‘å®šä¹‹åï¼›ä¸€ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…éƒ½æ”¶åˆ°ã€‚</p></li><li><p>å‘å¸ƒè®¢é˜…æ¨¡å¼ä¸å·¥ä½œé˜Ÿåˆ—æ¨¡å¼çš„åŒºåˆ«ï¼š</p><ul><li>å·¥ä½œé˜Ÿåˆ—æ¨¡å¼ä¸ç”¨å®šä¹‰äº¤æ¢æœºï¼Œè€Œå‘å¸ƒ/è®¢é˜…æ¨¡å¼éœ€è¦å®šä¹‰äº¤æ¢æœº</li><li>å‘å¸ƒ/è®¢é˜…æ¨¡å¼çš„ç”Ÿäº§æ–¹æ˜¯é¢å‘äº¤æ¢æœºå‘é€æ¶ˆæ¯ï¼Œå·¥ä½œé˜Ÿåˆ—æ¨¡å¼çš„ç”Ÿäº§æ–¹æ˜¯é¢å‘é˜Ÿåˆ—å‘é€æ¶ˆæ¯(åº•å±‚ä½¿ç”¨é»˜è®¤äº¤æ¢æœº)</li><li>å‘å¸ƒ/è®¢é˜…æ¨¡å¼éœ€è¦è®¾ç½®é˜Ÿåˆ—å’Œäº¤æ¢æœºçš„ç»‘å®šï¼Œå·¥ä½œé˜Ÿåˆ—æ¨¡å¼ä¸éœ€è¦è®¾ç½®ï¼Œå®é™…ä¸Šå·¥ä½œé˜Ÿåˆ—æ¨¡å¼ä¼šå°†é˜Ÿåˆ—ç»‘å®šåˆ°é»˜è®¤çš„äº¤æ¢æœº</li></ul></li></ol><hr><h2 id="Routingè·¯ç”±æ¨¡å¼-Direct">Routingè·¯ç”±æ¨¡å¼(Direct)</h2><p>æ¨¡å¼è¯´æ˜ï¼š</p><ul><li>é˜Ÿåˆ—ä¸äº¤æ¢æœºçš„ç»‘å®šï¼Œä¸èƒ½æ˜¯ä»»æ„ç»‘å®šäº†ï¼Œè€Œæ˜¯è¦æŒ‡å®šä¸€ä¸ª RoutingKeyï¼ˆè·¯ç”±keyï¼‰</li><li>æ¶ˆæ¯çš„å‘é€æ–¹åœ¨å‘ Exchange å‘é€æ¶ˆæ¯æ—¶ï¼Œä¹Ÿå¿…é¡»æŒ‡å®šæ¶ˆæ¯çš„ RoutingKey</li><li>Exchange ä¸å†æŠŠæ¶ˆæ¯äº¤ç»™æ¯ä¸€ä¸ªç»‘å®šçš„é˜Ÿåˆ—ï¼Œè€Œæ˜¯æ ¹æ®æ¶ˆæ¯çš„ Routing Key è¿›è¡Œåˆ¤æ–­ï¼Œåªæœ‰é˜Ÿåˆ—çš„Routingkey ä¸æ¶ˆæ¯çš„ Routing key å®Œå…¨ä¸€è‡´ï¼Œæ‰ä¼šæ¥æ”¶åˆ°æ¶ˆæ¯</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230627130017285.png" alt="image-20230627130017285"></p><p>Pï¼šç”Ÿäº§è€…ï¼Œå‘ Exchange å‘é€æ¶ˆæ¯ï¼Œå‘é€æ¶ˆæ¯æ—¶ï¼Œä¼šæŒ‡å®šä¸€ä¸ªrouting key</p><p>Xï¼šExchangeï¼ˆäº¤æ¢æœºï¼‰ï¼Œæ¥æ”¶ç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œç„¶åæŠŠæ¶ˆæ¯é€’äº¤ç»™ä¸ routing key å®Œå…¨åŒ¹é…çš„é˜Ÿåˆ—</p><p>C1ï¼šæ¶ˆè´¹è€…ï¼Œå…¶æ‰€åœ¨é˜Ÿåˆ—æŒ‡å®šäº†éœ€è¦ routing key ä¸º error çš„æ¶ˆæ¯</p><p>C2ï¼šæ¶ˆè´¹è€…ï¼Œå…¶æ‰€åœ¨é˜Ÿåˆ—æŒ‡å®šäº†éœ€è¦ routing key ä¸º infoã€errorã€warning çš„æ¶ˆæ¯</p><mark class="hl-label blue">ç¤ºä¾‹</mark> <div class="tabs" id="6cf7bbdd-8671-4d97-9a8a-e5c570e3becc"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6cf7bbdd-8671-4d97-9a8a-e5c570e3becc-1"><i class="fas fa-award"></i>åˆ›å»ºæ¶ˆè´¹è€…</button></li><li class="tab"><button type="button" data-href="#6cf7bbdd-8671-4d97-9a8a-e5c570e3becc-2"><i class="fas fa-baseball-ball"></i>å‘é€æ¶ˆæ¯</button></li><li class="tab"><button type="button" data-href="#6cf7bbdd-8671-4d97-9a8a-e5c570e3becc-3"><i class="fas fa-bone"></i>è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6cf7bbdd-8671-4d97-9a8a-e5c570e3becc-1"><p>åˆ†åˆ«å¯åŠ¨ä¸¤ä¸ªæ¶ˆè´¹è€…</p><div class="tabs" id="e8ac1bea-fb46-4d2c-b929-b55f58ed3b99"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e8ac1bea-fb46-4d2c-b929-b55f58ed3b99-1"><i class="fas fa-seedling"></i>1</button></li><li class="tab"><button type="button" data-href="#e8ac1bea-fb46-4d2c-b929-b55f58ed3b99-2"><i class="fas fa-leaf"></i>2</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e8ac1bea-fb46-4d2c-b929-b55f58ed3b99-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RouteConsumer1</span> <span class="keyword">extends</span> <span class="title class_">DefaultConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Channel channel;</span><br><span class="line">    <span class="comment">//é‡å†™æ„é€ å‡½æ•°,Channelé€šé“å¯¹è±¡éœ€è¦ä»å¤–å±‚ä¼ å…¥ï¼Œåœ¨handleDeliveryä¸­è¦ç”¨åˆ°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RouteConsumer1</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(channel);</span><br><span class="line">        <span class="built_in">this</span>.channel = channel;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;bodyï¼š&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">        System.out.println(<span class="string">&quot;å°†æ—¥å¿—ä¿¡æ¯æ‰“å°åˆ°æ§åˆ¶å°.....&quot;</span>);</span><br><span class="line">        channel.basicAck(envelope.getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºé€šä¿¡â€œé€šé“â€ï¼Œç›¸å½“äºTCPä¸­çš„è™šæ‹Ÿè¿æ¥</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConfig.getRabbitConnection().createChannel();</span><br><span class="line">        <span class="comment">//åˆ›å»ºé˜Ÿåˆ—,å£°æ˜å¹¶åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—å·²å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨è¿™ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°ï¼šé˜Ÿåˆ—åç§°ID</span></span><br><span class="line">        <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°ï¼šæ˜¯å¦æŒä¹…åŒ–ï¼Œfalseå¯¹åº”ä¸æŒä¹…åŒ–æ•°æ®ï¼ŒMQåœæ‰æ•°æ®å°±ä¼šä¸¢å¤±</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šæ˜¯å¦é˜Ÿåˆ—ç§æœ‰åŒ–ï¼Œfalseåˆ™ä»£è¡¨æ‰€æœ‰æ¶ˆè´¹è€…éƒ½å¯ä»¥è®¿é—®ï¼Œtrueä»£è¡¨åªæœ‰ç¬¬ä¸€æ¬¡æ‹¥æœ‰å®ƒçš„æ¶ˆè´¹è€…æ‰èƒ½ä¸€ç›´ä½¿ç”¨ï¼Œå…¶ä»–æ¶ˆè´¹è€…ä¸è®©è®¿é—®</span></span><br><span class="line">        <span class="comment">//ç¬¬å››ä¸ªï¼šæ˜¯å¦è‡ªåŠ¨åˆ é™¤,falseä»£è¡¨è¿æ¥åœæ‰åä¸è‡ªåŠ¨åˆ é™¤æ‰è¿™ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">//å…¶ä»–é¢å¤–çš„å‚æ•°, null</span></span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;test_direct_queue1&quot;</span>,<span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//ä»MQæœåŠ¡å™¨ä¸­è·å–æ•°æ®</span></span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°ï¼šé˜Ÿåˆ—å</span></span><br><span class="line">        <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°ä»£è¡¨æ˜¯å¦è‡ªåŠ¨ç¡®è®¤æ”¶åˆ°æ¶ˆæ¯ï¼Œfalseä»£è¡¨æ‰‹åŠ¨ç¼–ç¨‹æ¥ç¡®è®¤æ¶ˆæ¯ï¼Œè¿™æ˜¯MQçš„æ¨èåšæ³•</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°è¦ä¼ å…¥DefaultConsumerçš„å®ç°ç±»</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;test_direct_queue1&quot;</span>, <span class="literal">false</span>, <span class="keyword">new</span> <span class="title class_">RouteConsumer1</span>(channel));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e8ac1bea-fb46-4d2c-b929-b55f58ed3b99-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RouteConsumer2</span> <span class="keyword">extends</span> <span class="title class_">DefaultConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Channel channel;</span><br><span class="line">    <span class="comment">//é‡å†™æ„é€ å‡½æ•°,Channelé€šé“å¯¹è±¡éœ€è¦ä»å¤–å±‚ä¼ å…¥ï¼Œåœ¨handleDeliveryä¸­è¦ç”¨åˆ°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RouteConsumer2</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(channel);</span><br><span class="line">        <span class="built_in">this</span>.channel = channel;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;bodyï¼š&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">        System.out.println(<span class="string">&quot;å°†æ—¥å¿—ä¿¡æ¯å­˜å‚¨åˆ°æ•°æ®åº“.....&quot;</span>);</span><br><span class="line">        channel.basicAck(envelope.getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºé€šä¿¡â€œé€šé“â€ï¼Œç›¸å½“äºTCPä¸­çš„è™šæ‹Ÿè¿æ¥</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConfig.getRabbitConnection().createChannel();</span><br><span class="line">        <span class="comment">//åˆ›å»ºé˜Ÿåˆ—,å£°æ˜å¹¶åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—å·²å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨è¿™ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°ï¼šé˜Ÿåˆ—åç§°ID</span></span><br><span class="line">        <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°ï¼šæ˜¯å¦æŒä¹…åŒ–ï¼Œfalseå¯¹åº”ä¸æŒä¹…åŒ–æ•°æ®ï¼ŒMQåœæ‰æ•°æ®å°±ä¼šä¸¢å¤±</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šæ˜¯å¦é˜Ÿåˆ—ç§æœ‰åŒ–ï¼Œfalseåˆ™ä»£è¡¨æ‰€æœ‰æ¶ˆè´¹è€…éƒ½å¯ä»¥è®¿é—®ï¼Œtrueä»£è¡¨åªæœ‰ç¬¬ä¸€æ¬¡æ‹¥æœ‰å®ƒçš„æ¶ˆè´¹è€…æ‰èƒ½ä¸€ç›´ä½¿ç”¨ï¼Œå…¶ä»–æ¶ˆè´¹è€…ä¸è®©è®¿é—®</span></span><br><span class="line">        <span class="comment">//ç¬¬å››ä¸ªï¼šæ˜¯å¦è‡ªåŠ¨åˆ é™¤,falseä»£è¡¨è¿æ¥åœæ‰åä¸è‡ªåŠ¨åˆ é™¤æ‰è¿™ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">//å…¶ä»–é¢å¤–çš„å‚æ•°, null</span></span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;test_direct_queue2&quot;</span>,<span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//ä»MQæœåŠ¡å™¨ä¸­è·å–æ•°æ®</span></span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°ï¼šé˜Ÿåˆ—å</span></span><br><span class="line">        <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°ä»£è¡¨æ˜¯å¦è‡ªåŠ¨ç¡®è®¤æ”¶åˆ°æ¶ˆæ¯ï¼Œfalseä»£è¡¨æ‰‹åŠ¨ç¼–ç¨‹æ¥ç¡®è®¤æ¶ˆæ¯ï¼Œè¿™æ˜¯MQçš„æ¨èåšæ³•</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°è¦ä¼ å…¥DefaultConsumerçš„å®ç°ç±»</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;test_direct_queue2&quot;</span>, <span class="literal">false</span>, <span class="keyword">new</span> <span class="title class_">RouteConsumer2</span>(channel));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6cf7bbdd-8671-4d97-9a8a-e5c570e3becc-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> Connection rabbitConnection;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessage2RouteQueue</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºé€šä¿¡â€œé€šé“â€ï¼Œç›¸å½“äºTCPä¸­çš„è™šæ‹Ÿè¿æ¥</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> rabbitConnection.createChannel();</span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">   exchangeDeclare(String exchange, BuiltinExchangeType type, boolean durable, boolean autoDelete, boolean internal, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">   å‚æ•°ï¼š</span></span><br><span class="line"><span class="comment">    1. exchange:äº¤æ¢æœºåç§°</span></span><br><span class="line"><span class="comment">    2. type:äº¤æ¢æœºç±»å‹</span></span><br><span class="line"><span class="comment">        DIRECT(&quot;direct&quot;),ï¼šå®šå‘</span></span><br><span class="line"><span class="comment">        FANOUT(&quot;fanout&quot;),ï¼šæ‰‡å½¢ï¼ˆå¹¿æ’­ï¼‰ï¼Œå‘é€æ¶ˆæ¯åˆ°æ¯ä¸€ä¸ªä¸ä¹‹ç»‘å®šé˜Ÿåˆ—ã€‚</span></span><br><span class="line"><span class="comment">        TOPIC(&quot;topic&quot;),é€šé…ç¬¦çš„æ–¹å¼</span></span><br><span class="line"><span class="comment">        HEADERS(&quot;headers&quot;);å‚æ•°åŒ¹é…</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    3. durable:æ˜¯å¦æŒä¹…åŒ–</span></span><br><span class="line"><span class="comment">    4. autoDelete:è‡ªåŠ¨åˆ é™¤</span></span><br><span class="line"><span class="comment">    5. internalï¼šå†…éƒ¨ä½¿ç”¨ã€‚ ä¸€èˆ¬false</span></span><br><span class="line"><span class="comment">    6. argumentsï¼šå‚æ•°</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;test_direct&quot;</span>;</span><br><span class="line">    <span class="comment">//åˆ›å»ºäº¤æ¢æœº</span></span><br><span class="line">    channel.exchangeDeclare(exchangeName, BuiltinExchangeType.DIRECT,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºé˜Ÿåˆ—</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">&quot;test_direct_queue1&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">&quot;test_direct_queue2&quot;</span>;</span><br><span class="line"></span><br><span class="line">    channel.queueDeclare(queue1Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">    channel.queueDeclare(queue2Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    queueBind(String queue, String exchange, String routingKey)</span></span><br><span class="line"><span class="comment">    å‚æ•°ï¼š</span></span><br><span class="line"><span class="comment">        1. queueï¼šé˜Ÿåˆ—åç§°</span></span><br><span class="line"><span class="comment">        2. exchangeï¼šäº¤æ¢æœºåç§°</span></span><br><span class="line"><span class="comment">        3. routingKeyï¼šè·¯ç”±é”®ï¼Œç»‘å®šè§„åˆ™</span></span><br><span class="line"><span class="comment">            å¦‚æœäº¤æ¢æœºçš„ç±»å‹ä¸ºfanout ï¼ŒroutingKeyè®¾ç½®ä¸º&quot;&quot;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//é˜Ÿåˆ—1ç»‘å®š error</span></span><br><span class="line">    channel.queueBind(queue1Name,exchangeName,<span class="string">&quot;error&quot;</span>);</span><br><span class="line">    <span class="comment">//é˜Ÿåˆ—2ç»‘å®š info  error  warning</span></span><br><span class="line">    channel.queueBind(queue2Name,exchangeName,<span class="string">&quot;info&quot;</span>);</span><br><span class="line">    channel.queueBind(queue2Name,exchangeName,<span class="string">&quot;error&quot;</span>);</span><br><span class="line">    channel.queueBind(queue2Name,exchangeName,<span class="string">&quot;warning&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;æ—¥å¿—ä¿¡æ¯ï¼šå¼ ä¸‰è°ƒç”¨äº†deleteæ–¹æ³•...å‡ºé”™è¯¯äº†ã€‚ã€‚ã€‚æ—¥å¿—çº§åˆ«ï¼šerror...&quot;</span>;</span><br><span class="line">    <span class="comment">//å‘é€æ¶ˆæ¯</span></span><br><span class="line">    channel.basicPublish(exchangeName,<span class="string">&quot;warning&quot;</span>,<span class="literal">null</span>,body.getBytes());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é‡Šæ”¾èµ„æº</span></span><br><span class="line">    channel.close();</span><br><span class="line">    rabbitConnection.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6cf7bbdd-8671-4d97-9a8a-e5c570e3becc-3"><p>C2</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bodyï¼šæ—¥å¿—ä¿¡æ¯ï¼šå¼ ä¸‰è°ƒç”¨äº†deleteæ–¹æ³•<span class="string">...</span>å‡ºé”™è¯¯äº†ã€‚ã€‚ã€‚æ—¥å¿—çº§åˆ«ï¼šerror.<span class="string">..</span></span><br><span class="line">å°†æ—¥å¿—ä¿¡æ¯å­˜å‚¨åˆ°æ•°æ®åº“<span class="string">.....</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <mark class="hl-label green">å°ç»“</mark> <p>Routing æ¨¡å¼è¦æ±‚é˜Ÿåˆ—åœ¨ç»‘å®šäº¤æ¢æœºæ—¶è¦æŒ‡å®š routing keyï¼Œæ¶ˆæ¯ä¼šè½¬å‘åˆ°ç¬¦åˆ routing key çš„é˜Ÿåˆ—ã€‚</p><hr><h2 id="Topicsä¸»é¢˜æ¨¡å¼-Topic">Topicsä¸»é¢˜æ¨¡å¼(Topic)</h2><p>æ¨¡å¼è¯´æ˜ï¼š</p><ul><li>Topic ç±»å‹ä¸ Direct ç›¸æ¯”ï¼Œéƒ½æ˜¯å¯ä»¥æ ¹æ® RoutingKey æŠŠæ¶ˆæ¯è·¯ç”±åˆ°ä¸åŒçš„é˜Ÿåˆ—ã€‚</li><li>åªä¸è¿‡ Topic ç±»å‹Exchange å¯ä»¥è®©é˜Ÿåˆ—åœ¨ç»‘å®š Routing key çš„æ—¶å€™ä½¿ç”¨é€šé…ç¬¦ï¼</li><li>Routingkey ä¸€èˆ¬éƒ½æ˜¯æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå•è¯ç»„æˆï¼Œå¤šä¸ªå•è¯ä¹‹é—´ä»¥â€.â€åˆ†å‰²ï¼Œä¾‹å¦‚ï¼š item.insert</li><li>é€šé…ç¬¦è§„åˆ™ï¼š# åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªè¯ï¼Œ* åŒ¹é…ä¸å¤šä¸å°‘æ°å¥½1ä¸ªè¯ï¼Œä¾‹å¦‚ï¼šitem.# èƒ½å¤ŸåŒ¹é… item.insert.abcæˆ–è€… item.insertï¼Œitem.* åªèƒ½åŒ¹é… item.insert</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230627143522395.png" alt="image-20230627143522395"></p><mark class="hl-label blue">ç¤ºä¾‹</mark> <div class="tabs" id="4057a61c-cdcf-415e-ac49-9e8d69c468dd"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#4057a61c-cdcf-415e-ac49-9e8d69c468dd-1"><i class="fas fa-bug"></i>åˆ›å»ºæ¶ˆè´¹è€…</button></li><li class="tab"><button type="button" data-href="#4057a61c-cdcf-415e-ac49-9e8d69c468dd-2"><i class="fas fa-cannabis"></i>å‘é€æ¶ˆæ¯</button></li><li class="tab"><button type="button" data-href="#4057a61c-cdcf-415e-ac49-9e8d69c468dd-3"><i class="fas fa-candy-cane"></i>è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="4057a61c-cdcf-415e-ac49-9e8d69c468dd-1"><div class="tabs" id="c2d5c0c1-1bd9-485b-b822-9b2852a455a3"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c2d5c0c1-1bd9-485b-b822-9b2852a455a3-1"><i class="fas fa-seedling"></i>1</button></li><li class="tab"><button type="button" data-href="#c2d5c0c1-1bd9-485b-b822-9b2852a455a3-2"><i class="fas fa-leaf"></i>2</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c2d5c0c1-1bd9-485b-b822-9b2852a455a3-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TopicConsumer1</span> <span class="keyword">extends</span> <span class="title class_">DefaultConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Channel channel;</span><br><span class="line">    <span class="comment">//é‡å†™æ„é€ å‡½æ•°,Channelé€šé“å¯¹è±¡éœ€è¦ä»å¤–å±‚ä¼ å…¥ï¼Œåœ¨handleDeliveryä¸­è¦ç”¨åˆ°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TopicConsumer1</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(channel);</span><br><span class="line">        <span class="built_in">this</span>.channel = channel;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;bodyï¼š&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">        System.out.println(<span class="string">&quot;å°†æ—¥å¿—ä¿¡æ¯å­˜å…¥æ•°æ®åº“.......&quot;</span>);</span><br><span class="line">        channel.basicAck(envelope.getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºé€šä¿¡â€œé€šé“â€ï¼Œç›¸å½“äºTCPä¸­çš„è™šæ‹Ÿè¿æ¥</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConfig.getRabbitConnection().createChannel();</span><br><span class="line">        <span class="comment">//åˆ›å»ºé˜Ÿåˆ—,å£°æ˜å¹¶åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—å·²å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨è¿™ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°ï¼šé˜Ÿåˆ—åç§°ID</span></span><br><span class="line">        <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°ï¼šæ˜¯å¦æŒä¹…åŒ–ï¼Œfalseå¯¹åº”ä¸æŒä¹…åŒ–æ•°æ®ï¼ŒMQåœæ‰æ•°æ®å°±ä¼šä¸¢å¤±</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šæ˜¯å¦é˜Ÿåˆ—ç§æœ‰åŒ–ï¼Œfalseåˆ™ä»£è¡¨æ‰€æœ‰æ¶ˆè´¹è€…éƒ½å¯ä»¥è®¿é—®ï¼Œtrueä»£è¡¨åªæœ‰ç¬¬ä¸€æ¬¡æ‹¥æœ‰å®ƒçš„æ¶ˆè´¹è€…æ‰èƒ½ä¸€ç›´ä½¿ç”¨ï¼Œå…¶ä»–æ¶ˆè´¹è€…ä¸è®©è®¿é—®</span></span><br><span class="line">        <span class="comment">//ç¬¬å››ä¸ªï¼šæ˜¯å¦è‡ªåŠ¨åˆ é™¤,falseä»£è¡¨è¿æ¥åœæ‰åä¸è‡ªåŠ¨åˆ é™¤æ‰è¿™ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">//å…¶ä»–é¢å¤–çš„å‚æ•°, null</span></span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;test_topic_queue1&quot;</span>,<span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//ä»MQæœåŠ¡å™¨ä¸­è·å–æ•°æ®</span></span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°ï¼šé˜Ÿåˆ—å</span></span><br><span class="line">        <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°ä»£è¡¨æ˜¯å¦è‡ªåŠ¨ç¡®è®¤æ”¶åˆ°æ¶ˆæ¯ï¼Œfalseä»£è¡¨æ‰‹åŠ¨ç¼–ç¨‹æ¥ç¡®è®¤æ¶ˆæ¯ï¼Œè¿™æ˜¯MQçš„æ¨èåšæ³•</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°è¦ä¼ å…¥DefaultConsumerçš„å®ç°ç±»</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;test_topic_queue1&quot;</span>, <span class="literal">false</span>, <span class="keyword">new</span> <span class="title class_">TopicConsumer1</span>(channel));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c2d5c0c1-1bd9-485b-b822-9b2852a455a3-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TopicConsumer2</span> <span class="keyword">extends</span> <span class="title class_">DefaultConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Channel channel;</span><br><span class="line">    <span class="comment">//é‡å†™æ„é€ å‡½æ•°,Channelé€šé“å¯¹è±¡éœ€è¦ä»å¤–å±‚ä¼ å…¥ï¼Œåœ¨handleDeliveryä¸­è¦ç”¨åˆ°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TopicConsumer2</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(channel);</span><br><span class="line">        <span class="built_in">this</span>.channel = channel;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;bodyï¼š&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">        System.out.println(<span class="string">&quot;å°†æ—¥å¿—ä¿¡æ¯æ‰“å°æ§åˆ¶å°.......&quot;</span>);</span><br><span class="line">        channel.basicAck(envelope.getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºé€šä¿¡â€œé€šé“â€ï¼Œç›¸å½“äºTCPä¸­çš„è™šæ‹Ÿè¿æ¥</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConfig.getRabbitConnection().createChannel();</span><br><span class="line">        <span class="comment">//åˆ›å»ºé˜Ÿåˆ—,å£°æ˜å¹¶åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—å·²å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨è¿™ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°ï¼šé˜Ÿåˆ—åç§°ID</span></span><br><span class="line">        <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°ï¼šæ˜¯å¦æŒä¹…åŒ–ï¼Œfalseå¯¹åº”ä¸æŒä¹…åŒ–æ•°æ®ï¼ŒMQåœæ‰æ•°æ®å°±ä¼šä¸¢å¤±</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šæ˜¯å¦é˜Ÿåˆ—ç§æœ‰åŒ–ï¼Œfalseåˆ™ä»£è¡¨æ‰€æœ‰æ¶ˆè´¹è€…éƒ½å¯ä»¥è®¿é—®ï¼Œtrueä»£è¡¨åªæœ‰ç¬¬ä¸€æ¬¡æ‹¥æœ‰å®ƒçš„æ¶ˆè´¹è€…æ‰èƒ½ä¸€ç›´ä½¿ç”¨ï¼Œå…¶ä»–æ¶ˆè´¹è€…ä¸è®©è®¿é—®</span></span><br><span class="line">        <span class="comment">//ç¬¬å››ä¸ªï¼šæ˜¯å¦è‡ªåŠ¨åˆ é™¤,falseä»£è¡¨è¿æ¥åœæ‰åä¸è‡ªåŠ¨åˆ é™¤æ‰è¿™ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">//å…¶ä»–é¢å¤–çš„å‚æ•°, null</span></span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;test_topic_queue2&quot;</span>,<span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//ä»MQæœåŠ¡å™¨ä¸­è·å–æ•°æ®</span></span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°ï¼šé˜Ÿåˆ—å</span></span><br><span class="line">        <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°ä»£è¡¨æ˜¯å¦è‡ªåŠ¨ç¡®è®¤æ”¶åˆ°æ¶ˆæ¯ï¼Œfalseä»£è¡¨æ‰‹åŠ¨ç¼–ç¨‹æ¥ç¡®è®¤æ¶ˆæ¯ï¼Œè¿™æ˜¯MQçš„æ¨èåšæ³•</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°è¦ä¼ å…¥DefaultConsumerçš„å®ç°ç±»</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;test_topic_queue2&quot;</span>, <span class="literal">false</span>, <span class="keyword">new</span> <span class="title class_">TopicConsumer2</span>(channel));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4057a61c-cdcf-415e-ac49-9e8d69c468dd-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessage2TopicQueue</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºé€šä¿¡â€œé€šé“â€ï¼Œç›¸å½“äºTCPä¸­çš„è™šæ‹Ÿè¿æ¥</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> rabbitConnection.createChannel();</span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">   exchangeDeclare(String exchange, BuiltinExchangeType type, boolean durable, boolean autoDelete, boolean internal, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">   å‚æ•°ï¼š</span></span><br><span class="line"><span class="comment">    1. exchange:äº¤æ¢æœºåç§°</span></span><br><span class="line"><span class="comment">    2. type:äº¤æ¢æœºç±»å‹</span></span><br><span class="line"><span class="comment">        DIRECT(&quot;direct&quot;),ï¼šå®šå‘</span></span><br><span class="line"><span class="comment">        FANOUT(&quot;fanout&quot;),ï¼šæ‰‡å½¢ï¼ˆå¹¿æ’­ï¼‰ï¼Œå‘é€æ¶ˆæ¯åˆ°æ¯ä¸€ä¸ªä¸ä¹‹ç»‘å®šé˜Ÿåˆ—ã€‚</span></span><br><span class="line"><span class="comment">        TOPIC(&quot;topic&quot;),é€šé…ç¬¦çš„æ–¹å¼</span></span><br><span class="line"><span class="comment">        HEADERS(&quot;headers&quot;);å‚æ•°åŒ¹é…</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    3. durable:æ˜¯å¦æŒä¹…åŒ–</span></span><br><span class="line"><span class="comment">    4. autoDelete:è‡ªåŠ¨åˆ é™¤</span></span><br><span class="line"><span class="comment">    5. internalï¼šå†…éƒ¨ä½¿ç”¨ã€‚ ä¸€èˆ¬false</span></span><br><span class="line"><span class="comment">    6. argumentsï¼šå‚æ•°</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;test_topic&quot;</span>;</span><br><span class="line">    <span class="comment">//åˆ›å»ºäº¤æ¢æœº</span></span><br><span class="line">    channel.exchangeDeclare(exchangeName, BuiltinExchangeType.TOPIC,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//åˆ›å»ºé˜Ÿåˆ—</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">&quot;test_topic_queue1&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">&quot;test_topic_queue2&quot;</span>;</span><br><span class="line">    channel.queueDeclare(queue1Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">    channel.queueDeclare(queue2Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//7. ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    queueBind(String queue, String exchange, String routingKey)</span></span><br><span class="line"><span class="comment">    å‚æ•°ï¼š</span></span><br><span class="line"><span class="comment">        1. queueï¼šé˜Ÿåˆ—åç§°</span></span><br><span class="line"><span class="comment">        2. exchangeï¼šäº¤æ¢æœºåç§°</span></span><br><span class="line"><span class="comment">        3. routingKeyï¼šè·¯ç”±é”®ï¼Œç»‘å®šè§„åˆ™</span></span><br><span class="line"><span class="comment">            å¦‚æœäº¤æ¢æœºçš„ç±»å‹ä¸ºfanout ï¼ŒroutingKeyè®¾ç½®ä¸º&quot;&quot;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// routing key  ç³»ç»Ÿçš„åç§°.æ—¥å¿—çš„çº§åˆ«ã€‚</span></span><br><span class="line">    <span class="comment">//=éœ€æ±‚ï¼š æ‰€æœ‰errorçº§åˆ«çš„æ—¥å¿—å­˜å…¥æ•°æ®åº“ï¼Œæ‰€æœ‰orderç³»ç»Ÿçš„æ—¥å¿—å­˜å…¥æ•°æ®åº“</span></span><br><span class="line">    channel.queueBind(queue1Name,exchangeName,<span class="string">&quot;#.error&quot;</span>);</span><br><span class="line">    channel.queueBind(queue1Name,exchangeName,<span class="string">&quot;order.*&quot;</span>);</span><br><span class="line">    channel.queueBind(queue2Name,exchangeName,<span class="string">&quot;*.*&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;æ—¥å¿—ä¿¡æ¯ï¼šå¼ ä¸‰è°ƒç”¨äº†findAllæ–¹æ³•...æ—¥å¿—çº§åˆ«ï¼šinfo...&quot;</span>;</span><br><span class="line">    <span class="comment">//å‘é€æ¶ˆæ¯</span></span><br><span class="line">    channel.basicPublish(exchangeName,<span class="string">&quot;goods.error&quot;</span>,<span class="literal">null</span>,body.getBytes());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é‡Šæ”¾èµ„æº</span></span><br><span class="line">    channel.close();</span><br><span class="line">    rabbitConnection.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4057a61c-cdcf-415e-ac49-9e8d69c468dd-3"><p>C1</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bodyï¼šæ—¥å¿—ä¿¡æ¯ï¼šå¼ ä¸‰è°ƒç”¨äº†findAllæ–¹æ³•<span class="params">...</span>æ—¥å¿—çº§åˆ«ï¼šinfo<span class="params">...</span></span><br><span class="line">å°†æ—¥å¿—ä¿¡æ¯å­˜å…¥æ•°æ®åº“<span class="params">...</span><span class="params">...</span>.</span><br></pre></td></tr></table></figure><p>C2</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bodyï¼šæ—¥å¿—ä¿¡æ¯ï¼šå¼ ä¸‰è°ƒç”¨äº†findAllæ–¹æ³•<span class="params">...</span>æ—¥å¿—çº§åˆ«ï¼šinfo<span class="params">...</span></span><br><span class="line">å°†æ—¥å¿—ä¿¡æ¯æ‰“å°æ§åˆ¶å°<span class="params">...</span><span class="params">...</span>.</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><mark class="hl-label green">å°ç»“</mark> <p>Topic ä¸»é¢˜æ¨¡å¼å¯ä»¥å®ç°Pub/Sub å‘å¸ƒä¸è®¢é˜…æ¨¡å¼å’ŒRouting è·¯ç”±æ¨¡å¼çš„åŠŸèƒ½ï¼Œåªæ˜¯Topic åœ¨é…ç½®routing key çš„æ—¶å€™å¯ä»¥ä½¿ç”¨é€šé…ç¬¦ï¼Œæ˜¾å¾—æ›´åŠ çµæ´»ã€‚</p><hr><h2 id="å·¥ä½œæ¨¡å¼æ€»ç»“">å·¥ä½œæ¨¡å¼æ€»ç»“</h2><ol><li><p>ç®€å•æ¨¡å¼<br>ä¸€ä¸ªç”Ÿäº§è€…ã€ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œä¸éœ€è¦è®¾ç½®äº¤æ¢æœºï¼ˆä½¿ç”¨é»˜è®¤çš„äº¤æ¢æœºï¼‰ã€‚</p></li><li><p>å·¥ä½œé˜Ÿåˆ—æ¨¡å¼ Work Queue<br>ä¸€ä¸ªç”Ÿäº§è€…ã€å¤šä¸ªæ¶ˆè´¹è€…ï¼ˆç«äº‰å…³ç³»ï¼‰ï¼Œä¸éœ€è¦è®¾ç½®äº¤æ¢æœºï¼ˆä½¿ç”¨é»˜è®¤çš„äº¤æ¢æœºï¼‰ã€‚</p></li><li><p>å‘å¸ƒè®¢é˜…æ¨¡å¼ Publish/subscribe<br>éœ€è¦è®¾ç½®ç±»å‹ä¸º<code>fanout</code>çš„äº¤æ¢æœºï¼Œå¹¶ä¸”äº¤æ¢æœºå’Œé˜Ÿåˆ—è¿›è¡Œç»‘å®šï¼Œå½“å‘é€æ¶ˆæ¯åˆ°äº¤æ¢æœºåï¼Œäº¤æ¢æœºä¼šå°†æ¶ˆæ¯å‘é€åˆ°ç»‘å®šçš„é˜Ÿåˆ—ã€‚</p></li><li><p>è·¯ç”±æ¨¡å¼</p><p>Routingéœ€è¦è®¾ç½®ç±»å‹ä¸º<code>direct</code>çš„äº¤æ¢æœºï¼Œäº¤æ¢æœºå’Œé˜Ÿåˆ—è¿›è¡Œç»‘å®šï¼Œå¹¶ä¸”æŒ‡å®šrouting keyï¼Œå½“å‘é€æ¶ˆæ¯åˆ°äº¤æ¢æœºåï¼Œäº¤æ¢æœºä¼šæ ¹æ®routing keyå°†æ¶ˆæ¯å‘é€åˆ°å¯¹åº”çš„é˜Ÿåˆ—ã€‚</p></li><li><p>é€šé…ç¬¦æ¨¡å¼ Topic</p><p>éœ€è¦è®¾ç½®ç±»å‹ä¸º<code>topic</code>çš„äº¤æ¢æœºï¼Œäº¤æ¢æœºå’Œé˜Ÿåˆ—è¿›è¡Œç»‘å®šï¼Œå¹¶ä¸”æŒ‡å®šé€šé…ç¬¦æ–¹å¼çš„routing keyï¼Œå½“å‘é€æ¶ˆæ¯åˆ°äº¤æ¢æœºåï¼Œäº¤æ¢æœºä¼šæ ¹æ®routing keyå°†æ¶ˆæ¯å‘é€åˆ°å¯¹åº”çš„é˜Ÿåˆ—ã€‚</p></li></ol><hr><hr><h2 id="SpringBootæ•´åˆRabbitMQ">SpringBootæ•´åˆRabbitMQ</h2><div class="tabs" id="cfaca039-d38c-4b22-81b6-42a79b6d5668"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#cfaca039-d38c-4b22-81b6-42a79b6d5668-1"><i class="fas fa-award"></i>å¼•å…¥ä¾èµ–</button></li><li class="tab"><button type="button" data-href="#cfaca039-d38c-4b22-81b6-42a79b6d5668-2"><i class="fas fa-baseball-ball"></i>åˆ›å»ºé…ç½®æ–‡ä»¶</button></li><li class="tab"><button type="button" data-href="#cfaca039-d38c-4b22-81b6-42a79b6d5668-3"><i class="fas fa-bone"></i>åˆçº§ç”¨æ³•</button></li><li class="tab"><button type="button" data-href="#cfaca039-d38c-4b22-81b6-42a79b6d5668-4"><i class="fas fa-anchor"></i>é«˜çº§ç”¨æ³•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="cfaca039-d38c-4b22-81b6-42a79b6d5668-1"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cfaca039-d38c-4b22-81b6-42a79b6d5668-2"><p>application.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">my_vhost</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ³¨è§£<code>@EnableRabbit</code>æ¥å£°æ˜å¼€å¯ï¼Œå…¶å¯æ”¾åœ¨å¯åŠ¨ç±»ä¸Šï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨ä½ è‡ªå·±å†™çš„rabbité…ç½®ç±»ä¸Šã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cfaca039-d38c-4b22-81b6-42a79b6d5668-3"><div class="tabs" id="5364ad95-30a3-4ad0-b94d-b4c5badc237c"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#5364ad95-30a3-4ad0-b94d-b4c5badc237c-1"><i class="fas fa-seedling"></i>å¼€å¯rabbitmq</button></li><li class="tab"><button type="button" data-href="#5364ad95-30a3-4ad0-b94d-b4c5badc237c-2"><i class="fas fa-leaf"></i>ç›‘å¬æ¶ˆè´¹æ¶ˆæ¯</button></li><li class="tab"><button type="button" data-href="#5364ad95-30a3-4ad0-b94d-b4c5badc237c-3"><i class="fab fa-apple"></i>å‘é€æ¶ˆæ¯</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="5364ad95-30a3-4ad0-b94d-b4c5badc237c-1"><p>ä½¿ç”¨æ³¨è§£<code>@EnableRabbit</code>æ¥å£°æ˜å¼€å¯ï¼Œå…¶å¯æ”¾åœ¨å¯åŠ¨ç±»ä¸Šï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨ä½ è‡ªå·±å†™çš„rabbité…ç½®ç±»ä¸Šã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableRabbit</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitmqIntegrateApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(RabbitmqIntegrateApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5364ad95-30a3-4ad0-b94d-b4c5badc237c-2"><p>ä½¿ç”¨<code>@RabbitListener</code>æ³¨è§£å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueueConsumer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;ss007&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receive</span><span class="params">(<span class="meta">@Payload</span> String messageBody)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ss007é˜Ÿåˆ—ï¼š&quot;</span>+messageBody);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç åœ¨ç›‘å¬<code>ss007</code>é˜Ÿåˆ—ï¼Œåªè¦è¿™ä¸ªé˜Ÿåˆ—é‡Œé¢å­˜åœ¨æ¶ˆæ¯ï¼Œå®ƒå°±ä¼šæ¶ˆè´¹ã€‚</p><p>å€¼å¾—æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œè¿™æ ·å†™è¦æ±‚<code>ss007</code>è¿™ä¸ªé˜Ÿåˆ—æå‰åˆ›å»ºå¥½äº†ï¼Œä¸ç„¶ä¼šæŠ¥é”™ã€‚</p><p>åœ¨rabbitmqçš„ç®¡ç†åå°ï¼Œåªå¡«å†™åç§°<code>ss007</code>å…¶ä»–çš„éƒ½ä½¿ç”¨é»˜è®¤å€¼å³å¯ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5364ad95-30a3-4ad0-b94d-b4c5badc237c-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;å‘é…åˆ°æç“¦ç‰¹å¤§é™†åƒäº”åˆ†ç†ŸçŒªæ’ï¼Œå’Œæ¤ç‰©æŠ¢ç©ºæ°”ï¼Œä¹˜åæµ®åŠ›å¤§äºé‡åŠ›çš„èˆ¹èº²é¿å‰§æ¯’çš„èŸ’è›‡ã€‚&quot;</span>;</span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;ss007&quot;</span>,msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹æˆ‘ä»¬ç¨‹åºçš„è¾“å‡ºï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">2023</span>-<span class="number">06</span>-<span class="number">27</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">39</span>.<span class="number">031</span>  INFO <span class="number">74710</span> ---<span class="meta"> [ntContainer#0-1] c.e.r.Consumer.QueueConsumer             : ss007é˜Ÿåˆ—:å‘é…åˆ°æç“¦ç‰¹å¤§é™†åƒäº”åˆ†ç†ŸçŒªæ’ï¼Œå’Œæ¤ç‰©æŠ¢ç©ºæ°”ï¼Œä¹˜åæµ®åŠ›å¤§äºé‡åŠ›çš„èˆ¹èº²é¿å‰§æ¯’çš„èŸ’è›‡ã€‚</span></span><br></pre></td></tr></table></figure><p>å¯è§ï¼Œæˆ‘ä»¬åˆšå‘<code>ss007</code>é˜Ÿåˆ—å‘é€äº†ä¸€æ¡æ¶ˆæ¯ï¼Œè¿™æ¡æ¶ˆæ¯å°±è¢«æˆ‘ä»¬åˆšæ‰å†™çš„æ¶ˆè´¹è€…ç»™æ¶ˆè´¹äº†ã€‚</p><p>å‰é¢æˆ‘ä»¬ä»‹ç»Rabbitmqçš„æ—¶å€™è¯´æ¯ä¸ªé˜Ÿåˆ—éœ€è¦ç»‘å®šåˆ°ä¸€ä¸ªäº¤æ¢å™¨ä¸Šæ‰èƒ½æ­£å¸¸æ¥æ”¶æ¶ˆæ¯ï¼Œä½†æ˜¯æˆ‘ä»¬å¥½åƒæ²¡æœ‰å®šä¹‰äº¤æ¢å™¨ï¼Œä¹Ÿæ²¡æœ‰ç»‘å®šä»»ä½•äº¤æ¢å™¨ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿ</p><p>å…¶å®æ˜¯å› ä¸ºï¼Œrabbitmqæœ‰ä¸€ä¸ªé»˜è®¤çš„Exchangeï¼Œè€Œæ¯ä¸ªé˜Ÿåˆ—éƒ½ä¼šé»˜è®¤ç»‘å®šå®ƒã€‚æ‰€ä»¥æˆ‘ä»¬å‰é¢çš„æ¼”ç¤ºä½¿ç”¨çš„æ˜¯é»˜è®¤Exchangeï¼Œå®ƒæ˜¯ä¸€ä¸ªdirectç±»å‹çš„äº¤æ¢å™¨ã€‚</p><p>é‚£routing keyæˆ‘ä»¬ä¹Ÿæ²¡æŒ‡å®šå•Šï¼Œé»˜è®¤Exchangeä½¿ç”¨å“ªä¸ªè·¯ç”±keyå‘¢ï¼Ÿ é»˜è®¤é˜Ÿåˆ—åç§°ä½œä¸ºè·¯ç”±keyï¼Œä¹Ÿå°±æ˜¯<code>ss007</code>ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cfaca039-d38c-4b22-81b6-42a79b6d5668-4"><div class="tabs" id="a7ab3680-b4b7-42fc-9328-a5912b1dc73f"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#a7ab3680-b4b7-42fc-9328-a5912b1dc73f-1"><i class="fas fa-cat"></i>é…ç½®äº¤æ¢å™¨ä¸é˜Ÿåˆ—</button></li><li class="tab"><button type="button" data-href="#a7ab3680-b4b7-42fc-9328-a5912b1dc73f-2"><i class="fas fa-horse"></i>ç›‘å¬æ¶ˆè´¹æ¶ˆæ¯</button></li><li class="tab"><button type="button" data-href="#a7ab3680-b4b7-42fc-9328-a5912b1dc73f-3"><i class="fas fa-dove"></i>å‘é€æ¶ˆæ¯</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="a7ab3680-b4b7-42fc-9328-a5912b1dc73f-1"><p>åˆ›å»ºäº†ä¸€ä¸ªExchangeï¼Œä¸¤ä¸ªé˜Ÿåˆ—ï¼Œå¹¶å°†è¿™ä¸¤ä¸ªé˜Ÿåˆ—ç»‘å®šåˆ°äº†é‚£ä¸ªExchangeä¸Šã€‚æ³¨æ„ä¸¤ä¸ªç»‘å®šä½¿ç”¨çš„routingkeyæ˜¯ä¸ä¸€æ ·çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">topicQueue1</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;topicQueue1&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">topicQueue2</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;topicQueue2&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TopicExchange <span class="title function_">topicExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TopicExchange</span>(<span class="string">&quot;topicExchange&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">topicBinding1</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(topicQueue1()).to(topicExchange())</span><br><span class="line">                .with(<span class="string">&quot;ss007.ç‹äºŒç‹—.è§‰é†’&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">topicBinding2</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(topicQueue2()).to(topicExchange())</span><br><span class="line">                .with(<span class="string">&quot;ss007.*.è§‰é†’&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a7ab3680-b4b7-42fc-9328-a5912b1dc73f-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueueConsumer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;topicQueue1&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveTopic1</span><span class="params">(<span class="meta">@Payload</span> String messageBody)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;topic1é˜Ÿåˆ—ï¼š&quot;</span> + messageBody);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;topicQueue2&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveTopic2</span><span class="params">(<span class="meta">@Payload</span> String messageBody)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;topic2é˜Ÿåˆ—ï¼š&quot;</span> + messageBody);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a7ab3680-b4b7-42fc-9328-a5912b1dc73f-3"><p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æˆ‘ä»¬ä¸Šä¸€æ­¥é…ç½®çš„äº¤æ¢å™¨ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯routingkeyï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æ¶ˆæ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendTopicMsg</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">routingKey</span> <span class="operator">=</span> <span class="string">&quot;ss007.ç‰›ç¿ èŠ±.è§‰é†’&quot;</span> ;</span><br><span class="line">    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;å‘é…åˆ°æç“¦ç‰¹å¤§é™†åƒäº”åˆ†ç†ŸçŒªæ’ï¼Œå’Œæ¤ç‰©æŠ¢ç©ºæ°”ï¼Œä¹˜åæµ®åŠ›å¤§äºé‡åŠ›çš„èˆ¹èº²é¿å‰§æ¯’çš„èŸ’è›‡ã€‚&quot;</span>;</span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;topicExchange&quot;</span>,routingKey,msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ç¨‹åºè¾“å‡ºï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">topic2é˜Ÿåˆ—ï¼šå‘é…åˆ°æç“¦ç‰¹å¤§é™†åƒäº”åˆ†ç†ŸçŒªæ’ï¼Œå’Œæ¤ç‰©æŠ¢ç©ºæ°”ï¼Œä¹˜åæµ®åŠ›å¤§äºé‡åŠ›çš„èˆ¹èº²é¿å‰§æ¯’çš„èŸ’è›‡ã€‚</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å‘äº¤æ¢å™¨å‘é€äº†ä¸€æ¡æ¶ˆæ¯ï¼Œè·¯ç”±keyæ˜¯<code>ss007.ç‰›ç¿ èŠ±.è§‰é†’</code>ï¼Œå®ƒåŒ¹é…åˆ°äº†æˆ‘ä»¬topicBinding2çš„è·¯ç”±keyï¼š<code>ss007.*.è§‰é†’</code>ï¼Œè€Œæ²¡æœ‰åŒ¹é…åˆ°topicBinding1çš„è·¯ç”±keyï¼š<code>ss007.ç‹äºŒç‹—.è§‰é†’</code>ï¼Œæ‰€ä»¥åªæœ‰topicQueue2é‡Œä¸¢å…¥äº†æ¶ˆæ¯ã€‚</p><p>è¿™æ¬¡ä½¿ç”¨è·¯ç”±å­—æ®µä¸º<code>ss007.ç‹äºŒç‹—.è§‰é†’</code></p><p>è¾“å‡ºï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">topic1é˜Ÿåˆ—ï¼šå‘é…åˆ°æç“¦ç‰¹å¤§é™†åƒäº”åˆ†ç†ŸçŒªæ’ï¼Œå’Œæ¤ç‰©æŠ¢ç©ºæ°”ï¼Œä¹˜åæµ®åŠ›å¤§äºé‡åŠ›çš„èˆ¹èº²é¿å‰§æ¯’çš„èŸ’è›‡ã€‚</span><br><span class="line">topic2é˜Ÿåˆ—ï¼šå‘é…åˆ°æç“¦ç‰¹å¤§é™†åƒäº”åˆ†ç†ŸçŒªæ’ï¼Œå’Œæ¤ç‰©æŠ¢ç©ºæ°”ï¼Œä¹˜åæµ®åŠ›å¤§äºé‡åŠ›çš„èˆ¹èº²é¿å‰§æ¯’çš„èŸ’è›‡ã€‚</span><br></pre></td></tr></table></figure><p>å¯è§ï¼Œä¸¤ä¸ªé˜Ÿåˆ—é‡Œé¢éƒ½è¢«ä¸¢å…¥äº†åŒæ ·çš„æ¶ˆæ¯ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™æ˜¯ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯Topicç±»å‹çš„äº¤æ¢å™¨ï¼Œè€Œä¸”è·¯ç”±keyå¯ä»¥åŒ¹é…åˆ°ä¸¤ä¸ªé˜Ÿåˆ—çš„ç»‘å®šã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> ]]></content>
    
    
    <summary type="html">RabbitMQäº¤æ¢æœº(å·¥ä½œæ¨¡å¼)ã€SpringBootæ•´åˆRabbitMQ</summary>
    
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="æ¶ˆæ¯é˜Ÿåˆ—" scheme="https://wuwawawa.github.io/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>RabbitMQæ¶ˆæ¯åº”ç­”ä¸åˆ†å‘</title>
    <link href="https://wuwawawa.github.io/posts/203330d3.html"/>
    <id>https://wuwawawa.github.io/posts/203330d3.html</id>
    <published>2023-06-28T00:57:49.000Z</published>
    <updated>2023-06-28T01:53:49.758Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ¶ˆæ¯åº”ç­”">æ¶ˆæ¯åº”ç­”</h2><p>æ¶ˆè´¹è€…å®Œæˆä¸€ä¸ªä»»åŠ¡å¯èƒ½éœ€è¦ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†ä¸€ä¸ªé•¿çš„ä»»åŠ¡å¹¶ä»…åªå®Œæˆäº†éƒ¨åˆ†çªç„¶å®ƒæŒ‚æ‰äº†ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µã€‚RabbitMQ ä¸€æ—¦å‘æ¶ˆè´¹è€…ä¼ é€’äº†ä¸€æ¡æ¶ˆæ¯ï¼Œä¾¿ç«‹å³å°†è¯¥æ¶ˆæ¯æ ‡è®°ä¸ºåˆ é™¤ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œçªç„¶æœ‰ä¸ªæ¶ˆè´¹è€…æŒ‚æ‰äº†ï¼Œæˆ‘ä»¬å°†ä¸¢å¤±æ­£åœ¨å¤„ç†çš„æ¶ˆæ¯ã€‚ä»¥åŠåç»­å‘é€ç»™è¯¥æ¶ˆè´¹è€…çš„æ¶ˆæ¯ï¼Œå› ä¸ºå®ƒæ— æ³•æ¥æ”¶åˆ°ã€‚</p><p>ä¸ºäº†ä¿è¯æ¶ˆæ¯åœ¨å‘é€è¿‡ç¨‹ä¸­ä¸ä¸¢å¤±ï¼Œå¼•å…¥æ¶ˆæ¯åº”ç­”æœºåˆ¶ï¼Œæ¶ˆæ¯åº”ç­”å°±æ˜¯ï¼š<span class='p green'>æ¶ˆè´¹è€…åœ¨æ¥æ”¶åˆ°æ¶ˆæ¯å¹¶ä¸”å¤„ç†è¯¥æ¶ˆæ¯ä¹‹åï¼Œå‘Šè¯‰rabbitmqå®ƒå·²ç»å¤„ç†äº†ï¼Œrabbitmqå¯ä»¥æŠŠè¯¥æ¶ˆæ¯åˆ é™¤äº†ã€‚</span></p><hr><h3 id="è‡ªåŠ¨åº”ç­”">è‡ªåŠ¨åº”ç­”</h3><p>æ¶ˆæ¯å‘é€åç«‹å³è¢«è®¤ä¸ºå·²ç»ä¼ é€æˆåŠŸï¼Œè¿™ç§æ¨¡å¼éœ€è¦åœ¨<strong>é«˜ååé‡å’Œæ•°æ®ä¼ è¾“å®‰å…¨æ€§æ–¹é¢åšæƒè¡¡</strong>,å› ä¸ºè¿™ç§æ¨¡å¼å¦‚æœæ¶ˆæ¯åœ¨æ¥æ”¶åˆ°ä¹‹å‰ï¼Œæ¶ˆè´¹è€…é‚£è¾¹å‡ºç°è¿æ¥æˆ–è€… channel å…³é—­ï¼Œé‚£ä¹ˆæ¶ˆæ¯å°±ä¸¢å¤±äº†,å½“ç„¶å¦ä¸€æ–¹é¢è¿™ç§æ¨¡å¼æ¶ˆè´¹è€…é‚£è¾¹å¯ä»¥ä¼ é€’è¿‡è½½çš„æ¶ˆæ¯ï¼Œ<strong>æ²¡æœ‰å¯¹ä¼ é€’çš„æ¶ˆæ¯æ•°é‡è¿›è¡Œé™åˆ¶</strong>ï¼Œå½“ç„¶è¿™æ ·æœ‰å¯èƒ½ä½¿å¾—æ¶ˆè´¹è€…è¿™è¾¹ç”±äºæ¥æ”¶å¤ªå¤šè¿˜æ¥ä¸åŠå¤„ç†çš„æ¶ˆæ¯ï¼Œå¯¼è‡´è¿™äº›æ¶ˆæ¯çš„ç§¯å‹ï¼Œæœ€ç»ˆä½¿å¾—å†…å­˜è€—å°½ï¼Œæœ€ç»ˆè¿™äº›æ¶ˆè´¹è€…çº¿ç¨‹è¢«æ“ä½œç³»ç»Ÿæ€æ­»ï¼Œ<strong>æ‰€ä»¥è¿™ç§æ¨¡å¼ä»…é€‚ç”¨åœ¨æ¶ˆè´¹è€…å¯ä»¥é«˜æ•ˆå¹¶ä»¥æŸç§é€Ÿç‡èƒ½å¤Ÿå¤„ç†è¿™äº›æ¶ˆæ¯çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚</strong></p><hr><h3 id="æ‰‹åŠ¨åº”ç­”">æ‰‹åŠ¨åº”ç­”</h3><p>å½“ä¸€ä¸ªæ¶ˆè´¹è€…æ”¶åˆ°ä¸€ä¸ªå¿«é€’ï¼Œä½†æ˜¯è¿™ä¸ªåŒ…è£¹æ˜¯ç ´æŸçš„ï¼Œè¿™æ—¶å€™ä¸€èˆ¬ä¼šæœ‰ä»¥ä¸‹é€‰æ‹©</p><blockquote><p>æ‹’æ”¶å¿«é€’ï¼Œè®©å¿«é€’å‘˜æŠŠå¿«é€’å¯„å›ã€‚ ï¼ˆå¦‚æœæœ‰å¤šä¸ªconsumerå¯èƒ½è¿™æ¡æ¶ˆæ¯ä¼šåˆ°å…¶å®ƒçš„consumerä¸­ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªï¼Œé‚£ä¹ˆä¸‹æ¬¡è·å–è¿˜æ˜¯å¯ä»¥æ‹¿åˆ°ï¼‰</p><p>ç­¾æ”¶å¿«é€’ï¼Œç„¶åå·å·çš„æ‰”äº†ï¼ˆé’±å¤šä»»æ€§ï¼‰</p><p>æ‹’æ”¶å¿«é€’ï¼Œè”ç³»å•†å®¶å†ç»™æˆ‘è¡¥å‘ä¸€ä¸ª</p></blockquote><p>ä¸‹é¢æ˜¯å…·ä½“çš„æ–¹æ³•ï¼ŒBasicRejectåŒæ—¶æ‰¿æ‹…äº†æ‰”æ‰æ¶ˆæ¯ä¸é€€å›ã€‚åŒºåˆ«åœ¨ç¬¬äºŒä¸ªå‚æ•°ã€‚BasicNackåˆ™æ˜¯æ‰¹é‡è¿›è¡Œä¸Šé¢ä¸¤ä¸ªæ“ä½œï¼ŒDeliveryTagå°äºæˆ–ç­‰äºå½“å‰æ¶ˆæ¯çš„éƒ½ä¼šè¿›è¡Œè¯¥æ“ä½œï¼Œå½“ç„¶æ˜¯å¦æ‰¹é‡æ˜¯ç”±ç¬¬äºŒä¸ªå‚æ•°æ¥å†³å®šçš„ã€‚</p><p>BasicRecoveræ–¹æ³•åˆ™æ˜¯è¿›è¡Œè¡¥å‘æ“ä½œï¼Œå…¶ä¸­çš„å‚æ•°å¦‚æœä¸ºtrueæ˜¯æŠŠæ¶ˆæ¯é€€å›åˆ°queueä½†æ˜¯æœ‰å¯èƒ½è¢«å…¶å®ƒçš„consumeræ¥æ”¶åˆ°ï¼Œè®¾ç½®ä¸ºfalseæ˜¯åªè¡¥å‘ç»™å½“å‰çš„consumer</p><mark class="hl-label blue">æ‰‹åŠ¨æ¶ˆæ¯åº”ç­”çš„æ–¹æ³•</mark> <div class="tabs" id="a0f6f907-57ca-41b6-be17-62b82578e0f2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#a0f6f907-57ca-41b6-be17-62b82578e0f2-1"><i class="fas fa-seedling"></i>è‚¯å®šç¡®è®¤åº”ç­”basicAck</button></li><li class="tab"><button type="button" data-href="#a0f6f907-57ca-41b6-be17-62b82578e0f2-2"><i class="fas fa-leaf"></i>å¦å®šç¡®è®¤åº”ç­”basicReject</button></li><li class="tab"><button type="button" data-href="#a0f6f907-57ca-41b6-be17-62b82578e0f2-3"><i class="fab fa-apple"></i>å¦å®šç¡®è®¤basicNack</button></li><li class="tab"><button type="button" data-href="#a0f6f907-57ca-41b6-be17-62b82578e0f2-4"><i class="fas fa-tree"></i>è¡¥å‘æ¶ˆæ¯basicRecover</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="a0f6f907-57ca-41b6-be17-62b82578e0f2-1"><p><code>Channel.basicAck</code> ï¼š</p><p><code>basicAck(long deliveryTag, boolean multiple);</code></p><p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ¶ˆæ¯çš„æ ‡è®°ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦åº”ç”¨äºå¤šæ¶ˆæ¯ï¼ŒRabbitMQ å·²çŸ¥é“è¯¥æ¶ˆæ¯å¹¶ä¸”æˆåŠŸçš„å¤„ç†æ¶ˆæ¯ï¼Œå¯ä»¥å°†å…¶ä¸¢å¼ƒäº†</p><p>Multiple çš„è§£é‡Šï¼š</p><p>æ‰‹åŠ¨åº”ç­”çš„å¥½å¤„æ˜¯å¯ä»¥æ‰¹é‡åº”ç­”å¹¶ä¸”å‡å°‘ç½‘ç»œæ‹¥å µ</p><ul><li><p>true ä»£è¡¨æ‰¹é‡åº”ç­” channel ä¸Šæœªåº”ç­”çš„æ¶ˆæ¯</p><p>æ¯”å¦‚è¯´ channel ä¸Šæœ‰ä¼ é€ tag çš„æ¶ˆæ¯ 5,6,7,8 å½“å‰ tag æ˜¯ 8 é‚£ä¹ˆæ­¤æ—¶ 5-8 çš„è¿™äº›è¿˜æœªåº”ç­”çš„æ¶ˆæ¯éƒ½ä¼šè¢«ç¡®è®¤æ”¶åˆ°æ¶ˆæ¯åº”ç­”</p></li><li><p>false åŒä¸Šé¢ç›¸æ¯”åªä¼šåº”ç­” tag=8 çš„æ¶ˆæ¯ 5,6,7 è¿™ä¸‰ä¸ªæ¶ˆæ¯ä¾ç„¶ä¸ä¼šè¢«ç¡®è®¤æ”¶åˆ°æ¶ˆæ¯åº”ç­”</p></li></ul><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image.3vspi8fu4v20.webp" alt="image" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a0f6f907-57ca-41b6-be17-62b82578e0f2-2"><p><code>Channel.basicReject</code></p><p><code>basicReject(long deliveryTag, boolean requeue);</code></p><p>ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºæ‹’ç» <code>deliveryTag</code> å¯¹åº”çš„æ¶ˆæ¯ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦ <code>requeue</code>ï¼štrue åˆ™é‡æ–°å…¥é˜Ÿåˆ—ï¼Œfalse åˆ™ä¸¢å¼ƒæˆ–è€…è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ã€‚</p><p>è¯¥æ–¹æ³• reject åï¼Œè¯¥æ¶ˆè´¹è€…è¿˜æ˜¯ä¼šæ¶ˆè´¹åˆ°è¯¥æ¡è¢« reject çš„æ¶ˆæ¯ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a0f6f907-57ca-41b6-be17-62b82578e0f2-3"><p><code>Channel.basicNack</code> ï¼šè¡¨ç¤ºå·±æ‹’ç»å¤„ç†è¯¥æ¶ˆæ¯ï¼Œå¯ä»¥å°†å…¶ä¸¢å¼ƒäº†</p><p><code>basicNack(long deliveryTag, boolean multiple, boolean requeue);</code></p><p>ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºæ‹’ç» <code>deliveryTag</code> å¯¹åº”çš„æ¶ˆæ¯ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¡¨ç¤ºå¦åº”ç”¨äºå¤šæ¶ˆæ¯ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦ <code>requeue</code>ï¼Œä¸ basicReject åŒºåˆ«å°±æ˜¯åŒæ—¶æ”¯æŒå¤šä¸ªæ¶ˆæ¯ï¼Œå¯ä»¥ æ‹’ç»ç­¾æ”¶ è¯¥æ¶ˆè´¹è€…å…ˆå‰æ¥æ”¶æœª ack çš„æ‰€æœ‰æ¶ˆæ¯ã€‚æ‹’ç»ç­¾æ”¶åçš„æ¶ˆæ¯ä¹Ÿä¼šè¢«è‡ªå·±æ¶ˆè´¹åˆ°ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a0f6f907-57ca-41b6-be17-62b82578e0f2-4"><p><code>Channel.basicRecover</code></p><p><code>basicRecover(boolean requeue);</code></p><p>æ˜¯å¦æ¢å¤æ¶ˆæ¯åˆ°é˜Ÿåˆ—ï¼Œå‚æ•°æ˜¯æ˜¯å¦ <code>requeue</code>ï¼Œtrue åˆ™é‡æ–°å…¥é˜Ÿåˆ—ï¼Œå¹¶ä¸”å°½å¯èƒ½çš„å°†ä¹‹å‰ <code>recover</code> çš„æ¶ˆæ¯æŠ•é€’ç»™å…¶ä»–æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œè€Œä¸æ˜¯è‡ªå·±å†æ¬¡æ¶ˆè´¹ã€‚false åˆ™æ¶ˆæ¯ä¼šé‡æ–°è¢«æŠ•é€’ç»™è‡ªå·±ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="æ¶ˆæ¯è‡ªåŠ¨é‡æ–°å…¥é˜Ÿ">æ¶ˆæ¯è‡ªåŠ¨é‡æ–°å…¥é˜Ÿ</h3><p>å¦‚æœæ¶ˆè´¹è€…ç”±äºæŸäº›åŸå› å¤±å»è¿æ¥(å…¶é€šé“å·²å…³é—­ï¼Œè¿æ¥å·²å…³é—­æˆ– TCP è¿æ¥ä¸¢å¤±)ï¼Œå¯¼è‡´æ¶ˆæ¯æœªå‘é€ ACK ç¡®è®¤ï¼ŒRabbitMQ å°†äº†è§£åˆ°æ¶ˆæ¯æœªå®Œå…¨å¤„ç†ï¼Œå¹¶å°†å¯¹å…¶é‡æ–°æ’é˜Ÿã€‚å¦‚æœæ­¤æ—¶å…¶ä»–æ¶ˆè´¹è€…å¯ä»¥å¤„ç†ï¼Œå®ƒå°†å¾ˆå¿«å°†å…¶é‡æ–°åˆ†å‘ç»™å¦ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚è¿™æ ·ï¼Œå³ä½¿æŸä¸ªæ¶ˆè´¹è€…å¶å°”æ­»äº¡ï¼Œä¹Ÿå¯ä»¥ç¡®ä¿ä¸ä¼šä¸¢å¤±ä»»ä½•æ¶ˆæ¯ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image.4hplocbhsdk0.webp" alt="image" style="zoom:80%;" /><hr><hr><h2 id="RabbitMQæŒä¹…åŒ–">RabbitMQæŒä¹…åŒ–</h2><p>å½“ RabbitMQ æœåŠ¡åœæ‰ä»¥åï¼Œæ¶ˆæ¯ç”Ÿäº§è€…å‘é€è¿‡æ¥çš„æ¶ˆæ¯ä¸ä¸¢å¤±è¦å¦‚ä½•ä¿éšœï¼Ÿé»˜è®¤æƒ…å†µä¸‹ RabbitMQ é€€å‡ºæˆ–ç”±äºæŸç§åŸå› å´©æºƒæ—¶ï¼Œå®ƒå¿½è§†é˜Ÿåˆ—å’Œæ¶ˆæ¯ï¼Œé™¤éå‘ŠçŸ¥å®ƒä¸è¦è¿™æ ·åšã€‚ç¡®ä¿æ¶ˆæ¯ä¸ä¼šä¸¢å¤±éœ€è¦åšä¸¤ä»¶äº‹ï¼š<span class='p green'>æˆ‘ä»¬éœ€è¦å°†é˜Ÿåˆ—å’Œæ¶ˆæ¯éƒ½æ ‡è®°ä¸ºæŒä¹…åŒ–ã€‚</span></p><h3 id="é˜Ÿåˆ—æŒä¹…åŒ–">é˜Ÿåˆ—æŒä¹…åŒ–</h3><p>ä¹‹å‰æˆ‘ä»¬åˆ›å»ºçš„é˜Ÿåˆ—éƒ½æ˜¯éæŒä¹…åŒ–çš„ï¼ŒRabbitMQ å¦‚æœé‡å¯çš„åŒ–ï¼Œè¯¥é˜Ÿåˆ—å°±ä¼šè¢«åˆ é™¤æ‰ï¼Œå¦‚æœè¦é˜Ÿåˆ—å®ç°æŒä¹…åŒ–éœ€è¦åœ¨å£°æ˜é˜Ÿåˆ—çš„æ—¶å€™æŠŠ durable å‚æ•°è®¾ç½®ä¸ºtrueï¼Œä»£è¡¨å¼€å¯æŒä¹…åŒ–</p><p>åœ¨<strong>æ¶ˆæ¯ç”Ÿäº§è€…</strong>å¼€å¯æŒä¹…åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Task02</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é˜Ÿåˆ—åç§°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TASK_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ACK_QUEUE&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtils.getChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¼€å¯æŒä¹…åŒ–</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">durable</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">//å£°æ˜é˜Ÿåˆ—</span></span><br><span class="line">        channel.queueDeclare(TASK_QUEUE_NAME,durable,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//åœ¨æ§åˆ¶å°ä¸­è¾“å…¥ä¿¡æ¯</span></span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        System.out.println(<span class="string">&quot;è¯·è¾“å…¥ä¿¡æ¯ï¼š&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (scanner.hasNext())&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>,TASK_QUEUE_NAME,<span class="literal">null</span>,message.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;ç”Ÿäº§è€…å‘å‡ºæ¶ˆæ¯:&quot;</span>+ message);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„</p><blockquote><p>å¦‚æœä¹‹å‰å£°æ˜çš„é˜Ÿåˆ—ä¸æ˜¯æŒä¹…åŒ–çš„ï¼Œéœ€è¦æŠŠåŸå…ˆé˜Ÿåˆ—å…ˆåˆ é™¤ï¼Œæˆ–è€…é‡æ–°åˆ›å»ºä¸€ä¸ªæŒä¹…åŒ–çš„é˜Ÿåˆ—</p></blockquote><p>ä¸ç„¶å°±ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image.4nf70nwh0j60.webp" alt="image"></p><p>æŒä¹…åŒ–å‰åå¯¹æ¯”ï¼šDè¡¨ç¤ºDurable</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image.5tlb9m3bfh00.webp" alt="image"></p><hr><h3 id="æ¶ˆæ¯æŒä¹…åŒ–">æ¶ˆæ¯æŒä¹…åŒ–</h3><p>éœ€è¦åœ¨<strong>æ¶ˆæ¯ç”Ÿäº§è€…</strong>å‘å¸ƒæ¶ˆæ¯çš„æ—¶å€™ï¼Œå¼€å¯æ¶ˆæ¯çš„æŒä¹…åŒ–</p><p>åœ¨ basicPublish æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°æ·»åŠ è¿™ä¸ªå±æ€§ï¼š <code>MessageProperties.PERSISTENT_TEXT_PLAIN</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Task02</span> &#123;</span><br><span class="line">    <span class="comment">//é˜Ÿåˆ—åç§°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TASK_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ACK_QUEUE&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtils.getChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//é˜Ÿåˆ—æŒä¹…åŒ–</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">durable</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">//å£°æ˜é˜Ÿåˆ—</span></span><br><span class="line">        channel.queueDeclare(TASK_QUEUE_NAME,durable,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//åœ¨æ§åˆ¶å°ä¸­è¾“å…¥ä¿¡æ¯</span></span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        System.out.println(<span class="string">&quot;è¯·è¾“å…¥ä¿¡æ¯ï¼š&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (scanner.hasNext())&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">            <span class="comment">//è®¾ç½®ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ä¸ºæŒä¹…åŒ–æ¶ˆæ¯(è¦æ±‚ä¿å­˜åˆ°ç£ç›˜ä¸Š)</span></span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>,TASK_QUEUE_NAME, MessageProperties.PERSISTENT_TEXT_PLAIN,message.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;ç”Ÿäº§è€…å‘å‡ºæ¶ˆæ¯:&quot;</span>+ message);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†æ¶ˆæ¯æ ‡è®°ä¸ºæŒä¹…åŒ–å¹¶ä¸èƒ½å®Œå…¨ä¿è¯ä¸ä¼šä¸¢å¤±æ¶ˆæ¯ã€‚å°½ç®¡å®ƒå‘Šè¯‰ RabbitMQ å°†æ¶ˆæ¯ä¿å­˜åˆ°ç£ç›˜ï¼Œä½†æ˜¯è¿™é‡Œä¾ç„¶å­˜åœ¨å½“æ¶ˆæ¯åˆšå‡†å¤‡å­˜å‚¨åœ¨ç£ç›˜çš„æ—¶å€™ä½†æ˜¯è¿˜æ²¡æœ‰å­˜å‚¨å®Œï¼Œæ¶ˆæ¯è¿˜åœ¨ç¼“å­˜çš„ä¸€ä¸ªé—´éš”ç‚¹ã€‚æ­¤æ—¶å¹¶æ²¡æœ‰çœŸæ­£å†™å…¥ç£ç›˜ã€‚æŒä¹…æ€§ä¿è¯å¹¶ä¸å¼ºï¼Œä½†æ˜¯å¯¹äºæˆ‘ä»¬çš„ç®€å•ä»»åŠ¡é˜Ÿåˆ—è€Œè¨€ï¼Œè¿™å·²ç»ç»°ç»°æœ‰ä½™äº†ã€‚</p><hr><hr><h2 id="ä¸å…¬å¹³åˆ†å‘">ä¸å…¬å¹³åˆ†å‘</h2><p>åœ¨æœ€å¼€å§‹çš„æ—¶å€™æˆ‘ä»¬å­¦ä¹ åˆ° RabbitMQ åˆ†å‘æ¶ˆæ¯é‡‡ç”¨çš„è½®è¯¢åˆ†å‘ï¼Œä½†æ˜¯åœ¨æŸç§åœºæ™¯ä¸‹è¿™ç§ç­–ç•¥å¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œæ¯”æ–¹è¯´æœ‰ä¸¤ä¸ªæ¶ˆè´¹è€…åœ¨å¤„ç†ä»»åŠ¡ï¼Œå…¶ä¸­æœ‰ä¸ª<strong>æ¶ˆè´¹è€… 1</strong> å¤„ç†ä»»åŠ¡çš„é€Ÿåº¦éå¸¸å¿«ï¼Œè€Œå¦å¤–ä¸€ä¸ª<strong>æ¶ˆè´¹è€… 2</strong> å¤„ç†é€Ÿåº¦å´å¾ˆæ…¢ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¿˜æ˜¯é‡‡ç”¨è½®è¯¢åˆ†å‘çš„åŒ–å°±ä¼šåˆ°è¿™å¤„ç†é€Ÿåº¦å¿«çš„è¿™ä¸ªæ¶ˆè´¹è€…å¾ˆå¤§ä¸€éƒ¨åˆ†æ—¶é—´å¤„äºç©ºé—²çŠ¶æ€ï¼Œè€Œå¤„ç†æ…¢çš„é‚£ä¸ªæ¶ˆè´¹è€…ä¸€ç›´åœ¨å¹²æ´»ï¼Œè¿™ç§åˆ†é…æ–¹å¼åœ¨è¿™ç§æƒ…å†µä¸‹å…¶å®å°±ä¸å¤ªå¥½ï¼Œä½†æ˜¯ RabbitMQ å¹¶ä¸çŸ¥é“è¿™ç§æƒ…å†µå®ƒä¾ç„¶å¾ˆå…¬å¹³çš„è¿›è¡Œåˆ†å‘ã€‚</p><p>ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œ<strong>åœ¨æ¶ˆè´¹è€…ä¸­æ¶ˆè´¹æ¶ˆæ¯ä¹‹å‰</strong>ï¼Œè®¾ç½®å‚æ•° <code>channel.basicQos(1);</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Work03</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é˜Ÿåˆ—åç§°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TASK_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ACK_QUEUE&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ¥å—æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtils.getChannel();</span><br><span class="line">        System.out.println(<span class="string">&quot;C1ç­‰å¾…æ¥å—æ¶ˆæ¯å¤„ç†æ—¶é—´è¾ƒçŸ­&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span>(consumerTag,message) -&gt;&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//æ²‰ç¡1S</span></span><br><span class="line">            SleepUtils.sleep(<span class="number">1</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;æ¥å—åˆ°çš„æ¶ˆæ¯:&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(),<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            <span class="comment">//æ‰‹åŠ¨åº”ç­”</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 1.æ¶ˆæ¯çš„æ ‡è®°Tag</span></span><br><span class="line"><span class="comment">             * 2.æ˜¯å¦æ‰¹é‡åº”ç­” falseè¡¨ç¤ºä¸æ‰¹é‡åº”ç­”ä¿¡é“ä¸­çš„æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.basicAck(message.getEnvelope().getDeliveryTag(),<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">CancelCallback</span> <span class="variable">cancelCallback</span> <span class="operator">=</span> (consumerTag -&gt; &#123;</span><br><span class="line">            System.out.println(consumerTag + <span class="string">&quot;æ¶ˆè´¹è€…å–æ¶ˆæ¶ˆè´¹æ¥å£å›è°ƒé€»è¾‘&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//è®¾ç½®ä¸å…¬å¹³åˆ†å‘</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">prefetchCount</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        channel.basicQos(prefetchCount);</span><br><span class="line">        <span class="comment">//é‡‡ç”¨æ‰‹åŠ¨åº”ç­”</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">autoAck</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        channel.basicConsume(TASK_QUEUE_NAME,autoAck,deliverCallback,cancelCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¼€å¯æˆåŠŸï¼Œä¼šçœ‹åˆ°å¦‚ä¸‹ç»“æœï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230628094736710.png" alt="image-20230628094736710"></p><p>ä¸å…¬å¹³åˆ†å‘æ€æƒ³ï¼šå¦‚æœä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—è¿˜æ²¡æœ‰å¤„ç†å®Œæˆ–è€…æ²¡æœ‰åº”ç­”ç­¾æ”¶ä¸€ä¸ªæ¶ˆæ¯ï¼Œåˆ™ä¸æ‹’ç» RabbitMQ åˆ†é…æ–°çš„æ¶ˆæ¯åˆ°è¯¥å·¥ä½œé˜Ÿåˆ—ã€‚æ­¤æ—¶ RabbitMQ ä¼šä¼˜å…ˆåˆ†é…ç»™å…¶ä»–å·²ç»å¤„ç†å®Œæ¶ˆæ¯æˆ–è€…ç©ºé—²çš„å·¥ä½œé˜Ÿåˆ—ã€‚å¦‚æœæ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½æ²¡æœ‰å®Œæˆæ‰‹ä¸Šä»»åŠ¡ï¼Œé˜Ÿåˆ—è¿˜åœ¨ä¸åœçš„æ·»åŠ æ–°ä»»åŠ¡ï¼Œé˜Ÿåˆ—æœ‰å¯èƒ½å°±ä¼šé‡åˆ°é˜Ÿåˆ—è¢«æ’‘æ»¡çš„æƒ…å†µï¼Œè¿™ä¸ªæ—¶å€™å°±åªèƒ½æ·»åŠ æ–°çš„ worker (å·¥ä½œé˜Ÿåˆ—)æˆ–è€…æ”¹å˜å…¶ä»–å­˜å‚¨ä»»åŠ¡çš„ç­–ç•¥ã€‚</p><hr><h2 id="é¢„å–å€¼åˆ†å‘">é¢„å–å€¼åˆ†å‘</h2><p>å¸¦æƒçš„æ¶ˆæ¯åˆ†å‘</p><p>é»˜è®¤æ¶ˆæ¯çš„å‘é€æ˜¯å¼‚æ­¥å‘é€çš„ï¼Œæ‰€ä»¥åœ¨ä»»ä½•æ—¶å€™ï¼Œchannel ä¸Šä¸æ­¢åªæœ‰ä¸€ä¸ªæ¶ˆæ¯æ¥è‡ªæ¶ˆè´¹è€…çš„æ‰‹åŠ¨ç¡®è®¤ï¼Œæ‰€ä»¥æœ¬è´¨ä¸Šæ˜¯å¼‚æ­¥çš„ã€‚å› æ­¤è¿™é‡Œå°±å­˜åœ¨ä¸€ä¸ªæœªç¡®è®¤çš„æ¶ˆæ¯ç¼“å†²åŒºï¼Œå› æ­¤å¸Œæœ›å¼€å‘äººå‘˜èƒ½<strong>é™åˆ¶æ­¤ç¼“å†²åŒºçš„å¤§å°</strong>ï¼Œ<strong>ä»¥é¿å…ç¼“å†²åŒºé‡Œé¢æ— é™åˆ¶çš„æœªç¡®è®¤æ¶ˆæ¯é—®é¢˜</strong>ã€‚è¿™ä¸ªæ—¶å€™å°±å¯ä»¥é€šè¿‡ä½¿ç”¨ <code>basic.qos</code> æ–¹æ³•è®¾ç½®ã€Œé¢„å–è®¡æ•°ã€å€¼æ¥å®Œæˆçš„ã€‚</p><p>è¯¥å€¼å®šä¹‰é€šé“ä¸Šå…è®¸çš„æœªç¡®è®¤æ¶ˆæ¯çš„æœ€å¤§æ•°é‡ã€‚ä¸€æ—¦æ•°é‡è¾¾åˆ°é…ç½®çš„æ•°é‡ï¼Œ RabbitMQ å°†åœæ­¢åœ¨é€šé“ä¸Šä¼ é€’æ›´å¤šæ¶ˆæ¯ï¼Œé™¤éè‡³å°‘æœ‰ä¸€ä¸ªæœªå¤„ç†çš„æ¶ˆæ¯è¢«ç¡®è®¤ï¼Œä¾‹å¦‚ï¼Œå‡è®¾åœ¨é€šé“ä¸Šæœ‰æœªç¡®è®¤çš„æ¶ˆæ¯ 5ã€6ã€7ï¼Œ8ï¼Œå¹¶ä¸”é€šé“çš„é¢„å–è®¡æ•°è®¾ç½®ä¸º 4ï¼Œæ­¤æ—¶ RabbitMQ å°†ä¸ä¼šåœ¨è¯¥é€šé“ä¸Šå†ä¼ é€’ä»»ä½•æ¶ˆæ¯ï¼Œé™¤éè‡³å°‘æœ‰ä¸€ä¸ªæœªåº”ç­”çš„æ¶ˆæ¯è¢« ackã€‚æ¯”æ–¹è¯´ tag=6 è¿™ä¸ªæ¶ˆæ¯åˆšåˆšè¢«ç¡®è®¤ ACKï¼ŒRabbitMQ å°†ä¼šæ„ŸçŸ¥è¿™ä¸ªæƒ…å†µåˆ°å¹¶å†å‘é€ä¸€æ¡æ¶ˆæ¯ã€‚æ¶ˆæ¯åº”ç­”å’Œ QoS é¢„å–å€¼å¯¹ç”¨æˆ·ååé‡æœ‰é‡å¤§å½±å“ã€‚</p><p>é€šå¸¸ï¼Œå¢åŠ é¢„å–å°†æé«˜å‘æ¶ˆè´¹è€…ä¼ é€’æ¶ˆæ¯çš„é€Ÿåº¦ã€‚<strong>è™½ç„¶è‡ªåŠ¨åº”ç­”ä¼ è¾“æ¶ˆæ¯é€Ÿç‡æ˜¯æœ€ä½³çš„ï¼Œä½†æ˜¯ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å·²ä¼ é€’ä½†å°šæœªå¤„ç†çš„æ¶ˆæ¯çš„æ•°é‡ä¹Ÿä¼šå¢åŠ ï¼Œä»è€Œå¢åŠ äº†æ¶ˆè´¹è€…çš„ RAM æ¶ˆè€—</strong>(éšæœºå­˜å–å­˜å‚¨å™¨)åº”è¯¥å°å¿ƒä½¿ç”¨å…·æœ‰æ— é™é¢„å¤„ç†çš„è‡ªåŠ¨ç¡®è®¤æ¨¡å¼æˆ–æ‰‹åŠ¨ç¡®è®¤æ¨¡å¼ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹äº†å¤§é‡çš„æ¶ˆæ¯å¦‚æœæ²¡æœ‰ç¡®è®¤çš„è¯ï¼Œä¼šå¯¼è‡´æ¶ˆè´¹è€…è¿æ¥èŠ‚ç‚¹çš„å†…å­˜æ¶ˆè€—å˜å¤§ï¼Œæ‰€ä»¥æ‰¾åˆ°åˆé€‚çš„é¢„å–å€¼æ˜¯ä¸€ä¸ªåå¤è¯•éªŒçš„è¿‡ç¨‹ï¼Œä¸åŒçš„è´Ÿè½½è¯¥å€¼å–å€¼ä¹Ÿä¸åŒ 100 åˆ° 300 èŒƒå›´å†…çš„å€¼é€šå¸¸å¯æä¾›æœ€ä½³çš„ååé‡ï¼Œå¹¶ä¸”ä¸ä¼šç»™æ¶ˆè´¹è€…å¸¦æ¥å¤ªå¤§çš„é£é™©ã€‚</p><p>é¢„å–å€¼ä¸º 1 æ˜¯æœ€ä¿å®ˆçš„ã€‚å½“ç„¶è¿™å°†ä½¿ååé‡å˜å¾—å¾ˆä½ï¼Œç‰¹åˆ«æ˜¯æ¶ˆè´¹è€…è¿æ¥å»¶è¿Ÿå¾ˆä¸¥é‡çš„æƒ…å†µä¸‹ï¼Œç‰¹åˆ«æ˜¯åœ¨æ¶ˆè´¹è€…è¿æ¥ç­‰å¾…æ—¶é—´è¾ƒé•¿çš„ç¯å¢ƒä¸­ã€‚å¯¹äºå¤§å¤šæ•°åº”ç”¨æ¥è¯´ï¼Œç¨å¾®é«˜ä¸€ç‚¹çš„å€¼å°†æ˜¯æœ€ä½³çš„ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image.2anljpf3y134.webp" alt="image"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Work03</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é˜Ÿåˆ—åç§°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TASK_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ACK_QUEUE&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ¥å—æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtils.getChannel();</span><br><span class="line">        System.out.println(<span class="string">&quot;C1ç­‰å¾…æ¥å—æ¶ˆæ¯å¤„ç†æ—¶é—´è¾ƒçŸ­&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span>(consumerTag,message) -&gt;&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//æ²‰ç¡1S</span></span><br><span class="line">            SleepUtils.sleep(<span class="number">1</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;æ¥å—åˆ°çš„æ¶ˆæ¯:&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(),<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            <span class="comment">//æ‰‹åŠ¨åº”ç­”</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 1.æ¶ˆæ¯çš„æ ‡è®°Tag</span></span><br><span class="line"><span class="comment">             * 2.æ˜¯å¦æ‰¹é‡åº”ç­” falseè¡¨ç¤ºä¸æ‰¹é‡åº”ç­”ä¿¡é“ä¸­çš„æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.basicAck(message.getEnvelope().getDeliveryTag(),<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">CancelCallback</span> <span class="variable">cancelCallback</span> <span class="operator">=</span> (consumerTag -&gt; &#123;</span><br><span class="line">            System.out.println(consumerTag + <span class="string">&quot;æ¶ˆè´¹è€…å–æ¶ˆæ¶ˆè´¹æ¥å£å›è°ƒé€»è¾‘&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//è®¾ç½®ä¸å…¬å¹³åˆ†å‘</span></span><br><span class="line">        <span class="comment">//int prefetchCount = 1;</span></span><br><span class="line">        <span class="comment">//å€¼ä¸ç­‰äº 1ï¼Œåˆ™ä»£è¡¨é¢„å–å€¼,é¢„å–å€¼ä¸º4</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">prefetchCount</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">        channel.basicQos(prefetchCount);</span><br><span class="line">        <span class="comment">//é‡‡ç”¨æ‰‹åŠ¨åº”ç­”</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">autoAck</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        channel.basicConsume(TASK_QUEUE_NAME,autoAck,deliverCallback,cancelCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä¸å…¬å¹³åˆ†å‘å’Œé¢„å–å€¼åˆ†å‘éƒ½ç”¨åˆ° <code>basic.qos</code> æ–¹æ³•ï¼Œå¦‚æœå–å€¼ä¸º 1ï¼Œä»£è¡¨ä¸å…¬å¹³åˆ†å‘ï¼Œå–å€¼ä¸ä¸º1ï¼Œä»£è¡¨é¢„å–å€¼åˆ†å‘</p></blockquote>]]></content>
    
    
    <summary type="html">æ¶ˆæ¯åº”ç­”ä¸å‘å¸ƒ</summary>
    
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="æ¶ˆæ¯é˜Ÿåˆ—" scheme="https://wuwawawa.github.io/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>RabbitMQæ¦‚è¿°</title>
    <link href="https://wuwawawa.github.io/posts/b543ced0.html"/>
    <id>https://wuwawawa.github.io/posts/b543ced0.html</id>
    <published>2023-06-19T02:44:38.000Z</published>
    <updated>2023-06-28T02:09:21.279Z</updated>
    
    <content type="html"><![CDATA[<h2 id="MQæ¦‚è¿°">MQæ¦‚è¿°</h2><h3 id="MQåŸºæœ¬æ¦‚å¿µ">MQåŸºæœ¬æ¦‚å¿µ</h3><p>MQå…¨ç§°<span class='p red'>M</span>essage <span class='p red'>Q</span>ueueï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ï¼Œæ˜¯åœ¨æ¶ˆæ¯çš„ä¼ è¾“è¿‡ç¨‹ä¸­ä¿å­˜æ¶ˆæ¯çš„å®¹å™¨ã€‚å¤šç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚</p><p>åˆ†å¸ƒå¼ç³»ç»Ÿä¹‹é—´è¿›è¡Œé€šä¿¡æœ‰ä¸¤ç§æ–¹å¼ã€‚</p><ol><li>Aé€šè¿‡è¿œç¨‹è°ƒç”¨çš„æ–¹å¼ç›´æ¥å»è®¿é—®Bã€‚</li><li>Aç³»ç»Ÿè¿˜å¯ä»¥å€ŸåŠ©ç¬¬ä¸‰æ–¹æ¥å®Œæˆä¸Bç³»ç»Ÿè¿›è¡Œé€šä¿¡ã€‚æ¯”å¦‚Aç°å°†æ¶ˆæ¯å‘ç»™Cï¼ŒCå†è®²æ•°æ®å‘ç»™Bã€‚</li></ol><p>ï¬MQï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå­˜å‚¨æ¶ˆæ¯çš„ä¸­é—´ä»¶</p><p>ï¬åˆ†å¸ƒå¼ç³»ç»Ÿé€šä¿¡ä¸¤ç§æ–¹å¼ï¼šç›´æ¥è¿œç¨‹è°ƒç”¨å’Œå€ŸåŠ©ç¬¬ä¸‰æ–¹å®Œæˆé—´æ¥é€šä¿¡</p><p>ï¬å‘é€æ–¹ç§°ä¸ºç”Ÿäº§è€…ï¼Œæ¥æ”¶æ–¹ç§°ä¸ºæ¶ˆè´¹è€…</p><hr><h3 id="MQçš„ä¼˜åŠ¿å’ŒåŠ£åŠ¿">MQçš„ä¼˜åŠ¿å’ŒåŠ£åŠ¿</h3><mark class="hl-label green">ä¼˜åŠ¿</mark> <div class="tabs" id="a1df0ae3-f522-4b3f-b592-8f6762871809"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#a1df0ae3-f522-4b3f-b592-8f6762871809-1"><i class="fas fa-cat"></i>åº”ç”¨è§£è€¦</button></li><li class="tab"><button type="button" data-href="#a1df0ae3-f522-4b3f-b592-8f6762871809-2"><i class="fas fa-horse"></i>å¼‚æ­¥æé€Ÿ</button></li><li class="tab"><button type="button" data-href="#a1df0ae3-f522-4b3f-b592-8f6762871809-3"><i class="fas fa-dove"></i>å‰Šå³°å¡«è°·</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="a1df0ae3-f522-4b3f-b592-8f6762871809-1"><p>ä½¿ç”¨MQ ä½¿å¾—åº”ç”¨é—´è§£è€¦ï¼Œæå‡å®¹é”™æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p><p>å½“åº“å­˜ç³»ç»Ÿå‘ç”Ÿå¼‚å¸¸ï¼Œä¹Ÿä¸ä¼šå½±å“åˆ°è®¢å•ç³»ç»Ÿã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230619105918146.png" alt="image-20230619105918146" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a1df0ae3-f522-4b3f-b592-8f6762871809-2"><p>ä¸€ä¸ªä¸‹å•æ“ä½œè€—æ—¶ï¼š20 + 300 + 300 + 300 = 920msï¼Œç”¨æˆ·ç‚¹å‡»å®Œä¸‹å•æŒ‰é’®åï¼Œéœ€è¦ç­‰å¾…920msæ‰èƒ½å¾—åˆ°ä¸‹å•å“åº”ï¼Œå¤ªæ…¢ï¼</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230619105950643.png" alt="image-20230619105950643" style="zoom:50%;" /><p>ç”¨æˆ·ç‚¹å‡»å®Œä¸‹å•æŒ‰é’®åï¼Œåªéœ€ç­‰å¾…25mså°±èƒ½å¾—åˆ°ä¸‹å•å“åº”(20 + 5 = 25ms)ã€‚æå‡ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿååé‡ï¼ˆå•ä½æ—¶é—´å†…å¤„ç†è¯·æ±‚çš„æ•°ç›®ï¼‰ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230619110057758.png" alt="image-20230619110057758" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a1df0ae3-f522-4b3f-b592-8f6762871809-3"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230619110217684.png" alt="image-20230619110217684" style="zoom:50%;" /><p>ä½¿ç”¨äº†MQ ä¹‹åï¼Œé™åˆ¶æ¶ˆè´¹æ¶ˆæ¯çš„é€Ÿåº¦ä¸º1000ï¼Œè¿™æ ·ä¸€æ¥ï¼Œé«˜å³°æœŸäº§ç”Ÿçš„æ•°æ®åŠ¿å¿…ä¼šè¢«ç§¯å‹åœ¨MQ ä¸­ï¼Œé«˜å³°å°±è¢«â€œå‰Šâ€æ‰äº†ï¼Œä½†æ˜¯å› ä¸ºæ¶ˆæ¯ç§¯å‹ï¼Œåœ¨é«˜å³°æœŸè¿‡åçš„ä¸€æ®µæ—¶é—´å†…ï¼Œæ¶ˆè´¹æ¶ˆæ¯çš„é€Ÿåº¦è¿˜æ˜¯ä¼šç»´æŒåœ¨1000ï¼Œç›´åˆ°æ¶ˆè´¹å®Œç§¯å‹çš„æ¶ˆæ¯ï¼Œè¿™å°±å«åšâ€œå¡«è°·â€ã€‚</p><p>ä½¿ç”¨MQåï¼Œå¯ä»¥æé«˜ç³»ç»Ÿç¨³å®šæ€§ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230619110350154.png" alt="image-20230619110350154"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><mark class="hl-label red">åŠ£åŠ¿</mark> <div class="tabs" id="f1df2770-2143-4f82-9257-fd6baccaeedf"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#f1df2770-2143-4f82-9257-fd6baccaeedf-1"><i class="fas fa-bug"></i>ç³»ç»Ÿå¯ç”¨æ€§é™ä½</button></li><li class="tab"><button type="button" data-href="#f1df2770-2143-4f82-9257-fd6baccaeedf-2"><i class="fas fa-cannabis"></i>ç³»ç»Ÿå¤æ‚åº¦æé«˜</button></li><li class="tab"><button type="button" data-href="#f1df2770-2143-4f82-9257-fd6baccaeedf-3"><i class="fas fa-candy-cane"></i>ä¸€è‡´æ€§é—®é¢˜</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="f1df2770-2143-4f82-9257-fd6baccaeedf-1"><p>ç³»ç»Ÿå¼•å…¥çš„å¤–éƒ¨ä¾èµ–è¶Šå¤šï¼Œç³»ç»Ÿç¨³å®šæ€§è¶Šå·®ã€‚ä¸€æ—¦MQ å®•æœºï¼Œå°±ä¼šå¯¹ä¸šåŠ¡é€ æˆå½±å“ã€‚å¦‚ä½•ä¿è¯MQçš„é«˜å¯ç”¨ï¼Ÿ</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f1df2770-2143-4f82-9257-fd6baccaeedf-2"><p>MQ çš„åŠ å…¥å¤§å¤§å¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚åº¦ï¼Œä»¥å‰ç³»ç»Ÿé—´æ˜¯åŒæ­¥çš„è¿œç¨‹è°ƒç”¨ï¼Œç°åœ¨æ˜¯é€šè¿‡MQ è¿›è¡Œå¼‚æ­¥è°ƒç”¨ã€‚å¦‚ä½•ä¿è¯æ¶ˆæ¯æ²¡æœ‰è¢«é‡å¤æ¶ˆè´¹ï¼Ÿæ€ä¹ˆå¤„ç†æ¶ˆæ¯ä¸¢å¤±æƒ…å†µï¼Ÿé‚£ä¹ˆä¿è¯æ¶ˆæ¯ä¼ é€’çš„é¡ºåºæ€§ï¼Ÿ</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f1df2770-2143-4f82-9257-fd6baccaeedf-3"><p>A ç³»ç»Ÿå¤„ç†å®Œä¸šåŠ¡ï¼Œé€šè¿‡MQ ç»™Bã€Cã€Dä¸‰ä¸ªç³»ç»Ÿå‘æ¶ˆæ¯æ•°æ®ï¼Œå¦‚æœB ç³»ç»Ÿã€C ç³»ç»Ÿå¤„ç†æˆåŠŸï¼ŒD ç³»ç»Ÿå¤„ç†å¤±è´¥ã€‚å¦‚ä½•ä¿è¯æ¶ˆæ¯æ•°æ®å¤„ç†çš„ä¸€è‡´æ€§ï¼Ÿ</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><blockquote><p>æ—¢ç„¶ MQ æœ‰ä¼˜åŠ¿ä¹Ÿæœ‰åŠ£åŠ¿ï¼Œé‚£ä¹ˆä½¿ç”¨ MQ éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶å‘¢ï¼Ÿ</p></blockquote><p>â‘ ç”Ÿäº§è€…ä¸éœ€è¦ä»æ¶ˆè´¹è€…å¤„è·å¾—åé¦ˆã€‚å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¹‹å‰çš„ç›´æ¥è°ƒç”¨ï¼Œå…¶æ¥å£çš„è¿”å›å€¼åº”è¯¥ä¸ºç©ºï¼Œè¿™æ‰è®©æ˜æ˜ä¸‹å±‚çš„åŠ¨ä½œè¿˜æ²¡åšï¼Œä¸Šå±‚å´å½“æˆåŠ¨ä½œåšå®Œäº†ç»§ç»­å¾€åèµ°ï¼Œå³æ‰€è°“å¼‚æ­¥æˆä¸ºäº†å¯èƒ½ã€‚</p><p>â‘¡å®¹è®¸çŸ­æš‚çš„ä¸ä¸€è‡´æ€§ã€‚</p><p>â‘¢ç¡®å®æ˜¯ç”¨äº†æœ‰æ•ˆæœã€‚å³è§£è€¦ã€æé€Ÿã€å‰Šå³°è¿™äº›æ–¹é¢çš„æ”¶ç›Šï¼Œè¶…è¿‡åŠ å…¥MQï¼Œç®¡ç†MQè¿™äº›æˆæœ¬ã€‚</p><hr><h3 id="å¸¸è§çš„MQäº§å“">å¸¸è§çš„MQäº§å“</h3><p>ç›®å‰ä¸šç•Œæœ‰å¾ˆå¤šçš„ MQ äº§å“ï¼Œä¾‹å¦‚ RabbitMQã€RocketMQã€ActiveMQã€Kafkaã€ZeroMQã€MetaMqç­‰ï¼Œä¹Ÿæœ‰ç›´æ¥ä½¿ç”¨Rediså……å½“æ¶ˆæ¯é˜Ÿåˆ—çš„æ¡ˆä¾‹ï¼Œè€Œè¿™äº›æ¶ˆæ¯é˜Ÿåˆ—äº§å“ï¼Œå„æœ‰ä¾§é‡ï¼Œåœ¨å®é™…é€‰å‹æ—¶ï¼Œéœ€è¦ç»“åˆè‡ªèº«éœ€æ±‚åŠ MQ äº§å“ç‰¹å¾ï¼Œç»¼åˆè€ƒè™‘ã€‚</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">RabbitMQ</th><th style="text-align:center">ActiveMQ</th><th style="text-align:center">RocketMQ</th><th style="text-align:center">Kafka</th></tr></thead><tbody><tr><td style="text-align:center">å…¬å¸/ç¤¾åŒº</td><td style="text-align:center">RabbitMQ</td><td style="text-align:center">Apache</td><td style="text-align:center">é˜¿é‡Œ</td><td style="text-align:center">Apache</td></tr><tr><td style="text-align:center">å¼€å‘è¯­è¨€</td><td style="text-align:center">Erlang</td><td style="text-align:center">Java</td><td style="text-align:center">Java</td><td style="text-align:center">Scala&amp;Java</td></tr><tr><td style="text-align:center">å•æœºååé‡</td><td style="text-align:center">ä¸‡çº§ï¼ˆå…¶æ¬¡ï¼‰</td><td style="text-align:center">ä¸‡çº§ï¼ˆæœ€å·®ï¼‰</td><td style="text-align:center">åä¸‡çº§ï¼ˆæœ€å¥½ï¼‰</td><td style="text-align:center">åä¸‡çº§ï¼ˆæ¬¡ä¹‹ï¼‰</td></tr><tr><td style="text-align:center">æ¶ˆæ¯å»¶è¿Ÿ</td><td style="text-align:center">å¾®ç§’çº§</td><td style="text-align:center">æ¯«ç§’çº§</td><td style="text-align:center">äº³ç§’çº§s</td><td style="text-align:center">æ¯«ç§’ä»¥å†…</td></tr><tr><td style="text-align:center">åŠŸèƒ½ç‰¹æ€§</td><td style="text-align:center">å¹¶å‘èƒ½åŠ›å¼ºï¼Œæ€§èƒ½æå…¶å¥½ï¼Œ å»¶æ—¶ä½ï¼Œç¤¾åŒºæ´»è·ƒï¼Œç®¡ç†ç•Œé¢ä¸°å¯Œ</td><td style="text-align:center">è€ç‰Œäº§å“ï¼Œæˆç†Ÿåº¦é«˜ï¼Œ æ–‡æ¡£è¾ƒå¤š</td><td style="text-align:center">MQåŠŸèƒ½æ¯”è¾ƒå®Œå¤‡ï¼Œæ‰©å±•æ€§ä½³</td><td style="text-align:center">åªæ”¯æŒä¸»è¦çš„MQåŠŸèƒ½ï¼Œ æ¯•ç«Ÿæ˜¯ä¸ºå¤§æ•°æ®é¢†åŸŸå‡†å¤‡çš„ã€‚</td></tr></tbody></table><hr><hr><h2 id="RabbitMQçš„å®‰è£…">RabbitMQçš„å®‰è£…</h2><div class="tabs" id="141ff293-273e-4e63-b8a7-0015358c616c"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#141ff293-273e-4e63-b8a7-0015358c616c-1"><i class="fas fa-seedling"></i>æ‹‰å–é•œåƒ</button></li><li class="tab"><button type="button" data-href="#141ff293-273e-4e63-b8a7-0015358c616c-2"><i class="fas fa-leaf"></i>åˆ›å»ºæŒ‚è½½æ–‡ä»¶å¤¹å’Œé…ç½®æ–‡ä»¶</button></li><li class="tab"><button type="button" data-href="#141ff293-273e-4e63-b8a7-0015358c616c-3"><i class="fab fa-apple"></i>å¯åŠ¨å‘½ä»¤</button></li><li class="tab"><button type="button" data-href="#141ff293-273e-4e63-b8a7-0015358c616c-4"><i class="fas fa-tree"></i>è®¿é—®</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="141ff293-273e-4e63-b8a7-0015358c616c-1"><p><code>docker pull rabbitmq:management</code></p><p>managementï¼šè¡¨ç¤ºå¯ä»¥é€šè¿‡webé¡µé¢ç®¡ç†</p><p>å¦‚æœ<code>docker pull rabbitmq</code> åé¢ä¸å¸¦managementï¼Œå¯åŠ¨rabbitmqåæ˜¯æ— æ³•æ‰“å¼€ç®¡ç†ç•Œé¢çš„ï¼Œéœ€è¦å¯ç”¨æ’ä»¶</p><p><code>docker exec -it rabbitmq rabbitmq-plugins enable rabbitmq_management</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="141ff293-273e-4e63-b8a7-0015358c616c-2"><p>åˆ›å»ºå®Œæˆä¹‹åè¦å¯¹æ‰€åˆ›å»ºæ–‡ä»¶æˆæƒæƒé™ï¼Œéƒ½è®¾ç½®æˆ777 å¦åˆ™åœ¨å¯åŠ¨å®¹å™¨çš„æ—¶å€™å®¹æ˜“å¤±è´¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~/soft</span><br><span class="line">â¯ <span class="built_in">mkdir</span> -p ./rabbitmq/&#123;conf,data,<span class="built_in">log</span>&#125;</span><br><span class="line">â¯ <span class="built_in">chmod</span> -R 777 ./rabbitmq</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸´æ—¶å®¹å™¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name rabbitmq1 --restart=always --hostname=rabbitmqhost \</span><br><span class="line">-e RABBITMQ_DEFAULT_USER=admin -e RABBITMQ_DEFAULT_PASS=admin \</span><br><span class="line">-e RABBITMQ_DEFAULT_VHOST=my_vhost \</span><br><span class="line">-p 5672:5672 -p 15672:15672 \</span><br><span class="line">rabbitmq:management</span><br></pre></td></tr></table></figure><p>å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°å®¿ä¸»æœº</p><p><code>docker cp rabbitmq1:/etc/rabbitmq/ /Users/fortune/soft/rabbitmq/conf</code></p><p>åˆ é™¤ä¸´æ—¶å®¹å™¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker stop rabbitmq1 </span><br><span class="line">docker <span class="built_in">rm</span> rabbitmq1 </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="141ff293-273e-4e63-b8a7-0015358c616c-3"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name rabbitmq --restart=always \</span><br><span class="line">--hostname=rabbitmqhost \</span><br><span class="line">-e RABBITMQ_DEFAULT_USER=admin \</span><br><span class="line">-e RABBITMQ_DEFAULT_PASS=admin \</span><br><span class="line">-e RABBITMQ_DEFAULT_VHOST=my_vhost \</span><br><span class="line">-v /Users/fortune/soft/rabbitmq/data:/var/lib/rabbitmq \</span><br><span class="line">-v /Users/fortune/soft/rabbitmq/log:/var/log/rabbitmq \</span><br><span class="line">-v /Users/fortune/soft/rabbitmq/conf/rabbitmq:/etc/rabbitmq \</span><br><span class="line">-p 5672:5672 -p 15672:15672 \</span><br><span class="line">rabbitmq:management</span><br></pre></td></tr></table></figure><p>è®¾ç½®ä¸»æœºåçš„ä½œç”¨ ï¼ˆâ€“hostname=rabbitmqhostï¼‰</p><p>RabbitMQçš„ä¸€ä¸ªé‡è¦æ³¨æ„äº‹é¡¹æ˜¯å®ƒæ ¹æ®æ‰€è°“çš„ â€œèŠ‚ç‚¹åç§°â€ å­˜å‚¨æ•°æ®ï¼Œé»˜è®¤ä¸ºä¸»æœºå</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="141ff293-273e-4e63-b8a7-0015358c616c-4"><p>è®¿é—®localhost:15672è¾“å…¥ç”¨æˆ·åå¯†ç å³å¯è¿›å…¥æ§åˆ¶å°</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h2 id="RabbitMQç®€ä»‹">RabbitMQç®€ä»‹</h2><p>AMQPï¼Œå³Advanced Message Queuing Protocolï¼ˆé«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼‰ï¼Œæ˜¯ä¸€ä¸ªç½‘ç»œåè®®ï¼Œæ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶è®¾è®¡ã€‚åŸºäºæ­¤åè®®çš„å®¢æˆ·ç«¯ä¸æ¶ˆæ¯ä¸­é—´ä»¶å¯ä¼ é€’æ¶ˆæ¯ï¼Œå¹¶ä¸å—å®¢æˆ·ç«¯/ä¸­é—´ä»¶ä¸åŒäº§å“ï¼Œä¸åŒçš„å¼€å‘è¯­è¨€ç­‰æ¡ä»¶çš„é™åˆ¶ã€‚2006å¹´ï¼ŒAMQPè§„èŒƒå‘å¸ƒã€‚ç±»æ¯”HTTPã€‚</p><p>2007å¹´ï¼ŒRabbitæŠ€æœ¯å…¬å¸åŸºäºAMQPæ ‡å‡†å¼€å‘çš„RabbitMQ 1.0 å‘å¸ƒã€‚RabbitMQé‡‡ç”¨Erlangè¯­è¨€å¼€å‘ã€‚Erlangè¯­è¨€ç”±Ericsonè®¾è®¡ï¼Œä¸“é—¨ä¸ºå¼€å‘é«˜å¹¶å‘å’Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€ç§è¯­è¨€ï¼Œåœ¨ç”µä¿¡é¢†åŸŸä½¿ç”¨å¹¿æ³›ã€‚</p><p>RabbitMQ åŸºç¡€æ¶æ„å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230619112428501.png" alt="image-20230619112428501"></p><mark class="hl-label blue">RabbitMQä¸­ç›¸å…³æ¦‚å¿µ</mark> <div class="tabs" id="a99bb2e0-fea1-4c75-afe2-adf03e47f7ed"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#a99bb2e0-fea1-4c75-afe2-adf03e47f7ed-1"><i class="fas fa-cat"></i>Broker</button></li><li class="tab"><button type="button" data-href="#a99bb2e0-fea1-4c75-afe2-adf03e47f7ed-2"><i class="fas fa-horse"></i>Virtual host</button></li><li class="tab"><button type="button" data-href="#a99bb2e0-fea1-4c75-afe2-adf03e47f7ed-3"><i class="fas fa-dove"></i>Connection</button></li><li class="tab"><button type="button" data-href="#a99bb2e0-fea1-4c75-afe2-adf03e47f7ed-4"><i class="fas fa-dragon"></i>Channel</button></li><li class="tab"><button type="button" data-href="#a99bb2e0-fea1-4c75-afe2-adf03e47f7ed-5"><i class="fas fa-seedling"></i>Exchange</button></li><li class="tab"><button type="button" data-href="#a99bb2e0-fea1-4c75-afe2-adf03e47f7ed-6"><i class="fas fa-leaf"></i>Queue</button></li><li class="tab"><button type="button" data-href="#a99bb2e0-fea1-4c75-afe2-adf03e47f7ed-7"><i class="fab fa-apple"></i>Binding</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="a99bb2e0-fea1-4c75-afe2-adf03e47f7ed-1"><p>æ¥æ”¶å’Œåˆ†å‘æ¶ˆæ¯çš„åº”ç”¨ï¼ŒRabbitMQ Serverå°±æ˜¯Message Broker</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a99bb2e0-fea1-4c75-afe2-adf03e47f7ed-2"><p>å‡ºäºå¤šç§Ÿæˆ·å’Œå®‰å…¨å› ç´ è®¾è®¡çš„ï¼ŒæŠŠAMQP çš„åŸºæœ¬ç»„ä»¶åˆ’åˆ†åˆ°ä¸€ä¸ªè™šæ‹Ÿçš„åˆ†ç»„ä¸­ï¼Œç±»ä¼¼äºç½‘ç»œä¸­çš„namespace æ¦‚å¿µã€‚å½“å¤šä¸ªä¸åŒçš„ç”¨æˆ·ä½¿ç”¨åŒä¸€ä¸ªRabbitMQ server æä¾›çš„æœåŠ¡æ—¶ï¼Œå¯ä»¥åˆ’åˆ†å‡ºå¤šä¸ªvhostï¼Œæ¯ä¸ªç”¨æˆ·åœ¨è‡ªå·±çš„vhoståˆ›å»ºexchangeï¼queue ç­‰ã€‚</p><p>å¯ä»¥ç†è§£ä¸ºåƒMysqlé‡Œæ•°æ®åº“çš„æ¦‚å¿µ</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a99bb2e0-fea1-4c75-afe2-adf03e47f7ed-3"><p>publisherï¼consumer å’Œbroker ä¹‹é—´çš„TCP è¿æ¥</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a99bb2e0-fea1-4c75-afe2-adf03e47f7ed-4"><p>å¦‚æœæ¯ä¸€æ¬¡è®¿é—®RabbitMQ éƒ½å»ºç«‹ä¸€ä¸ªConnectionï¼Œåœ¨æ¶ˆæ¯é‡å¤§çš„æ—¶å€™å»ºç«‹TCP Connectionçš„å¼€é”€å°†æ˜¯å·¨å¤§çš„ï¼Œæ•ˆç‡ä¹Ÿè¾ƒä½ã€‚Channel æ˜¯åœ¨connection å†…éƒ¨å»ºç«‹çš„é€»è¾‘è¿æ¥ï¼Œå¦‚æœåº”ç”¨ç¨‹åºæ”¯æŒå¤šçº¿ç¨‹ï¼Œé€šå¸¸æ¯ä¸ªthreadåˆ›å»ºå•ç‹¬çš„channel è¿›è¡Œé€šè®¯ï¼ŒAMQP method åŒ…å«äº†channel id å¸®åŠ©å®¢æˆ·ç«¯å’Œmessage broker è¯†åˆ«channelï¼Œæ‰€ä»¥channel ä¹‹é—´æ˜¯å®Œå…¨éš”ç¦»çš„ã€‚Channel ä½œä¸ºè½»é‡çº§çš„Connection æå¤§å‡å°‘äº†æ“ä½œç³»ç»Ÿå»ºç«‹TCP connection çš„å¼€é”€</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a99bb2e0-fea1-4c75-afe2-adf03e47f7ed-5"><p>message åˆ°è¾¾broker çš„ç¬¬ä¸€ç«™ï¼Œæ ¹æ®åˆ†å‘è§„åˆ™ï¼ŒåŒ¹é…æŸ¥è¯¢è¡¨ä¸­çš„routing keyï¼Œåˆ†å‘æ¶ˆæ¯åˆ°queue ä¸­å»ã€‚å¸¸ç”¨çš„ç±»å‹æœ‰ï¼šdirect (point-to-point), topic (publish-subscribe) and fanout (multicast)</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a99bb2e0-fea1-4c75-afe2-adf03e47f7ed-6"><p>æ¶ˆæ¯æœ€ç»ˆè¢«é€åˆ°è¿™é‡Œç­‰å¾…consumer å–èµ°</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a99bb2e0-fea1-4c75-afe2-adf03e47f7ed-7"><p>exchange å’Œqueue ä¹‹é—´çš„è™šæ‹Ÿè¿æ¥ï¼Œbinding ä¸­å¯ä»¥åŒ…å«routing keyã€‚Binding ä¿¡æ¯è¢«ä¿å­˜åˆ°exchange ä¸­çš„æŸ¥è¯¢è¡¨ä¸­ï¼Œç”¨äºmessage çš„åˆ†å‘ä¾æ®</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr>]]></content>
    
    
    <summary type="html">RabbitMQåŸºæœ¬æ¦‚å¿µã€å…¥é—¨æ¡ˆä¾‹</summary>
    
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="æ¶ˆæ¯é˜Ÿåˆ—" scheme="https://wuwawawa.github.io/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>RedisåŸç†</title>
    <link href="https://wuwawawa.github.io/posts/1b7ba4a9.html"/>
    <id>https://wuwawawa.github.io/posts/1b7ba4a9.html</id>
    <published>2023-06-16T00:44:04.000Z</published>
    <updated>2023-06-17T13:33:10.931Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Redisæ•°æ®ç»“æ„">Redisæ•°æ®ç»“æ„</h2><h3 id="åŠ¨æ€å­—ç¬¦ä¸²">åŠ¨æ€å­—ç¬¦ä¸²</h3><p>æˆ‘ä»¬éƒ½çŸ¥é“Redisä¸­ä¿å­˜çš„Keyæ˜¯å­—ç¬¦ä¸²ï¼Œvalueå¾€å¾€æ˜¯å­—ç¬¦ä¸²æˆ–è€…å­—ç¬¦ä¸²çš„é›†åˆã€‚å¯è§å­—ç¬¦ä¸²æ˜¯Redisä¸­æœ€å¸¸ç”¨çš„ä¸€ç§æ•°æ®ç»“æ„ã€‚</p><p>ä¸è¿‡Redisæ²¡æœ‰ç›´æ¥ä½¿ç”¨Cè¯­è¨€ä¸­çš„å­—ç¬¦ä¸²ï¼Œå› ä¸ºCè¯­è¨€å­—ç¬¦ä¸²å­˜åœ¨å¾ˆå¤šé—®é¢˜ï¼š<br>è·å–å­—ç¬¦ä¸²é•¿åº¦çš„éœ€è¦é€šè¿‡è¿ç®—<br>éäºŒè¿›åˆ¶å®‰å…¨<br>ä¸å¯ä¿®æ”¹<br>Redisæ„å»ºäº†ä¸€ç§æ–°çš„å­—ç¬¦ä¸²ç»“æ„ï¼Œç§°ä¸ºç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSimple Dynamic Stringï¼‰ï¼Œç®€ç§°SDSã€‚<br>ä¾‹å¦‚ï¼Œæˆ‘ä»¬æ‰§è¡Œå‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> name admin</span><br><span class="line">OK</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆRediså°†åœ¨åº•å±‚åˆ›å»ºä¸¤ä¸ªSDSï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯åŒ…å«&quot;name&quot;çš„SDSï¼Œå¦ä¸€ä¸ªæ˜¯åŒ…å«&quot;admin&quot;&quot;çš„SDSã€‚</p><p>Redisæ˜¯Cè¯­è¨€å®ç°çš„ï¼Œå…¶ä¸­SDSæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œæºç å¦‚ä¸‹ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653984624671.png" alt="1653984624671"></p><p>ä¾‹å¦‚ï¼Œä¸€ä¸ªåŒ…å«å­—ç¬¦ä¸²â€œnameâ€çš„sdsç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653984648404.png" alt="1653984648404"></p><p>SDSä¹‹æ‰€ä»¥å«åšåŠ¨æ€å­—ç¬¦ä¸²ï¼Œæ˜¯å› ä¸ºå®ƒå…·å¤‡åŠ¨æ€æ‰©å®¹çš„èƒ½åŠ›ï¼Œä¾‹å¦‚ä¸€ä¸ªå†…å®¹ä¸ºâ€œhiâ€çš„SDSï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653984787383.png" alt="1653984787383"></p><p>å‡å¦‚æˆ‘ä»¬è¦ç»™SDSè¿½åŠ ä¸€æ®µå­—ç¬¦ä¸²â€œ,Amyâ€ï¼Œè¿™é‡Œé¦–å…ˆä¼šç”³è¯·æ–°å†…å­˜ç©ºé—´ï¼š</p><p>å¦‚æœæ–°å­—ç¬¦ä¸²å°äº1Mï¼Œåˆ™æ–°ç©ºé—´ä¸ºæ‰©å±•åå­—ç¬¦ä¸²é•¿åº¦çš„ä¸¤å€+1ï¼›</p><p>å¦‚æœæ–°å­—ç¬¦ä¸²å¤§äº1Mï¼Œåˆ™æ–°ç©ºé—´ä¸ºæ‰©å±•åå­—ç¬¦ä¸²é•¿åº¦+1M+1ã€‚ç§°ä¸ºå†…å­˜é¢„åˆ†é…ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653984822363.png" alt="1653984822363"></p><mark class="hl-label red">ä¼˜ç‚¹</mark> <p>â‘  è·å–å­—ç¬¦ä¸²é•¿åº¦çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(1ï¼‰</p><p>â‘¡ æ”¯æŒåŠ¨æ€æ‰©å®¹</p><p>â‘¢ å‡å°‘å†…å­˜åˆ†é…æ¬¡æ•°</p><p>â‘£ äºŒè¿›åˆ¶å®‰å…¨</p><hr><h3 id="IntSet">IntSet</h3><p>IntSetæ˜¯Redisä¸­seté›†åˆçš„ä¸€ç§å®ç°æ–¹å¼ï¼ŒåŸºäºæ•´æ•°æ•°ç»„æ¥å®ç°ï¼Œå¹¶ä¸”å…·å¤‡é•¿åº¦å¯å˜ã€æœ‰åºç­‰ç‰¹å¾ã€‚<br>ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">intset</span> &#123;</span></span><br><span class="line"><span class="type">uint32_t</span> encoding;<span class="comment">/*ç¼–ç æ–¹å¼ï¼Œæ”¯æŒå­˜æ”¾16ä½ã€32ä½ã€64ä½æ•´æ•°*/</span> </span><br><span class="line"><span class="type">uint32_t</span> length;<span class="comment">/*å…ƒç´ ä¸ªæ•°*/</span></span><br><span class="line"><span class="type">int8_t</span> contents[];<span class="comment">/*æ•´æ•°æ•°ç»„ï¼Œä¿å­˜é›†åˆæ•°æ®*/</span> </span><br><span class="line">&#125;intset;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„encodingåŒ…å«ä¸‰ç§æ¨¡å¼ï¼Œè¡¨ç¤ºå­˜å‚¨çš„æ•´æ•°å¤§å°ä¸åŒï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> INTSET_ENC_INT16(sizeof(int16_t))<span class="comment">/*2å­—èŠ‚æ•´æ•°ï¼ŒèŒƒå›´ç±»ä¼¼javaçš„short*/</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTSET_ENC_INT32(sizeof(int32_t))<span class="comment">/*4å­—èŠ‚æ•´æ•°ï¼ŒèŒƒå›´ç±»ä¼¼javaçš„int*/</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTSET_ENC_INT64(sizeof(int64_t))<span class="comment">/*8å­—èŠ‚æ•´æ•°ï¼ŒèŒƒå›´ç±»ä¼¼javaçš„long*/</span></span></span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ–¹ä¾¿æŸ¥æ‰¾ï¼ŒRedisä¼šå°†intsetä¸­æ‰€æœ‰çš„æ•´æ•°æŒ‰ç…§å‡åºä¾æ¬¡ä¿å­˜åœ¨contentsæ•°ç»„ä¸­ï¼Œç»“æ„å¦‚å›¾ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653985149557.png" alt="1653985149557"></p><p>ç°åœ¨ï¼Œæ•°ç»„ä¸­æ¯ä¸ªæ•°å­—éƒ½åœ¨int16_tçš„èŒƒå›´å†…ï¼Œå› æ­¤é‡‡ç”¨çš„ç¼–ç æ–¹å¼æ˜¯INTSET_ENC_INT16ï¼Œæ¯éƒ¨åˆ†å ç”¨çš„å­—èŠ‚å¤§å°ä¸ºï¼š<br>encodingï¼š4å­—èŠ‚<br>lengthï¼š4å­—èŠ‚<br>contentsï¼š2å­—èŠ‚ * 3  = 6å­—èŠ‚</p><mark class="hl-label green">IntSetå‡çº§</mark> <p>ç°åœ¨ï¼Œå‡è®¾æœ‰ä¸€ä¸ªintsetï¼Œå…ƒç´ ä¸º{5,10ï¼Œ20}ï¼Œé‡‡ç”¨çš„ç¼–ç æ˜¯INTSET_ENC_INT16ï¼Œåˆ™æ¯ä¸ªæ•´æ•°å 2å­—èŠ‚ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230616110642298.png" alt="image-20230616110642298"></p><p>æˆ‘ä»¬å‘è¯¥å…¶ä¸­æ·»åŠ ä¸€ä¸ªæ•°å­—ï¼š50000ï¼Œè¿™ä¸ªæ•°å­—è¶…å‡ºäº†int16_tçš„èŒƒå›´ï¼Œintsetä¼šè‡ªåŠ¨å‡çº§ç¼–ç æ–¹å¼åˆ°åˆé€‚çš„å¤§å°ã€‚<br>ä»¥å½“å‰æ¡ˆä¾‹æ¥è¯´æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>å‡çº§ç¼–ç ä¸ºINTSET_ENC_INT32, æ¯ä¸ªæ•´æ•°å 4å­—èŠ‚ï¼Œå¹¶æŒ‰ç…§æ–°çš„ç¼–ç æ–¹å¼åŠå…ƒç´ ä¸ªæ•°æ‰©å®¹æ•°ç»„</li><li>å€’åºä¾æ¬¡å°†æ•°ç»„ä¸­çš„å…ƒç´ æ‹·è´åˆ°æ‰©å®¹åçš„æ­£ç¡®ä½ç½®</li><li>å°†å¾…æ·»åŠ çš„å…ƒç´ æ”¾å…¥æ•°ç»„æœ«å°¾</li><li>æœ€åï¼Œå°†insetçš„encodingå±æ€§æ”¹ä¸ºINTSET_ENC_INT32ï¼Œå°†lengthå±æ€§æ”¹ä¸º4</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653985276621.png" alt="1653985276621"></p><mark class="hl-label blue">IntSetæ–°å¢æµç¨‹</mark> <p>æºç å¦‚ä¸‹</p><div class="tabs" id="b59a24b2-347a-4c61-a4ad-db89c7792c05"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#b59a24b2-347a-4c61-a4ad-db89c7792c05-1"><i class="fas fa-seedling"></i>intsetAdd</button></li><li class="tab"><button type="button" data-href="#b59a24b2-347a-4c61-a4ad-db89c7792c05-2"><i class="fas fa-leaf"></i>intsetUpgradeAndAdd</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="b59a24b2-347a-4c61-a4ad-db89c7792c05-1"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653985304075.png" alt="1653985304075"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b59a24b2-347a-4c61-a4ad-db89c7792c05-2"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653985327653.png" alt="1653985327653"  /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><mark class="hl-label green">å°æ€»ç»“</mark> <p>Intsetå¯ä»¥çœ‹åšæ˜¯ç‰¹æ®Šçš„æ•´æ•°æ•°ç»„ï¼Œå…·å¤‡ä¸€äº›ç‰¹ç‚¹ï¼š</p><ul><li>Redisä¼šç¡®ä¿Intsetä¸­çš„å…ƒç´ å”¯ä¸€ã€æœ‰åº</li><li>å…·å¤‡ç±»å‹å‡çº§æœºåˆ¶ï¼Œå¯ä»¥èŠ‚çœå†…å­˜ç©ºé—´</li><li>åº•å±‚é‡‡ç”¨äºŒåˆ†æŸ¥æ‰¾æ–¹å¼æ¥æŸ¥è¯¢</li></ul><hr><h3 id="Dict">Dict</h3><p>æˆ‘ä»¬çŸ¥é“Redisæ˜¯ä¸€ä¸ªé”®å€¼å‹ï¼ˆKey-Value Pairï¼‰çš„æ•°æ®åº“ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®é”®å®ç°å¿«é€Ÿçš„å¢åˆ æ”¹æŸ¥ã€‚è€Œé”®ä¸å€¼çš„æ˜ å°„å…³ç³»æ­£æ˜¯é€šè¿‡Dictæ¥å®ç°çš„ã€‚<br>Dictç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯ï¼šå“ˆå¸Œè¡¨ï¼ˆDictHashTableï¼‰ã€å“ˆå¸ŒèŠ‚ç‚¹ï¼ˆDictEntryï¼‰ã€å­—å…¸ï¼ˆDictï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictht</span> &#123;</span></span><br><span class="line">    dictEntry **table;      <span class="comment">// Entryæ•°ç»„ï¼Œæ•°ç»„ä¸­ä¿å­˜çš„æ˜¯æŒ‡å‘Entryçš„æŒ‡é’ˆ</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> size;     <span class="comment">// å“ˆå¸Œè¡¨æ•°ç»„çš„å¤§å°</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> sizemask; <span class="comment">// å“ˆå¸Œè¡¨æ•°ç»„çš„æ©ç ï¼Œç”¨äºè®¡ç®—ç´¢å¼•å€¼</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> used;     <span class="comment">// Entryä¸ªæ•°</span></span><br><span class="line">&#125; dictht;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> *key;              <span class="comment">// é”®</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="type">void</span> *val;          <span class="comment">// å€¼</span></span><br><span class="line">        <span class="type">uint64_t</span> u64;       <span class="comment">// 64ä½æ— ç¬¦å·æ•´æ•°</span></span><br><span class="line">        <span class="type">int64_t</span> s64;        <span class="comment">// 64ä½æœ‰ç¬¦å·æ•´æ•°</span></span><br><span class="line">        <span class="type">double</span> d;           <span class="comment">// åŒç²¾åº¦æµ®ç‚¹æ•°</span></span><br><span class="line">    &#125; v;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> *<span class="title">next</span>;</span> <span class="comment">// æŒ‡å‘ä¸‹ä¸€ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹çš„æŒ‡é’ˆ</span></span><br><span class="line">&#125; dictEntry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dict</span> &#123;</span></span><br><span class="line">    dictType *type;     <span class="comment">// dictç±»å‹ï¼Œå†…ç½®ä¸åŒçš„hashå‡½æ•°</span></span><br><span class="line">    <span class="type">void</span> *privdata;     <span class="comment">// ç§æœ‰æ•°æ®ï¼Œåœ¨åšç‰¹æ®Šhashè¿ç®—æ—¶ç”¨</span></span><br><span class="line">    dictht ht[<span class="number">2</span>];       <span class="comment">// ä¸€ä¸ªDictåŒ…å«ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯å½“å‰æ•°æ®ï¼Œå¦ä¸€ä¸ªä¸€èˆ¬æ˜¯ç©ºï¼Œrehashæ—¶ä½¿ç”¨</span></span><br><span class="line">    <span class="type">long</span> rehashidx;     <span class="comment">// rehashè¿›åº¦æ ‡è¯†ç¬¦ï¼Œ-1è¡¨ç¤ºæ²¡æœ‰è¿›è¡Œrehashæ“ä½œ</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> iterators; <span class="comment">// rehashæ˜¯å¦æš‚åœï¼Œ1åˆ™æš‚åœï¼Œ0åˆ™ç»§ç»­</span></span><br><span class="line">&#125; dict;</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬å‘Dictæ·»åŠ é”®å€¼å¯¹æ—¶ï¼ŒRedisé¦–å…ˆæ ¹æ®keyè®¡ç®—å‡ºhashå€¼ï¼ˆhï¼‰ï¼Œç„¶ååˆ©ç”¨ h &amp; sizemaskæ¥è®¡ç®—å…ƒç´ åº”è¯¥å­˜å‚¨åˆ°æ•°ç»„ä¸­çš„å“ªä¸ªç´¢å¼•ä½ç½®ã€‚æˆ‘ä»¬å­˜å‚¨k1=v1ï¼Œå‡è®¾k1çš„å“ˆå¸Œå€¼h =1ï¼Œåˆ™1&amp;3 =1ï¼Œå› æ­¤k1=v1è¦å­˜å‚¨åˆ°æ•°ç»„è§’æ ‡1ä½ç½®ã€‚å†æ¥ä¸€ä¸ªk2=v2,hashå€¼ç›¸ç­‰ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653985497735.png" alt="1653985497735"></p><p>Dictç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯ï¼šå“ˆå¸Œè¡¨ï¼ˆDictHashTableï¼‰ã€å“ˆå¸ŒèŠ‚ç‚¹ï¼ˆDictEntryï¼‰ã€å­—å…¸ï¼ˆDictï¼‰</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653985640422.png" alt="1653985640422"></p><div class="tabs" id="30d4fd04-9ea3-400c-8733-b028dc42b438"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#30d4fd04-9ea3-400c-8733-b028dc42b438-1"><i class="fas fa-cat"></i>Dictçš„æ‰©å®¹</button></li><li class="tab"><button type="button" data-href="#30d4fd04-9ea3-400c-8733-b028dc42b438-2"><i class="fas fa-cookie-bite"></i>Dictçš„æ”¶ç¼©</button></li><li class="tab"><button type="button" data-href="#30d4fd04-9ea3-400c-8733-b028dc42b438-3"><i class="fas fa-horse"></i>Dictçš„rehash</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="30d4fd04-9ea3-400c-8733-b028dc42b438-1"><p>Dictä¸­çš„HashTableå°±æ˜¯æ•°ç»„ç»“åˆå•å‘é“¾è¡¨çš„å®ç°ï¼Œå½“é›†åˆä¸­å…ƒç´ è¾ƒå¤šæ—¶ï¼Œå¿…ç„¶å¯¼è‡´å“ˆå¸Œå†²çªå¢å¤šï¼Œé“¾è¡¨è¿‡é•¿ï¼Œåˆ™æŸ¥è¯¢æ•ˆç‡ä¼šå¤§å¤§é™ä½ã€‚<br>Dictåœ¨æ¯æ¬¡æ–°å¢é”®å€¼å¯¹æ—¶éƒ½ä¼šæ£€æŸ¥è´Ÿè½½å› å­ï¼ˆLoadFactor = used/sizeï¼‰ ï¼Œæ»¡è¶³ä»¥ä¸‹ä¸¤ç§æƒ…å†µæ—¶ä¼šè§¦å‘å“ˆå¸Œè¡¨æ‰©å®¹ï¼š</p><ul><li>å“ˆå¸Œè¡¨çš„ LoadFactor &gt;= 1ï¼Œå¹¶ä¸”æœåŠ¡å™¨æ²¡æœ‰æ‰§è¡Œ BGSAVE æˆ–è€… BGREWRITEAOF ç­‰åå°è¿›ç¨‹ï¼›</li><li>å“ˆå¸Œè¡¨çš„ LoadFactor &gt; 5 ï¼›</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">dicExpandIfNeeded</span><span class="params">(dict *d)</span>&#123;</span><br><span class="line">  <span class="comment">// å¦‚æœæ­£åœ¨rehashï¼Œåˆ™è¿”å›ok</span></span><br><span class="line">  <span class="keyword">if</span>(dictIsRehashing(d)) <span class="keyword">return</span> DICT_OK;</span><br><span class="line">  <span class="comment">// å¦‚æœå“ˆå¸Œè¡¨ä¸ºç©ºï¼Œåˆ™åˆå§‹åŒ–å“ˆå¸Œè¡¨ä¸ºé»˜è®¤å¤§å°ï¼š4</span></span><br><span class="line">  <span class="keyword">if</span>(d-&gt;ht[<span class="number">0</span>].size == <span class="number">0</span>) <span class="keyword">return</span> dictExpand(d,DICT_HT_INITIAL_SIZE);</span><br><span class="line">  <span class="comment">// å½“è´Ÿè½½å› å­ (used/sizeï¼‰è¾¾åˆ°1ä»¥ä¸Šï¼Œå¹¶ä¸”å½“å‰æ²¡æœ‰è¿›è¡Œbgrewriteç­‰å­è¿›ç¨‹æ“ä½œ</span></span><br><span class="line">  <span class="comment">// æˆ–è€…è´Ÿè½½å› å­è¶…è¿‡5ï¼Œåˆ™è¿›è¡Œ dictExpandï¼Œä¹Ÿå°±æ˜¯æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (d-&gt;ht[<span class="number">0</span>].used &gt;= d-&gt;ht[<span class="number">0</span>].size &amp;&amp;</span><br><span class="line">        (dict_can_resize ||</span><br><span class="line">         d-&gt;ht[<span class="number">0</span>].used/d-&gt;ht[<span class="number">0</span>].size &gt; dict_force_resize_ratio) &amp;&amp;</span><br><span class="line">        dictTypeExpandAllowed(d))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// æ‰©å®¹å¤§å°ä¸ºused+1ï¼Œåº•å±‚ä¼šå¯¹æ‰©å®¹å¤§å°åšåˆ¤æ–­ï¼Œå®é™…ä¸Šæ‰¾çš„æ˜¯ç¬¬ä¸€ä¸ªå¤§äºç­‰äºused+1çš„ 2^n</span></span><br><span class="line">        <span class="keyword">return</span> dictExpand(d, d-&gt;ht[<span class="number">0</span>].used + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> DICT_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="30d4fd04-9ea3-400c-8733-b028dc42b438-2"><p>Dicté™¤äº†æ‰©å®¹ä»¥å¤–ï¼Œæ¯æ¬¡åˆ é™¤å…ƒç´ æ—¶ï¼Œä¹Ÿä¼šå¯¹è´Ÿè½½å› å­åšæ£€æŸ¥ï¼Œå½“LoadFactor &lt; 0.1 æ—¶ï¼Œä¼šåšå“ˆå¸Œè¡¨æ”¶ç¼©</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// t_hash.c # hashTypeDeleted() </span></span><br><span class="line"><span class="keyword">if</span> (dictDelete((dict*)o-&gt;ptr, field) == C_OK) &#123;</span><br><span class="line">Â  Â  deleted = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// åˆ é™¤æˆåŠŸåï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®Dictå¤§å°ï¼Œå¦‚æœéœ€è¦åˆ™è°ƒç”¨dictResizeé‡ç½®</span></span><br><span class="line">Â  Â  <span class="keyword">if</span> (htNeedsResize(o-&gt;ptr)) dictResize(o-&gt;ptr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// server.c æ–‡ä»¶</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">htNeedsResize</span><span class="params">(dict *dict)</span> &#123;</span><br><span class="line">Â  Â  <span class="type">long</span> <span class="type">long</span> size, used;</span><br><span class="line">Â  Â  <span class="comment">// å“ˆå¸Œè¡¨å¤§å°</span></span><br><span class="line">Â  Â  size = dictSlots(dict);</span><br><span class="line">Â  Â  <span class="comment">// entryæ•°é‡</span></span><br><span class="line">Â  Â  used = dictSize(dict);</span><br><span class="line">Â  Â  <span class="comment">// size &gt; 4ï¼ˆå“ˆå¸Œè¡¨åˆè¯†å¤§å°ï¼‰å¹¶ä¸” è´Ÿè½½å› å­ä½äº0.1</span></span><br><span class="line">Â  Â  <span class="keyword">return</span> (size &gt; DICT_HT_INITIAL_SIZE &amp;&amp; (used*<span class="number">100</span>/size &lt; HASHTABLE_MIN_FILL));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">dictResize</span><span class="params">(dict *d)</span>&#123;</span><br><span class="line">Â  Â  <span class="type">unsigned</span> <span class="type">long</span> minimal;</span><br><span class="line">Â  Â  <span class="comment">// å¦‚æœæ­£åœ¨åšbgsaveæˆ–bgrewriteofæˆ–rehashï¼Œåˆ™è¿”å›é”™è¯¯</span></span><br><span class="line">Â  Â  <span class="keyword">if</span> (!dict_can_resize || dictIsRehashing(d)) </span><br><span class="line">        <span class="keyword">return</span> DICT_ERR;</span><br><span class="line">Â  Â  <span class="comment">// è·å–usedï¼Œä¹Ÿå°±æ˜¯entryä¸ªæ•°</span></span><br><span class="line">Â  Â  minimal = d-&gt;ht[<span class="number">0</span>].used;</span><br><span class="line">Â  Â  <span class="comment">// å¦‚æœusedå°äº4ï¼Œåˆ™é‡ç½®ä¸º4</span></span><br><span class="line">Â  Â  <span class="keyword">if</span> (minimal &lt; DICT_HT_INITIAL_SIZE)</span><br><span class="line">Â  Â  Â  Â  minimal = DICT_HT_INITIAL_SIZE;</span><br><span class="line">Â  Â  <span class="comment">// é‡ç½®å¤§å°ä¸ºminimalï¼Œå…¶å®æ˜¯ç¬¬ä¸€ä¸ªå¤§äºç­‰äºminimalçš„2^n</span></span><br><span class="line">Â  Â  <span class="keyword">return</span> dictExpand(d, minimal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="30d4fd04-9ea3-400c-8733-b028dc42b438-3"><p>ä¸ç®¡æ˜¯æ‰©å®¹è¿˜æ˜¯æ”¶ç¼©ï¼Œå¿…å®šä¼šåˆ›å»ºæ–°çš„å“ˆå¸Œè¡¨ï¼Œå¯¼è‡´å“ˆå¸Œè¡¨çš„sizeå’Œsizemaskå˜åŒ–ï¼Œè€Œkeyçš„æŸ¥è¯¢ä¸sizemaskæœ‰å…³ã€‚å› æ­¤å¿…é¡»å¯¹å“ˆå¸Œè¡¨ä¸­çš„æ¯ä¸€ä¸ªkeyé‡æ–°è®¡ç®—ç´¢å¼•ï¼Œæ’å…¥æ–°çš„å“ˆå¸Œè¡¨ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºrehashã€‚è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ul><li>è®¡ç®—æ–°hashè¡¨çš„realeSizeï¼Œå€¼å–å†³äºå½“å‰è¦åšçš„æ˜¯æ‰©å®¹è¿˜æ˜¯æ”¶ç¼©ï¼š<ul><li>å¦‚æœæ˜¯æ‰©å®¹ï¼Œ<a href="http://xn--sizedict-309lrnyf93ba308jhyz009bulyebpa.ht">åˆ™æ–°sizeä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºdict.ht</a>[0].used + 1çš„2^n</li><li>å¦‚æœæ˜¯æ”¶ç¼©ï¼Œ<a href="http://xn--sizedict-309lrnyf93ba308jhyz009bulyebpa.ht">åˆ™æ–°sizeä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºdict.ht</a>[0].usedçš„2^n ï¼ˆä¸å¾—å°äº4ï¼‰</li></ul></li><li>æŒ‰ç…§æ–°çš„realeSizeç”³è¯·å†…å­˜ç©ºé—´ï¼Œåˆ›å»ºdicthtï¼Œ<a href="http://xn--dict-9k7fo76ei05chfya.ht">å¹¶èµ‹å€¼ç»™dict.ht</a>[1]</li><li>è®¾ç½®dict.rehashidx = 0ï¼Œæ ‡ç¤ºå¼€å§‹rehash</li><li><s><a href="http://xn--dict-fw9g.ht">å°†dict.ht</a>[0]<a href="http://xn--dictEntryrehashdict-f673ahz3bw09ldr4l367by3xi.ht">ä¸­çš„æ¯ä¸€ä¸ªdictEntryéƒ½rehashåˆ°dict.ht</a>[1]</s></li><li>æ¯æ¬¡æ‰§è¡Œæ–°å¢ã€æŸ¥è¯¢ã€ä¿®æ”¹ã€åˆ é™¤æ“ä½œæ—¶ï¼Œéƒ½æ£€æŸ¥ä¸€ä¸‹dict.rehashidxæ˜¯å¦å¤§äº-1ï¼Œ<a href="http://xn--dict-fj9fn60b3meqtz33c.ht">å¦‚æœæ˜¯åˆ™å°†dict.ht</a>[0].table[rehashidx]<a href="http://xn--entryrehashdict-df7y2036bukvcc86b.ht">çš„entryé“¾è¡¨rehashåˆ°dict.ht</a>[1]ï¼Œå¹¶ä¸”å°†rehashidx++ã€‚<a href="http://xn--dict-907j085c.ht">ç›´è‡³dict.ht</a>[0]<a href="http://xn--rehashdict-s11qz55mghdu3ijtgvl6e2byf.ht">çš„æ‰€æœ‰æ•°æ®éƒ½rehashåˆ°dict.ht</a>[1]</li><li><a href="http://xn--dict-fw9g.ht">å°†dict.ht</a>[1]<a href="http://xn--dict-9k7f028vteva.ht">èµ‹å€¼ç»™dict.ht</a>[0]ï¼Œ<a href="http://xn--dict-z95k.ht">ç»™dict.ht</a>[1]åˆå§‹åŒ–ä¸ºç©ºå“ˆå¸Œè¡¨ï¼Œ<a href="http://xn--dict-430gi74gild203bjk5c.ht">é‡Šæ”¾åŸæ¥çš„dict.ht</a>[0]çš„å†…å­˜</li><li>å°†rehashidxèµ‹å€¼ä¸º-1ï¼Œä»£è¡¨rehashç»“æŸ</li><li>åœ¨rehashè¿‡ç¨‹ä¸­ï¼Œæ–°å¢æ“ä½œï¼Œåˆ™ç›´æ¥å†™å…¥ht[1]ï¼ŒæŸ¥è¯¢ã€<a href="http://xn--dict-ue6fy7b90hub348a7phvn7bvk9i.ht">ä¿®æ”¹å’Œåˆ é™¤åˆ™ä¼šåœ¨dict.ht</a>[0]<a href="http://xn--dict-z21g.ht">å’Œdict.ht</a>[1]ä¾æ¬¡æŸ¥æ‰¾å¹¶æ‰§è¡Œã€‚è¿™æ ·å¯ä»¥ç¡®ä¿ht[0]çš„æ•°æ®åªå‡ä¸å¢ï¼Œéšç€rehashæœ€ç»ˆä¸ºç©º</li></ul><p>Dictçš„rehashå¹¶ä¸æ˜¯ä¸€æ¬¡æ€§å®Œæˆçš„ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœDictä¸­åŒ…å«æ•°ç™¾ä¸‡çš„entryï¼Œè¦åœ¨ä¸€æ¬¡rehashå®Œæˆï¼Œææœ‰å¯èƒ½å¯¼è‡´ä¸»çº¿ç¨‹é˜»å¡ã€‚å› æ­¤Dictçš„rehashæ˜¯åˆ†å¤šæ¬¡ã€æ¸è¿›å¼çš„å®Œæˆï¼Œå› æ­¤ç§°ä¸ºæ¸è¿›å¼rehashã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><mark class="hl-label blue">å°æ€»ç»“</mark> <p>Dictçš„ç»“æ„ï¼š</p><ul><li>ç±»ä¼¼javaçš„HashTableï¼Œåº•å±‚æ˜¯æ•°ç»„åŠ é“¾è¡¨æ¥è§£å†³å“ˆå¸Œå†²çª</li><li>DictåŒ…å«ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œht[0]å¹³å¸¸ç”¨ï¼Œht[1]ç”¨æ¥rehash</li></ul><p>Dictçš„ä¼¸ç¼©ï¼š</p><ul><li>å½“LoadFactorå¤§äº5æˆ–è€…LoadFactorå¤§äº1å¹¶ä¸”æ²¡æœ‰å­è¿›ç¨‹ä»»åŠ¡æ—¶ï¼ŒDictæ‰©å®¹</li><li>å½“LoadFactorå°äº0.1æ—¶ï¼ŒDictæ”¶ç¼©</li><li>æ‰©å®¹å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºused + 1çš„2^n</li><li>æ”¶ç¼©å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºused çš„2^n</li><li>Dicté‡‡ç”¨æ¸è¿›å¼rehashï¼Œæ¯æ¬¡è®¿é—®Dictæ—¶æ‰§è¡Œä¸€æ¬¡rehash</li><li>rehashæ—¶ht[0]åªå‡ä¸å¢ï¼Œæ–°å¢æ“ä½œåªåœ¨ht[1]æ‰§è¡Œï¼Œå…¶å®ƒæ“ä½œåœ¨ä¸¤ä¸ªå“ˆå¸Œè¡¨</li></ul><hr><h3 id="ZipList">ZipList</h3><p>ZipList æ˜¯ä¸€ç§ç‰¹æ®Šçš„â€œåŒç«¯é“¾è¡¨â€ ï¼Œç”±ä¸€ç³»åˆ—ç‰¹æ®Šç¼–ç çš„è¿ç»­å†…å­˜å—ç»„æˆã€‚å¯ä»¥åœ¨ä»»æ„ä¸€ç«¯è¿›è¡Œå‹å…¥/å¼¹å‡ºæ“ä½œ, å¹¶ä¸”è¯¥æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230616120637074.png" alt="image-20230616120637074"></p><table><thead><tr><th><strong>å±æ€§</strong></th><th><strong>ç±»å‹</strong></th><th><strong>é•¿åº¦</strong></th><th><strong>ç”¨é€”</strong></th></tr></thead><tbody><tr><td>zlbytes</td><td>uint32_t</td><td>4 å­—èŠ‚</td><td>è®°å½•æ•´ä¸ªå‹ç¼©åˆ—è¡¨å ç”¨çš„å†…å­˜å­—èŠ‚æ•°</td></tr><tr><td>zltail</td><td>uint32_t</td><td>4 å­—èŠ‚</td><td>è®°å½•å‹ç¼©åˆ—è¡¨è¡¨å°¾èŠ‚ç‚¹è·ç¦»å‹ç¼©åˆ—è¡¨çš„èµ·å§‹åœ°å€æœ‰å¤šå°‘å­—èŠ‚ï¼Œé€šè¿‡è¿™ä¸ªåç§»é‡ï¼Œå¯ä»¥ç¡®å®šè¡¨å°¾èŠ‚ç‚¹çš„åœ°å€ã€‚</td></tr><tr><td>zllen</td><td>uint16_t</td><td>2 å­—èŠ‚</td><td>è®°å½•äº†å‹ç¼©åˆ—è¡¨åŒ…å«çš„èŠ‚ç‚¹æ•°é‡ã€‚ æœ€å¤§å€¼ä¸ºUINT16_MAX ï¼ˆ65534ï¼‰ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªå€¼ï¼Œæ­¤å¤„ä¼šè®°å½•ä¸º65535ï¼Œä½†èŠ‚ç‚¹çš„çœŸå®æ•°é‡éœ€è¦éå†æ•´ä¸ªå‹ç¼©åˆ—è¡¨æ‰èƒ½è®¡ç®—å¾—å‡ºã€‚</td></tr><tr><td>entry</td><td>åˆ—è¡¨èŠ‚ç‚¹</td><td>ä¸å®š</td><td>å‹ç¼©åˆ—è¡¨åŒ…å«çš„å„ä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çš„é•¿åº¦ç”±èŠ‚ç‚¹ä¿å­˜çš„å†…å®¹å†³å®šã€‚</td></tr><tr><td>zlend</td><td>uint8_t</td><td>1 å­—èŠ‚</td><td>ç‰¹æ®Šå€¼ 0xFF ï¼ˆåè¿›åˆ¶ 255 ï¼‰ï¼Œç”¨äºæ ‡è®°å‹ç¼©åˆ—è¡¨çš„æœ«ç«¯ã€‚</td></tr></tbody></table><mark class="hl-label blue">ZipListEntry</mark> <p>ZipList ä¸­çš„Entryå¹¶ä¸åƒæ™®é€šé“¾è¡¨é‚£æ ·è®°å½•å‰åèŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå› ä¸ºè®°å½•ä¸¤ä¸ªæŒ‡é’ˆè¦å ç”¨16ä¸ªå­—èŠ‚ï¼Œæµªè´¹å†…å­˜ã€‚è€Œæ˜¯é‡‡ç”¨äº†ä¸‹é¢çš„ç»“æ„ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653986055253.png" alt="1653986055253"></p><ul><li><p>previous_entry_lengthï¼šå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦ï¼Œå 1ä¸ªæˆ–5ä¸ªå­—èŠ‚ã€‚</p><ul><li>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å°äº254å­—èŠ‚ï¼Œåˆ™é‡‡ç”¨1ä¸ªå­—èŠ‚æ¥ä¿å­˜è¿™ä¸ªé•¿åº¦å€¼</li><li>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å¤§äº254å­—èŠ‚ï¼Œåˆ™é‡‡ç”¨5ä¸ªå­—èŠ‚æ¥ä¿å­˜è¿™ä¸ªé•¿åº¦å€¼ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º0xfeï¼Œåå››ä¸ªå­—èŠ‚æ‰æ˜¯çœŸå®é•¿åº¦æ•°æ®</li></ul></li><li><p>encodingï¼šç¼–ç å±æ€§ï¼Œè®°å½•contentçš„æ•°æ®ç±»å‹ï¼ˆå­—ç¬¦ä¸²è¿˜æ˜¯æ•´æ•°ï¼‰ä»¥åŠé•¿åº¦ï¼Œå ç”¨1ä¸ªã€2ä¸ªæˆ–5ä¸ªå­—èŠ‚</p></li><li><p>contentsï¼šè´Ÿè´£ä¿å­˜èŠ‚ç‚¹çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–æ•´æ•°</p></li></ul><p>ZipListä¸­æ‰€æœ‰å­˜å‚¨é•¿åº¦çš„æ•°å€¼å‡é‡‡ç”¨å°ç«¯å­—èŠ‚åºï¼Œå³ä½ä½å­—èŠ‚åœ¨å‰ï¼Œé«˜ä½å­—èŠ‚åœ¨åã€‚ä¾‹å¦‚ï¼šæ•°å€¼0x1234ï¼Œé‡‡ç”¨å°ç«¯å­—èŠ‚åºåå®é™…å­˜å‚¨å€¼ä¸ºï¼š0x3412</p><mark class="hl-label green">Encodingç¼–ç </mark> <p>ZipListEntryä¸­çš„encodingç¼–ç åˆ†ä¸ºå­—ç¬¦ä¸²å’Œæ•´æ•°ä¸¤ç§ï¼š<br>å­—ç¬¦ä¸²ï¼šå¦‚æœencodingæ˜¯ä»¥â€œ00â€ã€â€œ01â€æˆ–è€…â€œ10â€å¼€å¤´ï¼Œåˆ™è¯æ˜contentæ˜¯å­—ç¬¦ä¸²</p><table><thead><tr><th>ç¼–ç </th><th>ç¼–ç é•¿åº¦</th><th>å­—ç¬¦ä¸²å¤§å°</th></tr></thead><tbody><tr><td>|00pppppp|</td><td>1 bytes</td><td>&lt;= 63 bytes</td></tr><tr><td>|01pppppp|qqqqqqqq|</td><td>2 bytes</td><td>&lt;= 16383 bytes</td></tr><tr><td>|10000000|qqqqqqqq|rrrrrrrr|ssssssss|tttttttt|</td><td>5 bytes</td><td>&lt;= 4294967295 bytes</td></tr></tbody></table><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦ä¿å­˜å­—ç¬¦ä¸²ï¼šâ€œabâ€å’Œ â€œbcâ€</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653986172002.png" alt="1653986172002"></p><p>æ•´æ•°ï¼šå¦‚æœencodingæ˜¯ä»¥â€œ11â€å¼€å§‹ï¼Œåˆ™è¯æ˜contentæ˜¯æ•´æ•°ï¼Œä¸”encodingå›ºå®šåªå ç”¨1ä¸ªå­—èŠ‚</p><table><thead><tr><th style="text-align:center">ç¼–ç </th><th style="text-align:center">ç¼–ç é•¿åº¦</th><th style="text-align:center">æ•´æ•°ç±»å‹</th></tr></thead><tbody><tr><td style="text-align:center">11000000</td><td style="text-align:center">1</td><td style="text-align:center">int16_tï¼ˆ2 bytesï¼‰</td></tr><tr><td style="text-align:center">11010000</td><td style="text-align:center">1</td><td style="text-align:center">int32_tï¼ˆ4 bytesï¼‰</td></tr><tr><td style="text-align:center">11100000</td><td style="text-align:center">1</td><td style="text-align:center">int64_tï¼ˆ8 bytesï¼‰</td></tr><tr><td style="text-align:center">11110000</td><td style="text-align:center">1</td><td style="text-align:center">24ä½æœ‰ç¬¦æ•´æ•°(3 bytes)</td></tr><tr><td style="text-align:center">11111110</td><td style="text-align:center">1</td><td style="text-align:center">8ä½æœ‰ç¬¦æ•´æ•°(1 bytes)</td></tr><tr><td style="text-align:center">1111xxxx</td><td style="text-align:center">1</td><td style="text-align:center">ç›´æ¥åœ¨xxxxä½ç½®ä¿å­˜æ•°å€¼ï¼ŒèŒƒå›´ä»0001~1101(0-12)ï¼Œå‡1åç»“æœä¸ºå®é™…å€¼</td></tr></tbody></table><p>ä¾‹å¦‚ï¼Œä¸€ä¸ªZipListä¸­åŒ…å«ä¸¤ä¸ªæ•´æ•°å€¼ï¼šâ€œ2â€å’Œâ€œ5â€</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230616143324590.png" alt="image-20230616143324590"></p><mark class="hl-label red">ZipListçš„è¿é”æ›´æ–°é—®é¢˜</mark> <p>ZipListçš„æ¯ä¸ªEntryéƒ½åŒ…å«previous_entry_lengthæ¥è®°å½•ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„å¤§å°ï¼Œé•¿åº¦æ˜¯1ä¸ªæˆ–5ä¸ªå­—èŠ‚ï¼š<br>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å°äº254å­—èŠ‚ï¼Œåˆ™é‡‡ç”¨1ä¸ªå­—èŠ‚æ¥ä¿å­˜è¿™ä¸ªé•¿åº¦å€¼<br>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å¤§äºç­‰äº254å­—èŠ‚ï¼Œåˆ™é‡‡ç”¨5ä¸ªå­—èŠ‚æ¥ä¿å­˜è¿™ä¸ªé•¿åº¦å€¼ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º0xfeï¼Œåå››ä¸ªå­—èŠ‚æ‰æ˜¯çœŸå®é•¿åº¦æ•°æ®<br>ç°åœ¨ï¼Œå‡è®¾æˆ‘ä»¬æœ‰Nä¸ªè¿ç»­çš„ã€é•¿åº¦ä¸º250~253å­—èŠ‚ä¹‹é—´çš„entryï¼Œå› æ­¤entryçš„previous_entry_lengthå±æ€§ç”¨1ä¸ªå­—èŠ‚å³å¯è¡¨ç¤ºï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230616145824215.png" alt="image-20230616145824215"></p><p>æ­¤æ—¶å¾€å¤´éƒ¨æ·»åŠ ä¸€ä¸ªé•¿åº¦å¤§äºç­‰äº254å­—èŠ‚çš„entry</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653986328124.png" alt="1653986328124"></p><p>ZipListè¿™ç§ç‰¹æ®Šæƒ…å†µä¸‹äº§ç”Ÿçš„è¿ç»­å¤šæ¬¡ç©ºé—´æ‰©å±•æ“ä½œç§°ä¹‹ä¸ºè¿é”æ›´æ–°ï¼ˆCascade Updateï¼‰ã€‚æ–°å¢ã€åˆ é™¤éƒ½å¯èƒ½å¯¼è‡´è¿é”æ›´æ–°çš„å‘ç”Ÿã€‚</p><mark class="hl-label blue">å°æ€»ç»“</mark> <p>ZipListç‰¹æ€§ï¼š</p><ul><li>å‹ç¼©åˆ—è¡¨çš„å¯ä»¥çœ‹åšä¸€ç§è¿ç»­å†…å­˜ç©ºé—´çš„&quot;åŒå‘é“¾è¡¨&quot;</li><li>åˆ—è¡¨çš„èŠ‚ç‚¹ä¹‹é—´ä¸æ˜¯é€šè¿‡æŒ‡é’ˆè¿æ¥ï¼Œè€Œæ˜¯è®°å½•ä¸Šä¸€èŠ‚ç‚¹å’Œæœ¬èŠ‚ç‚¹é•¿åº¦æ¥å¯»å€ï¼Œå†…å­˜å ç”¨è¾ƒä½</li><li>å¦‚æœåˆ—è¡¨æ•°æ®è¿‡å¤šï¼Œå¯¼è‡´é“¾è¡¨è¿‡é•¿ï¼Œå¯èƒ½å½±å“æŸ¥è¯¢æ€§èƒ½</li><li>å¢æˆ–åˆ è¾ƒå¤§æ•°æ®æ—¶æœ‰å¯èƒ½å‘ç”Ÿè¿ç»­æ›´æ–°é—®é¢˜</li></ul><hr><h3 id="QuickList">QuickList</h3><p>é—®é¢˜1ï¼šZipListè™½ç„¶èŠ‚çœå†…å­˜ï¼Œä½†ç”³è¯·å†…å­˜å¿…é¡»æ˜¯è¿ç»­ç©ºé—´ï¼Œå¦‚æœå†…å­˜å ç”¨è¾ƒå¤šï¼Œç”³è¯·å†…å­˜æ•ˆç‡å¾ˆä½ã€‚æ€ä¹ˆåŠï¼Ÿ</p><p>â€‹ç­”ï¼šä¸ºäº†ç¼“è§£è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»é™åˆ¶ZipListçš„é•¿åº¦å’Œentryå¤§å°ã€‚</p><p>é—®é¢˜2ï¼šä½†æ˜¯æˆ‘ä»¬è¦å­˜å‚¨å¤§é‡æ•°æ®ï¼Œè¶…å‡ºäº†ZipListæœ€ä½³çš„ä¸Šé™è¯¥æ€ä¹ˆåŠï¼Ÿ</p><p>â€‹ç­”ï¼šæˆ‘ä»¬å¯ä»¥åˆ›å»ºå¤šä¸ªZipListæ¥åˆ†ç‰‡å­˜å‚¨æ•°æ®ã€‚</p><p>é—®é¢˜3ï¼šæ•°æ®æ‹†åˆ†åæ¯”è¾ƒåˆ†æ•£ï¼Œä¸æ–¹ä¾¿ç®¡ç†å’ŒæŸ¥æ‰¾ï¼Œè¿™å¤šä¸ªZipListå¦‚ä½•å»ºç«‹è”ç³»ï¼Ÿ</p><p>â€‹ç­”ï¼šRedisåœ¨3.2ç‰ˆæœ¬å¼•å…¥äº†æ–°çš„æ•°æ®ç»“æ„QuickListï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒç«¯é“¾è¡¨ï¼Œåªä¸è¿‡é“¾è¡¨ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªZipListã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653986474927.png" alt="1653986474927"></p><p>ä¸ºäº†é¿å…QuickListä¸­çš„æ¯ä¸ªZipListä¸­entryè¿‡å¤šï¼ŒRedisæä¾›äº†ä¸€ä¸ªé…ç½®é¡¹ï¼šlist-max-ziplist-sizeæ¥é™åˆ¶ã€‚<br>å¦‚æœå€¼ä¸ºæ­£ï¼Œåˆ™ä»£è¡¨ZipListçš„å…è®¸çš„entryä¸ªæ•°çš„æœ€å¤§å€¼<br>å¦‚æœå€¼ä¸ºè´Ÿï¼Œåˆ™ä»£è¡¨ZipListçš„æœ€å¤§å†…å­˜å¤§å°ï¼Œåˆ†5ç§æƒ…å†µï¼š</p><ul><li>1ï¼šæ¯ä¸ªZipListçš„å†…å­˜å ç”¨ä¸èƒ½è¶…è¿‡4kb</li><li>2ï¼šæ¯ä¸ªZipListçš„å†…å­˜å ç”¨ä¸èƒ½è¶…è¿‡8kb</li><li>3ï¼šæ¯ä¸ªZipListçš„å†…å­˜å ç”¨ä¸èƒ½è¶…è¿‡16kb</li><li>4ï¼šæ¯ä¸ªZipListçš„å†…å­˜å ç”¨ä¸èƒ½è¶…è¿‡32kb</li><li>5ï¼šæ¯ä¸ªZipListçš„å†…å­˜å ç”¨ä¸èƒ½è¶…è¿‡64kb</li></ul><p>å…¶é»˜è®¤å€¼ä¸º -2</p><p>é™¤äº†æ§åˆ¶ZipListçš„å¤§å°ï¼ŒQuickListè¿˜å¯ä»¥å¯¹èŠ‚ç‚¹çš„ZipListåšå‹ç¼©ã€‚é€šè¿‡é…ç½®é¡¹list-compress-depthæ¥æ§åˆ¶ã€‚å› ä¸ºé“¾è¡¨ä¸€èˆ¬éƒ½æ˜¯ä»é¦–å°¾è®¿é—®è¾ƒå¤šï¼Œæ‰€ä»¥é¦–å°¾æ˜¯ä¸å‹ç¼©çš„ã€‚è¿™ä¸ªå‚æ•°æ˜¯æ§åˆ¶é¦–å°¾ä¸å‹ç¼©çš„èŠ‚ç‚¹ä¸ªæ•°ï¼š</p><p>0ï¼šç‰¹æ®Šå€¼ï¼Œä»£è¡¨ä¸å‹ç¼©</p><p>1ï¼šæ ‡ç¤ºQuickListçš„é¦–å°¾å„æœ‰1ä¸ªèŠ‚ç‚¹ä¸å‹ç¼©ï¼Œä¸­é—´èŠ‚ç‚¹å‹ç¼©</p><p>2ï¼šæ ‡ç¤ºQuickListçš„é¦–å°¾å„æœ‰2ä¸ªèŠ‚ç‚¹ä¸å‹ç¼©ï¼Œä¸­é—´èŠ‚ç‚¹å‹ç¼©</p><p>ä»¥æ­¤ç±»æ¨</p><p>é»˜è®¤å€¼ï¼š 0</p><p>ä»¥ä¸‹æ˜¯QuickListçš„å’ŒQuickListNodeçš„ç»“æ„æºç ï¼š</p><div class="tabs" id="7e84b56c-b0a5-4e0b-8fe8-c7bb22cafc52"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#7e84b56c-b0a5-4e0b-8fe8-c7bb22cafc52-1"><i class="fas fa-atom"></i>QuickList</button></li><li class="tab"><button type="button" data-href="#7e84b56c-b0a5-4e0b-8fe8-c7bb22cafc52-2"><i class="far fa-sun"></i>QuickListNode</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="7e84b56c-b0a5-4e0b-8fe8-c7bb22cafc52-1"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklist</span> &#123;</span></span><br><span class="line"><span class="comment">//å¤´èŠ‚ç‚¹æŒ‡é’ˆ</span></span><br><span class="line">quicklistNode *head;</span><br><span class="line"><span class="comment">//å°¾èŠ‚ç‚¹æŒ‡é’ˆ</span></span><br><span class="line">quicklistNode *tail;</span><br><span class="line"><span class="comment">//æ‰€æœ‰ziplistçš„entryçš„æ•°é‡ </span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> count;</span><br><span class="line"><span class="comment">//ziplistsæ€»æ•°é‡ </span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> len;</span><br><span class="line"><span class="comment">//ziplistçš„entryä¸Šé™ï¼Œé»˜è®¤å€¼-2 </span></span><br><span class="line"><span class="type">int</span> fill : QL_FILL_BITSï¼›</span><br><span class="line"><span class="comment">//é¦–å°¾ä¸å‹ç¼©çš„èŠ‚ç‚¹æ•°é‡</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> compress : QL_COMP_BITS;</span><br><span class="line"><span class="comment">//å†…å­˜é‡åˆ†é…æ—¶çš„ä¹¦ç­¾æ•°é‡åŠæ•°ç»„ï¼Œä¸€èˆ¬ç”¨ä¸åˆ°</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> bookmark_count : QL_BM_BITS;</span><br><span class="line">quicklistBookmark bookmarksD[];</span><br><span class="line">&#125; quicklist</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="7e84b56c-b0a5-4e0b-8fe8-c7bb22cafc52-2"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistNode</span> &#123;</span></span><br><span class="line">  <span class="comment">//å‰ä¸€ä¸ªèŠ‚ç‚¹æŒ‡é’ˆ</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">quicklistNode</span> *<span class="title">prev</span>;</span></span><br><span class="line">  <span class="comment">//ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æŒ‡é’ˆ</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">quicklistNode</span> *<span class="title">next</span>;</span></span><br><span class="line">  <span class="comment">//å½“å‰èŠ‚ç‚¹çš„ZipListæŒ‡é’ˆ</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> *zl;</span><br><span class="line">  <span class="comment">//å½“å‰èŠ‚ç‚¹çš„ZipListçš„å­—èŠ‚å¤§å°</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> sz;</span><br><span class="line">  <span class="comment">//å½“å‰èŠ‚ç‚¹çš„ZipListçš„entryä¸ªæ•° </span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> count : <span class="number">16</span>;</span><br><span class="line">  <span class="comment">//ç¼–ç æ–¹å¼ï¼š1ï¼Œ Ziplist; 2ï¼Œlzfå‹ç¼©æ¨¡å¼ </span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> encoding : <span class="number">2</span>;</span><br><span class="line">  <span class="comment">//æ•°æ®å®¹å™¨ç±»å‹ï¼ˆé¢„ç•™ï¼‰ï¼š1ï¼Œå…¶å®ƒï¼›2, ZipList</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> container : <span class="number">2</span>;</span><br><span class="line">  <span class="comment">//æ˜¯å¦è¢«è§£å‹ç¼©ã€‚1ï¼šåˆ™è¯´æ˜è¢«è§£å‹äº†ï¼Œå°†æ¥è¦é‡æ–°å‹ç¼©</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> recompress : <span class="number">1</span>;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> attempted compress : <span class="number">1</span>;<span class="comment">//æµ‹è¯•ç”¨</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> extra:<span class="number">10</span>;<span class="comment">/*é¢„ç•™å­—æ®µ*/</span> </span><br><span class="line">&#125; quicklistNode;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <p>æˆ‘ä»¬æ¥ä¸‹æ¥ç”¨ä¸€æ®µæµç¨‹å›¾æ¥æè¿°å½“å‰çš„è¿™ä¸ªç»“æ„</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653986718554.png" alt="1653986718554"></p><mark class="hl-label blue">æ€»ç»“</mark> <p>QuickListçš„ç‰¹ç‚¹ï¼š</p><ul><li>æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ä¸ºZipListçš„åŒç«¯é“¾è¡¨</li><li>èŠ‚ç‚¹é‡‡ç”¨ZipListï¼Œè§£å†³äº†ä¼ ç»Ÿé“¾è¡¨çš„å†…å­˜å ç”¨é—®é¢˜</li><li>æ§åˆ¶äº†ZipListå¤§å°ï¼Œè§£å†³è¿ç»­å†…å­˜ç©ºé—´ç”³è¯·æ•ˆç‡é—®é¢˜</li><li>ä¸­é—´èŠ‚ç‚¹å¯ä»¥å‹ç¼©ï¼Œè¿›ä¸€æ­¥èŠ‚çœäº†å†…å­˜</li></ul><hr><h3 id="SkipList">SkipList</h3><p>SkipListï¼ˆè·³è¡¨ï¼‰é¦–å…ˆæ˜¯é“¾è¡¨ï¼Œä½†ä¸ä¼ ç»Ÿé“¾è¡¨ç›¸æ¯”æœ‰å‡ ç‚¹å·®å¼‚ï¼š<br>å…ƒç´ æŒ‰ç…§å‡åºæ’åˆ—å­˜å‚¨<br>èŠ‚ç‚¹å¯èƒ½åŒ…å«å¤šä¸ªæŒ‡é’ˆï¼ŒæŒ‡é’ˆè·¨åº¦ä¸åŒã€‚</p><p>ä½œä¸ºä¸€ä¸ªé“¾è¡¨ï¼Œæˆ‘ä»¬å»è®¿é—®é¦–æˆ–å°¾çš„å…ƒç´ çš„æ—¶å€™ï¼Œæ€§èƒ½è¿˜æ˜¯ä¸é”™çš„ï¼Œä½†æ˜¯å‘¢ï¼Œç°åœ¨è¦å»è®¿é—®é˜Ÿåˆ—ä¸­é—´çš„å…ƒç´ ï¼Œæ¯”æ–¹è¯´11ï¼Œé‚£è¿™ä¸ªæ—¶å€™å•Šä½ å»æŸ¥è¯¢çš„æ€§èƒ½å°±æ¯”è¾ƒå·®äº†ï¼Œä½ ä¸å¾—ä¸ä¸€ä¸ªä¸€ä¸ªçš„å»éå†ã€‚ç°åœ¨è¿™ä¸ªé“¾è¡¨é•¿åº¦è¿˜æ¯”è¾ƒçŸ­ï¼Œåªæœ‰20ï¼Œé‚£å¦‚æœè¯´ç°åœ¨è¿™ä¸ªåˆ—è¡¨é‡Œé¢è¾¾åˆ°äº†ä¸Šåƒç”šè‡³æ•°ä¸‡ä¸ªå…ƒç´ ï¼Œè¦å»è®¿é—®ä¸­é—´å…ƒç´ çš„æ—¶å€™ï¼Œè¦éå†çš„æ¬¡æ•°æ˜¯ä¸æ˜¯å¯ä»¥è¾¾åˆ°æ•°åƒç”šè‡³ä¸Šä¸‡æ¬¡ã€‚</p><p>ä¸ºä»€ä¹ˆé“¾è¡¨æŸ¥è¯¢æ•ˆç‡æ…¢ï¼Ÿå°±æ˜¯å› ä¸ºé“¾è¡¨å®ƒçš„æŒ‡é’ˆè·¨åº¦æ˜¯ä¸€ã€‚æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå®ƒçš„æŒ‡é’ˆæ°¸è¿œæŒ‡å‘çš„æ˜¯ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653986771309.png" alt="1653986771309"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// t_zset.c</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplist</span> &#123;</span></span><br><span class="line">Â  Â  <span class="comment">// å¤´å°¾èŠ‚ç‚¹æŒ‡é’ˆ</span></span><br><span class="line">Â  Â  <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">header</span>, *<span class="title">tail</span>;</span></span><br><span class="line">Â  Â  <span class="comment">// èŠ‚ç‚¹æ•°é‡</span></span><br><span class="line">Â  Â  <span class="type">unsigned</span> <span class="type">long</span> length;</span><br><span class="line">Â  Â  <span class="comment">// æœ€å¤§çš„ç´¢å¼•å±‚çº§ï¼Œé»˜è®¤æ˜¯1</span></span><br><span class="line">Â  Â  <span class="type">int</span> level;</span><br><span class="line">&#125; zskiplist;</span><br><span class="line"><span class="comment">// t_zset.c</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> &#123;</span></span><br><span class="line">Â  Â  sds ele; <span class="comment">// èŠ‚ç‚¹å­˜å‚¨çš„å€¼</span></span><br><span class="line">Â  Â  <span class="type">double</span> score;<span class="comment">// èŠ‚ç‚¹åˆ†æ•°ï¼Œæ’åºã€æŸ¥æ‰¾ç”¨</span></span><br><span class="line">Â  Â  <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">backward</span>;</span> <span class="comment">// å‰ä¸€ä¸ªèŠ‚ç‚¹æŒ‡é’ˆ</span></span><br><span class="line">Â  Â  <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistLevel</span> &#123;</span></span><br><span class="line">Â  Â  Â  Â  <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">forward</span>;</span> <span class="comment">// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æŒ‡é’ˆ</span></span><br><span class="line">Â  Â  Â  Â  <span class="type">unsigned</span> <span class="type">long</span> span; <span class="comment">// ç´¢å¼•è·¨åº¦</span></span><br><span class="line">Â  Â  &#125; level[]; <span class="comment">// å¤šçº§ç´¢å¼•æ•°ç»„</span></span><br><span class="line">&#125; zskiplistNode;</span><br></pre></td></tr></table></figure><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230616095141891.png" alt="image-20230616095141891"></p><p>SkipListï¼ˆè·³è¡¨ï¼‰é¦–å…ˆæ˜¯é“¾è¡¨ï¼Œä½†ä¸ä¼ ç»Ÿé“¾è¡¨ç›¸æ¯”æœ‰å‡ ç‚¹å·®å¼‚ï¼š<br>å…ƒç´ æŒ‰ç…§å‡åºæ’åˆ—å­˜å‚¨<br>èŠ‚ç‚¹å¯èƒ½åŒ…å«å¤šä¸ªæŒ‡é’ˆï¼ŒæŒ‡é’ˆè·¨åº¦ä¸åŒã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653986877620.png" alt="1653986877620"></p><mark class="hl-label blue">å°æ€»ç»“</mark> <p>SkipListçš„ç‰¹ç‚¹ï¼š</p><ul><li>è·³è·ƒè¡¨æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«scoreå’Œeleå€¼</li><li>èŠ‚ç‚¹æŒ‰ç…§scoreå€¼æ’åºï¼Œscoreå€¼ä¸€æ ·åˆ™æŒ‰ç…§eleå­—å…¸æ’åº</li><li>æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥åŒ…å«å¤šå±‚æŒ‡é’ˆï¼Œå±‚æ•°æ˜¯1åˆ°32ä¹‹é—´çš„éšæœºæ•°</li><li>ä¸åŒå±‚æŒ‡é’ˆåˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„è·¨åº¦ä¸åŒï¼Œå±‚çº§è¶Šé«˜ï¼Œè·¨åº¦è¶Šå¤§</li><li>å¢åˆ æ”¹æŸ¥æ•ˆç‡ä¸çº¢é»‘æ ‘åŸºæœ¬ä¸€è‡´ï¼Œå®ç°å´æ›´ç®€å•</li></ul><hr><h3 id="RedisObject">RedisObject</h3><p>Redisä¸­çš„ä»»æ„æ•°æ®ç±»å‹çš„é”®å’Œå€¼éƒ½ä¼šè¢«å°è£…ä¸ºä¸€ä¸ªRedisObjectï¼Œä¹Ÿå«åšRediså¯¹è±¡ï¼Œæºç å¦‚ä¸‹ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653986956618.png" alt="1653986956618"></p><p>ä»Redisçš„ä½¿ç”¨è€…çš„è§’åº¦æ¥çœ‹ï¼Œâ¼€ä¸ªRedisèŠ‚ç‚¹åŒ…å«å¤šä¸ªdatabaseï¼ˆéclusteræ¨¡å¼ä¸‹é»˜è®¤æ˜¯16ä¸ªï¼Œclusteræ¨¡å¼ä¸‹åªèƒ½æ˜¯1ä¸ªï¼‰ï¼Œè€Œä¸€ä¸ªdatabaseç»´æŠ¤äº†ä»key spaceåˆ°object spaceçš„æ˜ å°„å…³ç³»ã€‚è¿™ä¸ªæ˜ å°„å…³ç³»çš„keyæ˜¯stringç±»å‹ï¼Œâ½½valueå¯ä»¥æ˜¯å¤šç§æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚ï¼š<br>string, list, hashã€setã€sorted setç­‰ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œkeyçš„ç±»å‹å›ºå®šæ˜¯stringï¼Œè€Œvalueå¯èƒ½çš„ç±»å‹æ˜¯å¤šä¸ªã€‚<br>â½½ä»Rediså†…éƒ¨å®ç°çš„â¾“åº¦æ¥çœ‹ï¼Œdatabaseå†…çš„è¿™ä¸ªæ˜ å°„å…³ç³»æ˜¯ç”¨â¼€ä¸ªdictæ¥ç»´æŠ¤çš„ã€‚dictçš„keyå›ºå®šç”¨â¼€ç§æ•°æ®ç»“æ„æ¥è¡¨è¾¾å°±å¤Ÿäº†ï¼Œè¿™å°±æ˜¯åŠ¨æ€å­—ç¬¦ä¸²sdsã€‚è€Œvalueåˆ™æ¯”è¾ƒå¤æ‚ï¼Œä¸ºäº†åœ¨åŒâ¼€ä¸ªdictå†…èƒ½å¤Ÿå­˜å‚¨ä¸åŒç±»å‹çš„valueï¼Œè¿™å°±éœ€è¦â¼€ä¸ªé€šâ½¤çš„æ•°æ®ç»“æ„ï¼Œè¿™ä¸ªé€šç”¨çš„æ•°æ®ç»“æ„å°±æ˜¯robjï¼Œå…¨åæ˜¯redisObjectã€‚</p><p>Redisçš„ç¼–ç æ–¹å¼</p><p>Redisä¸­ä¼šæ ¹æ®å­˜å‚¨çš„æ•°æ®ç±»å‹ä¸åŒï¼Œé€‰æ‹©ä¸åŒçš„ç¼–ç æ–¹å¼ï¼Œå…±åŒ…å«11ç§ä¸åŒç±»å‹ï¼š</p><p>Redisçš„ç¼–ç æ–¹å¼</p><p>Redisä¸­ä¼šæ ¹æ®å­˜å‚¨çš„æ•°æ®ç±»å‹ä¸åŒï¼Œé€‰æ‹©ä¸åŒçš„ç¼–ç æ–¹å¼ï¼Œå…±åŒ…å«11ç§ä¸åŒç±»å‹ï¼š</p><table><thead><tr><th><strong>ç¼–å·</strong></th><th><strong>ç¼–ç æ–¹å¼</strong></th><th><strong>è¯´æ˜</strong></th></tr></thead><tbody><tr><td>0</td><td>OBJ_ENCODING_RAW</td><td>rawç¼–ç åŠ¨æ€å­—ç¬¦ä¸²</td></tr><tr><td>1</td><td>OBJ_ENCODING_INT</td><td>longç±»å‹çš„æ•´æ•°çš„å­—ç¬¦ä¸²</td></tr><tr><td>2</td><td>OBJ_ENCODING_HT</td><td>hashè¡¨ï¼ˆå­—å…¸dictï¼‰</td></tr><tr><td>3</td><td>OBJ_ENCODING_ZIPMAP</td><td>å·²åºŸå¼ƒ</td></tr><tr><td>4</td><td>OBJ_ENCODING_LINKEDLIST</td><td>åŒç«¯é“¾è¡¨</td></tr><tr><td>5</td><td>OBJ_ENCODING_ZIPLIST</td><td>å‹ç¼©åˆ—è¡¨</td></tr><tr><td>6</td><td>OBJ_ENCODING_INTSET</td><td>æ•´æ•°é›†åˆ</td></tr><tr><td>7</td><td>OBJ_ENCODING_SKIPLIST</td><td>è·³è¡¨</td></tr><tr><td>8</td><td>OBJ_ENCODING_EMBSTR</td><td>embstrçš„åŠ¨æ€å­—ç¬¦ä¸²</td></tr><tr><td>9</td><td>OBJ_ENCODING_QUICKLIST</td><td>å¿«é€Ÿåˆ—è¡¨</td></tr><tr><td>10</td><td>OBJ_ENCODING_STREAM</td><td>Streamæµ</td></tr></tbody></table><p>äº”ç§æ•°æ®ç»“æ„</p><p>Redisä¸­ä¼šæ ¹æ®å­˜å‚¨çš„æ•°æ®ç±»å‹ä¸åŒï¼Œé€‰æ‹©ä¸åŒçš„ç¼–ç æ–¹å¼ã€‚æ¯ç§æ•°æ®ç±»å‹çš„ä½¿ç”¨çš„ç¼–ç æ–¹å¼å¦‚ä¸‹ï¼š</p><table><thead><tr><th><strong>æ•°æ®ç±»å‹</strong></th><th><strong>ç¼–ç æ–¹å¼</strong></th></tr></thead><tbody><tr><td>OBJ_STRING</td><td>intã€embstrã€raw</td></tr><tr><td>OBJ_LIST</td><td>LinkedListå’ŒZipList(3.2ä»¥å‰)ã€QuickListï¼ˆ3.2ä»¥åï¼‰</td></tr><tr><td>OBJ_SET</td><td>intsetã€HT</td></tr><tr><td>OBJ_ZSET</td><td>ZipListã€HTã€SkipList</td></tr><tr><td>OBJ_HASH</td><td>ZipListã€HT</td></tr></tbody></table><hr><hr><h2 id="äº”ç§æ•°æ®ç±»å‹">äº”ç§æ•°æ®ç±»å‹</h2><h3 id="String">String</h3><p>Stringæ˜¯Redisä¸­æœ€å¸¸è§çš„æ•°æ®å­˜å‚¨ç±»å‹ï¼š</p><div class="tabs" id="8cde4759-907e-4ac2-862a-e7b98a34c3c1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#8cde4759-907e-4ac2-862a-e7b98a34c3c1-1"><i class="fas fa-seedling"></i>RAW</button></li><li class="tab"><button type="button" data-href="#8cde4759-907e-4ac2-862a-e7b98a34c3c1-2"><i class="fas fa-leaf"></i>EMBSTR</button></li><li class="tab"><button type="button" data-href="#8cde4759-907e-4ac2-862a-e7b98a34c3c1-3"><i class="fab fa-apple"></i>INT</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="8cde4759-907e-4ac2-862a-e7b98a34c3c1-1"><p>å…¶åŸºæœ¬ç¼–ç æ–¹å¼æ˜¯RAWï¼ŒåŸºäºç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰å®ç°ï¼Œå­˜å‚¨ä¸Šé™ä¸º512mbã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653987103450.png" alt="1653987103450"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8cde4759-907e-4ac2-862a-e7b98a34c3c1-2"><p>å¦‚æœå­˜å‚¨çš„SDSé•¿åº¦å°äº44å­—èŠ‚ï¼Œåˆ™ä¼šé‡‡ç”¨EMBSTRç¼–ç ï¼Œæ­¤æ—¶RedisObjectä¸SDSæ˜¯ä¸€æ®µè¿ç»­ç©ºé—´ã€‚ç”³è¯·å†…å­˜æ—¶åªéœ€è¦è°ƒç”¨ä¸€æ¬¡å†…å­˜åˆ†é…å‡½æ•°ï¼Œæ•ˆç‡æ›´é«˜ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230616153706417.png" alt="image-20230616153706417"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8cde4759-907e-4ac2-862a-e7b98a34c3c1-3"><p>å¦‚æœå­˜å‚¨çš„å­—ç¬¦ä¸²æ˜¯æ•´æ•°å€¼ï¼Œå¹¶ä¸”å¤§å°åœ¨LONG_MAXèŒƒå›´å†…ï¼Œåˆ™ä¼šé‡‡ç”¨INTç¼–ç ï¼šç›´æ¥å°†æ•°æ®ä¿å­˜åœ¨RedisObjectçš„ptræŒ‡é’ˆä½ç½®ï¼ˆåˆšå¥½8å­—èŠ‚ï¼‰ï¼Œä¸å†éœ€è¦SDSäº†ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230616154241077.png" alt="image-20230616154241077"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><mark class="hl-label blue">æµ‹è¯•</mark> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> name jack</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; object encoding name</span><br><span class="line"><span class="string">&quot;embstr&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> name aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; strlen name</span><br><span class="line">(<span class="built_in">integer</span>) 44</span><br><span class="line">127.0.0.1:6379&gt; object encoding name</span><br><span class="line"><span class="string">&quot;embstr&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> name aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; strlen name</span><br><span class="line">(<span class="built_in">integer</span>) 45</span><br><span class="line">127.0.0.1:6379&gt; object encoding name</span><br><span class="line"><span class="string">&quot;raw&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> age 123</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; object encoding age</span><br><span class="line"><span class="string">&quot;int&quot;</span></span><br></pre></td></tr></table></figure><hr><h3 id="List">List</h3><p>Redisçš„Listç±»å‹å¯ä»¥ä»é¦–ã€å°¾æ“ä½œåˆ—è¡¨ä¸­çš„å…ƒç´ </p><p>å“ªä¸€ä¸ªæ•°æ®ç»“æ„èƒ½æ»¡è¶³ä¸Šè¿°ç‰¹å¾ï¼Ÿ</p><ul><li>LinkedList ï¼šæ™®é€šé“¾è¡¨ï¼Œå¯ä»¥ä»åŒç«¯è®¿é—®ï¼Œå†…å­˜å ç”¨è¾ƒé«˜ï¼Œå†…å­˜ç¢ç‰‡è¾ƒå¤š</li><li>ZipList ï¼šå‹ç¼©åˆ—è¡¨ï¼Œå¯ä»¥ä»åŒç«¯è®¿é—®ï¼Œå†…å­˜å ç”¨ä½ï¼Œå­˜å‚¨ä¸Šé™ä½</li><li>QuickListï¼šLinkedList + ZipListï¼Œå¯ä»¥ä»åŒç«¯è®¿é—®ï¼Œå†…å­˜å ç”¨è¾ƒä½ï¼ŒåŒ…å«å¤šä¸ªZipListï¼Œå­˜å‚¨ä¸Šé™é«˜</li></ul><p>Redisçš„Listç»“æ„ç±»ä¼¼ä¸€ä¸ªåŒç«¯é“¾è¡¨ï¼Œå¯ä»¥ä»é¦–ã€å°¾æ“ä½œåˆ—è¡¨ä¸­çš„å…ƒç´ ï¼š</p><p>åœ¨3.2ç‰ˆæœ¬ä¹‹å‰ï¼ŒRedisé‡‡ç”¨ZipListå’ŒLinkedListæ¥å®ç°Listï¼Œå½“å…ƒç´ æ•°é‡å°äº512å¹¶ä¸”å…ƒç´ å¤§å°å°äº64å­—èŠ‚æ—¶é‡‡ç”¨ZipListç¼–ç ï¼Œè¶…è¿‡åˆ™é‡‡ç”¨LinkedListç¼–ç ã€‚</p><p>åœ¨3.2ç‰ˆæœ¬ä¹‹åï¼ŒRedisç»Ÿä¸€é‡‡ç”¨QuickListæ¥å®ç°Listã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653987313461.png" alt="1653987313461"></p><hr><h3 id="Set">Set</h3><p>Setæ˜¯Redisä¸­çš„å•åˆ—é›†åˆï¼Œæ»¡è¶³ä¸‹åˆ—ç‰¹ç‚¹ï¼š</p><ul><li>ä¸ä¿è¯æœ‰åºæ€§</li><li>ä¿è¯å…ƒç´ å”¯ä¸€</li><li>æ±‚äº¤é›†ã€å¹¶é›†ã€å·®é›†</li></ul><p>å¯ä»¥çœ‹å‡ºï¼ŒSetå¯¹æŸ¥è¯¢å…ƒç´ çš„æ•ˆç‡è¦æ±‚éå¸¸é«˜ï¼Œæ€è€ƒä¸€ä¸‹ï¼Œä»€ä¹ˆæ ·çš„æ•°æ®ç»“æ„å¯ä»¥æ»¡è¶³ï¼Ÿ</p><p>ä¸ºäº†æŸ¥è¯¢æ•ˆç‡å’Œå”¯ä¸€æ€§ï¼Œseté‡‡ç”¨HTç¼–ç ï¼ˆDictï¼‰ã€‚Dictä¸­çš„keyç”¨æ¥å­˜å‚¨å…ƒç´ ï¼Œvalueç»Ÿä¸€ä¸ºnull</p><p>å½“å­˜å‚¨çš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯æ•´æ•°ï¼Œå¹¶ä¸”å…ƒç´ æ•°é‡ä¸è¶…è¿‡set-max-intset-entriesæ—¶ï¼ŒSetä¼šé‡‡ç”¨IntSetç¼–ç ï¼Œä»¥èŠ‚çœå†…å­˜</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230616160631352.png" alt="image-20230616160631352"></p><p>æ³¨æ„ï¼šå½“æ’å…¥çš„æ•°æ®ä¸æ˜¯æ•´æ•°ï¼ŒIntSetå°±ä¼šè½¬æ¢æˆDictã€‚</p><hr><h3 id="ZSET">ZSET</h3><p>ZSetä¹Ÿå°±æ˜¯SortedSetï¼Œå…¶ä¸­æ¯ä¸€ä¸ªå…ƒç´ éƒ½éœ€è¦æŒ‡å®šä¸€ä¸ªscoreå€¼å’Œmemberå€¼ï¼š</p><ul><li>å¯ä»¥æ ¹æ®scoreå€¼æ’åºå</li><li>memberå¿…é¡»å”¯ä¸€</li><li>å¯ä»¥æ ¹æ®memberæŸ¥è¯¢åˆ†æ•°</li></ul><p>å› æ­¤ï¼Œzsetåº•å±‚æ•°æ®ç»“æ„å¿…é¡»æ»¡è¶³é”®å€¼å­˜å‚¨ã€é”®å¿…é¡»å”¯ä¸€ã€å¯æ’åºè¿™å‡ ä¸ªéœ€æ±‚ã€‚ä¹‹å‰å­¦ä¹ çš„å“ªç§ç¼–ç ç»“æ„å¯ä»¥æ»¡è¶³ï¼Ÿ</p><ul><li>SkipListï¼šå¯ä»¥æ’åºï¼Œå¹¶ä¸”å¯ä»¥åŒæ—¶å­˜å‚¨scoreå’Œeleå€¼ï¼ˆmemberï¼‰</li><li>HTï¼ˆDictï¼‰ï¼šå¯ä»¥é”®å€¼å­˜å‚¨ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®keyæ‰¾value</li></ul><div class="tabs" id="87d68fcd-a4ee-4ec3-8596-98d5831447c8"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#87d68fcd-a4ee-4ec3-8596-98d5831447c8-1"><i class="fas fa-seedling"></i>Zsetç»“æ„</button></li><li class="tab"><button type="button" data-href="#87d68fcd-a4ee-4ec3-8596-98d5831447c8-2"><i class="fas fa-leaf"></i>createZsetObject</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="87d68fcd-a4ee-4ec3-8596-98d5831447c8-1"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zset</span> &#123;</span></span><br><span class="line">    <span class="comment">// DictæŒ‡é’ˆ</span></span><br><span class="line">Â  Â  dict *dict;</span><br><span class="line">    <span class="comment">// SkipListæŒ‡é’ˆ</span></span><br><span class="line">Â  Â  zskiplist *zsl;</span><br><span class="line">&#125; zset;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="87d68fcd-a4ee-4ec3-8596-98d5831447c8-2"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">robj *<span class="title function_">createZsetObject</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">Â  Â  zset *zs = zmalloc(<span class="keyword">sizeof</span>(*zs));</span><br><span class="line">Â  Â  robj *o;</span><br><span class="line">Â  Â  <span class="comment">// åˆ›å»ºDict</span></span><br><span class="line">Â  Â  zs-&gt;dict = dictCreate(&amp;zsetDictType,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// åˆ›å»ºSkipList</span></span><br><span class="line">Â  Â  zs-&gt;zsl = zslCreate(); </span><br><span class="line">Â  Â  o = createObject(OBJ_ZSET,zs);</span><br><span class="line">Â  Â  o-&gt;encoding = OBJ_ENCODING_SKIPLIST;</span><br><span class="line">Â  Â  <span class="keyword">return</span> o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653992172526.png" alt="1653992172526"></p><p>å½“å…ƒç´ æ•°é‡ä¸å¤šæ—¶ï¼ŒHTå’ŒSkipListçš„ä¼˜åŠ¿ä¸æ˜æ˜¾ï¼Œè€Œä¸”æ›´è€—å†…å­˜ã€‚å› æ­¤zsetè¿˜ä¼šé‡‡ç”¨ZipListç»“æ„æ¥èŠ‚çœå†…å­˜ï¼Œä¸è¿‡éœ€è¦åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ul><li>å…ƒç´ æ•°é‡å°äºzset_max_ziplist_entriesï¼Œé»˜è®¤å€¼128</li><li>æ¯ä¸ªå…ƒç´ éƒ½å°äºzset_max_ziplist_valueå­—èŠ‚ï¼Œé»˜è®¤å€¼64</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// zaddæ·»åŠ å…ƒç´ æ—¶ï¼Œå…ˆæ ¹æ®keyæ‰¾åˆ°zsetï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°çš„zset</span></span><br><span class="line">zobj = lookupKeyWrite(c-&gt;db,key);</span><br><span class="line"><span class="keyword">if</span> (checkType(c,zobj,OBJ_ZSET)) <span class="keyword">goto</span> cleanup;</span><br><span class="line"><span class="comment">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="keyword">if</span> (zobj == <span class="literal">NULL</span>) &#123; <span class="comment">// zsetä¸å­˜åœ¨</span></span><br><span class="line">Â  Â  <span class="keyword">if</span> (server.zset_max_ziplist_entries == <span class="number">0</span> ||</span><br><span class="line">Â  Â  Â  Â  server.zset_max_ziplist_value &lt; sdslen(c-&gt;argv[scoreidx+<span class="number">1</span>]-&gt;ptr))</span><br><span class="line">Â  Â  &#123; <span class="comment">// zset_max_ziplist_entriesè®¾ç½®ä¸º0å°±æ˜¯ç¦ç”¨äº†ZipListï¼Œ</span></span><br><span class="line">Â  Â  Â  Â  <span class="comment">// æˆ–è€…valueå¤§å°è¶…è¿‡äº†zset_max_ziplist_valueï¼Œé‡‡ç”¨HT + SkipList</span></span><br><span class="line">Â  Â  Â  Â  zobj = createZsetObject();</span><br><span class="line">Â  Â  &#125; <span class="keyword">else</span> &#123; <span class="comment">// å¦åˆ™ï¼Œé‡‡ç”¨ ZipList</span></span><br><span class="line">Â  Â  Â  Â  zobj = createZsetZiplistObject();</span><br><span class="line">Â  Â  &#125;</span><br><span class="line">Â  Â  dbAdd(c-&gt;db,key,zobj); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ziplistæœ¬èº«æ²¡æœ‰æ’åºåŠŸèƒ½ï¼Œè€Œä¸”æ²¡æœ‰é”®å€¼å¯¹çš„æ¦‚å¿µï¼Œå› æ­¤éœ€è¦æœ‰zseté€šè¿‡ç¼–ç å®ç°ï¼š</p><ul><li>ZipListæ˜¯è¿ç»­å†…å­˜ï¼Œå› æ­¤scoreå’Œelementæ˜¯ç´§æŒ¨åœ¨ä¸€èµ·çš„ä¸¤ä¸ªentryï¼Œ elementåœ¨å‰ï¼Œscoreåœ¨å</li><li>scoreè¶Šå°è¶Šæ¥è¿‘é˜Ÿé¦–ï¼Œscoreè¶Šå¤§è¶Šæ¥è¿‘é˜Ÿå°¾ï¼ŒæŒ‰ç…§scoreå€¼å‡åºæ’åˆ—</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230616165412835.png" alt="image-20230616165412835"></p><hr><h3 id="Hash">Hash</h3><p>Hashç»“æ„ä¸Redisä¸­çš„Zsetéå¸¸ç±»ä¼¼ï¼š</p><ul><li>éƒ½æ˜¯é”®å€¼å­˜å‚¨</li><li>éƒ½éœ€æ±‚æ ¹æ®é”®è·å–å€¼</li><li>é”®å¿…é¡»å”¯ä¸€</li></ul><p>åŒºåˆ«å¦‚ä¸‹ï¼š</p><ul><li>zsetçš„é”®æ˜¯memberï¼Œå€¼æ˜¯scoreï¼›hashçš„é”®å’Œå€¼éƒ½æ˜¯ä»»æ„å€¼</li><li>zsetè¦æ ¹æ®scoreæ’åºï¼›hashåˆ™æ— éœ€æ’åº</li></ul><p>å› æ­¤ï¼ŒHashåº•å±‚é‡‡ç”¨çš„ç¼–ç ä¸Zsetä¹ŸåŸºæœ¬ä¸€è‡´ï¼Œåªéœ€è¦æŠŠæ’åºæœ‰å…³çš„SkipListå»æ‰å³å¯ã€‚</p><p>Hashç»“æ„é»˜è®¤é‡‡ç”¨ZipListç¼–ç ï¼Œç”¨ä»¥èŠ‚çœå†…å­˜ã€‚</p><p>ZipListä¸­ç›¸é‚»çš„ä¸¤ä¸ªentry åˆ†åˆ«ä¿å­˜fieldå’Œvalueå½“æ•°æ®é‡è¾ƒå¤§æ—¶ï¼ŒHashç»“æ„ä¼šè½¬ä¸ºHTç¼–ç ï¼Œä¹Ÿå°±æ˜¯Dictï¼Œ</p><p>è§¦å‘æ¡ä»¶æœ‰ä¸¤ä¸ªï¼š</p><p>ZipListä¸­çš„å…ƒç´ æ•°é‡è¶…è¿‡äº†hash-max-ziplist-entriesï¼ˆé»˜è®¤512ï¼‰</p><p>ZipListä¸­çš„ä»»æ„entryå¤§å°è¶…è¿‡äº†hash-max-ziplist-valueï¼ˆé»˜è®¤64å­—èŠ‚ï¼‰</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230616170044461.png" alt="image-20230616170044461"></p><p>è½¬æ¢</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230616170222695.png" alt="image-20230616170222695"></p><p>æ€»ä¹‹ï¼Œziplistæœ¬æ¥å°±è®¾è®¡ä¸ºå„ä¸ªæ•°æ®é¡¹æŒ¨åœ¨â¼€èµ·ç»„æˆè¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œè¿™ç§ç»“æ„å¹¶ä¸æ“…é•¿åšä¿®æ”¹æ“ä½œã€‚â¼€æ—¦æ•°æ®å‘â½£æ”¹åŠ¨ï¼Œå°±ä¼šå¼•å‘å†…å­˜reallocï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ‹·è´ã€‚</p><hr><hr><h2 id="ç½‘ç»œæ¨¡å‹">ç½‘ç»œæ¨¡å‹</h2><h3 id="ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸æ€ç©ºé—´">ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸æ€ç©ºé—´</h3><p>æœåŠ¡å™¨å¤§å¤šéƒ½é‡‡ç”¨Linuxç³»ç»Ÿï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥Linuxä¸ºä¾‹æ¥è®²è§£:</p><p>ubuntuå’ŒCentos éƒ½æ˜¯Linuxçš„å‘è¡Œç‰ˆï¼Œå‘è¡Œç‰ˆå¯ä»¥çœ‹æˆå¯¹linuxåŒ…äº†ä¸€å±‚å£³ï¼Œä»»ä½•Linuxå‘è¡Œç‰ˆï¼Œå…¶ç³»ç»Ÿå†…æ ¸éƒ½æ˜¯Linuxã€‚æˆ‘ä»¬çš„åº”ç”¨éƒ½éœ€è¦é€šè¿‡Linuxå†…æ ¸ä¸ç¡¬ä»¶äº¤äº’ã€‚</p><p>è®¡ç®—æœºç¡¬ä»¶åŒ…æ‹¬ï¼Œå¦‚cpuï¼Œå†…å­˜ï¼Œç½‘å¡ç­‰ç­‰ï¼Œå†…æ ¸ï¼ˆé€šè¿‡å¯»å€ç©ºé—´ï¼‰å¯ä»¥æ“ä½œç¡¬ä»¶çš„ï¼Œä½†æ˜¯å†…æ ¸éœ€è¦ä¸åŒè®¾å¤‡çš„é©±åŠ¨ï¼Œæœ‰äº†è¿™äº›é©±åŠ¨ä¹‹åï¼Œå†…æ ¸å°±å¯ä»¥å»å¯¹è®¡ç®—æœºç¡¬ä»¶å»è¿›è¡Œ å†…å­˜ç®¡ç†ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„ç®¡ç†ï¼Œè¿›ç¨‹çš„ç®¡ç†ç­‰ç­‰ã€‚</p><p>æˆ‘ä»¬æƒ³è¦ç”¨æˆ·çš„åº”ç”¨æ¥è®¿é—®ï¼Œè®¡ç®—æœºå°±å¿…é¡»è¦é€šè¿‡å¯¹å¤–æš´éœ²çš„ä¸€äº›æ¥å£ï¼Œæ‰èƒ½è®¿é—®åˆ°ï¼Œä»è€Œç®€ä»‹çš„å®ç°å¯¹å†…æ ¸çš„æ“æ§ï¼Œä½†æ˜¯å†…æ ¸æœ¬èº«ä¸Šæ¥è¯´ä¹Ÿæ˜¯ä¸€ä¸ªåº”ç”¨ï¼Œæ‰€ä»¥ä»–æœ¬èº«ä¹Ÿéœ€è¦ä¸€äº›å†…å­˜ï¼Œcpuç­‰è®¾å¤‡èµ„æºï¼Œç”¨æˆ·åº”ç”¨æœ¬èº«ä¹Ÿåœ¨æ¶ˆè€—è¿™äº›èµ„æºï¼Œå¦‚æœä¸åŠ ä»»ä½•é™åˆ¶ï¼Œç”¨æˆ·å»æ“ä½œéšæ„çš„å»æ“ä½œæˆ‘ä»¬çš„èµ„æºï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´ä¸€äº›å†²çªï¼Œç”šè‡³æœ‰å¯èƒ½å¯¼è‡´æˆ‘ä»¬çš„ç³»ç»Ÿå‡ºç°æ— æ³•è¿è¡Œçš„é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŠŠç”¨æˆ·å’Œ<strong>å†…æ ¸éš”ç¦»å¼€</strong>ã€‚</p><p>è¿›ç¨‹çš„å¯»å€ç©ºé—´ä¼šåˆ’åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šå†…æ ¸ç©ºé—´ã€ç”¨æˆ·ç©ºé—´</p><p>ç”¨æˆ·ç©ºé—´åªèƒ½æ‰§è¡Œå—é™çš„å‘½ä»¤ï¼ˆRing3ï¼‰ï¼Œè€Œä¸”ä¸èƒ½ç›´æ¥è°ƒç”¨ç³»ç»Ÿèµ„æºï¼Œå¿…é¡»é€šè¿‡å†…æ ¸æä¾›çš„æ¥å£æ¥è®¿é—®</p><p>å†…æ ¸ç©ºé—´å¯ä»¥æ‰§è¡Œç‰¹æƒå‘½ä»¤ï¼ˆRing0ï¼‰ï¼Œè°ƒç”¨ä¸€åˆ‡ç³»ç»Ÿèµ„æº</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230616171453302.png" alt="image-20230616171453302" style="zoom:67%;" /><p>åœ¨linuxä¸­ï¼Œä»–ä»¬æƒé™åˆ†æˆä¸¤ä¸ªç­‰çº§ï¼Œ0å’Œ3ï¼Œç”¨æˆ·ç©ºé—´åªèƒ½æ‰§è¡Œå—é™çš„å‘½ä»¤ï¼ˆRing3ï¼‰ï¼Œè€Œä¸”ä¸èƒ½ç›´æ¥è°ƒç”¨ç³»ç»Ÿèµ„æºï¼Œå¿…é¡»é€šè¿‡å†…æ ¸æä¾›çš„æ¥å£æ¥è®¿é—®å†…æ ¸ç©ºé—´å¯ä»¥æ‰§è¡Œç‰¹æƒå‘½ä»¤ï¼ˆRing0ï¼‰ï¼Œè°ƒç”¨ä¸€åˆ‡ç³»ç»Ÿèµ„æºï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç”¨æˆ·çš„æ“ä½œæ˜¯è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œè€Œå†…æ ¸è¿è¡Œçš„æ•°æ®æ˜¯åœ¨å†…æ ¸ç©ºé—´çš„ï¼Œè€Œæœ‰çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºéœ€è¦å»è°ƒç”¨ä¸€äº›ç‰¹æƒèµ„æºï¼Œå»è°ƒç”¨ä¸€äº›å†…æ ¸ç©ºé—´çš„æ“ä½œï¼Œæ‰€ä»¥æ­¤æ—¶ä»–ä¿©éœ€è¦åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´è¿›è¡Œåˆ‡æ¢ã€‚</p><p>æ¯”å¦‚ï¼š</p><p>Linuxç³»ç»Ÿä¸ºäº†æé«˜IOæ•ˆç‡ï¼Œä¼šåœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´éƒ½åŠ å…¥ç¼“å†²åŒºï¼š</p><p>å†™æ•°æ®æ—¶ï¼Œè¦æŠŠç”¨æˆ·ç¼“å†²æ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œç„¶åå†™å…¥è®¾å¤‡</p><p>è¯»æ•°æ®æ—¶ï¼Œè¦ä»è®¾å¤‡è¯»å–æ•°æ®åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œç„¶åæ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒº</p><p>é’ˆå¯¹è¿™ä¸ªæ“ä½œï¼šæˆ‘ä»¬çš„ç”¨æˆ·åœ¨å†™è¯»æ•°æ®æ—¶ï¼Œä¼šå»å‘å†…æ ¸æ€ç”³è¯·ï¼Œæƒ³è¦è¯»å–å†…æ ¸çš„æ•°æ®ï¼Œè€Œå†…æ ¸æ•°æ®è¦å»ç­‰å¾…é©±åŠ¨ç¨‹åºä»ç¡¬ä»¶ä¸Šè¯»å–æ•°æ®ï¼Œå½“ä»ç£ç›˜ä¸ŠåŠ è½½åˆ°æ•°æ®ä¹‹åï¼Œå†…æ ¸ä¼šå°†æ•°æ®å†™å…¥åˆ°å†…æ ¸çš„ç¼“å†²åŒºä¸­ï¼Œç„¶åå†å°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·æ€çš„bufferä¸­ï¼Œç„¶åå†è¿”å›ç»™åº”ç”¨ç¨‹åºï¼Œæ•´ä½“è€Œè¨€ï¼Œé€Ÿåº¦æ…¢ï¼Œå°±æ˜¯è¿™ä¸ªåŸå› ï¼Œä¸ºäº†åŠ é€Ÿï¼Œæˆ‘ä»¬å¸Œæœ›readä¹Ÿå¥½ï¼Œè¿˜æ˜¯wait for dataä¹Ÿæœ€å¥½éƒ½ä¸è¦ç­‰å¾…ï¼Œæˆ–è€…æ—¶é—´å°½é‡çš„çŸ­ã€‚</p><hr><p>åœ¨ã€ŠUNIXç½‘ç»œç¼–ç¨‹ã€‹ä¸€ä¹¦ä¸­ï¼Œæ€»ç»“å½’çº³äº†5ç§IOæ¨¡å‹ï¼š</p><ul><li>é˜»å¡IOï¼ˆBlocking IOï¼‰</li><li>éé˜»å¡IOï¼ˆNonblocking IOï¼‰</li><li>IOå¤šè·¯å¤ç”¨ï¼ˆIO Multiplexingï¼‰</li><li>ä¿¡å·é©±åŠ¨IOï¼ˆSignal Driven IOï¼‰</li><li>å¼‚æ­¥IOï¼ˆAsynchronous IOï¼‰</li></ul><hr><h3 id="é˜»å¡IO">é˜»å¡IO</h3><p>é¡¾åæ€ä¹‰ï¼Œé˜»å¡IOå°±æ˜¯ä¸¤ä¸ªé˜¶æ®µéƒ½å¿…é¡»é˜»å¡ç­‰å¾…ã€‚</p><p>åº”ç”¨ç¨‹åºæƒ³è¦å»è¯»å–æ•°æ®ï¼Œä»–æ˜¯æ— æ³•ç›´æ¥å»è¯»å–ç£ç›˜æ•°æ®çš„ï¼Œä»–éœ€è¦å…ˆåˆ°å†…æ ¸é‡Œè¾¹å»ç­‰å¾…å†…æ ¸æ“ä½œç¡¬ä»¶æ‹¿åˆ°æ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯1ï¼Œæ˜¯éœ€è¦ç­‰å¾…çš„ï¼Œç­‰åˆ°å†…æ ¸ä»ç£ç›˜ä¸ŠæŠŠæ•°æ®åŠ è½½å‡ºæ¥ä¹‹åï¼Œå†æŠŠè¿™ä¸ªæ•°æ®å†™ç»™ç”¨æˆ·çš„ç¼“å­˜åŒºï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯2ï¼Œå¦‚æœæ˜¯é˜»å¡IOï¼Œé‚£ä¹ˆæ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·ä»å‘èµ·è¯»è¯·æ±‚å¼€å§‹ï¼Œä¸€ç›´åˆ°è¯»å–åˆ°æ•°æ®ï¼Œéƒ½æ˜¯ä¸€ä¸ªé˜»å¡çŠ¶æ€ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653897115346.png" alt="1653897115346"></p><mark class="hl-label blue">å…·ä½“æµç¨‹å¦‚ä¸‹</mark> <p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230616172336294.png" alt="image-20230616172336294"></p><hr><h3 id="éé˜»å¡IO">éé˜»å¡IO</h3><p>é¡¾åæ€ä¹‰ï¼Œéé˜»å¡IOçš„recvfromæ“ä½œä¼šç«‹å³è¿”å›ç»“æœè€Œä¸æ˜¯é˜»å¡ç”¨æˆ·è¿›ç¨‹ã€‚</p><p>é˜¶æ®µä¸€ï¼š</p><ul><li>ç”¨æˆ·è¿›ç¨‹å°è¯•è¯»å–æ•°æ®ï¼ˆæ¯”å¦‚ç½‘å¡æ•°æ®ï¼‰</li><li>æ­¤æ—¶æ•°æ®å°šæœªåˆ°è¾¾ï¼Œå†…æ ¸éœ€è¦ç­‰å¾…æ•°æ®</li><li>è¿”å›å¼‚å¸¸ç»™ç”¨æˆ·è¿›ç¨‹</li><li>ç”¨æˆ·è¿›ç¨‹æ‹¿åˆ°erroråï¼Œå†æ¬¡å°è¯•è¯»å–</li><li>å¾ªç¯å¾€å¤ï¼Œç›´åˆ°æ•°æ®å°±ç»ª</li></ul><p>é˜¶æ®µäºŒï¼š</p><ul><li>å°†å†…æ ¸æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒº</li><li>æ‹·è´è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·è¿›ç¨‹ä¾ç„¶é˜»å¡ç­‰å¾…</li><li>æ‹·è´å®Œæˆï¼Œç”¨æˆ·è¿›ç¨‹è§£é™¤é˜»å¡ï¼Œå¤„ç†æ•°æ®</li><li>å¯ä»¥çœ‹åˆ°ï¼Œéé˜»å¡IOæ¨¡å‹ä¸­ï¼Œç”¨æˆ·è¿›ç¨‹åœ¨ç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯éé˜»å¡ï¼Œç¬¬äºŒä¸ªé˜¶æ®µæ˜¯é˜»å¡çŠ¶æ€ã€‚è™½ç„¶æ˜¯éé˜»å¡ï¼Œä½†æ€§èƒ½å¹¶æ²¡æœ‰å¾—åˆ°æé«˜ã€‚è€Œä¸”å¿™ç­‰æœºåˆ¶ä¼šå¯¼è‡´CPUç©ºè½¬ï¼ŒCPUä½¿ç”¨ç‡æš´å¢ã€‚</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653897490116.png" alt="1653897490116"></p><hr><h3 id="IOå¤šè·¯å¤ç”¨">IOå¤šè·¯å¤ç”¨</h3><p>æ— è®ºæ˜¯é˜»å¡IOè¿˜æ˜¯éé˜»å¡IOï¼Œç”¨æˆ·åº”ç”¨åœ¨ä¸€é˜¶æ®µéƒ½éœ€è¦è°ƒç”¨recvfromæ¥è·å–æ•°æ®ï¼Œå·®åˆ«åœ¨äºæ— æ•°æ®æ—¶çš„å¤„ç†æ–¹æ¡ˆï¼š</p><ul><li>å¦‚æœè°ƒç”¨recvfromæ—¶ï¼Œæ°å¥½æ²¡æœ‰æ•°æ®ï¼Œé˜»å¡IOä¼šä½¿CPUé˜»å¡ï¼Œéé˜»å¡IOä½¿CPUç©ºè½¬ï¼Œéƒ½ä¸èƒ½å……åˆ†å‘æŒ¥CPUçš„ä½œç”¨ã€‚</li><li>å¦‚æœè°ƒç”¨recvfromæ—¶ï¼Œæ°å¥½æœ‰æ•°æ®ï¼Œåˆ™ç”¨æˆ·è¿›ç¨‹å¯ä»¥ç›´æ¥è¿›å…¥ç¬¬äºŒé˜¶æ®µï¼Œè¯»å–å¹¶å¤„ç†æ•°æ®</li></ul><p>æ¯”å¦‚æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯Socketè¯·æ±‚æ—¶ï¼Œåœ¨å•çº¿ç¨‹æƒ…å†µä¸‹ï¼Œåªèƒ½ä¾æ¬¡å¤„ç†æ¯ä¸€ä¸ªsocketï¼Œå¦‚æœæ­£åœ¨å¤„ç†çš„socketæ°å¥½æœªå°±ç»ªï¼ˆæ•°æ®ä¸å¯è¯»æˆ–ä¸å¯å†™ï¼‰ï¼Œçº¿ç¨‹å°±ä¼šè¢«é˜»å¡ï¼Œæ‰€æœ‰å…¶å®ƒå®¢æˆ·ç«¯socketéƒ½å¿…é¡»ç­‰å¾…ï¼Œæ€§èƒ½è‡ªç„¶ä¼šå¾ˆå·®ã€‚</p><p>æ‰€ä»¥æ€ä¹ˆçœ‹èµ·æ¥ä»¥ä¸Šä¸¤ç§æ–¹å¼æ€§èƒ½éƒ½ä¸å¥½</p><p>è€Œåœ¨å•çº¿ç¨‹æƒ…å†µä¸‹ï¼Œåªèƒ½ä¾æ¬¡å¤„ç†IOäº‹ä»¶ï¼Œå¦‚æœæ­£åœ¨å¤„ç†çš„IOäº‹ä»¶æ°å¥½æœªå°±ç»ªï¼ˆæ•°æ®ä¸å¯è¯»æˆ–ä¸å¯å†™ï¼‰ï¼Œçº¿ç¨‹å°±ä¼šè¢«é˜»å¡ï¼Œæ‰€æœ‰IOäº‹ä»¶éƒ½å¿…é¡»ç­‰å¾…ï¼Œæ€§èƒ½è‡ªç„¶ä¼šå¾ˆå·®ã€‚</p><p>å°±æ¯”å¦‚æœåŠ¡å‘˜ç»™é¡¾å®¢ç‚¹é¤ï¼Œåˆ†ä¸¤æ­¥ï¼š</p><ul><li>é¡¾å®¢æ€è€ƒè¦åƒä»€ä¹ˆï¼ˆç­‰å¾…æ•°æ®å°±ç»ªï¼‰</li><li>é¡¾å®¢æƒ³å¥½äº†ï¼Œå¼€å§‹ç‚¹é¤ï¼ˆè¯»å–æ•°æ®ï¼‰</li></ul><p>è¦æé«˜æ•ˆç‡æœ‰å‡ ç§åŠæ³•ï¼Ÿ</p><p>æ–¹æ¡ˆä¸€ï¼šå¢åŠ æ›´å¤šæœåŠ¡å‘˜ï¼ˆå¤šçº¿ç¨‹ï¼‰<br>æ–¹æ¡ˆäºŒï¼šä¸æ’é˜Ÿï¼Œè°æƒ³å¥½äº†åƒä»€ä¹ˆï¼ˆæ•°æ®å°±ç»ªäº†ï¼‰ï¼ŒæœåŠ¡å‘˜å°±ç»™è°ç‚¹é¤ï¼ˆç”¨æˆ·åº”ç”¨å°±å»è¯»å–æ•°æ®ï¼‰</p><blockquote><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šç”¨æˆ·è¿›ç¨‹å¦‚ä½•çŸ¥é“å†…æ ¸ä¸­æ•°æ®æ˜¯å¦å°±ç»ªå‘¢ï¼Ÿ</p></blockquote><ul><li>æ–‡ä»¶æè¿°ç¬¦ï¼ˆFile Descriptorï¼‰ï¼šç®€ç§°FDï¼Œæ˜¯ä¸€ä¸ªä»0 å¼€å§‹çš„æ— ç¬¦å·æ•´æ•°ï¼Œç”¨æ¥å…³è”Linuxä¸­çš„ä¸€ä¸ªæ–‡ä»¶ã€‚åœ¨Linuxä¸­ï¼Œä¸€åˆ‡çš†æ–‡ä»¶ï¼Œä¾‹å¦‚å¸¸è§„æ–‡ä»¶ã€è§†é¢‘ã€ç¡¬ä»¶è®¾å¤‡ç­‰ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬ç½‘ç»œå¥—æ¥å­—ï¼ˆSocketï¼‰ã€‚</li><li>IOå¤šè·¯å¤ç”¨ï¼šæ˜¯åˆ©ç”¨å•ä¸ªçº¿ç¨‹æ¥åŒæ—¶ç›‘å¬å¤šä¸ªFDï¼Œå¹¶åœ¨æŸä¸ªFDå¯è¯»ã€å¯å†™æ—¶å¾—åˆ°é€šçŸ¥ï¼Œä»è€Œé¿å…æ— æ•ˆçš„ç­‰å¾…ï¼Œå……åˆ†åˆ©ç”¨CPUèµ„æºã€‚</li></ul><p>é˜¶æ®µä¸€ï¼š</p><ul><li>ç”¨æˆ·è¿›ç¨‹è°ƒç”¨selectï¼ŒæŒ‡å®šè¦ç›‘å¬çš„FDé›†åˆ</li><li>å†…æ ¸ç›‘å¬FDå¯¹åº”çš„å¤šä¸ªsocket</li><li>ä»»æ„ä¸€ä¸ªæˆ–å¤šä¸ªsocketæ•°æ®å°±ç»ªåˆ™è¿”å›readable</li><li>æ­¤è¿‡ç¨‹ä¸­ç”¨æˆ·è¿›ç¨‹é˜»å¡</li></ul><p>é˜¶æ®µäºŒï¼š</p><ul><li>ç”¨æˆ·è¿›ç¨‹æ‰¾åˆ°å°±ç»ªçš„socket</li><li>ä¾æ¬¡è°ƒç”¨recvfromè¯»å–æ•°æ®</li><li>å†…æ ¸å°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´</li><li>ç”¨æˆ·è¿›ç¨‹å¤„ç†æ•°æ®</li></ul><p>å½“ç”¨æˆ·å»è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œä¸å†å»ç›´æ¥è°ƒç”¨recvfromäº†ï¼Œè€Œæ˜¯è°ƒç”¨selectçš„å‡½æ•°ï¼Œselectå‡½æ•°ä¼šå°†éœ€è¦ç›‘å¬çš„æ•°æ®äº¤ç»™å†…æ ¸ï¼Œç”±å†…æ ¸å»æ£€æŸ¥è¿™äº›æ•°æ®æ˜¯å¦å°±ç»ªäº†ï¼Œå¦‚æœè¯´è¿™ä¸ªæ•°æ®å°±ç»ªäº†ï¼Œå°±ä¼šé€šçŸ¥åº”ç”¨ç¨‹åºæ•°æ®å°±ç»ªï¼Œç„¶åæ¥è¯»å–æ•°æ®ï¼Œå†ä»å†…æ ¸ä¸­æŠŠæ•°æ®æ‹·è´ç»™ç”¨æˆ·æ€ï¼Œå®Œæˆæ•°æ®å¤„ç†ï¼Œå¦‚æœNå¤šä¸ªFDä¸€ä¸ªéƒ½æ²¡å¤„ç†å®Œï¼Œæ­¤æ—¶å°±è¿›è¡Œç­‰å¾…ã€‚</p><p>ç”¨IOå¤ç”¨æ¨¡å¼ï¼Œå¯ä»¥ç¡®ä¿å»è¯»æ•°æ®çš„æ—¶å€™ï¼Œæ•°æ®æ˜¯ä¸€å®šå­˜åœ¨çš„ï¼Œä»–çš„æ•ˆç‡æ¯”åŸæ¥çš„é˜»å¡IOå’Œéé˜»å¡IOæ€§èƒ½éƒ½è¦é«˜</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653898691736.png" alt="1653898691736" style="zoom:67%;" /><p>IOå¤šè·¯å¤ç”¨æ˜¯åˆ©ç”¨å•ä¸ªçº¿ç¨‹æ¥åŒæ—¶ç›‘å¬å¤šä¸ªFDï¼Œå¹¶åœ¨æŸä¸ªFDå¯è¯»ã€å¯å†™æ—¶å¾—åˆ°é€šçŸ¥ï¼Œä»è€Œé¿å…æ— æ•ˆçš„ç­‰å¾…ï¼Œå……åˆ†åˆ©ç”¨CPUèµ„æºã€‚ä¸è¿‡ç›‘å¬FDçš„æ–¹å¼ã€é€šçŸ¥çš„æ–¹å¼åˆæœ‰å¤šç§å®ç°ï¼Œå¸¸è§çš„æœ‰ï¼š</p><ul><li>select</li><li>poll</li><li>epoll</li></ul><p>å…¶ä¸­selectå’Œpoolç›¸å½“äºæ˜¯å½“è¢«ç›‘å¬çš„æ•°æ®å‡†å¤‡å¥½ä¹‹åï¼Œä»–ä¼šæŠŠä½ ç›‘å¬çš„FDæ•´ä¸ªæ•°æ®éƒ½å‘ç»™ä½ ï¼Œä½ éœ€è¦åˆ°æ•´ä¸ªFDä¸­å»æ‰¾ï¼Œå“ªäº›æ˜¯å¤„ç†å¥½äº†çš„ï¼Œéœ€è¦é€šè¿‡éå†çš„æ–¹å¼ï¼Œæ‰€ä»¥æ€§èƒ½ä¹Ÿå¹¶ä¸æ˜¯é‚£ä¹ˆå¥½</p><p>è€Œepollï¼Œåˆ™ç›¸å½“äºå†…æ ¸å‡†å¤‡å¥½äº†ä¹‹åï¼Œä»–ä¼šæŠŠå‡†å¤‡å¥½çš„æ•°æ®ï¼Œç›´æ¥å‘ç»™ä½ ï¼Œå’±ä»¬å°±çœå»äº†éå†çš„åŠ¨ä½œã€‚</p><hr><h4 id="select">select</h4><p>selectæ˜¯Linuxæœ€æ—©æ˜¯ç”±çš„I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯ï¼š</p><p>ç®€å•è¯´ï¼Œå°±æ˜¯æˆ‘ä»¬æŠŠéœ€è¦å¤„ç†çš„æ•°æ®å°è£…æˆFDï¼Œç„¶ååœ¨ç”¨æˆ·æ€æ—¶åˆ›å»ºä¸€ä¸ªfdçš„é›†åˆï¼ˆè¿™ä¸ªé›†åˆçš„å¤§å°æ˜¯è¦ç›‘å¬çš„é‚£ä¸ªFDçš„æœ€å¤§å€¼+1ï¼Œä½†æ˜¯å¤§å°æ•´ä½“æ˜¯æœ‰é™åˆ¶çš„ ï¼‰ï¼Œè¿™ä¸ªé›†åˆçš„é•¿åº¦å¤§å°æ˜¯æœ‰é™åˆ¶çš„ï¼ŒåŒæ—¶åœ¨è¿™ä¸ªé›†åˆä¸­ï¼Œæ ‡æ˜å‡ºæ¥æˆ‘ä»¬è¦æ§åˆ¶å“ªäº›æ•°æ®ï¼Œ</p><p>æ¯”å¦‚è¦ç›‘å¬çš„æ•°æ®ï¼Œæ˜¯1,2,5ä¸‰ä¸ªæ•°æ®ï¼Œæ­¤æ—¶ä¼šæ‰§è¡Œselectå‡½æ•°ï¼Œç„¶åå°†æ•´ä¸ªfdå‘ç»™å†…æ ¸æ€ï¼Œå†…æ ¸æ€ä¼šå»éå†ç”¨æˆ·æ€ä¼ é€’è¿‡æ¥çš„æ•°æ®ï¼Œå¦‚æœå‘ç°è¿™é‡Œè¾¹éƒ½æ•°æ®éƒ½æ²¡æœ‰å°±ç»ªï¼Œå°±ä¼‘çœ ï¼Œç›´åˆ°æœ‰æ•°æ®å‡†å¤‡å¥½æ—¶ï¼Œå°±ä¼šè¢«å”¤é†’ï¼Œå”¤é†’ä¹‹åï¼Œå†æ¬¡éå†ä¸€éï¼Œçœ‹çœ‹è°å‡†å¤‡å¥½äº†ï¼Œç„¶åå†å°†å¤„ç†æ‰æ²¡æœ‰å‡†å¤‡å¥½çš„æ•°æ®ï¼Œæœ€åå†å°†è¿™ä¸ªFDé›†åˆå†™å›åˆ°ç”¨æˆ·æ€ä¸­å»ï¼Œæ­¤æ—¶ç”¨æˆ·æ€å°±çŸ¥é“äº†ï¼Œå¥¥ï¼Œæœ‰äººå‡†å¤‡å¥½äº†ï¼Œä½†æ˜¯å¯¹äºç”¨æˆ·æ€è€Œè¨€ï¼Œå¹¶ä¸çŸ¥é“è°å¤„ç†å¥½äº†ï¼Œæ‰€ä»¥ç”¨æˆ·æ€ä¹Ÿéœ€è¦å»è¿›è¡Œéå†ï¼Œç„¶åæ‰¾åˆ°å¯¹åº”å‡†å¤‡å¥½æ•°æ®çš„èŠ‚ç‚¹ï¼Œå†å»å‘èµ·è¯»è¯·æ±‚ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œè¿™ç§æ¨¡å¼ä¸‹ä»–è™½ç„¶æ¯”é˜»å¡IOå’Œéé˜»å¡IOå¥½ï¼Œä½†æ˜¯ä¾ç„¶æœ‰äº›éº»çƒ¦çš„äº‹æƒ…ï¼Œ æ¯”å¦‚è¯´é¢‘ç¹çš„ä¼ é€’fdé›†åˆï¼Œé¢‘ç¹çš„å»éå†FDç­‰é—®é¢˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰ç±»å‹åˆ«å __fd_maskï¼Œæœ¬è´¨æ˜¯ long int</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">int</span> __fd_mask;</span><br><span class="line"><span class="comment">/* fd_set è®°å½•è¦ç›‘å¬çš„fdé›†åˆï¼ŒåŠå…¶å¯¹åº”çŠ¶æ€ */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">Â  Â  <span class="comment">// fds_bitsæ˜¯longç±»å‹æ•°ç»„ï¼Œé•¿åº¦ä¸º 1024/32 = 32</span></span><br><span class="line">Â  Â  <span class="comment">// å…±1024ä¸ªbitä½ï¼Œæ¯ä¸ªbitä½ä»£è¡¨ä¸€ä¸ªfdï¼Œ0ä»£è¡¨æœªå°±ç»ªï¼Œ1ä»£è¡¨å°±ç»ª</span></span><br><span class="line">Â  Â  __fd_mask fds_bits[__FD_SETSIZE / __NFDBITS];</span><br><span class="line">Â  Â  <span class="comment">// ...</span></span><br><span class="line">&#125; fd_set;</span><br><span class="line"><span class="comment">// selectå‡½æ•°ï¼Œç”¨äºç›‘å¬fd_setï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªfdçš„é›†åˆ</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">select</span><span class="params">(</span></span><br><span class="line"><span class="params">Â  Â  <span class="type">int</span> nfds, <span class="comment">// è¦ç›‘è§†çš„fd_setçš„æœ€å¤§fd + 1</span></span></span><br><span class="line"><span class="params">Â  Â  fd_set *readfds, <span class="comment">// è¦ç›‘å¬è¯»äº‹ä»¶çš„fdé›†åˆ</span></span></span><br><span class="line"><span class="params">Â  Â  fd_set *writefds,<span class="comment">// è¦ç›‘å¬å†™äº‹ä»¶çš„fdé›†åˆ</span></span></span><br><span class="line"><span class="params">Â  Â  fd_set *exceptfds, <span class="comment">// // è¦ç›‘å¬å¼‚å¸¸äº‹ä»¶çš„fdé›†åˆ</span></span></span><br><span class="line"><span class="params">    <span class="comment">// è¶…æ—¶æ—¶é—´ï¼Œnull-ç”¨ä¸è¶…æ—¶ï¼›0-ä¸é˜»å¡ç­‰å¾…ï¼›å¤§äº0-å›ºå®šç­‰å¾…æ—¶é—´</span></span></span><br><span class="line"><span class="params">Â  Â  <span class="keyword">struct</span> timeval *timeout</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure><div class="tabs" id="5e189b93-ed02-4460-b2cd-18f701c01df2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#5e189b93-ed02-4460-b2cd-18f701c01df2-1"><i class="fas fa-atom"></i>åˆ›å»ºfd_set</button></li><li class="tab"><button type="button" data-href="#5e189b93-ed02-4460-b2cd-18f701c01df2-2"><i class="far fa-sun"></i>æ‰§è¡Œselect</button></li><li class="tab"><button type="button" data-href="#5e189b93-ed02-4460-b2cd-18f701c01df2-3"><i class="fas fa-wind"></i>éå†fd_set</button></li><li class="tab"><button type="button" data-href="#5e189b93-ed02-4460-b2cd-18f701c01df2-4"><i class="fas fa-fire-alt"></i>æ•°æ®å°±ç»ª</button></li><li class="tab"><button type="button" data-href="#5e189b93-ed02-4460-b2cd-18f701c01df2-5"><i class="fas fa-cookie-bite"></i>éå†fd_set</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="5e189b93-ed02-4460-b2cd-18f701c01df2-1"><p>å‡å¦‚è¦ç›‘å¬ fd= 1, 2, 5</p><p>æ¯ä¸ªbitä½ä»£è¡¨ä¸€ä¸ªfd</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230616204442788.png" alt="image-20230616204442788" style="zoom: 50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5e189b93-ed02-4460-b2cd-18f701c01df2-2"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230616204552207.png" alt="image-20230616204552207" style="zoom: 50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5e189b93-ed02-4460-b2cd-18f701c01df2-3"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230616204629505.png" alt="image-20230616204629505" style="zoom: 50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5e189b93-ed02-4460-b2cd-18f701c01df2-4"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230616205131015.png" alt="image-20230616205131015" style="zoom: 50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5e189b93-ed02-4460-b2cd-18f701c01df2-5"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230616205352100.png" alt="image-20230616205352100" style="zoom: 50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <p>selectæ¨¡å¼å­˜åœ¨çš„é—®é¢˜ï¼š</p><p>éœ€è¦å°†æ•´ä¸ªfd_setä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œselectç»“æŸè¿˜è¦å†æ¬¡æ‹·è´å›ç”¨æˆ·ç©ºé—´</p><p>selectæ— æ³•å¾—çŸ¥å…·ä½“æ˜¯å“ªä¸ªfdå°±ç»ªï¼Œéœ€è¦éå†æ•´ä¸ªfd_set</p><p>fd_setç›‘å¬çš„fdæ•°é‡ä¸èƒ½è¶…è¿‡1024</p><hr><h4 id="poll">poll</h4><p>pollæ¨¡å¼å¯¹selectæ¨¡å¼åšäº†ç®€å•æ”¹è¿›ï¼Œä½†æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œéƒ¨åˆ†å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><p>IOæµç¨‹ï¼š</p><ul><li>åˆ›å»ºpollfdæ•°ç»„ï¼Œå‘å…¶ä¸­æ·»åŠ å…³æ³¨çš„fdä¿¡æ¯ï¼Œæ•°ç»„å¤§å°è‡ªå®šä¹‰</li><li>è°ƒç”¨pollå‡½æ•°ï¼Œå°†pollfdæ•°ç»„æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œè½¬é“¾è¡¨å­˜å‚¨ï¼Œæ— ä¸Šé™</li><li>å†…æ ¸éå†fdï¼Œåˆ¤æ–­æ˜¯å¦å°±ç»ª</li><li>æ•°æ®å°±ç»ªæˆ–è¶…æ—¶åï¼Œæ‹·è´pollfdæ•°ç»„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè¿”å›å°±ç»ªfdæ•°é‡n</li><li>ç”¨æˆ·è¿›ç¨‹åˆ¤æ–­næ˜¯å¦å¤§äº0</li><li>å¤§äº0åˆ™éå†pollfdæ•°ç»„ï¼Œæ‰¾åˆ°å°±ç»ªçš„fd</li></ul><p><strong>ä¸selectå¯¹æ¯”ï¼š</strong></p><ul><li>selectæ¨¡å¼ä¸­çš„fd_setå¤§å°å›ºå®šä¸º1024ï¼Œè€Œpollfdåœ¨å†…æ ¸ä¸­é‡‡ç”¨é“¾è¡¨ï¼Œç†è®ºä¸Šæ— ä¸Šé™</li><li>ç›‘å¬FDè¶Šå¤šï¼Œæ¯æ¬¡éå†æ¶ˆè€—æ—¶é—´ä¹Ÿè¶Šä¹…ï¼Œæ€§èƒ½åè€Œä¼šä¸‹é™</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pollfd ä¸­çš„äº‹ä»¶ç±»å‹</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POLLIN Â  Â  <span class="comment">//å¯è¯»äº‹ä»¶</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POLLOUT Â   <span class="comment">//å¯å†™äº‹ä»¶</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POLLERR Â  Â <span class="comment">//é”™è¯¯äº‹ä»¶</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POLLNVAL Â  <span class="comment">//fdæœªæ‰“å¼€</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// pollfdç»“æ„</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> &#123;</span></span><br><span class="line">Â  Â  <span class="type">int</span> fd; Â  Â    <span class="comment">/* è¦ç›‘å¬çš„fd Â */</span></span><br><span class="line">Â  Â  <span class="type">short</span> <span class="type">int</span> events; <span class="comment">/* è¦ç›‘å¬çš„äº‹ä»¶ç±»å‹ï¼šè¯»ã€å†™ã€å¼‚å¸¸ */</span></span><br><span class="line">Â  Â  <span class="type">short</span> <span class="type">int</span> revents;<span class="comment">/* å®é™…å‘ç”Ÿçš„äº‹ä»¶ç±»å‹ */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// pollå‡½æ•°</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">poll</span><span class="params">(</span></span><br><span class="line"><span class="params">Â  Â  <span class="keyword">struct</span> pollfd *fds, <span class="comment">// pollfdæ•°ç»„ï¼Œå¯ä»¥è‡ªå®šä¹‰å¤§å°</span></span></span><br><span class="line"><span class="params">Â  Â  <span class="type">nfds_t</span> nfds, <span class="comment">// æ•°ç»„å…ƒç´ ä¸ªæ•°</span></span></span><br><span class="line"><span class="params">Â  Â  <span class="type">int</span> timeout <span class="comment">// è¶…æ—¶æ—¶é—´</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure><hr><h4 id="epoll">epoll</h4><p>epollæ¨¡å¼æ˜¯å¯¹selectå’Œpollçš„æ”¹è¿›ï¼Œå®ƒæä¾›äº†ä¸‰ä¸ªå‡½æ•°ï¼š</p><p>ç¬¬ä¸€ä¸ªæ˜¯ï¼ševentpollçš„å‡½æ•°ï¼Œä»–å†…éƒ¨åŒ…å«ä¸¤ä¸ªä¸œè¥¿</p><p>ä¸€ä¸ªæ˜¯ï¼š</p><p>1ã€çº¢é»‘æ ‘-&gt; è®°å½•çš„äº‹è¦ç›‘å¬çš„FD</p><p>2ã€ä¸€ä¸ªæ˜¯é“¾è¡¨-&gt;ä¸€ä¸ªé“¾è¡¨ï¼Œè®°å½•çš„æ˜¯å°±ç»ªçš„FD</p><p>ç´§æ¥ç€è°ƒç”¨epoll_ctlæ“ä½œï¼Œå°†è¦ç›‘å¬çš„æ•°æ®æ·»åŠ åˆ°çº¢é»‘æ ‘ä¸Šå»ï¼Œå¹¶ä¸”ç»™æ¯ä¸ªfdè®¾ç½®ä¸€ä¸ªç›‘å¬å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåœ¨fdæ•°æ®å°±ç»ªæ—¶è§¦å‘ï¼Œå°±æ˜¯å‡†å¤‡å¥½äº†ï¼Œç°åœ¨å°±æŠŠfdæŠŠæ•°æ®æ·»åŠ åˆ°list_headä¸­å»</p><p>3ã€è°ƒç”¨epoll_waitå‡½æ•°</p><p>å°±å»ç­‰å¾…ï¼Œåœ¨ç”¨æˆ·æ€åˆ›å»ºä¸€ä¸ªç©ºçš„eventsæ•°ç»„ï¼Œå½“å°±ç»ªä¹‹åï¼Œæˆ‘ä»¬çš„å›è°ƒå‡½æ•°ä¼šæŠŠæ•°æ®æ·»åŠ åˆ°list_headä¸­å»ï¼Œå½“è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œä¼šå»æ£€æŸ¥list_headï¼Œå½“ç„¶è¿™ä¸ªè¿‡ç¨‹éœ€è¦å‚è€ƒé…ç½®çš„ç­‰å¾…æ—¶é—´ï¼Œå¯ä»¥ç­‰ä¸€å®šæ—¶é—´ï¼Œä¹Ÿå¯ä»¥ä¸€ç›´ç­‰ï¼Œ å¦‚æœåœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œæ£€æŸ¥åˆ°äº†list_headä¸­æœ‰æ•°æ®ä¼šå°†æ•°æ®æ·»åŠ åˆ°é“¾è¡¨ä¸­ï¼Œæ­¤æ—¶å°†æ•°æ®æ”¾å…¥åˆ°eventsæ•°ç»„ä¸­ï¼Œå¹¶ä¸”è¿”å›å¯¹åº”çš„æ“ä½œçš„æ•°é‡ï¼Œç”¨æˆ·æ€çš„æ­¤æ—¶æ”¶åˆ°å“åº”åï¼Œä»eventsä¸­æ‹¿åˆ°å¯¹åº”å‡†å¤‡å¥½çš„æ•°æ®çš„èŠ‚ç‚¹ï¼Œå†å»è°ƒç”¨æ–¹æ³•å»æ‹¿æ•°æ®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">eventpoll</span> &#123;</span></span><br><span class="line">Â  Â  <span class="comment">//...</span></span><br><span class="line">Â  Â  <span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> Â <span class="title">rbr</span>;</span> <span class="comment">// ä¸€é¢—çº¢é»‘æ ‘ï¼Œè®°å½•è¦ç›‘å¬çš„FD</span></span><br><span class="line">Â  Â  <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">rdlist</span>;</span><span class="comment">// ä¸€ä¸ªé“¾è¡¨ï¼Œè®°å½•å°±ç»ªçš„FD</span></span><br><span class="line">Â  Â  <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 1.åˆ›å»ºä¸€ä¸ªepollå®ä¾‹,å†…éƒ¨æ˜¯event pollï¼Œè¿”å›å¯¹åº”çš„å¥æŸ„epfd</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_create</span><span class="params">(<span class="type">int</span> size)</span>;</span><br><span class="line"><span class="comment">// 2.å°†ä¸€ä¸ªFDæ·»åŠ åˆ°epollçš„çº¢é»‘æ ‘ä¸­ï¼Œå¹¶è®¾ç½®ep_poll_callback</span></span><br><span class="line"><span class="comment">// callbackè§¦å‘æ—¶ï¼Œå°±æŠŠå¯¹åº”çš„FDåŠ å…¥åˆ°rdlistè¿™ä¸ªå°±ç»ªåˆ—è¡¨ä¸­</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_ctl</span><span class="params">(</span></span><br><span class="line"><span class="params">Â  Â  <span class="type">int</span> epfd, Â <span class="comment">// epollå®ä¾‹çš„å¥æŸ„</span></span></span><br><span class="line"><span class="params">Â  Â  <span class="type">int</span> op, Â  Â <span class="comment">// è¦æ‰§è¡Œçš„æ“ä½œï¼ŒåŒ…æ‹¬ï¼šADDã€MODã€DEL</span></span></span><br><span class="line"><span class="params">Â  Â  <span class="type">int</span> fd, Â  Â <span class="comment">// è¦ç›‘å¬çš„FD</span></span></span><br><span class="line"><span class="params">Â  Â  <span class="keyword">struct</span> epoll_event *event <span class="comment">// è¦ç›‘å¬çš„äº‹ä»¶ç±»å‹ï¼šè¯»ã€å†™ã€å¼‚å¸¸ç­‰</span></span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"><span class="comment">// 3.æ£€æŸ¥rdliståˆ—è¡¨æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºåˆ™è¿”å›å°±ç»ªçš„FDçš„æ•°é‡</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_wait</span><span class="params">(</span></span><br><span class="line"><span class="params">Â  Â  <span class="type">int</span> epfd, Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">// epollå®ä¾‹çš„å¥æŸ„</span></span></span><br><span class="line"><span class="params">Â  Â  <span class="keyword">struct</span> epoll_event *events, <span class="comment">// ç©ºeventæ•°ç»„ï¼Œç”¨äºæ¥æ”¶å°±ç»ªçš„FD</span></span></span><br><span class="line"><span class="params">Â  Â  <span class="type">int</span> maxevents, Â  Â  Â  Â  Â  Â  Â <span class="comment">// eventsæ•°ç»„çš„æœ€å¤§é•¿åº¦</span></span></span><br><span class="line"><span class="params">Â  Â  <span class="type">int</span> timeout Â  <span class="comment">// è¶…æ—¶æ—¶é—´ï¼Œ-1ç”¨ä¸è¶…æ—¶ï¼›0ä¸é˜»å¡ï¼›å¤§äº0ä¸ºé˜»å¡æ—¶é—´</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure><div class="tabs" id="ab16328b-43e8-47b1-a206-d6732070d977"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ab16328b-43e8-47b1-a206-d6732070d977-1"><i class="fas fa-cat"></i>epoll_create</button></li><li class="tab"><button type="button" data-href="#ab16328b-43e8-47b1-a206-d6732070d977-2"><i class="fas fa-horse"></i>æ·»åŠ è¦ç›‘å¬çš„FDï¼Œå…³è”callback</button></li><li class="tab"><button type="button" data-href="#ab16328b-43e8-47b1-a206-d6732070d977-3"><i class="fas fa-dove"></i>FDå°±ç»ª</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ab16328b-43e8-47b1-a206-d6732070d977-1"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230617104551607.png" alt="image-20230617104551607" style="zoom: 50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ab16328b-43e8-47b1-a206-d6732070d977-2"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230617104842869.png" alt="image-20230617104842869" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ab16328b-43e8-47b1-a206-d6732070d977-3"><p>å°±ç»ªè§¦å‘å›è°ƒå‡½æ•°æ·»åŠ è‡³å°±ç»ªé“¾è¡¨ï¼Œæ‹·è´åˆ°ç”¨æˆ·ç©ºé—´</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230617105134155.png" alt="image-20230617105134155" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h4 id="å°æ€»ç»“">å°æ€»ç»“</h4><p>selectæ¨¡å¼å­˜åœ¨çš„ä¸‰ä¸ªé—®é¢˜ï¼š</p><ul><li>èƒ½ç›‘å¬çš„FDæœ€å¤§ä¸è¶…è¿‡1024</li><li>æ¯æ¬¡selectéƒ½éœ€è¦æŠŠæ‰€æœ‰è¦ç›‘å¬çš„FDéƒ½æ‹·è´åˆ°å†…æ ¸ç©ºé—´</li><li>æ¯æ¬¡éƒ½è¦éå†æ‰€æœ‰FDæ¥åˆ¤æ–­å°±ç»ªçŠ¶æ€</li></ul><p>pollæ¨¡å¼çš„é—®é¢˜ï¼š</p><ul><li>pollåˆ©ç”¨é“¾è¡¨è§£å†³äº†selectä¸­ç›‘å¬FDä¸Šé™çš„é—®é¢˜ï¼Œä½†ä¾ç„¶è¦éå†æ‰€æœ‰FDï¼Œå¦‚æœç›‘å¬è¾ƒå¤šï¼Œæ€§èƒ½ä¼šä¸‹é™</li></ul><p>epollæ¨¡å¼ä¸­å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜çš„ï¼Ÿ</p><ul><li>åŸºäºepollå®ä¾‹ä¸­çš„çº¢é»‘æ ‘ä¿å­˜è¦ç›‘å¬çš„FDï¼Œç†è®ºä¸Šæ— ä¸Šé™ï¼Œè€Œä¸”å¢åˆ æ”¹æŸ¥æ•ˆç‡éƒ½éå¸¸é«˜</li><li>æ¯ä¸ªFDåªéœ€è¦æ‰§è¡Œä¸€æ¬¡epoll_ctlæ·»åŠ åˆ°çº¢é»‘æ ‘ï¼Œä»¥åæ¯æ¬¡epol_waitæ— éœ€ä¼ é€’ä»»ä½•å‚æ•°ï¼Œæ— éœ€é‡å¤æ‹·è´FDåˆ°å†…æ ¸ç©ºé—´</li><li>åˆ©ç”¨ep_poll_callbackæœºåˆ¶æ¥ç›‘å¬FDçŠ¶æ€ï¼Œæ— éœ€éå†æ‰€æœ‰FDï¼Œå› æ­¤æ€§èƒ½ä¸ä¼šéšç›‘å¬çš„FDæ•°é‡å¢å¤šè€Œä¸‹</li></ul><hr><h4 id="äº‹ä»¶é€šçŸ¥æœºåˆ¶">äº‹ä»¶é€šçŸ¥æœºåˆ¶</h4><p>å½“FDæœ‰æ•°æ®å¯è¯»æ—¶ï¼Œæˆ‘ä»¬è°ƒç”¨epoll_waitï¼ˆæˆ–è€…selectã€pollï¼‰å¯ä»¥å¾—åˆ°é€šçŸ¥ã€‚ä½†æ˜¯äº‹ä»¶é€šçŸ¥çš„æ¨¡å¼æœ‰ä¸¤ç§ï¼š</p><ul><li>LevelTriggeredï¼šç®€ç§°LTï¼Œä¹Ÿå«åšæ°´å¹³è§¦å‘ã€‚åªè¦æŸä¸ªFDä¸­æœ‰æ•°æ®å¯è¯»ï¼Œæ¯æ¬¡è°ƒç”¨epoll_waitéƒ½ä¼šå¾—åˆ°é€šçŸ¥ã€‚</li><li>EdgeTriggeredï¼šç®€ç§°ETï¼Œä¹Ÿå«åšè¾¹æ²¿è§¦å‘ã€‚åªæœ‰åœ¨æŸä¸ªFDæœ‰çŠ¶æ€å˜åŒ–æ—¶ï¼Œè°ƒç”¨epoll_waitæ‰ä¼šè¢«é€šçŸ¥ã€‚</li></ul><p>ä¸¾ä¸ªæ —å­ï¼š</p><ul><li>å‡è®¾ä¸€ä¸ªå®¢æˆ·ç«¯socketå¯¹åº”çš„FDå·²ç»æ³¨å†Œåˆ°äº†epollå®ä¾‹ä¸­</li><li>å®¢æˆ·ç«¯socketå‘é€äº†2kbçš„æ•°æ®</li><li>æœåŠ¡ç«¯è°ƒç”¨epoll_waitï¼Œå¾—åˆ°é€šçŸ¥è¯´FDå°±ç»ª</li><li>æœåŠ¡ç«¯ä»FDè¯»å–äº†1kbæ•°æ®å›åˆ°æ­¥éª¤3ï¼ˆå†æ¬¡è°ƒç”¨epoll_waitï¼Œå½¢æˆå¾ªç¯ï¼‰</li></ul><p>ç»“è®º</p><p>å¦‚æœæˆ‘ä»¬é‡‡ç”¨LTæ¨¡å¼ï¼Œå› ä¸ºFDä¸­ä»æœ‰1kbæ•°æ®ï¼Œåˆ™ç¬¬â‘¤æ­¥ä¾ç„¶ä¼šè¿”å›ç»“æœï¼Œå¹¶ä¸”å¾—åˆ°é€šçŸ¥<br>å¦‚æœæˆ‘ä»¬é‡‡ç”¨ETæ¨¡å¼ï¼Œå› ä¸ºç¬¬â‘¢æ­¥å·²ç»æ¶ˆè´¹äº†FDå¯è¯»äº‹ä»¶ï¼Œç¬¬â‘¤æ­¥FDçŠ¶æ€æ²¡æœ‰å˜åŒ–ï¼Œå› æ­¤epoll_waitä¸ä¼šè¿”å›ï¼Œæ•°æ®æ— æ³•è¯»å–ï¼Œå®¢æˆ·ç«¯å“åº”è¶…æ—¶ã€‚</p><hr><h4 id="åŸºäºepollçš„æœåŠ¡å™¨ç«¯æµç¨‹">åŸºäºepollçš„æœåŠ¡å™¨ç«¯æµç¨‹</h4><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230617111058655.png" alt="image-20230617111058655"></p><hr><h3 id="ä¿¡å·é©±åŠ¨IO">ä¿¡å·é©±åŠ¨IO</h3><p>ä¿¡å·é©±åŠ¨IOæ˜¯ä¸å†…æ ¸å»ºç«‹SIGIOçš„ä¿¡å·å…³è”å¹¶è®¾ç½®å›è°ƒï¼Œå½“å†…æ ¸æœ‰FDå°±ç»ªæ—¶ï¼Œä¼šå‘å‡ºSIGIOä¿¡å·é€šçŸ¥ç”¨æˆ·ï¼ŒæœŸé—´ç”¨æˆ·åº”ç”¨å¯ä»¥æ‰§è¡Œå…¶å®ƒä¸šåŠ¡ï¼Œæ— éœ€é˜»å¡ç­‰å¾…ã€‚</p><p>é˜¶æ®µä¸€ï¼š</p><ul><li>ç”¨æˆ·è¿›ç¨‹è°ƒç”¨sigactionï¼Œæ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°</li><li>å†…æ ¸è¿”å›æˆåŠŸï¼Œå¼€å§‹ç›‘å¬FD</li><li>ç”¨æˆ·è¿›ç¨‹ä¸é˜»å¡ç­‰å¾…ï¼Œå¯ä»¥æ‰§è¡Œå…¶å®ƒä¸šåŠ¡</li><li>å½“å†…æ ¸æ•°æ®å°±ç»ªåï¼Œå›è°ƒç”¨æˆ·è¿›ç¨‹çš„SIGIOå¤„ç†å‡½æ•°</li></ul><p>é˜¶æ®µäºŒï¼š</p><ul><li>æ”¶åˆ°SIGIOå›è°ƒä¿¡å·</li><li>è°ƒç”¨recvfromï¼Œè¯»å–</li><li>å†…æ ¸å°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´</li><li>ç”¨æˆ·è¿›ç¨‹å¤„ç†æ•°æ®</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653911776583.png" alt="1653911776583"></p><hr><h3 id="å¼‚æ­¥IO">å¼‚æ­¥IO</h3><p>è¿™ç§æ–¹å¼ï¼Œä¸ä»…ä»…æ˜¯ç”¨æˆ·æ€åœ¨è¯•å›¾è¯»å–æ•°æ®åï¼Œä¸é˜»å¡ï¼Œè€Œä¸”å½“å†…æ ¸çš„æ•°æ®å‡†å¤‡å®Œæˆåï¼Œä¹Ÿä¸ä¼šé˜»å¡</p><p>ä»–ä¼šç”±å†…æ ¸å°†æ‰€æœ‰æ•°æ®å¤„ç†å®Œæˆåï¼Œç”±å†…æ ¸å°†æ•°æ®å†™å…¥åˆ°ç”¨æˆ·æ€ä¸­ï¼Œç„¶åæ‰ç®—å®Œæˆï¼Œæ‰€ä»¥æ€§èƒ½æé«˜ï¼Œä¸ä¼šæœ‰ä»»ä½•é˜»å¡ï¼Œå…¨éƒ¨éƒ½ç”±å†…æ ¸å®Œæˆï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå¼‚æ­¥IOæ¨¡å‹ä¸­ï¼Œç”¨æˆ·è¿›ç¨‹åœ¨ä¸¤ä¸ªé˜¶æ®µéƒ½æ˜¯éé˜»å¡çŠ¶æ€ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653911877542.png" alt="1653911877542"></p><blockquote><p>å¯¹æ¯”</p></blockquote><p>IOæ“ä½œæ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œå…³é”®çœ‹æ•°æ®åœ¨å†…æ ¸ç©ºé—´ä¸ç”¨æˆ·ç©ºé—´çš„æ‹·è´è¿‡ç¨‹ï¼ˆæ•°æ®è¯»å†™çš„IOæ“ä½œï¼‰ï¼Œä¹Ÿå°±æ˜¯é˜¶æ®µäºŒæ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653912219712.png" alt="1653912219712"></p><hr><h3 id="Redisç½‘ç»œæ¨¡å‹">Redisç½‘ç»œæ¨¡å‹</h3><mark class="hl-label blue">Redisåˆ°åº•æ˜¯å•çº¿ç¨‹è¿˜æ˜¯å¤šçº¿ç¨‹ï¼Ÿ</mark> <ul><li>å¦‚æœä»…ä»…èŠRedisçš„æ ¸å¿ƒä¸šåŠ¡éƒ¨åˆ†ï¼ˆå‘½ä»¤å¤„ç†ï¼‰ï¼Œç­”æ¡ˆæ˜¯å•çº¿ç¨‹</li><li>å¦‚æœæ˜¯èŠæ•´ä¸ªRedisï¼Œé‚£ä¹ˆç­”æ¡ˆå°±æ˜¯å¤šçº¿ç¨‹</li></ul><p>åœ¨Redisç‰ˆæœ¬è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œåœ¨ä¸¤ä¸ªé‡è¦çš„æ—¶é—´èŠ‚ç‚¹ä¸Šå¼•å…¥äº†å¤šçº¿ç¨‹çš„æ”¯æŒï¼š</p><ul><li>Redis v4.0ï¼šå¼•å…¥å¤šçº¿ç¨‹å¼‚æ­¥å¤„ç†ä¸€äº›è€—æ—¶è¾ƒæ—§çš„ä»»åŠ¡ï¼Œä¾‹å¦‚å¼‚æ­¥åˆ é™¤å‘½ä»¤unlink</li><li>Redis v6.0ï¼šåœ¨æ ¸å¿ƒç½‘ç»œæ¨¡å‹ä¸­å¼•å…¥ å¤šçº¿ç¨‹ï¼Œè¿›ä¸€æ­¥æé«˜å¯¹äºå¤šæ ¸CPUçš„åˆ©ç”¨ç‡</li></ul><p>å› æ­¤ï¼Œå¯¹äºRedisçš„æ ¸å¿ƒç½‘ç»œæ¨¡å‹ï¼Œåœ¨Redis 6.0ä¹‹å‰ç¡®å®éƒ½æ˜¯å•çº¿ç¨‹ã€‚æ˜¯åˆ©ç”¨epollï¼ˆLinuxç³»ç»Ÿï¼‰è¿™æ ·çš„IOå¤šè·¯å¤ç”¨æŠ€æœ¯åœ¨äº‹ä»¶å¾ªç¯ä¸­ä¸æ–­å¤„ç†å®¢æˆ·ç«¯æƒ…å†µã€‚</p><mark class="hl-label green">ä¸ºä»€ä¹ˆRedisè¦é€‰æ‹©å•çº¿ç¨‹ï¼Ÿ</mark> <ul><li>æŠ›å¼€æŒä¹…åŒ–ä¸è°ˆï¼ŒRedisæ˜¯çº¯å†…å­˜æ“ä½œï¼Œæ‰§è¡Œé€Ÿåº¦éå¸¸å¿«ï¼Œå®ƒçš„æ€§èƒ½ç“¶é¢ˆæ˜¯ç½‘ç»œå»¶è¿Ÿè€Œä¸æ˜¯æ‰§è¡Œé€Ÿåº¦ï¼Œå› æ­¤å¤šçº¿ç¨‹å¹¶ä¸ä¼šå¸¦æ¥å·¨å¤§çš„æ€§èƒ½æå‡ã€‚</li><li>å¤šçº¿ç¨‹ä¼šå¯¼è‡´è¿‡å¤šçš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¸¦æ¥ä¸å¿…è¦çš„å¼€é”€</li><li>å¼•å…¥å¤šçº¿ç¨‹ä¼šé¢ä¸´çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¿…ç„¶è¦å¼•å…¥çº¿ç¨‹é”è¿™æ ·çš„å®‰å…¨æ‰‹æ®µï¼Œå®ç°å¤æ‚åº¦å¢é«˜ï¼Œè€Œä¸”æ€§èƒ½ä¹Ÿä¼šå¤§æ‰“æŠ˜æ‰£</li></ul><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230616174058705.png" alt="image-20230616174058705" style="zoom:67%;" /><p>å½“æˆ‘ä»¬çš„å®¢æˆ·ç«¯æƒ³è¦å»è¿æ¥æˆ‘ä»¬æœåŠ¡å™¨ï¼Œä¼šå»å…ˆåˆ°IOå¤šè·¯å¤ç”¨æ¨¡å‹å»è¿›è¡Œæ’é˜Ÿï¼Œä¼šæœ‰ä¸€ä¸ªè¿æ¥åº”ç­”å¤„ç†å™¨ï¼Œä»–ä¼šå»æ¥å—è¯»è¯·æ±‚ï¼Œç„¶ååˆæŠŠè¯»è¯·æ±‚æ³¨å†Œåˆ°å…·ä½“æ¨¡å‹ä¸­å»ï¼Œæ­¤æ—¶è¿™äº›å»ºç«‹èµ·æ¥çš„è¿æ¥ï¼Œå¦‚æœæ˜¯å®¢æˆ·ç«¯è¯·æ±‚å¤„ç†å™¨å»è¿›è¡Œæ‰§è¡Œå‘½ä»¤æ—¶ï¼Œä»–ä¼šå»æŠŠæ•°æ®è¯»å–å‡ºæ¥ï¼Œç„¶åæŠŠæ•°æ®æ”¾å…¥åˆ°clientä¸­ï¼Œ clinetå»è§£æå½“å‰çš„å‘½ä»¤è½¬åŒ–ä¸ºredisè®¤è¯†çš„å‘½ä»¤ï¼Œæ¥ä¸‹æ¥å°±å¼€å§‹å¤„ç†è¿™äº›å‘½ä»¤ï¼Œä»redisä¸­çš„commandä¸­æ‰¾åˆ°è¿™äº›å‘½ä»¤ï¼Œç„¶åå°±çœŸæ­£çš„å»æ“ä½œå¯¹åº”çš„æ•°æ®äº†ï¼Œå½“æ•°æ®æ“ä½œå®Œæˆåï¼Œä¼šå»æ‰¾åˆ°å‘½ä»¤å›å¤å¤„ç†å™¨ï¼Œå†ç”±ä»–å°†æ•°æ®å†™å‡ºã€‚</p><hr><hr><h2 id="Redisé€šè®¯åè®®-RESPåè®®">Redisé€šè®¯åè®®-RESPåè®®</h2><p>Redisæ˜¯ä¸€ä¸ªCSæ¶æ„çš„è½¯ä»¶ï¼Œé€šä¿¡ä¸€èˆ¬åˆ†ä¸¤æ­¥ï¼ˆä¸åŒ…æ‹¬pipelineå’ŒPubSubï¼‰ï¼š</p><p>å®¢æˆ·ç«¯ï¼ˆclientï¼‰å‘æœåŠ¡ç«¯ï¼ˆserverï¼‰å‘é€ä¸€æ¡å‘½ä»¤</p><p>æœåŠ¡ç«¯è§£æå¹¶æ‰§è¡Œå‘½ä»¤ï¼Œè¿”å›å“åº”ç»“æœç»™å®¢æˆ·ç«¯</p><p>å› æ­¤å®¢æˆ·ç«¯å‘é€å‘½ä»¤çš„æ ¼å¼ã€æœåŠ¡ç«¯å“åº”ç»“æœçš„æ ¼å¼å¿…é¡»æœ‰ä¸€ä¸ªè§„èŒƒï¼Œè¿™ä¸ªè§„èŒƒå°±æ˜¯é€šä¿¡åè®®ã€‚</p><p>è€Œåœ¨Redisä¸­é‡‡ç”¨çš„æ˜¯RESPï¼ˆRedis Serialization Protocolï¼‰åè®®ï¼š</p><p>Redis 1.2ç‰ˆæœ¬å¼•å…¥äº†RESPåè®®</p><p>Redis 2.0ç‰ˆæœ¬ä¸­æˆä¸ºä¸RedisæœåŠ¡ç«¯é€šä¿¡çš„æ ‡å‡†ï¼Œç§°ä¸ºRESP2</p><p>Redis 6.0ç‰ˆæœ¬ä¸­ï¼Œä»RESP2å‡çº§åˆ°äº†RESP3åè®®ï¼Œå¢åŠ äº†æ›´å¤šæ•°æ®ç±»å‹å¹¶ä¸”æ”¯æŒ6.0çš„æ–°ç‰¹æ€§â€“å®¢æˆ·ç«¯ç¼“å­˜</p><p>ä½†ç›®å‰ï¼Œé»˜è®¤ä½¿ç”¨çš„ä¾ç„¶æ˜¯RESP2åè®®ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬è¦å­¦ä¹ çš„åè®®ç‰ˆæœ¬ï¼ˆä»¥ä¸‹ç®€ç§°RESPï¼‰ã€‚</p><p>åœ¨RESPä¸­ï¼Œé€šè¿‡é¦–å­—èŠ‚çš„å­—ç¬¦æ¥åŒºåˆ†ä¸åŒæ•°æ®ç±»å‹ï¼Œå¸¸ç”¨çš„æ•°æ®ç±»å‹åŒ…æ‹¬5ç§ï¼š</p><p>å•è¡Œå­—ç¬¦ä¸²ï¼šé¦–å­—èŠ‚æ˜¯ â€˜+â€™ ï¼Œåé¢è·Ÿä¸Šå•è¡Œå­—ç¬¦ä¸²ï¼Œä»¥CRLFï¼ˆ â€œ\r\nâ€ ï¼‰ç»“å°¾ã€‚ä¾‹å¦‚è¿”å›&quot;OK&quot;ï¼š â€œ+OK\r\nâ€</p><p>é”™è¯¯ï¼ˆErrorsï¼‰ï¼šé¦–å­—èŠ‚æ˜¯ â€˜-â€™ ï¼Œä¸å•è¡Œå­—ç¬¦ä¸²æ ¼å¼ä¸€æ ·ï¼Œåªæ˜¯å­—ç¬¦ä¸²æ˜¯å¼‚å¸¸ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šâ€œ-Error message\r\nâ€</p><p>æ•°å€¼ï¼šé¦–å­—èŠ‚æ˜¯ â€˜:â€™ ï¼Œåé¢è·Ÿä¸Šæ•°å­—æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œä»¥CRLFç»“å°¾ã€‚ä¾‹å¦‚ï¼šâ€œ:10\r\nâ€</p><p>å¤šè¡Œå­—ç¬¦ä¸²ï¼šé¦–å­—èŠ‚æ˜¯ â€˜$â€™ ï¼Œè¡¨ç¤ºäºŒè¿›åˆ¶å®‰å…¨çš„å­—ç¬¦ä¸²ï¼Œæœ€å¤§æ”¯æŒ512MBï¼š</p><p>å¦‚æœå¤§å°ä¸º0ï¼Œåˆ™ä»£è¡¨ç©ºå­—ç¬¦ä¸²ï¼šâ€œ$0\r\n\r\nâ€</p><p>å¦‚æœå¤§å°ä¸º-1ï¼Œåˆ™ä»£è¡¨ä¸å­˜åœ¨ï¼šâ€œ$-1\r\nâ€</p><p>æ•°ç»„ï¼šé¦–å­—èŠ‚æ˜¯ â€˜*â€™ï¼Œåé¢è·Ÿä¸Šæ•°ç»„å…ƒç´ ä¸ªæ•°ï¼Œå†è·Ÿä¸Šå…ƒç´ ï¼Œå…ƒç´ æ•°æ®ç±»å‹ä¸é™:</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653982993020.png" alt="1653982993020"></p><hr><h3 id="åŸºäºSocketè‡ªå®šä¹‰Redisçš„å®¢æˆ·ç«¯">åŸºäºSocketè‡ªå®šä¹‰Redisçš„å®¢æˆ·ç«¯</h3><p>Redisæ”¯æŒTCPé€šä¿¡ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Socketæ¥æ¨¡æ‹Ÿå®¢æˆ·ç«¯ï¼Œä¸RedisæœåŠ¡ç«¯å»ºç«‹è¿æ¥ï¼š</p><div class="tabs" id="37dd8520-68a9-4405-a84e-462cf9cac3c4"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#37dd8520-68a9-4405-a84e-462cf9cac3c4-1"><i class="fas fa-bug"></i>main</button></li><li class="tab"><button type="button" data-href="#37dd8520-68a9-4405-a84e-462cf9cac3c4-2"><i class="fas fa-cannabis"></i>handleResponse</button></li><li class="tab"><button type="button" data-href="#37dd8520-68a9-4405-a84e-462cf9cac3c4-3"><i class="fas fa-candy-cane"></i>readBulkString</button></li><li class="tab"><button type="button" data-href="#37dd8520-68a9-4405-a84e-462cf9cac3c4-4"><i class="fas fa-child"></i>sendRequest</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="37dd8520-68a9-4405-a84e-462cf9cac3c4-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Socket s;</span><br><span class="line">    <span class="keyword">static</span> PrintWriter writer;</span><br><span class="line">    <span class="keyword">static</span> BufferedReader reader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.å»ºç«‹è¿æ¥</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> <span class="string">&quot;192.168.150.101&quot;</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">6379</span>;</span><br><span class="line">            s = <span class="keyword">new</span> <span class="title class_">Socket</span>(host, port);</span><br><span class="line">            <span class="comment">// 2.è·å–è¾“å‡ºæµã€è¾“å…¥æµ</span></span><br><span class="line">            writer = <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(<span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(s.getOutputStream(), StandardCharsets.UTF_8));</span><br><span class="line">            reader = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(s.getInputStream(), StandardCharsets.UTF_8));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.å‘å‡ºè¯·æ±‚</span></span><br><span class="line">            <span class="comment">// 3.1.è·å–æˆæƒ auth 123321</span></span><br><span class="line">            sendRequest(<span class="string">&quot;auth&quot;</span>, <span class="string">&quot;123321&quot;</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> handleResponse();</span><br><span class="line">            System.out.println(<span class="string">&quot;obj = &quot;</span> + obj);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.2.set name è™å“¥</span></span><br><span class="line">            sendRequest(<span class="string">&quot;set&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;è™å“¥&quot;</span>);</span><br><span class="line">            <span class="comment">// 4.è§£æå“åº”</span></span><br><span class="line">            obj = handleResponse();</span><br><span class="line">            System.out.println(<span class="string">&quot;obj = &quot;</span> + obj);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.2.set name è™å“¥</span></span><br><span class="line">            sendRequest(<span class="string">&quot;get&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">            <span class="comment">// 4.è§£æå“åº”</span></span><br><span class="line">            obj = handleResponse();</span><br><span class="line">            System.out.println(<span class="string">&quot;obj = &quot;</span> + obj);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.2.set name è™å“¥</span></span><br><span class="line">            sendRequest(<span class="string">&quot;mget&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;num&quot;</span>, <span class="string">&quot;msg&quot;</span>);</span><br><span class="line">            <span class="comment">// 4.è§£æå“åº”</span></span><br><span class="line">            obj = handleResponse();</span><br><span class="line">            System.out.println(<span class="string">&quot;obj = &quot;</span> + obj);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 5.é‡Šæ”¾è¿æ¥</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (reader != <span class="literal">null</span>) reader.close();</span><br><span class="line">                <span class="keyword">if</span> (writer != <span class="literal">null</span>) writer.close();</span><br><span class="line">                <span class="keyword">if</span> (s != <span class="literal">null</span>) s.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="37dd8520-68a9-4405-a84e-462cf9cac3c4-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">handleResponse</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// è¯»å–é¦–å­—èŠ‚</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">prefix</span> <span class="operator">=</span> reader.read();</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ•°æ®ç±»å‹æ ‡ç¤º</span></span><br><span class="line">    <span class="keyword">switch</span> (prefix) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;+&#x27;</span>: <span class="comment">// å•è¡Œå­—ç¬¦ä¸²ï¼Œç›´æ¥è¯»ä¸€è¡Œ</span></span><br><span class="line">            <span class="keyword">return</span> reader.readLine();</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;-&#x27;</span>: <span class="comment">// å¼‚å¸¸ï¼Œä¹Ÿè¯»ä¸€è¡Œ</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(reader.readLine());</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;:&#x27;</span>: <span class="comment">// æ•°å­—</span></span><br><span class="line">            <span class="keyword">return</span> Long.parseLong(reader.readLine());</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;$&#x27;</span>: <span class="comment">// å¤šè¡Œå­—ç¬¦ä¸²</span></span><br><span class="line">            <span class="comment">// å…ˆè¯»é•¿åº¦</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> Integer.parseInt(reader.readLine());</span><br><span class="line">            <span class="keyword">if</span> (len == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (len == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å†è¯»æ•°æ®,è¯»lenä¸ªå­—èŠ‚ã€‚æˆ‘ä»¬å‡è®¾æ²¡æœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œæ‰€ä»¥è¯»ä¸€è¡Œï¼ˆç®€åŒ–ï¼‰</span></span><br><span class="line">            <span class="keyword">return</span> reader.readLine();</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;*&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> readBulkString();</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;é”™è¯¯çš„æ•°æ®æ ¼å¼ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="37dd8520-68a9-4405-a84e-462cf9cac3c4-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">readBulkString</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// è·å–æ•°ç»„å¤§å°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> Integer.parseInt(reader.readLine());</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å®šä¹‰é›†åˆï¼Œæ¥æ”¶å¤šä¸ªå…ƒç´ </span></span><br><span class="line">    List&lt;Object&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(len);</span><br><span class="line">    <span class="comment">// éå†ï¼Œä¾æ¬¡è¯»å–æ¯ä¸ªå…ƒç´ </span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        list.add(handleResponse());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="37dd8520-68a9-4405-a84e-462cf9cac3c4-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// set name è™å“¥</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendRequest</span><span class="params">(String ... args)</span> &#123;</span><br><span class="line">    writer.println(<span class="string">&quot;*&quot;</span> + args.length);</span><br><span class="line">    <span class="keyword">for</span> (String arg : args) &#123;</span><br><span class="line">        writer.println(<span class="string">&quot;$&quot;</span> + arg.getBytes(StandardCharsets.UTF_8).length);</span><br><span class="line">        writer.println(arg);</span><br><span class="line">    &#125;</span><br><span class="line">    writer.flush();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="Rediså†…å­˜å›æ”¶">Rediså†…å­˜å›æ”¶</h2><p>Redisä¹‹æ‰€ä»¥æ€§èƒ½å¼ºï¼Œæœ€ä¸»è¦çš„åŸå› å°±æ˜¯åŸºäºå†…å­˜å­˜å‚¨ã€‚ç„¶è€Œå•èŠ‚ç‚¹çš„Rediså…¶å†…å­˜å¤§å°ä¸å®œè¿‡å¤§ï¼Œä¼šå½±å“æŒä¹…åŒ–æˆ–ä¸»ä»åŒæ­¥æ€§èƒ½ã€‚<br>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶æ¥è®¾ç½®Redisçš„æœ€å¤§å†…å­˜ï¼š<code>maxmemory 1gb</code></p><p>å½“å†…å­˜ä½¿ç”¨è¾¾åˆ°ä¸Šé™æ—¶ï¼Œå°±æ— æ³•å­˜å‚¨æ›´å¤šæ•°æ®äº†ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedisæä¾›äº†ä¸€äº›ç­–ç•¥å®ç°å†…å­˜å›æ”¶ï¼š</p><ul><li>å†…å­˜è¿‡æœŸç­–ç•¥</li><li>å†…å­˜æ·˜æ±°ç­–ç•¥</li></ul><hr><h3 id="è¿‡æœŸkeyå¤„ç†">è¿‡æœŸkeyå¤„ç†</h3><p>åœ¨å­¦ä¹ Redisç¼“å­˜çš„æ—¶å€™æˆ‘ä»¬è¯´è¿‡ï¼Œå¯ä»¥é€šè¿‡expireå‘½ä»¤ç»™Redisçš„keyè®¾ç½®TTLï¼ˆå­˜æ´»æ—¶é—´)</p><p>å½“keyçš„TTLåˆ°æœŸä»¥åï¼Œå†æ¬¡è®¿é—®nameè¿”å›çš„æ˜¯nilï¼Œè¯´æ˜è¿™ä¸ªkeyå·²ç»ä¸å­˜åœ¨äº†ï¼Œå¯¹åº”çš„å†…å­˜ä¹Ÿå¾—åˆ°é‡Šæ”¾ã€‚ä»è€Œèµ·åˆ°å†…å­˜å›æ”¶çš„ç›®çš„ã€‚</p><p>Redisæœ¬èº«æ˜¯ä¸€ä¸ªå…¸å‹çš„key-valueå†…å­˜å­˜å‚¨æ•°æ®åº“ï¼Œå› æ­¤æ‰€æœ‰çš„keyã€valueéƒ½ä¿å­˜åœ¨ä¹‹å‰å­¦ä¹ è¿‡çš„Dictç»“æ„ä¸­ã€‚ä¸è¿‡åœ¨å…¶databaseç»“æ„ä½“ä¸­ï¼Œæœ‰ä¸¤ä¸ªDictï¼šä¸€ä¸ªç”¨æ¥è®°å½•key-valueï¼›å¦ä¸€ä¸ªç”¨æ¥è®°å½•key-TTLã€‚</p><p>Redisæœ‰16ä¸ªæ•°æ®åº“ï¼Œæ¯ä¸ªæ•°æ®åº“å°±æ˜¯ä¸€ä¸ªredisDb</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisDb</span> &#123;</span></span><br><span class="line">Â  Â  dict *dict; Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">/* å­˜æ”¾æ‰€æœ‰keyåŠvalueçš„åœ°æ–¹ï¼Œä¹Ÿè¢«ç§°ä¸ºkeyspace*/</span></span><br><span class="line">Â  Â  dict *expires; Â  Â  Â  Â  Â  Â  Â <span class="comment">/* å­˜æ”¾æ¯ä¸€ä¸ªkeyåŠå…¶å¯¹åº”çš„TTLå­˜æ´»æ—¶é—´ï¼ŒåªåŒ…å«è®¾ç½®äº†TTLçš„key*/</span></span><br><span class="line">Â  Â  dict *blocking_keys; Â  Â  Â  Â <span class="comment">/* Keys with clients waiting for data (BLPOP)*/</span></span><br><span class="line">Â  Â  dict *ready_keys; Â  Â  Â  Â  Â  <span class="comment">/* Blocked keys that received a PUSH */</span></span><br><span class="line">Â  Â  dict *watched_keys; Â  Â  Â  Â  <span class="comment">/* WATCHED keys for MULTI/EXEC CAS */</span></span><br><span class="line">Â  Â  <span class="type">int</span> id; Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">/* Database IDï¼Œ0~15 */</span></span><br><span class="line">Â  Â  <span class="type">long</span> <span class="type">long</span> avg_ttl; Â  Â  Â  Â  Â <span class="comment">/* è®°å½•å¹³å‡TTLæ—¶é•¿ */</span></span><br><span class="line">Â  Â  <span class="type">unsigned</span> <span class="type">long</span> expires_cursor; <span class="comment">/* expireæ£€æŸ¥æ—¶åœ¨dictä¸­æŠ½æ ·çš„ç´¢å¼•ä½ç½®. */</span></span><br><span class="line">Â  Â  <span class="built_in">list</span> *defrag_later; Â  Â  Â  Â  <span class="comment">/* ç­‰å¾…ç¢ç‰‡æ•´ç†çš„keyåˆ—è¡¨. */</span></span><br><span class="line">&#125; redisDb;</span><br></pre></td></tr></table></figure><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653983606531.png" alt="1653983606531"></p><p>è¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜éœ€è¦æˆ‘ä»¬æ€è€ƒï¼š</p><blockquote><p>Redisæ˜¯å¦‚ä½•çŸ¥é“ä¸€ä¸ªkeyæ˜¯å¦è¿‡æœŸå‘¢ï¼Ÿ</p></blockquote><p>åˆ©ç”¨ä¸¤ä¸ªDictåˆ†åˆ«è®°å½•key-valueå¯¹åŠkey-ttlå¯¹</p><blockquote><p>æ˜¯ä¸æ˜¯TTLåˆ°æœŸå°±ç«‹å³åˆ é™¤äº†å‘¢ï¼Ÿ</p></blockquote><div class="tabs" id="196f3c83-22e3-4425-bd7b-2acf7e57e000"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#196f3c83-22e3-4425-bd7b-2acf7e57e000-1"><i class="fas fa-cat"></i>æƒ°æ€§åˆ é™¤</button></li><li class="tab"><button type="button" data-href="#196f3c83-22e3-4425-bd7b-2acf7e57e000-2"><i class="fas fa-horse"></i>å‘¨æœŸåˆ é™¤</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="196f3c83-22e3-4425-bd7b-2acf7e57e000-1"><p>æƒ°æ€§åˆ é™¤ï¼šé¡¾æ˜æ€è®®å¹¶ä¸æ˜¯åœ¨TTLåˆ°æœŸåå°±ç«‹åˆ»åˆ é™¤ï¼Œè€Œæ˜¯åœ¨è®¿é—®ä¸€ä¸ªkeyçš„æ—¶å€™ï¼Œæ£€æŸ¥è¯¥keyçš„å­˜æ´»æ—¶é—´ï¼Œå¦‚æœå·²ç»è¿‡æœŸæ‰æ‰§è¡Œåˆ é™¤ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230617162012568.png" alt="image-20230617162012568"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="196f3c83-22e3-4425-bd7b-2acf7e57e000-2"><p>å‘¨æœŸåˆ é™¤ï¼šé¡¾æ˜æ€è®®æ˜¯é€šè¿‡ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œå‘¨æœŸæ€§çš„æŠ½æ ·éƒ¨åˆ†è¿‡æœŸçš„keyï¼Œç„¶åæ‰§è¡Œåˆ é™¤ã€‚</p><p>æ‰§è¡Œå‘¨æœŸæœ‰ä¸¤ç§ï¼š</p><ul><li><p>RedisæœåŠ¡åˆå§‹åŒ–å‡½æ•°initServer()ä¸­è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ŒæŒ‰ç…§server.hzçš„é¢‘ç‡æ¥æ‰§è¡Œè¿‡æœŸkeyæ¸…ç†ï¼Œæ¨¡å¼ä¸ºSLOW</p></li><li><p>Redisçš„æ¯ä¸ªäº‹ä»¶å¾ªç¯å‰ä¼šè°ƒç”¨beforeSleep()å‡½æ•°ï¼Œæ‰§è¡Œè¿‡æœŸkeyæ¸…ç†ï¼Œæ¨¡å¼ä¸ºFAST</p></li></ul><p>SLOWæ¨¡å¼è§„åˆ™ï¼š</p><p>â‘ æ‰§è¡Œé¢‘ç‡å—server.hzå½±å“ï¼Œé»˜è®¤ä¸º10ï¼Œå³æ¯ç§’æ‰§è¡Œ10æ¬¡ï¼Œæ¯ä¸ªæ‰§è¡Œå‘¨æœŸ100msã€‚</p><p>â‘¡æ‰§è¡Œæ¸…ç†è€—æ—¶ä¸è¶…è¿‡ä¸€æ¬¡æ‰§è¡Œå‘¨æœŸçš„25%.é»˜è®¤slowæ¨¡å¼è€—æ—¶ä¸è¶…è¿‡25ms</p><p>â‘¢é€ä¸ªéå†dbï¼Œé€ä¸ªéå†dbä¸­çš„bucketï¼ŒæŠ½å–20ä¸ªkeyåˆ¤æ–­æ˜¯å¦è¿‡æœŸ</p><p>â‘£å¦‚æœæ²¡è¾¾åˆ°æ—¶é—´ä¸Šé™ï¼ˆ25msï¼‰å¹¶ä¸”è¿‡æœŸkeyæ¯”ä¾‹å¤§äº10%ï¼Œå†è¿›è¡Œä¸€æ¬¡æŠ½æ ·ï¼Œå¦åˆ™ç»“æŸ</p><p>FASTæ¨¡å¼è§„åˆ™ï¼ˆè¿‡æœŸkeyæ¯”ä¾‹å°äº10%ä¸æ‰§è¡Œ ï¼‰ï¼š</p><p>â‘ æ‰§è¡Œé¢‘ç‡å—beforeSleep()è°ƒç”¨é¢‘ç‡å½±å“ï¼Œä½†ä¸¤æ¬¡FASTæ¨¡å¼é—´éš”ä¸ä½äº2ms</p><p>â‘¡æ‰§è¡Œæ¸…ç†è€—æ—¶ä¸è¶…è¿‡1ms</p><p>â‘¢é€ä¸ªéå†dbï¼Œé€ä¸ªéå†dbä¸­çš„bucketï¼ŒæŠ½å–20ä¸ªkeyåˆ¤æ–­æ˜¯å¦è¿‡æœŸ</p><p>â‘£å¦‚æœæ²¡è¾¾åˆ°æ—¶é—´ä¸Šé™ï¼ˆ1msï¼‰å¹¶ä¸”è¿‡æœŸkeyæ¯”ä¾‹å¤§äº10%ï¼Œå†è¿›è¡Œä¸€æ¬¡æŠ½æ ·ï¼Œå¦åˆ™ç»“æŸâ‘£</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><mark class="hl-label blue">å°æ€»ç»“</mark> <p>RedisKeyçš„TTLè®°å½•æ–¹å¼ï¼š</p><p>åœ¨RedisDBä¸­é€šè¿‡ä¸€ä¸ªDictè®°å½•æ¯ä¸ªKeyçš„TTLæ—¶é—´</p><p>è¿‡æœŸkeyçš„åˆ é™¤ç­–ç•¥ï¼š</p><ul><li>æƒ°æ€§æ¸…ç†ï¼šæ¯æ¬¡æŸ¥æ‰¾keyæ—¶åˆ¤æ–­æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸåˆ™åˆ é™¤</li><li>å®šæœŸæ¸…ç†ï¼šå®šæœŸæŠ½æ ·éƒ¨åˆ†keyï¼Œåˆ¤æ–­æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸåˆ™åˆ é™¤</li></ul><p>å®šæœŸæ¸…ç†çš„ä¸¤ç§æ¨¡å¼ï¼š</p><ul><li>SLOWæ¨¡å¼æ‰§è¡Œé¢‘ç‡é»˜è®¤ä¸º10ï¼Œæ¯æ¬¡ä¸è¶…è¿‡25ms</li><li>FASTæ¨¡å¼æ‰§è¡Œé¢‘ç‡ä¸å›ºå®šï¼Œä½†ä¸¤æ¬¡é—´éš”ä¸ä½äº2msï¼Œæ¯æ¬¡è€—æ—¶ä¸è¶…è¿‡1ms</li></ul><hr><h3 id="å†…å­˜æ·˜æ±°ç­–ç•¥">å†…å­˜æ·˜æ±°ç­–ç•¥</h3><p>å†…å­˜æ·˜æ±°ï¼šå°±æ˜¯å½“Rediså†…å­˜ä½¿ç”¨è¾¾åˆ°è®¾ç½®çš„ä¸Šé™æ—¶ï¼Œä¸»åŠ¨æŒ‘é€‰éƒ¨åˆ†keyåˆ é™¤ä»¥é‡Šæ”¾æ›´å¤šå†…å­˜çš„æµç¨‹ã€‚Redisä¼šåœ¨å¤„ç†å®¢æˆ·ç«¯å‘½ä»¤çš„æ–¹æ³•processCommand()ä¸­å°è¯•åšå†…å­˜æ·˜æ±°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">processCommand</span><span class="params">(client *c)</span> &#123;</span><br><span class="line">Â  Â  <span class="comment">// å¦‚æœæœåŠ¡å™¨è®¾ç½®äº†server.maxmemoryå±æ€§ï¼Œå¹¶ä¸”å¹¶æœªæœ‰æ‰§è¡Œluaè„šæœ¬</span></span><br><span class="line">Â  Â  <span class="keyword">if</span> (server.maxmemory &amp;&amp; !server.lua_timedout) &#123;</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// å°è¯•è¿›è¡Œå†…å­˜æ·˜æ±°performEvictions</span></span><br><span class="line">Â  Â  Â  Â  <span class="type">int</span> out_of_memory = (performEvictions() == EVICT_FAIL);</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// ...</span></span><br><span class="line">Â  Â  Â  Â  <span class="keyword">if</span> (out_of_memory &amp;&amp; reject_cmd_on_oom) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  rejectCommand(c, shared.oomerr);</span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">return</span> C_OK;</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// ....</span></span><br><span class="line">Â  Â  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><mark class="hl-label blue">æ·˜æ±°ç­–ç•¥</mark> <p>Redisæ”¯æŒ8ç§ä¸åŒç­–ç•¥æ¥é€‰æ‹©è¦åˆ é™¤çš„keyï¼š</p><ul><li><p>noevictionï¼š ä¸æ·˜æ±°ä»»ä½•keyï¼Œä½†æ˜¯å†…å­˜æ»¡æ—¶ä¸å…è®¸å†™å…¥æ–°æ•°æ®ï¼Œé»˜è®¤å°±æ˜¯è¿™ç§ç­–ç•¥ã€‚</p></li><li><p>volatile-ttlï¼š å¯¹è®¾ç½®äº†TTLçš„keyï¼Œæ¯”è¾ƒkeyçš„å‰©ä½™TTLå€¼ï¼ŒTTLè¶Šå°è¶Šå…ˆè¢«æ·˜æ±°</p></li><li><p>allkeys-randomï¼šå¯¹å…¨ä½“key ï¼Œéšæœºè¿›è¡Œæ·˜æ±°ã€‚ä¹Ÿå°±æ˜¯ç›´æ¥ä»db-&gt;dictä¸­éšæœºæŒ‘é€‰</p></li><li><p>volatile-randomï¼šå¯¹è®¾ç½®äº†TTLçš„key ï¼Œéšæœºè¿›è¡Œæ·˜æ±°ã€‚ä¹Ÿå°±æ˜¯ä»db-&gt;expiresä¸­éšæœºæŒ‘é€‰ã€‚</p></li><li><p>allkeys-lruï¼š å¯¹å…¨ä½“keyï¼ŒåŸºäºLRUç®—æ³•è¿›è¡Œæ·˜æ±°</p></li><li><p>volatile-lruï¼š å¯¹è®¾ç½®äº†TTLçš„keyï¼ŒåŸºäºLRUç®—æ³•è¿›è¡Œæ·˜æ±°</p></li><li><p>allkeys-lfuï¼š å¯¹å…¨ä½“keyï¼ŒåŸºäºLFUç®—æ³•è¿›è¡Œæ·˜æ±°</p></li><li><p>volatile-lfuï¼š å¯¹è®¾ç½®äº†TTLçš„keyï¼ŒåŸºäºLFIç®—æ³•è¿›è¡Œæ·˜æ±°</p><p>æ¯”è¾ƒå®¹æ˜“æ··æ·†çš„æœ‰ä¸¤ä¸ªï¼š</p><ul><li>LRUï¼ˆLeast Recently Usedï¼‰ï¼Œæœ€å°‘æœ€è¿‘ä½¿ç”¨ã€‚ç”¨å½“å‰æ—¶é—´å‡å»æœ€åä¸€æ¬¡è®¿é—®æ—¶é—´ï¼Œè¿™ä¸ªå€¼è¶Šå¤§åˆ™æ·˜æ±°ä¼˜å…ˆçº§è¶Šé«˜ã€‚</li><li>LFUï¼ˆLeast Frequently Usedï¼‰ï¼Œæœ€å°‘é¢‘ç‡ä½¿ç”¨ã€‚ä¼šç»Ÿè®¡æ¯ä¸ªkeyçš„è®¿é—®é¢‘ç‡ï¼Œå€¼è¶Šå°æ·˜æ±°ä¼˜å…ˆçº§è¶Šé«˜ã€‚</li></ul></li></ul><p>Redisçš„æ•°æ®éƒ½ä¼šè¢«å°è£…ä¸ºRedisObjectç»“æ„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObject</span> &#123;</span></span><br><span class="line">Â  Â  <span class="type">unsigned</span> type:<span class="number">4</span>; Â  Â  Â  Â <span class="comment">// å¯¹è±¡ç±»å‹</span></span><br><span class="line">Â  Â  <span class="type">unsigned</span> encoding:<span class="number">4</span>; Â  Â <span class="comment">// ç¼–ç æ–¹å¼</span></span><br><span class="line">Â  Â  <span class="type">unsigned</span> lru:LRU_BITS; Â <span class="comment">// LRUï¼šä»¥ç§’ä¸ºå•ä½è®°å½•æœ€è¿‘ä¸€æ¬¡è®¿é—®æ—¶é—´ï¼Œé•¿åº¦24bit LFUï¼šé«˜16ä½ä»¥åˆ†é’Ÿä¸ºå•ä½è®°å½•æœ€è¿‘ä¸€æ¬¡è®¿é—®æ—¶é—´ï¼Œä½8ä½è®°å½•é€»è¾‘è®¿é—®æ¬¡æ•°</span></span><br><span class="line">Â  Â  <span class="type">int</span> refcount; Â  Â  Â  Â  Â  <span class="comment">// å¼•ç”¨è®¡æ•°ï¼Œè®¡æ•°ä¸º0åˆ™å¯ä»¥å›æ”¶</span></span><br><span class="line">Â  Â  <span class="type">void</span> *ptr; Â  Â  Â  Â  Â  Â  Â <span class="comment">// æ•°æ®æŒ‡é’ˆï¼ŒæŒ‡å‘çœŸå®æ•°æ®</span></span><br><span class="line">&#125; robj;</span><br></pre></td></tr></table></figure><p>LFUçš„è®¿é—®æ¬¡æ•°ä¹‹æ‰€ä»¥å«åšé€»è¾‘è®¿é—®æ¬¡æ•°ï¼Œæ˜¯å› ä¸ºå¹¶ä¸æ˜¯æ¯æ¬¡keyè¢«è®¿é—®éƒ½è®¡æ•°ï¼Œè€Œæ˜¯é€šè¿‡è¿ç®—ï¼š</p><ul><li>ç”Ÿæˆ0~1ä¹‹é—´çš„éšæœºæ•°R</li><li>è®¡ç®— (æ—§æ¬¡æ•° * lfu_log_factor + 1)ï¼Œè®°å½•ä¸ºP</li><li>å¦‚æœ R &lt; P ï¼Œåˆ™è®¡æ•°å™¨ + 1ï¼Œä¸”æœ€å¤§ä¸è¶…è¿‡255</li><li>è®¿é—®æ¬¡æ•°ä¼šéšæ—¶é—´è¡°å‡ï¼Œè·ç¦»ä¸Šä¸€æ¬¡è®¿é—®æ—¶é—´æ¯éš” lfu_decay_time åˆ†é’Ÿï¼Œè®¡æ•°å™¨ -1</li></ul><p>æœ€åç”¨ä¸€å‰¯å›¾æ¥æè¿°å½“å‰çš„è¿™ä¸ªæµç¨‹å§</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653984085095.png" alt="1653984085095"></p>]]></content>
    
    
    <summary type="html">æ•°æ®ç»“æ„ã€ç½‘ç»œæ¨¡å‹ã€RESPåè®®</summary>
    
    
    
    <category term="æ•°æ®åº“" scheme="https://wuwawawa.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="Redis" scheme="https://wuwawawa.github.io/tags/Redis/"/>
    
    <category term="æ•°æ®åº“" scheme="https://wuwawawa.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>Redisé«˜çº§</title>
    <link href="https://wuwawawa.github.io/posts/db4d2069.html"/>
    <id>https://wuwawawa.github.io/posts/db4d2069.html</id>
    <published>2023-06-12T09:12:51.000Z</published>
    <updated>2023-06-15T14:26:52.342Z</updated>
    
    <content type="html"><![CDATA[<h2 id="RedisæŒä¹…åŒ–">RedisæŒä¹…åŒ–</h2><p>Redisæœ‰ä¸¤ç§æŒä¹…åŒ–æ–¹æ¡ˆï¼š</p><ul><li>RDBæŒä¹…åŒ–</li><li>AOFæŒä¹…åŒ–</li></ul><hr><h3 id="RDBæŒä¹…åŒ–">RDBæŒä¹…åŒ–</h3><p>RDBå…¨ç§°<code>Redis Database Backup file</code>ï¼ˆRedisæ•°æ®å¤‡ä»½æ–‡ä»¶ï¼‰ï¼Œä¹Ÿè¢«å«åšRedisæ•°æ®å¿«ç…§ã€‚ç®€å•æ¥è¯´å°±æ˜¯æŠŠå†…å­˜ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½è®°å½•åˆ°ç£ç›˜ä¸­ã€‚å½“Rediså®ä¾‹æ•…éšœé‡å¯åï¼Œä»ç£ç›˜è¯»å–å¿«ç…§æ–‡ä»¶ï¼Œæ¢å¤æ•°æ®ã€‚å¿«ç…§æ–‡ä»¶ç§°ä¸ºRDBæ–‡ä»¶ï¼Œé»˜è®¤æ˜¯ä¿å­˜åœ¨å½“å‰è¿è¡Œç›®å½•ã€‚</p><hr><h4 id="æ‰§è¡Œæ—¶æœº">æ‰§è¡Œæ—¶æœº</h4><div class="tabs" id="d7672d57-2890-4cd6-9d53-7464f9c2a49f"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d7672d57-2890-4cd6-9d53-7464f9c2a49f-1"><i class="fas fa-seedling"></i>1)saveå‘½ä»¤</button></li><li class="tab"><button type="button" data-href="#d7672d57-2890-4cd6-9d53-7464f9c2a49f-2"><i class="fas fa-leaf"></i>2)bgsaveå‘½ä»¤</button></li><li class="tab"><button type="button" data-href="#d7672d57-2890-4cd6-9d53-7464f9c2a49f-3"><i class="fab fa-apple"></i>3)åœæœºæ—¶</button></li><li class="tab"><button type="button" data-href="#d7672d57-2890-4cd6-9d53-7464f9c2a49f-4"><i class="fas fa-tree"></i>4)è§¦å‘RDBæ¡ä»¶</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d7672d57-2890-4cd6-9d53-7464f9c2a49f-1"><p>æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¯ä»¥ç«‹å³æ‰§è¡Œä¸€æ¬¡RDBï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; save    <span class="comment">#ç”±Redisä¸»è¿›ç¨‹æ¥æ‰§è¡ŒRDBï¼Œä¼šé˜»å¡æ‰€æœ‰å‘½ä»¤</span></span><br><span class="line">ok</span><br></pre></td></tr></table></figure><p>saveå‘½ä»¤ä¼šå¯¼è‡´ä¸»è¿›ç¨‹æ‰§è¡ŒRDBï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­å…¶å®ƒæ‰€æœ‰å‘½ä»¤éƒ½ä¼šè¢«é˜»å¡ã€‚åªæœ‰åœ¨æ•°æ®è¿ç§»æ—¶å¯èƒ½ç”¨åˆ°ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d7672d57-2890-4cd6-9d53-7464f9c2a49f-2"><p>ä¸‹é¢çš„å‘½ä»¤å¯ä»¥å¼‚æ­¥æ‰§è¡ŒRDBï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; bgsave    <span class="comment">#å¼€å¯å­è¿›ç¨‹æ‰§è¡ŒRDBï¼Œé¿å…ä¸»è¿›ç¨‹å—åˆ°å½±å“</span></span><br><span class="line">ok</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‘½ä»¤æ‰§è¡Œåä¼šå¼€å¯ç‹¬ç«‹è¿›ç¨‹å®ŒæˆRDBï¼Œä¸»è¿›ç¨‹å¯ä»¥æŒç»­å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œä¸å—å½±å“ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d7672d57-2890-4cd6-9d53-7464f9c2a49f-3"><p>Redisåœæœºæ—¶ä¼šæ‰§è¡Œä¸€æ¬¡saveå‘½ä»¤ï¼Œå®ç°RDBæŒä¹…åŒ–ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d7672d57-2890-4cd6-9d53-7464f9c2a49f-4"><p>Rediså†…éƒ¨æœ‰è§¦å‘RDBçš„æœºåˆ¶ï¼Œå¯ä»¥åœ¨redis.confæ–‡ä»¶ä¸­æ‰¾åˆ°ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 900ç§’å†…ï¼Œå¦‚æœè‡³å°‘æœ‰1ä¸ªkeyè¢«ä¿®æ”¹ï¼Œåˆ™æ‰§è¡Œbgsave ï¼Œ å¦‚æœæ˜¯save &quot;&quot; åˆ™è¡¨ç¤ºç¦ç”¨RDB</span></span><br><span class="line"><span class="attr">save</span> <span class="string">900 1  </span></span><br><span class="line"><span class="attr">save</span> <span class="string">300 10  </span></span><br><span class="line"><span class="attr">save</span> <span class="string">60 10000 </span></span><br></pre></td></tr></table></figure><p>RDBçš„å…¶å®ƒé…ç½®ä¹Ÿå¯ä»¥åœ¨redis.confæ–‡ä»¶ä¸­è®¾ç½®ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ˜¯å¦å‹ç¼© ,å»ºè®®ä¸å¼€å¯ï¼Œå‹ç¼©ä¹Ÿä¼šæ¶ˆè€—cpuï¼Œç£ç›˜çš„è¯ä¸å€¼é’±</span></span><br><span class="line"><span class="attr">rdbcompression</span> <span class="string">yes</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># RDBæ–‡ä»¶åç§°</span></span><br><span class="line"><span class="attr">dbfilename</span> <span class="string">dump.rdb  </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># æ–‡ä»¶ä¿å­˜çš„è·¯å¾„ç›®å½•</span></span><br><span class="line"><span class="attr">dir</span> <span class="string">./ </span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h4 id="RDBåŸç†">RDBåŸç†</h4><p>bgsaveå¼€å§‹æ—¶ä¼šforkä¸»è¿›ç¨‹å¾—åˆ°å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹å…±äº«ä¸»è¿›ç¨‹çš„å†…å­˜æ•°æ®ã€‚å®Œæˆforkåè¯»å–å†…å­˜æ•°æ®å¹¶å†™å…¥ RDB æ–‡ä»¶ã€‚</p><p>forké‡‡ç”¨çš„æ˜¯copy-on-writeæŠ€æœ¯ï¼š</p><ul><li>å½“ä¸»è¿›ç¨‹æ‰§è¡Œè¯»æ“ä½œæ—¶ï¼Œè®¿é—®å…±äº«å†…å­˜ï¼›</li><li>å½“ä¸»è¿›ç¨‹æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œåˆ™ä¼šæ‹·è´ä¸€ä»½æ•°æ®ï¼Œæ‰§è¡Œå†™æ“ä½œã€‚</li></ul><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725151319695.png" alt="image-20210725151319695" style="zoom:67%;" /><hr><h4 id="å°ç»“">å°ç»“</h4><p>RDBæ–¹å¼bgsaveçš„åŸºæœ¬æµç¨‹ï¼Ÿ</p><ul><li>forkä¸»è¿›ç¨‹å¾—åˆ°ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå…±äº«å†…å­˜ç©ºé—´</li><li>å­è¿›ç¨‹è¯»å–å†…å­˜æ•°æ®å¹¶å†™å…¥æ–°çš„RDBæ–‡ä»¶</li><li>ç”¨æ–°RDBæ–‡ä»¶æ›¿æ¢æ—§çš„RDBæ–‡ä»¶</li></ul><p>RDBä¼šåœ¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿsave 60 1000ä»£è¡¨ä»€ä¹ˆå«ä¹‰ï¼Ÿ</p><ul><li>é»˜è®¤æ˜¯æœåŠ¡åœæ­¢æ—¶</li><li>ä»£è¡¨60ç§’å†…è‡³å°‘æ‰§è¡Œ1000æ¬¡ä¿®æ”¹åˆ™è§¦å‘RDB</li></ul><p>RDBçš„ç¼ºç‚¹ï¼Ÿ</p><ul><li>RDBæ‰§è¡Œé—´éš”æ—¶é—´é•¿ï¼Œä¸¤æ¬¡RDBä¹‹é—´å†™å…¥æ•°æ®æœ‰ä¸¢å¤±çš„é£é™©</li><li>forkå­è¿›ç¨‹ã€å‹ç¼©ã€å†™å‡ºRDBæ–‡ä»¶éƒ½æ¯”è¾ƒè€—æ—¶</li></ul><hr><h3 id="AOFæŒä¹…åŒ–">AOFæŒä¹…åŒ–</h3><h4 id="AOFåŸç†">AOFåŸç†</h4><p>AOFå…¨ç§°ä¸º<code>Append Only File</code>ï¼ˆè¿½åŠ æ–‡ä»¶ï¼‰ã€‚Rediså¤„ç†çš„æ¯ä¸€ä¸ªå†™å‘½ä»¤éƒ½ä¼šè®°å½•åœ¨AOFæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åšæ˜¯å‘½ä»¤æ—¥å¿—æ–‡ä»¶ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725151543640.png" alt="image-20210725151543640" style="zoom:67%;" /><hr><h4 id="AOFé…ç½®">AOFé…ç½®</h4><p>AOFé»˜è®¤æ˜¯å…³é—­çš„ï¼Œéœ€è¦ä¿®æ”¹redis.confé…ç½®æ–‡ä»¶æ¥å¼€å¯AOFï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ˜¯å¦å¼€å¯AOFåŠŸèƒ½ï¼Œé»˜è®¤æ˜¯no</span></span><br><span class="line"><span class="attr">appendonly</span> <span class="string">yes</span></span><br><span class="line"><span class="comment"># AOFæ–‡ä»¶çš„åç§°</span></span><br><span class="line"><span class="attr">appendfilename</span> <span class="string">&quot;appendonly.aof&quot;</span></span><br></pre></td></tr></table></figure><p>AOFçš„å‘½ä»¤è®°å½•çš„é¢‘ç‡ä¹Ÿå¯ä»¥é€šè¿‡redis.confæ–‡ä»¶æ¥é…ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¡¨ç¤ºæ¯æ‰§è¡Œä¸€æ¬¡å†™å‘½ä»¤ï¼Œç«‹å³è®°å½•åˆ°AOFæ–‡ä»¶</span></span><br><span class="line"><span class="attr">appendfsync</span> <span class="string">always </span></span><br><span class="line"><span class="comment"># å†™å‘½ä»¤æ‰§è¡Œå®Œå…ˆæ”¾å…¥AOFç¼“å†²åŒºï¼Œç„¶åè¡¨ç¤ºæ¯éš”1ç§’å°†ç¼“å†²åŒºæ•°æ®å†™åˆ°AOFæ–‡ä»¶ï¼Œæ˜¯é»˜è®¤æ–¹æ¡ˆ</span></span><br><span class="line"><span class="attr">appendfsync</span> <span class="string">everysec </span></span><br><span class="line"><span class="comment"># å†™å‘½ä»¤æ‰§è¡Œå®Œå…ˆæ”¾å…¥AOFç¼“å†²åŒºï¼Œç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶å°†ç¼“å†²åŒºå†…å®¹å†™å›ç£ç›˜</span></span><br><span class="line"><span class="attr">appendfsync</span> <span class="string">no</span></span><br></pre></td></tr></table></figure><mark class="hl-label blue">ä¸‰ç§ç­–ç•¥å¯¹æ¯”</mark> <table><thead><tr><th style="text-align:center">é…ç½®é¡¹</th><th style="text-align:center">åˆ·ç›˜æ—¶æœº</th><th style="text-align:center">ä¼˜ç‚¹</th><th style="text-align:center">ç¼ºç‚¹</th></tr></thead><tbody><tr><td style="text-align:center">always</td><td style="text-align:center">åŒæ­¥åˆ·ç›˜</td><td style="text-align:center">å¯é æ€§é«˜ï¼Œå‡ ä¹ä¸ä¸¢æ•°æ®</td><td style="text-align:center">æ€§èƒ½å½±å“æœ€å¤§</td></tr><tr><td style="text-align:center">everysec</td><td style="text-align:center">æ¯ç§’åˆ·ç›˜</td><td style="text-align:center">æ€§èƒ½é€‚ä¸­</td><td style="text-align:center">æœ€å¤šä¸¢å¤±1sæ•°æ®</td></tr><tr><td style="text-align:center">no</td><td style="text-align:center">æ“ä½œç³»ç»Ÿæ§åˆ¶</td><td style="text-align:center">æ€§èƒ½æœ€å¥½</td><td style="text-align:center">å¯é æ€§è¾ƒå·®ï¼Œå¯èƒ½ä¸¢å¤±å¤§é‡æ•°æ®</td></tr></tbody></table><hr><h4 id="AOFæ–‡ä»¶é‡å†™">AOFæ–‡ä»¶é‡å†™</h4><p>å› ä¸ºæ˜¯è®°å½•å‘½ä»¤ï¼ŒAOFæ–‡ä»¶ä¼šæ¯”RDBæ–‡ä»¶å¤§çš„å¤šã€‚è€Œä¸”AOFä¼šè®°å½•å¯¹åŒä¸€ä¸ªkeyçš„å¤šæ¬¡å†™æ“ä½œï¼Œä½†åªæœ‰æœ€åä¸€æ¬¡å†™æ“ä½œæ‰æœ‰æ„ä¹‰ã€‚é€šè¿‡æ‰§è¡Œbgrewriteaofå‘½ä»¤ï¼Œå¯ä»¥è®©AOFæ–‡ä»¶æ‰§è¡Œé‡å†™åŠŸèƒ½ï¼Œç”¨æœ€å°‘çš„å‘½ä»¤è¾¾åˆ°ç›¸åŒæ•ˆæœã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725151729118.png" alt="image-20210725151729118"></p><p>å¦‚å›¾ï¼ŒAOFåŸæœ¬æœ‰ä¸‰ä¸ªå‘½ä»¤ï¼Œä½†æ˜¯<code>set num 123 å’Œ set num 666</code>éƒ½æ˜¯å¯¹numçš„æ“ä½œï¼Œç¬¬äºŒæ¬¡ä¼šè¦†ç›–ç¬¬ä¸€æ¬¡çš„å€¼ï¼Œå› æ­¤ç¬¬ä¸€ä¸ªå‘½ä»¤è®°å½•ä¸‹æ¥æ²¡æœ‰æ„ä¹‰ã€‚</p><p>æ‰€ä»¥é‡å†™å‘½ä»¤åï¼ŒAOFæ–‡ä»¶å†…å®¹å°±æ˜¯ï¼š<code>mset name jack num 666</code></p><p>Redisä¹Ÿä¼šåœ¨è§¦å‘é˜ˆå€¼æ—¶è‡ªåŠ¨å»é‡å†™AOFæ–‡ä»¶ã€‚é˜ˆå€¼ä¹Ÿå¯ä»¥åœ¨redis.confä¸­é…ç½®ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># AOFæ–‡ä»¶æ¯”ä¸Šæ¬¡æ–‡ä»¶ å¢é•¿è¶…è¿‡å¤šå°‘ç™¾åˆ†æ¯”åˆ™è§¦å‘é‡å†™</span></span><br><span class="line"><span class="attr">auto-aof-rewrite-percentage</span> <span class="string">100</span></span><br><span class="line"><span class="comment"># AOFæ–‡ä»¶ä½“ç§¯æœ€å°å¤šå¤§ä»¥ä¸Šæ‰è§¦å‘é‡å†™ </span></span><br><span class="line"><span class="attr">auto-aof-rewrite-min-size</span> <span class="string">64mb </span></span><br></pre></td></tr></table></figure><hr><h3 id="RDBä¸AOFå¯¹æ¯”">RDBä¸AOFå¯¹æ¯”</h3><p>RDBå’ŒAOFå„æœ‰è‡ªå·±çš„ä¼˜ç¼ºç‚¹ï¼Œå¦‚æœå¯¹æ•°æ®å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜ï¼Œåœ¨å®é™…å¼€å‘ä¸­å¾€å¾€ä¼š<span class='p green'>ç»“åˆä¸¤è€…</span>æ¥ä½¿ç”¨ã€‚</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">RDB</th><th style="text-align:center">AOF</th></tr></thead><tbody><tr><td style="text-align:center">æŒä¹…åŒ–æ–¹å¼</td><td style="text-align:center">å®šæ—¶å¯¹æ•´ä¸ªå†…å­˜åšå¿«ç…§</td><td style="text-align:center">è®°å½•æ¯ä¸€æ¬¡æ‰§è¡Œçš„å‘½ä»¤</td></tr><tr><td style="text-align:center">æ•°æ®å®Œæ•´æ€§</td><td style="text-align:center">ä¸å®Œæ•´ï¼Œä¸¤æ¬¡å¤‡ä»½ä¹‹é—´ä¼šä¸¢å¤±</td><td style="text-align:center">ç›¸å¯¹å®Œæ•´ï¼Œå–å†³äºåˆ·ç›˜ç­–ç•¥</td></tr><tr><td style="text-align:center">æ–‡ä»¶å¤§å°</td><td style="text-align:center">ä¼šæœ‰å‹ç¼©ï¼Œæ–‡ä»¶ä½“ç§¯å°</td><td style="text-align:center">è®°å½•å‘½ä»¤ï¼Œæ–‡ä»¶ä½“ç§¯å¾ˆå¤§</td></tr><tr><td style="text-align:center">å®•æœºæ¢å¤é€Ÿåº¦</td><td style="text-align:center">å¾ˆå¿«</td><td style="text-align:center">æ…¢</td></tr><tr><td style="text-align:center">æ•°æ®æ¢å¤ä¼˜å…ˆçº§</td><td style="text-align:center">ä½ï¼Œå› ä¸ºæ•°æ®å®Œæ•´æ€§ä¸å¦‚AOF</td><td style="text-align:center">é«˜ï¼Œå› ä¸ºæ•°æ®å®Œæ•´æ€§æ›´é«˜</td></tr><tr><td style="text-align:center">ç³»ç»Ÿèµ„æºå ç”¨</td><td style="text-align:center">é«˜ï¼Œå¤§é‡CPUå’Œå†…å­˜æ¶ˆè€—</td><td style="text-align:center">ä½ï¼Œä¸»è¦æ˜¯ç£ç›˜I0èµ„æº<br/>ä½†AOFé‡å†™æ—¶ä¼šå ç”¨å¤§é‡CPUå’Œå†…å­˜èµ„æº</td></tr><tr><td style="text-align:center">ä½¿ç”¨åœºæ™¯</td><td style="text-align:center">å¯ä»¥å®¹å¿æ•°åˆ†é’Ÿçš„æ•°æ®ä¸¢å¤±ï¼Œè¿½æ±‚æ›´å¿«çš„å¯åŠ¨é€Ÿåº¦</td><td style="text-align:center">å¯¹æ•°æ®å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜å¸¸è§</td></tr></tbody></table><hr><hr><h2 id="Redisä¸»ä»">Redisä¸»ä»</h2><h3 id="æ­å»ºä¸»ä»æ¶æ„">æ­å»ºä¸»ä»æ¶æ„</h3><p>å•èŠ‚ç‚¹Redisçš„å¹¶å‘èƒ½åŠ›æ˜¯æœ‰ä¸Šé™çš„ï¼Œè¦è¿›ä¸€æ­¥æé«˜Redisçš„å¹¶å‘èƒ½åŠ›ï¼Œå°±éœ€è¦æ­å»ºä¸»ä»é›†ç¾¤ï¼Œå®ç°è¯»å†™åˆ†ç¦»ã€‚</p><p>æˆ‘ä»¬æ­å»ºçš„ä¸»ä»é›†ç¾¤ç»“æ„å¦‚å›¾ï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230614111321276.png" alt="image-20230614111321276" style="zoom:67%;" /><p>å…±åŒ…å«ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œä¸¤ä¸ªä»èŠ‚ç‚¹ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä¼šåœ¨åŒä¸€å°æœºå™¨ä¸­å¼€å¯3ä¸ªrediså®ä¾‹ï¼Œæ¨¡æ‹Ÿä¸»ä»é›†ç¾¤ï¼Œä¿¡æ¯å¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:center">IP</th><th style="text-align:center">PORT</th><th style="text-align:center">è§’è‰²</th></tr></thead><tbody><tr><td style="text-align:center">8.130.68.59</td><td style="text-align:center">6379</td><td style="text-align:center">master</td></tr><tr><td style="text-align:center">8.130.68.59</td><td style="text-align:center">6380</td><td style="text-align:center">slave</td></tr><tr><td style="text-align:center">8.130.68.59</td><td style="text-align:center">6381</td><td style="text-align:center">slave</td></tr></tbody></table><div class="tabs" id="36348bc6-aaa7-41c6-84c3-f97777968ac3"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#36348bc6-aaa7-41c6-84c3-f97777968ac3-1"><i class="fas fa-heartbeat"></i>åˆ›å»ºæ–‡ä»¶å¤¹</button></li><li class="tab"><button type="button" data-href="#36348bc6-aaa7-41c6-84c3-f97777968ac3-2"><i class="fas fa-cat"></i>ç¼–å†™docker-compose.yml</button></li><li class="tab"><button type="button" data-href="#36348bc6-aaa7-41c6-84c3-f97777968ac3-3"><i class="fas fa-horse"></i>å¯åŠ¨</button></li><li class="tab"><button type="button" data-href="#36348bc6-aaa7-41c6-84c3-f97777968ac3-4"><i class="fas fa-dove"></i>æŸ¥çœ‹ä¸»ä»å…³ç³»</button></li><li class="tab"><button type="button" data-href="#36348bc6-aaa7-41c6-84c3-f97777968ac3-5"><i class="fas fa-dragon"></i>æŸ¥çœ‹æ˜¯å¦åŒæ­¥äº†æ•°æ®</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="36348bc6-aaa7-41c6-84c3-f97777968ac3-1"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /Users/fortune/soft/Redis</span><br><span class="line"><span class="built_in">mkdir</span> /Users/fortune/soft/Redis/data-master</span><br><span class="line"><span class="built_in">mkdir</span> /Users/fortune/soft/Redis/data-slave-1</span><br><span class="line"><span class="built_in">mkdir</span> /Users/fortune/soft/Redis/data-slave-2</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶å±‚çº§å…³ç³»</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Redis</span></span><br><span class="line">â”œâ”€â”€ <span class="class"><span class="keyword">data</span>-master </span></span><br><span class="line">â”œâ”€â”€ <span class="class"><span class="keyword">data</span>-slave-1 </span></span><br><span class="line">â”œâ”€â”€ <span class="class"><span class="keyword">data</span>-slave-2</span></span><br><span class="line">â”œâ”€â”€ docker-compose.yml</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="36348bc6-aaa7-41c6-84c3-f97777968ac3-2"><p><code>vi /Users/fortune/soft/Redis/docker-compose.yml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.1&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">master:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-master</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--port</span> <span class="number">6379</span> <span class="string">--requirepass</span> <span class="string">test</span>  <span class="string">--appendonly</span> <span class="literal">yes</span> <span class="string">--protected-mode</span> <span class="literal">no</span> <span class="string">--daemonize</span> <span class="literal">no</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6379</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data-master:/data</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">slave1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave-1</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--slaveof</span> <span class="number">8.130</span><span class="number">.68</span><span class="number">.59</span> <span class="number">6379</span> <span class="string">--port</span> <span class="number">6380</span>  <span class="string">--requirepass</span> <span class="string">test</span> <span class="string">--masterauth</span> <span class="string">test</span>  <span class="string">--appendonly</span> <span class="literal">yes</span> <span class="string">--protected-mode</span> <span class="literal">no</span> <span class="string">--daemonize</span> <span class="literal">no</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6380</span><span class="string">:6380</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data-slave-1:/data</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">slave2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave-2</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--slaveof</span> <span class="number">8.130</span><span class="number">.68</span><span class="number">.59</span> <span class="number">6379</span> <span class="string">--port</span> <span class="number">6381</span>  <span class="string">--requirepass</span> <span class="string">test</span> <span class="string">--masterauth</span> <span class="string">test</span>  <span class="string">--appendonly</span> <span class="literal">yes</span> <span class="string">--protected-mode</span> <span class="literal">no</span> <span class="string">--daemonize</span> <span class="literal">no</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6381</span><span class="string">:6381</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data-slave-2:/data</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="36348bc6-aaa7-41c6-84c3-f97777968ac3-3"><p><code>docker-compose up -d</code></p><p><mark class="hl-label red">å…³é—­</mark></p><p><code>docker-compose down</code></p><p><mark class="hl-label blue">æŸ¥çœ‹æ—¥å¿—</mark></p><p><code>docker-compose logs -f</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="36348bc6-aaa7-41c6-84c3-f97777968ac3-4"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ0jl2rei3z6qtg79h1lbeZ redis]<span class="comment"># docker exec -it redis-master /bin/bash</span></span><br><span class="line">root@39d4a5aa7ddb:/data<span class="comment"># redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt; INFO REPLICATION</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=172.20.0.1,port=6381,state=online,offset=28,lag=0</span><br><span class="line">slave1:ip=172.20.0.1,port=6380,state=online,offset=28,lag=0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:2a6869f1541acab507d59c7fc484476a6231eb10</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:28</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:28</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="36348bc6-aaa7-41c6-84c3-f97777968ac3-5"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> a 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> b 2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">exit</span></span><br><span class="line">root@39d4a5aa7ddb:/data<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">[root@iZ0jl2rei3z6qtg79h1lbeZ redis]<span class="comment"># docker exec -it redis-slave-1 /bin/bash</span></span><br><span class="line">root@6dbd2b7c1676:/data<span class="comment"># redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">&quot;b&quot;</span></span><br><span class="line">2) <span class="string">&quot;a&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="ä¸»ä»æ•°æ®åŒæ­¥åŸç†">ä¸»ä»æ•°æ®åŒæ­¥åŸç†</h3><h4 id="å…¨é‡åŒæ­¥">å…¨é‡åŒæ­¥</h4><p>ä¸»ä»ç¬¬ä¸€æ¬¡å»ºç«‹è¿æ¥æ—¶ï¼Œä¼šæ‰§è¡Œå…¨é‡åŒæ­¥ï¼Œå°†masterèŠ‚ç‚¹çš„æ‰€æœ‰æ•°æ®éƒ½æ‹·è´ç»™slaveèŠ‚ç‚¹ï¼Œ</p><p>å®Œæ•´æµç¨‹æè¿°ï¼š</p><ul><li>slaveèŠ‚ç‚¹è¯·æ±‚å¢é‡åŒæ­¥</li><li>masterèŠ‚ç‚¹åˆ¤æ–­replidï¼Œå‘ç°ä¸ä¸€è‡´ï¼Œæ‹’ç»å¢é‡åŒæ­¥ï¼Œæ‰§è¡Œå…¨é‡åŒæ­¥</li><li>masterå°†å®Œæ•´å†…å­˜æ•°æ®ç”ŸæˆRDBï¼Œå‘é€RDBåˆ°slave</li><li>slaveæ¸…ç©ºæœ¬åœ°æ•°æ®ï¼ŒåŠ è½½masterçš„RDB</li><li>masterå°†RDBæœŸé—´çš„å‘½ä»¤è®°å½•åœ¨repl_baklogï¼Œå¹¶æŒç»­å°†logä¸­çš„å‘½ä»¤å‘é€ç»™slave</li><li>slaveæ‰§è¡Œæ¥æ”¶åˆ°çš„å‘½ä»¤ï¼Œä¿æŒä¸masterä¹‹é—´çš„åŒæ­¥</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725152222497.png" alt="image-20210725152222497"></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œmasterå¦‚ä½•å¾—çŸ¥salveæ˜¯ç¬¬ä¸€æ¬¡æ¥è¿æ¥å‘¢ï¼Ÿï¼Ÿ</p><p>æœ‰å‡ ä¸ªæ¦‚å¿µï¼Œå¯ä»¥ä½œä¸ºåˆ¤æ–­ä¾æ®ï¼š</p><ul><li><strong>Replication Id</strong>ï¼šç®€ç§°replidï¼Œæ˜¯æ•°æ®é›†çš„æ ‡è®°ï¼Œidä¸€è‡´åˆ™è¯´æ˜æ˜¯åŒä¸€æ•°æ®é›†ã€‚æ¯ä¸€ä¸ªmasteréƒ½æœ‰å”¯ä¸€çš„replidï¼Œslaveåˆ™ä¼šç»§æ‰¿masterèŠ‚ç‚¹çš„replid</li><li><strong>offset</strong>ï¼šåç§»é‡ï¼Œéšç€è®°å½•åœ¨repl_baklogä¸­çš„æ•°æ®å¢å¤šè€Œé€æ¸å¢å¤§ã€‚slaveå®ŒæˆåŒæ­¥æ—¶ä¹Ÿä¼šè®°å½•å½“å‰åŒæ­¥çš„offsetã€‚å¦‚æœslaveçš„offsetå°äºmasterçš„offsetï¼Œè¯´æ˜slaveæ•°æ®è½åäºmasterï¼Œéœ€è¦æ›´æ–°ã€‚</li></ul><p>å› æ­¤slaveåšæ•°æ®åŒæ­¥ï¼Œå¿…é¡»å‘masterå£°æ˜è‡ªå·±çš„replication id å’Œoffsetï¼Œmasteræ‰å¯ä»¥åˆ¤æ–­åˆ°åº•éœ€è¦åŒæ­¥å“ªäº›æ•°æ®ã€‚</p><p>å› ä¸ºslaveåŸæœ¬ä¹Ÿæ˜¯ä¸€ä¸ªmasterï¼Œæœ‰è‡ªå·±çš„replidå’Œoffsetï¼Œå½“ç¬¬ä¸€æ¬¡å˜æˆslaveï¼Œä¸masterå»ºç«‹è¿æ¥æ—¶ï¼Œå‘é€çš„replidå’Œoffsetæ˜¯è‡ªå·±çš„replidå’Œoffsetã€‚</p><p>masteråˆ¤æ–­å‘ç°slaveå‘é€æ¥çš„replidä¸è‡ªå·±çš„ä¸ä¸€è‡´ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªå…¨æ–°çš„slaveï¼Œå°±çŸ¥é“è¦åšå…¨é‡åŒæ­¥äº†ã€‚</p><p>masterä¼šå°†è‡ªå·±çš„replidå’Œoffsetéƒ½å‘é€ç»™è¿™ä¸ªslaveï¼Œslaveä¿å­˜è¿™äº›ä¿¡æ¯ã€‚ä»¥åslaveçš„replidå°±ä¸masterä¸€è‡´äº†ã€‚</p><p>å› æ­¤ï¼Œ<strong>masteråˆ¤æ–­ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥çš„ä¾æ®ï¼Œå°±æ˜¯çœ‹replidæ˜¯å¦ä¸€è‡´</strong>ã€‚</p><hr><h4 id="å¢é‡åŒæ­¥">å¢é‡åŒæ­¥</h4><p>å…¨é‡åŒæ­¥éœ€è¦å…ˆåšRDBï¼Œç„¶åå°†RDBæ–‡ä»¶é€šè¿‡ç½‘ç»œä¼ è¾“ä¸ªslaveï¼Œæˆæœ¬å¤ªé«˜äº†ã€‚å› æ­¤é™¤äº†ç¬¬ä¸€æ¬¡åšå…¨é‡åŒæ­¥ï¼Œå…¶å®ƒå¤§å¤šæ•°æ—¶å€™slaveä¸masteréƒ½æ˜¯åš<strong>å¢é‡åŒæ­¥</strong>ã€‚</p><p>ä»€ä¹ˆæ˜¯å¢é‡åŒæ­¥ï¼Ÿå°±æ˜¯åªæ›´æ–°slaveä¸masterå­˜åœ¨å·®å¼‚çš„éƒ¨åˆ†æ•°æ®ã€‚å¦‚å›¾</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725153201086.png" alt="image-20210725153201086" style="zoom:67%;" /><hr><h4 id="repl-backlogåŸç†">repl_backlogåŸç†</h4><p>masteræ€ä¹ˆçŸ¥é“slaveä¸è‡ªå·±çš„æ•°æ®å·®å¼‚åœ¨å“ªé‡Œå‘¢?</p><p>è¿™å°±è¦è¯´åˆ°å…¨é‡åŒæ­¥æ—¶çš„repl_baklogæ–‡ä»¶äº†ã€‚</p><p>è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ªå›ºå®šå¤§å°çš„æ•°ç»„ï¼Œåªä¸è¿‡æ•°ç»„æ˜¯ç¯å½¢ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>è§’æ ‡åˆ°è¾¾æ•°ç»„æœ«å°¾åï¼Œä¼šå†æ¬¡ä»0å¼€å§‹è¯»å†™</strong>ï¼Œè¿™æ ·æ•°ç»„å¤´éƒ¨çš„æ•°æ®å°±ä¼šè¢«è¦†ç›–ã€‚</p><div class="tabs" id="0715ae52-b306-4cfd-b62c-be9d9a3465d6"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#0715ae52-b306-4cfd-b62c-be9d9a3465d6-1"><i class="fas fa-seedling"></i>1</button></li><li class="tab"><button type="button" data-href="#0715ae52-b306-4cfd-b62c-be9d9a3465d6-2"><i class="fas fa-leaf"></i>2</button></li><li class="tab"><button type="button" data-href="#0715ae52-b306-4cfd-b62c-be9d9a3465d6-3"><i class="fab fa-apple"></i>3</button></li><li class="tab"><button type="button" data-href="#0715ae52-b306-4cfd-b62c-be9d9a3465d6-4"><i class="fas fa-tree"></i>4</button></li><li class="tab"><button type="button" data-href="#0715ae52-b306-4cfd-b62c-be9d9a3465d6-5"><i class="fas fa-heartbeat"></i>5</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="0715ae52-b306-4cfd-b62c-be9d9a3465d6-1"><p>repl_baklogä¸­ä¼šè®°å½•Rediså¤„ç†è¿‡çš„å‘½ä»¤æ—¥å¿—åŠoffsetï¼ŒåŒ…æ‹¬masterå½“å‰çš„offsetï¼Œå’Œslaveå·²ç»æ‹·è´åˆ°çš„offsetï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725153359022.png" alt="image-20210725153359022"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0715ae52-b306-4cfd-b62c-be9d9a3465d6-2"><p>slaveä¸masterçš„offsetä¹‹é—´çš„å·®å¼‚ï¼Œå°±æ˜¯salveéœ€è¦å¢é‡æ‹·è´çš„æ•°æ®äº†ã€‚</p><p>éšç€ä¸æ–­æœ‰æ•°æ®å†™å…¥ï¼Œmasterçš„offseté€æ¸å˜å¤§ï¼Œslaveä¹Ÿä¸æ–­çš„æ‹·è´ï¼Œè¿½èµ¶masterçš„offsetï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725153524190.png" alt="image-20210725153524190"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0715ae52-b306-4cfd-b62c-be9d9a3465d6-3"><p>ç›´åˆ°æ•°ç»„è¢«å¡«æ»¡ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725153715910.png" alt="image-20210725153715910"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0715ae52-b306-4cfd-b62c-be9d9a3465d6-4"><p>æ­¤æ—¶ï¼Œå¦‚æœæœ‰æ–°çš„æ•°æ®å†™å…¥ï¼Œå°±ä¼šè¦†ç›–æ•°ç»„ä¸­çš„æ—§æ•°æ®ã€‚ä¸è¿‡ï¼Œæ—§çš„æ•°æ®åªè¦æ˜¯ç»¿è‰²çš„ï¼Œè¯´æ˜æ˜¯å·²ç»è¢«åŒæ­¥åˆ°slaveçš„æ•°æ®ï¼Œå³ä¾¿è¢«è¦†ç›–äº†ä¹Ÿæ²¡ä»€ä¹ˆå½±å“ã€‚å› ä¸ºæœªåŒæ­¥çš„ä»…ä»…æ˜¯çº¢è‰²éƒ¨åˆ†ã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœslaveå‡ºç°ç½‘ç»œé˜»å¡ï¼Œå¯¼è‡´masterçš„offsetè¿œè¿œè¶…è¿‡äº†slaveçš„offsetï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725153937031.png" alt="image-20210725153937031"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0715ae52-b306-4cfd-b62c-be9d9a3465d6-5"><p>å¦‚æœmasterç»§ç»­å†™å…¥æ–°æ•°æ®ï¼Œå…¶offsetå°±ä¼šè¦†ç›–æ—§çš„æ•°æ®ï¼Œç›´åˆ°å°†slaveç°åœ¨çš„offsetä¹Ÿè¦†ç›–ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725154155984.png" alt="image-20210725154155984"></p><p>æ£•è‰²æ¡†ä¸­çš„çº¢è‰²éƒ¨åˆ†ï¼Œå°±æ˜¯å°šæœªåŒæ­¥ï¼Œä½†æ˜¯å´å·²ç»è¢«è¦†ç›–çš„æ•°æ®ã€‚æ­¤æ—¶å¦‚æœslaveæ¢å¤ï¼Œéœ€è¦åŒæ­¥ï¼Œå´å‘ç°è‡ªå·±çš„offsetéƒ½æ²¡æœ‰äº†ï¼Œæ— æ³•å®Œæˆå¢é‡åŒæ­¥äº†ã€‚åªèƒ½åšå…¨é‡åŒæ­¥ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>repl_baklogå¤§å°æœ‰ä¸Šé™ï¼Œå†™æ»¡åä¼šè¦†ç›–æœ€æ—©çš„æ•°æ®ã€‚å¦‚æœslaveæ–­å¼€æ—¶é—´è¿‡ä¹…ï¼Œå¯¼è‡´å°šæœªå¤‡ä»½çš„æ•°æ®è¢«è¦†ç›–ï¼Œåˆ™æ— æ³•åŸºäºlogåšå¢é‡åŒæ­¥ï¼Œåªèƒ½å†æ¬¡å…¨é‡åŒæ­¥ã€‚</p><hr><h3 id="ä¸»ä»åŒæ­¥ä¼˜åŒ–">ä¸»ä»åŒæ­¥ä¼˜åŒ–</h3><p>ä¸»ä»åŒæ­¥å¯ä»¥ä¿è¯ä¸»ä»æ•°æ®çš„ä¸€è‡´æ€§ï¼Œéå¸¸é‡è¦ã€‚</p><p>å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥ä¼˜åŒ–Redisä¸»ä»å°±é›†ç¾¤ï¼š</p><ul><li>åœ¨masterä¸­é…ç½®repl-diskless-sync yeså¯ç”¨æ— ç£ç›˜å¤åˆ¶ï¼Œé¿å…å…¨é‡åŒæ­¥æ—¶çš„ç£ç›˜IOã€‚</li><li>Rediså•èŠ‚ç‚¹ä¸Šçš„å†…å­˜å ç”¨ä¸è¦å¤ªå¤§ï¼Œå‡å°‘RDBå¯¼è‡´çš„è¿‡å¤šç£ç›˜IO</li><li>é€‚å½“æé«˜repl_baklogçš„å¤§å°ï¼Œå‘ç°slaveå®•æœºæ—¶å°½å¿«å®ç°æ•…éšœæ¢å¤ï¼Œå°½å¯èƒ½é¿å…å…¨é‡åŒæ­¥</li><li>é™åˆ¶ä¸€ä¸ªmasterä¸Šçš„slaveèŠ‚ç‚¹æ•°é‡ï¼Œå¦‚æœå®åœ¨æ˜¯å¤ªå¤šslaveï¼Œåˆ™å¯ä»¥é‡‡ç”¨ä¸»-ä»-ä»é“¾å¼ç»“æ„ï¼Œå‡å°‘masterå‹åŠ›</li></ul><p>ä¸»ä»ä»æ¶æ„å›¾ï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725154405899.png" alt="image-20210725154405899" style="zoom: 67%;" /><hr><h3 id="å°ç»“-2">å°ç»“</h3><blockquote><p>ç®€è¿°å…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥åŒºåˆ«ï¼Ÿ</p></blockquote><ul><li>å…¨é‡åŒæ­¥ï¼šmasterå°†å®Œæ•´å†…å­˜æ•°æ®ç”ŸæˆRDBï¼Œå‘é€RDBåˆ°slaveã€‚åç»­å‘½ä»¤åˆ™è®°å½•åœ¨repl_baklogï¼Œé€ä¸ªå‘é€ç»™slaveã€‚</li><li>å¢é‡åŒæ­¥ï¼šslaveæäº¤è‡ªå·±çš„offsetåˆ°masterï¼Œmasterè·å–repl_baklogä¸­ä»offsetä¹‹åçš„å‘½ä»¤ç»™slave</li></ul><blockquote><p>ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå…¨é‡åŒæ­¥ï¼Ÿ</p></blockquote><ul><li>slaveèŠ‚ç‚¹ç¬¬ä¸€æ¬¡è¿æ¥masterèŠ‚ç‚¹æ—¶</li><li>slaveèŠ‚ç‚¹æ–­å¼€æ—¶é—´å¤ªä¹…ï¼Œrepl_baklogä¸­çš„offsetå·²ç»è¢«è¦†ç›–æ—¶</li></ul><blockquote><p>ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå¢é‡åŒæ­¥ï¼Ÿ</p></blockquote><ul><li>slaveèŠ‚ç‚¹æ–­å¼€åˆæ¢å¤ï¼Œå¹¶ä¸”åœ¨repl_baklogä¸­èƒ½æ‰¾åˆ°offsetæ—¶</li></ul><hr><hr><h2 id="Rediså“¨å…µ">Rediså“¨å…µ</h2><p>Redisæä¾›äº†å“¨å…µï¼ˆSentinelï¼‰æœºåˆ¶æ¥å®ç°ä¸»ä»é›†ç¾¤çš„è‡ªåŠ¨æ•…éšœæ¢å¤ã€‚</p><hr><h3 id="å“¨å…µä½œç”¨">å“¨å…µä½œç”¨</h3><p>å“¨å…µçš„ä½œç”¨å¦‚ä¸‹ï¼š</p><ul><li><span class='p blue'>ç›‘æ§</span>ï¼šSentinel ä¼šä¸æ–­æ£€æŸ¥æ‚¨çš„masterå’Œslaveæ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œ</li><li><span class='p red'>è‡ªåŠ¨æ•…éšœæ¢å¤</span>ï¼šå¦‚æœmasteræ•…éšœï¼ŒSentinelä¼šå°†ä¸€ä¸ªslaveæå‡ä¸ºmasterã€‚å½“æ•…éšœå®ä¾‹æ¢å¤åä¹Ÿä»¥æ–°çš„masterä¸ºä¸»</li><li><span class='p green'>æœåŠ¡å‘ç°æ¥æº</span>ï¼šSentinelå……å½“Rediså®¢æˆ·ç«¯çš„æœåŠ¡å‘ç°æ¥æºï¼Œå½“é›†ç¾¤å‘ç”Ÿæ•…éšœè½¬ç§»æ—¶ï¼Œä¼šå°†æœ€æ–°ä¿¡æ¯æ¨é€ç»™Redisçš„å®¢æˆ·ç«¯</li></ul><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725154528072.png" alt="image-20210725154528072" style="zoom:67%;" /><hr><h3 id="é›†ç¾¤ç›‘æ§">é›†ç¾¤ç›‘æ§</h3><p>SentinelåŸºäºå¿ƒè·³æœºåˆ¶ç›‘æµ‹æœåŠ¡çŠ¶æ€ï¼Œæ¯éš”1ç§’å‘é›†ç¾¤çš„æ¯ä¸ªå®ä¾‹å‘é€pingå‘½ä»¤ï¼Œå“¨å…µå…ˆç›‘å¬ä¸»ï¼Œé€šè¿‡å¯¹ä¸»å‘é€infoå‘½ä»¤ï¼Œè·å–åˆ°ä»çš„ä¿¡æ¯ï¼Œç„¶åä¹Ÿä¼šç›‘å¬åˆ°ä»ã€‚</p><p>ä¸»è§‚ä¸‹çº¿ï¼šå¦‚æœæŸsentinelèŠ‚ç‚¹å‘ç°æŸå®ä¾‹æœªåœ¨è§„å®šæ—¶é—´å“åº”ï¼Œåˆ™è®¤ä¸ºè¯¥å®ä¾‹<span class='p blue'>ä¸»è§‚ä¸‹çº¿</span>ã€‚</p><p>å®¢è§‚ä¸‹çº¿ï¼šè‹¥è¶…è¿‡æŒ‡å®šæ•°é‡ï¼ˆquorumï¼‰çš„sentineléƒ½è®¤ä¸ºè¯¥å®ä¾‹ä¸»è§‚ä¸‹çº¿ï¼Œåˆ™è¯¥å®ä¾‹<span class='p blue'>å®¢è§‚ä¸‹çº¿</span>ã€‚quorumå€¼æœ€å¥½è¶…è¿‡Sentinelå®ä¾‹æ•°é‡çš„ä¸€åŠã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725154632354.png" alt="image-20210725154632354" style="zoom:67%;" /><hr><h3 id="é›†ç¾¤æ•…éšœæ¢å¤">é›†ç¾¤æ•…éšœæ¢å¤</h3><p>ä¸€æ—¦å‘ç°masteræ•…éšœï¼Œsentineléœ€è¦åœ¨salveä¸­é€‰æ‹©ä¸€ä¸ªä½œä¸ºæ–°çš„masterï¼Œé€‰æ‹©ä¾æ®æ˜¯è¿™æ ·çš„ï¼š</p><ul><li>é¦–å…ˆä¼šåˆ¤æ–­slaveèŠ‚ç‚¹ä¸masterèŠ‚ç‚¹æ–­å¼€æ—¶é—´é•¿çŸ­ï¼Œå¦‚æœè¶…è¿‡æŒ‡å®šå€¼ï¼ˆdown-after-milliseconds * 10ï¼‰åˆ™ä¼šæ’é™¤è¯¥slaveèŠ‚ç‚¹</li><li>ç„¶ååˆ¤æ–­slaveèŠ‚ç‚¹çš„slave-priorityå€¼ï¼Œè¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œå¦‚æœæ˜¯0åˆ™æ°¸ä¸å‚ä¸é€‰ä¸¾</li><li>å¦‚æœslave-prorityä¸€æ ·ï¼Œåˆ™åˆ¤æ–­slaveèŠ‚ç‚¹çš„offsetå€¼ï¼Œè¶Šå¤§è¯´æ˜æ•°æ®è¶Šæ–°ï¼Œä¼˜å…ˆçº§è¶Šé«˜</li><li>æœ€åæ˜¯åˆ¤æ–­slaveèŠ‚ç‚¹çš„è¿è¡Œidå¤§å°ï¼Œè¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚</li></ul><p>å½“é€‰å‡ºä¸€ä¸ªæ–°çš„masteråï¼Œè¯¥å¦‚ä½•å®ç°åˆ‡æ¢å‘¢ï¼Ÿ</p><mark class="hl-label blue">æµç¨‹å¦‚ä¸‹</mark> <ul><li>sentinelç»™å¤‡é€‰çš„slave1èŠ‚ç‚¹å‘é€slaveof no oneå‘½ä»¤ï¼Œè®©è¯¥èŠ‚ç‚¹æˆä¸ºmaster</li><li>sentinelç»™æ‰€æœ‰å…¶å®ƒslaveå‘é€slaveofå‘½ä»¤ï¼Œè®©è¿™äº›slaveæˆä¸ºæ–°masterçš„ä»èŠ‚ç‚¹ï¼Œå¼€å§‹ä»æ–°çš„masterä¸ŠåŒæ­¥æ•°æ®ã€‚</li><li>æœ€åï¼Œsentinelå°†æ•…éšœèŠ‚ç‚¹æ ‡è®°ä¸ºslaveï¼Œå½“æ•…éšœèŠ‚ç‚¹æ¢å¤åä¼šè‡ªåŠ¨æˆä¸ºæ–°çš„masterçš„slaveèŠ‚ç‚¹</li></ul><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725154816841.png" alt="image-20210725154816841" style="zoom:67%;" /><hr><h3 id="æ­å»ºå“¨å…µé›†ç¾¤">æ­å»ºå“¨å…µé›†ç¾¤</h3><p>ä¸‰ä¸ªsentinelå®ä¾‹ä¿¡æ¯å¦‚ä¸‹ï¼š</p><table><thead><tr><th>èŠ‚ç‚¹</th><th style="text-align:center">IP</th><th style="text-align:center">PORT</th></tr></thead><tbody><tr><td>s1</td><td style="text-align:center">8.130.68.59</td><td style="text-align:center">26379</td></tr><tr><td>s2</td><td style="text-align:center">8.130.68.59</td><td style="text-align:center">26380</td></tr><tr><td>s3</td><td style="text-align:center">8.130.68.59</td><td style="text-align:center">26381</td></tr></tbody></table><div class="tabs" id="801339e8-ef40-4cba-ae84-d2003c9067f9"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#801339e8-ef40-4cba-ae84-d2003c9067f9-1"><i class="fas fa-bug"></i>ç¼–å†™docker-compose.yml</button></li><li class="tab"><button type="button" data-href="#801339e8-ef40-4cba-ae84-d2003c9067f9-2"><i class="fas fa-cannabis"></i>åˆ›å»ºé…ç½®æ–‡ä»¶</button></li><li class="tab"><button type="button" data-href="#801339e8-ef40-4cba-ae84-d2003c9067f9-3"><i class="fas fa-candy-cane"></i>å¯åŠ¨</button></li><li class="tab"><button type="button" data-href="#801339e8-ef40-4cba-ae84-d2003c9067f9-4"><i class="fas fa-child"></i>æŸ¥çœ‹å“¨å…µå…³ç³»</button></li><li class="tab"><button type="button" data-href="#801339e8-ef40-4cba-ae84-d2003c9067f9-5"><i class="fas fa-cookie-bite"></i>éªŒè¯æ•…éšœæ¢å¤</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="801339e8-ef40-4cba-ae84-d2003c9067f9-1"><p><code>mkdir -p /Users/fortune/soft/sentinel</code></p><p><code>vi /Users/fortune/soft/sentinel/docker-compose.yml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.1&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis-sentinel-1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-sentinel-1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">26379</span><span class="string">:26379</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-sentinel</span> <span class="string">/user/local/etc/redis/sentinel.conf</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sentinel1.conf:/user/local/etc/redis/sentinel.conf</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis-sentinel-2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-sentinel-2</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">26380</span><span class="string">:26379</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-sentinel</span> <span class="string">/user/local/etc/redis/sentinel.conf</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sentinel2.conf:/user/local/etc/redis/sentinel.conf</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis-sentinel-3:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-sentinel-3</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">26381</span><span class="string">:26379</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-sentinel</span> <span class="string">/user/local/etc/redis/sentinel.conf</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sentinel3.conf:/user/local/etc/redis/sentinel.conf</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="801339e8-ef40-4cba-ae84-d2003c9067f9-2"><p><code>vi /opt/docker/sentinel/sentinel1.conf</code></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">port</span> <span class="string">26379</span></span><br><span class="line"><span class="attr">daemonize</span> <span class="string">no</span></span><br><span class="line"><span class="attr">dir</span> <span class="string">/tmp</span></span><br><span class="line"><span class="comment"># è‡ªå®šä¹‰é›†ç¾¤åï¼Œå…¶ä¸­ 8.130.68.59 ä¸º redis-master çš„ ipï¼Œ6379 ä¸º redis-master çš„ç«¯å£ï¼Œ2 ä¸ºæœ€å°æŠ•ç¥¨æ•°ï¼ˆå› ä¸ºæœ‰ 3 å° Sentinel æ‰€ä»¥å¯ä»¥è®¾ç½®æˆ 2ï¼‰</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">monitor mymaster 8.130.68.59 6379 2</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">down-after-milliseconds mymaster 30000</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">parallel-syncs mymaster 1</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">auth-pass mymaster test</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">failover-timeout mymaster 180000</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">deny-scripts-reconfig yes</span></span><br></pre></td></tr></table></figure><p><code>vi /opt/docker/sentinel/sentinel2.conf</code></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">port</span> <span class="string">26380</span></span><br><span class="line"><span class="attr">daemonize</span> <span class="string">no</span></span><br><span class="line"><span class="attr">dir</span> <span class="string">/tmp</span></span><br><span class="line"><span class="comment"># è‡ªå®šä¹‰é›†ç¾¤åï¼Œå…¶ä¸­ 8.130.68.59 ä¸º redis-master çš„ ipï¼Œ6379 ä¸º redis-master çš„ç«¯å£ï¼Œ2 ä¸ºæœ€å°æŠ•ç¥¨æ•°ï¼ˆå› ä¸ºæœ‰ 3 å° Sentinel æ‰€ä»¥å¯ä»¥è®¾ç½®æˆ 2ï¼‰</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">monitor mymaster 8.130.68.59 6379 2</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">down-after-milliseconds mymaster 30000</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">parallel-syncs mymaster 1</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">auth-pass mymaster test</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">failover-timeout mymaster 180000</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">deny-scripts-reconfig yes</span></span><br></pre></td></tr></table></figure><p><code>vi /opt/docker/sentinel/sentinel3.conf</code></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">port</span> <span class="string">26381</span></span><br><span class="line"><span class="attr">daemonize</span> <span class="string">no</span></span><br><span class="line"><span class="attr">dir</span> <span class="string">/tmp</span></span><br><span class="line"><span class="comment"># è‡ªå®šä¹‰é›†ç¾¤åï¼Œå…¶ä¸­ 8.130.68.59 ä¸º redis-master çš„ ipï¼Œ6379 ä¸º redis-master çš„ç«¯å£ï¼Œ2 ä¸ºæœ€å°æŠ•ç¥¨æ•°ï¼ˆå› ä¸ºæœ‰ 3 å° Sentinel æ‰€ä»¥å¯ä»¥è®¾ç½®æˆ 2ï¼‰</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">monitor mymaster 8.130.68.59 6379 2</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">down-after-milliseconds mymaster 30000</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">parallel-syncs mymaster 1</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">auth-pass mymaster test</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">failover-timeout mymaster 180000</span></span><br><span class="line"><span class="attr">sentinel</span> <span class="string">deny-scripts-reconfig yes</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="801339e8-ef40-4cba-ae84-d2003c9067f9-3"><p><code>docker-compose up -d</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="801339e8-ef40-4cba-ae84-d2003c9067f9-4"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ0jl2rei3z6qtg79h1lbeZ sentinel]<span class="comment"># docker exec -it redis-sentinel-1 /bin/bash</span></span><br><span class="line">root@3d95304a04ff:/data<span class="comment"># redis-cli -p 26379</span></span><br><span class="line">127.0.0.1:26379&gt; INFO SENTINEL</span><br><span class="line"><span class="comment"># Sentinel</span></span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">sentinel_simulate_failure_flags:0</span><br><span class="line">master0:name=mymaster,status=ok,address=10.132.75.15:6379,slaves=2,sentinels=3</span><br></pre></td></tr></table></figure><p>æ„æ€æ˜¯xxxè¿™ä¸ªé›†ç¾¤å½“å‰çŠ¶æ€æ˜¯okçš„ï¼Œå½“å‰ä¸»redisæ˜¯6379ï¼Œæœ‰2ä¸ªä»redisï¼Œ 3ä¸ªsentinel</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="801339e8-ef40-4cba-ae84-d2003c9067f9-5"><p>å°è¯•è®©master7001èŠ‚ç‚¹å®•æœºï¼ŒæŸ¥çœ‹sentinelæ—¥å¿—ï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210701222857997.png" alt="image-20210701222857997" style="zoom:67%;" /><p>æŸ¥çœ‹7003çš„æ—¥å¿—ï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210701223025709.png" alt="image-20210701223025709" style="zoom:67%;" /><p>æŸ¥çœ‹7002çš„æ—¥å¿—ï¼š</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210701223131264.png" alt="image-20210701223131264" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="RedisTemplate">RedisTemplate</h3><p>åœ¨Sentinelé›†ç¾¤ç›‘ç®¡ä¸‹çš„Redisä¸»ä»é›†ç¾¤ï¼Œå…¶èŠ‚ç‚¹ä¼šå› ä¸ºè‡ªåŠ¨æ•…éšœè½¬ç§»è€Œå‘ç”Ÿå˜åŒ–ï¼ŒRedisçš„å®¢æˆ·ç«¯å¿…é¡»æ„ŸçŸ¥è¿™ç§å˜åŒ–ï¼ŒåŠæ—¶æ›´æ–°è¿æ¥ä¿¡æ¯ã€‚Springçš„RedisTemplateåº•å±‚åˆ©ç”¨lettuceå®ç°äº†èŠ‚ç‚¹çš„æ„ŸçŸ¥å’Œè‡ªåŠ¨åˆ‡æ¢ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªæµ‹è¯•æ¥å®ç°RedisTemplateé›†æˆå“¨å…µæœºåˆ¶ã€‚</p><div class="tabs" id="ff1a06f6-f9a8-4235-9707-f3b456739ae1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ff1a06f6-f9a8-4235-9707-f3b456739ae1-1"><i class="fas fa-cat"></i>å¼•å…¥ä¾èµ–</button></li><li class="tab"><button type="button" data-href="#ff1a06f6-f9a8-4235-9707-f3b456739ae1-2"><i class="fas fa-horse"></i>é…ç½®Redisåœ°å€</button></li><li class="tab"><button type="button" data-href="#ff1a06f6-f9a8-4235-9707-f3b456739ae1-3"><i class="fas fa-dove"></i>é…ç½®è¯»å†™åˆ†ç¦»</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ff1a06f6-f9a8-4235-9707-f3b456739ae1-1"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ff1a06f6-f9a8-4235-9707-f3b456739ae1-2"><p>ç„¶ååœ¨é…ç½®æ–‡ä»¶application.ymlä¸­æŒ‡å®šredisçš„sentinelç›¸å…³ä¿¡æ¯ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">master:</span> <span class="string">mymaster</span></span><br><span class="line">      <span class="attr">nodes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span><span class="string">:27001</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span><span class="string">:27002</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span><span class="string">:27003</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ff1a06f6-f9a8-4235-9707-f3b456739ae1-3"><p>åœ¨é¡¹ç›®çš„å¯åŠ¨ç±»ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªæ–°çš„beanï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> LettuceClientConfigurationBuilderCustomizer <span class="title function_">clientConfigurationBuilderCustomizer</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> clientConfigurationBuilder -&gt; clientConfigurationBuilder.readFrom(ReadFrom.REPLICA_PREFERRED);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªbeanä¸­é…ç½®çš„å°±æ˜¯è¯»å†™ç­–ç•¥ï¼ŒåŒ…æ‹¬å››ç§ï¼š</p><ul><li><code>MASTER</code>ï¼šä»ä¸»èŠ‚ç‚¹è¯»å–</li><li><code>MASTER_PREFERRED</code>ï¼šä¼˜å…ˆä»masterèŠ‚ç‚¹è¯»å–ï¼Œmasterä¸å¯ç”¨æ‰è¯»å–replica</li><li><code>REPLICA</code>ï¼šä»slaveï¼ˆreplicaï¼‰èŠ‚ç‚¹è¯»å–</li><li><code>REPLICA _PREFERRED</code>ï¼šä¼˜å…ˆä»slaveï¼ˆreplicaï¼‰èŠ‚ç‚¹è¯»å–ï¼Œæ‰€æœ‰çš„slaveéƒ½ä¸å¯ç”¨æ‰è¯»å–master</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="Redisåˆ†ç‰‡é›†ç¾¤">Redisåˆ†ç‰‡é›†ç¾¤</h2><h3 id="æ­å»ºåˆ†ç‰‡é›†ç¾¤">æ­å»ºåˆ†ç‰‡é›†ç¾¤</h3><p>ä¸»ä»å’Œå“¨å…µå¯ä»¥è§£å†³é«˜å¯ç”¨ã€é«˜å¹¶å‘è¯»çš„é—®é¢˜ã€‚ä½†æ˜¯ä¾ç„¶æœ‰ä¸¤ä¸ªé—®é¢˜æ²¡æœ‰è§£å†³ï¼š</p><ul><li><p>æµ·é‡æ•°æ®å­˜å‚¨é—®é¢˜</p></li><li><p>é«˜å¹¶å‘å†™çš„é—®é¢˜</p></li></ul><p>ä½¿ç”¨åˆ†ç‰‡é›†ç¾¤å¯ä»¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå¦‚å›¾:</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725155747294.png" alt="image-20210725155747294" style="zoom:67%;" /><p>åˆ†ç‰‡é›†ç¾¤ç‰¹å¾ï¼š</p><ul><li><p>é›†ç¾¤ä¸­æœ‰å¤šä¸ªmasterï¼Œæ¯ä¸ªmasterä¿å­˜ä¸åŒæ•°æ®</p></li><li><p>æ¯ä¸ªmasteréƒ½å¯ä»¥æœ‰å¤šä¸ªslaveèŠ‚ç‚¹</p></li><li><p>masterä¹‹é—´é€šè¿‡pingç›‘æµ‹å½¼æ­¤å¥åº·çŠ¶æ€</p></li><li><p>å®¢æˆ·ç«¯è¯·æ±‚å¯ä»¥è®¿é—®é›†ç¾¤ä»»æ„èŠ‚ç‚¹ï¼Œæœ€ç»ˆéƒ½ä¼šè¢«è½¬å‘åˆ°æ­£ç¡®èŠ‚ç‚¹</p></li></ul><div class="tabs" id="2521cf50-4acc-47a1-84f0-c94d915192a9"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2521cf50-4acc-47a1-84f0-c94d915192a9-1"><i class="fas fa-seedling"></i>åˆ›å»ºæ¨¡ç‰ˆ</button></li><li class="tab"><button type="button" data-href="#2521cf50-4acc-47a1-84f0-c94d915192a9-2"><i class="fas fa-leaf"></i>ç”Ÿæˆ</button></li><li class="tab"><button type="button" data-href="#2521cf50-4acc-47a1-84f0-c94d915192a9-3"><i class="fab fa-apple"></i>ç¼–å†™docker-compose.yml</button></li><li class="tab"><button type="button" data-href="#2521cf50-4acc-47a1-84f0-c94d915192a9-4"><i class="fas fa-tree"></i>å¯åŠ¨ç»“æœ</button></li><li class="tab"><button type="button" data-href="#2521cf50-4acc-47a1-84f0-c94d915192a9-5"><i class="fas fa-heartbeat"></i>é›†ç¾¤é…ç½®</button></li><li class="tab"><button type="button" data-href="#2521cf50-4acc-47a1-84f0-c94d915192a9-6"><i class="fas fa-cookie-bite"></i>é›†ç¾¤æµ‹è¯•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2521cf50-4acc-47a1-84f0-c94d915192a9-1"><p><code>redis-cluster.tmpl</code></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redisç«¯å£</span></span><br><span class="line"><span class="attr">port</span> <span class="string">$&#123;PORT&#125;</span></span><br><span class="line"><span class="comment">#redis è®¿é—®å¯†ç </span></span><br><span class="line"><span class="attr">requirepass</span> <span class="string">123456</span></span><br><span class="line"><span class="comment">#redis è®¿é—®MasterèŠ‚ç‚¹å¯†ç </span></span><br><span class="line"><span class="attr">masterauth</span> <span class="string">123456</span></span><br><span class="line"><span class="comment"># å…³é—­ä¿æŠ¤æ¨¡å¼</span></span><br><span class="line"><span class="attr">protected-mode</span> <span class="string">no</span></span><br><span class="line"><span class="comment"># å¼€å¯é›†ç¾¤</span></span><br><span class="line"><span class="attr">cluster-enabled</span> <span class="string">yes</span></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹é…ç½®</span></span><br><span class="line"><span class="attr">cluster-config-file</span> <span class="string">nodes.conf</span></span><br><span class="line"><span class="comment"># è¶…æ—¶</span></span><br><span class="line"><span class="attr">cluster-node-timeout</span> <span class="string">5000</span></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹IP hostæ¨¡å¼ä¸ºå®¿ä¸»æœºIP</span></span><br><span class="line"><span class="attr">cluster-announce-ip</span> <span class="string">10.133.19.15</span></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹ç«¯å£ 7001 - 7006</span></span><br><span class="line"><span class="attr">cluster-announce-port</span> <span class="string">$&#123;PORT&#125;</span></span><br><span class="line"><span class="attr">cluster-announce-bus-port</span> <span class="string">1$&#123;PORT&#125;</span></span><br><span class="line"><span class="comment"># å¼€å¯ appendonly å¤‡ä»½æ¨¡å¼</span></span><br><span class="line"><span class="attr">appendonly</span> <span class="string">yes</span></span><br><span class="line"><span class="comment"># æ¯ç§’é’Ÿå¤‡ä»½</span></span><br><span class="line"><span class="attr">appendfsync</span> <span class="string">everysec</span></span><br><span class="line"><span class="comment"># å¯¹aofæ–‡ä»¶è¿›è¡Œå‹ç¼©æ—¶ï¼Œæ˜¯å¦æ‰§è¡ŒåŒæ­¥æ“ä½œ</span></span><br><span class="line"><span class="attr">no-appendfsync-on-rewrite</span> <span class="string">no</span></span><br><span class="line"><span class="comment"># å½“ç›®å‰aofæ–‡ä»¶å¤§å°è¶…è¿‡ä¸Šä¸€æ¬¡é‡å†™æ—¶çš„aofæ–‡ä»¶å¤§å°çš„100%æ—¶ä¼šå†æ¬¡è¿›è¡Œé‡å†™</span></span><br><span class="line"><span class="attr">auto-aof-rewrite-percentage</span> <span class="string">100</span></span><br><span class="line"><span class="comment"># é‡å†™å‰AOFæ–‡ä»¶çš„å¤§å°æœ€å°å€¼ é»˜è®¤ 64mb</span></span><br><span class="line"><span class="attr">auto-aof-rewrite-min-size</span> <span class="string">64mb</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># æ—¥å¿—é…ç½®</span></span><br><span class="line"><span class="comment"># de<span class="doctag">bug:</span>ä¼šæ‰“å°ç”Ÿæˆå¤§é‡ä¿¡æ¯ï¼Œé€‚ç”¨äºå¼€å‘/æµ‹è¯•é˜¶æ®µ</span></span><br><span class="line"><span class="comment"># verbose:åŒ…å«å¾ˆå¤šä¸å¤ªæœ‰ç”¨çš„ä¿¡æ¯ï¼Œä½†æ˜¯ä¸åƒdebugçº§åˆ«é‚£ä¹ˆæ··ä¹±</span></span><br><span class="line"><span class="comment"># notice:é€‚åº¦å†—é•¿ï¼Œé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒ</span></span><br><span class="line"><span class="comment"># warning:ä»…è®°å½•éå¸¸é‡è¦ã€å…³é”®çš„è­¦å‘Šæ¶ˆæ¯</span></span><br><span class="line"><span class="attr">loglevel</span> <span class="string">notice</span></span><br><span class="line"><span class="comment"># æ—¥å¿—æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="attr">logfile</span> <span class="string">&quot;/data/redis.log&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2521cf50-4acc-47a1-84f0-c94d915192a9-2"><p>ç”±äºèŠ‚ç‚¹IPç›¸åŒï¼Œåªæœ‰ç«¯å£ä¸Šçš„å·®åˆ«ï¼Œç°åœ¨é€šè¿‡è„šæœ¬ <code>redis-cluster-config.sh</code> æ‰¹é‡ç”Ÿæˆé…ç½®æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for port in `seq 7001 7006`; do \</span><br><span class="line">  mkdir -p ./$&#123;port&#125;/conf \</span><br><span class="line">  &amp;&amp; PORT=$&#123;port&#125; envsubst &lt; ./redis-cluster.tmpl &gt; ./$&#123;port&#125;/conf/redis.conf \</span><br><span class="line">  &amp;&amp; mkdir -p ./$&#123;port&#125;/data; \</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆçš„é…ç½®æ–‡ä»¶å¦‚ä¸‹å›¾</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ <span class="number">7001</span></span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ conf</span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ â”œâ”€â”€ redis<span class="selector-class">.conf</span></span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ data</span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ â”œâ”€â”€ appendonly<span class="selector-class">.aof</span></span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ â”œâ”€â”€ nodes<span class="selector-class">.conf</span></span><br><span class="line">â”œâ”€â”€ <span class="number">7002</span></span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ conf</span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ â”œâ”€â”€ redis<span class="selector-class">.conf</span></span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ data</span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ â”œâ”€â”€ appendonly<span class="selector-class">.aof</span></span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ â”œâ”€â”€ nodes<span class="selector-class">.conf</span></span><br><span class="line">â”œâ”€â”€ <span class="number">7003</span></span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ conf</span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ â”œâ”€â”€ redis<span class="selector-class">.conf</span></span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ data</span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ â”œâ”€â”€ appendonly<span class="selector-class">.aof</span></span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ â”œâ”€â”€ nodes<span class="selector-class">.conf</span></span><br><span class="line">â”œâ”€â”€ <span class="number">7004</span></span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ conf</span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ â”œâ”€â”€ redis<span class="selector-class">.conf</span></span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ data</span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ â”œâ”€â”€ appendonly<span class="selector-class">.aof</span></span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ â”œâ”€â”€ nodes<span class="selector-class">.conf</span></span><br><span class="line">â”œâ”€â”€ <span class="number">7005</span></span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ conf</span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ â”œâ”€â”€ redis<span class="selector-class">.conf</span></span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ data</span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ â”œâ”€â”€ appendonly<span class="selector-class">.aof</span></span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ â”œâ”€â”€ nodes<span class="selector-class">.conf</span></span><br><span class="line">â”œâ”€â”€ <span class="number">7006</span></span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ conf</span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ â”œâ”€â”€ redis<span class="selector-class">.conf</span></span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ data</span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ â”œâ”€â”€ appendonly<span class="selector-class">.aof</span></span><br><span class="line">â”œâ”€â”€ â”œâ”€â”€ â”œâ”€â”€ nodes.conf</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2521cf50-4acc-47a1-84f0-c94d915192a9-3"><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.1&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis7001:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis7001</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/etc/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./7001/conf/redis.conf:/usr/local/etc/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./7001/data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;7001:7001&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;17001:17001&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="comment"># è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·ï¼Œå¦åˆ™æ—¶é—´ä¼šæœ‰é—®é¢˜</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">logging:</span></span><br><span class="line">      <span class="attr">options:</span></span><br><span class="line">        <span class="attr">max-size:</span> <span class="string">&#x27;100m&#x27;</span></span><br><span class="line">        <span class="attr">max-file:</span> <span class="string">&#x27;10&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis7002:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis7002</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/etc/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./7002/conf/redis.conf:/usr/local/etc/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./7002/data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;7002:7002&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;17002:17002&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="comment"># è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·ï¼Œå¦åˆ™æ—¶é—´ä¼šæœ‰é—®é¢˜</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">logging:</span></span><br><span class="line">      <span class="attr">options:</span></span><br><span class="line">        <span class="attr">max-size:</span> <span class="string">&#x27;100m&#x27;</span></span><br><span class="line">        <span class="attr">max-file:</span> <span class="string">&#x27;10&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis7003:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis7003</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/etc/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./7003/conf/redis.conf:/usr/local/etc/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./7003/data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;7003:7003&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;17003:17003&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="comment"># è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·ï¼Œå¦åˆ™æ—¶é—´ä¼šæœ‰é—®é¢˜</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">logging:</span></span><br><span class="line">      <span class="attr">options:</span></span><br><span class="line">        <span class="attr">max-size:</span> <span class="string">&#x27;100m&#x27;</span></span><br><span class="line">        <span class="attr">max-file:</span> <span class="string">&#x27;10&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis7004:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis7004</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/etc/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./7004/conf/redis.conf:/usr/local/etc/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./7004/data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;7004:7004&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;17004:17004&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="comment"># è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·ï¼Œå¦åˆ™æ—¶é—´ä¼šæœ‰é—®é¢˜</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">logging:</span></span><br><span class="line">      <span class="attr">options:</span></span><br><span class="line">        <span class="attr">max-size:</span> <span class="string">&#x27;100m&#x27;</span></span><br><span class="line">        <span class="attr">max-file:</span> <span class="string">&#x27;10&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis7005:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis7005</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/etc/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./7005/conf/redis.conf:/usr/local/etc/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./7005/data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;7005:7005&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;17005:17005&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="comment"># è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·ï¼Œå¦åˆ™æ—¶é—´ä¼šæœ‰é—®é¢˜</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">logging:</span></span><br><span class="line">      <span class="attr">options:</span></span><br><span class="line">        <span class="attr">max-size:</span> <span class="string">&#x27;100m&#x27;</span></span><br><span class="line">        <span class="attr">max-file:</span> <span class="string">&#x27;10&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis7006:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis7006</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/etc/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./7006/conf/redis.conf:/usr/local/etc/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./7006/data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;7006:7006&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;17006:17006&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="comment"># è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·ï¼Œå¦åˆ™æ—¶é—´ä¼šæœ‰é—®é¢˜</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">logging:</span></span><br><span class="line">      <span class="attr">options:</span></span><br><span class="line">        <span class="attr">max-size:</span> <span class="string">&#x27;100m&#x27;</span></span><br><span class="line">        <span class="attr">max-file:</span> <span class="string">&#x27;10&#x27;</span></span><br><span class="line">        </span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">app_net:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2521cf50-4acc-47a1-84f0-c94d915192a9-4"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~/soft/Redis-Cluster via ğŸ³ desktop-linux</span><br><span class="line">â¯ docker-compose up -d</span><br><span class="line">[+] Running 7/7</span><br><span class="line"> â ¿ Network redis-cluster_default  Creat...                                 0.0s</span><br><span class="line"> â ¿ Container redis7003            Started                                  1.0s</span><br><span class="line"> â ¿ Container redis7005            Started                                  1.1s</span><br><span class="line"> â ¿ Container redis7004            Started                                  1.0s</span><br><span class="line"> â ¿ Container redis7001            Started                                  1.1s</span><br><span class="line"> â ¿ Container redis7002            Started                                  1.1s</span><br><span class="line"> â ¿ Container redis7006            Started                                  0.7s</span><br><span class="line"></span><br><span class="line">~/soft/Redis-Cluster via ğŸ³ desktop-linux</span><br><span class="line">â¯ docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS                                                        NAMES</span><br><span class="line">8330e7075b43   redis     <span class="string">&quot;docker-entrypoint.sâ€¦&quot;</span>   5 seconds ago   Up 4 seconds   0.0.0.0:7006-&gt;7006/tcp, 6379/tcp, 0.0.0.0:17006-&gt;17006/tcp   redis7006</span><br><span class="line">6e579503b917   redis     <span class="string">&quot;docker-entrypoint.sâ€¦&quot;</span>   5 seconds ago   Up 3 seconds   0.0.0.0:7004-&gt;7004/tcp, 6379/tcp, 0.0.0.0:17004-&gt;17004/tcp   redis7004</span><br><span class="line">e1d71b56d58f   redis     <span class="string">&quot;docker-entrypoint.sâ€¦&quot;</span>   5 seconds ago   Up 3 seconds   0.0.0.0:7005-&gt;7005/tcp, 6379/tcp, 0.0.0.0:17005-&gt;17005/tcp   redis7005</span><br><span class="line">b7ef20ba118b   redis     <span class="string">&quot;docker-entrypoint.sâ€¦&quot;</span>   5 seconds ago   Up 3 seconds   0.0.0.0:7001-&gt;7001/tcp, 6379/tcp, 0.0.0.0:17001-&gt;17001/tcp   redis7001</span><br><span class="line">d16f79a838b2   redis     <span class="string">&quot;docker-entrypoint.sâ€¦&quot;</span>   5 seconds ago   Up 4 seconds   0.0.0.0:7003-&gt;7003/tcp, 6379/tcp, 0.0.0.0:17003-&gt;17003/tcp   redis7003</span><br><span class="line">f8845d83564e   redis     <span class="string">&quot;docker-entrypoint.sâ€¦&quot;</span>   5 seconds ago   Up 3 seconds   0.0.0.0:7002-&gt;7002/tcp, 6379/tcp, 0.0.0.0:17002-&gt;17002/tcp   redis7002</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2521cf50-4acc-47a1-84f0-c94d915192a9-5"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">~/soft/Redis-Cluster via ğŸ³ desktop-linux</span><br><span class="line">â¯ docker <span class="built_in">exec</span> -it redis7001 redis-cli -p 7001 -a 123456 --cluster create 10.133.19.15:7001 10.133.19.15:7002 10.133.19.15:7003 10.133.19.15:7004 10.133.19.15:7005 10.133.19.15:7006 --cluster-replicas 1</span><br><span class="line">Warning: Using a password with <span class="string">&#x27;-a&#x27;</span> or <span class="string">&#x27;-u&#x27;</span> option on the <span class="built_in">command</span> line interface may not be safe.</span><br><span class="line">&gt;&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 6 nodes...</span><br><span class="line">Master[0] -&gt; Slots 0 - 5460</span><br><span class="line">Master[1] -&gt; Slots 5461 - 10922</span><br><span class="line">Master[2] -&gt; Slots 10923 - 16383</span><br><span class="line">Adding replica 10.133.19.15:7005 to 10.133.19.15:7001</span><br><span class="line">Adding replica 10.133.19.15:7006 to 10.133.19.15:7002</span><br><span class="line">Adding replica 10.133.19.15:7004 to 10.133.19.15:7003</span><br><span class="line">&gt;&gt;&gt; Trying to optimize slaves allocation <span class="keyword">for</span> anti-affinity</span><br><span class="line">[WARNING] Some slaves are <span class="keyword">in</span> the same host as their master</span><br><span class="line">M: 35d61c095bb5b8abf8bed68141fe002b47bf9981 10.133.19.15:7001</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">M: a55c33ac21e5ccb1a2d4978c2d79ab7ffb33e768 10.133.19.15:7002</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">M: 19c1b2b936a3dc0c7ed6a19105cd47b8ce5a1ee1 10.133.19.15:7003</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">S: af737cd5aebf58561a50f285b9729b7bced0096e 10.133.19.15:7004</span><br><span class="line">   replicates 35d61c095bb5b8abf8bed68141fe002b47bf9981</span><br><span class="line">S: a27a6620278382087b46f8f1b3933bcb50ef891a 10.133.19.15:7005</span><br><span class="line">   replicates a55c33ac21e5ccb1a2d4978c2d79ab7ffb33e768</span><br><span class="line">S: b52a607f01278bd84e0caa689b7cc9f4e1381d84 10.133.19.15:7006</span><br><span class="line">   replicates 19c1b2b936a3dc0c7ed6a19105cd47b8ce5a1ee1</span><br><span class="line">Can I <span class="built_in">set</span> the above configuration? (<span class="built_in">type</span> <span class="string">&#x27;yes&#x27;</span> to accept): <span class="built_in">yes</span></span><br><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to <span class="built_in">join</span> the cluster</span><br><span class="line">Waiting <span class="keyword">for</span> the cluster to <span class="built_in">join</span></span><br><span class="line">....</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.133.19.15:7001)</span><br><span class="line">M: 35d61c095bb5b8abf8bed68141fe002b47bf9981 10.133.19.15:7001</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 19c1b2b936a3dc0c7ed6a19105cd47b8ce5a1ee1 10.133.19.15:7003</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: a27a6620278382087b46f8f1b3933bcb50ef891a 10.133.19.15:7005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates a55c33ac21e5ccb1a2d4978c2d79ab7ffb33e768</span><br><span class="line">S: af737cd5aebf58561a50f285b9729b7bced0096e 10.133.19.15:7004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 35d61c095bb5b8abf8bed68141fe002b47bf9981</span><br><span class="line">M: a55c33ac21e5ccb1a2d4978c2d79ab7ffb33e768 10.133.19.15:7002</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: b52a607f01278bd84e0caa689b7cc9f4e1381d84 10.133.19.15:7006</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 19c1b2b936a3dc0c7ed6a19105cd47b8ce5a1ee1</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2521cf50-4acc-47a1-84f0-c94d915192a9-6"><p><mark class="hl-label blue">æŸ¥çœ‹é›†ç¾¤é€šä¿¡æ˜¯å¦æ­£å¸¸</mark></p><p>redis7001ä¸»èŠ‚ç‚¹å¯¹å®ƒçš„å‰¯æœ¬èŠ‚ç‚¹redis7005è¿›è¡Œpingæ“ä½œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~/soft/Redis-Cluster via ğŸ³ desktop-linux</span><br><span class="line">â¯ docker <span class="built_in">exec</span> -it redis7001 redis-cli -h 10.133.19.15 -p 7005 -a 123456 ping</span><br><span class="line">PONG</span><br></pre></td></tr></table></figure><p><mark class="hl-label green">æµ‹è¯•ç®€å•å­˜å‚¨</mark></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~/soft/Redis-Cluster via ğŸ³ desktop-linux</span><br><span class="line">â¯ docker <span class="built_in">exec</span> -it redis7001 redis-cli -p 7001 -a 123456</span><br><span class="line">Warning: Using a password with <span class="string">&#x27;-a&#x27;</span> or <span class="string">&#x27;-u&#x27;</span> option on the <span class="built_in">command</span> line interface may not be safe.</span><br><span class="line">127.0.0.1:7001&gt; <span class="built_in">set</span> name admin</span><br><span class="line">(error) MOVED 5798 10.133.19.15:7002</span><br></pre></td></tr></table></figure><p>ç”±äºRedis Clusterä¼šæ ¹æ®keyè¿›è¡Œhashè¿ç®—ï¼Œç„¶åå°†keyåˆ†æ•£åˆ°ä¸åŒslotsï¼Œnameçš„hashè¿ç®—ç»“æœåœ¨redis7002èŠ‚ç‚¹ä¸Šçš„slotsä¸­ã€‚æ‰€ä»¥æˆ‘ä»¬æ“ä½œredis7003å†™æ“ä½œä¼šè‡ªåŠ¨è·¯ç”±åˆ°7002ã€‚ç„¶è€Œerroræç¤ºæ— æ³•è·¯ç”±ï¼Ÿæ²¡å…³ç³»ï¼Œå·®ä¸€ä¸ª <code>-c</code> å‚æ•°è€Œå·²ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~/soft/Redis-Cluster via ğŸ³ desktop-linux took 41s</span><br><span class="line">â¯ docker <span class="built_in">exec</span> -it redis7001 redis-cli -p 7001 -a 123456 -c</span><br><span class="line">Warning: Using a password with <span class="string">&#x27;-a&#x27;</span> or <span class="string">&#x27;-u&#x27;</span> option on the <span class="built_in">command</span> line interface may not be safe.</span><br><span class="line">127.0.0.1:7001&gt; <span class="built_in">set</span> name 123</span><br><span class="line">-&gt; Redirected to slot [5798] located at 10.133.19.15:7002</span><br><span class="line">OK</span><br></pre></td></tr></table></figure><p><mark class="hl-label blue">æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</mark></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">10.133.19.15:7002&gt; cluster nodes</span><br><span class="line">af737cd5aebf58561a50f285b9729b7bced0096e 10.133.19.15:7004@17004 slave 35d61c095bb5b8abf8bed68141fe002b47bf9981 0 1686800998512 1 connected</span><br><span class="line">a55c33ac21e5ccb1a2d4978c2d79ab7ffb33e768 10.133.19.15:7002@17002 myself,master - 0 1686800999000 2 connected 5461-10922</span><br><span class="line">35d61c095bb5b8abf8bed68141fe002b47bf9981 10.133.19.15:7001@17001 master - 0 1686800999000 1 connected 0-5460</span><br><span class="line">b52a607f01278bd84e0caa689b7cc9f4e1381d84 10.133.19.15:7006@17006 slave 19c1b2b936a3dc0c7ed6a19105cd47b8ce5a1ee1 0 1686800999000 3 connected</span><br><span class="line">19c1b2b936a3dc0c7ed6a19105cd47b8ce5a1ee1 10.133.19.15:7003@17003 master - 0 1686800998514 3 connected 10923-16383</span><br><span class="line">a27a6620278382087b46f8f1b3933bcb50ef891a 10.133.19.15:7005@17005 slave a55c33ac21e5ccb1a2d4978c2d79ab7ffb33e768 0 1686800999944 2 connected</span><br></pre></td></tr></table></figure><p><mark class="hl-label blue">æŸ¥çœ‹slotsåˆ†ç‰‡</mark></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">10.133.19.15:7002&gt; cluster slots</span><br><span class="line">1) 1) (<span class="built_in">integer</span>) 0</span><br><span class="line">   2) (<span class="built_in">integer</span>) 5460</span><br><span class="line">   3) 1) <span class="string">&quot;10.133.19.15&quot;</span></span><br><span class="line">      2) (<span class="built_in">integer</span>) 7001</span><br><span class="line">      3) <span class="string">&quot;35d61c095bb5b8abf8bed68141fe002b47bf9981&quot;</span></span><br><span class="line">   4) 1) <span class="string">&quot;10.133.19.15&quot;</span></span><br><span class="line">      2) (<span class="built_in">integer</span>) 7004</span><br><span class="line">      3) <span class="string">&quot;af737cd5aebf58561a50f285b9729b7bced0096e&quot;</span></span><br><span class="line">2) 1) (<span class="built_in">integer</span>) 5461</span><br><span class="line">   2) (<span class="built_in">integer</span>) 10922</span><br><span class="line">   3) 1) <span class="string">&quot;10.133.19.15&quot;</span></span><br><span class="line">      2) (<span class="built_in">integer</span>) 7002</span><br><span class="line">      3) <span class="string">&quot;a55c33ac21e5ccb1a2d4978c2d79ab7ffb33e768&quot;</span></span><br><span class="line">   4) 1) <span class="string">&quot;10.133.19.15&quot;</span></span><br><span class="line">      2) (<span class="built_in">integer</span>) 7005</span><br><span class="line">      3) <span class="string">&quot;a27a6620278382087b46f8f1b3933bcb50ef891a&quot;</span></span><br><span class="line">3) 1) (<span class="built_in">integer</span>) 10923</span><br><span class="line">   2) (<span class="built_in">integer</span>) 16383</span><br><span class="line">   3) 1) <span class="string">&quot;10.133.19.15&quot;</span></span><br><span class="line">      2) (<span class="built_in">integer</span>) 7003</span><br><span class="line">      3) <span class="string">&quot;19c1b2b936a3dc0c7ed6a19105cd47b8ce5a1ee1&quot;</span></span><br><span class="line">   4) 1) <span class="string">&quot;10.133.19.15&quot;</span></span><br><span class="line">      2) (<span class="built_in">integer</span>) 7006</span><br><span class="line">      3) <span class="string">&quot;b52a607f01278bd84e0caa689b7cc9f4e1381d84&quot;</span></span><br></pre></td></tr></table></figure><p><mark class="hl-label green">æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯</mark></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">10.133.19.15:7002&gt; cluster info</span><br><span class="line">cluster_state:ok</span><br><span class="line">cluster_slots_assigned:16384</span><br><span class="line">cluster_slots_ok:16384</span><br><span class="line">cluster_slots_pfail:0</span><br><span class="line">cluster_slots_fail:0</span><br><span class="line">cluster_known_nodes:6</span><br><span class="line">cluster_size:3</span><br><span class="line">cluster_current_epoch:6</span><br><span class="line">cluster_my_epoch:2</span><br><span class="line">cluster_stats_messages_ping_sent:856</span><br><span class="line">cluster_stats_messages_pong_sent:864</span><br><span class="line">cluster_stats_messages_meet_sent:1</span><br><span class="line">cluster_stats_messages_sent:1721</span><br><span class="line">cluster_stats_messages_ping_received:864</span><br><span class="line">cluster_stats_messages_pong_received:857</span><br><span class="line">cluster_stats_messages_received:1721</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="æ•£åˆ—æ’æ§½åŸç†">æ•£åˆ—æ’æ§½åŸç†</h3><p>Redisä¼šæŠŠæ¯ä¸€ä¸ªmasterèŠ‚ç‚¹æ˜ å°„åˆ°0~16383å…±16384ä¸ªæ’æ§½ï¼ˆhash slotï¼‰ä¸Šï¼ŒæŸ¥çœ‹é›†ç¾¤ä¿¡æ¯æ—¶å°±èƒ½çœ‹åˆ°ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725155820320.png" alt="image-20210725155820320"></p><p>æ•°æ®keyä¸æ˜¯ä¸èŠ‚ç‚¹ç»‘å®šï¼Œè€Œæ˜¯ä¸æ’æ§½ç»‘å®šã€‚redisä¼šæ ¹æ®keyçš„æœ‰æ•ˆéƒ¨åˆ†è®¡ç®—æ’æ§½å€¼ï¼Œåˆ†ä¸¤ç§æƒ…å†µï¼š</p><ul><li>keyä¸­åŒ…å«&quot;{}&quot;ï¼Œä¸”â€œ{}â€ä¸­è‡³å°‘åŒ…å«1ä¸ªå­—ç¬¦ï¼Œâ€œ{}â€ä¸­çš„éƒ¨åˆ†æ˜¯æœ‰æ•ˆéƒ¨åˆ†</li><li>keyä¸­ä¸åŒ…å«â€œ{}â€ï¼Œæ•´ä¸ªkeyéƒ½æ˜¯æœ‰æ•ˆéƒ¨åˆ†</li></ul><p>ä¾‹å¦‚ï¼škeyæ˜¯numï¼Œé‚£ä¹ˆå°±æ ¹æ®numè®¡ç®—ï¼Œå¦‚æœæ˜¯{itcast}numï¼Œåˆ™æ ¹æ®itcastè®¡ç®—ã€‚è®¡ç®—æ–¹å¼æ˜¯åˆ©ç”¨CRC16ç®—æ³•å¾—åˆ°ä¸€ä¸ªhashå€¼ï¼Œç„¶åå¯¹16384å–ä½™ï¼Œå¾—åˆ°çš„ç»“æœå°±æ˜¯slotå€¼ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210725155850200.png" alt="image-20210725155850200"></p><p>å¦‚å›¾ï¼Œåœ¨7001è¿™ä¸ªèŠ‚ç‚¹æ‰§è¡Œset a 1æ—¶ï¼Œå¯¹aåšhashè¿ç®—ï¼Œå¯¹16384å–ä½™ï¼Œå¾—åˆ°çš„ç»“æœæ˜¯15495ï¼Œå› æ­¤è¦å­˜å‚¨åˆ°103èŠ‚ç‚¹ã€‚</p><p>åˆ°äº†7003åï¼Œæ‰§è¡Œ<code>get num</code>æ—¶ï¼Œå¯¹numåšhashè¿ç®—ï¼Œå¯¹16384å–ä½™ï¼Œå¾—åˆ°çš„ç»“æœæ˜¯2765ï¼Œå› æ­¤éœ€è¦åˆ‡æ¢åˆ°7001èŠ‚ç‚¹</p><mark class="hl-label blue">å°ç»“</mark> <p>Rediså¦‚ä½•åˆ¤æ–­æŸä¸ªkeyåº”è¯¥åœ¨å“ªä¸ªå®ä¾‹ï¼Ÿ</p><ul><li>å°†16384ä¸ªæ’æ§½åˆ†é…åˆ°ä¸åŒçš„å®ä¾‹</li><li>æ ¹æ®keyçš„æœ‰æ•ˆéƒ¨åˆ†è®¡ç®—å“ˆå¸Œå€¼ï¼Œå¯¹16384å–ä½™</li><li>ä½™æ•°ä½œä¸ºæ’æ§½ï¼Œå¯»æ‰¾æ’æ§½æ‰€åœ¨å®ä¾‹å³å¯</li></ul><p>å¦‚ä½•å°†åŒä¸€ç±»æ•°æ®å›ºå®šçš„ä¿å­˜åœ¨åŒä¸€ä¸ªRediså®ä¾‹ï¼Ÿ</p><ul><li>è¿™ä¸€ç±»æ•°æ®ä½¿ç”¨ç›¸åŒçš„æœ‰æ•ˆéƒ¨åˆ†ï¼Œä¾‹å¦‚keyéƒ½ä»¥{typeId}ä¸ºå‰ç¼€</li></ul><hr><hr><h2 id="Redisé”®å€¼è®¾è®¡">Redisé”®å€¼è®¾è®¡</h2><h3 id="ä¼˜é›…çš„keyç»“æ„">ä¼˜é›…çš„keyç»“æ„</h3><p>Redisçš„Keyè™½ç„¶å¯ä»¥è‡ªå®šä¹‰ï¼Œä½†æœ€å¥½éµå¾ªä¸‹é¢çš„å‡ ä¸ªæœ€ä½³å®è·µçº¦å®šï¼š</p><ul><li>éµå¾ªåŸºæœ¬æ ¼å¼ï¼š[ä¸šåŠ¡åç§°]:[æ•°æ®å]:[id]</li><li>é•¿åº¦ä¸è¶…è¿‡44å­—èŠ‚</li><li>ä¸åŒ…å«ç‰¹æ®Šå­—ç¬¦</li></ul><p>ä¾‹å¦‚ï¼šæˆ‘ä»¬çš„ç™»å½•ä¸šåŠ¡ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œå…¶keyå¯ä»¥è®¾è®¡æˆå¦‚ä¸‹æ ¼å¼ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220521120213631.png" alt=""></p><p>è¿™æ ·è®¾è®¡çš„å¥½å¤„ï¼š</p><ul><li>å¯è¯»æ€§å¼º</li><li>é¿å…keyå†²çª</li><li>æ–¹ä¾¿ç®¡ç†</li><li>æ›´èŠ‚çœå†…å­˜ï¼š keyæ˜¯stringç±»å‹ï¼Œåº•å±‚ç¼–ç åŒ…å«intã€embstrå’Œrawä¸‰ç§ã€‚embstråœ¨å°äº44å­—èŠ‚ä½¿ç”¨ï¼Œé‡‡ç”¨è¿ç»­å†…å­˜ç©ºé—´ï¼Œå†…å­˜å ç”¨æ›´å°ã€‚å½“å­—èŠ‚æ•°å¤§äº44å­—èŠ‚æ—¶ï¼Œä¼šè½¬ä¸ºrawæ¨¡å¼å­˜å‚¨ï¼Œåœ¨rawæ¨¡å¼ä¸‹ï¼Œå†…å­˜ç©ºé—´ä¸æ˜¯è¿ç»­çš„ï¼Œè€Œæ˜¯é‡‡ç”¨ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘äº†å¦å¤–ä¸€æ®µå†…å­˜ç©ºé—´ï¼Œåœ¨è¿™æ®µç©ºé—´é‡Œå­˜å‚¨SDSå†…å®¹ï¼Œè¿™æ ·ç©ºé—´ä¸è¿ç»­ï¼Œè®¿é—®çš„æ—¶å€™æ€§èƒ½ä¹Ÿå°±ä¼šæ”¶åˆ°å½±å“ï¼Œè¿˜æœ‰å¯èƒ½äº§ç”Ÿå†…å­˜ç¢ç‰‡</li></ul><hr><h3 id="æ‹’ç»BigKey">æ‹’ç»BigKey</h3><p>BigKeyé€šå¸¸ä»¥Keyçš„å¤§å°å’ŒKeyä¸­æˆå‘˜çš„æ•°é‡æ¥ç»¼åˆåˆ¤å®šï¼Œä¾‹å¦‚ï¼š</p><ul><li>Keyæœ¬èº«çš„æ•°æ®é‡è¿‡å¤§ï¼šä¸€ä¸ªStringç±»å‹çš„Keyï¼Œå®ƒçš„å€¼ä¸º5 MB</li><li>Keyä¸­çš„æˆå‘˜æ•°è¿‡å¤šï¼šä¸€ä¸ªZSETç±»å‹çš„Keyï¼Œå®ƒçš„æˆå‘˜æ•°é‡ä¸º10,000ä¸ª</li><li>Keyä¸­æˆå‘˜çš„æ•°æ®é‡è¿‡å¤§ï¼šä¸€ä¸ªHashç±»å‹çš„Keyï¼Œå®ƒçš„æˆå‘˜æ•°é‡è™½ç„¶åªæœ‰1,000ä¸ªä½†è¿™äº›æˆå‘˜çš„Valueï¼ˆå€¼ï¼‰æ€»å¤§å°ä¸º100 MB</li></ul><p>å¯ä»¥é‡‡ç”¨memory usage æŒ‡ä»¤æŸ¥çœ‹æŒ‡å®škeyåŠå…¶valueå ç”¨å¤§å°ï¼Œä½†æ˜¯ä¸€èˆ¬ä¸æ¨èä½¿ç”¨memoryæŒ‡ä»¤ï¼Œå› æ­¤è¿™ä¸ªæŒ‡ä»¤å¯¹cpuçš„ä½¿ç”¨ç‡æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œå®é™…å¼€å‘ä¸­ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬åªéœ€è¦è¡¡é‡å€¼æˆ–è€…å€¼çš„ä¸ªæ•°å°±è¡Œäº†ã€‚</p><p>æ¨èå€¼ï¼š</p><ul><li>å•ä¸ªkeyçš„valueå°äº10KB</li><li>å¯¹äºé›†åˆç±»å‹çš„keyï¼Œå»ºè®®å…ƒç´ æ•°é‡å°äº1000</li></ul><hr><h3 id="BigKeyçš„å±å®³">BigKeyçš„å±å®³</h3><ul><li>ç½‘ç»œé˜»å¡<ul><li>å¯¹BigKeyæ‰§è¡Œè¯»è¯·æ±‚æ—¶ï¼Œå°‘é‡çš„QPSå°±å¯èƒ½å¯¼è‡´å¸¦å®½ä½¿ç”¨ç‡è¢«å æ»¡ï¼Œå¯¼è‡´Rediså®ä¾‹ï¼Œä¹ƒè‡³æ‰€åœ¨ç‰©ç†æœºå˜æ…¢</li></ul></li><li>æ•°æ®å€¾æ–œ<ul><li>BigKeyæ‰€åœ¨çš„Rediså®ä¾‹å†…å­˜ä½¿ç”¨ç‡è¿œè¶…å…¶ä»–å®ä¾‹ï¼Œæ— æ³•ä½¿æ•°æ®åˆ†ç‰‡çš„å†…å­˜èµ„æºè¾¾åˆ°å‡è¡¡</li></ul></li><li>Redisé˜»å¡<ul><li>å¯¹å…ƒç´ è¾ƒå¤šçš„hashã€listã€zsetç­‰åšè¿ç®—ä¼šè€—æ—¶è¾ƒæ—§ï¼Œä½¿ä¸»çº¿ç¨‹è¢«é˜»å¡</li></ul></li><li>CPUå‹åŠ›<ul><li>å¯¹BigKeyçš„æ•°æ®åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¼šå¯¼è‡´CPUçš„ä½¿ç”¨ç‡é£™å‡ï¼Œå½±å“Rediså®ä¾‹å’Œæœ¬æœºå…¶å®ƒåº”ç”¨</li></ul></li></ul><hr><h3 id="å¦‚ä½•å‘ç°BigKey">å¦‚ä½•å‘ç°BigKey</h3><div class="tabs" id="07793243-545c-48a4-b4d8-8bb97db55d36"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#07793243-545c-48a4-b4d8-8bb97db55d36-1"><i class="fas fa-bug"></i>â‘ redis-cli --bigkeys</button></li><li class="tab"><button type="button" data-href="#07793243-545c-48a4-b4d8-8bb97db55d36-2"><i class="fas fa-cannabis"></i>â‘¡scanæ‰«æ</button></li><li class="tab"><button type="button" data-href="#07793243-545c-48a4-b4d8-8bb97db55d36-3"><i class="fas fa-candy-cane"></i>â‘¢ç¬¬ä¸‰æ–¹å·¥å…·</button></li><li class="tab"><button type="button" data-href="#07793243-545c-48a4-b4d8-8bb97db55d36-4"><i class="fas fa-child"></i>ç½‘ç»œç›‘æ§</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="07793243-545c-48a4-b4d8-8bb97db55d36-1"><p>åˆ©ç”¨redis-cliæä¾›çš„â€“bigkeyså‚æ•°ï¼Œå¯ä»¥éå†åˆ†ææ‰€æœ‰keyï¼Œå¹¶è¿”å›Keyçš„æ•´ä½“ç»Ÿè®¡ä¿¡æ¯ä¸æ¯ä¸ªæ•°æ®çš„Top1çš„big key</p><p>å‘½ä»¤ï¼š<code>redis-cli -a å¯†ç  --bigkeys</code></p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220521133359507.png" alt="image-20220521133359507"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="07793243-545c-48a4-b4d8-8bb97db55d36-2"><p>è‡ªå·±ç¼–ç¨‹ï¼Œåˆ©ç”¨scanæ‰«æRedisä¸­çš„æ‰€æœ‰keyï¼Œåˆ©ç”¨strlenã€hlenç­‰å‘½ä»¤åˆ¤æ–­keyçš„é•¿åº¦ï¼ˆæ­¤å¤„ä¸å»ºè®®ä½¿ç”¨MEMORY USAGEï¼‰</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220521133703245.png" alt="image-20220521133703245"></p><p>scan å‘½ä»¤è°ƒç”¨å®Œåæ¯æ¬¡ä¼šè¿”å›2ä¸ªå…ƒç´ ï¼Œç¬¬ä¸€ä¸ªæ˜¯ä¸‹ä¸€æ¬¡è¿­ä»£çš„å…‰æ ‡ï¼Œç¬¬ä¸€æ¬¡å…‰æ ‡ä¼šè®¾ç½®ä¸º0ï¼Œå½“æœ€åä¸€æ¬¡scan è¿”å›çš„å…‰æ ‡ç­‰äº0æ—¶ï¼Œè¡¨ç¤ºæ•´ä¸ªscanéå†ç»“æŸäº†ï¼Œç¬¬äºŒä¸ªè¿”å›çš„æ˜¯Listï¼Œä¸€ä¸ªåŒ¹é…çš„keyçš„æ•°ç»„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.heima.jedis.util.JedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.AfterEach;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.BeforeEach;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.ScanResult;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JedisTest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Jedis jedis;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1.å»ºç«‹è¿æ¥</span></span><br><span class="line">        <span class="comment">// jedis = new Jedis(&quot;192.168.150.101&quot;, 6379);</span></span><br><span class="line">        jedis = JedisConnectionFactory.getJedis();</span><br><span class="line">        <span class="comment">// 2.è®¾ç½®å¯†ç </span></span><br><span class="line">        jedis.auth(<span class="string">&quot;123321&quot;</span>);</span><br><span class="line">        <span class="comment">// 3.é€‰æ‹©åº“</span></span><br><span class="line">        jedis.select(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">STR_MAX_LEN</span> <span class="operator">=</span> <span class="number">10</span> * <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">HASH_MAX_LEN</span> <span class="operator">=</span> <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testScan</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">maxLen</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">len</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">cursor</span> <span class="operator">=</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// æ‰«æå¹¶è·å–ä¸€éƒ¨åˆ†key</span></span><br><span class="line">            ScanResult&lt;String&gt; result = jedis.scan(cursor);</span><br><span class="line">            <span class="comment">// è®°å½•cursor</span></span><br><span class="line">            cursor = result.getCursor();</span><br><span class="line">            List&lt;String&gt; list = result.getResult();</span><br><span class="line">            <span class="keyword">if</span> (list == <span class="literal">null</span> || list.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// éå†</span></span><br><span class="line">            <span class="keyword">for</span> (String key : list) &#123;</span><br><span class="line">                <span class="comment">// åˆ¤æ–­keyçš„ç±»å‹</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> jedis.type(key);</span><br><span class="line">                <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;string&quot;</span>:</span><br><span class="line">                        len = jedis.strlen(key);</span><br><span class="line">                        maxLen = STR_MAX_LEN;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;hash&quot;</span>:</span><br><span class="line">                        len = jedis.hlen(key);</span><br><span class="line">                        maxLen = HASH_MAX_LEN;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;list&quot;</span>:</span><br><span class="line">                        len = jedis.llen(key);</span><br><span class="line">                        maxLen = HASH_MAX_LEN;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;set&quot;</span>:</span><br><span class="line">                        len = jedis.scard(key);</span><br><span class="line">                        maxLen = HASH_MAX_LEN;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;zset&quot;</span>:</span><br><span class="line">                        len = jedis.zcard(key);</span><br><span class="line">                        maxLen = HASH_MAX_LEN;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (len &gt;= maxLen) &#123;</span><br><span class="line">                    System.out.printf(<span class="string">&quot;Found big key : %s, type: %s, length or size: %d %n&quot;</span>, key, type, len);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (!cursor.equals(<span class="string">&quot;0&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@AfterEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">tearDown</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (jedis != <span class="literal">null</span>) &#123;</span><br><span class="line">            jedis.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="07793243-545c-48a4-b4d8-8bb97db55d36-3"><ul><li>åˆ©ç”¨ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œå¦‚ Redis-Rdb-Tools åˆ†æRDBå¿«ç…§æ–‡ä»¶ï¼Œå…¨é¢åˆ†æå†…å­˜ä½¿ç”¨æƒ…å†µ</li><li><a href="https://github.com/sripathikrishnan/redis-rdb-tools">https://github.com/sripathikrishnan/redis-rdb-tools</a></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="07793243-545c-48a4-b4d8-8bb97db55d36-4"><ul><li>è‡ªå®šä¹‰å·¥å…·ï¼Œç›‘æ§è¿›å‡ºRedisçš„ç½‘ç»œæ•°æ®ï¼Œè¶…å‡ºé¢„è­¦å€¼æ—¶ä¸»åŠ¨å‘Šè­¦</li><li>ä¸€èˆ¬é˜¿é‡Œäº‘æ­å»ºçš„äº‘æœåŠ¡å™¨å°±æœ‰ç›¸å…³ç›‘æ§é¡µé¢</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220521140415785.png" alt="image-20220521140415785"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="å¦‚ä½•åˆ é™¤BigKey">å¦‚ä½•åˆ é™¤BigKey</h3><p>BigKeyå†…å­˜å ç”¨è¾ƒå¤šï¼Œå³ä¾¿æ—¶åˆ é™¤è¿™æ ·çš„keyä¹Ÿéœ€è¦è€—è´¹å¾ˆé•¿æ—¶é—´ï¼Œå¯¼è‡´Redisä¸»çº¿ç¨‹é˜»å¡ï¼Œå¼•å‘ä¸€ç³»åˆ—é—®é¢˜ã€‚</p><ul><li>redis 3.0 åŠä»¥ä¸‹ç‰ˆæœ¬<ul><li>å¦‚æœæ˜¯é›†åˆç±»å‹ï¼Œåˆ™éå†BigKeyçš„å…ƒç´ ï¼Œå…ˆé€ä¸ªåˆ é™¤å­å…ƒç´ ï¼Œæœ€ååˆ é™¤BigKey</li></ul></li><li>Redis 4.0ä»¥å<ul><li>Redisåœ¨4.0åæä¾›äº†å¼‚æ­¥åˆ é™¤çš„å‘½ä»¤ï¼šunlink</li></ul></li></ul><hr><h3 id="æ°å½“çš„æ•°æ®ç±»å‹">æ°å½“çš„æ•°æ®ç±»å‹</h3><p>æ¯”å¦‚å­˜å‚¨ä¸€ä¸ªUserå¯¹è±¡ï¼Œæˆ‘ä»¬æœ‰ä¸‰ç§å­˜å‚¨æ–¹å¼</p><div class="tabs" id="6e53bb1c-f654-4c01-9b69-652fc8b5197c"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6e53bb1c-f654-4c01-9b69-652fc8b5197c-1"><i class="fas fa-award"></i>jsonå­—ç¬¦ä¸²</button></li><li class="tab"><button type="button" data-href="#6e53bb1c-f654-4c01-9b69-652fc8b5197c-2"><i class="fas fa-baseball-ball"></i>å­—æ®µæ‰“æ•£</button></li><li class="tab"><button type="button" data-href="#6e53bb1c-f654-4c01-9b69-652fc8b5197c-3"><i class="fas fa-bone"></i>hashï¼ˆæ¨èï¼‰</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6e53bb1c-f654-4c01-9b69-652fc8b5197c-1"><table><thead><tr><th style="text-align:center">user:1</th><th style="text-align:center">{â€œnameâ€: â€œJackâ€, â€œageâ€: 21}</th></tr></thead></table><p>ä¼˜ç‚¹ï¼šå®ç°ç®€å•ç²—æš´</p><p>ç¼ºç‚¹ï¼šæ•°æ®è€¦åˆï¼Œä¸å¤Ÿçµæ´»</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6e53bb1c-f654-4c01-9b69-652fc8b5197c-2"><table><thead><tr><th style="text-align:center">user:1:name</th><th style="text-align:center">Jack</th></tr></thead><tbody><tr><td style="text-align:center">user:1:age</td><td style="text-align:center">21</td></tr></tbody></table><p>ä¼˜ç‚¹ï¼šå¯ä»¥çµæ´»è®¿é—®å¯¹è±¡ä»»æ„å­—æ®µ</p><p>ç¼ºç‚¹ï¼šå ç”¨ç©ºé—´å¤§ã€æ²¡åŠæ³•åšç»Ÿä¸€æ§åˆ¶</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6e53bb1c-f654-4c01-9b69-652fc8b5197c-3"><table><tr><td rowspan="2">user:1</td>        <td>name</td>        <td>jack</td></tr><tr><td>age</td><td>21</td></tr></table><p>ä¼˜ç‚¹ï¼šåº•å±‚ä½¿ç”¨ziplistï¼Œç©ºé—´å ç”¨å°ï¼Œå¯ä»¥çµæ´»è®¿é—®å¯¹è±¡çš„ä»»æ„å­—æ®µ</p><p>ç¼ºç‚¹ï¼šä»£ç ç›¸å¯¹å¤æ‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <blockquote><p>å‡å¦‚æœ‰hashç±»å‹çš„keyï¼Œå…¶ä¸­æœ‰100ä¸‡å¯¹fieldå’Œvalueï¼Œfieldæ˜¯è‡ªå¢idï¼Œè¿™ä¸ªkeyå­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿ</p></blockquote><table><tr style="color:red"><td>key</td>        <td>field</td>        <td>value</td></tr><tr><td rowspan="3">someKey</td><td>id:0</td>        <td>value0</td></tr>    <tr><td>.....</td>        <td>.....</td></tr>    <tr>        <td>id:999999</td>        <td>value999999</td>    </tr></table><p>å­˜åœ¨çš„é—®é¢˜ï¼š</p><ul><li>hashçš„entryæ•°é‡è¶…è¿‡500æ—¶ï¼Œä¼šä½¿ç”¨å“ˆå¸Œè¡¨è€Œä¸æ˜¯ZipListï¼Œå†…å­˜å ç”¨è¾ƒå¤š<ul><li><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220521142943350.png" alt="image-20220521142943350"></li></ul></li><li>å¯ä»¥é€šè¿‡hash-max-ziplist-entriesé…ç½®entryä¸Šé™ã€‚ä½†æ˜¯å¦‚æœentryè¿‡å¤šå°±ä¼šå¯¼è‡´BigKeyé—®é¢˜</li></ul><div class="tabs" id="591e5b8a-8484-44f9-833d-6f772219416c"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#591e5b8a-8484-44f9-833d-6f772219416c-1"><i class="fas fa-cat"></i>æ–¹æ¡ˆä¸€</button></li><li class="tab"><button type="button" data-href="#591e5b8a-8484-44f9-833d-6f772219416c-2"><i class="fas fa-horse"></i>æ–¹æ¡ˆäºŒ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="591e5b8a-8484-44f9-833d-6f772219416c-1"><p>æ‹†åˆ†ä¸ºstringç±»å‹</p><table><tr style="color:red"><td>key</td>        <td>value</td></tr><tr><td>id:0</td>        <td>value0</td></tr>    <tr><td>.....</td>        <td>.....</td></tr>    <tr>        <td>id:999999</td>        <td>value999999</td>    </tr></table><p>å­˜åœ¨çš„é—®é¢˜ï¼š</p><ul><li>stringç»“æ„åº•å±‚æ²¡æœ‰å¤ªå¤šå†…å­˜ä¼˜åŒ–ï¼Œå†…å­˜å ç”¨è¾ƒå¤š</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220521143458010.png" alt="image-20220521143458010"></p><ul><li>æƒ³è¦æ‰¹é‡è·å–è¿™äº›æ•°æ®æ¯”è¾ƒéº»çƒ¦</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="591e5b8a-8484-44f9-833d-6f772219416c-2"><p>æ‹†åˆ†ä¸ºå°çš„hashï¼Œå°† id / 100 ä½œä¸ºkeyï¼Œ å°†id % 100 ä½œä¸ºfieldï¼Œè¿™æ ·æ¯100ä¸ªå…ƒç´ ä¸ºä¸€ä¸ªHash</p><table><tr style="color:red"><td>key</td>        <td>field</td>        <td>value</td></tr><tr>        <td rowspan="3">key:0</td><td>id:00</td>        <td>value0</td></tr>    <tr><td>.....</td>        <td>.....</td></tr>    <tr>        <td>id:99</td>        <td>value99</td>    </tr>    <tr>        <td rowspan="3">key:1</td><td>id:00</td>        <td>value100</td></tr>    <tr><td>.....</td>        <td>.....</td></tr>    <tr>        <td>id:99</td>        <td>value199</td>    </tr>    <tr>    <td colspan="3">....</td>    </tr>    <tr>        <td rowspan="3">key:9999</td><td>id:00</td>        <td>value999900</td></tr>    <tr><td>.....</td>        <td>.....</td></tr>    <tr>        <td>id:99</td>        <td>value999999</td>    </tr></table><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220521144339377.png" alt="image-20220521144339377"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="æ€»ç»“">æ€»ç»“</h3><ul><li>Keyçš„æœ€ä½³å®è·µ<ul><li>å›ºå®šæ ¼å¼ï¼š[ä¸šåŠ¡å]:[æ•°æ®å]:[id]</li><li>è¶³å¤Ÿç®€çŸ­ï¼šä¸è¶…è¿‡44å­—èŠ‚</li><li>ä¸åŒ…å«ç‰¹æ®Šå­—ç¬¦</li></ul></li><li>Valueçš„æœ€ä½³å®è·µï¼š<ul><li>åˆç†çš„æ‹†åˆ†æ•°æ®ï¼Œæ‹’ç»BigKey</li><li>é€‰æ‹©åˆé€‚æ•°æ®ç»“æ„</li><li>Hashç»“æ„çš„entryæ•°é‡ä¸è¦è¶…è¿‡1000</li><li>è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´</li></ul></li></ul><hr><hr><hr><hr><h2 id="æ‰¹å¤„ç†ä¼˜åŒ–">æ‰¹å¤„ç†ä¼˜åŒ–</h2><h3 id="Pipeline">Pipeline</h3><p>æˆ‘ä»¬çš„å®¢æˆ·ç«¯ä¸redisæœåŠ¡å™¨æ˜¯è¿™æ ·äº¤äº’çš„</p><div class="tabs" id="f112ee38-765d-48f9-858c-0fe03583915c"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#f112ee38-765d-48f9-858c-0fe03583915c-1"><i class="fas fa-cat"></i>å•ä¸ªå‘½ä»¤çš„æ‰§è¡Œæµç¨‹</button></li><li class="tab"><button type="button" data-href="#f112ee38-765d-48f9-858c-0fe03583915c-2"><i class="fas fa-horse"></i>Næ¡å‘½ä»¤çš„æ‰§è¡Œæµç¨‹</button></li><li class="tab"><button type="button" data-href="#f112ee38-765d-48f9-858c-0fe03583915c-3"><i class="fas fa-dove"></i>æ‰¹å¤„ç†</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="f112ee38-765d-48f9-858c-0fe03583915c-1"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220521151459880.png" alt="image-20220521151459880"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f112ee38-765d-48f9-858c-0fe03583915c-2"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220521151524621.png" alt="image-20220521151524621"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f112ee38-765d-48f9-858c-0fe03583915c-3"><p>rediså¤„ç†æŒ‡ä»¤æ˜¯å¾ˆå¿«çš„ï¼Œä¸»è¦èŠ±è´¹çš„æ—¶å€™åœ¨äºç½‘ç»œä¼ è¾“ã€‚äºæ˜¯ä¹å¾ˆå®¹æ˜“æƒ³åˆ°å°†å¤šæ¡æŒ‡ä»¤æ‰¹é‡çš„ä¼ è¾“ç»™redis</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220521151902080.png" alt="image-20220521151902080"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>Redisæä¾›äº†å¾ˆå¤šMxxxè¿™æ ·çš„å‘½ä»¤ï¼Œå¯ä»¥å®ç°æ‰¹é‡æ’å…¥æ•°æ®ï¼Œä¾‹å¦‚ï¼š</p><ul><li>mset</li><li>hmset</li></ul><p>MSETè™½ç„¶å¯ä»¥æ‰¹å¤„ç†ï¼Œä½†æ˜¯å´åªèƒ½æ“ä½œéƒ¨åˆ†æ•°æ®ç±»å‹ï¼Œå› æ­¤å¦‚æœæœ‰å¯¹å¤æ‚æ•°æ®ç±»å‹çš„æ‰¹å¤„ç†éœ€è¦ï¼Œå»ºè®®ä½¿ç”¨Pipeline</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPipeline</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºç®¡é“</span></span><br><span class="line">    <span class="type">Pipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> jedis.pipelined();</span><br><span class="line">    <span class="type">long</span> <span class="variable">b</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// æ”¾å…¥å‘½ä»¤åˆ°ç®¡é“</span></span><br><span class="line">        pipeline.set(<span class="string">&quot;test:key_&quot;</span> + i, <span class="string">&quot;value_&quot;</span> + i);</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">1000</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// æ¯æ”¾å…¥1000æ¡å‘½ä»¤ï¼Œæ‰¹é‡æ‰§è¡Œ</span></span><br><span class="line">            pipeline.sync();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">e</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;time: &quot;</span> + (e - b));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ³¨æ„äº‹é¡¹ï¼š</p><p>â‘  æ‰¹å¤„ç†æ—¶ä¸å»ºè®®ä¸€æ¬¡æºå¸¦å¤ªå¤šå‘½ä»¤</p><p>â‘¡ Pipelineçš„å¤šä¸ªå‘½ä»¤ä¹‹é—´ä¸å…·å¤‡åŸå­æ€§</p><hr><h3 id="é›†ç¾¤ä¸‹çš„æ‰¹å¤„ç†">é›†ç¾¤ä¸‹çš„æ‰¹å¤„ç†</h3><p>å¦‚MSETæˆ–Pipelineè¿™æ ·çš„æ‰¹å¤„ç†éœ€è¦åœ¨ä¸€æ¬¡è¯·æ±‚ä¸­æºå¸¦å¤šæ¡å‘½ä»¤ï¼Œè€Œæ­¤æ—¶å¦‚æœRedisæ˜¯ä¸€ä¸ªé›†ç¾¤ï¼Œé‚£æ‰¹å¤„ç†å‘½ä»¤çš„å¤šä¸ªkeyå¿…é¡»è½åœ¨ä¸€ä¸ªæ’æ§½ä¸­ï¼Œå¦åˆ™å°±ä¼šå¯¼è‡´æ‰§è¡Œå¤±è´¥ã€‚å¤§å®¶å¯ä»¥æƒ³ä¸€æƒ³è¿™æ ·çš„è¦æ±‚å…¶å®å¾ˆéš¾å®ç°ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨æ‰¹å¤„ç†æ—¶ï¼Œå¯èƒ½ä¸€æ¬¡è¦æ’å…¥å¾ˆå¤šæ¡æ•°æ®ï¼Œè¿™äº›æ•°æ®å¾ˆæœ‰å¯èƒ½ä¸ä¼šéƒ½è½åœ¨ç›¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œè¿™å°±ä¼šå¯¼è‡´æŠ¥é”™äº†</p><p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°4ç§è§£å†³æ–¹æ¡ˆ</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653126446641.png" alt="1653126446641"></p><p>ç¬¬ä¸€ç§æ–¹æ¡ˆï¼šä¸²è¡Œæ‰§è¡Œï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œå½“ç„¶ï¼Œæ‰§è¡Œèµ·æ¥å°±å¾ˆç®€å•äº†ï¼Œç¼ºç‚¹å°±æ˜¯è€—æ—¶è¿‡ä¹…ã€‚</p><p>ç¬¬äºŒç§æ–¹æ¡ˆï¼šä¸²è¡Œslotï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ‰§è¡Œå‰ï¼Œå®¢æˆ·ç«¯å…ˆè®¡ç®—ä¸€ä¸‹å¯¹åº”çš„keyçš„slotï¼Œä¸€æ ·slotçš„keyå°±æ”¾åˆ°ä¸€ä¸ªç»„é‡Œè¾¹ï¼Œä¸åŒçš„ï¼Œå°±æ”¾åˆ°ä¸åŒçš„ç»„é‡Œè¾¹ï¼Œç„¶åå¯¹æ¯ä¸ªç»„æ‰§è¡Œpipelineçš„æ‰¹å¤„ç†ï¼Œä»–å°±èƒ½ä¸²è¡Œæ‰§è¡Œå„ä¸ªç»„çš„å‘½ä»¤ï¼Œè¿™ç§åšæ³•æ¯”ç¬¬ä¸€ç§æ–¹æ³•è€—æ—¶è¦å°‘ï¼Œä½†æ˜¯ç¼ºç‚¹å‘¢ï¼Œç›¸å¯¹æ¥è¯´å¤æ‚ä¸€ç‚¹ï¼Œæ‰€ä»¥è¿™ç§æ–¹æ¡ˆè¿˜éœ€è¦ä¼˜åŒ–ä¸€ä¸‹</p><p>ç¬¬ä¸‰ç§æ–¹æ¡ˆï¼šå¹¶è¡Œslotï¼Œç›¸è¾ƒäºç¬¬äºŒç§æ–¹æ¡ˆï¼Œåœ¨åˆ†ç»„å®Œæˆåä¸²è¡Œæ‰§è¡Œï¼Œç¬¬ä¸‰ç§æ–¹æ¡ˆï¼Œå°±å˜æˆäº†å¹¶è¡Œæ‰§è¡Œå„ä¸ªå‘½ä»¤ï¼Œæ‰€ä»¥ä»–çš„è€—æ—¶å°±éå¸¸çŸ­ï¼Œä½†æ˜¯å®ç°å‘¢ï¼Œä¹Ÿæ›´åŠ å¤æ‚ã€‚</p><p>ç¬¬å››ç§ï¼šhash_tagï¼Œredisè®¡ç®—keyçš„slotçš„æ—¶å€™ï¼Œå…¶å®æ˜¯æ ¹æ®keyçš„æœ‰æ•ˆéƒ¨åˆ†æ¥è®¡ç®—çš„ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å°±èƒ½ä¸€æ¬¡å¤„ç†æ‰€æœ‰çš„keyï¼Œè¿™ç§æ–¹å¼è€—æ—¶æœ€çŸ­ï¼Œå®ç°ä¹Ÿç®€å•ï¼Œä½†æ˜¯å¦‚æœé€šè¿‡æ“ä½œkeyçš„æœ‰æ•ˆéƒ¨åˆ†ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´æ‰€æœ‰çš„keyéƒ½è½åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œäº§ç”Ÿæ•°æ®å€¾æ–œçš„é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¨èä½¿ç”¨ç¬¬ä¸‰ç§æ–¹å¼ã€‚</p><hr><hr><h2 id="æŒä¹…åŒ–é…ç½®">æŒä¹…åŒ–é…ç½®</h2><p>Redisçš„æŒä¹…åŒ–è™½ç„¶å¯ä»¥ä¿è¯æ•°æ®å®‰å…¨ï¼Œä½†ä¹Ÿä¼šå¸¦æ¥å¾ˆå¤šé¢å¤–çš„å¼€é”€ï¼Œå› æ­¤æŒä¹…åŒ–è¯·éµå¾ªä¸‹åˆ—å»ºè®®ï¼š</p><ul><li>ç”¨æ¥åšç¼“å­˜çš„Rediså®ä¾‹å°½é‡ä¸è¦å¼€å¯æŒä¹…åŒ–åŠŸèƒ½</li><li>å»ºè®®å…³é—­RDBæŒä¹…åŒ–åŠŸèƒ½ï¼Œä½¿ç”¨AOFæŒä¹…åŒ–</li><li>åˆ©ç”¨è„šæœ¬å®šæœŸåœ¨slaveèŠ‚ç‚¹åšRDBï¼Œå®ç°æ•°æ®å¤‡ä»½</li><li>è®¾ç½®åˆç†çš„rewriteé˜ˆå€¼ï¼Œé¿å…é¢‘ç¹çš„bgrewrite</li><li>é…ç½®no-appendfsync-on-rewrite = yesï¼Œç¦æ­¢åœ¨rewriteæœŸé—´åšaofï¼Œé¿å…å› AOFå¼•èµ·çš„é˜»å¡</li><li>éƒ¨ç½²æœ‰å…³å»ºè®®ï¼š<ul><li>Rediså®ä¾‹çš„ç‰©ç†æœºè¦é¢„ç•™è¶³å¤Ÿå†…å­˜ï¼Œåº”å¯¹forkå’Œrewrite</li><li>å•ä¸ªRediså®ä¾‹å†…å­˜ä¸Šé™ä¸è¦å¤ªå¤§ï¼Œä¾‹å¦‚4Gæˆ–8Gã€‚å¯ä»¥åŠ å¿«forkçš„é€Ÿåº¦ã€å‡å°‘ä¸»ä»åŒæ­¥ã€æ•°æ®è¿ç§»å‹åŠ›</li><li>ä¸è¦ä¸CPUå¯†é›†å‹åº”ç”¨éƒ¨ç½²åœ¨ä¸€èµ·</li><li>ä¸è¦ä¸é«˜ç¡¬ç›˜è´Ÿè½½åº”ç”¨ä¸€èµ·éƒ¨ç½²ã€‚ä¾‹å¦‚ï¼šæ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—</li></ul></li></ul><hr><hr><h2 id="æ…¢æŸ¥è¯¢ä¼˜åŒ–">æ…¢æŸ¥è¯¢ä¼˜åŒ–</h2><h3 id="ä»€ä¹ˆæ˜¯æ…¢æŸ¥è¯¢">ä»€ä¹ˆæ˜¯æ…¢æŸ¥è¯¢</h3><p>å¹¶ä¸æ˜¯å¾ˆæ…¢çš„æŸ¥è¯¢æ‰æ˜¯æ…¢æŸ¥è¯¢ï¼Œè€Œæ˜¯ï¼šåœ¨Redisæ‰§è¡Œæ—¶è€—æ—¶è¶…è¿‡æŸä¸ªé˜ˆå€¼çš„å‘½ä»¤ï¼Œç§°ä¸ºæ…¢æŸ¥è¯¢ã€‚</p><p>æ…¢æŸ¥è¯¢çš„å±å®³ï¼šç”±äºRedisæ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥å½“å®¢æˆ·ç«¯å‘å‡ºæŒ‡ä»¤åï¼Œä»–ä»¬éƒ½ä¼šè¿›å…¥åˆ°redisåº•å±‚çš„queueæ¥æ‰§è¡Œï¼Œå¦‚æœæ­¤æ—¶æœ‰ä¸€äº›æ…¢æŸ¥è¯¢çš„æ•°æ®ï¼Œå°±ä¼šå¯¼è‡´å¤§é‡è¯·æ±‚é˜»å¡ï¼Œä»è€Œå¼•èµ·æŠ¥é”™ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è§£å†³æ…¢æŸ¥è¯¢é—®é¢˜ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653129590210.png" alt="1653129590210"></p><p>æ…¢æŸ¥è¯¢çš„é˜ˆå€¼å¯ä»¥é€šè¿‡é…ç½®æŒ‡å®šï¼š</p><p>slowlog-log-slower-thanï¼šæ…¢æŸ¥è¯¢é˜ˆå€¼ï¼Œå•ä½æ˜¯å¾®ç§’ã€‚é»˜è®¤æ˜¯10000ï¼Œå»ºè®®1000</p><p>æ…¢æŸ¥è¯¢ä¼šè¢«æ”¾å…¥æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­ï¼Œæ—¥å¿—çš„é•¿åº¦æœ‰ä¸Šé™ï¼Œå¯ä»¥é€šè¿‡é…ç½®æŒ‡å®šï¼š</p><p>slowlog-max-lenï¼šæ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆæœ¬è´¨æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼‰çš„é•¿åº¦ã€‚é»˜è®¤æ˜¯128ï¼Œå»ºè®®1000</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653130457771.png" alt="1653130457771"></p><p>ä¿®æ”¹è¿™ä¸¤ä¸ªé…ç½®å¯ä»¥ä½¿ç”¨ï¼šconfig setå‘½ä»¤ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653130475979.png" alt="1653130475979"></p><hr><h3 id="å¦‚ä½•æŸ¥çœ‹æ…¢æŸ¥è¯¢">å¦‚ä½•æŸ¥çœ‹æ…¢æŸ¥è¯¢</h3><p>çŸ¥é“äº†ä»¥ä¸Šå†…å®¹ä¹‹åï¼Œé‚£ä¹ˆå’±ä»¬å¦‚ä½•å»æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—åˆ—è¡¨å‘¢ï¼š</p><ul><li>slowlog lenï¼šæŸ¥è¯¢æ…¢æŸ¥è¯¢æ—¥å¿—é•¿åº¦</li><li>slowlog get [n]ï¼šè¯»å–næ¡æ…¢æŸ¥è¯¢æ—¥å¿—</li><li>slowlog resetï¼šæ¸…ç©ºæ…¢æŸ¥è¯¢åˆ—è¡¨</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653130858066.png" alt="1653130858066"></p><hr><hr><h2 id="å‘½ä»¤åŠå®‰å…¨é…ç½®">å‘½ä»¤åŠå®‰å…¨é…ç½®</h2><p>å®‰å…¨å¯ä»¥è¯´æ˜¯æœåŠ¡å™¨ç«¯ä¸€ä¸ªéå¸¸é‡è¦çš„è¯é¢˜ï¼Œå¦‚æœå®‰å…¨å‡ºç°äº†é—®é¢˜ï¼Œé‚£ä¹ˆä¸€æ—¦è¿™ä¸ªæ¼æ´è¢«ä¸€äº›åäººçŸ¥é“äº†ä¹‹åï¼Œå¹¶ä¸”è¿›è¡Œæ”»å‡»ï¼Œé‚£ä¹ˆè¿™å°±ä¼šç»™å’±ä»¬çš„ç³»ç»Ÿå¸¦æ¥å¾ˆå¤šçš„æŸå¤±ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™èŠ‚è¯¾å°±æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>Redisä¼šç»‘å®šåœ¨0.0.0.0:6379ï¼Œè¿™æ ·å°†ä¼šå°†RedisæœåŠ¡æš´éœ²åˆ°å…¬ç½‘ä¸Šï¼Œè€ŒRediså¦‚æœæ²¡æœ‰åšèº«ä»½è®¤è¯ï¼Œä¼šå‡ºç°ä¸¥é‡çš„å®‰å…¨æ¼æ´.<br>æ¼æ´é‡ç°æ–¹å¼ï¼š<a href="https://cloud.tencent.com/developer/article/1039000">https://cloud.tencent.com/developer/article/1039000</a></p><p>ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¸éœ€è¦å¯†ç ä¹Ÿèƒ½å¤Ÿç™»å½•å‘¢ï¼Œä¸»è¦æ˜¯Redisè€ƒè™‘åˆ°æ¯æ¬¡ç™»å½•éƒ½æ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥Rediså°±æœ‰ä¸€ç§sshå…ç§˜é’¥ç™»å½•çš„æ–¹å¼ï¼Œç”Ÿæˆä¸€å¯¹å…¬é’¥å’Œç§é’¥ï¼Œç§é’¥æ”¾åœ¨æœ¬åœ°ï¼Œå…¬é’¥æ”¾åœ¨redisç«¯ï¼Œå½“æˆ‘ä»¬ç™»å½•æ—¶æœåŠ¡å™¨ï¼Œå†ç™»å½•æ—¶å€™ï¼Œä»–ä¼šå»è§£æå…¬é’¥å’Œç§é’¥ï¼Œå¦‚æœæ²¡æœ‰é—®é¢˜ï¼Œåˆ™ä¸éœ€è¦åˆ©ç”¨redisçš„ç™»å½•ä¹Ÿèƒ½è®¿é—®ï¼Œè¿™ç§åšæ³•æœ¬èº«ä¹Ÿå¾ˆå¸¸è§ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªå‰æï¼Œå‰æå°±æ˜¯å…¬é’¥å¿…é¡»ä¿å­˜åœ¨æœåŠ¡å™¨ä¸Šï¼Œæ‰è¡Œï¼Œä½†æ˜¯Redisçš„æ¼æ´åœ¨äºåœ¨ä¸ç™»å½•çš„æƒ…å†µä¸‹ï¼Œä¹Ÿèƒ½æŠŠç§˜é’¥é€åˆ°LinuxæœåŠ¡å™¨ï¼Œä»è€Œäº§ç”Ÿæ¼æ´</p><p>æ¼æ´å‡ºç°çš„æ ¸å¿ƒçš„åŸå› æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>Redisæœªè®¾ç½®å¯†ç </li><li>åˆ©ç”¨äº†Redisçš„config setå‘½ä»¤åŠ¨æ€ä¿®æ”¹Redisé…ç½®</li><li>ä½¿ç”¨äº†Rootè´¦å·æƒé™å¯åŠ¨Redis</li></ul><p>æ‰€ä»¥ï¼šå¦‚ä½•è§£å†³å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é‡‡ç”¨å¦‚ä¸‹å‡ ç§æ–¹æ¡ˆ</p><p>ä¸ºäº†é¿å…è¿™æ ·çš„æ¼æ´ï¼Œè¿™é‡Œç»™å‡ºä¸€äº›å»ºè®®ï¼š</p><ul><li>Redisä¸€å®šè¦è®¾ç½®å¯†ç </li><li>ç¦æ­¢çº¿ä¸Šä½¿ç”¨ä¸‹é¢å‘½ä»¤ï¼škeysã€flushallã€flushdbã€config setç­‰å‘½ä»¤ã€‚å¯ä»¥åˆ©ç”¨rename-commandç¦ç”¨ã€‚</li><li>bindï¼šé™åˆ¶ç½‘å¡ï¼Œç¦æ­¢å¤–ç½‘ç½‘å¡è®¿é—®</li><li>å¼€å¯é˜²ç«å¢™</li><li>ä¸è¦ä½¿ç”¨Rootè´¦æˆ·å¯åŠ¨Redis</li><li>å°½é‡ä¸æ˜¯æœ‰é»˜è®¤çš„ç«¯å£</li></ul><hr><hr><h2 id="Rediså†…å­˜åˆ’åˆ†å’Œå†…å­˜é…ç½®">Rediså†…å­˜åˆ’åˆ†å’Œå†…å­˜é…ç½®</h2><p>å½“Rediså†…å­˜ä¸è¶³æ—¶ï¼Œå¯èƒ½å¯¼è‡´Keyé¢‘ç¹è¢«åˆ é™¤ã€å“åº”æ—¶é—´å˜é•¿ã€QPSä¸ç¨³å®šç­‰é—®é¢˜ã€‚å½“å†…å­˜ä½¿ç”¨ç‡è¾¾åˆ°90%ä»¥ä¸Šæ—¶å°±éœ€è¦æˆ‘ä»¬è­¦æƒ•ï¼Œå¹¶å¿«é€Ÿå®šä½åˆ°å†…å­˜å ç”¨çš„åŸå› ã€‚</p><p><strong>æœ‰å…³ç¢ç‰‡é—®é¢˜åˆ†æ</strong></p><p>Redisåº•å±‚åˆ†é…å¹¶ä¸æ˜¯è¿™ä¸ªkeyæœ‰å¤šå¤§ï¼Œä»–å°±ä¼šåˆ†é…å¤šå¤§ï¼Œè€Œæ˜¯æœ‰ä»–è‡ªå·±çš„åˆ†é…ç­–ç•¥ï¼Œæ¯”å¦‚8,16,20ç­‰ç­‰ï¼Œå‡å®šå½“å‰keyåªéœ€è¦10ä¸ªå­—èŠ‚ï¼Œæ­¤æ—¶åˆ†é…8è‚¯å®šä¸å¤Ÿï¼Œé‚£ä¹ˆä»–å°±ä¼šåˆ†é…16ä¸ªå­—èŠ‚ï¼Œå¤šå‡ºæ¥çš„6ä¸ªå­—èŠ‚å°±ä¸èƒ½è¢«ä½¿ç”¨ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ ç¢ç‰‡é—®é¢˜</p><p><strong>è¿›ç¨‹å†…å­˜é—®é¢˜åˆ†æï¼š</strong></p><p>è¿™ç‰‡å†…å­˜ï¼Œé€šå¸¸æˆ‘ä»¬éƒ½å¯ä»¥å¿½ç•¥ä¸è®¡</p><p><strong>ç¼“å†²åŒºå†…å­˜é—®é¢˜åˆ†æï¼š</strong></p><p>ä¸€èˆ¬åŒ…æ‹¬å®¢æˆ·ç«¯ç¼“å†²åŒºã€AOFç¼“å†²åŒºã€å¤åˆ¶ç¼“å†²åŒºç­‰ã€‚å®¢æˆ·ç«¯ç¼“å†²åŒºåˆåŒ…æ‹¬è¾“å…¥ç¼“å†²åŒºå’Œè¾“å‡ºç¼“å†²åŒºä¸¤ç§ã€‚è¿™éƒ¨åˆ†å†…å­˜å ç”¨æ³¢åŠ¨è¾ƒå¤§ï¼Œæ‰€ä»¥è¿™ç‰‡å†…å­˜ä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦é‡ç‚¹åˆ†æçš„å†…å­˜é—®é¢˜ã€‚</p><table><thead><tr><th><strong>å†…å­˜å ç”¨</strong></th><th><strong>è¯´æ˜</strong></th></tr></thead><tbody><tr><td>æ•°æ®å†…å­˜</td><td>æ˜¯Redisæœ€ä¸»è¦çš„éƒ¨åˆ†ï¼Œå­˜å‚¨Redisçš„é”®å€¼ä¿¡æ¯ã€‚ä¸»è¦é—®é¢˜æ˜¯BigKeyé—®é¢˜ã€å†…å­˜ç¢ç‰‡é—®é¢˜</td></tr><tr><td>è¿›ç¨‹å†…å­˜</td><td>Redisä¸»è¿›ç¨‹æœ¬èº«è¿â¾è‚¯å®šéœ€è¦å â½¤å†…å­˜ï¼Œå¦‚ä»£ç ã€å¸¸é‡æ± ç­‰ç­‰ï¼›è¿™éƒ¨åˆ†å†…å­˜â¼¤çº¦â¼å…†ï¼Œåœ¨â¼¤å¤šæ•°â½£äº§ç¯å¢ƒä¸­ä¸Redisæ•°æ®å â½¤çš„å†…å­˜ç›¸â½å¯ä»¥å¿½ç•¥ã€‚</td></tr><tr><td>ç¼“å†²åŒºå†…å­˜</td><td>ä¸€èˆ¬åŒ…æ‹¬å®¢æˆ·ç«¯ç¼“å†²åŒºã€AOFç¼“å†²åŒºã€å¤åˆ¶ç¼“å†²åŒºç­‰ã€‚å®¢æˆ·ç«¯ç¼“å†²åŒºåˆåŒ…æ‹¬è¾“å…¥ç¼“å†²åŒºå’Œè¾“å‡ºç¼“å†²åŒºä¸¤ç§ã€‚è¿™éƒ¨åˆ†å†…å­˜å ç”¨æ³¢åŠ¨è¾ƒå¤§ï¼Œä¸å½“ä½¿ç”¨BigKeyï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºã€‚</td></tr></tbody></table><p>äºæ˜¯æˆ‘ä»¬å°±éœ€è¦é€šè¿‡ä¸€äº›å‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹åˆ°Redisç›®å‰çš„å†…å­˜åˆ†é…çŠ¶æ€ï¼š</p><div class="tabs" id="4c71f7b2-4ce1-4f9e-899a-2b35b26b6ee6"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#4c71f7b2-4ce1-4f9e-899a-2b35b26b6ee6-1"><i class="fas fa-seedling"></i>1</button></li><li class="tab"><button type="button" data-href="#4c71f7b2-4ce1-4f9e-899a-2b35b26b6ee6-2"><i class="fas fa-leaf"></i>2</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="4c71f7b2-4ce1-4f9e-899a-2b35b26b6ee6-1"><p>info memoryï¼šæŸ¥çœ‹å†…å­˜åˆ†é…çš„æƒ…å†µ</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653132073570.png" alt="1653132073570"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4c71f7b2-4ce1-4f9e-899a-2b35b26b6ee6-2"><ul><li>memory xxxï¼šæŸ¥çœ‹keyçš„ä¸»è¦å ç”¨æƒ…å†µ</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653132098823.png" alt="1653132098823"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹åˆ°äº†è¿™äº›é…ç½®ï¼Œæœ€å…³é”®çš„ç¼“å­˜åŒºå†…å­˜å¦‚ä½•å®šä½å’Œè§£å†³å‘¢ï¼Ÿ</p><p>å†…å­˜ç¼“å†²åŒºå¸¸è§çš„æœ‰ä¸‰ç§ï¼š</p><ul><li>å¤åˆ¶ç¼“å†²åŒºï¼šä¸»ä»å¤åˆ¶çš„repl_backlog_bufï¼Œå¦‚æœå¤ªå°å¯èƒ½å¯¼è‡´é¢‘ç¹çš„å…¨é‡å¤åˆ¶ï¼Œå½±å“æ€§èƒ½ã€‚é€šè¿‡replbacklog-sizeæ¥è®¾ç½®ï¼Œé»˜è®¤1mb</li><li>AOFç¼“å†²åŒºï¼šAOFåˆ·ç›˜ä¹‹å‰çš„ç¼“å­˜åŒºåŸŸï¼ŒAOFæ‰§è¡Œrewriteçš„ç¼“å†²åŒºã€‚æ— æ³•è®¾ç½®å®¹é‡ä¸Šé™</li><li>å®¢æˆ·ç«¯ç¼“å†²åŒºï¼šåˆ†ä¸ºè¾“å…¥ç¼“å†²åŒºå’Œè¾“å‡ºç¼“å†²åŒºï¼Œè¾“å…¥ç¼“å†²åŒºæœ€å¤§1Gä¸”ä¸èƒ½è®¾ç½®ã€‚è¾“å‡ºç¼“å†²åŒºå¯ä»¥è®¾ç½®</li></ul><p>ä»¥ä¸Šå¤åˆ¶ç¼“å†²åŒºå’ŒAOFç¼“å†²åŒº ä¸ä¼šæœ‰é—®é¢˜ï¼Œæœ€å…³é”®å°±æ˜¯å®¢æˆ·ç«¯ç¼“å†²åŒºçš„é—®é¢˜</p><p>å®¢æˆ·ç«¯ç¼“å†²åŒºï¼šæŒ‡çš„å°±æ˜¯æˆ‘ä»¬å‘é€å‘½ä»¤æ—¶ï¼Œå®¢æˆ·ç«¯ç”¨æ¥ç¼“å­˜å‘½ä»¤çš„ä¸€ä¸ªç¼“å†²åŒºï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å‘redisè¾“å…¥æ•°æ®çš„è¾“å…¥ç«¯ç¼“å†²åŒºå’Œrediså‘å®¢æˆ·ç«¯è¿”å›æ•°æ®çš„å“åº”ç¼“å­˜åŒºï¼Œè¾“å…¥ç¼“å†²åŒºæœ€å¤§1Gä¸”ä¸èƒ½è®¾ç½®ï¼Œæ‰€ä»¥è¿™ä¸€å—æˆ‘ä»¬æ ¹æœ¬ä¸ç”¨æ‹…å¿ƒï¼Œå¦‚æœè¶…è¿‡äº†è¿™ä¸ªç©ºé—´ï¼Œredisä¼šç›´æ¥æ–­å¼€ï¼Œå› ä¸ºæœ¬æ¥æ­¤æ—¶æ­¤åˆ»å°±ä»£è¡¨ç€rediså¤„ç†ä¸è¿‡æ¥äº†ï¼Œæˆ‘ä»¬éœ€è¦æ‹…å¿ƒçš„å°±æ˜¯è¾“å‡ºç«¯ç¼“å†²åŒº</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653132410073.png" alt="1653132410073"></p><p>æˆ‘ä»¬åœ¨ä½¿ç”¨redisè¿‡ç¨‹ä¸­ï¼Œå¤„ç†å¤§é‡çš„big valueï¼Œé‚£ä¹ˆä¼šå¯¼è‡´æˆ‘ä»¬çš„è¾“å‡ºç»“æœè¿‡å¤šï¼Œå¦‚æœè¾“å‡ºç¼“å­˜åŒºè¿‡å¤§ï¼Œä¼šå¯¼è‡´redisç›´æ¥æ–­å¼€ï¼Œè€Œé»˜è®¤é…ç½®çš„æƒ…å†µä¸‹ï¼Œ å…¶å®ä»–æ˜¯æ²¡æœ‰å¤§å°çš„ï¼Œè¿™å°±æ¯”è¾ƒå‘äº†ï¼Œå†…å­˜å¯èƒ½ä¸€ä¸‹å­è¢«å æ»¡ï¼Œä¼šç›´æ¥å¯¼è‡´å’±ä»¬çš„redisæ–­å¼€ï¼Œæ‰€ä»¥è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ä¸ª</p><p>1ã€è®¾ç½®ä¸€ä¸ªå¤§å°</p><p>2ã€å¢åŠ æˆ‘ä»¬å¸¦å®½çš„å¤§å°ï¼Œé¿å…æˆ‘ä»¬å‡ºç°å¤§é‡æ•°æ®ä»è€Œç›´æ¥è¶…è¿‡äº†redisçš„æ‰¿å—èƒ½åŠ›</p><hr><hr><h2 id="é›†ç¾¤è¿˜æ˜¯ä¸»ä»">é›†ç¾¤è¿˜æ˜¯ä¸»ä»</h2><p>é›†ç¾¤è™½ç„¶å…·å¤‡é«˜å¯ç”¨ç‰¹æ€§ï¼Œèƒ½å®ç°è‡ªåŠ¨æ•…éšœæ¢å¤ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨ä¸å½“ï¼Œä¹Ÿä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š</p><ul><li>é›†ç¾¤å®Œæ•´æ€§é—®é¢˜</li><li>é›†ç¾¤å¸¦å®½é—®é¢˜</li><li>æ•°æ®å€¾æ–œé—®é¢˜</li><li>å®¢æˆ·ç«¯æ€§èƒ½é—®é¢˜</li><li>å‘½ä»¤çš„é›†ç¾¤å…¼å®¹æ€§é—®é¢˜</li><li>luaå’Œäº‹åŠ¡é—®é¢˜</li></ul><p><strong>é—®é¢˜1ã€åœ¨Redisçš„é»˜è®¤é…ç½®ä¸­ï¼Œå¦‚æœå‘ç°ä»»æ„ä¸€ä¸ªæ’æ§½ä¸å¯ç”¨ï¼Œåˆ™æ•´ä¸ªé›†ç¾¤éƒ½ä¼šåœæ­¢å¯¹å¤–æœåŠ¡ï¼š</strong></p><p>å¤§å®¶å¯ä»¥è®¾æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæœ‰å‡ ä¸ªslotä¸èƒ½ä½¿ç”¨ï¼Œé‚£ä¹ˆæ­¤æ—¶æ•´ä¸ªé›†ç¾¤éƒ½ä¸èƒ½ç”¨äº†ï¼Œæˆ‘ä»¬åœ¨å¼€å‘ä¸­ï¼Œå…¶å®æœ€é‡è¦çš„æ˜¯å¯ç”¨æ€§ï¼Œæ‰€ä»¥éœ€è¦æŠŠå¦‚ä¸‹é…ç½®ä¿®æ”¹æˆnoï¼Œå³æœ‰slotä¸èƒ½ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬çš„redisé›†ç¾¤è¿˜æ˜¯å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653132740637.png" alt="1653132740637"></p><p><strong>é—®é¢˜2ã€é›†ç¾¤å¸¦å®½é—®é¢˜</strong></p><p>é›†ç¾¤èŠ‚ç‚¹ä¹‹é—´ä¼šä¸æ–­çš„äº’ç›¸Pingæ¥ç¡®å®šé›†ç¾¤ä¸­å…¶å®ƒèŠ‚ç‚¹çš„çŠ¶æ€ã€‚æ¯æ¬¡Pingæºå¸¦çš„ä¿¡æ¯è‡³å°‘åŒ…æ‹¬ï¼š</p><ul><li>æ’æ§½ä¿¡æ¯</li><li>é›†ç¾¤çŠ¶æ€ä¿¡æ¯</li></ul><p>é›†ç¾¤ä¸­èŠ‚ç‚¹è¶Šå¤šï¼Œé›†ç¾¤çŠ¶æ€ä¿¡æ¯æ•°æ®é‡ä¹Ÿè¶Šå¤§ï¼Œ10ä¸ªèŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯å¯èƒ½è¾¾åˆ°1kbï¼Œæ­¤æ—¶æ¯æ¬¡é›†ç¾¤äº’é€šéœ€è¦çš„å¸¦å®½ä¼šéå¸¸é«˜ï¼Œè¿™æ ·ä¼šå¯¼è‡´é›†ç¾¤ä¸­å¤§é‡çš„å¸¦å®½éƒ½ä¼šè¢«pingä¿¡æ¯æ‰€å ç”¨ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¯æ€•çš„é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»è§£å†³è¿™æ ·çš„é—®é¢˜</p><p><strong>è§£å†³é€”å¾„ï¼š</strong></p><ul><li>é¿å…å¤§é›†ç¾¤ï¼Œé›†ç¾¤èŠ‚ç‚¹æ•°ä¸è¦å¤ªå¤šï¼Œæœ€å¥½å°‘äº1000ï¼Œå¦‚æœä¸šåŠ¡åºå¤§ï¼Œåˆ™å»ºç«‹å¤šä¸ªé›†ç¾¤ã€‚</li><li>é¿å…åœ¨å•ä¸ªç‰©ç†æœºä¸­è¿è¡Œå¤ªå¤šRediså®ä¾‹</li><li>é…ç½®åˆé€‚çš„cluster-node-timeoutå€¼</li></ul><p><strong>é—®é¢˜3ã€å‘½ä»¤çš„é›†ç¾¤å…¼å®¹æ€§é—®é¢˜</strong></p><p>æœ‰å…³è¿™ä¸ªé—®é¢˜å’±ä»¬å·²ç»æ¢è®¨è¿‡äº†ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨æ‰¹å¤„ç†çš„å‘½ä»¤æ—¶ï¼Œredisè¦æ±‚æˆ‘ä»¬çš„keyå¿…é¡»è½åœ¨ç›¸åŒçš„slotä¸Šï¼Œç„¶åå¤§é‡çš„keyåŒæ—¶æ“ä½œæ—¶ï¼Œæ˜¯æ— æ³•å®Œæˆçš„ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯å¿…é¡»è¦å¯¹è¿™æ ·çš„æ•°æ®è¿›è¡Œå¤„ç†ï¼Œè¿™äº›æ–¹æ¡ˆæˆ‘ä»¬ä¹‹å‰å·²ç»æ¢è®¨è¿‡äº†ï¼Œæ‰€ä»¥ä¸å†è¿™ä¸ªåœ°æ–¹èµ˜è¿°äº†ã€‚</p><p><strong>é—®é¢˜4ã€luaå’Œäº‹åŠ¡çš„é—®é¢˜</strong></p><p>luaå’Œäº‹åŠ¡éƒ½æ˜¯è¦ä¿è¯åŸå­æ€§é—®é¢˜ï¼Œå¦‚æœä½ çš„keyä¸åœ¨ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ˜¯æ— æ³•ä¿è¯luaçš„æ‰§è¡Œå’Œäº‹åŠ¡çš„ç‰¹æ€§çš„ï¼Œæ‰€ä»¥åœ¨é›†ç¾¤æ¨¡å¼æ˜¯æ²¡æœ‰åŠæ³•æ‰§è¡Œluaå’Œäº‹åŠ¡çš„</p><p><strong>é‚£æˆ‘ä»¬åˆ°åº•æ˜¯é›†ç¾¤è¿˜æ˜¯ä¸»ä»</strong></p><p>å•ä½“Redisï¼ˆä¸»ä»Redisï¼‰å·²ç»èƒ½è¾¾åˆ°ä¸‡çº§åˆ«çš„QPSï¼Œå¹¶ä¸”ä¹Ÿå…·å¤‡å¾ˆå¼ºçš„é«˜å¯ç”¨ç‰¹æ€§ã€‚å¦‚æœä¸»ä»èƒ½æ»¡è¶³ä¸šåŠ¡éœ€æ±‚çš„æƒ…å†µä¸‹ï¼Œæ‰€ä»¥å¦‚æœä¸æ˜¯åœ¨ä¸‡ä¸å¾—å·²çš„æƒ…å†µä¸‹ï¼Œå°½é‡ä¸æ­å»ºRedisé›†ç¾¤</p>]]></content>
    
    
    <summary type="html">åˆ†å¸ƒå¼ç¼“å­˜</summary>
    
    
    
    <category term="æ•°æ®åº“" scheme="https://wuwawawa.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="Redis" scheme="https://wuwawawa.github.io/tags/Redis/"/>
    
    <category term="æ•°æ®åº“" scheme="https://wuwawawa.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>Rediså®æˆ˜</title>
    <link href="https://wuwawawa.github.io/posts/1bd023c5.html"/>
    <id>https://wuwawawa.github.io/posts/1bd023c5.html</id>
    <published>2023-06-07T01:27:51.000Z</published>
    <updated>2023-06-12T05:12:22.945Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æŸ¥è¯¢ç¼“å­˜">æŸ¥è¯¢ç¼“å­˜</h2><h3 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç¼“å­˜">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç¼“å­˜</h3><p>ä¸€å¥è¯:å› ä¸º<span class='p green'>é€Ÿåº¦å¿«å¥½ç”¨</span></p><p>ç¼“å­˜æ•°æ®å­˜å‚¨äºä»£ç ä¸­,è€Œä»£ç è¿è¡Œåœ¨å†…å­˜ä¸­,å†…å­˜çš„è¯»å†™æ€§èƒ½è¿œé«˜äºç£ç›˜,ç¼“å­˜å¯ä»¥å¤§å¤§é™ç”¨æˆ·è®¿é—®å¹¶å‘é‡å¸¦æ¥çš„æœåŠ¡å™¨è¯»å†™å‹åŠ›</p><p>å®é™…å¼€å‘è¿‡ç¨‹ä¸­,ä¼ä¸šçš„æ•°æ®é‡,å°‘åˆ™å‡ åä¸‡,å¤šåˆ™å‡ åƒä¸‡,è¿™ä¹ˆå¤§æ•°æ®é‡,å¦‚æœæ²¡æœ‰ç¼“å­˜æ¥ä½œä¸º&quot;é¿éœ‡å™¨&quot;,ç³»ç»Ÿæ˜¯å‡ ä¹æ’‘ä¸ä½çš„,æ‰€ä»¥ä¼ä¸šä¼šå¤§é‡è¿ç”¨åˆ°ç¼“å­˜æŠ€æœ¯;</p><p>ä½†æ˜¯ç¼“å­˜ä¹Ÿä¼šå¢åŠ ä»£ç å¤æ‚åº¦å’Œè¿è¥çš„æˆæœ¬:</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220523214414123.png" alt="image-20220523214414123" style="zoom:67%;" /><hr><h3 id="å¦‚ä½•ä½¿ç”¨ç¼“å­˜">å¦‚ä½•ä½¿ç”¨ç¼“å­˜</h3><p>å®é™…å¼€å‘ä¸­,ä¼šæ„ç­‘å¤šçº§ç¼“å­˜æ¥ä½¿ç³»ç»Ÿè¿è¡Œé€Ÿåº¦è¿›ä¸€æ­¥æå‡,ä¾‹å¦‚:æœ¬åœ°ç¼“å­˜ä¸redisä¸­çš„ç¼“å­˜å¹¶å‘ä½¿ç”¨</p><p>æµè§ˆå™¨ç¼“å­˜ï¼šä¸»è¦æ˜¯å­˜åœ¨äºæµè§ˆå™¨ç«¯çš„ç¼“å­˜</p><p>åº”ç”¨å±‚ç¼“å­˜ï¼šå¯ä»¥åˆ†ä¸ºtomcatæœ¬åœ°ç¼“å­˜ï¼Œæ¯”å¦‚ä¹‹å‰æåˆ°çš„mapï¼Œæˆ–è€…æ˜¯ä½¿ç”¨redisä½œä¸ºç¼“å­˜</p><p>æ•°æ®åº“ç¼“å­˜ï¼šåœ¨æ•°æ®åº“ä¸­æœ‰ä¸€ç‰‡ç©ºé—´æ˜¯ buffer poolï¼Œå¢æ”¹æŸ¥æ•°æ®éƒ½ä¼šå…ˆåŠ è½½åˆ°mysqlçš„ç¼“å­˜ä¸­</p><p>CPUç¼“å­˜ï¼šå½“ä»£è®¡ç®—æœºæœ€å¤§çš„é—®é¢˜æ˜¯ cpuæ€§èƒ½æå‡äº†ï¼Œä½†å†…å­˜è¯»å†™é€Ÿåº¦æ²¡æœ‰è·Ÿä¸Šï¼Œæ‰€ä»¥ä¸ºäº†é€‚åº”å½“ä¸‹çš„æƒ…å†µï¼Œå¢åŠ äº†cpuçš„L1ï¼ŒL2ï¼ŒL3çº§çš„ç¼“å­˜</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220523212915666.png" alt="image-20220523212915666" style="zoom:67%;" /><hr><h3 id="æ·»åŠ ç¼“å­˜ç¤ºä¾‹">æ·»åŠ ç¼“å­˜ç¤ºä¾‹</h3><div class="tabs" id="84f6d553-6ab6-4b83-b7b7-552490e051a5"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#84f6d553-6ab6-4b83-b7b7-552490e051a5-1"><i class="fas fa-seedling"></i>åŸæœ¬æ“ä½œ</button></li><li class="tab"><button type="button" data-href="#84f6d553-6ab6-4b83-b7b7-552490e051a5-2"><i class="fas fa-leaf"></i>æ”¹è¿›æ€è·¯</button></li><li class="tab"><button type="button" data-href="#84f6d553-6ab6-4b83-b7b7-552490e051a5-3"><i class="fab fa-apple"></i>å®ç°ä»£ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="84f6d553-6ab6-4b83-b7b7-552490e051a5-1"><p>åœ¨æˆ‘ä»¬æŸ¥è¯¢å•†æˆ·ä¿¡æ¯æ—¶ï¼Œæˆ‘ä»¬æ˜¯ç›´æ¥æ“ä½œä»æ•°æ®åº“ä¸­å»è¿›è¡ŒæŸ¥è¯¢çš„ï¼Œå¤§è‡´é€»è¾‘æ˜¯è¿™æ ·ï¼Œç›´æ¥æŸ¥è¯¢æ•°æ®åº“é‚£è‚¯å®šæ…¢å’¯ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¢åŠ ç¼“å­˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//è¿™é‡Œæ˜¯ç›´æ¥æŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">    <span class="keyword">return</span> shopService.queryById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="84f6d553-6ab6-4b83-b7b7-552490e051a5-2"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653322097736.png" alt="1653322097736" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="84f6d553-6ab6-4b83-b7b7-552490e051a5-3"><p>ä»£ç æ€è·¯ï¼šå¦‚æœç¼“å­˜æœ‰ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå¦‚æœç¼“å­˜ä¸å­˜åœ¨ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åå­˜å…¥redisã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653322190155.png" alt="1653322190155" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="ç¼“å­˜æ›´æ–°ç­–ç•¥">ç¼“å­˜æ›´æ–°ç­–ç•¥</h3><p>ç¼“å­˜æ›´æ–°æ˜¯redisä¸ºäº†èŠ‚çº¦å†…å­˜è€Œè®¾è®¡å‡ºæ¥çš„ä¸€ä¸ªä¸œè¥¿ï¼Œä¸»è¦æ˜¯å› ä¸ºå†…å­˜æ•°æ®å®è´µï¼Œå½“æˆ‘ä»¬å‘redisæ’å…¥å¤ªå¤šæ•°æ®ï¼Œæ­¤æ—¶å°±å¯èƒ½ä¼šå¯¼è‡´ç¼“å­˜ä¸­çš„æ•°æ®è¿‡å¤šï¼Œæ‰€ä»¥redisä¼šå¯¹éƒ¨åˆ†æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œæˆ–è€…æŠŠä»–å«ä¸ºæ·˜æ±°æ›´åˆé€‚ã€‚</p><p>å†…å­˜æ·˜æ±°ï¼šredisè‡ªåŠ¨è¿›è¡Œï¼Œå½“rediså†…å­˜è¾¾åˆ°å’±ä»¬è®¾å®šçš„max-memeryçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨è§¦å‘æ·˜æ±°æœºåˆ¶ï¼Œæ·˜æ±°æ‰ä¸€äº›ä¸é‡è¦çš„æ•°æ®(å¯ä»¥è‡ªå·±è®¾ç½®ç­–ç•¥æ–¹å¼)</p><p>è¶…æ—¶å‰”é™¤ï¼šå½“æˆ‘ä»¬ç»™redisè®¾ç½®äº†è¿‡æœŸæ—¶é—´ttlä¹‹åï¼Œredisä¼šå°†è¶…æ—¶çš„æ•°æ®è¿›è¡Œåˆ é™¤ï¼Œæ–¹ä¾¿å’±ä»¬ç»§ç»­ä½¿ç”¨ç¼“å­˜</p><p>ä¸»åŠ¨æ›´æ–°ï¼šæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨è°ƒç”¨æ–¹æ³•æŠŠç¼“å­˜åˆ æ‰ï¼Œé€šå¸¸ç”¨äºè§£å†³ç¼“å­˜å’Œæ•°æ®åº“ä¸ä¸€è‡´é—®é¢˜</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">å†…å­˜æ·˜æ±°</th><th style="text-align:center">è¶…æ—¶å‰”é™¤</th><th style="text-align:center">ä¸»åŠ¨æ›´æ–°</th></tr></thead><tbody><tr><td style="text-align:center">è¯´æ˜</td><td style="text-align:center">ä¸ç”¨è‡ªå·±ç»´æŠ¤ï¼Œåˆ©ç”¨Redisçš„å…§å­˜æ·˜æ±°æœºåˆ¶ï¼Œå½“å†…å­˜ä¸è¶³æ—¶è‡ªåŠ¨æ·˜æ±°éƒ¨åˆ†æ•°æ®ã€‚ä¸‹æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ç¼“å­˜ã€‚</td><td style="text-align:center">ç»™ç¼“å­˜æ•°æ®æ·»åŠ TTLæ—¶é—´ï¼Œåˆ°æœŸåè‡ªåŠ¨åˆ é™¤ç¼“å­˜ã€‚ä¸‹æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ç¼“å­˜ã€‚</td><td style="text-align:center">ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œåœ¨ä¿®æ”¹æ•°æ®åº“çš„åŒæ—¶ï¼Œæ›´æ–°ç¼“å­˜ã€‚</td></tr><tr><td style="text-align:center">ä¸€è‡´æ€§</td><td style="text-align:center">å·®</td><td style="text-align:center">ä¸€èˆ¬</td><td style="text-align:center">å¥½</td></tr><tr><td style="text-align:center">ç»´æŠ¤æˆæœ¬</td><td style="text-align:center">æ— </td><td style="text-align:center">åº•</td><td style="text-align:center">é«˜</td></tr></tbody></table><p>ä¸šåŠ¡åœºæ™¯ï¼š</p><p>ä½ä¸€è‡´æ€§éœ€æ±‚ï¼šä½¿ç”¨å†…å­˜æ·˜æ±°æœºåˆ¶ã€‚ä¾‹å¦‚åº—é“ºç±»å‹çš„æŸ¥è¯¢ç¼“å­˜</p><p>é«˜ä¸€è‡´æ€§éœ€æ±‚ï¼šä¸»åŠ¨æ›´æ–°ï¼Œå¹¶ä»¥è¶…æ—¶å‰”é™¤ä½œä¸ºå…œåº•æ–¹æ¡ˆã€‚ä¾‹å¦‚åº—é“ºè¯¦æƒ…æŸ¥è¯¢çš„ç¼“å­˜</p><hr><p>ä¸»åŠ¨æ›´æ–°ä¸šåŠ¡å®ç°å¸¸è§çš„æœ‰ä¸‰ç§æ¨¡å¼ï¼š</p><p>Cache Aside Patternï¼šç”±ç¼“å­˜çš„è°ƒç”¨è€…ï¼Œåœ¨æ›´æ–°æ•°æ®åº“çš„åŒæ—¶æ›´æ–°ç¼“å­˜</p><p>Read/Write Through Patternï¼šç¼“å­˜ä¸æ•°æ®åº“æ•´åˆä¸ºä¸€ä¸ªæœåŠ¡ï¼Œ ç”±æœåŠ¡æ¥ç»´æŠ¤ä¸€è‡´æ€§ã€‚è°ƒç”¨è€…è°ƒç”¨è¯¥æœåŠ¡ï¼Œæ— éœ€å…³å¿ƒç¼“å­˜ä¸€è‡´æ€§é—®é¢˜</p><p>Write Behind Caching Patternï¼šè°ƒç”¨è€…åªæ“ä½œç¼“å­˜ï¼Œç”±å…¶å®ƒçº¿ç¨‹å¼‚æ­¥çš„å°†ç¼“å­˜æ•°æ®æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨æœ€å¤šçš„è¿˜æ˜¯æ–¹æ¡ˆä¸€ï¼šCache Aside Patternã€‚</p><p>å› æ­¤åœ¨ç¼–ç è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘å‡ ä¸ªé—®é¢˜</p><mark class="hl-label blue">åˆ é™¤ç¼“å­˜è¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ</mark> <ul><li><span class='p red'>æ›´æ–°ç¼“å­˜</span>ï¼šæ¯æ¬¡æ›´æ–°æ•°æ®åº“éƒ½æ›´æ–°ç¼“å­˜ï¼Œæ— æ•ˆå†™æ“ä½œè¾ƒå¤šâŒ</li><li><span class='p green'>åˆ é™¤ç¼“å­˜</span>ï¼šæ›´æ–°æ•°æ®åº“æ—¶è®©ç¼“å­˜å¤±æ•ˆï¼ŒæŸ¥è¯¢æ—¶å†æ›´æ–°ç¼“å­˜âœ…</li></ul><mark class="hl-label blue">å¦‚ä½•ä¿è¯ç¼“å­˜ä¸æ•°æ®åº“çš„æ“ä½œçš„åŒæ—¶æˆåŠŸæˆ–å¤±è´¥ï¼Ÿ</mark> <ul><li>å•ä½“ç³»ç»Ÿï¼Œå°†ç¼“å­˜ä¸æ•°æ®åº“æ“ä½œæ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡</li><li>åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåˆ©ç”¨TCCç­‰åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ</li></ul><mark class="hl-label blue">å…ˆæ“ä½œç¼“å­˜è¿˜æ˜¯å…ˆæ“ä½œæ•°æ®åº“ï¼Ÿ</mark> <ul><li><span class='p red'>å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ“ä½œæ•°æ®åº“</span>âŒ</li><li><span class='p green'>å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</span>âœ…</li></ul><p>æˆ‘ä»¬åº”å½“æ˜¯å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ï¼ŒåŸå› åœ¨äºï¼Œå¦‚æœä½ é€‰æ‹©ç¬¬ä¸€ç§æ–¹æ¡ˆï¼Œåœ¨ä¸¤ä¸ªçº¿ç¨‹å¹¶å‘æ¥è®¿é—®æ—¶ï¼Œå‡è®¾çº¿ç¨‹1å…ˆæ¥ï¼Œä»–å…ˆæŠŠç¼“å­˜åˆ äº†ï¼Œæ­¤æ—¶çº¿ç¨‹2è¿‡æ¥ï¼Œä»–æŸ¥è¯¢ç¼“å­˜æ•°æ®å¹¶ä¸å­˜åœ¨ï¼Œæ­¤æ—¶ä»–å†™å…¥ç¼“å­˜ï¼Œå½“ä»–å†™å…¥ç¼“å­˜åï¼Œçº¿ç¨‹1å†æ‰§è¡Œæ›´æ–°åŠ¨ä½œæ—¶ï¼Œå®é™…ä¸Šå†™å…¥çš„å°±æ˜¯æ—§çš„æ•°æ®ï¼Œæ–°çš„æ•°æ®è¢«æ—§æ•°æ®è¦†ç›–äº†ã€‚</p><p>æ–¹æ¡ˆäºŒåŒæ ·å¯èƒ½å‘ç”Ÿä¸ä¸€è‡´é—®é¢˜ï¼Œå½“çº¿ç¨‹1æŸ¥è¯¢æ—¶ç¼“å­˜åˆšå¥½å¤±æ•ˆäº†ï¼Œæ­¤æ—¶çº¿ç¨‹2è¿‡æ¥æ›´æ–°æ•°æ®åº“åˆ é™¤ç¼“å­˜ï¼Œçº¿ç¨‹1å†æŠŠæ—§æ•°æ®å†™å…¥ç¼“å­˜ã€‚ä½†æ˜¯è¿™ç§æƒ…å†µç›¸å¯¹æ¥è¯´å‡ºç°çš„å¯èƒ½æ€§æ¯”è¾ƒä½ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653323595206.png" alt="1653323595206" style="zoom:67%;" /><mark class="hl-label blue">ä»£ç å®ç°</mark> <div class="tabs" id="e590ce20-d8fc-4b54-bf5b-e8ff4675c66e"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e590ce20-d8fc-4b54-bf5b-e8ff4675c66e-1"><i class="fas fa-bug"></i>æ ¸å¿ƒæ€è·¯</button></li><li class="tab"><button type="button" data-href="#e590ce20-d8fc-4b54-bf5b-e8ff4675c66e-2"><i class="fas fa-cannabis"></i>è®¾ç½®redisç¼“å­˜æ—¶æ·»åŠ è¿‡æœŸæ—¶é—´</button></li><li class="tab"><button type="button" data-href="#e590ce20-d8fc-4b54-bf5b-e8ff4675c66e-3"><i class="fas fa-candy-cane"></i>æ›´æ–°æ•°æ®åº“æ—¶åˆ é™¤ç¼“å­˜</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e590ce20-d8fc-4b54-bf5b-e8ff4675c66e-1"><p>æ ¸å¿ƒæ€è·¯å¦‚ä¸‹ï¼š</p><p>ä¿®æ”¹ShopControllerä¸­çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ»¡è¶³ä¸‹é¢çš„éœ€æ±‚ï¼š</p><p>æ ¹æ®idæŸ¥è¯¢åº—é“ºæ—¶ï¼Œå¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå°†æ•°æ®åº“ç»“æœå†™å…¥ç¼“å­˜ï¼Œå¹¶è®¾ç½®è¶…æ—¶æ—¶é—´</p><p>æ ¹æ®idä¿®æ”¹åº—é“ºæ—¶ï¼Œå…ˆä¿®æ”¹æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e590ce20-d8fc-4b54-bf5b-e8ff4675c66e-2"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653325871232.png" alt="1653325871232"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e590ce20-d8fc-4b54-bf5b-e8ff4675c66e-3"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653325929549.png" alt="1653325929549"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><mark class="hl-label blue">æ€»ç»“ï¼šç¼“å­˜æ›´æ–°ç­–ç•¥çš„æœ€ä½³å®è·µæ–¹æ¡ˆ</mark> <p>1.ä½ä¸€è‡´æ€§éœ€æ±‚ï¼šä½¿ç”¨Redisè‡ªå¸¦çš„å†…å­˜æ·˜æ±°æœºåˆ¶</p><p>2.é«˜ä¸€è‡´æ€§éœ€æ±‚ï¼šä¸»åŠ¨æ›´æ–°ï¼Œå¹¶ä»¥è¶…æ—¶å‰”é™¤ä½œä¸ºå…œåº•æ–¹æ¡ˆ</p><ul><li>è¯»æ“ä½œ<ul><li>ç¼“å­˜å‘½ä¸­ç›´æ¥è¿”å›</li><li>ç¼“å­˜æœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶å†™å…¥ç¼“å­˜ï¼Œè®¾å®šè¶…æ—¶æ—¶é—´</li></ul></li><li>å†™æ“ä½œ<ul><li>å…ˆå†™æ•°æ®åº“ï¼Œç„¶ååˆ é™¤ç¼“å­˜</li><li>è¦ç¡®ä¿æ•°æ®åº“ä¸ç¼“å­˜æ“ä½œçš„åŸå­æ€§</li></ul></li></ul><hr><h3 id="ç¼“å­˜ç©¿é€">ç¼“å­˜ç©¿é€</h3><p>ç¼“å­˜ç©¿é€ ï¼šç¼“å­˜ç©¿é€æ˜¯æŒ‡å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œè¿™æ ·ç¼“å­˜æ°¸è¿œä¸ä¼šç”Ÿæ•ˆï¼Œè¿™äº›è¯·æ±‚éƒ½ä¼šæ‰“åˆ°æ•°æ®åº“ã€‚</p><p>å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</p><div class="tabs" id="b931f832-db95-4426-be0c-b4fa3d765ef3"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#b931f832-db95-4426-be0c-b4fa3d765ef3-1"><i class="fas fa-cat"></i>ç¼“å­˜ç©ºå¯¹è±¡</button></li><li class="tab"><button type="button" data-href="#b931f832-db95-4426-be0c-b4fa3d765ef3-2"><i class="fas fa-horse"></i>å¸ƒéš†è¿‡æ»¤</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="b931f832-db95-4426-be0c-b4fa3d765ef3-1"><p>å½“æˆ‘ä»¬å®¢æˆ·ç«¯è®¿é—®ä¸å­˜åœ¨çš„æ•°æ®æ—¶ï¼Œå…ˆè¯·æ±‚redisï¼Œä½†æ˜¯æ­¤æ—¶redisä¸­æ²¡æœ‰æ•°æ®ï¼Œæ­¤æ—¶ä¼šè®¿é—®åˆ°æ•°æ®åº“ï¼Œä½†æ˜¯æ•°æ®åº“ä¸­ä¹Ÿæ²¡æœ‰æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®ç©¿é€äº†ç¼“å­˜ï¼Œç›´å‡»æ•°æ®åº“ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“æ•°æ®åº“èƒ½å¤Ÿæ‰¿è½½çš„å¹¶å‘ä¸å¦‚redisè¿™ä¹ˆé«˜ï¼Œå¦‚æœå¤§é‡çš„è¯·æ±‚åŒæ—¶è¿‡æ¥è®¿é—®è¿™ç§ä¸å­˜åœ¨çš„æ•°æ®ï¼Œè¿™äº›è¯·æ±‚å°±éƒ½ä¼šè®¿é—®åˆ°æ•°æ®åº“ï¼Œç®€å•çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯å“ªæ€•è¿™ä¸ªæ•°æ®åœ¨æ•°æ®åº“ä¸­ä¹Ÿä¸å­˜åœ¨ï¼Œæˆ‘ä»¬ä¹ŸæŠŠè¿™ä¸ªæ•°æ®å­˜å…¥åˆ°redisä¸­å»ï¼Œè¿™æ ·ï¼Œä¸‹æ¬¡ç”¨æˆ·è¿‡æ¥è®¿é—®è¿™ä¸ªä¸å­˜åœ¨çš„æ•°æ®ï¼Œé‚£ä¹ˆåœ¨redisä¸­ä¹Ÿèƒ½æ‰¾åˆ°è¿™ä¸ªæ•°æ®å°±ä¸ä¼šè¿›å…¥åˆ°ç¼“å­˜äº†ã€‚</p><ul><li>ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œç»´æŠ¤æ–¹ä¾¿</li><li>ç¼ºç‚¹ï¼š<ul><li>é¢å¤–çš„å†…å­˜æ¶ˆè€—</li><li>å¯èƒ½é€ æˆçŸ­æœŸçš„ä¸ä¸€è‡´</li></ul></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b931f832-db95-4426-be0c-b4fa3d765ef3-2"><p>å¸ƒéš†è¿‡æ»¤å™¨å…¶å®é‡‡ç”¨çš„æ˜¯å“ˆå¸Œæ€æƒ³æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡ä¸€ä¸ªåºå¤§çš„äºŒè¿›åˆ¶æ•°ç»„ï¼Œèµ°å“ˆå¸Œæ€æƒ³å»åˆ¤æ–­å½“å‰è¿™ä¸ªè¦æŸ¥è¯¢çš„è¿™ä¸ªæ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­å­˜åœ¨ï¼Œåˆ™æ”¾è¡Œï¼Œè¿™ä¸ªè¯·æ±‚ä¼šå»è®¿é—®redisï¼Œå“ªæ€•æ­¤æ—¶redisä¸­çš„æ•°æ®è¿‡æœŸäº†ï¼Œä½†æ˜¯æ•°æ®åº“ä¸­ä¸€å®šå­˜åœ¨è¿™ä¸ªæ•°æ®ï¼Œåœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥è¿™ä¸ªæ•°æ®åï¼Œå†å°†å…¶æ”¾å…¥åˆ°redisä¸­ï¼Œå‡è®¾å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­è¿™ä¸ªæ•°æ®ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚</p><ul><li>ä¼˜ç‚¹ï¼šå†…å­˜å ç”¨è¾ƒå°‘ï¼Œæ²¡æœ‰å¤šä½™key</li><li>ç¼ºç‚¹ï¼š<ul><li>å®ç°å¤æ‚</li><li>å­˜åœ¨è¯¯åˆ¤å¯èƒ½ï¼Œè¯¯åˆ¤åŸå› åœ¨äºï¼šå¸ƒéš†è¿‡æ»¤å™¨èµ°çš„æ˜¯å“ˆå¸Œæ€æƒ³ï¼Œåªè¦å“ˆå¸Œæ€æƒ³ï¼Œå°±å¯èƒ½å­˜åœ¨å“ˆå¸Œå†²çª</li></ul></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653326156516.png" alt="1653326156516" style="zoom:67%;" /><mark class="hl-label blue">ç¼–ç è§£å†³å•†å“æŸ¥è¯¢çš„ç¼“å­˜ç©¿é€é—®é¢˜</mark> <div class="tabs" id="d31401f6-73bd-497d-86f5-8c8710cc5731"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d31401f6-73bd-497d-86f5-8c8710cc5731-1"><i class="fas fa-atom"></i>æ ¸å¿ƒæ€è·¯</button></li><li class="tab"><button type="button" data-href="#d31401f6-73bd-497d-86f5-8c8710cc5731-2"><i class="far fa-sun"></i>æµç¨‹å›¾</button></li><li class="tab"><button type="button" data-href="#d31401f6-73bd-497d-86f5-8c8710cc5731-3"><i class="fas fa-wind"></i>ä»£ç å®ç°</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d31401f6-73bd-497d-86f5-8c8710cc5731-1"><p>æ ¸å¿ƒæ€è·¯å¦‚ä¸‹ï¼š</p><p>åœ¨åŸæ¥çš„é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬å¦‚æœå‘ç°è¿™ä¸ªæ•°æ®åœ¨mysqlä¸­ä¸å­˜åœ¨ï¼Œç›´æ¥å°±è¿”å›404äº†ï¼Œè¿™æ ·æ˜¯ä¼šå­˜åœ¨ç¼“å­˜ç©¿é€é—®é¢˜çš„</p><p>ç°åœ¨çš„é€»è¾‘ä¸­ï¼šå¦‚æœè¿™ä¸ªæ•°æ®ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬ä¸ä¼šè¿”å›404 ï¼Œè¿˜æ˜¯ä¼šæŠŠè¿™ä¸ªæ•°æ®å†™å…¥åˆ°Redisä¸­ï¼Œå¹¶ä¸”å°†valueè®¾ç½®ä¸ºç©ºï¼Œæ¬§å½“å†æ¬¡å‘èµ·æŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬å¦‚æœå‘ç°å‘½ä¸­ä¹‹åï¼Œåˆ¤æ–­è¿™ä¸ªvalueæ˜¯å¦æ˜¯nullï¼Œå¦‚æœæ˜¯nullï¼Œåˆ™æ˜¯ä¹‹å‰å†™å…¥çš„æ•°æ®ï¼Œè¯æ˜æ˜¯ç¼“å­˜ç©¿é€æ•°æ®ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ç›´æ¥è¿”å›æ•°æ®ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d31401f6-73bd-497d-86f5-8c8710cc5731-2"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653327124561.png" alt="1653327124561" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d31401f6-73bd-497d-86f5-8c8710cc5731-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//1.ä»RedisæŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="comment">//3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­å‘½ä¸­çš„æ˜¯å¦æ˜¯ç©ºå€¼</span></span><br><span class="line">    <span class="keyword">if</span> (shopJson != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//è¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//4.ä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="comment">//5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.å­˜åœ¨ï¼Œå†™å…¥Redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(shop), CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <mark class="hl-label blue">æ€»ç»“</mark> <p>ç¼“å­˜ç©¿é€äº§ç”Ÿçš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ</p><ul><li>ç”¨æˆ·è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œä¸æ–­å‘èµ·è¿™æ ·çš„è¯·æ±‚ï¼Œç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§å‹åŠ›</li></ul><p>ç¼“å­˜ç©¿é€çš„è§£å†³æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ</p><ul><li>ç¼“å­˜nullå€¼</li><li>å¸ƒéš†è¿‡æ»¤</li><li>å¢å¼ºidçš„å¤æ‚åº¦ï¼Œé¿å…è¢«çŒœæµ‹idè§„å¾‹</li><li>åšå¥½æ•°æ®çš„åŸºç¡€æ ¼å¼æ ¡éªŒ</li><li>åŠ å¼ºç”¨æˆ·æƒé™æ ¡éªŒ</li><li>åšå¥½çƒ­ç‚¹å‚æ•°çš„é™æµ</li></ul><hr><h3 id="ç¼“å­˜é›ªå´©">ç¼“å­˜é›ªå´©</h3><p>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨åŒä¸€æ—¶æ®µå¤§é‡çš„ç¼“å­˜keyåŒæ—¶å¤±æ•ˆæˆ–è€…RedisæœåŠ¡å®•æœºï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚åˆ°è¾¾æ•°æ®åº“ï¼Œå¸¦æ¥å·¨å¤§å‹åŠ›ã€‚</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><ul><li>ç»™ä¸åŒçš„Keyçš„TTLæ·»åŠ éšæœºå€¼</li><li>åˆ©ç”¨Redisé›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§</li><li>ç»™ç¼“å­˜ä¸šåŠ¡æ·»åŠ é™çº§é™æµç­–ç•¥</li><li>ç»™ä¸šåŠ¡æ·»åŠ å¤šçº§ç¼“å­˜</li></ul><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653327884526.png" alt="1653327884526" style="zoom:67%;" /><hr><h3 id="ç¼“å­˜å‡»ç©¿">ç¼“å­˜å‡»ç©¿</h3><p>ç¼“å­˜å‡»ç©¿é—®é¢˜ä¹Ÿå«çƒ­ç‚¹Keyé—®é¢˜ï¼Œå°±æ˜¯ä¸€ä¸ªè¢«é«˜å¹¶å‘è®¿é—®å¹¶ä¸”ç¼“å­˜é‡å»ºä¸šåŠ¡è¾ƒå¤æ‚çš„keyçªç„¶å¤±æ•ˆäº†ï¼Œæ— æ•°çš„è¯·æ±‚è®¿é—®ä¼šåœ¨ç¬é—´ç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„å†²å‡»ã€‚</p><p>å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</p><ul><li>äº’æ–¥é”</li><li>é€»è¾‘è¿‡æœŸ</li></ul><div class="tabs" id="adfa7107-a653-49ad-bd02-ad74091d7f4a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#adfa7107-a653-49ad-bd02-ad74091d7f4a-1"><i class="fas fa-atom"></i>åˆ†æ</button></li><li class="tab"><button type="button" data-href="#adfa7107-a653-49ad-bd02-ad74091d7f4a-2"><i class="far fa-sun"></i>äº’æ–¥é”</button></li><li class="tab"><button type="button" data-href="#adfa7107-a653-49ad-bd02-ad74091d7f4a-3"><i class="fas fa-wind"></i>é€»è¾‘è¿‡æœŸ</button></li><li class="tab"><button type="button" data-href="#adfa7107-a653-49ad-bd02-ad74091d7f4a-4"><i class="fas fa-fire-alt"></i>æ–¹æ¡ˆå¯¹æ¯”</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="adfa7107-a653-49ad-bd02-ad74091d7f4a-1"><p>å‡è®¾çº¿ç¨‹1åœ¨æŸ¥è¯¢ç¼“å­˜ä¹‹åï¼Œæœ¬æ¥åº”è¯¥å»æŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åæŠŠè¿™ä¸ªæ•°æ®é‡æ–°åŠ è½½åˆ°ç¼“å­˜çš„ï¼Œæ­¤æ—¶åªè¦çº¿ç¨‹1èµ°å®Œè¿™ä¸ªé€»è¾‘ï¼Œå…¶ä»–çº¿ç¨‹å°±éƒ½èƒ½ä»ç¼“å­˜ä¸­åŠ è½½è¿™äº›æ•°æ®äº†ï¼Œä½†æ˜¯å‡è®¾åœ¨çº¿ç¨‹1æ²¡æœ‰èµ°å®Œçš„æ—¶å€™ï¼Œåç»­çš„çº¿ç¨‹2ï¼Œçº¿ç¨‹3ï¼Œçº¿ç¨‹4åŒæ—¶è¿‡æ¥è®¿é—®å½“å‰è¿™ä¸ªæ–¹æ³•ï¼Œ é‚£ä¹ˆè¿™äº›çº¿ç¨‹éƒ½ä¸èƒ½ä»ç¼“å­˜ä¸­æŸ¥è¯¢åˆ°æ•°æ®ï¼Œé‚£ä¹ˆä»–ä»¬å°±ä¼šåŒä¸€æ—¶åˆ»æ¥è®¿é—®æŸ¥è¯¢ç¼“å­˜ï¼Œéƒ½æ²¡æŸ¥åˆ°ï¼Œæ¥ç€åŒä¸€æ—¶é—´å»è®¿é—®æ•°æ®åº“ï¼ŒåŒæ—¶çš„å»æ‰§è¡Œæ•°æ®åº“ä»£ç ï¼Œå¯¹æ•°æ®åº“è®¿é—®å‹åŠ›è¿‡å¤§</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653328022622.png" alt="1653328022622" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="adfa7107-a653-49ad-bd02-ad74091d7f4a-2"><p>å› ä¸ºé”èƒ½å®ç°äº’æ–¥æ€§ã€‚å‡è®¾çº¿ç¨‹è¿‡æ¥ï¼Œåªèƒ½ä¸€ä¸ªäººä¸€ä¸ªäººçš„æ¥è®¿é—®æ•°æ®åº“ï¼Œä»è€Œé¿å…å¯¹äºæ•°æ®åº“è®¿é—®å‹åŠ›è¿‡å¤§ï¼Œä½†è¿™ä¹Ÿä¼šå½±å“æŸ¥è¯¢çš„æ€§èƒ½ï¼Œå› ä¸ºæ­¤æ—¶ä¼šè®©æŸ¥è¯¢çš„æ€§èƒ½ä»å¹¶è¡Œå˜æˆäº†ä¸²è¡Œï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨tryLockæ–¹æ³• + double checkæ¥è§£å†³è¿™æ ·çš„é—®é¢˜ã€‚</p><p>å‡è®¾ç°åœ¨çº¿ç¨‹1è¿‡æ¥è®¿é—®ï¼Œä»–æŸ¥è¯¢ç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œä½†æ˜¯æ­¤æ—¶ä»–è·å¾—åˆ°äº†é”çš„èµ„æºï¼Œé‚£ä¹ˆçº¿ç¨‹1å°±ä¼šä¸€ä¸ªäººå»æ‰§è¡Œé€»è¾‘ï¼Œå‡è®¾ç°åœ¨çº¿ç¨‹2è¿‡æ¥ï¼Œçº¿ç¨‹2åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¹¶æ²¡æœ‰è·å¾—åˆ°é”ï¼Œé‚£ä¹ˆçº¿ç¨‹2å°±å¯ä»¥è¿›è¡Œåˆ°ä¼‘çœ ï¼Œç›´åˆ°çº¿ç¨‹1æŠŠé”é‡Šæ”¾åï¼Œçº¿ç¨‹2è·å¾—åˆ°é”ï¼Œç„¶åå†æ¥æ‰§è¡Œé€»è¾‘ï¼Œæ­¤æ—¶å°±èƒ½å¤Ÿä»ç¼“å­˜ä¸­æ‹¿åˆ°æ•°æ®äº†ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653328288627.png" alt="1653328288627" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="adfa7107-a653-49ad-bd02-ad74091d7f4a-3"><p>æˆ‘ä»¬ä¹‹æ‰€ä»¥ä¼šå‡ºç°è¿™ä¸ªç¼“å­˜å‡»ç©¿é—®é¢˜ï¼Œä¸»è¦åŸå› æ˜¯åœ¨äºæˆ‘ä»¬å¯¹keyè®¾ç½®äº†è¿‡æœŸæ—¶é—´ï¼Œå‡è®¾æˆ‘ä»¬ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå…¶å®å°±ä¸ä¼šæœ‰ç¼“å­˜å‡»ç©¿çš„é—®é¢˜ï¼Œä½†æ˜¯ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·æ•°æ®ä¸å°±ä¸€ç›´å ç”¨æˆ‘ä»¬å†…å­˜äº†å—ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨é€»è¾‘è¿‡æœŸæ–¹æ¡ˆã€‚</p><p>æˆ‘ä»¬æŠŠè¿‡æœŸæ—¶é—´è®¾ç½®åœ¨redisçš„valueä¸­ï¼Œæ³¨æ„ï¼šè¿™ä¸ªè¿‡æœŸæ—¶é—´å¹¶ä¸ä¼šç›´æ¥ä½œç”¨äºredisï¼Œè€Œæ˜¯æˆ‘ä»¬åç»­é€šè¿‡é€»è¾‘å»å¤„ç†ã€‚å‡è®¾çº¿ç¨‹1å»æŸ¥è¯¢ç¼“å­˜ï¼Œç„¶åä»valueä¸­åˆ¤æ–­å‡ºæ¥å½“å‰çš„æ•°æ®å·²ç»è¿‡æœŸäº†ï¼Œæ­¤æ—¶çº¿ç¨‹1å»è·å¾—äº’æ–¥é”ï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹ä¼šè¿›è¡Œé˜»å¡ï¼Œè·å¾—äº†é”çš„çº¿ç¨‹ä»–ä¼šå¼€å¯ä¸€ä¸ª çº¿ç¨‹å»è¿›è¡Œä»¥å‰çš„é‡æ„æ•°æ®çš„é€»è¾‘ï¼Œç›´åˆ°æ–°å¼€çš„çº¿ç¨‹å®Œæˆè¿™ä¸ªé€»è¾‘åï¼Œæ‰é‡Šæ”¾é”ï¼Œ è€Œçº¿ç¨‹1ç›´æ¥è¿›è¡Œè¿”å›ï¼Œå‡è®¾ç°åœ¨çº¿ç¨‹3è¿‡æ¥è®¿é—®ï¼Œç”±äºçº¿ç¨‹çº¿ç¨‹2æŒæœ‰ç€é”ï¼Œæ‰€ä»¥çº¿ç¨‹3æ— æ³•è·å¾—é”ï¼Œçº¿ç¨‹3ä¹Ÿç›´æ¥è¿”å›æ•°æ®ï¼Œåªæœ‰ç­‰åˆ°æ–°å¼€çš„çº¿ç¨‹2æŠŠé‡å»ºæ•°æ®æ„å»ºå®Œåï¼Œå…¶ä»–çº¿ç¨‹æ‰èƒ½èµ°è¿”å›æ­£ç¡®çš„æ•°æ®ã€‚</p><p>è¿™ç§æ–¹æ¡ˆå·§å¦™åœ¨äºï¼Œå¼‚æ­¥çš„æ„å»ºç¼“å­˜ï¼Œç¼ºç‚¹åœ¨äºåœ¨æ„å»ºå®Œç¼“å­˜ä¹‹å‰ï¼Œè¿”å›çš„éƒ½æ˜¯è„æ•°æ®ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653328663897.png" alt="1653328663897" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="adfa7107-a653-49ad-bd02-ad74091d7f4a-4"><p>äº’æ–¥é”æ–¹æ¡ˆï¼šç”±äºä¿è¯äº†äº’æ–¥æ€§ï¼Œæ‰€ä»¥æ•°æ®ä¸€è‡´ï¼Œä¸”å®ç°ç®€å•ï¼Œå› ä¸ºä»…ä»…åªéœ€è¦åŠ ä¸€æŠŠé”è€Œå·²ï¼Œä¹Ÿæ²¡å…¶ä»–çš„äº‹æƒ…éœ€è¦æ“å¿ƒï¼Œæ‰€ä»¥æ²¡æœ‰é¢å¤–çš„å†…å­˜æ¶ˆè€—ï¼Œç¼ºç‚¹åœ¨äºæœ‰é”å°±æœ‰æ­»é”é—®é¢˜çš„å‘ç”Ÿï¼Œä¸”åªèƒ½ä¸²è¡Œæ‰§è¡Œæ€§èƒ½è‚¯å®šå—åˆ°å½±å“</p><p>é€»è¾‘è¿‡æœŸæ–¹æ¡ˆï¼šçº¿ç¨‹è¯»å–è¿‡ç¨‹ä¸­ä¸éœ€è¦ç­‰å¾…ï¼Œæ€§èƒ½å¥½ï¼Œæœ‰ä¸€ä¸ªé¢å¤–çš„çº¿ç¨‹æŒæœ‰é”å»è¿›è¡Œé‡æ„æ•°æ®ï¼Œä½†æ˜¯åœ¨é‡æ„æ•°æ®å®Œæˆå‰ï¼Œå…¶ä»–çš„çº¿ç¨‹åªèƒ½è¿”å›ä¹‹å‰çš„æ•°æ®ï¼Œä¸”å®ç°èµ·æ¥éº»çƒ¦</p><table><thead><tr><th style="text-align:center">è§£å†³æ–¹æ¡ˆ</th><th style="text-align:center">ä¼˜ç‚¹</th><th style="text-align:center">ç¼ºç‚¹</th></tr></thead><tbody><tr><td style="text-align:center">äº’æ–¥é”</td><td style="text-align:center">1.æ²¡æœ‰é¢å¤–çš„å†…å­˜æ¶ˆè€—<br/>2.ä¿è¯ä¸€è‡´æ€§<br/>3.å®ç°ç®€å•</td><td style="text-align:center">1.çº¿ç¨‹éœ€è¦ç­‰å¾…ï¼Œæ€§èƒ½å—å½±å“<br/>2.å¯èƒ½æœ‰æ­»é”é£é™©</td></tr><tr><td style="text-align:center">é€»è¾‘è¿‡æœŸ</td><td style="text-align:center">çº¿ç¨‹æ— éœ€ç­‰å¾…ï¼Œæ€§èƒ½è¾ƒå¥½</td><td style="text-align:center">1.ä¸ä¿è¯ä¸€è‡´æ€§<br/>2.æœ‰é¢å¤–å†…å­˜æ¶ˆè€—<br/>3.å®ç°å¤æ‚</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <mark class="hl-label blue">ä»£ç å®ç°</mark> <div class="tabs" id="b617c6aa-a20d-44d3-9872-b0b0c06d3c0a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#b617c6aa-a20d-44d3-9872-b0b0c06d3c0a-1"><i class="fas fa-cat"></i>äº’æ–¥é”æ€è·¯</button></li><li class="tab"><button type="button" data-href="#b617c6aa-a20d-44d3-9872-b0b0c06d3c0a-2"><i class="fas fa-horse"></i>äº’æ–¥é”ä»£ç </button></li><li class="tab"><button type="button" data-href="#b617c6aa-a20d-44d3-9872-b0b0c06d3c0a-3"><i class="fas fa-dove"></i>é€»è¾‘è¿‡æœŸæ€è·¯</button></li><li class="tab"><button type="button" data-href="#b617c6aa-a20d-44d3-9872-b0b0c06d3c0a-4"><i class="fas fa-dragon"></i>é€»è¾‘è¿‡æœŸä»£ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="b617c6aa-a20d-44d3-9872-b0b0c06d3c0a-1"><p>æ ¸å¿ƒæ€è·¯ï¼šç›¸è¾ƒäºåŸæ¥ä»ç¼“å­˜ä¸­æŸ¥è¯¢ä¸åˆ°æ•°æ®åç›´æ¥æŸ¥è¯¢æ•°æ®åº“è€Œè¨€ï¼Œç°åœ¨çš„æ–¹æ¡ˆæ˜¯ è¿›è¡ŒæŸ¥è¯¢ä¹‹åï¼Œå¦‚æœä»ç¼“å­˜æ²¡æœ‰æŸ¥è¯¢åˆ°æ•°æ®ï¼Œåˆ™è¿›è¡Œäº’æ–¥é”çš„è·å–ï¼Œè·å–äº’æ–¥é”åï¼Œåˆ¤æ–­æ˜¯å¦è·å¾—åˆ°äº†é”ï¼Œå¦‚æœæ²¡æœ‰è·å¾—åˆ°ï¼Œåˆ™ä¼‘çœ ï¼Œè¿‡ä¸€ä¼šå†è¿›è¡Œå°è¯•ï¼Œç›´åˆ°è·å–åˆ°é”ä¸ºæ­¢ï¼Œæ‰èƒ½è¿›è¡ŒæŸ¥è¯¢</p><p>å¦‚æœè·å–åˆ°äº†é”çš„çº¿ç¨‹ï¼Œå†å»è¿›è¡ŒæŸ¥è¯¢ï¼ŒæŸ¥è¯¢åå°†æ•°æ®å†™å…¥redisï¼Œå†é‡Šæ”¾é”ï¼Œè¿”å›æ•°æ®ï¼Œåˆ©ç”¨äº’æ–¥é”å°±èƒ½ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œæ“ä½œæ•°æ®åº“çš„é€»è¾‘ï¼Œé˜²æ­¢ç¼“å­˜å‡»ç©¿</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653357860001.png" alt="1653357860001" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b617c6aa-a20d-44d3-9872-b0b0c06d3c0a-2"><div class="tabs" id="72d25354-8817-4911-9f5a-d200d956aee0"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#72d25354-8817-4911-9f5a-d200d956aee0-1"><i class="fas fa-bug"></i>æ“ä½œé”çš„ä»£ç </button></li><li class="tab"><button type="button" data-href="#72d25354-8817-4911-9f5a-d200d956aee0-2"><i class="fas fa-cannabis"></i>æ“ä½œä»£ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="72d25354-8817-4911-9f5a-d200d956aee0-1"><p>æ ¸å¿ƒæ€è·¯å°±æ˜¯åˆ©ç”¨redisçš„setnxæ–¹æ³•æ¥è¡¨ç¤ºè·å–é”ï¼Œè¯¥æ–¹æ³•å«ä¹‰æ˜¯redisä¸­å¦‚æœæ²¡æœ‰è¿™ä¸ªkeyï¼Œåˆ™æ’å…¥æˆåŠŸï¼Œè¿”å›1ï¼Œåœ¨stringRedisTemplateä¸­è¿”å›trueï¼Œ  å¦‚æœæœ‰è¿™ä¸ªkeyåˆ™æ’å…¥å¤±è´¥ï¼Œåˆ™è¿”å›0ï¼Œåœ¨stringRedisTemplateè¿”å›falseï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡trueï¼Œæˆ–è€…æ˜¯falseï¼Œæ¥è¡¨ç¤ºæ˜¯å¦æœ‰çº¿ç¨‹æˆåŠŸæ’å…¥keyï¼ŒæˆåŠŸæ’å…¥çš„keyçš„çº¿ç¨‹æˆ‘ä»¬è®¤ä¸ºä»–å°±æ˜¯è·å¾—åˆ°é”çš„çº¿ç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    stringRedisTemplate.delete(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="72d25354-8817-4911-9f5a-d200d956aee0-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Shop <span class="title function_">queryWithMutex</span><span class="params">(Long id)</span>  &#123;</span><br><span class="line">       <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id;</span><br><span class="line">       <span class="comment">// 1ã€ä»redisä¸­æŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">       <span class="comment">// 2ã€åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">       <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">           <span class="comment">// å­˜åœ¨,ç›´æ¥è¿”å›</span></span><br><span class="line">           <span class="keyword">return</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//åˆ¤æ–­å‘½ä¸­çš„å€¼æ˜¯å¦æ˜¯ç©ºå€¼</span></span><br><span class="line">       <span class="keyword">if</span> (shopJson != <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="comment">//è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯</span></span><br><span class="line">           <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 4.å®ç°ç¼“å­˜é‡æ„</span></span><br><span class="line">       <span class="comment">//4.1 è·å–äº’æ–¥é”</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> <span class="string">&quot;lock:shop:&quot;</span> + id;</span><br><span class="line">       <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">           <span class="comment">// 4.2 åˆ¤æ–­å¦è·å–æˆåŠŸ</span></span><br><span class="line">           <span class="keyword">if</span>(!isLock)&#123;</span><br><span class="line">               <span class="comment">//4.3 å¤±è´¥ï¼Œåˆ™ä¼‘çœ é‡è¯•</span></span><br><span class="line">               Thread.sleep(<span class="number">50</span>);</span><br><span class="line">               <span class="keyword">return</span> queryWithMutex(id);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//4.4 æˆåŠŸï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">            shop = getById(id);</span><br><span class="line">           <span class="comment">// 5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯</span></span><br><span class="line">           <span class="keyword">if</span>(shop == <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">//å°†ç©ºå€¼å†™å…¥redis</span></span><br><span class="line">               stringRedisTemplate.opsForValue().set(key,<span class="string">&quot;&quot;</span>,CACHE_NULL_TTL,TimeUnit.MINUTES);</span><br><span class="line">               <span class="comment">//è¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">               <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//6.å†™å…¥redis</span></span><br><span class="line">           stringRedisTemplate.opsForValue().set(key,JSONUtil.toJsonStr(shop),CACHE_NULL_TTL,TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">       &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="comment">//7.é‡Šæ”¾äº’æ–¥é”</span></span><br><span class="line">           unlock(lockKey);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> shop;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b617c6aa-a20d-44d3-9872-b0b0c06d3c0a-3"><p>éœ€æ±‚ï¼šä¿®æ”¹æ ¹æ®idæŸ¥è¯¢å•†é“ºçš„ä¸šåŠ¡ï¼ŒåŸºäºé€»è¾‘è¿‡æœŸæ–¹å¼æ¥è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</p><p>æ€è·¯åˆ†æï¼šå½“ç”¨æˆ·å¼€å§‹æŸ¥è¯¢redisæ—¶ï¼Œåˆ¤æ–­æ˜¯å¦å‘½ä¸­ï¼Œå¦‚æœæ²¡æœ‰å‘½ä¸­åˆ™ç›´æ¥è¿”å›ç©ºæ•°æ®ï¼Œä¸æŸ¥è¯¢æ•°æ®åº“ï¼Œè€Œä¸€æ—¦å‘½ä¸­åï¼Œå°†valueå–å‡ºï¼Œåˆ¤æ–­valueä¸­çš„è¿‡æœŸæ—¶é—´æ˜¯å¦æ»¡è¶³ï¼Œå¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œåˆ™ç›´æ¥è¿”å›redisä¸­çš„æ•°æ®ï¼Œå¦‚æœè¿‡æœŸï¼Œåˆ™åœ¨å¼€å¯ç‹¬ç«‹çº¿ç¨‹åç›´æ¥è¿”å›ä¹‹å‰çš„æ•°æ®ï¼Œç‹¬ç«‹çº¿ç¨‹å»é‡æ„æ•°æ®ï¼Œé‡æ„å®Œæˆåé‡Šæ”¾äº’æ–¥é”ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653360308731.png" alt="1653360308731" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b617c6aa-a20d-44d3-9872-b0b0c06d3c0a-4"><div class="tabs" id="28dbfd45-11d5-4d6b-a08c-4132542e590d"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#28dbfd45-11d5-4d6b-a08c-4132542e590d-1"><i class="fas fa-seedling"></i>æ–°å»ºå®ä½“ç±»</button></li><li class="tab"><button type="button" data-href="#28dbfd45-11d5-4d6b-a08c-4132542e590d-2"><i class="fas fa-leaf"></i>æ–°å¢æ–¹æ³•</button></li><li class="tab"><button type="button" data-href="#28dbfd45-11d5-4d6b-a08c-4132542e590d-3"><i class="fab fa-apple"></i>æ­£å¼ä»£ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="28dbfd45-11d5-4d6b-a08c-4132542e590d-1"><p>å› ä¸ºç°åœ¨redisä¸­å­˜å‚¨çš„æ•°æ®çš„valueéœ€è¦å¸¦ä¸Šè¿‡æœŸæ—¶é—´ï¼Œæ­¤æ—¶è¦ä¹ˆä½ å»ä¿®æ”¹åŸæ¥çš„å®ä½“ç±»ï¼Œè¦ä¹ˆæ–°å»ºä¸€ä¸ªå®ä½“ç±»ï¼Œæˆ‘ä»¬é‡‡ç”¨ç¬¬äºŒä¸ªæ–¹æ¡ˆï¼Œè¿™ä¸ªæ–¹æ¡ˆï¼Œå¯¹åŸæ¥ä»£ç æ²¡æœ‰ä¾µå…¥æ€§ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime expireTime;</span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="28dbfd45-11d5-4d6b-a08c-4132542e590d-2"><p>åœ¨ShopServiceImpl æ–°å¢æ­¤æ–¹æ³•ï¼Œåˆ©ç”¨å•å…ƒæµ‹è¯•è¿›è¡Œç¼“å­˜é¢„çƒ­</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653360807133.png" alt="1653360807133"></p><p>åœ¨æµ‹è¯•ç±»ä¸­</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653360864839.png" alt="1653360864839"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="28dbfd45-11d5-4d6b-a08c-4132542e590d-3"><p>ShopServiceImpl</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">public</span> Shop <span class="title function_">queryWithLogicalExpire</span><span class="params">( Long id )</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">// 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(json)) &#123;</span><br><span class="line">        <span class="comment">// 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.å‘½ä¸­ï¼Œéœ€è¦å…ˆæŠŠjsonååºåˆ—åŒ–ä¸ºå¯¹è±¡</span></span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(json, RedisData.class);</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), Shop.class);</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();</span><br><span class="line">    <span class="comment">// 5.åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">if</span>(expireTime.isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// 5.1.æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›åº—é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.2.å·²è¿‡æœŸï¼Œéœ€è¦ç¼“å­˜é‡å»º</span></span><br><span class="line">    <span class="comment">// 6.ç¼“å­˜é‡å»º</span></span><br><span class="line">    <span class="comment">// 6.1.è·å–äº’æ–¥é”</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">    <span class="comment">// 6.2.åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (isLock)&#123;</span><br><span class="line">        CACHE_REBUILD_EXECUTOR.submit( ()-&gt;&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="comment">//é‡å»ºç¼“å­˜</span></span><br><span class="line">                <span class="built_in">this</span>.saveShop2Redis(id,<span class="number">20L</span>);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                unlock(lockKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6.4.è¿”å›è¿‡æœŸçš„å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="ç¼“å­˜å·¥å…·å°è£…">ç¼“å­˜å·¥å…·å°è£…</h3><p>åŸºäºStringRedisTemplateå°è£…ä¸€ä¸ªç¼“å­˜å·¥å…·ç±»ï¼Œæ»¡è¶³ä¸‹åˆ—éœ€æ±‚ï¼š</p><ul><li>æ–¹æ³•1ï¼šå°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®TTLè¿‡æœŸæ—¶é—´</li><li>æ–¹æ³•2ï¼šå°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œç”¨äºå¤„ç†ç¼“å­˜å‡»ç©¿é—®é¢˜</li><li>æ–¹æ³•3ï¼šæ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œåˆ©ç”¨ç¼“å­˜ç©ºå€¼çš„æ–¹å¼è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜</li><li>æ–¹æ³•4ï¼šæ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œéœ€è¦åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</li></ul><div class="tabs" id="48e5902e-5df4-4efe-ad11-be584fa4d16e"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#48e5902e-5df4-4efe-ad11-be584fa4d16e-1"><i class="fas fa-bug"></i>æˆå‘˜å˜é‡åŠéƒ¨åˆ†æ–¹æ³•</button></li><li class="tab"><button type="button" data-href="#48e5902e-5df4-4efe-ad11-be584fa4d16e-2"><i class="fas fa-cannabis"></i>æ–¹æ³•ä¸€</button></li><li class="tab"><button type="button" data-href="#48e5902e-5df4-4efe-ad11-be584fa4d16e-3"><i class="fas fa-candy-cane"></i>æ–¹æ³•äºŒ</button></li><li class="tab"><button type="button" data-href="#48e5902e-5df4-4efe-ad11-be584fa4d16e-4"><i class="fas fa-child"></i>æ–¹æ³•ä¸‰</button></li><li class="tab"><button type="button" data-href="#48e5902e-5df4-4efe-ad11-be584fa4d16e-5"><i class="fas fa-heartbeat"></i>æ–¹æ³•å››</button></li><li class="tab"><button type="button" data-href="#48e5902e-5df4-4efe-ad11-be584fa4d16e-6"><i class="fas fa-cookie-bite"></i>ä½¿ç”¨ç¤ºä¾‹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="48e5902e-5df4-4efe-ad11-be584fa4d16e-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheClient</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        stringRedisTemplate.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="48e5902e-5df4-4efe-ad11-be584fa4d16e-2"><p>å°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®TTLè¿‡æœŸæ—¶é—´</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, Object value, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, timeUnit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="48e5902e-5df4-4efe-ad11-be584fa4d16e-3"><p>å°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œç”¨äºå¤„ç†ç¼“å­˜å‡»ç©¿é—®é¢˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithPassThrough</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    <span class="comment">//å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºRç±»å‹ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toBean(json, type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (json != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥ï¼ŒæŸ¥è¯¢é€»è¾‘ç”¨æˆ‘ä»¬å‚æ•°ä¸­æ³¨å…¥çš„å‡½æ•°</span></span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">    <span class="comment">//æŸ¥ä¸åˆ°ï¼Œåˆ™å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">    <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æŸ¥åˆ°äº†åˆ™è½¬ä¸ºjsonå­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(r);</span><br><span class="line">    <span class="comment">//å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span></span><br><span class="line">    <span class="built_in">this</span>.set(key, jsonStr, time, timeUnit);</span><br><span class="line">    <span class="comment">//æœ€ç»ˆæŠŠæŸ¥è¯¢åˆ°çš„å•†æˆ·ä¿¡æ¯è¿”å›ç»™å‰ç«¯</span></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="48e5902e-5df4-4efe-ad11-be584fa4d16e-4"><p>æ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œç¼“å­˜ç©ºå€¼çš„æ–¹å¼è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithMutex</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    <span class="comment">//å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºShopç±»å‹ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toBean(json, type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (json != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">        <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">50</span>);</span><br><span class="line">            <span class="keyword">return</span> queryWithMutex(keyPrefix, id, type, dbFallback, time, timeUnit);</span><br><span class="line">        &#125;</span><br><span class="line">        r = dbFallback.apply(id);</span><br><span class="line">        <span class="comment">//æŸ¥ä¸åˆ°ï¼Œåˆ™å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">        <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span></span><br><span class="line">        <span class="built_in">this</span>.set(key, r, time, timeUnit);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        unlock(lockKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="48e5902e-5df4-4efe-ad11-be584fa4d16e-5"><p>æ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œéœ€è¦åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithLogicalExpire</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    <span class="comment">//1. ä»redisä¸­æŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//2. å¦‚æœæœªå‘½ä¸­ï¼Œåˆ™è¿”å›ç©º</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(json)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3. å‘½ä¸­ï¼Œå°†jsonååºåˆ—åŒ–ä¸ºå¯¹è±¡</span></span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(json, RedisData.class);</span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), type);</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();</span><br><span class="line">    <span class="comment">//4. åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">if</span> (expireTime.isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">//5. è¿‡æœŸï¼Œç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6. è¿‡æœŸï¼Œå°è¯•è·å–äº’æ–¥é”</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">    <span class="comment">//7. è·å–åˆ°äº†é”</span></span><br><span class="line">    <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">        <span class="comment">//8. å¼€å¯ç‹¬ç«‹çº¿ç¨‹</span></span><br><span class="line">        CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">R</span> <span class="variable">tmp</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">                <span class="built_in">this</span>.setWithLogicExpire(key, tmp, time, timeUnit);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                unlock(lockKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//9. ç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//10. æœªè·å–åˆ°é”ï¼Œç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setWithLogicExpire</span><span class="params">(String key, Object value, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    RedisData&lt;Object&gt; redisData = <span class="keyword">new</span> <span class="title class_">RedisData</span>&lt;&gt;();</span><br><span class="line">    redisData.setData(value);</span><br><span class="line">    redisData.setExpireTime(LocalDateTime.now().plusSeconds(timeUnit.toSeconds(time)));</span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="48e5902e-5df4-4efe-ad11-be584fa4d16e-6"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> CacheClient cacheClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// è§£å†³ç¼“å­˜ç©¿é€</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> cacheClient</span><br><span class="line">            .queryWithPassThrough(CACHE_SHOP_KEY, id, Shop.class, <span class="built_in">this</span>::getById, CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿</span></span><br><span class="line">    <span class="comment">// Shop shop = cacheClient</span></span><br><span class="line">    <span class="comment">//         .queryWithMutex(CACHE_SHOP_KEY, id, Shop.class, this::getById, CACHE_SHOP_TTL, TimeUnit.MINUTES);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿</span></span><br><span class="line">    <span class="comment">// Shop shop = cacheClient</span></span><br><span class="line">    <span class="comment">//         .queryWithLogicalExpire(CACHE_SHOP_KEY, id, Shop.class, this::getById, 20L, TimeUnit.SECONDS);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 7.è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="ä¼˜æƒ åˆ¸ç§’æ€">ä¼˜æƒ åˆ¸ç§’æ€</h2><h3 id="å…¨å±€å”¯ä¸€ID">å…¨å±€å”¯ä¸€ID</h3><p>æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼Œå½“ç”¨æˆ·æŠ¢è´­æ—¶ï¼Œå°±ä¼šç”Ÿæˆè®¢å•å¹¶ä¿å­˜åˆ°tb_voucher_orderè¿™å¼ è¡¨ä¸­ï¼Œè€Œè®¢å•è¡¨å¦‚æœä½¿ç”¨æ•°æ®åº“è‡ªå¢IDå°±å­˜åœ¨ä¸€äº›é—®é¢˜ï¼š</p><ul><li>idçš„è§„å¾‹æ€§å¤ªæ˜æ˜¾</li><li>å—å•è¡¨æ•°æ®é‡çš„é™åˆ¶</li></ul><p>åœºæ™¯åˆ†æï¼šå¦‚æœæˆ‘ä»¬çš„idå…·æœ‰å¤ªæ˜æ˜¾çš„è§„åˆ™ï¼Œç”¨æˆ·æˆ–è€…è¯´å•†ä¸šå¯¹æ‰‹å¾ˆå®¹æ˜“çŒœæµ‹å‡ºæ¥æˆ‘ä»¬çš„ä¸€äº›æ•æ„Ÿä¿¡æ¯ï¼Œæ¯”å¦‚å•†åŸåœ¨ä¸€å¤©æ—¶é—´å†…ï¼Œå–å‡ºäº†å¤šå°‘å•ï¼Œè¿™æ˜æ˜¾ä¸åˆé€‚ã€‚</p><p>åœºæ™¯åˆ†æäºŒï¼šéšç€æˆ‘ä»¬å•†åŸè§„æ¨¡è¶Šæ¥è¶Šå¤§ï¼Œmysqlçš„å•è¡¨çš„å®¹é‡ä¸å®œè¶…è¿‡500Wï¼Œæ•°æ®é‡è¿‡å¤§ä¹‹åï¼Œæˆ‘ä»¬è¦è¿›è¡Œæ‹†åº“æ‹†è¡¨ï¼Œä½†æ‹†åˆ†è¡¨äº†ä¹‹åï¼Œä»–ä»¬ä»é€»è¾‘ä¸Šè®²ä»–ä»¬æ˜¯åŒä¸€å¼ è¡¨ï¼Œæ‰€ä»¥ä»–ä»¬çš„idæ˜¯ä¸èƒ½ä¸€æ ·çš„ï¼Œ äºæ˜¯ä¹æˆ‘ä»¬éœ€è¦ä¿è¯idçš„å”¯ä¸€æ€§ã€‚</p><p>å…¨å±€IDç”Ÿæˆå™¨ï¼Œæ˜¯ä¸€ç§åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ç”¨æ¥ç”Ÿæˆå…¨å±€å”¯ä¸€IDçš„å·¥å…·ï¼Œä¸€èˆ¬è¦æ»¡è¶³ä¸‹åˆ—ç‰¹æ€§ï¼š</p><p>å”¯ä¸€æ€§ã€é«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€é€’å¢æ€§ã€å®‰å…¨æ€§</p><p>ä¸ºäº†å¢åŠ IDçš„å®‰å…¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç›´æ¥ä½¿ç”¨Redisè‡ªå¢çš„æ•°å€¼ï¼Œè€Œæ˜¯æ‹¼æ¥ä¸€äº›å…¶å®ƒä¿¡æ¯</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653363172079.png" alt="1653363172079"></p><p>IDçš„ç»„æˆéƒ¨åˆ†ï¼šç¬¦å·ä½ï¼š1bitï¼Œæ°¸è¿œä¸º0</p><p>æ—¶é—´æˆ³ï¼š31bitï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œå¯ä»¥ä½¿ç”¨69å¹´</p><p>åºåˆ—å·ï¼š32bitï¼Œç§’å†…çš„è®¡æ•°å™¨ï¼Œæ”¯æŒæ¯ç§’äº§ç”Ÿ2^32ä¸ªä¸åŒID</p><mark class="hl-label blue">Rediså®ç°å…¨å±€å”¯ä¸€Id</mark> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisIdWorker</span> &#123;</span><br><span class="line">    <span class="comment">// å¼€å§‹æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">BEGIN_TIMESTAMP</span> <span class="operator">=</span> <span class="number">1640995200L</span>;</span><br><span class="line">    <span class="comment">//åºåˆ—å·çš„ä½æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BITS</span> <span class="operator">=</span> <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisIdWorker</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">(String keyPrefix)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.ç”Ÿæˆæ—¶é—´æˆ³</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="type">long</span> <span class="variable">nowSecond</span> <span class="operator">=</span> now.toEpochSecond(ZoneOffset.UTC);</span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> nowSecond - BEGIN_TIMESTAMP;</span><br><span class="line">        <span class="comment">// 2.ç”Ÿæˆåºåˆ—å·</span></span><br><span class="line">        <span class="comment">// 2.1.è·å–å½“å‰æ—¥æœŸï¼Œç²¾ç¡®åˆ°å¤©</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">date</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy:MM:dd&quot;</span>));</span><br><span class="line">        <span class="comment">// 2.2.è‡ªå¢é•¿</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().increment(<span class="string">&quot;icr:&quot;</span> + keyPrefix + <span class="string">&quot;:&quot;</span> + date);</span><br><span class="line">        <span class="comment">// 3.æ‹¼æ¥å¹¶è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> timestamp &lt;&lt; COUNT_BITS | count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="æ·»åŠ ä¼˜æƒ å·">æ·»åŠ ä¼˜æƒ å·</h3><p>æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼Œåˆ†ä¸ºå¹³ä»·åˆ¸å’Œç‰¹ä»·åˆ¸ã€‚å¹³ä»·åˆ¸å¯ä»¥ä»»æ„è´­ä¹°ï¼Œè€Œç‰¹ä»·åˆ¸éœ€è¦ç§’æ€æŠ¢è´­ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653365145124.png" alt="1653365145124"></p><p>tb_voucherï¼šä¼˜æƒ åˆ¸çš„åŸºæœ¬ä¿¡æ¯ï¼Œä¼˜æƒ é‡‘é¢ã€ä½¿ç”¨è§„åˆ™ç­‰<br>tb_seckill_voucherï¼šä¼˜æƒ åˆ¸çš„åº“å­˜ã€å¼€å§‹æŠ¢è´­æ—¶é—´ï¼Œç»“æŸæŠ¢è´­æ—¶é—´ã€‚ç‰¹ä»·ä¼˜æƒ åˆ¸æ‰éœ€è¦å¡«å†™è¿™äº›ä¿¡æ¯</p><p>å¹³ä»·å·ç”±äºä¼˜æƒ åŠ›åº¦å¹¶ä¸æ˜¯å¾ˆå¤§ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥ä»»æ„é¢†å–</p><p>è€Œä»£é‡‘åˆ¸ç”±äºä¼˜æƒ åŠ›åº¦å¤§ï¼Œæ‰€ä»¥åƒç¬¬äºŒç§å·ï¼Œå°±å¾—é™åˆ¶æ•°é‡ï¼Œä»è¡¨ç»“æ„ä¸Šä¹Ÿèƒ½çœ‹å‡ºï¼Œç‰¹ä»·å·é™¤äº†å…·æœ‰ä¼˜æƒ å·çš„åŸºæœ¬ä¿¡æ¯ä»¥å¤–ï¼Œè¿˜å…·æœ‰åº“å­˜ï¼ŒæŠ¢è´­æ—¶é—´ï¼Œç»“æŸæ—¶é—´ç­‰ç­‰å­—æ®µ</p><div class="tabs" id="e389ccba-adc1-4058-b892-47404b04c12b"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e389ccba-adc1-4058-b892-47404b04c12b-1"><i class="fas fa-seedling"></i>æ–°å¢æ™®é€šå·</button></li><li class="tab"><button type="button" data-href="#e389ccba-adc1-4058-b892-47404b04c12b-2"><i class="fas fa-leaf"></i>æ–°å¢ç§’æ€å·1</button></li><li class="tab"><button type="button" data-href="#e389ccba-adc1-4058-b892-47404b04c12b-3"><i class="fab fa-apple"></i>æ–°å¢ç§’æ€å·2</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e389ccba-adc1-4058-b892-47404b04c12b-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">addVoucher</span><span class="params">(<span class="meta">@RequestBody</span> Voucher voucher)</span> &#123;</span><br><span class="line">    voucherService.save(voucher);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(voucher.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e389ccba-adc1-4058-b892-47404b04c12b-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;seckill&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">addSeckillVoucher</span><span class="params">(<span class="meta">@RequestBody</span> Voucher voucher)</span> &#123;</span><br><span class="line">    voucherService.addSeckillVoucher(voucher);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(voucher.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e389ccba-adc1-4058-b892-47404b04c12b-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜ä¼˜æƒ åˆ¸</span></span><br><span class="line">    save(voucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€ä¿¡æ¯</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">    seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">    seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">    seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">    seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">    seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€åº“å­˜åˆ°Redisä¸­</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="å®ç°ç§’æ€ä¸‹å•-ç¼ºé™·ç‰ˆ">å®ç°ç§’æ€ä¸‹å•-ç¼ºé™·ç‰ˆ</h3><div class="tabs" id="faddf319-29fa-41f3-8852-c88d6baa697b"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#faddf319-29fa-41f3-8852-c88d6baa697b-1"><i class="fas fa-cat"></i>æ ¸å¿ƒæ€è·¯</button></li><li class="tab"><button type="button" data-href="#faddf319-29fa-41f3-8852-c88d6baa697b-2"><i class="fas fa-horse"></i>æ³¨æ„ç‚¹</button></li><li class="tab"><button type="button" data-href="#faddf319-29fa-41f3-8852-c88d6baa697b-3"><i class="fas fa-dove"></i>æµç¨‹å›¾</button></li><li class="tab"><button type="button" data-href="#faddf319-29fa-41f3-8852-c88d6baa697b-4"><i class="fas fa-dragon"></i>å®ç°ä»£ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="faddf319-29fa-41f3-8852-c88d6baa697b-1"><p>å½“æˆ‘ä»¬ç‚¹å‡»æŠ¢è´­æ—¶ï¼Œä¼šè§¦å‘å³ä¾§çš„è¯·æ±‚ï¼Œæˆ‘ä»¬åªéœ€è¦ç¼–å†™å¯¹åº”çš„controllerå³å¯</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653365839526.png" alt="1653365839526" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="faddf319-29fa-41f3-8852-c88d6baa697b-2"><p>ä¸‹å•æ—¶éœ€è¦åˆ¤æ–­ä¸¤ç‚¹ï¼š</p><ul><li>ç§’æ€æ˜¯å¦å¼€å§‹æˆ–ç»“æŸï¼Œå¦‚æœå°šæœªå¼€å§‹æˆ–å·²ç»ç»“æŸåˆ™æ— æ³•ä¸‹å•</li><li>åº“å­˜æ˜¯å¦å……è¶³ï¼Œä¸è¶³åˆ™æ— æ³•ä¸‹å•</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="faddf319-29fa-41f3-8852-c88d6baa697b-3"><p>å½“ç”¨æˆ·å¼€å§‹è¿›è¡Œä¸‹å•ï¼Œæˆ‘ä»¬åº”å½“å»æŸ¥è¯¢ä¼˜æƒ å·ä¿¡æ¯ï¼ŒæŸ¥è¯¢åˆ°ä¼˜æƒ å·ä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦æ»¡è¶³ç§’æ€æ¡ä»¶</p><p>æ¯”å¦‚æ—¶é—´æ˜¯å¦å……è¶³ï¼Œå¦‚æœæ—¶é—´å……è¶³ï¼Œåˆ™è¿›ä¸€æ­¥åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœä¸¤è€…éƒ½æ»¡è¶³ï¼Œåˆ™æ‰£å‡åº“å­˜ï¼Œåˆ›å»ºè®¢å•ï¼Œç„¶åè¿”å›è®¢å•idï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ¡ä»¶ä¸æ»¡è¶³åˆ™ç›´æ¥ç»“æŸã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653366238564.png" alt="1653366238564" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="faddf319-29fa-41f3-8852-c88d6baa697b-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5ï¼Œæ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock= stock -1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="comment">//æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">// 6.1.è®¢å•id</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="comment">// 6.2.ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    <span class="comment">// 6.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    save(voucherOrder);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="è¶…å–é—®é¢˜åˆ†æ">è¶…å–é—®é¢˜åˆ†æ</h3><p>åœ¨æˆ‘ä»¬åŸæœ‰ä»£ç ä¸­æ˜¯è¿™ä¹ˆå†™çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">       <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">       <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//5ï¼Œæ‰£å‡åº“å­˜</span></span><br><span class="line">   <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">           .setSql(<span class="string">&quot;stock= stock -1&quot;</span>)</span><br><span class="line">           .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update();</span><br><span class="line">   <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">       <span class="comment">//æ‰£å‡åº“å­˜</span></span><br><span class="line">       <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾çº¿ç¨‹1è¿‡æ¥æŸ¥è¯¢åº“å­˜ï¼Œåˆ¤æ–­å‡ºæ¥åº“å­˜å¤§äº1ï¼Œæ­£å‡†å¤‡å»æ‰£å‡åº“å­˜ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ¥å¾—åŠå»æ‰£å‡ï¼Œæ­¤æ—¶çº¿ç¨‹2è¿‡æ¥ï¼Œçº¿ç¨‹2ä¹Ÿå»æŸ¥è¯¢åº“å­˜ï¼Œå‘ç°è¿™ä¸ªæ•°é‡ä¸€å®šä¹Ÿå¤§äº1ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªçº¿ç¨‹éƒ½ä¼šå»æ‰£å‡åº“å­˜ï¼Œæœ€ç»ˆå¤šä¸ªçº¿ç¨‹ç›¸å½“äºä¸€èµ·å»æ‰£å‡åº“å­˜ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°åº“å­˜çš„è¶…å–é—®é¢˜ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230607171606864.png" alt="image-20230607171606864" style="zoom: 33%;" /><p>è¶…å–é—®é¢˜æ˜¯å…¸å‹çš„å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé’ˆå¯¹è¿™ä¸€é—®é¢˜çš„å¸¸è§è§£å†³æ–¹æ¡ˆå°±æ˜¯åŠ é”ï¼šè€Œå¯¹äºåŠ é”ï¼Œæˆ‘ä»¬é€šå¸¸æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆ</p><ul><li>æ‚²è§‚é”ï¼šè®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜ä¸€å®šä¼šå‘ç”Ÿï¼Œå› æ­¤åœ¨æ“ä½œæ•°æ®ä¹‹å‰å…ˆè·å–é”ï¼Œç¡®ä¿çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œã€‚ä¾‹å¦‚Synchronizedã€ Lockéƒ½å±äºæ‚²è§‚é”</li><li>ä¹è§‚é”ï¼šè®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜ä¸ä¸€å®šä¼šå‘ç”Ÿï¼Œå› æ­¤ä¸åŠ é”ï¼Œåªæ˜¯åœ¨æ›´æ–°æ•°æ®æ—¶å»åˆ¤æ–­æœ‰æ²¡æœ‰å…¶å®ƒçº¿ç¨‹å¯¹æ•°æ®åšäº†ä¿®æ”¹ã€‚å¦‚æœæ²¡æœ‰ä¿®æ”¹åˆ™è®¤ä¸ºæ˜¯å®‰å…¨çš„ï¼Œè‡ªå·±æ‰æ›´æ–°æ•°æ®ã€‚å¦‚æœå·²ç»è¢«å…¶å®ƒçº¿ç¨‹ä¿®æ”¹è¯´æ˜å‘ç”Ÿäº†å®‰å…¨é—®é¢˜ï¼Œæ­¤æ—¶å¯ä»¥é‡è¯•æˆ–å¼‚å¸¸ã€‚</li></ul><hr><h3 id="ä¹è§‚é”è§£å†³è¶…å–é—®é¢˜">ä¹è§‚é”è§£å†³è¶…å–é—®é¢˜</h3><div class="tabs" id="3ed92029-ae41-412d-8870-94fe421ccd57"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#3ed92029-ae41-412d-8870-94fe421ccd57-1"><i class="fas fa-award"></i>ä¿®æ”¹ä»£ç æ–¹æ¡ˆä¸€</button></li><li class="tab"><button type="button" data-href="#3ed92029-ae41-412d-8870-94fe421ccd57-2"><i class="fas fa-baseball-ball"></i>æ”¹è¿›ä»£ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="3ed92029-ae41-412d-8870-94fe421ccd57-1"><p>VoucherOrderServiceImpl åœ¨æ‰£å‡åº“å­˜æ—¶ï¼Œæ”¹ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock= stock -1&quot;</span>) <span class="comment">//set stock = stock -1</span></span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).eq(<span class="string">&quot;stock&quot;</span>,voucher.getStock()).update(); <span class="comment">//where id = ï¼Ÿ and stock = ?</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šé€»è¾‘çš„æ ¸å¿ƒå«ä¹‰æ˜¯ï¼šåªè¦æˆ‘æ‰£å‡åº“å­˜æ—¶çš„åº“å­˜å’Œä¹‹å‰æˆ‘æŸ¥è¯¢åˆ°çš„åº“å­˜æ˜¯ä¸€æ ·çš„ï¼Œå°±æ„å‘³ç€æ²¡æœ‰äººåœ¨ä¸­é—´ä¿®æ”¹è¿‡åº“å­˜ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±æ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯ä»¥ä¸Šè¿™ç§æ–¹å¼é€šè¿‡æµ‹è¯•å‘ç°ä¼šæœ‰å¾ˆå¤šå¤±è´¥çš„æƒ…å†µï¼Œå¤±è´¥çš„åŸå› åœ¨äºï¼šåœ¨ä½¿ç”¨ä¹è§‚é”è¿‡ç¨‹ä¸­å‡è®¾100ä¸ªçº¿ç¨‹åŒæ—¶éƒ½æ‹¿åˆ°äº†100çš„åº“å­˜ï¼Œç„¶åå¤§å®¶ä¸€èµ·å»è¿›è¡Œæ‰£å‡ï¼Œä½†æ˜¯100ä¸ªäººä¸­åªæœ‰1ä¸ªäººèƒ½æ‰£å‡æˆåŠŸï¼Œå…¶ä»–çš„äººåœ¨å¤„ç†æ—¶ï¼Œä»–ä»¬åœ¨æ‰£å‡æ—¶ï¼Œåº“å­˜å·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œæ‰€ä»¥æ­¤æ—¶å…¶ä»–çº¿ç¨‹éƒ½ä¼šå¤±è´¥</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="3ed92029-ae41-412d-8870-94fe421ccd57-2"><p>ä¹‹å‰çš„æ–¹å¼è¦ä¿®æ”¹å‰åéƒ½ä¿æŒä¸€è‡´ï¼Œä½†æ˜¯è¿™æ ·æˆ‘ä»¬åˆ†æè¿‡ï¼ŒæˆåŠŸçš„æ¦‚ç‡å¤ªä½ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ä¹è§‚é”éœ€è¦å˜ä¸€ä¸‹ï¼Œæ”¹æˆstockå¤§äº0 å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock= stock -1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update().gt(<span class="string">&quot;stock&quot;</span>,<span class="number">0</span>); <span class="comment">//where id = ? and stock &gt; 0</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="ä¸€äººä¸€å•">ä¸€äººä¸€å•</h3><p>éœ€æ±‚ï¼šä¿®æ”¹ç§’æ€ä¸šåŠ¡ï¼Œè¦æ±‚åŒä¸€ä¸ªä¼˜æƒ åˆ¸ï¼Œä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€å•</p><p>ç°åœ¨çš„é—®é¢˜åœ¨äºï¼š</p><p>ä¼˜æƒ å·æ˜¯ä¸ºäº†å¼•æµï¼Œä½†æ˜¯ç›®å‰çš„æƒ…å†µæ˜¯ï¼Œä¸€ä¸ªäººå¯ä»¥æ— é™åˆ¶çš„æŠ¢è¿™ä¸ªä¼˜æƒ å·ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”å½“å¢åŠ ä¸€å±‚é€»è¾‘ï¼Œè®©ä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€ä¸ªå•ï¼Œè€Œä¸æ˜¯è®©ä¸€ä¸ªç”¨æˆ·ä¸‹å¤šä¸ªå•</p><p>å…·ä½“æ“ä½œé€»è¾‘å¦‚ä¸‹ï¼šæ¯”å¦‚æ—¶é—´æ˜¯å¦å……è¶³ï¼Œå¦‚æœæ—¶é—´å……è¶³ï¼Œåˆ™è¿›ä¸€æ­¥åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œç„¶åå†æ ¹æ®ä¼˜æƒ å·idå’Œç”¨æˆ·idæŸ¥è¯¢æ˜¯å¦å·²ç»ä¸‹è¿‡è¿™ä¸ªè®¢å•ï¼Œå¦‚æœä¸‹è¿‡è¿™ä¸ªè®¢å•ï¼Œåˆ™ä¸å†ä¸‹å•ï¼Œå¦åˆ™è¿›è¡Œä¸‹å•</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653371854389.png" alt="1653371854389" style="zoom:67%;" /><mark class="hl-label blue">ä»£ç å®ç°</mark> <div class="tabs" id="335ee1ee-824b-4142-8394-a9c120829fa1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#335ee1ee-824b-4142-8394-a9c120829fa1-1"><i class="fas fa-bug"></i>åˆæ­¥ä»£ç </button></li><li class="tab"><button type="button" data-href="#335ee1ee-824b-4142-8394-a9c120829fa1-2"><i class="fas fa-heartbeat"></i>å°è£…æ–¹æ³•</button></li><li class="tab"><button type="button" data-href="#335ee1ee-824b-4142-8394-a9c120829fa1-3"><i class="fas fa-cannabis"></i>é—®é¢˜åˆ†æ1</button></li><li class="tab"><button type="button" data-href="#335ee1ee-824b-4142-8394-a9c120829fa1-4"><i class="fas fa-candy-cane"></i>ä»£ç å®ç°1</button></li><li class="tab"><button type="button" data-href="#335ee1ee-824b-4142-8394-a9c120829fa1-5"><i class="fas fa-child"></i>é—®é¢˜åˆ†æ2</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="335ee1ee-824b-4142-8394-a9c120829fa1-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.ä¸€äººä¸€å•é€»è¾‘</span></span><br><span class="line">    <span class="comment">// 5.1.ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">    <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6ï¼Œæ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock= stock -1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="comment">//æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//7.åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">// 7.1.è®¢å•id</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line"></span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    <span class="comment">// 7.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    save(voucherOrder);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="335ee1ee-824b-4142-8394-a9c120829fa1-2"><p>å°è£…äº†ä¸€ä¸ªcreateVoucherOrderæ–¹æ³•ï¼ŒåŒæ—¶ä¸ºäº†ç¡®ä¿ä»–çº¿ç¨‹å®‰å…¨ï¼Œåœ¨æ–¹æ³•ä¸Šæ·»åŠ äº†ä¸€æŠŠsynchronized é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">         <span class="comment">// 5.1.æŸ¥è¯¢è®¢å•</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">        <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) <span class="comment">// set stock = stock - 1</span></span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>) <span class="comment">// where id = ? and stock &gt; 0</span></span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.åˆ›å»ºè®¢å•</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="comment">// 7.1.è®¢å•id</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        <span class="comment">// 7.2.ç”¨æˆ·id</span></span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        <span class="comment">// 7.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        save(voucherOrder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.è¿”å›è®¢å•id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="335ee1ee-824b-4142-8394-a9c120829fa1-3"><p>ç°åœ¨çš„é—®é¢˜è¿˜æ˜¯å’Œä¹‹å‰ä¸€æ ·ï¼Œå¹¶å‘è¿‡æ¥ï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œéƒ½ä¸å­˜åœ¨è®¢å•ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯éœ€è¦åŠ é”ï¼Œä½†æ˜¯ä¹è§‚é”æ¯”è¾ƒé€‚åˆæ›´æ–°æ•°æ®ï¼Œè€Œç°åœ¨æ˜¯æ’å…¥æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ‚²è§‚é”æ“ä½œã€‚æˆ‘ä»¬åœ¨æ–¹æ³•ä¸Šæ·»åŠ äº†ä¸€æŠŠsynchronized é”ï¼Œä½†æ˜¯è¿™æ ·æ·»åŠ é”ï¼Œé”çš„ç²’åº¦å¤ªç²—äº†ï¼Œåœ¨ä½¿ç”¨é”è¿‡ç¨‹ä¸­ï¼Œæ§åˆ¶é”ç²’åº¦æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„äº‹æƒ…ï¼Œå› ä¸ºå¦‚æœé”çš„ç²’åº¦å¤ªå¤§ï¼Œä¼šå¯¼è‡´æ¯ä¸ªçº¿ç¨‹è¿›æ¥éƒ½ä¼šé”ä½ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»æ§åˆ¶é”çš„ç²’åº¦ã€‚intern() è¿™ä¸ªæ–¹æ³•æ˜¯ä»å¸¸é‡æ± ä¸­æ‹¿åˆ°æ•°æ®ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨userId.toString() ä»–æ‹¿åˆ°çš„å¯¹è±¡å®é™…ä¸Šæ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œnewå‡ºæ¥çš„å¯¹è±¡ï¼Œæˆ‘ä»¬ä½¿ç”¨é”å¿…é¡»ä¿è¯é”å¿…é¡»æ˜¯åŒä¸€æŠŠï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨intern()æ–¹æ³•ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="335ee1ee-824b-4142-8394-a9c120829fa1-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span>  Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="keyword">synchronized</span>(userId.toString().intern())&#123;</span><br><span class="line">        <span class="comment">// 5.1.æŸ¥è¯¢è®¢å•</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">        <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) <span class="comment">// set stock = stock - 1</span></span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>) <span class="comment">// where id = ? and stock &gt; 0</span></span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.åˆ›å»ºè®¢å•</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="comment">// 7.1.è®¢å•id</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        <span class="comment">// 7.2.ç”¨æˆ·id</span></span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        <span class="comment">// 7.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        save(voucherOrder);</span><br><span class="line">        <span class="comment">// 7.è¿”å›è®¢å•id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="335ee1ee-824b-4142-8394-a9c120829fa1-5"><p>ä½†æ˜¯ä»¥ä¸Šä»£ç è¿˜æ˜¯å­˜åœ¨é—®é¢˜ï¼Œé—®é¢˜çš„åŸå› åœ¨äºå½“å‰æ–¹æ³•è¢«springçš„äº‹åŠ¡æ§åˆ¶ï¼Œå¦‚æœä½ åœ¨æ–¹æ³•å†…éƒ¨åŠ é”ï¼Œå¯èƒ½ä¼šå¯¼è‡´å½“å‰æ–¹æ³•äº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ï¼Œä½†æ˜¯é”å·²ç»é‡Šæ”¾ä¹Ÿä¼šå¯¼è‡´é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©å°†å½“å‰æ–¹æ³•æ•´ä½“åŒ…è£¹èµ·æ¥ï¼Œç¡®ä¿äº‹åŠ¡ä¸ä¼šå‡ºç°é—®é¢˜ï¼šå¦‚ä¸‹ï¼š</p><p>åœ¨seckillVoucher æ–¹æ³•ä¸­ï¼Œæ·»åŠ ä»¥ä¸‹é€»è¾‘ï¼Œè¿™æ ·å°±èƒ½ä¿è¯äº‹åŠ¡çš„ç‰¹æ€§ï¼ŒåŒæ—¶ä¹Ÿæ§åˆ¶äº†é”çš„ç²’åº¦</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653373434815.png" alt="1653373434815"></p><p>ä½†æ˜¯ä»¥ä¸Šåšæ³•ä¾ç„¶æœ‰é—®é¢˜ï¼Œå› ä¸ºä½ è°ƒç”¨çš„æ–¹æ³•ï¼Œå…¶å®æ˜¯this.çš„æ–¹å¼è°ƒç”¨çš„ï¼Œäº‹åŠ¡æƒ³è¦ç”Ÿæ•ˆï¼Œè¿˜å¾—åˆ©ç”¨ä»£ç†æ¥ç”Ÿæ•ˆï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹ï¼Œæˆ‘ä»¬éœ€è¦è·å¾—åŸå§‹çš„äº‹åŠ¡å¯¹è±¡ï¼Œ æ¥æ“ä½œäº‹åŠ¡</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653383810643.png" alt="1653383810643"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜">é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜</h3><p>é€šè¿‡åŠ é”å¯ä»¥è§£å†³åœ¨å•æœºæƒ…å†µä¸‹çš„ä¸€äººä¸€å•å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯åœ¨é›†ç¾¤æ¨¡å¼ä¸‹å°±ä¸è¡Œäº†ã€‚</p><p>ç”±äºç°åœ¨æˆ‘ä»¬éƒ¨ç½²äº†å¤šä¸ªtomcatï¼Œæ¯ä¸ªtomcatéƒ½æœ‰ä¸€ä¸ªå±äºè‡ªå·±çš„jvmï¼Œé‚£ä¹ˆå‡è®¾åœ¨æœåŠ¡å™¨Açš„tomcatå†…éƒ¨ï¼Œæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹ç”±äºä½¿ç”¨çš„æ˜¯åŒä¸€ä»½ä»£ç ï¼Œé‚£ä¹ˆä»–ä»¬çš„é”å¯¹è±¡æ˜¯åŒä¸€ä¸ªï¼Œæ˜¯å¯ä»¥å®ç°äº’æ–¥çš„ï¼Œä½†æ˜¯å¦‚æœç°åœ¨æ˜¯æœåŠ¡å™¨Bçš„tomcatå†…éƒ¨ï¼Œåˆæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯ä»–ä»¬çš„é”å¯¹è±¡å†™çš„è™½ç„¶å’ŒæœåŠ¡å™¨Aä¸€æ ·ï¼Œä½†æ˜¯é”å¯¹è±¡å´ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥çº¿ç¨‹3å’Œçº¿ç¨‹4å¯ä»¥å®ç°äº’æ–¥ï¼Œä½†æ˜¯å´æ— æ³•å’Œçº¿ç¨‹1å’Œçº¿ç¨‹2å®ç°äº’æ–¥ï¼Œè¿™å°±æ˜¯ é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œsyné”å¤±æ•ˆçš„åŸå› ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653374044740.png" alt="1653374044740"></p><hr><hr><h2 id="åˆ†å¸ƒå¼é”">åˆ†å¸ƒå¼é”</h2><h3 id="åŸºæœ¬åŸç†å’Œå®ç°æ–¹å¼å¯¹æ¯”">åŸºæœ¬åŸç†å’Œå®ç°æ–¹å¼å¯¹æ¯”</h3><p>åˆ†å¸ƒå¼é”ï¼šæ»¡è¶³åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–é›†ç¾¤æ¨¡å¼ä¸‹å¤šè¿›ç¨‹å¯è§å¹¶ä¸”äº’æ–¥çš„é”ã€‚</p><p>åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯è®©å¤§å®¶éƒ½ä½¿ç”¨åŒä¸€æŠŠé”ï¼Œåªè¦å¤§å®¶ä½¿ç”¨çš„æ˜¯åŒä¸€æŠŠé”ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½é”ä½çº¿ç¨‹ï¼Œä¸è®©çº¿ç¨‹è¿›è¡Œï¼Œè®©ç¨‹åºä¸²è¡Œæ‰§è¡Œï¼Œè¿™å°±æ˜¯åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€è·¯</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653374296906.png" alt="1653374296906" style="zoom: 50%;" /><mark class="hl-label blue">é‚£ä¹ˆåˆ†å¸ƒå¼é”ä»–åº”è¯¥æ»¡è¶³ä¸€äº›ä»€ä¹ˆæ ·çš„æ¡ä»¶å‘¢ï¼Ÿ</mark> <p>å¯è§æ€§ï¼šå¤šä¸ªçº¿ç¨‹éƒ½èƒ½çœ‹åˆ°ç›¸åŒçš„ç»“æœï¼Œæ³¨æ„ï¼šè¿™ä¸ªåœ°æ–¹è¯´çš„å¯è§æ€§å¹¶ä¸æ˜¯å¹¶å‘ç¼–ç¨‹ä¸­æŒ‡çš„å†…å­˜å¯è§æ€§ï¼Œåªæ˜¯è¯´å¤šä¸ªè¿›ç¨‹ä¹‹é—´éƒ½èƒ½æ„ŸçŸ¥åˆ°å˜åŒ–çš„æ„æ€</p><p>äº’æ–¥ï¼šäº’æ–¥æ˜¯åˆ†å¸ƒå¼é”çš„æœ€åŸºæœ¬çš„æ¡ä»¶ï¼Œä½¿å¾—ç¨‹åºä¸²è¡Œæ‰§è¡Œ</p><p>é«˜å¯ç”¨ï¼šç¨‹åºä¸æ˜“å´©æºƒï¼Œæ—¶æ—¶åˆ»åˆ»éƒ½ä¿è¯è¾ƒé«˜çš„å¯ç”¨æ€§</p><p>é«˜æ€§èƒ½ï¼šç”±äºåŠ é”æœ¬èº«å°±è®©æ€§èƒ½é™ä½ï¼Œæ‰€æœ‰å¯¹äºåˆ†å¸ƒå¼é”æœ¬èº«éœ€è¦ä»–å°±è¾ƒé«˜çš„åŠ é”æ€§èƒ½å’Œé‡Šæ”¾é”æ€§èƒ½</p><p>å®‰å…¨æ€§ï¼šå®‰å…¨ä¹Ÿæ˜¯ç¨‹åºä¸­å¿…ä¸å¯å°‘çš„ä¸€ç¯</p><mark class="hl-label blue">å¸¸è§çš„åˆ†å¸ƒå¼é”æœ‰ä¸‰ç§</mark> <p>Mysqlï¼šmysqlæœ¬èº«å°±å¸¦æœ‰é”æœºåˆ¶ï¼Œä½†æ˜¯ç”±äºmysqlæ€§èƒ½æœ¬èº«ä¸€èˆ¬ï¼Œæ‰€ä»¥é‡‡ç”¨åˆ†å¸ƒå¼é”çš„æƒ…å†µä¸‹ï¼Œå…¶å®ä½¿ç”¨mysqlä½œä¸ºåˆ†å¸ƒå¼é”æ¯”è¾ƒå°‘è§</p><p>Redisï¼šredisä½œä¸ºåˆ†å¸ƒå¼é”æ˜¯éå¸¸å¸¸è§çš„ä¸€ç§ä½¿ç”¨æ–¹å¼ï¼Œç°åœ¨ä¼ä¸šçº§å¼€å‘ä¸­åŸºæœ¬éƒ½ä½¿ç”¨redisæˆ–è€…zookeeperä½œä¸ºåˆ†å¸ƒå¼é”ï¼Œåˆ©ç”¨setnxè¿™ä¸ªæ–¹æ³•ï¼Œå¦‚æœæ’å…¥keyæˆåŠŸï¼Œåˆ™è¡¨ç¤ºè·å¾—åˆ°äº†é”ï¼Œå¦‚æœæœ‰äººæ’å…¥æˆåŠŸï¼Œå…¶ä»–äººæ’å…¥å¤±è´¥åˆ™è¡¨ç¤ºæ— æ³•è·å¾—åˆ°é”ï¼Œåˆ©ç”¨è¿™å¥—é€»è¾‘æ¥å®ç°åˆ†å¸ƒå¼é”</p><p>Zookeeperï¼šzookeeperä¹Ÿæ˜¯ä¼ä¸šçº§å¼€å‘ä¸­è¾ƒå¥½çš„ä¸€ä¸ªå®ç°åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆï¼Œç”±äºæœ¬å¥—è§†é¢‘å¹¶ä¸è®²è§£zookeeperçš„åŸç†å’Œåˆ†å¸ƒå¼é”çš„å®ç°ï¼Œæ‰€ä»¥ä¸è¿‡å¤šé˜è¿°</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">MySQL</th><th style="text-align:center">Redis</th><th style="text-align:center">Zookeeper</th></tr></thead><tbody><tr><td style="text-align:center">äº’æ–¥</td><td style="text-align:center">åˆ©ç”¨mysqlæœ¬èº«çš„äº’æ–¥é”æœºåˆ¶</td><td style="text-align:center">åˆ©ç”¨setnxè¿™æ ·çš„äº’æ–¥å‘½ä»¤</td><td style="text-align:center">åˆ©ç”¨èŠ‚ç‚¹çš„å”¯ä¸€æ€§å’Œæœ‰åºæ€§å®ç°äº’æ–¥</td></tr><tr><td style="text-align:center">é«˜å¯ç”¨</td><td style="text-align:center">å¥½</td><td style="text-align:center">å¥½</td><td style="text-align:center">å¥½</td></tr><tr><td style="text-align:center">é«˜æ€§èƒ½</td><td style="text-align:center">ä¸€èˆ¬</td><td style="text-align:center">å¥½</td><td style="text-align:center">ä¸€èˆ¬</td></tr><tr><td style="text-align:center">å®‰å…¨æ€§</td><td style="text-align:center">æ–­å¼€è¿æ¥ï¼Œè‡ªåŠ¨é‡Šæ”¾é”</td><td style="text-align:center">åˆ©ç”¨é”è¶…æ—¶æ—¶é—´ï¼Œåˆ°æœŸé‡Šæ”¾</td><td style="text-align:center">ä¸´æ—¶èŠ‚ç‚¹ï¼Œæ–­å¼€è¿æ¥è‡ªåŠ¨é‡Šæ”¾</td></tr></tbody></table><hr><h3 id="Redisåˆ†å¸ƒå¼é”å®ç°æ€è·¯">Redisåˆ†å¸ƒå¼é”å®ç°æ€è·¯</h3><p>å®ç°åˆ†å¸ƒå¼é”æ—¶éœ€è¦å®ç°çš„ä¸¤ä¸ªåŸºæœ¬æ–¹æ³•ï¼š</p><ul><li><p>è·å–é”ï¼š</p><ul><li>äº’æ–¥ï¼šç¡®ä¿åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”</li><li>éé˜»å¡ï¼šå°è¯•ä¸€æ¬¡ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false</li></ul></li><li><p>é‡Šæ”¾é”ï¼š</p><ul><li>æ‰‹åŠ¨é‡Šæ”¾</li><li>è¶…æ—¶é‡Šæ”¾ï¼šè·å–é”æ—¶æ·»åŠ ä¸€ä¸ªè¶…æ—¶æ—¶é—´</li></ul></li></ul><p>æˆ‘ä»¬åˆ©ç”¨redis çš„setnxæ–¹æ³•ï¼Œå½“æœ‰å¤šä¸ªçº¿ç¨‹è¿›å…¥æ—¶ï¼Œæˆ‘ä»¬å°±åˆ©ç”¨è¯¥æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›å…¥æ—¶ï¼Œredis ä¸­å°±æœ‰è¿™ä¸ªkey äº†ï¼Œè¿”å›äº†1ï¼Œå¦‚æœç»“æœæ˜¯1ï¼Œåˆ™è¡¨ç¤ºä»–æŠ¢åˆ°äº†é”ï¼Œé‚£ä¹ˆä»–å»æ‰§è¡Œä¸šåŠ¡ï¼Œç„¶åå†åˆ é™¤é”ï¼Œé€€å‡ºé”é€»è¾‘ï¼Œæ²¡æœ‰æŠ¢åˆ°é”çš„å“¥ä»¬ï¼Œç­‰å¾…ä¸€å®šæ—¶é—´åé‡è¯•å³å¯</p><hr><h3 id="Rediså®ç°åˆ†å¸ƒå¼é”ç‰ˆæœ¬ä¸€">Rediså®ç°åˆ†å¸ƒå¼é”ç‰ˆæœ¬ä¸€</h3><div class="tabs" id="6661440d-2301-409e-8e0d-f8408cedc68f"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6661440d-2301-409e-8e0d-f8408cedc68f-1"><i class="fas fa-award"></i>é”çš„åŸºæœ¬æ¥å£</button></li><li class="tab"><button type="button" data-href="#6661440d-2301-409e-8e0d-f8408cedc68f-2"><i class="fas fa-baseball-ball"></i>åŠ é”é€»è¾‘</button></li><li class="tab"><button type="button" data-href="#6661440d-2301-409e-8e0d-f8408cedc68f-3"><i class="fas fa-bone"></i>é‡Šæ”¾é”é€»è¾‘</button></li><li class="tab"><button type="button" data-href="#6661440d-2301-409e-8e0d-f8408cedc68f-4"><i class="fas fa-anchor"></i>ä½¿ç”¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6661440d-2301-409e-8e0d-f8408cedc68f-1"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1656079017728.png" alt="1656079017728"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6661440d-2301-409e-8e0d-f8408cedc68f-2"><p>åˆ›å»º<code>SimpleRedisLock</code>å®ç°<code>ILock</code>æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRedisLock</span> <span class="keyword">implements</span> <span class="title class_">ILock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_PREFIX=<span class="string">&quot;lock:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">threadId</span> <span class="operator">=</span> Thread.currentThread().getId();</span><br><span class="line">        <span class="comment">// è·å–é”</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">                .setIfAbsent(KEY_PREFIX + name, threadId + <span class="string">&quot;&quot;</span>, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6661440d-2301-409e-8e0d-f8408cedc68f-3"><p>é‡Šæ”¾é”ï¼Œé˜²æ­¢åˆ é™¤åˆ«äººçš„é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//é€šè¿‡delåˆ é™¤é”</span></span><br><span class="line">    stringRedisTemplate.delete(KEY_PREFIX + name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6661440d-2301-409e-8e0d-f8408cedc68f-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">     <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">     <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">     <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">     <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">         <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">         <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">     <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">         <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">         <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">     <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">         <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">         <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">     <span class="comment">//åˆ›å»ºé”å¯¹è±¡(æ–°å¢ä»£ç )</span></span><br><span class="line">     <span class="type">SimpleRedisLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleRedisLock</span>(<span class="string">&quot;order:&quot;</span> + userId, stringRedisTemplate);</span><br><span class="line">     <span class="comment">//è·å–é”å¯¹è±¡</span></span><br><span class="line">     <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">1200</span>);</span><br><span class="line"><span class="comment">//åŠ é”å¤±è´¥</span></span><br><span class="line">     <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">         <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">//è·å–ä»£ç†å¯¹è±¡(äº‹åŠ¡)</span></span><br><span class="line">         <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">         <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">     &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">         <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">         lock.unlock();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="Redisåˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µè¯´æ˜">Redisåˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µè¯´æ˜</h3><p>é€»è¾‘è¯´æ˜ï¼š</p><p>æŒæœ‰é”çš„çº¿ç¨‹åœ¨é”çš„å†…éƒ¨å‡ºç°äº†é˜»å¡ï¼Œå¯¼è‡´ä»–çš„é”è‡ªåŠ¨é‡Šæ”¾ï¼Œè¿™æ—¶å…¶ä»–çº¿ç¨‹ï¼Œçº¿ç¨‹2æ¥å°è¯•è·å¾—é”ï¼Œå°±æ‹¿åˆ°äº†è¿™æŠŠé”ï¼Œç„¶åçº¿ç¨‹2åœ¨æŒæœ‰é”æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹1ååº”è¿‡æ¥ï¼Œç»§ç»­æ‰§è¡Œï¼Œè€Œçº¿ç¨‹1æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œèµ°åˆ°äº†åˆ é™¤é”é€»è¾‘ï¼Œæ­¤æ—¶å°±ä¼šæŠŠæœ¬åº”è¯¥å±äºçº¿ç¨‹2çš„é”è¿›è¡Œåˆ é™¤ï¼Œè¿™å°±æ˜¯è¯¯åˆ åˆ«äººé”çš„æƒ…å†µè¯´æ˜</p><p>è§£å†³æ–¹æ¡ˆï¼šè§£å†³æ–¹æ¡ˆå°±æ˜¯åœ¨æ¯ä¸ªçº¿ç¨‹é‡Šæ”¾é”çš„æ—¶å€™ï¼Œå»åˆ¤æ–­ä¸€ä¸‹å½“å‰è¿™æŠŠé”æ˜¯å¦å±äºè‡ªå·±ï¼Œå¦‚æœå±äºè‡ªå·±ï¼Œåˆ™ä¸è¿›è¡Œé”çš„åˆ é™¤ï¼Œå‡è®¾è¿˜æ˜¯ä¸Šè¾¹çš„æƒ…å†µï¼Œçº¿ç¨‹1å¡é¡¿ï¼Œé”è‡ªåŠ¨é‡Šæ”¾ï¼Œçº¿ç¨‹2è¿›å…¥åˆ°é”çš„å†…éƒ¨æ‰§è¡Œé€»è¾‘ï¼Œæ­¤æ—¶çº¿ç¨‹1ååº”è¿‡æ¥ï¼Œç„¶ååˆ é™¤é”ï¼Œä½†æ˜¯çº¿ç¨‹1ï¼Œä¸€çœ‹å½“å‰è¿™æŠŠé”ä¸æ˜¯å±äºè‡ªå·±ï¼Œäºæ˜¯ä¸è¿›è¡Œåˆ é™¤é”é€»è¾‘ï¼Œå½“çº¿ç¨‹2èµ°åˆ°åˆ é™¤é”é€»è¾‘æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¡è¿‡è‡ªåŠ¨é‡Šæ”¾é”çš„æ—¶é—´ç‚¹ï¼Œåˆ™åˆ¤æ–­å½“å‰è¿™æŠŠé”æ˜¯å±äºè‡ªå·±çš„ï¼Œäºæ˜¯åˆ é™¤è¿™æŠŠé”ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653385920025.png" alt="1653385920025" style="zoom:67%;" /><mark class="hl-label blue">è§£å†³Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜</mark> <div class="tabs" id="421e4a73-18f7-4d39-9729-ecce756dbdf1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#421e4a73-18f7-4d39-9729-ecce756dbdf1-1"><i class="fas fa-bug"></i>å®ç°æ€è·¯</button></li><li class="tab"><button type="button" data-href="#421e4a73-18f7-4d39-9729-ecce756dbdf1-2"><i class="fas fa-cannabis"></i>åŠ é”</button></li><li class="tab"><button type="button" data-href="#421e4a73-18f7-4d39-9729-ecce756dbdf1-3"><i class="fas fa-candy-cane"></i>é‡Šæ”¾é”</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="421e4a73-18f7-4d39-9729-ecce756dbdf1-1"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230607190409171.png" alt="image-20230607190409171" style="zoom:50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="421e4a73-18f7-4d39-9729-ecce756dbdf1-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ID_PREFIX</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>) + <span class="string">&quot;-&quot;</span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">   <span class="comment">// è·å–çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line">   <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">   <span class="comment">// è·å–é”</span></span><br><span class="line">   <span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">                .setIfAbsent(KEY_PREFIX + name, threadId, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">   <span class="keyword">return</span> Boolean.TRUE.equals(success);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="421e4a73-18f7-4d39-9729-ecce756dbdf1-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">    <span class="comment">// è·å–é”ä¸­çš„æ ‡ç¤º</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(KEY_PREFIX + name);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ ‡ç¤ºæ˜¯å¦ä¸€è‡´</span></span><br><span class="line">    <span class="keyword">if</span>(threadId.equals(id)) &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">        stringRedisTemplate.delete(KEY_PREFIX + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜">åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜</h3><p>æ›´ä¸ºæç«¯çš„è¯¯åˆ é€»è¾‘è¯´æ˜ï¼š</p><p>çº¿ç¨‹1ç°åœ¨æŒæœ‰é”ä¹‹åï¼Œåœ¨æ‰§è¡Œä¸šåŠ¡é€»è¾‘è¿‡ç¨‹ä¸­ï¼Œä»–æ­£å‡†å¤‡åˆ é™¤é”ï¼Œè€Œä¸”å·²ç»èµ°åˆ°äº†æ¡ä»¶åˆ¤æ–­çš„è¿‡ç¨‹ä¸­ï¼Œæ¯”å¦‚ä»–å·²ç»æ‹¿åˆ°äº†å½“å‰è¿™æŠŠé”ç¡®å®æ˜¯å±äºä»–è‡ªå·±çš„ï¼Œæ­£å‡†å¤‡åˆ é™¤é”ï¼Œä½†æ˜¯æ­¤æ—¶ä»–çš„é”åˆ°æœŸäº†ï¼Œé‚£ä¹ˆæ­¤æ—¶çº¿ç¨‹2è¿›æ¥ï¼Œä½†æ˜¯çº¿ç¨‹1ä»–ä¼šæ¥ç€å¾€åæ‰§è¡Œï¼Œå½“ä»–å¡é¡¿ç»“æŸåï¼Œä»–ç›´æ¥å°±ä¼šæ‰§è¡Œåˆ é™¤é”é‚£è¡Œä»£ç ï¼Œç›¸å½“äºæ¡ä»¶åˆ¤æ–­å¹¶æ²¡æœ‰èµ·åˆ°ä½œç”¨ï¼Œè¿™å°±æ˜¯åˆ é”æ—¶çš„åŸå­æ€§é—®é¢˜ï¼Œä¹‹æ‰€ä»¥æœ‰è¿™ä¸ªé—®é¢˜ï¼Œæ˜¯å› ä¸ºçº¿ç¨‹1çš„æ‹¿é”ï¼Œæ¯”é”ï¼Œåˆ é”ï¼Œå®é™…ä¸Šå¹¶ä¸æ˜¯åŸå­æ€§çš„ï¼Œæˆ‘ä»¬è¦é˜²æ­¢åˆšæ‰çš„æƒ…å†µå‘ç”Ÿã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230607190933715.png" alt="image-20230607190933715" style="zoom: 50%;" /><hr><h3 id="Luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜">Luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜</h3><p>Redisæä¾›äº†Luaè„šæœ¬åŠŸèƒ½ï¼Œåœ¨ä¸€ä¸ªè„šæœ¬ä¸­ç¼–å†™å¤šæ¡Rediså‘½ä»¤ï¼Œç¡®ä¿å¤šæ¡å‘½ä»¤æ‰§è¡Œæ—¶çš„åŸå­æ€§ã€‚Luaæ˜¯ä¸€ç§ç¼–ç¨‹è¯­è¨€ï¼Œå®ƒçš„åŸºæœ¬è¯­æ³•å¤§å®¶å¯ä»¥å‚è€ƒç½‘ç«™ï¼š<a href="https://www.runoob.com/lua/lua-tutorial.html%EF%BC%8C%E8%BF%99%E9%87%8C%E9%87%8D%E7%82%B9%E4%BB%8B%E7%BB%8DRedis%E6%8F%90%E4%BE%9B%E7%9A%84%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8lua%E5%8E%BB%E6%93%8D%E4%BD%9Credis%EF%BC%8C%E5%8F%88%E8%83%BD%E4%BF%9D%E8%AF%81%E4%BB%96%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%B0%B1%E5%8F%AF%E4%BB%A5%E5%AE%9E%E7%8E%B0%E6%8B%BF%E9%94%81%E6%AF%94%E9%94%81%E5%88%A0%E9%94%81%E6%98%AF%E4%B8%80%E4%B8%AA%E5%8E%9F%E5%AD%90%E6%80%A7%E5%8A%A8%E4%BD%9C%E4%BA%86%EF%BC%8C%E4%BD%9C%E4%B8%BAJava%E7%A8%8B%E5%BA%8F%E5%91%98%E8%BF%99%E4%B8%80%E5%9D%97%E5%B9%B6%E4%B8%8D%E4%BD%9C%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E8%A6%81%E6%B1%82%EF%BC%8C%E5%B9%B6%E4%B8%8D%E9%9C%80%E8%A6%81%E5%A4%A7%E5%AE%B6%E8%BF%87%E4%BA%8E%E7%B2%BE%E9%80%9A%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E4%BB%96%E6%9C%89%E4%BB%80%E4%B9%88%E4%BD%9C%E7%94%A8%E5%8D%B3%E5%8F%AF%E3%80%82">https://www.runoob.com/lua/lua-tutorial.htmlï¼Œè¿™é‡Œé‡ç‚¹ä»‹ç»Redisæä¾›çš„è°ƒç”¨å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨luaå»æ“ä½œredisï¼Œåˆèƒ½ä¿è¯ä»–çš„åŸå­æ€§ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°æ‹¿é”æ¯”é”åˆ é”æ˜¯ä¸€ä¸ªåŸå­æ€§åŠ¨ä½œäº†ï¼Œä½œä¸ºJavaç¨‹åºå‘˜è¿™ä¸€å—å¹¶ä¸ä½œä¸€ä¸ªç®€å•è¦æ±‚ï¼Œå¹¶ä¸éœ€è¦å¤§å®¶è¿‡äºç²¾é€šï¼Œåªéœ€è¦çŸ¥é“ä»–æœ‰ä»€ä¹ˆä½œç”¨å³å¯ã€‚</a></p><p>è¿™é‡Œé‡ç‚¹ä»‹ç»Redisæä¾›çš„è°ƒç”¨å‡½æ•°ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.call(<span class="string">&#x27;å‘½ä»¤åç§°&#x27;</span>, <span class="string">&#x27;key&#x27;</span>, <span class="string">&#x27;å…¶å®ƒå‚æ•°&#x27;</span>, ...)</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦æ‰§è¡Œset name jackï¼Œåˆ™è„šæœ¬æ˜¯è¿™æ ·ï¼š</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># æ‰§è¡Œ set name jack</span><br><span class="line">redis.call(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;jack&#x27;</span>)</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦å…ˆæ‰§è¡Œset name Roseï¼Œå†æ‰§è¡Œget nameï¼Œåˆ™è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># å…ˆæ‰§è¡Œ set name jack</span><br><span class="line">redis.call(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;Rose&#x27;</span>)</span><br><span class="line"># å†æ‰§è¡Œ get name</span><br><span class="line"><span class="keyword">local</span> name = redis.call(<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"># è¿”å›</span><br><span class="line"><span class="keyword">return</span> name</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å›ä¸€ä¸‹æˆ‘ä»¬é‡Šæ”¾é”çš„é€»è¾‘ï¼š</p><p>é‡Šæ”¾é”çš„ä¸šåŠ¡æµç¨‹æ˜¯è¿™æ ·çš„</p><p>â€‹1ã€è·å–é”ä¸­çš„çº¿ç¨‹æ ‡ç¤º</p><p>â€‹2ã€åˆ¤æ–­æ˜¯å¦ä¸æŒ‡å®šçš„æ ‡ç¤ºï¼ˆå½“å‰çº¿ç¨‹æ ‡ç¤ºï¼‰ä¸€è‡´</p><p>â€‹3ã€å¦‚æœä¸€è‡´åˆ™é‡Šæ”¾é”ï¼ˆåˆ é™¤ï¼‰</p><p>â€‹4ã€å¦‚æœä¸ä¸€è‡´åˆ™ä»€ä¹ˆéƒ½ä¸åš</p><p>å¦‚æœç”¨Luaè„šæœ¬æ¥è¡¨ç¤ºåˆ™æ˜¯è¿™æ ·çš„ï¼š</p><p>æœ€ç»ˆæˆ‘ä»¬æ“ä½œredisçš„æ‹¿é”æ¯”é”åˆ é”çš„luaè„šæœ¬å°±ä¼šå˜æˆè¿™æ ·</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- è¿™é‡Œçš„ KEYS[1] å°±æ˜¯é”çš„keyï¼Œè¿™é‡Œçš„ARGV[1] å°±æ˜¯å½“å‰çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line"><span class="comment">-- è·å–é”ä¸­çš„æ ‡ç¤ºï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡ç¤ºä¸€è‡´</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;GET&#x27;</span>, KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>]) <span class="keyword">then</span></span><br><span class="line">  <span class="comment">-- ä¸€è‡´ï¼Œåˆ™åˆ é™¤é”</span></span><br><span class="line">  <span class="keyword">return</span> redis.call(<span class="string">&#x27;DEL&#x27;</span>, KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- ä¸ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><mark class="hl-label blue">æœ€ç»ˆè§£é”ä»£ç </mark> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; UNLOCK_SCRIPT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    UNLOCK_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>();</span><br><span class="line">    UNLOCK_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;unlock.lua&quot;</span>));</span><br><span class="line">    UNLOCK_SCRIPT.setResultType(Long.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    stringRedisTemplate.execute(UNLOCK_SCRIPT,</span><br><span class="line">            Collections.singletonList(KEY_PREFIX + name),</span><br><span class="line">            ID_PREFIX + Thread.currentThread().getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="å°æ€»ç»“">å°æ€»ç»“</h3><p>åŸºäºRedisçš„åˆ†å¸ƒå¼é”å®ç°æ€è·¯ï¼š</p><ul><li>åˆ©ç”¨set nx exè·å–é”ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä¿å­˜çº¿ç¨‹æ ‡ç¤º</li><li>é‡Šæ”¾é”æ—¶å…ˆåˆ¤æ–­çº¿ç¨‹æ ‡ç¤ºæ˜¯å¦ä¸è‡ªå·±ä¸€è‡´ï¼Œä¸€è‡´åˆ™åˆ é™¤é”<ul><li>ç‰¹æ€§ï¼š<ul><li>åˆ©ç”¨set nxæ»¡è¶³äº’æ–¥æ€§</li><li>åˆ©ç”¨set exä¿è¯æ•…éšœæ—¶é”ä¾ç„¶èƒ½é‡Šæ”¾ï¼Œé¿å…æ­»é”ï¼Œæé«˜å®‰å…¨æ€§</li><li>åˆ©ç”¨Redisé›†ç¾¤ä¿è¯é«˜å¯ç”¨å’Œé«˜å¹¶å‘ç‰¹æ€§</li></ul></li></ul></li></ul><p>ç¬”è€…æ€»ç»“ï¼šæˆ‘ä»¬ä¸€è·¯èµ°æ¥ï¼Œåˆ©ç”¨æ·»åŠ è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”é—®é¢˜çš„å‘ç”Ÿï¼Œä½†æ˜¯æœ‰äº†è¿‡æœŸæ—¶é—´ä¹‹åï¼Œå¯èƒ½å‡ºç°è¯¯åˆ åˆ«äººé”çš„é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¼€å§‹æ˜¯åˆ©ç”¨åˆ ä¹‹å‰ é€šè¿‡æ‹¿é”ï¼Œæ¯”é”ï¼Œåˆ é”è¿™ä¸ªé€»è¾‘æ¥è§£å†³çš„ï¼Œä¹Ÿå°±æ˜¯åˆ ä¹‹å‰åˆ¤æ–­ä¸€ä¸‹å½“å‰è¿™æŠŠé”æ˜¯å¦æ˜¯å±äºè‡ªå·±çš„ï¼Œä½†æ˜¯ç°åœ¨è¿˜æœ‰åŸå­æ€§é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ²¡æ³•ä¿è¯æ‹¿é”æ¯”é”åˆ é”æ˜¯ä¸€ä¸ªåŸå­æ€§çš„åŠ¨ä½œï¼Œæœ€åé€šè¿‡luaè¡¨è¾¾å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜</p><p>ä½†æ˜¯ç›®å‰è¿˜å‰©ä¸‹ä¸€ä¸ªé—®é¢˜é”ä¸ä½ï¼Œä»€ä¹ˆæ˜¯é”ä¸ä½å‘¢ï¼Œä½ æƒ³ä¸€æƒ³ï¼Œå¦‚æœå½“è¿‡æœŸæ—¶é—´åˆ°äº†ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ç»™ä»–ç»­æœŸä¸€ä¸‹ï¼Œæ¯”å¦‚ç»­ä¸ª30sï¼Œå°±å¥½åƒæ˜¯ç½‘å§ä¸Šç½‘ï¼Œ ç½‘è´¹åˆ°äº†ä¹‹åï¼Œç„¶åè¯´ï¼Œæ¥ï¼Œç½‘ç®¡ï¼Œå†ç»™æˆ‘æ¥10å—çš„ï¼Œæ˜¯ä¸æ˜¯åè¾¹çš„é—®é¢˜éƒ½ä¸ä¼šå‘ç”Ÿäº†ï¼Œé‚£ä¹ˆç»­æœŸé—®é¢˜æ€ä¹ˆè§£å†³å‘¢ï¼Œå¯ä»¥ä¾èµ–äºæˆ‘ä»¬æ¥ä¸‹æ¥è¦å­¦ä¹ redissionå•¦</p><hr><hr><h2 id="åˆ†å¸ƒå¼é”-redission">åˆ†å¸ƒå¼é”-redission</h2><h3 id="setnxå­˜åœ¨çš„é—®é¢˜">setnxå­˜åœ¨çš„é—®é¢˜</h3><p>åŸºäºsetnxå®ç°çš„åˆ†å¸ƒå¼é”å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š</p><ul><li>é‡å…¥é—®é¢˜ï¼šé‡å…¥é—®é¢˜æ˜¯æŒ‡ è·å¾—é”çš„çº¿ç¨‹å¯ä»¥å†æ¬¡è¿›å…¥åˆ°ç›¸åŒçš„é”çš„ä»£ç å—ä¸­ï¼Œå¯é‡å…¥é”çš„æ„ä¹‰åœ¨äºé˜²æ­¢æ­»é”ï¼Œæ¯”å¦‚HashTableè¿™æ ·çš„ä»£ç ä¸­ï¼Œä»–çš„æ–¹æ³•éƒ½æ˜¯ä½¿ç”¨synchronizedä¿®é¥°çš„ï¼Œå‡å¦‚ä»–åœ¨ä¸€ä¸ªæ–¹æ³•å†…ï¼Œè°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆæ­¤æ—¶å¦‚æœæ˜¯ä¸å¯é‡å…¥çš„ï¼Œä¸å°±æ­»é”äº†å—ï¼Ÿæ‰€ä»¥å¯é‡å…¥é”ä»–çš„ä¸»è¦æ„ä¹‰æ˜¯é˜²æ­¢æ­»é”ï¼Œæˆ‘ä»¬çš„synchronizedå’ŒLocké”éƒ½æ˜¯å¯é‡å…¥çš„ã€‚</li><li>ä¸å¯é‡è¯•ï¼šæ˜¯æŒ‡ç›®å‰çš„åˆ†å¸ƒå¼åªèƒ½å°è¯•ä¸€æ¬¡ï¼Œæˆ‘ä»¬è®¤ä¸ºåˆç†çš„æƒ…å†µæ˜¯ï¼šå½“çº¿ç¨‹åœ¨è·å¾—é”å¤±è´¥åï¼Œä»–åº”è¯¥èƒ½å†æ¬¡å°è¯•è·å¾—é”ã€‚</li><li>è¶…æ—¶é‡Šæ”¾ï¼šæˆ‘ä»¬åœ¨åŠ é”æ—¶å¢åŠ äº†è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·çš„æˆ‘ä»¬å¯ä»¥é˜²æ­¢æ­»é”ï¼Œä½†æ˜¯å¦‚æœå¡é¡¿çš„æ—¶é—´è¶…é•¿ï¼Œè™½ç„¶æˆ‘ä»¬é‡‡ç”¨äº†luaè¡¨è¾¾å¼é˜²æ­¢åˆ é”çš„æ—¶å€™ï¼Œè¯¯åˆ åˆ«äººçš„é”ï¼Œä½†æ˜¯æ¯•ç«Ÿæ²¡æœ‰é”ä½ï¼Œæœ‰å®‰å…¨éšæ‚£</li><li>ä¸»ä»ä¸€è‡´æ€§ï¼š å¦‚æœRedisæä¾›äº†ä¸»ä»é›†ç¾¤ï¼Œå½“æˆ‘ä»¬å‘é›†ç¾¤å†™æ•°æ®æ—¶ï¼Œä¸»æœºéœ€è¦å¼‚æ­¥çš„å°†æ•°æ®åŒæ­¥ç»™ä»æœºï¼Œè€Œä¸‡ä¸€åœ¨åŒæ­¥è¿‡å»ä¹‹å‰ï¼Œä¸»æœºå®•æœºäº†ï¼Œå°±ä¼šå‡ºç°æ­»é”é—®é¢˜ã€‚</li></ul><p>é‚£ä¹ˆä»€ä¹ˆæ˜¯Redissionå‘¢ï¼Ÿ</p><p>Redissonæ˜¯ä¸€ä¸ªåœ¨Redisçš„åŸºç¡€ä¸Šå®ç°çš„Javaé©»å†…å­˜æ•°æ®ç½‘æ ¼ï¼ˆIn-Memory Data Gridï¼‰ã€‚å®ƒä¸ä»…æä¾›äº†ä¸€ç³»åˆ—çš„åˆ†å¸ƒå¼çš„Javaå¸¸ç”¨å¯¹è±¡ï¼Œè¿˜æä¾›äº†è®¸å¤šåˆ†å¸ƒå¼æœåŠ¡ï¼Œå…¶ä¸­å°±åŒ…å«äº†å„ç§åˆ†å¸ƒå¼é”çš„å®ç°ã€‚Redissionæä¾›äº†åˆ†å¸ƒå¼é”çš„å¤šç§å¤šæ ·çš„åŠŸèƒ½ã€‚</p><hr><h3 id="Redissionå¿«é€Ÿå…¥é—¨">Redissionå¿«é€Ÿå…¥é—¨</h3><div class="tabs" id="550dcb47-48ae-4dc5-81b4-1849f0bde594"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#550dcb47-48ae-4dc5-81b4-1849f0bde594-1"><i class="fas fa-seedling"></i>å¼•å…¥ä¾èµ–</button></li><li class="tab"><button type="button" data-href="#550dcb47-48ae-4dc5-81b4-1849f0bde594-2"><i class="fas fa-leaf"></i>é…ç½®Redissonå®¢æˆ·ç«¯</button></li><li class="tab"><button type="button" data-href="#550dcb47-48ae-4dc5-81b4-1849f0bde594-3"><i class="fas fa-cookie-bite"></i>ä½¿ç”¨1</button></li><li class="tab"><button type="button" data-href="#550dcb47-48ae-4dc5-81b4-1849f0bde594-4"><i class="fab fa-apple"></i>ä½¿ç”¨2</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="550dcb47-48ae-4dc5-81b4-1849f0bde594-1"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.13.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="550dcb47-48ae-4dc5-81b4-1849f0bde594-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// é…ç½®</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://8.130.68.59:6379&quot;</span>)</span><br><span class="line">            .setPassword(<span class="string">&quot;root123&quot;</span>);</span><br><span class="line">        <span class="comment">// åˆ›å»ºRedissonClientå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="550dcb47-48ae-4dc5-81b4-1849f0bde594-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissionClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testRedisson</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="comment">//è·å–é”(å¯é‡å…¥)ï¼ŒæŒ‡å®šé”çš„åç§°</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;anyLock&quot;</span>);</span><br><span class="line">    <span class="comment">//å°è¯•è·å–é”ï¼Œå‚æ•°åˆ†åˆ«æ˜¯ï¼šè·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´(æœŸé—´ä¼šé‡è¯•)ï¼Œé”è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ï¼Œæ—¶é—´å•ä½</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">1</span>,<span class="number">10</span>,TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­è·å–é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span>(isLock)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ‰§è¡Œä¸šåŠ¡&quot;</span>);          </span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="550dcb47-48ae-4dc5-81b4-1849f0bde594-4"><p>åœ¨ VoucherOrderServiceImplæ³¨å…¥RedissonClient</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">        <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">        <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//åˆ›å»ºé”å¯¹è±¡ è¿™ä¸ªä»£ç ä¸ç”¨äº†ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨è¦ä½¿ç”¨åˆ†å¸ƒå¼é”</span></span><br><span class="line">        <span class="comment">//SimpleRedisLock lock = new SimpleRedisLock(&quot;order:&quot; + userId, stringRedisTemplate);</span></span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">        <span class="comment">//è·å–é”å¯¹è±¡</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock();</span><br><span class="line">       </span><br><span class="line"><span class="comment">//åŠ é”å¤±è´¥</span></span><br><span class="line">        <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//è·å–ä»£ç†å¯¹è±¡(äº‹åŠ¡)</span></span><br><span class="line">            <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">            <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="redissonåˆ†å¸ƒå¼é”åŸç†">redissonåˆ†å¸ƒå¼é”åŸç†</h3><h4 id="å¯é‡å…¥åŸç†">å¯é‡å…¥åŸç†</h4><mark class="hl-label blue">åˆ©ç”¨hashç»“æ„è®°å½•çº¿ç¨‹idå’Œé‡å…¥æ¬¡æ•°</mark> <div class="tabs" id="adddc3e0-e4f7-4203-ab4c-c166ae4a5387"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#adddc3e0-e4f7-4203-ab4c-c166ae4a5387-1"><i class="fas fa-seedling"></i>è·å–é”çš„luaè„šæœ¬</button></li><li class="tab"><button type="button" data-href="#adddc3e0-e4f7-4203-ab4c-c166ae4a5387-2"><i class="fas fa-leaf"></i>è·å–é”æµç¨‹å›¾</button></li><li class="tab"><button type="button" data-href="#adddc3e0-e4f7-4203-ab4c-c166ae4a5387-3"><i class="fab fa-apple"></i>é‡Šæ”¾é”çš„luaè„šæœ¬</button></li><li class="tab"><button type="button" data-href="#adddc3e0-e4f7-4203-ab4c-c166ae4a5387-4"><i class="fas fa-tree"></i>é‡Šæ”¾é”æµç¨‹å›¾</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="adddc3e0-e4f7-4203-ab4c-c166ae4a5387-1"><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>]; <span class="comment">-- é”çš„key</span></span><br><span class="line"><span class="keyword">local</span> threadId = ARGV[<span class="number">1</span>]; <span class="comment">-- çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†</span></span><br><span class="line"><span class="keyword">local</span> releaseTime = ARGV[<span class="number">2</span>]; <span class="comment">-- é”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é—´</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- è‹¥é”ä¸å­˜åœ¨ï¼šåˆ™è·å–é”</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;exists&#x27;</span>, key) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">     redis.call(<span class="string">&#x27;hset&#x27;</span>, key, releaseTime, <span class="number">1</span>);</span><br><span class="line">     <span class="comment">-- è®¾ç½®é”æœ‰æ•ˆæœŸ</span></span><br><span class="line">     redis.call(<span class="string">&#x27;pexpire&#x27;</span>, key, threadId);</span><br><span class="line">     <span class="keyword">return</span> <span class="literal">nil</span>; <span class="comment">-- è¿”å›ç»“æœ</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="comment">-- é”å·²ç»å­˜åœ¨ï¼Œåˆ¤æ–­threadIdæ˜¯å¦æ˜¯è‡ªå·±</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;hexists&#x27;</span>, key, releaseTime) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">     <span class="comment">-- é”é‡å…¥æ¬¡æ•°+1</span></span><br><span class="line">     redis.call(<span class="string">&#x27;hincrby&#x27;</span>, key, releaseTime, <span class="number">1</span>);</span><br><span class="line">     <span class="comment">-- é‡æ–°è®¾ç½®æœ‰æ•ˆæœŸ</span></span><br><span class="line">     redis.call(<span class="string">&#x27;pexpire&#x27;</span>, key, threadId);</span><br><span class="line">     <span class="keyword">return</span> <span class="literal">nil</span>; <span class="comment">-- è¿”å›ç»“æœ</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="comment">--é”æ˜¯è¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼Œç›´æ¥è¿”å›é”å‰©ä½™è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="keyword">return</span> redis.call(<span class="string">&#x27;pttl&#x27;</span>, key);</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="adddc3e0-e4f7-4203-ab4c-c166ae4a5387-2"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230609170228655.png" alt="image-20230609170228655" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="adddc3e0-e4f7-4203-ab4c-c166ae4a5387-3"><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>]; <span class="comment">-- é”çš„key</span></span><br><span class="line"><span class="keyword">local</span> channel = KEYS[<span class="number">2</span>]; <span class="comment">-- è§£é”æ¶ˆæ¯PubSubé¢‘é“</span></span><br><span class="line"><span class="keyword">local</span> message = ARGV[<span class="number">1</span>]; <span class="comment">-- è§£é”æ¶ˆæ¯</span></span><br><span class="line"><span class="keyword">local</span> releaseTime = ARGV[<span class="number">2</span>]; <span class="comment">-- é”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é—´</span></span><br><span class="line"><span class="keyword">local</span> threadId = ARGV[<span class="number">3</span>]; <span class="comment">-- çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†</span></span><br><span class="line"><span class="comment">-- è‹¥é”ä¸å­˜åœ¨ï¼šåˆ™ç›´æ¥å¹¿æ’­è§£é”æ¶ˆæ¯ï¼Œå¹¶è¿”å›1</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;exists&#x27;</span>, key) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    redis.call(<span class="string">&#x27;publish&#x27;</span>, channel, message);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="comment">-- è‹¥é”å­˜åœ¨ï¼Œä½†å”¯ä¸€æ ‡è¯†ä¸åŒ¹é…</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;hexists&#x27;</span>, key, threadId) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>; <span class="comment">--ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="comment">-- æ˜¯è‡ªå·±çš„é”ï¼Œåˆ™é‡å…¥æ¬¡æ•°-1</span></span><br><span class="line"><span class="keyword">local</span> counter = redis.call(<span class="string">&#x27;hincrby&#x27;</span>, key, threadId, <span class="number">-1</span>);</span><br><span class="line"><span class="comment">-- åˆ¤æ–­é‡å…¥æ¬¡æ•°æ˜¯å¦å·²ç»ç­‰äº0</span></span><br><span class="line"><span class="keyword">if</span> (counter &gt; <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- å¤§äº0ï¼Œè¯´æ˜ä¸èƒ½é‡Šæ”¾é”ï¼Œé‡ç½®æœ‰æ•ˆæœŸç„¶åè¿”å›</span></span><br><span class="line">    redis.call(<span class="string">&#x27;pexpire&#x27;</span>, key, releaseTime);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="comment">--ç­‰äº0è¯´æ˜å¯ä»¥é‡Šæ”¾é”</span></span><br><span class="line">    <span class="comment">-- åˆ é™¤é”</span></span><br><span class="line">    redis.call(<span class="string">&#x27;del&#x27;</span>, key);</span><br><span class="line">    <span class="comment">-- å‘å¸ƒé”é‡Šæ”¾ä¿¡å·ï¼Œå¹¿æ’­è§£é”æ¶ˆæ¯ï¼Œå”¤é†’ç«äº‰è€…</span></span><br><span class="line">    redis.call(<span class="string">&#x27;publish&#x27;</span>, channel, message);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="adddc3e0-e4f7-4203-ab4c-c166ae4a5387-4"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230609170245983.png" alt="image-20230609170245983" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h4 id="é‡è¯•æœºåˆ¶å’Œçœ‹é—¨ç‹—æœºåˆ¶">é‡è¯•æœºåˆ¶å’Œçœ‹é—¨ç‹—æœºåˆ¶</h4><mark class="hl-label blue">å¯é‡è¯•ï¼šåˆ©ç”¨ä¿¡å·é‡å’ŒPubSubåŠŸèƒ½å®ç°ç­‰å¾…ã€å”¤é†’ï¼Œè·å–é”å¤±è´¥çš„é‡è¯•æœºåˆ¶</mark> <br/><mark class="hl-label green">è¶…æ—¶ç»­çº¦ï¼šåˆ©ç”¨watchDogï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆreleaseTime/3ï¼‰ï¼Œé‡ç½®è¶…æ—¶æ—¶é—´</mark> <img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230610113051979.png" alt="image-20230610113051979" style="zoom:67%;" /><div class="tabs" id="89bedab8-920c-414a-8e85-5ebf98ba1f65"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#89bedab8-920c-414a-8e85-5ebf98ba1f65-1"><i class="fas fa-bug"></i>å‚æ•°</button></li><li class="tab"><button type="button" data-href="#89bedab8-920c-414a-8e85-5ebf98ba1f65-2"><i class="fas fa-cannabis"></i>tryLock</button></li><li class="tab"><button type="button" data-href="#89bedab8-920c-414a-8e85-5ebf98ba1f65-3"><i class="fas fa-candy-cane"></i>ç¬¬ä¸€æ¬¡å°è¯•è·å–é”</button></li><li class="tab"><button type="button" data-href="#89bedab8-920c-414a-8e85-5ebf98ba1f65-4"><i class="fas fa-child"></i>è®¢é˜…é”é‡Šæ”¾ä¿¡å·</button></li><li class="tab"><button type="button" data-href="#89bedab8-920c-414a-8e85-5ebf98ba1f65-5"><i class="fas fa-cookie-bite"></i>å¾ªç¯å†æ¬¡å°è¯•</button></li><li class="tab"><button type="button" data-href="#89bedab8-920c-414a-8e85-5ebf98ba1f65-6"><i class="fas fa-heartbeat"></i>é‡Šæ”¾é”</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="89bedab8-920c-414a-8e85-5ebf98ba1f65-1"><p><code>tryLock</code>æ–¹æ³•æœ‰ä¸‰ä¸ªé‡è½½å½¢å¼ã€‚</p><p><code>tryLock()</code> waiteTimeé»˜è®¤ä¸º-1ï¼ŒleaseTimeé»˜è®¤ä¸º30s</p><p><code>tryLock(long waitTime, TimeUnit unit)</code> leaseTimeé»˜è®¤ä¸º30s</p><p><code>tryLock(long waitTime, long leaseTime, TimeUnit unit)</code></p><p>waitTimeï¼šè·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é•¿ï¼Œåœ¨ç¬¬ä¸€æ¬¡è·å–é”å¤±è´¥æ—¶å°±ä¸ä¼šç«‹å³è¿”å›ï¼Œè€Œæ˜¯åœ¨ç­‰å¾…æ—¶é—´å†…ä¸æ–­å»å°è¯•ã€‚</p><p>leaseTimeï¼šè‡ªåŠ¨å¤±æ•ˆé‡Šæ”¾æ—¶é—´</p><p>æˆ‘ä»¬åœ¨è¿™é‡Œè¦ç ”ç©¶é”é‡è¯•æœºåˆ¶ï¼Œæ‰€ä»¥waitTimeå¿…é¡»å¾—ä¼ ï¼ŒleaseTimeä¸ä¼ ä¹Ÿä¼šç»™é»˜è®¤å‚æ•°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RLock</span> <span class="variable">redisLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;order:&quot;</span> + <span class="number">1010</span>);</span><br><span class="line"><span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> redisLock.tryLock(<span class="number">1L</span>,TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line"><span class="comment">//RedissonLock#tryLock</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> waitTime, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">   <span class="keyword">return</span> tryLock(waitTime, -<span class="number">1</span>, unit);<span class="comment">//-&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="89bedab8-920c-414a-8e85-5ebf98ba1f65-2"><p>æ³¨æ„ä¸‹é¢çš„æ‰€æœ‰æ–¹æ³•éƒ½åœ¨æˆ‘ä»¬è·å–çš„é”ä¸­ã€‚</p><p><code>RLock redisLock = redissonClient.getLock(&quot;order:&quot; + 1010);</code></p><p>å°†tryLockå†…éƒ¨ä»£ç è¿›è¡Œç»†åˆ†å¯åˆ†ä¸ºä¸‹é¢è¿™äº›æ­¥éª¤</p><p>1ã€ <code>tryAcquire</code>å°è¯•ç¬¬ä¸€æ¬¡è·å–é”ï¼Œè¿”å›<code>ttl</code>ã€‚<code>ttl</code>ä¸º<code>null</code>åˆ™è·å–é”æˆåŠŸè¿”å›<code>true</code>ï¼›å¦åˆ™çœ‹è·å–é”æ˜¯å¦è¶…æ—¶ï¼Œè¶…æ—¶åˆ™è·å–é”å¤±è´¥è¿”å›<code>false</code>ï¼Œæœªè¶…æ—¶ç»§ç»­</p><p>3ã€ <code>subscribe</code>è®¢é˜…é”é‡Šæ”¾ä¿¡å·</p><p>4ã€å¾ªç¯<code>tryAcquire</code>å°è¯•è·å–é”ï¼Œ<code>semaphore</code>é˜»å¡ç­‰å¾…é”é‡Šæ”¾ä¿¡å·ã€‚é”è¶…æ—¶æ—¶é—´ &lt; ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼Œåˆ™é˜»å¡æ—¶é—´ä¸ºé”è¶…æ—¶æ—¶é—´ ï¼›å¦åˆ™ä¸ºç­‰å¾…è¶…æ—¶æ—¶é—´ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="89bedab8-920c-414a-8e85-5ebf98ba1f65-3"><div class="tabs" id="b73af6f0-6d79-4089-9b56-1f41afd1c947"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#b73af6f0-6d79-4089-9b56-1f41afd1c947-1"><i class="fas fa-award"></i>tryLock</button></li><li class="tab"><button type="button" data-href="#b73af6f0-6d79-4089-9b56-1f41afd1c947-2"><i class="fas fa-baseball-ball"></i>tryAcquire</button></li><li class="tab"><button type="button" data-href="#b73af6f0-6d79-4089-9b56-1f41afd1c947-3"><i class="fas fa-bone"></i>tryLockInnerAsyncæ‰§è¡ŒåŠ é”luaè„šæœ¬</button></li><li class="tab"><button type="button" data-href="#b73af6f0-6d79-4089-9b56-1f41afd1c947-4"><i class="fas fa-anchor"></i>scheduleExpirationRenewalé”ç»­çº¦</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="b73af6f0-6d79-4089-9b56-1f41afd1c947-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è½¬æ¢æˆæ¯«ç§’</span></span><br><span class="line"><span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> unit.toMillis(waitTime);</span><br><span class="line"><span class="type">long</span> <span class="variable">current</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"><span class="comment">//è·å–çº¿ç¨‹æ ‡è¯†</span></span><br><span class="line"><span class="type">long</span> <span class="variable">threadId</span> <span class="operator">=</span> Thread.currentThread().getId();</span><br><span class="line"><span class="comment">// å°è¯•è·å–é”ï¼Œè‹¥è¿”å›å€¼ä¸ºnullï¼Œåˆ™è¡¨ç¤ºå·²è·å–åˆ°é” -&gt;</span></span><br><span class="line"><span class="type">Long</span> <span class="variable">ttl</span> <span class="operator">=</span> tryAcquire(waitTime, leaseTime, unit, threadId);</span><br><span class="line"><span class="comment">// lock acquired</span></span><br><span class="line"><span class="keyword">if</span> (ttl == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æœ€å¤§ç­‰å¾…æ—¶é—´-è·å–é”æ¶ˆè€—çš„æ—¶é—´</span></span><br><span class="line">time -= System.currentTimeMillis() - current;</span><br><span class="line"><span class="comment">// å‰©ä½™ç­‰å¾…æ—¶é—´å°äº0 è¿”å›</span></span><br><span class="line"><span class="keyword">if</span> (time &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    acquireFailed(waitTime, unit, threadId);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç»§ç»­å°è¯• -&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b73af6f0-6d79-4089-9b56-1f41afd1c947-2"><p>leaseTime å¿…é¡»æ˜¯ -1 æ‰ä¼šå¼€å¯ Watch Dog æœºåˆ¶ï¼Œå¦‚æœéœ€è¦å¼€å¯ Watch Dog æœºåˆ¶å°±å¿…é¡»ä½¿ç”¨é»˜è®¤çš„åŠ é”æ—¶é—´ä¸º 30sã€‚</p><p>å¦‚æœä½ è‡ªå·±è‡ªå®šä¹‰æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œé”å°±ä¼šè‡ªå®šé‡Šæ”¾ï¼Œå¹¶ä¸ä¼šè‡ªåŠ¨ç»­æœŸã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Long <span class="title function_">tryAcquire</span><span class="params">(<span class="type">long</span> waitTime, <span class="type">long</span> leaseTime, TimeUnit unit, <span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> get(tryAcquireAsync(waitTime, leaseTime, unit, threadId));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; RFuture&lt;Long&gt; <span class="title function_">tryAcquireAsync</span><span class="params">(<span class="type">long</span> waitTime, <span class="type">long</span> leaseTime, TimeUnit unit, <span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœä¼ äº†leaseTimeåˆ™æŒ‰ä¼ å…¥çš„</span></span><br><span class="line">    <span class="keyword">if</span> (leaseTime != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> tryLockInnerAsync(waitTime, leaseTime, unit, threadId, RedisCommands.EVAL_LONG);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰ä¼ leaseTimeï¼Œåˆ™è·å–é…ç½®ä¸­çš„ï¼Œé»˜è®¤ä¸º30s -&gt;</span></span><br><span class="line">    RFuture&lt;Long&gt; ttlRemainingFuture = tryLockInnerAsync(waitTime,</span><br><span class="line">            commandExecutor.getConnectionManager().getCfg().getLockWatchdogTimeout(),</span><br><span class="line">            TimeUnit.MILLISECONDS, threadId, RedisCommands.EVAL_LONG);</span><br><span class="line">    <span class="comment">// Futureå®Œæˆä¹‹åè¿›å…¥è¿™ä¸ªå‡½æ•° </span></span><br><span class="line">    ttlRemainingFuture.onComplete((ttlRemaining, e) -&gt; &#123;</span><br><span class="line">        <span class="comment">// å¼‚å¸¸ä¸ä¸ºNull è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// lock acquired</span></span><br><span class="line">        <span class="keyword">if</span> (ttlRemaining == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¼€å¯çœ‹é—¨ç‹—</span></span><br><span class="line">            scheduleExpirationRenewal(threadId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> ttlRemainingFuture;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b73af6f0-6d79-4089-9b56-1f41afd1c947-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;T&gt; RFuture&lt;T&gt; <span class="title function_">tryLockInnerAsync</span><span class="params">(<span class="type">long</span> waitTime, <span class="type">long</span> leaseTime, TimeUnit unit, <span class="type">long</span> threadId, RedisStrictCommand&lt;T&gt; command)</span> &#123;</span><br><span class="line">        <span class="comment">// å°†leaseTimeè®°å½•åˆ°æˆå‘˜å˜é‡ ä¸‹é¢ç»­çº¦ä¼šç”¨åˆ°</span></span><br><span class="line">        internalLockLeaseTime = unit.toMillis(leaseTime);</span><br><span class="line">        <span class="comment">// æ³¨æ„è·å–é”æˆåŠŸè¿”å›nil å¤±è´¥è¿”å›é”çš„å‰©ä½™æœ‰æ•ˆæœŸ</span></span><br><span class="line">        <span class="keyword">return</span> evalWriteAsync(getName(), LongCodec.INSTANCE, command,</span><br><span class="line">                <span class="string">&quot;if (redis.call(&#x27;exists&#x27;, KEYS[1]) == 0) then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[2], 1); &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return nil; &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[2]) == 1) then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[2], 1); &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return nil; &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return redis.call(&#x27;pttl&#x27;, KEYS[1]);&quot;</span>,</span><br><span class="line">                Collections.singletonList(getName()), internalLockLeaseTime, getLockName(threadId));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b73af6f0-6d79-4089-9b56-1f41afd1c947-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">scheduleExpirationRenewal</span><span class="params">(<span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">    <span class="type">ExpirationEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExpirationEntry</span>();</span><br><span class="line">    <span class="comment">// getEntryName() è¿”å› è¿æ¥å+:+é”å </span></span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ¬¡æ”¾ é‡Œé¢è‚¯å®šæ²¡æœ‰ è¿”å›Null ä¿è¯åŒä¸€ä¸ªé”ä¸ç®¡é‡å…¥å¤šå°‘æ¬¡è·å¾—çš„éƒ½æ˜¯åŒä¸€ä¸ªEntry</span></span><br><span class="line">    <span class="type">ExpirationEntry</span> <span class="variable">oldEntry</span> <span class="operator">=</span> EXPIRATION_RENEWAL_MAP.putIfAbsent(getEntryName(), entry);</span><br><span class="line">    <span class="keyword">if</span> (oldEntry != <span class="literal">null</span>) &#123;</span><br><span class="line">        oldEntry.addThreadId(threadId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        entry.addThreadId(threadId);</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€æ¬¡æ¥ åšä¸€ä¸ªç»­çº¦çš„åŠ¨ä½œ</span></span><br><span class="line">        renewExpiration();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">renewExpiration</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ä»mapé‡Œè·å¾—Entry</span></span><br><span class="line">    <span class="type">ExpirationEntry</span> <span class="variable">ee</span> <span class="operator">=</span> EXPIRATION_RENEWAL_MAP.get(getEntryName());</span><br><span class="line">    <span class="keyword">if</span> (ee == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Timeoutæ˜¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ æ¯è¿‡internalLockLeaseTime/3 æ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">    <span class="type">Timeout</span> <span class="variable">task</span> <span class="operator">=</span> commandExecutor.getConnectionManager().newTimeout(<span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(Timeout timeout)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="comment">// ä»mapé‡Œè·å¾—Entry</span></span><br><span class="line">            <span class="type">ExpirationEntry</span> <span class="variable">ent</span> <span class="operator">=</span> EXPIRATION_RENEWAL_MAP.get(getEntryName());</span><br><span class="line">            <span class="keyword">if</span> (ent == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">threadId</span> <span class="operator">=</span> ent.getFirstThreadId();</span><br><span class="line">            <span class="keyword">if</span> (threadId == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åˆ·æ–°æœ‰æ•ˆæœŸ</span></span><br><span class="line">            RFuture&lt;Boolean&gt; future = renewExpirationAsync(threadId);</span><br><span class="line">            <span class="comment">// ä¸Šé¢çš„futureæ‰§è¡Œç»“æŸå</span></span><br><span class="line">            future.onComplete((res, e) -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;Can&#x27;t update lock &quot;</span> + getName() + <span class="string">&quot; expiration&quot;</span>, e);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (res) &#123;</span><br><span class="line">                    <span class="comment">// é€’å½’è°ƒç”¨è‡ªå·±</span></span><br><span class="line">                    renewExpiration();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, internalLockLeaseTime / <span class="number">3</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    <span class="comment">// å°†ä»»åŠ¡æ”¾åˆ°entryä¸­</span></span><br><span class="line">    ee.setTimeout(task);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//é‡ç½®é”æœ‰æ•ˆæœŸ</span></span><br><span class="line"><span class="keyword">protected</span> RFuture&lt;Boolean&gt; <span class="title function_">renewExpirationAsync</span><span class="params">(<span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> evalWriteAsync(getName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN,</span><br><span class="line">            <span class="string">&quot;if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[2]) == 1) then &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return 1; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return 0;&quot;</span>,</span><br><span class="line">            Collections.singletonList(getName()),</span><br><span class="line">            internalLockLeaseTime, getLockName(threadId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="89bedab8-920c-414a-8e85-5ebf98ba1f65-4"><p>ä¸ä¼šç«‹å³å»å°è¯•ï¼Œåˆšåˆšè·å–é”å¤±è´¥ï¼Œç«‹å³å»é‡è¯•ï¼Œå¤§æ¦‚ç‡ä¹Ÿæ˜¯å¤±è´¥çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">current = System.currentTimeMillis();</span><br><span class="line"><span class="comment">// é˜…è§£é”æ¶ˆæ¯ï¼Œè§org.redisson.pubsub.LockPubSub#onMessage</span></span><br><span class="line">RFuture&lt;RedissonLockEntry&gt; subscribeFuture = subscribe(threadId);</span><br><span class="line"><span class="comment">// å½“this.awaitè¿”å›falseï¼Œè¯´æ˜ç­‰å¾…æ—¶é—´å·²ç»è¶…å‡ºè·å–é”æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œ</span></span><br><span class="line"><span class="keyword">if</span> (!subscribeFuture.await(time, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!subscribeFuture.cancel(<span class="literal">false</span>)) &#123;</span><br><span class="line">        subscribeFuture.onComplete((res, e) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (e == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// å–æ¶ˆè®¢é˜…å¹¶è¿”å›è·å–é”å¤±è´¥</span></span><br><span class="line">                unsubscribe(subscribeFuture, threadId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    acquireFailed(waitTime, unit, threadId);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// this.awaitè¿”å›trueï¼Œåœ¨timeä»¥å†…ç­‰åˆ°äº†é‡Šæ”¾é”çš„é€šçŸ¥,è¿›å…¥å¾ªç¯å°è¯•è·å–é”</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="89bedab8-920c-414a-8e85-5ebf98ba1f65-5"><p>å½“é”æ­£åœ¨è¢«å ç”¨æ—¶ï¼Œç­‰å¾…è·å–é”çš„è¿›ç¨‹å¹¶ä¸æ˜¯é€šè¿‡ä¸€ä¸ª while(true) æ­»å¾ªç¯å»è·å–é”ï¼Œè€Œæ˜¯åˆ©ç”¨äº† Redis çš„å‘å¸ƒè®¢é˜…æœºåˆ¶,é€šè¿‡ await æ–¹æ³•é˜»å¡ç­‰å¾…é”çš„è¿›ç¨‹ï¼Œæœ‰æ•ˆçš„è§£å†³äº†æ— æ•ˆçš„é”ç”³è¯·æµªè´¹èµ„æºçš„é—®é¢˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// å†æ¬¡è®¡ç®—å‰©ä½™ç­‰å¾…æ—¶é—´</span></span><br><span class="line">    time -= System.currentTimeMillis() - current;</span><br><span class="line">    <span class="keyword">if</span> (time &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        acquireFailed(waitTime, unit, threadId);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// å†æ¬¡é‡è¯•è·å–é” é€»è¾‘ä¸ç¬¬ä¸€æ¬¡ç›¸åŒ</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        ttl = tryAcquire(waitTime, leaseTime, unit, threadId);</span><br><span class="line">        <span class="comment">// lock acquired</span></span><br><span class="line">        <span class="keyword">if</span> (ttl == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        time -= System.currentTimeMillis() - currentTime;</span><br><span class="line">        <span class="keyword">if</span> (time &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            acquireFailed(waitTime, unit, threadId);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// waiting for message</span></span><br><span class="line">        currentTime = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//æ ¹æ®é”TTLï¼Œè°ƒæ•´é˜»å¡ç­‰å¾…æ—¶é•¿ï¼›</span></span><br><span class="line">        <span class="keyword">if</span> (ttl &gt;= <span class="number">0</span> &amp;&amp; ttl &lt; time) &#123;</span><br><span class="line">            <span class="comment">// åˆ©ç”¨åˆšåˆšè®¢é˜…ç”Ÿæˆçš„futureç”Ÿæˆä¿¡å·é‡ä¿¡å·é‡Semaphore</span></span><br><span class="line">            <span class="comment">//è°ƒç”¨å…¶tryAcquireæ–¹æ³•ä¼šè®©å½“å‰çº¿ç¨‹é˜»å¡ä¸€æ®µæ—¶é—´ï¼Œé¿å…äº†åœ¨whileå¾ªç¯ä¸­é¢‘ç¹è¯·æ±‚è·å–é”ï¼›</span></span><br><span class="line">            <span class="comment">//è¯¥Semaphoreçš„releaseæ–¹æ³•ï¼Œä¼šåœ¨è®¢é˜…è§£é”æ¶ˆæ¯çš„ç›‘å¬å™¨æ¶ˆæ¯å¤„ç†æ–¹æ³•org.redisson.pubsub.LockPubSub#onMessageè°ƒç”¨ï¼›</span></span><br><span class="line">            <span class="comment">//å½“å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†å ç”¨çš„é”ï¼Œä¼šå¹¿æ’­è§£é”æ¶ˆæ¯ï¼Œç›‘å¬å™¨æ¥æ”¶è§£é”æ¶ˆæ¯ï¼Œå¹¶é‡Šæ”¾ä¿¡å·é‡ï¼Œæœ€ç»ˆä¼šå”¤é†’é˜»å¡åœ¨è¿™é‡Œçš„çº¿ç¨‹ã€‚</span></span><br><span class="line">            subscribeFuture.getNow().getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            subscribeFuture.getNow().getLatch().tryAcquire(time, TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        time -= System.currentTimeMillis() - currentTime;</span><br><span class="line">        <span class="keyword">if</span> (time &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            acquireFailed(waitTime, unit, threadId);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">//å–æ¶ˆè§£é”æ¶ˆæ¯çš„è®¢é˜…</span></span><br><span class="line">    unsubscribe(subscribeFuture, threadId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="89bedab8-920c-414a-8e85-5ebf98ba1f65-6"><div class="tabs" id="97f2d8d9-dd2f-4030-9c26-0b35173589cd"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#97f2d8d9-dd2f-4030-9c26-0b35173589cd-1"><i class="fas fa-seedling"></i>unlockAsync</button></li><li class="tab"><button type="button" data-href="#97f2d8d9-dd2f-4030-9c26-0b35173589cd-2"><i class="fas fa-leaf"></i>unlockInnerAsyncæ‰§è¡Œé‡Šæ”¾é”luaè„šæœ¬</button></li><li class="tab"><button type="button" data-href="#97f2d8d9-dd2f-4030-9c26-0b35173589cd-3"><i class="fab fa-apple"></i>å–æ¶ˆçœ‹é—¨ç‹—</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="97f2d8d9-dd2f-4030-9c26-0b35173589cd-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RFuture&lt;Void&gt; <span class="title function_">unlockAsync</span><span class="params">(<span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">    RPromise&lt;Void&gt; result = <span class="keyword">new</span> <span class="title class_">RedissonPromise</span>&lt;Void&gt;();</span><br><span class="line">    <span class="comment">// æ‰§è¡Œé‡Šæ”¾é”luaè„šæœ¬</span></span><br><span class="line">    RFuture&lt;Boolean&gt; future = unlockInnerAsync(threadId);</span><br><span class="line">    <span class="comment">// ç­‰å¾…ä¸Šé¢çš„futureå®Œæˆå</span></span><br><span class="line">    future.onComplete((opStatus, e) -&gt; &#123;</span><br><span class="line">        <span class="comment">// å–æ¶ˆæ›´æ–°ä»»åŠ¡</span></span><br><span class="line">        cancelExpirationRenewal(threadId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            result.tryFailure(e);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (opStatus == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">IllegalMonitorStateException</span> <span class="variable">cause</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>(<span class="string">&quot;attempt to unlock lock, not locked by current thread by node id: &quot;</span></span><br><span class="line">                    + id + <span class="string">&quot; thread-id: &quot;</span> + threadId);</span><br><span class="line">            result.tryFailure(cause);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        result.trySuccess(<span class="literal">null</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="97f2d8d9-dd2f-4030-9c26-0b35173589cd-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> RFuture&lt;Boolean&gt; <span class="title function_">unlockInnerAsync</span><span class="params">(<span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> evalWriteAsync(getName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN,</span><br><span class="line">            <span class="string">&quot;if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[3]) == 0) then &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return nil;&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;local counter = redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[3], -1); &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;if (counter &gt; 0) then &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[2]); &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return 0; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;redis.call(&#x27;del&#x27;, KEYS[1]); &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;redis.call(&#x27;publish&#x27;, KEYS[2], ARGV[1]); &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return 1; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return nil;&quot;</span>,</span><br><span class="line">            Arrays.asList(getName(), getChannelName()), LockPubSub.UNLOCK_MESSAGE, internalLockLeaseTime, getLockName(threadId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="97f2d8d9-dd2f-4030-9c26-0b35173589cd-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">cancelExpirationRenewal</span><span class="params">(Long threadId)</span> &#123;</span><br><span class="line">    <span class="comment">// ä»mapé‡Œå–</span></span><br><span class="line">    <span class="type">ExpirationEntry</span> <span class="variable">task</span> <span class="operator">=</span> EXPIRATION_RENEWAL_MAP.get(getEntryName());</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç§»é™¤id</span></span><br><span class="line">    <span class="keyword">if</span> (threadId != <span class="literal">null</span>) &#123;</span><br><span class="line">        task.removeThreadId(threadId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å–æ¶ˆå®šæ—¶ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">if</span> (threadId == <span class="literal">null</span> || task.hasNoThreads()) &#123;</span><br><span class="line">        <span class="type">Timeout</span> <span class="variable">timeout</span> <span class="operator">=</span> task.getTimeout();</span><br><span class="line">        <span class="keyword">if</span> (timeout != <span class="literal">null</span>) &#123;</span><br><span class="line">            timeout.cancel();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// entryç§»é™¤</span></span><br><span class="line">        EXPIRATION_RENEWAL_MAP.remove(getEntryName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>ç»“åˆLuaè„šæœ¬å’Œæºç ï¼Œæ¨¡æ‹Ÿä¸‹å¤šä¸ªçº¿ç¨‹äº‰æŠ¢é”ä¼šæ˜¯æ€æ ·çš„æµç¨‹ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼Œæ¯”è¾ƒå…³é”®çš„ä¸‰å¤„å·²ç”¨çº¢è‰²å­—ä½“æ ‡æ³¨ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230609231717380.png" alt="image-20230609231717380" style="zoom:67%;" /><hr><h4 id="MutiLockåŸç†">MutiLockåŸç†</h4><div class="tabs" id="d29f6808-63d3-4753-9c5a-1049488b38c8"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d29f6808-63d3-4753-9c5a-1049488b38c8-1"><i class="fas fa-seedling"></i>ä¸»èŠ‚ç‚¹å®•æœº</button></li><li class="tab"><button type="button" data-href="#d29f6808-63d3-4753-9c5a-1049488b38c8-2"><i class="fas fa-leaf"></i>MutiLocké”</button></li><li class="tab"><button type="button" data-href="#d29f6808-63d3-4753-9c5a-1049488b38c8-3"><i class="fab fa-apple"></i>MutiLockåŠ é”åŸç†</button></li><li class="tab"><button type="button" data-href="#d29f6808-63d3-4753-9c5a-1049488b38c8-4"><i class="fas fa-tree"></i>MutiLockä½¿ç”¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d29f6808-63d3-4753-9c5a-1049488b38c8-1"><p>ä¸ºäº†æé«˜redisçš„å¯ç”¨æ€§ï¼Œæˆ‘ä»¬ä¼šæ­å»ºé›†ç¾¤æˆ–è€…ä¸»ä»ï¼Œç°åœ¨ä»¥ä¸»ä»ä¸ºä¾‹</p><p>æ­¤æ—¶æˆ‘ä»¬å»å†™å‘½ä»¤ï¼Œå†™åœ¨ä¸»æœºä¸Šï¼Œ ä¸»æœºä¼šå°†æ•°æ®åŒæ­¥ç»™ä»æœºï¼Œä½†æ˜¯å‡è®¾åœ¨ä¸»æœºè¿˜æ²¡æœ‰æ¥å¾—åŠæŠŠæ•°æ®å†™å…¥åˆ°ä»æœºå»çš„æ—¶å€™ï¼Œæ­¤æ—¶ä¸»æœºå®•æœºï¼Œå“¨å…µä¼šå‘ç°ä¸»æœºå®•æœºï¼Œå¹¶ä¸”é€‰ä¸¾ä¸€ä¸ªslaveå˜æˆmasterï¼Œè€Œæ­¤æ—¶æ–°çš„masterä¸­å®é™…ä¸Šå¹¶æ²¡æœ‰é”ä¿¡æ¯ï¼Œæ­¤æ—¶é”ä¿¡æ¯å°±å·²ç»ä¸¢æ‰äº†ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653553998403.png" alt="1653553998403" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d29f6808-63d3-4753-9c5a-1049488b38c8-2"><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œredissionæå‡ºæ¥äº†MutiLocké”ï¼Œä½¿ç”¨è¿™æŠŠé”å’±ä»¬å°±ä¸ä½¿ç”¨ä¸»ä»äº†ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„åœ°ä½éƒ½æ˜¯ä¸€æ ·çš„ï¼Œ è¿™æŠŠé”åŠ é”çš„é€»è¾‘éœ€è¦å†™å…¥åˆ°æ¯ä¸€ä¸ªä¸»ä¸›èŠ‚ç‚¹ä¸Šï¼Œåªæœ‰æ‰€æœ‰çš„æœåŠ¡å™¨éƒ½å†™å…¥æˆåŠŸï¼Œæ­¤æ—¶æ‰æ˜¯åŠ é”æˆåŠŸï¼Œå‡è®¾ç°åœ¨æŸä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œé‚£ä¹ˆä»–å»è·å¾—é”çš„æ—¶å€™ï¼Œåªè¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ‹¿ä¸åˆ°ï¼Œéƒ½ä¸èƒ½ç®—æ˜¯åŠ é”æˆåŠŸï¼Œå°±ä¿è¯äº†åŠ é”çš„å¯é æ€§ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653554055048.png" alt="1653554055048" style="zoom: 50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d29f6808-63d3-4753-9c5a-1049488b38c8-3"><p>é‚£ä¹ˆMutiLock åŠ é”åŸç†æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å½“æˆ‘ä»¬å»è®¾ç½®äº†å¤šä¸ªé”æ—¶ï¼Œredissionä¼šå°†å¤šä¸ªé”æ·»åŠ åˆ°ä¸€ä¸ªé›†åˆä¸­ï¼Œç„¶åç”¨whileå¾ªç¯å»ä¸åœå»å°è¯•æ‹¿é”ï¼Œä½†æ˜¯ä¼šæœ‰ä¸€ä¸ªæ€»å…±çš„åŠ é”æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´æ˜¯ç”¨éœ€è¦åŠ é”çš„ä¸ªæ•° * 1500ms ï¼Œå‡è®¾æœ‰3ä¸ªé”ï¼Œé‚£ä¹ˆæ—¶é—´å°±æ˜¯4500msï¼Œå‡è®¾åœ¨è¿™4500mså†…ï¼Œæ‰€æœ‰çš„é”éƒ½åŠ é”æˆåŠŸï¼Œ é‚£ä¹ˆæ­¤æ—¶æ‰ç®—æ˜¯åŠ é”æˆåŠŸï¼Œå¦‚æœåœ¨4500msæœ‰çº¿ç¨‹åŠ é”å¤±è´¥ï¼Œåˆ™ä¼šå†æ¬¡å»è¿›è¡Œé‡è¯•.</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653553093967.png" alt="1653553093967" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d29f6808-63d3-4753-9c5a-1049488b38c8-4"><div class="tabs" id="d7456afb-9c83-4e3e-bf27-18a45d1cbbe7"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d7456afb-9c83-4e3e-bf27-18a45d1cbbe7-1"><i class="fas fa-cat"></i>é…ç½®å¤šä¸ªredissonClient</button></li><li class="tab"><button type="button" data-href="#d7456afb-9c83-4e3e-bf27-18a45d1cbbe7-2"><i class="fas fa-horse"></i>ä½¿ç”¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d7456afb-9c83-4e3e-bf27-18a45d1cbbe7-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://8.130.68.59:6379&quot;</span>)</span><br><span class="line">                .setPassword(<span class="string">&quot;root123&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://8.130.68.59:6380&quot;</span>)</span><br><span class="line">                .setPassword(<span class="string">&quot;root123&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://8.130.68.59:6381&quot;</span>)</span><br><span class="line">                .setPassword(<span class="string">&quot;root123&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d7456afb-9c83-4e3e-bf27-18a45d1cbbe7-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient2;</span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient3;</span><br><span class="line"><span class="keyword">private</span> RLock lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@BeforeEach</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock1</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock2</span> <span class="operator">=</span> redissonClient2.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock3</span> <span class="operator">=</span> redissonClient3.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">    lock = redissonClient.getMultiLock(lock1, lock2, lock3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">method</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> lock.tryLock();</span><br><span class="line">    redissonClient.getMultiLock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="ç§’æ€ä¼˜åŒ–">ç§’æ€ä¼˜åŒ–</h2><h3 id="å¼‚æ­¥ç§’æ€æ€è·¯">å¼‚æ­¥ç§’æ€æ€è·¯</h3><p>æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹ä¸‹å•æµç¨‹</p><p>å½“ç”¨æˆ·å‘èµ·è¯·æ±‚ï¼Œæ­¤æ—¶ä¼šè¯·æ±‚nginxï¼Œnginxä¼šè®¿é—®åˆ°tomcatï¼Œè€Œtomcatä¸­çš„ç¨‹åºï¼Œä¼šè¿›è¡Œä¸²è¡Œæ“ä½œï¼Œåˆ†æˆå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤</p><p>1ã€æŸ¥è¯¢ä¼˜æƒ å·</p><p>2ã€åˆ¤æ–­ç§’æ€åº“å­˜æ˜¯å¦è¶³å¤Ÿ</p><p>3ã€æŸ¥è¯¢è®¢å•</p><p>4ã€æ ¡éªŒæ˜¯å¦æ˜¯ä¸€äººä¸€å•</p><p>5ã€æ‰£å‡åº“å­˜</p><p>6ã€åˆ›å»ºè®¢å•</p><p>åœ¨è¿™å…­æ­¥æ“ä½œä¸­ï¼Œåˆæœ‰å¾ˆå¤šæ“ä½œæ˜¯è¦å»æ“ä½œæ•°æ®åº“çš„ï¼Œè€Œä¸”è¿˜æ˜¯ä¸€ä¸ªçº¿ç¨‹ä¸²è¡Œæ‰§è¡Œï¼Œ è¿™æ ·å°±ä¼šå¯¼è‡´æˆ‘ä»¬çš„ç¨‹åºæ‰§è¡Œçš„å¾ˆæ…¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼‚æ­¥ç¨‹åºæ‰§è¡Œï¼Œé‚£ä¹ˆå¦‚ä½•åŠ é€Ÿå‘¢ï¼Ÿ</p><div class="tabs" id="4baba01a-1fd4-4d5b-b3bb-b19671e2bcae"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#4baba01a-1fd4-4d5b-b3bb-b19671e2bcae-1"><i class="fas fa-atom"></i>æ–¹æ¡ˆä¸€</button></li><li class="tab"><button type="button" data-href="#4baba01a-1fd4-4d5b-b3bb-b19671e2bcae-2"><i class="far fa-sun"></i>æ–¹æ¡ˆäºŒ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="4baba01a-1fd4-4d5b-b3bb-b19671e2bcae-1"><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¸å¯ä»¥ä½¿ç”¨å¼‚æ­¥ç¼–æ’æ¥åšï¼Œæˆ–è€…è¯´æˆ‘å¼€å¯Nå¤šçº¿ç¨‹ï¼ŒNå¤šä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒæŸ¥è¯¢ä¼˜æƒ å·ï¼Œä¸€ä¸ªæ‰§è¡Œåˆ¤æ–­æ‰£å‡åº“å­˜ï¼Œä¸€ä¸ªå»åˆ›å»ºè®¢å•ç­‰ç­‰ï¼Œç„¶åå†ç»Ÿä¸€åšè¿”å›ã€‚å¦‚æœä½ é‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œå¦‚æœè®¿é—®çš„äººå¾ˆå¤šï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¯èƒ½ä¸€ä¸‹å­å°±è¢«æ¶ˆè€—å®Œäº†ï¼Œè€Œä¸”ä½¿ç”¨ä¸Šè¿°æ–¹æ¡ˆï¼Œæœ€å¤§çš„ç‰¹ç‚¹åœ¨äºï¼Œä½ è§‰å¾—æ—¶æ•ˆæ€§ä¼šéå¸¸é‡è¦ï¼Œä½†æ˜¯ä½ æƒ³æƒ³æ˜¯å—ï¼Ÿå¹¶ä¸æ˜¯ï¼Œæ¯”å¦‚æˆ‘åªè¦ç¡®å®šä»–èƒ½åšè¿™ä»¶äº‹ï¼Œç„¶åæˆ‘åè¾¹æ…¢æ…¢åšå°±å¯ä»¥äº†ï¼Œæˆ‘å¹¶ä¸éœ€è¦ä»–ä¸€å£æ°”åšå®Œè¿™ä»¶äº‹ã€‚æ‰€ä»¥æˆ‘ä»¬åº”å½“é‡‡ç”¨ç±»ä¼¼æ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹å¼æ¥å®Œæˆæˆ‘ä»¬çš„éœ€æ±‚ï¼Œè€Œä¸æ˜¯ä½¿ç”¨çº¿ç¨‹æ± æˆ–è€…æ˜¯å¼‚æ­¥ç¼–æ’çš„æ–¹å¼æ¥å®Œæˆè¿™ä¸ªéœ€æ±‚ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653560986599.png" alt="1653560986599" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4baba01a-1fd4-4d5b-b3bb-b19671e2bcae-2"><p>æˆ‘ä»¬å°†è€—æ—¶æ¯”è¾ƒçŸ­çš„é€»è¾‘åˆ¤æ–­æ”¾å…¥åˆ°redisä¸­ï¼Œæ¯”å¦‚æ˜¯å¦åº“å­˜è¶³å¤Ÿï¼Œæ¯”å¦‚æ˜¯å¦ä¸€äººä¸€å•ï¼Œè¿™æ ·çš„æ“ä½œï¼Œåªè¦è¿™ç§é€»è¾‘å¯ä»¥å®Œæˆï¼Œå°±æ„å‘³ç€æˆ‘ä»¬æ˜¯ä¸€å®šå¯ä»¥ä¸‹å•å®Œæˆçš„ï¼Œæˆ‘ä»¬åªéœ€è¦è¿›è¡Œå¿«é€Ÿçš„é€»è¾‘åˆ¤æ–­ï¼Œæ ¹æœ¬å°±ä¸ç”¨ç­‰ä¸‹å•é€»è¾‘èµ°å®Œï¼Œæˆ‘ä»¬ç›´æ¥ç»™ç”¨æˆ·è¿”å›æˆåŠŸï¼Œ å†åœ¨åå°å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œåå°çº¿ç¨‹æ…¢æ…¢çš„å»æ‰§è¡Œqueueé‡Œè¾¹çš„æ¶ˆæ¯ï¼Œè¿™æ ·ç¨‹åºä¸å°±è¶…çº§å¿«äº†å—ï¼Ÿè€Œä¸”ä¹Ÿä¸ç”¨æ‹…å¿ƒçº¿ç¨‹æ± æ¶ˆè€—æ®†å°½çš„é—®é¢˜ï¼Œå› ä¸ºè¿™é‡Œæˆ‘ä»¬çš„ç¨‹åºä¸­å¹¶æ²¡æœ‰æ‰‹åŠ¨ä½¿ç”¨ä»»ä½•çº¿ç¨‹æ± ï¼Œå½“ç„¶è¿™é‡Œè¾¹æœ‰ä¸¤ä¸ªéš¾ç‚¹</p><p>ç¬¬ä¸€ä¸ªéš¾ç‚¹æ˜¯æˆ‘ä»¬æ€ä¹ˆåœ¨redisä¸­å»å¿«é€Ÿæ ¡éªŒä¸€äººä¸€å•ï¼Œè¿˜æœ‰åº“å­˜åˆ¤æ–­</p><p>ç¬¬äºŒä¸ªéš¾ç‚¹æ˜¯ç”±äºæˆ‘ä»¬æ ¡éªŒå’Œtomctä¸‹å•æ˜¯ä¸¤ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•çŸ¥é“åˆ°åº•å“ªä¸ªå•ä»–æœ€åæ˜¯å¦æˆåŠŸï¼Œæˆ–è€…æ˜¯ä¸‹å•å®Œæˆï¼Œä¸ºäº†å®Œæˆè¿™ä»¶äº‹æˆ‘ä»¬åœ¨redisæ“ä½œå®Œä¹‹åï¼Œæˆ‘ä»¬ä¼šå°†ä¸€äº›ä¿¡æ¯è¿”å›ç»™å‰ç«¯ï¼ŒåŒæ—¶ä¹Ÿä¼šæŠŠè¿™äº›ä¿¡æ¯ä¸¢åˆ°å¼‚æ­¥queueä¸­å»ï¼Œåç»­æ“ä½œä¸­ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªidæ¥æŸ¥è¯¢æˆ‘ä»¬tomcatä¸­çš„ä¸‹å•é€»è¾‘æ˜¯å¦å®Œæˆäº†ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653561657295.png" alt="1653561657295" style="zoom:67%;" /><p>æˆ‘ä»¬ç°åœ¨æ¥çœ‹çœ‹æ•´ä½“æ€è·¯ï¼šå½“ç”¨æˆ·ä¸‹å•ä¹‹åï¼Œåˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³åªéœ€è¦å¯¼redisä¸­å»æ ¹æ®keyæ‰¾å¯¹åº”çš„valueæ˜¯å¦å¤§äº0å³å¯ï¼Œå¦‚æœä¸å……è¶³ï¼Œåˆ™ç›´æ¥ç»“æŸï¼Œå¦‚æœå……è¶³ï¼Œç»§ç»­åœ¨redisä¸­åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å¯ä»¥ä¸‹å•ï¼Œå¦‚æœseté›†åˆä¸­æ²¡æœ‰è¿™æ¡æ•°æ®ï¼Œè¯´æ˜ä»–å¯ä»¥ä¸‹å•ï¼Œå¦‚æœseté›†åˆä¸­æ²¡æœ‰è¿™æ¡è®°å½•ï¼Œåˆ™å°†userIdå’Œä¼˜æƒ å·å­˜å…¥åˆ°redisä¸­ï¼Œå¹¶ä¸”è¿”å›0ï¼Œæ•´ä¸ªè¿‡ç¨‹éœ€è¦ä¿è¯æ˜¯åŸå­æ€§çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨luaæ¥æ“ä½œ</p><p>å½“ä»¥ä¸Šåˆ¤æ–­é€»è¾‘èµ°å®Œä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­å½“å‰redisä¸­è¿”å›çš„ç»“æœæ˜¯å¦æ˜¯0 ï¼Œå¦‚æœæ˜¯0ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥ä¸‹å•ï¼Œåˆ™å°†ä¹‹å‰è¯´çš„ä¿¡æ¯å­˜å…¥åˆ°åˆ°queueä¸­å»ï¼Œç„¶åè¿”å›ï¼Œç„¶åå†æ¥ä¸ªçº¿ç¨‹å¼‚æ­¥çš„ä¸‹å•ï¼Œå‰ç«¯å¯ä»¥é€šè¿‡è¿”å›çš„è®¢å•idæ¥åˆ¤æ–­æ˜¯å¦ä¸‹å•æˆåŠŸã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653562234886.png" alt="1653562234886" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="ç§’æ€èµ„æ ¼åˆ¤æ–­">ç§’æ€èµ„æ ¼åˆ¤æ–­</h3><p>éœ€æ±‚ï¼š</p><ul><li><p>æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œå°†ä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</p></li><li><p>åŸºäºLuaè„šæœ¬ï¼Œåˆ¤æ–­ç§’æ€åº“å­˜ã€ä¸€äººä¸€å•ï¼Œå†³å®šç”¨æˆ·æ˜¯å¦æŠ¢è´­æˆåŠŸ</p></li><li><p>å¦‚æœæŠ¢è´­æˆåŠŸï¼Œå°†ä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idå°è£…åå­˜å…¥é˜»å¡é˜Ÿåˆ—</p></li><li><p>å¼€å¯çº¿ç¨‹ä»»åŠ¡ï¼Œä¸æ–­ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå®ç°å¼‚æ­¥ä¸‹å•åŠŸèƒ½</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1656080546603.png" alt="1656080546603"></p></li></ul><div class="tabs" id="601d3706-08b9-4770-8325-8be09a054135"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#601d3706-08b9-4770-8325-8be09a054135-1"><i class="fas fa-atom"></i>æ·»åŠ ä¼˜æƒ åˆ¸</button></li><li class="tab"><button type="button" data-href="#601d3706-08b9-4770-8325-8be09a054135-2"><i class="far fa-sun"></i>luaè„šæœ¬</button></li><li class="tab"><button type="button" data-href="#601d3706-08b9-4770-8325-8be09a054135-3"><i class="fas fa-wind"></i>ç§’æ€é€»è¾‘</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="601d3706-08b9-4770-8325-8be09a054135-1"><p><mark class="hl-label blue">VoucherServiceImpl</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜ä¼˜æƒ åˆ¸</span></span><br><span class="line">    save(voucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€ä¿¡æ¯</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">    seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">    seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">    seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">    seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">    seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€åº“å­˜åˆ°Redisä¸­</span></span><br><span class="line">    <span class="comment">//SECKILL_STOCK_KEY è¿™ä¸ªå˜é‡å®šä¹‰åœ¨RedisConstansä¸­</span></span><br><span class="line">    <span class="comment">//private static final String SECKILL_STOCK_KEY =&quot;seckill:stock:&quot;</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="601d3706-08b9-4770-8325-8be09a054135-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">-- <span class="number">1.</span>å‚æ•°åˆ—è¡¨</span><br><span class="line">-- <span class="number">1.1</span>.ä¼˜æƒ åˆ¸id</span><br><span class="line"><span class="type">local</span> <span class="variable">voucherId</span> <span class="operator">=</span> ARGV[<span class="number">1</span>]</span><br><span class="line">-- <span class="number">1.2</span>.ç”¨æˆ·id</span><br><span class="line"><span class="type">local</span> <span class="variable">userId</span> <span class="operator">=</span> ARGV[<span class="number">2</span>]</span><br><span class="line">-- <span class="number">1.3</span>.è®¢å•id</span><br><span class="line"><span class="type">local</span> <span class="variable">orderId</span> <span class="operator">=</span> ARGV[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">-- <span class="number">2.</span>æ•°æ®key</span><br><span class="line">-- <span class="number">2.1</span>.åº“å­˜key</span><br><span class="line"><span class="type">local</span> <span class="variable">stockKey</span> <span class="operator">=</span> <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId</span><br><span class="line">-- <span class="number">2.2</span>.è®¢å•key</span><br><span class="line"><span class="type">local</span> <span class="variable">orderKey</span> <span class="operator">=</span> <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId</span><br><span class="line"></span><br><span class="line">-- <span class="number">3.</span>è„šæœ¬ä¸šåŠ¡</span><br><span class="line">-- <span class="number">3.1</span>.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ get stockKey</span><br><span class="line"><span class="title function_">if</span><span class="params">(tonumber(redis.call(<span class="string">&#x27;get&#x27;</span>, stockKey)</span>) &lt;= <span class="number">0</span>) then</span><br><span class="line">    -- <span class="number">3.2</span>.åº“å­˜ä¸è¶³ï¼Œè¿”å›<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">end</span><br><span class="line">-- <span class="number">3.2</span>.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å• SISMEMBER orderKey userId</span><br><span class="line"><span class="title function_">if</span><span class="params">(redis.call(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId)</span> == <span class="number">1</span>) then</span><br><span class="line">    -- <span class="number">3.3</span>.å­˜åœ¨ï¼Œè¯´æ˜æ˜¯é‡å¤ä¸‹å•ï¼Œè¿”å›<span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">end</span><br><span class="line">-- <span class="number">3.4</span>.æ‰£åº“å­˜ incrby stockKey -<span class="number">1</span></span><br><span class="line">redis.call(<span class="string">&#x27;incrby&#x27;</span>, stockKey, -<span class="number">1</span>)</span><br><span class="line">-- <span class="number">3.5</span>.ä¸‹å•ï¼ˆä¿å­˜ç”¨æˆ·ï¼‰sadd orderKey userId</span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="601d3706-08b9-4770-8325-8be09a054135-3"><p><mark class="hl-label green">VoucherOrderServiceImpl</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">//è·å–ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="comment">// 1.æ‰§è¡Œluaè„šæœ¬</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(</span><br><span class="line">            SECKILL_SCRIPT,</span><br><span class="line">            Collections.emptyList(),</span><br><span class="line">            voucherId.toString(), userId.toString(), String.valueOf(orderId)</span><br><span class="line">    );</span><br><span class="line">    <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> result.intValue();</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0</span></span><br><span class="line">    <span class="keyword">if</span> (r != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 2.1.ä¸ä¸º0 ï¼Œä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(r == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//TODO ä¿å­˜é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="comment">// 3.è¿”å›è®¢å•id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="Redisæ¶ˆæ¯é˜Ÿåˆ—">Redisæ¶ˆæ¯é˜Ÿåˆ—</h2><p>ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚æœ€ç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹åŒ…æ‹¬3ä¸ªè§’è‰²ï¼š</p><ul><li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­˜å‚¨å’Œç®¡ç†æ¶ˆæ¯ï¼Œä¹Ÿè¢«ç§°ä¸ºæ¶ˆæ¯ä»£ç†ï¼ˆMessage Brokerï¼‰</li><li>ç”Ÿäº§è€…ï¼šå‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—</li><li>æ¶ˆè´¹è€…ï¼šä»æ¶ˆæ¯é˜Ÿåˆ—è·å–æ¶ˆæ¯å¹¶å¤„ç†æ¶ˆæ¯</li></ul><p>ä½¿ç”¨é˜Ÿåˆ—çš„å¥½å¤„åœ¨äº **è§£è€¦ï¼š**æ‰€è°“è§£è€¦ï¼Œä¸¾ä¸€ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­å°±æ˜¯ï¼šå¿«é€’å‘˜(ç”Ÿäº§è€…)æŠŠå¿«é€’æ”¾åˆ°å¿«é€’æŸœé‡Œè¾¹(Message Queue)å»ï¼Œæˆ‘ä»¬(æ¶ˆè´¹è€…)ä»å¿«é€’æŸœé‡Œè¾¹å»æ‹¿ä¸œè¥¿ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå¼‚æ­¥ï¼Œå¦‚æœè€¦åˆï¼Œé‚£ä¹ˆè¿™ä¸ªå¿«é€’å‘˜ç›¸å½“äºç›´æ¥æŠŠå¿«é€’äº¤ç»™ä½ ï¼Œè¿™äº‹å›ºç„¶å¥½ï¼Œä½†æ˜¯ä¸‡ä¸€ä½ ä¸åœ¨å®¶ï¼Œé‚£ä¹ˆå¿«é€’å‘˜å°±ä¼šä¸€ç›´ç­‰ä½ ï¼Œè¿™å°±æµªè´¹äº†å¿«é€’å‘˜çš„æ—¶é—´ï¼Œæ‰€ä»¥è¿™ç§æ€æƒ³åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ï¼Œæ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚</p><p>è¿™ç§åœºæ™¯åœ¨æˆ‘ä»¬ç§’æ€ä¸­å°±å˜æˆäº†ï¼šæˆ‘ä»¬ä¸‹å•ä¹‹åï¼Œåˆ©ç”¨rediså»è¿›è¡Œæ ¡éªŒä¸‹å•æ¡ä»¶ï¼Œå†é€šè¿‡é˜Ÿåˆ—æŠŠæ¶ˆæ¯å‘é€å‡ºå»ï¼Œç„¶åå†å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»æ¶ˆè´¹è¿™ä¸ªæ¶ˆæ¯ï¼Œå®Œæˆè§£è€¦ï¼ŒåŒæ—¶ä¹ŸåŠ å¿«æˆ‘ä»¬çš„å“åº”é€Ÿåº¦ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›ç°æˆçš„mqï¼Œæ¯”å¦‚kafkaï¼Œrabbitmqç­‰ç­‰ï¼Œä½†æ˜¯å‘¢ï¼Œå¦‚æœæ²¡æœ‰å®‰è£…mqï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨redisæä¾›çš„mqæ–¹æ¡ˆï¼Œé™ä½æˆ‘ä»¬çš„éƒ¨ç½²å’Œå­¦ä¹ æˆæœ¬ã€‚</p><hr><h3 id="åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—">åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—</h3><p>æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰ï¼Œå­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚è€ŒRedisçš„listæ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¾ˆå®¹æ˜“æ¨¡æ‹Ÿå‡ºé˜Ÿåˆ—æ•ˆæœã€‚</p><p>é˜Ÿåˆ—æ˜¯å…¥å£å’Œå‡ºå£ä¸åœ¨ä¸€è¾¹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ï¼šLPUSH ç»“åˆ RPOPã€æˆ–è€… RPUSH ç»“åˆ LPOPæ¥å®ç°ã€‚<br>ä¸è¿‡è¦æ³¨æ„çš„æ˜¯ï¼Œå½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯æ—¶RPOPæˆ–LPOPæ“ä½œä¼šè¿”å›nullï¼Œå¹¶ä¸åƒJVMçš„é˜»å¡é˜Ÿåˆ—é‚£æ ·ä¼šé˜»å¡å¹¶ç­‰å¾…æ¶ˆæ¯ã€‚å› æ­¤è¿™é‡Œåº”è¯¥ä½¿ç”¨BRPOPæˆ–è€…BLPOPæ¥å®ç°é˜»å¡æ•ˆæœã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653575176451.png" alt="1653575176451"></p><p>åŸºäºListçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ<br>ä¼˜ç‚¹ï¼š</p><ul><li>åˆ©ç”¨Rediså­˜å‚¨ï¼Œä¸å—é™äºJVMå†…å­˜ä¸Šé™</li><li>åŸºäºRedisçš„æŒä¹…åŒ–æœºåˆ¶ï¼Œæ•°æ®å®‰å…¨æ€§æœ‰ä¿è¯</li><li>å¯ä»¥æ»¡è¶³æ¶ˆæ¯æœ‰åºæ€§</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±</li><li>åªæ”¯æŒå•æ¶ˆè´¹è€…</li></ul><hr><h3 id="åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—">åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—</h3><p>PubSubï¼ˆå‘å¸ƒè®¢é˜…ï¼‰æ˜¯Redis2.0ç‰ˆæœ¬å¼•å…¥çš„æ¶ˆæ¯ä¼ é€’æ¨¡å‹ã€‚é¡¾åæ€ä¹‰ï¼Œæ¶ˆè´¹è€…å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªchannelï¼Œç”Ÿäº§è€…å‘å¯¹åº”channelå‘é€æ¶ˆæ¯åï¼Œæ‰€æœ‰è®¢é˜…è€…éƒ½èƒ½æ”¶åˆ°ç›¸å…³æ¶ˆæ¯ã€‚</p><p>SUBSCRIBE channel [channel] ï¼šè®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“<br>PUBLISH channel msg ï¼šå‘ä¸€ä¸ªé¢‘é“å‘é€æ¶ˆæ¯<br>PSUBSCRIBE pattern[pattern] ï¼šè®¢é˜…ä¸patternæ ¼å¼åŒ¹é…çš„æ‰€æœ‰é¢‘é“</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653575506373.png" alt="1653575506373" style="zoom:67%;" /><p>åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ<br>ä¼˜ç‚¹ï¼š</p><ul><li>é‡‡ç”¨å‘å¸ƒè®¢é˜…æ¨¡å‹ï¼Œæ”¯æŒå¤šç”Ÿäº§ã€å¤šæ¶ˆè´¹</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>ä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–</li><li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±</li><li>æ¶ˆæ¯å †ç§¯æœ‰ä¸Šé™ï¼Œè¶…å‡ºæ—¶æ•°æ®ä¸¢å¤±</li></ul><hr><h3 id="åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—">åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—</h3><p>Stream æ˜¯ Redis 5.0 å¼•å…¥çš„ä¸€ç§æ–°æ•°æ®ç±»å‹ï¼Œå¯ä»¥å®ç°ä¸€ä¸ªåŠŸèƒ½éå¸¸å®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p><div class="tabs" id="4bf99a7f-851c-4e60-aa15-4aa143909861"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#4bf99a7f-851c-4e60-aa15-4aa143909861-1"><i class="fas fa-award"></i>å‘é€æ¶ˆæ¯</button></li><li class="tab"><button type="button" data-href="#4bf99a7f-851c-4e60-aa15-4aa143909861-2"><i class="fas fa-baseball-ball"></i>è¯»å–æ¶ˆæ¯</button></li><li class="tab"><button type="button" data-href="#4bf99a7f-851c-4e60-aa15-4aa143909861-3"><i class="fas fa-bone"></i>ä½¿ç”¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="4bf99a7f-851c-4e60-aa15-4aa143909861-1"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653577301737.png" alt="1653577301737"></p><p>ä¾‹å¦‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## åˆ›å»ºåä¸º users çš„é˜Ÿåˆ—ï¼Œå¹¶ä¸”å…¶ä¸­å‘é€ä¸€ä¸ªæ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š&#123;name=jack,age=21&#125;,å¹¶ä¸”ä½¿ç”¨Redisè‡ªåŠ¨ç”ŸæˆID</span></span><br><span class="line">127.0.0.1:6379&gt; XADD <span class="built_in">users</span> * name jack age 21</span><br><span class="line"><span class="string">&quot;1644805700523-0&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4bf99a7f-851c-4e60-aa15-4aa143909861-2"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653577445413.png" alt="1653577445413" style="zoom:67%;" /><p>ä¾‹å¦‚ï¼Œä½¿ç”¨XREADè¯»å–ç¬¬ä¸€ä¸ªæ¶ˆæ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; XREAD COUNT 1 STREAMS <span class="built_in">users</span> 0</span><br><span class="line">1) 1) <span class="string">&quot;users&quot;</span></span><br><span class="line">   2) 1) 1) <span class="string">&quot;1686396575325-0&quot;</span></span><br><span class="line">         2) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">            2) <span class="string">&quot;jack&quot;</span></span><br><span class="line">            3) <span class="string">&quot;age&quot;</span></span><br><span class="line">            4) 21</span><br></pre></td></tr></table></figure><p>XREADé˜»å¡æ–¹å¼ï¼Œè¯»å–æœ€æ–°çš„æ¶ˆæ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; XREAD COUNT 1 BLOCK 1000 STREAMS <span class="built_in">users</span> $</span><br><span class="line">(nil)</span><br><span class="line">(1.10s)</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4bf99a7f-851c-4e60-aa15-4aa143909861-3"><p>åœ¨ä¸šåŠ¡å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾ªç¯çš„è°ƒç”¨XREADé˜»å¡æ–¹å¼æ¥æŸ¥è¯¢æœ€æ–°æ¶ˆæ¯ï¼Œä»è€Œå®ç°æŒç»­ç›‘å¬é˜Ÿåˆ—çš„æ•ˆæœï¼Œä¼ªä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">    <span class="comment">// å°è¯•è¯»å–é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œæœ€å¤šé˜»å¡2ç§’</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.excute(<span class="string">&quot;XREAD COUNT 1 BLOCK 2000 STREAMS users $&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(msg == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">    handleMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šå½“æˆ‘ä»¬æŒ‡å®šèµ·å§‹IDä¸º$æ—¶ï¼Œä»£è¡¨è¯»å–æœ€æ–°çš„æ¶ˆæ¯ï¼Œå¦‚æœæˆ‘ä»¬å¤„ç†ä¸€æ¡æ¶ˆæ¯çš„è¿‡ç¨‹ä¸­ï¼Œåˆæœ‰è¶…è¿‡1æ¡ä»¥ä¸Šçš„æ¶ˆæ¯åˆ°è¾¾é˜Ÿåˆ—ï¼Œåˆ™ä¸‹æ¬¡è·å–æ—¶ä¹Ÿåªèƒ½è·å–åˆ°æœ€æ–°çš„ä¸€æ¡ï¼Œä¼šå‡ºç°æ¼è¯»æ¶ˆæ¯çš„é—®é¢˜</p><p>STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADå‘½ä»¤ç‰¹ç‚¹ï¼š</p><ul><li>æ¶ˆæ¯å¯å›æº¯</li><li>ä¸€ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…è¯»å–</li><li>å¯ä»¥é˜»å¡è¯»å–</li><li>æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <mark class="hl-label blue">æ¶ˆè´¹è€…ç»„</mark> <p>æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰ï¼šå°†å¤šä¸ªæ¶ˆè´¹è€…åˆ’åˆ†åˆ°ä¸€ä¸ªç»„ä¸­ï¼Œç›‘å¬åŒä¸€ä¸ªé˜Ÿåˆ—ã€‚å…·å¤‡ä¸‹åˆ—ç‰¹ç‚¹ï¼š</p><ul><li>æ¶ˆæ¯åˆ†æµ é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¼šåˆ†æµç»™ç»„å†…çš„ä¸åŒæ¶ˆè´¹è€…ï¼Œè€Œä¸æ˜¯é‡å¤æ¶ˆè´¹ï¼Œä»è€ŒåŠ å¿«æ¶ˆæ¯å¤„ç†çš„é€Ÿåº¦</li><li>æ¶ˆæ¯æ ‡ç¤º æ¶ˆè´¹è€…ç»„ä¼šç»´æŠ¤ä¸€ä¸ªæ ‡ç¤ºï¼Œ è®°å½•æœ€åä¸€ä¸ªè¢«å¤„ç†çš„æ¶ˆæ¯ï¼Œ å“ªæ€•æ¶ˆè´¹è€…å®•æœºé‡å¯ï¼Œè¿˜ä¼šä»æ ‡ç¤ºä¹‹åè¯»å–æ¶ˆæ¯ã€‚ç¡®ä¿æ¯ä¸€ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æ¶ˆè´¹</li><li>æ¶ˆæ¯ç¡®è®¤ æ¶ˆè´¹è€…è·å–æ¶ˆæ¯åï¼Œæ¶ˆæ¯å¤„äº pendingçŠ¶æ€ï¼Œäº•å­˜å…¥ä¸€ä¸ªpending-listã€‚å½“å¤„ç†å®Œæˆåéœ€è¦é€šè¿‡XACKæ¥ç¡®è®¤æ¶ˆæ¯ï¼Œæ ‡è®°æ¶ˆæ¯ä¸ºå·²å¤„ç†ï¼Œæ‰ä¼šä»pending-listç§»é™¤</li></ul><div class="tabs" id="75b87830-c6bf-4e70-bbf1-8cdb998001a2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#75b87830-c6bf-4e70-bbf1-8cdb998001a2-1"><i class="fas fa-cat"></i>åˆ›å»ºæ¶ˆè´¹è€…ç»„</button></li><li class="tab"><button type="button" data-href="#75b87830-c6bf-4e70-bbf1-8cdb998001a2-2"><i class="fas fa-horse"></i>åˆ é™¤æ¶ˆè´¹ç»„</button></li><li class="tab"><button type="button" data-href="#75b87830-c6bf-4e70-bbf1-8cdb998001a2-3"><i class="fas fa-dove"></i>æ·»åŠ æ¶ˆè´¹è€…</button></li><li class="tab"><button type="button" data-href="#75b87830-c6bf-4e70-bbf1-8cdb998001a2-4"><i class="fas fa-dragon"></i>åˆ é™¤æ¶ˆè´¹è€…</button></li><li class="tab"><button type="button" data-href="#75b87830-c6bf-4e70-bbf1-8cdb998001a2-5"><i class="fas fa-heartbeat"></i>ä»æ¶ˆè´¹è€…ç»„è¯»å–æ¶ˆæ¯</button></li><li class="tab"><button type="button" data-href="#75b87830-c6bf-4e70-bbf1-8cdb998001a2-6"><i class="fas fa-cookie-bite"></i>ä½¿ç”¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="75b87830-c6bf-4e70-bbf1-8cdb998001a2-1"><p><code>XGROUP CREATE key groupName ID [MKSTREAM]</code></p><p>keyï¼šé˜Ÿåˆ—åç§°<br>groupNameï¼šæ¶ˆè´¹è€…ç»„åç§°<br>IDï¼šèµ·å§‹IDæ ‡ç¤ºï¼Œ$ä»£è¡¨é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªæ¶ˆæ¯ï¼Œ0åˆ™ä»£è¡¨é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ¶ˆæ¯<br>MKSTREAMï¼šé˜Ÿåˆ—ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="75b87830-c6bf-4e70-bbf1-8cdb998001a2-2"><p><code>XGROUP DESTORY key groupName</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="75b87830-c6bf-4e70-bbf1-8cdb998001a2-3"><p><code>XGROUP CREATECONSUMER key groupname consumername</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="75b87830-c6bf-4e70-bbf1-8cdb998001a2-4"><p><code>XGROUP DELCONSUMER key groupname consumername</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="75b87830-c6bf-4e70-bbf1-8cdb998001a2-5"><p><code>XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key ...] ID [ID ...]</code></p><p>groupï¼šæ¶ˆè´¹ç»„åç§°</p><p>consumerï¼šæ¶ˆè´¹è€…åç§°ï¼Œå¦‚æœæ¶ˆè´¹è€…ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…</p><p>countï¼šæœ¬æ¬¡æŸ¥è¯¢çš„æœ€å¤§æ•°é‡</p><p>BLOCK millisecondsï¼šå½“æ²¡æœ‰æ¶ˆæ¯æ—¶æœ€é•¿ç­‰å¾…æ—¶é—´</p><p>NOACKï¼šæ— éœ€æ‰‹åŠ¨ACKï¼Œè·å–åˆ°æ¶ˆæ¯åè‡ªåŠ¨ç¡®è®¤</p><p>STREAMS keyï¼šæŒ‡å®šé˜Ÿåˆ—åç§°</p><p>IDï¼šè·å–æ¶ˆæ¯çš„èµ·å§‹ID</p><ul><li>â€œ&gt;â€ï¼šä»ä¸‹ä¸€ä¸ªæœªæ¶ˆè´¹çš„æ¶ˆæ¯å¼€å§‹</li><li>å…¶å®ƒï¼šæ ¹æ®æŒ‡å®šidä»pending-listä¸­è·å–å·²æ¶ˆè´¹ä½†æœªç¡®è®¤çš„æ¶ˆæ¯ï¼Œä¾‹å¦‚0ï¼Œæ˜¯ä»pending-listä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯å¼€å§‹ã€‚</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="75b87830-c6bf-4e70-bbf1-8cdb998001a2-6"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">    <span class="comment">// å°è¯•ç›‘å¬é˜Ÿåˆ—ï¼Œä½¿ç”¨é˜»å¡æ¨¡å¼ï¼Œæœ€å¤šç­‰å¾… 2000 æ¯«ç§’</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.call(<span class="string">&quot;XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 &gt;&quot;</span>);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ç»“æœ</span></span><br><span class="line">    <span class="keyword">if</span> (msg == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//æœ‰ç»“æœï¼Œåˆ™å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">        handleMessage(msg);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="comment">//å‡ºç°å¼‚å¸¸ï¼Œåˆ™æŸ¥è¯¢pending-list,ç»§ç»­å¤„ç†</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.call(<span class="string">&quot;XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 0&quot;</span>);</span><br><span class="line">            <span class="comment">// åˆ¤æ–­ç»“æœ</span></span><br><span class="line">            <span class="keyword">if</span> (msg == <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="comment">//æœ‰ç»“æœï¼Œåˆ™å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">                handleMessage(msg);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                <span class="comment">// å‡ºç°å¼‚å¸¸è®°å½•æ—¥å¿—å³å¯ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADGROUPå‘½ä»¤ç‰¹ç‚¹ï¼š</p><ul><li>æ¶ˆæ¯å¯å›æº¯</li><li>å¯ä»¥å¤šæ¶ˆè´¹è€…äº‰æŠ¢æ¶ˆæ¯ï¼ŒåŠ å¿«æ¶ˆè´¹é€Ÿåº¦</li><li>å¯ä»¥é˜»å¡è¯»å–</li><li>æ²¡æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©</li><li>æœ‰æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼Œä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡</li></ul><p>æœ€åæˆ‘ä»¬æ¥ä¸ªå°å¯¹æ¯”</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">List</th><th style="text-align:center">PubSub</th><th style="text-align:center">Stream</th></tr></thead><tbody><tr><td style="text-align:center">æ¶ˆæ¯æŒä¹…åŒ–</td><td style="text-align:center">æ”¯æŒ</td><td style="text-align:center">ä¸æ”¯æŒ</td><td style="text-align:center">æ”¯æŒ</td></tr><tr><td style="text-align:center">é˜»å¡è¯»å–</td><td style="text-align:center">æ”¯æŒ</td><td style="text-align:center">æ”¯æŒ</td><td style="text-align:center">æ”¯æŒ</td></tr><tr><td style="text-align:center">æ¶ˆæ¯å †ç§¯å¤„ç†</td><td style="text-align:center">é¦–å…ˆäºå†…å­˜ç©ºé—´ï¼Œkeyåˆ©ç”¨å¤šæ¶ˆè´¹è€…åŠ å¿«å¤„ç†</td><td style="text-align:center">å—é™äºæ¶ˆè´¹è€…ç¼“å†²åŒº</td><td style="text-align:center">å—é™äºé˜Ÿåˆ—é•¿åº¦ï¼Œå¯ä»¥åˆ©ç”¨æ¶ˆè´¹è€…ç»„æé«˜æ¶ˆè´¹é€Ÿåº¦ï¼Œå‡å°‘å †ç§¯</td></tr><tr><td style="text-align:center">æ¶ˆæ¯ç¡®è®¤æœºåˆ¶</td><td style="text-align:center">ä¸æ”¯æŒ</td><td style="text-align:center">ä¸æ”¯æŒ</td><td style="text-align:center">æ”¯æŒ</td></tr><tr><td style="text-align:center">æ¶ˆæ¯å›æº¯</td><td style="text-align:center">ä¸æ”¯æŒ</td><td style="text-align:center">ä¸æ”¯æŒ</td><td style="text-align:center">æ”¯æŒ</td></tr></tbody></table><hr><h3 id="Streamçš„æ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ä¸‹å•">Streamçš„æ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ä¸‹å•</h3><p>éœ€æ±‚ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªStreamç±»å‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåä¸ºstream.orders</li><li>ä¿®æ”¹ä¹‹å‰çš„ç§’æ€ä¸‹å•Luaè„šæœ¬ï¼Œåœ¨è®¤å®šæœ‰æŠ¢è´­èµ„æ ¼åï¼Œç›´æ¥å‘stream.ordersä¸­æ·»åŠ æ¶ˆæ¯ï¼Œå†…å®¹åŒ…å«voucherIdã€userIdã€orderId</li><li>é¡¹ç›®å¯åŠ¨æ—¶ï¼Œå¼€å¯ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡ï¼Œå°è¯•è·å–stream.ordersä¸­çš„æ¶ˆæ¯ï¼Œå®Œæˆä¸‹å•</li></ul><div class="tabs" id="002b742c-1310-4d1b-b929-2a7f61880510"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#002b742c-1310-4d1b-b929-2a7f61880510-1"><i class="fas fa-cat"></i>åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—å’Œæ¶ˆè´¹è€…ç»„</button></li><li class="tab"><button type="button" data-href="#002b742c-1310-4d1b-b929-2a7f61880510-2"><i class="fas fa-horse"></i>ä¿®æ”¹luaè¡¨è¾¾å¼</button></li><li class="tab"><button type="button" data-href="#002b742c-1310-4d1b-b929-2a7f61880510-3"><i class="fas fa-heartbeat"></i>VoucherOrderServiceImpl</button></li><li class="tab"><button type="button" data-href="#002b742c-1310-4d1b-b929-2a7f61880510-4"><i class="fas fa-dove"></i>å¤„ç†æ¶ˆæ¯</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="002b742c-1310-4d1b-b929-2a7f61880510-1"><p><code>XGROUP CREATE stream.orders g1 0 MKSTREAM</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="002b742c-1310-4d1b-b929-2a7f61880510-2"><p>æ–°å¢3.6 å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ä¸­</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1.å‚æ•°åˆ—è¡¨</span></span><br><span class="line"><span class="comment">-- 1.1.ä¼˜æƒ åˆ¸id</span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- 1.2.ç”¨æˆ·id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="comment">-- 1.3.è®¢å•id</span></span><br><span class="line"><span class="keyword">local</span> orderId = ARGV[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2.æ•°æ®key</span></span><br><span class="line"><span class="comment">-- 2.1.åº“å­˜key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">-- 2.2.è®¢å•key</span></span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.è„šæœ¬ä¸šåŠ¡</span></span><br><span class="line"><span class="comment">-- 3.1.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ get stockKey</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.2.åº“å­˜ä¸è¶³ï¼Œè¿”å›1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 3.2.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å• SISMEMBER orderKey userId</span></span><br><span class="line"><span class="keyword">if</span>(redis.call(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.3.å­˜åœ¨ï¼Œè¯´æ˜æ˜¯é‡å¤ä¸‹å•ï¼Œè¿”å›2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 3.4.æ‰£åº“å­˜ incrby stockKey -1</span></span><br><span class="line">redis.call(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>)</span><br><span class="line"><span class="comment">-- 3.5.ä¸‹å•ï¼ˆä¿å­˜ç”¨æˆ·ï¼‰sadd orderKey userId</span></span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId)</span><br><span class="line"><span class="comment">-- 1.å‚æ•°åˆ—è¡¨</span></span><br><span class="line"><span class="comment">-- 1.1.ä¼˜æƒ åˆ¸id</span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- 1.2.ç”¨æˆ·id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="comment">-- 1.3.è®¢å•id</span></span><br><span class="line"><span class="keyword">local</span> orderId = ARGV[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2.æ•°æ®key</span></span><br><span class="line"><span class="comment">-- 2.1.åº“å­˜key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">-- 2.2.è®¢å•key</span></span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.è„šæœ¬ä¸šåŠ¡</span></span><br><span class="line"><span class="comment">-- 3.1.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ get stockKey</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.2.åº“å­˜ä¸è¶³ï¼Œè¿”å›1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 3.2.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å• SISMEMBER orderKey userId</span></span><br><span class="line"><span class="keyword">if</span>(redis.call(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.3.å­˜åœ¨ï¼Œè¯´æ˜æ˜¯é‡å¤ä¸‹å•ï¼Œè¿”å›2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 3.4.æ‰£åº“å­˜ incrby stockKey -1</span></span><br><span class="line">redis.call(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>)</span><br><span class="line"><span class="comment">-- 3.5.ä¸‹å•ï¼ˆä¿å­˜ç”¨æˆ·ï¼‰sadd orderKey userId</span></span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId)</span><br><span class="line"><span class="comment">-- 3.6.å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ä¸­ï¼Œ XADD stream.orders * k1 v1 k2 v2 ...</span></span><br><span class="line">redis.call(<span class="string">&#x27;xadd&#x27;</span>, <span class="string">&#x27;stream.orders&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;userId&#x27;</span>, userId, <span class="string">&#x27;voucherId&#x27;</span>, voucherId, <span class="string">&#x27;id&#x27;</span>, orderId)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="002b742c-1310-4d1b-b929-2a7f61880510-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(SECKILL_SCRIPT,</span><br><span class="line">            Collections.emptyList(), voucherId.toString(),</span><br><span class="line">            UserHolder.getUser().getId().toString(), String.valueOf(orderId));</span><br><span class="line">    <span class="keyword">if</span> (result.intValue() != <span class="number">0</span>) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;luaè„šæœ¬è¿”å›å€¼ï¼š&#123;&#125;&quot;</span>, result.intValue());</span><br><span class="line">        <span class="keyword">return</span> Result.fail(result.intValue() == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•å•Š&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸»çº¿ç¨‹è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">    proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="002b742c-1310-4d1b-b929-2a7f61880510-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 1.è·å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 &gt;</span></span><br><span class="line">                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(</span><br><span class="line">                    Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                    StreamReadOptions.empty().count(<span class="number">1</span>).block(Duration.ofSeconds(<span class="number">2</span>)),</span><br><span class="line">                    StreamOffset.create(<span class="string">&quot;stream.orders&quot;</span>, ReadOffset.lastConsumed())</span><br><span class="line">                );</span><br><span class="line">                <span class="comment">// 2.åˆ¤æ–­è®¢å•ä¿¡æ¯æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">                <span class="keyword">if</span> (list == <span class="literal">null</span> || list.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰æ¶ˆæ¯ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è§£ææ•°æ®</span></span><br><span class="line">                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="number">0</span>);</span><br><span class="line">                Map&lt;Object, Object&gt; value = record.getValue();</span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                <span class="comment">// 3.åˆ›å»ºè®¢å•</span></span><br><span class="line">                createVoucherOrder(voucherOrder);</span><br><span class="line">                <span class="comment">// 4.ç¡®è®¤æ¶ˆæ¯ XACK</span></span><br><span class="line">                stringRedisTemplate.opsForStream().acknowledge(<span class="string">&quot;s1&quot;</span>, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                <span class="comment">//å¤„ç†å¼‚å¸¸æ¶ˆæ¯</span></span><br><span class="line">                handlePendingList();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlePendingList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 1.è·å–pending-listä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 0</span></span><br><span class="line">                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(</span><br><span class="line">                    Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                    StreamReadOptions.empty().count(<span class="number">1</span>),</span><br><span class="line">                    StreamOffset.create(<span class="string">&quot;stream.orders&quot;</span>, ReadOffset.from(<span class="string">&quot;0&quot;</span>))</span><br><span class="line">                );</span><br><span class="line">                <span class="comment">// 2.åˆ¤æ–­è®¢å•ä¿¡æ¯æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">                <span class="keyword">if</span> (list == <span class="literal">null</span> || list.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œç»“æŸå¾ªç¯</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è§£ææ•°æ®</span></span><br><span class="line">                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="number">0</span>);</span><br><span class="line">                Map&lt;Object, Object&gt; value = record.getValue();</span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                <span class="comment">// 3.åˆ›å»ºè®¢å•</span></span><br><span class="line">                createVoucherOrder(voucherOrder);</span><br><span class="line">                <span class="comment">// 4.ç¡®è®¤æ¶ˆæ¯ XACK</span></span><br><span class="line">                stringRedisTemplate.opsForStream().acknowledge(<span class="string">&quot;s1&quot;</span>, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;å¤„ç†penddingè®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    Thread.sleep(<span class="number">20</span>);</span><br><span class="line">                &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="ç‚¹èµå®ç°-sortedSet">ç‚¹èµå®ç°-sortedSet</h2><div class="tabs" id="ed3f0b4c-f93a-49ef-9df3-492ab55d6d5a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ed3f0b4c-f93a-49ef-9df3-492ab55d6d5a-1"><i class="fas fa-atom"></i>åˆå§‹ä»£ç </button></li><li class="tab"><button type="button" data-href="#ed3f0b4c-f93a-49ef-9df3-492ab55d6d5a-2"><i class="far fa-sun"></i>å®Œå–„ç‚¹èµåŠŸèƒ½</button></li><li class="tab"><button type="button" data-href="#ed3f0b4c-f93a-49ef-9df3-492ab55d6d5a-3"><i class="fas fa-wind"></i>åœ¨Blogæ·»åŠ ä¸€ä¸ªå­—æ®µ</button></li><li class="tab"><button type="button" data-href="#ed3f0b4c-f93a-49ef-9df3-492ab55d6d5a-4"><i class="fas fa-fire-alt"></i>ä¿®æ”¹ä»£ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ed3f0b4c-f93a-49ef-9df3-492ab55d6d5a-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/likes/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogLikes</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//ä¿®æ”¹ç‚¹èµæ•°é‡</span></span><br><span class="line">    blogService.update().setSql(<span class="string">&quot;liked = liked +1 &quot;</span>).eq(<span class="string">&quot;id&quot;</span>,id).update();</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é—®é¢˜åˆ†æï¼šè¿™ç§æ–¹å¼ä¼šå¯¼è‡´ä¸€ä¸ªç”¨æˆ·æ— é™ç‚¹èµï¼Œæ˜æ˜¾æ˜¯ä¸åˆç†çš„</p><p>é€ æˆè¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯ï¼Œæˆ‘ä»¬ç°åœ¨çš„é€»è¾‘ï¼Œå‘èµ·è¯·æ±‚å°±ç»™æ•°æ®åº“+1ï¼Œæ‰€ä»¥æ‰ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ed3f0b4c-f93a-49ef-9df3-492ab55d6d5a-2"><p>éœ€æ±‚ï¼š</p><ul><li>åŒä¸€ä¸ªç”¨æˆ·åªèƒ½ç‚¹èµä¸€æ¬¡ï¼Œå†æ¬¡ç‚¹å‡»åˆ™å–æ¶ˆç‚¹èµ</li><li>å¦‚æœå½“å‰ç”¨æˆ·å·²ç»ç‚¹èµï¼Œåˆ™ç‚¹èµæŒ‰é’®é«˜äº®æ˜¾ç¤ºï¼ˆå‰ç«¯å·²å®ç°ï¼Œåˆ¤æ–­å­—æ®µBlogç±»çš„isLikeå±æ€§ï¼‰</li></ul><p>å®ç°æ­¥éª¤ï¼š</p><ul><li>ç»™Blogç±»ä¸­æ·»åŠ ä¸€ä¸ªisLikeå­—æ®µï¼Œæ ‡ç¤ºæ˜¯å¦è¢«å½“å‰ç”¨æˆ·ç‚¹èµ</li><li>ä¿®æ”¹ç‚¹èµåŠŸèƒ½ï¼Œåˆ©ç”¨Redisçš„seté›†åˆåˆ¤æ–­æ˜¯å¦ç‚¹èµè¿‡ï¼Œæœªç‚¹èµè¿‡åˆ™ç‚¹èµæ•°+1ï¼Œå·²ç‚¹èµè¿‡åˆ™ç‚¹èµæ•°-1</li><li>ä¿®æ”¹æ ¹æ®idæŸ¥è¯¢Blogçš„ä¸šåŠ¡ï¼Œåˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦ç‚¹èµè¿‡ï¼Œèµ‹å€¼ç»™isLikeå­—æ®µ</li><li>ä¿®æ”¹åˆ†é¡µæŸ¥è¯¢Blogä¸šåŠ¡ï¼Œåˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦ç‚¹èµè¿‡ï¼Œèµ‹å€¼ç»™isLikeå­—æ®µ</li></ul><p>ä¸ºä»€ä¹ˆé‡‡ç”¨seté›†åˆï¼š</p><p>å› ä¸ºæˆ‘ä»¬çš„æ•°æ®æ˜¯ä¸èƒ½é‡å¤çš„ï¼Œå½“ç”¨æˆ·æ“ä½œè¿‡ä¹‹åï¼Œæ— è®ºä»–æ€ä¹ˆæ“ä½œï¼Œéƒ½æ˜¯</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ed3f0b4c-f93a-49ef-9df3-492ab55d6d5a-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableField(exist = false)</span></span><br><span class="line"><span class="keyword">private</span> Boolean isLike;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ed3f0b4c-f93a-49ef-9df3-492ab55d6d5a-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµ</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span><br><span class="line">    <span class="keyword">if</span> (BooleanUtil.isFalse(isMember)) &#123;</span><br><span class="line">        <span class="comment">//3.å¦‚æœæœªç‚¹èµï¼Œå¯ä»¥ç‚¹èµ</span></span><br><span class="line">        <span class="comment">//3.1 æ•°æ®åº“ç‚¹èµæ•°+1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="comment">//3.2 ä¿å­˜ç”¨æˆ·åˆ°Redisçš„seté›†åˆ</span></span><br><span class="line">        <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">            stringRedisTemplate.opsForSet().add(key, userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//4.å¦‚æœå·²ç‚¹èµï¼Œå–æ¶ˆç‚¹èµ</span></span><br><span class="line">        <span class="comment">//4.1 æ•°æ®åº“ç‚¹èµæ•°-1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="comment">//4.2 æŠŠç”¨æˆ·ä»Redisçš„seté›†åˆç§»é™¤</span></span><br><span class="line">        <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">            stringRedisTemplate.opsForSet().remove(key, userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <mark class="hl-label blue">ç‚¹èµæ’è¡Œæ¦œ</mark> <p>åœ¨æ¢åº—ç¬”è®°çš„è¯¦æƒ…é¡µé¢ï¼Œåº”è¯¥æŠŠç»™è¯¥ç¬”è®°ç‚¹èµçš„äººæ˜¾ç¤ºå‡ºæ¥ï¼Œæ¯”å¦‚æœ€æ—©ç‚¹èµçš„TOP5ï¼Œå½¢æˆç‚¹èµæ’è¡Œæ¦œï¼š</p><p>ä¹‹å‰çš„ç‚¹èµæ˜¯æ”¾åˆ°seté›†åˆï¼Œä½†æ˜¯seté›†åˆæ˜¯ä¸èƒ½æ’åºçš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ï¼Œå’±ä»¬å¯ä»¥é‡‡ç”¨ä¸€ä¸ªå¯ä»¥æ’åºçš„seté›†åˆï¼Œå°±æ˜¯å’±ä»¬çš„sortedSet</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653805077118.png" alt="1653805077118" style="zoom:67%;" /><p>æˆ‘ä»¬æ¥ä¸‹æ¥æ¥å¯¹æ¯”ä¸€ä¸‹è¿™äº›é›†åˆçš„åŒºåˆ«æ˜¯ä»€ä¹ˆ</p><p>æ‰€æœ‰ç‚¹èµçš„äººï¼Œéœ€è¦æ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”å½“ä½¿ç”¨setæˆ–è€…æ˜¯sortedSet</p><p>å…¶æ¬¡æˆ‘ä»¬éœ€è¦æ’åºï¼Œå°±å¯ä»¥ç›´æ¥é”å®šä½¿ç”¨sortedSetå•¦</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">List</th><th style="text-align:center">Set</th><th style="text-align:center">SortedSet</th></tr></thead><tbody><tr><td style="text-align:center">æ’åºæ–¹å¼</td><td style="text-align:center">æŒ‰æ·»åŠ é¡ºåºæ’åº</td><td style="text-align:center">æ— æ³•æ’åº</td><td style="text-align:center">æŒ‰scoreå€¼æ’åº</td></tr><tr><td style="text-align:center">å”¯ä¸€æ€§</td><td style="text-align:center">ä¸å”¯ä¸€</td><td style="text-align:center">å”¯ä¸€</td><td style="text-align:center">å”¯ä¸€</td></tr><tr><td style="text-align:center">æŸ¥æ‰¾æ–¹å¼</td><td style="text-align:center">æŒ‰ç´¢å¼•æŸ¥æ‰¾æˆ–é¦–ä½æŸ¥æ‰¾</td><td style="text-align:center">æ ¹æ®å…ƒç´ æŸ¥æ‰¾</td><td style="text-align:center">æ ¹æ®å…ƒç´ æŸ¥æ‰¾</td></tr></tbody></table><p>ä¿®æ”¹ä»£ç </p><div class="tabs" id="136de59c-033e-4085-a058-77f0cad44561"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#136de59c-033e-4085-a058-77f0cad44561-1"><i class="fas fa-bug"></i>ç‚¹èµé€»è¾‘ä»£ç </button></li><li class="tab"><button type="button" data-href="#136de59c-033e-4085-a058-77f0cad44561-2"><i class="fas fa-cannabis"></i>ç‚¹èµåˆ—è¡¨æŸ¥è¯¢åˆ—è¡¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="136de59c-033e-4085-a058-77f0cad44561-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">     <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">     <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">     <span class="comment">// 2.åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµ</span></span><br><span class="line">     <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">     <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());</span><br><span class="line">     <span class="keyword">if</span> (score == <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="comment">// 3.å¦‚æœæœªç‚¹èµï¼Œå¯ä»¥ç‚¹èµ</span></span><br><span class="line">         <span class="comment">// 3.1.æ•°æ®åº“ç‚¹èµæ•° + 1</span></span><br><span class="line">         <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">         <span class="comment">// 3.2.ä¿å­˜ç”¨æˆ·åˆ°Redisçš„seté›†åˆ  zadd key value score</span></span><br><span class="line">         <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">             stringRedisTemplate.opsForZSet().add(key, userId.toString(), System.currentTimeMillis());</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// 4.å¦‚æœå·²ç‚¹èµï¼Œå–æ¶ˆç‚¹èµ</span></span><br><span class="line">         <span class="comment">// 4.1.æ•°æ®åº“ç‚¹èµæ•° -1</span></span><br><span class="line">         <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">         <span class="comment">// 4.2.æŠŠç”¨æˆ·ä»Redisçš„seté›†åˆç§»é™¤</span></span><br><span class="line">         <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">             stringRedisTemplate.opsForZSet().remove(key, userId.toString());</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> Result.ok();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">isBlogLiked</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">     <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">     <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">     <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="comment">// ç”¨æˆ·æœªç™»å½•ï¼Œæ— éœ€æŸ¥è¯¢æ˜¯å¦ç‚¹èµ</span></span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line">     <span class="comment">// 2.åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµ</span></span><br><span class="line">     <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;blog:liked:&quot;</span> + blog.getId();</span><br><span class="line">     <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());</span><br><span class="line">     blog.setIsLike(score != <span class="literal">null</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="136de59c-033e-4085-a058-77f0cad44561-2"><p><code>BlogController</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/likes/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogLikes</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> blogService.queryBlogLikes(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>BlogService</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogLikes</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢top5çš„ç‚¹èµç”¨æˆ· zrange key 0 4</span></span><br><span class="line">    Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span> (top5 == <span class="literal">null</span> || top5.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2.è§£æå‡ºå…¶ä¸­çš„ç”¨æˆ·id</span></span><br><span class="line">    List&lt;Long&gt; ids = top5.stream().map(Long::valueOf).collect(Collectors.toList());</span><br><span class="line">    <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    <span class="comment">// 3.æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢ç”¨æˆ· WHERE id IN ( 5 , 1 ) ORDER BY FIELD(id, 5, 1)</span></span><br><span class="line">    List&lt;UserDTO&gt; userDTOS = userService.query()</span><br><span class="line">            .in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="string">&quot;)&quot;</span>).list()</span><br><span class="line">            .stream()</span><br><span class="line">            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// 4.è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(userDTOS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="å¥½å‹å…³æ³¨-set">å¥½å‹å…³æ³¨-set</h2><h3 id="å…³æ³¨å’Œå–æ¶ˆå…³æ³¨">å…³æ³¨å’Œå–æ¶ˆå…³æ³¨</h3><div class="tabs" id="bdd86502-abdf-4f47-9317-fa06d5ab6d28"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#bdd86502-abdf-4f47-9317-fa06d5ab6d28-1"><i class="fas fa-seedling"></i>1</button></li><li class="tab"><button type="button" data-href="#bdd86502-abdf-4f47-9317-fa06d5ab6d28-2"><i class="fas fa-leaf"></i>å®ç°æ€è·¯</button></li><li class="tab"><button type="button" data-href="#bdd86502-abdf-4f47-9317-fa06d5ab6d28-3"><i class="fab fa-apple"></i>FollowController</button></li><li class="tab"><button type="button" data-href="#bdd86502-abdf-4f47-9317-fa06d5ab6d28-4"><i class="fas fa-tree"></i>FollowService</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="bdd86502-abdf-4f47-9317-fa06d5ab6d28-1"><p>é’ˆå¯¹ç”¨æˆ·çš„æ“ä½œï¼šå¯ä»¥å¯¹ç”¨æˆ·è¿›è¡Œå…³æ³¨å’Œå–æ¶ˆå…³æ³¨åŠŸèƒ½ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653806140822.png" alt="1653806140822" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="bdd86502-abdf-4f47-9317-fa06d5ab6d28-2"><p>éœ€æ±‚ï¼šåŸºäºè¯¥è¡¨æ•°æ®ç»“æ„ï¼Œå®ç°ä¸¤ä¸ªæ¥å£ï¼š</p><ul><li>å…³æ³¨å’Œå–å…³æ¥å£</li><li>åˆ¤æ–­æ˜¯å¦å…³æ³¨çš„æ¥å£</li></ul><p>å…³æ³¨æ˜¯Userä¹‹é—´çš„å…³ç³»ï¼Œæ˜¯åšä¸»ä¸ç²‰ä¸çš„å…³ç³»ï¼Œæ•°æ®åº“ä¸­æœ‰ä¸€å¼ tb_followè¡¨æ¥æ ‡ç¤ºï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653806253817.png" alt="1653806253817"></p><p>æ³¨æ„: è¿™é‡Œéœ€è¦æŠŠä¸»é”®ä¿®æ”¹ä¸ºè‡ªå¢é•¿ï¼Œç®€åŒ–å¼€å‘ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="bdd86502-abdf-4f47-9317-fa06d5ab6d28-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…³æ³¨</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/&#123;id&#125;/&#123;isFollow&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long followUserId, <span class="meta">@PathVariable(&quot;isFollow&quot;)</span> Boolean isFollow)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> followService.follow(followUserId, isFollow);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å–æ¶ˆå…³æ³¨</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/or/not/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">isFollow</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long followUserId)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> followService.isFollow(followUserId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="bdd86502-abdf-4f47-9317-fa06d5ab6d28-4"><div class="tabs" id="cccdfb68-bd1f-430e-906b-bff07b662bc9"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#cccdfb68-bd1f-430e-906b-bff07b662bc9-1"><i class="fas fa-award"></i>å…³æ³¨</button></li><li class="tab"><button type="button" data-href="#cccdfb68-bd1f-430e-906b-bff07b662bc9-2"><i class="fas fa-baseball-ball"></i>å–æ¶ˆå…³æ³¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="cccdfb68-bd1f-430e-906b-bff07b662bc9-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…³æ³¨service</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFollow)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">    <span class="comment">// 1.åˆ¤æ–­åˆ°åº•æ˜¯å…³æ³¨è¿˜æ˜¯å–å…³</span></span><br><span class="line">    <span class="keyword">if</span> (isFollow) &#123;</span><br><span class="line">        <span class="comment">// 2.å…³æ³¨ï¼Œæ–°å¢æ•°æ®</span></span><br><span class="line">        <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">        follow.setUserId(userId);</span><br><span class="line">        follow.setFollowUserId(followUserId);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(follow);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 3.å–å…³ï¼Œåˆ é™¤ delete from tb_follow where user_id = ? and follow_user_id = ?</span></span><br><span class="line">        remove(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;Follow&gt;()</span><br><span class="line">                .eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cccdfb68-bd1f-430e-906b-bff07b662bc9-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å–æ¶ˆå…³æ³¨</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">isFollow</span><span class="params">(Long followUserId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.æŸ¥è¯¢æ˜¯å¦å…³æ³¨ select count(*) from tb_follow where user_id = ? and follow_user_id = ?</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId).count();</span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(count &gt; <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="å…±åŒå…³æ³¨">å…±åŒå…³æ³¨</h3><div class="tabs" id="d7cfd170-156e-4615-ae27-3c3a93bae496"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d7cfd170-156e-4615-ae27-3c3a93bae496-1"><i class="fas fa-horse"></i>1</button></li><li class="tab"><button type="button" data-href="#d7cfd170-156e-4615-ae27-3c3a93bae496-2"><i class="fas fa-dove"></i>2</button></li><li class="tab"><button type="button" data-href="#d7cfd170-156e-4615-ae27-3c3a93bae496-3"><i class="fas fa-dragon"></i>3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d7cfd170-156e-4615-ae27-3c3a93bae496-1"><p>éœ€æ±‚ï¼šåˆ©ç”¨Redisä¸­æ°å½“çš„æ•°æ®ç»“æ„ï¼Œå®ç°å…±åŒå…³æ³¨åŠŸèƒ½ã€‚åœ¨åšä¸»ä¸ªäººé¡µé¢å±•ç¤ºå‡ºå½“å‰ç”¨æˆ·ä¸åšä¸»çš„å…±åŒå…³æ³¨å‘¢ã€‚</p><p>å½“ç„¶æ˜¯ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰å­¦ä¹ è¿‡çš„seté›†åˆå’¯ï¼Œåœ¨seté›†åˆä¸­ï¼Œæœ‰äº¤é›†å¹¶é›†è¡¥é›†çš„apiï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸¤äººçš„å…³æ³¨çš„äººåˆ†åˆ«æ”¾å…¥åˆ°ä¸€ä¸ªseté›†åˆä¸­ï¼Œç„¶åå†é€šè¿‡apiå»æŸ¥çœ‹è¿™ä¸¤ä¸ªseté›†åˆä¸­çš„äº¤é›†æ•°æ®ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d7cfd170-156e-4615-ae27-3c3a93bae496-2"><p>æˆ‘ä»¬å…ˆæ¥æ”¹é€ å½“å‰çš„å…³æ³¨åˆ—è¡¨</p><p>æ”¹é€ åŸå› æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦åœ¨ç”¨æˆ·å…³æ³¨äº†æŸä½ç”¨æˆ·åï¼Œéœ€è¦å°†æ•°æ®æ”¾å…¥åˆ°seté›†åˆä¸­ï¼Œæ–¹ä¾¿åç»­è¿›è¡Œå…±åŒå…³æ³¨ï¼ŒåŒæ—¶å½“å–æ¶ˆå…³æ³¨æ—¶ï¼Œä¹Ÿéœ€è¦ä»seté›†åˆä¸­è¿›è¡Œåˆ é™¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFollow)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">    <span class="comment">// 1.åˆ¤æ–­åˆ°åº•æ˜¯å…³æ³¨è¿˜æ˜¯å–å…³</span></span><br><span class="line">    <span class="keyword">if</span> (isFollow) &#123;</span><br><span class="line">        <span class="comment">// 2.å…³æ³¨ï¼Œæ–°å¢æ•°æ®</span></span><br><span class="line">        <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">        follow.setUserId(userId);</span><br><span class="line">        follow.setFollowUserId(followUserId);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(follow);</span><br><span class="line">        <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">            <span class="comment">// æŠŠå…³æ³¨ç”¨æˆ·çš„idï¼Œæ”¾å…¥redisçš„seté›†åˆ sadd userId followerUserId</span></span><br><span class="line">            stringRedisTemplate.opsForSet().add(key, followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 3.å–å…³ï¼Œåˆ é™¤ delete from tb_follow where user_id = ? and follow_user_id = ?</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> remove(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;Follow&gt;()</span><br><span class="line">                .eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId));</span><br><span class="line">        <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">            <span class="comment">// æŠŠå…³æ³¨ç”¨æˆ·çš„idä»Redisé›†åˆä¸­ç§»é™¤</span></span><br><span class="line">            stringRedisTemplate.opsForSet().remove(key, followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d7cfd170-156e-4615-ae27-3c3a93bae496-3"><p>å…·ä½“çš„å…³æ³¨ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">followCommons</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">    <span class="comment">// 2.æ±‚äº¤é›†</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key2</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + id;</span><br><span class="line">    Set&lt;String&gt; intersect = stringRedisTemplate.opsForSet().intersect(key, key2);</span><br><span class="line">    <span class="keyword">if</span> (intersect == <span class="literal">null</span> || intersect.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// æ— äº¤é›†</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.è§£æidé›†åˆ</span></span><br><span class="line">    List&lt;Long&gt; ids = intersect.stream().map(Long::valueOf).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// 4.æŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">    List&lt;UserDTO&gt; users = userService.listByIds(ids)</span><br><span class="line">            .stream()</span><br><span class="line">            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> Result.ok(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="Feedæµå®ç°æ–¹æ¡ˆ">Feedæµå®ç°æ–¹æ¡ˆ</h3><p>å½“æˆ‘ä»¬å…³æ³¨äº†ç”¨æˆ·åï¼Œè¿™ä¸ªç”¨æˆ·å‘äº†åŠ¨æ€ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥æŠŠè¿™äº›æ•°æ®æ¨é€ç»™ç”¨æˆ·ï¼Œè¿™ä¸ªéœ€æ±‚ï¼Œå…¶å®æˆ‘ä»¬åˆæŠŠä»–å«åšFeedæµï¼Œå…³æ³¨æ¨é€ä¹Ÿå«åšFeedæµï¼Œç›´è¯‘ä¸ºæŠ•å–‚ã€‚ä¸ºç”¨æˆ·æŒç»­çš„æä¾›â€œæ²‰æµ¸å¼â€çš„ä½“éªŒï¼Œé€šè¿‡æ— é™ä¸‹æ‹‰åˆ·æ–°è·å–æ–°çš„ä¿¡æ¯ã€‚</p><div class="tabs" id="c3c3b6b8-5d41-479e-88a8-7ffb8fcddecb"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c3c3b6b8-5d41-479e-88a8-7ffb8fcddecb-1"><i class="fas fa-bug"></i>ä¼ ç»Ÿæ¨¡å¼</button></li><li class="tab"><button type="button" data-href="#c3c3b6b8-5d41-479e-88a8-7ffb8fcddecb-2"><i class="fas fa-cannabis"></i>Feedæ¨¡å¼</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c3c3b6b8-5d41-479e-88a8-7ffb8fcddecb-1"><p>å¯¹äºä¼ ç»Ÿçš„æ¨¡å¼çš„å†…å®¹è§£é”ï¼šæˆ‘ä»¬æ˜¯éœ€è¦ç”¨æˆ·å»é€šè¿‡æœç´¢å¼•æ“æˆ–è€…æ˜¯å…¶ä»–çš„æ–¹å¼å»è§£é”æƒ³è¦çœ‹çš„å†…å®¹</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653808641260.png" alt="1653808641260"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c3c3b6b8-5d41-479e-88a8-7ffb8fcddecb-2"><p>å¯¹äºæ–°å‹çš„Feedæµçš„çš„æ•ˆæœï¼šä¸éœ€è¦æˆ‘ä»¬ç”¨æˆ·å†å»æ¨é€ä¿¡æ¯ï¼Œè€Œæ˜¯ç³»ç»Ÿåˆ†æç”¨æˆ·åˆ°åº•æƒ³è¦ä»€ä¹ˆï¼Œç„¶åç›´æ¥æŠŠå†…å®¹æ¨é€ç»™ç”¨æˆ·ï¼Œä»è€Œä½¿ç”¨æˆ·èƒ½å¤Ÿæ›´åŠ çš„èŠ‚çº¦æ—¶é—´ï¼Œä¸ç”¨ä¸»åŠ¨å»å¯»æ‰¾ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653808993693.png" alt="1653808993693"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>Feedæµçš„å®ç°æœ‰ä¸¤ç§æ¨¡å¼ï¼š</p><p>Feedæµäº§å“æœ‰ä¸¤ç§å¸¸è§æ¨¡å¼ï¼š<br>Timelineï¼šä¸åšå†…å®¹ç­›é€‰ï¼Œç®€å•çš„æŒ‰ç…§å†…å®¹å‘å¸ƒæ—¶é—´æ’åºï¼Œå¸¸ç”¨äºå¥½å‹æˆ–å…³æ³¨ã€‚ä¾‹å¦‚æœ‹å‹åœˆ</p><ul><li>ä¼˜ç‚¹ï¼šä¿¡æ¯å…¨é¢ï¼Œä¸ä¼šæœ‰ç¼ºå¤±ã€‚å¹¶ä¸”å®ç°ä¹Ÿç›¸å¯¹ç®€å•</li><li>ç¼ºç‚¹ï¼šä¿¡æ¯å™ªéŸ³è¾ƒå¤šï¼Œç”¨æˆ·ä¸ä¸€å®šæ„Ÿå…´è¶£ï¼Œå†…å®¹è·å–æ•ˆç‡ä½</li></ul><p>æ™ºèƒ½æ’åºï¼šåˆ©ç”¨æ™ºèƒ½ç®—æ³•å±è”½æ‰è¿è§„çš„ã€ç”¨æˆ·ä¸æ„Ÿå…´è¶£çš„å†…å®¹ã€‚æ¨é€ç”¨æˆ·æ„Ÿå…´è¶£ä¿¡æ¯æ¥å¸å¼•ç”¨æˆ·</p><ul><li>ä¼˜ç‚¹ï¼šæŠ•å–‚ç”¨æˆ·æ„Ÿå…´è¶£ä¿¡æ¯ï¼Œç”¨æˆ·ç²˜åº¦å¾ˆé«˜ï¼Œå®¹æ˜“æ²‰è¿·</li><li>ç¼ºç‚¹ï¼šå¦‚æœç®—æ³•ä¸ç²¾å‡†ï¼Œå¯èƒ½èµ·åˆ°åä½œç”¨<br>æœ¬ä¾‹ä¸­çš„ä¸ªäººé¡µé¢ï¼Œæ˜¯åŸºäºå…³æ³¨çš„å¥½å‹æ¥åšFeedæµï¼Œå› æ­¤é‡‡ç”¨Timelineçš„æ¨¡å¼ã€‚è¯¥æ¨¡å¼çš„å®ç°æ–¹æ¡ˆæœ‰ä¸‰ç§ï¼š</li></ul><p>æˆ‘ä»¬æœ¬æ¬¡é’ˆå¯¹å¥½å‹çš„æ“ä½œï¼Œé‡‡ç”¨çš„å°±æ˜¯Timelineçš„æ–¹å¼ï¼Œåªéœ€è¦æ‹¿åˆ°æˆ‘ä»¬å…³æ³¨ç”¨æˆ·çš„ä¿¡æ¯ï¼Œç„¶åæŒ‰ç…§æ—¶é—´æ’åºå³å¯</p><p>ï¼Œå› æ­¤é‡‡ç”¨Timelineçš„æ¨¡å¼ã€‚è¯¥æ¨¡å¼çš„å®ç°æ–¹æ¡ˆæœ‰ä¸‰ç§ï¼š</p><ul><li>æ‹‰æ¨¡å¼</li><li>æ¨æ¨¡å¼</li><li>æ¨æ‹‰ç»“åˆ</li></ul><div class="tabs" id="95619f31-dad8-4bef-9533-b2217ebb6587"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#95619f31-dad8-4bef-9533-b2217ebb6587-1"><i class="fas fa-cat"></i>æ‹‰æ¨¡å¼</button></li><li class="tab"><button type="button" data-href="#95619f31-dad8-4bef-9533-b2217ebb6587-2"><i class="fas fa-horse"></i>æ¨æ¨¡å¼</button></li><li class="tab"><button type="button" data-href="#95619f31-dad8-4bef-9533-b2217ebb6587-3"><i class="fas fa-dove"></i>æ¨æ‹‰ç»“åˆ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="95619f31-dad8-4bef-9533-b2217ebb6587-1"><p><strong>æ‹‰æ¨¡å¼</strong>ï¼šä¹Ÿå«åšè¯»æ‰©æ•£</p><p>è¯¥æ¨¡å¼çš„æ ¸å¿ƒå«ä¹‰å°±æ˜¯ï¼šå½“å¼ ä¸‰å’Œæå››å’Œç‹äº”å‘äº†æ¶ˆæ¯åï¼Œéƒ½ä¼šä¿å­˜åœ¨è‡ªå·±çš„é‚®ç®±ä¸­ï¼Œå‡è®¾èµµå…­è¦è¯»å–ä¿¡æ¯ï¼Œé‚£ä¹ˆä»–ä¼šä»è¯»å–ä»–è‡ªå·±çš„æ”¶ä»¶ç®±ï¼Œæ­¤æ—¶ç³»ç»Ÿä¼šä»ä»–å…³æ³¨çš„äººç¾¤ä¸­ï¼ŒæŠŠä»–å…³æ³¨äººçš„ä¿¡æ¯å…¨éƒ¨éƒ½è¿›è¡Œæ‹‰å–ï¼Œç„¶ååœ¨è¿›è¡Œæ’åº</p><p>ä¼˜ç‚¹ï¼šæ¯”è¾ƒèŠ‚çº¦ç©ºé—´ï¼Œå› ä¸ºèµµå…­åœ¨è¯»ä¿¡æ¯æ—¶ï¼Œå¹¶æ²¡æœ‰é‡å¤è¯»å–ï¼Œè€Œä¸”è¯»å–å®Œä¹‹åå¯ä»¥æŠŠä»–çš„æ”¶ä»¶ç®±è¿›è¡Œæ¸…æ¥šã€‚</p><p>ç¼ºç‚¹ï¼šæ¯”è¾ƒå»¶è¿Ÿï¼Œå½“ç”¨æˆ·è¯»å–æ•°æ®æ—¶æ‰å»å…³æ³¨çš„äººé‡Œè¾¹å»è¯»å–æ•°æ®ï¼Œå‡è®¾ç”¨æˆ·å…³æ³¨äº†å¤§é‡çš„ç”¨æˆ·ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šæ‹‰å–æµ·é‡çš„å†…å®¹ï¼Œå¯¹æœåŠ¡å™¨å‹åŠ›å·¨å¤§ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653809450816.png" alt="1653809450816" style="zoom: 50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="95619f31-dad8-4bef-9533-b2217ebb6587-2"><p><strong>æ¨æ¨¡å¼</strong>ï¼šä¹Ÿå«åšå†™æ‰©æ•£ã€‚</p><p>æ¨æ¨¡å¼æ˜¯æ²¡æœ‰å†™é‚®ç®±çš„ï¼Œå½“å¼ ä¸‰å†™äº†ä¸€ä¸ªå†…å®¹ï¼Œæ­¤æ—¶ä¼šä¸»åŠ¨çš„æŠŠå¼ ä¸‰å†™çš„å†…å®¹å‘é€åˆ°ä»–çš„ç²‰ä¸æ”¶ä»¶ç®±ä¸­å»ï¼Œå‡è®¾æ­¤æ—¶æå››å†æ¥è¯»å–ï¼Œå°±ä¸ç”¨å†å»ä¸´æ—¶æ‹‰å–äº†</p><p>ä¼˜ç‚¹ï¼šæ—¶æ•ˆå¿«ï¼Œä¸ç”¨ä¸´æ—¶æ‹‰å–</p><p>ç¼ºç‚¹ï¼šå†…å­˜å‹åŠ›å¤§ï¼Œå‡è®¾ä¸€ä¸ªå¤§Vå†™ä¿¡æ¯ï¼Œå¾ˆå¤šäººå…³æ³¨ä»–ï¼Œ å°±ä¼šå†™å¾ˆå¤šåˆ†æ•°æ®åˆ°ç²‰ä¸é‚£è¾¹å»</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653809875208.png" alt="1653809875208" style="zoom: 50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="95619f31-dad8-4bef-9533-b2217ebb6587-3"><p><strong>æ¨æ‹‰ç»“åˆæ¨¡å¼</strong>ï¼šä¹Ÿå«åšè¯»å†™æ··åˆï¼Œå…¼å…·æ¨å’Œæ‹‰ä¸¤ç§æ¨¡å¼çš„ä¼˜ç‚¹ã€‚</p><p>æ¨æ‹‰æ¨¡å¼æ˜¯ä¸€ä¸ªæŠ˜ä¸­çš„æ–¹æ¡ˆï¼Œç«™åœ¨å‘ä»¶äººè¿™ä¸€æ®µï¼Œå¦‚æœæ˜¯ä¸ªæ™®é€šçš„äººï¼Œé‚£ä¹ˆæˆ‘ä»¬é‡‡ç”¨å†™æ‰©æ•£çš„æ–¹å¼ï¼Œç›´æ¥æŠŠæ•°æ®å†™å…¥åˆ°ä»–çš„ç²‰ä¸ä¸­å»ï¼Œå› ä¸ºæ™®é€šçš„äººä»–çš„ç²‰ä¸å…³æ³¨é‡æ¯”è¾ƒå°ï¼Œæ‰€ä»¥è¿™æ ·åšæ²¡æœ‰å‹åŠ›ï¼Œå¦‚æœæ˜¯å¤§Vï¼Œé‚£ä¹ˆä»–æ˜¯ç›´æ¥å°†æ•°æ®å…ˆå†™å…¥åˆ°ä¸€ä»½åˆ°å‘ä»¶ç®±é‡Œè¾¹å»ï¼Œç„¶åå†ç›´æ¥å†™ä¸€ä»½åˆ°æ´»è·ƒç²‰ä¸æ”¶ä»¶ç®±é‡Œè¾¹å»ï¼Œç°åœ¨ç«™åœ¨æ”¶ä»¶äººè¿™ç«¯æ¥çœ‹ï¼Œå¦‚æœæ˜¯æ´»è·ƒç²‰ä¸ï¼Œé‚£ä¹ˆå¤§Vå’Œæ™®é€šçš„äººå‘çš„éƒ½ä¼šç›´æ¥å†™å…¥åˆ°è‡ªå·±æ”¶ä»¶ç®±é‡Œè¾¹æ¥ï¼Œè€Œå¦‚æœæ˜¯æ™®é€šçš„ç²‰ä¸ï¼Œç”±äºä»–ä»¬ä¸Šçº¿ä¸æ˜¯å¾ˆé¢‘ç¹ï¼Œæ‰€ä»¥ç­‰ä»–ä»¬ä¸Šçº¿æ—¶ï¼Œå†ä»å‘ä»¶ç®±é‡Œè¾¹å»æ‹‰ä¿¡æ¯ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653812346852.png" alt="1653812346852" style="zoom: 50%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">æ‹‰æ¨¡å¼</th><th style="text-align:center">æ¨æ¨¡å¼</th><th style="text-align:center">æ¨æ‹‰ç»“åˆ</th></tr></thead><tbody><tr><td style="text-align:center">å†™æ¯”ä¾‹</td><td style="text-align:center">ä½</td><td style="text-align:center">é«˜</td><td style="text-align:center">ä¸­</td></tr><tr><td style="text-align:center">è¯»æ¯”ä¾‹</td><td style="text-align:center">é«˜</td><td style="text-align:center">ä½</td><td style="text-align:center">ä¸­</td></tr><tr><td style="text-align:center">ç”¨æˆ·è¯»å–å»¶è¿Ÿ</td><td style="text-align:center">é«˜</td><td style="text-align:center">ä½</td><td style="text-align:center">ä¸­</td></tr><tr><td style="text-align:center">å®ç°éš¾åº¦</td><td style="text-align:center">å¤æ‚</td><td style="text-align:center">ç®€å•</td><td style="text-align:center">å¾ˆå¤æ‚</td></tr><tr><td style="text-align:center">ä½¿ç”¨åœºæ™¯</td><td style="text-align:center">å¾ˆå°‘ä½¿ç”¨</td><td style="text-align:center">ç”¨æˆ·é‡å°‘ï¼Œæ²¡æœ‰å¤§V</td><td style="text-align:center">è¿‡åƒä¸‡çš„ç”¨æˆ·é‡ï¼Œæœ‰å¤§V</td></tr></tbody></table><hr><h3 id="æ¨æ¨¡å¼å®ç°">æ¨æ¨¡å¼å®ç°</h3><p>éœ€æ±‚ï¼š</p><ul><li>ä¿®æ”¹æ–°å¢æ¢åº—ç¬”è®°çš„ä¸šåŠ¡ï¼Œåœ¨ä¿å­˜blogåˆ°æ•°æ®åº“çš„åŒæ—¶ï¼Œæ¨é€åˆ°ç²‰ä¸çš„æ”¶ä»¶ç®±</li><li>æ”¶ä»¶ç®±æ»¡è¶³å¯ä»¥æ ¹æ®æ—¶é—´æˆ³æ’åºï¼Œå¿…é¡»ç”¨Redisçš„æ•°æ®ç»“æ„å®ç°</li><li>æŸ¥è¯¢æ”¶ä»¶ç®±æ•°æ®æ—¶ï¼Œå¯ä»¥å®ç°åˆ†é¡µæŸ¥è¯¢</li></ul><p>Feedæµä¸­çš„æ•°æ®ä¼šä¸æ–­æ›´æ–°ï¼Œæ‰€ä»¥æ•°æ®çš„è§’æ ‡ä¹Ÿåœ¨å˜åŒ–ï¼Œå› æ­¤ä¸èƒ½é‡‡ç”¨ä¼ ç»Ÿçš„åˆ†é¡µæ¨¡å¼ã€‚</p><p>ä¼ ç»Ÿäº†åˆ†é¡µåœ¨feedæµæ˜¯ä¸é€‚ç”¨çš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„æ•°æ®ä¼šéšæ—¶å‘ç”Ÿå˜åŒ–</p><p>å‡è®¾åœ¨t1 æ—¶åˆ»ï¼Œæˆ‘ä»¬å»è¯»å–ç¬¬ä¸€é¡µï¼Œæ­¤æ—¶page = 1 ï¼Œsize = 5 ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‹¿åˆ°çš„å°±æ˜¯10~6 è¿™å‡ æ¡è®°å½•ï¼Œå‡è®¾ç°åœ¨t2æ—¶å€™åˆå‘å¸ƒäº†ä¸€æ¡è®°å½•ï¼Œæ­¤æ—¶t3 æ—¶åˆ»ï¼Œæˆ‘ä»¬æ¥è¯»å–ç¬¬äºŒé¡µï¼Œè¯»å–ç¬¬äºŒé¡µä¼ å…¥çš„å‚æ•°æ˜¯page=2 ï¼Œsize=5 ï¼Œé‚£ä¹ˆæ­¤æ—¶è¯»å–åˆ°çš„ç¬¬äºŒé¡µå®é™…ä¸Šæ˜¯ä»6 å¼€å§‹ï¼Œç„¶åæ˜¯6~2 ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¯»å–åˆ°äº†é‡å¤çš„æ•°æ®ï¼Œæ‰€ä»¥feedæµçš„åˆ†é¡µï¼Œä¸èƒ½é‡‡ç”¨åŸå§‹æ–¹æ¡ˆæ¥åšã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653813047671.png" alt="1653813047671" style="zoom:67%;" /><mark class="hl-label blue">Feedæµçš„æ»šåŠ¨åˆ†é¡µ</mark> <p>æˆ‘ä»¬éœ€è¦è®°å½•æ¯æ¬¡æ“ä½œçš„æœ€åä¸€æ¡ï¼Œç„¶åä»è¿™ä¸ªä½ç½®å¼€å§‹å»è¯»å–æ•°æ®</p><p>ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬ä»t1æ—¶åˆ»å¼€å§‹ï¼Œæ‹¿ç¬¬ä¸€é¡µæ•°æ®ï¼Œæ‹¿åˆ°äº†10~6ï¼Œç„¶åè®°å½•ä¸‹å½“å‰æœ€åä¸€æ¬¡æ‹¿å–çš„è®°å½•ï¼Œå°±æ˜¯6ï¼Œt2æ—¶åˆ»å‘å¸ƒäº†æ–°çš„è®°å½•ï¼Œæ­¤æ—¶è¿™ä¸ª11æ”¾åˆ°æœ€é¡¶ä¸Šï¼Œä½†æ˜¯ä¸ä¼šå½±å“æˆ‘ä»¬ä¹‹å‰è®°å½•çš„6ï¼Œæ­¤æ—¶t3æ—¶åˆ»æ¥æ‹¿ç¬¬äºŒé¡µï¼Œç¬¬äºŒé¡µè¿™ä¸ªæ—¶å€™æ‹¿æ•°æ®ï¼Œè¿˜æ˜¯ä»6åä¸€ç‚¹çš„5å»æ‹¿ï¼Œå°±æ‹¿åˆ°äº†5-1çš„è®°å½•ã€‚æˆ‘ä»¬è¿™ä¸ªåœ°æ–¹å¯ä»¥é‡‡ç”¨sortedSetæ¥åšï¼Œå¯ä»¥è¿›è¡ŒèŒƒå›´æŸ¥è¯¢ï¼Œå¹¶ä¸”è¿˜å¯ä»¥è®°å½•å½“å‰è·å–æ•°æ®æ—¶é—´æˆ³æœ€å°å€¼ï¼Œå°±å¯ä»¥å®ç°æ»šåŠ¨åˆ†é¡µäº†</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653813462834.png" alt="1653813462834" style="zoom:67%;" /><p>æ ¸å¿ƒçš„æ„æ€ï¼šå°±æ˜¯æˆ‘ä»¬åœ¨ä¿å­˜å®Œæ¢åº—ç¬”è®°åï¼Œè·å¾—åˆ°å½“å‰ç¬”è®°çš„ç²‰ä¸ï¼Œç„¶åæŠŠæ•°æ®æ¨é€åˆ°ç²‰ä¸çš„redisä¸­å»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    blog.setUserId(user.getId());</span><br><span class="line">    <span class="comment">// 2.ä¿å­˜æ¢åº—ç¬”è®°</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(blog);</span><br><span class="line">    <span class="keyword">if</span>(!isSuccess)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ–°å¢ç¬”è®°å¤±è´¥!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.æŸ¥è¯¢ç¬”è®°ä½œè€…çš„æ‰€æœ‰ç²‰ä¸ select * from tb_follow where follow_user_id = ?</span></span><br><span class="line">    List&lt;Follow&gt; follows = followService.query().eq(<span class="string">&quot;follow_user_id&quot;</span>, user.getId()).list();</span><br><span class="line">    <span class="comment">// 4.æ¨é€ç¬”è®°idç»™æ‰€æœ‰ç²‰ä¸</span></span><br><span class="line">    <span class="keyword">for</span> (Follow follow : follows) &#123;</span><br><span class="line">        <span class="comment">// 4.1.è·å–ç²‰ä¸id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> follow.getUserId();</span><br><span class="line">        <span class="comment">// 4.2.æ¨é€</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> FEED_KEY + userId;</span><br><span class="line">        stringRedisTemplate.opsForZSet().add(key, blog.getId().toString(), System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.è¿”å›id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶é‚®ç®±">å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶é‚®ç®±</h3><p>éœ€æ±‚ï¼šåœ¨ä¸ªäººä¸»é¡µçš„â€œå…³æ³¨â€å¡ç‰‡ä¸­ï¼ŒæŸ¥è¯¢å¹¶å±•ç¤ºæ¨é€çš„Blogä¿¡æ¯ï¼š</p><p>å…·ä½“æ“ä½œå¦‚ä¸‹ï¼š</p><p>1ã€æ¯æ¬¡æŸ¥è¯¢å®Œæˆåï¼Œæˆ‘ä»¬è¦åˆ†æå‡ºæŸ¥è¯¢å‡ºæ•°æ®çš„æœ€å°æ—¶é—´æˆ³ï¼Œè¿™ä¸ªå€¼ä¼šä½œä¸ºä¸‹ä¸€æ¬¡æŸ¥è¯¢çš„æ¡ä»¶</p><p>2ã€æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸ä¸Šä¸€æ¬¡æŸ¥è¯¢ç›¸åŒçš„æŸ¥è¯¢ä¸ªæ•°ä½œä¸ºåç§»é‡ï¼Œä¸‹æ¬¡æŸ¥è¯¢æ—¶ï¼Œè·³è¿‡è¿™äº›æŸ¥è¯¢è¿‡çš„æ•°æ®ï¼Œæ‹¿åˆ°æˆ‘ä»¬éœ€è¦çš„æ•°æ®</p><p>ç»¼ä¸Šï¼šæˆ‘ä»¬çš„è¯·æ±‚å‚æ•°ä¸­å°±éœ€è¦æºå¸¦ lastIdï¼šä¸Šä¸€æ¬¡æŸ¥è¯¢çš„æœ€å°æ—¶é—´æˆ³å’Œåç§»é‡è¿™ä¸¤ä¸ªå‚æ•°ã€‚</p><p>è¿™ä¸¤ä¸ªå‚æ•°ç¬¬ä¸€æ¬¡ä¼šç”±å‰ç«¯æ¥æŒ‡å®šï¼Œä»¥åçš„æŸ¥è¯¢å°±æ ¹æ®åå°ç»“æœä½œä¸ºæ¡ä»¶ï¼Œå†æ¬¡ä¼ é€’åˆ°åå°ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653819821591.png" alt="1653819821591" style="zoom:67%;" /><div class="tabs" id="cdf486cb-451e-45f1-aa05-c5341900e3aa"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#cdf486cb-451e-45f1-aa05-c5341900e3aa-1"><i class="fas fa-award"></i>å®šä¹‰è¿”å›å€¼å®ä½“ç±»</button></li><li class="tab"><button type="button" data-href="#cdf486cb-451e-45f1-aa05-c5341900e3aa-2"><i class="fas fa-baseball-ball"></i>BlogController</button></li><li class="tab"><button type="button" data-href="#cdf486cb-451e-45f1-aa05-c5341900e3aa-3"><i class="fas fa-bone"></i>BlogServiceImpl</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="cdf486cb-451e-45f1-aa05-c5341900e3aa-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScrollResult</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;?&gt; list;</span><br><span class="line">    <span class="keyword">private</span> Long minTime;</span><br><span class="line">    <span class="keyword">private</span> Integer offset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cdf486cb-451e-45f1-aa05-c5341900e3aa-2"><p>æ³¨æ„ï¼šRequestParam è¡¨ç¤ºæ¥å—urlåœ°å€æ ä¼ å‚çš„æ³¨è§£ï¼Œå½“æ–¹æ³•ä¸Šå‚æ•°çš„åç§°å’Œurlåœ°å€æ ä¸ç›¸åŒæ—¶ï¼Œå¯ä»¥é€šè¿‡RequestParam æ¥è¿›è¡ŒæŒ‡å®š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/of/follow&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogOfFollow</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@RequestParam(&quot;lastId&quot;)</span> Long max, <span class="meta">@RequestParam(value = &quot;offset&quot;, defaultValue = &quot;0&quot;)</span> Integer offset)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> blogService.queryBlogOfFollow(max, offset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cdf486cb-451e-45f1-aa05-c5341900e3aa-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogOfFollow</span><span class="params">(Long max, Integer offset)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.æŸ¥è¯¢æ”¶ä»¶ç®± ZREVRANGEBYSCORE key Max Min LIMIT offset count</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> FEED_KEY + userId;</span><br><span class="line">    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples = stringRedisTemplate.opsForZSet()</span><br><span class="line">        .reverseRangeByScoreWithScores(key, <span class="number">0</span>, max, offset, <span class="number">2</span>);</span><br><span class="line">    <span class="comment">// 3.éç©ºåˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (typedTuples == <span class="literal">null</span> || typedTuples.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.è§£ææ•°æ®ï¼šblogIdã€minTimeï¼ˆæ—¶é—´æˆ³ï¼‰ã€offset</span></span><br><span class="line">    List&lt;Long&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(typedTuples.size());</span><br><span class="line">    <span class="type">long</span> <span class="variable">minTime</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// 2</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">os</span> <span class="operator">=</span> <span class="number">1</span>; <span class="comment">// 2</span></span><br><span class="line">    <span class="keyword">for</span> (ZSetOperations.TypedTuple&lt;String&gt; tuple : typedTuples) &#123; <span class="comment">// 5 4 4 2 2</span></span><br><span class="line">        <span class="comment">// 4.1.è·å–id</span></span><br><span class="line">        ids.add(Long.valueOf(tuple.getValue()));</span><br><span class="line">        <span class="comment">// 4.2.è·å–åˆ†æ•°(æ—¶é—´æˆ³ï¼‰</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> tuple.getScore().longValue();</span><br><span class="line">        <span class="keyword">if</span>(time == minTime)&#123;</span><br><span class="line">            os++;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            minTime = time;</span><br><span class="line">            os = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">os = minTime == max ? os : os + offset;</span><br><span class="line">    <span class="comment">// 5.æ ¹æ®idæŸ¥è¯¢blog</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    List&lt;Blog&gt; blogs = query().in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Blog blog : blogs) &#123;</span><br><span class="line">        <span class="comment">// 5.1.æŸ¥è¯¢blogæœ‰å…³çš„ç”¨æˆ·</span></span><br><span class="line">        queryBlogUser(blog);</span><br><span class="line">        <span class="comment">// 5.2.æŸ¥è¯¢blogæ˜¯å¦è¢«ç‚¹èµ</span></span><br><span class="line">        isBlogLiked(blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6.å°è£…å¹¶è¿”å›</span></span><br><span class="line">    <span class="type">ScrollResult</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScrollResult</span>();</span><br><span class="line">    r.setList(blogs);</span><br><span class="line">    r.setOffset(os);</span><br><span class="line">    r.setMinTime(minTime);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.ok(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><hr><h2 id="é™„è¿‘å•†æˆ·-GEO">é™„è¿‘å•†æˆ·-GEO</h2><h3 id="GEOæ•°æ®ç»“æ„çš„åŸºæœ¬ç”¨æ³•">GEOæ•°æ®ç»“æ„çš„åŸºæœ¬ç”¨æ³•</h3><p>GEOå°±æ˜¯Geolocationçš„ç®€å†™å½¢å¼ï¼Œä»£è¡¨åœ°ç†åæ ‡ã€‚Redisåœ¨3.2ç‰ˆæœ¬ä¸­åŠ å…¥äº†å¯¹GEOçš„æ”¯æŒï¼Œå…è®¸å­˜å‚¨åœ°ç†åæ ‡ä¿¡æ¯ï¼Œå¸®åŠ©æˆ‘ä»¬æ ¹æ®ç»çº¬åº¦æ¥æ£€ç´¢æ•°æ®ã€‚å¸¸è§çš„å‘½ä»¤æœ‰ï¼š</p><ul><li>GEOADDï¼šæ·»åŠ ä¸€ä¸ªåœ°ç†ç©ºé—´ä¿¡æ¯ï¼ŒåŒ…å«ï¼šç»åº¦ï¼ˆlongitudeï¼‰ã€çº¬åº¦ï¼ˆlatitudeï¼‰ã€å€¼ï¼ˆmemberï¼‰</li><li>GEODISTï¼šè®¡ç®—æŒ‡å®šçš„ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»å¹¶è¿”å›</li><li>GEOHASHï¼šå°†æŒ‡å®šmemberçš„åæ ‡è½¬ä¸ºhashå­—ç¬¦ä¸²å½¢å¼å¹¶è¿”å›</li><li>GEOPOSï¼šè¿”å›æŒ‡å®šmemberçš„åæ ‡</li><li>GEORADIUSï¼šæŒ‡å®šåœ†å¿ƒã€åŠå¾„ï¼Œæ‰¾åˆ°è¯¥åœ†å†…åŒ…å«çš„æ‰€æœ‰memberï¼Œå¹¶æŒ‰ç…§ä¸åœ†å¿ƒä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚6.ä»¥åå·²åºŸå¼ƒ</li><li>GEOSEARCHï¼šåœ¨æŒ‡å®šèŒƒå›´å†…æœç´¢memberï¼Œå¹¶æŒ‰ç…§ä¸æŒ‡å®šç‚¹ä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚èŒƒå›´å¯ä»¥æ˜¯åœ†å½¢æˆ–çŸ©å½¢ã€‚6.2.æ–°åŠŸèƒ½</li><li>GEOSEARCHSTOREï¼šä¸GEOSEARCHåŠŸèƒ½ä¸€è‡´ï¼Œä¸è¿‡å¯ä»¥æŠŠç»“æœå­˜å‚¨åˆ°ä¸€ä¸ªæŒ‡å®šçš„keyã€‚ 6.2.æ–°åŠŸèƒ½</li></ul><mark class="hl-label blue">ç»ƒä¹ Redisçš„GEOåŠŸèƒ½</mark> <div class="tabs" id="be3f2628-88ce-4261-99aa-adfabd0d52aa"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#be3f2628-88ce-4261-99aa-adfabd0d52aa-1"><i class="fas fa-seedling"></i>éœ€æ±‚</button></li><li class="tab"><button type="button" data-href="#be3f2628-88ce-4261-99aa-adfabd0d52aa-2"><i class="fas fa-leaf"></i>æ·»åŠ æ•°æ®</button></li><li class="tab"><button type="button" data-href="#be3f2628-88ce-4261-99aa-adfabd0d52aa-3"><i class="fab fa-apple"></i>è®¡ç®—è·ç¦»</button></li><li class="tab"><button type="button" data-href="#be3f2628-88ce-4261-99aa-adfabd0d52aa-4"><i class="fas fa-tree"></i>æœç´¢</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="be3f2628-88ce-4261-99aa-adfabd0d52aa-1"><p>æ·»åŠ ä¸‹é¢å‡ æ¡æ•°æ®ï¼š</p><ul><li><p>åŒ—äº¬å—ç«™ï¼ˆ 116.378248 39.865275 ï¼‰</p></li><li><p>åŒ—äº¬ç«™ï¼ˆ 116.42803 39.903738 ï¼‰</p></li><li><p>åŒ—äº¬è¥¿ç«™ï¼ˆ 116.322287 39.893729 ï¼‰</p></li></ul><p>è®¡ç®—åŒ—äº¬è¥¿ç«™åˆ°åŒ—äº¬ç«™çš„è·ç¦»<br>æœç´¢å¤©å®‰é—¨ï¼ˆ 116.397904 39.909005 ï¼‰é™„è¿‘10kmå†…çš„æ‰€æœ‰ç«è½¦ç«™ï¼Œå¹¶æŒ‰ç…§è·ç¦»å‡åºæ’åº</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="be3f2628-88ce-4261-99aa-adfabd0d52aa-2"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt;GEOADD g1 116.378248 39.865275 bjn 116.42803 39.903738 bjz 116.322287 39.893729 bjx</span><br><span class="line">3</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> g1</span><br><span class="line">zset</span><br></pre></td></tr></table></figure><p>å…¶å†…éƒ¨å­˜å‚¨ä¸ºsortedSet</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230612083827052.png" alt="image-20230612083827052"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="be3f2628-88ce-4261-99aa-adfabd0d52aa-3"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEODIST g1 bjx bjz</span><br><span class="line"><span class="string">&quot;9091.5648&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; GEODIST g1 bjx bjz km</span><br><span class="line"><span class="string">&quot;9.0916&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="be3f2628-88ce-4261-99aa-adfabd0d52aa-4"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEOSEARCH g1 FROMLONLAT 116.397904 39.909005 BYRADIUS 10 km WITHDIST</span><br><span class="line">1) 1) <span class="string">&quot;bjz&quot;</span></span><br><span class="line">   2) <span class="string">&quot;2.6361&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;bjn&quot;</span></span><br><span class="line">   2) <span class="string">&quot;5.1452&quot;</span></span><br><span class="line">3) 1) <span class="string">&quot;bjx&quot;</span></span><br><span class="line">   2) <span class="string">&quot;6.6723&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO">å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO</h3><div class="tabs" id="9532e0ee-db13-4865-b062-daed8d75507c"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#9532e0ee-db13-4865-b062-daed8d75507c-1"><i class="fas fa-award"></i>å…·ä½“åœºæ™¯è¯´æ˜</button></li><li class="tab"><button type="button" data-href="#9532e0ee-db13-4865-b062-daed8d75507c-2"><i class="fas fa-baseball-ball"></i>å°†æ•°æ®è¿›è¡Œåˆ†ç»„</button></li><li class="tab"><button type="button" data-href="#9532e0ee-db13-4865-b062-daed8d75507c-3"><i class="fas fa-bone"></i>ä»£ç å®ç°å¯¼å…¥</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="9532e0ee-db13-4865-b062-daed8d75507c-1"><p>å½“æˆ‘ä»¬ç‚¹å‡»ç¾é£Ÿä¹‹åï¼Œä¼šå‡ºç°ä¸€ç³»åˆ—çš„å•†å®¶ï¼Œå•†å®¶ä¸­å¯ä»¥æŒ‰ç…§å¤šç§æ’åºæ–¹å¼ï¼Œæˆ‘ä»¬æ­¤æ—¶å…³æ³¨çš„æ˜¯è·ç¦»ï¼Œè¿™ä¸ªåœ°æ–¹å°±éœ€è¦ä½¿ç”¨åˆ°æˆ‘ä»¬çš„GEOï¼Œå‘åå°ä¼ å…¥å½“å‰appæ”¶é›†çš„åœ°å€(æˆ‘ä»¬æ­¤å¤„æ˜¯å†™æ­»çš„) ï¼Œä»¥å½“å‰åæ ‡ä½œä¸ºåœ†å¿ƒï¼ŒåŒæ—¶ç»‘å®šç›¸åŒçš„åº—å®¶ç±»å‹typeï¼Œä»¥åŠåˆ†é¡µä¿¡æ¯ï¼ŒæŠŠè¿™å‡ ä¸ªæ¡ä»¶ä¼ å…¥åå°ï¼Œåå°æŸ¥è¯¢å‡ºå¯¹åº”çš„æ•°æ®å†è¿”å›ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653822036941.png" alt="1653822036941" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9532e0ee-db13-4865-b062-daed8d75507c-2"><p>æˆ‘ä»¬è¦åšçš„äº‹æƒ…æ˜¯ï¼šå°†æ•°æ®åº“è¡¨ä¸­çš„æ•°æ®å¯¼å…¥åˆ°redisä¸­å»ï¼Œredisä¸­çš„GEOï¼ŒGEOåœ¨redisä¸­å°±ä¸€ä¸ªmenberå’Œä¸€ä¸ªç»çº¬åº¦ï¼Œæˆ‘ä»¬æŠŠxå’Œyè½´ä¼ å…¥åˆ°redisåšçš„ç»çº¬åº¦ä½ç½®å»ï¼Œä½†æˆ‘ä»¬ä¸èƒ½æŠŠæ‰€æœ‰çš„æ•°æ®éƒ½æ”¾å…¥åˆ°menberä¸­å»ï¼Œæ¯•ç«Ÿä½œä¸ºredisæ˜¯ä¸€ä¸ªå†…å­˜çº§æ•°æ®åº“ï¼Œå¦‚æœå­˜æµ·é‡æ•°æ®ï¼Œredisè¿˜æ˜¯åŠ›ä¸ä»å¿ƒï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™ä¸ªåœ°æ–¹å­˜å‚¨ä»–çš„idå³å¯ã€‚</p><p>ä½†æ˜¯è¿™ä¸ªæ—¶å€™è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨redisä¸­å¹¶æ²¡æœ‰å­˜å‚¨typeï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•æ ¹æ®typeæ¥å¯¹æ•°æ®è¿›è¡Œç­›é€‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŒ‰ç…§å•†æˆ·ç±»å‹åšåˆ†ç»„ï¼Œç±»å‹ç›¸åŒçš„å•†æˆ·ä½œä¸ºåŒä¸€ç»„ï¼Œä»¥typeIdä¸ºkeyå­˜å…¥åŒä¸€ä¸ªGEOé›†åˆä¸­å³å¯</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653822021827.png" alt="1653822021827" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9532e0ee-db13-4865-b062-daed8d75507c-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">loadShopData</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢åº—é“ºä¿¡æ¯</span></span><br><span class="line">    List&lt;Shop&gt; list = shopService.list();</span><br><span class="line">    <span class="comment">// 2.æŠŠåº—é“ºåˆ†ç»„ï¼ŒæŒ‰ç…§typeIdåˆ†ç»„ï¼ŒtypeIdä¸€è‡´çš„æ”¾åˆ°ä¸€ä¸ªé›†åˆ</span></span><br><span class="line">    Map&lt;Long, List&lt;Shop&gt;&gt; map = list.stream().collect(Collectors.groupingBy(Shop::getTypeId));</span><br><span class="line">    <span class="comment">// 3.åˆ†æ‰¹å®Œæˆå†™å…¥Redis</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; entry : map.entrySet()) &#123;</span><br><span class="line">        <span class="comment">// 3.1.è·å–ç±»å‹id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">typeId</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SHOP_GEO_KEY + typeId;</span><br><span class="line">        <span class="comment">// 3.2.è·å–åŒç±»å‹çš„åº—é“ºçš„é›†åˆ</span></span><br><span class="line">        List&lt;Shop&gt; value = entry.getValue();</span><br><span class="line">        List&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; locations = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(value.size());</span><br><span class="line">        <span class="comment">// 3.3.å†™å…¥redis GEOADD key ç»åº¦ çº¬åº¦ member</span></span><br><span class="line">        <span class="keyword">for</span> (Shop shop : value) &#123;</span><br><span class="line">            <span class="comment">// stringRedisTemplate.opsForGeo().add(key, new Point(shop.getX(), shop.getY()), shop.getId().toString());</span></span><br><span class="line">            locations.add(<span class="keyword">new</span> <span class="title class_">RedisGeoCommands</span>.GeoLocation&lt;&gt;(</span><br><span class="line">                    shop.getId().toString(),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Point</span>(shop.getX(), shop.getY())</span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line">        stringRedisTemplate.opsForGeo().add(key, locations);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½">å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½</h3><div class="tabs" id="2a724b43-d390-4eb3-b4bb-dd8fafbbd2b1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2a724b43-d390-4eb3-b4bb-dd8fafbbd2b1-1"><i class="fas fa-bug"></i>ä¿®æ”¹pomæ–‡ä»¶</button></li><li class="tab"><button type="button" data-href="#2a724b43-d390-4eb3-b4bb-dd8fafbbd2b1-2"><i class="fas fa-cannabis"></i>ShopController</button></li><li class="tab"><button type="button" data-href="#2a724b43-d390-4eb3-b4bb-dd8fafbbd2b1-3"><i class="fas fa-candy-cane"></i>ShopServiceImpl</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2a724b43-d390-4eb3-b4bb-dd8fafbbd2b1-1"><p>SpringDataRedisçš„2.3.9ç‰ˆæœ¬å¹¶ä¸æ”¯æŒRedis 6.2æä¾›çš„GEOSEARCHå‘½ä»¤ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æç¤ºå…¶ç‰ˆæœ¬ï¼Œä¿®æ”¹è‡ªå·±çš„POM</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2a724b43-d390-4eb3-b4bb-dd8fafbbd2b1-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/of/type&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopByType</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(&quot;typeId&quot;)</span> Integer typeId,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;x&quot;, required = false)</span> Double x,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;y&quot;, required = false)</span> Double y</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> shopService.queryShopByType(typeId, current, x, y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2a724b43-d390-4eb3-b4bb-dd8fafbbd2b1-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryShopByType</span><span class="params">(Integer typeId, Integer current, Double x, Double y)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.åˆ¤æ–­æ˜¯å¦éœ€è¦æ ¹æ®åæ ‡æŸ¥è¯¢</span></span><br><span class="line">        <span class="keyword">if</span> (x == <span class="literal">null</span> || y == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// ä¸éœ€è¦åæ ‡æŸ¥è¯¢ï¼ŒæŒ‰æ•°æ®åº“æŸ¥è¯¢</span></span><br><span class="line">            Page&lt;Shop&gt; page = query()</span><br><span class="line">                    .eq(<span class="string">&quot;type_id&quot;</span>, typeId)</span><br><span class="line">                    .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));</span><br><span class="line">            <span class="comment">// è¿”å›æ•°æ®</span></span><br><span class="line">            <span class="keyword">return</span> Result.ok(page.getRecords());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.è®¡ç®—åˆ†é¡µå‚æ•°</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">from</span> <span class="operator">=</span> (current - <span class="number">1</span>) * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line">        <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> current * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.æŸ¥è¯¢redisã€æŒ‰ç…§è·ç¦»æ’åºã€åˆ†é¡µã€‚ç»“æœï¼šshopIdã€distance</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SHOP_GEO_KEY + typeId;</span><br><span class="line">        GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo() <span class="comment">// GEOSEARCH key BYLONLAT x y BYRADIUS 10 WITHDISTANCE</span></span><br><span class="line">                .search(</span><br><span class="line">                        key,</span><br><span class="line">                        GeoReference.fromCoordinate(x, y),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Distance</span>(<span class="number">5000</span>),</span><br><span class="line">                        RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs().includeDistance().limit(end)</span><br><span class="line">                );</span><br><span class="line">        <span class="comment">// 4.è§£æå‡ºid</span></span><br><span class="line">        <span class="keyword">if</span> (results == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; list = results.getContent();</span><br><span class="line">        <span class="keyword">if</span> (list.size() &lt;= from) &#123;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰ä¸‹ä¸€é¡µäº†ï¼Œç»“æŸ</span></span><br><span class="line">            <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.1.æˆªå– from ~ endçš„éƒ¨åˆ†</span></span><br><span class="line">        List&lt;Long&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(list.size());</span><br><span class="line">        Map&lt;String, Distance&gt; distanceMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(list.size());</span><br><span class="line">        list.stream().skip(from).forEach(result -&gt; &#123;</span><br><span class="line">            <span class="comment">// 4.2.è·å–åº—é“ºid</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">shopIdStr</span> <span class="operator">=</span> result.getContent().getName();</span><br><span class="line">            ids.add(Long.valueOf(shopIdStr));</span><br><span class="line">            <span class="comment">// 4.3.è·å–è·ç¦»</span></span><br><span class="line">            <span class="type">Distance</span> <span class="variable">distance</span> <span class="operator">=</span> result.getDistance();</span><br><span class="line">            distanceMap.put(shopIdStr, distance);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 5.æ ¹æ®idæŸ¥è¯¢Shop</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">        List&lt;Shop&gt; shops = query().in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line">        <span class="keyword">for</span> (Shop shop : shops) &#123;</span><br><span class="line">            shop.setDistance(distanceMap.get(shop.getId().toString()).getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 6.è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(shops);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="ç”¨æˆ·ç­¾åˆ°-BitMap">ç”¨æˆ·ç­¾åˆ°-BitMap</h2><h3 id="BitMapåŠŸèƒ½æ¼”ç¤º">BitMapåŠŸèƒ½æ¼”ç¤º</h3><p>æˆ‘ä»¬é’ˆå¯¹ç­¾åˆ°åŠŸèƒ½å®Œå…¨å¯ä»¥é€šè¿‡mysqlæ¥å®Œæˆï¼Œæ¯”å¦‚è¯´ä»¥ä¸‹è¿™å¼ è¡¨</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653823145495.png" alt="1653823145495"></p><p>ç”¨æˆ·ä¸€æ¬¡ç­¾åˆ°ï¼Œå°±æ˜¯ä¸€æ¡è®°å½•ï¼Œå‡å¦‚æœ‰1000ä¸‡ç”¨æˆ·ï¼Œå¹³å‡æ¯äººæ¯å¹´ç­¾åˆ°æ¬¡æ•°ä¸º10æ¬¡ï¼Œåˆ™è¿™å¼ è¡¨ä¸€å¹´çš„æ•°æ®é‡ä¸º 1äº¿æ¡</p><p>æ¯ç­¾åˆ°ä¸€æ¬¡éœ€è¦ä½¿ç”¨ï¼ˆ8 + 8 + 1 + 1 + 3 + 1ï¼‰å…±22 å­—èŠ‚çš„å†…å­˜ï¼Œä¸€ä¸ªæœˆåˆ™æœ€å¤šéœ€è¦600å¤šå­—èŠ‚</p><p>æˆ‘ä»¬å¦‚ä½•èƒ½å¤Ÿç®€åŒ–ä¸€ç‚¹å‘¢ï¼Ÿå…¶å®å¯ä»¥è€ƒè™‘å°æ—¶å€™ä¸€ä¸ªæŒºå¸¸è§çš„æ–¹æ¡ˆï¼Œå°±æ˜¯å°æ—¶å€™ï¼Œå’±ä»¬å‡†å¤‡ä¸€å¼ å°å°çš„å¡ç‰‡ï¼Œä½ åªè¦ç­¾åˆ°å°±æ‰“ä¸Šä¸€ä¸ªå‹¾ï¼Œæˆ‘æœ€ååˆ¤æ–­ä½ æ˜¯å¦ç­¾åˆ°ï¼Œå…¶å®åªéœ€è¦åˆ°å°å¡ç‰‡ä¸Šçœ‹ä¸€çœ‹å°±çŸ¥é“äº†</p><p>æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ç±»ä¼¼è¿™æ ·çš„æ–¹æ¡ˆæ¥å®ç°æˆ‘ä»¬çš„ç­¾åˆ°éœ€æ±‚ã€‚</p><p>æˆ‘ä»¬æŒ‰æœˆæ¥ç»Ÿè®¡ç”¨æˆ·ç­¾åˆ°ä¿¡æ¯ï¼Œç­¾åˆ°è®°å½•ä¸º1ï¼Œæœªç­¾åˆ°åˆ™è®°å½•ä¸º0.</p><p>æŠŠæ¯ä¸€ä¸ªbitä½å¯¹åº”å½“æœˆçš„æ¯ä¸€å¤©ï¼Œå½¢æˆäº†æ˜ å°„å…³ç³»ã€‚ç”¨0å’Œ1æ ‡ç¤ºä¸šåŠ¡çŠ¶æ€ï¼Œè¿™ç§æ€è·¯å°±ç§°ä¸ºä½å›¾ï¼ˆBitMapï¼‰ã€‚è¿™æ ·æˆ‘ä»¬å°±ç”¨æå°çš„ç©ºé—´ï¼Œæ¥å®ç°äº†å¤§é‡æ•°æ®çš„è¡¨ç¤º</p><p>Redisä¸­æ˜¯åˆ©ç”¨stringç±»å‹æ•°æ®ç»“æ„å®ç°BitMapï¼Œå› æ­¤æœ€å¤§ä¸Šé™æ˜¯512Mï¼Œè½¬æ¢ä¸ºbitåˆ™æ˜¯ 2^32ä¸ªbitä½ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653824498278.png" alt="1653824498278"></p><p>BitMapçš„æ“ä½œå‘½ä»¤æœ‰ï¼š</p><ul><li>SETBITï¼šå‘æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰å­˜å…¥ä¸€ä¸ª0æˆ–1</li><li>GETBIT ï¼šè·å–æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰çš„bitå€¼</li><li>BITCOUNT ï¼šç»Ÿè®¡BitMapä¸­å€¼ä¸º1çš„bitä½çš„æ•°é‡</li><li>BITFIELD ï¼šæ“ä½œï¼ˆæŸ¥è¯¢ã€ä¿®æ”¹ã€è‡ªå¢ï¼‰BitMapä¸­bitæ•°ç»„ä¸­çš„æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰çš„å€¼</li><li>BITFIELD_RO ï¼šè·å–BitMapä¸­bitæ•°ç»„ï¼Œå¹¶ä»¥åè¿›åˆ¶å½¢å¼è¿”å›</li><li>BITOP ï¼šå°†å¤šä¸ªBitMapçš„ç»“æœåšä½è¿ç®—ï¼ˆä¸ ã€æˆ–ã€å¼‚æˆ–ï¼‰</li><li>BITPOS ï¼šæŸ¥æ‰¾bitæ•°ç»„ä¸­æŒ‡å®šèŒƒå›´å†…ç¬¬ä¸€ä¸ª0æˆ–1å‡ºç°çš„ä½ç½®</li></ul><hr><h3 id="ç­¾åˆ°åŠŸèƒ½">ç­¾åˆ°åŠŸèƒ½</h3><div class="tabs" id="d58e03cd-0d6f-440a-b95c-765f4d71de34"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d58e03cd-0d6f-440a-b95c-765f4d71de34-1"><i class="fas fa-atom"></i>éœ€æ±‚</button></li><li class="tab"><button type="button" data-href="#d58e03cd-0d6f-440a-b95c-765f4d71de34-2"><i class="far fa-sun"></i>UserController</button></li><li class="tab"><button type="button" data-href="#d58e03cd-0d6f-440a-b95c-765f4d71de34-3"><i class="fas fa-wind"></i>UserServiceImpl</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d58e03cd-0d6f-440a-b95c-765f4d71de34-1"><p>éœ€æ±‚ï¼šå®ç°ç­¾åˆ°æ¥å£ï¼Œå°†å½“å‰ç”¨æˆ·å½“å¤©ç­¾åˆ°ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</p><p>æ€è·¯ï¼šæˆ‘ä»¬å¯ä»¥æŠŠå¹´å’Œæœˆä½œä¸ºbitMapçš„keyï¼Œç„¶åä¿å­˜åˆ°ä¸€ä¸ªbitMapä¸­ï¼Œæ¯æ¬¡ç­¾åˆ°å°±åˆ°å¯¹åº”çš„ä½ä¸ŠæŠŠæ•°å­—ä»0å˜æˆ1ï¼Œåªè¦å¯¹åº”æ˜¯1ï¼Œå°±è¡¨æ˜è¯´æ˜è¿™ä¸€å¤©å·²ç»ç­¾åˆ°äº†ï¼Œåä¹‹åˆ™æ²¡æœ‰ç­¾åˆ°ã€‚</p><p>æˆ‘ä»¬é€šè¿‡æ¥å£æ–‡æ¡£å‘ç°ï¼Œæ­¤æ¥å£å¹¶æ²¡æœ‰ä¼ é€’ä»»ä½•çš„å‚æ•°ï¼Œæ²¡æœ‰å‚æ•°æ€ä¹ˆç¡®å®æ˜¯å“ªä¸€å¤©ç­¾åˆ°å‘¢ï¼Ÿè¿™ä¸ªå¾ˆå®¹æ˜“ï¼Œå¯ä»¥é€šè¿‡åå°ä»£ç ç›´æ¥è·å–å³å¯ï¼Œç„¶ååˆ°å¯¹åº”çš„åœ°å€ä¸Šå»ä¿®æ”¹bitMapã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653833970361.png" alt="1653833970361" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d58e03cd-0d6f-440a-b95c-765f4d71de34-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/sign&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> userService.sign();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d58e03cd-0d6f-440a-b95c-765f4d71de34-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.è·å–æ—¥æœŸ</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">// 3.æ‹¼æ¥key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">keySuffix</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">// 4.è·å–ä»Šå¤©æ˜¯æœ¬æœˆçš„ç¬¬å‡ å¤©</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dayOfMonth</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">    <span class="comment">// 5.å†™å…¥Redis SETBIT key offset 1</span></span><br><span class="line">    stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="ç­¾åˆ°ç»Ÿè®¡">ç­¾åˆ°ç»Ÿè®¡</h3><div class="tabs" id="ab69da0a-f994-436f-ae40-68f5398abfc0"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ab69da0a-f994-436f-ae40-68f5398abfc0-1"><i class="fas fa-award"></i>é—®é¢˜åˆ†æ</button></li><li class="tab"><button type="button" data-href="#ab69da0a-f994-436f-ae40-68f5398abfc0-2"><i class="fas fa-baseball-ball"></i>UserController</button></li><li class="tab"><button type="button" data-href="#ab69da0a-f994-436f-ae40-68f5398abfc0-3"><i class="fas fa-bone"></i>UserServiceImpl</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ab69da0a-f994-436f-ae40-68f5398abfc0-1"><blockquote><p>é—®é¢˜1ï¼šä»€ä¹ˆå«åšè¿ç»­ç­¾åˆ°å¤©æ•°ï¼Ÿ</p></blockquote><p>ä»æœ€åä¸€æ¬¡ç­¾åˆ°å¼€å§‹å‘å‰ç»Ÿè®¡ï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€æ¬¡æœªç­¾åˆ°ä¸ºæ­¢ï¼Œè®¡ç®—æ€»çš„ç­¾åˆ°æ¬¡æ•°ï¼Œå°±æ˜¯è¿ç»­ç­¾åˆ°å¤©æ•°ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653834455899.png" alt="1653834455899"></p><p>Javaé€»è¾‘ä»£ç ï¼šè·å¾—å½“å‰è¿™ä¸ªæœˆçš„æœ€åä¸€æ¬¡ç­¾åˆ°æ•°æ®ï¼Œå®šä¹‰ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç„¶åä¸åœçš„å‘å‰ç»Ÿè®¡ï¼Œç›´åˆ°è·å¾—ç¬¬ä¸€ä¸ªé0çš„æ•°å­—å³å¯ï¼Œæ¯å¾—åˆ°ä¸€ä¸ªé0çš„æ•°å­—è®¡æ•°å™¨+1ï¼Œç›´åˆ°éå†å®Œæ‰€æœ‰çš„æ•°æ®ï¼Œå°±å¯ä»¥è·å¾—å½“å‰æœˆçš„ç­¾åˆ°æ€»å¤©æ•°äº†</p><blockquote><p>é—®é¢˜2ï¼šå¦‚ä½•å¾—åˆ°æœ¬æœˆåˆ°ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰ç­¾åˆ°æ•°æ®ï¼Ÿ</p></blockquote><p><code>BITFIELD key GET u[dayOfMonth] 0</code></p><p>å‡è®¾ä»Šå¤©æ˜¯10å·ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä»å½“å‰æœˆçš„ç¬¬ä¸€å¤©å¼€å§‹ï¼Œè·å¾—åˆ°å½“å‰è¿™ä¸€å¤©çš„ä½æ•°ï¼Œæ˜¯10å·ï¼Œé‚£ä¹ˆå°±æ˜¯10ä½ï¼Œå»æ‹¿è¿™æ®µæ—¶é—´çš„æ•°æ®ï¼Œå°±èƒ½æ‹¿åˆ°æ‰€æœ‰çš„æ•°æ®äº†ï¼Œé‚£ä¹ˆè¿™10å¤©é‡Œè¾¹ç­¾åˆ°äº†å¤šå°‘æ¬¡å‘¢ï¼Ÿç»Ÿè®¡æœ‰å¤šå°‘ä¸ª1å³å¯ã€‚</p><blockquote><p>é—®é¢˜3ï¼šå¦‚ä½•ä»åå‘å‰éå†æ¯ä¸ªbitä½ï¼Ÿ</p></blockquote><p>æ³¨æ„ï¼šbitMapè¿”å›çš„æ•°æ®æ˜¯10è¿›åˆ¶ï¼Œå“ªå‡å¦‚è¯´è¿”å›ä¸€ä¸ªæ•°å­—8ï¼Œé‚£ä¹ˆæˆ‘å“ªå„¿çŸ¥é“åˆ°åº•å“ªäº›æ˜¯0ï¼Œå“ªäº›æ˜¯1å‘¢ï¼Ÿæˆ‘ä»¬åªéœ€è¦è®©å¾—åˆ°çš„10è¿›åˆ¶æ•°å­—å’Œ1åšä¸è¿ç®—å°±å¯ä»¥äº†ï¼Œå› ä¸º1åªæœ‰é‡è§1 æ‰æ˜¯1ï¼Œå…¶ä»–æ•°å­—éƒ½æ˜¯0 ï¼Œæˆ‘ä»¬æŠŠç­¾åˆ°ç»“æœå’Œ1è¿›è¡Œä¸æ“ä½œï¼Œæ¯ä¸ä¸€æ¬¡ï¼Œå°±æŠŠç­¾åˆ°ç»“æœå‘å³ç§»åŠ¨ä¸€ä½ï¼Œä¾æ¬¡å†…æ¨ï¼Œæˆ‘ä»¬å°±èƒ½å®Œæˆé€ä¸ªéå†çš„æ•ˆæœäº†ã€‚</p><p>éœ€æ±‚ï¼šå®ç°ä¸‹é¢æ¥å£ï¼Œç»Ÿè®¡å½“å‰ç”¨æˆ·æˆªæ­¢å½“å‰æ—¶é—´åœ¨æœ¬æœˆçš„è¿ç»­ç­¾åˆ°å¤©æ•°</p><p>æœ‰ç”¨æˆ·æœ‰æ—¶é—´æˆ‘ä»¬å°±å¯ä»¥ç»„ç»‡å‡ºå¯¹åº”çš„keyï¼Œæ­¤æ—¶å°±èƒ½æ‰¾åˆ°è¿™ä¸ªç”¨æˆ·æˆªæ­¢è¿™å¤©çš„æ‰€æœ‰ç­¾åˆ°è®°å½•ï¼Œå†æ ¹æ®è¿™å¥—ç®—æ³•ï¼Œå°±èƒ½ç»Ÿè®¡å‡ºæ¥ä»–è¿ç»­ç­¾åˆ°çš„æ¬¡æ•°äº†</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653835784444.png" alt="1653835784444"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ab69da0a-f994-436f-ae40-68f5398abfc0-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/sign/count&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">signCount</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userService.signCount();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ab69da0a-f994-436f-ae40-68f5398abfc0-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">signCount</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.è·å–æ—¥æœŸ</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">// 3.æ‹¼æ¥key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">keySuffix</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">// 4.è·å–ä»Šå¤©æ˜¯æœ¬æœˆçš„ç¬¬å‡ å¤©</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dayOfMonth</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">    <span class="comment">// 5.è·å–æœ¬æœˆæˆªæ­¢ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰çš„ç­¾åˆ°è®°å½•ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªåè¿›åˆ¶çš„æ•°å­— BITFIELD sign:5:202203 GET u14 0</span></span><br><span class="line">    List&lt;Long&gt; result = stringRedisTemplate.opsForValue().bitField(</span><br><span class="line">            key,</span><br><span class="line">            BitFieldSubCommands.create()</span><br><span class="line">                    .get(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth)).valueAt(<span class="number">0</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span> || result.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰ä»»ä½•ç­¾åˆ°ç»“æœ</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">num</span> <span class="operator">=</span> result.get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (num == <span class="literal">null</span> || num == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6.å¾ªç¯éå†</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// 6.1.è®©è¿™ä¸ªæ•°å­—ä¸1åšä¸è¿ç®—ï¼Œå¾—åˆ°æ•°å­—çš„æœ€åä¸€ä¸ªbitä½  // åˆ¤æ–­è¿™ä¸ªbitä½æ˜¯å¦ä¸º0</span></span><br><span class="line">        <span class="keyword">if</span> ((num &amp; <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸º0ï¼Œè¯´æ˜æœªç­¾åˆ°ï¼Œç»“æŸ</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸ä¸º0ï¼Œè¯´æ˜å·²ç­¾åˆ°ï¼Œè®¡æ•°å™¨+1</span></span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŠŠæ•°å­—å³ç§»ä¸€ä½ï¼ŒæŠ›å¼ƒæœ€åä¸€ä¸ªbitä½ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªbitä½</span></span><br><span class="line">        num &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><hr><h2 id="UVç»Ÿè®¡-HyperLogLog">UVç»Ÿè®¡-HyperLogLog</h2><p>é¦–å…ˆæˆ‘ä»¬ææ‡‚ä¸¤ä¸ªæ¦‚å¿µï¼š</p><ul><li>UVï¼šå…¨ç§°Unique Visitorï¼Œä¹Ÿå«ç‹¬ç«‹è®¿å®¢é‡ï¼Œæ˜¯æŒ‡é€šè¿‡äº’è”ç½‘è®¿é—®ã€æµè§ˆè¿™ä¸ªç½‘é¡µçš„è‡ªç„¶äººã€‚1å¤©å†…åŒä¸€ä¸ªç”¨æˆ·å¤šæ¬¡è®¿é—®è¯¥ç½‘ç«™ï¼Œåªè®°å½•1æ¬¡ã€‚</li><li>PVï¼šå…¨ç§°Page Viewï¼Œä¹Ÿå«é¡µé¢è®¿é—®é‡æˆ–ç‚¹å‡»é‡ï¼Œç”¨æˆ·æ¯è®¿é—®ç½‘ç«™çš„ä¸€ä¸ªé¡µé¢ï¼Œè®°å½•1æ¬¡PVï¼Œç”¨æˆ·å¤šæ¬¡æ‰“å¼€é¡µé¢ï¼Œåˆ™è®°å½•å¤šæ¬¡PVã€‚å¾€å¾€ç”¨æ¥è¡¡é‡ç½‘ç«™çš„æµé‡ã€‚</li></ul><p>é€šå¸¸æ¥è¯´UVä¼šæ¯”PVå¤§å¾ˆå¤šï¼Œæ‰€ä»¥è¡¡é‡åŒä¸€ä¸ªç½‘ç«™çš„è®¿é—®é‡ï¼Œæˆ‘ä»¬éœ€è¦ç»¼åˆè€ƒè™‘å¾ˆå¤šå› ç´ ï¼Œæ‰€ä»¥æˆ‘ä»¬åªæ˜¯å•çº¯çš„æŠŠè¿™ä¸¤ä¸ªå€¼ä½œä¸ºä¸€ä¸ªå‚è€ƒå€¼</p><p>UVç»Ÿè®¡åœ¨æœåŠ¡ç«¯åšä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºè¦åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦å·²ç»ç»Ÿè®¡è¿‡äº†ï¼Œéœ€è¦å°†ç»Ÿè®¡è¿‡çš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜ã€‚ä½†æ˜¯å¦‚æœæ¯ä¸ªè®¿é—®çš„ç”¨æˆ·éƒ½ä¿å­˜åˆ°Redisä¸­ï¼Œæ•°æ®é‡ä¼šéå¸¸ææ€–ï¼Œé‚£æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p><p>Hyperloglog(HLL)æ˜¯ä»Loglogç®—æ³•æ´¾ç”Ÿçš„æ¦‚ç‡ç®—æ³•ï¼Œç”¨äºç¡®å®šéå¸¸å¤§çš„é›†åˆçš„åŸºæ•°ï¼Œè€Œä¸éœ€è¦å­˜å‚¨å…¶æ‰€æœ‰å€¼ã€‚ç›¸å…³ç®—æ³•åŸç†å¤§å®¶å¯ä»¥å‚è€ƒï¼š<a href="https://juejin.cn/post/6844903785744056333#heading-0">https://juejin.cn/post/6844903785744056333#heading-0</a><br>Redisä¸­çš„HLLæ˜¯åŸºäºstringç»“æ„å®ç°çš„ï¼Œ<span class='p red'>å•ä¸ªHLLçš„å†…å­˜æ°¸è¿œå°äº16kb**ï¼Œ**å†…å­˜å ç”¨ä½çš„ä»¤äººå‘æŒ‡ï¼</span>ä½œä¸ºä»£ä»·ï¼Œå…¶æµ‹é‡ç»“æœæ˜¯æ¦‚ç‡æ€§çš„ï¼Œ<span class='p blue'>æœ‰å°äº0.81ï¼…çš„è¯¯å·®ã€‚</span>ä¸è¿‡å¯¹äºUVç»Ÿè®¡æ¥è¯´ï¼Œè¿™å®Œå…¨å¯ä»¥å¿½ç•¥ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1653837988985.png" alt="1653837988985"></p><p>æµ‹è¯•æ€è·¯ï¼šæˆ‘ä»¬ç›´æ¥åˆ©ç”¨å•å…ƒæµ‹è¯•ï¼Œå‘HyperLogLogä¸­æ·»åŠ 100ä¸‡æ¡æ•°æ®ï¼Œçœ‹çœ‹å†…å­˜å ç”¨å’Œç»Ÿè®¡æ•ˆæœå¦‚ä½•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testHyperLogLog</span><span class="params">()</span> &#123;</span><br><span class="line">    String[] users = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">1000</span>];</span><br><span class="line">    <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">        j = i % <span class="number">1000</span>;</span><br><span class="line">        users[j] = <span class="string">&quot;user_&quot;</span> + i;</span><br><span class="line">        <span class="keyword">if</span> (j == <span class="number">999</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForHyperLogLog().add(<span class="string">&quot;HLL&quot;</span>, users);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> stringRedisTemplate.opsForHyperLogLog().size(<span class="string">&quot;HLL&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;count = &quot;</span> + count);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//count = 997593</span></span><br></pre></td></tr></table></figure><p>ç»è¿‡æµ‹è¯•ï¼šæˆ‘ä»¬ä¼šå‘ç”Ÿä»–çš„è¯¯å·®æ˜¯åœ¨å…è®¸èŒƒå›´å†…ï¼Œå¹¶ä¸”å†…å­˜å ç”¨æå°</p>]]></content>
    
    
    <summary type="html">ç¼“å­˜ã€ç§’æ€ã€åˆ†å¸ƒå¼é”redissonã€ç‚¹èµã€å…±åŒå…³æ³¨ã€GEOã€BitMapã€HyperLogLog</summary>
    
    
    
    <category term="æ•°æ®åº“" scheme="https://wuwawawa.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="Redis" scheme="https://wuwawawa.github.io/tags/Redis/"/>
    
    <category term="æ•°æ®åº“" scheme="https://wuwawawa.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>RedisåŸºç¡€</title>
    <link href="https://wuwawawa.github.io/posts/6dfcb629.html"/>
    <id>https://wuwawawa.github.io/posts/6dfcb629.html</id>
    <published>2023-06-06T01:14:58.000Z</published>
    <updated>2023-06-07T02:21:05.707Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Rediså…¥é—¨">Rediså…¥é—¨</h2><h3 id="ä»€ä¹ˆæ˜¯NoSQL">ä»€ä¹ˆæ˜¯NoSQL</h3><ul><li>NoSQLæœ€å¸¸è§çš„è§£é‡Šæ˜¯&quot;<code>non-relational</code>&quot;ï¼Œ å¾ˆå¤šäººä¹Ÿè¯´å®ƒæ˜¯&quot;<span class='p green'>Not Only SQL</span>&quot;</li><li>NoSQLä»…ä»…æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œæ³›æŒ‡<span class='p blue'>éå…³ç³»å‹çš„æ•°æ®åº“</span></li><li>åŒºåˆ«äºå…³ç³»æ•°æ®åº“ï¼Œå®ƒä»¬ä¸ä¿è¯å…³ç³»æ•°æ®çš„ACIDç‰¹æ€§</li><li>NoSQLæ˜¯ä¸€é¡¹å…¨æ–°çš„æ•°æ®åº“é©å‘½æ€§è¿åŠ¨ï¼Œæå€¡è¿ç”¨éå…³ç³»å‹çš„æ•°æ®å­˜å‚¨ï¼Œç›¸å¯¹äºé“ºå¤©ç›–åœ°çš„å…³ç³»å‹æ•°æ®åº“è¿ç”¨ï¼Œè¿™ä¸€æ¦‚å¿µæ— ç–‘æ˜¯ä¸€ç§å…¨æ–°çš„æ€ç»´çš„æ³¨å…¥</li><li>å¸¸è§çš„NoSQLæ•°æ®åº“æœ‰ï¼š<code>Redis</code>ã€<code>MemCache</code>ã€<code>MongoDB</code>ç­‰</li></ul><hr><h3 id="NoSQLä¸SQLçš„å·®å¼‚">NoSQLä¸SQLçš„å·®å¼‚</h3><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">SQL</th><th style="text-align:center">NoSQL</th></tr></thead><tbody><tr><td style="text-align:center">æ•°æ®ç»“æ„</td><td style="text-align:center">ç»“æ„åŒ–</td><td style="text-align:center">éç»“æ„åŒ–</td></tr><tr><td style="text-align:center">æ•°æ®å…³è”</td><td style="text-align:center">å…³è”çš„</td><td style="text-align:center">æ— å…³è”çš„</td></tr><tr><td style="text-align:center">æŸ¥è¯¢æ–¹å¼</td><td style="text-align:center">SQLæŸ¥è¯¢</td><td style="text-align:center">éSQL</td></tr><tr><td style="text-align:center">äº‹åŠ¡ç‰¹æ€§</td><td style="text-align:center">ACID</td><td style="text-align:center">BASE</td></tr><tr><td style="text-align:center">å­˜å‚¨æ–¹å¼</td><td style="text-align:center">ç£ç›˜</td><td style="text-align:center">å†…å­˜</td></tr><tr><td style="text-align:center">æ‰©å±•æ€§</td><td style="text-align:center">å‚ç›´</td><td style="text-align:center">æ°´å¹³</td></tr><tr><td style="text-align:center">ä½¿ç”¨åœºæ™¯</td><td style="text-align:center">1ï¼‰æ•°æ®ç»“æ„å›ºå®š<br>2ï¼‰ç›¸å…³ä¸šåŠ¡å¯¹æ•°æ®å®‰å…¨æ€§ã€ä¸€è‡´æ€§è¦æ±‚è¾ƒé«˜</td><td style="text-align:center">1ï¼‰æ•°æ®ç»“æ„ä¸å›ºå®š<br>2ï¼‰å¯¹ä¸€è‡´æ€§ã€å®‰å…¨æ€§è¦æ±‚ä¸é«˜<br>3ï¼‰å¯¹æ€§èƒ½è¦æ±‚</td></tr></tbody></table><hr><h3 id="è®¤è¯†Redis">è®¤è¯†Redis</h3><blockquote><p>Redisè¯ç”Ÿäº2009å¹´å…¨ç§°æ˜¯Remote Dictionary Serverï¼Œè¿œç¨‹è¯å…¸æœåŠ¡å™¨ï¼Œæ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„é”®å€¼å‹NoSQLæ•°æ®åº“ã€‚</p></blockquote><mark class="hl-label blue">Redisçš„ç‰¹å¾ï¼š</mark> <ul><li>é”®å€¼ï¼ˆ<code>key-value</code>ï¼‰å‹ï¼Œvalueæ”¯æŒå¤šç§ä¸åŒæ•°æ®ç»“æ„ï¼ŒåŠŸèƒ½ä¸°å¯Œ</li><li>å•çº¿ç¨‹ï¼Œæ¯ä¸ªå‘½ä»¤å…·å¤‡åŸå­æ€§</li><li>ä½å»¶è¿Ÿï¼Œé€Ÿåº¦å¿«ï¼ˆåŸºäºå†…å­˜ã€IOå¤šè·¯å¤ç”¨ã€è‰¯å¥½çš„ç¼–ç ï¼‰ã€‚</li><li>æ”¯æŒæ•°æ®æŒä¹…åŒ–</li><li>æ”¯æŒä¸»ä»é›†ç¾¤ã€åˆ†ç‰‡é›†ç¾¤</li><li>æ”¯æŒå¤šè¯­è¨€å®¢æˆ·ç«¯</li></ul><hr><h3 id="å•çº¿ç¨‹æ¶æ„">å•çº¿ç¨‹æ¶æ„</h3><p>Redisä½¿ç”¨äº†<span class='p blue'>å•çº¿ç¨‹æ¶æ„</span>å’Œ<span class='p green'>I/Oå¤šè·¯å¤ç”¨æ¨¡å‹</span>æ¥å®ç°é«˜æ€§èƒ½çš„å†…å­˜æ•°æ®åº“æœåŠ¡ã€‚</p><div class="tabs" id="6f10bb80-30b4-4dbd-9043-37cd961f9301"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6f10bb80-30b4-4dbd-9043-37cd961f9301-1"><i class="fas fa-award"></i>1</button></li><li class="tab"><button type="button" data-href="#6f10bb80-30b4-4dbd-9043-37cd961f9301-2"><i class="fas fa-baseball-ball"></i>2</button></li><li class="tab"><button type="button" data-href="#6f10bb80-30b4-4dbd-9043-37cd961f9301-3"><i class="fas fa-bone"></i>3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6f10bb80-30b4-4dbd-9043-37cd961f9301-1"><p>Redis å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„æ¨¡å‹å¯ä»¥ç®€åŒ–æˆä¸‹å›¾, æ¯æ¬¡å®¢æˆ·ç«¯è°ƒç”¨éƒ½ç»å†äº†å‘é€å‘½ä»¤ã€æ‰§è¡Œå‘½ä»¤ã€è¿”å›ç»“æœä¸‰ä¸ªè¿‡ç¨‹ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/Redis%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg" alt="Redisæµç¨‹å›¾" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6f10bb80-30b4-4dbd-9043-37cd961f9301-2"><p>å…¶ä¸­ç¬¬2æ­¥æ˜¯é‡ç‚¹è¦è®¨è®ºçš„ï¼Œå› ä¸ºRedis æ˜¯å•çº¿ç¨‹æ¥å¤„ç†å‘½ä»¤çš„ï¼Œæ‰€ä»¥ä¸€æ¡å‘½ä»¤ä»å®¢æˆ·ç«¯è¾¾åˆ°æœåŠ¡ç«¯ä¸ä¼šç«‹åˆ»è¢«æ‰§è¡Œï¼Œæ‰€æœ‰å‘½ä»¤éƒ½ä¼šè¿›å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åé€ä¸ªè¢«æ‰§è¡Œã€‚</p><p>å‘é€å‘½ä»¤ã€è¿”å›ç»“æœã€å‘½ä»¤æ’é˜Ÿè‚¯å®šä¸åƒæè¿°çš„è¿™ä¹ˆç®€å•ï¼Œ Redisä½¿ç”¨äº†I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯æ¥è§£å†³I/Oçš„é—®é¢˜</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/Redis%E5%91%BD%E4%BB%A4%E9%98%9F%E5%88%971.jpg" alt="Rediså‘½ä»¤é˜Ÿåˆ—1" style="zoom: 67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6f10bb80-30b4-4dbd-9043-37cd961f9301-3"><p>å‘½ä»¤çš„æ‰§è¡Œé¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼Œä½†æ˜¯å¯ä»¥ç¡®å®šä¸ä¼šæœ‰ä¸¤æ¡å‘½ä»¤è¢«åŒæ—¶æ‰§è¡Œã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/Redis%E5%91%BD%E4%BB%A4%E9%98%9F%E5%88%973.jpg" alt="Rediså‘½ä»¤é˜Ÿåˆ—3" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <blockquote><p>ä¸ºä»€ä¹ˆå•çº¿ç¨‹è¿˜èƒ½è¿™ä¹ˆå¿«</p></blockquote><p>é€šå¸¸æ¥è®²ï¼Œå•çº¿ç¨‹å¤„ç†èƒ½åŠ›è¦æ¯”å¤šçº¿ç¨‹å·®ï¼Œä¾‹å¦‚æœ‰10000æ–¤è´§ç‰©ï¼Œæ¯è¾†è½¦çš„è¿è½½èƒ½åŠ›æ˜¯æ¯æ¬¡200æ–¤ï¼Œé‚£ä¹ˆè¦50æ¬¡æ‰èƒ½å®Œæˆï¼Œä½†æ˜¯å¦‚æœæœ‰50è¾†è½¦ï¼Œåªè¦å®‰æ’åˆç†ï¼Œåªéœ€è¦ä¸€æ¬¡å°±å¯ä»¥å®Œæˆä»»åŠ¡ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆRedis ä½¿ç”¨å•çº¿ç¨‹æ¨¡å‹ä¼šè¾¾åˆ°æ¯ç§’ä¸‡çº§åˆ«çš„å¤„ç†èƒ½åŠ›å‘¢ï¼Ÿå¯ä»¥å°†å…¶å½’ç»“ä¸ºä¸‰ç‚¹ï¼š</p><p>ç¬¬ä¸€ï¼Œçº¯å†…å­˜è®¿é—®ï¼Œ Redis å°†æ‰€æœ‰æ•°æ®æ”¾åœ¨å†…å­˜ä¸­ï¼Œå†…å­˜çš„å“åº”æ—¶é•¿å¤§çº¦ä¸º100 çº³ç§’ï¼Œè¿™æ˜¯Redisè¾¾åˆ°æ¯ç§’ä¸‡çº§åˆ«è®¿é—®çš„é‡è¦åŸºç¡€ã€‚</p><p>ç¬¬äºŒï¼Œéé˜»å¡I/O, Redis ä½¿ç”¨epollä½œä¸ºI/Oå¤šè·¯å¤ç”¨æŠ€æœ¯çš„å®ç°ï¼Œå†åŠ ä¸ŠRedisè‡ªèº«çš„äº‹ä»¶å¤„ç†æ¨¡å‹å°†epollä¸­çš„è¿æ¥ã€è¯»å†™ã€å…³é—­éƒ½è½¬æ¢ä¸ºäº‹ä»¶ï¼Œä¸åœ¨ç½‘ç»œI/Oä¸Šæµªè´¹è¿‡å¤šçš„æ—¶é—´ã€‚</p><p>ç¬¬ä¸‰ï¼Œå•çº¿ç¨‹é¿å…äº†çº¿ç¨‹åˆ‡æ¢å’Œç«æ€äº§ç”Ÿçš„æ¶ˆè€—ã€‚</p><p>ä½†æ˜¯å•çº¿ç¨‹ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼šå¯¹äºæ¯ä¸ªå‘½ä»¤çš„æ‰§è¡Œæ—¶é—´æ˜¯æœ‰è¦æ±‚çš„ã€‚å¦‚æœæŸä¸ªå‘½ä»¤æ‰§è¡Œè¿‡é•¿ï¼Œä¼šé€ æˆå…¶ä»–å‘½ä»¤çš„é˜»å¡ï¼Œå¯¹äºRedis è¿™ç§é«˜æ€§èƒ½çš„æœåŠ¡æ¥è¯´æ˜¯è‡´å‘½çš„ï¼Œæ‰€ä»¥Redis æ˜¯é¢å‘å¿«é€Ÿæ‰§è¡Œåœºæ™¯çš„æ•°æ®åº“ã€‚</p><hr><h3 id="Redisä½¿ç”¨åœºæ™¯">Redisä½¿ç”¨åœºæ™¯</h3><div class="tabs" id="afd4130e-07a4-4024-b30c-71235e734c38"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#afd4130e-07a4-4024-b30c-71235e734c38-1"><i class="fas fa-seedling"></i>ç¼“å­˜</button></li><li class="tab"><button type="button" data-href="#afd4130e-07a4-4024-b30c-71235e734c38-2"><i class="fas fa-leaf"></i>æ’è¡Œæ¦œç³»ç»Ÿ</button></li><li class="tab"><button type="button" data-href="#afd4130e-07a4-4024-b30c-71235e734c38-3"><i class="fab fa-apple"></i>è®¡æ•°å™¨åº”ç”¨</button></li><li class="tab"><button type="button" data-href="#afd4130e-07a4-4024-b30c-71235e734c38-4"><i class="fas fa-tree"></i>ç¤¾äº¤ç½‘ç»œ</button></li><li class="tab"><button type="button" data-href="#afd4130e-07a4-4024-b30c-71235e734c38-5"><i class="fas fa-heartbeat"></i>æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="afd4130e-07a4-4024-b30c-71235e734c38-1"><p>ç¼“å­˜æœºåˆ¶å‡ ä¹åœ¨æ‰€æœ‰çš„å¤§å‹ç½‘ç«™éƒ½æœ‰ä½¿ç”¨ï¼Œåˆç†åœ°ä½¿ç”¨ç¼“å­˜ä¸ä»…å¯ä»¥åŠ å¿«æ•°æ®çš„è®¿é—®é€Ÿåº¦ï¼Œè€Œä¸”èƒ½å¤Ÿæœ‰æ•ˆåœ°é™ä½åç«¯æ•°æ®æºçš„å‹åŠ›ã€‚Redis æä¾›äº†é”®å€¼è¿‡æœŸæ—¶é—´è®¾ç½®ï¼Œå¹¶ä¸”ä¹Ÿæä¾›äº†çµæ´»æ§åˆ¶æœ€å¤§å†…å­˜å’Œå†…å­˜æº¢å‡ºåçš„æ·˜æ±°ç­–ç•¥ã€‚å¯ä»¥è¿™ä¹ˆè¯´ï¼Œä¸€ä¸ªåˆç†çš„ç¼“å­˜è®¾è®¡èƒ½å¤Ÿä¸ºä¸€ä¸ªç½‘ç«™çš„ç¨³å®šä¿é©¾æŠ¤èˆªã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="afd4130e-07a4-4024-b30c-71235e734c38-2"><p>æ’è¡Œæ¦œç³»ç»Ÿå‡ ä¹å­˜åœ¨äºæ‰€æœ‰çš„ç½‘ç«™ï¼Œä¾‹å¦‚æŒ‰ç…§çƒ­åº¦æ’åçš„æ’è¡Œæ¦œï¼ŒæŒ‰ç…§å‘å¸ƒæ—¶é—´çš„æ’è¡Œæ¦œï¼ŒæŒ‰ç…§å„ç§å¤æ‚ç»´åº¦è®¡ç®—å‡ºçš„æ’è¡Œæ¦œï¼Œ Redisæä¾›äº†åˆ—è¡¨å’Œæœ‰åºé›†åˆæ•°æ®ç»“æ„ï¼Œåˆç†åœ°ä½¿ç”¨è¿™äº›æ•°æ®ç»“æ„å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ„å»ºå„ç§æ’è¡Œæ¦œç³»ç»Ÿã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="afd4130e-07a4-4024-b30c-71235e734c38-3"><p>è®¡æ•°å™¨åœ¨ç½‘ç«™ä¸­çš„ä½œç”¨è‡³å…³é‡è¦ï¼Œä¾‹å¦‚è§†é¢‘ç½‘ç«™æœ‰æ’­æ”¾æ•°ã€ç”µå•†ç½‘ç«™æœ‰æµè§ˆæ•°ï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„å®æ—¶æ€§ï¼Œæ¯ä¸€æ¬¡æ’­æ”¾å’Œæµè§ˆéƒ½è¦åšåŠ 1 çš„æ“ä½œï¼Œå¦‚æœå¹¶å‘é‡å¾ˆå¤§å¯¹äºä¼ ç»Ÿå…³ç³»å‹æ•°æ®çš„æ€§èƒ½æ˜¯ä¸€ç§æŒ‘æˆ˜ã€‚Redis å¤©ç„¶æ”¯æŒè®¡æ•°åŠŸèƒ½è€Œä¸”è®¡æ•°çš„æ€§èƒ½ä¹Ÿéå¸¸å¥½ï¼Œå¯ä»¥è¯´æ˜¯è®¡æ•°å™¨ç³»ç»Ÿçš„é‡è¦é€‰æ‹©ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="afd4130e-07a4-4024-b30c-71235e734c38-4"><p>èµï¼è¸©ã€ç²‰ä¸ã€å…±åŒå¥½å‹ï¼å–œå¥½ã€æ¨é€ã€ä¸‹æ‹‰åˆ·æ–°ç­‰æ˜¯ç¤¾äº¤ç½‘ç«™çš„å¿…å¤‡åŠŸèƒ½ï¼Œç”±äºç¤¾äº¤ç½‘ç«™è®¿é—®é‡é€šå¸¸æ¯”è¾ƒå¤§ï¼Œè€Œä¸”ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®ä¸å¤ªé€‚åˆä¿å­˜è¿™ç§ç±»å‹çš„æ•°æ®ï¼Œ Redis æä¾›çš„æ•°æ®ç»“æ„å¯ä»¥ç›¸å¯¹æ¯”è¾ƒå®¹æ˜“åœ°å®ç°è¿™äº›åŠŸèƒ½ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="afd4130e-07a4-4024-b30c-71235e734c38-5"><p>æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿå¯ä»¥è¯´æ˜¯ä¸€ä¸ªå¤§å‹ç½‘ç«™çš„å¿…å¤‡åŸºç¡€ç»„ä»¶ï¼Œå› ä¸ºå…¶å…·æœ‰ä¸šåŠ¡è§£è€¦ã€éå®æ—¶ä¸šåŠ¡å‰Šå³°ç­‰ç‰¹æ€§ã€‚Redi s æä¾›äº†å‘å¸ƒè®¢é˜…åŠŸèƒ½å’Œé˜»å¡é˜Ÿåˆ—çš„åŠŸèƒ½ï¼Œè™½ç„¶å’Œä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—æ¯”è¿˜ä¸å¤Ÿè¶³å¤Ÿå¼ºå¤§ï¼Œä½†æ˜¯å¯¹äºä¸€èˆ¬çš„æ¶ˆæ¯é˜Ÿåˆ—åŠŸèƒ½åŸºæœ¬å¯ä»¥æ»¡è¶³ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="Rediså…¨å±€å‘½ä»¤">Rediså…¨å±€å‘½ä»¤</h2><div class="tabs" id="56da306b-3cff-458e-b89a-0e52e5a6f25b"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#56da306b-3cff-458e-b89a-0e52e5a6f25b-1"><i class="fas fa-cat"></i>é”®ç®¡ç†</button></li><li class="tab"><button type="button" data-href="#56da306b-3cff-458e-b89a-0e52e5a6f25b-2"><i class="fas fa-horse"></i>éå†é”®</button></li><li class="tab"><button type="button" data-href="#56da306b-3cff-458e-b89a-0e52e5a6f25b-3"><i class="fas fa-heartbeat"></i>é”®è¿‡æœŸ</button></li><li class="tab"><button type="button" data-href="#56da306b-3cff-458e-b89a-0e52e5a6f25b-4"><i class="fas fa-cookie-bite"></i>é”®çš„æ•°æ®ç»“æ„ç±»å‹å’Œå†…éƒ¨ç¼–ç </button></li><li class="tab"><button type="button" data-href="#56da306b-3cff-458e-b89a-0e52e5a6f25b-5"><i class="fas fa-dove"></i>æ•°æ®åº“ç®¡ç†</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="56da306b-3cff-458e-b89a-0e52e5a6f25b-1"><p><code>del key</code></p><p>del æ˜¯ä¸€ä¸ªé€šç”¨å‘½ä»¤ï¼Œæ— è®ºå€¼æ˜¯ä»€ä¹ˆæ•°æ®ç»“æ„ç±»å‹ï¼Œ del å‘½ä»¤éƒ½å¯ä»¥å°†å…¶åˆ é™¤</p><p>è¿”å›ç»“æœä¸ºæˆåŠŸåˆ é™¤é”®çš„ä¸ªæ•°ï¼Œå‡è®¾åˆ é™¤ä¸€ä¸ªä¸å­˜åœ¨çš„é”®ï¼Œå°±ä¼šè¿”å›0</p><p><code>dbsize</code></p><p>dbsize å‘½ä»¤ä¼šè¿”å›å½“å‰æ•°æ®åº“ä¸­é”®çš„æ€»æ•°ã€‚</p><p>dbsizeå‘½ä»¤åœ¨è®¡ç®—é”®æ€»æ•°æ—¶ä¸ä¼šéå†æ‰€æœ‰é”®ï¼Œè€Œæ˜¯ç›´æ¥è·å–Rediså†…ç½®çš„é”®æ€»æ•°å˜é‡ï¼Œæ‰€ä»¥dbsizeå‘½ä»¤çš„æ—¶é—´å¤æ‚åº¦æ˜¯0(1) ã€‚</p><p>è€Œkeyså‘½ä»¤ä¼šéå†æ‰€æœ‰é”®ï¼Œæ‰€ä»¥å®ƒçš„æ—¶é—´å¤æ‚åº¦æ˜¯O(n), å½“Redisä¿å­˜äº†å¤§é‡é”®æ—¶ï¼Œçº¿ä¸Šç¯å¢ƒç¦æ­¢ä½¿ç”¨ã€‚</p><p><code>exists key</code></p><p>å¦‚æœé”®å­˜åœ¨åˆ™è¿”å›1ä¸å­˜åœ¨åˆ™è¿”å›0</p><p><code>rename key newkey</code></p><p>é”®é‡å‘½å</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="56da306b-3cff-458e-b89a-0e52e5a6f25b-2"><p><code>keys pattern</code></p><p>å…¨é‡éå†é”®ï¼Œæ ¹æ®patternåŒ¹é…</p><p>ï¼Šä»£è¡¨åŒ¹é…ä»»æ„å­—ç¬¦ã€‚ä¼šå°†æ‰€æœ‰çš„é”®è¾“å‡ºï¼Œ<span class='p red'>ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒè®¾å¤‡ä¸Šä½¿ç”¨</span></p><p>? ä»£è¡¨åŒ¹é…ä¸€ä¸ªå­—ç¬¦</p><p>[] ä»£è¡¨ppéƒ¨åˆ†å­—ç¬¦</p><p><code>scan cursor [match pattern] [count number]</code></p><p>æ¸è¿›å¼éå†</p><p>cursoræ˜¯å¿…éœ€å‚æ•°ï¼Œå®é™…ä¸Šcursor æ˜¯ä¸€ä¸ªæ¸¸æ ‡ï¼Œç¬¬ä¸€æ¬¡éå†ä»0 å¼€å§‹ï¼Œæ¯æ¬¡scanéå†å®Œéƒ½ä¼šè¿”å›å½“å‰æ¸¸æ ‡çš„å€¼ï¼Œç›´åˆ°æ¸¸æ ‡å€¼ä¸º0, è¡¨ç¤ºéå†ç»“æŸã€‚</p><p>match patternæ˜¯å¯é€‰å‚æ•°ï¼Œå®ƒçš„ä½œç”¨çš„æ˜¯åšæ¨¡å¼çš„åŒ¹é…ï¼Œè¿™ç‚¹å’Œkeysçš„æ¨¡å¼åŒ¹é…å¾ˆåƒã€‚</p><p>count numberæ˜¯å¯é€‰å‚æ•°,å®ƒçš„ä½œç”¨æ˜¯è¡¨æ˜æ¯æ¬¡è¦éå†çš„é”®ä¸ªæ•°ï¼Œé»˜è®¤å€¼æ˜¯10, æ­¤å‚æ•°å¯ä»¥é€‚å½“å¢å¤§ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="56da306b-3cff-458e-b89a-0e52e5a6f25b-3"><p><code>expire key seconds</code></p><p>Redis æ”¯æŒå¯¹é”®æ·»åŠ è¿‡æœŸæ—¶é—´ï¼Œå½“è¶…è¿‡è¿‡æœŸæ—¶é—´åï¼Œä¼šè‡ªåŠ¨åˆ é™¤</p><p><code>ttl key</code></p><p>ttlå‘½ä»¤ä¼šè¿”å›é”®çš„å‰©ä½™è¿‡æœŸæ—¶é—´ï¼Œå®ƒæœ‰3 ç§è¿”å›å€¼ï¼š</p><ul><li>å¤§äºç­‰äº0 çš„æ•´æ•°ï¼šé”®å‰©ä½™çš„è¿‡æœŸæ—¶é—´ã€‚</li><li>-1: é”®æ²¡è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚</li><li>-2: é”®ä¸å­˜åœ¨</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="56da306b-3cff-458e-b89a-0e52e5a6f25b-4"><p><code>type key</code></p><p>è¿”å›é”®çš„æ•°æ®ç»“æ„ç±»å‹ï¼Œå¦‚æœé”®ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›none</p><p><code>object encoding key</code></p><p>æ¯ç§æ•°æ®ç»“æ„éƒ½æœ‰è‡ªå·±åº•å±‚çš„å†…éƒ¨ç¼–ç å®ç°ï¼Œè€Œä¸”æ˜¯å¤šç§å®ç°ï¼Œè¿™æ ·Redisä¼šåœ¨åˆé€‚çš„åœºæ™¯é€‰æ‹©åˆé€‚çš„å†…éƒ¨ç¼–ç ã€‚ä¾‹å¦‚listæ•°æ®ç»“æ„åŒ…å«äº†linkedlistå’Œziplistä¸¤ç§å†…éƒ¨ç¼–ç ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="56da306b-3cff-458e-b89a-0e52e5a6f25b-5"><p><code>select dbIndex</code></p><p>åˆ‡æ¢æ•°æ®åº“ã€‚ã€‚Redisé»˜è®¤é…ç½®ä¸­æ˜¯æœ‰16 ä¸ªæ•°æ®åº“ï¼Œé»˜è®¤ä½¿ç”¨çš„å°±æ˜¯0å·æ•°æ®åº“</p><p><code>FLUSHDB</code></p><p>åˆ é™¤å½“å‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰key</p><p><code>FLUSHALL</code></p><p>åˆ é™¤æ‰€æœ‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰key</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="Redisæ•°æ®ç»“æ„">Redisæ•°æ®ç»“æ„</h2><p>Redisæ˜¯ä¸€ä¸ªkey-valueçš„æ•°æ®åº“ï¼Œkeyä¸€èˆ¬æ˜¯Stringç±»å‹ï¼Œä¸è¿‡valueçš„ç±»å‹å¤šç§å¤šæ ·ï¼Œä¸ä»…å¯ä»¥å¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œä¸”è¿˜å¯ä»¥æ˜¯å…·ä½“çš„æ•°æ®ç»“æ„ã€‚</p><p><img src="https://image-bed-vz.oss-cn-hangzhou.aliyuncs.com/Redis/image-20220524205926164.png" alt="image-20220524205926164"></p><hr><hr><h2 id="Stringç±»å‹">Stringç±»å‹</h2><p>å­—ç¬¦ä¸²ç±»å‹æ˜¯Redisæœ€åŸºç¡€çš„æ•°æ®ç»“æ„ã€‚é¦–å…ˆé”®éƒ½æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œè€Œä¸”å…¶ä»–å‡ ç§æ•°æ®ç»“æ„éƒ½æ˜¯åœ¨å­—ç¬¦ä¸²ç±»å‹åŸºç¡€ä¸Šæ„å»ºçš„ã€‚</p><p>å…¶valueæ˜¯å­—ç¬¦ä¸²ï¼Œä¸è¿‡æ ¹æ®å­—ç¬¦ä¸²çš„æ ¼å¼ä¸åŒï¼Œåˆå¯ä»¥åˆ†ä¸º3ç±»ï¼š</p><ul><li><code>string</code>ï¼šæ™®é€šå­—ç¬¦ä¸²</li><li><code>int</code>ï¼šæ•´æ•°ç±»å‹ï¼Œå¯ä»¥åšè‡ªå¢ã€è‡ªå‡æ“ä½œ</li><li><code>float</code>ï¼šæµ®ç‚¹ç±»å‹ï¼Œå¯ä»¥åšè‡ªå¢ã€è‡ªå‡æ“ä½œ</li></ul><p>ä¸ç®¡æ˜¯å“ªç§æ ¼å¼ï¼Œåº•å±‚éƒ½æ˜¯å­—èŠ‚æ•°ç»„å½¢å¼å­˜å‚¨ï¼Œåªä¸è¿‡æ˜¯ç¼–ç æ–¹å¼ä¸åŒã€‚å­—ç¬¦ä¸²ç±»å‹çš„æœ€å¤§ç©ºé—´ä¸èƒ½è¶…è¿‡512m.</p><hr><h3 id="å¸¸è§å‘½ä»¤">å¸¸è§å‘½ä»¤</h3><div class="tabs" id="2fc12848-ed04-4e93-a442-0ffca0b79ef7"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2fc12848-ed04-4e93-a442-0ffca0b79ef7-1"><i class="fas fa-cat"></i>è®¾ç½®å€¼</button></li><li class="tab"><button type="button" data-href="#2fc12848-ed04-4e93-a442-0ffca0b79ef7-2"><i class="fas fa-horse"></i>è·å–å€¼</button></li><li class="tab"><button type="button" data-href="#2fc12848-ed04-4e93-a442-0ffca0b79ef7-3"><i class="fas fa-dove"></i>è‡ªå¢å€¼</button></li><li class="tab"><button type="button" data-href="#2fc12848-ed04-4e93-a442-0ffca0b79ef7-4"><i class="fas fa-dragon"></i>ä¸å¸¸ç”¨å‘½ä»¤</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2fc12848-ed04-4e93-a442-0ffca0b79ef7-1"><p><code>set key value [ex seconds] [px milliseconds] [nx|xx]</code></p><p>setå‘½ä»¤æœ‰å‡ ä¸ªé€‰é¡¹ï¼š</p><ul><li>ex secondsï¼šä¸ºé”®è®¾ç½®ç§’çº§è¿‡æœŸæ—¶é—´ã€‚</li><li>px millisecondsï¼šä¸ºé”®è®¾ç½®æ¯«ç§’çº§è¿‡æœŸæ—¶é—´ã€‚</li><li>nx : é”®å¿…é¡»ä¸å­˜åœ¨ï¼Œæ‰å¯ä»¥è®¾ç½®æˆåŠŸï¼Œç”¨äºæ·»åŠ ã€‚</li><li>xxï¼šä¸nxç›¸åï¼Œé”®å¿…é¡»å­˜åœ¨ï¼Œæ‰å¯ä»¥è®¾ç½®æˆåŠŸï¼Œ ç”¨äºæ›´æ–°ã€‚</li></ul><p>é™¤äº†seté€‰é¡¹ï¼Œ Redis è¿˜æä¾›äº†<code>setex</code>å’Œ<code>setnx</code>ä¸¤ä¸ªå‘½ä»¤ï¼Œå®ƒä»¬çš„ä½œç”¨å’Œexå’Œnxé€‰é¡¹æ˜¯ä¸€æ ·çš„ã€‚</p><p><code>mset key value [key value ...]</code></p><p>æ‰¹é‡è®¾ç½®å€¼ï¼Œé€šè¿‡<code>mset</code>å‘½ä»¤å¯ä»¥ä¸€æ¬¡æ€§è®¾ç½®å¤šä¸ªé”®å€¼å¯¹ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2fc12848-ed04-4e93-a442-0ffca0b79ef7-2"><p><code>get key</code></p><p>å¦‚æœè¦è·å–çš„é”®ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›nil(ç©º)</p><p><code>mget key [key ...]</code></p><p>æ‰¹é‡è·å–å€¼ï¼Œé€šè¿‡<code>mget</code>å‘½ä»¤å¯ä»¥ä¸€æ¬¡æ€§è·å–å¤šä¸ªé”®çš„å€¼ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2fc12848-ed04-4e93-a442-0ffca0b79ef7-3"><p><code>incr key</code></p><p>incrå‘½ä»¤ç”¨äºå¯¹å€¼åšè‡ªå¢æ“ä½œï¼Œè¿”å›ç»“æœåˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š</p><ul><li>å€¼ä¸æ˜¯æ•´æ•°ï¼Œè¿”å›é”™è¯¯ã€‚</li><li>å€¼æ˜¯æ•´æ•°ï¼Œè¿”å›è‡ªå¢åçš„ç»“æœã€‚</li><li>é”®ä¸å­˜åœ¨ï¼ŒæŒ‰ç…§å€¼ä¸º0 è‡ªå¢ï¼Œè¿”å›ç»“æœä¸º1 ã€‚</li></ul><p>é™¤äº†incrå‘½ä»¤ï¼ŒRedisæä¾›äº†decr(è‡ªå‡)ã€incrby(è‡ªå¢æŒ‡å®šæ•°å­—)ã€decrby (è‡ªå‡æŒ‡å®šæ•°å­—)ã€incrbyfloat(è‡ªå¢æµ®ç‚¹æ•°)</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2fc12848-ed04-4e93-a442-0ffca0b79ef7-4"><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>append key value </code></td><td>å‘å­—ç¬¦ä¸²å°¾éƒ¨è¿½åŠ å€¼</td></tr><tr><td><code>strlen key</code></td><td>å­—ç¬¦ä¸²é•¿åº¦</td></tr><tr><td><code>getset key value</code></td><td>è®¾ç½®å€¼å¹¶è¿”å›é”®åŸæ¥çš„å€¼</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="å†…éƒ¨ç¼–ç ">å†…éƒ¨ç¼–ç </h3><p>å­—ç¬¦ä¸²ç±»å‹çš„å†…éƒ¨ç¼–ç æœ‰3 ç§ï¼š</p><ul><li>int: 8 ä¸ªå­—èŠ‚çš„é•¿æ•´å‹ã€‚</li><li>embstr: é•¿åº¦å°äºç­‰äº44çš„å­—ç¬¦ä¸²ã€‚</li><li>raw: å¤§äº44ä¸ªå­—èŠ‚çš„å­—ç¬¦ä¸²ã€‚</li></ul><p>Redis ä¼šæ ¹æ®å½“å‰å€¼çš„ç±»å‹å’Œé•¿åº¦å†³å®šä½¿ç”¨å“ªç§å†…éƒ¨ç¼–ç å®ç°ã€‚</p><div class="tabs" id="95fe8596-9b07-4151-8343-ec780819f209"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#95fe8596-9b07-4151-8343-ec780819f209-1"><i class="fas fa-seedling"></i>æ•´æ•°ç±»å‹ç¤ºä¾‹</button></li><li class="tab"><button type="button" data-href="#95fe8596-9b07-4151-8343-ec780819f209-2"><i class="fas fa-leaf"></i>çŸ­å­—ç¬¦ä¸²ç¤ºä¾‹</button></li><li class="tab"><button type="button" data-href="#95fe8596-9b07-4151-8343-ec780819f209-3"><i class="fab fa-apple"></i>é•¿å­—ç¬¦ä¸²ç¤ºä¾‹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="95fe8596-9b07-4151-8343-ec780819f209-1"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> key1 123</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> key1</span><br><span class="line">string</span><br><span class="line">127.0.0.1:6379&gt; object encoding key1</span><br><span class="line"><span class="string">&quot;int&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="95fe8596-9b07-4151-8343-ec780819f209-2"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> key2 <span class="string">&quot;hello,world&quot;</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> key2</span><br><span class="line">string</span><br><span class="line">127.0.0.1:6379&gt; object encoding key2 </span><br><span class="line"><span class="string">&quot;embstr&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="95fe8596-9b07-4151-8343-ec780819f209-3"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> key3 <span class="string">&quot;one string greater than 39 byte..............&quot;</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; object encoding key3</span><br><span class="line"><span class="string">&quot;raw&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; strlen key3</span><br><span class="line">(<span class="built_in">integer</span>) 45</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="ä½¿ç”¨åœºæ™¯">ä½¿ç”¨åœºæ™¯</h3><div class="tabs" id="e4babf27-43ae-4acf-be62-fad0bb243223"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e4babf27-43ae-4acf-be62-fad0bb243223-1"><i class="fas fa-cat"></i>ç¼“å­˜åŠŸèƒ½</button></li><li class="tab"><button type="button" data-href="#e4babf27-43ae-4acf-be62-fad0bb243223-2"><i class="fas fa-horse"></i>è®¡æ•°</button></li><li class="tab"><button type="button" data-href="#e4babf27-43ae-4acf-be62-fad0bb243223-3"><i class="fas fa-dove"></i>å…±äº«Session</button></li><li class="tab"><button type="button" data-href="#e4babf27-43ae-4acf-be62-fad0bb243223-4"><i class="fas fa-dragon"></i>é™é€Ÿ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e4babf27-43ae-4acf-be62-fad0bb243223-1"><p>Redis ä½œä¸ºç¼“å­˜å±‚ï¼Œ MySQL ä½œä¸ºå­˜å‚¨å±‚ï¼Œç»å¤§éƒ¨åˆ†è¯·æ±‚çš„æ•°æ®éƒ½æ˜¯ä»Redisä¸­è·å–ã€‚ç”±åƒRediså…·æœ‰æ”¯æ’‘é«˜å¹¶å‘çš„ç‰¹æ€§ï¼Œæ‰€ä»¥ç¼“å­˜é€šå¸¸èƒ½èµ·åˆ°åŠ é€Ÿè¯»å†™å’Œé™ä½åç«¯å‹åŠ›çš„ä½œç”¨ã€‚</p><p>ä¸ MySQLç­‰å…³ç³»å‹æ•°æ®åº“ä¸åŒçš„æ˜¯ï¼ŒRedisæ²¡æœ‰å‘½ä»¤ç©ºé—´ï¼Œ è€Œä¸”ä¹Ÿæ²¡æœ‰å¯¹é”®åæœ‰ å¼ºåˆ¶è¦æ±‚ï¼ˆé™¤äº†ä¸èƒ½ä½¿ç”¨ä¸€äº›ç‰¹æ®Šå­—ç¬¦ï¼‰ã€‚ ä½†è®¾è®¡åˆç†çš„é”®åï¼Œ æœ‰åˆ©äºé˜²æ­¢é”®å†²çªï¼Œå’Œé¡¹ç›®çš„å¯ç»´æŠ¤æ€§ï¼Œ æ¯”è¾ƒæ¨èçš„æ–¹å¼æ˜¯ä½¿ç”¨ <code>&quot;ä¸šåŠ¡å:å¯¹è±¡å:id:[å±æ€§]</code> ä½œä¸ºé”®åï¼ˆä¹Ÿå¯ä»¥ä¸æ˜¯åˆ†å·ï¼‰ã€‚</p><p>ä¾‹å¦‚MySQLçš„æ•°æ®åº“åä¸ºvs, ç”¨æˆ·è¡¨åä¸ºuser, é‚£ä¹ˆå¯¹åº”çš„é”®å¯ä»¥ç”¨<code>&quot;vs:user:1&quot;,&quot;vs:user:1:name&quot;</code>æ¥è¡¨ç¤ºï¼Œ å¦‚æœå½“å‰Redisåªè¢«ä¸€ä¸ªä¸šåŠ¡ä½¿ç”¨ï¼Œ ç”šè‡³å¯ä»¥å»æ‰ â€œvsâ€ã€‚</p><p>å¦‚æœé”®åæ¯”è¾ƒé•¿ï¼Œ ä¾‹å¦‚<code>&quot;user:{uid}:friends:messages:{mid}&quot;</code>, å¯ä»¥åœ¨èƒ½æè¿°é”®å«ä¹‰çš„å‰æä¸‹é€‚å½“å‡å°‘é”®çš„é•¿åº¦ï¼Œ ä¾‹å¦‚å˜ä¸º<code>&quot;u:{uid}:fr:m:{mid}&quot;</code>, ä»è€Œå‡å°‘ç”±äºé”®è¿‡é•¿çš„å†…å­˜æµªè´¹ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e4babf27-43ae-4acf-be62-fad0bb243223-2"><p>è®¸å¤šåº”ç”¨éƒ½ä¼šä½¿ç”¨Redisä½œä¸ºè®¡æ•°çš„åŸºç¡€å·¥å…·ï¼Œ å®ƒå¯ä»¥å®ç°å¿«é€Ÿè®¡æ•°ã€ æŸ¥è¯¢ç¼“å­˜çš„åŠŸèƒ½ï¼ŒåŒæ—¶æ•°æ®å¯ä»¥å¼‚æ­¥è½åœ°åˆ°å…¶ä»–æ•°æ®æºã€‚</p><p>ä¾‹å¦‚è§†é¢‘æ’­æ”¾æ•°è®¡ç³»ç»Ÿå°±æ˜¯ä½¿ç”¨Redisä½œä¸ºè§†é¢‘æ’­æ”¾æ•°è®¡æ•°çš„åŸºç¡€ç»„ä»¶ï¼Œ ç”¨æˆ·æ¯æ’­æ”¾ä¸€æ¬¡è§†é¢‘ï¼Œ ç›¸åº”çš„è§†é¢‘æ’­æ”¾æ•°å°±ä¼šè‡ªå¢1ã€‚</p><p>å®é™…ä¸Šä¸€ä¸ªçœŸå®çš„è®¡æ•°ç³»ç»Ÿè¦è€ƒè™‘çš„é—®é¢˜ä¼šå¾ˆå¤šï¼šé˜²ä½œå¼Šã€æŒ‰ç…§ä¸åŒç»´åº¦è®¡æ•°ï¼Œæ•°æ®æŒä¹…åŒ–åˆ°åº•å±‚æ•°æ®æºç­‰ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e4babf27-43ae-4acf-be62-fad0bb243223-3"><p>ä¸€ä¸ªåˆ†å¸ƒå¼WebæœåŠ¡å°†ç”¨æˆ·çš„Sessionä¿¡æ¯ï¼ˆä¾‹å¦‚ç”¨æˆ·ç™»å½•ä¿¡æ¯ï¼‰ä¿å­˜åœ¨å„è‡ªæœåŠ¡å™¨ä¸­ï¼Œè¿™æ ·ä¼šé€ æˆä¸€ä¸ªé—®é¢˜ï¼Œå‡ºåƒè´Ÿè½½å‡è¡¡çš„è€ƒè™‘ï¼Œåˆ†å¸ƒå¼æœåŠ¡ä¼šå°†ç”¨æˆ·çš„è®¿é—®å‡è¡¡åˆ°ä¸åŒæœåŠ¡å™¨ä¸Šï¼Œç”¨æˆ·åˆ·æ–°ä¸€æ¬¡è®¿é—®å¯èƒ½ä¼šå‘ç°éœ€è¦é‡æ–°ç™»å½•ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯ç”¨æˆ·æ— æ³•å®¹å¿çš„ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨Rediså°†ç”¨æˆ·çš„Sessionè¿›è¡Œé›†ä¸­ç®¡ç†ï¼Œï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹åªè¦ä¿è¯Redisæ˜¯é«˜å¯ç”¨å’Œæ‰©å±•æ€§çš„ï¼Œæ¯æ¬¡ç”¨æˆ·æ›´æ–°æˆ–è€…æŸ¥è¯¢ç™»å½•ä¿¡æ¯éƒ½ç›´æ¥ä»Redisä¸­é›†ä¸­è·å–ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e4babf27-43ae-4acf-be62-fad0bb243223-4"><p>å¾ˆå¤šåº”ç”¨å‡ºäºå®‰å…¨çš„è€ƒè™‘ï¼Œä¼šåœ¨æ¯æ¬¡è¿›è¡Œç™»å½•æ—¶ï¼Œè®©ç”¨æˆ·è¾“å…¥æ‰‹æœºéªŒè¯ç ï¼Œä»è€Œç¡®å®šæ˜¯å¦æ˜¯ç”¨æˆ·æœ¬äººã€‚ä½†æ˜¯ä¸ºäº†çŸ­ä¿¡æ¥å£ä¸è¢«é¢‘ç¹è®¿é—®ï¼Œä¼šé™åˆ¶ç”¨æˆ·æ¯åˆ†é’Ÿè·å–éªŒè¯ç çš„é¢‘ç‡ï¼Œä¾‹å¦‚ä¸€åˆ†é’Ÿä¸èƒ½è¶…è¿‡5æ¬¡ã€‚</p><p>ä¸€äº›ç½‘ç«™é™åˆ¶ä¸€ä¸ªIP åœ°å€ä¸èƒ½åœ¨ä¸€ç§’é’Ÿä¹‹å†…è®¿é—´è¶…è¿‡n æ¬¡ä¹Ÿå¯ä»¥é‡‡ç”¨ç±»ä¼¼çš„æ€è·¯ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="Hashç±»å‹">Hashç±»å‹</h2><p>å‡ ä¹æ‰€æœ‰çš„ç¼–ç¨‹è¯­è¨€éƒ½æä¾›äº†å“ˆå¸Œ(hash) ç±»å‹ï¼Œå®ƒä»¬çš„å«æ³•å¯èƒ½æ˜¯å“ˆå¸Œã€å­—å…¸ã€å…³è”æ•°ç»„ã€‚åœ¨Redis ä¸­ï¼Œå“ˆå¸Œç±»å‹æ˜¯æŒ‡é”®å€¼æœ¬èº«åˆæ˜¯ä¸€ä¸ªé”®å€¼å¯¹ç»“æ„ï¼Œå½¢å¦‚<code>value=&#123;&#123;fi eldl,valuel&#125;,... &#123;fieldN,valueN&#125;&#125;</code>, Redisé”®å€¼å¯¹å’Œå“ˆå¸Œç±»å‹äºŒè€…çš„å…³ç³»å¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220525001227167.png" alt="image-20220525001227167"  /><p>å“ˆå¸Œç±»å‹ä¸­çš„æ˜ å°„å…³ç³»å«ä½œfield-value, æ³¨æ„è¿™é‡Œçš„valueæ˜¯æŒ‡fieldå¯¹åº”çš„å€¼ï¼Œä¸æ˜¯é”®å¯¹åº”çš„å€¼ï¼Œè¯·æ³¨æ„valueåœ¨ä¸åŒä¸Šä¸‹æ–‡çš„ä½œç”¨ã€‚</p><hr><h3 id="å¸¸è§å‘½ä»¤-2">å¸¸è§å‘½ä»¤</h3><div class="tabs" id="c3256886-0ff3-4b02-b127-c277beeba0ae"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c3256886-0ff3-4b02-b127-c277beeba0ae-1"><i class="fas fa-seedling"></i>è®¾ç½®å€¼</button></li><li class="tab"><button type="button" data-href="#c3256886-0ff3-4b02-b127-c277beeba0ae-2"><i class="fas fa-leaf"></i>è·å–å€¼</button></li><li class="tab"><button type="button" data-href="#c3256886-0ff3-4b02-b127-c277beeba0ae-3"><i class="fab fa-apple"></i>field</button></li><li class="tab"><button type="button" data-href="#c3256886-0ff3-4b02-b127-c277beeba0ae-4"><i class="fas fa-tree"></i>value</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c3256886-0ff3-4b02-b127-c277beeba0ae-1"><p><code>hset key field value</code></p><p>å¦‚æœè®¾ç½®æˆåŠŸä¼šè¿”å›1, åä¹‹ä¼šè¿”å›0ã€‚æ­¤å¤–Redisæä¾›äº†hsetnxå‘½ä»¤ï¼Œå®ƒä»¬çš„å…³ç³»å°±åƒsetå’Œsetnxå‘½ä»¤ä¸€æ ·ï¼Œåªä¸è¿‡ä½œç”¨åŸŸç”±é”®å˜ä¸ºfield ã€‚</p><p><code>hmset key field value [field value....]</code></p><p>æ‰¹é‡è®¾ç½®å€¼</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c3256886-0ff3-4b02-b127-c277beeba0ae-2"><p><code>hget key field</code></p><p>å¦‚æœé”®æˆ–fieldä¸å­˜åœ¨ï¼Œä¼šè¿”å›nil</p><p><code>hmget field [field ...]</code></p><p>æ‰¹é‡è·å–å€¼</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c3256886-0ff3-4b02-b127-c277beeba0ae-3"><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>hdel key field [field ...]</code></td><td>hdelä¼šåˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªfieldï¼Œè¿”å›åˆ é™¤fieldçš„ä¸ªæ•°</td></tr><tr><td><code>hlen key</code></td><td>è®¡ç®—keyä¸­fieldä¸ªæ•°</td></tr><tr><td><code>hexists key field</code></td><td>åˆ¤æ–­keyä¸­fieldæ˜¯å¦å­˜åœ¨</td></tr><tr><td><code>hkeys keys</code></td><td>è·å–keyä¸­æ‰€æœ‰field</td></tr><tr><td><code>hgetall key</code></td><td>è·å–keyçš„ç´¢å¼•field-value</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c3256886-0ff3-4b02-b127-c277beeba0ae-4"><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>hvals key</code></td><td>è·å–keyçš„æ‰€æœ‰value</td></tr><tr><td><code>hincrby key field</code></td><td>å¯¹åº”key-field-valueé€’å¢æ•´æ•°</td></tr><tr><td><code>hincrbyfloat key field</code></td><td>å¯¹åº”key-field-valueé€’å¢æµ®ç‚¹æ•°</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="å†…éƒ¨ç¼–ç -2">å†…éƒ¨ç¼–ç </h3><p>å“ˆå¸Œç±»å‹çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ï¼š</p><ul><li>listpack(å‹ç¼©åˆ—è¡¨)ï¼šå½“å“ˆå¸Œç±»å‹å…ƒç´ ä¸ªæ•°å°äºhash-max-listpack-entriesé…ç½®ï¼ˆé»˜è®¤512 ä¸ªï¼‰ã€åŒæ—¶æ‰€æœ‰å€¼éƒ½å°äºhash-max-listpackï¼value é…ç½®ï¼ˆé»˜è®¤64å­—èŠ‚ï¼‰æ—¶ï¼Œ Redis ä¼šä½¿ç”¨listpackä½œä¸ºå“ˆå¸Œçš„å†…éƒ¨å®ç°ï¼Œlistpackä½¿ç”¨æ›´åŠ ç´§å‡‘çš„ç»“æ„å®ç°å¤šä¸ªå…ƒç´ çš„è¿ç»­å­˜å‚¨ï¼Œæ‰€ä»¥åœ¨èŠ‚çœå†…å­˜æ–¹é¢æ¯”hashtableæ›´åŠ ä¼˜ç§€ã€‚</li><li>hashtable(å“ˆå¸Œè¡¨)ï¼šå½“å“ˆå¸Œç±»å‹æ— æ³•æ»¡è¶³ziplistçš„æ¡ä»¶æ—¶ï¼Œ Redisä¼šä½¿ç”¨hashtableä½œä¸ºå“ˆå¸Œçš„å†…éƒ¨å®ç°ï¼Œå› ä¸ºæ­¤æ—¶ziplistçš„è¯»å†™æ•ˆç‡ä¼šä¸‹é™ï¼Œè€Œhashtable çš„è¯»å†™æ—¶é—´å¤æ‚åº¦ä¸º0(1) ã€‚</li></ul><div class="tabs" id="73731162-3585-43b0-9a3a-0f1ac9d26ced"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#73731162-3585-43b0-9a3a-0f1ac9d26ced-1"><i class="fas fa-cat"></i>1</button></li><li class="tab"><button type="button" data-href="#73731162-3585-43b0-9a3a-0f1ac9d26ced-2"><i class="fas fa-horse"></i>2</button></li><li class="tab"><button type="button" data-href="#73731162-3585-43b0-9a3a-0f1ac9d26ced-3"><i class="fas fa-dove"></i>3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="73731162-3585-43b0-9a3a-0f1ac9d26ced-1"><p>å½“fieldä¸ªæ•°æ¯”è¾ƒå°‘ä¸”æ²¡æœ‰å¤§çš„value æ—¶ï¼Œå†…éƒ¨ç¼–ç ä¸ºlistpack</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hmset hashkey f1 v1 f2 v2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> hashkey</span><br><span class="line"><span class="built_in">hash</span></span><br><span class="line">127.0.0.1:6379&gt; object encoding hashkey</span><br><span class="line"><span class="string">&quot;listpack&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="73731162-3585-43b0-9a3a-0f1ac9d26ced-2"><p>å½“æœ‰valueå¤§åƒ64 å­—èŠ‚ï¼Œå†…éƒ¨ç¼–ç ä¼šç”±listpackå˜ä¸ºhashtable</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hset hashkey f3 <span class="string">&quot;one string is bigger than 64 byte ............................................................&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; object encoding hashkey</span><br><span class="line"><span class="string">&quot;hashtable&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="73731162-3585-43b0-9a3a-0f1ac9d26ced-3"><p>å½“fieldä¸ªæ•°è¶…è¿‡512, å†…éƒ¨ç¼–ç ä¹Ÿä¼šç”±listpackå˜ä¸ºhashtabl</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hset hashkey1 f4 v4 f5 v5 ......f513 v513</span><br><span class="line">ok</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; object encoding hashkey1</span><br><span class="line"><span class="string">&quot;hashtable&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="ä½¿ç”¨åœºæ™¯-2">ä½¿ç”¨åœºæ™¯</h3><p>ç›¸æ¯”äºä½¿ç”¨å­—ç¬¦ä¸²åºåˆ—åŒ–ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œå“ˆå¸Œç±»å‹å˜å¾—æ›´åŠ ç›´è§‚ï¼Œå¹¶ä¸”åœ¨æ›´æ–°æ“ä½œä¸Šä¼šæ›´åŠ ä¾¿æ·ã€‚å¯ä»¥å°†æ¯ä¸ªç”¨æˆ·çš„idå®šä¹‰ä¸ºé”®åç¼€ï¼Œå¤šå¯¹field-value å¯¹åº”æ¯ä¸ªç”¨æˆ·çš„å±æ€§ã€‚</p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»èƒ½å¤Ÿç”¨ä¸‰ç§æ–¹æ³•ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œä¸‹é¢ç»™å‡ºä¸‰ç§æ–¹æ¡ˆçš„å®ç°æ–¹æ³•å’Œä¼˜ç¼ºç‚¹åˆ†æã€‚</p><div class="tabs" id="93174b1e-5063-45a8-9951-073e9c3b1815"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#93174b1e-5063-45a8-9951-073e9c3b1815-1"><i class="fas fa-atom"></i>åŸç”Ÿå­—ç¬¦ä¸²ç±»å‹</button></li><li class="tab"><button type="button" data-href="#93174b1e-5063-45a8-9951-073e9c3b1815-2"><i class="far fa-sun"></i>2</button></li><li class="tab"><button type="button" data-href="#93174b1e-5063-45a8-9951-073e9c3b1815-3"><i class="fas fa-wind"></i>å“ˆå¸Œç±»å‹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="93174b1e-5063-45a8-9951-073e9c3b1815-1"><p>æ¯ä¸ªå±æ€§ä¸€ä¸ªé”®ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> user:1:name <span class="string">&quot;tom&quot;</span></span><br><span class="line"><span class="built_in">set</span> user:1:age 23</span><br><span class="line"><span class="built_in">set</span> user:1:city <span class="string">&quot;beijing&quot;</span></span><br></pre></td></tr></table></figure><p>ä¼˜ç‚¹ï¼šç®€å•ç›´è§‚ï¼Œæ¯ä¸ªå±æ€§éƒ½æ”¯å¾…æ›´æ–°æ“ä½œã€‚</p><p>ç¼ºç‚¹ï¼šå ç”¨è¿‡å¤šçš„é”®ï¼Œå†…å­˜å ç”¨é‡è¾ƒå¤§ï¼ŒåŒæ—¶ç”¨æˆ·ä¿¡æ¯å†…èšæ€§æ¯”è¾ƒå·®ï¼Œæ‰€ä»¥æ­¤ç§æ–¹æ¡ˆä¸€èˆ¬ä¸ä¼šåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="93174b1e-5063-45a8-9951-073e9c3b1815-2"><p>åºåˆ—åŒ–å­—ç¬¦ä¸²ç±»å‹ï¼šå°†ç”¨æˆ·ä¿¡æ¯åºåˆ—åŒ–åç”¨ä¸€ä¸ªé”®ä¿å­˜ã€‚</p><p><code>set user:1 serialize(userInfo)</code></p><p>ä¼˜ç‚¹ï¼šç®€åŒ–ç¼–ç¨‹ï¼Œå¦‚æœåˆç†çš„ä½¿ç”¨åºåˆ—åŒ–å¯ä»¥æé«˜å†…å­˜çš„ä½¿ç”¨æ•ˆç‡ã€‚</p><p>ç¼ºç‚¹ï¼šåºåˆ—åŒ–å’Œååºåˆ—åŒ–æœ‰ä¸€å®šçš„å¼€é”€ï¼ŒåŒæ—¶æ¯æ¬¡æ›´æ–°å±æ€§éƒ½éœ€è¦æŠŠå…¨éƒ¨æ•°æ®å–å‡ºè¿›è¡Œååºåˆ—åŒ–ï¼Œæ›´æ–°åå†åºåˆ—åŒ–åˆ°Redisä¸­ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="93174b1e-5063-45a8-9951-073e9c3b1815-3"><p>æ¯ä¸ªç”¨æˆ·å±æ€§ä½¿ç”¨ä¸€å¯¹field-value, ä½†æ˜¯åªç”¨ä¸€ä¸ªé”®ä¿å­˜ã€‚</p><p><code>hmset user:1 name &quot;tom&quot; age 23 city &quot;beijing&quot;</code></p><p>ä¼˜ç‚¹ï¼šç®€å•ç›´è§‚ï¼Œå¦‚æœä½¿ç”¨åˆç†å¯ä»¥å‡å°‘å†…å­˜ç©ºé—´çš„ä½¿ç”¨ã€‚</p><p>ç¼ºç‚¹ï¼šè¦æ§åˆ¶å“ˆå¸Œåœ¨listpackå’Œhashtableä¸¤ç§å†…éƒ¨ç¼–ç çš„è½¬æ¢ï¼Œ hashtableä¼šæ¶ˆè€—æ›´å¤šå†…å­˜ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><hr><h2 id="Listç±»å‹">Listç±»å‹</h2><p>åˆ—è¡¨(list)ç±»å‹æ˜¯ç”¨æ¥å­˜å‚¨å¤šä¸ªæœ‰åºçš„å­—ç¬¦ä¸²ï¼Œåˆ—è¡¨ä¸­çš„æ¯ä¸ªå­—ç¬¦ä¸²ç§°ä¸ºå…ƒç´ (element),ä¸€ä¸ªåˆ—è¡¨æœ€å¤šå¯ä»¥å­˜å‚¨2çš„32æ¬¡æ–¹ä¸ªå…ƒç´ ã€‚åœ¨Redisä¸­ï¼Œå¯ä»¥å¯¹åˆ—è¡¨ä¸¤ç«¯æ’å…¥(push) å’Œå¼¹å‡º(pop),è¿˜å¯ä»¥è·å–æŒ‡å®šèŒƒå›´çš„å…ƒç´ åˆ—è¡¨ã€è·å–æŒ‡å®šç´¢å¼•ä¸‹æ ‡çš„å…ƒç´ ç­‰ã€‚åˆ—è¡¨æ˜¯ä¸€ç§æ¯”è¾ƒçµæ´»çš„æ•°æ®ç»“æ„ï¼Œå®ƒå¯ä»¥å……å½“æ ˆå’Œé˜Ÿåˆ—çš„è§’è‰²ï¼Œåœ¨å®é™…å¼€å‘ä¸Šæœ‰å¾ˆå¤šåº”ç”¨åœºæ™¯ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/new.gif" alt="new"></p><p>åˆ—è¡¨ç±»å‹æœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š</p><p>ç¬¬ä¸€ã€åˆ—è¡¨ä¸­çš„å…ƒç´ æ˜¯æœ‰åºçš„ï¼Œè¿™å°±æ„å‘³ç€å¯ä»¥é€šè¿‡ç´¢å¼•ä¸‹æ ‡è·å–æŸä¸ªå…ƒç´ æˆ–è€…æŸä¸ªèŒƒå›´å†…çš„å…ƒç´ åˆ—è¡¨ã€‚</p><p>ç¬¬äºŒã€åˆ—è¡¨ä¸­çš„å…ƒç´ å¯ä»¥æ˜¯é‡å¤çš„ã€‚</p><hr><h3 id="å¸¸è§å‘½ä»¤-3">å¸¸è§å‘½ä»¤</h3><div class="tabs" id="9a7ceafc-8a90-480c-a138-38d48c77fbcd"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#9a7ceafc-8a90-480c-a138-38d48c77fbcd-1"><i class="fas fa-seedling"></i>æ·»åŠ æ“ä½œ</button></li><li class="tab"><button type="button" data-href="#9a7ceafc-8a90-480c-a138-38d48c77fbcd-2"><i class="fas fa-leaf"></i>æŸ¥æ‰¾</button></li><li class="tab"><button type="button" data-href="#9a7ceafc-8a90-480c-a138-38d48c77fbcd-3"><i class="fab fa-apple"></i>åˆ é™¤</button></li><li class="tab"><button type="button" data-href="#9a7ceafc-8a90-480c-a138-38d48c77fbcd-4"><i class="fas fa-tree"></i>ä¿®æ”¹</button></li><li class="tab"><button type="button" data-href="#9a7ceafc-8a90-480c-a138-38d48c77fbcd-5"><i class="fas fa-heartbeat"></i>é˜»å¡æ“ä½œ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="9a7ceafc-8a90-480c-a138-38d48c77fbcd-1"><p><code>rpush key value [value ....]</code></p><p>ä»å³è¾¹æ’å…¥å…ƒç´ </p><p><code>lpush key value [value]</code></p><p>ä»å·¦è¾¹æ’å…¥å…ƒç´ </p><p><code>linsert key before|after pivot value</code></p><p>linsertå‘½ä»¤ä¼šä»åˆ—è¡¨ä¸­æ‰¾åˆ°ç­‰äºpivotçš„å…ƒç´ ï¼Œåœ¨å…¶å‰(before)æˆ–è€…å(after) æ’å…¥ä¸€ä¸ªæ–°çš„å…ƒç´ value</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9a7ceafc-8a90-480c-a138-38d48c77fbcd-2"><p><code>lrange key start end </code></p><p>è·å–æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ åˆ—è¡¨ï¼Œstartä¸º0ï¼Œendä¸º-1æ˜¯è¡¨ç¤ºè·å–æ‰€æœ‰å…ƒç´ </p><p><code>lindex key index</code></p><p>è·å–åˆ—è¡¨æŒ‡å®šç´¢å¼•ä¸‹æ ‡çš„å…ƒç´ </p><p><code>llen key</code></p><p>è·å–åˆ—è¡¨é•¿åº¦</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9a7ceafc-8a90-480c-a138-38d48c77fbcd-3"><p><code>lpop key</code></p><p>ä»åˆ—è¡¨å·¦ä¾§å¼¹å‡ºå…ƒç´ </p><p><code>rpop key</code></p><p>ä»åˆ—è¡¨å³ä¾§å¼¹å‡º</p><p><code>ltrim key start end</code></p><p>æŒ‰ç…§ç´¢å¼•èŒƒå›´ä¿®å‰ªåˆ—è¡¨</p><p><code>lrem key count value</code></p><p>åˆ é™¤æŒ‡å®šå…ƒç´ </p><p>lrem å‘½ä»¤ä¼šä»åˆ—è¡¨ä¸­æ‰¾åˆ°ç­‰åƒvalue çš„å…ƒç´ è¿›è¡Œåˆ é™¤ï¼Œæ ¹æ®countçš„ä¸åŒåˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š</p><ul><li>countï¼0, ä»å·¦åˆ°å³ï¼Œåˆ é™¤æœ€å¤šcountä¸ªå…ƒç´ </li><li>count&lt;0, ä»å³åˆ°å·¦ï¼Œåˆ é™¤æœ€å¤šcountç»å¯¹å€¼ä¸ªå…ƒç´ </li><li>count=0,åˆ é™¤æ‰€æœ‰</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9a7ceafc-8a90-480c-a138-38d48c77fbcd-4"><p><code>lset key index newValue</code></p><p>ä¿®æ”¹æŒ‡å®šç´¢å¼•ä¸‹æ ‡çš„å…ƒç´ </p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9a7ceafc-8a90-480c-a138-38d48c77fbcd-5"><p>é˜»å¡å¼å¼¹å‡ºå¦‚ä¸‹ï¼š</p><p><code>blpop key [key . . .] timeout </code></p><p><code>brpop key [key . . .] timeout</code></p><p>blpopå’Œbrpopæ˜¯lpopå’Œrpopçš„é˜»å¡ç‰ˆæœ¬ï¼Œå®ƒä»¬é™¤äº†å¼¹å‡ºæ–¹å‘ä¸åŒï¼Œä½¿ç”¨æ–¹æ³•åŸºæœ¬ç›¸åŒï¼Œæ‰€ä»¥ä¸‹é¢ä»¥brpopå‘½ä»¤è¿›è¡Œè¯´æ˜ï¼Œ brpopå‘½ä»¤åŒ…å«ä¸¤ä¸ªå‚æ•°ï¼š</p><p>[key . . .]  å¤šä¸ªåˆ—è¡¨çš„é”®</p><p>timeout é˜»å¡æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰</p><p>1)åˆ—è¡¨ä¸ºç©ºï¼šå¦‚æœtimeout =3 ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯è¦ç­‰åˆ°3ç§’åè¿”å›nilï¼Œå¦‚æœtimeoutï¼ 0ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¸€ç›´é˜»å¡ç­‰ä¸‹å»</p><p>2)åˆ—è¡¨ä¸ºç©ºï¼šå¦‚æœæ­¤æœŸé—´æ·»åŠ äº†æ•°æ®elementï¼Œå®¢æˆ·ç«¯ç«‹å³è¿”å›</p><p>3)åˆ—è¡¨ä¸ä¸ºç©ºï¼šå®¢æˆ·ç«¯ä¼šç«‹å³è¿”å›</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="å†…éƒ¨ç¼–ç -3">å†…éƒ¨ç¼–ç </h3><p>åˆ—è¡¨ç±»å‹çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ã€‚</p><p>ziplist(å‹ç¼©åˆ—è¡¨)ï¼š å½“åˆ—è¡¨çš„å…ƒç´ ä¸ªæ•°å°äºlist-max-ziplist-entriesé…ç½®(é»˜è®¤512ä¸ª)ï¼ŒåŒæ—¶åˆ—è¡¨ä¸­æ¯ä¸ªå…ƒç´ çš„å€¼éƒ½å°äºlist-max-ziplistï¼value é…ç½®ï¼ˆé»˜è®¤64å­—èŠ‚ï¼‰æ—¶ï¼Œ Redis ä¼šä½¿ç”¨ziplistä½œä¸ºåˆ—è¡¨çš„å†…éƒ¨å®ç°ã€‚</p><p>linkedlist(é“¾è¡¨)ï¼šå½“åˆ—è¡¨ç±»å‹æ— æ³•æ»¡è¶³ziplistçš„æ¡ä»¶æ—¶ï¼Œ Redisä¼šä½¿ç”¨linkedlistä½œä¸ºåˆ—è¡¨çš„å†…éƒ¨å®ç°ã€‚</p><p>Redis3.2 ç‰ˆæœ¬æä¾›äº†quicklistå†…éƒ¨ç¼–ç ï¼Œç®€å•åœ°è¯´å®ƒæ˜¯ä»¥ä¸€ä¸ªziplistä¸ºèŠ‚ç‚¹çš„linkedlist,å®ƒç»“åˆäº†ziplistå’Œlinkedlistä¸¤è€…çš„ä¼˜åŠ¿ï¼Œä¸ºåˆ—è¡¨ç±»å‹æä¾›äº†ä¸€ç§æ›´ä¸ºä¼˜ç§€çš„å†…éƒ¨ç¼–ç å®ç°ã€‚</p><hr><h3 id="ä½¿ç”¨åœºæ™¯-3">ä½¿ç”¨åœºæ™¯</h3><p>Redis çš„lpush+brpopå‘½ä»¤ç»„åˆå³å¯å®ç°é˜»å¡é˜Ÿåˆ—ï¼Œç”Ÿäº§è€…å®¢æˆ·ç«¯ä½¿ç”¨lrpush ä»åˆ—è¡¨å·¦ä¾§æ’å…¥å…ƒç´ ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å®¢æˆ·ç«¯ä½¿ç”¨brpopå‘½ä»¤é˜»å¡å¼çš„ï¼‚æŠ¢ï¼‚åˆ—è¡¨å°¾éƒ¨çš„å…ƒç´ ï¼Œå¤šä¸ªå®¢æˆ·ç«¯ä¿è¯äº†æ¶ˆè´¹çš„è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨æ€§ã€‚</p><p>å®é™…ä¸Šåˆ—è¡¨çš„ä½¿ç”¨åœºæ™¯å¾ˆå¤šï¼Œåœ¨é€‰æ‹©æ—¶å¯ä»¥å‚è€ƒä»¥ä¸‹å£è¯€</p><p>lpush+lpop = Stack(æ ˆ)</p><p>lpush+rpop = Queue(é˜Ÿåˆ—)</p><p>lpush+ltrim = Capped Collection(æœ‰é™é›†åˆ)</p><p>lpush+brpop = Message Queue(æ¶ˆæ¯é˜Ÿåˆ—)</p><hr><hr><h2 id="Setç±»å‹">Setç±»å‹</h2><p>é›†åˆ(set)ç±»å‹ä¹Ÿæ˜¯ç”¨æ¥ä¿å­˜å¤šä¸ªçš„å­—ç¬¦ä¸²å…ƒç´ ï¼Œä½†å’Œåˆ—è¡¨ç±»å‹ä¸ä¸€æ ·çš„æ˜¯ï¼Œé›†åˆä¸­ä¸å…è®¸æœ‰é‡å¤å…ƒç´ ï¼Œå¹¶ä¸”é›†åˆä¸­çš„å…ƒç´ æ˜¯æ— åºçš„ï¼Œä¸èƒ½é€šè¿‡ç´¢å¼•ä¸‹æ ‡è·å–å…ƒç´ ã€‚ä¸€ä¸ªé›†</p><p>åˆæœ€å¤šå¯ä»¥å­˜å‚¨2çš„32æ¬¡æ–¹- 1ä¸ªå…ƒç´ ã€‚</p><p>Redisé™¤äº†æ”¯æŒé›†åˆå†…çš„å¢åˆ æ”¹æŸ¥ï¼ŒåŒæ—¶è¿˜æ”¯æŒå¤šä¸ªé›†åˆå–äº¤é›†ã€å¹¶é›†ã€å·®é›†ï¼Œåˆç†åœ°ä½¿ç”¨å¥½é›†åˆç±»å‹ï¼Œèƒ½åœ¨å®é™…å¼€å‘ä¸­è§£å†³å¾ˆå¤šå®é™…é—®é¢˜ã€‚</p><hr><h3 id="å¸¸è§å‘½ä»¤-4">å¸¸è§å‘½ä»¤</h3><div class="tabs" id="ae2f84aa-7721-4abd-bbcb-20d3a2f0410a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ae2f84aa-7721-4abd-bbcb-20d3a2f0410a-1"><i class="fas fa-seedling"></i>æ·»åŠ å…ƒç´ </button></li><li class="tab"><button type="button" data-href="#ae2f84aa-7721-4abd-bbcb-20d3a2f0410a-2"><i class="fas fa-leaf"></i>åˆ é™¤å…ƒç´ </button></li><li class="tab"><button type="button" data-href="#ae2f84aa-7721-4abd-bbcb-20d3a2f0410a-3"><i class="fab fa-apple"></i>é›†åˆæ“ä½œ</button></li><li class="tab"><button type="button" data-href="#ae2f84aa-7721-4abd-bbcb-20d3a2f0410a-4"><i class="fas fa-tree"></i>é›†åˆé—´æ“ä½œ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ae2f84aa-7721-4abd-bbcb-20d3a2f0410a-1"><p><code>sadd key element [element ...]</code></p><p>è¿”å›ç»“æœä¸ºæ·»åŠ æˆåŠŸçš„å…ƒç´ ä¸ªæ•°</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ae2f84aa-7721-4abd-bbcb-20d3a2f0410a-2"><p><code>srem key element [element ...]</code></p><p>è¿”å›ç»“æœä¸ºæˆåŠŸåˆ é™¤å…ƒç´ ä¸ªæ•°</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ae2f84aa-7721-4abd-bbcb-20d3a2f0410a-3"><p><code>smembers key</code></p><p>è·å–æ‰€æœ‰å…ƒç´ </p><p><code>scard key</code></p><p>è®¡ç®—å…ƒç´ ä¸ªæ•°,scard çš„æ—¶é—´å¤æ‚åº¦ä¸º0(1), å®ƒä¸ä¼šéå†é›†åˆæ‰€æœ‰å…ƒç´ ï¼Œè€Œæ˜¯ç›´æ¥ç”¨Rediså†…éƒ¨çš„å˜é‡</p><p><code>sismember key element</code></p><p>åˆ¤æ–­å…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­ï¼Œå¦‚æœç»™å®šå…ƒç´ elementåœ¨é›†åˆå†…è¿”å›1, åä¹‹è¿”å›0</p><p><code>srandmember key [count]</code></p><p>éšæœºä»é›†åˆè¿”å›æŒ‡å®šä¸ªæ•°å…ƒç´ ï¼Œ[count]æ˜¯å¯é€‰å‚æ•°ï¼Œå¦‚æœä¸å†™é»˜è®¤ä¸º1</p><p><code>spop key</code></p><p>ä»é›†åˆéšæœºå¼¹å‡ºå…ƒç´ ,srandmember å’Œspopéƒ½æ˜¯éšæœºä»é›†åˆé€‰å‡ºå…ƒç´ ï¼Œä¸¤è€…ä¸åŒçš„æ˜¯spopå‘½ä»¤æ‰§è¡Œåï¼Œå…ƒç´ ä¼šä»é›†åˆä¸­åˆ é™¤ï¼Œè€Œsrandmember ä¸ä¼šã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ae2f84aa-7721-4abd-bbcb-20d3a2f0410a-4"><p><code>sinter key [key ...]</code></p><p>æ±‚å¤šä¸ªé›†åˆçš„äº¤é›†</p><p><code>suinon key [key ...]</code></p><p>æ±‚å¤šä¸ªé›†åˆçš„å¹¶é›†</p><p><code>sdiff key [key ...]</code></p><p>æ±‚å¤šä¸ªé›†åˆçš„å·®é›†</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sinterstore</span> destination_key<span class="meta"> [key1 key2 ...]</span></span><br><span class="line"><span class="attribute">suinonstore</span> destination_key<span class="meta"> [key1 key2 ...]</span></span><br><span class="line"><span class="attribute">sdiffstore</span> destination_key<span class="meta"> [key1 key2 ...]</span></span><br></pre></td></tr></table></figure><p>å°†äº¤é›†ã€å¹¶é›†ã€å·®é›†çš„ç»“æœä¿å­˜åˆ°destination_keyä¸­</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="å†…éƒ¨ç¼–ç -4">å†…éƒ¨ç¼–ç </h3><p>é›†åˆç±»å‹çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ï¼š</p><ul><li>intset(æ•´æ•°é›†åˆ)ï¼šå½“é›†åˆå…ƒç´ ä¸ªæ•°å°äºset-max-intset-entriesé…ç½®ï¼ˆé»˜è®¤512 ä¸ªï¼‰ï¼ŒRedis ä¼šä½¿ç”¨intsetä½œä¸ºé›†åˆçš„å†…éƒ¨å®ç°ï¼Œä»è€Œå‡å°‘å†…å­˜çš„ä½¿ç”¨ã€‚</li><li>hashtable(å“ˆå¸Œè¡¨)ï¼šå½“é›†åˆç±»å‹æ— æ³•æ»¡è¶³intsetçš„æ¡ä»¶æ—¶ï¼Œ Redisä¼šä½¿ç”¨hashtableä½œä¸ºé›†åˆçš„å†…éƒ¨å®ç°ã€‚</li></ul><p>å½“å…ƒç´ ä¸ªæ•°è¾ƒå°‘ä¸”éƒ½ä¸ºæ•´æ•°æ—¶ï¼Œå†…éƒ¨ç¼–ç ä¸ºintset</p><p>å½“æŸä¸ªå…ƒç´ ä¸ä¸ºæ•´æ•°æ—¶ï¼Œå†…éƒ¨ç¼–ç ä¹Ÿä¼šå˜ä¸ºhashtable</p><p>å½“å…ƒç´ ä¸ªæ•°è¶…è¿‡512 ä¸ªï¼Œå†…éƒ¨ç¼–ç å˜ä¸ºhashtable</p><hr><h3 id="ä½¿ç”¨åœºæ™¯-4">ä½¿ç”¨åœºæ™¯</h3><p>é›†åˆç±»å‹æ¯”è¾ƒå…¸å‹çš„ä½¿ç”¨åœºæ™¯æ˜¯æ ‡ç­¾(tag)ã€‚ä¾‹å¦‚ä¸€ä¸ªç”¨æˆ·å¯èƒ½å¯¹å¨±ä¹ã€ä½“è‚²æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œå¦ä¸€ä¸ªç”¨æˆ·å¯èƒ½å¯¹å†å²ã€æ–°é—»æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œè¿™äº›å…´è¶£ç‚¹å°±æ˜¯æ ‡ç­¾ã€‚æœ‰äº†è¿™äº›æ•°æ®å°±å¯ä»¥å¾—åˆ°å–œæ¬¢åŒä¸€ä¸ªæ ‡ç­¾çš„äººï¼Œä»¥åŠç”¨æˆ·çš„å…±åŒå–œå¥½çš„æ ‡ç­¾ï¼Œè¿™äº›æ•°æ®å¯¹äºç”¨æˆ·ä½“éªŒä»¥åŠå¢å¼ºç”¨æˆ·é»åº¦æ¯”è¾ƒé‡è¦ã€‚ä¾‹å¦‚ä¸€ä¸ªç”µå­å•†åŠ¡çš„ç½‘ç«™ä¼šå¯¹ä¸åŒæ ‡ç­¾çš„ç”¨æˆ·åšä¸åŒç±»å‹çš„æ¨èï¼Œæ¯”å¦‚å¯¹æ•°ç äº§å“æ¯”è¾ƒæ„Ÿå…´è¶£çš„äººï¼Œåœ¨å„ä¸ªé¡µé¢æˆ–è€…é€šè¿‡é‚®ä»¶çš„å½¢å¼ç»™ä»–ä»¬æ¨èæœ€æ–°çš„æ•°ç äº§å“ï¼Œé€šå¸¸ä¼šä¸ºç½‘ç«™å¸¦æ¥æ›´å¤šçš„åˆ©ç›Šã€‚</p><hr><hr><h2 id="SortedSetç±»å‹">SortedSetç±»å‹</h2><p>æœ‰åºé›†åˆç›¸å¯¹äºå“ˆå¸Œã€åˆ—è¡¨ã€é›†åˆæ¥è¯´ä¼šæœ‰ä¸€ç‚¹ç‚¹é™Œç”Ÿï¼Œä½†æ—¢ç„¶å«æœ‰åºé›†åˆï¼Œé‚£ä¹ˆå®ƒå’Œé›†åˆå¿…ç„¶æœ‰ç€è”ç³»ï¼Œå®ƒä¿ç•™äº†é›†åˆä¸èƒ½æœ‰é‡å¤æˆå‘˜çš„ç‰¹æ€§ï¼Œä½†ä¸åŒçš„æ˜¯ï¼Œæœ‰åºé›†åˆä¸­çš„å…ƒç´ å¯ä»¥æ’åºã€‚ä½†æ˜¯å®ƒå’Œåˆ—è¡¨ä½¿ç”¨ç´¢å¼•ä¸‹æ ‡ä½œä¸ºæ’åºä¾æ®ä¸åŒçš„æ˜¯ï¼Œå®ƒç»™æ¯ä¸ªå…ƒç´ è®¾ç½®ä¸€ä¸ªåˆ†æ•°(scoreï¼‰ ï¼Œå¯ä»¥åŸºäºscoreå±æ€§å¯¹å…ƒç´ æ’åºï¼Œåº•å±‚çš„å®ç°æ˜¯ä¸€ä¸ªè·³è¡¨ï¼ˆSkipListï¼‰åŠ  hashè¡¨ã€‚</p><blockquote><p>æœ‰åºé›†åˆä¸­çš„å…ƒç´ ä¸èƒ½é‡å¤ï¼Œä½†æ˜¯score å¯ä»¥é‡å¤ï¼Œå°±å’Œä¸€ä¸ªç­é‡Œçš„åŒå­¦å­¦å·ä¸èƒ½é‡å¤ï¼Œä½†æ˜¯è€ƒè¯•æˆç»©å¯ä»¥ç›¸åŒã€‚</p></blockquote><h3 id="å¸¸è§å‘½ä»¤-5">å¸¸è§å‘½ä»¤</h3><div class="tabs" id="ceb52e25-aef0-4aae-9d3b-c0c2a49b0cdf"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ceb52e25-aef0-4aae-9d3b-c0c2a49b0cdf-1"><i class="fas fa-seedling"></i>æ·»åŠ æˆå‘˜</button></li><li class="tab"><button type="button" data-href="#ceb52e25-aef0-4aae-9d3b-c0c2a49b0cdf-2"><i class="fas fa-leaf"></i>åˆ é™¤æˆå‘˜</button></li><li class="tab"><button type="button" data-href="#ceb52e25-aef0-4aae-9d3b-c0c2a49b0cdf-3"><i class="fab fa-apple"></i>é›†åˆæ“ä½œ</button></li><li class="tab"><button type="button" data-href="#ceb52e25-aef0-4aae-9d3b-c0c2a49b0cdf-4"><i class="fas fa-tree"></i>é›†åˆé—´æ“ä½œ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ceb52e25-aef0-4aae-9d3b-c0c2a49b0cdf-1"><p><code>zadd key score member [score member ...]</code></p><p>è¿”å›ç»“æœä»£è¡¨æˆåŠŸæ·»åŠ æˆå‘˜çš„ä¸ªæ•°</p><p>zadd å‘½ä»¤æ·»åŠ äº†nx ã€xx ã€ch ã€incr å››ä¸ªé€‰é¡¹</p><p>â€¢ nx: memberå¿…é¡»ä¸å­˜åœ¨ï¼Œæ‰å¯ä»¥è®¾ç½®æˆåŠŸï¼Œç”¨äºæ·»åŠ </p><p>â€¢ xx: memberå¿…é¡»å­˜åœ¨ï¼Œæ‰å¯ä»¥è®¾ç½®æˆåŠŸï¼Œç”¨äºæ›´æ–°</p><p>â€¢ ch: è¿”å›æ­¤æ¬¡æ“ä½œåï¼Œæœ‰åºé›†åˆå…ƒç´ å’Œåˆ†æ•°å‘ç”Ÿå˜åŒ–çš„ä¸ªæ•°</p><p>â€¢ incrï¼šå¯¹score åšå¢åŠ ï¼Œç›¸å½“äºåé¢ä»‹ç»çš„zincrby</p><p>æœ‰åºé›†åˆç›¸æ¯”é›†åˆæä¾›äº†æ’åºå­—æ®µï¼Œä½†æ˜¯ä¹Ÿäº§ç”Ÿäº†ä»£ä»·ï¼Œ zadd çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(lo g(n)), sadd çš„æ—¶é—´å¤æ‚åº¦ä¸º0(1)ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ceb52e25-aef0-4aae-9d3b-c0c2a49b0cdf-2"><p><code>zrem key member [member ...]</code></p><p>è¿”å›ç»“æœä¸ºæˆåŠŸåˆ é™¤çš„ä¸ªæ•°ã€‚</p><p><code>zremrangebyrank key start end</code></p><p>åˆ é™¤æŒ‡å®šæ’åå†…çš„å‡åºå…ƒç´ </p><p><code>zremrangebyscore key min max</code></p><p>åˆ é™¤æŒ‡å®šåˆ†æ•°èŒƒå›´çš„æˆå‘˜</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ceb52e25-aef0-4aae-9d3b-c0c2a49b0cdf-3"><p><code>zcard key</code></p><p>è®¡ç®—æˆå‘˜ä¸ªæ•°</p><p><code>zscore key member</code></p><p>è®¡ç®—æŸä¸ªæˆå‘˜çš„åˆ†æ•°</p><p><code>zincrby key increment member</code></p><p>å¢åŠ æˆå‘˜çš„åˆ†æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zrange key start end [withscores]</span><br><span class="line">zrevrange key start end [withscores]</span><br></pre></td></tr></table></figure><p>è¿”å›æŒ‡å®šæ’åèŒƒå›´çš„æˆå‘˜,æœ‰åºé›†åˆæ˜¯æŒ‰ç…§åˆ†å€¼æ’åçš„ï¼Œ zran g e æ˜¯ä»ä½åˆ°é«˜è¿”å›ï¼Œ zrevran g e åä¹‹ã€‚ä¸‹é¢ä»£ç </p><p>è¿”å›æ’åæœ€ä½çš„æ˜¯ä¸‰ä¸ªæˆå‘˜ï¼Œå¦‚æœåŠ ä¸Šw it hscores é€‰é¡¹ï¼ŒåŒæ—¶ä¼šè¿”å›æˆå‘˜çš„åˆ†æ•°ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zrank key member</span><br><span class="line">zrevrank key member</span><br></pre></td></tr></table></figure><p>è®¡ç®—æˆå‘˜çš„æ’å,zrank æ˜¯ä»åˆ†æ•°ä»ä½åˆ°é«˜è¿”å›æ’åï¼Œ zrevrank åä¹‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zrangebyscore key min max [withsocre] [<span class="built_in">limit</span> offset count]</span><br><span class="line">zrevrangebyscore key min max [withsocre] [<span class="built_in">limit</span> offset count]</span><br></pre></td></tr></table></figure><p>è¿”å›æŒ‡å®šåˆ†æ•°èŒƒå›´çš„æˆå‘˜,å…¶ä¸­zrangebyscoreæŒ‰ç…§åˆ†æ•°ä»ä½åˆ°é«˜è¿”å›ï¼Œzrevrangebyscoreåä¹‹,withscoresé€‰é¡¹ä¼šåŒæ—¶è¿”å›æ¯ä¸ªæˆå‘˜çš„åˆ†æ•°ã€‚</p><p>[limit offset count]é€‰é¡¹å¯ä»¥é™åˆ¶è¾“å‡ºçš„èµ·å§‹ä½ç½®å’Œä¸ªæ•°</p><p><code>zcount key min max </code></p><p>è¿”å›æŒ‡å®šåˆ†æ•°èŒƒå›´æˆå‘˜ä¸ªæ•°</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ceb52e25-aef0-4aae-9d3b-c0c2a49b0cdf-4"><div class="tabs" id="ad595fb0-f098-427c-8472-85c3ecf2eedc"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ad595fb0-f098-427c-8472-85c3ecf2eedc-1"><i class="fas fa-cat"></i>å¯¼å…¥æ•°æ®</button></li><li class="tab"><button type="button" data-href="#ad595fb0-f098-427c-8472-85c3ecf2eedc-2"><i class="fas fa-horse"></i>äº¤é›†</button></li><li class="tab"><button type="button" data-href="#ad595fb0-f098-427c-8472-85c3ecf2eedc-3"><i class="fas fa-dove"></i>å¹¶é›†</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ad595fb0-f098-427c-8472-85c3ecf2eedc-1"><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">zadd</span> user:ranking:<span class="number">1</span> <span class="number">1</span> kris <span class="number">91</span> mike <span class="number">200</span> frank <span class="number">220</span> tim <span class="number">250</span> martin <span class="number">251</span> tom</span><br><span class="line"><span class="attribute">zadd</span> user:ranking:<span class="number">2</span> <span class="number">8</span> james <span class="number">77</span> mike <span class="number">625</span> martin <span class="number">888</span> tom</span><br></pre></td></tr></table></figure><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230606161459008.png" alt="image-20230606161459008" style="zoom:33%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ad595fb0-f098-427c-8472-85c3ecf2eedc-2"><p><code>zinterstore destination numkeys key [key ...] [weights weight [weight ...]] [aggregate sum|min|max]</code></p><p>äº¤é›†:è¿™ä¸ªå‘½ä»¤å‚æ•°è¾ƒå¤šï¼Œä¸‹é¢åˆ†åˆ«è¿›è¡Œè¯´æ˜ï¼š</p><p>destination: äº¤é›†è®¡ç®—ç»“æœä¿å­˜åˆ°è¿™ä¸ªé”®ã€‚</p><p>numkeys: éœ€è¦åšäº¤é›†è®¡ç®—é”®çš„ä¸ªæ•°ã€‚</p><p>key [key â€¦]:éœ€è¦åšäº¤é›†è®¡ç®—çš„é”®ã€‚</p><p>[weights weight [weight â€¦]]:æ¯ä¸ªé”®çš„æƒé‡ï¼Œåœ¨åšäº¤é›†è®¡ç®—æ—¶ï¼Œæ¯ä¸ªé”®ä¸­çš„æ¯ä¸ªmember ä¼šå°†è‡ªå·±åˆ†æ•°ä¹˜ä»¥è¿™ä¸ªæƒé‡ï¼Œæ¯ä¸ªé”®çš„æƒé‡é»˜è®¤æ˜¯1ã€‚</p><p>aggregate sum|min|max:è®¡ç®—æˆå‘˜äº¤é›†åï¼Œåˆ†å€¼å¯ä»¥æŒ‰ç…§sumå’Œã€minæœ€å°å€¼ã€maxæœ€å¤§å€¼åšæ±‡æ€»ï¼Œé»˜è®¤å€¼æ˜¯sum ã€‚</p><p><mark class="hl-label blue">ç¤ºä¾‹</mark></p><p>ä¸‹é¢æ“ä½œå¯¹user:ranking:1å’Œuser:ranking:2åšäº¤é›†ï¼Œ weightå’Œaggregateä½¿ç”¨äº†é»˜è®¤é…ç½®ï¼Œå¯ä»¥çœ‹åˆ°ç›®æ ‡é”®user:ranking:interå¯¹åˆ†å€¼åšäº†sum æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">zinterstore user:ranking:inter 2 user:ranking:1 user:ranking:2 </span><br><span class="line">zrange user:ranking:inter 0 -1 withscores </span><br><span class="line">1) <span class="string">&quot;mike&quot;</span></span><br><span class="line">2) <span class="string">&quot;168&quot;</span></span><br><span class="line">3) <span class="string">&quot;martin&quot;</span></span><br><span class="line">4) <span class="string">&quot;875&quot;</span></span><br><span class="line">5) <span class="string">&quot;tom&quot;</span></span><br><span class="line">6) <span class="string">&quot;1139&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ad595fb0-f098-427c-8472-85c3ecf2eedc-3"><p><code>zunionstore destination numkeys key [key ...] [weights weight [weight ...]] [aggregate sum|min|max]</code></p><p>å‚æ•°å’Œzinterstoreæ˜¯ä¸€è‡´çš„ï¼Œåªä¸è¿‡æ˜¯åšå¹¶é›†è®¡ç®—</p><p><mark class="hl-label blue">ç¤ºä¾‹</mark></p><p>ä¸‹é¢æ“ä½œå¯¹user:ranking:1å’Œuser:ranking:2åšå¹¶é›†ï¼Œ weightå’Œaggregateä½¿ç”¨äº†é»˜è®¤é…ç½®ï¼Œå¯ä»¥çœ‹åˆ°ç›®æ ‡é”®user:ranking:unionå¯¹åˆ†å€¼åšäº†sumæ“ä½œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">zunionstore user:ranking:union 2 user:ranking:1 user:ranking:2 </span><br><span class="line">zrange user:ranking:union 0 -1 withscores </span><br><span class="line"> 1) <span class="string">&quot;kris&quot;</span></span><br><span class="line"> 2) <span class="string">&quot;1&quot;</span></span><br><span class="line"> 3) <span class="string">&quot;james&quot;</span></span><br><span class="line"> 4) <span class="string">&quot;8&quot;</span></span><br><span class="line"> 5) <span class="string">&quot;mike&quot;</span></span><br><span class="line"> 6) <span class="string">&quot;168&quot;</span></span><br><span class="line"> 7) <span class="string">&quot;frank&quot;</span></span><br><span class="line"> 8) <span class="string">&quot;200&quot;</span></span><br><span class="line"> 9) <span class="string">&quot;tim&quot;</span></span><br><span class="line">10) <span class="string">&quot;220&quot;</span></span><br><span class="line">11) <span class="string">&quot;martin&quot;</span></span><br><span class="line">12) <span class="string">&quot;875&quot;</span></span><br><span class="line">13) <span class="string">&quot;tom&quot;</span></span><br><span class="line">14) <span class="string">&quot;1139&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="å†…éƒ¨ç¼–ç -5">å†…éƒ¨ç¼–ç </h3><p>æœ‰åºé›†åˆç±»å‹çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ï¼š</p><p>ziplist(å‹ç¼©åˆ—è¡¨)ï¼š å½“åˆ—è¡¨çš„å…ƒç´ ä¸ªæ•°å°äºlist-max-ziplist-entriesé…ç½®(é»˜è®¤512ä¸ª)ï¼ŒåŒæ—¶åˆ—è¡¨ä¸­æ¯ä¸ªå…ƒç´ çš„å€¼éƒ½å°äºlist-max-ziplistï¼value é…ç½®ï¼ˆé»˜è®¤64å­—èŠ‚ï¼‰æ—¶ï¼Œ Redis ä¼šä½¿ç”¨ziplistä½œä¸ºæœ‰åºçš„å†…éƒ¨å®ç°ã€‚</p><p>skiplist(è·³è¡¨)ï¼šå½“æ— æ³•æ»¡è¶³ziplistçš„æ¡ä»¶æ—¶ï¼Œ Redisä¼šä½¿ç”¨skiplistä½œä¸ºæœ‰åºé›†åˆçš„å†…éƒ¨å®ç°ï¼Œå› ä¸ºæ­¤æ—¶ziplistçš„è¯»å†™æ•ˆç‡ä¼šä¸‹é™ã€‚</p><p>å½“å…ƒç´ ä¸ªæ•°è¾ƒå°‘ä¸”æ¯ä¸ªå…ƒç´ è¾ƒå°æ—¶ï¼Œå†…éƒ¨ç¼–ç ä¸ºziplist</p><p>å½“å…ƒç´ ä¸ªæ•°è¶…è¿‡128 ä¸ªï¼Œå†…éƒ¨ç¼–ç å˜ä¸ºskiplist</p><p>å½“æŸä¸ªå…ƒç´ å¤§äº64 å­—èŠ‚æ—¶ï¼Œå†…éƒ¨ç¼–ç ä¹Ÿä¼šå˜ä¸ºhashtable:</p><hr><h3 id="ä½¿ç”¨åœºæ™¯-5">ä½¿ç”¨åœºæ™¯</h3><p>æœ‰åºé›†åˆæ¯”è¾ƒå…¸å‹çš„ä½¿ç”¨åœºæ™¯å°±æ˜¯æ’è¡Œæ¦œç³»ç»Ÿã€‚ä¾‹å¦‚è§†é¢‘ç½‘ç«™éœ€è¦å¯¹ç”¨æˆ·ä¸Šä¼ çš„è§†é¢‘åšæ’è¡Œæ¦œï¼Œæ¦œå•çš„ç»´åº¦å¯èƒ½æ˜¯å¤šä¸ªæ–¹é¢çš„ï¼šæŒ‰ç…§æ—¶é—´ã€æŒ‰ç…§æ’­æ”¾æ•°é‡ã€æŒ‰ç…§è·å¾—çš„èµæ•°ã€‚</p><p>ä½¿ç”¨èµæ•°è¿™ä¸ªç»´åº¦ï¼Œè®°å½•æ¯å¤©ç”¨æˆ·ä¸Šä¼ è§†é¢‘çš„æ’è¡Œæ¦œã€‚ä¸»è¦éœ€è¦å®ç°ä»¥ä¸‹4 ä¸ªåŠŸèƒ½ã€‚</p><div class="tabs" id="6f561f11-7489-4c61-a554-c7bb7ac8838d"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6f561f11-7489-4c61-a554-c7bb7ac8838d-1"><i class="fas fa-award"></i>æ·»åŠ ç”¨æˆ·èµæ•°</button></li><li class="tab"><button type="button" data-href="#6f561f11-7489-4c61-a554-c7bb7ac8838d-2"><i class="fas fa-baseball-ball"></i>å–æ¶ˆç”¨æˆ·èµæ•°</button></li><li class="tab"><button type="button" data-href="#6f561f11-7489-4c61-a554-c7bb7ac8838d-3"><i class="fas fa-bone"></i>å±•ç¤ºè·å–èµæ•°æœ€å¤šçš„åä¸ªç”¨æˆ·</button></li><li class="tab"><button type="button" data-href="#6f561f11-7489-4c61-a554-c7bb7ac8838d-4"><i class="fas fa-anchor"></i>å±•ç¤ºç”¨æˆ·ä¿¡æ¯ä»¥åŠç”¨æˆ·åˆ†æ•°</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6f561f11-7489-4c61-a554-c7bb7ac8838d-1"><p>ä¾‹å¦‚ç”¨æˆ·mikeä¸Šä¼ äº†ä¸€ä¸ªè§†é¢‘ï¼Œå¹¶è·å¾—äº†3 ä¸ªèµï¼Œå¯ä»¥ä½¿ç”¨æœ‰åºé›†åˆçš„zaddå’ŒzincrbyåŠŸèƒ½ï¼š</p><p><code>zadd user:ranking mike 3</code></p><p>å¦‚æœä¹‹åå†è·å¾—ä¸€ä¸ªèµï¼Œå¯ä»¥ä½¿ç”¨zincrby</p><p><code>zincrby user:ranking mike 1</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6f561f11-7489-4c61-a554-c7bb7ac8838d-2"><p>ç”±äºå„ç§åŸå› ï¼ˆä¾‹å¦‚ç”¨æˆ·æ³¨é”€ã€ç”¨æˆ·ä½œå¼Šï¼‰éœ€è¦å°†ç”¨æˆ·åˆ é™¤ï¼Œæ­¤æ—¶éœ€è¦å°†ç”¨æˆ·ä»æ¦œå•ä¸­åˆ é™¤æ‰ï¼Œå¯ä»¥ä½¿ç”¨zrem ã€‚ä¾‹å¦‚åˆ é™¤æˆå‘˜tom:</p><p><code>zrem user:ranking tom</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6f561f11-7489-4c61-a554-c7bb7ac8838d-3"><p>æ­¤åŠŸèƒ½ä½¿ç”¨zrevrangeå‘½ä»¤å®ç°ï¼š</p><p><code>zrevrangebyrank user:ranking 0 9</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6f561f11-7489-4c61-a554-c7bb7ac8838d-4"><p>æ­¤åŠŸèƒ½å°†ç”¨æˆ·åä½œä¸ºé”®åç¼€ï¼Œå°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åœ¨å“ˆå¸Œç±»å‹ä¸­ï¼Œè‡³äºç”¨æˆ·çš„åˆ†æ•°å’Œæ’åå¯ä»¥ä½¿ç”¨zscore å’Œzrank ä¸¤ä¸ªåŠŸèƒ½ï¼š</p><p><code>hgetall user:info:tom</code></p><p><code>zscore user:ranking mike</code></p><p><code>zrank user:ranking mike</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><hr><h2 id="SpringDataRediså®¢æˆ·ç«¯">SpringDataRediså®¢æˆ·ç«¯</h2><p>SpringDataæ˜¯Springä¸­æ•°æ®æ“ä½œçš„æ¨¡å—ï¼ŒåŒ…å«å¯¹å„ç§æ•°æ®åº“çš„é›†æˆï¼Œå…¶ä¸­å¯¹Redisçš„é›†æˆæ¨¡å—å°±å«åšSpringDataRedisã€‚</p><p>å®˜ç½‘åœ°å€ï¼š<a href="https://spring.io/projects/spring-data-redis">https://spring.io/projects/spring-data-redis</a></p><ul><li>æä¾›äº†å¯¹ä¸åŒRediså®¢æˆ·ç«¯çš„æ•´åˆï¼ˆLettuceå’ŒJedisï¼‰</li><li>æä¾›äº†RedisTemplateç»Ÿä¸€APIæ¥æ“ä½œRedis</li><li>æ”¯æŒRedisçš„å‘å¸ƒè®¢é˜…æ¨¡å‹</li><li>æ”¯æŒRediså“¨å…µå’ŒRedisé›†ç¾¤</li><li>æ”¯æŒåŸºäºLettuceçš„å“åº”å¼ç¼–ç¨‹</li><li>æ”¯æŒåŸºäºJDKã€JSONã€å­—ç¬¦ä¸²ã€Springå¯¹è±¡çš„æ•°æ®åºåˆ—åŒ–åŠååºåˆ—åŒ–</li><li>æ”¯æŒåŸºäºRedisçš„JDKCollectionå®ç°</li></ul><p>SpringDataRedisä¸­æä¾›äº†RedisTemplateå·¥å…·ç±»ï¼Œå…¶ä¸­å°è£…äº†å„ç§å¯¹Redisçš„æ“ä½œã€‚å¹¶ä¸”å°†ä¸åŒæ•°æ®ç±»å‹çš„æ“ä½œAPIå°è£…åˆ°äº†ä¸åŒçš„ç±»å‹ä¸­ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/UFlNIV0.png" alt=""></p><hr><h3 id="å¿«é€Ÿä½¿ç”¨">å¿«é€Ÿä½¿ç”¨</h3><p>SpringBootå·²ç»æä¾›äº†å¯¹SpringDataRedisçš„æ”¯æŒï¼Œä½¿ç”¨éå¸¸ç®€å•ã€‚</p><div class="tabs" id="d8e4ee01-5335-4db3-a2f8-7eaaf1b9e974"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#d8e4ee01-5335-4db3-a2f8-7eaaf1b9e974-1"><i class="fas fa-award"></i>å¼•å…¥ä¾èµ–</button></li><li class="tab"><button type="button" data-href="#d8e4ee01-5335-4db3-a2f8-7eaaf1b9e974-2"><i class="fas fa-baseball-ball"></i>é…ç½®Redis</button></li><li class="tab"><button type="button" data-href="#d8e4ee01-5335-4db3-a2f8-7eaaf1b9e974-3"><i class="fas fa-bone"></i>æ³¨å…¥RedisTemplate</button></li><li class="tab"><button type="button" data-href="#d8e4ee01-5335-4db3-a2f8-7eaaf1b9e974-4"><i class="fas fa-anchor"></i>ç¼–å†™æµ‹è¯•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="d8e4ee01-5335-4db3-a2f8-7eaaf1b9e974-1"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--redisä¾èµ–--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--common-pool--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Jacksonä¾èµ–--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d8e4ee01-5335-4db3-a2f8-7eaaf1b9e974-2"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123321</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">8</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">8</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="string">100ms</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d8e4ee01-5335-4db3-a2f8-7eaaf1b9e974-3"><p>å› ä¸ºæœ‰äº†SpringBootçš„è‡ªåŠ¨è£…é…ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿æ¥å°±ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisStringTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="d8e4ee01-5335-4db3-a2f8-7eaaf1b9e974-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisStringTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å†™å…¥ä¸€æ¡Stringæ•°æ®</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;è™å“¥&quot;</span>);</span><br><span class="line">        <span class="comment">// è·å–stringæ•°æ®</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">name</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;name = &quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="è‡ªå®šä¹‰åºåˆ—åŒ–">è‡ªå®šä¹‰åºåˆ—åŒ–</h3><p>RedisTemplateå¯ä»¥æ¥æ”¶ä»»æ„Objectä½œä¸ºå€¼å†™å…¥Redisï¼Œåªä¸è¿‡å†™å…¥å‰ä¼šæŠŠObjectåºåˆ—åŒ–ä¸ºå­—èŠ‚å½¢å¼ï¼Œé»˜è®¤æ˜¯é‡‡ç”¨JDKåºåˆ—åŒ–ï¼Œå¾—åˆ°çš„ç»“æœæ˜¯è¿™æ ·çš„ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/5FjtWk5.png" alt=""></p><p>ç¼ºç‚¹ï¼š</p><ul><li>å¯è¯»æ€§å·®</li><li>å†…å­˜å ç”¨è¾ƒå¤§</li></ul><p>æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰RedisTemplateçš„åºåˆ—åŒ–æ–¹å¼ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory connectionFactory)</span>&#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºRedisTemplateå¯¹è±¡</span></span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// è®¾ç½®è¿æ¥å·¥å‚</span></span><br><span class="line">        template.setConnectionFactory(connectionFactory);</span><br><span class="line">        <span class="comment">// åˆ›å»ºJSONåºåˆ—åŒ–å·¥å…·</span></span><br><span class="line">        <span class="type">GenericJackson2JsonRedisSerializer</span> <span class="variable">jsonRedisSerializer</span> <span class="operator">=</span> </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>();</span><br><span class="line">        <span class="comment">// è®¾ç½®Keyçš„åºåˆ—åŒ–</span></span><br><span class="line">        template.setKeySerializer(RedisSerializer.string());</span><br><span class="line">        template.setHashKeySerializer(RedisSerializer.string());</span><br><span class="line">        <span class="comment">// è®¾ç½®Valueçš„åºåˆ—åŒ–</span></span><br><span class="line">        template.setValueSerializer(jsonRedisSerializer);</span><br><span class="line">        template.setHashValueSerializer(jsonRedisSerializer);</span><br><span class="line">        <span class="comment">// è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé‡‡ç”¨äº†JSONåºåˆ—åŒ–æ¥ä»£æ›¿é»˜è®¤çš„JDKåºåˆ—åŒ–æ–¹å¼ã€‚æœ€ç»ˆç»“æœå¦‚å›¾ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/XOAq3cN.png" alt=""></p><p>æ•´ä½“å¯è¯»æ€§æœ‰äº†å¾ˆå¤§æå‡ï¼Œå¹¶ä¸”èƒ½å°†Javaå¯¹è±¡è‡ªåŠ¨çš„åºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸²ï¼Œå¹¶ä¸”æŸ¥è¯¢æ—¶èƒ½è‡ªåŠ¨æŠŠJSONååºåˆ—åŒ–ä¸ºJavaå¯¹è±¡ã€‚ä¸è¿‡ï¼Œå…¶ä¸­è®°å½•äº†åºåˆ—åŒ–æ—¶å¯¹åº”çš„classåç§°ï¼Œç›®çš„æ˜¯ä¸ºäº†æŸ¥è¯¢æ—¶å®ç°è‡ªåŠ¨ååºåˆ—åŒ–ã€‚è¿™ä¼šå¸¦æ¥é¢å¤–çš„å†…å­˜å¼€é”€ã€‚</p><hr><h3 id="Stringåºåˆ—åŒ–">Stringåºåˆ—åŒ–</h3><p>ä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ä½¿ç”¨JSONåºåˆ—åŒ–å™¨æ¥å¤„ç†valueï¼Œè€Œæ˜¯ç»Ÿä¸€ä½¿ç”¨Stringåºåˆ—åŒ–å™¨ï¼Œè¦æ±‚åªèƒ½å­˜å‚¨Stringç±»å‹çš„keyå’Œvalueã€‚å½“éœ€è¦å­˜å‚¨Javaå¯¹è±¡æ—¶ï¼Œæ‰‹åŠ¨å®Œæˆå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/Ip9TKSY.png" style="zoom:67%;" /><p>å› ä¸ºå­˜å…¥å’Œè¯»å–æ—¶çš„åºåˆ—åŒ–åŠååºåˆ—åŒ–éƒ½æ˜¯æˆ‘ä»¬è‡ªå·±å®ç°çš„ï¼ŒSpringDataRediså°±ä¸ä¼šå°†classä¿¡æ¯å†™å…¥Redisäº†ã€‚</p><p>è¿™ç§ç”¨æ³•æ¯”è¾ƒæ™®éï¼Œå› æ­¤SpringDataRediså°±æä¾›äº†RedisTemplateçš„å­ç±»ï¼šStringRedisTemplateï¼Œå®ƒçš„keyå’Œvalueçš„åºåˆ—åŒ–æ–¹å¼é»˜è®¤å°±æ˜¯Stringæ–¹å¼ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/zXH6Qn6.png" style="zoom:67%;" /><p>çœå»äº†æˆ‘ä»¬è‡ªå®šä¹‰RedisTemplateçš„åºåˆ—åŒ–æ–¹å¼çš„æ­¥éª¤ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"><span class="comment">// JSONåºåˆ—åŒ–å·¥å…·</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testSaveUser</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºå¯¹è±¡</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;è™å“¥&quot;</span>, <span class="number">21</span>);</span><br><span class="line">    <span class="comment">// æ‰‹åŠ¨åºåˆ—åŒ–</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> mapper.writeValueAsString(user);</span><br><span class="line">    <span class="comment">// å†™å…¥æ•°æ®</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(<span class="string">&quot;user:200&quot;</span>, json);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æ•°æ®</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonUser</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;user:200&quot;</span>);</span><br><span class="line">    <span class="comment">// æ‰‹åŠ¨ååºåˆ—åŒ–</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> mapper.readValue(jsonUser, User.class);</span><br><span class="line">    System.out.println(<span class="string">&quot;user1 = &quot;</span> + user1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Rediså…¥é—¨ã€å¸¸è§å‘½ä»¤ã€å®¢æˆ·ç«¯</summary>
    
    
    
    <category term="æ•°æ®åº“" scheme="https://wuwawawa.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="Redis" scheme="https://wuwawawa.github.io/tags/Redis/"/>
    
    <category term="æ•°æ®åº“" scheme="https://wuwawawa.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>IOæµ</title>
    <link href="https://wuwawawa.github.io/posts/7f134d07.html"/>
    <id>https://wuwawawa.github.io/posts/7f134d07.html</id>
    <published>2023-06-04T07:03:25.000Z</published>
    <updated>2023-06-05T08:39:06.889Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-IOæ¦‚è¿°">1. IOæ¦‚è¿°</h2><h3 id="1-1-ä»€ä¹ˆæ˜¯IO">1.1 ä»€ä¹ˆæ˜¯IO</h3><p>ç”Ÿæ´»ä¸­ï¼Œä½ è‚¯å®šç»å†è¿‡è¿™æ ·çš„åœºæ™¯ã€‚å½“ä½ ç¼–è¾‘ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå¿˜è®°äº†<code>ctrl+s</code> ï¼Œå¯èƒ½æ–‡ä»¶å°±ç™½ç™½ç¼–è¾‘äº†ã€‚å½“ä½ ç”µè„‘ä¸Šæ’å…¥ä¸€ä¸ªUç›˜ï¼Œå¯ä»¥æŠŠä¸€ä¸ªè§†é¢‘ï¼Œæ‹·è´åˆ°ä½ çš„ç”µè„‘ç¡¬ç›˜é‡Œã€‚é‚£ä¹ˆæ•°æ®éƒ½æ˜¯åœ¨å“ªäº›è®¾å¤‡ä¸Šçš„å‘¢ï¼Ÿé”®ç›˜ã€å†…å­˜ã€ç¡¬ç›˜ã€å¤–æ¥è®¾å¤‡ç­‰ç­‰ã€‚</p><p>æˆ‘ä»¬æŠŠè¿™ç§æ•°æ®çš„ä¼ è¾“ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€ç§æ•°æ®çš„æµåŠ¨ï¼ŒæŒ‰ç…§æµåŠ¨çš„æ–¹å‘ï¼Œä»¥å†…å­˜ä¸ºåŸºå‡†ï¼Œåˆ†ä¸º<code>è¾“å…¥input</code> å’Œ<code>è¾“å‡ºoutput</code> ï¼Œå³æµå‘å†…å­˜æ˜¯è¾“å…¥æµï¼Œæµå‡ºå†…å­˜çš„è¾“å‡ºæµã€‚</p><p>Javaä¸­I/Oæ“ä½œä¸»è¦æ˜¯æŒ‡ä½¿ç”¨<code>java.io</code>åŒ…ä¸‹çš„å†…å®¹ï¼Œè¿›è¡Œè¾“å…¥ã€è¾“å‡ºæ“ä½œã€‚<strong>è¾“å…¥</strong>ä¹Ÿå«åš<strong>è¯»å–</strong>æ•°æ®ï¼Œ<strong>è¾“å‡º</strong>ä¹Ÿå«åšä½œ<strong>å†™å‡º</strong>æ•°æ®ã€‚</p><hr><h3 id="1-2-IOçš„åˆ†ç±»">1.2 IOçš„åˆ†ç±»</h3><p>æ ¹æ®æ•°æ®çš„æµå‘åˆ†ä¸ºï¼š<strong>è¾“å…¥æµ</strong>å’Œ<strong>è¾“å‡ºæµ</strong>ã€‚</p><ul><li><strong>è¾“å…¥æµ</strong> ï¼šæŠŠæ•°æ®ä»<code>å…¶ä»–è®¾å¤‡</code>ä¸Šè¯»å–åˆ°<code>å†…å­˜</code>ä¸­çš„æµã€‚</li><li><strong>è¾“å‡ºæµ</strong> ï¼šæŠŠæ•°æ®ä»<code>å†…å­˜</code> ä¸­å†™å‡ºåˆ°<code>å…¶ä»–è®¾å¤‡</code>ä¸Šçš„æµã€‚</li></ul><p>æ ¼å±€æ•°æ®çš„ç±»å‹åˆ†ä¸ºï¼š<strong>å­—èŠ‚æµ</strong>å’Œ<strong>å­—ç¬¦æµ</strong>ã€‚</p><ul><li><strong>å­—èŠ‚æµ</strong> ï¼šä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œè¯»å†™æ•°æ®çš„æµï¼Œå¯ä»¥æ“ä½œæ‰€æœ‰ç±»å‹çš„æ–‡ä»¶ã€‚</li><li><strong>å­—ç¬¦æµ</strong> ï¼šä»¥å­—ç¬¦ä¸ºå•ä½ï¼Œè¯»å†™æ•°æ®çš„æµï¼Œåªèƒ½æ“ä½œçº¯æ–‡æœ¬æ–‡ä»¶ã€‚</li></ul><hr><h3 id="1-3-IOçš„æµå‘è¯´æ˜å›¾è§£">1.3 IOçš„æµå‘è¯´æ˜å›¾è§£</h3><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1_io.jpg" style="zoom:67%;" /><hr><h3 id="1-4-é¡¶çº§çˆ¶ç±»ä»¬">1.4 é¡¶çº§çˆ¶ç±»ä»¬</h3><table><thead><tr><th style="text-align:center"></th><th style="text-align:center"><strong>è¾“å…¥æµ</strong></th><th style="text-align:center">è¾“å‡ºæµ</th></tr></thead><tbody><tr><td style="text-align:center"><strong><span class='p blue'>å­—èŠ‚æµ</span></strong></td><td style="text-align:center">å­—èŠ‚è¾“å…¥æµ<br /><strong><span class='p blue'>InputStream</span></strong></td><td style="text-align:center">å­—èŠ‚è¾“å‡ºæµ<br /><strong><span class='p blue'>OutputStream</span></strong></td></tr><tr><td style="text-align:center"><strong><span class='p green'>å­—ç¬¦æµ</span></strong></td><td style="text-align:center">å­—ç¬¦è¾“å…¥æµ<br /><strong><span class='p green'>Reader</span></strong></td><td style="text-align:center">å­—ç¬¦è¾“å‡ºæµ<br /><strong><span class='p green'>Writer</span></strong></td></tr></tbody></table><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605103133931.png" alt="image-20230605103133931" style="zoom: 50%;" /><hr><hr><h2 id="2-å­—èŠ‚æµ">2. å­—èŠ‚æµ</h2><p>ä¸€åˆ‡æ–‡ä»¶æ•°æ®(æ–‡æœ¬ã€å›¾ç‰‡ã€è§†é¢‘ç­‰)åœ¨å­˜å‚¨æ—¶ï¼Œéƒ½æ˜¯ä»¥<span class='p blue'>äºŒè¿›åˆ¶æ•°å­—</span>çš„å½¢å¼ä¿å­˜ï¼Œéƒ½ä¸€ä¸ªä¸€ä¸ªçš„å­—èŠ‚ï¼Œé‚£ä¹ˆä¼ è¾“æ—¶ä¸€æ ·å¦‚æ­¤ã€‚æ‰€ä»¥ï¼Œå­—èŠ‚æµå¯ä»¥ä¼ è¾“ä»»æ„æ–‡ä»¶æ•°æ®ã€‚åœ¨æ“ä½œæµçš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦æ—¶åˆ»æ˜ç¡®ï¼Œæ— è®ºä½¿ç”¨ä»€ä¹ˆæ ·çš„æµå¯¹è±¡ï¼Œåº•å±‚ä¼ è¾“çš„å§‹ç»ˆä¸ºäºŒè¿›åˆ¶æ•°æ®ã€‚</p><hr><h3 id="2-1-å­—èŠ‚è¾“å‡ºæµ-OutputStream">2.1 å­—èŠ‚è¾“å‡ºæµ[OutputStream]</h3><p><code>java.io.OutputStream </code>æŠ½è±¡ç±»æ˜¯è¡¨ç¤º<span class='p blue'>å­—èŠ‚è¾“å‡ºæµ</span>çš„æ‰€æœ‰ç±»çš„<span class='p green'>è¶…ç±»</span>ï¼Œå°†æŒ‡å®šçš„å­—èŠ‚ä¿¡æ¯å†™å‡ºåˆ°ç›®çš„åœ°ã€‚å®ƒå®šä¹‰äº†å­—èŠ‚è¾“å‡ºæµçš„<strong>åŸºæœ¬å…±æ€§åŠŸèƒ½æ–¹æ³•</strong>ã€‚</p><table><thead><tr><th style="text-align:left">æ–¹æ³•</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left"><code>public void close()</code></td><td style="text-align:left">å…³é—­æ­¤è¾“å‡ºæµå¹¶é‡Šæ”¾ä¸æ­¤æµç›¸å…³è”çš„ä»»ä½•ç³»ç»Ÿèµ„æº</td></tr><tr><td style="text-align:left"><code>public void flush() </code></td><td style="text-align:left">åˆ·æ–°æ­¤è¾“å‡ºæµå¹¶å¼ºåˆ¶ä»»ä½•ç¼“å†²çš„è¾“å‡ºå­—èŠ‚è¢«å†™å‡º</td></tr><tr><td style="text-align:left"><code>public void write(byte[] b)</code></td><td style="text-align:left">å°† b.lengthå­—èŠ‚ä»æŒ‡å®šçš„å­—èŠ‚æ•°ç»„å†™å…¥æ­¤è¾“å‡ºæµ</td></tr><tr><td style="text-align:left"><code>public void write(byte[] b, int off, int len)</code></td><td style="text-align:left">ä»æŒ‡å®šçš„å­—èŠ‚æ•°ç»„å†™å…¥ lenå­—èŠ‚ï¼Œä»åç§»é‡ offå¼€å§‹è¾“å‡ºåˆ°æ­¤è¾“å‡ºæµ</td></tr><tr><td style="text-align:left"><code>public abstract void write(int b)</code></td><td style="text-align:left">å°†æŒ‡å®šçš„å­—èŠ‚è¾“å‡ºæµ</td></tr></tbody></table><p>å°è´´å£«ï¼š</p><blockquote><p>closeæ–¹æ³•ï¼Œå½“å®Œæˆæµçš„æ“ä½œæ—¶ï¼Œå¿…é¡»è°ƒç”¨æ­¤æ–¹æ³•ï¼Œé‡Šæ”¾ç³»ç»Ÿèµ„æºã€‚</p></blockquote><hr><h3 id="2-2-FileOutputStreamç±»">2.2 FileOutputStreamç±»</h3><p><code>OutputStream</code>æœ‰å¾ˆå¤šå­ç±»ï¼Œæˆ‘ä»¬ä»æœ€ç®€å•çš„ä¸€ä¸ªå­ç±»å¼€å§‹ã€‚</p><p><code>java.io.FileOutputStream </code>ç±»æ˜¯æ–‡ä»¶è¾“å‡ºæµï¼Œç”¨äºå°†æ•°æ®å†™å‡ºåˆ°æ–‡ä»¶ã€‚</p><hr><h4 id="æ„é€ æ–¹æ³•">æ„é€ æ–¹æ³•</h4><ul><li><code>public FileOutputStream(File file)</code>ï¼šåˆ›å»ºæ–‡ä»¶è¾“å‡ºæµä»¥å†™å…¥ç”±æŒ‡å®šçš„ Fileå¯¹è±¡è¡¨ç¤ºçš„æ–‡ä»¶ã€‚</li><li><code>public FileOutputStream(String name)</code>ï¼š åˆ›å»ºæ–‡ä»¶è¾“å‡ºæµä»¥æŒ‡å®šçš„åç§°å†™å…¥æ–‡ä»¶ã€‚</li></ul><p>å½“ä½ åˆ›å»ºä¸€ä¸ªæµå¯¹è±¡æ—¶ï¼Œå¿…é¡»ä¼ å…¥ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ã€‚</p><p>è¯¥è·¯å¾„ä¸‹ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œä¼šåˆ›å»ºè¯¥æ–‡ä»¶ã€‚å¦‚æœæœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œä¼šæ¸…ç©ºè¿™ä¸ªæ–‡ä»¶çš„æ•°æ®ã€‚</p><p>å¦‚æœè¯¥çˆ¶çº§è·¯å¾„ä¸å­˜åœ¨ï¼Œåˆ™ä¼šæŠ›å¼‚å¸¸ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileOutputStreamConstructor</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[]args)</span>&#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨Fileå¯¹è±¡åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        File file=<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;a.txt&quot;</span>);</span><br><span class="line">        FileOutputStream fos=<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        FileOutputStream fos=<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;b.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="å†™å‡ºå­—èŠ‚æ•°æ®">å†™å‡ºå­—èŠ‚æ•°æ®</h4><div class="tabs" id="21c1247c-49c1-4bc8-b28c-26f07175856d"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#21c1247c-49c1-4bc8-b28c-26f07175856d-1"><i class="fas fa-seedling"></i>å†™å‡ºå­—èŠ‚</button></li><li class="tab"><button type="button" data-href="#21c1247c-49c1-4bc8-b28c-26f07175856d-2"><i class="fas fa-leaf"></i>å†™å‡ºå­—èŠ‚æ•°ç»„</button></li><li class="tab"><button type="button" data-href="#21c1247c-49c1-4bc8-b28c-26f07175856d-3"><i class="fab fa-apple"></i>å†™å‡ºæŒ‡å®šé•¿åº¦å­—èŠ‚æ•°ç»„</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="21c1247c-49c1-4bc8-b28c-26f07175856d-1"><p><code>write(int b)</code> æ–¹æ³•ï¼Œæ¯æ¬¡å¯ä»¥å†™å‡ºä¸€ä¸ªå­—èŠ‚æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FOSWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;fos.txt&quot;</span>);     </span><br><span class="line">      <span class="comment">// å†™å‡ºæ•°æ®</span></span><br><span class="line">      fos.write(<span class="number">97</span>); <span class="comment">// å†™å‡ºç¬¬1ä¸ªå­—èŠ‚</span></span><br><span class="line">      fos.write(<span class="number">98</span>); <span class="comment">// å†™å‡ºç¬¬2ä¸ªå­—èŠ‚</span></span><br><span class="line">      fos.write(<span class="number">99</span>); <span class="comment">// å†™å‡ºç¬¬3ä¸ªå­—èŠ‚</span></span><br><span class="line">      <span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¾“å‡ºç»“æœï¼š</span></span><br><span class="line"><span class="comment">//abc</span></span><br></pre></td></tr></table></figure><p>å°è´´å£«ï¼š</p><blockquote><ol><li>è™½ç„¶å‚æ•°ä¸ºintç±»å‹å››ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯åªä¼šä¿ç•™ä¸€ä¸ªå­—èŠ‚çš„ä¿¡æ¯å†™å‡ºã€‚</li><li>æµæ“ä½œå®Œæ¯•åï¼Œå¿…é¡»é‡Šæ”¾ç³»ç»Ÿèµ„æºï¼Œè°ƒç”¨closeæ–¹æ³•ï¼Œåƒä¸‡è®°å¾—ã€‚</li></ol></blockquote><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="21c1247c-49c1-4bc8-b28c-26f07175856d-2"><p><code>write(byte[] b)</code>ï¼Œæ¯æ¬¡å¯ä»¥å†™å‡ºæ•°ç»„ä¸­çš„æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FOSWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;fos.txt&quot;</span>);     </span><br><span class="line">      <span class="comment">// å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">      <span class="type">byte</span>[] b = <span class="string">&quot;é»‘é©¬ç¨‹åºå‘˜&quot;</span>.getBytes();</span><br><span class="line">      <span class="comment">// å†™å‡ºå­—èŠ‚æ•°ç»„æ•°æ®</span></span><br><span class="line">      fos.write(b);</span><br><span class="line">      <span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¾“å‡ºç»“æœï¼š</span></span><br><span class="line"><span class="comment">//é»‘é©¬ç¨‹åºå‘˜</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="21c1247c-49c1-4bc8-b28c-26f07175856d-3"><p><code>write(byte[] b, int off, int len)</code> ,æ¯æ¬¡å†™å‡ºä»offç´¢å¼•å¼€å§‹ï¼Œlenä¸ªå­—èŠ‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FOSWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;fos.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">        <span class="type">byte</span>[] b = <span class="string">&quot;abcde&quot;</span>.getBytes();</span><br><span class="line">        <span class="comment">// å†™å‡ºä»ç´¢å¼•2å¼€å§‹ï¼Œ2ä¸ªå­—èŠ‚ã€‚ç´¢å¼•2æ˜¯cï¼Œä¸¤ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯cdã€‚</span></span><br><span class="line">        fos.write(b,<span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¾“å‡ºç»“æœï¼š</span></span><br><span class="line"><span class="comment">//cd</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h4 id="æ•°æ®è¿½åŠ ç»­å†™">æ•°æ®è¿½åŠ ç»­å†™</h4><p>æ¯æ¬¡ç¨‹åºè¿è¡Œï¼Œåˆ›å»ºè¾“å‡ºæµå¯¹è±¡ï¼Œéƒ½ä¼šæ¸…ç©ºç›®æ ‡æ–‡ä»¶ä¸­çš„æ•°æ®ã€‚å¦‚ä½•ä¿ç•™ç›®æ ‡æ–‡ä»¶ä¸­æ•°æ®ï¼Œè¿˜èƒ½ç»§ç»­æ·»åŠ æ–°æ•°æ®å‘¢ï¼Ÿ</p><ul><li><code>public FileOutputStream(File file, boolean append)</code>ï¼š åˆ›å»ºæ–‡ä»¶è¾“å‡ºæµä»¥å†™å…¥ç”±æŒ‡å®šçš„ Fileå¯¹è±¡è¡¨ç¤ºçš„æ–‡ä»¶ã€‚</li><li><code>public FileOutputStream(String name, boolean append)</code>ï¼š åˆ›å»ºæ–‡ä»¶è¾“å‡ºæµä»¥æŒ‡å®šçš„åç§°å†™å…¥æ–‡ä»¶ã€‚</li></ul><p>è¿™ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œå‚æ•°ä¸­éƒ½éœ€è¦ä¼ å…¥ä¸€ä¸ªbooleanç±»å‹çš„å€¼ï¼Œ<code>true</code> è¡¨ç¤ºè¿½åŠ æ•°æ®ï¼Œ<code>false</code> è¡¨ç¤ºæ¸…ç©ºåŸæœ‰æ•°æ®ã€‚è¿™æ ·åˆ›å»ºçš„è¾“å‡ºæµå¯¹è±¡ï¼Œå°±å¯ä»¥æŒ‡å®šæ˜¯å¦è¿½åŠ ç»­å†™äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FOSWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;fos.txt&quot;</span>ï¼Œ<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">        <span class="type">byte</span>[] b = <span class="string">&quot;abcde&quot;</span>.getBytes();</span><br><span class="line">        <span class="comment">// å†™å‡ºä»ç´¢å¼•2å¼€å§‹ï¼Œ2ä¸ªå­—èŠ‚ã€‚ç´¢å¼•2æ˜¯cï¼Œä¸¤ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯cdã€‚</span></span><br><span class="line">        fos.write(b);</span><br><span class="line">        <span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ–‡ä»¶æ“ä½œå‰ï¼šcd</span></span><br><span class="line"><span class="comment">//æ–‡ä»¶æ“ä½œåï¼šcdabcde</span></span><br></pre></td></tr></table></figure><hr><h4 id="å†™å‡ºæ¢è¡Œ">å†™å‡ºæ¢è¡Œ</h4><p>Windowsç³»ç»Ÿé‡Œï¼Œæ¢è¡Œç¬¦å·æ˜¯<code>\r\n</code> ã€‚ä»¥æŒ‡å®šæ˜¯å¦è¿½åŠ ç»­å†™äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FOSWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;fos.txt&quot;</span>);  </span><br><span class="line">      <span class="comment">// å®šä¹‰å­—èŠ‚æ•°ç»„</span></span><br><span class="line">      <span class="type">byte</span>[] words = &#123;<span class="number">97</span>,<span class="number">98</span>,<span class="number">99</span>,<span class="number">100</span>,<span class="number">101</span>&#125;;</span><br><span class="line">      <span class="comment">// éå†æ•°ç»„</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; words.length; i++) &#123;</span><br><span class="line">          <span class="comment">// å†™å‡ºä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">            fos.write(words[i]);</span><br><span class="line">          <span class="comment">// å†™å‡ºä¸€ä¸ªæ¢è¡Œ, æ¢è¡Œç¬¦å·è½¬æˆæ•°ç»„å†™å‡º</span></span><br><span class="line">            fos.write(<span class="string">&quot;\r\n&quot;</span>.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">è¾“å‡ºç»“æœï¼š</span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">c</span><br><span class="line">d</span><br><span class="line">e</span><br></pre></td></tr></table></figure><ul><li>å›è½¦ç¬¦<code>\r</code>å’Œæ¢è¡Œç¬¦<code>\n</code> ï¼š<ul><li>å›è½¦ç¬¦ï¼šå›åˆ°ä¸€è¡Œçš„å¼€å¤´ï¼ˆreturnï¼‰ã€‚</li><li>æ¢è¡Œç¬¦ï¼šä¸‹ä¸€è¡Œï¼ˆnewlineï¼‰ã€‚</li></ul></li><li>ç³»ç»Ÿä¸­çš„æ¢è¡Œï¼š<ul><li>Windowsç³»ç»Ÿé‡Œï¼Œæ¯è¡Œç»“å°¾æ˜¯ <code>å›è½¦+æ¢è¡Œ</code> ï¼Œå³<code>\r\n</code>ï¼›</li><li>Unixç³»ç»Ÿé‡Œï¼Œæ¯è¡Œç»“å°¾åªæœ‰ <code>æ¢è¡Œ</code> ï¼Œå³<code>\n</code>ï¼›</li><li>Macç³»ç»Ÿé‡Œï¼Œæ¯è¡Œç»“å°¾æ˜¯ <code>å›è½¦</code> ï¼Œå³<code>\r</code>ã€‚ä» Mac OS Xå¼€å§‹ä¸Linuxç»Ÿä¸€ã€‚</li></ul></li></ul><hr><hr><h3 id="2-3-å­—èŠ‚è¾“å…¥æµ-InputStream">2.3 å­—èŠ‚è¾“å…¥æµ[InputStream]</h3><p><code>java.io.InputStream </code>æŠ½è±¡ç±»æ˜¯è¡¨ç¤º<span class='p blue'>å­—èŠ‚è¾“å…¥æµ</span>çš„æ‰€æœ‰ç±»çš„<span class='p green'>è¶…ç±»</span>ï¼Œå¯ä»¥è¯»å–å­—èŠ‚ä¿¡æ¯åˆ°å†…å­˜ä¸­ã€‚å®ƒå®šä¹‰äº†å­—èŠ‚è¾“å…¥æµçš„<strong>åŸºæœ¬å…±æ€§åŠŸèƒ½æ–¹æ³•</strong>ã€‚</p><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>public void close()</code></td><td>å…³é—­æ­¤è¾“å…¥æµå¹¶é‡Šæ”¾ä¸æ­¤æµç›¸å…³è”çš„ä»»ä½•ç³»ç»Ÿèµ„æº</td></tr><tr><td><code>public abstract int read()</code></td><td>ä»è¾“å…¥æµè¯»å–æ•°æ®çš„ä¸‹ä¸€ä¸ªå­—èŠ‚</td></tr><tr><td><code>public int read(byte[] b)</code></td><td>ä»è¾“å…¥æµä¸­è¯»å–ä¸€äº›å­—èŠ‚æ•°ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åˆ°å­—èŠ‚æ•°ç»„ bä¸­</td></tr></tbody></table><hr><h3 id="2-4-FileInputStreamç±»">2.4 FileInputStreamç±»</h3><p><code>java.io.FileInputStream </code>ç±»æ˜¯æ–‡ä»¶è¾“å…¥æµï¼Œä»æ–‡ä»¶ä¸­è¯»å–å­—èŠ‚ã€‚</p><hr><h4 id="æ„é€ æ–¹æ³•-2">æ„é€ æ–¹æ³•</h4><ul><li><code>FileInputStream(File file)</code>ï¼š é€šè¿‡æ‰“å¼€ä¸å®é™…æ–‡ä»¶çš„è¿æ¥æ¥åˆ›å»ºä¸€ä¸ª FileInputStream ï¼Œè¯¥æ–‡ä»¶ç”±æ–‡ä»¶ç³»ç»Ÿä¸­çš„ Fileå¯¹è±¡ fileå‘½åã€‚</li><li><code>FileInputStream(String name)</code>ï¼š é€šè¿‡æ‰“å¼€ä¸å®é™…æ–‡ä»¶çš„è¿æ¥æ¥åˆ›å»ºä¸€ä¸ª FileInputStream ï¼Œè¯¥æ–‡ä»¶ç”±æ–‡ä»¶ç³»ç»Ÿä¸­çš„è·¯å¾„å nameå‘½åã€‚</li></ul><p>å½“ä½ åˆ›å»ºä¸€ä¸ªæµå¯¹è±¡æ—¶ï¼Œå¿…é¡»ä¼ å…¥ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ã€‚è¯¥è·¯å¾„ä¸‹ï¼Œå¦‚æœæ²¡æœ‰è¯¥æ–‡ä»¶,ä¼šæŠ›å‡º<code>FileNotFoundException</code> ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileInputStreamConstructor</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨Fileå¯¹è±¡åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;a.txt&quot;</span>);</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;b.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="è¯»å–å­—èŠ‚æ•°æ®">è¯»å–å­—èŠ‚æ•°æ®</h4><div class="tabs" id="de55a6fe-5f85-42d2-8091-b9d3495e2f38"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#de55a6fe-5f85-42d2-8091-b9d3495e2f38-1"><i class="fas fa-cat"></i>è¯»å–å­—èŠ‚</button></li><li class="tab"><button type="button" data-href="#de55a6fe-5f85-42d2-8091-b9d3495e2f38-2"><i class="fas fa-horse"></i>ä½¿ç”¨å­—èŠ‚æ•°ç»„è¯»å–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="de55a6fe-5f85-42d2-8091-b9d3495e2f38-1"><p><code>read</code>æ–¹æ³•ï¼Œæ¯æ¬¡å¯ä»¥è¯»å–ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œ<span class='p red'>è‡ªåŠ¨æå‡ä¸ºintç±»å‹</span>ï¼Œè¯»å–åˆ°æ–‡ä»¶æœ«å°¾ï¼Œè¿”å›`-1</p><p><mark class="hl-label blue">å¾ªç¯è¯»å–æ–¹å¼</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FISRead</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">      <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">       <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;read.txt&quot;</span>);</span><br><span class="line">      <span class="comment">// å®šä¹‰å˜é‡ï¼Œä¿å­˜æ•°æ®</span></span><br><span class="line">        <span class="type">int</span> b ï¼›</span><br><span class="line">        <span class="comment">// å¾ªç¯è¯»å–</span></span><br><span class="line">        <span class="keyword">while</span> ((b = fis.read())!=-<span class="number">1</span>) &#123;</span><br><span class="line">            System.out.println((<span class="type">char</span>)b);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¾“å‡ºç»“æœï¼š</span></span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">c</span><br><span class="line">d</span><br><span class="line">e</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="de55a6fe-5f85-42d2-8091-b9d3495e2f38-2"><p><code>read(byte[] b)</code>ï¼Œæ¯æ¬¡è¯»å–bçš„é•¿åº¦ä¸ªå­—èŠ‚åˆ°æ•°ç»„ä¸­ï¼Œè¿”å›è¯»å–åˆ°çš„æœ‰æ•ˆå­—èŠ‚ä¸ªæ•°ï¼Œè¯»å–åˆ°æœ«å°¾æ—¶ï¼Œè¿”å›<code>-1</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FISRead</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">      <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡.</span></span><br><span class="line">       <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;read.txt&quot;</span>); <span class="comment">// æ–‡ä»¶ä¸­ä¸ºabcde</span></span><br><span class="line">      <span class="comment">// å®šä¹‰å˜é‡ï¼Œä½œä¸ºæœ‰æ•ˆä¸ªæ•°</span></span><br><span class="line">        <span class="type">int</span> len ï¼›</span><br><span class="line">        <span class="comment">// å®šä¹‰å­—èŠ‚æ•°ç»„ï¼Œä½œä¸ºè£…å­—èŠ‚æ•°æ®çš„å®¹å™¨   </span></span><br><span class="line">        <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">2</span>];</span><br><span class="line">        <span class="comment">// å¾ªç¯è¯»å–</span></span><br><span class="line">        <span class="keyword">while</span> (( len= fis.read(b))!=-<span class="number">1</span>) &#123;</span><br><span class="line">           <span class="comment">// æ¯æ¬¡è¯»å–å,æŠŠæ•°ç»„çš„æœ‰æ•ˆå­—èŠ‚éƒ¨åˆ†ï¼Œå˜æˆå­—ç¬¦ä¸²æ‰“å°</span></span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(bï¼Œ<span class="number">0</span>ï¼Œlen));<span class="comment">//  len æ¯æ¬¡è¯»å–çš„æœ‰æ•ˆå­—èŠ‚ä¸ªæ•°</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¾“å‡ºç»“æœï¼š</span></span><br><span class="line">ab</span><br><span class="line">cd</span><br><span class="line">e</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="2-5-å­—èŠ‚æµç»ƒä¹ -å›¾ç‰‡å¤åˆ¶">2.5 å­—èŠ‚æµç»ƒä¹ :å›¾ç‰‡å¤åˆ¶</h3><mark class="hl-label blue">å¤åˆ¶åŸç†å›¾è§£</mark> <p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2_copy.jpg" alt=""></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Copy</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 1.åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="comment">// 1.1 æŒ‡å®šæ•°æ®æº</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/Users/fortune/Downloads/test.png&quot;</span>);</span><br><span class="line">        <span class="comment">// 1.2 æŒ‡å®šç›®çš„åœ°</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;test_copy.jpg&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.è¯»å†™æ•°æ®</span></span><br><span class="line">        <span class="comment">// 2.1 å®šä¹‰æ•°ç»„</span></span><br><span class="line">        <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="comment">// 2.2 å®šä¹‰é•¿åº¦</span></span><br><span class="line">        <span class="type">int</span> len;</span><br><span class="line">        <span class="comment">// 2.3 å¾ªç¯è¯»å–</span></span><br><span class="line">        <span class="keyword">while</span> ((len = fis.read(b))!=-<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 2.4 å†™å‡ºæ•°æ®</span></span><br><span class="line">            fos.write(b, <span class="number">0</span> , len);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.å…³é—­èµ„æº</span></span><br><span class="line">        fos.close();</span><br><span class="line">        fis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><mark class="hl-label blue">å°è´´å£«-æµçš„å…³é—­åŸåˆ™</mark> <p>å…ˆå¼€åå…³ï¼Œåå¼€å…ˆå…³</p><hr><hr><h2 id="3-å­—ç¬¦ç¼–ç å’Œå­—ç¬¦é›†">3 å­—ç¬¦ç¼–ç å’Œå­—ç¬¦é›†</h2><h3 id="å­—ç¬¦ç¼–ç ">å­—ç¬¦ç¼–ç </h3><p>è®¡ç®—æœºä¸­å‚¨å­˜çš„ä¿¡æ¯éƒ½æ˜¯ç”¨äºŒè¿›åˆ¶æ•°è¡¨ç¤ºçš„ï¼Œè€Œæˆ‘ä»¬åœ¨å±å¹•ä¸Šçœ‹åˆ°çš„æ•°å­—ã€è‹±æ–‡ã€æ ‡ç‚¹ç¬¦å·ã€æ±‰å­—ç­‰å­—ç¬¦æ˜¯äºŒè¿›åˆ¶æ•°è½¬æ¢ä¹‹åçš„ç»“æœã€‚æŒ‰ç…§æŸç§è§„åˆ™ï¼Œå°†å­—ç¬¦å­˜å‚¨åˆ°è®¡ç®—æœºä¸­ï¼Œç§°ä¸º<span class='p blue'>ç¼–ç </span> ã€‚åä¹‹ï¼Œå°†å­˜å‚¨åœ¨è®¡ç®—æœºä¸­çš„äºŒè¿›åˆ¶æ•°æŒ‰ç…§æŸç§è§„åˆ™è§£ææ˜¾ç¤ºå‡ºæ¥ï¼Œç§°ä¸º<span class='p green'>è§£ç </span> ã€‚</p><p>æ¯”å¦‚è¯´ï¼ŒæŒ‰ç…§Aè§„åˆ™å­˜å‚¨ï¼ŒåŒæ ·æŒ‰ç…§Aè§„åˆ™è§£æï¼Œé‚£ä¹ˆå°±èƒ½æ˜¾ç¤ºæ­£ç¡®çš„æ–‡æœ¬ç¬¦å·ã€‚åä¹‹ï¼ŒæŒ‰ç…§Aè§„åˆ™å­˜å‚¨ï¼Œå†æŒ‰ç…§Bè§„åˆ™è§£æï¼Œå°±ä¼šå¯¼è‡´ä¹±ç ç°è±¡ã€‚</p><p>ç¼–ç :å­—ç¬¦(èƒ½çœ‹æ‡‚çš„)â€“å­—èŠ‚(çœ‹ä¸æ‡‚çš„)</p><p>è§£ç :å­—èŠ‚(çœ‹ä¸æ‡‚çš„)â€“&gt;å­—ç¬¦(èƒ½çœ‹æ‡‚çš„)</p><p>å­—ç¬¦ç¼–ç <code>Character Encoding</code> : å°±æ˜¯ä¸€å¥—è‡ªç„¶è¯­è¨€çš„å­—ç¬¦ä¸äºŒè¿›åˆ¶æ•°ä¹‹é—´çš„å¯¹åº”è§„åˆ™ã€‚</p><p>ç¼–ç è¡¨:ç”Ÿæ´»ä¸­æ–‡å­—å’Œè®¡ç®—æœºä¸­äºŒè¿›åˆ¶çš„å¯¹åº”è§„åˆ™</p><h3 id="å­—ç¬¦é›†">å­—ç¬¦é›†</h3><p>å­—ç¬¦é›† <code>Charset</code>ï¼šä¹Ÿå«ç¼–ç è¡¨ã€‚æ˜¯ä¸€ä¸ªç³»ç»Ÿæ”¯æŒçš„æ‰€æœ‰å­—ç¬¦çš„é›†åˆï¼ŒåŒ…æ‹¬å„å›½å®¶æ–‡å­—ã€æ ‡ç‚¹ç¬¦å·ã€å›¾å½¢ç¬¦å·ã€æ•°å­—ç­‰ã€‚</p><p>è®¡ç®—æœºè¦å‡†ç¡®çš„å­˜å‚¨å’Œè¯†åˆ«å„ç§å­—ç¬¦é›†ç¬¦å·ï¼Œéœ€è¦è¿›è¡Œå­—ç¬¦ç¼–ç ï¼Œä¸€å¥—å­—ç¬¦é›†å¿…ç„¶è‡³å°‘æœ‰ä¸€å¥—å­—ç¬¦ç¼–ç ã€‚å¸¸è§å­—ç¬¦é›†æœ‰ASCIIå­—ç¬¦é›†ã€GBKå­—ç¬¦é›†ã€Unicodeå­—ç¬¦é›†ç­‰ã€‚<img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1_charset.jpg" alt=""></p><p>å¯è§ï¼Œå½“æŒ‡å®šäº†<span class='p blue'>ç¼–ç </span>ï¼Œå®ƒæ‰€å¯¹åº”çš„<span class='p green'>å­—ç¬¦é›†</span>è‡ªç„¶å°±æŒ‡å®šäº†ï¼Œæ‰€ä»¥<span class='p blue'>ç¼–ç </span>æ‰æ˜¯æˆ‘ä»¬æœ€ç»ˆè¦å…³å¿ƒçš„ã€‚</p><ul><li>ASCIIå­—ç¬¦é›† ï¼š<ul><li>ASCIIï¼ˆAmerican Standard Code for Information Interchangeï¼Œç¾å›½ä¿¡æ¯äº¤æ¢æ ‡å‡†ä»£ç ï¼‰æ˜¯åŸºäºæ‹‰ä¸å­—æ¯çš„ä¸€å¥—ç”µè„‘ç¼–ç ç³»ç»Ÿï¼Œç”¨äºæ˜¾ç¤ºç°ä»£è‹±è¯­ï¼Œä¸»è¦åŒ…æ‹¬æ§åˆ¶å­—ç¬¦ï¼ˆå›è½¦é”®ã€é€€æ ¼ã€æ¢è¡Œé”®ç­‰ï¼‰å’Œå¯æ˜¾ç¤ºå­—ç¬¦ï¼ˆè‹±æ–‡å¤§å°å†™å­—ç¬¦ã€é˜¿æ‹‰ä¼¯æ•°å­—å’Œè¥¿æ–‡ç¬¦å·ï¼‰ã€‚</li><li>åŸºæœ¬çš„ASCIIå­—ç¬¦é›†ï¼Œä½¿ç”¨7ä½ï¼ˆbitsï¼‰è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œå…±128å­—ç¬¦ã€‚ASCIIçš„æ‰©å±•å­—ç¬¦é›†ä½¿ç”¨8ä½ï¼ˆbitsï¼‰è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œå…±256å­—ç¬¦ï¼Œæ–¹ä¾¿æ”¯æŒæ¬§æ´²å¸¸ç”¨å­—ç¬¦ã€‚</li></ul></li><li>ISO-8859-1å­—ç¬¦é›†ï¼š<ul><li>æ‹‰ä¸ç è¡¨ï¼Œåˆ«åLatin-1ï¼Œç”¨äºæ˜¾ç¤ºæ¬§æ´²ä½¿ç”¨çš„è¯­è¨€ï¼ŒåŒ…æ‹¬è·å…°ã€ä¸¹éº¦ã€å¾·è¯­ã€æ„å¤§åˆ©è¯­ã€è¥¿ç­ç‰™è¯­ç­‰ã€‚</li><li>ISO-8859-1ä½¿ç”¨å•å­—èŠ‚ç¼–ç ï¼Œå…¼å®¹ASCIIç¼–ç ã€‚</li></ul></li><li>GBxxxå­—ç¬¦é›†ï¼š<ul><li>GBå°±æ˜¯å›½æ ‡çš„æ„æ€ï¼Œæ˜¯ä¸ºäº†æ˜¾ç¤ºä¸­æ–‡è€Œè®¾è®¡çš„ä¸€å¥—å­—ç¬¦é›†ã€‚</li><li>GB2312ï¼šç®€ä½“ä¸­æ–‡ç è¡¨ã€‚ä¸€ä¸ªå°äº127çš„å­—ç¬¦çš„æ„ä¹‰ä¸åŸæ¥ç›¸åŒã€‚ä½†ä¸¤ä¸ªå¤§äº127çš„å­—ç¬¦è¿åœ¨ä¸€èµ·æ—¶ï¼Œå°±è¡¨ç¤ºä¸€ä¸ªæ±‰å­—ï¼Œè¿™æ ·å¤§çº¦å¯ä»¥ç»„åˆäº†åŒ…å«7000å¤šä¸ªç®€ä½“æ±‰å­—ï¼Œæ­¤å¤–æ•°å­¦ç¬¦å·ã€ç½—é©¬å¸Œè…Šçš„å­—æ¯ã€æ—¥æ–‡çš„å‡åä»¬éƒ½ç¼–è¿›å»äº†ï¼Œè¿åœ¨ASCIIé‡Œæœ¬æ¥å°±æœ‰çš„æ•°å­—ã€æ ‡ç‚¹ã€å­—æ¯éƒ½ç»Ÿç»Ÿé‡æ–°ç¼–äº†ä¸¤ä¸ªå­—èŠ‚é•¿çš„ç¼–ç ï¼Œè¿™å°±æ˜¯å¸¸è¯´çš„&quot;å…¨è§’&quot;å­—ç¬¦ï¼Œè€ŒåŸæ¥åœ¨127å·ä»¥ä¸‹çš„é‚£äº›å°±å«&quot;åŠè§’&quot;å­—ç¬¦äº†ã€‚</li><li>GBKï¼šæœ€å¸¸ç”¨çš„ä¸­æ–‡ç è¡¨ã€‚æ˜¯åœ¨GB2312æ ‡å‡†åŸºç¡€ä¸Šçš„æ‰©å±•è§„èŒƒï¼Œä½¿ç”¨äº†åŒå­—èŠ‚ç¼–ç æ–¹æ¡ˆï¼Œå…±æ”¶å½•äº†21003ä¸ªæ±‰å­—ï¼Œå®Œå…¨å…¼å®¹GB2312æ ‡å‡†ï¼ŒåŒæ—¶æ”¯æŒç¹ä½“æ±‰å­—ä»¥åŠæ—¥éŸ©æ±‰å­—ç­‰ã€‚</li><li>GB18030ï¼šæœ€æ–°çš„ä¸­æ–‡ç è¡¨ã€‚æ”¶å½•æ±‰å­—70244ä¸ªï¼Œé‡‡ç”¨å¤šå­—èŠ‚ç¼–ç ï¼Œæ¯ä¸ªå­—å¯ä»¥ç”±1ä¸ªã€2ä¸ªæˆ–4ä¸ªå­—èŠ‚ç»„æˆã€‚æ”¯æŒä¸­å›½å›½å†…å°‘æ•°æ°‘æ—çš„æ–‡å­—ï¼ŒåŒæ—¶æ”¯æŒç¹ä½“æ±‰å­—ä»¥åŠæ—¥éŸ©æ±‰å­—ç­‰ã€‚</li></ul></li><li>Unicodeå­—ç¬¦é›† ï¼š<ul><li>Unicodeç¼–ç ç³»ç»Ÿä¸ºè¡¨è¾¾ä»»æ„è¯­è¨€çš„ä»»æ„å­—ç¬¦è€Œè®¾è®¡ï¼Œæ˜¯ä¸šç•Œçš„ä¸€ç§æ ‡å‡†ï¼Œä¹Ÿç§°ä¸ºç»Ÿä¸€ç ã€æ ‡å‡†ä¸‡å›½ç ã€‚</li><li>å®ƒæœ€å¤šä½¿ç”¨4ä¸ªå­—èŠ‚çš„æ•°å­—æ¥è¡¨è¾¾æ¯ä¸ªå­—æ¯ã€ç¬¦å·ï¼Œæˆ–è€…æ–‡å­—ã€‚æœ‰ä¸‰ç§ç¼–ç æ–¹æ¡ˆï¼ŒUTF-8ã€UTF-16å’ŒUTF-32ã€‚æœ€ä¸ºå¸¸ç”¨çš„UTF-8ç¼–ç ã€‚</li><li>UTF-8ç¼–ç ï¼Œå¯ä»¥ç”¨æ¥è¡¨ç¤ºUnicodeæ ‡å‡†ä¸­ä»»ä½•å­—ç¬¦ï¼Œå®ƒæ˜¯ç”µå­é‚®ä»¶ã€ç½‘é¡µåŠå…¶ä»–å­˜å‚¨æˆ–ä¼ é€æ–‡å­—çš„åº”ç”¨ä¸­ï¼Œä¼˜å…ˆé‡‡ç”¨çš„ç¼–ç ã€‚äº’è”ç½‘å·¥ç¨‹å·¥ä½œå°ç»„ï¼ˆIETFï¼‰è¦æ±‚æ‰€æœ‰äº’è”ç½‘åè®®éƒ½å¿…é¡»æ”¯æŒUTF-8ç¼–ç ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¼€å‘Webåº”ç”¨ï¼Œä¹Ÿè¦ä½¿ç”¨UTF-8ç¼–ç ã€‚å®ƒä½¿ç”¨ä¸€è‡³å››ä¸ªå­—èŠ‚ä¸ºæ¯ä¸ªå­—ç¬¦ç¼–ç ï¼Œç¼–ç è§„åˆ™ï¼š<ol><li>128ä¸ªUS-ASCIIå­—ç¬¦ï¼Œåªéœ€ä¸€ä¸ªå­—èŠ‚ç¼–ç ã€‚</li><li>æ‹‰ä¸æ–‡ç­‰å­—ç¬¦ï¼Œéœ€è¦äºŒä¸ªå­—èŠ‚ç¼–ç ã€‚</li><li>å¤§éƒ¨åˆ†å¸¸ç”¨å­—ï¼ˆå«ä¸­æ–‡ï¼‰ï¼Œä½¿ç”¨ä¸‰ä¸ªå­—èŠ‚ç¼–ç ã€‚</li><li>å…¶ä»–æå°‘ä½¿ç”¨çš„Unicodeè¾…åŠ©å­—ç¬¦ï¼Œä½¿ç”¨å››å­—èŠ‚ç¼–ç ã€‚</li></ol></li></ul></li></ul><div class="tabs" id="184ab7b2-45a9-47d5-b04c-fa10b15e6949"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#184ab7b2-45a9-47d5-b04c-fa10b15e6949-1"><i class="fas fa-cat"></i>ASCII</button></li><li class="tab"><button type="button" data-href="#184ab7b2-45a9-47d5-b04c-fa10b15e6949-2"><i class="fas fa-dragon"></i>GBK</button></li><li class="tab"><button type="button" data-href="#184ab7b2-45a9-47d5-b04c-fa10b15e6949-3"><i class="fas fa-horse"></i>GBK-è‹±æ–‡</button></li><li class="tab"><button type="button" data-href="#184ab7b2-45a9-47d5-b04c-fa10b15e6949-4"><i class="fas fa-dove"></i>GBK-ä¸­æ–‡</button></li><li class="tab"><button type="button" data-href="#184ab7b2-45a9-47d5-b04c-fa10b15e6949-5"><i class="fas fa-heartbeat"></i>ç»ƒä¹ 1</button></li><li class="tab"><button type="button" data-href="#184ab7b2-45a9-47d5-b04c-fa10b15e6949-6"><i class="fas fa-cookie-bite"></i>Unicode</button></li><li class="tab"><button type="button" data-href="#184ab7b2-45a9-47d5-b04c-fa10b15e6949-7"><i class="fas fa-seedling"></i>ç»ƒä¹ 2</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="184ab7b2-45a9-47d5-b04c-fa10b15e6949-1"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605105932374.png" alt="image-20230605105932374" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="184ab7b2-45a9-47d5-b04c-fa10b15e6949-2"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605110521924.png" alt="image-20230605110521924"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="184ab7b2-45a9-47d5-b04c-fa10b15e6949-3"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605110159762.png" alt="image-20230605110159762" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="184ab7b2-45a9-47d5-b04c-fa10b15e6949-4"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605110902419.png" alt="image-20230605110902419" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="184ab7b2-45a9-47d5-b04c-fa10b15e6949-5"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605110938055.png" alt="image-20230605110938055" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="184ab7b2-45a9-47d5-b04c-fa10b15e6949-6"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605111250559.png" alt="image-20230605111250559" style="zoom:67%;" /><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605111345585.png" alt="image-20230605111345585" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="184ab7b2-45a9-47d5-b04c-fa10b15e6949-7"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605111953146.png" alt="image-20230605111953146"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="ç¼–ç å¼•å‡ºçš„é—®é¢˜">ç¼–ç å¼•å‡ºçš„é—®é¢˜</h3><p>åœ¨IDEAä¸­ï¼Œä½¿ç”¨<code>FileReader</code> è¯»å–é¡¹ç›®ä¸­çš„æ–‡æœ¬æ–‡ä»¶ã€‚ç”±äºIDEAçš„è®¾ç½®ï¼Œéƒ½æ˜¯é»˜è®¤çš„<code>UTF-8</code>ç¼–ç ï¼Œæ‰€ä»¥æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚ä½†æ˜¯ï¼Œå½“è¯»å–Windowsç³»ç»Ÿä¸­åˆ›å»ºçš„æ–‡æœ¬æ–‡ä»¶æ—¶ï¼Œç”±äºWindowsç³»ç»Ÿçš„é»˜è®¤æ˜¯GBKç¼–ç ï¼Œå°±ä¼šå‡ºç°ä¹±ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReaderDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">FileReader</span> <span class="variable">fileReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;E:\\File_GBK.txt&quot;</span>);</span><br><span class="line">        <span class="type">int</span> read;</span><br><span class="line">        <span class="keyword">while</span> ((read = fileReader.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">            System.out.print((<span class="type">char</span>)read);</span><br><span class="line">        &#125;</span><br><span class="line">        fileReader.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">è¾“å‡ºç»“æœï¼š</span><br><span class="line">ï¿½ï¿½ï¿½</span><br></pre></td></tr></table></figure><hr><h3 id="ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¹±ç ">ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¹±ç </h3><div class="tabs" id="772e38d1-bb09-4f2e-b77a-e4f2ea15ea94"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#772e38d1-bb09-4f2e-b77a-e4f2ea15ea94-1"><i class="fas fa-atom"></i>è¯»å–æ•°æ®æ—¶æœªè¯»å®Œæ•´ä¸ªæ±‰å­—</button></li><li class="tab"><button type="button" data-href="#772e38d1-bb09-4f2e-b77a-e4f2ea15ea94-2"><i class="far fa-sun"></i>ç¼–ç å’Œè§£ç æ—¶çš„æ–¹å¼ä¸ç»Ÿä¸€</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="772e38d1-bb09-4f2e-b77a-e4f2ea15ea94-1"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605112545784.png" alt="image-20230605112545784" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="772e38d1-bb09-4f2e-b77a-e4f2ea15ea94-2"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605112647860.png" alt="image-20230605112647860" style="zoom:67%;" /><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h3 id="å¦‚ä½•é¿å…ä¹±ç ">å¦‚ä½•é¿å…ä¹±ç </h3><ol><li>ä¸è¦ç”¨å­—èŠ‚æµè¯»å–æ–‡æœ¬æ–‡ä»¶</li><li>ç¼–ç è§£ç æ—¶ä½¿ç”¨åŒä¸€ä¸ªç è¡¨ï¼ŒåŒä¸€ä¸ªç¼–ç æ–¹å¼</li></ol><hr><h3 id="Javaä¸­ç¼–ç ä¸è§£ç ">Javaä¸­ç¼–ç ä¸è§£ç </h3><table><thead><tr><th>Stringç±»ä¸­æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>public byte[] geyBytes()</code></td><td>ä½¿ç”¨é»˜è®¤æ–¹å¼è¿›è¡Œç¼–ç </td></tr><tr><td><code>public byte[] getBytes(String charsetName)</code></td><td>ä½¿ç”¨æŒ‡å®šæ–¹å¼è¿›è¡Œç¼–ç </td></tr><tr><td><code>String(byte[] bytes)</code></td><td>ä½¿ç”¨é»˜è®¤æ–¹å¼è¿›è¡Œè§£ç </td></tr><tr><td><code>String(byte[] bytes, String charsetName)</code></td><td>ä½¿ç”¨æŒ‡å®šæ–¹å¼è¿›è¡Œè§£ç </td></tr></tbody></table><hr><hr><h2 id="4-å­—ç¬¦æµ">4. å­—ç¬¦æµ</h2><p>å½“ä½¿ç”¨å­—èŠ‚æµè¯»å–æ–‡æœ¬æ–‡ä»¶æ—¶ï¼Œå¯èƒ½ä¼šæœ‰ä¸€ä¸ªå°é—®é¢˜ã€‚å°±æ˜¯é‡åˆ°ä¸­æ–‡å­—ç¬¦æ—¶ï¼Œå¯èƒ½ä¸ä¼šæ˜¾ç¤ºå®Œæ•´çš„å­—ç¬¦ï¼Œé‚£æ˜¯å› ä¸ºä¸€ä¸ªä¸­æ–‡å­—ç¬¦å¯èƒ½å ç”¨å¤šä¸ªå­—èŠ‚å­˜å‚¨ã€‚æ‰€ä»¥Javaæä¾›ä¸€äº›å­—ç¬¦æµç±»ï¼Œä»¥å­—ç¬¦ä¸ºå•ä½è¯»å†™æ•°æ®ï¼Œä¸“é—¨ç”¨äºå¤„ç†æ–‡æœ¬æ–‡ä»¶ã€‚</p><span class='p red'>å­—ç¬¦æµçš„åº•å±‚å…¶å®å°±æ˜¯å­—èŠ‚æµ</span><p>å­—ç¬¦æµ= å­—èŠ‚æµ+å­—ç¬¦é›†</p><span class='p green'>ç‰¹ç‚¹</span><p>è¾“å…¥æµï¼šä¸€æ¬¡è¯»ä¸€ä¸ªå­—èŠ‚ï¼Œé‡åˆ°ä¸­æ–‡æ—¶ï¼Œä¸€æ¬¡è¯»å¤šä¸ªå­—èŠ‚</p><span class='p blue'>ä½¿ç”¨åœºæ™¯</span><p>å¯¹äºçº¯æ–‡æœ¬æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œ</p><hr><h3 id="4-1-å­—ç¬¦è¾“å…¥æµ-Reader">4.1 å­—ç¬¦è¾“å…¥æµ[Reader]</h3><p><code>java.io.Reader</code>æŠ½è±¡ç±»æ˜¯è¡¨ç¤ºç”¨äºè¯»å–<span class='p blue'>å­—ç¬¦æµ</span>çš„æ‰€æœ‰ç±»çš„<span class='p green'>å­—ç¬¦æµ</span>ï¼Œå¯ä»¥è¯»å–å­—ç¬¦ä¿¡æ¯åˆ°å†…å­˜ä¸­ã€‚å®ƒå®šä¹‰äº†å­—ç¬¦è¾“å…¥æµçš„åŸºæœ¬å…±æ€§åŠŸèƒ½æ–¹æ³•ã€‚</p><table><thead><tr><th style="text-align:left">æ–¹æ³•</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left"><code>public void close()</code></td><td style="text-align:left">å…³é—­æ­¤æµå¹¶é‡Šæ”¾ä¸æ­¤æµç›¸å…³è”çš„ä»»ä½•ç³»ç»Ÿèµ„æº</td></tr><tr><td style="text-align:left"><code>public int read()</code></td><td style="text-align:left">ä»è¾“å…¥æµè¯»å–ä¸€ä¸ªå­—ç¬¦</td></tr><tr><td style="text-align:left"><code>public int read(char[] cbuf)</code></td><td style="text-align:left">ä»è¾“å…¥æµä¸­è¯»å–ä¸€äº›å­—ç¬¦ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åˆ°å­—ç¬¦æ•°ç»„ cbufä¸­</td></tr></tbody></table><h3 id="4-2-FileReaderç±»">4.2 FileReaderç±»</h3><p><code>java.io.FileReader </code>ç±»æ˜¯è¯»å–å­—ç¬¦æ–‡ä»¶çš„ä¾¿åˆ©ç±»ã€‚æ„é€ æ—¶ä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„å­—ç¬¦ç¼–ç å’Œé»˜è®¤å­—èŠ‚ç¼“å†²åŒºã€‚</p><ol><li><p>å­—ç¬¦ç¼–ç ï¼šå­—èŠ‚ä¸å­—ç¬¦çš„å¯¹åº”è§„åˆ™ã€‚Windowsç³»ç»Ÿçš„ä¸­æ–‡ç¼–ç é»˜è®¤æ˜¯GBKç¼–ç è¡¨ã€‚ideaä¸­UTF-8</p></li><li><p>å­—èŠ‚ç¼“å†²åŒºï¼šä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œç”¨æ¥ä¸´æ—¶å­˜å‚¨å­—èŠ‚æ•°æ®ã€‚</p></li></ol><hr><h4 id="æ„é€ æ–¹æ³•-3">æ„é€ æ–¹æ³•</h4><ul><li><code>FileReader(File file)</code>ï¼š åˆ›å»ºä¸€ä¸ªæ–°çš„ FileReader ï¼Œç»™å®šè¦è¯»å–çš„Fileå¯¹è±¡ã€‚</li><li><code>FileReader(String fileName)</code>ï¼š åˆ›å»ºä¸€ä¸ªæ–°çš„ FileReader ï¼Œç»™å®šè¦è¯»å–çš„æ–‡ä»¶çš„åç§°ã€‚</li></ul><p>å½“ä½ åˆ›å»ºä¸€ä¸ªæµå¯¹è±¡æ—¶ï¼Œå¿…é¡»ä¼ å…¥ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ã€‚ç±»ä¼¼äºFileInputStream ã€‚</p><ul><li>æ„é€ ä¸¾ä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileReaderConstructor</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨Fileå¯¹è±¡åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;a.txt&quot;</span>);</span><br><span class="line">        <span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(file);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;b.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="è¯»å–å­—ç¬¦æ•°æ®">è¯»å–å­—ç¬¦æ•°æ®</h4><p>å­—ç¬¦æµçš„åº•å±‚ä¹Ÿæ˜¯å­—èŠ‚æµï¼Œé»˜è®¤ä¹Ÿæ˜¯ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚çš„è¯»å–çš„ã€‚</p><p>å¦‚æœé‡åˆ°ä¸­æ–‡å°±ä¼šä¸€æ¬¡è¯»å–å¤šä¸ªï¼ŒGBKä¸€æ¬¡è¯»ä¸¤ä¸ªå­—èŠ‚ï¼ŒUTF-8ä¸€æ¬¡è¯»ä¸‰ä¸ªå­—èŠ‚</p><div class="tabs" id="b7b8e42e-fb85-44ea-96a1-96a262669edd"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#b7b8e42e-fb85-44ea-96a1-96a262669edd-1"><i class="fas fa-atom"></i>è¯»å–å­—ç¬¦</button></li><li class="tab"><button type="button" data-href="#b7b8e42e-fb85-44ea-96a1-96a262669edd-2"><i class="far fa-sun"></i>ä½¿ç”¨å­—ç¬¦æ•°ç»„è¯»å–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="b7b8e42e-fb85-44ea-96a1-96a262669edd-1"><p><code>read</code>æ–¹æ³•ï¼Œæ¯æ¬¡å¯ä»¥è¯»å–ä¸€ä¸ªå­—ç¬¦çš„æ•°æ®ï¼Œæå‡ä¸ºintç±»å‹ï¼Œè¯»å–åˆ°æ–‡ä»¶æœ«å°¾ï¼Œè¿”å›<code>-1</code></p><p><mark class="hl-label blue">éœ€è¦å¼ºè½¬</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FRRead</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">      <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">       <span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;read.txt&quot;</span>);</span><br><span class="line">      <span class="comment">// å®šä¹‰å˜é‡ï¼Œä¿å­˜æ•°æ®</span></span><br><span class="line">        <span class="type">int</span> b ï¼›</span><br><span class="line">        <span class="comment">// å¾ªç¯è¯»å–</span></span><br><span class="line">        <span class="keyword">while</span> ((b = fr.read())!=-<span class="number">1</span>) &#123;</span><br><span class="line">            System.out.println((<span class="type">char</span>)b);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fr.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¾“å‡ºç»“æœï¼š</span></span><br><span class="line">é»‘</span><br><span class="line">é©¬</span><br><span class="line">ç¨‹</span><br><span class="line">åº</span><br><span class="line">å‘˜</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="b7b8e42e-fb85-44ea-96a1-96a262669edd-2"><p><code>read(char[] cbuf)</code>ï¼Œæ¯æ¬¡è¯»å–bçš„é•¿åº¦ä¸ªå­—ç¬¦åˆ°æ•°ç»„ä¸­ï¼Œè¿”å›è¯»å–åˆ°çš„æœ‰æ•ˆå­—ç¬¦ä¸ªæ•°ï¼Œè¯»å–åˆ°æœ«å°¾æ—¶ï¼Œè¿”å›<code>-1</code></p><p><mark class="hl-label blue">ä¸éœ€è¦å¼ºè½¬</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FISRead</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">      <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">       <span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;read.txt&quot;</span>);</span><br><span class="line">      <span class="comment">// å®šä¹‰å˜é‡ï¼Œä¿å­˜æœ‰æ•ˆå­—ç¬¦ä¸ªæ•°</span></span><br><span class="line">        <span class="type">int</span> len ï¼›</span><br><span class="line">        <span class="comment">// å®šä¹‰å­—ç¬¦æ•°ç»„ï¼Œä½œä¸ºè£…å­—ç¬¦æ•°æ®çš„å®¹å™¨</span></span><br><span class="line">        <span class="type">char</span>[] cbuf = <span class="keyword">new</span> <span class="title class_">char</span>[<span class="number">2</span>];</span><br><span class="line">        <span class="comment">// å¾ªç¯è¯»å–</span></span><br><span class="line">        <span class="keyword">while</span> ((len = fr.read(cbuf))!=-<span class="number">1</span>) &#123;</span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(cbuf,<span class="number">0</span>,len));</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fr.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">è¾“å‡ºç»“æœï¼š</span><br><span class="line">é»‘é©¬</span><br><span class="line">ç¨‹åº</span><br><span class="line">å‘˜</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><hr><h3 id="4-3-å­—ç¬¦è¾“å‡ºæµ-Writer">4.3 å­—ç¬¦è¾“å‡ºæµ[Writer]</h3><p><code>java.io.Writer </code>æŠ½è±¡ç±»æ˜¯è¡¨ç¤ºç”¨äº<span class='p blue'>å†™å‡ºå­—ç¬¦æµ</span>çš„æ‰€æœ‰ç±»çš„<span class='p green'>è¶…ç±»</span>ï¼Œå°†æŒ‡å®šçš„å­—ç¬¦ä¿¡æ¯å†™å‡ºåˆ°ç›®çš„åœ°ã€‚å®ƒå®šä¹‰äº†å­—èŠ‚è¾“å‡ºæµçš„åŸºæœ¬å…±æ€§åŠŸèƒ½æ–¹æ³•ã€‚</p><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>void write(int c)</code></td><td>å†™å…¥å•ä¸ªå­—ç¬¦</td></tr><tr><td><code>void write(char[] cbuf) </code></td><td>å†™å…¥å­—ç¬¦æ•°ç»„</td></tr><tr><td><code>abstract  void write(char[] cbuf, int off, int len) </code></td><td>å†™å…¥å­—ç¬¦æ•°ç»„çš„æŸä¸€éƒ¨åˆ†,offæ•°ç»„çš„å¼€å§‹ç´¢å¼•,lenå†™çš„å­—ç¬¦ä¸ªæ•°</td></tr><tr><td><code>void write(String str) </code></td><td>å†™å…¥å­—ç¬¦ä¸²</td></tr><tr><td><code>void write(String str, int off, int len)</code></td><td>å†™å…¥å­—ç¬¦ä¸²çš„æŸä¸€éƒ¨åˆ†,offå­—ç¬¦ä¸²çš„å¼€å§‹ç´¢å¼•,lenå†™çš„å­—ç¬¦ä¸ªæ•°</td></tr><tr><td><code>void flush() </code></td><td>åˆ·æ–°è¯¥æµçš„ç¼“å†²</td></tr><tr><td><code>void close()</code></td><td>å…³é—­æ­¤æµï¼Œä½†è¦å…ˆåˆ·æ–°å®ƒ</td></tr></tbody></table><hr><h3 id="4-4-FileWriterç±»">4.4 FileWriterç±»</h3><p><code>java.io.FileWriter </code>ç±»æ˜¯å†™å‡ºå­—ç¬¦åˆ°æ–‡ä»¶çš„ä¾¿åˆ©ç±»ã€‚æ„é€ æ—¶ä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„å­—ç¬¦ç¼–ç å’Œé»˜è®¤å­—èŠ‚ç¼“å†²åŒºã€‚</p><hr><h4 id="æ„é€ æ–¹æ³•-4">æ„é€ æ–¹æ³•</h4><ul><li><code>FileWriter(File file)</code>ï¼š åˆ›å»ºä¸€ä¸ªæ–°çš„ FileWriterï¼Œç»™å®šè¦è¯»å–çš„Fileå¯¹è±¡ã€‚</li><li><code>FileWriter(String fileName)</code>ï¼š åˆ›å»ºä¸€ä¸ªæ–°çš„ FileWriterï¼Œç»™å®šè¦è¯»å–çš„æ–‡ä»¶çš„åç§°ã€‚</li></ul><p>å½“ä½ åˆ›å»ºä¸€ä¸ªæµå¯¹è±¡æ—¶ï¼Œå¿…é¡»ä¼ å…¥ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ï¼Œç±»ä¼¼äºFileOutputStreamã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileWriterConstructor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨Fileå¯¹è±¡åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;a.txt&quot;</span>);</span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(file);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;b.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="å†™å‡ºå­—ç¬¦æ•°æ®">å†™å‡ºå­—ç¬¦æ•°æ®</h4><div class="tabs" id="e6d3229b-770e-460b-8f25-294467efdc76"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e6d3229b-770e-460b-8f25-294467efdc76-1"><i class="fas fa-award"></i>å†™å‡ºå­—ç¬¦</button></li><li class="tab"><button type="button" data-href="#e6d3229b-770e-460b-8f25-294467efdc76-2"><i class="fas fa-baseball-ball"></i>å†™å‡ºå­—ç¬¦æ•°ç»„</button></li><li class="tab"><button type="button" data-href="#e6d3229b-770e-460b-8f25-294467efdc76-3"><i class="fas fa-bone"></i>å†™å‡ºå­—ç¬¦ä¸²</button></li><li class="tab"><button type="button" data-href="#e6d3229b-770e-460b-8f25-294467efdc76-4"><i class="fas fa-anchor"></i>ç»­å†™å’Œæ¢è¡Œ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e6d3229b-770e-460b-8f25-294467efdc76-1"><p><code>write(int b)</code> æ–¹æ³•ï¼Œæ¯æ¬¡å¯ä»¥å†™å‡ºä¸€ä¸ªå­—ç¬¦æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FWWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;fw.txt&quot;</span>);     </span><br><span class="line">      <span class="comment">// å†™å‡ºæ•°æ®</span></span><br><span class="line">      fw.write(<span class="number">97</span>); <span class="comment">// å†™å‡ºç¬¬1ä¸ªå­—ç¬¦</span></span><br><span class="line">      fw.write(<span class="string">&#x27;b&#x27;</span>); <span class="comment">// å†™å‡ºç¬¬2ä¸ªå­—ç¬¦</span></span><br><span class="line">      fw.write(<span class="string">&#x27;C&#x27;</span>); <span class="comment">// å†™å‡ºç¬¬3ä¸ªå­—ç¬¦</span></span><br><span class="line">      fw.write(<span class="number">30000</span>); <span class="comment">// å†™å‡ºç¬¬4ä¸ªå­—ç¬¦ï¼Œä¸­æ–‡ç¼–ç è¡¨ä¸­30000å¯¹åº”ä¸€ä¸ªæ±‰å­—ã€‚</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">        ã€æ³¨æ„ã€‘å…³é—­èµ„æºæ—¶,ä¸FileOutputStreamä¸åŒã€‚</span></span><br><span class="line"><span class="comment">       å¦‚æœä¸å…³é—­,æ•°æ®åªæ˜¯ä¿å­˜åˆ°ç¼“å†²åŒºï¼Œå¹¶æœªä¿å­˜åˆ°æ–‡ä»¶ã€‚</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">// fw.close();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¾“å‡ºç»“æœï¼š</span></span><br><span class="line">abCç”°</span><br></pre></td></tr></table></figure><p>å°è´´å£«ï¼š</p><ol><li>è™½ç„¶å‚æ•°ä¸ºintç±»å‹å››ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯åªä¼šä¿ç•™ä¸€ä¸ªå­—ç¬¦çš„ä¿¡æ¯å†™å‡ºã€‚</li><li>æœªè°ƒç”¨closeæ–¹æ³•ï¼Œæ•°æ®åªæ˜¯ä¿å­˜åˆ°äº†ç¼“å†²åŒºï¼Œå¹¶æœªå†™å‡ºåˆ°æ–‡ä»¶ä¸­ã€‚</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e6d3229b-770e-460b-8f25-294467efdc76-2"><p><code>write(char[] cbuf)</code> å’Œ <code>write(char[] cbuf, int off, int len)</code> ï¼Œæ¯æ¬¡å¯ä»¥å†™å‡ºå­—ç¬¦æ•°ç»„ä¸­çš„æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FWWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;fw.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">        <span class="type">char</span>[] chars = <span class="string">&quot;é»‘é©¬ç¨‹åºå‘˜&quot;</span>.toCharArray();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å†™å‡ºå­—ç¬¦æ•°ç»„</span></span><br><span class="line">        fw.write(chars); <span class="comment">// é»‘é©¬ç¨‹åºå‘˜</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å†™å‡ºä»ç´¢å¼•2å¼€å§‹ï¼Œ2ä¸ªå­—èŠ‚ã€‚ç´¢å¼•2æ˜¯&#x27;ç¨‹&#x27;ï¼Œä¸¤ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯&#x27;ç¨‹åº&#x27;ã€‚</span></span><br><span class="line">        fw.write(b,<span class="number">2</span>,<span class="number">2</span>); <span class="comment">// ç¨‹åº</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e6d3229b-770e-460b-8f25-294467efdc76-3"><p><code>write(String str)</code> å’Œ <code>write(String str, int off, int len)</code> ï¼Œæ¯æ¬¡å¯ä»¥å†™å‡ºå­—ç¬¦ä¸²ä¸­çš„æ•°æ®ï¼Œæ›´ä¸ºæ–¹ä¾¿</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FWWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;fw.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// å­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;é»‘é©¬ç¨‹åºå‘˜&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å†™å‡ºå­—ç¬¦æ•°ç»„</span></span><br><span class="line">        fw.write(msg); <span class="comment">//é»‘é©¬ç¨‹åºå‘˜</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å†™å‡ºä»ç´¢å¼•2å¼€å§‹ï¼Œ2ä¸ªå­—èŠ‚ã€‚ç´¢å¼•2æ˜¯&#x27;ç¨‹&#x27;ï¼Œä¸¤ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯&#x27;ç¨‹åº&#x27;ã€‚</span></span><br><span class="line">        fw.write(msg, <span class="number">2</span>, <span class="number">2</span>);<span class="comment">// ç¨‹åº</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e6d3229b-770e-460b-8f25-294467efdc76-4"><p>æ“ä½œç±»ä¼¼äºFileOutputStreamã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FWWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡ï¼Œå¯ä»¥ç»­å†™æ•°æ®</span></span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;fw.txt&quot;</span>ï¼Œ<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// å†™å‡ºå­—ç¬¦ä¸²</span></span><br><span class="line">        fw.write(<span class="string">&quot;é»‘é©¬&quot;</span>);</span><br><span class="line">        <span class="comment">// å†™å‡ºæ¢è¡Œ</span></span><br><span class="line">        fw.write(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">        <span class="comment">// å†™å‡ºå­—ç¬¦ä¸²</span></span><br><span class="line">        fw.write(<span class="string">&quot;ç¨‹åºå‘˜&quot;</span>);</span><br><span class="line">        <span class="comment">// å…³é—­èµ„æº</span></span><br><span class="line">        fw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">è¾“å‡ºç»“æœ:</span><br><span class="line">é»‘é©¬ </span><br><span class="line">ç¨‹åºå‘˜</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h4 id="å…³é—­å’Œåˆ·æ–°">å…³é—­å’Œåˆ·æ–°</h4><p>å› ä¸ºå†…ç½®ç¼“å†²åŒºçš„åŸå› ï¼Œå¦‚æœä¸å…³é—­è¾“å‡ºæµï¼Œæ— æ³•å†™å‡ºå­—ç¬¦åˆ°æ–‡ä»¶ä¸­ã€‚ä½†æ˜¯å…³é—­çš„æµå¯¹è±¡ï¼Œæ˜¯æ— æ³•ç»§ç»­å†™å‡ºæ•°æ®çš„ã€‚å¦‚æœæˆ‘ä»¬æ—¢æƒ³å†™å‡ºæ•°æ®ï¼Œåˆæƒ³ç»§ç»­ä½¿ç”¨æµï¼Œå°±éœ€è¦<code>flush</code> æ–¹æ³•äº†ã€‚</p><ul><li><code>flush</code> ï¼šåˆ·æ–°ç¼“å†²åŒºï¼Œæµå¯¹è±¡å¯ä»¥ç»§ç»­ä½¿ç”¨ã€‚</li><li><code>close </code>: å…ˆåˆ·æ–°ç¼“å†²åŒºï¼Œç„¶åé€šçŸ¥ç³»ç»Ÿé‡Šæ”¾èµ„æºã€‚æµå¯¹è±¡ä¸å¯ä»¥å†è¢«ä½¿ç”¨äº†ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FWWrite</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç§°åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;fw.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// å†™å‡ºæ•°æ®ï¼Œé€šè¿‡flush</span></span><br><span class="line">        fw.write(<span class="string">&#x27;åˆ·&#x27;</span>); <span class="comment">// å†™å‡ºç¬¬1ä¸ªå­—ç¬¦</span></span><br><span class="line">        fw.flush();</span><br><span class="line">        fw.write(<span class="string">&#x27;æ–°&#x27;</span>); <span class="comment">// ç»§ç»­å†™å‡ºç¬¬2ä¸ªå­—ç¬¦ï¼Œå†™å‡ºæˆåŠŸ</span></span><br><span class="line">        fw.flush();</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// å†™å‡ºæ•°æ®ï¼Œé€šè¿‡close</span></span><br><span class="line">        fw.write(<span class="string">&#x27;å…³&#x27;</span>); <span class="comment">// å†™å‡ºç¬¬1ä¸ªå­—ç¬¦</span></span><br><span class="line">        fw.close();</span><br><span class="line">        fw.write(<span class="string">&#x27;é—­&#x27;</span>); <span class="comment">// ç»§ç»­å†™å‡ºç¬¬2ä¸ªå­—ç¬¦,ã€æŠ¥é”™ã€‘java.io.IOException: Stream closed</span></span><br><span class="line">        fw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><mark class="hl-label red">å°è´´å£«</mark> <p>å³ä¾¿æ˜¯flushæ–¹æ³•å†™å‡ºäº†æ•°æ®ï¼Œæ“ä½œçš„æœ€åè¿˜æ˜¯è¦è°ƒç”¨closeæ–¹æ³•ï¼Œé‡Šæ”¾ç³»ç»Ÿèµ„æºã€‚</p><p>å­—ç¬¦æµï¼Œåªèƒ½æ“ä½œæ–‡æœ¬æ–‡ä»¶ï¼Œä¸èƒ½æ“ä½œå›¾ç‰‡ï¼Œè§†é¢‘ç­‰éæ–‡æœ¬æ–‡ä»¶ã€‚</p><p>å½“æˆ‘ä»¬å•çº¯è¯»æˆ–è€…å†™æ–‡æœ¬æ–‡ä»¶æ—¶  ä½¿ç”¨å­—ç¬¦æµ å…¶ä»–æƒ…å†µä½¿ç”¨å­—èŠ‚æµ</p><hr><hr><hr><h2 id="5-IOå¼‚å¸¸çš„å¤„ç†">5. IOå¼‚å¸¸çš„å¤„ç†</h2><div class="tabs" id="336c0b22-4fcd-45ed-a6cd-98e737540fa5"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#336c0b22-4fcd-45ed-a6cd-98e737540fa5-1"><i class="fas fa-bug"></i>JDK7å‰å¤„ç†</button></li><li class="tab"><button type="button" data-href="#336c0b22-4fcd-45ed-a6cd-98e737540fa5-2"><i class="fas fa-cannabis"></i>JDK7çš„å¤„ç†</button></li><li class="tab"><button type="button" data-href="#336c0b22-4fcd-45ed-a6cd-98e737540fa5-3"><i class="fas fa-candy-cane"></i>JDK9çš„æ”¹è¿›</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="336c0b22-4fcd-45ed-a6cd-98e737540fa5-1"><p><code>try...catch...finally</code> ä»£ç å—ï¼Œå¤„ç†å¼‚å¸¸éƒ¨åˆ†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HandleException1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">      <span class="comment">// å£°æ˜å˜é‡</span></span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">            fw = <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;fw.txt&quot;</span>);</span><br><span class="line">            <span class="comment">// å†™å‡ºæ•°æ®</span></span><br><span class="line">            fw.write(<span class="string">&quot;é»‘é©¬ç¨‹åºå‘˜&quot;</span>); <span class="comment">//é»‘é©¬ç¨‹åºå‘˜</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (fw != <span class="literal">null</span>) &#123;</span><br><span class="line">                    fw.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="336c0b22-4fcd-45ed-a6cd-98e737540fa5-2"><p><code>try-with-resource</code> è¯­å¥ï¼Œè¯¥è¯­å¥ç¡®ä¿äº†æ¯ä¸ªèµ„æºåœ¨è¯­å¥ç»“æŸæ—¶å…³é—­ã€‚æ‰€è°“çš„èµ„æºï¼ˆresourceï¼‰æ˜¯æŒ‡åœ¨ç¨‹åºå®Œæˆåï¼Œå¿…é¡»å…³é—­çš„å¯¹è±¡ã€‚</p><p>åŸç†ï¼šå®ç°äº†AutoClosableæ¥å£ï¼Œç‰¹å®šçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥è‡ªåŠ¨é‡Šæ”¾èµ„æº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (åˆ›å»ºæµå¯¹è±¡è¯­å¥ï¼Œå¦‚æœå¤šä¸ª,ä½¿ç”¨<span class="string">&#x27;;&#x27;</span>éš”å¼€) &#123;</span><br><span class="line"><span class="comment">// è¯»å†™æ•°æ®</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç ä½¿ç”¨æ¼”ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HandleException2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">      <span class="comment">// åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">try</span> ( <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;fw.txt&quot;</span>); ) &#123;</span><br><span class="line">            <span class="comment">// å†™å‡ºæ•°æ®</span></span><br><span class="line">            fw.write(<span class="string">&quot;é»‘é©¬ç¨‹åºå‘˜&quot;</span>); <span class="comment">//é»‘é©¬ç¨‹åºå‘˜</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="336c0b22-4fcd-45ed-a6cd-98e737540fa5-3"><p><code>try-with-resource</code> çš„æ”¹è¿›ï¼Œå¯¹äº<strong>å¼•å…¥å¯¹è±¡</strong>çš„æ–¹å¼ï¼Œæ”¯æŒçš„æ›´åŠ ç®€æ´ã€‚è¢«å¼•å…¥çš„å¯¹è±¡ï¼ŒåŒæ ·å¯ä»¥è‡ªåŠ¨å…³é—­ï¼Œæ— éœ€æ‰‹åŠ¨close</p><p>æ ¼å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¢«finalä¿®é¥°çš„å¯¹è±¡</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Resource</span> <span class="variable">resource1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Resource</span>(<span class="string">&quot;resource1&quot;</span>);</span><br><span class="line"><span class="comment">// æ™®é€šå¯¹è±¡</span></span><br><span class="line"><span class="type">Resource</span> <span class="variable">resource2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Resource</span>(<span class="string">&quot;resource2&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼•å…¥æ–¹å¼ï¼šç›´æ¥å¼•å…¥</span></span><br><span class="line"><span class="keyword">try</span> (resource1; resource2) &#123;</span><br><span class="line">     <span class="comment">// ä½¿ç”¨å¯¹è±¡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç ä½¿ç”¨æ¼”ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TryDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;in.txt&quot;</span>);</span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;out.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// å¼•å…¥åˆ°tryä¸­</span></span><br><span class="line">        <span class="keyword">try</span> (fr; fw) &#123;</span><br><span class="line">            <span class="comment">// å®šä¹‰å˜é‡</span></span><br><span class="line">            <span class="type">int</span> b;</span><br><span class="line">            <span class="comment">// è¯»å–æ•°æ®</span></span><br><span class="line">            <span class="keyword">while</span> ((b = fr.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// å†™å‡ºæ•°æ®</span></span><br><span class="line">                fw.write(b);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="6-ç»¼åˆç»ƒä¹ ">6. ç»¼åˆç»ƒä¹ </h2><h3 id="6-1-æ‹·è´æ–‡ä»¶å¤¹">6.1 æ‹·è´æ–‡ä»¶å¤¹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CopyDir</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//æ‹·è´ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œè€ƒè™‘å­æ–‡ä»¶å¤¹</span></span><br><span class="line">        <span class="comment">//1.åˆ›å»ºå¯¹è±¡è¡¨ç¤ºæ•°æ®æº</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">src</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/Users/fortune/Daily/è®ºæ–‡æ±‡æŠ¥&quot;</span>);</span><br><span class="line">        <span class="comment">//2.åˆ›å»ºå¯¹è±¡è¡¨ç¤ºç›®çš„åœ°</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">dest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/Users/fortune/Daily/æœªå‘½åæ–‡ä»¶å¤¹&quot;</span>);</span><br><span class="line">        <span class="comment">//3.è°ƒç”¨æ–¹æ³•å¼€å§‹æ‹·è´</span></span><br><span class="line">        copydir(src,dest);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">copydir</span><span class="params">(File src, File dest)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        dest.mkdirs();</span><br><span class="line">        <span class="comment">//é€’å½’</span></span><br><span class="line">        <span class="comment">//1.è¿›å…¥æ•°æ®æº</span></span><br><span class="line">        File[] files = src.listFiles();</span><br><span class="line">        <span class="comment">//2.éå†æ•°ç»„</span></span><br><span class="line">        <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">            <span class="keyword">if</span>(file.isFile())&#123;</span><br><span class="line">                <span class="comment">//3.åˆ¤æ–­æ–‡ä»¶ï¼Œæ‹·è´</span></span><br><span class="line">                <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">                <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(dest,file.getName()));</span><br><span class="line">                <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="type">int</span> len;</span><br><span class="line">                <span class="keyword">while</span>((len = fis.read(bytes)) != -<span class="number">1</span>)&#123;</span><br><span class="line">                    fos.write(bytes,<span class="number">0</span>,len);</span><br><span class="line">                &#125;</span><br><span class="line">                fos.close();</span><br><span class="line">                fis.close();</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//4.åˆ¤æ–­æ–‡ä»¶å¤¹ï¼Œé€’å½’</span></span><br><span class="line">                copydir(file, <span class="keyword">new</span> <span class="title class_">File</span>(dest,file.getName()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="6-2-æ•°å­—æ’åº">6.2 æ•°å­—æ’åº</h3><p>æ–‡æœ¬æ–‡ä»¶ä¸­æœ‰ä»¥ä¸‹çš„æ•°æ®ï¼š<br>2-1-9-4-7-8<br>å°†æ–‡ä»¶ä¸­çš„æ•°æ®è¿›è¡Œæ’åºï¼Œå˜æˆä»¥ä¸‹çš„æ•°æ®ï¼š<br>1-2-4-7-8-9</p><div class="tabs" id="895d1d50-960d-47e9-946c-fd0e2c421614"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#895d1d50-960d-47e9-946c-fd0e2c421614-1"><i class="fas fa-seedling"></i>å®ç°æ–¹å¼ä¸€</button></li><li class="tab"><button type="button" data-href="#895d1d50-960d-47e9-946c-fd0e2c421614-2"><i class="fas fa-leaf"></i>å®ç°æ–¹å¼äºŒ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="895d1d50-960d-47e9-946c-fd0e2c421614-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test03</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//1.è¯»å–æ•°æ®</span></span><br><span class="line">        <span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;myio\\a.txt&quot;</span>);</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="type">int</span> ch;</span><br><span class="line">        <span class="keyword">while</span>((ch = fr.read()) != -<span class="number">1</span>)&#123;</span><br><span class="line">            sb.append((<span class="type">char</span>)ch);</span><br><span class="line">        &#125;</span><br><span class="line">        fr.close();</span><br><span class="line">        System.out.println(sb);</span><br><span class="line">        <span class="comment">//2.æ’åº</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> sb.toString();</span><br><span class="line">        String[] arrStr = str.split(<span class="string">&quot;-&quot;</span>);<span class="comment">//2-1-9-4-7-8</span></span><br><span class="line"></span><br><span class="line">        ArrayList&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String s : arrStr) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> Integer.parseInt(s);</span><br><span class="line">            list.add(i);</span><br><span class="line">        &#125;</span><br><span class="line">        Collections.sort(list);</span><br><span class="line">        System.out.println(list);</span><br><span class="line">        <span class="comment">//3.å†™å‡º</span></span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;myio\\a.txt&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(i == list.size() - <span class="number">1</span>)&#123;</span><br><span class="line">                fw.write(list.get(i) + <span class="string">&quot;&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                fw.write(list.get(i) + <span class="string">&quot;-&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        fw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="895d1d50-960d-47e9-946c-fd0e2c421614-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test04</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//1.è¯»å–æ•°æ®</span></span><br><span class="line">        <span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;myio\\a.txt&quot;</span>);</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="type">int</span> ch;</span><br><span class="line">        <span class="keyword">while</span>((ch = fr.read()) != -<span class="number">1</span>)&#123;</span><br><span class="line">            sb.append((<span class="type">char</span>)ch);</span><br><span class="line">        &#125;</span><br><span class="line">        fr.close();</span><br><span class="line">        System.out.println(sb);</span><br><span class="line">        <span class="comment">//2.æ’åº</span></span><br><span class="line">        Integer[] arr = Arrays.stream(sb.toString()</span><br><span class="line">                                      .split(<span class="string">&quot;-&quot;</span>))</span><br><span class="line">            .map(Integer::parseInt)</span><br><span class="line">            .sorted()</span><br><span class="line">            .toArray(Integer[]::<span class="keyword">new</span>);</span><br><span class="line">        <span class="comment">//3.å†™å‡º</span></span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;myio\\a.txt&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> Arrays.toString(arr).replace(<span class="string">&quot;, &quot;</span>,<span class="string">&quot;-&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> s.substring(<span class="number">1</span>, s.length() - <span class="number">1</span>);</span><br><span class="line">        fw.write(result);</span><br><span class="line">        fw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="7-ç¼“å†²æµ">7. ç¼“å†²æµ</h2><h3 id="7-1-æ¦‚è¿°">7.1 æ¦‚è¿°</h3><p>ç¼“å†²æµ,ä¹Ÿå«é«˜æ•ˆæµï¼Œæ˜¯å¯¹4ä¸ªåŸºæœ¬çš„<code>FileXxx</code> æµçš„å¢å¼ºï¼Œæ‰€ä»¥ä¹Ÿæ˜¯4ä¸ªæµï¼ŒæŒ‰ç…§æ•°æ®ç±»å‹åˆ†ç±»ï¼š</p><ul><li><strong>å­—èŠ‚ç¼“å†²æµ</strong>ï¼š<code>BufferedInputStream</code>ï¼Œ<code>BufferedOutputStream</code></li><li><strong>å­—ç¬¦ç¼“å†²æµ</strong>ï¼š<code>BufferedReader</code>ï¼Œ<code>BufferedWriter</code></li></ul><p>ç¼“å†²æµçš„åŸºæœ¬åŸç†ï¼Œæ˜¯åœ¨åˆ›å»ºæµå¯¹è±¡æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªå†…ç½®çš„é»˜è®¤å¤§å°çš„ç¼“å†²åŒºæ•°ç»„ï¼Œé€šè¿‡ç¼“å†²åŒºè¯»å†™ï¼Œå‡å°‘ç³»ç»ŸIOæ¬¡æ•°ï¼Œä»è€Œæé«˜è¯»å†™çš„æ•ˆç‡ã€‚</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605131840638.png" alt="image-20230605131840638" style="zoom:67%;" /><hr><h3 id="7-2-å­—èŠ‚ç¼“å†²æµ">7.2 å­—èŠ‚ç¼“å†²æµ</h3><h4 id="æ„é€ æ–¹æ³•-5">æ„é€ æ–¹æ³•</h4><ul><li><code>public BufferedInputStream(InputStream in)</code> ï¼šåˆ›å»ºä¸€ä¸ª æ–°çš„ç¼“å†²è¾“å…¥æµã€‚</li><li><code>public BufferedOutputStream(OutputStream out)</code>ï¼š åˆ›å»ºä¸€ä¸ªæ–°çš„ç¼“å†²è¾“å‡ºæµã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºå­—èŠ‚ç¼“å†²è¾“å…¥æµ</span></span><br><span class="line"><span class="type">BufferedInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;bis.txt&quot;</span>));</span><br><span class="line"><span class="comment">// åˆ›å»ºå­—èŠ‚ç¼“å†²è¾“å‡ºæµ</span></span><br><span class="line"><span class="type">BufferedOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;bos.txt&quot;</span>));</span><br></pre></td></tr></table></figure><hr><h4 id="æ•ˆç‡æµ‹è¯•">æ•ˆç‡æµ‹è¯•</h4><p>æŸ¥è¯¢APIï¼Œç¼“å†²æµè¯»å†™æ–¹æ³•ä¸åŸºæœ¬çš„æµæ˜¯ä¸€è‡´çš„ï¼Œæˆ‘ä»¬é€šè¿‡å¤åˆ¶å¤§æ–‡ä»¶ï¼ˆ375MBï¼‰ï¼Œæµ‹è¯•å®ƒçš„æ•ˆç‡ã€‚</p><div class="tabs" id="9d5d2982-e909-4d73-9076-fa41f7f0fcb5"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#9d5d2982-e909-4d73-9076-fa41f7f0fcb5-1"><i class="fas fa-seedling"></i>åŸºæœ¬æµ</button></li><li class="tab"><button type="button" data-href="#9d5d2982-e909-4d73-9076-fa41f7f0fcb5-2"><i class="fas fa-leaf"></i>ç¼“å†²æµ1</button></li><li class="tab"><button type="button" data-href="#9d5d2982-e909-4d73-9076-fa41f7f0fcb5-3"><i class="fab fa-apple"></i>ç¼“å†²æµ2</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="9d5d2982-e909-4d73-9076-fa41f7f0fcb5-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BufferedDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="comment">// è®°å½•å¼€å§‹æ—¶é—´</span></span><br><span class="line">      <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"><span class="comment">// åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;jdk9.exe&quot;</span>);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;copy.exe&quot;</span>)</span><br><span class="line">        )&#123;</span><br><span class="line">        <span class="comment">// è¯»å†™æ•°æ®</span></span><br><span class="line">            <span class="type">int</span> b;</span><br><span class="line">            <span class="keyword">while</span> ((b = fis.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                fos.write(b);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// è®°å½•ç»“æŸæ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;æ™®é€šæµå¤åˆ¶æ—¶é—´:&quot;</span>+(end - start)+<span class="string">&quot; æ¯«ç§’&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">åå‡ åˆ†é’Ÿè¿‡å»äº†...</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9d5d2982-e909-4d73-9076-fa41f7f0fcb5-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BufferedDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="comment">// è®°å½•å¼€å§‹æ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">                <span class="type">BufferedInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;jdk9.exe&quot;</span>));</span><br><span class="line">                <span class="type">BufferedOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;copy.exe&quot;</span>));</span><br><span class="line">        )&#123;</span><br><span class="line">            <span class="comment">// è¯»å†™æ•°æ®</span></span><br><span class="line">            <span class="type">int</span> b;</span><br><span class="line">            <span class="keyword">while</span> ((b = bis.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                bos.write(b);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è®°å½•ç»“æŸæ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;ç¼“å†²æµå¤åˆ¶æ—¶é—´:&quot;</span>+(end - start)+<span class="string">&quot; æ¯«ç§’&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ç¼“å†²æµå¤åˆ¶æ—¶é—´:<span class="number">8016</span> æ¯«ç§’</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9d5d2982-e909-4d73-9076-fa41f7f0fcb5-3"><p>å¦‚ä½•æ›´å¿«å‘¢ï¼Ÿä½¿ç”¨æ•°ç»„çš„æ–¹å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BufferedDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">      <span class="comment">// è®°å½•å¼€å§‹æ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"><span class="comment">// åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line"><span class="type">BufferedInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;jdk9.exe&quot;</span>));</span><br><span class="line"> <span class="type">BufferedOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;copy.exe&quot;</span>));</span><br><span class="line">        )&#123;</span><br><span class="line">          <span class="comment">// è¯»å†™æ•°æ®</span></span><br><span class="line">            <span class="type">int</span> len;</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8</span>*<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">while</span> ((len = bis.read(bytes)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                bos.write(bytes, <span class="number">0</span> , len);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// è®°å½•ç»“æŸæ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;ç¼“å†²æµä½¿ç”¨æ•°ç»„å¤åˆ¶æ—¶é—´:&quot;</span>+(end - start)+<span class="string">&quot; æ¯«ç§’&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">ç¼“å†²æµä½¿ç”¨æ•°ç»„å¤åˆ¶æ—¶é—´:<span class="number">666</span> æ¯«ç§’</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h3 id="7-3-å­—ç¬¦ç¼“å†²æµ">7.3 å­—ç¬¦ç¼“å†²æµ</h3><h4 id="æ„é€ æ–¹æ³•-6">æ„é€ æ–¹æ³•</h4><ul><li><code>public BufferedReader(Reader in)</code> ï¼šåˆ›å»ºä¸€ä¸ª æ–°çš„ç¼“å†²è¾“å…¥æµã€‚</li><li><code>public BufferedWriter(Writer out)</code>ï¼š åˆ›å»ºä¸€ä¸ªæ–°çš„ç¼“å†²è¾“å‡ºæµã€‚</li></ul><p>æ„é€ ä¸¾ä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºå­—ç¬¦ç¼“å†²è¾“å…¥æµ</span></span><br><span class="line"><span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;br.txt&quot;</span>));</span><br><span class="line"><span class="comment">// åˆ›å»ºå­—ç¬¦ç¼“å†²è¾“å‡ºæµ</span></span><br><span class="line"><span class="type">BufferedWriter</span> <span class="variable">bw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;bw.txt&quot;</span>));</span><br></pre></td></tr></table></figure><h4 id="ç‰¹æœ‰æ–¹æ³•">ç‰¹æœ‰æ–¹æ³•</h4><p>å­—ç¬¦ç¼“å†²æµçš„åŸºæœ¬æ–¹æ³•ä¸æ™®é€šå­—ç¬¦æµè°ƒç”¨æ–¹å¼ä¸€è‡´ï¼Œä¸å†é˜è¿°ï¼Œæˆ‘ä»¬æ¥çœ‹å®ƒä»¬å…·å¤‡çš„ç‰¹æœ‰æ–¹æ³•ã€‚</p><ul><li>BufferedReaderï¼š<code>public String readLine()</code>: è¯»ä¸€è¡Œæ–‡å­—ã€‚</li><li>BufferedWriterï¼š<code>public void newLine()</code>: å†™ä¸€è¡Œè¡Œåˆ†éš”ç¬¦,ç”±ç³»ç»Ÿå±æ€§å®šä¹‰ç¬¦å·ã€‚ è·¨å¹³å°çš„æ¢è¡Œ</li></ul><div class="tabs" id="76a42036-3cc4-4933-9695-5f84eea8bb52"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#76a42036-3cc4-4933-9695-5f84eea8bb52-1"><i class="fas fa-cat"></i>readLine</button></li><li class="tab"><button type="button" data-href="#76a42036-3cc4-4933-9695-5f84eea8bb52-2"><i class="fas fa-horse"></i>newLine</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="76a42036-3cc4-4933-9695-5f84eea8bb52-1"><p>readLineæ–¹æ³•åœ¨è¯»å–çš„æ—¶å€™ï¼Œä¸€æ¬¡è¯»ä¸€æ•´è¡Œï¼Œé‡åˆ°å›è½¦æ¢è¡Œç»“æŸ</p><p>ä½†æ˜¯ä¸ä¼šæŠŠå›è½¦æ¢è¡Œè¯»å…¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BufferedReaderDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;in.txt&quot;</span>));</span><br><span class="line">        <span class="comment">// å®šä¹‰å­—ç¬¦ä¸²,ä¿å­˜è¯»å–çš„ä¸€è¡Œæ–‡å­—</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">line</span>  <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// å¾ªç¯è¯»å–,è¯»å–åˆ°æœ€åè¿”å›null</span></span><br><span class="line">        <span class="keyword">while</span> ((line = br.readLine())!=<span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.print(line);</span><br><span class="line">            System.out.println(<span class="string">&quot;------&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾èµ„æº</span></span><br><span class="line">        br.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="76a42036-3cc4-4933-9695-5f84eea8bb52-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BufferedWriterDemo</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException  &#123;</span><br><span class="line">      <span class="comment">// åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line"><span class="type">BufferedWriter</span> <span class="variable">bw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;out.txt&quot;</span>));</span><br><span class="line">      <span class="comment">// å†™å‡ºæ•°æ®</span></span><br><span class="line">        bw.write(<span class="string">&quot;é»‘é©¬&quot;</span>);</span><br><span class="line">      <span class="comment">// å†™å‡ºæ¢è¡Œ</span></span><br><span class="line">        bw.newLine();</span><br><span class="line">        bw.write(<span class="string">&quot;ç¨‹åº&quot;</span>);</span><br><span class="line">        bw.newLine();</span><br><span class="line">        bw.write(<span class="string">&quot;å‘˜&quot;</span>);</span><br><span class="line">        bw.newLine();</span><br><span class="line"><span class="comment">// é‡Šæ”¾èµ„æº</span></span><br><span class="line">        bw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¾“å‡ºæ•ˆæœ:</span></span><br><span class="line">é»‘é©¬</span><br><span class="line">ç¨‹åº</span><br><span class="line">å‘˜</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h4 id="ç»ƒä¹ ">ç»ƒä¹ </h4><p>è¯·å°†æ–‡æœ¬ä¿¡æ¯æ¢å¤é¡ºåºã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">3.ä¾ä¸­ã€ä¾éƒéƒ­æ”¸ä¹‹ã€è´¹ç¥ã€è‘£å…ç­‰ï¼Œæ­¤çš†è‰¯å®ï¼Œå¿—è™‘å¿ çº¯ï¼Œæ˜¯ä»¥å…ˆå¸ç®€æ‹”ä»¥é—é™›ä¸‹ã€‚æ„šä»¥ä¸ºå®«ä¸­ä¹‹äº‹ï¼Œäº‹æ— å¤§å°ï¼Œæ‚‰ä»¥å’¨ä¹‹ï¼Œç„¶åæ–½è¡Œï¼Œå¿…å¾—è£¨è¡¥é˜™æ¼ï¼Œæœ‰æ‰€å¹¿ç›Šã€‚</span><br><span class="line">8.æ„¿é™›ä¸‹æ‰˜è‡£ä»¥è®¨è´¼å…´å¤ä¹‹æ•ˆï¼Œä¸æ•ˆï¼Œåˆ™æ²»è‡£ä¹‹ç½ªï¼Œä»¥å‘Šå…ˆå¸ä¹‹çµã€‚è‹¥æ— å…´å¾·ä¹‹è¨€ï¼Œåˆ™è´£æ”¸ä¹‹ã€ç¥ã€å…ç­‰ä¹‹æ…¢ï¼Œä»¥å½°å…¶å’ï¼›é™›ä¸‹äº¦å®œè‡ªè°‹ï¼Œä»¥å’¨è¯¹å–„é“ï¼Œå¯Ÿçº³é›…è¨€ï¼Œæ·±è¿½å…ˆå¸é—è¯ï¼Œè‡£ä¸èƒœå—æ©æ„Ÿæ¿€ã€‚</span><br><span class="line">4.å°†å†›å‘å® ï¼Œæ€§è¡Œæ·‘å‡ï¼Œæ™“ç•…å†›äº‹ï¼Œè¯•ç”¨ä¹‹äºæ˜”æ—¥ï¼Œå…ˆå¸ç§°ä¹‹æ›°èƒ½ï¼Œæ˜¯ä»¥ä¼—è®®ä¸¾å® ä¸ºç£ã€‚æ„šä»¥ä¸ºè¥ä¸­ä¹‹äº‹ï¼Œæ‚‰ä»¥å’¨ä¹‹ï¼Œå¿…èƒ½ä½¿è¡Œé˜µå’Œç¦ï¼Œä¼˜åŠ£å¾—æ‰€ã€‚</span><br><span class="line">2.å®«ä¸­åºœä¸­ï¼Œä¿±ä¸ºä¸€ä½“ï¼Œé™Ÿç½šè‡§å¦ï¼Œä¸å®œå¼‚åŒã€‚è‹¥æœ‰ä½œå¥¸çŠ¯ç§‘åŠä¸ºå¿ å–„è€…ï¼Œå®œä»˜æœ‰å¸è®ºå…¶åˆ‘èµï¼Œä»¥æ˜­é™›ä¸‹å¹³æ˜ä¹‹ç†ï¼Œä¸å®œåç§ï¼Œä½¿å†…å¤–å¼‚æ³•ä¹Ÿã€‚</span><br><span class="line">1.å…ˆå¸åˆ›ä¸šæœªåŠè€Œä¸­é“å´©æ®‚ï¼Œä»Šå¤©ä¸‹ä¸‰åˆ†ï¼Œç›Šå·ç–²å¼Šï¼Œæ­¤è¯šå±æ€¥å­˜äº¡ä¹‹ç§‹ä¹Ÿã€‚ç„¶ä¾å«ä¹‹è‡£ä¸æ‡ˆäºå†…ï¼Œå¿ å¿—ä¹‹å£«å¿˜èº«äºå¤–è€…ï¼Œç›–è¿½å…ˆå¸ä¹‹æ®Šé‡ï¼Œæ¬²æŠ¥ä¹‹äºé™›ä¸‹ä¹Ÿã€‚è¯šå®œå¼€å¼ åœ£å¬ï¼Œä»¥å…‰å…ˆå¸é—å¾·ï¼Œæ¢å¼˜å¿—å£«ä¹‹æ°”ï¼Œä¸å®œå¦„è‡ªè²è–„ï¼Œå¼•å–»å¤±ä¹‰ï¼Œä»¥å¡å¿ è°ä¹‹è·¯ä¹Ÿã€‚</span><br><span class="line">9.ä»Šå½“è¿œç¦»ï¼Œä¸´è¡¨æ¶•é›¶ï¼Œä¸çŸ¥æ‰€è¨€ã€‚</span><br><span class="line">6.è‡£æœ¬å¸ƒè¡£ï¼Œèº¬è€•äºå—é˜³ï¼Œè‹Ÿå…¨æ€§å‘½äºä¹±ä¸–ï¼Œä¸æ±‚é—»è¾¾äºè¯¸ä¾¯ã€‚å…ˆå¸ä¸ä»¥è‡£å‘é„™ï¼ŒçŒ¥è‡ªæ‰å±ˆï¼Œä¸‰é¡¾è‡£äºè‰åºä¹‹ä¸­ï¼Œå’¨è‡£ä»¥å½“ä¸–ä¹‹äº‹ï¼Œç”±æ˜¯æ„Ÿæ¿€ï¼Œé‚è®¸å…ˆå¸ä»¥é©±é©°ã€‚åå€¼å€¾è¦†ï¼Œå—ä»»äºè´¥å†›ä¹‹é™…ï¼Œå¥‰å‘½äºå±éš¾ä¹‹é—´ï¼Œå°”æ¥äºŒåæœ‰ä¸€å¹´çŸ£ã€‚</span><br><span class="line">7.å…ˆå¸çŸ¥è‡£è°¨æ…ï¼Œæ•…ä¸´å´©å¯„è‡£ä»¥å¤§äº‹ä¹Ÿã€‚å—å‘½ä»¥æ¥ï¼Œå¤™å¤œå¿§å¹ï¼Œæä»˜æ‰˜ä¸æ•ˆï¼Œä»¥ä¼¤å…ˆå¸ä¹‹æ˜ï¼Œæ•…äº”æœˆæ¸¡æ³¸ï¼Œæ·±å…¥ä¸æ¯›ã€‚ä»Šå—æ–¹å·²å®šï¼Œå…µç”²å·²è¶³ï¼Œå½“å¥–ç‡ä¸‰å†›ï¼ŒåŒ—å®šä¸­åŸï¼Œåº¶ç«­é©½é’ï¼Œæ”˜é™¤å¥¸å‡¶ï¼Œå…´å¤æ±‰å®¤ï¼Œè¿˜äºæ—§éƒ½ã€‚æ­¤è‡£æ‰€ä»¥æŠ¥å…ˆå¸è€Œå¿ é™›ä¸‹ä¹‹èŒåˆ†ä¹Ÿã€‚è‡³äºæ–Ÿé…ŒæŸç›Šï¼Œè¿›å°½å¿ è¨€ï¼Œåˆ™æ”¸ä¹‹ã€ç¥ã€å…ä¹‹ä»»ä¹Ÿã€‚</span><br><span class="line">5.äº²è´¤è‡£ï¼Œè¿œå°äººï¼Œæ­¤å…ˆæ±‰æ‰€ä»¥å…´éš†ä¹Ÿï¼›äº²å°äººï¼Œè¿œè´¤è‡£ï¼Œæ­¤åæ±‰æ‰€ä»¥å€¾é¢“ä¹Ÿã€‚å…ˆå¸åœ¨æ—¶ï¼Œæ¯ä¸è‡£è®ºæ­¤äº‹ï¼Œæœªå°ä¸å¹æ¯ç—›æ¨äºæ¡“ã€çµä¹Ÿã€‚ä¾ä¸­ã€å°šä¹¦ã€é•¿å²ã€å‚å†›ï¼Œæ­¤æ‚‰è´è‰¯æ­»èŠ‚ä¹‹è‡£ï¼Œæ„¿é™›ä¸‹äº²ä¹‹ä¿¡ä¹‹ï¼Œåˆ™æ±‰å®¤ä¹‹éš†ï¼Œå¯è®¡æ—¥è€Œå¾…ä¹Ÿã€‚</span><br></pre></td></tr></table></figure><ol><li>é€è¡Œè¯»å–æ–‡æœ¬ä¿¡æ¯ã€‚</li><li>æŠŠè¯»å–åˆ°çš„æ–‡æœ¬å­˜å‚¨åˆ°é›†åˆä¸­</li><li>å¯¹é›†åˆä¸­çš„æ–‡æœ¬è¿›è¡Œæ’åº</li><li>éå†é›†åˆï¼ŒæŒ‰é¡ºåºï¼Œå†™å‡ºæ–‡æœ¬ä¿¡æ¯ã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo05Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//1.åˆ›å»ºArrayListé›†åˆ,æ³›å‹ä½¿ç”¨String</span></span><br><span class="line">        ArrayList&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//2.åˆ›å»ºBufferedReaderå¯¹è±¡,æ„é€ æ–¹æ³•ä¸­ä¼ é€’FileReaderå¯¹è±¡</span></span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;10_IO\\in.txt&quot;</span>));</span><br><span class="line">        <span class="comment">//3.åˆ›å»ºBufferedWriterå¯¹è±¡,æ„é€ æ–¹æ³•ä¸­ä¼ é€’FileWriterå¯¹è±¡</span></span><br><span class="line">        <span class="type">BufferedWriter</span> <span class="variable">bw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;10_IO\\out.txt&quot;</span>));</span><br><span class="line">        <span class="comment">//4.ä½¿ç”¨BufferedReaderå¯¹è±¡ä¸­çš„æ–¹æ³•readLine,ä»¥è¡Œçš„æ–¹å¼è¯»å–æ–‡æœ¬</span></span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">while</span>((line = br.readLine())!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//5.æŠŠè¯»å–åˆ°çš„æ–‡æœ¬å­˜å‚¨åˆ°ArrayListé›†åˆä¸­</span></span><br><span class="line">            list.add(line);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//6.ä½¿ç”¨Collectionsé›†åˆå·¥å…·ç±»ä¸­çš„æ–¹æ³•sort,å¯¹é›†åˆä¸­çš„å…ƒç´ æŒ‰ç…§è‡ªå®šä¹‰è§„åˆ™æ’åº</span></span><br><span class="line">        Collections.sort(list, <span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;String&gt;() &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                o1-o2:å‡åº</span></span><br><span class="line"><span class="comment">                o2-o1:é™åº</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(String o1, String o2)</span> &#123;</span><br><span class="line">                <span class="comment">//ä¾æ¬¡æ¯”è¾ƒé›†åˆä¸­ä¸¤ä¸ªå…ƒç´ çš„é¦–å­—æ¯,å‡åºæ’åº</span></span><br><span class="line">                <span class="keyword">return</span> o1.charAt(<span class="number">0</span>)-o2.charAt(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//7.éå†ArrayListé›†åˆ,è·å–æ¯ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">        <span class="keyword">for</span> (String s : list) &#123;</span><br><span class="line">            <span class="comment">//8.ä½¿ç”¨BufferedWriterå¯¹è±¡ä¸­çš„æ–¹æ³•wirte,æŠŠéå†å¾—åˆ°çš„å…ƒç´ å†™å…¥åˆ°æ–‡æœ¬ä¸­(å†…å­˜ç¼“å†²åŒºä¸­)</span></span><br><span class="line">            bw.write(s);</span><br><span class="line">            <span class="comment">//9.å†™æ¢è¡Œ</span></span><br><span class="line">            bw.newLine();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//10.é‡Šæ”¾èµ„æº</span></span><br><span class="line">        bw.close();</span><br><span class="line">        br.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="8-è½¬æ¢æµ">8. è½¬æ¢æµ</h2><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605142703576.png" alt="image-20230605142703576" style="zoom:67%;" /><h3 id="8-1-InputStreamReaderç±»">8.1 InputStreamReaderç±»</h3><p>è½¬æ¢æµ<code>java.io.InputStreamReader</code>ï¼Œæ˜¯Readerçš„å­ç±»ï¼Œæ˜¯ä»å­—èŠ‚æµåˆ°å­—ç¬¦æµçš„æ¡¥æ¢ã€‚å®ƒè¯»å–å­—èŠ‚ï¼Œå¹¶ä½¿ç”¨æŒ‡å®šçš„å­—ç¬¦é›†å°†å…¶è§£ç ä¸ºå­—ç¬¦ã€‚å®ƒçš„å­—ç¬¦é›†å¯ä»¥ç”±åç§°æŒ‡å®šï¼Œä¹Ÿå¯ä»¥æ¥å—å¹³å°çš„é»˜è®¤å­—ç¬¦é›†ã€‚</p><h4 id="æ„é€ æ–¹æ³•-7">æ„é€ æ–¹æ³•</h4><ul><li><code>InputStreamReader(InputStream in)</code>: åˆ›å»ºä¸€ä¸ªä½¿ç”¨é»˜è®¤å­—ç¬¦é›†çš„å­—ç¬¦æµã€‚</li><li><code>InputStreamReader(InputStream in, String charsetName)</code>: åˆ›å»ºä¸€ä¸ªæŒ‡å®šå­—ç¬¦é›†çš„å­—ç¬¦æµã€‚</li></ul><p>æ„é€ ä¸¾ä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InputStreamReader</span> <span class="variable">isr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;in.txt&quot;</span>));</span><br><span class="line"><span class="type">InputStreamReader</span> <span class="variable">isr2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;in.txt&quot;</span>) , <span class="string">&quot;GBK&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="æŒ‡å®šç¼–ç è¯»å–">æŒ‡å®šç¼–ç è¯»å–</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReaderDemo2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// å®šä¹‰æ–‡ä»¶è·¯å¾„,æ–‡ä»¶ä¸ºgbkç¼–ç </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">FileName</span> <span class="operator">=</span> <span class="string">&quot;E:\\file_gbk.txt&quot;</span>;</span><br><span class="line">        <span class="comment">// åˆ›å»ºæµå¯¹è±¡,é»˜è®¤UTF8ç¼–ç </span></span><br><span class="line">        <span class="type">InputStreamReader</span> <span class="variable">isr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(FileName));</span><br><span class="line">        <span class="comment">// åˆ›å»ºæµå¯¹è±¡,æŒ‡å®šGBKç¼–ç </span></span><br><span class="line">        <span class="type">InputStreamReader</span> <span class="variable">isr2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(FileName) , <span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">        <span class="comment">// å®šä¹‰å˜é‡,ä¿å­˜å­—ç¬¦</span></span><br><span class="line">        <span class="type">int</span> read;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨é»˜è®¤ç¼–ç å­—ç¬¦æµè¯»å–,ä¹±ç </span></span><br><span class="line">        <span class="keyword">while</span> ((read = isr.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">            System.out.print((<span class="type">char</span>)read); <span class="comment">// ï¿½ï¿½Òºï¿½</span></span><br><span class="line">        &#125;</span><br><span class="line">        isr.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä½¿ç”¨æŒ‡å®šç¼–ç å­—ç¬¦æµè¯»å–,æ­£å¸¸è§£æ</span></span><br><span class="line">        <span class="keyword">while</span> ((read = isr2.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">            System.out.print((<span class="type">char</span>)read);<span class="comment">// å¤§å®¶å¥½</span></span><br><span class="line">        &#125;</span><br><span class="line">        isr2.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="8-2-OutputStreamWriterç±»">8.2 OutputStreamWriterç±»</h3><p>è½¬æ¢æµ<code>java.io.OutputStreamWriter</code> ï¼Œæ˜¯Writerçš„å­ç±»ï¼Œæ˜¯ä»å­—ç¬¦æµåˆ°å­—èŠ‚æµçš„æ¡¥æ¢ã€‚ä½¿ç”¨æŒ‡å®šçš„å­—ç¬¦é›†å°†å­—ç¬¦ç¼–ç ä¸ºå­—èŠ‚ã€‚å®ƒçš„å­—ç¬¦é›†å¯ä»¥ç”±åç§°æŒ‡å®šï¼Œä¹Ÿå¯ä»¥æ¥å—å¹³å°çš„é»˜è®¤å­—ç¬¦é›†ã€‚</p><hr><h4 id="æ„é€ æ–¹æ³•-8">æ„é€ æ–¹æ³•</h4><ul><li><code>OutputStreamWriter(OutputStream in)</code>: åˆ›å»ºä¸€ä¸ªä½¿ç”¨é»˜è®¤å­—ç¬¦é›†çš„å­—ç¬¦æµã€‚</li><li><code>OutputStreamWriter(OutputStream in, String charsetName)</code>: åˆ›å»ºä¸€ä¸ªæŒ‡å®šå­—ç¬¦é›†çš„å­—ç¬¦æµã€‚</li></ul><p>æ„é€ ä¸¾ä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">OutputStreamWriter</span> <span class="variable">isr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;out.txt&quot;</span>));</span><br><span class="line"><span class="type">OutputStreamWriter</span> <span class="variable">isr2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;out.txt&quot;</span>) , <span class="string">&quot;GBK&quot;</span>);</span><br></pre></td></tr></table></figure><hr><h4 id="æŒ‡å®šç¼–ç å†™å‡º">æŒ‡å®šç¼–ç å†™å‡º</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OutputDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">      <span class="comment">// å®šä¹‰æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">FileName</span> <span class="operator">=</span> <span class="string">&quot;E:\\out.txt&quot;</span>;</span><br><span class="line">      <span class="comment">// åˆ›å»ºæµå¯¹è±¡,é»˜è®¤UTF8ç¼–ç </span></span><br><span class="line">        <span class="type">OutputStreamWriter</span> <span class="variable">osw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(FileName));</span><br><span class="line">        <span class="comment">// å†™å‡ºæ•°æ®</span></span><br><span class="line">      osw.write(<span class="string">&quot;ä½ å¥½&quot;</span>); <span class="comment">// ä¿å­˜ä¸º6ä¸ªå­—èŠ‚</span></span><br><span class="line">        osw.close();</span><br><span class="line">      </span><br><span class="line"><span class="comment">// å®šä¹‰æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="type">String</span> <span class="variable">FileName2</span> <span class="operator">=</span> <span class="string">&quot;E:\\out2.txt&quot;</span>;</span><br><span class="line">     <span class="comment">// åˆ›å»ºæµå¯¹è±¡,æŒ‡å®šGBKç¼–ç </span></span><br><span class="line">        <span class="type">OutputStreamWriter</span> <span class="variable">osw2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(FileName2),<span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">        <span class="comment">// å†™å‡ºæ•°æ®</span></span><br><span class="line">      osw2.write(<span class="string">&quot;ä½ å¥½&quot;</span>);<span class="comment">// ä¿å­˜ä¸º4ä¸ªå­—èŠ‚</span></span><br><span class="line">        osw2.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="8-3-è½¬æ¢æµç†è§£å›¾è§£">8.3 è½¬æ¢æµç†è§£å›¾è§£</h3><p><strong><span class='p blue'>è½¬æ¢æµæ˜¯å­—èŠ‚ä¸å­—ç¬¦é—´çš„æ¡¥æ¢ï¼</span></strong></p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2_zhuanhuan.jpg" alt=""></p><hr><h3 id="8-4-ç»ƒä¹ ">8.4 ç»ƒä¹ </h3><p>è½¬æ¢æ–‡ä»¶ç¼–ç :å°†GBKç¼–ç çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè½¬æ¢ä¸ºUTF-8ç¼–ç çš„æ–‡æœ¬æ–‡ä»¶ã€‚</p><ol><li>æŒ‡å®šGBKç¼–ç çš„è½¬æ¢æµï¼Œè¯»å–æ–‡æœ¬æ–‡ä»¶ã€‚</li><li>ä½¿ç”¨UTF-8ç¼–ç çš„è½¬æ¢æµï¼Œå†™å‡ºæ–‡æœ¬æ–‡ä»¶ã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.å®šä¹‰æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">srcFile</span> <span class="operator">=</span> <span class="string">&quot;file_gbk.txt&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">destFile</span> <span class="operator">=</span> <span class="string">&quot;file_utf8.txt&quot;</span>;</span><br><span class="line">        <span class="comment">// 2.åˆ›å»ºæµå¯¹è±¡</span></span><br><span class="line">        <span class="comment">// 2.1 è½¬æ¢è¾“å…¥æµ,æŒ‡å®šGBKç¼–ç </span></span><br><span class="line">        <span class="type">InputStreamReader</span> <span class="variable">isr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(srcFile) , <span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.2 è½¬æ¢è¾“å‡ºæµ,é»˜è®¤utf8ç¼–ç </span></span><br><span class="line">        <span class="type">OutputStreamWriter</span> <span class="variable">osw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(destFile));</span><br><span class="line">        <span class="comment">// 3.è¯»å†™æ•°æ®</span></span><br><span class="line">        <span class="comment">// 3.1 å®šä¹‰æ•°ç»„</span></span><br><span class="line">        <span class="type">char</span>[] cbuf = <span class="keyword">new</span> <span class="title class_">char</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="comment">// 3.2 å®šä¹‰é•¿åº¦</span></span><br><span class="line">        <span class="type">int</span> len;</span><br><span class="line">        <span class="comment">// 3.3 å¾ªç¯è¯»å–</span></span><br><span class="line">        <span class="keyword">while</span> ((len = isr.read(cbuf))!=-<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// å¾ªç¯å†™å‡º</span></span><br><span class="line">            osw.write(cbuf,<span class="number">0</span>,len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.é‡Šæ”¾èµ„æº</span></span><br><span class="line">        osw.close();</span><br><span class="line">        isr.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="9-åºåˆ—åŒ–æµ">9. åºåˆ—åŒ–æµ</h2><h3 id="9-1-æ¦‚è¿°">9.1 æ¦‚è¿°</h3><p>Java æä¾›äº†ä¸€ç§å¯¹è±¡<span class='p blue'>åºåˆ—åŒ–</span>çš„æœºåˆ¶ã€‚ç”¨ä¸€ä¸ªå­—èŠ‚åºåˆ—å¯ä»¥è¡¨ç¤ºä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å­—èŠ‚åºåˆ—åŒ…å«è¯¥<code>å¯¹è±¡çš„æ•°æ®</code>ã€<code>å¯¹è±¡çš„ç±»å‹</code>å’Œ<code>å¯¹è±¡ä¸­å­˜å‚¨çš„å±æ€§</code>ç­‰ä¿¡æ¯ã€‚å­—èŠ‚åºåˆ—å†™å‡ºåˆ°æ–‡ä»¶ä¹‹åï¼Œç›¸å½“äºæ–‡ä»¶ä¸­<span class='p red'>æŒä¹…ä¿å­˜</span>äº†ä¸€ä¸ªå¯¹è±¡çš„ä¿¡æ¯ã€‚</p><p>åä¹‹ï¼Œè¯¥å­—èŠ‚åºåˆ—è¿˜å¯ä»¥ä»æ–‡ä»¶ä¸­è¯»å–å›æ¥ï¼Œé‡æ„å¯¹è±¡ï¼Œå¯¹å®ƒè¿›è¡Œ<span class='p green'>ååºåˆ—åŒ–</span>ã€‚<code>å¯¹è±¡çš„æ•°æ®</code>ã€<code>å¯¹è±¡çš„ç±»å‹</code>å’Œ<code>å¯¹è±¡ä¸­å­˜å‚¨çš„æ•°æ®</code>ä¿¡æ¯ï¼Œéƒ½å¯ä»¥ç”¨æ¥åœ¨å†…å­˜ä¸­åˆ›å»ºå¯¹è±¡ã€‚çœ‹å›¾ç†è§£åºåˆ—åŒ–ï¼š <img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/3_xuliehua.jpg" alt=""></p><hr><h3 id="9-2-ObjectOutputStreamç±»">9.2 ObjectOutputStreamç±»</h3><p><code>java.io.ObjectOutputStream </code> ç±»ï¼Œå°†Javaå¯¹è±¡çš„åŸå§‹æ•°æ®ç±»å‹å†™å‡ºåˆ°æ–‡ä»¶,å®ç°å¯¹è±¡çš„æŒä¹…å­˜å‚¨ã€‚</p><h4 id="æ„é€ æ–¹æ³•-9">æ„é€ æ–¹æ³•</h4><p><code>public ObjectOutputStream(OutputStream out) </code>ï¼š åˆ›å»ºä¸€ä¸ªæŒ‡å®šOutputStreamçš„ObjectOutputStreamã€‚</p><p>æ„é€ ä¸¾ä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FileOutputStream</span> <span class="variable">fileOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;employee.txt&quot;</span>);</span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOut);</span><br></pre></td></tr></table></figure><h4 id="åºåˆ—åŒ–æ“ä½œ">åºåˆ—åŒ–æ“ä½œ</h4><ol><li>ä¸€ä¸ªå¯¹è±¡è¦æƒ³åºåˆ—åŒ–ï¼Œå¿…é¡»æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶:</li></ol><ul><li>è¯¥ç±»å¿…é¡»å®ç°<code>java.io.Serializable </code> æ¥å£ï¼Œ<code>Serializable</code> æ˜¯ä¸€ä¸ªæ ‡è®°æ¥å£ï¼Œä¸å®ç°æ­¤æ¥å£çš„ç±»å°†ä¸ä¼šä½¿ä»»ä½•çŠ¶æ€åºåˆ—åŒ–æˆ–ååºåˆ—åŒ–ï¼Œä¼šæŠ›å‡º<code>NotSerializableException</code> ã€‚</li><li>è¯¥ç±»çš„æ‰€æœ‰å±æ€§å¿…é¡»æ˜¯å¯åºåˆ—åŒ–çš„ã€‚å¦‚æœæœ‰ä¸€ä¸ªå±æ€§ä¸éœ€è¦å¯åºåˆ—åŒ–çš„ï¼Œåˆ™è¯¥å±æ€§å¿…é¡»æ³¨æ˜æ˜¯ç¬æ€çš„ï¼Œä½¿ç”¨<code>transient</code> å…³é”®å­—ä¿®é¥°ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Employee</span> <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> String address;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">transient</span> <span class="type">int</span> age; <span class="comment">// transientç¬æ€ä¿®é¥°æˆå‘˜,ä¸ä¼šè¢«åºåˆ—åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addressCheck</span><span class="params">()</span> &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;Address  check : &quot;</span> + name + <span class="string">&quot; -- &quot;</span> + address);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>serializableæ¥å£é‡Œé¢æ˜¯æ²¡æœ‰æŠ½è±¡æ–¹æ³•ï¼Œæ ‡è®°å‹æ¥å£</p><p>ä¸€æ—¦å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œé‚£ä¹ˆå°±è¡¨ç¤ºå½“å‰ç±»å¯ä»¥è¢«åºåˆ—åŒ–</p><p>2.å†™å‡ºå¯¹è±¡æ–¹æ³•</p><ul><li><code>public final void writeObject (Object obj)</code> : å°†æŒ‡å®šçš„å¯¹è±¡å†™å‡ºã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializeDemo</span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String [] args)</span>   &#123;</span><br><span class="line">    <span class="type">Employee</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Employee</span>();</span><br><span class="line">    e.name = <span class="string">&quot;zhangsan&quot;</span>;</span><br><span class="line">    e.address = <span class="string">&quot;beiqinglu&quot;</span>;</span><br><span class="line">    e.age = <span class="number">20</span>; </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// åˆ›å»ºåºåˆ—åŒ–æµå¯¹è±¡</span></span><br><span class="line">          <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;employee.txt&quot;</span>));</span><br><span class="line">        <span class="comment">// å†™å‡ºå¯¹è±¡</span></span><br><span class="line">        out.writeObject(e);</span><br><span class="line">        <span class="comment">// é‡Šæ”¾èµ„æº</span></span><br><span class="line">        out.close();</span><br><span class="line">        fileOut.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;Serialized data is saved&quot;</span>); <span class="comment">// å§“åï¼Œåœ°å€è¢«åºåˆ—åŒ–ï¼Œå¹´é¾„æ²¡æœ‰è¢«åºåˆ—åŒ–ã€‚</span></span><br><span class="line">        &#125; <span class="keyword">catch</span>(IOException i)   &#123;</span><br><span class="line">            i.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¾“å‡ºç»“æœï¼š</span></span><br><span class="line">Serialized data is saved</span><br></pre></td></tr></table></figure><hr><h3 id="9-3-ObjectInputStreamç±»">9.3 ObjectInputStreamç±»</h3><p>ObjectInputStreamååºåˆ—åŒ–æµï¼Œå°†ä¹‹å‰ä½¿ç”¨ObjectOutputStreamåºåˆ—åŒ–çš„åŸå§‹æ•°æ®æ¢å¤ä¸ºå¯¹è±¡ã€‚</p><hr><h4 id="æ„é€ æ–¹æ³•-10">æ„é€ æ–¹æ³•</h4><p><code>public ObjectInputStream(InputStream in) </code>ï¼š åˆ›å»ºä¸€ä¸ªæŒ‡å®šInputStreamçš„ObjectInputStream</p><hr><h4 id="ååºåˆ—åŒ–æ“ä½œ">ååºåˆ—åŒ–æ“ä½œ</h4><div class="tabs" id="2b2d4f12-f62d-4af1-abb9-0995ae782e8b"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#2b2d4f12-f62d-4af1-abb9-0995ae782e8b-1"><i class="fas fa-atom"></i>1</button></li><li class="tab"><button type="button" data-href="#2b2d4f12-f62d-4af1-abb9-0995ae782e8b-2"><i class="far fa-sun"></i>2</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="2b2d4f12-f62d-4af1-abb9-0995ae782e8b-1"><p>å¦‚æœèƒ½æ‰¾åˆ°ä¸€ä¸ªå¯¹è±¡çš„classæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œè°ƒç”¨<code>ObjectInputStream</code>è¯»å–å¯¹è±¡çš„æ–¹æ³•ï¼š</p><p><code>public final Object readObject ()</code> : è¯»å–ä¸€ä¸ªå¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeserializeDemo</span> &#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String [] args)</span>   &#123;</span><br><span class="line">        <span class="type">Employee</span> <span class="variable">e</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="comment">// åˆ›å»ºååºåˆ—åŒ–æµ</span></span><br><span class="line">             <span class="type">FileInputStream</span> <span class="variable">fileIn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;employee.txt&quot;</span>);</span><br><span class="line">             <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileIn);</span><br><span class="line">             <span class="comment">// è¯»å–ä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line">             e = (Employee) in.readObject();</span><br><span class="line">             <span class="comment">// é‡Šæ”¾èµ„æº</span></span><br><span class="line">             in.close();</span><br><span class="line">             fileIn.close();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(IOException i) &#123;</span><br><span class="line">             <span class="comment">// æ•è·å…¶ä»–å¼‚å¸¸</span></span><br><span class="line">             i.printStackTrace();</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(ClassNotFoundException c)  &#123;</span><br><span class="line">        <span class="comment">// æ•è·ç±»æ‰¾ä¸åˆ°å¼‚å¸¸</span></span><br><span class="line">             System.out.println(<span class="string">&quot;Employee class not found&quot;</span>);</span><br><span class="line">             c.printStackTrace();</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ— å¼‚å¸¸,ç›´æ¥æ‰“å°è¾“å‡º</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Name: &quot;</span> + e.name);<span class="comment">// zhangsan</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Address: &quot;</span> + e.address); <span class="comment">// beiqinglu</span></span><br><span class="line">        System.out.println(<span class="string">&quot;age: &quot;</span> + e.age); <span class="comment">// 0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="2b2d4f12-f62d-4af1-abb9-0995ae782e8b-2"><p>**å¦å¤–ï¼Œå½“JVMååºåˆ—åŒ–å¯¹è±¡æ—¶ï¼Œèƒ½æ‰¾åˆ°classæ–‡ä»¶ï¼Œä½†æ˜¯classæ–‡ä»¶åœ¨åºåˆ—åŒ–å¯¹è±¡ä¹‹åå‘ç”Ÿäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆååºåˆ—åŒ–æ“ä½œä¹Ÿä¼šå¤±è´¥ï¼ŒæŠ›å‡ºä¸€ä¸ª<code>InvalidClassException</code>å¼‚å¸¸ã€‚**å‘ç”Ÿè¿™ä¸ªå¼‚å¸¸çš„åŸå› å¦‚ä¸‹ï¼š</p><ul><li>è¯¥ç±»çš„åºåˆ—ç‰ˆæœ¬å·ä¸ä»æµä¸­è¯»å–çš„ç±»æè¿°ç¬¦çš„ç‰ˆæœ¬å·ä¸åŒ¹é…</li><li>è¯¥ç±»åŒ…å«æœªçŸ¥æ•°æ®ç±»å‹</li><li>è¯¥ç±»æ²¡æœ‰å¯è®¿é—®çš„æ— å‚æ•°æ„é€ æ–¹æ³•</li></ul><p><code>Serializable</code> æ¥å£ç»™éœ€è¦åºåˆ—åŒ–çš„ç±»ï¼Œæ ¹æ®æˆå‘˜å˜é‡ã€é™æ€å˜é‡ã€æ–¹æ³•ï¼Œæä¾›äº†ä¸€ä¸ªåºåˆ—ç‰ˆæœ¬å·ã€‚</p><p><code>serialVersionUID</code> è¯¥ç‰ˆæœ¬å·çš„ç›®çš„åœ¨äºéªŒè¯åºåˆ—åŒ–çš„å¯¹è±¡å’Œå¯¹åº”ç±»æ˜¯å¦ç‰ˆæœ¬åŒ¹é…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Employee</span> <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line">     <span class="comment">// åŠ å…¥åºåˆ—ç‰ˆæœ¬å·</span></span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">     <span class="keyword">public</span> String name;</span><br><span class="line">     <span class="keyword">public</span> String address;</span><br><span class="line">     <span class="comment">// æ·»åŠ æ–°çš„å±æ€§ ,é‡æ–°ç¼–è¯‘, å¯ä»¥ååºåˆ—åŒ–,è¯¥å±æ€§èµ‹ä¸ºé»˜è®¤å€¼.</span></span><br><span class="line">     <span class="keyword">public</span> <span class="type">int</span> eid; </span><br><span class="line"></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addressCheck</span><span class="params">()</span> &#123;</span><br><span class="line">         System.out.println(<span class="string">&quot;Address  check : &quot;</span> + name + <span class="string">&quot; -- &quot;</span> + address);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æå‰å®šå›ºå®šå¥½serialVersionUIDï¼Œåé¢å†æ·»åŠ å­—æ®µä¹Ÿèƒ½ååºåˆ—åŒ–ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <mark class="hl-label blue">ç»†èŠ‚æ±‡æ€»</mark> <p>â‘ ä½¿ç”¨åºåˆ—åŒ–æµå°†å¯¹è±¡å†™åˆ°æ–‡ä»¶æ—¶ï¼Œéœ€è¦è®©Javabeanç±»å®ç°Serializableæ¥å£ã€‚å¦åˆ™ï¼Œä¼šå‡ºç°NotSerializableExceptionå¼‚å¸¸</p><p>â‘¡ åºåˆ—åŒ–æµå†™åˆ°æ–‡ä»¶ä¸­çš„æ•°æ®æ˜¯ä¸èƒ½ä¿®æ”¹çš„ï¼Œä¸€æ—¦ä¿®æ”¹å°±æ— æ³•å†æ¬¡è¯»å›æ¥äº†</p><p>â‘¢åºåˆ—åŒ–å¯¹è±¡åï¼Œä¿®æ”¹äº†Javabeanç±»ï¼Œå†æ¬¡ååºåˆ—åŒ–ï¼Œä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿ</p><p>ä¼šå‡ºé—®é¢˜ï¼Œä¼šæŠ›å‡ºInvalidclassExceptionå¼‚å¸¸</p><p>è§£å†³æ–¹æ¡ˆï¼šç»™Javabeanç±»æ·»åŠ serialversionUIDï¼ˆåºåˆ—å·ã€ç‰ˆæœ¬å·ï¼‰</p><p>â‘£å¦‚æœä¸€ä¸ªå¯¹è±¡ä¸­çš„æŸä¸ªæˆå‘˜å˜é‡çš„å€¼ä¸æƒ³è¢«åºåˆ—åŒ–ï¼Œåˆè¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ</p><p>è§£å†³æ–¹æ¡ˆï¼šç»™è¯¥æˆå‘˜å˜é‡åŠ transientå…³é”®å­—ä¿®é¥°ï¼Œè¯¥å…³é”®å­—æ ‡è®°çš„æˆå‘˜å˜é‡ä¸å‚ä¸åºåˆ—åŒ–è¿‡ç¨‹</p><hr><h3 id="9-4-ç»ƒä¹ ">9.4 ç»ƒä¹ </h3><p>åºåˆ—åŒ–é›†åˆ</p><ol><li>å°†å­˜æœ‰å¤šä¸ªè‡ªå®šä¹‰å¯¹è±¡çš„é›†åˆåºåˆ—åŒ–æ“ä½œï¼Œä¿å­˜åˆ°<code>list.txt</code>æ–‡ä»¶ä¸­ã€‚</li><li>ååºåˆ—åŒ–<code>list.txt</code> ï¼Œå¹¶éå†é›†åˆï¼Œæ‰“å°å¯¹è±¡ä¿¡æ¯ã€‚</li></ol><blockquote><p>åˆ†æ</p></blockquote><ol><li>æŠŠè‹¥å¹²å­¦ç”Ÿå¯¹è±¡ ï¼Œä¿å­˜åˆ°é›†åˆä¸­ã€‚</li><li>æŠŠé›†åˆåºåˆ—åŒ–ã€‚</li><li>ååºåˆ—åŒ–è¯»å–æ—¶ï¼Œåªéœ€è¦è¯»å–ä¸€æ¬¡ï¼Œè½¬æ¢ä¸ºé›†åˆç±»å‹ã€‚</li><li>éå†é›†åˆï¼Œå¯ä»¥æ‰“å°æ‰€æœ‰çš„å­¦ç”Ÿä¿¡æ¯</li></ol><div class="tabs" id="3e032854-f16e-4c94-96cd-b7f5d280e943"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#3e032854-f16e-4c94-96cd-b7f5d280e943-1"><i class="fas fa-bug"></i>åºåˆ—åŒ–</button></li><li class="tab"><button type="button" data-href="#3e032854-f16e-4c94-96cd-b7f5d280e943-2"><i class="fas fa-cannabis"></i>ååºåˆ—åŒ–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="3e032854-f16e-4c94-96cd-b7f5d280e943-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;è€ç‹&quot;</span>, <span class="string">&quot;laow&quot;</span>);</span><br><span class="line"><span class="type">Student</span> <span class="variable">student2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;è€å¼ &quot;</span>, <span class="string">&quot;laoz&quot;</span>);</span><br><span class="line"><span class="type">Student</span> <span class="variable">student3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;è€æ&quot;</span>, <span class="string">&quot;laol&quot;</span>);</span><br><span class="line">ArrayList&lt;Student&gt; arrayList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">arrayList.add(student);</span><br><span class="line">arrayList.add(student2);</span><br><span class="line">arrayList.add(student3);</span><br><span class="line"><span class="comment">// åˆ›å»º åºåˆ—åŒ–æµ </span></span><br><span class="line">ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;list.txt&quot;</span>));</span><br><span class="line"><span class="comment">// å†™å‡ºå¯¹è±¡</span></span><br><span class="line">oos.writeObject(arrayList);</span><br><span class="line"><span class="comment">// é‡Šæ”¾èµ„æº</span></span><br><span class="line">oos.close();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="3e032854-f16e-4c94-96cd-b7f5d280e943-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;list.txt&quot;</span>));</span><br><span class="line"><span class="comment">// è¯»å–å¯¹è±¡,å¼ºè½¬ä¸ºArrayListç±»å‹</span></span><br><span class="line">ArrayList&lt;Student&gt; list = (ArrayList&lt;Student&gt;) ois.readObject();</span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;list.size();i++)&#123;</span><br><span class="line">    Student s=list.get(i);</span><br><span class="line">    System.out.println(s.getName()+<span class="string">&quot;--&quot;</span>+s.getPwd());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="10-æ‰“å°æµ">10. æ‰“å°æµ</h2><h3 id="10-1-æ¦‚è¿°">10.1 æ¦‚è¿°</h3><p>å¹³æ—¶æˆ‘ä»¬åœ¨æ§åˆ¶å°æ‰“å°è¾“å‡ºï¼Œæ˜¯è°ƒç”¨<code>print</code>æ–¹æ³•å’Œ<code>println</code>æ–¹æ³•å®Œæˆçš„ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ¥è‡ªäº<code>java.io.PrintStream</code>ç±»ï¼Œè¯¥ç±»èƒ½å¤Ÿæ–¹ä¾¿åœ°æ‰“å°å„ç§æ•°æ®ç±»å‹çš„å€¼ï¼Œæ˜¯ä¸€ç§ä¾¿æ·çš„è¾“å‡ºæ–¹å¼ã€‚</p><p>æ‰“å°æµåªæœ‰è¾“å‡ºæµï¼Œæ²¡æœ‰è¾“å…¥æµã€‚</p><p>æ‰“å°æµåˆ†ä¸ºä¸¤ç§PrintStreamå­—èŠ‚æ‰“å°æµï¼ŒPrintWriterå­—ç¬¦æ‰“å°æµã€‚</p><hr><h3 id="10-2-PrintStreamç±»">10.2 PrintStreamç±»</h3><h4 id="æ„é€ æ–¹æ³•-11">æ„é€ æ–¹æ³•</h4><p><code>public PrintStream(String fileName)  </code>ï¼š ä½¿ç”¨æŒ‡å®šçš„æ–‡ä»¶ååˆ›å»ºä¸€ä¸ªæ–°çš„æ‰“å°æµã€‚</p><p>æ„é€ ä¸¾ä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">PrintStream</span> <span class="variable">ps</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintStream</span>(<span class="string">&quot;ps.txt&quot;</span>)ï¼›</span><br></pre></td></tr></table></figure><hr><h4 id="æˆå‘˜æ–¹æ³•">æˆå‘˜æ–¹æ³•</h4><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>public void write(int b)</code></td><td>å¸¸è§„æ–¹æ³•ï¼šè§„åˆ™å’Œä¹‹å‰ä¸€æ ·ï¼Œå°†æŒ‡å®šçš„å­—èŠ‚å†™å‡º</td></tr><tr><td><code>public void println(Xxx xx)</code></td><td>ç‰¹æœ‰æ–¹æ³•ï¼šæ‰“å°ä»»æ„æ•°æ®ï¼Œè‡ªåŠ¨åˆ·æ–°ï¼Œè‡ªåŠ¨æ¢è¡Œ</td></tr><tr><td><code>public void print(Xxx xx)</code></td><td>ç‰¹æœ‰æ–¹æ³•ï¼šæ‰“å°ä»»æ„æ•°æ®ï¼Œä¸æ¢è¡Œ</td></tr><tr><td><code>public void printf(String format,Object... args)</code></td><td>ç‰¹æœ‰æ–¹æ³•ï¼šå¸¦æœ‰å ä½ç¬¦çš„æ‰“å°è¯­å¥ï¼Œä¸æ¢è¡Œ</td></tr></tbody></table><hr><h4 id="æ”¹å˜æ‰“å°æµå‘">æ”¹å˜æ‰“å°æµå‘</h4><p><code>System.out</code>å°±æ˜¯<code>PrintStream</code>ç±»å‹çš„ï¼Œåªä¸è¿‡å®ƒçš„æµå‘æ˜¯ç³»ç»Ÿè§„å®šçš„ï¼Œæ‰“å°åœ¨æ§åˆ¶å°ä¸Šã€‚ä¸è¿‡ï¼Œæ—¢ç„¶æ˜¯æµå¯¹è±¡ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç©ä¸€ä¸ª&quot;å°æŠŠæˆ&quot;ï¼Œæ”¹å˜å®ƒçš„æµå‘ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//è·å–æ‰“å°æµçš„å¯¹è±¡ï¼Œæ­¤æ‰“å°æµåœ¨è™šæ‹Ÿæœºå¯åŠ¨çš„æ—¶å€™ï¼Œç”±è™šæ‹Ÿæœºåˆ›å»ºï¼Œé»˜è®¤æŒ‡å‘æ§åˆ¶å°</span></span><br><span class="line">    <span class="comment">//ç‰¹æ®Šçš„æ‰“å°æµï¼Œç³»ç»Ÿä¸­çš„æ ‡å‡†è¾“å‡ºæµ</span></span><br><span class="line">    <span class="type">PrintStream</span> <span class="variable">ps</span> <span class="operator">=</span> System.out;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è°ƒç”¨æ‰“å°æµä¸­çš„æ–¹æ³•println</span></span><br><span class="line">    <span class="comment">// å†™å‡ºæ•°æ®ï¼Œè‡ªåŠ¨æ¢è¡Œï¼Œè‡ªåŠ¨åˆ·æ–°</span></span><br><span class="line">    ps.println(<span class="string">&quot;123&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ‰“å°æµ,æŒ‡å®šæ–‡ä»¶çš„åç§°</span></span><br><span class="line">    <span class="type">PrintStream</span> <span class="variable">ps1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintStream</span>(<span class="string">&quot;ps.txt&quot;</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½®ç³»ç»Ÿçš„æ‰“å°æµæµå‘,è¾“å‡ºåˆ°ps.txt</span></span><br><span class="line">    System.setOut(ps1);</span><br><span class="line">    <span class="comment">// è°ƒç”¨ç³»ç»Ÿçš„æ‰“å°æµ,ps.txtä¸­è¾“å‡º97</span></span><br><span class="line">    System.out.println(<span class="number">97</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h3 id="10-3-PrintWriterç±»">10.3 PrintWriterç±»</h3><h4 id="æ„é€ æ–¹æ³•-12">æ„é€ æ–¹æ³•</h4><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605151225339.png" alt="image-20230605151225339" style="zoom:67%;" /><hr><h4 id="æˆå‘˜æ–¹æ³•-2">æˆå‘˜æ–¹æ³•</h4><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605151421711.png" alt="image-20230605151421711" style="zoom:67%;" /><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//1.åˆ›å»ºå­—ç¬¦æ‰“å°æµå¯¹è±¡</span></span><br><span class="line">    <span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(<span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;myio\\a.txt&quot;</span>), <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//2.å†™å‡ºæ•°æ®</span></span><br><span class="line">    pw.println(<span class="string">&quot;ä»Šå¤©ä½ ç»ˆäºæ¥äº†&quot;</span>);</span><br><span class="line">    pw.print(<span class="string">&quot;ä½ å¥½&quot;</span>);</span><br><span class="line">    pw.printf(<span class="string">&quot;%sçˆ±ä¸Šäº†%s&quot;</span>,<span class="string">&quot;é˜¿ç&quot;</span>,<span class="string">&quot;é˜¿å¼º&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="10-4-æ€»ç»“">10.4 æ€»ç»“</h3><ol><li>æ‰“å°æµæœ‰å‡ ç§ï¼Ÿå„æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ</li></ol><p>æœ‰å­—èŠ‚æ‰“å°æµå’Œå­—ç¬¦æ‰“å°æµä¸¤ç§</p><p>æ‰“å°æµä¸æ“ä½œæ•°æ®æºï¼Œåªèƒ½æ“ä½œç›®çš„åœ°</p><p>å­—èŠ‚æ‰“å°æµï¼šé»˜è®¤è‡ªåŠ¨åˆ·æ–°ï¼Œç‰¹æœ‰çš„printlnè‡ªåŠ¨æ¢è¡Œ</p><p>å­—ç¬¦æ‰“å°æµï¼šè‡ªåŠ¨åˆ·æ–°éœ€è¦å¼€å¯ï¼Œç‰¹æœ‰çš„printlnè‡ªåŠ¨æ¢è¡Œ</p><hr><hr><h2 id="11-å‹ç¼©æµå’Œè§£å‹ç¼©æµ">11. å‹ç¼©æµå’Œè§£å‹ç¼©æµ</h2><p>å‹ç¼©æµï¼š</p><p>â€‹è´Ÿè´£å‹ç¼©æ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹</p><p>è§£å‹ç¼©æµï¼š</p><p>â€‹è´Ÿè´£æŠŠå‹ç¼©åŒ…ä¸­çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹è§£å‹å‡ºæ¥</p><div class="tabs" id="68286546-a105-4ead-9347-4855a17501be"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#68286546-a105-4ead-9347-4855a17501be-1"><i class="fas fa-cat"></i>å‹ç¼©æµ1</button></li><li class="tab"><button type="button" data-href="#68286546-a105-4ead-9347-4855a17501be-2"><i class="fas fa-horse"></i>å‹ç¼©æµ2</button></li><li class="tab"><button type="button" data-href="#68286546-a105-4ead-9347-4855a17501be-3"><i class="fas fa-dove"></i>è§£å‹ç¼©æµ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="68286546-a105-4ead-9347-4855a17501be-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZipStreamDemo2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         *   å‹ç¼©æµ</span></span><br><span class="line"><span class="comment">         *      éœ€æ±‚ï¼š</span></span><br><span class="line"><span class="comment">         *          æŠŠD:\\a.txtæ‰“åŒ…æˆä¸€ä¸ªå‹ç¼©åŒ…</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">//1.åˆ›å»ºFileå¯¹è±¡è¡¨ç¤ºè¦å‹ç¼©çš„æ–‡ä»¶</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">src</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\a.txt&quot;</span>);</span><br><span class="line">        <span class="comment">//2.åˆ›å»ºFileå¯¹è±¡è¡¨ç¤ºå‹ç¼©åŒ…çš„ä½ç½®</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">dest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\&quot;</span>);</span><br><span class="line">        <span class="comment">//3.è°ƒç”¨æ–¹æ³•ç”¨æ¥å‹ç¼©</span></span><br><span class="line">        toZip(src,dest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    *   ä½œç”¨ï¼šå‹ç¼©</span></span><br><span class="line"><span class="comment">    *   å‚æ•°ä¸€ï¼šè¡¨ç¤ºè¦å‹ç¼©çš„æ–‡ä»¶</span></span><br><span class="line"><span class="comment">    *   å‚æ•°äºŒï¼šè¡¨ç¤ºå‹ç¼©åŒ…çš„ä½ç½®</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">toZip</span><span class="params">(File src,File dest)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//1.åˆ›å»ºå‹ç¼©æµå…³è”å‹ç¼©åŒ…</span></span><br><span class="line">        <span class="type">ZipOutputStream</span> <span class="variable">zos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(dest,<span class="string">&quot;a.zip&quot;</span>)));</span><br><span class="line">        <span class="comment">//2.åˆ›å»ºZipEntryå¯¹è±¡ï¼Œè¡¨ç¤ºå‹ç¼©åŒ…é‡Œé¢çš„æ¯ä¸€ä¸ªæ–‡ä»¶å’Œæ–‡ä»¶å¤¹</span></span><br><span class="line">        <span class="comment">//å‚æ•°ï¼šå‹ç¼©åŒ…é‡Œé¢çš„è·¯å¾„</span></span><br><span class="line">        <span class="type">ZipEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipEntry</span>(<span class="string">&quot;aaa\\bbb\\a.txt&quot;</span>);</span><br><span class="line">        <span class="comment">//3.æŠŠZipEntryå¯¹è±¡æ”¾åˆ°å‹ç¼©åŒ…å½“ä¸­</span></span><br><span class="line">        zos.putNextEntry(entry);</span><br><span class="line">        <span class="comment">//4.æŠŠsrcæ–‡ä»¶ä¸­çš„æ•°æ®å†™åˆ°å‹ç¼©åŒ…å½“ä¸­</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(src);</span><br><span class="line">        <span class="type">int</span> b;</span><br><span class="line">        <span class="keyword">while</span>((b = fis.read()) != -<span class="number">1</span>)&#123;</span><br><span class="line">            zos.write(b);</span><br><span class="line">        &#125;</span><br><span class="line">        zos.closeEntry();</span><br><span class="line">        zos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="68286546-a105-4ead-9347-4855a17501be-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZipStreamDemo3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         *   å‹ç¼©æµ</span></span><br><span class="line"><span class="comment">         *      éœ€æ±‚ï¼š</span></span><br><span class="line"><span class="comment">         *          æŠŠD:\\aaaæ–‡ä»¶å¤¹å‹ç¼©æˆä¸€ä¸ªå‹ç¼©åŒ…</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">//1.åˆ›å»ºFileå¯¹è±¡è¡¨ç¤ºè¦å‹ç¼©çš„æ–‡ä»¶å¤¹</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">src</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\aaa&quot;</span>);</span><br><span class="line">        <span class="comment">//2.åˆ›å»ºFileå¯¹è±¡è¡¨ç¤ºå‹ç¼©åŒ…æ”¾åœ¨å“ªé‡Œï¼ˆå‹ç¼©åŒ…çš„çˆ¶çº§è·¯å¾„ï¼‰</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">destParent</span> <span class="operator">=</span> src.getParentFile();<span class="comment">//D:\\</span></span><br><span class="line">        <span class="comment">//3.åˆ›å»ºFileå¯¹è±¡è¡¨ç¤ºå‹ç¼©åŒ…çš„è·¯å¾„</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">dest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(destParent,src.getName() + <span class="string">&quot;.zip&quot;</span>);</span><br><span class="line">        <span class="comment">//4.åˆ›å»ºå‹ç¼©æµå…³è”å‹ç¼©åŒ…</span></span><br><span class="line">        <span class="type">ZipOutputStream</span> <span class="variable">zos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(dest));</span><br><span class="line">        <span class="comment">//5.è·å–srcé‡Œé¢çš„æ¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå˜æˆZipEntryå¯¹è±¡ï¼Œæ”¾å…¥åˆ°å‹ç¼©åŒ…å½“ä¸­</span></span><br><span class="line">        toZip(src,zos,src.getName());<span class="comment">//aaa</span></span><br><span class="line">        <span class="comment">//6.é‡Šæ”¾èµ„æº</span></span><br><span class="line">        zos.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    *   ä½œç”¨ï¼šè·å–srcé‡Œé¢çš„æ¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå˜æˆZipEntryå¯¹è±¡ï¼Œæ”¾å…¥åˆ°å‹ç¼©åŒ…å½“ä¸­</span></span><br><span class="line"><span class="comment">    *   å‚æ•°ä¸€ï¼šæ•°æ®æº</span></span><br><span class="line"><span class="comment">    *   å‚æ•°äºŒï¼šå‹ç¼©æµ</span></span><br><span class="line"><span class="comment">    *   å‚æ•°ä¸‰ï¼šå‹ç¼©åŒ…å†…éƒ¨çš„è·¯å¾„</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">toZip</span><span class="params">(File src,ZipOutputStream zos,String name)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//1.è¿›å…¥srcæ–‡ä»¶å¤¹</span></span><br><span class="line">        File[] files = src.listFiles();</span><br><span class="line">        <span class="comment">//2.éå†æ•°ç»„</span></span><br><span class="line">        <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">            <span class="keyword">if</span>(file.isFile())&#123;</span><br><span class="line">                <span class="comment">//3.åˆ¤æ–­-æ–‡ä»¶ï¼Œå˜æˆZipEntryå¯¹è±¡ï¼Œæ”¾å…¥åˆ°å‹ç¼©åŒ…å½“ä¸­</span></span><br><span class="line">                <span class="type">ZipEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipEntry</span>(name + <span class="string">&quot;\\&quot;</span> + file.getName());<span class="comment">//aaa\\no1\\a.txt</span></span><br><span class="line">                zos.putNextEntry(entry);</span><br><span class="line">                <span class="comment">//è¯»å–æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œå†™åˆ°å‹ç¼©åŒ…</span></span><br><span class="line">                <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">                <span class="type">int</span> b;</span><br><span class="line">                <span class="keyword">while</span>((b = fis.read()) != -<span class="number">1</span>)&#123;</span><br><span class="line">                    zos.write(b);</span><br><span class="line">                &#125;</span><br><span class="line">                fis.close();</span><br><span class="line">                zos.closeEntry();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//4.åˆ¤æ–­-æ–‡ä»¶å¤¹ï¼Œé€’å½’</span></span><br><span class="line">                toZip(file,zos,name + <span class="string">&quot;\\&quot;</span> + file.getName());</span><br><span class="line">                <span class="comment">//     no1            aaa   \\   no1</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="68286546-a105-4ead-9347-4855a17501be-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZipStreamDemo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1.åˆ›å»ºä¸€ä¸ªFileè¡¨ç¤ºè¦è§£å‹çš„å‹ç¼©åŒ…</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">src</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\aaa.zip&quot;</span>);</span><br><span class="line">        <span class="comment">//2.åˆ›å»ºä¸€ä¸ªFileè¡¨ç¤ºè§£å‹çš„ç›®çš„åœ°</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">dest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è°ƒç”¨æ–¹æ³•</span></span><br><span class="line">        unzip(src,dest);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®šä¹‰ä¸€ä¸ªæ–¹æ³•ç”¨æ¥è§£å‹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unzip</span><span class="params">(File src,File dest)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//è§£å‹çš„æœ¬è´¨ï¼šæŠŠå‹ç¼©åŒ…é‡Œé¢çš„æ¯ä¸€ä¸ªæ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹è¯»å–å‡ºæ¥ï¼ŒæŒ‰ç…§å±‚çº§æ‹·è´åˆ°ç›®çš„åœ°å½“ä¸­</span></span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªè§£å‹ç¼©æµç”¨æ¥è¯»å–å‹ç¼©åŒ…ä¸­çš„æ•°æ®</span></span><br><span class="line">        <span class="type">ZipInputStream</span> <span class="variable">zip</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(src));</span><br><span class="line">        <span class="comment">//è¦å…ˆè·å–åˆ°å‹ç¼©åŒ…é‡Œé¢çš„æ¯ä¸€ä¸ªzipentryå¯¹è±¡</span></span><br><span class="line">        <span class="comment">//è¡¨ç¤ºå½“å‰åœ¨å‹ç¼©åŒ…ä¸­è·å–åˆ°çš„æ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹</span></span><br><span class="line">        ZipEntry entry;</span><br><span class="line">        <span class="keyword">while</span>((entry = zip.getNextEntry()) != <span class="literal">null</span>)&#123;</span><br><span class="line">            System.out.println(entry);</span><br><span class="line">            <span class="keyword">if</span>(entry.isDirectory())&#123;</span><br><span class="line">                <span class="comment">//æ–‡ä»¶å¤¹ï¼šéœ€è¦åœ¨ç›®çš„åœ°destå¤„åˆ›å»ºä¸€ä¸ªåŒæ ·çš„æ–‡ä»¶å¤¹</span></span><br><span class="line">                <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(dest,entry.toString());</span><br><span class="line">                file.mkdirs();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//æ–‡ä»¶ï¼šéœ€è¦è¯»å–åˆ°å‹ç¼©åŒ…ä¸­çš„æ–‡ä»¶ï¼Œå¹¶æŠŠä»–å­˜æ”¾åˆ°ç›®çš„åœ°destæ–‡ä»¶å¤¹ä¸­ï¼ˆæŒ‰ç…§å±‚çº§ç›®å½•è¿›è¡Œå­˜æ”¾ï¼‰</span></span><br><span class="line">                <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(dest,entry.toString()));</span><br><span class="line">                <span class="type">int</span> b;</span><br><span class="line">                <span class="keyword">while</span>((b = zip.read()) != -<span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="comment">//å†™åˆ°ç›®çš„åœ°</span></span><br><span class="line">                    fos.write(b);</span><br><span class="line">                &#125;</span><br><span class="line">                fos.close();</span><br><span class="line">                <span class="comment">//è¡¨ç¤ºåœ¨å‹ç¼©åŒ…ä¸­çš„ä¸€ä¸ªæ–‡ä»¶å¤„ç†å®Œæ¯•äº†ã€‚</span></span><br><span class="line">                zip.closeEntry();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        zip.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="12-å·¥å…·åŒ…">12. å·¥å…·åŒ…</h2><h3 id="Commons-io">Commons-io</h3><p>ä»‹ç»ï¼š</p><p>â€‹Commonsæ˜¯apacheå¼€æºåŸºé‡‘ç»„ç»‡æä¾›çš„å·¥å…·åŒ…ï¼Œé‡Œé¢æœ‰å¾ˆå¤šå¸®åŠ©æˆ‘ä»¬æé«˜å¼€å‘æ•ˆç‡çš„API</p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605152735412.png" alt="image-20230605152735412" style="zoom:67%;" /><blockquote><p>å¸¸è§æ–¹æ³•</p></blockquote><div class="tabs" id="99950581-ffc1-4236-b396-1a2789bddfe2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#99950581-ffc1-4236-b396-1a2789bddfe2-1"><i class="fas fa-seedling"></i>FileUtils</button></li><li class="tab"><button type="button" data-href="#99950581-ffc1-4236-b396-1a2789bddfe2-2"><i class="fas fa-leaf"></i>IOUtils</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="99950581-ffc1-4236-b396-1a2789bddfe2-1"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605152935221.png" alt="image-20230605152935221"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="99950581-ffc1-4236-b396-1a2789bddfe2-2"><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605153001115.png" alt="image-20230605153001115"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsIODemo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">          FileUtilsç±»</span></span><br><span class="line"><span class="comment">                static void copyFile(File srcFile, File destFile)                   å¤åˆ¶æ–‡ä»¶</span></span><br><span class="line"><span class="comment">                static void copyDirectory(File srcDir, File destDir)                å¤åˆ¶æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="comment">                static void copyDirectoryToDirectory(File srcDir, File destDir)     å¤åˆ¶æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="comment">                static void deleteDirectory(File directory)                         åˆ é™¤æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="comment">                static void cleanDirectory(File directory)                          æ¸…ç©ºæ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="comment">                static String readFileToString(File file, Charset encoding)         è¯»å–æ–‡ä»¶ä¸­çš„æ•°æ®å˜æˆæˆå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment">                static void write(File file, CharSequence data, String encoding)    å†™å‡ºæ•°æ®</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            IOUtilsç±»</span></span><br><span class="line"><span class="comment">                public static int copy(InputStream input, OutputStream output)      å¤åˆ¶æ–‡ä»¶</span></span><br><span class="line"><span class="comment">                public static int copyLarge(Reader input, Writer output)            å¤åˆ¶å¤§æ–‡ä»¶</span></span><br><span class="line"><span class="comment">                public static String readLines(Reader input)                        è¯»å–æ•°æ®</span></span><br><span class="line"><span class="comment">                public static void write(String data, OutputStream output)          å†™å‡ºæ•°æ®</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* File src = new File(&quot;myio\\a.txt&quot;);</span></span><br><span class="line"><span class="comment">        File dest = new File(&quot;myio\\copy.txt&quot;);</span></span><br><span class="line"><span class="comment">        FileUtils.copyFile(src,dest);*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*File src = new File(&quot;D:\\aaa&quot;);</span></span><br><span class="line"><span class="comment">        File dest = new File(&quot;D:\\bbb&quot;);</span></span><br><span class="line"><span class="comment">        FileUtils.copyDirectoryToDirectory(src,dest);*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*File src = new File(&quot;D:\\bbb&quot;);</span></span><br><span class="line"><span class="comment">        FileUtils.cleanDirectory(src);*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="hutool">hutool</h3><p>ä»‹ç»ï¼š</p><p>â€‹Commonsæ˜¯å›½äººå¼€å‘çš„å¼€æºå·¥å…·åŒ…ï¼Œé‡Œé¢æœ‰å¾ˆå¤šå¸®åŠ©æˆ‘ä»¬æé«˜å¼€å‘æ•ˆç‡çš„API</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230605153252059.png" alt="image-20230605153252059"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        FileUtilç±»:</span></span><br><span class="line"><span class="comment">                fileï¼šæ ¹æ®å‚æ•°åˆ›å»ºä¸€ä¸ªfileå¯¹è±¡</span></span><br><span class="line"><span class="comment">                touchï¼šæ ¹æ®å‚æ•°åˆ›å»ºæ–‡ä»¶</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                writeLinesï¼šæŠŠé›†åˆä¸­çš„æ•°æ®å†™å‡ºåˆ°æ–‡ä»¶ä¸­ï¼Œè¦†ç›–æ¨¡å¼ã€‚</span></span><br><span class="line"><span class="comment">                appendLinesï¼šæŠŠé›†åˆä¸­çš„æ•°æ®å†™å‡ºåˆ°æ–‡ä»¶ä¸­ï¼Œç»­å†™æ¨¡å¼ã€‚</span></span><br><span class="line"><span class="comment">                readLinesï¼šæŒ‡å®šå­—ç¬¦ç¼–ç ï¼ŒæŠŠæ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œè¯»åˆ°é›†åˆä¸­ã€‚</span></span><br><span class="line"><span class="comment">                readUtf8Linesï¼šæŒ‰ç…§UTF-8çš„å½¢å¼ï¼ŒæŠŠæ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œè¯»åˆ°é›†åˆä¸­</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                copyï¼šæ‹·è´æ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="comment">/* File file1 = FileUtil.file(&quot;D:\\&quot;, &quot;aaa&quot;, &quot;bbb&quot;, &quot;a.txt&quot;);</span></span><br><span class="line"><span class="comment">        System.out.println(file1);//D:\aaa\bbb\a.txt</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        File touch = FileUtil.touch(file1);</span></span><br><span class="line"><span class="comment">        System.out.println(touch);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        ArrayList&lt;String&gt; list = new ArrayList&lt;&gt;();</span></span><br><span class="line"><span class="comment">        list.add(&quot;aaa&quot;);</span></span><br><span class="line"><span class="comment">        list.add(&quot;aaa&quot;);</span></span><br><span class="line"><span class="comment">        list.add(&quot;aaa&quot;);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        File file2 = FileUtil.writeLines(list, &quot;D:\\a.txt&quot;, &quot;UTF-8&quot;);</span></span><br><span class="line"><span class="comment">        System.out.println(file2);*/</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/*  ArrayList&lt;String&gt; list = new ArrayList&lt;&gt;();</span></span><br><span class="line"><span class="comment">        list.add(&quot;aaa&quot;);</span></span><br><span class="line"><span class="comment">        list.add(&quot;aaa&quot;);</span></span><br><span class="line"><span class="comment">        list.add(&quot;aaa&quot;);</span></span><br><span class="line"><span class="comment">        File file3 = FileUtil.appendLines(list, &quot;D:\\a.txt&quot;, &quot;UTF-8&quot;);</span></span><br><span class="line"><span class="comment">        System.out.println(file3);*/</span></span><br><span class="line">        List&lt;String&gt; list = FileUtil.readLines(<span class="string">&quot;D:\\a.txt&quot;</span>, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">å­—èŠ‚æµã€å­—ç¬¦æµã€å…¶ä»–æµã€å·¥å…·åŒ…</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/tags/Java/"/>
    
  </entry>
  
</feed>
