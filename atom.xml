<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>LuckyBoyğŸ¥</title>
  
  
  <link href="https://wuwawawa.github.io/atom.xml" rel="self"/>
  
  <link href="https://wuwawawa.github.io/"/>
  <updated>2024-04-05T09:15:14.526Z</updated>
  <id>https://wuwawawa.github.io/</id>
  
  <author>
    <name>LuckyBoyğŸ¥</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Sentinelè§£æ</title>
    <link href="https://wuwawawa.github.io/posts/aeb76929.html"/>
    <id>https://wuwawawa.github.io/posts/aeb76929.html</id>
    <published>2024-04-05T01:37:43.000Z</published>
    <updated>2024-04-05T09:15:14.526Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/sentinel-group/sentinel-awesome?tab=readme-ov-file">https://github.com/sentinel-group/sentinel-awesome?tab=readme-ov-file</a></p><p><a href="https://sentinelguard.io/zh-cn/docs/basic-implementation.html">Sentinel å·¥ä½œä¸»æµç¨‹</a></p><p>è´£ä»»é“¾æ¨¡å¼ SPIæœºåˆ¶ AOP  CopyOnWriteå†™å…¥æ—¶å¤åˆ¶  æ–­è·¯å™¨çŠ¶æ€è½¬æ¢  closed  open half-open</p><h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><p>Sentinelå®ç°é™æµã€éš”ç¦»ã€é™çº§ã€ç†”æ–­ç­‰åŠŸèƒ½ï¼Œæœ¬è´¨è¦åšçš„å°±æ˜¯ä¸¤ä»¶äº‹æƒ…ï¼š</p><ul><li>ç»Ÿè®¡æ•°æ®ï¼šç»Ÿè®¡æŸä¸ªèµ„æºçš„è®¿é—®æ•°æ®ï¼ˆQPSã€RTç­‰ä¿¡æ¯ï¼‰</li><li>è§„åˆ™åˆ¤æ–­ï¼šåˆ¤æ–­é™æµè§„åˆ™ã€éš”ç¦»è§„åˆ™ã€é™çº§è§„åˆ™ã€ç†”æ–­è§„åˆ™æ˜¯å¦æ»¡è¶³</li></ul><p>è¿™é‡Œçš„<strong>èµ„æº</strong>å°±æ˜¯å¸Œæœ›è¢«Sentinelä¿æŠ¤çš„ä¸šåŠ¡ï¼Œä¾‹å¦‚é¡¹ç›®ä¸­å®šä¹‰çš„controlleræ–¹æ³•å°±æ˜¯é»˜è®¤è¢«Sentinelä¿æŠ¤çš„èµ„æºã€‚</p><hr><blockquote><p>Sentinelçš„çº¿ç¨‹éš”ç¦»ä¸Hystixçš„çº¿ç¨‹éš”ç¦»æœ‰ä»€ä¹ˆå·®åˆ«ï¼Ÿ</p></blockquote><p>Hystixé»˜è®¤æ˜¯åŸºäºçº¿ç¨‹æ± å®ç°çš„çº¿ç¨‹éš”ç¦»ï¼Œæ¯ä¸€ä¸ªè¢«éš”ç¦»çš„ä¸šåŠ¡éƒ½è¦åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æ± ï¼Œçº¿ç¨‹è¿‡å¤šä¼šå¸¦æ¥é¢å¤–çš„ CPUå¼€é”€ï¼Œæ€§èƒ½ä¸€èˆ¬ï¼Œä½†æ˜¯éš”ç¦»æ€§æ›´å¼ºã€‚</p><p>Sentinelæ˜¯åŸºäºä¿¡å·é‡ï¼ˆè®¡æ•°å™¨ï¼‰å®ç°çš„çº¿ç¨‹éš”ç¦»ï¼Œä¸ç”¨åˆ›å»ºçº¿ç¨‹æ± ï¼Œæ€§èƒ½è¾ƒå¥½ï¼Œä½†æ˜¯éš”ç¦»æ€§ä¸€èˆ¬ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240405102207474.png" alt="image-20240405102207474" style="zoom:50%;" /></p><hr><h2 id="é™æµç®—æ³•"><a href="#é™æµç®—æ³•" class="headerlink" title="é™æµç®—æ³•"></a>é™æµç®—æ³•</h2><h3 id="è®¡æ•°å™¨ç®—æ³•"><a href="#è®¡æ•°å™¨ç®—æ³•" class="headerlink" title="è®¡æ•°å™¨ç®—æ³•"></a>è®¡æ•°å™¨ç®—æ³•</h3><mark class="hl-label blue">å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•</mark> <ul><li><p>å°†æ—¶é—´åˆ’åˆ†ä¸ºå¤šä¸ªçª—å£ï¼Œçª—å£æ—¶é—´è·¨åº¦ç§°ä¸ºIntervalï¼Œæœ¬ä¾‹ä¸­ä¸º1000msï¼›</p></li><li><p>æ¯ä¸ªçª—å£ç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæ¯æœ‰ä¸€æ¬¡è¯·æ±‚å°±å°†è®¡æ•°å™¨åŠ ä¸€ï¼Œé™æµå°±æ˜¯è®¾ç½®è®¡æ•°å™¨é˜ˆå€¼ï¼Œæœ¬ä¾‹ä¸º3 </p></li><li>å¦‚æœè®¡æ•°å™¨è¶…è¿‡äº†é™æµé˜ˆå€¼ï¼Œåˆ™è¶…å‡ºé˜ˆå€¼çš„è¯·æ±‚éƒ½è¢«ä¸¢å¥”ã€‚</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240405103520533.png" alt="image-20240405103520533"></p><hr><mark class="hl-label green">æ»‘åŠ¨çª—å£è®¡æ•°å™¨ç®—æ³•</mark> <p>æ»‘åŠ¨çª—å£è®¡æ•°å™¨ç®—æ³•ä¼šå°†ä¸€ä¸ªçª—å£åˆ’åˆ†ä¸ºnä¸ªæ›´å°çš„åŒºé—´ï¼Œä¾‹å¦‚ï¼š</p><ul><li>çª—å£æ—¶é—´è·¨åº¦Intervalä¸º1ç§’ï¼›åŒºé—´æ•°é‡n=2ï¼Œåˆ™æ¯ä¸ªå°åŒºé—´æ—¶é—´è·¨åº¦ä¸º500ms</li><li>é™æµé˜ˆå€¼ä¾ç„¶ä¸º3ï¼Œæ—¶é—´çª—å£ï¼ˆ1ç§’ï¼‰å†…è¯·æ±‚è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œè¶…å‡ºçš„è¯·æ±‚è¢«é™æµ</li><li>çª—å£ä¼šæ ¹æ®å½“å‰è¯·æ±‚æ‰€åœ¨æ—¶é—´ï¼ˆcurrentTimeï¼‰ç§»åŠ¨ï¼Œçª—å£èŒƒå›´æ˜¯ä»ï¼ˆcurrentTime-Intervalï¼‰ä¹‹åçš„ç¬¬ä¸€ä¸ªæ—¶åŒºå¼€å§‹ï¼Œåˆ°currentTimeæ‰€åœ¨æ—¶åŒºç»“æŸã€‚</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240405104356930.png" alt="image-20240405104356930"></p><p> ç”±äºå°åŒºé—´è·¨åº¦å¤ªå¤§ è¿˜æ˜¯å¯èƒ½ä¼šå‡ºç°è¶…å‡ºé™æµé˜ˆå€¼çš„é—®é¢˜ å›¾ä¸­1250 - 2100ms  850msæ”¾è¡Œäº†4ä¸ªè¯·æ±‚</p><hr><h3 id="ä»¤ç‰Œæ¡¶ç®—æ³•"><a href="#ä»¤ç‰Œæ¡¶ç®—æ³•" class="headerlink" title="ä»¤ç‰Œæ¡¶ç®—æ³•"></a>ä»¤ç‰Œæ¡¶ç®—æ³•</h3><ul><li>ä»¥å›ºå®šçš„é€Ÿç‡ç”Ÿæˆä»¤ç‰Œï¼Œå­˜å…¥ä»¤ç‰Œæ¡¶ä¸­ï¼Œå¦‚æœä»¤ç‰Œæ¡¶æ»¡äº†ä»¥åï¼Œå¤šä½™ä»¤ç‰Œä¸¢å¼ƒ</li><li>è¯·æ±‚è¿›å…¥åï¼Œå¿…é¡»å…ˆå°è¯•ä»æ¡¶ä¸­è·å–ä»¤ç‰Œï¼Œè·å–åˆ°ä»¤ç‰Œåæ‰å¯ä»¥è¢«å¤„ç†</li><li>å¦‚æœä»¤ç‰Œæ¡¶ä¸­æ²¡æœ‰ä»¤ç‰Œï¼Œåˆ™è¯·æ±‚ç­‰å¾…æˆ–ä¸¢å¼ƒ</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240405104932170.png" alt="image-20240405104932170" style="zoom: 67%;" /></p><p>å¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼š</p><p>â€‹    ç¬¬1sä¸­ç”Ÿäº§äº†5ä¸ªä»¤ç‰Œä½†æ²¡äººæ¶ˆè´¹ï¼Œç¬¬äºŒç§’é’Ÿæ¥äº†10ä¸ªè¯·æ±‚ æ¶ˆè€—5ä¸ª å†ç”Ÿæˆ5ä¸ª æ€»å…±æ”¾è¡Œäº†10ä¸ªè¯·æ±‚</p><p>â€‹    å…è®¸æµé‡ä¸€å®šç¨‹åº¦çš„çªå‘</p><p>ä»£ç å®ç°æ€æƒ³:</p><p>â€‹    è®°å½•ä¸Šä¸€æ¬¡è¯·æ±‚æ¥çš„æ—¶é—´ä»¥åŠå–äº†å‡ ä¸ªä»¤ç‰Œäº†</p><p>â€‹    å¯ä»¥è®¡ç®—å‡ºä¸Šä¸€æ¬¡åˆ°ç°åœ¨èƒ½ç”Ÿæˆå¤šå°‘ä»¤ç‰Œ</p><hr><h3 id="æ¼æ¡¶ç®—æ³•"><a href="#æ¼æ¡¶ç®—æ³•" class="headerlink" title="æ¼æ¡¶ç®—æ³•"></a>æ¼æ¡¶ç®—æ³•</h3><ul><li>å°†æ¯ä¸ªè¯·æ±‚è§†ä½œâ€æ°´æ»´â€æ”¾å…¥â€æ¼æ¡¶â€è¿›è¡Œå­˜å‚¨ï¼›</li><li><p>â€œæ¼æ¡¶â€ä»¥å›ºå®šé€Ÿç‡å‘å¤–â€æ¼â€å‡ºè¯·æ±‚æ¥æ‰§è¡Œï¼Œå¦‚æœâ€æ¼æ¡¶â€ç©ºäº†åˆ™åœæ­¢â€æ¼æ°´â€</p></li><li><p>å¦‚æœâ€æ¼æ¡¶â€æ»¡äº†åˆ™å¤šä½™çš„â€æ°´æ»´â€ä¼šè¢«ç›´æ¥ä¸¢å¼ƒã€‚</p></li></ul><p>ä»£ç å®ç°æ€æƒ³ï¼š</p><p>Sentinelåœ¨å®ç°æ¼æ¡¶æ—¶ï¼Œé‡‡ç”¨äº†æ’é˜Ÿç­‰å¾…æ¨¡å¼ï¼š</p><p>è®©æ‰€æœ‰è¯·æ±‚è¿›å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åæŒ‰ç…§é˜ˆå€¼å…è®¸çš„æ—¶é—´é—´éš”ä¾æ¬¡æ‰§è¡Œã€‚å¹¶å‘çš„å¤šä¸ªè¯·æ±‚å¿…é¡»ç­‰å¾…ï¼Œé¢„æœŸçš„ç­‰å¾…æ—¶é•¿=æœ€è¿‘ä¸€æ¬¡è¯·æ±‚çš„é¢„æœŸç­‰å¾…æ—¶é—´+å…è®¸çš„é—´éš”ã€‚å¦‚æœè¯·æ±‚é¢„æœŸçš„ç­‰å¾…æ—¶é—´è¶…å‡ºæœ€å¤§æ—¶é•¿ï¼Œåˆ™ä¼šè¢«æ‹’ç»ã€‚</p><p>ä¾‹å¦‚ï¼šQPS=5ï¼Œæ„å‘³ç€æ¯200mså¤„ç†ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„è¯·æ±‚ï¼›timeout=2000ï¼Œæ„å‘³ç€é¢„æœŸç­‰å¾…è¶…è¿‡2000msçš„è¯·æ±‚ä¼šè¢«æ‹’ç»å¹¶æŠ›å‡ºå¼‚å¸¸</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240405105925451.png" alt="image-20240405105925451"></p><hr><h3 id="å¯¹æ¯”"><a href="#å¯¹æ¯”" class="headerlink" title="å¯¹æ¯”"></a>å¯¹æ¯”</h3><div class="table-container"><table><thead><tr><th>å¯¹æ¯”é¡¹</th><th style="text-align:center">æ»‘åŠ¨æ—¶é—´çª—å£</th><th style="text-align:center">ä»¤ç‰Œæ¡¶</th><th style="text-align:center">æ¼æ¡¶</th></tr></thead><tbody><tr><td>èƒ½å¦ä¿è¯æµé‡æ›²çº¿å¹³æ»‘</td><td style="text-align:center">ä¸èƒ½ï¼Œä½†çª—å£å†…åŒºé—´è¶Šå°ï¼Œæµé‡æ§åˆ¶è¶Šå¹³æ»‘</td><td style="text-align:center">åŸºæœ¬èƒ½ï¼Œåœ¨è¯·æ±‚é‡æŒç»­é«˜äºä»¤ç‰Œç”Ÿæˆé€Ÿåº¦æ—¶ï¼Œæµé‡å¹³æ»‘<br/>ä½†è¯·æ±‚é‡åœ¨ä»¤ç‰Œç”Ÿæˆé€Ÿç‡ä¸Šä¸‹æ³¢åŠ¨æ—¶ï¼Œæ— æ³•ä¿è¯æ›²çº¿å¹³æ»‘</td><td style="text-align:center">èƒ½ï¼Œæ‰€æœ‰è¯·æ±‚è¿›å…¥æ¡¶å†…ï¼Œä»¥æ’å®šé€Ÿç‡æ”¾è¡Œï¼Œç»å¯¹å¹³æ»‘</td></tr><tr><td>èƒ½å¦åº”å¯¹çªå¢æµé‡</td><td style="text-align:center">ä¸èƒ½ï¼Œå¾’å¢æµé‡ï¼Œåªè¦é«˜å‡ºé™æµé˜ˆå€¼éƒ½ä¼šè¢«æ‹’ç»</td><td style="text-align:center">èƒ½ï¼Œæ¡¶å†…ç§¯ç´¯çš„ä»¤ç‰Œå¯ä»¥åº”å¯¹çªå¢æµé‡</td><td style="text-align:center">èƒ½ï¼Œè¯·æ±‚å¯ä»¥æš‚å­˜åœ¨æ¡¶å†…</td></tr><tr><td>æµé‡æ§åˆ¶ç²¾ç¡®åº¦</td><td style="text-align:center">ä½ï¼Œçª—å£åŒºé—´è¶Šå°ï¼Œç²¾åº¦è¶Šé«˜</td><td style="text-align:center">é«˜</td><td style="text-align:center">é«˜</td></tr></tbody></table></div><p>Sentinelå†…éƒ¨</p><p>é»˜è®¤é™æµæ¨¡å¼æ˜¯åŸºäºæ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•</p><p>æ’é˜Ÿç­‰å¾…çš„é™æµæ¨¡å¼åˆ™åŸºäºæ¼æ¡¶ç®—æ³•</p><p>çƒ­ç‚¹å‚æ•°é™æµåˆ™æ˜¯åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•</p><hr><h2 id="å…³é”®ç»„ä»¶"><a href="#å…³é”®ç»„ä»¶" class="headerlink" title="å…³é”®ç»„ä»¶"></a>å…³é”®ç»„ä»¶</h2><h3 id="ProcessorSlotChain"><a href="#ProcessorSlotChain" class="headerlink" title="ProcessorSlotChain"></a>ProcessorSlotChain</h3><p>Sentinel çš„æ ¸å¿ƒéª¨æ¶ï¼Œå°†ä¸åŒçš„ Slot æŒ‰ç…§é¡ºåºä¸²åœ¨ä¸€èµ·ï¼ˆè´£ä»»é“¾æ¨¡å¼ï¼‰ï¼Œä»è€Œå°†ä¸åŒçš„åŠŸèƒ½ï¼ˆé™æµã€é™çº§ã€ç³»ç»Ÿä¿æŠ¤ï¼‰ç»„åˆåœ¨ä¸€èµ·ã€‚<code>slot chain</code> å…¶å®å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šç»Ÿè®¡æ•°æ®æ„å»ºéƒ¨åˆ†ï¼ˆstatisticï¼‰å’Œåˆ¤æ–­éƒ¨åˆ†ï¼ˆrule checkingï¼‰ã€‚æ ¸å¿ƒç»“æ„ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/sentinel-slot-chain-architecture.png" alt="sentinel-slot-chain"></p><blockquote><p>ç»Ÿè®¡æ•°æ®æ„å»ºéƒ¨åˆ†ï¼ˆstatisticï¼‰</p></blockquote><ul><li>NodeSelectorSlotï¼šè´Ÿè´£æ„å»ºç°‡ç‚¹é“¾è·¯ä¸­çš„èŠ‚ç‚¹ï¼ˆDefaultNodeï¼‰ï¼Œå°†è¿™äº›èŠ‚ç‚¹å½¢æˆé“¾è·¯æ ‘</li><li>ClusterBuilderSlotï¼šè´Ÿè´£æ„å»ºæŸä¸ªèµ„æºçš„ClusterNodeï¼ŒClusterNodeå¯ä»¥ä¿å­˜èµ„æºçš„è¿è¡Œä¿¡æ¯ï¼ˆå“åº”æ—¶é—´ã€QPSã€block æ•°ç›®ã€çº¿ç¨‹æ•°ã€å¼‚å¸¸æ•°ç­‰ï¼‰ä»¥åŠæ¥æºä¿¡æ¯ï¼ˆoriginåç§°ï¼‰</li><li>StatisticSlotï¼šè´Ÿè´£ç»Ÿè®¡å®æ—¶è°ƒç”¨æ•°æ®ï¼ŒåŒ…æ‹¬è¿è¡Œä¿¡æ¯ã€æ¥æºä¿¡æ¯ç­‰ </li></ul><blockquote><p>è§„åˆ™åˆ¤æ–­éƒ¨åˆ†ï¼ˆrule checkingï¼‰</p></blockquote><ul><li>AuthoritySlotï¼šè´Ÿè´£æˆæƒè§„åˆ™ï¼ˆæ¥æºæ§åˆ¶ï¼‰</li><li>SystemSlotï¼šè´Ÿè´£ç³»ç»Ÿä¿æŠ¤è§„åˆ™</li><li>ParamFlowSlotï¼šè´Ÿè´£çƒ­ç‚¹å‚æ•°é™æµè§„åˆ™</li><li>FlowSlotï¼šè´Ÿè´£é™æµè§„åˆ™</li><li>DegradeSlotï¼šè´Ÿè´£é™çº§è§„åˆ™</li></ul><hr><h3 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h3><p>Context ä»£è¡¨è°ƒç”¨é“¾è·¯ä¸Šä¸‹æ–‡ï¼Œè´¯ç©¿ä¸€æ¬¡è°ƒç”¨é“¾è·¯ä¸­çš„æ‰€æœ‰ <code>Entry</code>ã€‚</p><p>Context ç»´æŒç€å…¥å£èŠ‚ç‚¹ï¼ˆ<code>entranceNode</code>ï¼‰ã€æœ¬æ¬¡è°ƒç”¨é“¾è·¯çš„ curNodeã€è°ƒç”¨æ¥æºï¼ˆ<code>origin</code>ï¼‰ç­‰ä¿¡æ¯ã€‚åç»­çš„Slotéƒ½å¯ä»¥é€šè¿‡Contextæ‹¿åˆ°DefaultNodeæˆ–è€…ClusterNodeï¼Œä»è€Œè·å–ç»Ÿè®¡æ•°æ®ï¼Œå®Œæˆè§„åˆ™åˆ¤æ–­ã€‚</p><p>Context ç»´æŒçš„æ–¹å¼ï¼šé€šè¿‡ ThreadLocal ä¼ é€’ï¼Œåªæœ‰åœ¨å…¥å£ <code>enter</code> çš„æ—¶å€™ç”Ÿæ•ˆã€‚</p><p>ç”±äº Context æ˜¯é€šè¿‡ ThreadLocal ä¼ é€’çš„ï¼Œå› æ­¤å¯¹äºå¼‚æ­¥è°ƒç”¨é“¾è·¯ï¼Œçº¿ç¨‹åˆ‡æ¢çš„æ—¶å€™ä¼šä¸¢æ‰ Contextï¼Œå› æ­¤éœ€è¦æ‰‹åŠ¨é€šè¿‡ <code>ContextUtil.runOnContext(context, f)</code> æ¥å˜æ¢ contextã€‚</p><hr><h3 id="Entry"><a href="#Entry" class="headerlink" title="Entry"></a>Entry</h3><p>æ¯ä¸€æ¬¡èµ„æºè°ƒç”¨éƒ½ä¼šåˆ›å»ºä¸€ä¸ª <code>Entry</code>ã€‚</p><p><code>Entry</code> åŒ…å«äº†èµ„æºåã€curNodeï¼ˆå½“å‰ç»Ÿè®¡èŠ‚ç‚¹ï¼‰ã€originNodeï¼ˆæ¥æºç»Ÿè®¡èŠ‚ç‚¹ï¼‰ç­‰ä¿¡æ¯ã€‚</p><p><code>CtEntry</code> ä¸ºæ™®é€šçš„ <code>Entry</code>ï¼Œåœ¨è°ƒç”¨ <code>SphU.entry(xxx)</code> çš„æ—¶å€™åˆ›å»ºã€‚ç‰¹æ€§ï¼šLinked entry within current contextï¼ˆå†…éƒ¨ç»´æŠ¤ç€ <code>parent</code> å’Œ <code>child</code>ï¼‰</p><p><strong>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹</strong>ï¼šCtEntry æ„é€ å‡½æ•°ä¸­ä¼šåš<strong>è°ƒç”¨é“¾çš„å˜æ¢</strong>ï¼Œå³å°†å½“å‰ Entry æ¥åˆ°ä¼ å…¥ Context çš„è°ƒç”¨é“¾è·¯ä¸Šï¼ˆ<code>setUpEntryFor</code>ï¼‰ã€‚</p><p>èµ„æºè°ƒç”¨ç»“æŸæ—¶éœ€è¦ <code>entry.exit()</code>ã€‚exit æ“ä½œä¼šè¿‡ä¸€é slot chain exitï¼Œæ¢å¤è°ƒç”¨æ ˆï¼Œexit context ç„¶åæ¸…ç©º entry ä¸­çš„ context é˜²æ­¢é‡å¤è°ƒç”¨ã€‚</p><p>@SentinelResourceæ³¨è§£å°±æ˜¯ä¸€ä¸ªæ ‡è®°ï¼Œè€ŒSentinelåŸºäºAOPæ€æƒ³ï¼Œå¯¹è¢«æ ‡è®°çš„æ–¹æ³•åšç¯ç»•å¢å¼ºï¼Œå®Œæˆèµ„æºï¼ˆ<code>Entry</code>ï¼‰çš„åˆ›å»ºã€‚</p><hr><h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><p>Sentinelä¸­çš„ç°‡ç‚¹é“¾è·¯æ˜¯ç”±ä¸€ä¸ªä¸ªçš„Nodeç»„æˆçš„ï¼ŒNodeæ˜¯ä¸€ä¸ªæ¥å£ï¼ŒåŒ…æ‹¬ä¸‹é¢çš„å®ç°ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925103029924.png" alt="image-20210925103029924"></p><p>æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½å¯ä»¥è®°å½•å¯¹èµ„æºçš„è®¿é—®ç»Ÿè®¡æ•°æ®ï¼Œæ‰€ä»¥éƒ½æ˜¯StatisticNodeçš„å­ç±»ã€‚</p><p>æŒ‰ç…§ä½œç”¨åˆ†ä¸ºä¸¤ç±»Nodeï¼š</p><ul><li>DefaultNodeï¼šä»£è¡¨é“¾è·¯æ ‘ä¸­çš„æ¯ä¸€ä¸ªèµ„æºï¼Œä¸€ä¸ªèµ„æºå‡ºç°åœ¨ä¸åŒé“¾è·¯ä¸­æ—¶ï¼Œä¼šåˆ›å»ºä¸åŒçš„DefaultNodeèŠ‚ç‚¹ã€‚è€Œæ ‘çš„å…¥å£èŠ‚ç‚¹å«EntranceNodeï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šçš„DefaultNode</li><li>ClusterNodeï¼šä»£è¡¨èµ„æºï¼Œä¸€ä¸ªèµ„æºä¸ç®¡å‡ºç°åœ¨å¤šå°‘é“¾è·¯ä¸­ï¼Œåªä¼šæœ‰ä¸€ä¸ªClusterNodeã€‚è®°å½•çš„æ˜¯å½“å‰èµ„æºè¢«è®¿é—®çš„æ‰€æœ‰ç»Ÿè®¡æ•°æ®ä¹‹å’Œã€‚</li></ul><p>DefaultNodeè®°å½•çš„æ˜¯èµ„æºåœ¨å½“å‰é“¾è·¯ä¸­çš„è®¿é—®æ•°æ®ï¼Œç”¨æ¥å®ç°åŸºäºé“¾è·¯æ¨¡å¼çš„é™æµè§„åˆ™ã€‚ClusterNodeè®°å½•çš„æ˜¯èµ„æºåœ¨æ‰€æœ‰é“¾è·¯ä¸­çš„è®¿é—®æ•°æ®ï¼Œå®ç°é»˜è®¤æ¨¡å¼ã€å…³è”æ¨¡å¼çš„é™æµè§„åˆ™ã€‚</p><p>ä¾‹å¦‚ï¼šæˆ‘ä»¬åœ¨ä¸€ä¸ªSpringMVCé¡¹ç›®ä¸­ï¼Œæœ‰ä¸¤ä¸ªä¸šåŠ¡ï¼š</p><ul><li>ä¸šåŠ¡1ï¼šcontrollerä¸­çš„èµ„æº<code>/order/query</code>è®¿é—®äº†serviceä¸­çš„èµ„æº<code>/goods</code></li><li>ä¸šåŠ¡2ï¼šcontrollerä¸­çš„èµ„æº<code>/order/save</code>è®¿é—®äº†serviceä¸­çš„èµ„æº<code>/goods</code></li></ul><p>åˆ›å»ºçš„é“¾è·¯å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925104726158.png" alt="image-20210925104726158"></p><hr><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="å…¥å£"><a href="#å…¥å£" class="headerlink" title="å…¥å£"></a>å…¥å£</h3><p>é¦–å…ˆï¼Œå›åˆ°ä¸€åˆ‡çš„å…¥å£ï¼Œ<code>AbstractSentinelInterceptor</code>ç±»çš„<code>preHandle</code>æ–¹æ³•ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925142313050.png" alt="image-20210925142313050"></p><p>è¿˜æœ‰ï¼Œ<code>SentinelResourceAspect</code>çš„ç¯ç»•å¢å¼ºæ–¹æ³•ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925142438552.png" alt="image-20210925142438552"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œä»»ä½•ä¸€ä¸ªèµ„æºå¿…å®šè¦æ‰§è¡Œ<code>SphU.entry()</code>è¿™ä¸ªæ–¹æ³•:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Entry <span class="title function_">entry</span><span class="params">(String name, <span class="type">int</span> resourceType, EntryType trafficType, Object[] args)</span></span><br><span class="line">    <span class="keyword">throws</span> BlockException &#123;</span><br><span class="line">    <span class="keyword">return</span> Env.sph.entryWithType(name, resourceType, trafficType, <span class="number">1</span>, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­è¿›å…¥<code>Env.sph.entryWithType(name, resourceType, trafficType, 1, args);</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Entry <span class="title function_">entryWithType</span><span class="params">(String name, <span class="type">int</span> resourceType, EntryType entryType, <span class="type">int</span> count, <span class="type">boolean</span> prioritized,</span></span><br><span class="line"><span class="params">                           Object[] args)</span> <span class="keyword">throws</span> BlockException &#123;</span><br><span class="line">    <span class="comment">// å°† èµ„æºåç§°ç­‰åŸºæœ¬ä¿¡æ¯ å°è£…ä¸ºä¸€ä¸ª StringResourceWrapperå¯¹è±¡</span></span><br><span class="line">    <span class="type">StringResourceWrapper</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringResourceWrapper</span>(name, entryType, resourceType);</span><br><span class="line">    <span class="comment">// ç»§ç»­</span></span><br><span class="line">    <span class="keyword">return</span> entryWithPriority(resource, count, prioritized, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›å…¥<code>entryWithPriority</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Entry <span class="title function_">entryWithPriority</span><span class="params">(ResourceWrapper resourceWrapper, <span class="type">int</span> count, <span class="type">boolean</span> prioritized, Object... args)</span></span><br><span class="line">    <span class="keyword">throws</span> BlockException &#123;</span><br><span class="line">    <span class="comment">// è·å– Context</span></span><br><span class="line">    <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> ContextUtil.getContext();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Using default context.</span></span><br><span class="line">        context = InternalContextUtil.internalEnter(Constants.CONTEXT_DEFAULT_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">ã€<span class="comment">// è·å– Slotæ‰§è¡Œé“¾ï¼ŒåŒä¸€ä¸ªèµ„æºï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ‰§è¡Œé“¾ï¼Œæ”¾å…¥ç¼“å­˜</span></span><br><span class="line">    ProcessorSlot&lt;Object&gt; chain = lookProcessChain(resourceWrapper);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»º Entryï¼Œå¹¶å°† resourceã€chainã€context è®°å½•åœ¨ Entryä¸­</span></span><br><span class="line">    <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtEntry</span>(resourceWrapper, chain, context);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œ slotChain</span></span><br><span class="line">        chain.entry(context, resourceWrapper, <span class="literal">null</span>, count, prioritized, args);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BlockException e1) &#123;</span><br><span class="line">        e.exit(count, args);</span><br><span class="line">        <span class="keyword">throw</span> e1;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e1) &#123;</span><br><span class="line">        <span class="comment">// This should not happen, unless there are errors existing in Sentinel internal.</span></span><br><span class="line">        RecordLog.info(<span class="string">&quot;Sentinel unexpected exception&quot;</span>, e1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œä¼šè·å–<code>ProcessorSlotChain</code>å¯¹è±¡ï¼Œç„¶ååŸºäºchain.entry()å¼€å§‹æ‰§è¡ŒslotChainä¸­çš„æ¯ä¸€ä¸ªSlot.  è€Œè¿™é‡Œåˆ›å»ºçš„æ˜¯å…¶å®ç°ç±»ï¼šDefaultProcessorSlotChain.</p><p>è·å–ProcessorSlotChainä»¥åä¼šä¿å­˜åˆ°ä¸€ä¸ªMapä¸­ï¼Œkeyæ˜¯ResourceWrapperï¼Œå€¼æ˜¯ProcessorSlotChain.</p><p>æ‰€ä»¥ï¼Œ<strong>ä¸€ä¸ªèµ„æºåªä¼šæœ‰ä¸€ä¸ªProcessorSlotChain</strong>.</p><hr><h3 id="DefaultProcessorSlotChain"><a href="#DefaultProcessorSlotChain" class="headerlink" title="DefaultProcessorSlotChain"></a>DefaultProcessorSlotChain</h3><p>æˆ‘ä»¬è¿›å…¥DefaultProcessorSlotChainçš„entryæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">entry</span><span class="params">(Context context, ResourceWrapper resourceWrapper, Object t, <span class="type">int</span> count, <span class="type">boolean</span> prioritized, Object... args)</span></span><br><span class="line">    <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// firstï¼Œå°±æ˜¯è´£ä»»é“¾ä¸­çš„ç¬¬ä¸€ä¸ª slot</span></span><br><span class="line">    first.transformEntry(context, resourceWrapper, t, count, prioritized, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„firstï¼Œç±»å‹æ˜¯AbstractLinkedProcessorSlotï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925144355865.png" alt="image-20210925144355865"></p><p>çœ‹ä¸‹ç»§æ‰¿å…³ç³»ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925144010507.png" alt="image-20210925144010507"></p><p>å› æ­¤ï¼Œfirstä¸€å®šæ˜¯è¿™äº›å®ç°ç±»ä¸­çš„ä¸€ä¸ªï¼ŒæŒ‰ç…§æœ€æ—©è®²çš„è´£ä»»é“¾é¡ºåºï¼Œfirståº”è¯¥å°±æ˜¯ <code>NodeSelectorSlot</code>ã€‚</p><p>ä¸è¿‡ï¼Œæ—¢ç„¶æ˜¯åŸºäºè´£ä»»é“¾æ¨¡å¼ï¼Œæ‰€ä»¥è¿™é‡Œåªè¦è®°ä½ä¸‹ä¸€ä¸ªslotå°±å¯ä»¥äº†ï¼Œä¹Ÿå°±æ˜¯nextï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925144233302.png" alt="image-20210925144233302"></p><p>nextç¡®å®æ˜¯NodeSelectSlotç±»å‹ã€‚</p><p>è€ŒNodeSelectSlotçš„nextä¸€å®šæ˜¯ClusterBuilderSlotï¼Œä¾æ¬¡ç±»æ¨ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925101327080.png" alt="image-20210925101327080"></p><p>è´£ä»»é“¾å°±å»ºç«‹èµ·æ¥äº†ã€‚</p><hr><h3 id="NodeSelectorSlot"><a href="#NodeSelectorSlot" class="headerlink" title="NodeSelectorSlot"></a>NodeSelectorSlot</h3><p>NodeSelectorSlotè´Ÿè´£æ„å»ºç°‡ç‚¹é“¾è·¯ä¸­çš„èŠ‚ç‚¹ï¼ˆDefaultNodeï¼‰ï¼Œå°†è¿™äº›èŠ‚ç‚¹å½¢æˆé“¾è·¯æ ‘ã€‚</p><p>æ ¸å¿ƒä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">entry</span><span class="params">(Context context, ResourceWrapper resourceWrapper, Object obj, <span class="type">int</span> count, <span class="type">boolean</span> prioritized, Object... args)</span></span><br><span class="line">    <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">  <span class="comment">// å°è¯•è·å– å½“å‰èµ„æºçš„ DefaultNode</span></span><br><span class="line">    <span class="type">DefaultNode</span> <span class="variable">node</span> <span class="operator">=</span> map.get(context.getName());</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            node = map.get(context.getName());</span><br><span class="line">            <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœä¸ºç©ºï¼Œä¸ºå½“å‰èµ„æºåˆ›å»ºä¸€ä¸ªæ–°çš„ DefaultNode</span></span><br><span class="line">                node = <span class="keyword">new</span> <span class="title class_">DefaultNode</span>(resourceWrapper, <span class="literal">null</span>);</span><br><span class="line">                HashMap&lt;String, DefaultNode&gt; cacheMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, DefaultNode&gt;(map.size());</span><br><span class="line">                cacheMap.putAll(map);</span><br><span class="line">                <span class="comment">// æ”¾å…¥ç¼“å­˜ä¸­ï¼Œæ³¨æ„è¿™é‡Œçš„ keyæ˜¯contextNameï¼Œ</span></span><br><span class="line">                <span class="comment">// è¿™æ ·ä¸åŒé“¾è·¯è¿›å…¥ç›¸åŒèµ„æºï¼Œå°±ä¼šåˆ›å»ºå¤šä¸ª DefaultNode</span></span><br><span class="line">                cacheMap.put(context.getName(), node);</span><br><span class="line">                map = cacheMap;</span><br><span class="line">                <span class="comment">// å½“å‰èŠ‚ç‚¹åŠ å…¥ä¸Šä¸€èŠ‚ç‚¹çš„ childä¸­ï¼Œè¿™æ ·å°±æ„æˆäº†è°ƒç”¨é“¾è·¯æ ‘</span></span><br><span class="line">                ((DefaultNode) context.getLastNode()).addChild(node);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// contextä¸­çš„curNodeï¼ˆå½“å‰èŠ‚ç‚¹ï¼‰è®¾ç½®ä¸ºæ–°çš„ node</span></span><br><span class="line">    context.setCurNode(node);</span><br><span class="line">    <span class="comment">// æ‰§è¡Œä¸‹ä¸€ä¸ª slot</span></span><br><span class="line">    fireEntry(context, resourceWrapper, node, count, prioritized, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªSlotå®Œæˆäº†è¿™ä¹ˆå‡ ä»¶äº‹æƒ…ï¼š</p><ul><li>ä¸ºå½“å‰èµ„æºåˆ›å»º DefaultNode</li><li>å°†DefaultNodeæ”¾å…¥ç¼“å­˜ä¸­ï¼Œkeyæ˜¯contextNameï¼Œè¿™æ ·ä¸åŒé“¾è·¯å…¥å£çš„è¯·æ±‚ï¼Œå°†ä¼šåˆ›å»ºå¤šä¸ªDefaultNodeï¼Œç›¸åŒé“¾è·¯åˆ™åªæœ‰ä¸€ä¸ªDefaultNode</li><li>å°†å½“å‰èµ„æºçš„DefaultNodeè®¾ç½®ä¸ºä¸Šä¸€ä¸ªèµ„æºçš„childNode</li><li>å°†å½“å‰èµ„æºçš„DefaultNodeè®¾ç½®ä¸ºContextä¸­çš„curNodeï¼ˆå½“å‰èŠ‚ç‚¹ï¼‰</li></ul><p>ä¸‹ä¸€ä¸ªslotï¼Œå°±æ˜¯ClusterBuilderSlot</p><hr><h3 id="ClusterBuilderSlot"><a href="#ClusterBuilderSlot" class="headerlink" title="ClusterBuilderSlot"></a>ClusterBuilderSlot</h3><p>ClusterBuilderSlotè´Ÿè´£æ„å»ºæŸä¸ªèµ„æºçš„ClusterNodeï¼Œæ ¸å¿ƒä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">entry</span><span class="params">(Context context, ResourceWrapper resourceWrapper, DefaultNode node,</span></span><br><span class="line"><span class="params">                  <span class="type">int</span> count, <span class="type">boolean</span> prioritized, Object... args)</span></span><br><span class="line">    <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// åˆ¤ç©ºï¼Œæ³¨æ„ClusterNodeæ˜¯å…±äº«çš„æˆå‘˜å˜é‡ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªèµ„æºåªæœ‰ä¸€ä¸ªClusterNodeï¼Œä¸é“¾è·¯æ— å…³</span></span><br><span class="line">    <span class="keyword">if</span> (clusterNode == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clusterNode == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// åˆ›å»º cluster node.</span></span><br><span class="line">                clusterNode = <span class="keyword">new</span> <span class="title class_">ClusterNode</span>(resourceWrapper.getName(), resourceWrapper.getResourceType());</span><br><span class="line">                HashMap&lt;ResourceWrapper, ClusterNode&gt; newMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(Math.max(clusterNodeMap.size(), <span class="number">16</span>));</span><br><span class="line">                newMap.putAll(clusterNodeMap);</span><br><span class="line">                <span class="comment">// æ”¾å…¥ç¼“å­˜ï¼Œå¯ä»¥æ˜¯nodeIdï¼Œä¹Ÿå°±æ˜¯resourceåç§°</span></span><br><span class="line">                newMap.put(node.getId(), clusterNode);</span><br><span class="line">                clusterNodeMap = newMap;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†èµ„æºçš„ DefaultNodeä¸ ClusterNodeå…³è”</span></span><br><span class="line">    node.setClusterNode(clusterNode);</span><br><span class="line"><span class="comment">// è®°å½•è¯·æ±‚æ¥æº origin å°† originæ”¾å…¥ entry</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">&quot;&quot;</span>.equals(context.getOrigin())) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">originNode</span> <span class="operator">=</span> node.getClusterNode().getOrCreateOriginNode(context.getOrigin());</span><br><span class="line">        context.getCurEntry().setOriginNode(originNode);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// ç»§ç»­ä¸‹ä¸€ä¸ªslot</span></span><br><span class="line">    fireEntry(context, resourceWrapper, node, count, prioritized, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="StatisticSlot"><a href="#StatisticSlot" class="headerlink" title="StatisticSlot"></a>StatisticSlot</h3><p>StatisticSlotè´Ÿè´£ç»Ÿè®¡å®æ—¶è°ƒç”¨æ•°æ®ï¼ŒåŒ…æ‹¬è¿è¡Œä¿¡æ¯ï¼ˆè®¿é—®æ¬¡æ•°ã€çº¿ç¨‹æ•°ï¼‰ã€æ¥æºä¿¡æ¯ç­‰ã€‚</p><p>StatisticSlotæ˜¯å®ç°é™æµçš„å…³é”®ï¼Œå…¶ä¸­åŸºäº<strong>æ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•</strong>ç»´æŠ¤äº†è®¡æ•°å™¨ï¼Œç»Ÿè®¡è¿›å…¥æŸä¸ªèµ„æºçš„è¯·æ±‚æ¬¡æ•°ã€‚</p><p>æ ¸å¿ƒä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">entry</span><span class="params">(Context context, ResourceWrapper resourceWrapper, DefaultNode node, </span></span><br><span class="line"><span class="params">                  <span class="type">int</span> count, <span class="type">boolean</span> prioritized, Object... args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ”¾è¡Œåˆ°ä¸‹ä¸€ä¸ª slotï¼Œåšé™æµã€é™çº§ç­‰åˆ¤æ–­</span></span><br><span class="line">        fireEntry(context, resourceWrapper, node, count, prioritized, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¯·æ±‚é€šè¿‡äº†, çº¿ç¨‹è®¡æ•°å™¨ +1 ï¼Œç”¨ä½œçº¿ç¨‹éš”ç¦»</span></span><br><span class="line">        node.increaseThreadNum();</span><br><span class="line">        <span class="comment">// è¯·æ±‚è®¡æ•°å™¨ +1 ç”¨ä½œé™æµ</span></span><br><span class="line">        node.addPassRequest(count);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (context.getCurEntry().getOriginNode() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæœ‰ originï¼Œæ¥æºè®¡æ•°å™¨ä¹Ÿéƒ½è¦ +1</span></span><br><span class="line">            context.getCurEntry().getOriginNode().increaseThreadNum();</span><br><span class="line">            context.getCurEntry().getOriginNode().addPassRequest(count);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (resourceWrapper.getEntryType() == EntryType.IN) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯å…¥å£èµ„æºï¼Œè¿˜è¦ç»™å…¨å±€è®¡æ•°å™¨ +1.</span></span><br><span class="line">            Constants.ENTRY_NODE.increaseThreadNum();</span><br><span class="line">            Constants.ENTRY_NODE.addPassRequest(count);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¯·æ±‚é€šè¿‡åçš„å›è°ƒ.</span></span><br><span class="line">        <span class="keyword">for</span> (ProcessorSlotEntryCallback&lt;DefaultNode&gt; handler : StatisticSlotCallbackRegistry.getEntryCallbacks()) &#123;</span><br><span class="line">            handler.onPass(context, resourceWrapper, node, count, args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        <span class="comment">// å„ç§å¼‚å¸¸å¤„ç†å°±çœç•¥äº†ã€‚ã€‚ã€‚</span></span><br><span class="line">        context.getCurEntry().setError(e);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦å¤–ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰€æœ‰çš„è®¡æ•°+1åŠ¨ä½œéƒ½åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼Œä»¥<code>node.addPassRequest(count);</code>ä¸ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addPassRequest</span><span class="params">(<span class="type">int</span> count)</span> &#123;</span><br><span class="line">    <span class="comment">// DefaultNodeçš„è®¡æ•°å™¨ï¼Œä»£è¡¨å½“å‰é“¾è·¯çš„ è®¡æ•°å™¨</span></span><br><span class="line">    <span class="built_in">super</span>.addPassRequest(count);</span><br><span class="line">    <span class="comment">// ClusterNodeè®¡æ•°å™¨ï¼Œä»£è¡¨å½“å‰èµ„æºçš„ æ€»è®¡æ•°å™¨</span></span><br><span class="line">    <span class="built_in">this</span>.clusterNode.addPassRequest(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“è®¡æ•°æ–¹å¼ï¼Œæˆ‘ä»¬åç»­å†çœ‹ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œè¿›å…¥è§„åˆ™æ ¡éªŒçš„ç›¸å…³slotäº†ï¼Œä¾æ¬¡æ˜¯ï¼š</p><ul><li>AuthoritySlotï¼šè´Ÿè´£æˆæƒè§„åˆ™ï¼ˆæ¥æºæ§åˆ¶ï¼‰</li><li>SystemSlotï¼šè´Ÿè´£ç³»ç»Ÿä¿æŠ¤è§„åˆ™</li><li>ParamFlowSlotï¼šè´Ÿè´£çƒ­ç‚¹å‚æ•°é™æµè§„åˆ™</li><li>FlowSlotï¼šè´Ÿè´£é™æµè§„åˆ™</li><li>DegradeSlotï¼šè´Ÿè´£é™çº§è§„åˆ™</li></ul><hr><h3 id="AuthoritySlot"><a href="#AuthoritySlot" class="headerlink" title="AuthoritySlot"></a>AuthoritySlot</h3><p>è´Ÿè´£è¯·æ±‚æ¥æºoriginçš„æˆæƒè§„åˆ™åˆ¤æ–­ï¼Œå¦‚å›¾ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925152626648.png" alt="image-20210925152626648"></p><p>æ ¸å¿ƒAPIï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">entry</span><span class="params">(Context context, ResourceWrapper resourceWrapper, DefaultNode node, <span class="type">int</span> count, <span class="type">boolean</span> prioritized, Object... args)</span></span><br><span class="line">    <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// æ ¡éªŒé»‘ç™½åå•</span></span><br><span class="line">    checkBlackWhiteAuthority(resourceWrapper, context);</span><br><span class="line">    <span class="comment">// è¿›å…¥ä¸‹ä¸€ä¸ª slot</span></span><br><span class="line">    fireEntry(context, resourceWrapper, node, count, prioritized, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é»‘ç™½åå•æ ¡éªŒçš„é€»è¾‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">checkBlackWhiteAuthority</span><span class="params">(ResourceWrapper resource, Context context)</span> <span class="keyword">throws</span> AuthorityException &#123;</span><br><span class="line">    <span class="comment">// è·å–æˆæƒè§„åˆ™</span></span><br><span class="line">    Map&lt;String, Set&lt;AuthorityRule&gt;&gt; authorityRules = AuthorityRuleManager.getAuthorityRules();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (authorityRules == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Set&lt;AuthorityRule&gt; rules = authorityRules.get(resource.getName());</span><br><span class="line">    <span class="keyword">if</span> (rules == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// éå†è§„åˆ™å¹¶åˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">for</span> (AuthorityRule rule : rules) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!AuthorityRuleChecker.passCheck(rule, context)) &#123;</span><br><span class="line">            <span class="comment">// è§„åˆ™ä¸é€šè¿‡ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthorityException</span>(context.getOrigin(), rule);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†çœ‹ä¸‹<code>AuthorityRuleChecker.passCheck(rule, context)</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">passCheck</span><span class="params">(AuthorityRule rule, Context context)</span> &#123;</span><br><span class="line">    <span class="comment">// å¾—åˆ°è¯·æ±‚æ¥æº origin</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">requester</span> <span class="operator">=</span> context.getOrigin();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¥æºä¸ºç©ºï¼Œæˆ–è€…è§„åˆ™ä¸ºç©ºï¼Œéƒ½ç›´æ¥æ”¾è¡Œ</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtil.isEmpty(requester) || StringUtil.isEmpty(rule.getLimitApp())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// rule.getLimitApp()å¾—åˆ°çš„å°±æ˜¯ ç™½åå• æˆ– é»‘åå• çš„å­—ç¬¦ä¸²ï¼Œè¿™é‡Œå…ˆç”¨ indexOfæ–¹æ³•åˆ¤æ–­</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> rule.getLimitApp().indexOf(requester);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">contain</span> <span class="operator">=</span> pos &gt; -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (contain) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœåŒ…å« originï¼Œè¿˜è¦è¿›ä¸€æ­¥åšç²¾ç¡®åˆ¤æ–­ï¼ŒæŠŠåå•åˆ—è¡¨ä»¥&quot;,&quot;åˆ†å‰²ï¼Œé€ä¸ªåˆ¤æ–­</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">exactlyMatch</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        String[] appArray = rule.getLimitApp().split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String app : appArray) &#123;</span><br><span class="line">            <span class="keyword">if</span> (requester.equals(app)) &#123;</span><br><span class="line">                exactlyMatch = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        contain = exactlyMatch;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// å¦‚æœæ˜¯é»‘åå•ï¼Œå¹¶ä¸”åŒ…å«originï¼Œåˆ™è¿”å›false</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">strategy</span> <span class="operator">=</span> rule.getStrategy();</span><br><span class="line">    <span class="keyword">if</span> (strategy == RuleConstant.AUTHORITY_BLACK &amp;&amp; contain) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// å¦‚æœæ˜¯ç™½åå•ï¼Œå¹¶ä¸”ä¸åŒ…å«originï¼Œåˆ™è¿”å›false</span></span><br><span class="line">    <span class="keyword">if</span> (strategy == RuleConstant.AUTHORITY_WHITE &amp;&amp; !contain) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// å…¶å®ƒæƒ…å†µè¿”å›true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>SystemSlotæ˜¯å¯¹ç³»ç»Ÿä¿æŠ¤çš„è§„åˆ™æ ¡éªŒï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925153228036.png" alt="image-20210925153228036"></p><p>æ ¸å¿ƒAPIï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">entry</span><span class="params">(Context context, ResourceWrapper resourceWrapper, DefaultNode node, </span></span><br><span class="line"><span class="params">                  <span class="type">int</span> count,<span class="type">boolean</span> prioritized, Object... args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// ç³»ç»Ÿè§„åˆ™æ ¡éªŒ</span></span><br><span class="line">    SystemRuleManager.checkSystem(resourceWrapper);</span><br><span class="line">    <span class="comment">// è¿›å…¥ä¸‹ä¸€ä¸ª slot</span></span><br><span class="line">    fireEntry(context, resourceWrapper, node, count, prioritized, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥çœ‹ä¸‹<code>SystemRuleManager.checkSystem(resourceWrapper);</code>çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">checkSystem</span><span class="params">(ResourceWrapper resourceWrapper)</span> <span class="keyword">throws</span> BlockException &#123;</span><br><span class="line">    <span class="keyword">if</span> (resourceWrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Ensure the checking switch is on.</span></span><br><span class="line">    <span class="keyword">if</span> (!checkSystemStatus.get()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åªé’ˆå¯¹å…¥å£èµ„æºåšæ ¡éªŒï¼Œå…¶å®ƒç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (resourceWrapper.getEntryType() != EntryType.IN) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¨å±€ QPSæ ¡éªŒ</span></span><br><span class="line">    <span class="type">double</span> <span class="variable">currentQps</span> <span class="operator">=</span> Constants.ENTRY_NODE == <span class="literal">null</span> ? <span class="number">0.0</span> : Constants.ENTRY_NODE.successQps();</span><br><span class="line">    <span class="keyword">if</span> (currentQps &gt; qps) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SystemBlockException</span>(resourceWrapper.getName(), <span class="string">&quot;qps&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¨å±€ çº¿ç¨‹æ•° æ ¡éªŒ</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">currentThread</span> <span class="operator">=</span> Constants.ENTRY_NODE == <span class="literal">null</span> ? <span class="number">0</span> : Constants.ENTRY_NODE.curThreadNum();</span><br><span class="line">    <span class="keyword">if</span> (currentThread &gt; maxThread) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SystemBlockException</span>(resourceWrapper.getName(), <span class="string">&quot;thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// å…¨å±€å¹³å‡ RTæ ¡éªŒ</span></span><br><span class="line">    <span class="type">double</span> <span class="variable">rt</span> <span class="operator">=</span> Constants.ENTRY_NODE == <span class="literal">null</span> ? <span class="number">0</span> : Constants.ENTRY_NODE.avgRt();</span><br><span class="line">    <span class="keyword">if</span> (rt &gt; maxRt) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SystemBlockException</span>(resourceWrapper.getName(), <span class="string">&quot;rt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¨å±€ ç³»ç»Ÿè´Ÿè½½ æ ¡éªŒ</span></span><br><span class="line">    <span class="keyword">if</span> (highestSystemLoadIsSet &amp;&amp; getCurrentSystemAvgLoad() &gt; highestSystemLoad) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!checkBbr(currentThread)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SystemBlockException</span>(resourceWrapper.getName(), <span class="string">&quot;load&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¨å±€ CPUä½¿ç”¨ç‡ æ ¡éªŒ</span></span><br><span class="line">    <span class="keyword">if</span> (highestCpuUsageIsSet &amp;&amp; getCurrentCpuUsage() &gt; highestCpuUsage) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SystemBlockException</span>(resourceWrapper.getName(), <span class="string">&quot;cpu&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="ParamFlowSlot"><a href="#ParamFlowSlot" class="headerlink" title="ParamFlowSlot"></a>ParamFlowSlot</h3><p>ParamFlowSlotå°±æ˜¯çƒ­ç‚¹å‚æ•°é™æµï¼Œå¦‚å›¾ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925153719891.png" alt="image-20210925153719891"></p><p>æ˜¯é’ˆå¯¹è¿›å…¥èµ„æºçš„è¯·æ±‚ï¼Œé’ˆå¯¹ä¸åŒçš„è¯·æ±‚å‚æ•°å€¼åˆ†åˆ«ç»Ÿè®¡QPSçš„é™æµæ–¹å¼ã€‚</p><ul><li><p>è¿™é‡Œçš„å•æœºé˜ˆå€¼ï¼Œå°±æ˜¯æœ€å¤§ä»¤ç‰Œæ•°é‡ï¼šmaxCount</p></li><li><p>è¿™é‡Œçš„ç»Ÿè®¡çª—å£æ—¶é•¿ï¼Œå°±æ˜¯ç»Ÿè®¡æ—¶é•¿ï¼šduration</p></li></ul><p>å«ä¹‰æ˜¯æ¯éš”durationæ—¶é—´é•¿åº¦å†…ï¼Œæœ€å¤šç”Ÿäº§maxCountä¸ªä»¤ç‰Œï¼Œä¸Šå›¾é…ç½®çš„å«ä¹‰æ˜¯æ¯1ç§’é’Ÿç”Ÿäº§2ä¸ªä»¤ç‰Œã€‚</p><p>æ ¸å¿ƒAPIï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">entry</span><span class="params">(Context context, ResourceWrapper resourceWrapper, DefaultNode node,</span></span><br><span class="line"><span class="params">                  <span class="type">int</span> count, <span class="type">boolean</span> prioritized, Object... args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰è®¾ç½®çƒ­ç‚¹è§„åˆ™ï¼Œç›´æ¥æ”¾è¡Œ</span></span><br><span class="line">    <span class="keyword">if</span> (!ParamFlowRuleManager.hasRules(resourceWrapper.getName())) &#123;</span><br><span class="line">        fireEntry(context, resourceWrapper, node, count, prioritized, args);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// çƒ­ç‚¹è§„åˆ™åˆ¤æ–­</span></span><br><span class="line">    checkFlow(resourceWrapper, count, args);</span><br><span class="line">    <span class="comment">// è¿›å…¥ä¸‹ä¸€ä¸ª slot</span></span><br><span class="line">    fireEntry(context, resourceWrapper, node, count, prioritized, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><mark class="hl-label blue">ä»¤ç‰Œæ¡¶</mark> <p>çƒ­ç‚¹è§„åˆ™åˆ¤æ–­é‡‡ç”¨äº†ä»¤ç‰Œæ¡¶ç®—æ³•æ¥å®ç°å‚æ•°é™æµï¼Œä¸ºæ¯ä¸€ä¸ªä¸åŒå‚æ•°å€¼è®¾ç½®ä»¤ç‰Œæ¡¶ï¼ŒSentinelçš„ä»¤ç‰Œæ¡¶æœ‰ä¸¤éƒ¨åˆ†ç»„æˆï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925163744108.png" alt="image-20210925163744108"></p><p>è¿™ä¸¤ä¸ªMapçš„keyéƒ½æ˜¯è¯·æ±‚çš„å‚æ•°å€¼ï¼Œvalueå´ä¸åŒï¼Œå…¶ä¸­ï¼š</p><ul><li>tokenCountersï¼šç”¨æ¥è®°å½•å‰©ä½™ä»¤ç‰Œæ•°é‡</li><li>timeCountersï¼šç”¨æ¥è®°å½•ä¸Šä¸€ä¸ªè¯·æ±‚çš„æ—¶é—´</li></ul><p>å½“ä¸€ä¸ªæºå¸¦å‚æ•°çš„è¯·æ±‚åˆ°æ¥åï¼ŒåŸºæœ¬åˆ¤æ–­æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/sentinel.jpg" alt="sentinel"></p><hr><h3 id="FlowSlot"><a href="#FlowSlot" class="headerlink" title="FlowSlot"></a>FlowSlot</h3><p>FlowSlotæ˜¯è´Ÿè´£é™æµè§„åˆ™çš„åˆ¤æ–­ï¼Œå¦‚å›¾ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925172542274.png" alt="image-20210925172542274"></p><p>åŒ…æ‹¬ï¼š</p><ul><li>ä¸‰ç§æµæ§æ¨¡å¼ï¼šç›´æ¥æ¨¡å¼ã€å…³è”æ¨¡å¼ã€é“¾è·¯æ¨¡å¼</li><li>ä¸‰ç§æµæ§æ•ˆæœï¼šå¿«é€Ÿå¤±è´¥ã€warm upã€æ’é˜Ÿç­‰å¾…</li></ul><p>ä¸‰ç§æµæ§æ¨¡å¼ï¼Œä»åº•å±‚<strong>æ•°æ®ç»Ÿè®¡</strong>è§’åº¦ï¼Œåˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li>å¯¹è¿›å…¥èµ„æºçš„æ‰€æœ‰è¯·æ±‚ï¼ˆClusterNodeï¼‰åšé™æµç»Ÿè®¡ï¼šç›´æ¥æ¨¡å¼ã€å…³è”æ¨¡å¼</li><li>å¯¹è¿›å…¥èµ„æºçš„éƒ¨åˆ†é“¾è·¯ï¼ˆDefaultNodeï¼‰åšé™æµç»Ÿè®¡ï¼šé“¾è·¯æ¨¡å¼</li></ul><p>ä¸‰ç§æµæ§æ•ˆæœï¼Œä»<strong>é™æµç®—æ³•</strong>æ¥çœ‹ï¼Œåˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li>æ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•ï¼šå¿«é€Ÿå¤±è´¥ã€warm up</li><li>æ¼æ¡¶ç®—æ³•ï¼šæ’é˜Ÿç­‰å¾…æ•ˆæœ</li></ul><hr><h4 id="æ ¸å¿ƒæµç¨‹"><a href="#æ ¸å¿ƒæµç¨‹" class="headerlink" title="æ ¸å¿ƒæµç¨‹"></a>æ ¸å¿ƒæµç¨‹</h4><p>æ ¸å¿ƒAPIå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">entry</span><span class="params">(Context context, ResourceWrapper resourceWrapper, DefaultNode node, <span class="type">int</span> count,</span></span><br><span class="line"><span class="params">                  <span class="type">boolean</span> prioritized, Object... args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// é™æµè§„åˆ™æ£€æµ‹</span></span><br><span class="line">    checkFlow(resourceWrapper, context, node, count, prioritized);</span><br><span class="line"><span class="comment">// æ”¾è¡Œ</span></span><br><span class="line">    fireEntry(context, resourceWrapper, node, count, prioritized, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>checkFlowæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">checkFlow</span><span class="params">(ResourceWrapper resource, Context context, DefaultNode node, <span class="type">int</span> count, <span class="type">boolean</span> prioritized)</span></span><br><span class="line">    <span class="keyword">throws</span> BlockException &#123;</span><br><span class="line">    <span class="comment">// checkeræ˜¯ FlowRuleChecker ç±»çš„ä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line">    checker.checkFlow(ruleProvider, resource, context, node, count, prioritized);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿå…¥FlowRuleCheckerï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkFlow</span><span class="params">(Function&lt;String, Collection&lt;FlowRule&gt;&gt; ruleProvider, </span></span><br><span class="line"><span class="params">                      ResourceWrapper resource,Context context, DefaultNode node,</span></span><br><span class="line"><span class="params">                      <span class="type">int</span> count, <span class="type">boolean</span> prioritized)</span> <span class="keyword">throws</span> BlockException &#123;</span><br><span class="line">        <span class="keyword">if</span> (ruleProvider == <span class="literal">null</span> || resource == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰èµ„æºçš„æ‰€æœ‰é™æµè§„åˆ™</span></span><br><span class="line">        Collection&lt;FlowRule&gt; rules = ruleProvider.apply(resource.getName());</span><br><span class="line">        <span class="keyword">if</span> (rules != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (FlowRule rule : rules) &#123;</span><br><span class="line">                <span class="comment">// éå†ï¼Œé€ä¸ªè§„åˆ™åšæ ¡éªŒ</span></span><br><span class="line">                <span class="keyword">if</span> (!canPassCheck(rule, context, node, count, prioritized)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FlowException</span>(rule.getLimitApp(), rule);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„FlowRuleå°±æ˜¯é™æµè§„åˆ™æ¥å£ï¼Œå…¶ä¸­çš„å‡ ä¸ªæˆå‘˜å˜é‡ï¼Œåˆšå¥½å¯¹åº”è¡¨å•å‚æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlowRule</span> <span class="keyword">extends</span> <span class="title class_">AbstractRule</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é˜ˆå€¼ç±»å‹ (0: çº¿ç¨‹, 1: QPS).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">grade</span> <span class="operator">=</span> RuleConstant.FLOW_GRADE_QPS;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é˜ˆå€¼.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> count;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸‰ç§é™æµæ¨¡å¼.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> RuleConstant#STRATEGY_DIRECT&#125; ç›´è¿æ¨¡å¼;</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> RuleConstant#STRATEGY_RELATE&#125; å…³è”æ¨¡å¼;</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> RuleConstant#STRATEGY_CHAIN&#125; é“¾è·¯æ¨¡å¼.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">strategy</span> <span class="operator">=</span> RuleConstant.STRATEGY_DIRECT;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å…³è”æ¨¡å¼å…³è”çš„èµ„æºåç§°.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String refResource;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 3ç§æµæ§æ•ˆæœ.</span></span><br><span class="line"><span class="comment">     * 0. å¿«é€Ÿå¤±è´¥, 1. warm up, 2. æ’é˜Ÿç­‰å¾…, 3. warm up + æ’é˜Ÿç­‰å¾…</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">controlBehavior</span> <span class="operator">=</span> RuleConstant.CONTROL_BEHAVIOR_DEFAULT;</span><br><span class="line"><span class="comment">// é¢„çƒ­æ—¶é•¿</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">warmUpPeriodSec</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é˜Ÿåˆ—æœ€å¤§ç­‰å¾…æ—¶é—´.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxQueueingTimeMs</span> <span class="operator">=</span> <span class="number">500</span>;</span><br><span class="line">    <span class="comment">// ã€‚ã€‚ã€‚ ç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¡éªŒçš„é€»è¾‘å®šä¹‰åœ¨<code>FlowRuleChecker</code>çš„<code>canPassCheck</code>æ–¹æ³•ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canPassCheck</span><span class="params">(<span class="comment">/*@NonNull*/</span> FlowRule rule, Context context, DefaultNode node, <span class="type">int</span> acquireCount,</span></span><br><span class="line"><span class="params">                            <span class="type">boolean</span> prioritized)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–é™æµèµ„æºåç§°</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">limitApp</span> <span class="operator">=</span> rule.getLimitApp();</span><br><span class="line">    <span class="keyword">if</span> (limitApp == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// æ ¡éªŒè§„åˆ™</span></span><br><span class="line">    <span class="keyword">return</span> passLocalCheck(rule, context, node, acquireCount, prioritized);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›å…¥<code>passLocalCheck()</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">passLocalCheck</span><span class="params">(FlowRule rule, Context context, DefaultNode node,</span></span><br><span class="line"><span class="params">                                      <span class="type">int</span> acquireCount,  <span class="type">boolean</span> prioritized)</span> &#123;</span><br><span class="line">    <span class="comment">// åŸºäºé™æµæ¨¡å¼åˆ¤æ–­è¦ç»Ÿè®¡çš„èŠ‚ç‚¹ï¼Œ </span></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ç›´è¿æ¨¡å¼ï¼Œå…³è”æ¨¡å¼ï¼Œå¯¹ClusterNodeç»Ÿè®¡ï¼Œå¦‚æœæ˜¯é“¾è·¯æ¨¡å¼ï¼Œåˆ™å¯¹DefaultNodeç»Ÿè®¡</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">selectedNode</span> <span class="operator">=</span> selectNodeByRequesterAndStrategy(rule, context, node);</span><br><span class="line">    <span class="keyword">if</span> (selectedNode == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// åˆ¤æ–­è§„åˆ™</span></span><br><span class="line">    <span class="keyword">return</span> rule.getRater().canPass(selectedNode, acquireCount, prioritized);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯¹è§„åˆ™çš„åˆ¤æ–­å…ˆè¦é€šè¿‡<code>FlowRule#getRater()</code>è·å–æµé‡æ§åˆ¶å™¨<code>TrafficShapingController</code>ï¼Œç„¶åå†åšé™æµã€‚</p><p>è€Œ<code>TrafficShapingController</code>æœ‰3ç§å®ç°ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925175221211.png" alt="image-20210925175221211"></p><ul><li>DefaultControllerï¼šå¿«é€Ÿå¤±è´¥ï¼Œé»˜è®¤çš„æ–¹å¼ï¼ŒåŸºäºæ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•</li><li>WarmUpControllerï¼šé¢„çƒ­æ¨¡å¼ï¼ŒåŸºäºæ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•ï¼Œåªä¸è¿‡é˜ˆå€¼æ˜¯åŠ¨æ€çš„</li><li>RateLimiterControllerï¼šæ’é˜Ÿç­‰å¾…æ¨¡å¼ï¼ŒåŸºäºæ¼æ¡¶ç®—æ³•</li></ul><p>æœ€ç»ˆçš„é™æµåˆ¤æ–­éƒ½åœ¨TrafficShapingControllerçš„canPassæ–¹æ³•ä¸­ã€‚</p><hr><h4 id="æ»‘åŠ¨æ—¶é—´çª—å£"><a href="#æ»‘åŠ¨æ—¶é—´çª—å£" class="headerlink" title="æ»‘åŠ¨æ—¶é—´çª—å£"></a>æ»‘åŠ¨æ—¶é—´çª—å£</h4><p>æ»‘åŠ¨æ—¶é—´çª—å£çš„åŠŸèƒ½åˆ†ä¸¤éƒ¨åˆ†æ¥çœ‹ï¼š</p><ul><li>ä¸€æ˜¯æ—¶é—´åŒºé—´çª—å£çš„QPSè®¡æ•°åŠŸèƒ½ï¼Œè¿™ä¸ªæ˜¯åœ¨StatisticSlotä¸­è°ƒç”¨çš„</li><li>äºŒæ˜¯å¯¹æ»‘åŠ¨çª—å£å†…çš„æ—¶é—´åŒºé—´çª—å£QPSç´¯åŠ ï¼Œè¿™ä¸ªæ˜¯åœ¨FlowRuleä¸­è°ƒç”¨çš„</li></ul><mark class="hl-label blue">æ—¶é—´çª—å£è¯·æ±‚é‡ç»Ÿè®¡</mark> <p>å›é¡¾StatisticSlotï¼Œæœ‰è¿™æ ·ä¸€æ®µä»£ç ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925180522926.png" alt="image-20210925180522926"></p><p>å°±æ˜¯åœ¨ç»Ÿè®¡é€šè¿‡è¯¥èŠ‚ç‚¹çš„QPSï¼Œæˆ‘ä»¬è·Ÿå…¥çœ‹çœ‹ï¼Œè¿™é‡Œè¿›å…¥äº†DefaultNodeå†…éƒ¨ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925180619492.png" alt="image-20210925180619492"></p><p>å‘ç°åŒæ—¶å¯¹<code>DefaultNode</code>å’Œ<code>ClusterNode</code>åœ¨åšQPSç»Ÿè®¡ï¼Œæˆ‘ä»¬çŸ¥é“<code>DefaultNode</code>å’Œ<code>ClusterNode</code>éƒ½æ˜¯<code>StatisticNode</code>çš„å­ç±»ï¼Œè¿™é‡Œè°ƒç”¨<code>addPassRequest()</code>æ–¹æ³•ï¼Œæœ€ç»ˆéƒ½ä¼šè¿›å…¥<code>StatisticNode</code>ä¸­ã€‚</p><p>éšä¾¿è·Ÿå…¥ä¸€ä¸ªï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925180810181.png" alt="image-20210925180810181"></p><p>è¿™é‡Œæœ‰ç§’ã€åˆ†ä¸¤ç§çº¬åº¦çš„ç»Ÿè®¡ï¼Œå¯¹åº”ä¸¤ä¸ªè®¡æ•°å™¨ã€‚æ‰¾åˆ°å¯¹åº”çš„æˆå‘˜å˜é‡ï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925180954856.png" alt="image-20210925180954856"></p><p>ä¸¤ä¸ªè®¡æ•°å™¨éƒ½æ˜¯ArrayMetricç±»å‹ï¼Œå¹¶ä¸”ä¼ å…¥äº†ä¸¤ä¸ªå‚æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// intervalInMsï¼šæ˜¯æ»‘åŠ¨çª—å£çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤ä¸º 1 ç§’</span></span><br><span class="line"><span class="comment">// sampleCount: æ—¶é—´çª—å£çš„åˆ†éš”æ•°é‡ï¼Œé»˜è®¤ä¸º 2ï¼Œå°±æ˜¯æŠŠ 1ç§’åˆ†ä¸º 2ä¸ªå°æ—¶é—´çª—</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ArrayMetric</span><span class="params">(<span class="type">int</span> sampleCount, <span class="type">int</span> intervalInMs)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.data = <span class="keyword">new</span> <span class="title class_">OccupiableBucketLeapArray</span>(sampleCount, intervalInMs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚å›¾ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925181359203.png" alt="image-20210925181359203"></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿›å…¥<code>ArrayMetric</code>ç±»çš„<code>addPass</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addPass</span><span class="params">(<span class="type">int</span> count)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰æ—¶é—´æ‰€åœ¨çš„æ—¶é—´çª—</span></span><br><span class="line">    WindowWrap&lt;MetricBucket&gt; wrap = data.currentWindow();</span><br><span class="line">    <span class="comment">// è®¡æ•°å™¨ +1</span></span><br><span class="line">    wrap.value().addPass(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œè®¡æ•°å™¨å¦‚ä½•çŸ¥é“å½“å‰æ‰€åœ¨çš„çª—å£æ˜¯å“ªä¸ªå‘¢ï¼Ÿ</p><p>è¿™é‡Œçš„dataæ˜¯ä¸€ä¸ªLeapArrayï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925181714605.png" alt="image-20210925181714605"></p><p>LeapArrayçš„å››ä¸ªå±æ€§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">LeapArray</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// å°çª—å£çš„æ—¶é—´é•¿åº¦ï¼Œé»˜è®¤æ˜¯500ms ï¼Œå€¼ = intervalInMs / sampleCount</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> windowLengthInMs;</span><br><span class="line">    <span class="comment">// æ»‘åŠ¨çª—å£å†…çš„ å°çª—å£ æ•°é‡ï¼Œé»˜è®¤ä¸º 2</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> sampleCount;</span><br><span class="line">    <span class="comment">// æ»‘åŠ¨çª—å£çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤ä¸º 1000ms</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> intervalInMs;</span><br><span class="line">    <span class="comment">// æ»‘åŠ¨çª—å£çš„æ—¶é—´é—´éš”ï¼Œå•ä½ä¸ºç§’ï¼Œé»˜è®¤ä¸º 1</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> intervalInSecond;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LeapArrayæ˜¯ä¸€ä¸ªç¯å½¢æ•°ç»„ï¼Œå› ä¸ºæ—¶é—´æ˜¯æ— é™çš„ï¼Œæ•°ç»„é•¿åº¦ä¸å¯èƒ½æ— é™ï¼Œå› æ­¤æ•°ç»„ä¸­æ¯ä¸€ä¸ªæ ¼å­æ”¾å…¥ä¸€ä¸ªæ—¶é—´çª—ï¼ˆwindowï¼‰ï¼Œå½“æ•°ç»„æ”¾æ»¡åï¼Œè§’æ ‡å½’0ï¼Œè¦†ç›–æœ€åˆçš„windowã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925182127206.png" alt="image-20210925182127206"></p><p>å› ä¸ºæ»‘åŠ¨çª—å£æœ€å¤šåˆ†æˆsampleCountæ•°é‡çš„å°çª—å£ï¼Œå› æ­¤æ•°ç»„é•¿åº¦åªè¦å¤§äºsampleCountï¼Œé‚£ä¹ˆæœ€è¿‘çš„ä¸€ä¸ªæ»‘åŠ¨çª—å£å†…çš„2ä¸ªå°çª—å£å°±æ°¸è¿œä¸ä¼šè¢«è¦†ç›–ï¼Œå°±ä¸ç”¨æ‹…å¿ƒæ—§æ•°æ®è¢«è¦†ç›–çš„é—®é¢˜äº†ã€‚</p><p>æˆ‘ä»¬è·Ÿå…¥<code>data.currentWindow();</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> WindowWrap&lt;T&gt; <span class="title function_">currentWindow</span><span class="params">(<span class="type">long</span> timeMillis)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (timeMillis &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// è®¡ç®—å½“å‰æ—¶é—´å¯¹åº”çš„æ•°ç»„è§’æ ‡</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> calculateTimeIdx(timeMillis);</span><br><span class="line">    <span class="comment">// è®¡ç®—å½“å‰æ—¶é—´æ‰€åœ¨çª—å£çš„å¼€å§‹æ—¶é—´.</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">windowStart</span> <span class="operator">=</span> calculateWindowStart(timeMillis);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * å…ˆæ ¹æ®è§’æ ‡è·å–æ•°ç»„ä¸­ä¿å­˜çš„ oldWindow å¯¹è±¡ï¼Œå¯èƒ½æ˜¯æ—§æ•°æ®ï¼Œéœ€è¦åˆ¤æ–­.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * (1) oldWindow ä¸å­˜åœ¨, è¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡ï¼Œåˆ›å»ºæ–° windowå¹¶å­˜å…¥ï¼Œç„¶åè¿”å›å³å¯</span></span><br><span class="line"><span class="comment">         * (2) oldWindowçš„ starTime = æœ¬æ¬¡è¯·æ±‚çš„ windowStar, è¯´æ˜æ­£æ˜¯è¦æ‰¾çš„çª—å£ï¼Œç›´æ¥è¿”å›.</span></span><br><span class="line"><span class="comment">         * (3) oldWindowçš„ starTime &lt; æœ¬æ¬¡è¯·æ±‚çš„ windowStar, è¯´æ˜æ˜¯æ—§æ•°æ®ï¼Œéœ€è¦è¢«è¦†ç›–ï¼Œåˆ›å»º </span></span><br><span class="line"><span class="comment">         *     æ–°çª—å£ï¼Œè¦†ç›–æ—§çª—å£</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        WindowWrap&lt;T&gt; old = array.get(idx);</span><br><span class="line">        <span class="keyword">if</span> (old == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»ºæ–° window</span></span><br><span class="line">            WindowWrap&lt;T&gt; window = <span class="keyword">new</span> <span class="title class_">WindowWrap</span>&lt;T&gt;(windowLengthInMs, windowStart, newEmptyBucket(timeMillis));</span><br><span class="line">            <span class="comment">// åŸºäºCASå†™å…¥æ•°ç»„ï¼Œé¿å…çº¿ç¨‹å®‰å…¨é—®é¢˜</span></span><br><span class="line">            <span class="keyword">if</span> (array.compareAndSet(idx, <span class="literal">null</span>, window)) &#123;</span><br><span class="line">                <span class="comment">// å†™å…¥æˆåŠŸï¼Œè¿”å›æ–°çš„ window</span></span><br><span class="line">                <span class="keyword">return</span> window;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å†™å…¥å¤±è´¥ï¼Œè¯´æ˜æœ‰å¹¶å‘æ›´æ–°ï¼Œç­‰å¾…å…¶å®ƒäººæ›´æ–°å®Œæˆå³å¯</span></span><br><span class="line">                Thread.<span class="keyword">yield</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (windowStart == old.windowStart()) &#123;</span><br><span class="line">            <span class="keyword">return</span> old;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (windowStart &gt; old.windowStart()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (updateLock.tryLock()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// è·å–å¹¶å‘é”ï¼Œè¦†ç›–æ—§çª—å£å¹¶è¿”å›</span></span><br><span class="line">                    <span class="keyword">return</span> resetWindowTo(old, windowStart);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    updateLock.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// è·å–é”å¤±è´¥ï¼Œç­‰å¾…å…¶å®ƒçº¿ç¨‹å¤„ç†å°±å¯ä»¥äº†</span></span><br><span class="line">                Thread.<span class="keyword">yield</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (windowStart &lt; old.windowStart()) &#123;</span><br><span class="line">            <span class="comment">// è¿™ç§æƒ…å†µä¸åº”è¯¥å­˜åœ¨ï¼Œå†™è¿™é‡Œåªæ˜¯ä»¥é˜²ä¸‡ä¸€ã€‚</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WindowWrap</span>&lt;T&gt;(windowLengthInMs, windowStart, newEmptyBucket(timeMillis));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°å½“å‰æ—¶é—´æ‰€åœ¨çª—å£ï¼ˆWindowWrapï¼‰åï¼Œåªè¦è°ƒç”¨WindowWrapå¯¹è±¡ä¸­çš„addæ–¹æ³•ï¼Œè®¡æ•°å™¨+1å³å¯ã€‚</p><p>è¿™é‡Œåªè´Ÿè´£ç»Ÿè®¡æ¯ä¸ªçª—å£çš„è¯·æ±‚é‡ï¼Œä¸è´Ÿè´£æ‹¦æˆªã€‚é™æµæ‹¦æˆªè¦çœ‹FlowSlotä¸­çš„é€»è¾‘ã€‚</p><hr><mark class="hl-label red">æ»‘åŠ¨çª—å£QPSè®¡ç®—</mark> <p>FlowSlotçš„é™æµåˆ¤æ–­æœ€ç»ˆéƒ½ç”±<code>TrafficShapingController</code>æ¥å£ä¸­çš„<code>canPass</code>æ–¹æ³•æ¥å®ç°ã€‚è¯¥æ¥å£æœ‰ä¸‰ä¸ªå®ç°ç±»ï¼š</p><ul><li>DefaultControllerï¼šå¿«é€Ÿå¤±è´¥ï¼Œé»˜è®¤çš„æ–¹å¼ï¼ŒåŸºäºæ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•</li><li>WarmUpControllerï¼šé¢„çƒ­æ¨¡å¼ï¼ŒåŸºäºæ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•ï¼Œåªä¸è¿‡é˜ˆå€¼æ˜¯åŠ¨æ€çš„</li><li>RateLimiterControllerï¼šæ’é˜Ÿç­‰å¾…æ¨¡å¼ï¼ŒåŸºäºæ¼æ¡¶ç®—æ³•</li></ul><p>å› æ­¤ï¼Œæˆ‘ä»¬è·Ÿå…¥é»˜è®¤çš„DefaultControllerä¸­çš„canPassæ–¹æ³•æ¥åˆ†æï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canPass</span><span class="params">(Node node, <span class="type">int</span> acquireCount, <span class="type">boolean</span> prioritized)</span> &#123;</span><br><span class="line">    <span class="comment">// è®¡ç®—ç›®å‰ä¸ºæ­¢æ»‘åŠ¨çª—å£å†…å·²ç»å­˜åœ¨çš„è¯·æ±‚é‡</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">curCount</span> <span class="operator">=</span> avgUsedTokens(node);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ï¼šå·²ä½¿ç”¨è¯·æ±‚é‡ + éœ€è¦çš„è¯·æ±‚é‡ï¼ˆ1ï¼‰ æ˜¯å¦å¤§äº çª—å£çš„è¯·æ±‚é˜ˆå€¼</span></span><br><span class="line">    <span class="keyword">if</span> (curCount + acquireCount &gt; count) &#123;</span><br><span class="line">        <span class="comment">// å¤§äºï¼Œè¯´æ˜è¶…å‡ºé˜ˆå€¼ï¼Œè¿”å›false</span></span><br><span class="line">        <span class="keyword">if</span> (prioritized &amp;&amp; grade == RuleConstant.FLOW_GRADE_QPS) &#123;</span><br><span class="line">            <span class="type">long</span> currentTime;</span><br><span class="line">            <span class="type">long</span> waitInMs;</span><br><span class="line">            currentTime = TimeUtil.currentTimeMillis();</span><br><span class="line">            waitInMs = node.tryOccupyNext(currentTime, acquireCount, count);</span><br><span class="line">            <span class="keyword">if</span> (waitInMs &lt; OccupyTimeoutProperty.getOccupyTimeout()) &#123;</span><br><span class="line">                node.addWaitingRequest(currentTime + waitInMs, acquireCount);</span><br><span class="line">                node.addOccupiedPass(acquireCount);</span><br><span class="line">                sleep(waitInMs);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// PriorityWaitException indicates that the request will pass after waiting for &#123;@link @waitInMs&#125;.</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PriorityWaitException</span>(waitInMs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°äºç­‰äºï¼Œè¯´æ˜åœ¨é˜ˆå€¼èŒƒå›´å†…ï¼Œè¿”å›true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› æ­¤ï¼Œåˆ¤æ–­çš„å…³é”®å°±æ˜¯<code>int curCount = avgUsedTokens(node);</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">avgUsedTokens</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT_AVG_USED_TOKENS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> grade == RuleConstant.FLOW_GRADE_THREAD ? node.curThreadNum() : (<span class="type">int</span>)(node.passQps());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯é™æµï¼Œèµ°<code>node.passQps()</code>é€»è¾‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™é‡Œåˆè¿›å…¥äº† StatisticNodeç±»</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">double</span> <span class="title function_">passQps</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è¯·æ±‚é‡ Ã· æ»‘åŠ¨çª—å£æ—¶é—´é—´éš” ï¼Œå¾—åˆ°çš„å°±æ˜¯QPS</span></span><br><span class="line">    <span class="keyword">return</span> rollingCounterInSecond.pass() / rollingCounterInSecond.getWindowIntervalInSec();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆ<code>rollingCounterInSecond.pass()</code>æ˜¯å¦‚ä½•å¾—åˆ°è¯·æ±‚é‡çš„å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rollingCounterInSecond æœ¬è´¨æ˜¯ArrayMetricï¼Œä¹‹å‰è¯´è¿‡</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">pass</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çª—å£</span></span><br><span class="line">    data.currentWindow();</span><br><span class="line">    <span class="type">long</span> <span class="variable">pass</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// è·å– å½“å‰æ—¶é—´çš„ æ»‘åŠ¨çª—å£èŒƒå›´å†… çš„æ‰€æœ‰å°çª—å£</span></span><br><span class="line">    List&lt;MetricBucket&gt; list = data.values();</span><br><span class="line"><span class="comment">// éå†</span></span><br><span class="line">    <span class="keyword">for</span> (MetricBucket window : list) &#123;</span><br><span class="line">        <span class="comment">// ç´¯åŠ æ±‚å’Œ</span></span><br><span class="line">        pass += window.pass();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> pass;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥çœ‹çœ‹<code>data.values()</code>å¦‚ä½•è·å– æ»‘åŠ¨çª—å£èŒƒå›´å†… çš„æ‰€æœ‰å°çª—å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ­¤å¤„è¿›å…¥LeapArrayç±»ä¸­ï¼š</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;T&gt; <span class="title function_">values</span><span class="params">(<span class="type">long</span> timeMillis)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (timeMillis &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;T&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ›å»ºç©ºé›†åˆï¼Œå¤§å°ç­‰äº LeapArrayé•¿åº¦</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> array.length();</span><br><span class="line">    List&lt;T&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;T&gt;(size);</span><br><span class="line"><span class="comment">// éå† LeapArray</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="comment">// è·å–æ¯ä¸€ä¸ªå°çª—å£</span></span><br><span class="line">        WindowWrap&lt;T&gt; windowWrap = array.get(i);</span><br><span class="line">        <span class="comment">// åˆ¤æ–­è¿™ä¸ªå°çª—å£æ˜¯å¦åœ¨ æ»‘åŠ¨çª—å£æ—¶é—´èŒƒå›´å†…ï¼ˆ1ç§’å†…ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (windowWrap == <span class="literal">null</span> || isWindowDeprecated(timeMillis, windowWrap)) &#123;</span><br><span class="line">            <span class="comment">// ä¸åœ¨èŒƒå›´å†…ï¼Œåˆ™è·³è¿‡</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åœ¨èŒƒå›´å†…ï¼Œåˆ™æ·»åŠ åˆ°é›†åˆä¸­</span></span><br><span class="line">        result.add(windowWrap.value());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å›é›†åˆ</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œ<code>isWindowDeprecated(timeMillis, windowWrap)</code>åˆæ˜¯å¦‚ä½•åˆ¤æ–­çª—å£æ˜¯å¦ç¬¦åˆè¦æ±‚å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isWindowDeprecated</span><span class="params">(<span class="type">long</span> time, WindowWrap&lt;T&gt; windowWrap)</span> &#123;</span><br><span class="line">    <span class="comment">// å½“å‰æ—¶é—´ - çª—å£å¼€å§‹æ—¶é—´  æ˜¯å¦å¤§äº æ»‘åŠ¨çª—å£çš„æœ€å¤§é—´éš”ï¼ˆ1ç§’ï¼‰</span></span><br><span class="line">    <span class="comment">// ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¦ç»Ÿè®¡çš„æ—¶ è·ç¦»å½“å‰æ—¶é—´1ç§’å†…çš„ å°çª—å£çš„ countä¹‹å’Œ</span></span><br><span class="line">    <span class="keyword">return</span> time - windowWrap.windowStart() &gt; intervalInMs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="æ¼æ¡¶"><a href="#æ¼æ¡¶" class="headerlink" title="æ¼æ¡¶"></a>æ¼æ¡¶</h4><p>ä¸Šä¸€èŠ‚æˆ‘ä»¬è®²è¿‡ï¼ŒFlowSlotçš„é™æµåˆ¤æ–­æœ€ç»ˆéƒ½ç”±<code>TrafficShapingController</code>æ¥å£ä¸­çš„<code>canPass</code>æ–¹æ³•æ¥å®ç°ã€‚è¯¥æ¥å£æœ‰ä¸‰ä¸ªå®ç°ç±»ï¼š</p><ul><li>DefaultControllerï¼šå¿«é€Ÿå¤±è´¥ï¼Œé»˜è®¤çš„æ–¹å¼ï¼ŒåŸºäºæ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•</li><li>WarmUpControllerï¼šé¢„çƒ­æ¨¡å¼ï¼ŒåŸºäºæ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•ï¼Œåªä¸è¿‡é˜ˆå€¼æ˜¯åŠ¨æ€çš„</li><li>RateLimiterControllerï¼šæ’é˜Ÿç­‰å¾…æ¨¡å¼ï¼ŒåŸºäºæ¼æ¡¶ç®—æ³•</li></ul><p>å› æ­¤ï¼Œæˆ‘ä»¬è·Ÿå…¥é»˜è®¤çš„RateLimiterControllerä¸­çš„canPassæ–¹æ³•æ¥åˆ†æï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canPass</span><span class="params">(Node node, <span class="type">int</span> acquireCount, <span class="type">boolean</span> prioritized)</span> &#123;</span><br><span class="line">    <span class="comment">// Pass when acquire count is less or equal than 0.</span></span><br><span class="line">    <span class="keyword">if</span> (acquireCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é˜ˆå€¼å°äºç­‰äº 0 ï¼Œé˜»æ­¢è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// è·å–å½“å‰æ—¶é—´</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> TimeUtil.currentTimeMillis();</span><br><span class="line">    <span class="comment">// è®¡ç®—ä¸¤æ¬¡è¯·æ±‚ä¹‹é—´å…è®¸çš„æœ€å°æ—¶é—´é—´éš”</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">costTime</span> <span class="operator">=</span> Math.round(<span class="number">1.0</span> * (acquireCount) / count * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—æœ¬æ¬¡è¯·æ±‚ å…è®¸æ‰§è¡Œçš„æ—¶é—´ç‚¹ = æœ€è¿‘ä¸€æ¬¡è¯·æ±‚çš„å¯æ‰§è¡Œæ—¶é—´ + ä¸¤æ¬¡è¯·æ±‚çš„æœ€å°é—´éš”</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">expectedTime</span> <span class="operator">=</span> costTime + latestPassedTime.get();</span><br><span class="line"><span class="comment">// å¦‚æœå…è®¸æ‰§è¡Œçš„æ—¶é—´ç‚¹å°äºå½“å‰æ—¶é—´ï¼Œè¯´æ˜å¯ä»¥ç«‹å³æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">if</span> (expectedTime &lt;= currentTime) &#123;</span><br><span class="line">        <span class="comment">// æ›´æ–°ä¸Šä¸€æ¬¡çš„è¯·æ±‚çš„æ‰§è¡Œæ—¶é—´</span></span><br><span class="line">        latestPassedTime.set(currentTime);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸èƒ½ç«‹å³æ‰§è¡Œï¼Œéœ€è¦è®¡ç®— é¢„æœŸç­‰å¾…æ—¶é•¿</span></span><br><span class="line">        <span class="comment">// é¢„æœŸç­‰å¾…æ—¶é•¿ = ä¸¤æ¬¡è¯·æ±‚çš„æœ€å°é—´éš” +æœ€è¿‘ä¸€æ¬¡è¯·æ±‚çš„å¯æ‰§è¡Œæ—¶é—´ - å½“å‰æ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">waitTime</span> <span class="operator">=</span> costTime + latestPassedTime.get() - TimeUtil.currentTimeMillis();</span><br><span class="line">        <span class="comment">// å¦‚æœé¢„æœŸç­‰å¾…æ—¶é—´è¶…å‡ºé˜ˆå€¼ï¼Œåˆ™æ‹’ç»è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">if</span> (waitTime &gt; maxQueueingTimeMs) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// é¢„æœŸç­‰å¾…æ—¶é—´å°äºé˜ˆå€¼ï¼Œæ›´æ–°æœ€è¿‘ä¸€æ¬¡è¯·æ±‚çš„å¯æ‰§è¡Œæ—¶é—´ï¼ŒåŠ ä¸ŠcostTime</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">oldTime</span> <span class="operator">=</span> latestPassedTime.addAndGet(costTime);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// ä¿é™©èµ·è§ï¼Œå†åˆ¤æ–­ä¸€æ¬¡é¢„æœŸç­‰å¾…æ—¶é—´ï¼Œæ˜¯å¦è¶…è¿‡é˜ˆå€¼</span></span><br><span class="line">                waitTime = oldTime - TimeUtil.currentTimeMillis();</span><br><span class="line">                <span class="keyword">if</span> (waitTime &gt; maxQueueingTimeMs) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœè¶…è¿‡ï¼Œåˆ™æŠŠåˆšæ‰ åŠ  çš„æ—¶é—´å† å‡å›æ¥</span></span><br><span class="line">                    latestPassedTime.addAndGet(-costTime);</span><br><span class="line">                    <span class="comment">// æ‹’ç»</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// in race condition waitTime may &lt;= 0</span></span><br><span class="line">                <span class="keyword">if</span> (waitTime &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// é¢„æœŸç­‰å¾…æ—¶é—´åœ¨é˜ˆå€¼èŒƒå›´å†…ï¼Œä¼‘çœ è¦ç­‰å¾…çš„æ—¶é—´ï¼Œé†’æ¥åç»§ç»­æ‰§è¡Œ</span></span><br><span class="line">                    Thread.sleep(waitTime);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸æˆ‘ä»¬ä¹‹å‰åˆ†æçš„æ¼æ¡¶ç®—æ³•åŸºæœ¬ä¸€è‡´ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925210716675.png" alt="image-20210925210716675"></p><hr><h3 id="DegradeSlot"><a href="#DegradeSlot" class="headerlink" title="DegradeSlot"></a>DegradeSlot</h3><p>æœ€åä¸€å…³ï¼Œå°±æ˜¯é™çº§è§„åˆ™åˆ¤æ–­äº†ã€‚</p><p>Sentinelçš„é™çº§æ˜¯åŸºäºçŠ¶æ€æœºæ¥å®ç°çš„ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925211020881.png" alt="image-20210925211020881"></p><p>å¯¹åº”çš„å®ç°åœ¨DegradeSlotç±»ä¸­ï¼Œæ ¸å¿ƒAPIï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">entry</span><span class="params">(Context context, ResourceWrapper resourceWrapper, DefaultNode node, </span></span><br><span class="line"><span class="params">                  <span class="type">int</span> count, <span class="type">boolean</span> prioritized, Object... args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// ç†”æ–­é™çº§è§„åˆ™åˆ¤æ–­</span></span><br><span class="line">    performChecking(context, resourceWrapper);</span><br><span class="line"><span class="comment">// ç»§ç»­ä¸‹ä¸€ä¸ªslot</span></span><br><span class="line">    fireEntry(context, resourceWrapper, node, count, prioritized, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­è¿›å…¥<code>performChecking</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">performChecking</span><span class="params">(Context context, ResourceWrapper r)</span> <span class="keyword">throws</span> BlockException &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰èµ„æºä¸Šçš„æ‰€æœ‰çš„æ–­è·¯å™¨ CircuitBreaker</span></span><br><span class="line">    List&lt;CircuitBreaker&gt; circuitBreakers = DegradeRuleManager.getCircuitBreakers(r.getName());</span><br><span class="line">    <span class="keyword">if</span> (circuitBreakers == <span class="literal">null</span> || circuitBreakers.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (CircuitBreaker cb : circuitBreakers) &#123;</span><br><span class="line">        <span class="comment">// éå†æ–­è·¯å™¨ï¼Œé€ä¸ªåˆ¤æ–­</span></span><br><span class="line">        <span class="keyword">if</span> (!cb.tryPass(context)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DegradeException</span>(cb.getRule().getLimitApp(), cb.getRule());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="CircuitBreaker"><a href="#CircuitBreaker" class="headerlink" title="CircuitBreaker"></a>CircuitBreaker</h4><p>æˆ‘ä»¬è¿›å…¥CircuitBreakerçš„tryPassæ–¹æ³•ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryPass</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­çŠ¶æ€æœºçŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (currentState.get() == State.CLOSED) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯closedçŠ¶æ€ï¼Œç›´æ¥æ”¾è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (currentState.get() == State.OPEN) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯OPENçŠ¶æ€ï¼Œæ–­è·¯å™¨æ‰“å¼€</span></span><br><span class="line">        <span class="comment">// ç»§ç»­åˆ¤æ–­OPENæ—¶é—´çª—æ˜¯å¦ç»“æŸï¼Œå¦‚æœæ˜¯åˆ™æŠŠçŠ¶æ€ä»OPENåˆ‡æ¢åˆ° HALF_OPENï¼Œè¿”å›true</span></span><br><span class="line">        <span class="keyword">return</span> retryTimeoutArrived() &amp;&amp; fromOpenToHalfOpen(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// OPENçŠ¶æ€ï¼Œå¹¶ä¸”æ—¶é—´çª—æœªåˆ°ï¼Œè¿”å›false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰å…³æ—¶é—´çª—çš„åˆ¤æ–­åœ¨<code>retryTimeoutArrived()</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">retryTimeoutArrived</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å½“å‰æ—¶é—´ å¤§äº ä¸‹ä¸€æ¬¡ HalfOpençš„é‡è¯•æ—¶é—´</span></span><br><span class="line">    <span class="keyword">return</span> TimeUtil.currentTimeMillis() &gt;= nextRetryTimestamp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>OPENåˆ°HALF_OPENåˆ‡æ¢åœ¨<code>fromOpenToHalfOpen(context)</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">fromOpenToHalfOpen</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="comment">// åŸºäºCASä¿®æ”¹çŠ¶æ€ï¼Œä» OPENåˆ° HALF_OPEN</span></span><br><span class="line">    <span class="keyword">if</span> (currentState.compareAndSet(State.OPEN, State.HALF_OPEN)) &#123;</span><br><span class="line">        <span class="comment">// çŠ¶æ€å˜æ›´çš„äº‹ä»¶é€šçŸ¥</span></span><br><span class="line">        notifyObservers(State.OPEN, State.HALF_OPEN, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// å¾—åˆ°å½“å‰èµ„æº</span></span><br><span class="line">        <span class="type">Entry</span> <span class="variable">entry</span> <span class="operator">=</span> context.getCurEntry();</span><br><span class="line">        <span class="comment">// ç»™èµ„æºè®¾ç½®ç›‘å¬å™¨ï¼Œåœ¨èµ„æºEntryé”€æ¯æ—¶ï¼ˆèµ„æºä¸šåŠ¡æ‰§è¡Œå®Œæ¯•æ—¶ï¼‰è§¦å‘</span></span><br><span class="line">        entry.whenTerminate(<span class="keyword">new</span> <span class="title class_">BiConsumer</span>&lt;Context, Entry&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(Context context, Entry entry)</span> &#123;</span><br><span class="line">                <span class="comment">// åˆ¤æ–­ èµ„æºä¸šåŠ¡æ˜¯å¦å¼‚å¸¸</span></span><br><span class="line">                <span class="keyword">if</span> (entry.getBlockError() != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœå¼‚å¸¸ï¼Œåˆ™å†æ¬¡è¿›å…¥OPENçŠ¶æ€</span></span><br><span class="line">                    currentState.compareAndSet(State.HALF_OPEN, State.OPEN);</span><br><span class="line">                    notifyObservers(State.HALF_OPEN, State.OPEN, <span class="number">1.0d</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå‡ºç°äº†ä»OPENåˆ°HALF_OPENã€ä»HALF_OPENåˆ°OPENçš„å˜åŒ–ï¼Œä½†æ˜¯è¿˜æœ‰å‡ ä¸ªæ²¡æœ‰ï¼š</p><ul><li>ä»CLOSEDåˆ°OPEN</li><li>ä»HALF_OPENåˆ°CLOSED</li></ul><h4 id="è§¦å‘æ–­è·¯å™¨"><a href="#è§¦å‘æ–­è·¯å™¨" class="headerlink" title="è§¦å‘æ–­è·¯å™¨"></a>è§¦å‘æ–­è·¯å™¨</h4><p>è¯·æ±‚ç»è¿‡æ‰€æœ‰æ’æ§½ åï¼Œä¸€å®šä¼šæ‰§è¡Œexitæ–¹æ³•ï¼Œè€Œåœ¨DegradeSlotçš„exitæ–¹æ³•ä¸­ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925213440686.png" alt="image-20210925213440686"></p><p>ä¼šè°ƒç”¨CircuitBreakerçš„onRequestCompleteæ–¹æ³•ã€‚è€ŒCircuitBreakeræœ‰ä¸¤ä¸ªå®ç°ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210925213939035.png" alt="image-20210925213939035"></p><p>æˆ‘ä»¬è¿™é‡Œä»¥å¼‚å¸¸æ¯”ä¾‹ç†”æ–­ä¸ºä¾‹æ¥çœ‹ï¼Œè¿›å…¥<code>ExceptionCircuitBreaker</code>çš„<code>onRequestComplete</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onRequestComplete</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–èµ„æº Entry</span></span><br><span class="line">    <span class="type">Entry</span> <span class="variable">entry</span> <span class="operator">=</span> context.getCurEntry();</span><br><span class="line">    <span class="keyword">if</span> (entry == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°è¯•è·å– èµ„æºä¸­çš„ å¼‚å¸¸</span></span><br><span class="line">    <span class="type">Throwable</span> <span class="variable">error</span> <span class="operator">=</span> entry.getError();</span><br><span class="line">    <span class="comment">// è·å–è®¡æ•°å™¨ï¼ŒåŒæ ·é‡‡ç”¨äº†æ»‘åŠ¨çª—å£æ¥è®¡æ•°</span></span><br><span class="line">    <span class="type">SimpleErrorCounter</span> <span class="variable">counter</span> <span class="operator">=</span> stat.currentWindow().value();</span><br><span class="line">    <span class="keyword">if</span> (error != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œåˆ™ errorè®¡æ•°å™¨ +1</span></span><br><span class="line">        counter.getErrorCount().add(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸ç®¡æ˜¯å¦å‡ºç°å¼‚å¸¸ï¼Œtotalè®¡æ•°å™¨ +1</span></span><br><span class="line">    counter.getTotalCount().add(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// åˆ¤æ–­å¼‚å¸¸æ¯”ä¾‹æ˜¯å¦è¶…å‡ºé˜ˆå€¼</span></span><br><span class="line">    handleStateChangeWhenThresholdExceeded(error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥çœ‹é˜ˆå€¼åˆ¤æ–­çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleStateChangeWhenThresholdExceeded</span><span class="params">(Throwable error)</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰å·²ç»æ˜¯OPENçŠ¶æ€ï¼Œä¸åšå¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (currentState.get() == State.OPEN) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// å¦‚æœå·²ç»æ˜¯ HALF_OPEN çŠ¶æ€ï¼Œåˆ¤æ–­æ˜¯å¦éœ€æ±‚åˆ‡æ¢çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (currentState.get() == State.HALF_OPEN) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰å¼‚å¸¸ï¼Œåˆ™ä» HALF_OPEN åˆ° CLOSED</span></span><br><span class="line">            fromHalfOpenToClose();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æœ‰ä¸€æ¬¡ï¼Œå†æ¬¡è¿›å…¥OPEN</span></span><br><span class="line">            fromHalfOpenToOpen(<span class="number">1.0d</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// è¯´æ˜å½“å‰æ˜¯CLOSEçŠ¶æ€ï¼Œéœ€è¦åˆ¤æ–­æ˜¯å¦è§¦å‘é˜ˆå€¼</span></span><br><span class="line">    List&lt;SimpleErrorCounter&gt; counters = stat.values();</span><br><span class="line">    <span class="type">long</span> <span class="variable">errCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> <span class="variable">totalCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ç´¯åŠ è®¡ç®— å¼‚å¸¸è¯·æ±‚æ•°é‡ã€æ€»è¯·æ±‚æ•°é‡</span></span><br><span class="line">    <span class="keyword">for</span> (SimpleErrorCounter counter : counters) &#123;</span><br><span class="line">        errCount += counter.errorCount.sum();</span><br><span class="line">        totalCount += counter.totalCount.sum();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ€»è¯·æ±‚æ•°é‡æœªè¾¾åˆ°é˜ˆå€¼ï¼Œä»€ä¹ˆéƒ½ä¸åš</span></span><br><span class="line">    <span class="keyword">if</span> (totalCount &lt; minRequestAmount) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">double</span> <span class="variable">curCount</span> <span class="operator">=</span> errCount;</span><br><span class="line">    <span class="keyword">if</span> (strategy == DEGRADE_GRADE_EXCEPTION_RATIO) &#123;</span><br><span class="line">        <span class="comment">// è®¡ç®—è¯·æ±‚çš„å¼‚å¸¸æ¯”ä¾‹</span></span><br><span class="line">        curCount = errCount * <span class="number">1.0d</span> / totalCount;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ¯”ä¾‹è¶…è¿‡é˜ˆå€¼ï¼Œåˆ‡æ¢åˆ° OPEN</span></span><br><span class="line">    <span class="keyword">if</span> (curCount &gt; threshold) &#123;</span><br><span class="line">        transformToOpen(curCount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="SPIæœºåˆ¶"><a href="#SPIæœºåˆ¶" class="headerlink" title="SPIæœºåˆ¶"></a>SPIæœºåˆ¶</h2><p>Sentinel æä¾›å¤šæ ·åŒ–çš„ SPI æ¥å£ç”¨äºæä¾›æ‰©å±•çš„èƒ½åŠ›ã€‚å¼€å‘è€…å¯ä»¥åœ¨ç”¨åŒä¸€ä¸ª <code>sentinel-core</code> çš„åŸºç¡€ä¸Šè‡ªè¡Œæ‰©å±•æ¥å£å®ç°ï¼Œä»è€Œå¯ä»¥æ–¹ä¾¿åœ°æ ¹æ®ä¸šåŠ¡éœ€æ±‚ç»™ Sentinel æ·»åŠ è‡ªå®šä¹‰çš„é€»è¾‘ã€‚ç›®å‰ Sentinel æä¾›å¦‚ä¸‹çš„æ‰©å±•ç‚¹ï¼š</p><ul><li>åˆå§‹åŒ–è¿‡ç¨‹æ‰©å±•ï¼šæä¾› <code>InitFunc</code> SPIæ¥å£ï¼Œå¯ä»¥æ·»åŠ è‡ªå®šä¹‰çš„ä¸€äº›åˆå§‹åŒ–é€»è¾‘ï¼Œå¦‚åŠ¨æ€è§„åˆ™æºæ³¨å†Œç­‰ã€‚</li><li>Slot/Slot Chain æ‰©å±•ï¼šç”¨äºç»™ Sentinel åŠŸèƒ½é“¾æ·»åŠ è‡ªå®šä¹‰çš„åŠŸèƒ½å¹¶è‡ªç”±ç¼–æ’ã€‚</li><li>æŒ‡æ ‡ç»Ÿè®¡æ‰©å±•ï¼ˆStatisticSlot Callbackï¼‰ï¼šç”¨äºæ‰©å±• StatisticSlot æŒ‡æ ‡ç»Ÿè®¡ç›¸å…³çš„é€»è¾‘ã€‚</li><li>Transport æ‰©å±•ï¼šæä¾› CommandHandlerã€CommandCenter ç­‰æ¥å£ï¼Œç”¨äºå¯¹å¿ƒè·³å‘é€ã€ç›‘æ§ API Server è¿›è¡Œæ‰©å±•ã€‚</li><li>é›†ç¾¤æµæ§æ‰©å±•ï¼šå¯ä»¥æ–¹ä¾¿åœ°å®šåˆ¶ token client/server è‡ªå®šä¹‰å®ç°ï¼Œå¯å‚è€ƒ<a href="https://github.com/alibaba/Sentinel/wiki/é›†ç¾¤æµæ§#æ‰©å±•æ¥å£è®¾è®¡">å¯¹åº”æ–‡æ¡£</a></li><li>æ—¥å¿—æ‰©å±•ï¼šç”¨äºè‡ªå®šä¹‰ record log Loggerï¼Œå¯ç”¨äºå¯¹æ¥ slf4j ç­‰æ ‡å‡†æ—¥å¿—å®ç°ã€‚</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/164955218-3469f26d-3838-41fc-9e89-c6fa0997b8c8.png" alt="image"></p>]]></content>
    
    
    <summary type="html">å·¥ä½œåŸç†åˆ†æã€æ ¸å¿ƒæºç è§£æ</summary>
    
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
    <category term="ä¸­é—´ä»¶" scheme="https://wuwawawa.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>çº¿ç¨‹æ± è§£æ</title>
    <link href="https://wuwawawa.github.io/posts/927b9f8f.html"/>
    <id>https://wuwawawa.github.io/posts/927b9f8f.html</id>
    <published>2024-03-26T07:50:31.000Z</published>
    <updated>2024-03-27T07:24:22.086Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html">Javaçº¿ç¨‹æ± å®ç°åŸç†åŠå…¶åœ¨ç¾å›¢ä¸šåŠ¡ä¸­çš„å®è·µ</a></p><p><a href="https://my.oschina.net/andylucc/blog/648127">æ›´å¥½çš„ä½¿ç”¨ JAVA çº¿ç¨‹æ± </a></p><h2 id="å·¥ä½œæ¨¡å‹ä»¥åŠçŠ¶æ€æµè½¬"><a href="#å·¥ä½œæ¨¡å‹ä»¥åŠçŠ¶æ€æµè½¬" class="headerlink" title="å·¥ä½œæ¨¡å‹ä»¥åŠçŠ¶æ€æµè½¬"></a>å·¥ä½œæ¨¡å‹ä»¥åŠçŠ¶æ€æµè½¬</h2><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240326191032918.png" alt="image-20240326191032918" style="zoom:50%;" /></p><mark class="hl-label blue">ctl</mark> <figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å‰ä¸‰ä½è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼ŒåäºŒåä¹ä½è¡¨ç¤ºå·¥ä½œçº¿ç¨‹æ•°</span><br><span class="line">RUNNING      11100000000000000000000000000000      -536870912</span><br><span class="line">SHUTDOWN     00000000000000000000000000000000               0</span><br><span class="line">STOP         00100000000000000000000000000000       536870912</span><br><span class="line">TIDYING      01000000000000000000000000000000      1073741824</span><br><span class="line">TERMINATED   01100000000000000000000000000000      1610612736</span><br><span class="line">ä»å°åˆ°å¤§ RUNNING &lt; SHUTDOWN &lt; STOP &lt; TIDYING &lt; TERMINATED</span><br></pre></td></tr></table></figure><div class="table-container"><table><thead><tr><th style="text-align:left">è¿è¡ŒçŠ¶æ€</th><th style="text-align:center">çŠ¶æ€æè¿°</th></tr></thead><tbody><tr><td style="text-align:left"><code>RUNNING</code></td><td style="text-align:center">èƒ½æ¥å—æ–°æäº¤çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¹Ÿèƒ½å¤„ç†é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</td></tr><tr><td style="text-align:left"><code>SHUTDOWN</code></td><td style="text-align:center">å…³é—­çŠ¶æ€ï¼Œä¸å†æ¥å—æ–°æäº¤çš„ä»»åŠ¡ï¼Œä½†å´å¯ä»¥ç»§ç»­å¤„ç†é˜»å¡é˜Ÿåˆ—ä¸­å·²ä¿å­˜çš„ä»»åŠ¡</td></tr><tr><td style="text-align:left"><code>STOP</code></td><td style="text-align:center">ä¸èƒ½æ¥å—æ–°ä»»åŠ¡ï¼Œä¹Ÿä¸å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä¼šä¸­æ–­æ­£åœ¨å¤„ç†ä»»åŠ¡çš„çº¿ç¨‹</td></tr><tr><td style="text-align:left"><code>TIDYING</code></td><td style="text-align:center">æ‰€æœ‰çš„ä»»åŠ¡éƒ½å·²ç»ˆæ­¢äº†ï¼ŒworkerCountï¼ˆæœ‰æ•ˆçº¿ç¨‹æ•°ï¼‰ä¸º0</td></tr><tr><td style="text-align:left"><code>TERMINATED</code></td><td style="text-align:center">åœ¨terminated()æ–¹æ³•æ‰§è¡Œå®Œåè¿›å…¥è¯¥çŠ¶æ€</td></tr></tbody></table></div><mark class="hl-label green">å…¨å±€é”mainLock</mark> <p>æºç ä¸­ï¼Œå‘ç°å¾ˆå¤šåœ°æ–¹éƒ½ä¼šç”¨åˆ°mainLockï¼Œå®ƒæ˜¯çº¿ç¨‹æ± ä¸­çš„ä¸€æŠŠå…¨å±€é”ï¼Œä¸»è¦æ˜¯ç”¨æ¥æ§åˆ¶works é›†åˆçš„å¹¶å‘å®‰å…¨ï¼Œå› ä¸ºå¦‚æœæ²¡æœ‰è¿™æŠŠå…¨å±€é”ï¼Œå°±æœ‰å¯èƒ½å¤šä¸ªçº¿ç¨‹å…¬ç”¨åŒä¸€ä¸ªçº¿ç¨‹æ± å¯¹è±¡ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨æäº¤ä»»åŠ¡ï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨shutdownçº¿ç¨‹æ± ï¼Œå¦‚æœä¸åšå¹¶å‘æ§åˆ¶ï¼Œé‚£å°±æœ‰å¯èƒ½çº¿ç¨‹æ± shutdownäº†ï¼Œä½†æ˜¯è¿˜æœ‰å·¥ä½œçº¿ç¨‹æ²¡æœ‰è¢«ä¸­æ–­ï¼Œå¦‚æœ1ä¸ªçº¿ç¨‹åœ¨shutdownï¼Œ99ä¸ªçº¿ç¨‹åœ¨æäº¤ä»»åŠ¡ï¼Œé‚£ä¹ˆæœ€ç»ˆå°±å¯èƒ½å¯¼è‡´çº¿ç¨‹æ± å…³é—­äº†ï¼Œä½†æ˜¯çº¿ç¨‹æ± ä¸­çš„å¾ˆå¤šçº¿ç¨‹éƒ½æ²¡æœ‰åœæ­¢ï¼Œä»ç„¶åœ¨è¿è¡Œï¼Œè¿™è‚¯å®šæ˜¯ä¸è¡Œï¼Œæ‰€ä»¥éœ€è¦è¿™æŠŠå…¨å±€é”æ¥å¯¹worksé›†åˆçš„æ“ä½œè¿›è¡Œå¹¶å‘å®‰å…¨æ§åˆ¶ã€‚</p><h2 id="çº¿ç¨‹è¿è¡Œã€å¼‚å¸¸å¤„ç†ã€ä¿æ´»ã€å›æ”¶"><a href="#çº¿ç¨‹è¿è¡Œã€å¼‚å¸¸å¤„ç†ã€ä¿æ´»ã€å›æ”¶" class="headerlink" title="çº¿ç¨‹è¿è¡Œã€å¼‚å¸¸å¤„ç†ã€ä¿æ´»ã€å›æ”¶"></a>çº¿ç¨‹è¿è¡Œã€å¼‚å¸¸å¤„ç†ã€ä¿æ´»ã€å›æ”¶</h2><p>åœ¨çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ²¡æœ‰æ ¸å¿ƒçº¿ç¨‹ä¸éæ ¸å¿ƒçº¿ç¨‹ä¹‹åˆ†ï¼Œæ²¡æœ‰å˜é‡æ¥åŒºåˆ†ï¼Œå®ƒä»¬ç›´æ¥æ²¡æœ‰æ˜æ˜¾çš„è¾¹ç•Œã€‚åªæœ‰æ ¸å¿ƒçº¿ç¨‹æ•°å’Œéæ ¸å¿ƒçº¿ç¨‹æ•°è¿™ä¹ˆä¸€è¯´ï¼Œä¿è¯çº¿ç¨‹æ± ä¸­æœ‰è¿™ä¹ˆå¤šæ ¸å¿ƒçº¿ç¨‹æ•°ã€‚</p><mark class="hl-label blue">runWorker</mark> <p>æ ¸å¿ƒçº¿ç¨‹å¯ä»¥è¢«å›æ”¶ï¼Œåªæœ‰åœ¨ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³æ—¶ï¼š</p><ol><li>çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹æ•°ï¼ŒåŒæ—¶æ‰€æœ‰çš„çº¿ç¨‹éƒ½å¤„äºé—²ç½®çŠ¶æ€ï¼Œå³æ²¡æœ‰æ­£åœ¨å¤„ç†ä»»åŠ¡ã€‚</li><li>çº¿ç¨‹æ± çš„keepAliveTimeæ—¶é—´åˆ°è¾¾åï¼Œå³ä½¿å½“å‰çº¿ç¨‹æ•°é‡è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä¹Ÿä¼šè¢«å›æ”¶ã€‚</li></ol><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240326212846472.png" alt="image-20240326212846472" style="zoom:67%;" /></p><blockquote><p>addWorkeræ–¹æ³•</p></blockquote><p>addWorkeræ–¹æ³•æ˜¯æ ¸å¿ƒæ–¹æ³•ï¼Œæ˜¯ç”¨æ¥æ·»åŠ çº¿ç¨‹çš„ï¼Œcoreå‚æ•°è¡¨ç¤ºæ¡ä»¶çš„æ˜¯æ ¸å¿ƒçº¿ç¨‹è¿˜æ˜¯éæ ¸å¿ƒçº¿ç¨‹ã€‚</p><p>åœ¨çœ‹è¿™ä¸ªæ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬ä¸å¦¨å…ˆè‡ªå·±æ¥åˆ†æä¸€ä¸‹ï¼Œä»€ä¹ˆæ˜¯æ·»åŠ çº¿ç¨‹ï¼Ÿ </p><p>å®é™…ä¸Šå°±è¦å¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ç®¡æ˜¯æ ¸å¿ƒçº¿ç¨‹è¿˜æ˜¯éæ ¸å¿ƒçº¿ç¨‹å…¶å®éƒ½åªæ˜¯ä¸€ä¸ªæ™®é€šçš„çº¿ç¨‹ï¼Œè€Œæ ¸å¿ƒå’Œéæ ¸å¿ƒçš„åŒºåˆ«åœ¨äºï¼š </p><ol><li><p>å¦‚æœæ˜¯è¦æ·»åŠ æ ¸å¿ƒå·¥ä½œçº¿ç¨‹ï¼Œé‚£ä¹ˆå°±å¾—åˆ¤æ–­ç›®å‰çš„å·¥ä½œçº¿ç¨‹æ•°æ˜¯å¦è¶…è¿‡corePoolSize</p><p>a. å¦‚æœæ²¡æœ‰è¶…è¿‡ï¼Œåˆ™ç›´æ¥å¼€å¯æ–°çš„å·¥ä½œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡</p><p>b. å¦‚æœè¶…è¿‡äº†ï¼Œåˆ™ä¸ä¼šå¼€å¯æ–°çš„å·¥ä½œçº¿ç¨‹ï¼Œè€Œæ˜¯æŠŠä»»åŠ¡è¿›è¡Œå…¥é˜Ÿ2</p></li><li><p>å¦‚æœè¦æ·»åŠ çš„æ˜¯éæ ¸å¿ƒå·¥ä½œçº¿ç¨‹ï¼Œé‚£å°±è¦åˆ¤æ–­ç›®å‰çš„å·¥ä½œçº¿ç¨‹æ•°æ˜¯å¦è¶…è¿‡maximumPoolSize</p><p>a. å¦‚æœæ²¡æœ‰è¶…è¿‡ï¼Œåˆ™ç›´æ¥å¼€å¯æ–°çš„å·¥ä½œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡</p><p>b. å¦‚æœè¶…è¿‡äº†ï¼Œåˆ™æ‹’ç»æ‰§è¡Œä»»åŠ¡. . . . . . </p></li></ol><p>æ‰€ä»¥åœ¨addWorkeræ–¹æ³•ä¸­ï¼Œé¦–å…ˆå°±è¦åˆ¤æ–­å·¥ä½œçº¿ç¨‹æœ‰æ²¡æœ‰è¶…è¿‡é™åˆ¶ï¼Œå¦‚æœæ²¡æœ‰è¶…è¿‡é™åˆ¶å†å»å¼€å¯ä¸€ä¸ªçº¿ç¨‹ã€‚</p><p>å¹¶ä¸”åœ¨addWorkeræ–¹æ³•ä¸­ï¼Œè¿˜å¾—åˆ¤æ–­çº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œå¦‚æœçº¿ç¨‹æ± çš„çŠ¶æ€ä¸æ˜¯RUNNINGçŠ¶æ€äº†ï¼Œé‚£å°±æ²¡å¿…è¦è¦å»æ·»åŠ çº¿ç¨‹äº†ï¼Œå½“ç„¶æœ‰ä¸€ç§ç‰¹ä¾‹ï¼Œå°±æ˜¯çº¿ç¨‹æ± çš„çŠ¶æ€æ˜¯SHUTDOWNï¼Œä½†æ˜¯é˜Ÿåˆ—ä¸­æœ‰ä»»åŠ¡ï¼Œé‚£æ­¤æ—¶è¿˜æ˜¯éœ€è¦æ·»åŠ æ·»åŠ ä¸€ä¸ªçº¿ç¨‹çš„ã€‚</p><p>é‚£è¿™ç§ç‰¹ä¾‹æ˜¯å¦‚ä½•äº§ç”Ÿçš„å‘¢ï¼Ÿ </p><p>æˆ‘ä»¬å‰é¢æåˆ°çš„éƒ½æ˜¯å¼€å¯æ–°çš„å·¥ä½œçº¿ç¨‹ï¼Œé‚£ä¹ˆå·¥ä½œçº¿ç¨‹æ€ä¹ˆå›æ”¶å‘¢ï¼Ÿä¸å¯èƒ½å¼€å¯çš„å·¥ä½œçº¿ç¨‹ä¸€ç›´æ´»ç€ï¼Œ å› ä¸ºå¦‚æœä»»åŠ¡ç”±å¤šå˜å°‘ï¼Œé‚£ä¹Ÿå°±ä¸éœ€è¦è¿‡å¤šçš„çº¿ç¨‹èµ„æºï¼Œæ‰€ä»¥çº¿ç¨‹æ± ä¸­ä¼šæœ‰æœºåˆ¶å¯¹å¼€å¯çš„å·¥ä½œçº¿ç¨‹è¿›è¡Œå›æ”¶ï¼Œå¦‚ä½•å›æ”¶çš„ï¼Œåæ–‡ä¼šæåˆ°ï¼Œæˆ‘ä»¬è¿™é‡Œå…ˆåˆ†æï¼Œæœ‰æ²¡æœ‰å¯èƒ½çº¿ç¨‹æ± ä¸­æ‰€æœ‰çš„çº¿ç¨‹éƒ½è¢«å›æ”¶äº†ï¼Œç­”æ¡ˆçš„æ˜¯æœ‰çš„ã€‚</p><p>é¦–å…ˆéæ ¸å¿ƒå·¥ä½œçº¿ç¨‹è¢«å›æ”¶æ˜¯å¯ä»¥ç†è§£çš„ï¼Œé‚£æ ¸å¿ƒå·¥ä½œçº¿ç¨‹è¦ä¸è¦å›æ”¶æ‰å‘¢ï¼Ÿå…¶å®çº¿ç¨‹æ± å­˜åœ¨çš„æ„ä¹‰ï¼Œ å°±æ˜¯æäº¤ç”Ÿæˆå¥½çº¿ç¨‹èµ„æºï¼Œéœ€è¦çº¿ç¨‹çš„æ—¶å€™ç›´æ¥ä½¿ç”¨å°±å¯ä»¥ï¼Œè€Œä¸éœ€è¦ä¸´æ—¶å»å¼€å¯çº¿ç¨‹ï¼Œæ‰€ä»¥æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¼€å¯çš„æ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ˜¯ä¸ç”¨å›æ”¶æ‰çš„ï¼Œå°±ç®—æš‚æ—¶æ²¡æœ‰ä»»åŠ¡è¦å¤„ç†ï¼Œä¹Ÿä¸ç”¨å›æ”¶ï¼Œå°±è®©æ ¸å¿ƒå·¥ä½œçº¿ç¨‹åœ¨é‚£ç­‰ç€å°±å¯ä»¥äº†ã€‚</p><p>ä½†æ˜¯ ï¼åœ¨çº¿ç¨‹æ± ä¸­æœ‰è¿™ä¹ˆä¸€ä¸ªå‚æ•°ï¼š<code>allowCoreThreadTimeOut</code>ï¼Œè¡¨ç¤ºæ˜¯å¦å…è®¸æ ¸å¿ƒå·¥ä½œçº¿ç¨‹è¶…æ—¶ï¼Œæ„æ€å°±æ˜¯æ˜¯å¦å…è®¸æ ¸å¿ƒå·¥ä½œçº¿ç¨‹å›æ”¶ï¼Œé»˜è®¤è¿™ä¸ªå‚æ•°ä¸ºfalseï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥è°ƒç”¨allowCoreThreadTimeOut(boolean value)æ¥æŠŠè¿™ä¸ªå‚æ•°æ”¹ä¸ºtrueï¼Œåªè¦æ”¹äº†ï¼Œé‚£ä¹ˆæ ¸å¿ƒå·¥ä½œçº¿ç¨‹ä¹Ÿå°±ä¼šè¢«å›æ”¶äº†ï¼Œé‚£è¿™æ ·çº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰å·¥ä½œçº¿ç¨‹éƒ½å¯èƒ½è¢«å›æ”¶æ‰ï¼Œé‚£å¦‚æœæ‰€æœ‰å·¥ä½œçº¿ç¨‹éƒ½è¢«å›æ”¶æ‰ä¹‹åï¼Œé˜»å¡é˜Ÿåˆ—ä¸­æ¥äº†ä¸€ä¸ªä»»åŠ¡ï¼Œè¿™æ ·å°±å½¢æˆäº†ç‰¹ä¾‹æƒ…å†µã€‚</p>]]></content>
    
    
    <summary type="html">ctlçº¿ç¨‹æ± äº”ç§çŠ¶æ€ çº¿ç¨‹å¦‚ä½•ä¿æ´»ã€å›æ”¶ æ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ—¶æŠ›äº†å¼‚å¸¸å¦‚æœç»§ç»­</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="JUC" scheme="https://wuwawawa.github.io/tags/JUC/"/>
    
  </entry>
  
  <entry>
    <title>NETWORK&amp;OS</title>
    <link href="https://wuwawawa.github.io/posts/8969a1d0.html"/>
    <id>https://wuwawawa.github.io/posts/8969a1d0.html</id>
    <published>2024-03-07T08:08:19.000Z</published>
    <updated>2024-04-25T03:39:49.625Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç½‘ç»œç³»ç»Ÿ"><a href="#ç½‘ç»œç³»ç»Ÿ" class="headerlink" title="ç½‘ç»œç³»ç»Ÿ"></a>ç½‘ç»œç³»ç»Ÿ</h2><p>neetyåŸç†</p><p>Nettyæ˜¯ä¸€ä¸ªåŸºäºJava NIOçš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œå®ƒé€šè¿‡ä½¿ç”¨å¤šè·¯å¤ç”¨ã€äº‹ä»¶é©±åŠ¨å’Œå¼‚æ­¥I/Oæ¥æé«˜ç½‘ç»œåº”ç”¨ç¨‹åºçš„ç½‘ç»œæ€§èƒ½ã€‚</p><p>Nettyä¸­æœ‰ä¸¤ç§ç±»å‹çš„çº¿ç¨‹ï¼šBossçº¿ç¨‹å’ŒWorkerçº¿ç¨‹ã€‚</p><p>Bossçº¿ç¨‹ç”¨äºç›‘å¬å¹¶æ¥å—æ–°çš„å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ï¼Œå¹¶å°†å…¶åˆ†é…ç»™Workerçº¿ç¨‹å¤„ç†ã€‚</p><p>Workerçº¿ç¨‹åˆ™è´Ÿè´£å¤„ç†ä¸å®¢æˆ·ç«¯çš„æ•°æ®é€šä¿¡ï¼Œåœ¨Nettyä¸­ï¼Œæ¯ä¸ªWorkerçº¿ç¨‹éƒ½æœ‰å…¶è‡ªå·±çš„EventLoopï¼Œç”¨äºå¤„ç†è¿æ¥åˆ°è¯¥Workerçº¿ç¨‹çš„æ‰€æœ‰å®¢æˆ·ç«¯ã€‚</p><p>å› æ­¤ï¼ŒBossçº¿ç¨‹ä¸“é—¨ç”¨äºå®¢æˆ·ç«¯è¿æ¥ç®¡ç†ï¼Œè€ŒWorkerçº¿ç¨‹åˆ™ç”¨äºå®¢æˆ·ç«¯æ•°æ®å¤„ç†ã€‚</p><p>è¿™æ ·çš„è®¾è®¡å¯ä»¥æé«˜ç½‘ç»œåº”ç”¨ç¨‹åºçš„ååé‡ï¼Œå¹¶ä¸”å¯ä»¥æœ‰æ•ˆåœ°åˆ©ç”¨å¤šæ ¸ç³»ç»Ÿçš„èµ„æºã€‚</p><details class="folding-tag" cyan close><summary> IOå¤šè·¯å¤ç”¨ </summary>              <div class='content'>              <p><mark class="hl-label blue">select/poll</mark> </p><p>select å®ç°å¤šè·¯å¤ç”¨çš„æ–¹å¼æ˜¯ï¼Œå°†å·²è¿æ¥çš„ Socket éƒ½æ”¾åˆ°ä¸€ä¸ª<strong>æ–‡ä»¶æè¿°ç¬¦é›†åˆ</strong>ï¼Œç„¶åè°ƒç”¨ select å‡½æ•°å°†æ–‡ä»¶æè¿°ç¬¦é›†åˆ<strong>æ‹·è´</strong>åˆ°å†…æ ¸é‡Œï¼Œè®©å†…æ ¸æ¥æ£€æŸ¥æ˜¯å¦æœ‰ç½‘ç»œäº‹ä»¶äº§ç”Ÿï¼Œæ£€æŸ¥çš„æ–¹å¼å¾ˆç²—æš´ï¼Œå°±æ˜¯é€šè¿‡<strong>éå†</strong>æ–‡ä»¶æè¿°ç¬¦é›†åˆçš„æ–¹å¼ï¼Œå½“æ£€æŸ¥åˆ°æœ‰äº‹ä»¶äº§ç”Ÿåï¼Œå°†æ­¤ Socket æ ‡è®°ä¸ºå¯è¯»æˆ–å¯å†™ï¼Œ æ¥ç€å†æŠŠæ•´ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†åˆ<strong>æ‹·è´</strong>å›ç”¨æˆ·æ€é‡Œï¼Œç„¶åç”¨æˆ·æ€è¿˜éœ€è¦å†é€šè¿‡<strong>éå†</strong>çš„æ–¹æ³•æ‰¾åˆ°å¯è¯»æˆ–å¯å†™çš„ Socketï¼Œç„¶åå†å¯¹å…¶å¤„ç†ã€‚</p><p><mark class="hl-label green">epoll</mark> </p><p>epoll åœ¨å†…æ ¸é‡Œä½¿ç”¨<strong>çº¢é»‘æ ‘æ¥è·Ÿè¸ªè¿›ç¨‹æ‰€æœ‰å¾…æ£€æµ‹çš„æ–‡ä»¶æè¿°å­—</strong>ï¼ŒæŠŠéœ€è¦ç›‘æ§çš„ socket é€šè¿‡ <code>epoll_ctl()</code> å‡½æ•°åŠ å…¥å†…æ ¸ä¸­çš„çº¢é»‘æ ‘é‡Œã€‚</p><p>epoll ä½¿ç”¨<strong>äº‹ä»¶é©±åŠ¨</strong>çš„æœºåˆ¶ï¼Œå†…æ ¸é‡Œ<strong>ç»´æŠ¤äº†ä¸€ä¸ªé“¾è¡¨æ¥è®°å½•å°±ç»ªäº‹ä»¶</strong>ï¼Œå½“æŸä¸ª socket æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œé€šè¿‡<strong>å›è°ƒå‡½æ•°</strong>å†…æ ¸ä¼šå°†å…¶åŠ å…¥åˆ°è¿™ä¸ªå°±ç»ªäº‹ä»¶åˆ—è¡¨ä¸­ï¼Œå½“ç”¨æˆ·è°ƒç”¨ <code>epoll_wait()</code> å‡½æ•°æ—¶ï¼Œåªä¼šè¿”å›æœ‰äº‹ä»¶å‘ç”Ÿçš„æ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°ï¼Œä¸éœ€è¦åƒ select/poll é‚£æ ·è½®è¯¢æ‰«ææ•´ä¸ª socket é›†åˆï¼Œå¤§å¤§æé«˜äº†æ£€æµ‹çš„æ•ˆç‡ã€‚</p>              </div>            </details><hr><h2 id="é›¶æ‹·è´"><a href="#é›¶æ‹·è´" class="headerlink" title="é›¶æ‹·è´"></a>é›¶æ‹·è´</h2><h3 id="ä¼ ç»Ÿçš„æ–‡ä»¶ä¼ è¾“"><a href="#ä¼ ç»Ÿçš„æ–‡ä»¶ä¼ è¾“" class="headerlink" title="ä¼ ç»Ÿçš„æ–‡ä»¶ä¼ è¾“"></a>ä¼ ç»Ÿçš„æ–‡ä»¶ä¼ è¾“</h3><p>ç”¨æˆ·è¿›ç¨‹è°ƒç”¨ read æ–¹æ³•ï¼Œå‘æ“ä½œç³»ç»Ÿå‘å‡º I/O è¯·æ±‚ï¼Œè¯·æ±‚è¯»å–æ•°æ®åˆ°è‡ªå·±çš„å†…å­˜ç¼“å†²åŒºä¸­ï¼Œä»ç”¨æˆ·æ€åˆ‡æ¢è‡³å†…æ ¸æ€ï¼Œè¿›ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼›</p><p>â‘  DMA å°†ç£ç›˜ä¸­çš„æ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºä¸­ï¼Œæ­¤æ—¶ä¸å ç”¨ CPUï¼ŒCPU å¯ä»¥æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚</p><p>â‘¡ CPU æ”¶åˆ° DMA çš„ä¿¡å·ï¼ŒçŸ¥é“æ•°æ®å·²ç»å‡†å¤‡å¥½ï¼Œäºæ˜¯å°†æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç³»ç»Ÿè°ƒç”¨è¿”å›ï¼Œä»å†…æ ¸æ€æ€åˆ‡æ¢è‡³ç”¨æˆ·æ€ã€‚</p><p> ç”¨æˆ·è¿›ç¨‹è°ƒç”¨ read æ–¹æ³•ï¼Œå‘æ“ä½œç³»ç»Ÿå‘å‡º I/O è¯·æ±‚ï¼Œä»ç”¨æˆ·æ€åˆ‡æ¢è‡³å†…æ ¸æ€ã€‚</p><p>â‘¢ CPUå°†ç”¨æˆ·çš„ç¼“å†²åŒºé‡Œçš„æ•°æ®å†æ‹·è´åˆ°å†…æ ¸çš„ socket çš„ç¼“å†²åŒºé‡Œã€‚</p><p>â‘£ DMAæŠŠå†…æ ¸çš„ socket ç¼“å†²åŒºé‡Œçš„æ•°æ®ï¼Œæ‹·è´åˆ°ç½‘å¡çš„ç¼“å†²åŒºé‡Œã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E4%BC%A0%E7%BB%9F%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93.png" alt="img" style="zoom:50%;" /></p><hr><h3 id="mmap-write"><a href="#mmap-write" class="headerlink" title="mmap + write"></a>mmap + write</h3><p><code>read()</code> ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹ä¸­ä¼šæŠŠå†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·çš„ç¼“å†²åŒºé‡Œï¼Œäºæ˜¯ä¸ºäº†å‡å°‘è¿™ä¸€æ­¥å¼€é”€ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <code>mmap()</code> æ›¿æ¢ <code>read()</code> ç³»ç»Ÿè°ƒç”¨å‡½æ•°ã€‚</p><p><code>mmap()</code> ç³»ç»Ÿè°ƒç”¨å‡½æ•°ä¼šç›´æ¥æŠŠå†…æ ¸ç¼“å†²åŒºé‡Œçš„æ•°æ®ã€Œ<strong>æ˜ å°„</strong>ã€åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè¿™æ ·ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¸ç”¨æˆ·ç©ºé—´å°±ä¸éœ€è¦å†è¿›è¡Œä»»ä½•çš„æ•°æ®æ‹·è´æ“ä½œã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/20240310155250.png" alt="img" style="zoom:50%;" /></p><p>å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>åº”ç”¨è¿›ç¨‹è°ƒç”¨äº† <code>mmap()</code> åï¼ŒDMA ä¼šæŠŠç£ç›˜çš„æ•°æ®æ‹·è´åˆ°å†…æ ¸çš„ç¼“å†²åŒºé‡Œã€‚æ¥ç€ï¼Œåº”ç”¨è¿›ç¨‹è·Ÿæ“ä½œç³»ç»Ÿå†…æ ¸ã€Œå…±äº«ã€è¿™ä¸ªç¼“å†²åŒºï¼›</li><li>åº”ç”¨è¿›ç¨‹å†è°ƒç”¨ <code>write()</code>ï¼Œæ“ä½œç³»ç»Ÿç›´æ¥å°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºä¸­ï¼Œè¿™ä¸€åˆ‡éƒ½å‘ç”Ÿåœ¨å†…æ ¸æ€ï¼Œç”± CPU æ¥æ¬è¿æ•°æ®ï¼›</li><li>æœ€åï¼ŒæŠŠå†…æ ¸çš„ socket ç¼“å†²åŒºé‡Œçš„æ•°æ®ï¼Œæ‹·è´åˆ°ç½‘å¡çš„ç¼“å†²åŒºé‡Œï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯ç”± DMA æ¬è¿çš„ã€‚</li></ul><p>æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œé€šè¿‡ä½¿ç”¨ <code>mmap()</code> æ¥ä»£æ›¿ <code>read()</code>ï¼Œ å¯ä»¥å‡å°‘ä¸€æ¬¡æ•°æ®æ‹·è´çš„è¿‡ç¨‹ã€‚</p><p>ä½†è¿™è¿˜ä¸æ˜¯æœ€ç†æƒ³çš„é›¶æ‹·è´ï¼Œå› ä¸ºä»ç„¶éœ€è¦é€šè¿‡ CPU æŠŠå†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºé‡Œï¼Œè€Œä¸”ä»ç„¶éœ€è¦ 4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå› ä¸ºç³»ç»Ÿè°ƒç”¨è¿˜æ˜¯ 2 æ¬¡ã€‚</p><hr><h3 id="sendfile"><a href="#sendfile" class="headerlink" title="sendfile"></a>sendfile</h3><p>åœ¨ Linux å†…æ ¸ç‰ˆæœ¬ 2.1 ä¸­ï¼Œæä¾›äº†ä¸€ä¸ªä¸“é—¨å‘é€æ–‡ä»¶çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•° <code>sendfile()</code></p><p>å®ƒå¯ä»¥æ›¿ä»£å‰é¢çš„ <code>read()</code> å’Œ <code>write()</code> è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå°±å‡å°‘äº† 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ã€‚</p><p>è¯¥ç³»ç»Ÿè°ƒç”¨ï¼Œå¯ä»¥ç›´æ¥æŠŠå†…æ ¸ç¼“å†²åŒºé‡Œçš„æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºé‡Œï¼Œä¸å†æ‹·è´åˆ°ç”¨æˆ·æ€ï¼Œè¿™æ ·å°±åªæœ‰ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå’Œ 3 æ¬¡æ•°æ®æ‹·è´ã€‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/senfile-3%E6%AC%A1%E6%8B%B7%E8%B4%9D.png" alt="img" style="zoom:50%;" /></p><hr><h3 id="SG-DMA"><a href="#SG-DMA" class="headerlink" title="SG-DMA"></a>SG-DMA</h3><p>ä» Linux å†…æ ¸ <code>2.4</code> ç‰ˆæœ¬å¼€å§‹èµ·ï¼Œå¯¹äºæ”¯æŒç½‘å¡æ”¯æŒ SG-DMA æŠ€æœ¯çš„æƒ…å†µä¸‹ï¼Œ <code>sendfile()</code> ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹å‘ç”Ÿäº†ç‚¹å˜åŒ–ï¼Œå…·ä½“è¿‡ç¨‹å¦‚ä¸‹</p><ul><li>ç¬¬ä¸€æ­¥ï¼Œé€šè¿‡ DMA å°†ç£ç›˜ä¸Šçš„æ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºé‡Œï¼›</li><li>ç¬¬äºŒæ­¥ï¼Œç¼“å†²åŒºæè¿°ç¬¦å’Œæ•°æ®é•¿åº¦ä¼ åˆ° socket ç¼“å†²åŒºï¼Œè¿™æ ·ç½‘å¡çš„ SG-DMA æ§åˆ¶å™¨å°±å¯ä»¥ç›´æ¥å°†å†…æ ¸ç¼“å­˜ä¸­çš„æ•°æ®æ‹·è´åˆ°ç½‘å¡çš„ç¼“å†²åŒºé‡Œï¼Œæ­¤è¿‡ç¨‹ä¸éœ€è¦å°†æ•°æ®ä»æ“ä½œç³»ç»Ÿå†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ° socket ç¼“å†²åŒºä¸­ï¼Œè¿™æ ·å°±å‡å°‘äº†ä¸€æ¬¡æ•°æ®æ‹·è´ï¼›</li></ul><p>æ‰€ä»¥ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹‹ä¸­ï¼Œåªè¿›è¡Œäº† 2 æ¬¡æ•°æ®æ‹·è´ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/senfile-%E9%9B%B6%E6%8B%B7%E8%B4%9D.png" alt="img" style="zoom:50%;" /></p><p>é›¶æ‹·è´æŠ€æœ¯çš„æ–‡ä»¶ä¼ è¾“æ–¹å¼ç›¸æ¯”ä¼ ç»Ÿæ–‡ä»¶ä¼ è¾“çš„æ–¹å¼ï¼Œå‡å°‘äº† 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ•°æ®æ‹·è´æ¬¡æ•°ï¼Œ<strong>åªéœ€è¦ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ•°æ®æ‹·è´æ¬¡æ•°ï¼Œå°±å¯ä»¥å®Œæˆæ–‡ä»¶çš„ä¼ è¾“ï¼Œè€Œä¸” 2 æ¬¡çš„æ•°æ®æ‹·è´è¿‡ç¨‹ï¼Œéƒ½ä¸éœ€è¦é€šè¿‡ CPUï¼Œ2 æ¬¡éƒ½æ˜¯ç”± DMA æ¥æ¬è¿ã€‚</strong></p><h2 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h2><p><a href="https://www.xiaolincoding.com/network/3_tcp/tcp_interview.html">å°æ—TCP</a></p><hr><details class="folding-tag" cyan close><summary> é”®å…¥ç½‘å€åˆ°ç½‘é¡µæ˜¾ç¤ºï¼ŒæœŸé—´å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ </summary>              <div class='content'>              <ol><li><p>HTTP</p><p>è§£æURL åè®® + WebæœåŠ¡å™¨ + èµ„æºå ç”Ÿæˆ HTTP è¯·æ±‚æ¶ˆæ¯</p></li><li><p>DNS åŸŸåè§£æ å°†åŸŸåè§£ææˆIPåœ°å€</p><p>å„çº§ç¼“å­˜ -&gt; æœ¬åœ°DNSæœåŠ¡å™¨ -&gt; æ ¹åŸŸåæœåŠ¡å™¨ -&gt; é¡¶çº§åŸŸåæœåŠ¡å™¨ -&gt; æƒå¨åŸŸåæœåŠ¡å™¨</p></li><li><p>å„çº§åè®®æ ˆ</p><p>TCP ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ å¯é ä¼ è¾“</p><p>IP å¡«å†™æºåœ°å€ IP å’Œ ç›®æ ‡åœ°å€ IP</p><p>ARP å¹¿æ’­å¯»æ‰¾ç›®æ ‡MACåœ°å€</p></li><li><p>è®¾å¤‡é—´ä¼ è¾“<br>ç½‘å¡ -&gt; äº¤æ¢æœº -&gt; è·¯ç”±å™¨ -&gt; æœåŠ¡å™¨</p></li><li><p>åè®®åè§£æ</p></li><li><p>æœåŠ¡å™¨è¿”å› html + css + javascript</p></li><li><p>æµè§ˆå™¨æ¸²æŸ“ç½‘é¡µ</p></li><li><p>TCPå››æ¬¡æŒ¥æ‰‹æ–­å¼€è¿æ¥</p></li></ol>              </div>            </details><hr>]]></content>
    
    
    <summary type="html">è®¡ç®—æœºç½‘ç»œ&amp;æ“ä½œç³»ç»Ÿ</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="é¢è¯•é¢˜" scheme="https://wuwawawa.github.io/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    
  </entry>
  
  <entry>
    <title>Mysql&amp;Redis&amp;RocketMQé¢è¯•é¢˜</title>
    <link href="https://wuwawawa.github.io/posts/a257a413.html"/>
    <id>https://wuwawawa.github.io/posts/a257a413.html</id>
    <published>2024-03-05T06:56:47.000Z</published>
    <updated>2024-04-11T12:01:20.507Z</updated>
    
    <content type="html"><![CDATA[<details class="folding-tag" cyan close><summary> SQLè¯­å¥åœ¨MySQLä¸­çš„æ‰§è¡Œè¿‡ç¨‹ </summary>              <div class='content'>              <p>1.è¿æ¥å±‚ TCPä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ æ ¡éªŒç”¨æˆ·åå¯†ç  è¯»å–æƒé™</p><p>2.æœåŠ¡å±‚ ç¼“å­˜æŸ¥è¯¢ã€Sqlåˆ†æä¸ä¼˜åŒ–ï¼ˆèµ°ä»€ä¹ˆç´¢å¼•ï¼‰ã€ç”Ÿæˆæ‰§è¡Œè®¡åˆ’</p><p>3.å¼•æ“å±‚ çœŸæ­£çš„è´Ÿè´£äº†MySQLä¸­æ•°æ®çš„å­˜å‚¨å’Œæå–(æ—¥å¿—)</p>              </div>            </details><hr><h2 id="Mysqlç´¢å¼•"><a href="#Mysqlç´¢å¼•" class="headerlink" title="Mysqlç´¢å¼•"></a>Mysqlç´¢å¼•</h2><blockquote><p>ç´¢å¼•ä¼˜åŒ–</p></blockquote><p><a href="https://piaohua.github.io/post/mysql/20230627-index/">https://piaohua.github.io/post/mysql/20230627-index/</a></p><details class="folding-tag" cyan close><summary> ç´¢å¼•åŠå…¶ä¼˜ç¼ºç‚¹ </summary>              <div class='content'>              <p><mark class="hl-label green">ä¼˜ç‚¹</mark> </p><p>æé«˜æ•°æ®æ£€ç´¢çš„æ•ˆç‡ï¼Œé™ä½<code>æ•°æ®åº“çš„IOæˆæœ¬</code></p><p>å”¯ä¸€ç´¢å¼•ï¼Œå¯ä»¥ä¿è¯æ•°æ®åº“è¡¨ä¸­æ¯ä¸€è¡Œ<code>æ•°æ®çš„å”¯ä¸€æ€§</code></p><p>åŠ é€Ÿè¡¨å’Œè¡¨ä¹‹é—´çš„è¿æ¥ï¼Œå‡å°‘æŸ¥è¯¢ä¸­åˆ†ç»„å’Œæ’åºçš„æ—¶é—´</p><p><mark class="hl-label red">ç¼ºç‚¹</mark> </p><p>ç´¢å¼•éœ€è¦å <code>ç£ç›˜ç©ºé—´</code></p><p>åˆ›å»ºç´¢å¼•å’Œç»´æŠ¤ç´¢å¼•è¦<code>è€—è´¹æ—¶é—´</code></p><p>ç´¢å¼•å¤§å¤§æé«˜äº†æŸ¥è¯¢é€Ÿåº¦ï¼ŒåŒæ—¶å´ä¼š<code>é™ä½æ›´æ–°è¡¨çš„é€Ÿåº¦</code></p>              </div>            </details><hr><details class="folding-tag" blue close><summary> ç´¢å¼•å¤±æ•ˆåœºæ™¯ </summary>              <div class='content'>              <p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E5%9C%BA%E6%99%AF.png" alt="1ç´¢å¼•å¤±æ•ˆåœºæ™¯"></p><p><code>MySQL8.0ç‰ˆæœ¬</code>å¼€å§‹å¢åŠ äº†ç´¢å¼•è·³è·ƒæ‰«æçš„åŠŸèƒ½ï¼Œå½“ç¬¬ä¸€åˆ—ç´¢å¼•çš„å”¯ä¸€å€¼è¾ƒå°‘æ—¶ï¼Œå³ä½¿ where æ¡ä»¶æ²¡æœ‰ç¬¬ä¸€åˆ—ç´¢å¼•ï¼ŒæŸ¥è¯¢çš„æ—¶å€™ä¹Ÿå¯ä»¥ç”¨åˆ°è”åˆç´¢å¼•ã€‚æ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨çš„è”åˆç´¢å¼•æ˜¯ bcd ä½†æ˜¯ b ä¸­å­—æ®µæ¯”è¾ƒå°‘ æˆ‘ä»¬åœ¨ä½¿ç”¨è”åˆç´¢å¼•çš„æ—¶å€™æ²¡æœ‰ ä½¿ç”¨ b ä½†æ˜¯ä¾ç„¶å¯ä»¥ä½¿ç”¨è”åˆç´¢å¼• <strong>MySQL è”åˆç´¢å¼•æœ‰æ—¶å€™éµå¾ªæœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™ï¼Œæœ‰æ—¶å€™ä¸éµå¾ªã€‚</strong></p>              </div>            </details><hr><details class="folding-tag" yellow close><summary> ç´¢å¼•ä¸‹æ¨å’Œè¦†ç›–ç´¢å¼• </summary>              <div class='content'>              <p><mark class="hl-label green">ç´¢å¼•ä¸‹æ¨</mark> </p><p>ç´¢å¼•ä¸‹æ¨ï¼ˆIndex Condition Pushdownï¼‰å¯ä»¥åœ¨éèšç°‡ç´¢å¼•éå†è¿‡ç¨‹ä¸­ï¼Œå¯¹ç´¢å¼•ä¸­åŒ…å«çš„å­—æ®µå…ˆåšåˆ¤æ–­ï¼Œè¿‡æ»¤æ‰ä¸ç¬¦åˆæ¡ä»¶çš„è®°å½•ï¼Œå‡å°‘å›è¡¨æ¬¡æ•°ã€‚</p><p><mark class="hl-label blue">è¦†ç›–ç´¢å¼•</mark> </p><p>å¦‚æœä¸€ä¸ªç´¢å¼•åŒ…å«ï¼ˆæˆ–è€…è¯´è¦†ç›–ï¼‰æ‰€æœ‰éœ€è¦æŸ¥è¯¢çš„å­—æ®µçš„å€¼ï¼Œæˆ‘ä»¬å°±ç§°ä¹‹ä¸º è¦†ç›–ç´¢å¼•ã€‚</p>              </div>            </details><hr><details class="folding-tag" green close><summary> å“ªäº›æƒ…å†µé€‚åˆåˆ›å»ºç´¢å¼•ï¼Ÿå“ªäº›æƒ…å†µä¸é€‚åˆåˆ›å»ºç´¢å¼• </summary>              <div class='content'>              <p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1%E9%80%82%E5%90%88%E4%B8%8D%E9%80%82%E5%90%88%E7%B4%A2%E5%BC%95.png" alt="1é€‚åˆä¸é€‚åˆç´¢å¼•"></p>              </div>            </details><hr><details class="folding-tag" yellow close><summary> mysqlç´¢å¼•ä¸ºä»€ä¹ˆç”¨B+æ ‘ï¼Ÿ </summary>              <div class='content'>              <p>Hashç´¢å¼•ç­‰å€¼æŸ¥è¯¢æ•ˆç‡é«˜ï¼Œé¢å¯¹èŒƒå›´æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ä¼šé€€åŒ–ã€‚è€Œä¸”æ•°æ®çš„å­˜å‚¨æ˜¯<code>æ²¡æœ‰é¡ºåºçš„</code>ï¼Œåœ¨ ORDER BY çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Hash ç´¢å¼•è¿˜éœ€è¦å¯¹æ•°æ®é‡æ–°æ’åºã€‚å¯¹äºè”åˆç´¢å¼•çš„æƒ…å†µï¼ŒHash å€¼æ˜¯å°†è”åˆç´¢å¼•é”®åˆå¹¶åä¸€èµ·æ¥è®¡ç®—çš„ï¼Œæ— æ³•å¯¹å•ç‹¬çš„ä¸€ä¸ªé”®æˆ–è€…å‡ ä¸ªç´¢å¼•é”®è¿›è¡ŒæŸ¥è¯¢ã€‚</p><p>äºŒå‰æœç´¢æ ‘ ä¸å¹³è¡¡ çº¢é»‘æ ‘ æ ‘å¤ªé«˜  å¹³è¡¡äºŒå‰æ ‘ é€‰æ‹©è€—æ—¶</p><p>B+æ ‘æ˜¯å¹³è¡¡å’Œæœç´¢æ ‘çš„ç»“åˆã€‚ å¤šè·¯å¹³è¡¡</p><p>B+æ ‘æ•°æ®æŒ‰é¡ºåºæ’åˆ—ï¼Œå¯ä»¥ä½¿ç”¨ã€ŒäºŒåˆ†æŸ¥æ‰¾æ³•ã€é«˜æ•ˆå®šä½æ•°æ®ã€‚</p><p>B+æ ‘  vs Bæ ‘  </p><p>B+ æ ‘çš„éå¶å­èŠ‚ç‚¹ä¸å­˜æ”¾å®é™…çš„è®°å½•æ•°æ®ï¼Œä»…å­˜æ”¾ç´¢å¼•ã€‚</p><p>B+ æ ‘å¶å­èŠ‚ç‚¹ä¹‹é—´ç”¨é“¾è¡¨è¿æ¥äº†èµ·æ¥ï¼Œæœ‰åˆ©äºèŒƒå›´æŸ¥è¯¢ï¼Œè€Œ B æ ‘è¦å®ç°èŒƒå›´æŸ¥è¯¢ï¼Œå› æ­¤åªèƒ½é€šè¿‡æ ‘çš„éå†æ¥å®ŒæˆèŒƒå›´æŸ¥è¯¢</p><p>B+æ ‘ä¹Ÿæ˜¯å¤šè·¯å¹³è¡¡æŸ¥æ‰¾æ ‘ï¼Œå…¶ä¸Bæ ‘çš„åŒºåˆ«ä¸»è¦åœ¨äºï¼š</p><p>Bæ ‘ä¸­æ¯ä¸ªèŠ‚ç‚¹ï¼ˆåŒ…æ‹¬å¶èŠ‚ç‚¹å’Œéå¶èŠ‚ç‚¹ï¼‰éƒ½å­˜å‚¨çœŸå®çš„æ•°æ®ï¼ŒB+æ ‘ä¸­åªæœ‰å¶å­èŠ‚ç‚¹å­˜å‚¨çœŸå®çš„æ•°æ®ï¼Œéå¶èŠ‚ç‚¹åªå­˜å‚¨é”®ã€‚</p><p>Bæ ‘ä¸­ä¸€æ¡è®°å½•åªä¼šå‡ºç°ä¸€æ¬¡ï¼Œä¸ä¼šé‡å¤å‡ºç°ï¼Œè€Œ B+æ ‘çš„é”®åˆ™å¯èƒ½é‡å¤é‡ç° â€”â€”â€”-  ä¸€å®šä¼šåœ¨å¶èŠ‚ç‚¹å‡ºç°ï¼Œä¹Ÿå¯èƒ½åœ¨éå¶èŠ‚ç‚¹é‡å¤å‡ºç°ã€‚</p><p>B+æ ‘çš„å¶èŠ‚ç‚¹ä¹‹é—´é€šè¿‡åŒå‘é“¾è¡¨é“¾æ¥ã€‚</p><p>Bæ ‘ä¸­çš„éå¶èŠ‚ç‚¹ï¼Œè®°å½•æ•°æ¯”å­èŠ‚ç‚¹ä¸ªæ•°å°‘1ï¼›è€Œ B+æ ‘ä¸­è®°å½•æ•°ä¸å­èŠ‚ç‚¹ä¸ªæ•°ç›¸åŒã€‚</p><p>æ›´å°‘çš„IOæ¬¡æ•°</p><p>æ›´é€‚ç”¨äºèŒƒå›´æŸ¥è¯¢</p><p>æ›´ç¨³å®šçš„æŸ¥è¯¢æ•ˆç‡</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240321164535531.png" alt="image-20240321164535531" style="zoom:33%;" /></p>              </div>            </details><hr><details class="folding-tag" cyan close><summary> count(1)ã€ count(*)ã€ count(ä¸»é”®å­—æ®µ) </summary>              <div class='content'>              <p>count(1)ã€ count(*)ã€ count(ä¸»é”®å­—æ®µ)åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œå¦‚æœè¡¨é‡Œå­˜åœ¨äºŒçº§ç´¢å¼•ï¼Œä¼˜åŒ–å™¨å°±ä¼šé€‰æ‹©äºŒçº§ç´¢å¼•è¿›è¡Œæ‰«æã€‚</p><p>æ‰€ä»¥ï¼Œå¦‚æœè¦æ‰§è¡Œ count(1)ã€ count(*)ã€ count(ä¸»é”®å­—æ®µ) æ—¶ï¼Œå°½é‡åœ¨æ•°æ®è¡¨ä¸Šå»ºç«‹äºŒçº§ç´¢å¼•ï¼Œè¿™æ ·ä¼˜åŒ–å™¨ä¼šè‡ªåŠ¨é‡‡ç”¨ key_len æœ€å°çš„äºŒçº§ç´¢å¼•è¿›è¡Œæ‰«æï¼Œç›¸æ¯”äºæ‰«æä¸»é”®ç´¢å¼•æ•ˆç‡ä¼šé«˜ä¸€äº›ã€‚</p><p>å†æ¥ï¼Œå°±æ˜¯ä¸è¦ä½¿ç”¨ count(å­—æ®µ) æ¥ç»Ÿè®¡è®°å½•ä¸ªæ•°ï¼Œå› ä¸ºå®ƒçš„æ•ˆç‡æ˜¯æœ€å·®çš„ï¼Œä¼šé‡‡ç”¨å…¨è¡¨æ‰«æçš„æ–¹å¼æ¥ç»Ÿè®¡ã€‚å¦‚æœä½ éè¦ç»Ÿè®¡è¡¨ä¸­è¯¥å­—æ®µä¸ä¸º NULL çš„è®°å½•ä¸ªæ•°ï¼Œå»ºè®®ç»™è¿™ä¸ªå­—æ®µå»ºç«‹ä¸€ä¸ªäºŒçº§ç´¢å¼•ã€‚</p>              </div>            </details><hr><details class="folding-tag" green close><summary> Mysqlæ·±åˆ†é¡µå¦‚ä½•è§£å†³ </summary>              <div class='content'>              <p>ä¸¾ä¸€ä¸ªç®€å•çš„Sqlä¾‹å­</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,name <span class="keyword">from</span> detail <span class="keyword">where</span> create_time <span class="operator">&gt;</span> <span class="string">&#x27;2022-06-13 00:00&#x27;</span> limit <span class="number">100000</span>,<span class="number">10</span>;</span><br></pre></td></tr></table></figure><p><mark class="hl-label blue">æŸ¥è¯¢è¿‡ç¨‹</mark> </p><p>1.å‡è®¾æˆ‘ä»¬çš„<code>create_time</code>æ˜¯ä¸€ä¸ªäºŒçº§ç´¢å¼•ï¼Œæˆ‘ä»¬å…ˆè¦æ‰¾åˆ°æ‰€æœ‰æ»¡è¶³è®°å½•çš„æ¡ä»¶ï¼Œæ‹¿åˆ°äº†éèšç°‡ç´¢å¼•ä¸Šè®°å½•çš„ä¸»é”®idã€‚</p><p>2.åˆ°èšç°‡ç´¢å¼•è¿›è¡Œå›è¡¨ï¼ŒæŸ¥è¯¢æ•°æ®ã€‚</p><p>3.æ‰«ææˆ‘ä»¬è¦æŸ¥è¯¢çš„limitæ•°æ®ï¼Œä»0å¼€å§‹ä¸æ–­æ‰«æã€‚æœ€åæŠ›å¼ƒå‰100000æ¡ã€‚</p><p>åŸå› ï¼š</p><p>1.limitè¦æ‰«æ100010æ¡æ•°æ®ï¼Œå¹¶ä¸”è¿›è¡Œä¸¢å¼ƒã€‚</p><p>2.æ‰«ææ›´å¤šæ•°æ®ä¹Ÿæ„å‘³ç€å›è¡¨æ•°æ®æ›´å¤šã€‚</p><p><mark class="hl-label green">ä¼˜åŒ–æ–¹æ³•</mark> </p><p>1.å­æŸ¥è¯¢ä¼˜åŒ–</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,name <span class="keyword">from</span> detail <span class="keyword">where</span> id <span class="operator">&gt;=</span> (<span class="keyword">select</span> a.id <span class="keyword">from</span> detail a <span class="keyword">where</span> a.create_time <span class="operator">&gt;</span> <span class="string">&#x27;2022-06-13 00:00&#x27;</span> limit <span class="number">100000</span>,<span class="number">1</span>) limit <span class="number">10</span>;</span><br></pre></td></tr></table></figure><p>2.åç§»æ³• è¦çŸ¥é“ä¸Šæ¬¡æŸ¥è¯¢çš„idï¼Œå¹¶ä¸”idè‡ªå¢</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id, name <span class="keyword">from</span> detail <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">100000</span> <span class="keyword">order</span> <span class="keyword">by</span> id limit <span class="number">10</span>ï¼›</span><br></pre></td></tr></table></figure>              </div>            </details><hr><h2 id="Mysqläº‹åŠ¡"><a href="#Mysqläº‹åŠ¡" class="headerlink" title="Mysqläº‹åŠ¡"></a>Mysqläº‹åŠ¡</h2><details class="folding-tag" cyan close><summary> äº‹åŠ¡çš„ACIDç‰¹æ€§ </summary>              <div class='content'>              <p>Atomicity åŸå­æ€§ äº‹åŠ¡æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ï¼Œè¦ä¹ˆå…¨éƒ¨æäº¤ï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥å›æ»šã€‚</p><p>Consistency ä¸€è‡´æ€§ äº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®ä»ä¸€ä¸ª<code>åˆæ³•æ€§çŠ¶æ€</code>å˜æ¢åˆ°å¦å¤–ä¸€ä¸ª<code>åˆæ³•æ€§çŠ¶æ€</code>ã€‚</p><p>Isolation éš”ç¦»æ€§ ä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œ<code>ä¸èƒ½è¢«å…¶ä»–äº‹åŠ¡å¹²æ‰°</code>ï¼Œå³ä¸€ä¸ªäº‹åŠ¡å†…éƒ¨çš„æ“ä½œåŠä½¿ç”¨çš„æ•°æ®å¯¹<code>å¹¶å‘</code>çš„å…¶ä»–äº‹åŠ¡æ˜¯éš”ç¦»çš„ï¼Œå¹¶å‘æ‰§è¡Œçš„å„ä¸ªäº‹åŠ¡ä¹‹é—´ä¸èƒ½ç›¸äº’å¹²æ‰°ã€‚</p><p>Durability æŒä¹…æ€§ ä¸€ä¸ªäº‹åŠ¡ä¸€æ—¦è¢«æäº¤ï¼Œå®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜å°±æ˜¯ æ°¸ä¹…æ€§çš„ã€‚</p><ul><li>æŒä¹…æ€§æ˜¯é€šè¿‡ redo log ï¼ˆé‡åšæ—¥å¿—ï¼‰æ¥ä¿è¯çš„ï¼›</li><li>åŸå­æ€§æ˜¯é€šè¿‡ undo logï¼ˆå›æ»šæ—¥å¿—ï¼‰ æ¥ä¿è¯çš„ï¼›</li><li>éš”ç¦»æ€§æ˜¯é€šè¿‡ MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ æˆ–é”æœºåˆ¶æ¥ä¿è¯çš„ï¼›</li><li>ä¸€è‡´æ€§åˆ™æ˜¯é€šè¿‡æŒä¹…æ€§+åŸå­æ€§+éš”ç¦»æ€§æ¥ä¿è¯ï¼›</li></ul>              </div>            </details><hr><details class="folding-tag" green close><summary> æ•°æ®å¹¶å‘é—®é¢˜å’Œäº‹åŠ¡éš”ç¦»çº§åˆ« </summary>              <div class='content'>              <p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240306124025555.png" alt="image-20240306124025555"></p><p>å¹»è¯»å¼ºè°ƒçš„æ˜¯ä¸€ä¸ªäº‹åŠ¡æŒ‰ç…§æŸä¸ªç›¸åŒæ¡ä»¶å¤šæ¬¡è¯»å–è®°å½•æ—¶ï¼Œåè¯»å–æ—¶è¯»åˆ°äº†ä¹‹å‰æ²¡æœ‰è¯»åˆ°çš„è®°å½•ã€‚</p>              </div>            </details><hr><details class="folding-tag" green close><summary> InnoDBå­˜å‚¨å¼•æ“å¯¹MVCCçš„å®ç° </summary>              <div class='content'>              <p>MVCC æ˜¯ä¸€ç§å¹¶å‘æ§åˆ¶æœºåˆ¶ï¼Œç”¨äºåœ¨å¤šä¸ªå¹¶å‘äº‹åŠ¡åŒæ—¶è¯»å†™æ•°æ®åº“æ—¶ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§å’Œéš”ç¦»æ€§ã€‚å®ƒæ˜¯é€šè¿‡åœ¨æ¯ä¸ªæ•°æ®è¡Œä¸Šç»´æŠ¤å¤šä¸ªç‰ˆæœ¬çš„æ•°æ®æ¥å®ç°çš„ã€‚å½“ä¸€ä¸ªäº‹åŠ¡è¦å¯¹æ•°æ®åº“ä¸­çš„æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶ï¼ŒMVCC ä¼šä¸ºè¯¥äº‹åŠ¡åˆ›å»ºä¸€ä¸ªæ•°æ®å¿«ç…§ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¿®æ”¹å®é™…çš„æ•°æ®è¡Œã€‚</p><p><mark class="hl-label green">MVCCæ•´ä½“æ“ä½œæµç¨‹</mark> </p><ol><li>é¦–å…ˆè·å–äº‹åŠ¡è‡ªå·±çš„ç‰ˆæœ¬å·ï¼Œä¹Ÿå°±æ˜¯äº‹åŠ¡ IDï¼›</li><li>è·å– ReadViewï¼›</li><li>æŸ¥è¯¢å¾—åˆ°çš„æ•°æ®ï¼Œç„¶åä¸ ReadView ä¸­çš„äº‹åŠ¡ç‰ˆæœ¬å·è¿›è¡Œæ¯”è¾ƒï¼›</li><li>å¦‚æœä¸ç¬¦åˆ ReadView è§„åˆ™ï¼Œå°±éœ€è¦ä» Undo Log ä¸­è·å–å†å²å¿«ç…§ï¼›</li><li>æœ€åè¿”å›ç¬¦åˆè§„åˆ™çš„æ•°æ®ã€‚</li></ol><p>ä½¿ç”¨<code>READ COMMITTED</code>éš”ç¦»çº§åˆ«çš„äº‹åŠ¡åœ¨æ¯æ¬¡æŸ¥è¯¢å¼€å§‹æ—¶éƒ½ä¼šç”Ÿæˆä¸€ä¸ªç‹¬ç«‹çš„ReadView</p><p>ä½¿ç”¨<code>REPEATABLE READ</code>éš”ç¦»çº§åˆ«çš„äº‹åŠ¡æ¥è¯´ï¼Œåªä¼šåœ¨ç¬¬ä¸€æ¬¡æ‰§è¡ŒæŸ¥è¯¢è¯­å¥æ—¶ç”Ÿæˆä¸€ä¸ª<code>ReadView</code>ï¼Œä¹‹åçš„æŸ¥è¯¢å°±ä¸ä¼šé‡å¤ç”Ÿæˆäº†ã€‚</p>              </div>            </details><hr><details class="folding-tag" yellow close><summary> MVCCå’ŒNext-key Lockæ˜¯å¦‚ä½•åœ¨RRçº§åˆ«ä¸‹é˜²æ­¢å¹»è¯»çš„ï¼Ÿ </summary>              <div class='content'>              <p><mark class="hl-label blue">æ‰§è¡Œæ™®é€šselectï¼Œæ­¤æ—¶ä¼šä»¥MVCCå¿«ç…§è¯»çš„æ–¹å¼è¯»å–æ•°æ®</mark> </p><p>åœ¨å¿«ç…§è¯»çš„æƒ…å†µä¸‹ï¼ŒRR éš”ç¦»çº§åˆ«åªä¼šåœ¨äº‹åŠ¡å¼€å¯åçš„ç¬¬ä¸€æ¬¡æŸ¥è¯¢ç”Ÿæˆ <code>Read View</code> ï¼Œå¹¶ä½¿ç”¨è‡³äº‹åŠ¡æäº¤ã€‚æ‰€ä»¥åœ¨ç”Ÿæˆ <code>Read View</code> ä¹‹åå…¶å®ƒäº‹åŠ¡æ‰€åšçš„æ›´æ–°ã€æ’å…¥è®°å½•ç‰ˆæœ¬å¯¹å½“å‰äº‹åŠ¡å¹¶ä¸å¯è§ï¼Œå®ç°äº†å¯é‡å¤è¯»å’Œé˜²æ­¢å¿«ç…§è¯»ä¸‹çš„ â€œå¹»è¯»â€ã€‚</p><p><mark class="hl-label green">æ‰§è¡Œinsertã€updateã€deleteç­‰å½“å‰è¯»</mark> </p><p>MySQL é‡Œé™¤äº†æ™®é€šæŸ¥è¯¢æ˜¯å¿«ç…§è¯»ï¼Œå…¶ä»–éƒ½æ˜¯<strong>å½“å‰è¯»</strong>ï¼Œæ¯”å¦‚ updateã€insertã€deleteã€selectâ€¦for updateï¼Œè¿™äº›è¯­å¥æ‰§è¡Œå‰éƒ½ä¼šæŸ¥è¯¢æœ€æ–°ç‰ˆæœ¬çš„æ•°æ®ï¼Œç„¶åå†åšè¿›ä¸€æ­¥çš„æ“ä½œã€‚</p><p>åœ¨å½“å‰è¯»ä¸‹ï¼Œè¯»å–çš„éƒ½æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œå¦‚æœå…¶å®ƒäº‹åŠ¡æœ‰æ’å…¥æ–°çš„è®°å½•ï¼Œå¹¶ä¸”åˆšå¥½åœ¨å½“å‰äº‹åŠ¡æŸ¥è¯¢èŒƒå›´å†…ï¼Œå°±ä¼šäº§ç”Ÿå¹»è¯»ï¼<code>InnoDB</code> ä½¿ç”¨<code>Next-key Lock</code>ï¼ˆè®°å½•é”+é—´éš™é”ï¼‰æ¥é˜²æ­¢è¿™ç§æƒ…å†µã€‚å½“æ‰§è¡Œå½“å‰è¯»æ—¶ï¼Œä¼šé”å®šè¯»å–åˆ°çš„è®°å½•çš„åŒæ—¶ï¼Œé”å®šå®ƒä»¬çš„é—´éš™ï¼Œé˜²æ­¢å…¶å®ƒäº‹åŠ¡åœ¨æŸ¥è¯¢èŒƒå›´å†…æ’å…¥æ•°æ®ã€‚åªè¦æˆ‘ä¸è®©ä½ æ’å…¥ï¼Œå°±ä¸ä¼šå‘ç”Ÿå¹»è¯»ã€‚</p><p>ä½†æŸäº›æƒ…å†µä¸‹è¿˜æ˜¯ä¼šå‘ç”Ÿå¹»è¯»ã€‚</p><p><a href="https://xiaolincoding.com/mysql/transaction/phantom.html#%E5%B9%BB%E8%AF%BB%E8%A2%AB%E5%AE%8C%E5%85%A8%E8%A7%A3%E5%86%B3%E4%BA%86%E5%90%97">å¹»è¯»è¢«å®Œå…¨è§£å†³äº†å˜›ï¼Ÿ</a>   </p><p>MySQL å¯é‡å¤è¯»éš”ç¦»çº§åˆ«å¹¶æ²¡æœ‰å½»åº•è§£å†³å¹»è¯»ï¼Œåªæ˜¯å¾ˆå¤§ç¨‹åº¦ä¸Šé¿å…äº†å¹»è¯»ç°è±¡çš„å‘ç”Ÿã€‚é¿å…è¿™ç±»ç‰¹æ®Šåœºæ™¯ä¸‹å‘ç”Ÿå¹»è¯»çš„ç°è±¡çš„è¯ï¼Œå°±æ˜¯å°½é‡åœ¨å¼€å¯äº‹åŠ¡ä¹‹åï¼Œé©¬ä¸Šæ‰§è¡Œ select â€¦ for update è¿™ç±»å½“å‰è¯»çš„è¯­å¥ï¼Œå› ä¸ºå®ƒä¼šå¯¹è®°å½•åŠ  next-key lockï¼Œä»è€Œé¿å…å…¶ä»–äº‹åŠ¡æ’å…¥ä¸€æ¡æ–°è®°å½•ã€‚</p>              </div>            </details><hr><h2 id="Mysqlé”"><a href="#Mysqlé”" class="headerlink" title="Mysqlé”"></a>Mysqlé”</h2><details class="folding-tag" cyan close><summary> é—´éš™é”æ­»é” </summary>              <div class='content'>              <p>äº‹åŠ¡çš„é—´éš™é”ä¹‹é—´æ˜¯ç›¸äº’å…¼å®¹çš„ï¼Œä¸ä¼šäº§ç”Ÿå†²çªã€‚</p><p>é—´éš™é”çš„æ„ä¹‰åªåœ¨äºé˜»æ­¢åŒºé—´è¢«æ’å…¥ï¼Œå› æ­¤æ˜¯å¯ä»¥å…±å­˜çš„ã€‚ä¸€ä¸ªäº‹åŠ¡è·å–çš„é—´éš™é”ä¸ä¼šé˜»æ­¢å¦ä¸€ä¸ªäº‹åŠ¡è·å–åŒä¸€ä¸ªé—´éš™èŒƒå›´çš„é—´éš™é”ã€‚</p><p>å¦‚æœä¸¤ä¸ªäº‹åŠ¡åˆ†åˆ«å‘å¯¹æ–¹æŒæœ‰çš„é—´éš™é”èŒƒå›´å†…æ’å…¥ä¸€æ¡è®°å½•ï¼Œè€Œæ’å…¥æ“ä½œä¸ºäº†è·å–åˆ°æ’å…¥æ„å‘é”ï¼Œéƒ½åœ¨ç­‰å¾…å¯¹æ–¹äº‹åŠ¡çš„é—´éš™é”é‡Šæ”¾ï¼Œäºæ˜¯å°±é€ æˆäº†å¾ªç¯ç­‰å¾…ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/ab%E4%BA%8B%E5%8A%A1%E6%AD%BB%E9%94%81.drawio.png" alt="img" style="zoom:67%;" /></p>              </div>            </details><hr><h2 id="Mysqlæ—¥å¿—"><a href="#Mysqlæ—¥å¿—" class="headerlink" title="Mysqlæ—¥å¿—"></a>Mysqlæ—¥å¿—</h2><details class="folding-tag" cyan close><summary> undo logå’Œredo logæœ‰ä»€ä¹ˆç”¨ï¼Ÿ </summary>              <div class='content'>              <p><a href="https://www.xiaolincoding.com/mysql/log/how_update.html#mysql-%E6%97%A5%E5%BF%97-undo-log%E3%80%81redo-log%E3%80%81binlog-%E6%9C%89%E4%BB%80%E4%B9%88%E7%94%A8">MySQL æ—¥å¿—ï¼šundo logã€redo logã€binlog æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</a></p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240306154509741.png" alt="image-20240306154509741"></p>              </div>            </details><hr><details class="folding-tag" green close><summary> ä¸€æ¡æ›´æ–°è¯­å¥ï¼Œæ—¥å¿—æ˜¯å¦‚ä½•å†™å…¥çš„ï¼Ÿ </summary>              <div class='content'>              <p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/15477e4c8e68ee00bc5e496ed287f3af.png" alt=""></p>              </div>            </details><hr><details class="folding-tag" blue close><summary> ä¸ºä»€ä¹ˆéœ€è¦binlogï¼Ÿ </summary>              <div class='content'>              <p><a href="https://www.xiaolincoding.com/mysql/log/how_update.html#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-binlog">ä¸ºä»€ä¹ˆéœ€è¦binlog</a></p>              </div>            </details><hr><h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><details class="folding-tag" cyan close><summary> Redisä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿ </summary>              <div class='content'>              <p>CPU å¹¶ä¸æ˜¯åˆ¶çº¦ Redis æ€§èƒ½è¡¨ç°çš„ç“¶é¢ˆæ‰€åœ¨ï¼Œæ›´å¤šæƒ…å†µä¸‹æ˜¯å—åˆ°å†…å­˜å¤§å°å’Œç½‘ç»œI/Oçš„é™åˆ¶ï¼Œæ‰€ä»¥ Redis æ ¸å¿ƒç½‘ç»œæ¨¡å‹ä½¿ç”¨å•çº¿ç¨‹å¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚</p><p>æ‰€ä»¥ä¸ºäº†æé«˜ç½‘ç»œ I/O çš„å¹¶è¡Œåº¦ï¼ŒRedis 6.0 å¯¹äºç½‘ç»œ I/O é‡‡ç”¨å¤šçº¿ç¨‹æ¥å¤„ç†ã€‚ä½†æ˜¯å¯¹äºå‘½ä»¤çš„æ‰§è¡Œï¼ŒRedis ä»ç„¶ä½¿ç”¨å•çº¿ç¨‹æ¥å¤„ç†ã€‚</p><p>CPUæˆä¸ºRedisçš„ç“¶é¢ˆçš„æƒ…å†µå¾ˆå°‘è§ï¼ŒRedisçš„ç“¶é¢ˆæœ€æœ‰å¯èƒ½æ˜¯å†…å­˜çš„å¤§å°æˆ–è€…ç½‘ç»œé™åˆ¶ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240307132303677.png" alt="image-20240307132303677"></p>              </div>            </details><hr><details class="folding-tag" green close><summary> é˜»å¡IOã€éé˜»å¡IOã€IOå¤šè·¯å¤ç”¨ </summary>              <div class='content'>              <p>IOè¯»å–æ•°æ®åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µ:</p><ol><li>å†…æ ¸å‡†å¤‡å¥½æ•°æ®</li><li>å†…æ ¸æŠŠæ•°æ®ä»å†…æ ¸æ€æ‹·è´åˆ°ç”¨æˆ·æ€</li></ol><blockquote><p>é˜»å¡IO</p></blockquote><p>å½“ç”¨æˆ·è°ƒç”¨ read åï¼Œç”¨æˆ·çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç­‰å†…æ ¸æ•°æ®å‡†å¤‡å¥½å¹¶ä¸”æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°ç”¨æˆ·æ€ç¼“å­˜åŒºåï¼Œ read æ‰ä¼šè¿”å›ã€‚é˜»å¡IOæ˜¯ä¸¤ä¸ªé˜¶æ®µéƒ½ä¼šé˜»å¡ï¼Œæ²¡æœ‰æ•°æ®æ—¶ä¹Ÿä¼šé˜»å¡ã€‚</p><blockquote><p>éé˜»å¡IO</p></blockquote><p>è°ƒç”¨readåï¼Œå¦‚æœæ²¡æœ‰æ•°æ®å°±ç«‹é©¬è¿”å›ï¼Œé€šè¿‡ä¸æ–­è½®è¯¢çš„æ–¹å¼å»è°ƒç”¨readï¼Œç›´åˆ°æ•°æ®è¢«æ‹·è´åˆ°ç”¨æˆ·æ€çš„åº”ç”¨ç¨‹åºç¼“å†²åŒºï¼Œreadè¯·æ±‚æ‰è·å–åˆ°ç»“æœã€‚éé˜»å¡IOé˜»å¡çš„æ˜¯ç¬¬äºŒä¸ªé˜¶æ®µï¼Œç¬¬ä¸€é˜¶æ®µæ²¡æœ‰æ•°æ®æ—¶ä¸ä¼šé˜»å¡ï¼Œç¬¬äºŒé˜¶æ®µç­‰å¾…å†…æ ¸æŠŠæ•°æ®ä»å†…æ ¸æ€æ‹·è´åˆ°ç”¨æˆ·æ€çš„è¿‡ç¨‹ä¸­æ‰ä¼šé˜»å¡ã€‚</p><blockquote><p>Select/poll IOå¤šè·¯å¤ç”¨</p></blockquote><p>ä¸€ä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶ç›‘å¬å¤šä¸ªsocketä¸Šçš„äº‹ä»¶ï¼ˆè¯»ã€å†™ã€è¿æ¥ï¼‰</p><p>é€šè¿‡Selectç³»ç»Ÿè°ƒç”¨ ï¼Œç”¨æˆ·çº¿ç¨‹é˜»å¡ã€‚å°†ä¸€æ‰¹æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯å‘é€ç»™å†…æ ¸ï¼Œå‡å°‘å¯¹å†…æ ¸çš„è°ƒç”¨æ¬¡æ•°ã€‚ç”±å†…æ ¸å»éå†æ¯ä¸€ä¸ªsocketæŸ¥çœ‹æœ‰æ— æ•°æ®åˆ°è¾¾ï¼Œæœ‰æ•°æ®åˆ°è¾¾åå°†æ­¤ Socket æ ‡è®°ä¸ºå¯è¯»æˆ–å¯å†™ï¼Œ æ¥ç€å†æŠŠæ•´ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†åˆ<strong>æ‹·è´</strong>å›ç”¨æˆ·æ€é‡Œï¼Œç„¶åç”¨æˆ·æ€è¿˜éœ€è¦å†é€šè¿‡<strong>éå†</strong>çš„æ–¹æ³•æ‰¾åˆ°å¯è¯»æˆ–å¯å†™çš„ Socketï¼Œç„¶åå†å¯¹å…¶å¤„ç†ã€‚</p><blockquote><p>epoll</p></blockquote><p>epoll åœ¨å†…æ ¸é‡Œä½¿ç”¨<strong>çº¢é»‘æ ‘æ¥è·Ÿè¸ªè¿›ç¨‹æ‰€æœ‰å¾…æ£€æµ‹çš„æ–‡ä»¶æè¿°å­—</strong>ï¼ŒæŠŠéœ€è¦ç›‘æ§çš„ socket é€šè¿‡ <code>epoll_ctl()</code> å‡½æ•°åŠ å…¥å†…æ ¸ä¸­çš„çº¢é»‘æ ‘é‡Œã€‚</p><p>epoll ä½¿ç”¨<strong>äº‹ä»¶é©±åŠ¨</strong>çš„æœºåˆ¶ï¼Œå†…æ ¸é‡Œ<strong>ç»´æŠ¤äº†ä¸€ä¸ªé“¾è¡¨æ¥è®°å½•å°±ç»ªäº‹ä»¶</strong>ï¼Œå½“æŸä¸ª socket æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œé€šè¿‡<strong>å›è°ƒå‡½æ•°</strong>å†…æ ¸ä¼šå°†å…¶åŠ å…¥åˆ°è¿™ä¸ªå°±ç»ªäº‹ä»¶åˆ—è¡¨ä¸­ï¼Œå½“ç”¨æˆ·è°ƒç”¨ <code>epoll_wait()</code> å‡½æ•°æ—¶ï¼Œåªä¼šè¿”å›æœ‰äº‹ä»¶å‘ç”Ÿçš„æ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°ï¼Œä¸éœ€è¦åƒ select/poll é‚£æ ·è½®è¯¢æ‰«ææ•´ä¸ª socket é›†åˆï¼Œå¤§å¤§æé«˜äº†æ£€æµ‹çš„æ•ˆç‡ã€‚</p>              </div>            </details><hr><details class="folding-tag" green close><summary> Redis æ•°æ®ç»“æ„ </summary>              <div class='content'>              <p><a href="https://www.xiaolincoding.com/redis/data_struct/command.html#string">Redis å¸¸è§æ•°æ®ç±»å‹å’Œåº”ç”¨åœºæ™¯</a></p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/%E4%BA%94%E7%A7%8D%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.png" alt=""></p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240308144725480.png" alt="image-20240308144725480"></p><p>æ•´æ•°æ•°ç»„ ï¼š æŒ‰åºæ’åˆ— äºŒåˆ†æŸ¥æ‰¾</p><p>å­—å…¸ï¼šç±»ä¼¼javaçš„HashTableï¼Œåº•å±‚æ˜¯æ•°ç»„åŠ é“¾è¡¨æ¥è§£å†³å“ˆå¸Œå†²çª åŒ…å«ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œht[0]å¹³å¸¸ç”¨ï¼Œht[1]ç”¨æ¥rehash</p><p>Dicté‡‡ç”¨æ¸è¿›å¼rehashï¼Œæ¯æ¬¡è®¿é—®Dictæ—¶æ‰§è¡Œä¸€æ¬¡rehash</p><p>rehashæ—¶ht[0]åªå‡ä¸å¢ï¼Œæ–°å¢æ“ä½œåªåœ¨ht[1]æ‰§è¡Œï¼Œå…¶å®ƒæ“ä½œåœ¨ä¸¤ä¸ªå“ˆå¸Œè¡¨</p><p>æœ€å¤§çš„å±‚æ•°æ˜¯ 32</p><p>è·³è¡¨</p><p>æ¯ä¸ªNodeå­˜å‚¨</p><p>score</p><p>æ•°æ®</p><p>å‰é©±èŠ‚ç‚¹æŒ‡é’ˆ</p><p>ç´¢å¼•æ•°ç»„level</p><p>â€‹    ç´¢å¼•è·¨åº¦</p><p>â€‹    ç´¢å¼•æŒ‡å‘çš„node</p><p>æ’å…¥èŠ‚ç‚¹ æ›´æ–°è·¨åº¦</p>              </div>            </details><details class="folding-tag" blue close><summary> RedisæŒä¹…åŒ– </summary>              <div class='content'>              <p>RDBå†™æ—¶å¤åˆ¶ COW</p><p>é€šè¿‡ fork åˆ›å»ºå­è¿›ç¨‹æ—¶ä¸ä¼šç«‹åˆ»è§¦å‘å¤§é‡å†…å­˜çš„æ‹·è´ï¼Œå†…å­˜åœ¨è¢«ä¿®æ”¹æ—¶ä¼šä»¥é¡µä¸ºå•ä½è¿›è¡Œæ‹·è´ï¼Œè¿™ä¹Ÿå°±é¿å…äº†å¤§é‡æ‹·è´å†…å­˜è€Œå¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼›</p><p>çˆ¶å­è¿›ç¨‹å…±äº«çš„ç©ºé—´ç²’åº¦æ˜¯é¡µï¼ˆåœ¨Linuxä¸­ï¼Œé¡µçš„å¤§å°ä¸º4KBï¼‰ï¼Œçˆ¶/å­è¿›ç¨‹ä¿®æ”¹æŸä¸ªé¡µæ—¶ï¼Œè¯¥é¡µçš„å…±äº«æ‰ç»“æŸï¼ŒåŒæ—¶å­è¿›ç¨‹åˆ†é…è¯¥é¡µå¤§å°çš„ç‰©ç†ç©ºé—´å¤åˆ¶çˆ¶è¿›ç¨‹å¯¹åº”é¡µçš„å†…å®¹ã€‚è¿™æ ·ï¼Œå¦‚æœå½“å­è¿›ç¨‹è¿è¡ŒæœŸé—´ï¼Œçˆ¶å­è¿›ç¨‹éƒ½æ²¡æœ‰ä¿®æ”¹æ•°æ®ï¼Œé‚£ä¹ˆæ“ä½œç³»ç»Ÿå°±èŠ‚çœäº†å¤§é‡çš„å†…å­˜å¤åˆ¶æ—¶é—´å’Œå ç”¨ç©ºé—´ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1Redis%E6%8C%81%E4%B9%85%E5%8C%96.png" alt="1RedisæŒä¹…åŒ–"></p>              </div>            </details><hr><p>dict æ¸è¿›å¼å“ˆå¸Œ</p><hr><h2 id="RocketMQ"><a href="#RocketMQ" class="headerlink" title="RocketMQ"></a>RocketMQ</h2>]]></content>
    
    
    <summary type="html">Mysql&amp;Redis&amp;RocketMQé¢è¯•é¢˜</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="é¢è¯•é¢˜" scheme="https://wuwawawa.github.io/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    
  </entry>
  
  <entry>
    <title>Javaæ—¥å¿—ä½“ç³»</title>
    <link href="https://wuwawawa.github.io/posts/b41723d6.html"/>
    <id>https://wuwawawa.github.io/posts/b41723d6.html</id>
    <published>2023-12-25T05:55:36.000Z</published>
    <updated>2024-03-05T07:01:48.689Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ—¥å¿—æ¡†æ¶ç±»åˆ«"><a href="#æ—¥å¿—æ¡†æ¶ç±»åˆ«" class="headerlink" title="æ—¥å¿—æ¡†æ¶ç±»åˆ«"></a>æ—¥å¿—æ¡†æ¶ç±»åˆ«</h2><h3 id="è®°å½•å‹æ—¥å¿—æ¡†æ¶"><a href="#è®°å½•å‹æ—¥å¿—æ¡†æ¶" class="headerlink" title="è®°å½•å‹æ—¥å¿—æ¡†æ¶"></a>è®°å½•å‹æ—¥å¿—æ¡†æ¶</h3><ol><li><code>Jul (Java Util Logging)</code>ï¼šJDKä¸­çš„æ—¥å¿—è®°å½•å·¥å…·ï¼Œä¹Ÿå¸¸ç§°ä¸ºJDKLogã€jdk-loggingï¼Œè‡ªJava1.4ä»¥æ¥çš„å®˜æ–¹æ—¥å¿—å®ç°ã€‚</li><li><code>Log4j</code>ï¼šApache Log4jæ˜¯ä¸€ä¸ªåŸºäºJavaçš„æ—¥å¿—è®°å½•å·¥å…·ã€‚å®ƒæ˜¯ç”±Ceki GÃ¼lcÃ¼é¦–åˆ›çš„ï¼Œç°åœ¨åˆ™æ˜¯Apacheè½¯ä»¶åŸºé‡‘ä¼šçš„ä¸€ä¸ªé¡¹ç›®ã€‚ Log4jæ˜¯å‡ ç§Javaæ—¥å¿—æ¡†æ¶ä¹‹ä¸€ã€‚</li><li><code>Log4j</code>ï¼šä¸€ä¸ªå…·ä½“çš„æ—¥å¿—å®ç°æ¡†æ¶ï¼Œæ˜¯Log4j 1çš„ä¸‹ä¸€ä¸ªç‰ˆæœ¬ï¼Œä¸Log4j 1å‘ç”Ÿäº†å¾ˆå¤§çš„å˜åŒ–ï¼ŒLog4j 2ä¸å…¼å®¹Log4j 1ã€‚</li><li><code>Logback</code>ï¼šä¸€ä¸ªå…·ä½“çš„æ—¥å¿—å®ç°æ¡†æ¶ï¼Œå’ŒSlf4jæ˜¯åŒä¸€ä¸ªä½œè€…ï¼Œä½†å…¶æ€§èƒ½æ›´å¥½(<span class='p green'>æ¨èä½¿ç”¨</span>) ã€‚</li></ol><hr><h3 id="é—¨é¢å‹æ—¥å¿—æ¡†æ¶"><a href="#é—¨é¢å‹æ—¥å¿—æ¡†æ¶" class="headerlink" title="é—¨é¢å‹æ—¥å¿—æ¡†æ¶"></a>é—¨é¢å‹æ—¥å¿—æ¡†æ¶</h3><ol><li><code>JCL</code>ï¼šApacheåŸºé‡‘ä¼šæ‰€å±çš„é¡¹ç›®ï¼Œæ˜¯ä¸€å¥—Javaæ—¥å¿—æ¥å£ï¼Œä¹‹å‰å«Jakarta Commons Loggingï¼Œåæ›´åä¸ºCommons Logging</li><li><code>SLF4J</code>ï¼šæ˜¯ä¸€å¥—ç®€æ˜“Javaæ—¥å¿—é—¨é¢ï¼Œ<span class='p green'>æœ¬èº«å¹¶æ— æ—¥å¿—çš„å®ç°</span>ã€‚ï¼ˆSimple Logging Facade for Javaï¼Œç¼©å†™Slf4jï¼‰</li></ol><hr><h2 id="Javaæ—¥å¿—æ¡†æ¶å‘å±•å²"><a href="#Javaæ—¥å¿—æ¡†æ¶å‘å±•å²" class="headerlink" title="Javaæ—¥å¿—æ¡†æ¶å‘å±•å²"></a>Javaæ—¥å¿—æ¡†æ¶å‘å±•å²</h2><div class="tabs" id="429b6ca4-4b72-4496-bb40-135bd75ba457"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#429b6ca4-4b72-4496-bb40-135bd75ba457-1"><i class="fas fa-bug"></i>1</button></li><li class="tab"><button type="button" data-href="#429b6ca4-4b72-4496-bb40-135bd75ba457-2"><i class="fas fa-cannabis"></i>2</button></li><li class="tab"><button type="button" data-href="#429b6ca4-4b72-4496-bb40-135bd75ba457-3"><i class="fas fa-candy-cane"></i>3</button></li><li class="tab"><button type="button" data-href="#429b6ca4-4b72-4496-bb40-135bd75ba457-4"><i class="fas fa-child"></i>4</button></li><li class="tab"><button type="button" data-href="#429b6ca4-4b72-4496-bb40-135bd75ba457-5"><i class="fas fa-award"></i>5</button></li><li class="tab"><button type="button" data-href="#429b6ca4-4b72-4496-bb40-135bd75ba457-6"><i class="fas fa-baseball-ball"></i>6</button></li><li class="tab"><button type="button" data-href="#429b6ca4-4b72-4496-bb40-135bd75ba457-7"><i class="fas fa-anchor"></i>7</button></li><li class="tab"><button type="button" data-href="#429b6ca4-4b72-4496-bb40-135bd75ba457-8"><i class="fas fa-bone"></i>8</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="429b6ca4-4b72-4496-bb40-135bd75ba457-1"><p>2001å¹´ä»¥å‰ï¼ŒJavaæ˜¯æ²¡æœ‰æ—¥å¿—åº“çš„ï¼Œæ‰“å°æ—¥å¿—å…¨å‡­<code>System.out</code>å’Œ<code>System.err</code></p><p>ç¼ºç‚¹:</p><ol><li>äº§ç”Ÿå¤§é‡çš„IOæ“ä½œåŒæ—¶åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ— æ³•åˆç†çš„æ§åˆ¶æ˜¯å¦éœ€è¦è¾“å‡º</li><li>è¾“å‡ºçš„å†…å®¹ä¸èƒ½ä¿å­˜åˆ°æ–‡ä»¶</li><li>åªæ‰“å°åœ¨æ§åˆ¶å°ï¼Œæ‰“å°å®Œå°±è¿‡å»äº†ï¼Œä¹Ÿå°±æ˜¯è¯´é™¤éä½ ä¸€ç›´ç›¯ç€ç¨‹åºè·‘</li><li>æ— æ³•å®šåˆ¶åŒ–ï¼Œä¸”æ—¥å¿—ç²’åº¦ä¸å¤Ÿç»†</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="429b6ca4-4b72-4496-bb40-135bd75ba457-2"><p>2001å¹´ï¼Œä¸€ä¸ª<strong>ceki GulcÃ¼</strong>çš„å¤§ä½¬æäº†ä¸€ä¸ªæ—¥å¿—æ¡†æ¶ log4jåæ¥( log4jæˆä¸ºApacheé¡¹ç›®ï¼ŒCekiåŠ å…¥Apacheç»„ç»‡ Apacheè¿˜æ›¾ç»å»ºè®®Sunå¼•å…¥Log4jåˆ°Javaçš„æ ‡å‡†åº“ä¸­ï¼Œä½†Sunæ‹’ç»äº†.</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/3bd956b4a3e905be00f003e0f3600fb4.png" alt="image-20211212211243016"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="429b6ca4-4b72-4496-bb40-135bd75ba457-3"><p>Sunæœ‰è‡ªå·±çš„å°å¿ƒæ€ï¼Œ2002å¹´2æœˆJDK1.4å‘å¸ƒï¼ŒSunæ¨å‡ºäº†è‡ªå·±çš„æ—¥å¿—æ ‡å‡†åº“JUL(Java Util Logging)ï¼Œå…¶å®æ˜¯ç…§ç€Log4jæŠ„çš„ï¼Œè€Œä¸”è¿˜æ²¡æŠ„å¥½ï¼Œè¿˜æ˜¯åœ¨JDK1.5ä»¥åæ€§èƒ½å’Œå¯ç”¨æ€§æ‰æœ‰æ‰€æå‡ã€‚ç”±äºLog4jæ¯”JULå¥½ç”¨ï¼Œå¹¶ä¸”æˆç†Ÿï¼Œæ‰€ä»¥Log4jåœ¨é€‰æ‹©ä¸Šå æ®äº†ä¸€å®šçš„ä¼˜åŠ¿ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="429b6ca4-4b72-4496-bb40-135bd75ba457-4"><p>2002å¹´8æœˆApacheæ¨å‡ºäº†JCL(Jakarta Commons Logging)ï¼Œä¹Ÿå°±æ˜¯æ—¥å¿—æŠ½è±¡å±‚ï¼Œæ”¯æŒè¿è¡Œæ—¶åŠ¨æ€åŠ è½½æ—¥å¿—ç»„ä»¶çš„å®ç°ï¼Œå½“ç„¶ä¹Ÿæä¾›ä¸€ä¸ªé»˜è®¤å®ç°Simple Log( ClassLoader ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æœèƒ½æ‰¾åˆ°Log4jåˆ™é»˜è®¤ä½¿ç”¨log4jå®ç°ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨JULå®ç°ï¼Œå†æ²¡æœ‰åˆ™ä½¿ç”¨JCLå†…éƒ¨æä¾›çš„ Simple Logå®ç°)ã€‚</p><p>ä½†æ˜¯JULæœ‰ä¸‰ä¸ªç¼ºç‚¹:</p><p>1ï¼æ•ˆç‡è¾ƒä½ã€‚ </p><p>2ï¼å®¹æ˜“å¼•å‘æ··ä¹±ã€‚</p><p> 3ï¼ä½¿ç”¨äº†è‡ªå®šä¹‰ClassLoaderçš„ç¨‹åºä¸­ï¼Œä½¿ç”¨JCLä¼šå¼•å‘å†…å­˜æ³„éœ²ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/bVbAMyv.png" alt="image.png"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="429b6ca4-4b72-4496-bb40-135bd75ba457-5"><p>2006å¹´å·¨ä½¬Ceki( Log4jçš„ä½œè€…ï¼‰å› ä¸ºä¸€äº›åŸå› ç¦»å¼€äº†Apacheç»„ç»‡ï¼Œä¹‹åCekiè§‰å¾—JCLä¸å¥½ç”¨ï¼Œè‡ªå·±æ€äº†ä¸€å¥—æ–°çš„æ—¥å¿—æ ‡å‡†æ¥å£è§„èŒƒSlf4j (Simple Logging Facacfor Java)ï¼Œä¹Ÿå¯ä»¥ç§°ä¸ºæ—¥å¿—é—¨é¢ï¼Œå¾ˆæ˜æ˜¾Slf4jæ˜¯å¯¹æ ‡JCLï¼Œåé¢ä¹Ÿè¯æ˜äº†Slf4jæ¯”JCLæ›´ä¼˜ç§€ã€‚ å·¨ä½¬Cekiæä¾›äº†ä¸€ç³»åˆ—çš„æ¡¥æ¥åŒ…æ¥å¸®åŠ©Slf4jæ¥å£ä¸å…¶ä»–æ—¥å¿—åº“å»ºç«‹å…³ç³»ï¼Œè¿™ç§æ–¹å¼ç§°æ¡¥æ¥è®¾è®¡æ¨¡å¼ã€‚ ä»£ç ä½¿ç”¨Slf4jæ¥å£ï¼Œå°±å¯ä»¥å®ç°æ—¥å¿—çš„ç»Ÿä¸€æ ‡å‡†åŒ–ï¼Œåç»­å¦‚æœæƒ³è¦æ›´æ¢æ—¥å¿—å®ç°ï¼Œåªéœ€å¼•å…¥Slf4jä¸ç›¸å…³çš„æ¡¥æ¥åŒ…ï¼Œå†å¼•å…¥å…·ä½“çš„æ—¥å¿—æ ‡å‡†åº“å³å¯ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="429b6ca4-4b72-4496-bb40-135bd75ba457-6"><p>ä½†æ˜¯ç”±äº<code>Slf4j</code>å‡ºæ¥çš„è¾ƒæ™šï¼Œè€Œä¸”è¿˜åªæ˜¯ä¸€ä¸ªæ—¥å¿—æ¥å£ï¼Œæ‰€ä»¥ä¹‹å‰å·²ç»å‡ºç°çš„æ—¥å¿—äº§å“ï¼Œå¦‚<code>JUL</code>å’Œ<code>Log4j</code>éƒ½æ˜¯æ²¡æœ‰å®ç°è¿™ä¸ªæ¥å£çš„ï¼Œæ‰€ä»¥å°´å°¬çš„æ˜¯å…‰æœ‰ä¸€ä¸ªæ¥å£ï¼Œæ²¡æœ‰å®ç°çš„äº§å“ä¹Ÿæ˜¯å¾ˆæ†‹å±ˆå•Šï¼Œå°±ç®—å¼€å‘è€…æƒ³ç”¨<code>Slf4j</code>ä¹Ÿæ˜¯ç”¨ä¸äº†ã€‚</p><p>äºæ˜¯å¤§ä½¬<strong>Ceki GÃ¼lcÃ¼</strong>æ’¸å‡ºäº†ä¹‹å‰æåˆ°çš„æ¡¥æ¥åŒ…ï¼Œäºæ˜¯æ—¥å¿—ç³»ç»Ÿç°åœ¨æœ‰äº†è¿™æ ·çš„ç»“æ„</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/bVbAMzq.png" alt="image.png" style="zoom:50%;" /></p><p>ä½†æ˜¯å…¶å®ä¹‹å‰å¾ˆå¤š<code>Java</code>åº”ç”¨åº”è¯¥ä¾èµ–çš„<code>JCL</code>ï¼Œæ‰€ä»¥å…‰æœ‰æ—¥å¿—äº§å“æ¡¥æ¥åŒ…ï¼Œå¥½åƒè¿˜ä¸å¤Ÿ<strong>Ceki GÃ¼lcÃ¼</strong>ï¼šæ²¡é—®é¢˜ï¼Œä¸å°±æ˜¯ä¸å¤Ÿæ¡¥æ¥åŒ…ä¹ˆï¼Œæˆ‘å†™ï¼Œæˆ‘æ¥è¯æ˜Slf4jæ˜¯æœ€å®Œç¾çš„ã€‚</p><p>äºæ˜¯æœ‰äº†<code>JCL</code>çš„æ¡¥æ¥åŒ…</p><p><img src="https://segmentfault.com/img/bVbAMA9" alt="image.png" style="zoom:50%;" /></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="429b6ca4-4b72-4496-bb40-135bd75ba457-7"><p>ç”±äºä½¿ç”¨<code>Slf4j</code>ï¼Œéœ€è¦ä¸€æ¬¡æ¡¥æ¥åŒ…ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰çš„æ—¥å¿—äº§å“éƒ½ä¸æ˜¯æ­£ç»Ÿçš„<code>Slf4j</code>çš„å®ç°ï¼Œå› æ­¤ï¼Œ2006å¹´ï¼Œå‡ºè‡ª<strong>Ceki GÃ¼lcÃ¼</strong>ä¹‹æ‰‹çš„æ—¥å¿—äº§å“<code>Logback</code>åº”è¿è€Œç”Ÿ</p><p><code>Logback</code>æ˜¯å®Œç¾å®ç°äº†<code>Slf4j</code>ï¼Œäºæ˜¯ç°åœ¨æ—¥å¿—ç³»ç»Ÿå˜æˆäº†</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/bVbAMUJ.png" alt="æœªå‘½åæ–‡ä»¶ (4).png" style="zoom:50%;" /></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="429b6ca4-4b72-4496-bb40-135bd75ba457-8"><p>2012å¹´ï¼ŒApacheç›´æ¥æ¨å‡ºæ–°é¡¹ç›®Log4j2(ä¸å…¼å®¹Log4j) , Log4j2å…¨é¢å€Ÿé‰´Slf4j+Logback ã€‚ Log4j2ä¸ä»…ä»…å…·æœ‰Logbackçš„æ‰€æœ‰ç‰¹æ€§ï¼Œè¿˜åšäº†åˆ†ç¦»è®¾è®¡ï¼Œåˆ†ä¸ºlog4j-apiå’Œlog4j-coreï¼Œlog4j-apiæ˜¯æ—¥å¿—æ¥å£ï¼Œlog4j-coreæ˜¯æ—¥å¿—æ ‡å‡†åº“ï¼Œå¹¶ä¸”Apacheä¹Ÿä¸ºLog4j2æä¾›äº†å„ç§æ¡¥æ¥åŒ…ã€‚</p><p>è€Œä¸”log4j2 çš„æ€§èƒ½æå‡å¾ˆå¤§ï¼Œè€Œä¸”æ”¯æŒå¼‚æ­¥æ—¥å¿—æ‰“å°ã€‚å¢åŠ å¾ˆå¤šæ–°çš„ç‰¹æ€§ã€‚</p><p><img src="https://segmentfault.com/img/bVcTphN" alt="img" style="zoom: 67%;" /></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h2 id="Slf4jçš„ä½¿ç”¨"><a href="#Slf4jçš„ä½¿ç”¨" class="headerlink" title="Slf4jçš„ä½¿ç”¨"></a>Slf4jçš„ä½¿ç”¨</h2><h3 id="Slf4jä¸å…¶å®ƒæ—¥å¿—ç»„ä»¶çš„å…³ç³»è¯´æ˜"><a href="#Slf4jä¸å…¶å®ƒæ—¥å¿—ç»„ä»¶çš„å…³ç³»è¯´æ˜" class="headerlink" title="Slf4jä¸å…¶å®ƒæ—¥å¿—ç»„ä»¶çš„å…³ç³»è¯´æ˜"></a>Slf4jä¸å…¶å®ƒæ—¥å¿—ç»„ä»¶çš„å…³ç³»è¯´æ˜</h3><p>Slf4jçš„è®¾è®¡æ€æƒ³æ¯”è¾ƒç®€æ´ï¼Œä½¿ç”¨äº†Facadeè®¾è®¡æ¨¡å¼ï¼ŒSlf4jæœ¬èº«åªæä¾›äº†ä¸€ä¸ª<code>slf4j-api-version.jar</code>åŒ…ï¼Œè¿™ä¸ªjarä¸­ä¸»è¦æ˜¯æ—¥å¿—çš„æŠ½è±¡æ¥å£ï¼Œjarä¸­æœ¬èº«å¹¶æ²¡æœ‰å¯¹æŠ½è±¡å‡ºæ¥çš„æ¥å£åšå®ç°ã€‚</p><p>å¯¹äºä¸åŒçš„æ—¥å¿—å®ç°æ–¹æ¡ˆ(ä¾‹å¦‚Logbackï¼ŒLog4jâ€¦)ï¼Œå°è£…å‡ºä¸åŒçš„æ¡¥æ¥ç»„ä»¶(ä¾‹å¦‚logback-classic-version.jarï¼Œslf4j-log4j12-version.jar)ï¼Œè¿™æ ·ä½¿ç”¨è¿‡ç¨‹ä¸­å¯ä»¥çµæ´»çš„é€‰å–è‡ªå·±é¡¹ç›®é‡Œçš„æ—¥å¿—å®ç°ã€‚</p><hr><h3 id="Slf4jä¸å…¶å®ƒæ—¥å¿—ç»„ä»¶é›†æˆå›¾"><a href="#Slf4jä¸å…¶å®ƒæ—¥å¿—ç»„ä»¶é›†æˆå›¾" class="headerlink" title="Slf4jä¸å…¶å®ƒæ—¥å¿—ç»„ä»¶é›†æˆå›¾"></a>Slf4jä¸å…¶å®ƒæ—¥å¿—ç»„ä»¶é›†æˆå›¾</h3><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20231225145318031.png" alt="image-20231225145318031" style="zoom:67%;" /></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œåº”ç”¨è°ƒäº†sl4j-apiï¼Œå³<strong>æ—¥å¿—é—¨é¢æ¥å£</strong>ã€‚æ—¥å¿—é—¨é¢æ¥å£æœ¬èº«é€šå¸¸å¹¶æ²¡æœ‰å®é™…çš„æ—¥å¿—è¾“å‡ºèƒ½åŠ›ï¼Œå®ƒåº•å±‚è¿˜æ˜¯éœ€è¦å»è°ƒç”¨å…·ä½“çš„æ—¥å¿—æ¡†æ¶APIçš„ï¼Œä¹Ÿå°±æ˜¯å®é™…ä¸Šå®ƒéœ€è¦è·Ÿå…·ä½“çš„æ—¥å¿—æ¡†æ¶ç»“åˆä½¿ç”¨ã€‚ç”±äºå…·ä½“æ—¥å¿—æ¡†æ¶æ¯”è¾ƒå¤šï¼Œè€Œä¸”äº’ç›¸ä¹Ÿå¤§éƒ½ä¸å…¼å®¹ï¼Œæ—¥å¿—é—¨é¢æ¥å£è¦æƒ³å®ç°ä¸ä»»æ„æ—¥å¿—æ¡†æ¶ç»“åˆå¯èƒ½éœ€è¦å¯¹åº”çš„æ¡¥æ¥å™¨ï¼Œä¸Šå›¾çº¢æ¡†ä¸­çš„ç»„ä»¶å³æ˜¯å¯¹åº”çš„å„ç§æ¡¥æ¥å™¨ï¼</p><div class="table-container"><table><thead><tr><th style="text-align:center"><strong>jaråŒ…å</strong></th><th style="text-align:center"><strong>è¯´æ˜</strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong>slf4j-log4j12-1.7.30.jar</strong></td><td style="text-align:center">Log4j1.2ç‰ˆæœ¬çš„æ¡¥æ¥å™¨ï¼Œä½ éœ€è¦å°†Log4j.jaråŠ å…¥Classpathã€‚</td></tr><tr><td style="text-align:center"><strong>slf4j-jdk14-1.7.30.jar</strong></td><td style="text-align:center">java.util.loggingçš„æ¡¥æ¥å™¨ï¼ŒJdkåŸç”Ÿæ—¥å¿—æ¡†æ¶ã€‚</td></tr><tr><td style="text-align:center"><strong>slf4j-nop-1.7.30.jar</strong></td><td style="text-align:center">NOPæ¡¥æ¥å™¨ï¼Œé»˜é»˜ä¸¢å¼ƒä¸€åˆ‡æ—¥å¿—ã€‚</td></tr><tr><td style="text-align:center"><strong>slf4j-simple-1.7.30.jar</strong></td><td style="text-align:center">ä¸€ä¸ªç®€å•å®ç°çš„æ¡¥æ¥å™¨ï¼Œè¯¥å®ç°è¾“å‡ºæ‰€æœ‰äº‹ä»¶åˆ°System.err. åªæœ‰Infoä»¥åŠé«˜äºè¯¥çº§åˆ«çš„æ¶ˆæ¯è¢«æ‰“å°ï¼Œåœ¨å°å‹åº”ç”¨ä¸­å®ƒä¹Ÿè®¸æ˜¯æœ‰ç”¨çš„ã€‚</td></tr><tr><td style="text-align:center"><strong>slf4j-jcl-1.7.30.jar</strong></td><td style="text-align:center">Jakarta Commons Logging çš„æ¡¥æ¥å™¨. è¿™ä¸ªæ¡¥æ¥å™¨å°†Slf4jæ‰€æœ‰æ—¥å¿—å§”æ´¾ç»™Jclã€‚</td></tr><tr><td style="text-align:center"><strong>logback-classic-1.0.13.jar(requires logback-core-1.0.13.jar)</strong></td><td style="text-align:center">Slf4jçš„åŸç”Ÿå®ç°ï¼ŒLogbackç›´æ¥å®ç°äº†Slf4jçš„æ¥å£ï¼Œå› æ­¤ä½¿ç”¨Slf4jä¸Logbackçš„ç»“åˆä½¿ç”¨ä¹Ÿæ„å‘³æ›´å°çš„å†…å­˜ä¸è®¡ç®—å¼€é”€</td></tr></tbody></table></div><hr><h2 id="Slf4jæºç åˆ†æ"><a href="#Slf4jæºç åˆ†æ" class="headerlink" title="Slf4jæºç åˆ†æ"></a>Slf4jæºç åˆ†æ</h2><blockquote><p>slf4j-api-version.jarä¸­å‡ ä¸ªæ ¸å¿ƒç±»ä¸æ¥å£</p></blockquote><div class="table-container"><table><thead><tr><th style="text-align:center"><strong>ç±»ä¸æ¥å£</strong></th><th style="text-align:center"><strong>ç”¨é€”</strong></th></tr></thead><tbody><tr><td style="text-align:center">org.slf4j.LoggerFactory(class)</td><td style="text-align:center">ç»™è°ƒç”¨æ–¹æä¾›çš„åˆ›å»ºLoggerçš„å·¥å‚ç±»ï¼Œåœ¨ç¼–è¯‘æ—¶ç»‘å®šå…·ä½“çš„æ—¥å¿—å®ç°ç»„ä»¶</td></tr><tr><td style="text-align:center">org.slf4j.Logger(interface)</td><td style="text-align:center">ç»™è°ƒç”¨æ–¹æä¾›çš„æ—¥å¿—è®°å½•æŠ½è±¡æ–¹æ³•ï¼Œä¾‹å¦‚debug(String msg),info(String msg)ç­‰æ–¹æ³•</td></tr><tr><td style="text-align:center">org.slf4j.ILoggerFactory(interface)</td><td style="text-align:center">è·å–çš„Loggerçš„å·¥å‚æ¥å£ï¼Œå…·ä½“çš„æ—¥å¿—ç»„ä»¶å®ç°æ­¤æ¥å£</td></tr><tr><td style="text-align:center">org.slf4j.helpers.NOPLogger(class)</td><td style="text-align:center">å¯¹org.slf4j.Loggeræ¥å£çš„ä¸€ä¸ªæ²¡æœ‰ä»»ä½•æ“ä½œçš„å®ç°ï¼Œä¹Ÿæ˜¯Slf4jçš„é»˜è®¤æ—¥å¿—å®ç°</td></tr><tr><td style="text-align:center">org.slf4j.impl.StaticLoggerBinder(class)</td><td style="text-align:center">ä¸å…·ä½“çš„æ—¥å¿—å®ç°ç»„ä»¶å®ç°çš„æ¡¥æ¥ç±»ï¼Œå…·ä½“çš„æ—¥å¿—å®ç°ç»„ä»¶éœ€è¦å®šä¹‰org.slf4j.implåŒ…ï¼Œå¹¶åœ¨org.slf4j.implåŒ…ä¸‹æä¾›æ­¤ç±»ï¼Œæ³¨æ„åœ¨slf4j-api-version.jarä¸­ä¸å­˜åœ¨org.slf4j.impl.StaticLoggerBinderï¼Œåœ¨æºç åŒ…slf4j-api-version-source.jarä¸­æ‰å­˜åœ¨æ­¤ç±»</td></tr></tbody></table></div><hr><p><a href="https://juejin.cn/post/6905026199722917902#heading-19">https://juejin.cn/post/6905026199722917902#heading-19</a></p><p><a href="https://www.cnblogs.com/FlyAway2013/p/10691936.html">https://www.cnblogs.com/FlyAway2013/p/10691936.html</a></p><p><a href="https://juejin.cn/post/6939478456287625246">https://juejin.cn/post/6939478456287625246</a></p>]]></content>
    
    
    <summary type="html">Javaæ—¥å¿—ä½“ç³»</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>JUC&amp;JVMé¢è¯•é¢˜</title>
    <link href="https://wuwawawa.github.io/posts/c7a2e76a.html"/>
    <id>https://wuwawawa.github.io/posts/c7a2e76a.html</id>
    <published>2023-12-14T07:27:31.000Z</published>
    <updated>2024-04-11T07:10:25.873Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¯¹æ¯”"><a href="#å¯¹æ¯”" class="headerlink" title="å¯¹æ¯”"></a>å¯¹æ¯”</h2><p><a href="https://javabetter.cn/sidebar/sanfene/javathread.html#%E8%AF%B7%E8%AF%B4%E8%AF%B4-sleep-%E5%92%8C-wait-%E7%9A%84%E5%8C%BA%E5%88%AB-%E8%A1%A5%E5%85%85">sleepå’Œwaitçš„åŒºåˆ«</a></p><p><a href="https://javabetter.cn/sidebar/sanfene/javathread.html#_28-%E8%AF%B4%E8%AF%B4-synchronized-%E5%92%8C-reentrantlock-%E7%9A%84%E5%8C%BA%E5%88%AB">synchronizedå’ŒReentrantLockçš„åŒºåˆ«</a></p><details class="folding-tag" cyan close><summary> ä¸‰ç§ç­‰å¾…ã€å”¤é†’çº¿ç¨‹æ–¹æ³•å¯¹æ¯” </summary>              <div class='content'>              <blockquote><p>Object</p></blockquote><p><code>wait()ï¼Œnotify()ï¼ŒnotifyAll()</code>ç”¨äºçº¿ç¨‹çš„ç­‰å¾…å”¤é†’ï¼Œéƒ½å¿…é¡»åœ¨synchronizedå†…éƒ¨ä¸­æ‰§è¡Œï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸<code>java.lang.IllegalMonitorStateException</code><br>å”¤é†’åç­‰å¾…ä¼šå¯¼è‡´çº¿ç¨‹ä¸€è‡´é˜»å¡ã€‚</p><blockquote><p>Condition</p></blockquote><p><code>await()ã€signal()å’ŒsignalAll()</code>ç”¨äºç­‰å¾…å”¤é†’çº¿ç¨‹ï¼Œä½†æ˜¯å¿…é¡»æ”¾åœ¨lock()å’Œunlock()åŠ é”ä»£ç å—ä¸­ï¼Œå¦åˆ™ä¼šå‡ºå¼‚å¸¸<code>java.lang.IllegalMonitorStateException</code></p><p>å”¤é†’åç­‰å¾…ä¼šå¯¼è‡´çº¿ç¨‹ä¸€è‡´é˜»å¡ã€‚</p><blockquote><p>LockSupport</p></blockquote><p>LockSupportçš„ä½¿ç”¨ä¸éœ€è¦åŠ åˆ°synchronizedæˆ–lockä¿®é¥°çš„åŒæ­¥ä»£ç å—å’ŒåŒæ­¥æ–¹æ³•ä¸­ã€‚LockSupportä¸ç”¨æŒæœ‰é”å—ï¼Œä¸ç”¨åŠ é”ï¼Œç¨‹åºæ€§èƒ½å¥½ã€‚</p><p>LockSupportå¯ä»¥è§£å†³å…ˆé€šçŸ¥åç­‰å¾…ï¼Œçº¿ç¨‹ä¸€è‡´é˜»å¡é—®é¢˜ã€‚</p><p>ä½¿ç”¨åˆ°çš„æ˜¯ä¸€ç§permitçš„è®¸å¯ æœ€å¤§ä¸º1</p>              </div>            </details><hr><h2 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h2><p>AQSæ˜¯å¤šçº¿ç¨‹åŒæ­¥å™¨ï¼Œå®ƒæ˜¯J.U.CåŒ…ä¸­å¤šä¸ªç»„ä»¶çš„åº•å±‚å®ç°ã€‚ æ¯”å¦‚è¯´ReentrantLockã€CountdownLatchå’ŒSemaphoreéƒ½ç”¨åˆ°äº†AQSã€‚ </p><p>ä»æœ¬è´¨ä¸Šæ¥è¯´ï¼ŒAQSæä¾›äº†ä¸¤ç§é”çš„æœºåˆ¶ï¼Œåˆ†åˆ«æ˜¯æ’ä»–é”å’Œå…±äº«é”ã€‚</p><p>æ’ä»–é”ï¼Œå°±æ˜¯å­˜åœ¨å¤šä¸ªçº¿ç¨‹å»ç«äº‰åŒä¸€å…¶äº«èµ„æºçš„æ—¶å€™ï¼ŒåŒä¸€æ—¶åˆ»åªå…è®¸ä¸€å“¥çº¿ç¨‹å»è®¿é—®è¿™æ ·ä¸€ä¸ªå…±äº«èµ„æºã€‚</p><p>å…±äº«é”ä¹Ÿç§°ä¸ºè¯»é”ï¼Œå°±æ˜¯åœ¨åŒä¸€ä¸ªæ—¶åˆ»å…è®¦å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å¾—è¿™æ ·ä¸€ä¸ªé”çš„èµ„æºï¼Œæ¯”å¦‚CountDounLatchä»¥åŠSemaphoreï¼Œéƒ½ç”¨åˆ°äº†AQSä¸­çš„å…±äº«é”çš„åŠŸèƒ½ã€‚</p><p>é‚£ä¹ˆAQSä½œä¸ºäº’æ–¥é”æ¥è¯´å‘¢ï¼Œéœ€è¦è§£å†³ä¸‰ä¸ªæ ¸å¿ƒçš„é—´é¢˜ã€‚</p><ol><li>äº’æ–¤å˜é‡çš„è®¾è®¡ï¼Œå¦‚ä½•ä¿è¯å¤šçº¿ç¨‹åŒæ—¶æ›´æ–°äº’æ–¤å˜é‡çš„æ—¶å€™çš„çº¿ç¨‹å®‰å…¨æ€§ </li><li><p>æœªç«äº‰åˆ°é”èµ„æºçš„çº¿ç¨‹çš„ç­‰å¾…ä»¥åŠç«äº‰åˆ°é”çš„èµ„æºé‡Šæ”¾é”ä¹‹åçš„å”¤é†’</p></li><li><p>é”ç«äº‰çš„å…¬å¹³æ€§å’Œéå…¬å¹³æ€§</p></li></ol><p><a href="https://www.processon.com/view/link/5f90497463768906e6807c72">lockæµç¨‹å›¾</a></p><h2 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h2><div class="tag link"><a class="link-card" title="å…³é”®å­—: synchronizedè¯¦è§£" href="https://www.pdai.tech/md/java/thread/java-thread-x-key-synchronized.html"><div class="left"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/favicon.png"/></div><div class="right"><p class="text">å…³é”®å­—: synchronizedè¯¦è§£</p><p class="url">https://www.pdai.tech/md/java/thread/java-thread-x-key-synchronized.html</p></div></a></div><div class="tag link"><a class="link-card" title="é”è¿›é˜¶" href="/posts/3f9c0b8e.html#8-2-è½»é‡çº§é”"><div class="left"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/favicon.png"/></div><div class="right"><p class="text">é”è¿›é˜¶</p><p class="url">/posts/3f9c0b8e.html#8-2-è½»é‡çº§é”</p></div></a></div><hr><h2 id="æ— é”"><a href="#æ— é”" class="headerlink" title="æ— é”"></a>æ— é”</h2><details class="folding-tag" cyan close><summary> CASå’ŒABAé—®é¢˜ </summary>              <div class='content'>              <p>CASæ˜¯ä¸€ç§ä¹è§‚é”æŠ€æœ¯ï¼Œæ˜¯Compare And Swapçš„ç®€ç§°ã€‚</p><p>ä¸»è¦å°±æ˜¯åœ¨æ•°æ®å˜æ›´çš„æ—¶å€™ï¼Œå…ˆå¯¹æ¯”ï¼Œå’ŒæœŸæœ›å€¼ä¸€è‡´æ—¶å†æ›¿æ¢ï¼Œå¦åˆ™ä¸æ›¿æ¢ã€‚</p><p>CAS(V,A,B)<br>1ï¼šVè¡¨ç¤ºå†…å­˜ä¸­çš„åœ°å€<br>2ï¼šAè¡¨ç¤ºé¢„æœŸå€¼<br>3ï¼šBè¡¨ç¤ºè¦ä¿®æ”¹çš„æ–°å€¼</p><p>CASçš„åŸç†å°±æ˜¯é¢„æœŸå€¼Aä¸å†…å­˜ä¸­çš„å€¼ç›¸æ¯”è¾ƒï¼Œå¦‚æœç›¸åŒåˆ™å°†å†…å­˜ä¸­çš„å€¼æ”¹å˜æˆæ–°å€¼Bã€‚</p><p>Javaä¸­çš„CASæ˜¯é€šè¿‡Unsafeç±»å®ç°çš„ï¼Œé€šè¿‡ä½¿ç”¨ native æ–¹æ³•ç›´æ¥è®¿é—®æ“ä½œç³»ç»Ÿåº•å±‚ã€‚åº•å±‚cmpxchgæŒ‡ä»¤ï¼Œä¼šé”å®šæ€»çº¿ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹å¯¹å…±äº«å˜é‡çš„è®¿é—®</p><hr><p><span class='p red'>ABAé—®é¢˜</span></p><p>çº¿ç¨‹1å‡†å¤‡åˆ©ç”¨CASä¿®æ”¹å˜é‡å€¼Aï¼Œä½†æ˜¯åœ¨ä¿®æ”¹ä¹‹å‰ï¼Œå…¶ä»–çº¿ç¨‹å·²ç»å°†Aå˜æˆäº†Bï¼Œç„¶ååˆå˜æˆAï¼Œå³A-&gt;B-&gt;A,çº¿ç¨‹1æ‰§è¡ŒCASçš„æ—¶å€™å‘ç°ä»ç„¶ä¸ºAï¼Œæ‰€ä»¥CASä¼šæ“ä½œæˆåŠŸï¼Œä½†æ˜¯å…¶å®ç›®å‰è¿™ä¸ªAå·²ç»æ˜¯å…¶ä»–çº¿ç¨‹ä¿®æ”¹çš„äº†ï¼Œä½†æ˜¯çº¿ç¨‹1å¹¶ä¸çŸ¥é“ï¼Œæœ€ç»ˆå†…å­˜å€¼å˜æˆäº†Bï¼Œè¿™å°±å¯¼è‡´äº†ABAé—®é¢˜ã€‚</p><p>ç»“åˆå®é™…æƒ…å†µï¼Œå°±èƒ½çœ‹å‡ºé—®é¢˜</p><p>å‡è®¾æœ‰ä¸€ä¸ªéµå¾ªCASçš„ææ¬¾æœºï¼Œå°ç°æœ‰100å…ƒå­˜æ¬¾ï¼Œè¦ç”¨è¿™ä¸ªææ¬¾æœºæ¥ææ¬¾50å…ƒã€‚</p><p>ç”±äºææ¬¾æœºç¡¬ä»¶å‡ºäº†ç‚¹é—®é¢˜ï¼Œå°ç°çš„ææ¬¾æ“ä½œè¢«åŒæ—¶æäº¤äº†ä¸¤æ¬¡ï¼Œå¼€å¯äº†ä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸¤ä¸ªçº¿ç¨‹éƒ½æ˜¯è·å–å½“å‰å€¼100å…ƒï¼Œè¦æ›´æ–°æˆ50 å…ƒã€‚ç†æƒ³æƒ…æ³ä¸‹ï¼Œåº”è¯¥ä¸€ä¸ªçº¿ç¨‹æ›´æ–°æˆåŠŸï¼Œä¸€ä¸ªçº¿ç¨‹æ›´æ–°å¤±è´¥ï¼Œå°ç°çš„å­˜æ¬¾å€¼è¢«æ‰£ä¸€æ¬¡ã€‚</p><p>çº¿ç¨‹1é¦–å…ˆæ‰§è¡ŒæˆåŠŸï¼ŒæŠŠä½™é¢ä»100æ”¹æˆ50ã€‚çº¿ç¨‹2å› ä¸ºæŸç§åŸå› é˜»å¡ã€‚è¿™æ—¶ï¼Œå°ç°çš„å¦ˆå¦ˆåˆšå¥½ç»™å°ç°æ±‡æ¬¾50å…ƒã€‚</p><p>çº¿ç¨‹2ä»ç„¶æ˜¯é˜»å¡çŠ¶æ€ï¼Œçº¿ç¨‹3æ‰§è¡ŒæˆåŠŸï¼ŒæŠŠä½™é¢ä»50æ”¹æˆäº†100ã€‚</p><p>çº¿ç¨‹2æ¢å¤è¿è¡Œï¼Œç”±äºé˜»å¡ä¹‹å‰è·å¾—äº†â€å½“å‰å€¼â€100ï¼Œå¹¶ä¸”ç»è¿‡compareæ£€æµ‹ï¼Œæ­¤æ—¶å­˜æ¬¾å®é™…å€¼ä¹Ÿæ˜¯100ï¼Œæ‰€ä»¥ä¼šæˆåŠŸæŠŠå˜é‡å€¼100æ›´æ–°æˆ50ã€‚</p><blockquote><p>å¦‚ä½•è§£å†³ï¼Ÿ</p></blockquote><p>æ•°æ®åº“å±‚é¢è¦è§£å†³ ç‰ˆæœ¬å·</p><p>Javaå±‚é¢ <code>AtomicStampedReference</code>å’Œ<code>AtomicMarkableReference</code></p><p>AtomicStampedReference åˆ©ç”¨ä¸€ä¸ªintç±»å‹çš„æ ‡è®°æ¥è®°å½•ï¼Œå®ƒèƒ½å¤Ÿè®°å½•æ”¹å˜çš„æ¬¡æ•°ã€‚</p><p>AtomicMarkableReference åˆ©ç”¨ä¸€ä¸ªbooleanç±»å‹çš„æ ‡è®°æ¥è®°å½•ï¼Œåªèƒ½è®°å½•å®ƒæ”¹å˜è¿‡ï¼Œä¸èƒ½è®°å½•æ”¹å˜çš„æ¬¡æ•°</p>              </div>            </details><hr><h2 id="çº¿ç¨‹æ± "><a href="#çº¿ç¨‹æ± " class="headerlink" title="çº¿ç¨‹æ± "></a>çº¿ç¨‹æ± </h2><p><a href="https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html"><a href="https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html">Javaçº¿ç¨‹æ± å®ç°åŸç†åŠå…¶åœ¨ç¾å›¢ä¸šåŠ¡ä¸­çš„å®è·µ</a></a></p><details class="folding-tag" cyan close><summary> çº¿ç¨‹æ± å¸¸è§å‚æ•°æœ‰å“ªäº›ï¼Ÿ çº¿ç¨‹æ± çº¿ç¨‹æ•°è¯¥å¦‚ä½•é…ç½®ï¼Ÿ </summary>              <div class='content'>              <p><mark class="hl-label blue">CPUå¯†é›†å‹</mark> </p><p>CPUå¯†é›†å‹ä¹Ÿå°±æ˜¯è®¡ç®—å¯†é›†å‹ï¼Œé«˜å¹¶å‘ã€ä»»åŠ¡æ‰§è¡Œæ—¶é—´çŸ­ â€”&gt;ï¼ˆ æ ¸å¿ƒçº¿ç¨‹æ•° = CPUæ ¸æ•°+1 ï¼‰ï¼Œå‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ ã€‚</p><p>è®¡ç®—å‹ä»£ç ã€Bitmapè½¬æ¢ã€Gsonè½¬æ¢</p><p>ä¸ºäº†åº”å¯¹çº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿçš„ç¼ºé¡µä¸­æ–­æˆ–å…¶ä»–å¼‚å¸¸å¯¼è‡´çš„çº¿ç¨‹é˜»å¡è¯·æ±‚ï¼Œé¢å¤–å†å¤šè®¾ç½®ä¸€ä¸ªçº¿ç¨‹ï¼Œå½“æŸä¸ªçº¿ç¨‹æš‚æ—¶ä¸éœ€è¦CPUæ—¶ï¼Œå¯ä»¥ç”±æ›¿è¡¥çº¿ç¨‹ç»§ç»­æ¥åˆ©ç”¨CPUã€‚</p><p><mark class="hl-label green">IOå¯†é›†å‹</mark> </p><p>IOå¯†é›†å‹æ˜¯æŒ‡æˆ‘ä»¬ç¨‹åºæ›´å¤šçš„å·¥ä½œæ˜¯åœ¨é€šè¿‡ç£ç›˜ã€å†…å­˜æˆ–è€…æ˜¯ç½‘ç»œè¯»å–æ•°æ®ï¼Œåœ¨IOæœŸé—´æˆ‘ä»¬çº¿ç¨‹æ˜¯é˜»å¡çš„ï¼Œè¿™æœŸé—´CPUå…¶å®ä¹Ÿæ˜¯ç©ºé—²çš„ï¼Œè¿™æ ·æˆ‘ä»¬çš„æ“ä½œç³»ç»Ÿå°±å¯ä»¥åˆ‡æ¢å…¶ä»–çº¿ç¨‹æ¥ä½¿ç”¨CPUèµ„æºã€‚(æ ¸å¿ƒçº¿ç¨‹æ•° = CPUæ ¸æ•° * 2 )</p><p>æ–‡ä»¶è¯»å†™ã€DBè¯»å†™ã€ç½‘ç»œè¯·æ±‚</p><p> çº¿ç¨‹åœ¨æ‰§è¡ŒIOå‹ä»»åŠ¡æ—¶ï¼Œå¯èƒ½å¤§éƒ¨åˆ†æ—¶é—´éƒ½é˜»å¡åœ¨IOä¸Šï¼Œå‡å¦‚ç°åœ¨æœ‰10ä¸ªCPUï¼Œå¦‚æœæˆ‘ä»¬åªè®¾ç½®äº†10ä¸ªæ ¸å¿ƒçº¿ç¨‹æ¥æ‰§è¡ŒIOå‹ä»»åŠ¡ï¼Œé‚£ä¹ˆè¿™10ä¸ªçº¿ç¨‹å¯èƒ½éƒ½é˜»å¡åœ¨äº†IOä¸Šï¼Œè¿™æ ·10ä¸ªCPUå°±æ²¡æ´»å¹²äº†ï¼Œæ‰€ä»¥ï¼Œå¯¹äºIOå‹ä»»åŠ¡ï¼Œæ ¸å¿ƒçº¿ç¨‹æ•° = CPUæ ¸æ•° * 2</p><p>æ³¨ï¼šIOå¯†é›†å‹ï¼ˆæŸå¤§å‚å®è·µç»éªŒï¼‰<br>æ ¸å¿ƒçº¿ç¨‹æ•° = CPUæ ¸æ•° / ï¼ˆ1-é˜»å¡ç³»æ•°ï¼‰ ä¾‹å¦‚é˜»å¡ç³»æ•° 0.8ï¼ŒCPUæ ¸æ•°ä¸º4</p><p>æ ¸å¿ƒçº¿ç¨‹æ•°= CPUæ ¸æ•° * ï¼ˆ1 + çº¿ç¨‹ç­‰å¾…æ—¶é—´ / çº¿ç¨‹è¿è¡Œæ€»æ—¶é—´ ï¼‰</p><p>å¯ä»¥ä½¿ç”¨å·¥å…·æ£€æµ‹</p><p>åˆ™æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º20</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240302151707280.png" alt="image-20240302151707280" style="zoom:50%;" /></p>              </div>            </details><hr><details class="folding-tag" green close><summary> çº¿ç¨‹æ± executeå’Œsubmitæœ‰ä½•åŒºåˆ«ï¼Ÿ  å‡ºç°å¼‚å¸¸æ—¶æœ‰ä½•ä¸åŒï¼Ÿ </summary>              <div class='content'>              <p>submitæ–¹æ³•å’Œexecuteæ–¹æ³•æœ€å¤§çš„ä¸åŒç‚¹åœ¨äºsubmitæ–¹æ³•å¯ä»¥è·å–åˆ°ä»»åŠ¡è¿”å›å€¼æˆ–ä»»åŠ¡å¼‚å¸¸ä¿¡æ¯ï¼Œexecuteæ–¹æ³•ä¸èƒ½è·å–ä»»åŠ¡è¿”å›å€¼å’Œå¼‚å¸¸ä¿¡æ¯ã€‚</p><p>æ‰§è¡Œ <code>execute</code> æ–¹æ³•ï¼Œå½“ä»»åŠ¡æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå½“å‰çº¿ç¨‹ä¼šç»ˆæ­¢ï¼Œä¸”ä¼šæ‰“å°å¼‚å¸¸ä¿¡æ¯ã€‚</p><p>æ‰§è¡Œ <code>submit</code> æ–¹æ³•ï¼Œå½“ä»»åŠ¡æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå½“å‰çº¿ç¨‹ä¸ä¼šç»ˆæ­¢ï¼Œä¸ä¼šæ‰“å°å¼‚å¸¸ä¿¡æ¯ï¼Œåªæœ‰åœ¨è°ƒç”¨ get æ–¹æ³•çš„æ—¶å€™ï¼Œæ‰ä¼šæ‰“å°å¼‚å¸¸ä¿¡æ¯ã€‚</p><p>è§£å†³æ–¹æ³•:</p><blockquote><p>1.ä½¿ç”¨try-catchä»£ç å—</p></blockquote><p>åœ¨çº¿ç¨‹çš„ run() æ–¹æ³•ä¸­åŠ å…¥ try-catch ä»£ç å—ï¼Œé¿å…è¿è¡Œæ—¶å¼‚å¸¸ï¼ŒåŒæ—¶å¯ä»¥åœ¨ catch å—ä¸­è®°å½•å¼‚å¸¸æ—¥å¿—ã€‚</p><p>çº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡æŠ›å‡ºçš„å¼‚å¸¸ä¼šè¢«è‡ªèº«çš„ try-catch ä»£ç å—æ•è·ï¼Œä»è€Œé˜²æ­¢å·¥ä½œçº¿ç¨‹å› å¼‚å¸¸è€Œæ„å¤–é€€å‡ºã€‚è¿™æ„å‘³ç€ processWorkerExit æ–¹æ³•ä¸ä¼šè¢«æ‰§è¡Œã€‚</p><blockquote><p>2.çº¿ç¨‹è®¾ç½®UncaughtExceptionHandler</p></blockquote><p>åœ¨ç¬¬ä¸€ä¸ªæ–¹æ³•ä¸­ï¼Œæ¯ä¸ªä»»åŠ¡éƒ½éœ€è¦æ‰‹åŠ¨æ·»åŠ  try-catch ä»£ç å—ï¼Œè¿™æ ·åšéå¸¸éº»çƒ¦ä¸”ä¸ä¿é™©ã€‚å¦‚æœæœ‰äººå¿˜è®°äº†æ·»åŠ  try-catch ä»£ç å—ï¼Œåœ¨ä»»åŠ¡å‡ºç°å¼‚å¸¸æ—¶ï¼Œçº¿ç¨‹æ± ä¼šé¢‘ç¹åˆ é™¤å¼‚å¸¸çš„å·¥ä½œçº¿ç¨‹å¹¶åˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹ï¼Œè¿™æ ·ä¼šä¸¥é‡å½±å“çº¿ç¨‹æ± çš„æ€§èƒ½ã€‚</p><p>å¯ä»¥ä½¿ç”¨ Thread.setDefaultUncaughtExceptionHandler æ–¹æ³•è®¾ç½®ä¸€ä¸ªå…¨å±€é»˜è®¤çš„æœªæ•è·å¼‚å¸¸å¤„ç†å™¨ï¼Œè¯¥å¤„ç†å™¨ä¼šé€‚ç”¨äºæ‰€æœ‰çº¿ç¨‹ã€‚æ— è®ºæ˜¯ä¸»çº¿ç¨‹è¿˜æ˜¯åˆ›å»ºçš„å…¶ä»–çº¿ç¨‹ï¼Œåœ¨å‘ç”Ÿæœªæ•è·å¼‚å¸¸æ—¶éƒ½å°†è¢«è¯¥å¤„ç†å™¨å¤„ç†ã€‚</p><p>ä½†æ˜¯è¯¥æ–¹æ³•æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol><li>å½“ submit æ–¹æ³•æäº¤çš„ä»»åŠ¡å‡ºç°å¼‚å¸¸æ—¶ï¼Œä»ç„¶æ— æ³•å¤„ç†è¯¥å¼‚å¸¸ã€‚</li><li>çº¿ç¨‹æ± ä»ç„¶ä¼šåˆ é™¤å¼‚å¸¸çš„å·¥ä½œçº¿ç¨‹å¹¶åˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹ï¼Œè¿™å¹¶æ²¡æœ‰é¿å…çº¿ç¨‹æ± çš„æ€§èƒ½æŸè€—ã€‚</li></ol><p>æ‰€ä»¥ä¸æ¨èä½¿ç”¨æœªæ•è·å¼‚å¸¸å¤„ç†å™¨æ¥å¤„ç†çº¿ç¨‹å¼‚å¸¸</p><blockquote><p>3.ç»§æ‰¿ThreadPoolExecutoré‡å†™afterExecuteæ–¹æ³•</p><p>4.å®ç°ThreadFactoryï¼Œè‡ªå®šä¹‰çº¿ç¨‹å·¥å‚ç±»ï¼ˆæ¨èï¼‰</p></blockquote><p>è‡ªå®šä¹‰çº¿ç¨‹å·¥å‚æ–¹æ³•ï¼Œä¸ºæ¯ä¸€ä¸ª run æ–¹æ³•æ·»åŠ  try-catch ä»£ç å—</p><p>æ˜¾ç„¶ï¼Œå½“ä½¿ç”¨ submit æ–¹æ³•æäº¤çš„ä»»åŠ¡å‡ºç°å¼‚å¸¸æ—¶ï¼Œä»ç„¶æ— æ³•è¿›è¡Œå¤„ç†ã€‚ç„¶è€Œï¼Œæˆ‘ä»ç„¶æ¨èä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œå› ä¸ºå®ƒè‡³å°‘è§£å†³äº†åœ¨ execute æ–¹æ³•ä¸­ä»»åŠ¡å‡ºç°å¼‚å¸¸çš„æƒ…å†µã€‚å¯¹äº FutureTask çš„å¼‚å¸¸ï¼Œè°ƒç”¨æ–¹éœ€è¦è‡ªè¡Œå¤„ç†ï¼Œå› ä¸º FutureTask è®¾è®¡çš„æœ¬æ„å°±æ˜¯å°†ç»“æœäº¤ç»™è°ƒç”¨æ–¹å¤„ç†ï¼Œè¿™ä¸ªç»“æœä¹ŸåŒ…å«å¼‚å¸¸ã€‚</p>              </div>            </details><hr><h2 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h2><details class="folding-tag" blue close><summary> Threadã€ThreadLocalå’ŒThreadLocalMapå…³ç³»ï¼Ÿ </summary>              <div class='content'>              <ul><li>Threadç±»ä¸­æœ‰ä¸€ä¸ªThreadLocal.ThreadLocalMap threadLocals = nullçš„å˜é‡,è¿™ä¸ªThreadLocalç›¸å½“äºæ˜¯Threadç±»å’ŒThreadLocalMapçš„æ¡¥æ¢,åœ¨ThreadLocalä¸­æœ‰é™æ€å†…éƒ¨ç±»ThreadLocalMap,ThreadLocalMapä¸­æœ‰Entryæ•°ç»„</li><li><span class='p blue'>å½“æˆ‘ä»¬ä¸ºthreadLocalå˜é‡èµ‹å€¼ï¼Œå®é™…ä¸Šå°±æ˜¯ä»¥å½“å‰threadLocalå®ä¾‹ä¸ºkeyï¼Œå€¼ä¸ºvalueçš„Entryï¼Œå¾€å½“å‰çº¿ç¨‹çš„threadLocalMapä¸­å­˜æ”¾</span></li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230405210717894.png" alt="image-20230405210717894" style="zoom:50%;" /></p><p>ThreadLocalMapä»å­—é¢ä¸Šå°±å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªä¿å­˜ThreadLocalå¯¹è±¡çš„map(å…¶å®æ˜¯ä»¥ThreadLocalä¸ºKey)ï¼Œä¸è¿‡æ˜¯ç»è¿‡äº†ä¸¤å±‚åŒ…è£…çš„ThreadLocalå¯¹è±¡ã€‚</p>              </div>            </details><hr><details class="folding-tag" blue close><summary> ä¸ºä»€ä¹ˆ ThreadLocalMap çš„ Entry ä¸­çš„ key è®¾ç½®ä¸ºå¼±å¼•ç”¨ï¼Ÿ </summary>              <div class='content'>              <p>å¼ºè½¯å¼±è™š</p><p>ThreadLocalMapçš„Entryå¯¹ThreadLocalçš„çš„å¼•ç”¨ä¸ºå¼±å¼•ç”¨ï¼Œé¿å…äº†ThreadLocalå¯¹è±¡æ— æ³•è¢«å›æ”¶çš„é—®é¢˜ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230405230616586.png" alt="image-20230405230616586" style="zoom:50%;" /></p><p>valueä¸ºå¼ºå¼•ç”¨ï¼Œå¦‚æœä¸æ¸…ç†Entryå¯èƒ½ä¼šç…§æˆæ³„æ¼ã€‚</p><p>å…»æˆä¹ æƒ¯ç”¨å®Œå°±removeã€‚</p>              </div>            </details><hr><h2 id="ç±»åŠ è½½å­ç³»ç»Ÿ"><a href="#ç±»åŠ è½½å­ç³»ç»Ÿ" class="headerlink" title="ç±»åŠ è½½å­ç³»ç»Ÿ"></a>ç±»åŠ è½½å­ç³»ç»Ÿ</h2><details class="folding-tag" blue close><summary> ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æœºåˆ¶? æœ‰ä»€ä¹ˆä½œç”¨? å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶? </summary>              <div class='content'>              <p>åŒäº²å§”æ´¾æœºåˆ¶æŒ‡çš„æ˜¯ï¼šå½“ä¸€ä¸ªç±»åŠ è½½å™¨æ¥æ”¶åˆ°åŠ è½½ç±»çš„ä»»åŠ¡æ—¶ï¼Œä¼šå‘ä¸Šäº¤ç»™çˆ¶ç±»åŠ è½½å™¨æŸ¥æ‰¾æ˜¯å¦åŠ è½½è¿‡ï¼Œå†ç”±é¡¶å‘ä¸‹è¿›è¡ŒåŠ è½½ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240315184540249.png" alt="image-20240315184540249" style="zoom:33%;" /></p><p><mark class="hl-label blue">åŒäº²å§”æ´¾æœºåˆ¶ä½œç”¨</mark> </p><p>1.ä¿è¯ç±»åŠ è½½çš„å®‰å…¨æ€§,é¿å…æ¶æ„ä»£ç æ›¿æ¢JDKä¸­çš„æ ¸å¿ƒç±»åº“</p><p>2.é¿å…é‡å¤åŠ è½½</p><p><mark class="hl-label green">å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶?</mark> </p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240315185126628.png" alt="image-20240315185126628" style="zoom:50%;" /></p><blockquote><p>é‡å†™loadClassæ–¹æ³•æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶</p></blockquote><p>åœ¨<code>loadClass</code>æ–¹æ³•ä¸­å®ç°äº†åŒäº²å§”æ´¾æœºåˆ¶,æƒ³è¦æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶å°±å¿…é¡»é‡å†™<code>loadClass</code>æ–¹æ³•,å°†å…¶ä¸­åŒäº²å§”æ´¾æœºåˆ¶ä»£ç å»æ‰.</p><p>Tomcatçš„è‡ªå®šä¹‰ ç±»åŠ è½½å™¨<code>ParallelWebappClassLoader</code>å°±æ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶,è‡ªå·±åŠ è½½è€Œä¸äº¤ç»™çˆ¶ç±»åŠ è½½,å®ç°äº†åº”ç”¨çš„éš”ç¦».</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240315185854247.png" alt="image-20240315185854247" style="zoom:50%;" /></p><blockquote><p>çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨æ‰“ç ´åŒäº²å§”æ´¾   ä¾‹ï¼šJDBC</p></blockquote><p>JDBCä¸­ä½¿ç”¨äº†<code>DriverManager</code>æ¥ç®¡ç†é¡¹ç›®ä¸­å¼•å…¥çš„ä¸åŒæ•°æ®åº“çš„é©±åŠ¨ï¼Œæ¯”å¦‚mysqlé©±åŠ¨ã€oracleé©±åŠ¨ã€‚</p><p>DriverManagerå±äºrt.jaræ˜¯å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½çš„ã€‚è€Œç”¨æˆ·jaråŒ…ä¸­çš„é©±åŠ¨éœ€è¦ç”±åº”ç”¨ç±»åŠ è½½å™¨åŠ è½½ï¼Œè¿™å°±è¿åäº†åŒäº²å§”æ´¾æœºåˆ¶ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240317160601180.png" alt="image-20240317160601180" style="zoom:50%;" /></p>              </div>            </details><hr><details class="folding-tag" green close><summary> ç±»çš„ç”Ÿå‘½å‘¨æœŸ </summary>              <div class='content'>              <p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240320192522730.png" alt="image-20240320192522730"></p>              </div>            </details><h2 id="è¿è¡Œæ—¶æ•°æ®åŒº"><a href="#è¿è¡Œæ—¶æ•°æ®åŒº" class="headerlink" title="è¿è¡Œæ—¶æ•°æ®åŒº"></a>è¿è¡Œæ—¶æ•°æ®åŒº</h2><details class="folding-tag" cyan close><summary> æ ˆã€å †ã€æ–¹æ³•åŒºçš„äº¤äº’å…³ç³» </summary>              <div class='content'>              <ol><li>Person ç±»çš„ .class ä¿¡æ¯å­˜æ”¾åœ¨æ–¹æ³•åŒºä¸­</li><li>person å˜é‡å­˜æ”¾åœ¨ Java æ ˆçš„å±€éƒ¨å˜é‡è¡¨ä¸­</li><li>çœŸæ­£çš„ person å¯¹è±¡å­˜æ”¾åœ¨ Java å †ä¸­</li><li>åœ¨ person å¯¹è±¡ä¸­ï¼Œæœ‰ä¸ªæŒ‡é’ˆæŒ‡å‘æ–¹æ³•åŒºä¸­çš„ person ç±»å‹æ•°æ®ï¼Œè¡¨æ˜è¿™ä¸ª person å¯¹è±¡æ˜¯ç”¨æ–¹æ³•åŒºä¸­çš„ Person ç±» new å‡ºæ¥çš„</li></ol><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/b9f11764ee47b28d37f7764dfd9c9f55.png" style="zoom:50%;" /></p>              </div>            </details><hr><details class="folding-tag" green close><summary> å¸¸é‡æ± ã€è¿è¡Œæ—¶å¸¸é‡æ± å’Œå­—ç¬¦ä¸²å¸¸é‡æ±    æ¼”è¿› itern() </summary>              <div class='content'>              <p>å½“ç±»åŠ è½½åˆ°å†…å­˜ä¸­åï¼ŒJVM å°±ä¼šå°† class æ–‡ä»¶å¸¸é‡æ± ä¸­çš„å†…å®¹å­˜æ”¾åˆ°è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ï¼Œæ¯ä¸ª.classå¯¹åº”æœ‰ä¸€ä¸ªè¿è¡Œæ—¶å¸¸é‡æ± ã€‚</p><p><mark class="hl-label red">JDK6</mark> </p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1a3aa55257c3150d78327542e5ca230e.png" alt="image-20200708211541300" style="zoom:50%;" /></p><p><mark class="hl-label blue">JDK7</mark> </p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/e0f65fc4228d9b6573ae1b23d9a1558b.png" alt="image-20200708211609911" style="zoom:50%;" /></p><p><mark class="hl-label pink">JDK8</mark> </p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/c3ed969b0d2bad704c22481208e5dd10.png" alt="image-20200708211637952" style="zoom:50%;" /></p><p>jdk7 ç‰ˆæœ¬å¯¹ intern æ“ä½œå’Œå¸¸é‡æ± éƒ½åšäº†ä¸€å®šçš„ä¿®æ”¹ã€‚ä¸»è¦åŒ…æ‹¬2ç‚¹ï¼š</p><ul><li>å°†Stringå¸¸é‡æ±  ä» Perm åŒºç§»åŠ¨åˆ°äº† Java HeapåŒº</li><li><code>String#intern</code> æ–¹æ³•æ—¶ï¼Œå¦‚æœå­˜åœ¨å †ä¸­çš„å¯¹è±¡ï¼Œä¼šç›´æ¥ä¿å­˜å¯¹è±¡çš„å¼•ç”¨ï¼Œè€Œä¸ä¼šé‡æ–°åˆ›å»ºå¯¹è±¡ï¼ˆè€ŒJDK6ä¼šåˆ›å»ºï¼‰ã€‚</li></ul><p><a href="https://tech.meituan.com/2014/03/06/in-depth-understanding-string-intern.html">https://tech.meituan.com/2014/03/06/in-depth-understanding-string-intern.html</a></p>              </div>            </details><hr><h2 id="åƒåœ¾å›æ”¶ç®—æ³•å’Œåƒåœ¾å›æ”¶å™¨"><a href="#åƒåœ¾å›æ”¶ç®—æ³•å’Œåƒåœ¾å›æ”¶å™¨" class="headerlink" title="åƒåœ¾å›æ”¶ç®—æ³•å’Œåƒåœ¾å›æ”¶å™¨"></a>åƒåœ¾å›æ”¶ç®—æ³•å’Œåƒåœ¾å›æ”¶å™¨</h2><details class="folding-tag" cyan close><summary> å“ªäº›å¯¹è±¡å¯ä»¥ä½œä¸º GC Roots å‘¢ï¼Ÿ </summary>              <div class='content'>              <p>è™šæ‹Ÿæœºæ ˆ(æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡è¡¨)ä¸­å¼•ç”¨çš„å¯¹è±¡</p><p>æœ¬åœ°æ–¹æ³•æ ˆ(Native æ–¹æ³•)ä¸­å¼•ç”¨çš„å¯¹è±¡</p><p>æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡</p><p>æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡</p><p>æ‰€æœ‰è¢«åŒæ­¥é”æŒæœ‰çš„å¯¹è±¡</p><p>JNIï¼ˆJava Native Interfaceï¼‰å¼•ç”¨çš„å¯¹è±¡</p>              </div>            </details><hr><details class="folding-tag" green close><summary> åƒåœ¾å›æ”¶ç®—æ³• </summary>              <div class='content'>              <p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240318093257349.png" alt="image-20240318093257349"></p>              </div>            </details><hr><details class="folding-tag" green close><summary> å¸¸ç”¨çš„åƒåœ¾å›æ”¶å™¨ </summary>              <div class='content'>              <p>ç”±äºåƒåœ¾å›æ”¶å™¨åˆ†ä¸ºå¹´è½»ä»£å’Œè€å¹´ä»£ï¼Œé™¤äº†G1ä¹‹å¤–å…¶ä»–åƒåœ¾å›æ”¶å™¨å¿…é¡»æˆå¯¹ç»„åˆè¿›è¡Œä½¿ç”¨ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240318095326219.png" alt="image-20240318095326219" style="zoom: 50%;" /></p><blockquote><p>Serial + Serial Old   å•çº¿ç¨‹ä¸²è¡Œ</p></blockquote><p>å•CPUå¤„ç†å™¨ä¸‹ååé‡éå¸¸å‡ºè‰² å¤šCPUå¤„ç†å™¨ä¼šè®©ç”¨æˆ·çº¿ç¨‹å¤„äºé•¿æ—¶é—´ç­‰å¾…</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240318095609643.png" alt="image-20240318095609643"></p><blockquote><p>ParNew + CMS</p></blockquote><p>ParNewåƒåœ¾å›æ”¶å™¨æœ¬è´¨ä¸Šæ˜¯å¯¹Serialåœ¨å¤šCPUä¸‹çš„ä¼˜åŒ–ï¼Œä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œåƒåœ¾å›æ”¶ã€‚å¤šCPUå¤„ç†å™¨ä¸‹åœé¡¿æ—¶é—´è¾ƒçŸ­ã€‚ååé‡å’Œåœé¡¿æ—¶é—´ä¸å¦‚G1ï¼Œ æ‰€ä»¥åœ¨JDK9ä¹‹åä¸å»ºè®®ä½¿ç”¨ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240318101050149.png" alt="image-20240318101050149" style="zoom:25%;" /></p><p>CMSï¼ˆConcurrent Mark Sweepï¼‰å¹¶å‘æ ‡è®°æ¸…é™¤</p><p>CMSåƒåœ¾å›æ”¶å™¨å…³æ³¨çš„æ˜¯ç³»ç»Ÿçš„æš‚åœæ—¶é—´ï¼Œ å…è®¸ç”¨æˆ·çº¿ç¨‹å’Œåƒåœ¾å›æ”¶çº¿ç¨‹åœ¨æŸäº›æ­¥éª¤ä¸­åŒæ—¶æ‰§è¡Œï¼Œå‡å°‘äº†ç”¨æˆ·çº¿ç¨‹çš„ç­‰å¾…æ—¶é—´ï¼Œç³»ç»Ÿç”±äºåƒåœ¾å›æ”¶å‡ºç°çš„åœé¡¿æ—¶é—´è¾ƒçŸ­ï¼Œç”¨æˆ·ä½“éªŒå¥½ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240318101200261.png" alt="image-20240318101200261" style="zoom:25%;" /></p><p>ç¼ºç‚¹</p><p>1ã€å†…å­˜ç¢ç‰‡é—®é¢˜ -  å¯ä»¥è®¾ç½®å‚æ•°Næ¬¡FULL GC åå†æ•´ç†<br>2ã€æµ®åŠ¨åƒåœ¾é—®é¢˜ </p><p>3ã€é€€åŒ–é—®é¢˜ - å¦‚æœè€å¹´ä»£å†…å­˜ä¸è¶³æ— æ³•åˆ†é…å¯¹è±¡ï¼ŒCMSå°±ä¼šé€€åŒ–æˆSerial Oldå•çº¿ç¨‹å›æ”¶è€å¹´ä»£</p><p>CMSçš„å¹¶å‘æ¨¡å¼å¤±è´¥ ï¼ˆconcurrent mode failureï¼‰ ç°è±¡ã€‚ç”±äºCMSçš„åƒåœ¾æ¸…ç†çº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹æ˜¯å¹¶è¡Œè¿›è¡Œçš„ï¼Œå¦‚æœåœ¨å¹¶å‘æ¸…ç†çš„è¿‡ç¨‹ä¸­è€å¹´ä»£çš„ç©ºé—´ä¸è¶³ä»¥å®¹çº³æ”¾å…¥è€å¹´ä»£çš„å¯¹è±¡ï¼Œä¼šäº§ç”Ÿå¹¶å‘æ¨¡å¼å¤±è´¥ã€‚å¹¶å‘æ¨¡å¼å¤±è´¥ä¼šå¯¼è‡´Javaè™šæ‹Ÿæœºä½¿ç”¨Serial oldå•çº¿ç¨‹è¿›è¡ŒFULLGCå›æ”¶è€å¹´ä»£ï¼Œå‡ºç°é•¿æ—¶é—´çš„åœé¡¿ã€‚</p><p>å¯ä»¥è®¾ç½®å‚æ•°æå‰è¿›è¡Œå›æ”¶ </p><blockquote><p>Parallel Scavenge + Parallel Old</p></blockquote><p>Parallel Scavengeæ˜¯JDK8é»˜è®¤çš„å¹´è½»ä»£åƒåœ¾å›æ”¶å™¨ï¼Œå¤šçº¿ç¨‹å¹¶è¡Œå›æ”¶ï¼Œå…³æ³¨çš„æ˜¯ç³»ç»Ÿçš„ååé‡ã€‚å…·å¤‡<span class='p red'>è‡ªåŠ¨è°ƒæ•´å †å†…å­˜å¤§å°</span>çš„ç‰¹ç‚¹ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240318102107265.png" alt="image-20240318102107265" style="zoom:25%;" /></p><p>Parallel Oldæ˜¯ä¸ºParallel Scavengeæ”¶é›†å™¨è®¾è®¡çš„è€å¹´ä»£ç‰ˆæœ¬ï¼Œåˆ©ç”¨å¤šçº¿ç¨‹å¹¶å‘æ”¶é›†ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240318102307415.png" alt="image-20240318102307415" style="zoom:25%;" /></p><p>åœ¨ä½¿ç”¨è¿™ä¸ªç»„åˆæ—¶ï¼Œä¸è¦è®¾ç½®å †å†…å­˜çš„æœ€å¤§å€¼ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šæ ¹æ®æœ€å¤§æš‚åœæ—¶é—´å’Œååé‡è‡ªåŠ¨è°ƒæ•´å†…å­˜å¤§å°ã€‚</p><blockquote><p>G1</p></blockquote><p>JDK9ä¹‹åé»˜è®¤çš„åƒåœ¾å›æ”¶å™¨æ˜¯G1 ï¼ˆGarbage Firstï¼‰åƒåœ¾å›æ”¶å™¨ã€‚</p><p>Parallel Scavengeå…³æ³¨ååé‡ï¼Œå…è®¸ç”¨æˆ·è®¾ç½®æœ€å¤§æš‚åœæ—¶é—´ï¼Œä½†æ˜¯ä¼šå‡å°‘å¹´è½»ä»£å¯ç”¨ç©ºé—´çš„å¤§å°ã€‚</p><p>CMSå…³æ³¨æš‚åœæ—¶é—´ï¼Œä½†æ˜¯ååé‡æ–¹é¢ä¼šä¸‹é™ã€‚</p><p>è€ŒG1è®¾è®¡ç›®æ ‡å°±æ˜¯å°†ä¸Šè¿°ä¸¤ç§åƒåœ¾å›æ”¶å™¨çš„ä¼˜ç‚¹èåˆï¼š</p><p>1.æ”¯æŒå·¨å¤§çš„å †ç©ºé—´å›æ”¶ï¼Œå¹¶æœ‰è¾ƒé«˜çš„ååé‡ã€‚<br>2.æ”¯æŒå¤šCPUå¹¶è¡Œåƒåœ¾å›æ”¶ã€‚<br>3.å…è®¸ç”¨æˆ·è®¾ç½®æœ€å¤§æš‚åœæ—¶é—´ã€‚</p><p>G1çš„æ•´ä¸ªå †ä¼šè¢«åˆ’åˆ†æˆå¤šä¸ªå¤§å°ç›¸ç­‰çš„åŒºåŸŸï¼Œç§°ä¹‹ä¸ºåŒºRegionï¼ŒåŒºåŸŸä¸è¦æ±‚æ˜¯è¿ç»­çš„ã€‚åˆ†ä¸ºEdenã€Survivorã€OldåŒºã€‚Regionçš„å¤§å°é€šè¿‡å †ç©ºé—´å¤§å°/2048è®¡ç®—å¾—åˆ°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å‚æ•°-XX:G1HeapRegionSize=32mæŒ‡å®šï¼ˆå…¶ä¸­32mæŒ‡å®šregionå¤§å°ä¸º32Mï¼‰ï¼ŒRegion sizeå¿…é¡»æ˜¯2çš„æŒ‡æ•°å¹‚ï¼Œå–å€¼èŒƒå›´ä»1Måˆ°32Mã€‚</p><p>G1åƒåœ¾å›æ”¶æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><p>1ã€å¹´è½»ä»£å›æ”¶ ï¼ˆYoung GCï¼‰  å›æ”¶EdenåŒºå’ŒSurvivoråŒºä¸­ä¸ç”¨çš„å¯¹è±¡ã€‚ä¼šå¯¼è‡´STW,é‡‡ç”¨å¤åˆ¶ç®—æ³•ã€‚æ ¹æ®é…ç½®çš„æœ€å¤§æš‚åœæ—¶é—´è®¡ç®—å‡ºæœ¬æ¬¡å›æ”¶æ—¶æœ€å¤šèƒ½å›æ”¶å¤šå°‘ä¸ªRegion ä¿è¯æœ€å¤§æš‚åœæ—¶é—´ã€‚éƒ¨åˆ†å¯¹è±¡å¦‚æœå¤§å°è¶…è¿‡Regionçš„ä¸€åŠï¼Œä¼šç›´æ¥æ”¾å…¥è€å¹´ä»£ï¼Œè¿™ç±»è€å¹´ä»£è¢«ç§°ä¸ºHumongousåŒºã€‚æ¯”å¦‚æ¯ä¸ªRegionæ˜¯2Mï¼Œåªè¦ä¸€ä¸ªå¤§å¯¹è±¡è¶…è¿‡äº†1Må°±è¢«æ”¾å…¥ HumongousåŒºï¼Œå¦‚æœå¯¹è±¡è¿‡å¤§ä¼šæ¨ªè·¨å¤šä¸ªRegionã€‚</p><p>2ã€æ··åˆå›æ”¶ï¼ˆMixed GCï¼‰ å›æ”¶æ‰€æœ‰çš„å¹´è½»ä»£å’Œéƒ¨åˆ†è€å¹´ä»£çš„çš„å¯¹è±¡ä»¥åŠå¤§å¯¹è±¡åŒºã€‚é‡‡ç”¨å¤åˆ¶ç®—æ³•å®Œæˆã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240318104441766.png" alt="image-20240318104441766" style="zoom:33%;" /></p><p>æ³¨æ„ï¼šå¦‚æœæ¸…ç†è¿‡ç¨‹ä¸­å‘ç°æ²¡æœ‰è¶³å¤Ÿçš„ç©ºRegionå­˜æ”¾è½¬ç§»çš„å¯¹è±¡ï¼Œä¼šå‡ºç°Full GCã€‚å•çº¿ç¨‹æ‰§è¡Œæ ‡è®°-æ•´ç†ç®—æ³•ï¼Œ æ­¤æ—¶ä¼šå¯¼è‡´ç”¨æˆ·çº¿ç¨‹çš„æš‚åœã€‚æ‰€ä»¥å°½é‡ä¿è¯åº”è¯¥ç”¨çš„å †å†…å­˜æœ‰ä¸€å®šå¤šä½™çš„ç©ºé—´ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240318112942651.png" alt="image-20240318112942651"></p><p>ZGCä½å»¶æ—¶ ä½†æ˜¯ååé‡å¯èƒ½ä¸ä½³ ä¼šè¿›è¡Œå¤šæ¬¡åƒåœ¾å›æ”¶</p>              </div>            </details><hr><h2 id="GCè°ƒä¼˜"><a href="#GCè°ƒä¼˜" class="headerlink" title="GCè°ƒä¼˜"></a>GCè°ƒä¼˜</h2><p><a href="https://tech.meituan.com/2020/11/12/java-9-cms-gc.html"><a href="https://tech.meituan.com/2020/11/12/java-9-cms-gc.html">Javaä¸­9ç§å¸¸è§çš„CMS GCé—®é¢˜åˆ†æä¸è§£å†³</a></a></p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240318162317624.png" alt="image-20240318162317624"></p><h2 id="å†…å­˜è°ƒä¼˜"><a href="#å†…å­˜è°ƒä¼˜" class="headerlink" title="å†…å­˜è°ƒä¼˜"></a>å†…å­˜è°ƒä¼˜</h2><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240318090040137.png" alt="image-20240318090040137"></p><hr><h2 id="Gitå·¥ä½œæµç¨‹"><a href="#Gitå·¥ä½œæµç¨‹" class="headerlink" title="Gitå·¥ä½œæµç¨‹"></a>Gitå·¥ä½œæµç¨‹</h2><p>4ä¸ªæ¦‚å¿µ: å·¥ä½œåŒº æš‚å­˜åŒº æœ¬åœ°ä»“åº“  è¿œç¨‹ä»“åº“</p><p>åˆ†æ”¯ç®¡ç†</p><p>å·¥ä½œæµ</p><p>master  release dev feature</p>]]></content>
    
    
    <summary type="html">JUC&amp;JVMé¢è¯•é¢˜</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="é¢è¯•é¢˜" scheme="https://wuwawawa.github.io/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    
  </entry>
  
  <entry>
    <title>JavaåŸºç¡€é¢è¯•é¢˜</title>
    <link href="https://wuwawawa.github.io/posts/2e67a3f3.html"/>
    <id>https://wuwawawa.github.io/posts/2e67a3f3.html</id>
    <published>2023-12-14T05:45:41.000Z</published>
    <updated>2024-04-07T13:50:21.914Z</updated>
    
    <content type="html"><![CDATA[<div class="table-container"><table><thead><tr><th style="text-align:center">ä¿®é¥°ç¬¦\æƒé™</th><th style="text-align:center">ç±»å†…éƒ¨</th><th style="text-align:center">åŒåŒ…</th><th style="text-align:center">å­ç±»éåŒåŒ…</th><th style="text-align:center">éåŒåŒ…éå­ç±»</th></tr></thead><tbody><tr><td style="text-align:center">private</td><td style="text-align:center">âˆš</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center"></td></tr><tr><td style="text-align:center">defalut</td><td style="text-align:center">âˆš</td><td style="text-align:center">âˆš</td><td style="text-align:center"></td><td style="text-align:center"></td></tr><tr><td style="text-align:center">protected</td><td style="text-align:center">âˆš</td><td style="text-align:center">âˆš</td><td style="text-align:center">âˆš</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">public</td><td style="text-align:center">âˆš</td><td style="text-align:center">âˆš</td><td style="text-align:center">âˆš</td><td style="text-align:center">âˆš</td></tr></tbody></table></div><h2 id="å°è£…ç»§æ‰¿å¤šæ€"><a href="#å°è£…ç»§æ‰¿å¤šæ€" class="headerlink" title="å°è£…ç»§æ‰¿å¤šæ€"></a>å°è£…ç»§æ‰¿å¤šæ€</h2><div class="tabs" id="8d28a2e3-d8a9-4e60-88b8-fb48aa3b6581"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#8d28a2e3-d8a9-4e60-88b8-fb48aa3b6581-1"><i class="fas fa-cat"></i>å°è£…</button></li><li class="tab"><button type="button" data-href="#8d28a2e3-d8a9-4e60-88b8-fb48aa3b6581-2"><i class="fas fa-horse"></i>ç»§æ‰¿</button></li><li class="tab"><button type="button" data-href="#8d28a2e3-d8a9-4e60-88b8-fb48aa3b6581-3"><i class="fas fa-dove"></i>å¤šæ€</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="8d28a2e3-d8a9-4e60-88b8-fb48aa3b6581-1"><p>å°†æ•°æ®å’Œæ–¹æ³•è¢«ä¿æŠ¤åœ¨ç±»çš„å†…éƒ¨ï¼Œå°½å¯èƒ½åœ°éšè—å†…éƒ¨çš„å®ç°ç»†èŠ‚ï¼Œåªä¿ç•™ä¸€äº›å¯¹å¤–æ¥å£ä½¿ä¹‹ä¸å¤–éƒ¨å‘ç”Ÿè”ç³»ã€‚</p><p>å¥½å¤„ï¼š</p><p>â€‹    å®‰å…¨æ€§ éšè—ä¿¡æ¯ï¼Œå®ç°ç»†èŠ‚ã€‚</p><p>â€‹    </p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8d28a2e3-d8a9-4e60-88b8-fb48aa3b6581-2"><p>å­ç±»å¯ä»¥é€šè¿‡ç»§æ‰¿ä»çˆ¶ç±»ä¸­è·å¾—çˆ¶ç±»çš„å±æ€§å’Œæ–¹æ³•ï¼ŒåŒæ—¶å¯ä»¥åœ¨å…¶åŸºç¡€ä¸Šè¿›è¡Œæ‰©å±•æˆ–è€…ä¿®æ”¹ï¼Œå®ç°ä»£ç çš„é‡ç”¨ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†ä¸€ç§åˆ†å±‚ç»“æ„ï¼Œå¯ä»¥æ›´å¥½åœ°ç»„ç»‡å’Œç®¡ç†ä»£ç ã€‚</p><p>é€šè¿‡ç»§æ‰¿ï¼Œå¯ä»¥å®ç°å¤šæ€æ€§</p><p>å­ç±»é‡å†™çˆ¶ç±»æ–¹æ³• ä¸¤åŒä¸¤å°ä¸€å¤§åŸåˆ™</p><p>ä¸¤åŒ: æ–¹æ³•åç›¸åŒ æ–¹æ³•å‚æ•°ç›¸åŒ</p><p>ä¸¤å°: å­ç±»æ–¹æ³•è¿”å›å€¼ç±»å‹åº”æ¯”çˆ¶ç±»æ–¹æ³•è¿”å›å€¼ç±»å‹æ›´å°æˆ–ç›¸ç­‰ï¼Œå­ç±»æ–¹æ³•å£°æ˜æŠ›å‡ºçš„å¼‚å¸¸ç±»åº”æ¯”çˆ¶ç±»æ–¹æ³•å£°æ˜æŠ›å‡ºçš„å¼‚å¸¸ç±»æ›´å°æˆ–ç›¸ç­‰</p><p>ä¸€å¤§: å­ç±»çš„è®¿é—®æƒé™ä¿®é¥°ç¬¦åº”æ¯”çˆ¶ç±»çš„è®¿é—®æƒé™ä¿®é¥°ç¬¦æ›´å¤§</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8d28a2e3-d8a9-4e60-88b8-fb48aa3b6581-3"><p>å¤šæ€æ˜¯åŒä¸€ä¸ªè¡Œä¸ºå…·æœ‰å¤šä¸ªä¸åŒè¡¨ç°å½¢å¼æˆ–å½¢æ€çš„èƒ½åŠ›ã€‚</p><p>å¤šæ€æ€§å¯ä»¥é€šè¿‡ç»§æ‰¿å’Œæ–¹æ³•é‡å†™æ¥å®ç°ã€‚å…·ä½“æ¥è¯´ï¼Œçˆ¶ç±»çš„å¼•ç”¨å¯ä»¥æŒ‡å‘å­ç±»çš„å¯¹è±¡ï¼Œå¹¶ä¸”è°ƒç”¨ç›¸åŒçš„æ–¹æ³•æ—¶ä¼šæ ¹æ®å®é™…çš„å¯¹è±¡ç±»å‹æ‰§è¡Œä¸åŒçš„ä»£ç ã€‚å¤šæ€æ€§ä½¿å¾—ä»£ç æ›´åŠ çµæ´»ï¼Œèƒ½å¤Ÿé€‚åº”ä¸åŒçš„éœ€æ±‚å’Œæƒ…å¢ƒï¼ŒåŒæ—¶ä¹Ÿæé«˜äº†ä»£ç çš„å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p><p>å¤šæ€æ€§ä½¿å¾—ä»£ç èƒ½å¤Ÿä»¥ä¸€ç§ç»Ÿä¸€çš„æ–¹å¼å¤„ç†ä¸åŒç±»å‹çš„å¯¹è±¡ï¼Œä»è€Œæé«˜äº†ä»£ç çš„å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h2 id="æŠ½è±¡ç±»ä¸æ¥å£"><a href="#æŠ½è±¡ç±»ä¸æ¥å£" class="headerlink" title="æŠ½è±¡ç±»ä¸æ¥å£"></a>æŠ½è±¡ç±»ä¸æ¥å£</h2><details class="folding-tag" cyan close><summary> æ¥å£ä¸æŠ½è±¡ç±»å¼‚åŒ </summary>              <div class='content'>              <p>éƒ½å¯ä»¥å®šä¹‰æŠ½è±¡æ–¹æ³•</p><p>éƒ½ä¸èƒ½åˆ›å»ºæœ¬ç±»å¯¹è±¡</p><hr><p>æŠ½è±¡ç±»ä¸ä¸€å®šéœ€è¦åŒ…å«æŠ½è±¡æ–¹æ³•ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªç±»ä¸­åŒ…å«æœ‰æŠ½è±¡æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å¿…é¡»å£°æ˜ä¸ºæŠ½è±¡ç±»ã€‚</p><p>(<code>AbstractQueuedSynchronizer</code>æ˜¯æŠ½è±¡ç±»ï¼Œä½†æ˜¯å…¶ä¸­å¹¶æ²¡æœ‰æŠ½è±¡æ–¹æ³•ã€‚æ—¢ç„¶AQSå®šä¹‰ä¸ºæŠ½è±¡ç±»ï¼Œé‚£ä¹ˆè¯¥å­ç±»å®ç°çš„æ–¹æ³•ä¸ºä»€ä¹ˆä¸å®šä¹‰ä¸ºæŠ½è±¡æ–¹æ³•å‘¢ï¼ŸAQSè®¾è®¡çš„åˆè¡·å°±æ˜¯ä¸ºå…¶å®ƒç»„ä»¶æä¾›ä¸€ä¸ªå¼ºå¤§çš„åŸºç¡€ï¼Œä¸å¸Œæœ›å…¶ä»–ç»„ä»¶ç›´æ¥æ‹¿æ¥ä½¿ç”¨ç›´æ¥new åˆ›å»ºå¯¹è±¡ï¼Œæ‰€ä»¥å®šä¹‰ä¸ºæŠ½è±¡ç±»ã€‚æ¨¡ç‰ˆæ–¹æ³•ï¼ŒæŒ‰éœ€é‡å†™ï¼Œå¦‚æœç›´æ¥ä½¿ç”¨åˆ™æŠ›å¼‚å¸¸)</p><p>æŠ½è±¡ç±»ä½¿ç”¨<code>extend</code>å…³é”®å­—ç»§æ‰¿ï¼Œæ¥å£ä½¿ç”¨<code>implement</code>å…³é”®å­—å®ç°</p><p>æŠ½è±¡ç±»å¯ä»¥å»å®ç°æ¥å£ï¼Œè€Œæ¥å£åªèƒ½ç»§æ‰¿æ¥å£ï¼Œä¸èƒ½ç»§æ‰¿ç±»ã€‚åŒæ—¶ä¸€ä¸ªç±»æœ€å¤šç»§æ‰¿ä¸€ä¸ªçˆ¶ç±»ï¼Œä½†å¯ä»¥å®ç°å¤šä¸ªæ¥å£ã€‚</p><p>æŠ½è±¡ç±»å¯ä»¥å®šä¹‰æˆå‘˜å±æ€§ï¼Œè€Œæ¥å£ä¸èƒ½å®šä¹‰æˆå‘˜å±æ€§ï¼Œåªèƒ½å®šä¹‰é™æ€å±æ€§ï¼Œè€Œä¸”åªèƒ½ç”¨<code>final</code>å…³é”®å­—å®šä¹‰é™æ€å¸¸é‡ã€‚</p><p>æ¥å£æ²¡æœ‰æ„é€ å™¨ï¼Œè€ŒæŠ½è±¡ç±»å¯ä»¥å®šä¹‰æ„é€ å™¨ï¼ˆé™å®šå­ç±»çš„æ„é€ è¡Œä¸ºï¼‰ã€‚</p><p>Java8ä¹‹åï¼Œæ¥å£å¯ä»¥å®šä¹‰é™æ€æ–¹æ³•ä»¥åŠå¯ä»¥ç”¨<code>default</code>å…³é”®å­—æ¥é»˜è®¤å®ç°æ–¹æ³•ã€‚è¢«<code>default</code>å…³é”®å­—ä¿®é¥°çš„æ–¹æ³•å°±ä¸æ˜¯æŠ½è±¡æ–¹æ³•ä¹Ÿå°±ä¸ä¼šå¼ºåˆ¶è¦æ±‚å­ç±»å»å®ç°æ–¹æ³•ã€‚</p><p>æ‰€ä»¥å½“æˆ‘ä»¬å‘ç°æ—¢å¯ä»¥ç”¨æŠ½è±¡ç±»ä¹Ÿå¯ä»¥ç”¨æ¥å£æ—¶ï¼Œå°½é‡å»é€‰æ‹©æ¥å£ã€‚ è¿™æ ·å­ç±»çš„çµæ´»åº¦ä¼šæ›´é«˜ã€‚</p><p>æŠ½è±¡ç±»æ›´è¿›ä¸€æ­¥åœ°æŠ½è±¡åå°±è¯ç”Ÿäº†æ¥å£ã€‚æ¥å£æ¯”æŠ½è±¡ç±»æ›´çº¯ç²¹ï¼Œå› ä¸ºå®ƒæ²¡æœ‰äº†æˆå‘˜å±æ€§ï¼Œåªæœ‰æ–¹æ³•ã€‚å­ç±»å®ç°æ¥å£åï¼Œå”¯ä¸€èƒ½åšçš„å°±æ˜¯é‡å†™æ–¹æ³•ã€‚ä¸åƒæŠ½è±¡ç±»ï¼Œå­ç±»ç»§æ‰¿æŠ½è±¡ç±»è¿å¸¦ç€å°†çˆ¶ç±»çš„æˆå‘˜å±æ€§ä¹Ÿç»§æ‰¿è¿‡æ¥äº†ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240306185159397.png" alt="image-20240306185159397"></p>              </div>            </details><hr><details class="folding-tag" green close><summary> æšä¸¾çš„æœ¬è´¨ </summary>              <div class='content'>              <p> å®šä¹‰æšä¸¾ç±»å‹æ—¶æœ¬è´¨ä¸Šå°±æ˜¯å®šä¹‰ä¸€ä¸ªç±»åˆ«ï¼Œåªä¸è¿‡å¾ˆå¤šç»†èŠ‚ç”±ç¼–è¯‘å™¨å¸®æˆ‘ä»¬å®Œæˆäº†ï¼Œæ‰€ä»¥æŸäº›ç¨‹åº¦ä¸Šï¼Œenumå…³é”®å­—çš„ä½œç”¨ å°±åƒæ˜¯classæˆ–interface</p><p>1 æšä¸¾çš„æœ¬è´¨ï¼šå…¶å®å°±æ˜¯ç»ˆæ­¢ç±»ï¼Œå¹¶ç»§æ‰¿EnumæŠ½è±¡ç±»ã€‚</p><p>2 æšä¸¾ä¸­çš„å˜é‡ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå½“å‰ç±»å‹çš„é™æ€å¸¸é‡ã€‚</p><p>æšä¸¾ç±»ä¹Ÿå¯ä»¥ç»§æ‰¿æ¥å£</p>              </div>            </details><hr><p><a href="https://blog.csdn.net/lisainan66/article/details/133135939">å¤šæ€ä¹‹çˆ¶ç±»å¼•ç”¨æŒ‡å‘å­ç±»å®ä¾‹</a></p><hr><h2 id="é›†åˆ"><a href="#é›†åˆ" class="headerlink" title="é›†åˆ"></a>é›†åˆ</h2><details class="folding-tag" cyan close><summary> ä½¿ç”¨foreachå†…éƒ¨è¿›è¡Œåˆ é™¤ï¼Œä¸ºä»€ä¹ˆä¼šæŠ›å‡ºå¼‚å¸¸ </summary>              <div class='content'>              <p>è¿­ä»£å™¨åœ¨éå†æ˜¯ç›´æ¥è®¿é—®é›†åˆä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”åœ¨éå†è¿‡ç¨‹ä¸­ä½¿ç”¨äº†ä¸€ä¸ª<code>modCount</code>å˜é‡ã€‚é›†åˆåœ¨è¢«éå†æœŸé—´ï¼Œå¦‚æœå®ƒçš„å†…å®¹å‘ç”Ÿäº†å˜åŒ–ï¼Œå°±ä¼šæ”¹å˜<code>modCount</code>å˜é‡çš„å€¼ã€‚è¿­ä»£å™¨åœ¨ä½¿ç”¨<code>hashNext()/next()</code>éå†ä¸‹ä¸€ä¸ªå…ƒç´ ä¹‹å‰ï¼Œä¼šæ£€æµ‹<code>modCount</code>å˜é‡æ˜¯å¦ä¸ºé¢„æœŸå€¼ï¼Œæ˜¯å°±è¿”å›éå†ï¼Œå¦åˆ™æŠ›å‡º<code>ConcurrentModificationException</code>å¼‚å¸¸    </p><p>æ­£ç¡®çš„æ–¹å¼æ˜¯ä½¿ç”¨ è¿­ä»£å™¨ å¯¹å…ƒç´ è¿›è¡Œåˆ é™¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ArrayList&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;() &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        add(<span class="number">1</span>);</span><br><span class="line">        add(<span class="number">2</span>);</span><br><span class="line">        add(<span class="number">3</span>);</span><br><span class="line">        add(<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">    Iterator&lt;Integer&gt; it = list.iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">cur</span> <span class="operator">=</span> it.next();</span><br><span class="line">        <span class="keyword">if</span> (cur == <span class="number">2</span>) &#123;</span><br><span class="line">            it.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="tag link"><a class="link-card" title="Listé›†åˆçš„éå†æ–¹å¼" href="/posts/494ad091.html#Listé›†åˆçš„éå†æ–¹å¼"><div class="left"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/favicon.png"/></div><div class="right"><p class="text">Listé›†åˆçš„éå†æ–¹å¼</p><p class="url">/posts/494ad091.html#Listé›†åˆçš„éå†æ–¹å¼</p></div></a></div><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230516205838333.png" alt="image-20230516205838333" style="zoom: 50%;" /></p>              </div>            </details><hr><details class="folding-tag" green close><summary> å¢å¼ºforå¾ªç¯çš„åº•å±‚å®ç°åŸç† </summary>              <div class='content'>              <p>å¢å¼ºforå¾ªç¯æ˜¯JAVAæä¾›çš„è¯­æ³•ç³–ï¼Œè™½ç„¶å¢å¼ºforå¾ªç¯é€šè¿‡è¿­ä»£å™¨å®ç°ï¼Œä½†æ˜¯åˆ é™¤å…ƒç´ è¿˜æ˜¯å¾—é€šè¿‡è¿­ä»£å™¨æ¥è¿›è¡Œåˆ é™¤ã€‚</p><p>ä»¥ä¸‹ä»£ç è¿›è¡Œåç¼–è¯‘</p><div class="tabs" id="12d75644-1286-4f09-9156-e500ad2a10df"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#12d75644-1286-4f09-9156-e500ad2a10df-1"><i class="fas fa-seedling"></i>åŸä»£ç </button></li><li class="tab"><button type="button" data-href="#12d75644-1286-4f09-9156-e500ad2a10df-2"><i class="fas fa-leaf"></i>åç¼–è¯‘å</button></li><li class="tab"><button type="button" data-href="#12d75644-1286-4f09-9156-e500ad2a10df-3"><i class="fab fa-apple"></i>åˆ†æ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="12d75644-1286-4f09-9156-e500ad2a10df-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Integer i : list) &#123;</span><br><span class="line">   System.out.println(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="12d75644-1286-4f09-9156-e500ad2a10df-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Integer i;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">Iterator</span> <span class="variable">iterator</span> <span class="operator">=</span> list.iterator(); iterator.hasNext(); System.out.println(i))&#123;</span><br><span class="line">   i = (Integer)iterator.next();        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="12d75644-1286-4f09-9156-e500ad2a10df-3"><p>åç¼–è¯‘åçš„ä»£ç å…¶å®æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬æŒ‰ç…§æ‰§è¡Œé¡ºåºæ‹†è§£ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Integer i; å®šä¹‰ä¸€ä¸ªä¸´æ—¶å˜é‡i</span><br><span class="line"><span class="type">Iterator</span> <span class="variable">iterator</span> <span class="operator">=</span> list.iterator(); è·å–Listçš„è¿­ä»£å™¨</span><br><span class="line">iterator.hasNext(); åˆ¤æ–­è¿­ä»£å™¨ä¸­æ˜¯å¦æœ‰æœªéå†è¿‡çš„å…ƒç´ </span><br><span class="line">i = (Integer)iterator.next(); è·å–ç¬¬ä¸€ä¸ªæœªéå†çš„å…ƒç´ ï¼Œèµ‹å€¼ç»™ä¸´æ—¶å˜é‡i</span><br><span class="line">System.out.println(i) è¾“å‡ºä¸´æ—¶å˜é‡içš„å€¼</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>              </div>            </details><hr><div class="table-container"><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">åˆå§‹å®¹é‡</th><th style="text-align:center">æ—¶æœº</th><th style="text-align:center">å€æ•°</th></tr></thead><tbody><tr><td style="text-align:center">ArrayList</td><td style="text-align:center">ç©ºå‚æ„é€ é»˜è®¤å®¹é‡10 æ‡’åˆ›å»º<br/>è‹¥æŒ‡å®šåˆ™ç«‹åˆ»åˆ›å»ºè¯¥å¤§å°çš„æ•°ç»„</td><td style="text-align:center">å®¹é‡æ»¡çš„æ—¶å€™æ‰ä¼šè¿›è¡Œæ‰©å®¹</td><td style="text-align:center">1.5</td></tr><tr><td style="text-align:center">HashMap</td><td style="text-align:center">ç©ºå‚æ„é€ é»˜è®¤å®¹é‡ä¸º16 æ‡’åˆ›å»º<br/>æœ‰å‚æ„é€ å®¹é‡ä¸ºå¤§äºç­‰äºå‚æ•°çš„æœ€å°2çš„å¹‚æ¬¡</td><td style="text-align:center">++size &gt; threshold<br/>å…ƒç´ æ•°ç›®è¾¾åˆ°å®¹é‡*è´Ÿè½½å› å­æ—¶</td><td style="text-align:center">2</td></tr><tr><td style="text-align:center">Concurrent<br>HashMap</td><td style="text-align:center">ç©ºå‚æ„é€ é»˜è®¤å®¹é‡ä¸º16<br/>sizeCtlä¸ºå¤§äºç­‰äº(1.0 + (long)initialCapacity / loadFactor)å‚æ•°çš„æœ€å°2çš„å¹‚æ¬¡</td><td style="text-align:center">å…ƒç´ æ•°ç›®è¾¾åˆ°sizeCtlæ—¶</td><td style="text-align:center">2</td></tr></tbody></table></div><p><code>ArrayList</code>æ„é€ æ—¶å¦‚æœæœªæŒ‡å®šå®¹é‡ï¼Œåˆ™ä¼šåœ¨ç¬¬ä¸€æ¬¡addå…ƒç´ æ—¶ï¼Œè®¾ç½®é»˜è®¤å®¹é‡å¤§å°ä¸º10ï¼Œä¹‹åæ¯æ¬¡æ–°å¢å…ƒç´ æ—¶éƒ½ä¼šåˆ¤æ–­å½“å‰size+1ï¼Œæ˜¯å¦å¤§äºç›®å‰å®¹é‡ï¼Œå¦‚æœå¤§äºåˆ™è¿›è¡Œæ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯<code>ArrayList</code>æ˜¯åœ¨å®¹é‡æ»¡çš„æ—¶å€™æ‰ä¼šè¿›è¡Œæ‰©å®¹ï¼Œå¹¶ä¸”æ¯æ¬¡é€šè¿‡<code>Arrays.copyOf</code>çš„æ–¹å¼ï¼Œæ‰©å®¹ä¸ºåŸæ•°ç»„çš„1.5å€ï¼Œæœ€å¤§å®¹é‡ä¸º<code>Integer.MAX_VALUE</code></p><p><code>HashMap1.8</code> å½“æ‹‰é“¾é•¿åº¦å¤§äº8ä¸”æ•°ç»„é•¿åº¦å¤§äº64æ—¶ä¼šæ ‘åŒ–,å½“æ ‘çš„èŠ‚ç‚¹å°äº6å°±ä¼šæŠŠæ ‘è½¬ä¸ºé“¾è¡¨.</p><blockquote><p>ConcurrentHashMap</p></blockquote><p><code>sizeCtl</code>ä¸º0ï¼Œä»£è¡¨æ•°ç»„æœªåˆå§‹åŒ–ï¼Œ ä¸”æ•°ç»„çš„åˆå§‹å®¹é‡ä¸º16</p><p><code>sizeCtl</code>ä¸ºæ­£æ•°ï¼Œ<span class='p green'>å¦‚æœæ•°ç»„æœªåˆå§‹åŒ–ï¼Œé‚£ä¹ˆå…¶è®°å½•çš„æ˜¯æ•°ç»„çš„åˆå§‹å®¹é‡ï¼Œå¦‚æœæ•°ç»„å·²ç»åˆå§‹åŒ–ï¼Œé‚£ä¹ˆå…¶è®°å½•çš„æ˜¯æ•°ç»„çš„æ‰©å®¹é˜ˆå€¼</span></p><p><code>sizeCtl</code>ä¸º-1ï¼Œè¡¨ç¤ºæ•°ç»„æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–</p><p><code>sizeCtl</code>å°äº0ï¼Œå¹¶ä¸”ä¸æ˜¯-1ï¼Œè¡¨ç¤ºæ•°ç»„æ­£åœ¨æ‰©å®¹ï¼Œ -(1+n)ï¼Œè¡¨ç¤ºæ­¤æ—¶æœ‰nä¸ªçº¿ç¨‹æ­£åœ¨å…±åŒå®Œæˆæ•°ç»„çš„æ‰©å®¹æ“ä½œ</p><p>ConcurrentHashMapè´Ÿè½½å› å­åªå½±å“åˆå§‹è¡¨å®¹é‡,åç»­ä½¿ç”¨<code>n - (n &gt;&gt;&gt; 2 )</code>ä¸ºæ‰©å®¹é˜ˆå€¼.</p><hr><h2 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h2><details class="folding-tag" cyan close><summary> HashMap1.7æ•°æ®ç»“æ„ã€æ’å…¥æ–¹å¼ã€æ‰©å®¹å¹¶å‘æ­»é“¾é—®é¢˜ </summary>              <div class='content'>              <p>æ•°æ®ç»“æ„ï¼šæ•°ç»„+å•å‘é“¾è¡¨</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/v2-e326681a8e66e07a23e1cf45d4686001_1440w.webp" alt="img" style="zoom:33%;" /></p><p>æ’å…¥æ–¹å¼ï¼šå¤´æ’æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">createEntry</span><span class="params">(<span class="type">int</span> hash, K key, V value, <span class="type">int</span> bucketIndex)</span> &#123;</span><br><span class="line">    <span class="comment">//å–å‡ºç´¢å¼•ä½ç½®çš„å…ƒç´ </span></span><br><span class="line">    Entry&lt;K,V&gt; e = table[bucketIndex];</span><br><span class="line">    <span class="comment">//å°†æ–°çš„å…ƒç´ æ”¾ç½®åˆ°ç´¢å¼•ä½ï¼ŒåŒæ—¶å°†åŸèŠ‚ç‚¹çš„ä½œä¸ºæ–°å…ƒç´ çš„nextï¼Œå½¢æˆå•å‘é“¾è¡¨</span></span><br><span class="line">    <span class="comment">//å¤´æ’æ³•</span></span><br><span class="line">    table[bucketIndex] = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(hash, key, value, e);</span><br><span class="line">    size++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/v2-b7d6d61af1a3887611c01e91a1ac5784_1440w.webp" alt="img" style="zoom:33%;" /></p><blockquote><p>æ­£å¸¸æƒ…å†µä¸‹æ‰©å®¹</p></blockquote><p>HashMapæ­£å¸¸æƒ…å†µä¸‹çš„æ‰©å®¹å®ç°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/v2-ad1f36eb1b79f629ca500c73987c4531_1440w.webp" alt="img" style="zoom:33%;" /></p><p>æ—§HashMapçš„èŠ‚ç‚¹ä¼šä¾æ¬¡è½¬ç§»åˆ°æ–°HashMapä¸­ï¼Œæ—§HashMapè½¬ç§»çš„é¡ºåºæ˜¯Aã€Bã€Cï¼Œè€Œæ–°HashMapä½¿ç”¨çš„æ˜¯å¤´æ’æ³•ï¼Œæ‰€ä»¥æœ€ç»ˆåœ¨æ–°HashMapä¸­çš„é¡ºåºæ˜¯Cã€Bã€Aï¼Œä¹Ÿå°±æ˜¯ä¸Šå›¾å±•ç¤ºçš„é‚£æ ·ã€‚</p><blockquote><p>å¹¶å‘æ‰©å®¹æ­»é“¾</p></blockquote><p><mark class="hl-label blue">æ­¥éª¤ä¸€</mark> </p><p>æ­»å¾ªç¯æ˜¯å› ä¸ºå¹¶å‘HashMapæ‰©å®¹å¯¼è‡´çš„ï¼Œå¹¶å‘æ‰©å®¹çš„ç¬¬ä¸€æ­¥ï¼Œçº¿ç¨‹T1å’Œçº¿ç¨‹T2è¦å¯¹HashMapè¿›è¡Œæ‰©å®¹æ“ä½œï¼Œæ­¤æ—¶T1å’ŒT2æŒ‡å‘çš„æ˜¯é“¾è¡¨çš„å¤´ç»“ç‚¹å…ƒç´ Aï¼Œè€ŒT1å’ŒT2çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯T1.nextå’ŒT2.nextæŒ‡å‘çš„æ˜¯BèŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/v2-e0b4f5ea00cb277bde490f315b9b387f_1440w.webp" alt="img" style="zoom:33%;" /></p><p><mark class="hl-label red">æ­¥éª¤äºŒ</mark> </p><p>æ­»å¾ªç¯çš„ç¬¬äºŒæ­¥æ“ä½œæ˜¯ï¼Œçº¿ç¨‹T2æ—¶é—´ç‰‡ç”¨å®Œè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œè€Œçº¿ç¨‹T1å¼€å§‹æ‰§è¡Œæ‰©å®¹æ“ä½œï¼Œä¸€ç›´åˆ°çº¿ç¨‹T1æ‰©å®¹å®Œæˆåï¼Œçº¿ç¨‹T2æ‰è¢«å”¤é†’ï¼Œæ‰©å®¹ä¹‹åçš„åœºæ™¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/v2-5f78d8ac8af1efc79e7d79a1f3fdc154_1440w.webp" alt="img" style="zoom:33%;" /></p><p>ä»ä¸Šå›¾å¯çŸ¥çº¿ç¨‹T1æ‰§è¡Œä¹‹åï¼Œå› ä¸ºæ˜¯å¤´æ’æ³•ï¼Œæ‰€ä»¥HashMapçš„é¡ºåºå·²ç»å‘ç”Ÿäº†æ”¹å˜ï¼Œä½†çº¿ç¨‹T2å¯¹äºå‘ç”Ÿçš„ä¸€åˆ‡æ˜¯ä¸å¯çŸ¥çš„ï¼Œæ‰€ä»¥å®ƒçš„æŒ‡å‘å…ƒç´ ä¾ç„¶æ²¡å˜ï¼Œå¦‚ä¸Šå›¾å±•ç¤ºçš„é‚£æ ·ï¼ŒT2æŒ‡å‘çš„æ˜¯Aå…ƒç´ ï¼ŒT2.nextæŒ‡å‘çš„èŠ‚ç‚¹æ˜¯Bå…ƒç´ ã€‚</p><p><mark class="hl-label pink">æ­¥éª¤ä¸‰</mark> </p><p>å½“çº¿ç¨‹T1æ‰§è¡Œå®Œï¼Œè€Œçº¿ç¨‹T2æ¢å¤æ‰§è¡Œæ—¶ï¼Œæ­»å¾ªç¯å°±å»ºç«‹äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/v2-bd4a753db8c985119aa4dcd4356609cf_1440w.webp" alt="img" style="zoom:33%;" /></p><p>å› ä¸ºT1æ‰§è¡Œå®Œæ‰©å®¹ä¹‹åBèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯Aï¼Œè€ŒT2çº¿ç¨‹æŒ‡å‘çš„é¦–èŠ‚ç‚¹æ˜¯Aï¼Œç¬¬äºŒä¸ªèŠ‚ç‚¹æ˜¯Bï¼Œè¿™ä¸ªé¡ºåºåˆšå¥½å’ŒT1æ‰©å®Œå®¹å®Œä¹‹åçš„èŠ‚ç‚¹é¡ºåºæ˜¯ç›¸åçš„ã€‚<strong>T1æ‰§è¡Œå®Œä¹‹åçš„é¡ºåºæ˜¯Båˆ°Aï¼Œè€ŒT2çš„é¡ºåºæ˜¯Aåˆ°Bï¼Œè¿™æ ·AèŠ‚ç‚¹å’ŒBèŠ‚ç‚¹å°±å½¢æˆæ­»å¾ªç¯äº†</strong>ï¼Œè¿™å°±æ˜¯HashMapæ­»å¾ªç¯å¯¼è‡´çš„åŸå› ã€‚</p>              </div>            </details><hr><details class="folding-tag" cyan close><summary> HashMap1.8æ•°æ®ç»“æ„ã€æ’å…¥æ–¹å¼ã€å¹¶å‘å…ƒç´ ä¸¢å¤± </summary>              <div class='content'>              <p>æ•°æ®ç»“æ„ï¼šæ•°ç»„+å•å‘é“¾è¡¨+çº¢é»‘æ ‘+åŒå‘é“¾è¡¨</p><p>æ’å…¥æ–¹å¼ï¼šå°¾æ’æ³•</p><p>å¹¶å‘å…ƒç´ ä¸¢å¤±</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ·»åŠ å…ƒç´ æ—¶ï¼Œä¼šæœ‰æ•°æ®è¦†ç›–ä¸¢å¤±æ•°æ®</span></span><br><span class="line"><span class="keyword">final</span> V <span class="title function_">putVal</span><span class="params">(<span class="type">int</span> hash, K key, V value, <span class="type">boolean</span> onlyIfAbsent,</span></span><br><span class="line"><span class="params">               <span class="type">boolean</span> evict)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="type">int</span> n, i;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="comment">//æ­¤å¤„ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹å‘åŒä¸€ä¸ªä½ç½®å­˜å…¥å…ƒç´ ï¼Œä¼šæœ‰å€¼è¦†ç›–çš„é—®é¢˜ï¼Œå¯¼è‡´æ•°ä¸¢å¤±</span></span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="literal">null</span>)</span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="literal">null</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ä¸‹é¢ä»£ç çœç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰©å®¹æ—¶ï¼Œè¿ç§»æ•°æ®çš„æƒ…å†µä¸‹ï¼Œä¼šæœ‰æ•°æ®è¦†ç›–ä¸¢å¤±çš„é—®é¢˜</span></span><br><span class="line"><span class="comment">// å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œç»™åŒä¸€ä¸ªæ•°ç»„çš„ç›¸åŒä½ç½®èµ‹å€¼ï¼Œä¼šæœ‰æ•°æ®è¦†ç›–çš„é£é™©</span></span><br><span class="line"><span class="keyword">if</span> (loTail != <span class="literal">null</span>) &#123;</span><br><span class="line">    loTail.next = <span class="literal">null</span>;</span><br><span class="line">    newTab[j] = loHead;  <span class="comment">//å°†åŸå§‹ç´¢å¼•ä½çš„æ•°æ®è¿ç§»åˆ°æ–°æ•°ç»„</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (hiTail != <span class="literal">null</span>) &#123;</span><br><span class="line">    hiTail.next = <span class="literal">null</span>;</span><br><span class="line">    newTab[j + oldCap] = hiHead; <span class="comment">//å°†æ–°ç´¢å¼•ä½çš„æ•°æ®è¿ç§»åˆ°æ–°æ•°ç»„</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>[newCap];</span><br><span class="line">table = newTab;</span><br></pre></td></tr></table></figure><p>put å’Œ get å¹¶å‘æ—¶ï¼Œå¯èƒ½å¯¼è‡´ get ä¸º nullã€‚çº¿ç¨‹ 1 æ‰§è¡Œ put æ—¶ï¼Œå› ä¸ºå…ƒç´ ä¸ªæ•°è¶…å‡º threshold è€Œå¯¼è‡´ rehashï¼Œçº¿ç¨‹ 2 æ­¤æ—¶æ‰§è¡Œ getï¼Œæœ‰å¯èƒ½å¯¼è‡´è¿™ä¸ªé—®é¢˜ã€‚è¿™ä¸ªé—®é¢˜åœ¨ JDK 1.7 å’Œ JDK 1.8 ä¸­éƒ½å­˜åœ¨ã€‚</p>              </div>            </details><hr><h2 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h2><details class="folding-tag" cyan close><summary> HashMapã€HashTableã€ConcurrentHashMapåŒºåˆ« </summary>              <div class='content'>              <blockquote><p>HashMap</p></blockquote><p> HashMap æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨ Hashmap è¿›è¡Œ put æ“ä½œä¼šå¼•èµ·æ­»å¾ªç¯ï¼Œå¯¼è‡´ CPU åˆ©ç”¨ç‡æ¥è¿‘ 100%ï¼Œæ‰€ä»¥åœ¨å¹¶å‘æƒ…å†µä¸‹ä¸èƒ½ä½¿ç”¨ HashMapã€‚</p><blockquote><p>HashTable</p></blockquote><p>HashTable å’Œ HashMap çš„å®ç°åŸç†å‡ ä¹ä¸€æ ·ï¼Œå·®åˆ«æ— éæ˜¯</p><ul><li>HashTable ä¸å…è®¸ key å’Œ value ä¸º null</li><li>HashTable æ˜¯çº¿ç¨‹å®‰å…¨çš„ ä½†æ˜¯ HashTable çº¿ç¨‹å®‰å…¨çš„ç­–ç•¥å®ç°ä»£ä»·å´å¤ªå¤§äº†ï¼Œç®€å•ç²—æš´ï¼Œget/put æ‰€æœ‰ç›¸å…³æ“ä½œéƒ½æ˜¯ synchronized çš„ï¼Œè¿™ç›¸å½“äºç»™æ•´ä¸ªå“ˆå¸Œè¡¨åŠ äº†ä¸€æŠŠå¤§é”ã€‚</li></ul><p>å¤šçº¿ç¨‹è®¿é—®æ—¶å€™ï¼Œåªè¦æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®æˆ–æ“ä½œè¯¥å¯¹è±¡ï¼Œé‚£å…¶ä»–çº¿ç¨‹åªèƒ½é˜»å¡ï¼Œç›¸å½“äºå°†æ‰€æœ‰çš„æ“ä½œä¸²è¡ŒåŒ–ï¼Œåœ¨ç«äº‰æ¿€çƒˆçš„å¹¶å‘åœºæ™¯ä¸­æ€§èƒ½å°±ä¼šéå¸¸å·®ã€‚</p><blockquote><p>ConcurrentHashMap</p></blockquote><p>ä¸»è¦å°±æ˜¯ä¸ºäº†åº”å¯¹ <code>HashMap</code> åœ¨å¹¶å‘ç¯å¢ƒä¸‹ä¸å®‰å…¨è€Œè¯ç”Ÿçš„ï¼Œ <code>ConcurrentHashMap</code> çš„è®¾è®¡ä¸å®ç°éå¸¸ç²¾å·§ï¼Œå¤§é‡çš„åˆ©ç”¨äº† <code>volatile</code>ï¼Œ<code>final</code>ï¼Œ <code>CAS</code> ç­‰æ— é”æŠ€æœ¯æ¥å‡å°‘é”ç«äº‰å¯¹äºæ€§èƒ½çš„å½±å“ã€‚</p>              </div>            </details><details class="folding-tag" green close><summary> 1.7ã€1.8 ConcurrentHashMapå¯¹æ¯” </summary>              <div class='content'>              <div class="tabs" id="794a187f-5e35-4305-96f0-a006bcf78cf1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#794a187f-5e35-4305-96f0-a006bcf78cf1-1"><i class="fas fa-seedling"></i>JDK1.7</button></li><li class="tab"><button type="button" data-href="#794a187f-5e35-4305-96f0-a006bcf78cf1-2"><i class="fas fa-leaf"></i>JDK1.8</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="794a187f-5e35-4305-96f0-a006bcf78cf1-1"><p>åœ¨ JDK1.7 ä¸­ ConcurrentHashMap é‡‡ç”¨äº†æ•°ç»„+Segment+åˆ†æ®µé”çš„æ–¹å¼å®ç°ã€‚</p><p><strong>1.Segment(åˆ†æ®µé”)</strong><br> ConcurrentHashMap ä¸­çš„åˆ†æ®µé”ç§°ä¸º Segmentï¼Œå®ƒå³ç±»ä¼¼äº HashMap çš„ç»“æ„ï¼Œå³å†…éƒ¨æ‹¥æœ‰ä¸€ä¸ª Entry æ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ åˆæ˜¯ä¸€ä¸ªé“¾è¡¨,åŒæ—¶åˆæ˜¯ä¸€ä¸ª ReentrantLockï¼ˆSegment ç»§æ‰¿äº† ReentrantLockï¼‰ã€‚</p><p><strong>2.å†…éƒ¨ç»“æ„</strong><br> ConcurrentHashMap ä½¿ç”¨åˆ†æ®µé”æŠ€æœ¯ï¼Œå°†æ•°æ®åˆ†æˆä¸€æ®µä¸€æ®µçš„å­˜å‚¨ï¼Œç„¶åç»™æ¯ä¸€æ®µæ•°æ®é…ä¸€æŠŠé”ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å ç”¨é”è®¿é—®å…¶ä¸­ä¸€ä¸ªæ®µæ•°æ®çš„æ—¶å€™ï¼Œå…¶ä»–æ®µçš„æ•°æ®ä¹Ÿèƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®ï¼Œèƒ½å¤Ÿå®ç°çœŸæ­£çš„å¹¶å‘è®¿é—®ã€‚å¦‚ä¸‹å›¾æ˜¯ ConcurrentHashMap çš„å†…éƒ¨ç»“æ„å›¾ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240228161103148.png" alt="image-20240228161103148" style="zoom: 33%;" /></p><p>ä»ä¸Šé¢çš„ç»“æ„æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ï¼ŒConcurrentHashMap å®šä½ä¸€ä¸ªå…ƒç´ çš„è¿‡ç¨‹éœ€è¦è¿›è¡Œä¸¤æ¬¡ Hash æ“ä½œã€‚ç¬¬ä¸€æ¬¡ Hash å®šä½åˆ° Segmentï¼Œç¬¬äºŒæ¬¡ Hash å®šä½åˆ°å…ƒç´ æ‰€åœ¨çš„é“¾è¡¨çš„å¤´éƒ¨ã€‚</p><p><strong>3.è¯¥ç»“æ„çš„ä¼˜åŠ£åŠ¿</strong><br> <strong>åå¤„:</strong><br> è¿™ä¸€ç§ç»“æ„çš„å¸¦æ¥çš„å‰¯ä½œç”¨æ˜¯ Hash çš„è¿‡ç¨‹è¦æ¯”æ™®é€šçš„ HashMap è¦é•¿<br> <strong>å¥½å¤„:</strong><br> å†™æ“ä½œçš„æ—¶å€™å¯ä»¥åªå¯¹å…ƒç´ æ‰€åœ¨çš„ Segment è¿›è¡ŒåŠ é”å³å¯ï¼Œä¸ä¼šå½±å“åˆ°å…¶ä»–çš„ Segmentï¼Œè¿™æ ·ï¼Œåœ¨æœ€ç†æƒ³çš„æƒ…å†µä¸‹ï¼ŒConcurrentHashMap å¯ä»¥æœ€é«˜åŒæ—¶æ”¯ æŒ Segment æ•°é‡å¤§å°çš„å†™æ“ä½œï¼ˆåˆšå¥½è¿™äº›å†™æ“ä½œéƒ½éå¸¸å¹³å‡åœ°åˆ†å¸ƒåœ¨æ‰€æœ‰çš„ Segment ä¸Šï¼‰ã€‚</p><p>æ‰€ä»¥ï¼Œé€šè¿‡è¿™ä¸€ç§ç»“æ„ï¼ŒConcurrentHashMap çš„å¹¶å‘èƒ½åŠ›å¯ä»¥å¤§å¤§çš„æé«˜ã€‚</p><p>è®¡ç®—å…ƒç´ ä¸ªæ•°å‰ï¼Œå…ˆä¸åŠ é”è®¡ç®—ä¸¤æ¬¡ï¼Œå¦‚æœå‰åä¸¤æ¬¡ç»“æœå¦‚ä¸€æ ·ï¼Œè®¤ä¸ºä¸ªæ•°æ­£ç¡®è¿”å›</p><p>å¦‚æœä¸ä¸€æ ·ï¼Œè¿›è¡Œé‡è¯•ï¼Œé‡è¯•æ¬¡æ•°è¶…è¿‡ 3ï¼Œå°†æ‰€æœ‰ segment é”ä½ï¼Œé‡æ–°è®¡ç®—ä¸ªæ•°è¿”å›</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="794a187f-5e35-4305-96f0-a006bcf78cf1-2"><p>JDK8 ä¸­ ConcurrentHashMap å‚è€ƒäº† JDK8 HashMap çš„å®ç°ï¼Œé‡‡ç”¨äº†æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„å®ç°æ–¹å¼æ¥è®¾è®¡ï¼Œå†…éƒ¨å¤§é‡é‡‡ç”¨ CAS æ“ä½œã€‚</p><p>Java8 ConcurrentHashMap ç»“æ„åŸºæœ¬ä¸Šå’Œ Java8 çš„ HashMap ä¸€æ ·ï¼Œä¸è¿‡ä¿è¯çº¿ç¨‹å®‰å…¨æ€§ã€‚</p><p>å…¶å®å¯ä»¥çœ‹å‡º JDK1.8 ç‰ˆæœ¬çš„ ConcurrentHashMap çš„æ•°æ®ç»“æ„å·²ç»æ¥è¿‘ HashMapï¼Œç›¸å¯¹è€Œè¨€ï¼ŒConcurrentHashMap åªæ˜¯å¢åŠ äº†åŒæ­¥çš„æ“ä½œæ¥æ§åˆ¶å¹¶å‘ï¼Œä» JDK1.7 ç‰ˆæœ¬çš„ ReentrantLock+Segment+HashEntryï¼Œåˆ° JDK1.8 ç‰ˆæœ¬ä¸­ synchronized+CAS+HashEntry+çº¢é»‘æ ‘ã€‚</p><ol><li>æ•°æ®ç»“æ„ï¼šå–æ¶ˆäº† Segment åˆ†æ®µé”çš„æ•°æ®ç»“æ„ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„ç»“æ„ã€‚</li><li>ä¿è¯çº¿ç¨‹å®‰å…¨æœºåˆ¶ï¼šJDK1.7 é‡‡ç”¨ segment çš„åˆ†æ®µé”æœºåˆ¶å®ç°çº¿ç¨‹å®‰å…¨ï¼Œå…¶ä¸­ segment ç»§æ‰¿è‡ª ReentrantLockã€‚JDK1.8 é‡‡ç”¨ CAS+Synchronized ä¿è¯çº¿ç¨‹ å®‰å…¨ã€‚</li><li>é”çš„ç²’åº¦ï¼šåŸæ¥æ˜¯å¯¹éœ€è¦è¿›è¡Œæ•°æ®æ“ä½œçš„ Segment åŠ é”ï¼Œç°è°ƒæ•´ä¸ºå¯¹æ¯ä¸ªæ•°ç»„å…ƒç´ åŠ é”ï¼ˆNodeï¼‰ã€‚</li><li>é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘:å®šä½ç»“ç‚¹çš„ hash ç®—æ³•ç®€åŒ–ä¼šå¸¦æ¥å¼Šç«¯,Hash å†²çªåŠ å‰§,å› æ­¤åœ¨é“¾è¡¨èŠ‚ç‚¹æ•°é‡å¤§äº 8 æ—¶ï¼Œä¼šå°†é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘è¿›è¡Œå­˜å‚¨ã€‚</li><li>æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ï¼šä»åŸæ¥çš„éå†é“¾è¡¨ O(n)ï¼Œå˜æˆéå†çº¢é»‘æ ‘O(logN)ã€‚</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>              </div>            </details>]]></content>
    
    
    <summary type="html">JavaåŸºç¡€é¢è¯•é¢˜</summary>
    
    
    
    <category term="Java" scheme="https://wuwawawa.github.io/categories/Java/"/>
    
    
    <category term="é¢è¯•é¢˜" scheme="https://wuwawawa.github.io/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    
  </entry>
  
  <entry>
    <title>Springé¢è¯•é¢˜</title>
    <link href="https://wuwawawa.github.io/posts/489ef953.html"/>
    <id>https://wuwawawa.github.io/posts/489ef953.html</id>
    <published>2023-12-08T06:04:44.000Z</published>
    <updated>2024-03-20T09:39:14.342Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Spring-IOC"><a href="#Spring-IOC" class="headerlink" title="Spring-IOC"></a>Spring-IOC</h2><details class="folding-tag" blue close><summary> Spring refresh æµç¨‹ </summary>              <div class='content'>              <p>refresh æ˜¯ <code>AbstractApplicationContext</code> ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Œè´Ÿè´£åˆå§‹åŒ– <code>ApplicationContext</code> å®¹å™¨ï¼Œå®¹å™¨å¿…é¡»è°ƒç”¨ refresh æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚å®ƒçš„å†…éƒ¨ä¸»è¦ä¼šè°ƒç”¨ 12 ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬æŠŠå®ƒä»¬ç§°ä¸º refresh çš„ 12 ä¸ªæ­¥éª¤ï¼š</p><ol><li><code>prepareRefresh</code></li><li><code>obtainFreshBeanFactory</code></li><li><code>prepareBeanFactory</code></li><li><code>postProcessBeanFactory</code></li><li><code>invokeBeanFactoryPostProcessors</code></li><li><code>registerBeanPostProcessors</code></li><li><code>initMessageSource</code></li><li><code>initApplicationEventMulticaster</code></li><li><code>onRefresh</code></li><li><code>registerListeners</code></li><li><code>finishBeanFactoryInitialization</code></li><li><code>finishRefresh</code></li></ol><p>1 ä¸ºå‡†å¤‡ç¯å¢ƒ</p><p>2 3 4 5 6 ä¸ºå‡†å¤‡ <code>BeanFactory</code></p><p>7 8 9 10 12 ä¸ºå‡†å¤‡ <code>ApplicationContext</code></p><p>11 ä¸ºåˆå§‹åŒ– <code>BeanFactory</code> ä¸­éå»¶è¿Ÿå•ä¾‹ bean</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/refresh%E6%B5%81%E7%A8%8B.png" alt="refreshæµç¨‹"></p>              </div>            </details><hr><details class="folding-tag" cyan close><summary> Beançš„ç”Ÿå‘½å‘¨æœŸï¼Ÿ </summary>              <div class='content'>              <p>Instantiate å®ä¾‹åŒ–</p><p>Initialize åˆå§‹åŒ–</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/2Bean%20%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png" alt="2Bean ç”Ÿå‘½å‘¨æœŸ"></p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240301114922096.png" alt="image-20240301114922096"></p>              </div>            </details><hr><details class="folding-tag" blue close><summary> setå¾ªç¯ä¾èµ–ã€äºŒçº§ç¼“å­˜å°±å·²ç»å¯ä»¥è§£å†³å¾ªç¯ä¾èµ–äº†ä¸ºä»€ä¹ˆè¿˜éœ€è¦ä¸‰çº§ç¼“å­˜å‘¢ï¼Ÿ </summary>              <div class='content'>              <p><a href="#jump">ä»£ç†å¯¹è±¡åˆ›å»ºçš„æ—¶æœºâ†“â†“â†“</a></p><p><mark class="hl-label blue">ä¸€çº§ç¼“å­˜</mark> </p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210903100752165.png" alt="image-20210903100752165" style="zoom:80%;" /></p><p>ä½œç”¨æ˜¯ä¿è¯å•ä¾‹å¯¹è±¡ä»…è¢«åˆ›å»ºä¸€æ¬¡</p><ul><li>ç¬¬ä¸€æ¬¡èµ° <code>getBean(&quot;a&quot;)</code> æµç¨‹åï¼Œæœ€åä¼šå°†æˆå“ a æ”¾å…¥ singletonObjects ä¸€çº§ç¼“å­˜</li><li>åç»­å†èµ° <code>getBean(&quot;a&quot;)</code> æµç¨‹æ—¶ï¼Œå…ˆä»ä¸€çº§ç¼“å­˜ä¸­æ‰¾ï¼Œè¿™æ—¶å·²ç»æœ‰æˆå“ aï¼Œå°±æ— éœ€å†æ¬¡åˆ›å»º</li></ul><p><mark class="hl-label blue">ä¸€çº§ç¼“å­˜ä¸å¾ªç¯ä¾èµ–</mark> </p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210903100914140.png" alt="image-20210903100914140" style="zoom:80%;" /></p><p>ä¸€çº§ç¼“å­˜æ— æ³•è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œåˆ†æå¦‚ä¸‹</p><ul><li>æ— è®ºæ˜¯è·å– bean a è¿˜æ˜¯è·å– bean bï¼Œèµ°çš„æ–¹æ³•éƒ½æ˜¯åŒä¸€ä¸ª getBean æ–¹æ³•ï¼Œå‡è®¾å…ˆèµ° <code>getBean(&quot;a&quot;)</code></li><li>å½“ a çš„å®ä¾‹å¯¹è±¡åˆ›å»ºï¼Œæ¥ä¸‹æ¥æ‰§è¡Œ <code>a.setB()</code> æ—¶ï¼Œéœ€è¦èµ° <code>getBean(&quot;b&quot;)</code> æµç¨‹ï¼Œçº¢è‰²ç®­å¤´ 1</li><li>å½“ b çš„å®ä¾‹å¯¹è±¡åˆ›å»ºï¼Œæ¥ä¸‹æ¥æ‰§è¡Œ <code>b.setA()</code> æ—¶ï¼Œåˆå›åˆ°äº† <code>getBean(&quot;a&quot;)</code> çš„æµç¨‹ï¼Œçº¢è‰²ç®­å¤´ 2</li><li>ä½†æ­¤æ—¶ singletonObjects ä¸€çº§ç¼“å­˜å†…æ²¡æœ‰æˆå“çš„ aï¼Œé™·å…¥äº†æ­»å¾ªç¯</li></ul><p><mark class="hl-label pink">äºŒçº§ç¼“å­˜</mark> </p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210903101849924.png" alt="image-20210903101849924" style="zoom:80%;" /></p><p>è§£å†³æ€è·¯å¦‚ä¸‹ï¼š</p><ul><li>å†å¢åŠ ä¸€ä¸ª singletonFactories ç¼“å­˜</li><li>åœ¨ä¾èµ–æ³¨å…¥å‰ï¼Œå³ <code>a.setB()</code> ä»¥åŠ <code>b.setA()</code> å°† a åŠ b çš„åŠæˆå“å¯¹è±¡ï¼ˆæœªå®Œæˆä¾èµ–æ³¨å…¥å’Œåˆå§‹åŒ–ï¼‰æ”¾å…¥æ­¤ç¼“å­˜</li><li>æ‰§è¡Œä¾èµ–æ³¨å…¥æ—¶ï¼Œå…ˆçœ‹çœ‹ singletonFactories ç¼“å­˜ä¸­æ˜¯å¦æœ‰åŠæˆå“çš„å¯¹è±¡ï¼Œå¦‚æœæœ‰æ‹¿æ¥æ³¨å…¥ï¼Œé¡ºåˆ©èµ°å®Œæµç¨‹</li></ul><p>å¯¹äºä¸Šé¢çš„å›¾</p><ul><li><code>a = new A()</code> æ‰§è¡Œä¹‹åå°±ä¼šæŠŠè¿™ä¸ªåŠæˆå“çš„ a æ”¾å…¥ singletonFactories ç¼“å­˜ï¼Œå³ <code>factories.put(a)</code></li><li>æ¥ä¸‹æ¥æ‰§è¡Œ <code>a.setB()</code>ï¼Œèµ°å…¥ <code>getBean(&quot;b&quot;)</code> æµç¨‹ï¼Œçº¢è‰²ç®­å¤´ 3</li><li>è¿™å›å†æ‰§è¡Œåˆ° <code>b.setA()</code> æ—¶ï¼Œéœ€è¦ä¸€ä¸ª a å¯¹è±¡ï¼Œæœ‰æ²¡æœ‰å‘¢ï¼Ÿæœ‰ï¼</li><li><code>factories.get()</code> åœ¨ singletonFactories  ç¼“å­˜ä¸­å°±å¯ä»¥æ‰¾åˆ°ï¼Œçº¢è‰²ç®­å¤´ 4 å’Œ 5</li><li>b çš„æµç¨‹èƒ½å¤Ÿé¡ºåˆ©èµ°å®Œï¼Œå°† b æˆå“æ”¾å…¥ singletonObject ä¸€çº§ç¼“å­˜ï¼Œè¿”å›åˆ° a çš„ä¾èµ–æ³¨å…¥æµç¨‹ï¼Œçº¢è‰²ç®­å¤´ 6</li></ul><p><mark class="hl-label pink">äºŒçº§ç¼“å­˜ä¸åˆ›å»ºä»£ç†</mark> </p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210903103030877.png" alt="image-20210903103030877" style="zoom:80%;" /></p><p>äºŒçº§ç¼“å­˜çš„åœºæ™¯<span class='p red'>æ— æ³•æ­£ç¡®å¤„ç†å¾ªç¯ä¾èµ–å¹¶ä¸”åŒ…å«æœ‰ä»£ç†åˆ›å»º</span>ï¼Œåˆ†æå¦‚ä¸‹</p><ul><li>spring é»˜è®¤è¦æ±‚ï¼Œåœ¨ <code>a.init</code> å®Œæˆä¹‹åæ‰èƒ½åˆ›å»ºä»£ç† <code>pa = proxy(a)</code></li><li>ç”±äº a çš„ä»£ç†åˆ›å»ºæ—¶æœºé åï¼Œåœ¨æ‰§è¡Œ <code>factories.put(a)</code> å‘ singletonFactories ä¸­æ”¾å…¥çš„è¿˜æ˜¯åŸå§‹å¯¹è±¡</li><li>æ¥ä¸‹æ¥ç®­å¤´ 3ã€4ã€5 è¿™å‡ æ­¥ b å¯¹è±¡æ‹¿åˆ°å’Œæ³¨å…¥çš„éƒ½æ˜¯åŸå§‹å¯¹aè±¡</li></ul><p><mark class="hl-label red">ä¸‰çº§ç¼“å­˜</mark> </p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210903103628639.png" alt="image-20210903103628639"></p><p>ç®€å•åˆ†æçš„è¯ï¼Œåªéœ€è¦å°†ä»£ç†çš„åˆ›å»ºæ—¶æœºæ”¾åœ¨ä¾èµ–æ³¨å…¥ä¹‹å‰å³å¯ï¼Œä½† spring ä»ç„¶å¸Œæœ›ä»£ç†çš„åˆ›å»ºæ—¶æœºåœ¨ init ä¹‹åï¼Œåªæœ‰å‡ºç°å¾ªç¯ä¾èµ–æ—¶ï¼Œæ‰ä¼šå°†ä»£ç†çš„åˆ›å»ºæ—¶æœºæå‰ã€‚æ‰€ä»¥è§£å†³æ€è·¯ç¨æ˜¾å¤æ‚ï¼š</p><ul><li>å›¾ä¸­ <code>factories.put(fa)</code> æ”¾å…¥çš„æ—¢ä¸æ˜¯åŸå§‹å¯¹è±¡ï¼Œä¹Ÿä¸æ˜¯ä»£ç†å¯¹è±¡è€Œæ˜¯å·¥å‚å¯¹è±¡ fa</li><li>å½“æ£€æŸ¥å‡ºå‘ç”Ÿå¾ªç¯ä¾èµ–æ—¶ï¼Œfa çš„äº§å“å°±æ˜¯ä»£ç† paï¼Œæ²¡æœ‰å‘ç”Ÿå¾ªç¯ä¾èµ–ï¼Œfa çš„äº§å“æ˜¯åŸå§‹å¯¹è±¡ a</li><li>å‡è®¾å‡ºç°äº†å¾ªç¯ä¾èµ–ï¼Œæ‹¿åˆ°äº† singletonFactories ä¸­çš„å·¥å‚å¯¹è±¡ï¼Œé€šè¿‡åœ¨ä¾èµ–æ³¨å…¥å‰è·å¾—äº† paï¼Œçº¢è‰²ç®­å¤´ 5</li><li>è¿™å› <code>b.setA()</code> æ³¨å…¥çš„å°±æ˜¯ä»£ç†å¯¹è±¡ï¼Œä¿è¯äº†æ­£ç¡®æ€§ï¼Œçº¢è‰²ç®­å¤´ 7</li><li>è¿˜éœ€è¦æŠŠ pa å­˜å…¥æ–°åŠ çš„ earlySingletonObjects ç¼“å­˜ï¼Œçº¢è‰²ç®­å¤´ 6</li><li><code>a.init</code> å®Œæˆåï¼Œæ— éœ€äºŒæ¬¡åˆ›å»ºä»£ç†ï¼Œä»å“ªå„¿æ‰¾åˆ° pa å‘¢ï¼ŸearlySingletonObjects å·²ç»ç¼“å­˜ï¼Œè“è‰²ç®­å¤´ 9</li></ul><p>å½“æˆå“å¯¹è±¡äº§ç”Ÿï¼Œæ”¾å…¥ singletonObject åï¼ŒsingletonFactories å’Œ earlySingletonObjects å°±ä¸­çš„å¯¹è±¡å°±æ²¡æœ‰ç”¨å¤„ï¼Œæ¸…é™¤å³å¯</p>              </div>            </details><hr><details class="folding-tag" yellow close><summary> æ„é€ å¾ªç¯ä¾èµ–å¦‚ä½•è§£å†³ï¼Ÿ ä¸‰çº§ç¼“å­˜èƒ½å¦è§£å†³ï¼Ÿ </summary>              <div class='content'>              <p>æ— æ³•ç”¨ä¸‰çº§ç¼“å­˜è§£å†³</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210903085906315.png" alt="image-20210903085906315"  /></p><p><mark class="hl-label blue">æ³¨å…¥ä»£ç†å¯¹è±¡ï¼Œé€šè¿‡ä»£ç†å¯¹è±¡è®¿é—®</mark> </p><p>a æ³¨å…¥ b çš„ä»£ç†å¯¹è±¡ï¼Œè¿™æ ·èƒ½å¤Ÿä¿è¯ a çš„æµç¨‹èµ°é€šã€‚åç»­éœ€è¦ç”¨åˆ° b çš„çœŸå®å¯¹è±¡æ—¶ï¼Œå¯ä»¥é€šè¿‡ä»£ç†é—´æ¥è®¿é—®</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210903091627659.png" alt="image-20210903091627659" style="zoom: 50%;" /></p><p>ç”¨ <code>@Lazy</code> ä¸ºæ„é€ æ–¹æ³•å‚æ•°ç”Ÿæˆä»£ç†</p><p>æˆ–<code>@Scope(proxyMode = ScopedProxyMode.TARGET_CLASS)</code></p><p><mark class="hl-label pink">æ³¨å…¥å·¥å‚å¯¹è±¡ï¼Œå»¶è¿Ÿå¯¹è±¡åˆ›å»º</mark> </p><p>a æ³¨å…¥ b çš„å·¥å‚å¯¹è±¡ï¼Œè®© b çš„å®ä¾‹åˆ›å»ºè¢«æ¨è¿Ÿï¼Œè¿™æ ·èƒ½å¤Ÿä¿è¯ a çš„æµç¨‹å…ˆèµ°é€šã€‚åç»­éœ€è¦ç”¨åˆ° b çš„çœŸå®å¯¹è±¡æ—¶ï¼Œå†é€šè¿‡ ObjectFactory å·¥å‚é—´æ¥è®¿é—®</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210903091743366.png" alt="image-20210903091743366" style="zoom:50%;" /></p><p>ç”¨ ObjectProvider å»¶è¿Ÿä¾èµ–å¯¹è±¡çš„åˆ›å»º</p>              </div>            </details><hr><h2 id="Spring-AOP"><a href="#Spring-AOP" class="headerlink" title="Spring-AOP"></a>Spring-AOP</h2><details class="folding-tag" cyan close><summary> ä»€ä¹ˆæ˜¯ä»£ç†æ¨¡å¼?èŠèŠJDKå’ŒCGLibåŠ¨æ€ä»£ç†å®ç°å’ŒåŒºåˆ«? </summary>              <div class='content'>              <p>ä»£ç†æ¨¡å¼æ˜¯ä¸€ç§æ¯”è¾ƒå¥½ç†è§£çš„è®¾è®¡æ¨¡å¼ã€‚ ç®€å•æ¥è¯´å°±æ˜¯æˆ‘ä»¬ä½¿ç”¨ä»£ç†å¯¹è±¡æ¥ä»£æ›¿å¯¹çœŸå®å¯¹è±¡(real object)çš„è®¿é—®ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸ä¿®æ”¹åŸç›®æ ‡å¯¹è±¡çš„å‰æä¸‹ï¼Œæä¾›é¢å¤–çš„åŠŸèƒ½æ“ä½œï¼Œæ‰©å±•ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½ã€‚</p><p>Javaä¸­çš„ä»£ç†æŒ‰ç…§ä»£ç†ç±»ç”Ÿæˆæ—¶æœºä¸åŒåˆåˆ†ä¸º<code>é™æ€ä»£ç†</code>å’Œ<code>åŠ¨æ€ä»£ç†</code>ã€‚é™æ€ä»£ç†ä»£ç†ç±»åœ¨ç¼–è¯‘æœŸå°±ç”Ÿæˆï¼Œè€ŒåŠ¨æ€ä»£ç†ä»£ç†ç±»åˆ™æ˜¯åœ¨Javaè¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆã€‚åŠ¨æ€ä»£ç†åˆæœ‰<code>JDKä»£ç†</code>å’Œ<code>CGLibä»£ç†</code>ä¸¤ç§ã€‚</p><hr><p><mark class="hl-label blue">JDKåŠ¨æ€ä»£ç†</mark> </p><p><code>JDK</code>çš„åŠ¨æ€ä»£ç†æ˜¯åŸºäº<strong>åå°„</strong>å®ç°ã€‚<code>JDK</code>é€šè¿‡åå°„ï¼Œç”Ÿæˆä¸€ä¸ªä»£ç†ç±»ï¼Œè¿™ä¸ªä»£ç†ç±»å®ç°äº†åŸæ¥é‚£ä¸ªç±»çš„å…¨éƒ¨æ¥å£ï¼Œå¹¶å¯¹æ¥å£ä¸­å®šä¹‰çš„æ‰€æœ‰æ–¹æ³•è¿›è¡Œäº†ä»£ç†ã€‚å½“æˆ‘ä»¬é€šè¿‡ä»£ç†å¯¹è±¡æ‰§è¡ŒåŸæ¥é‚£ä¸ªç±»çš„æ–¹æ³•æ—¶ï¼Œä»£ç†ç±»åº•å±‚ä¼šé€šè¿‡åå°„æœºåˆ¶ï¼Œå›è°ƒæˆ‘ä»¬å®ç°çš„<code>InvocationHandler</code>æ¥å£çš„<code>invoke</code>æ–¹æ³•ã€‚å¹¶ä¸”è¿™ä¸ªä»£ç†ç±»æ˜¯Proxyç±»çš„å­ç±»ã€‚è¿™å°±æ˜¯<code>JDK</code>åŠ¨æ€ä»£ç†å¤§è‡´çš„å®ç°æ–¹å¼ã€‚</p><p>ä¼˜ç‚¹:</p><ol><li><code>JDK</code>åŠ¨æ€ä»£ç†æ˜¯<code>JDK</code>åŸç”Ÿçš„ï¼Œä¸éœ€è¦ä»»ä½•ä¾èµ–å³å¯ä½¿ç”¨ï¼›</li><li>é€šè¿‡åå°„æœºåˆ¶ç”Ÿæˆä»£ç†ç±»çš„é€Ÿåº¦è¦æ¯”<code>CGLib</code>æ“ä½œå­—èŠ‚ç ç”Ÿæˆä»£ç†ç±»çš„é€Ÿåº¦æ›´å¿«ï¼›</li></ol><p>ç¼ºç‚¹:</p><ol><li>å¦‚æœè¦ä½¿ç”¨<code>JDK</code>åŠ¨æ€ä»£ç†ï¼Œè¢«ä»£ç†çš„ç±»å¿…é¡»å®ç°äº†æ¥å£ï¼Œå¦åˆ™æ— æ³•ä»£ç†()ï¼›</li><li><code>JDK</code>åŠ¨æ€ä»£ç†æ— æ³•ä¸ºæ²¡æœ‰åœ¨æ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•å®ç°ä»£ç†ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå®ç°äº†æ¥å£çš„ç±»ï¼Œæˆ‘ä»¬ä¸ºå®ƒçš„ä¸€ä¸ªä¸å±äºæ¥å£ä¸­çš„æ–¹æ³•é…ç½®äº†åˆ‡é¢ï¼Œ<code>Spring</code>ä»ç„¶ä¼šä½¿ç”¨<code>JDK</code>çš„åŠ¨æ€ä»£ç†ï¼Œä½†æ˜¯ç”±äºé…ç½®äº†åˆ‡é¢çš„æ–¹æ³•ä¸å±äºæ¥å£ï¼Œä¸ºè¿™ä¸ªæ–¹æ³•é…ç½®çš„åˆ‡é¢å°†ä¸ä¼šè¢«ç»‡å…¥ã€‚</li><li><code>JDK</code>åŠ¨æ€ä»£ç†æ‰§è¡Œä»£ç†æ–¹æ³•æ—¶ï¼Œéœ€è¦é€šè¿‡åå°„æœºåˆ¶è¿›è¡Œå›è°ƒï¼Œæ­¤æ—¶æ–¹æ³•æ‰§è¡Œçš„æ•ˆç‡æ¯”è¾ƒä½ï¼›</li></ol><p>æ³¨ï¼šJDKä»£ç†ï¼Œä»£ç†çš„æ˜¯æ¥å£ï¼Œæ—¢ç„¶ä»£ç†çš„æ˜¯æ¥å£ï¼Œé‚£å¦‚æœæ²¡æœ‰å®ç°ç±»æ€ä¹ˆåŠï¼Œèƒ½ä¸èƒ½ä»£ç†ã€‚ç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼ŒMybatiså°±æ˜¯è¿™æ ·çš„ã€‚</p><hr><p><mark class="hl-label green">CGLibåŠ¨æ€ä»£ç†</mark> </p><p><code>CGLib</code>å®ç°åŠ¨æ€ä»£ç†çš„åŸç†æ˜¯ï¼Œåº•å±‚é‡‡ç”¨äº†<code>ASM</code>å­—èŠ‚ç ç”Ÿæˆæ¡†æ¶ï¼Œç›´æ¥å¯¹éœ€è¦ä»£ç†çš„ç±»çš„å­—èŠ‚ç è¿›è¡Œæ“ä½œï¼Œç”Ÿæˆè¿™ä¸ªç±»çš„ä¸€ä¸ªå­ç±»ï¼Œå¹¶é‡å†™äº†ç±»çš„æ‰€æœ‰å¯ä»¥é‡å†™çš„æ–¹æ³•ï¼Œåœ¨é‡å†™çš„è¿‡ç¨‹ä¸­ï¼Œå°†æˆ‘ä»¬å®šä¹‰çš„é¢å¤–çš„é€»è¾‘ï¼ˆç®€å•ç†è§£ä¸º<code>Spring</code>ä¸­çš„åˆ‡é¢ï¼‰ç»‡å…¥åˆ°æ–¹æ³•ä¸­ï¼Œå¯¹æ–¹æ³•è¿›è¡Œäº†å¢å¼ºã€‚è€Œé€šè¿‡å­—èŠ‚ç æ“ä½œç”Ÿæˆçš„ä»£ç†ç±»ï¼Œå’Œæˆ‘ä»¬è‡ªå·±ç¼–å†™å¹¶ç¼–è¯‘åçš„ç±»æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚</p><p>ä¼˜ç‚¹:</p><ol><li>ä½¿ç”¨<code>CGLib</code>ä»£ç†çš„ç±»ï¼Œä¸éœ€è¦å®ç°æ¥å£ï¼Œå› ä¸º<code>CGLib</code>ç”Ÿæˆçš„ä»£ç†ç±»æ˜¯ç›´æ¥ç»§æ‰¿è‡ªéœ€è¦è¢«ä»£ç†çš„ç±»ï¼›</li><li><code>CGLib</code>ç”Ÿæˆçš„ä»£ç†ç±»æ˜¯åŸæ¥é‚£ä¸ªç±»çš„å­ç±»ï¼Œè¿™å°±æ„å‘³ç€è¿™ä¸ªä»£ç†ç±»å¯ä»¥ä¸ºåŸæ¥é‚£ä¸ªç±»ä¸­ï¼Œæ‰€æœ‰èƒ½å¤Ÿè¢«å­ç±»é‡å†™çš„æ–¹æ³•è¿›è¡Œä»£ç†ï¼›</li><li><code>CGLib</code>ç”Ÿæˆçš„ä»£ç†ç±»ï¼Œå’Œæˆ‘ä»¬è‡ªå·±ç¼–å†™å¹¶ç¼–è¯‘çš„ç±»æ²¡æœ‰å¤ªå¤§åŒºåˆ«ï¼Œå¯¹æ–¹æ³•çš„è°ƒç”¨å’Œç›´æ¥è°ƒç”¨æ™®é€šç±»çš„æ–¹å¼ä¸€è‡´ï¼Œæ‰€ä»¥<code>CGLib</code>æ‰§è¡Œä»£ç†æ–¹æ³•çš„æ•ˆç‡è¦é«˜äº<code>JDK</code>çš„åŠ¨æ€ä»£ç†ï¼›</li></ol><p>ç¼ºç‚¹:</p><ol><li>ç”±äº<code>CGLib</code>çš„ä»£ç†ç±»ä½¿ç”¨çš„æ˜¯ç»§æ‰¿ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€å¦‚æœéœ€è¦è¢«ä»£ç†çš„ç±»æ˜¯ä¸€ä¸ª<code>final</code>ç±»ï¼Œåˆ™æ— æ³•ä½¿ç”¨<code>CGLib</code>ä»£ç†ï¼›</li><li>ç”±äº<code>CGLib</code>å®ç°ä»£ç†æ–¹æ³•çš„æ–¹å¼æ˜¯é‡å†™çˆ¶ç±»çš„æ–¹æ³•ï¼Œæ‰€ä»¥æ— æ³•å¯¹<code>final</code>æ–¹æ³•ï¼Œæˆ–è€…<code>private</code>æ–¹æ³•è¿›è¡Œä»£ç†ï¼Œå› ä¸ºå­ç±»æ— æ³•é‡å†™è¿™äº›æ–¹æ³•ï¼›</li><li><code>CGLib</code>ç”Ÿæˆä»£ç†ç±»çš„æ–¹å¼æ˜¯é€šè¿‡æ“ä½œå­—èŠ‚ç ï¼Œè¿™ç§æ–¹å¼ç”Ÿæˆä»£ç†ç±»çš„é€Ÿåº¦è¦æ¯”<code>JDK</code>é€šè¿‡åå°„ç”Ÿæˆä»£ç†ç±»çš„é€Ÿåº¦æ›´æ…¢ï¼›</li></ol>              </div>            </details><hr><details class="folding-tag" green close><summary> ä»£ç†å¯¹è±¡åˆ›å»ºçš„æ—¶æœº? </summary>              <div class='content'>              <p><span id="jump"></span></p><p>Aspect = advice + pointcut ï¼Œ ä¸€ä¸ªåˆ‡é¢ç±»ä¸­å¯èƒ½æœ‰ä¸€åˆ°å¤šä¸ªé€šçŸ¥æ–¹æ³•ã€‚</p><p>advisor = æ›´ç»†ç²’åº¦çš„åˆ‡é¢ï¼ŒåŒ…å«ä¸€ä¸ªé€šçŸ¥å’Œåˆ‡ç‚¹ã€‚</p><p>é…ç½®çš„åˆ‡ç‚¹ã€åˆ‡é¢éƒ½ä¼šè½¬æ¢æˆä¸€ä¸ªä¸ª<code>Advisor</code>å¯¹è±¡ã€‚</p><p>ä»£ç†å¯¹è±¡å†…éƒ¨ä¼šä¿å­˜å…³è”çš„<code>Advisor</code>å¯¹è±¡ã€‚</p><p><code>AnnotationAwareAspectJAutoProxyCreator#wrapIfNecessary()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">wrapIfNecessary</span><span class="params">(Object bean, String beanName, Object cacheKey)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.hasLength(beanName) &amp;&amp; <span class="built_in">this</span>.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line"><span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (Boolean.FALSE.equals(<span class="built_in">this</span>.advisedBeans.get(cacheKey))) &#123;</span><br><span class="line"><span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line">   <span class="comment">// åˆ¤æ–­beanæ˜¯å¦æ˜¯åˆ‡ç‚¹ã€åˆ‡é¢ã€é€šçŸ¥ è¿™äº›ä¸è¿›è¡Œå¢å¼º</span></span><br><span class="line"><span class="keyword">if</span> (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;</span><br><span class="line"><span class="built_in">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line"><span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create proxy if we have advice. å¯»æ‰¾åŒ¹é…çš„åˆ‡é¢</span></span><br><span class="line">Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, <span class="literal">null</span>);</span><br><span class="line"><span class="keyword">if</span> (specificInterceptors != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="built_in">this</span>.advisedBeans.put(cacheKey, Boolean.TRUE);</span><br><span class="line"><span class="type">Object</span> <span class="variable">proxy</span> <span class="operator">=</span> createProxy(</span><br><span class="line">bean.getClass(), beanName, specificInterceptors, <span class="keyword">new</span> <span class="title class_">SingletonTargetSource</span>(bean));</span><br><span class="line"><span class="built_in">this</span>.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line">     <span class="comment">// è¿”å›ä»£ç†å¯¹è±¡</span></span><br><span class="line"><span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">   <span class="comment">// æ²¡æœ‰åŒ¹é…çš„åˆ‡é¢ ä¸è¿›è¡Œå¢å¼º</span></span><br><span class="line"><span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡ªåŠ¨ä»£ç†åå¤„ç†å™¨åœ¨å“ªé‡Œä¼šè¢«è°ƒç”¨åˆ°</p><p>åˆ›å»ºé˜¶æ®µ å¦‚æœä¼ å…¥äº†TargetSource ï¼ˆäº†è§£å³å¯ï¼‰</p><p>åˆå§‹åŒ–é˜¶æ®µ åå¤„ç†å™¨ä»£ç†</p><p>ä¾èµ–æ³¨å…¥é˜¶æ®µ äº§ç”Ÿäº†å¾ªç¯ä¾èµ– åœ¨å•ä¾‹å·¥å‚æ± ä¸­é€šè¿‡å·¥å‚å¯¹è±¡é—´æ¥è°ƒç”¨åˆ°åå¤„ç†å™¨ç±»åˆ›å»ºä»£ç†</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240301114922096.png" alt="image-20240301114922096"></p>              </div>            </details><hr><h2 id="Spring-äº‹åŠ¡"><a href="#Spring-äº‹åŠ¡" class="headerlink" title="Spring-äº‹åŠ¡"></a>Spring-äº‹åŠ¡</h2><details class="folding-tag" cyan close><summary> Springäº‹åŠ¡å¤±æ•ˆåœºæ™¯ </summary>              <div class='content'>              <blockquote><p>é…ç½®é—®é¢˜</p></blockquote><p><mark class="hl-label blue">æ•°æ®åº“ä¸æ”¯æŒäº‹åŠ¡</mark> </p><p>äº‹åŠ¡æœ¬æ¥å°±æ˜¯æ•°æ®åº“çš„åŠŸèƒ½ï¼Œå¦‚æœæ•°æ®åº“æœ¬èº«ä¸æ”¯æŒäº‹åŠ¡ï¼Œé‚£ä»»å‡­ä»£ç ä¸Šå¦‚ä½•è®¾ç½®ä¹Ÿæ˜¯æ²¡ç”¨çš„ã€‚ä»¥MySQLä¸ºä¾‹ï¼ŒInnoDBå¼•æ“æ˜¯æ”¯æŒäº‹åŠ¡çš„ï¼Œè€ŒåƒMyISAMã€MEMORYç­‰æ˜¯ä¸æ”¯æŒäº‹åŠ¡çš„ã€‚ä»MySQL5.5.5å¼€å§‹é»˜è®¤çš„å­˜å‚¨å¼•æ“æ˜¯InnoDBï¼Œä¹‹å‰é»˜è®¤éƒ½æ˜¯MyISAMã€‚</p><hr><p><mark class="hl-label green">æœªå¼€å¯äº‹åŠ¡</mark> </p><p>å¦‚æœæ˜¯SpringBooté¡¹ç›®ï¼Œé‚£ä¹ˆSpringBooté€šè¿‡DataSourceTransactionManagerAutoConfigurationè‡ªåŠ¨é…ç½®ç±»å¸®æˆ‘ä»¬å¼€å¯äº†äº‹åŠ¡ã€‚å¦‚æœæ˜¯ä¼ ç»Ÿçš„Springé¡¹ç›®ï¼Œåˆ™éœ€è¦æˆ‘ä»¬è‡ªå·±é…ç½®</p><hr><blockquote><p>Spring-AOPä»£ç†</p></blockquote><p><mark class="hl-label blue">äº‹åŠ¡æ–¹æ³•è¢«finalæˆ–staticå…³é”®å­—ä¿®é¥°</mark> </p><p>å¦‚æœ<code>Spring</code>ä½¿ç”¨äº†<code>Cglib</code>ä»£ç†å®ç°ï¼ˆæ¯”å¦‚ä½ çš„ä»£ç†ç±»æ²¡æœ‰å®ç°æ¥å£ï¼‰ï¼Œè€Œä½ çš„ä¸šåŠ¡æ–¹æ³•æ°å¥½ä½¿ç”¨äº†<code>final</code>æˆ–è€…<code>static</code>å…³é”®å­—ï¼Œé‚£ä¹ˆäº‹åŠ¡ä¹Ÿä¼šå¤±è´¥ã€‚æ›´å…·ä½“åœ°è¯´ï¼Œå®ƒåº”è¯¥æŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸º<code>Cglib</code>ä½¿ç”¨å­—èŠ‚ç å¢å¼ºæŠ€æœ¯ç”Ÿæˆè¢«ä»£ç†ç±»çš„å­ç±»å¹¶é‡å†™è¢«ä»£ç†ç±»çš„æ–¹æ³•æ¥å®ç°ä»£ç†ã€‚å¦‚æœè¢«ä»£ç†çš„æ–¹æ³•çš„æ–¹æ³•ä½¿ç”¨<code>final</code>æˆ–<code>static</code>å…³é”®å­—ï¼Œåˆ™å­ç±»ä¸èƒ½é‡å†™è¢«ä»£ç†çš„æ–¹æ³•ã€‚</p><p>å¦‚æœ<code>Spring</code>ä½¿ç”¨<code>JDK</code>åŠ¨æ€ä»£ç†å®ç°ï¼Œ<code>JDK</code>åŠ¨æ€ä»£ç†æ˜¯åŸºäºæ¥å£å®ç°çš„ï¼Œé‚£ä¹ˆ<code>final</code>å’Œ<code>static</code>ä¿®é¥°çš„æ–¹æ³•ä¹Ÿå°±æ— æ³•è¢«ä»£ç†ã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼Œæ–¹æ³•è¿ä»£ç†éƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆè‚¯å®šæ— æ³•å®ç°äº‹åŠ¡å›æ»šäº†ã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p><p>å»æ‰finalæˆ–è€…staticå…³é”®å­—</p><hr><p><mark class="hl-label green">æ–¹æ³•çš„è®¿é—®æƒé™ä¸æ˜¯public</mark> </p><p>å¦‚æœæ–¹æ³•çš„è®¿é—®æƒé™ä¸æ˜¯<code>public</code>ï¼Œ<code>Spring</code>äº‹åŠ¡ä¹Ÿä¼šå¤±è´¥ï¼Œå› ä¸º<code>Spring</code>çš„äº‹åŠ¡ç®¡ç†æºç <code>AbstractFallbackTransactionAttributeSource</code>ä¸­æœ‰åˆ¤æ–­<code>computeTransactionAttribute()ã€‚</code>å¦‚æœç›®æ ‡æ–¹æ³•ä¸æ˜¯å…¬å…±çš„ï¼Œåˆ™<code>TransactionAttribute</code>è¿”å›<code>null</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Don&#x27;t allow no-public methods as required.</span></span><br><span class="line"><span class="keyword">if</span> (allowPublicMethodsOnly() &amp;&amp; !Modifier.isPublic(method.getModifiers())) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p><p>æ˜¯å°†å½“å‰æ–¹æ³•è®¿é—®çº§åˆ«æ›´æ”¹ä¸º<code>public</code></p><hr><p><mark class="hl-label red">åŒä¸€ä¸ªç±»ä¸­ï¼Œæ–¹æ³•å†…éƒ¨è°ƒç”¨</mark> </p><p>äº‹åŠ¡æ˜¯é€šè¿‡ <code>Spring AOP</code>ä»£ç†æ¥å®ç°çš„ï¼Œè€Œåœ¨åŒä¸€ä¸ªç±»ä¸­ï¼Œä¸€ä¸ªæ–¹æ³•è°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œ è°ƒç”¨æ–¹æ³•ç›´æ¥è°ƒç”¨ç›®æ ‡æ–¹æ³•çš„ä»£ç ï¼Œè€Œä¸æ˜¯é€šè¿‡ä»£ç†ç±»è¿›è¡Œè°ƒç”¨ï¼Œå› æ­¤äº‹åŠ¡ä¸ç”Ÿæ•ˆã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p><ol><li>ä¾èµ–æ³¨å…¥è‡ªå·±ï¼ˆä»£ç†ï¼‰ï¼Œé€šè¿‡ä»£ç†ç±»æ¥è°ƒç”¨ç›®æ ‡æ–¹æ³•</li><li>å¼€å¯<code>@EnableAspectJAutoProxy(exposeProxy = true)</code>ï¼Œ<code>AopContext.currentProxy())</code>å¾—åˆ°ä»£ç†å¯¹è±¡ï¼Œå†è°ƒç”¨ç›®æ ‡æ–¹æ³•</li></ol><hr><blockquote><p>é”™è¯¯çš„å¼‚å¸¸å¤„ç†</p></blockquote><p><mark class="hl-label blue">æŠ›å‡ºæ£€æŸ¥å¼‚å¸¸</mark> </p><p>æ¯”å¦‚ä½ çš„äº‹åŠ¡æ§åˆ¶ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Service1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountMapper accountMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> from, <span class="type">int</span> to, <span class="type">int</span> amount)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">fromBalance</span> <span class="operator">=</span> accountMapper.findBalanceBy(from);</span><br><span class="line">        <span class="keyword">if</span> (fromBalance - amount &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            accountMapper.update(from, -<span class="number">1</span> * amount);</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">            accountMapper.update(to, amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ<code>@Transactional</code> æ²¡æœ‰ç‰¹åˆ«æŒ‡å®šï¼ŒSpring åªä¼šåœ¨é‡åˆ°è¿è¡Œæ—¶å¼‚å¸¸RuntimeExceptionæˆ–è€…erroræ—¶è¿›è¡Œå›æ»šï¼Œè€Œ<code>IOException</code>ç­‰æ£€æŸ¥å¼‚å¸¸ä¸ä¼šå½±å“å›æ»šã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">rollbackOn</span><span class="params">(Throwable ex)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> (ex <span class="keyword">instanceof</span> RuntimeException || ex <span class="keyword">instanceof</span> Error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p><p>çŸ¥é“åŸå› åï¼Œè§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ã€‚é…ç½®<code>rollbackFor</code>å±æ€§ï¼Œä¾‹å¦‚<code>@Transactional(rollbackFor = Exception.class)</code>ã€‚</p><hr><p><mark class="hl-label green">ä¸šåŠ¡æ–¹æ³•æœ¬èº«æ•è·äº†å¼‚å¸¸</mark> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Service2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountMapper accountMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> from, <span class="type">int</span> to, <span class="type">int</span> amount)</span>  &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">fromBalance</span> <span class="operator">=</span> accountMapper.findBalanceBy(from);</span><br><span class="line">            <span class="keyword">if</span> (fromBalance - amount &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                accountMapper.update(from, -<span class="number">1</span> * amount);</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">                accountMapper.update(to, amount);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§åœºæ™¯ä¸‹ï¼Œäº‹åŠ¡å¤±è´¥çš„åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œäº‹åŠ¡é€šçŸ¥åªæœ‰æ‰åˆ°äº†ç›®æ ‡æŠ›å‡ºçš„å¼‚å¸¸ï¼Œæ‰èƒ½è¿›è¡Œåç»­çš„å›æ»šå¤„ç†ï¼Œå¦‚æœç›®æ ‡è‡ªå·±å¤„ç†æ‰å¼‚å¸¸ï¼Œäº‹åŠ¡é€šçŸ¥æ— æ³•çŸ¥æ‚‰ã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p><ol><li>å¼‚å¸¸catchåå†æ¬¡æŠ›å‡º</li><li>æ‰‹åŠ¨è®¾ç½® <code>TransactionInterceptor.currentTransactionstatus().setRolLbackOnly();</code></li></ol><hr><p><mark class="hl-label red">AOPåˆ‡é¢é¡ºåºå¯¼è‡´å¯¼è‡´å¼‚å¸¸åœ¨åˆ‡é¢å¤„å¤„ç†</mark> </p><p><code>Spring</code>çš„äº‹åŠ¡åˆ‡é¢ä¼˜å…ˆçº§æœ€ä½ï¼Œæ‰€ä»¥å¦‚æœå¼‚å¸¸è¢«åˆ«çš„åˆ‡é¢æ•è·ï¼ŒSpringä¹Ÿä¸èƒ½æ­£å¸¸å¤„ç†äº‹åŠ¡ï¼Œå› ä¸ºäº‹åŠ¡ç®¡ç†å™¨æ— æ³•æ•è·å¼‚å¸¸ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Service3</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountMapper accountMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> from, <span class="type">int</span> to, <span class="type">int</span> amount)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">fromBalance</span> <span class="operator">=</span> accountMapper.findBalanceBy(from);</span><br><span class="line">        <span class="keyword">if</span> (fromBalance - amount &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            accountMapper.update(from, -<span class="number">1</span> * amount);</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">            accountMapper.update(to, amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect</span> &#123;</span><br><span class="line">    <span class="meta">@Around(&quot;execution(* transfer(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        LoggerUtils.get().debug(<span class="string">&quot;log:&#123;&#125;&quot;</span>, pjp.getTarget());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> pjp.proceed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p><ol><li>å¼‚å¸¸catchåå†æ¬¡æŠ›å‡º</li><li>æ‰‹åŠ¨è®¾ç½® <code>TransactionInterceptor.currentTransactionstatus().setRolLbackOnly();</code></li><li>è°ƒæ•´åˆ‡é¢é¡ºåºï¼Œåœ¨ MyAspect ä¸Šæ·»åŠ  <code>@Order(Ordered.LOWEST_PRECEDENCE - 1)</code> ï¼ˆä¸æ¨èï¼‰</li></ol><hr><blockquote><p>@Transactionalç›¸å…³</p></blockquote><p><mark class="hl-label blue">ä½¿ç”¨äº†é”™è¯¯çš„äº‹åŠ¡ä¼ æ’­æœºåˆ¶</mark> </p><p><code>Spring</code>æä¾›äº†ä¸ƒç§äº‹åŠ¡ä¼ æ’­æœºåˆ¶ï¼Œå¯æ ¹æ®â€œæ˜¯å¦æ”¯æŒå½“å‰äº‹åŠ¡â€çš„ç»´åº¦åˆ†ä¸ºä»¥ä¸‹ 3 ç±»ï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image.png" alt="image" style="zoom: 45%;" /></p><p>è‹¥propagationå±æ€§è®¾ç½®å¦‚ä¸‹ä¸‰ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼Œäº‹åŠ¡å°†ä¸ä¼šå‘ç”Ÿå›æ»šã€‚</p><ul><li>SUPPORTSï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™ä»¥éäº‹åŠ¡çš„æ–¹å¼ç»§ç»­è¿è¡Œã€‚</li><li>NOT_SUPPORTEDï¼šä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚</li><li>NEVERï¼šä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</li></ul><hr><p><mark class="hl-label green">Transactionalæ²¡æœ‰ä¿è¯åŸå­è¡Œä¸º</mark> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Service7</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(Service7.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountMapper accountMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> from, <span class="type">int</span> to, <span class="type">int</span> amount)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">fromBalance</span> <span class="operator">=</span> accountMapper.findBalanceBy(from);</span><br><span class="line">        logger.debug(<span class="string">&quot;æ›´æ–°å‰æŸ¥è¯¢ä½™é¢ä¸º: &#123;&#125;&quot;</span>, fromBalance);</span><br><span class="line">        <span class="keyword">if</span> (fromBalance - amount &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            accountMapper.update(from, -<span class="number">1</span> * amount);</span><br><span class="line">            accountMapper.update(to, amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">findBalance</span><span class="params">(<span class="type">int</span> accountNo)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountMapper.findBalanceBy(accountNo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç å®é™…ä¸Šæ˜¯æœ‰ bug çš„ï¼Œå‡è®¾ from ä½™é¢ä¸º 1000ï¼Œä¸¤ä¸ªçº¿ç¨‹éƒ½æ¥è½¬è´¦ 1000ï¼Œå¯èƒ½ä¼šå‡ºç°æ‰£å‡ä¸ºè´Ÿæ•°çš„æƒ…å†µ</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210903120436365.png" alt="image-20210903120436365" style="zoom: 50%;" /></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œçº¢è‰²çº¿ç¨‹å’Œè“è‰²çº¿ç¨‹çš„æŸ¥è¯¢éƒ½å‘ç”Ÿåœ¨æ‰£å‡ä¹‹å‰ï¼Œéƒ½ä»¥ä¸ºè‡ªå·±æœ‰è¶³å¤Ÿçš„ä½™é¢åšæ‰£å‡</p><p><mark class="hl-label red">é’ˆå¯¹ä¸Šé¢çš„é—®é¢˜ï¼Œèƒ½å¦åœ¨æ–¹æ³•ä¸ŠåŠ synchronizedé”æ¥è§£å†³å‘¢ï¼Ÿ</mark> </p><p>ç­”æ¡ˆæ˜¯ä¸è¡Œï¼ŒåŸå› å¦‚ä¸‹ï¼š</p><ul><li>synchronized ä¿è¯çš„ä»…æ˜¯ç›®æ ‡æ–¹æ³•çš„åŸå­æ€§ï¼Œç¯ç»•ç›®æ ‡æ–¹æ³•çš„è¿˜æœ‰ commit ç­‰æ“ä½œï¼Œå®ƒä»¬å¹¶æœªå¤„äº sync å—å†…</li><li>å¯ä»¥å‚è€ƒä¸‹å›¾å‘ç°ï¼Œè“è‰²çº¿ç¨‹çš„æŸ¥è¯¢åªè¦åœ¨çº¢è‰²çº¿ç¨‹æäº¤ä¹‹å‰æ‰§è¡Œï¼Œé‚£ä¹ˆä¾ç„¶ä¼šæŸ¥è¯¢åˆ°æœ‰ 1000 è¶³å¤Ÿä½™é¢æ¥è½¬è´¦</li></ul><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20210903120800185.png" alt="image-20210903120800185" style="zoom:50%;" /></p><ul><li><p>è§£æ³•1ï¼šsynchronized èŒƒå›´åº”æ‰©å¤§è‡³ä»£ç†æ–¹æ³•è°ƒç”¨</p></li><li><p>è§£æ³•2ï¼šä½¿ç”¨ select â€¦ for update æ›¿æ¢ select</p></li></ul><hr><blockquote><p>å¤šçº¿ç¨‹è°ƒç”¨</p></blockquote><p>è¿™æ˜¯å› ä¸º <code>Spring</code>äº‹åŠ¡æ˜¯åŸºäºçº¿ç¨‹ç»‘å®šçš„ï¼Œ æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„äº‹åŠ¡ä¸Šä¸‹æ–‡ï¼Œè€Œå¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯èƒ½ä¼šå­˜åœ¨å¤šä¸ªçº¿ç¨‹å…±äº«åŒä¸€ä¸ªäº‹åŠ¡ä¸Šä¸‹æ–‡çš„æƒ…å†µï¼Œå¯¼è‡´äº‹åŠ¡ä¸ç”Ÿæ•ˆã€‚ <code>Spring</code>äº‹åŠ¡ç®¡ç†å™¨é€šè¿‡ä½¿ç”¨çº¿ç¨‹æœ¬åœ°å˜é‡ï¼ˆ <code>ThreadLocal</code>ï¼‰æ¥å®ç°çº¿ç¨‹å®‰å…¨ã€‚åœ¨Springäº‹åŠ¡ç®¡ç†å™¨ä¸­ï¼Œé€šè¿‡<code>TransactionSynchronizationManager</code>ç±»æ¥ç®¡ç†äº‹åŠ¡ä¸Šä¸‹æ–‡ã€‚<code>TransactionSynchronizationManager</code>å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª<code>ThreadLocal</code>å¯¹è±¡ï¼Œç”¨æ¥å­˜å‚¨å½“å‰çº¿ç¨‹çš„äº‹åŠ¡ä¸Šä¸‹æ–‡ã€‚åœ¨äº‹åŠ¡å¼€å§‹æ—¶ï¼Œ<code>TransactionSynchronizationManager</code>ä¼šå°†äº‹åŠ¡ä¸Šä¸‹æ–‡ç»‘å®šåˆ°å½“å‰çº¿ç¨‹çš„<code>ThreadLocal</code>å¯¹è±¡ä¸­ï¼Œå½“äº‹åŠ¡ç»“æŸæ—¶ï¼Œ<code>TransactionSynchronizationManager</code>ä¼šå°†äº‹åŠ¡ä¸Šä¸‹æ–‡ä»<code>ThreadLocal</code>å¯¹è±¡ä¸­ç§»é™¤ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doSomeThing</span><span class="params">(User user)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å­çº¿ç¨‹æ‰§è¡Œ</span></span><br><span class="line">    CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">        userMapper.insert(user);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¸»çº¿ç¨‹æ‰§è¡Œ</span></span><br><span class="line">    userMapper.insert(user);</span><br><span class="line">    <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šå°†Connectionè¿æ¥æ”¾åœ¨è‡ªå·±çš„threadlocalé‡Œé¢ï¼Œæ‰€ä»¥@Transactionalè·å–ä¸åˆ°å­çº¿ç¨‹çš„è¿æ¥ï¼Œæ²¡æ³•å›æ»š</p><p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p><p>çˆ¶å­çº¿ç¨‹å…±ç”¨ä¸€ä¸ªè¿æ¥ï¼Œå­çº¿ç¨‹å¦‚æœè¿è¡Œå‡ºé”™ï¼Œè¦åœ¨ä¸»çº¿ç¨‹ä¸­è·å–åˆ°å¹¶æŠ›å‡ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doSomeThing</span><span class="params">(User user)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.åœ¨ä¸»çº¿ç¨‹é‡Œè·å–æ•°æ®åº“è¿æ¥èµ„æº</span></span><br><span class="line">    <span class="type">ConnectionHolder</span> <span class="variable">conHolder</span> <span class="operator">=</span></span><br><span class="line">            (ConnectionHolder) TransactionSynchronizationManager.getResource(dataSource);</span><br><span class="line">    <span class="comment">//å­çº¿ç¨‹æ‰§è¡Œ</span></span><br><span class="line">    CompletableFuture&lt;Void&gt; future = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// 2.å­çº¿ç¨‹ç»‘å®šä¸»çº¿ç¨‹çš„æ•°æ®åº“è¿æ¥èµ„æº</span></span><br><span class="line">        TransactionSynchronizationManager.bindResource(dataSource, conHolder);</span><br><span class="line">        userMapper.insert(user);</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 3.è§£ç»‘</span></span><br><span class="line">        TransactionSynchronizationManager.unbindResource(dataSource);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//ä¸»çº¿ç¨‹æ‰§è¡Œ</span></span><br><span class="line">    userMapper.insert(user);</span><br><span class="line">    <span class="comment">// é˜»å¡ç­‰å¾…å­çº¿ç¨‹ å¹¶æ‹¿åˆ°å­çº¿ç¨‹çš„å¼‚å¸¸ è‹¥æŠ›å‡ºå¼‚å¸¸ åˆ™joinåä¹Ÿä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    future.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>              </div>            </details><hr><h2 id="SpringBoot"><a href="#SpringBoot" class="headerlink" title="SpringBoot"></a>SpringBoot</h2><details class="folding-tag" cyan close><summary> Jarlauncherçš„ä½œç”¨? </summary>              <div class='content'>              <p>åœ¨å¼€å‘ç¯å¢ƒä¸­é€šè¿‡è¿è¡Œideaä¸­çš„runæ–¹å¼å³å¯è¿è¡ŒSpringBootåº”ç”¨ï¼Œä¹Ÿæ˜¯åœ¨å¼€å‘è¿‡ç¨‹ä¸­æœ€å¸¸è§çš„ä¸€ç§æ–¹å¼ã€‚è¿™ç§æ–¹å¼å¯åŠ¨ä½¿ç”¨çš„ç±»åŠ è½½å™¨ä¸º<code>AppClassLoader</code>ï¼Œæ‰€æœ‰ä¾èµ–çš„jaråŒ…éƒ½é€šè¿‡<code>-classpath</code>æ·»åŠ è‡³å¯åŠ¨å‚æ•°ã€‚</p><p>åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œå°†Mavenæ’ä»¶å°†é¡¹ç›®æ‰“æˆjaråŒ…åï¼Œå¯ä»¥é€šè¿‡è¿è¡Œå‘½ä»¤å‡½å‚æ•°<code>java -jar</code>çš„æ–¹å¼è¿è¡Œã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ BOOT-INF</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ classes -- åº”ç”¨ç¨‹åº</span><br><span class="line">â”‚Â Â  â””â”€â”€ lib --é¡¹ç›®è¿è¡Œä¾èµ–çš„jaråŒ…</span><br><span class="line">â”œâ”€â”€ META-INF</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ MANIFEST.MF --æ¸…å•æ–‡ä»¶</span><br><span class="line">â”‚Â Â  â””â”€â”€ maven</span><br><span class="line">â””â”€â”€ org</span><br><span class="line">    â””â”€â”€ springframework</span><br><span class="line">        â””â”€â”€ boot</span><br><span class="line">            â””â”€â”€ loader -- é€šè¿‡æ‰“åŒ…æ’ä»¶æ‰“å…¥</span><br></pre></td></tr></table></figure><p>åœ¨æ¸…å•æ–‡ä»¶ä¸­<code>MANIFEST.MF</code></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Manifest-Version</span>: <span class="string">1.0</span></span><br><span class="line"><span class="attr">Created-By</span>: <span class="string">Maven JAR Plugin 3.2.2</span></span><br><span class="line"><span class="attr">Build-Jdk-Spec</span>: <span class="string">17</span></span><br><span class="line"><span class="attr">Main-Class</span>: <span class="string">org.springframework.boot.loader.JarLauncher </span></span><br><span class="line"><span class="attr">Start-Class</span>: <span class="string">com.whut.PortApplication </span></span><br><span class="line"><span class="attr">Spring-Boot-Version</span>: <span class="string">3.0.7</span></span><br><span class="line"><span class="attr">Spring-Boot-Classes</span>: <span class="string">BOOT-INF/classes/</span></span><br><span class="line"><span class="attr">Spring-Boot-Lib</span>: <span class="string">BOOT-INF/lib/</span></span><br><span class="line"><span class="attr">Spring-Boot-Classpath-Index</span>: <span class="string">BOOT-INF/classpath.idx</span></span><br><span class="line"><span class="attr">Spring-Boot-Layers-Index</span>: <span class="string">BOOT-INF/layers.idx</span></span><br></pre></td></tr></table></figure><ul><li><code>Main-Class</code>æ˜¯<code>org.springframework.boot.loader.JarLauncher</code>ï¼Œå³jarå¯åŠ¨çš„Mainå‡½æ•°ï¼›</li><li><code>Start-Class</code>æ˜¯<code>com.whut.PortApplication</code> ï¼Œå³æˆ‘ä»¬è‡ªå·±SpringBooté¡¹ç›®çš„å¯åŠ¨ç±»ï¼›</li></ul><p>å› ä¸ºorg.springframework.boot.loader.JarLauncherç±»å­˜åœ¨äºorg.springframework.boot:spring-boot-loaderä¸­ï¼Œæ‰€ä»¥çœ‹æºç ä¹‹å‰éœ€è¦å…ˆå¼•å…¥mavenä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-loader<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="tabs" id="91a018db-47a9-47db-82d9-fbd971ee6736"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#91a018db-47a9-47db-82d9-fbd971ee6736-1"><i class="fas fa-seedling"></i>JarLauncheræºç </button></li><li class="tab"><button type="button" data-href="#91a018db-47a9-47db-82d9-fbd971ee6736-2"><i class="fas fa-leaf"></i>Launcher#launch(args)æ–¹æ³•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="91a018db-47a9-47db-82d9-fbd971ee6736-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JarLauncher</span> <span class="keyword">extends</span> <span class="title class_">ExecutableArchiveLauncher</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">EntryFilter</span> <span class="variable">NESTED_ARCHIVE_ENTRY_FILTER</span> <span class="operator">=</span> (entry) -&gt; &#123;</span><br><span class="line"><span class="keyword">if</span> (entry.isDirectory()) &#123;</span><br><span class="line"><span class="keyword">return</span> entry.getName().equals(<span class="string">&quot;BOOT-INF/classes/&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> entry.getName().startsWith(<span class="string">&quot;BOOT-INF/lib/&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">JarLauncher</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">JarLauncher</span><span class="params">(Archive archive)</span> &#123;</span><br><span class="line"><span class="built_in">super</span>(archive);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isPostProcessingClassPathArchives</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isNestedArchive</span><span class="params">(Archive.Entry entry)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> NESTED_ARCHIVE_ENTRY_FILTER.matches(entry);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> String <span class="title function_">getArchiveEntryPathPrefix</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;BOOT-INF/&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">JarLauncher</span>().launch(args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>JarLauncher#main()</code>ä¸­æ–°å»ºäº†<code>JarLauncher</code>å¹¶è°ƒç”¨çˆ¶ç±»Launcherä¸­çš„<code>launch()</code>æ–¹æ³•å¯åŠ¨ç¨‹åºï¼›<br><code>isNestedArchive(Archinve.Entry entry)</code>æ–¹æ³•ç”¨äºåˆ¤æ–­FAT JARèµ„æºçš„ç›¸å¯¹è·¯å¾„æ˜¯å¦ä¸º<code>nestedArchive</code>åµŒå¥—æ–‡æ¡£ã€‚è¿›è€Œå†³å®šè¿™äº›FAT JARæ˜¯å¦ä¼šè¢«launchã€‚å½“æ–¹æ³•è¿”å›falseæ—¶ï¼Œè¯´æ˜FAT JARè¢«è§£å‹è‡³æ–‡ä»¶ç›®å½•</p><blockquote><p>Archiveçš„æ¦‚å¿µ</p></blockquote><p>archiveå³å½’æ¡£æ–‡ä»¶ï¼Œè¿™ä¸ªæ¦‚å¿µåœ¨linuxä¸‹æ¯”è¾ƒå¸¸è§ï¼›é€šå¸¸å°±æ˜¯ä¸€ä¸ªtar/zipæ ¼å¼çš„å‹ç¼©åŒ…ï¼›è€Œjaræ­£æ˜¯zipæ ¼å¼çš„ã€‚</p><p>SpringBootæŠ½è±¡äº†Archiveçš„æ¦‚å¿µï¼Œä¸€ä¸ªArchiveå¯ä»¥æ˜¯jarï¼ˆJarFileArchiveï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯æ–‡ä»¶ç›®å½•ï¼ˆExplodedArchiveï¼‰ï¼›è¿™æ ·ä¹Ÿå°±ç»Ÿä¸€äº†è®¿é—®èµ„æºçš„é€»è¾‘å±‚ï¼›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Archive</span> <span class="keyword">extends</span> <span class="title class_">Iterable</span>&lt;Archive.Entry&gt;, AutoCloseable &#123;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Archive</code>ç»§æ‰¿è‡ª<code>Archive.Entry</code>ï¼Œ<code>Archive.Entry</code>æœ‰ä¸¤ç§å®ç°ï¼š</p><ul><li><code>JarFileArchive.JarFileEntry</code> â€”&gt; åŸºäº<code>java.util.jar.JarEntry</code>å®ç°ï¼Œè¡¨ç¤ºFAT JARåµŒå…¥èµ„æºã€‚</li><li><code>ExplodedArchive.FileEntry</code> â€”&gt; åŸºäºæ–‡ä»¶ç³»ç»Ÿå®ç°ï¼›</li></ul><p>ä¸¤è€…çš„ä¸»è¦å·®åˆ«æ˜¯<code>ExplodedArchive</code>ç›¸æ¯”äºJarFileArchiveå¤šäº†ä¸€ä¸ªè·å–æ–‡ä»¶çš„getFile()æ–¹æ³•ï¼›</p><p>ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªåœ¨jaråŒ…ç¯å¢ƒä¸‹å¯»æ‰¾èµ„æºï¼Œä¸€ä¸ªåœ¨æ–‡ä»¶å¤¹ç›®å½•ä¸‹å¯»æ‰¾èµ„æº</p><p><strong>å½“æ‰§è¡Œjava -jarå‘½ä»¤æ—¶ï¼Œå°†è°ƒç”¨/META-INF /MANIFEST.MFæ–‡ä»¶çš„Main-Classå±æ€§çš„main()æ–¹æ³•ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯JarLauncher#launch(args)æ–¹æ³•ï¼›</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="91a018db-47a9-47db-82d9-fbd971ee6736-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">launch</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isExploded()) &#123;</span><br><span class="line">        <span class="comment">// phase1ï¼šæ³¨å†Œjar URLå¤„ç†å™¨</span></span><br><span class="line">        JarFile.registerUrlProtocolHandler();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// phase2ï¼šåˆ›å»ºClassLoader</span></span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> createClassLoader(getClassPathArchivesIterator());</span><br><span class="line">    <span class="type">String</span> <span class="variable">jarMode</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;jarmode&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">launchClass</span> <span class="operator">=</span> (jarMode != <span class="literal">null</span> &amp;&amp; !jarMode.isEmpty()) ? JAR_MODE_LAUNCHER : getMainClass();</span><br><span class="line">    <span class="comment">// phase3ï¼šåå°„è°ƒç”¨å®é™…çš„å¼•å¯¼ç±»launch</span></span><br><span class="line">    launch(args, launchClass, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒJDKæä¾›çš„ClassLoaderåªèƒ½è¯†åˆ«jarä¸­çš„classæ–‡ä»¶ä»¥åŠåŠ è½½classpathä¸‹çš„å…¶ä»–jaråŒ…ä¸­çš„classæ–‡ä»¶ï¼Œå¯¹äºjar in jarçš„åŒ…æ— æ³•åŠ è½½ï¼›<br>å½“SpringBoot FAT JARè¢«<code>java -jar</code>å‘½ä»¤å¼•å¯¼æ—¶ï¼Œå…¶å†…éƒ¨çš„JARæ–‡ä»¶æ— æ³•è¢«å†…åµŒå®ç°å½“åšclassPathï¼Œæ•…éœ€è¦å®šä¹‰äº†ä¸€å¥—URLStreamHandlerå®ç°ç±»å’ŒJarURLConnectionå®ç°ç±»ï¼Œç”¨æ¥åŠ è½½jar in jaråŒ…çš„classç±»æ–‡ä»¶ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><blockquote><p>æ€»ç»“</p></blockquote><p>Spring Bootåº”ç”¨æ‰“åŒ…ä¹‹åï¼Œç”Ÿæˆä¸€ä¸ª<code>Fat jar</code>ï¼ŒåŒ…å«äº†åº”ç”¨ä¾èµ–çš„æ‰€æœ‰ä¸‰æ–¹jaråŒ…å’ŒSpringBoot Loaderç›¸å…³çš„ç±»ã€‚</p><p>Fat jarçš„å¯åŠ¨Mainå‡½æ•°æ˜¯<code>JarLauncher</code>ï¼Œå®ƒè´Ÿè´£åˆ›å»ºä¸€ä¸ª<code>LaunchedURLClassLoader</code>æ¥åŠ è½½<code>BOOT-INF/classes</code>ç›®å½•ä»¥åŠ<code>/BOOT-INF/libä¸‹é¢çš„jar</code>ï¼Œå¹¶åˆ©ç”¨åå°„è·å–<code>mainClass</code>ç±»ä¸­çš„<code>main(Stirng[])</code>æ–¹æ³•å¹¶è°ƒç”¨ã€‚</p><p>å³ï¼šè¿è¡ŒJarLauncherå®é™…ä¸Šæ˜¯åœ¨åŒè¿›ç¨‹ã€åŒçº¿ç¨‹å†…è°ƒç”¨Start-Classç±»çš„main(Stirng[])æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨è°ƒç”¨å‰å‡†å¤‡å¥½ClassPathã€‚</p>              </div>            </details><hr><details class="folding-tag" green close><summary> è‡ªåŠ¨è£…é…åŸç† </summary>              <div class='content'>              <p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240320114427371.png" alt="image-20240320114427371"></p>              </div>            </details><hr><details class="folding-tag" blue close><summary> Tomcatå¹¶å‘é‡ </summary>              <div class='content'>              <p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20240320143615690.png" alt="image-20240320143615690"></p>              </div>            </details><h2 id="è®¾è®¡æ¨¡å¼"><a href="#è®¾è®¡æ¨¡å¼" class="headerlink" title="è®¾è®¡æ¨¡å¼"></a>è®¾è®¡æ¨¡å¼</h2><p>é€‚é…å™¨æ¨¡å¼</p><p>DisposableBeanAdapter</p><p>HeandlerAdapter</p><hr><p>äº«å…ƒæ¨¡å¼(æ± åŒ–)</p><p>hikariè¿æ¥æ± </p><p>åœ¨JDKä¸­ Booleanï¼ŒByteï¼ŒShortï¼ŒIntegerï¼ŒLongï¼ŒCharacter ç­‰åŒ…è£…ç±»æä¾›äº† valueOf æ–¹æ³•ï¼Œä¾‹å¦‚ Long çš„ valueOf ä¼šç¼“å­˜ -128~127 ä¹‹é—´çš„ Long å¯¹è±¡ï¼Œåœ¨è¿™ä¸ªèŒƒå›´ä¹‹é—´ä¼šé‡ç”¨å¯¹è±¡ï¼Œå¤§äºè¿™ä¸ªèŒƒå›´ï¼Œæ‰ä¼šæ–°å»º Long å¯¹è±¡</p><hr><p>è´£ä»»é“¾æ¨¡å¼</p>]]></content>
    
    
    <summary type="html">Springé¢è¯•é¢˜</summary>
    
    
    
    <category term="Spring" scheme="https://wuwawawa.github.io/categories/Spring/"/>
    
    
    <category term="é¢è¯•é¢˜" scheme="https://wuwawawa.github.io/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    
  </entry>
  
  <entry>
    <title>åŒºé—´æœ€å€¼é—®é¢˜ä¸STè¡¨</title>
    <link href="https://wuwawawa.github.io/posts/95223a9d.html"/>
    <id>https://wuwawawa.github.io/posts/95223a9d.html</id>
    <published>2023-10-17T05:22:19.000Z</published>
    <updated>2023-10-17T06:38:47.783Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬å…ˆä»ä¸€ä¸ªç®€å•çš„åŒºé—´é—®é¢˜åˆ‡å…¥</p><p>ç»™å®šä¸€ä¸ªé•¿åº¦ä¸º N çš„æ•°åˆ—ï¼Œå’Œ M æ¬¡è¯¢é—®ï¼Œæ±‚å‡ºæ¯ä¸€æ¬¡è¯¢é—®çš„åŒºé—´[L , R] å†…æ•°å­—çš„æœ€å¤§å€¼ã€‚</p><blockquote><p>ç¤ºä¾‹</p></blockquote><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ä¸‹æ ‡ï¼š0<span class="number"> 1 </span>2<span class="number"> 3 </span>4<span class="number"> 5 </span>6 7</span><br><span class="line">æ•°åˆ—ï¼š9<span class="number"> 3 </span>1<span class="number"> 7 </span>5<span class="number"> 6 </span>0 8</span><br><span class="line">è¯¢é—®ï¼š</span><br><span class="line">[0,5] -&gt; 9</span><br><span class="line">[4,5] -&gt; 6</span><br><span class="line">[3,5] -&gt; 7</span><br></pre></td></tr></table></figure><h2 id="æš´åŠ›è§£æ³•"><a href="#æš´åŠ›è§£æ³•" class="headerlink" title="æš´åŠ›è§£æ³•"></a>æš´åŠ›è§£æ³•</h2><div class="tabs" id="f67643ba-62fd-4f13-a803-a1c293ff0cdb"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#f67643ba-62fd-4f13-a803-a1c293ff0cdb-1"><i class="fas fa-atom"></i>æš´åŠ›è§£æ³•</button></li><li class="tab"><button type="button" data-href="#f67643ba-62fd-4f13-a803-a1c293ff0cdb-2"><i class="far fa-sun"></i>æš´åŠ›æ‰“è¡¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="f67643ba-62fd-4f13-a803-a1c293ff0cdb-1"><p> å¯¹äºæ¯æ¬¡è¯¢é—®ï¼Œéƒ½éå†ä¸€éåŒºé—´</p><p>O(NM)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">    <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> sc.nextInt(), M = sc.nextInt();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[] arr = <span class="keyword">new</span> <span class="title class_">int</span>[N];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        arr[i] = sc.nextInt();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (M-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">l</span> <span class="operator">=</span> sc.nextInt(), r = sc.nextInt();</span><br><span class="line">        <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> Integer.MIN_VALUE;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> l; i &lt;= r; i++) &#123;</span><br><span class="line">            ans = Math.max(ans, arr[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(ans);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f67643ba-62fd-4f13-a803-a1c293ff0cdb-2"><p>å®šä¹‰æ•°ç»„ <code>ans[i][j]</code>  è¡¨ç¤º[i , j]åŒºé—´çš„ç­”æ¡ˆ ä½¿ç”¨åŠ¨æ€è§„åˆ’çš„æ€æƒ³å¯¹æ•°ç»„è¿›è¡Œå¡«å……</p><p>ç©ºé—´å¤æ‚åº¦ O(n*n)</p><p>æ—¶é—´å¤æ‚åº¦ O(n*n + m)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">    <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> sc.nextInt(), M = sc.nextInt();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[] arr = <span class="keyword">new</span> <span class="title class_">int</span>[N];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        arr[i] = sc.nextInt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“è¡¨</span></span><br><span class="line">    <span class="type">int</span>[][] ans = <span class="keyword">new</span> <span class="title class_">int</span>[N][N];</span><br><span class="line">    <span class="comment">//base case</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) ans[i][i] = arr[i];</span><br><span class="line">    <span class="comment">// çŠ¶æ€è½¬ç§»</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i + <span class="number">1</span>; j &lt; N; j++) &#123;</span><br><span class="line">            ans[i][j] = Math.max(ans[i][j - <span class="number">1</span>], arr[j]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (M-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">l</span> <span class="operator">=</span> sc.nextInt(), r = sc.nextInt();</span><br><span class="line">        System.out.println(ans[l][r]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h2 id="ç¨€ç–è¡¨ä¼˜åŒ–"><a href="#ç¨€ç–è¡¨ä¼˜åŒ–" class="headerlink" title="ç¨€ç–è¡¨ä¼˜åŒ–"></a>ç¨€ç–è¡¨ä¼˜åŒ–</h2><p>åœ¨æš´åŠ›æ‰“è¡¨çš„è§£æ³•ä¸­ æˆ‘ä»¬æŠŠæ¯ä¸ªå°åŒºé—´éƒ½è¿›è¡Œäº†å­˜å‚¨ï¼Œå¤ªè¿‡äºç´§å‡‘ï¼Œä½¿å¾—å ç”¨çš„ç©ºé—´è¿‡å¤§</p><p>[0,1] [0,2] [0,3] [0,4] [0,5] [0,6] [0,7] </p><p>[1,2] [1,3] [1,4] [1,5] [1,6] [1,7]</p><p>[2,3] [2,4] [2,5] [2,6] [2,7]</p><p>â€¦â€¦</p><hr><p>STè¡¨åˆ™æ˜¯åŸºäºåŠ¨æ€è§„åˆ’ + å€å¢çš„æ€æƒ³ï¼š</p><p>å‡å¦‚æˆ‘ä»¬éœ€è¦æ±‚[0 , x]åŒºé—´çš„æœ€å¤§å€¼ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“[0 ,  x/2] å’Œ [x/2 + 1 , x]çš„æœ€å¤§å€¼ åå¤å‡åŠç›´è‡³åŒºé—´é•¿åº¦ä¸º1</p><p>å®šä¹‰ <code>dp[i][j]</code> è¡¨ç¤º ä» i å¼€å§‹ ï¼Œé•¿åº¦ä¸º 2^j çš„ åŒºé—´æœ€å¤§å€¼</p><p>base case </p><p><code>dp[i][0] = arr[i]</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">å¯¹äºæ¯æ¬¡è¯¢é—® [l , r] åŒºé—´æœ€å¤§å€¼ä¸º </span><br><span class="line">    <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> (<span class="type">int</span>) (Math.log(R - L + <span class="number">1</span>) / Math.log(<span class="number">2</span>));</span><br><span class="line">    <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> Math.max(dp[L][j], dp[R - (<span class="number">1</span> &lt;&lt; j) + <span class="number">1</span>][j]);</span><br><span class="line"></span><br><span class="line">å‡è®¾åŒºé—´ä¸º[<span class="number">1</span>,<span class="number">8</span>]</span><br><span class="line">  é‚£æˆ‘ä»¬å–çš„ä¸¤ä¸ªåŒºé—´æ˜¯[<span class="number">1</span>,<span class="number">8</span>] å’Œ [<span class="number">1</span>,<span class="number">8</span>]</span><br><span class="line">å‡è®¾åŒºé—´ä¸º[<span class="number">1</span>,<span class="number">9</span>]</span><br><span class="line">  é‚£æˆ‘ä»¬å–çš„ä¸¤ä¸ªåŒºé—´æ˜¯[<span class="number">1</span>,<span class="number">8</span>] å’Œ [<span class="number">2</span>,<span class="number">9</span>]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">    <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> sc.nextInt(), M = sc.nextInt();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[] arr = <span class="keyword">new</span> <span class="title class_">int</span>[N];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        arr[i] = sc.nextInt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> (<span class="type">int</span>) (Math.log(N) / Math.log(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[N][size + <span class="number">5</span>];</span><br><span class="line">    <span class="comment">//base case</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) dp[i][<span class="number">0</span>] = arr[i];</span><br><span class="line">    <span class="comment">// çŠ¶æ€è½¬ç§»</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= size; j++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i + (<span class="number">1</span> &lt;&lt; j) - <span class="number">1</span> &lt; N; i++) &#123;</span><br><span class="line">            dp[i][j] = Math.max(dp[i][j - <span class="number">1</span>], dp[i + (<span class="number">1</span> &lt;&lt; (j - <span class="number">1</span>))][j - <span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (M-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">L</span> <span class="operator">=</span> sc.nextInt(), R = sc.nextInt();</span><br><span class="line">        <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> (<span class="type">int</span>) (Math.log(R - L + <span class="number">1</span>) / Math.log(<span class="number">2</span>));</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> Math.max(dp[L][j], dp[R - (<span class="number">1</span> &lt;&lt; j) + <span class="number">1</span>][j]);</span><br><span class="line">        System.out.println(res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>STè¡¨ä¸ä»…ä»…å¯ä»¥ç”¨æ¥æ±‚max ï¼Œè¿˜å¯ä»¥ç”¨æ¥æ±‚ min gcd(æœ€å¤§å…¬çº¦æ•°) lcm(æœ€å°å…¬å€æ•°)</p><p>ST è¡¨æ˜¯ä¸€ä¸ªé™æ€è¡¨ï¼Œåªèƒ½å¤„ç†ä¸€äº›ç¦»çº¿é—®é¢˜ï¼Œè€Œä¸èƒ½å¤„ç†åœ¨çº¿é—®é¢˜ã€‚</p>]]></content>
    
    
    <summary type="html">sparse table ç¨€ç–è¡¨</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>ç®—æ³•æ¨¡ç‰ˆ</title>
    <link href="https://wuwawawa.github.io/posts/bb13e2f5.html"/>
    <id>https://wuwawawa.github.io/posts/bb13e2f5.html</id>
    <published>2023-10-04T03:38:05.000Z</published>
    <updated>2024-04-07T02:58:07.768Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ»‘åŠ¨çª—å£"><a href="#æ»‘åŠ¨çª—å£" class="headerlink" title="æ»‘åŠ¨çª—å£"></a>æ»‘åŠ¨çª—å£</h2><h3 id="ç»å…¸æ¨¡ç‰ˆé¢˜"><a href="#ç»å…¸æ¨¡ç‰ˆé¢˜" class="headerlink" title="ç»å…¸æ¨¡ç‰ˆé¢˜"></a>ç»å…¸æ¨¡ç‰ˆé¢˜</h3><p>å…³é”®è¯ï¼š æ»¡è¶³xxxæ¡ä»¶ï¼ˆè®¡ç®—ç»“æœ(åŠ å‡ä¹˜é™¤)ã€å‡ºç°æ¬¡æ•°(cntæ•°ç»„å‡†å¤‡)ã€åŒæ—¶åŒ…å«ï¼‰é•¿åº¦æœ€é•¿/æœ€çŸ­å­ä¸²/å­æ•°ç»„</p><p>æ³¨æ„ç‚¹<br>1.if/whileä½¿ç”¨æ¡ä»¶åˆ¤æ–­<br>2.right-left+1çš„é‡è¦æ€§</p><div class="tabs" id="df3b0974-b073-4def-8595-8222f2f2897c"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#df3b0974-b073-4def-8595-8222f2f2897c-1"><i class="fas fa-seedling"></i>209</button></li><li class="tab"><button type="button" data-href="#df3b0974-b073-4def-8595-8222f2f2897c-2"><i class="fas fa-leaf"></i>713</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="df3b0974-b073-4def-8595-8222f2f2897c-1"><p><a href="https://leetcode.cn/problems/minimum-size-subarray-sum/">é•¿åº¦æœ€å°çš„å­æ•°ç»„</a></p><p>ç»™å®šä¸€ä¸ªå«æœ‰ <code>n</code> ä¸ªæ­£æ•´æ•°çš„æ•°ç»„å’Œä¸€ä¸ªæ­£æ•´æ•° <code>target</code> ã€‚</p><p>æ‰¾å‡ºè¯¥æ•°ç»„ä¸­æ»¡è¶³å…¶æ€»å’Œå¤§äºç­‰äº <code>target</code> çš„é•¿åº¦æœ€å°çš„ <strong>è¿ç»­å­æ•°ç»„</strong> <code>[numsl, numsl+1, ..., numsr-1, numsr]</code> ï¼Œå¹¶è¿”å›å…¶é•¿åº¦ã€‚å¦‚æœä¸å­˜åœ¨ç¬¦åˆæ¡ä»¶çš„å­æ•°ç»„ï¼Œè¿”å› <code>0</code> ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">minSubArrayLen</span><span class="params">(<span class="type">int</span> target, <span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> Integer.MAX_VALUE;</span><br><span class="line">    <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">l</span> <span class="operator">=</span> <span class="number">0</span> , r = <span class="number">0</span> , len = nums.length;</span><br><span class="line">    <span class="keyword">while</span>(r &lt; len)&#123;</span><br><span class="line">        sum += nums[r];    </span><br><span class="line">        <span class="keyword">while</span>(sum &gt;= target)&#123;</span><br><span class="line">            res = Math.min(res , r - l + <span class="number">1</span>);</span><br><span class="line">            sum -= nums[l];</span><br><span class="line">            l++;</span><br><span class="line">        &#125;</span><br><span class="line">        r++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res == Integer.MAX_VALUE ? <span class="number">0</span> : res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="df3b0974-b073-4def-8595-8222f2f2897c-2"><p><a href="https://leetcode.cn/problems/subarray-product-less-than-k/">ä¹˜ç§¯å°äº K çš„å­æ•°ç»„</a></p><p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ <code>nums</code> å’Œä¸€ä¸ªæ•´æ•° <code>k</code> ï¼Œè¯·ä½ è¿”å›å­æ•°ç»„å†…æ‰€æœ‰å…ƒç´ çš„ä¹˜ç§¯ä¸¥æ ¼å°äº <code>k</code> çš„è¿ç»­å­æ•°ç»„çš„æ•°ç›®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">numSubarrayProductLessThanK</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">product</span> <span class="operator">=</span> <span class="number">1</span> , len = nums.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">l</span> <span class="operator">=</span> <span class="number">0</span> , r = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(r &lt; len)&#123;</span><br><span class="line">        product *= nums[r];</span><br><span class="line">        r++;</span><br><span class="line">        <span class="keyword">while</span>(product &gt;= k &amp;&amp; l &lt; r)&#123;</span><br><span class="line">            product /= nums[l++];</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// ä»¥nums[r] ç»“å°¾å­æ•°ç»„ä¸ªæ•°</span></span><br><span class="line">        res += r - l;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="ä¸¤ç«¯æ»‘åŠ¨çª—å£å¥—è·¯æ¨¡æ¿é¢˜"><a href="#ä¸¤ç«¯æ»‘åŠ¨çª—å£å¥—è·¯æ¨¡æ¿é¢˜" class="headerlink" title="ä¸¤ç«¯æ»‘åŠ¨çª—å£å¥—è·¯æ¨¡æ¿é¢˜"></a>ä¸¤ç«¯æ»‘åŠ¨çª—å£å¥—è·¯æ¨¡æ¿é¢˜</h3><p>æ­£éš¾åˆ™åï¼Œä»ä¸¤è¾¹æ‹¿éš¾æ€è€ƒï¼Œæœ€å¤§åŒ–æ‹¿å¤–é¢ç­‰ä»·è½¬æ¢ä¸ºæœ€å°åŒ–æ‹¿é‡Œé¢<br>ç”±æ­¤å˜ä¸ºæ¨¡æ¿é¢˜ï¼šä»ä¸¤ç«¯å–æ•°å­—ç­‰ç­‰ï¼Œè¿ç»­å­æ•°ç»„ï¼Œå­—ä¸²ï¼Œå¯ä»¥æƒ³åˆ°æ»‘åŠ¨çª—å£è§£å†³</p><div class="tabs" id="174d806e-4979-4493-a287-fb02300675f0"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#174d806e-4979-4493-a287-fb02300675f0-1"><i class="fas fa-seedling"></i>2516</button></li><li class="tab"><button type="button" data-href="#174d806e-4979-4493-a287-fb02300675f0-2"><i class="fas fa-leaf"></i>1423</button></li><li class="tab"><button type="button" data-href="#174d806e-4979-4493-a287-fb02300675f0-3"><i class="fab fa-apple"></i>1658</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="174d806e-4979-4493-a287-fb02300675f0-1"><p><a href="https://leetcode.cn/problems/take-k-of-each-character-from-left-and-right/"> æ¯ç§å­—ç¬¦è‡³å°‘å– K ä¸ª</a></p><p>ç»™ä½ ä¸€ä¸ªç”±å­—ç¬¦ <code>&#39;a&#39;</code>ã€<code>&#39;b&#39;</code>ã€<code>&#39;c&#39;</code> ç»„æˆçš„å­—ç¬¦ä¸² <code>s</code> å’Œä¸€ä¸ªéè´Ÿæ•´æ•° <code>k</code> ã€‚æ¯åˆ†é’Ÿï¼Œä½ å¯ä»¥é€‰æ‹©å–èµ° <code>s</code> <strong>æœ€å·¦ä¾§</strong> è¿˜æ˜¯ <strong>æœ€å³ä¾§</strong> çš„é‚£ä¸ªå­—ç¬¦ã€‚</p><p>ä½ å¿…é¡»å–èµ°æ¯ç§å­—ç¬¦ <strong>è‡³å°‘</strong> <code>k</code> ä¸ªï¼Œè¿”å›éœ€è¦çš„ <strong>æœ€å°‘</strong> åˆ†é’Ÿæ•°ï¼›å¦‚æœæ— æ³•å–åˆ°ï¼Œåˆ™è¿”å› <code>-1</code> ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">takeCharacters</span><span class="params">(String s, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">    <span class="type">char</span>[] cs = s.toCharArray();</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> cs.length;</span><br><span class="line">    <span class="comment">// ç»Ÿè®¡è¯é¢‘</span></span><br><span class="line">    HashMap&lt;Character, Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&#x27;a&#x27;</span>,-k);</span><br><span class="line">    map.put(<span class="string">&#x27;b&#x27;</span>,-k);</span><br><span class="line">    map.put(<span class="string">&#x27;c&#x27;</span>,-k);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">char</span> c : cs) &#123;</span><br><span class="line">       map.merge(c,<span class="number">1</span>,Integer::sum);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (Integer value : map.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// çª—å£</span></span><br><span class="line">    HashMap&lt;Character, Integer&gt; window = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="type">int</span> <span class="variable">l</span> <span class="operator">=</span> <span class="number">0</span>, r = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (r &lt; len) &#123;</span><br><span class="line">        <span class="type">char</span> <span class="variable">rc</span> <span class="operator">=</span> cs[r];</span><br><span class="line">        window.merge(rc, <span class="number">1</span>, Integer::sum);</span><br><span class="line">        <span class="keyword">while</span> (window.get(rc) &gt; map.get(rc) &amp;&amp; l &lt;= r) &#123;</span><br><span class="line">            <span class="type">char</span> <span class="variable">lc</span> <span class="operator">=</span> cs[l];</span><br><span class="line">            window.merge(lc, -<span class="number">1</span>, Integer::sum);</span><br><span class="line">            l++;</span><br><span class="line">        &#125;</span><br><span class="line">        ans = Math.max(ans, r - l + <span class="number">1</span>);</span><br><span class="line">        r++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> len - ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="174d806e-4979-4493-a287-fb02300675f0-2"><p><a href="https://leetcode.cn/problems/maximum-points-you-can-obtain-from-cards/">å¯è·å¾—çš„æœ€å¤§ç‚¹æ•°</a></p><p>å‡ å¼ å¡ç‰Œ <strong>æ’æˆä¸€è¡Œ</strong>ï¼Œæ¯å¼ å¡ç‰Œéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ç‚¹æ•°ã€‚ç‚¹æ•°ç”±æ•´æ•°æ•°ç»„ <code>cardPoints</code> ç»™å‡ºã€‚</p><p>æ¯æ¬¡è¡ŒåŠ¨ï¼Œä½ å¯ä»¥ä»è¡Œçš„å¼€å¤´æˆ–è€…æœ«å°¾æ‹¿ä¸€å¼ å¡ç‰Œï¼Œæœ€ç»ˆä½ å¿…é¡»æ­£å¥½æ‹¿ <code>k</code> å¼ å¡ç‰Œã€‚</p><p>ä½ çš„ç‚¹æ•°å°±æ˜¯ä½ æ‹¿åˆ°æ‰‹ä¸­çš„æ‰€æœ‰å¡ç‰Œçš„ç‚¹æ•°ä¹‹å’Œã€‚</p><p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ <code>cardPoints</code> å’Œæ•´æ•° <code>k</code>ï¼Œè¯·ä½ è¿”å›å¯ä»¥è·å¾—çš„æœ€å¤§ç‚¹æ•°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">maxScore</span><span class="params">(<span class="type">int</span>[] cardPoints, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> cardPoints.length;</span><br><span class="line">    k = len - k;</span><br><span class="line">    <span class="comment">// è®¡ç®—sum</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> Arrays.stream(cardPoints).sum();</span><br><span class="line">    <span class="keyword">if</span> (k == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">l</span> <span class="operator">=</span> <span class="number">0</span>, r = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> Integer.MAX_VALUE;</span><br><span class="line">    <span class="type">int</span> <span class="variable">total</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (r &lt; len) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">rx</span> <span class="operator">=</span> cardPoints[r];</span><br><span class="line">        total += rx;</span><br><span class="line">        <span class="keyword">if</span> (r - l + <span class="number">1</span> == k + <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">lx</span> <span class="operator">=</span> cardPoints[l];</span><br><span class="line">            total -= lx;</span><br><span class="line">            l++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r - l + <span class="number">1</span> == k) &#123;</span><br><span class="line">            ans = Math.min(ans, total);</span><br><span class="line">        &#125;</span><br><span class="line">        r++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum - ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="174d806e-4979-4493-a287-fb02300675f0-3"><p><a href="https://leetcode.cn/problems/minimum-operations-to-reduce-x-to-zero/">å°† x å‡åˆ° 0 çš„æœ€å°æ“ä½œæ•°</a></p><p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ <code>nums</code> å’Œä¸€ä¸ªæ•´æ•° <code>x</code> ã€‚æ¯ä¸€æ¬¡æ“ä½œæ—¶ï¼Œä½ åº”å½“ç§»é™¤æ•°ç»„ <code>nums</code> æœ€å·¦è¾¹æˆ–æœ€å³è¾¹çš„å…ƒç´ ï¼Œç„¶åä» <code>x</code> ä¸­å‡å»è¯¥å…ƒç´ çš„å€¼ã€‚è¯·æ³¨æ„ï¼Œéœ€è¦ <strong>ä¿®æ”¹</strong> æ•°ç»„ä»¥ä¾›æ¥ä¸‹æ¥çš„æ“ä½œä½¿ç”¨ã€‚</p><p>å¦‚æœå¯ä»¥å°† <code>x</code> <strong>æ°å¥½</strong> å‡åˆ° <code>0</code> ï¼Œè¿”å› <strong>æœ€å°æ“ä½œæ•°</strong> ï¼›å¦åˆ™ï¼Œè¿”å› <code>-1</code> ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">minOperations</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> x)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> Arrays.stream(nums).sum();</span><br><span class="line">    <span class="type">int</span> <span class="variable">target</span> <span class="operator">=</span> sum - x;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> nums.length;</span><br><span class="line">    <span class="keyword">if</span> (x == sum) &#123;</span><br><span class="line">        <span class="keyword">return</span> len;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åœ¨çª—å£å†…æ‰¾åˆ°æœ€é•¿å­æ•°ç»„ å…¶å’Œç­‰äºtarget</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">l</span> <span class="operator">=</span> <span class="number">0</span>, r = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (r &lt; len) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">rx</span> <span class="operator">=</span> nums[r];</span><br><span class="line">        s += rx;</span><br><span class="line">        <span class="keyword">while</span> (s &gt; target &amp;&amp; l &lt;= r) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">lx</span> <span class="operator">=</span> nums[l];</span><br><span class="line">            s -= lx;</span><br><span class="line">            l++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (s == target) &#123;</span><br><span class="line">            res = Math.max(res, r - l + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        r++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res == -<span class="number">1</span> ? -<span class="number">1</span> : len - res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="ä¸¤ä¸ªleftè®¡ç®—åŒºé—´ä¸ªæ•°"><a href="#ä¸¤ä¸ªleftè®¡ç®—åŒºé—´ä¸ªæ•°" class="headerlink" title="ä¸¤ä¸ªleftè®¡ç®—åŒºé—´ä¸ªæ•°"></a>ä¸¤ä¸ªleftè®¡ç®—åŒºé—´ä¸ªæ•°</h3><p>æ»‘åŠ¨çª—å£åŒºé—´ä¸ªæ•°è®¡ç®—æ¨¡æ¿é¢˜ï¼ˆä¸¤ä¸ªleftè®¡ç®—åŒºé—´ä¸ªæ•°ï¼‰</p><p>ä¸»è¦è§£å†³çš„é—®é¢˜æ˜¯åˆ©ç”¨æ»‘åŠ¨çª—å£çš„ä¸¤ä¸ªleftè®¡ç®—åŒºé—´ä¸ªæ•°çš„æ¨¡æ¿è§£å†³ç›¸å…³å¥—è·¯é¢˜ã€‚</p><p>é¢˜ç›®ä¸­å¾€å¾€åŒ…å«<span class='p green'>æ°å¥½å­—çœ¼</span></p><blockquote><p>æŠŠã€Œæ°å¥½ã€ è½¬æ¢æˆä¸º ã€Œæœ€å¤šã€ã€‚</p><p>ä¾‹å¦‚æ±‚æ°å¥½kä¸ªï¼Œå°±ç”¨æœ€å¤škä¸ª - æœ€å¤šk-1ä¸ª = æ°å¥½kä¸ª</p></blockquote><div class="tabs" id="8c93d26e-1b54-4ffd-9dce-d4803af8693d"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#8c93d26e-1b54-4ffd-9dce-d4803af8693d-1"><i class="fas fa-seedling"></i>LC930</button></li><li class="tab"><button type="button" data-href="#8c93d26e-1b54-4ffd-9dce-d4803af8693d-2"><i class="fas fa-leaf"></i>LC1248</button></li><li class="tab"><button type="button" data-href="#8c93d26e-1b54-4ffd-9dce-d4803af8693d-3"><i class="fab fa-apple"></i>LC992</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="8c93d26e-1b54-4ffd-9dce-d4803af8693d-1"><p><a href="https://leetcode.cn/problems/binary-subarrays-with-sum/">å’Œç›¸åŒçš„äºŒå…ƒå­æ•°ç»„</a></p><p>ç»™ä½ ä¸€ä¸ªäºŒå…ƒæ•°ç»„ <code>nums</code> ï¼Œ<code>nums[i]</code> ä¸æ˜¯ <code>0</code> å°±æ˜¯ <code>1</code>ï¼Œå’Œä¸€ä¸ªæ•´æ•° <code>goal</code> ï¼Œè¯·ä½ ç»Ÿè®¡å¹¶è¿”å›æœ‰å¤šå°‘ä¸ªå’Œä¸º <code>goal</code> çš„ <strong>éç©º</strong> å­æ•°ç»„ã€‚</p><p><strong>å­æ•°ç»„</strong> æ˜¯æ•°ç»„çš„ä¸€æ®µè¿ç»­éƒ¨åˆ†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">numSubarraysWithSum</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> goal)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cal(nums, goal) - cal(nums, goal - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">cal</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> <span class="number">0</span>; right &lt; nums.length; right++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> nums[right];</span><br><span class="line">        s += x;</span><br><span class="line">        <span class="keyword">while</span> (s &gt; k &amp;&amp; left &lt;= right) &#123;</span><br><span class="line">            s -= nums[left];</span><br><span class="line">            left += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ans += right - left + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8c93d26e-1b54-4ffd-9dce-d4803af8693d-2"><p><a href="https://leetcode.cn/problems/count-number-of-nice-subarrays/">ç»Ÿè®¡ä¼˜ç¾å­æ•°ç»„</a></p><p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ <code>nums</code> å’Œä¸€ä¸ªæ•´æ•° <code>k</code>ã€‚å¦‚æœæŸä¸ªè¿ç»­å­æ•°ç»„ä¸­æ°å¥½æœ‰ <code>k</code> ä¸ªå¥‡æ•°æ•°å­—ï¼Œæˆ‘ä»¬å°±è®¤ä¸ºè¿™ä¸ªå­æ•°ç»„æ˜¯ã€Œ<strong>ä¼˜ç¾å­æ•°ç»„</strong>ã€ã€‚</p><p>è¯·è¿”å›è¿™ä¸ªæ•°ç»„ä¸­ <strong>ã€Œä¼˜ç¾å­æ•°ç»„ã€</strong> çš„æ•°ç›®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">numberOfSubarrays</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cal(nums, k) - cal(nums, k - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">cal</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> nums.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">countOdd</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> <span class="number">0</span>; right &lt; len; right++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> nums[right];</span><br><span class="line">        countOdd += ((x &amp; <span class="number">1</span>) == <span class="number">1</span>) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (countOdd &gt; k &amp;&amp; left &lt;= right) &#123;</span><br><span class="line">            countOdd -= ((nums[left] &amp; <span class="number">1</span>) == <span class="number">1</span>) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">            left++;</span><br><span class="line">        &#125;</span><br><span class="line">        ans += right - left + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="8c93d26e-1b54-4ffd-9dce-d4803af8693d-3"><p><a href="https://leetcode.cn/problems/subarrays-with-k-different-integers/"> K ä¸ªä¸åŒæ•´æ•°çš„å­æ•°ç»„</a></p><p>ç»™å®šä¸€ä¸ªæ­£æ•´æ•°æ•°ç»„ <code>nums</code>å’Œä¸€ä¸ªæ•´æ•° <code>k</code>ï¼Œè¿”å› <code>nums</code> ä¸­ ã€Œ<strong>å¥½å­æ•°ç»„ã€</strong> çš„æ•°ç›®ã€‚</p><p>å¦‚æœ <code>nums</code> çš„æŸä¸ªå­æ•°ç»„ä¸­ä¸åŒæ•´æ•°çš„ä¸ªæ•°æ°å¥½ä¸º <code>k</code>ï¼Œåˆ™ç§° <code>nums</code> çš„è¿™ä¸ªè¿ç»­ã€ä¸ä¸€å®šä¸åŒçš„å­æ•°ç»„ä¸º <strong>ã€Œå¥½å­æ•°ç»„ ã€</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">subarraysWithKDistinct</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cal(nums, k) - cal(nums, k - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">cal</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> nums.length;</span><br><span class="line">    HashMap&lt;Integer, Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> <span class="number">0</span>; right &lt; len; right++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">rx</span> <span class="operator">=</span> nums[right];</span><br><span class="line">        map.merge(rx, <span class="number">1</span>, Integer::sum);</span><br><span class="line">        <span class="keyword">while</span> (map.size() &gt; k &amp;&amp; left &lt;= right) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">lx</span> <span class="operator">=</span> nums[left];</span><br><span class="line">            map.merge(lx, -<span class="number">1</span>, Integer::sum);</span><br><span class="line">            <span class="keyword">if</span> (map.get(lx) == <span class="number">0</span>) &#123;</span><br><span class="line">                map.remove(lx);</span><br><span class="line">            &#125;</span><br><span class="line">            left++;</span><br><span class="line">        &#125;</span><br><span class="line">        ans += right - left + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h2 id="åˆ†ç»„å¾ªç¯"><a href="#åˆ†ç»„å¾ªç¯" class="headerlink" title="åˆ†ç»„å¾ªç¯"></a>åˆ†ç»„å¾ªç¯</h2><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šæŒ‰ç…§é¢˜ç›®è¦æ±‚ï¼Œæ•°ç»„ä¼šè¢«åˆ†å‰²æˆè‹¥å¹²ç»„ï¼Œä¸”æ¯ä¸€ç»„çš„åˆ¤æ–­/å¤„ç†é€»è¾‘æ˜¯ä¸€æ ·çš„ã€‚</p><p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼š</p><ul><li>å¤–å±‚å¾ªç¯è´Ÿè´£éå†ç»„ä¹‹å‰çš„å‡†å¤‡å·¥ä½œï¼ˆè®°å½•å¼€å§‹ä½ç½®ï¼‰ï¼Œå’Œéå†ç»„ä¹‹åçš„ç»Ÿè®¡å·¥ä½œï¼ˆæ›´æ–°ç­”æ¡ˆæœ€å¤§å€¼ï¼‰ã€‚</li><li>å†…å±‚å¾ªç¯è´Ÿè´£éå†ç»„ï¼Œæ‰¾å‡ºè¿™ä¸€ç»„åœ¨å“ªç»“æŸã€‚</li></ul><p>ä¸€èˆ¬æ¥è¯´ï¼Œåˆ†ç»„å¾ªç¯çš„æ¨¡æ¿å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">n = <span class="built_in">len</span>(nums)</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> i &lt; n:</span><br><span class="line">    start = i</span><br><span class="line">    <span class="keyword">while</span> i &lt; n <span class="keyword">and</span> ...:</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="comment"># ä» start åˆ° i-1 æ˜¯ä¸€ç»„</span></span><br><span class="line">    <span class="comment"># ä¸‹ä¸€ç»„ä» i å¼€å§‹ï¼Œæ— éœ€ i += 1</span></span><br></pre></td></tr></table></figure><p><a href="https://leetcode.cn/problems/longest-even-odd-subarray-with-threshold/">æœ€é•¿å¥‡å¶å­æ•°ç»„</a></p><p><a href="https://leetcode.cn/problems/consecutive-characters/">è¿ç»­å­—ç¬¦</a></p><p><a href="https://leetcode.cn/problems/longer-contiguous-segments-of-ones-than-zeros/">å“ªç§è¿ç»­å­å­—ç¬¦ä¸²æ›´é•¿</a></p><p><a href="https://leetcode.cn/problems/minimum-time-to-make-rope-colorful/">ä½¿ç»³å­å˜æˆå½©è‰²çš„æœ€çŸ­æ—¶é—´</a></p><p><a href="https://leetcode.cn/problems/longest-substring-of-all-vowels-in-order/">æ‰€æœ‰å…ƒéŸ³æŒ‰é¡ºåºæ’å¸ƒçš„æœ€é•¿å­å­—ç¬¦ä¸²</a></p><h2 id="åŒå‘BFS"><a href="#åŒå‘BFS" class="headerlink" title="åŒå‘BFS"></a>åŒå‘BFS</h2><p>ã€ŒåŒå‘ BFSã€çš„åŸºæœ¬å®ç°æ€è·¯å¦‚ä¸‹ï¼š</p><p>åˆ›å»ºã€Œä¸¤ä¸ªé˜Ÿåˆ—ã€åˆ†åˆ«ç”¨äºä¸¤ä¸ªæ–¹å‘çš„æœç´¢ï¼›<br>åˆ›å»ºã€Œä¸¤ä¸ªå“ˆå¸Œè¡¨ã€ç”¨äºã€Œè§£å†³ç›¸åŒèŠ‚ç‚¹é‡å¤æœç´¢ã€å’Œã€Œè®°å½•è½¬æ¢æ¬¡æ•°ã€ï¼›<br>ä¸ºäº†å°½å¯èƒ½è®©ä¸¤ä¸ªæœç´¢æ–¹å‘â€œå¹³å‡â€ï¼Œæ¯æ¬¡ä»é˜Ÿåˆ—ä¸­å–å€¼è¿›è¡Œæ‰©å±•æ—¶ï¼Œå…ˆåˆ¤æ–­å“ªä¸ªé˜Ÿåˆ—å®¹é‡è¾ƒå°‘ï¼›<br>å¦‚æœåœ¨æœç´¢è¿‡ç¨‹ä¸­ã€Œæœç´¢åˆ°å¯¹æ–¹æœç´¢è¿‡çš„èŠ‚ç‚¹ã€ï¼Œè¯´æ˜æ‰¾åˆ°äº†æœ€çŸ­è·¯å¾„ã€‚<br>ã€ŒåŒå‘ BFSã€åŸºæœ¬æ€è·¯å¯¹åº”çš„ä¼ªä»£ç å¤§è‡´å¦‚ä¸‹ï¼š</p><div class="tabs" id="019b1ae0-3bce-4c44-8e19-84a975519e1b"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#019b1ae0-3bce-4c44-8e19-84a975519e1b-1"><i class="fas fa-seedling"></i>ä¼ªä»£ç </button></li><li class="tab"><button type="button" data-href="#019b1ae0-3bce-4c44-8e19-84a975519e1b-2"><i class="fas fa-leaf"></i>ç¤ºä¾‹ä»£ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="019b1ae0-3bce-4c44-8e19-84a975519e1b-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">d1ã€d2 ä¸ºä¸¤ä¸ªæ–¹å‘çš„é˜Ÿåˆ—</span><br><span class="line">m1ã€m2 ä¸ºä¸¤ä¸ªæ–¹å‘çš„å“ˆå¸Œè¡¨ï¼Œè®°å½•æ¯ä¸ªèŠ‚ç‚¹è·ç¦»èµ·ç‚¹çš„</span><br><span class="line">    </span><br><span class="line"><span class="comment">// åªæœ‰ä¸¤ä¸ªé˜Ÿåˆ—éƒ½ä¸ç©ºï¼Œæ‰æœ‰å¿…è¦ç»§ç»­å¾€ä¸‹æœç´¢</span></span><br><span class="line"><span class="comment">// å¦‚æœå…¶ä¸­ä¸€ä¸ªé˜Ÿåˆ—ç©ºäº†ï¼Œè¯´æ˜ä»æŸä¸ªæ–¹å‘æœåˆ°åº•éƒ½æœä¸åˆ°è¯¥æ–¹å‘çš„ç›®æ ‡èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">while</span>(!d1.isEmpty() &amp;&amp; !d2.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (d1.size() &lt; d2.size()) &#123;</span><br><span class="line">        update(d1, m1, m2);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        update(d2, m2, m1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// update ä¸ºå°†å½“å‰é˜Ÿåˆ— d ä¸­åŒ…å«çš„å…ƒç´ å–å‡ºï¼Œè¿›è¡Œã€Œä¸€æ¬¡å®Œæ•´æ‰©å±•ã€çš„é€»è¾‘ï¼ˆæŒ‰å±‚æ‹“å±•ï¼‰</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Deque d, Map cur, Map other)</span> &#123;&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="019b1ae0-3bce-4c44-8e19-84a975519e1b-2"><p><a href="https://leetcode.cn/problems/minimum-operations-to-convert-number/">è½¬åŒ–æ•°å­—çš„æœ€å°è¿ç®—æ•°</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] nums;</span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">minimumOperations</span><span class="params">(<span class="type">int</span>[] _nums, <span class="type">int</span> s, <span class="type">int</span> t)</span> &#123;</span><br><span class="line">    nums = _nums;</span><br><span class="line">    Deque&lt;Long&gt; d1 = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;&gt;(), d2 = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;&gt;();</span><br><span class="line">    Map&lt;Long, Integer&gt; m1 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(), m2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    d1.addLast(s * <span class="number">1L</span>);</span><br><span class="line">    d2.addLast(t * <span class="number">1L</span>);</span><br><span class="line">    m1.put(s * <span class="number">1L</span>, <span class="number">0</span>);</span><br><span class="line">    m2.put(t * <span class="number">1L</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">while</span> (!d1.isEmpty() &amp;&amp; !d2.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (d1.size() &lt; d2.size()) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> update(d1, m1, d2, m2, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (ans != -<span class="number">1</span>) <span class="keyword">return</span> ans;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> update(d2, m2, d1, m1, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (ans != -<span class="number">1</span>) <span class="keyword">return</span> ans;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">update</span><span class="params">(Deque&lt;Long&gt; d1, Map&lt;Long, Integer&gt; m1, Deque&lt;Long&gt; d2, Map&lt;Long, Integer&gt; m2, <span class="type">boolean</span> flag)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> d1.size();</span><br><span class="line">    <span class="keyword">while</span> (m-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">cur</span> <span class="operator">=</span> d1.pollFirst();</span><br><span class="line">        <span class="type">int</span> <span class="variable">step</span> <span class="operator">=</span> m1.get(cur);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i : nums) &#123;</span><br><span class="line">            <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">                <span class="comment">// æ­£å‘æœç´¢ï¼šè¿›è¡Œå‡ºé˜Ÿæ£€æŸ¥ï¼Œåªæœ‰å‡ºé˜Ÿå…ƒç´ ç¬¦åˆæ¡ä»¶ï¼Œæ‰èƒ½ä½¿ç”¨å‡ºé˜Ÿå…ƒç´ å¾€ä¸‹æ‹“å±•</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="number">0</span> &lt;= cur &amp;&amp; cur &lt;= <span class="number">1000</span>) &#123;</span><br><span class="line">                    <span class="type">long</span>[] result = <span class="keyword">new</span> <span class="title class_">long</span>[]&#123;cur + i, cur - i, cur ^ i&#125;;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">long</span> next : result) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (m2.containsKey(next)) <span class="keyword">return</span> step + <span class="number">1</span> + m2.get(next);</span><br><span class="line">                        <span class="keyword">if</span> (!m1.containsKey(next)) &#123;</span><br><span class="line">                            d1.addLast(next);</span><br><span class="line">                            m1.put(next, step + <span class="number">1</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// åå‘æœç´¢ï¼šè¿›è¡Œå…¥é˜Ÿæ£€æŸ¥ï¼Œåªæœ‰æ‹“å±•å…ƒç´ ç¬¦åˆæ¡ä»¶ï¼Œæ‰èƒ½å°†æ‹“å±•å…ƒç´ å…¥é˜Ÿ</span></span><br><span class="line">                <span class="type">long</span>[] result = <span class="keyword">new</span> <span class="title class_">long</span>[]&#123;cur + i, cur - i, cur ^ i&#125;;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">long</span> next : result) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="number">0</span> &lt;= next &amp;&amp; next &lt;= <span class="number">1000</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (m2.containsKey(next)) <span class="keyword">return</span> step + <span class="number">1</span> + m2.get(next);</span><br><span class="line">                        <span class="keyword">if</span> (!m1.containsKey(next)) &#123;</span><br><span class="line">                            d1.addLast(next);</span><br><span class="line">                            m1.put(next, step + <span class="number">1</span>);</span><br><span class="line">                        &#125;   </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h2 id="æ ‘å½¢DP"><a href="#æ ‘å½¢DP" class="headerlink" title="æ ‘å½¢DP"></a>æ ‘å½¢DP</h2><h2 id="æ¢æ ¹DP"><a href="#æ¢æ ¹DP" class="headerlink" title="æ¢æ ¹DP"></a>æ¢æ ¹DP</h2><hr><h2 id="æ•°ä½DP"><a href="#æ•°ä½DP" class="headerlink" title="æ•°ä½DP"></a>æ•°ä½DP</h2><p>å°† n è½¬æ¢æˆå­—ç¬¦ä¸² sï¼Œå®šä¹‰ <code>f(i,mask,isLimit,hasNum)</code> è¡¨ç¤ºæ„é€ ç¬¬ i ä½åŠå…¶ä¹‹åæ•°ä½çš„åˆæ³•æ–¹æ¡ˆæ•°ï¼Œå…¶å‚æ•°çš„å«ä¹‰ä¸º:</p><ul><li>mask è¡¨ç¤ºå‰é¢é€‰è¿‡çš„æ•°å­—é›†åˆï¼Œæ¢å¥è¯è¯´ï¼Œç¬¬ i ä½è¦é€‰çš„æ•°å­—ä¸èƒ½åœ¨ mask ä¸­ã€‚</li><li>isLimit è¡¨ç¤ºå½“å‰æ˜¯å¦å—åˆ°äº† n çš„çº¦æŸï¼ˆæ³¨æ„è¦æ„é€ çš„æ•°å­—ä¸èƒ½è¶…è¿‡ nï¼‰ã€‚è‹¥ä¸ºçœŸï¼Œåˆ™ç¬¬ i ä½å¡«å…¥çš„æ•°å­—è‡³å¤šä¸º s[i]ï¼Œå¦åˆ™å¯ä»¥æ˜¯ 9ã€‚å¦‚æœåœ¨å—åˆ°çº¦æŸçš„æƒ…å†µä¸‹å¡«äº† s[i]ï¼Œé‚£ä¹ˆåç»­å¡«å…¥çš„æ•°å­—ä»ä¼šå—åˆ° n çš„çº¦æŸã€‚ä¾‹å¦‚ n=123ï¼Œé‚£ä¹ˆ i=0 å¡«çš„æ˜¯ 1 çš„è¯ï¼Œi=1 çš„è¿™ä¸€ä½è‡³å¤šå¡« 2ã€‚</li><li>hasNum è¡¨ç¤º i å‰é¢çš„æ•°ä½æ˜¯å¦å¡«äº†æ•°å­—ã€‚è‹¥ä¸ºå‡ï¼Œåˆ™å½“å‰ä½å¯ä»¥è·³è¿‡ï¼ˆä¸å¡«æ•°å­—ï¼‰ï¼Œæˆ–è€…è¦å¡«å…¥çš„æ•°å­—è‡³å°‘ä¸º 1ï¼›è‹¥ä¸ºçœŸï¼Œåˆ™è¦å¡«å…¥çš„æ•°å­—å¯ä»¥ä» 0 å¼€å§‹ã€‚ä¾‹å¦‚ n=1233ï¼Œåœ¨ i=0 æ—¶è·³è¿‡çš„è¯ï¼Œç›¸å½“äºåé¢è¦æ„é€ çš„æ˜¯ä¸€ä¸ª 9 ä»¥å†…çš„æ•°å­—äº†ï¼Œå¦‚æœ i=1 ä¸è·³è¿‡ï¼Œé‚£ä¹ˆç›¸å½“äºæ„é€ ä¸€ä¸ª 10 åˆ° 99 çš„ä¸¤ä½æ•°ï¼Œå¦‚æœ i=1 è·³è¿‡ï¼Œç›¸å½“äºæ„é€ çš„æ˜¯ä¸€ä¸ª 9 ä»¥å†…çš„æ•°å­—ã€‚</li></ul><blockquote><p>å¦‚æœä¸€ä¸ªæ­£æ•´æ•°æ¯ä¸€ä¸ªæ•°ä½éƒ½æ˜¯ <strong>äº’ä¸ç›¸åŒ</strong> çš„ï¼Œæˆ‘ä»¬ç§°å®ƒæ˜¯ <strong>ç‰¹æ®Šæ•´æ•°</strong> ã€‚ç»™ä½ ä¸€ä¸ª <strong>æ­£</strong> æ•´æ•° <code>n</code> ï¼Œè¯·ä½ è¿”å›åŒºé—´ <code>[1, n]</code> ä¹‹é—´ç‰¹æ®Šæ•´æ•°çš„æ•°ç›®ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="type">int</span>[][] memo;   <span class="comment">// memo[i][mask]è®°å½•å½“å‰é€‰æ‹©é¡ºä½ä¸ºiï¼Œå·²é€‰çŠ¶æ€ä¸ºmaskæ—¶ï¼Œæ„é€ ç¬¬iä½åŠåé¢ä½çš„åˆæ³•æ–¹æ¡ˆæ•°</span></span><br><span class="line">    <span class="type">char</span>[] s;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">countSpecialNumbers</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        å‚è€ƒçµç¥ã®æ•°ä½DPè®°å¿†åŒ–DFSæ¨¡æ¿ï¼š</span></span><br><span class="line"><span class="comment">        æ³¨æ„è¿™é¢˜ä¸LC1012æ˜¯ä¸€æ ·çš„ï¼Œä¸è¿‡è¿™é¢˜æ›´ç›´æ¥æ±‚æ¯ä¸€ä½éƒ½ä¸ç›¸åŒæ•°å­—</span></span><br><span class="line"><span class="comment">        dfs(i, mask, isLimit, hasNum) ä»£è¡¨ä»å·¦åˆ°å³é€‰åˆ°ç¬¬iä¸ªæ•°å­—æ—¶(iä»0å¼€å§‹)ï¼Œå‰é¢æ•°å­—å·²é€‰çŠ¶æ€ä¸ºmaskæ—¶çš„åˆæ³•æ–¹æ¡ˆæ•°</span></span><br><span class="line"><span class="comment">        å„ä¸ªå‚æ•°çš„å«ä¹‰å¦‚ä¸‹:</span></span><br><span class="line"><span class="comment">        i:å½“å‰é€‰æ‹©çš„æ•°å­—ä½æ¬¡ï¼Œä»0å¼€å§‹</span></span><br><span class="line"><span class="comment">        mask:å‰é¢å·²æ‹©æ•°å­—çš„çŠ¶æ€ï¼Œæ˜¯ä¸€ä¸ª10ä½çš„äºŒè¿›åˆ¶æ•°ï¼Œå¦‚:0000000010å°±ä»£è¡¨å‰é¢å·²ç»é€‰äº†1</span></span><br><span class="line"><span class="comment">        isLimit:booleanç±»å‹ï¼Œä»£è¡¨å½“å‰ä½é€‰æ‹©æ˜¯å¦è¢«å‰é¢ä½çš„é€‰æ‹©é™åˆ¶äº†ï¼›</span></span><br><span class="line"><span class="comment">            å¦‚n=1234ï¼Œå‰é¢é€‰äº†12ï¼Œé€‰ç¬¬3ä½çš„æ—¶å€™ä¼šè¢«é™åˆ¶åœ¨0~3ï¼ŒisLimit=trueï¼›å¦åˆ™æ˜¯0~9ï¼ŒisLimit=false</span></span><br><span class="line"><span class="comment">        hasNum:è¡¨ç¤ºå‰é¢æ˜¯å¦å·²ç»é€‰æ‹©äº†æ•°å­—ï¼Œè‹¥é€‰æ‹©äº†å°±ä¸ºtrue(è¯†åˆ«ç›´æ¥æ„é€ ä½ä½çš„æƒ…å†µ)</span></span><br><span class="line"><span class="comment">        æ—¶é—´å¤æ‚åº¦:O(1024*M*10) ç©ºé—´å¤æ‚åº¦:O(1024*M)</span></span><br><span class="line"><span class="comment">        è®°å¿†åŒ–DFSçš„æ—¶é—´å¤æ‚åº¦=çŠ¶æ€æ•°*æ¯ä¸€æ¬¡æšä¸¾çš„æƒ…å†µæ•°</span></span><br><span class="line"><span class="comment">        **è®°å¿†åŒ–æœ¬è´¨å°±æ˜¯å‡å°‘å‰é¢å·²é€‰çŠ¶æ€ä¸€è‡´çš„æƒ…å†µï¼Œå°†1eMçš„æ—¶é—´å¤æ‚åº¦å‹ç¼©è‡³1&lt;&lt;Mï¼Œæ•ˆç‡éå¸¸é«˜**</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        s = String.valueOf(n).toCharArray();    <span class="comment">// è½¬åŒ–ä¸ºå­—ç¬¦æ•°ç»„å½¢å¼</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> s.length;</span><br><span class="line">        memo = <span class="keyword">new</span> <span class="title class_">int</span>[m][<span class="number">1</span> &lt;&lt; <span class="number">10</span>];     <span class="comment">// iâˆˆ[0,m-1]ï¼Œmaskä¸ºä¸€ä¸ª10ä½äºŒè¿›åˆ¶æ•°</span></span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–memoä¸º-1ä»£è¡¨è¯¥é¡ºä½ä¸‹è¯¥å·²é€‰çŠ¶æ€è¿˜æ²¡è¿›è¡Œè®¡ç®—</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            Arrays.fill(memo[i], -<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ³¨æ„ä¸€å¼€å§‹æœ€é«˜ä½æ˜¯æœ‰é™åˆ¶çš„ï¼ŒisLimit=true</span></span><br><span class="line">        <span class="keyword">return</span> dfs(<span class="number">0</span>, <span class="number">0</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// dfs(i, mask, isLimit, hasNum) ä»£è¡¨ä»å·¦åˆ°å³é€‰ç¬¬iä¸ªæ•°å­—æ—¶ï¼Œå‰é¢å·²é€‰çŠ¶æ€ä¸ºmaskæ—¶çš„åˆæ³•æ–¹æ¡ˆæ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">dfs</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> mask, <span class="type">boolean</span> isLimit, <span class="type">boolean</span> hasNum)</span> &#123;</span><br><span class="line">        <span class="comment">// base case</span></span><br><span class="line">        <span class="comment">// iè¶Šè¿‡æœ€åä¸€ä½ï¼Œæ­¤æ—¶å‰é¢é€‰äº†å°±ç®—ä¸€ä¸ªï¼Œæ²¡é€‰çš„å°±ä¸ç®—ï¼Œå› ä¸ºä¸é€‰åé¢ä¹Ÿæ²¡å¾—é€‰äº†</span></span><br><span class="line">        <span class="keyword">if</span> (i == s.length) <span class="keyword">return</span> hasNum ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// å·²ç»è®¡ç®—è¿‡è¯¥çŠ¶æ€ï¼Œå¹¶ä¸”è¯¥çŠ¶æ€æ˜¯æœ‰æ•ˆçš„ï¼Œç›´æ¥è¿”å›è¯¥çŠ¶æ€</span></span><br><span class="line">        <span class="comment">// è¿™ä¸€æ­¥æ˜¯é™ä½æ—¶é—´å¤æ‚åº¦çš„å…³é”®ï¼Œä½¿å¾—è®°å¿†åŒ–dfsçš„æ—¶é—´å¤æ‚åº¦æ§åˆ¶å¾—å¾ˆä½</span></span><br><span class="line">        <span class="comment">// !isLimitè¡¨ç¤ºæ²¡æœ‰è¢«é™åˆ¶çš„æ‰å¯ä»¥ç›´æ¥å¾—å‡ºç»“æœï¼Œå¦åˆ™è¿˜è¦æ ¹æ®åé¢çš„æ•°å­—è¿›è¡Œè®¡ç®—å­é—®é¢˜è®¡ç®—</span></span><br><span class="line">        <span class="keyword">if</span> (!isLimit &amp;&amp; hasNum &amp;&amp; memo[i][mask] != -<span class="number">1</span>) <span class="keyword">return</span> memo[i][mask];</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">0</span>;    <span class="comment">// ç»“æœ</span></span><br><span class="line">        <span class="comment">// æœ¬ä½å¯ä»¥å–0(å¯ç›´æ¥æ„é€ ä½ä½æ•°)çš„æƒ…å†µï¼Œæ­¤æ—¶è¦åŠ ä¸Šæ„é€ ä½ä½æ•°0xxxçš„æ–¹æ¡ˆæ•°</span></span><br><span class="line">        <span class="comment">// å°†æ˜¯å¦é€‰äº†æ•°å­—ä½œä¸ºåˆ†ç±»æ¡ä»¶æ˜¯ä¸ºäº†é¿å…å‡ºç°00010è¿™æ ·æœ‰å¤šä¸ª0çš„å°±ä¸èƒ½ç»Ÿè®¡äº†</span></span><br><span class="line">        <span class="keyword">if</span> (!hasNum) res = dfs(i + <span class="number">1</span>, mask, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// æ„é€ ä¸å½“å‰é¡ºä½ç›¸åŒä½æ•°çš„æ•°å­—å°±è¦æšä¸¾å¯é€‰çš„æ•°å­—è¿›è¡ŒDFS</span></span><br><span class="line">        <span class="comment">// æšä¸¾çš„èµ·ç‚¹è¦è§†hasNumè€Œå®šï¼Œå¦‚æœå‰é¢é€‰æ‹©äº†æ•°å­—ï¼Œé‚£ä¹ˆç°åœ¨å¯ä»¥é€‰0ï¼›å¦åˆ™åªèƒ½ä»1å¼€å§‹</span></span><br><span class="line">        <span class="comment">// æšä¸¾å¾—ç»ˆç‚¹è§†isLimitè€Œå®šï¼Œè‹¥è¢«é™åˆ¶äº†åªèƒ½åˆ°s[i]ï¼Œå¦åˆ™å¯ä»¥åˆ°9</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> hasNum ? <span class="number">0</span> : <span class="number">1</span>, end = isLimit ? s[i] - <span class="string">&#x27;0&#x27;</span> : <span class="number">9</span>; k &lt;= end; k++) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœè¯¥æ•°å­—kè¿˜æ²¡æœ‰è¢«é€‰ä¸­ï¼Œé‚£çŒ«å°±å¯ä»¥é€‰è¯¥ä½æ•°å­—</span></span><br><span class="line">            <span class="keyword">if</span> (((mask &gt;&gt; k) &amp; <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// æ–¹æ¡ˆæ•°éµå¾ªåŠ æ³•åŸç†</span></span><br><span class="line">                <span class="comment">// i:è¿›è¡Œä¸‹ä¸€ä½çš„DFSï¼Œå› æ­¤ä¸ºi+1</span></span><br><span class="line">                <span class="comment">// mask:ç”±äºè¯¥ä½é€‰ä¸­äº†kï¼Œmaskæ©è†œä¼ ä¸‹å»å°±è¦æ›´æ–°ï¼Œå·²é€‰çŠ¶æ€åŠ ä¸Šk</span></span><br><span class="line">                <span class="comment">// isLimit:å½“ä¸”ä»…å½“å‰é¢çš„è¢«é™åˆ¶äº†ä¸”è¯¥ä½è¢«é™åˆ¶</span></span><br><span class="line">                <span class="comment">// hasNum:è¯¥ä½é€‰äº†å¿…å®šä¸ºtrue</span></span><br><span class="line">                res += dfs(i + <span class="number">1</span>, mask | (<span class="number">1</span> &lt;&lt; k), isLimit &amp;&amp; k == end, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!isLimit &amp;&amp; hasNum) memo[i][mask] = res;    <span class="comment">// å¦‚æœå‰é¢æ²¡æœ‰é™åˆ¶ï¼Œè¡¨æ˜åé¢éƒ½æ˜¯åŒè´¨çš„ï¼Œå¯ä»¥è®°å½•è¿›memoä¸­</span></span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¢˜å•ï¼š</p><p><a href="https://leetcode.cn/problems/number-of-digit-one/">233. æ•°å­— 1 çš„ä¸ªæ•°</a></p><p><a href="https://leetcode.cn/problems/non-negative-integers-without-consecutive-ones/">600. ä¸å«è¿ç»­1çš„éè´Ÿæ•´æ•°</a></p><p><a href="https://leetcode.cn/problems/count-numbers-with-unique-digits/">357. ç»Ÿè®¡å„ä½æ•°å­—éƒ½ä¸åŒçš„æ•°å­—ä¸ªæ•°</a></p><p><a href="https://leetcode.cn/problems/numbers-at-most-n-given-digit-set/">902. æœ€å¤§ä¸º N çš„æ•°å­—ç»„åˆ</a></p><p><a href="https://leetcode.cn/problems/rotated-digits/">788. æ—‹è½¬æ•°å­—</a></p><p><a href="https://leetcode.cn/problems/numbers-with-repeated-digits/">1012. è‡³å°‘æœ‰ 1 ä½é‡å¤çš„æ•°å­—</a></p><p><a href="https://leetcode.cn/problems/count-special-integers/">2376. ç»Ÿè®¡ç‰¹æ®Šæ•´æ•°</a></p><p><a href="https://leetcode.cn/problems/count-numbers-with-unique-digits/">357. ç»Ÿè®¡å„ä½æ•°å­—éƒ½ä¸åŒçš„æ•°å­—ä¸ªæ•°</a></p><hr><h2 id="å¹¶æŸ¥é›†"><a href="#å¹¶æŸ¥é›†" class="headerlink" title="å¹¶æŸ¥é›†"></a>å¹¶æŸ¥é›†</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼€å¯äº†è·¯å¾„å‹ç¼©å’ŒæŒ‰å¤§å°åˆå¹¶çš„å¹¶æŸ¥é›†</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnionFind</span> &#123;</span><br><span class="line">    <span class="type">int</span>[] parent;</span><br><span class="line">    <span class="type">int</span>[] size;</span><br><span class="line">    <span class="comment">// å½“å‰è¿é€šåˆ†æ”¯æ•°ç›®</span></span><br><span class="line">    <span class="type">int</span> branchCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UnionFind</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.branchCount = n;</span><br><span class="line">        <span class="built_in">this</span>.parent = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">        <span class="built_in">this</span>.size = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">        Arrays.fill(size, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; ++i) &#123;</span><br><span class="line">            parent[i] = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">find</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">        <span class="comment">// è·¯å¾„å‹ç¼©</span></span><br><span class="line">        <span class="keyword">return</span> parent[x] == x ? x : (parent[x] = find(parent[x]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">union</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">        x = find(x);</span><br><span class="line">        y = find(y);</span><br><span class="line">        <span class="keyword">if</span> (x == y) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŒ‰å¤§å°åˆå¹¶</span></span><br><span class="line">        <span class="keyword">if</span> (size[x] &lt; size[y]) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> x;</span><br><span class="line">            x = y;</span><br><span class="line">            y = temp;</span><br><span class="line">        &#125;</span><br><span class="line">        parent[y] = x;</span><br><span class="line">        size[x] += size[y];</span><br><span class="line">        --branchCount;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isConnected</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> find(x) == find(y);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">branchCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> branchCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="å‰ç¼€å’Œä¸å·®åˆ†"><a href="#å‰ç¼€å’Œä¸å·®åˆ†" class="headerlink" title="å‰ç¼€å’Œä¸å·®åˆ†"></a>å‰ç¼€å’Œä¸å·®åˆ†</h2><h3 id="ä¸€ç»´å‰ç¼€å’Œ"><a href="#ä¸€ç»´å‰ç¼€å’Œ" class="headerlink" title="ä¸€ç»´å‰ç¼€å’Œ"></a>ä¸€ç»´å‰ç¼€å’Œ</h3><hr><h3 id="ä¸€ç»´å·®åˆ†"><a href="#ä¸€ç»´å·®åˆ†" class="headerlink" title="ä¸€ç»´å·®åˆ†"></a>ä¸€ç»´å·®åˆ†</h3><hr><h3 id="äºŒç»´å‰ç¼€å’Œ"><a href="#äºŒç»´å‰ç¼€å’Œ" class="headerlink" title="äºŒç»´å‰ç¼€å’Œ"></a>äºŒç»´å‰ç¼€å’Œ</h3><p>å®šä¹‰<code>preSum[i][j]</code> æ˜¯ä»(0,0) åˆ° (i,j) çš„ å’Œ</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1614615488-IBbfAx-%E4%BA%8C%E7%BB%B4%E5%8C%BA%E5%9F%9F%E5%92%8C%E6%A3%80%E7%B4%A2.png" alt="äºŒç»´åŒºåŸŸå’Œæ£€ç´¢" style="zoom: 25%;" /></p><p><code>sumRegion(A,D)=sumRegion(O,D)âˆ’sumRegion(O,E)âˆ’sumRegion(O,F)+sumRegion(O,G)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> grid.length, n = grid[<span class="number">0</span>].length;</span><br><span class="line"><span class="comment">// äºŒç»´å‰ç¼€å’Œ</span></span><br><span class="line"><span class="type">int</span>[][] preSum = <span class="keyword">new</span> <span class="title class_">int</span>[m + <span class="number">1</span>][n + <span class="number">1</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= m; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= n; j++) &#123;</span><br><span class="line">        preSum[i][j] = preSum[i - <span class="number">1</span>][j] + preSum[i][j - <span class="number">1</span>] - preSum[i - <span class="number">1</span>][j - <span class="number">1</span>] + grid[i - <span class="number">1</span>][j - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="äºŒç»´å·®åˆ†"><a href="#äºŒç»´å·®åˆ†" class="headerlink" title="äºŒç»´å·®åˆ†"></a>äºŒç»´å·®åˆ†</h3><p>å¦‚æœå°†çŸ©é˜µçš„ç¬¬ (i,j) ä¸ªå•å…ƒæ ¼ä¸­çš„å€¼å¢åŠ  1ï¼Œé‚£ä¹ˆï¼Œè‹¥å¯¹çŸ©é˜µæ±‚äºŒç»´å‰ç¼€å’Œï¼Œé‚£ä¹ˆä¸‹å›¾ (a) ä¸­çš„é»„è‰²åŒºåŸŸçš„å€¼éƒ½ä¼šå¢åŠ  1ã€‚</p><p>å¦‚æœè¦å°†çŸ©é˜µä¸­çš„ ä»»æ„ çŸ©å½¢åŒºåŸŸï¼ˆå¦‚ä¸‹å›¾ä¸­ (b) çš„è“è‰²åŒºåŸŸï¼‰çš„å€¼å¢åŠ  1 å‘¢ï¼Ÿåªéœ€æŒ‰ç…§ä¸‹å›¾ (c) æ¥ä¿®æ”¹çŸ©é˜µå³å¯ã€‚ä¿®æ”¹åï¼Œè‹¥å¯¹çŸ©é˜µæ±‚å‰ç¼€å’Œï¼Œé‚£ä¹ˆï¼Œåªä¼šæœ‰è“è‰²çš„åŒºåŸŸçš„å€¼ +1ï¼Œå…¶å®ƒåŒºåŸŸçš„å€¼éƒ½ä¸å˜ã€‚</p><p><img src="https://pic.leetcode-cn.com/1641658840-YrICJa-image.png" alt="image.png" style="zoom: 25%;" /></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span>[][] rangeAddQueries(<span class="type">int</span> n, <span class="type">int</span>[][] queries) &#123;</span><br><span class="line">    <span class="type">int</span>[][] diff = <span class="keyword">new</span> <span class="title class_">int</span>[n + <span class="number">2</span>][n + <span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span>[] q : queries)&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">x1</span> <span class="operator">=</span> q[<span class="number">0</span>] , y1 = q[<span class="number">1</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">x2</span> <span class="operator">=</span> q[<span class="number">2</span>] , y2 = q[<span class="number">3</span>];</span><br><span class="line">        diff[x1][y1]++;</span><br><span class="line">        diff[x2 + <span class="number">1</span>][y2 + <span class="number">1</span>]++;</span><br><span class="line">        diff[x2 + <span class="number">1</span>][y1]--;</span><br><span class="line">        diff[x1][y2 + <span class="number">1</span>]--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span>[][] ans = <span class="keyword">new</span> <span class="title class_">int</span>[n][n];</span><br><span class="line">    <span class="comment">// ä½¿ç”¨å·®åˆ†æ•°ç»„æ±‚å‰ç¼€å’Œ</span></span><br><span class="line">    ans[<span class="number">0</span>][<span class="number">0</span>] = diff[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>;i &lt; n;i++)&#123;</span><br><span class="line">        <span class="comment">// æ±‚ç¬¬ä¸€è¡Œ</span></span><br><span class="line">        ans[<span class="number">0</span>][i] = ans[<span class="number">0</span>][i - <span class="number">1</span>] + diff[<span class="number">0</span>][i];</span><br><span class="line">        <span class="comment">// æ±‚ç¬¬ä¸€åˆ—</span></span><br><span class="line">        ans[i][<span class="number">0</span>] = ans[i - <span class="number">1</span>][<span class="number">0</span>] + diff[i][<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>;i &lt; n;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>;j &lt; n;j++)&#123;</span><br><span class="line">            ans[i][j] = ans[i - <span class="number">1</span>][j] + ans[i][j - <span class="number">1</span>] - ans[i - <span class="number">1</span>][j - <span class="number">1</span>] + diff[i][j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="STè¡¨"><a href="#STè¡¨" class="headerlink" title="STè¡¨"></a>STè¡¨</h2><p>ST è¡¨æ˜¯ç”¨äºè§£å†³ å¯é‡å¤è´¡çŒ®é—®é¢˜ çš„æ•°æ®ç»“æ„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">    <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> sc.nextInt(), M = sc.nextInt();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[] arr = <span class="keyword">new</span> <span class="title class_">int</span>[N];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        arr[i] = sc.nextInt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> (<span class="type">int</span>) (Math.log(N) / Math.log(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[N][size + <span class="number">5</span>];</span><br><span class="line">    <span class="comment">//base case</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) dp[i][<span class="number">0</span>] = arr[i];</span><br><span class="line">    <span class="comment">// çŠ¶æ€è½¬ç§»</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= size; j++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i + (<span class="number">1</span> &lt;&lt; j) - <span class="number">1</span> &lt; N; i++) &#123;</span><br><span class="line">            dp[i][j] = calculate(dp[i][j - <span class="number">1</span>], dp[i + (<span class="number">1</span> &lt;&lt; (j - <span class="number">1</span>))][j - <span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (M-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">L</span> <span class="operator">=</span> sc.nextInt(), R = sc.nextInt();</span><br><span class="line">        <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> (<span class="type">int</span>) (Math.log(R - L + <span class="number">1</span>) / Math.log(<span class="number">2</span>));</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> calculate(dp[L][j], dp[R - (<span class="number">1</span> &lt;&lt; j) + <span class="number">1</span>][j]);</span><br><span class="line">        System.out.println(res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="å¿«é€Ÿå¹‚-amp-ç»„åˆè®¡æ•°"><a href="#å¿«é€Ÿå¹‚-amp-ç»„åˆè®¡æ•°" class="headerlink" title="å¿«é€Ÿå¹‚&amp;ç»„åˆè®¡æ•°"></a>å¿«é€Ÿå¹‚&amp;ç»„åˆè®¡æ•°</h2><div class="tabs" id="657446ae-ec88-48e3-9f15-2c6218a8c84b"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#657446ae-ec88-48e3-9f15-2c6218a8c84b-1"><i class="fas fa-seedling"></i>DPæ‰“è¡¨</button></li><li class="tab"><button type="button" data-href="#657446ae-ec88-48e3-9f15-2c6218a8c84b-2"><i class="fas fa-leaf"></i>Lucas</button></li><li class="tab"><button type="button" data-href="#657446ae-ec88-48e3-9f15-2c6218a8c84b-3"><i class="fab fa-apple"></i>exLucas</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="657446ae-ec88-48e3-9f15-2c6218a8c84b-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> <span class="number">2005</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">MOD</span> <span class="operator">=</span> (<span class="type">int</span>) <span class="number">1e9</span> + <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span>[][] comb = <span class="keyword">new</span> <span class="title class_">int</span>[N][N];</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        comb[i][<span class="number">0</span>] = comb[i][i] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt; i; j++) &#123;</span><br><span class="line">            comb[i][j] = comb[i - <span class="number">1</span>][j] + comb[i - <span class="number">1</span>][j - <span class="number">1</span>];</span><br><span class="line">            comb[i][j] %= MOD;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    System.out.println(comb[<span class="number">5</span>][<span class="number">3</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="657446ae-ec88-48e3-9f15-2c6218a8c84b-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> <span class="number">100002</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="type">long</span> <span class="variable">MOD</span> <span class="operator">=</span> (<span class="type">long</span>) (<span class="number">1e9</span> + <span class="number">7</span>);</span><br><span class="line"><span class="keyword">static</span> <span class="type">long</span>[] fac = <span class="keyword">new</span> <span class="title class_">long</span>[N];</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–é˜¶ä¹˜</span></span><br><span class="line">    fac[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>; i &lt; N; i++) &#123;</span><br><span class="line">        fac[i] = fac[i - <span class="number">1</span>] * i % MOD;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">long</span> <span class="title function_">ksm</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> n, <span class="type">long</span> mod)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((n &amp; <span class="number">1</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">            ans = ans * x % mod;</span><br><span class="line">        &#125;</span><br><span class="line">        n &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">        x = x * x % mod;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">long</span> <span class="title function_">C</span><span class="params">(<span class="type">long</span> n, <span class="type">long</span> m, <span class="type">long</span> p)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (n == m || m == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (n &lt; m) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (m * <span class="number">2</span> &gt; n) &#123;</span><br><span class="line">        m = n - m;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fac[(<span class="type">int</span>) n] * ksm(fac[(<span class="type">int</span>) m] * fac[(<span class="type">int</span>) (n - m)] % p, p - <span class="number">2</span>, p) % p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    è®¡ç®— C(n,m)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">long</span> <span class="title function_">lucas</span><span class="params">(<span class="type">long</span> n, <span class="type">long</span> m, <span class="type">long</span> p)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (m == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> lucas(n / p, m / p, p) * C(n % p, m % p, p) % p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="657446ae-ec88-48e3-9f15-2c6218a8c84b-3"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h2 id="åŸåœ°å †åŒ–"><a href="#åŸåœ°å †åŒ–" class="headerlink" title="åŸåœ°å †åŒ–"></a>åŸåœ°å †åŒ–</h2><div class="tabs" id="e7e66a86-91ce-4f22-b37a-9e457c4b1f9d"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e7e66a86-91ce-4f22-b37a-9e457c4b1f9d-1"><i class="fas fa-seedling"></i>æœ€å¤§å †</button></li><li class="tab"><button type="button" data-href="#e7e66a86-91ce-4f22-b37a-9e457c4b1f9d-2"><i class="fas fa-leaf"></i>æœ€å°å †</button></li><li class="tab"><button type="button" data-href="#e7e66a86-91ce-4f22-b37a-9e457c4b1f9d-3"><i class="fab fa-apple"></i>ä½¿ç”¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e7e66a86-91ce-4f22-b37a-9e457c4b1f9d-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸåœ°å †åŒ–ï¼ˆæœ€å¤§å †ï¼‰</span></span><br><span class="line"> <span class="comment">// å †åŒ–å¯ä»¥ä¿è¯ h[0] æ˜¯å †é¡¶å…ƒç´ ï¼Œä¸” h[i] &gt;= max(h[2*i+1], h[2*i+2])</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">(<span class="type">int</span>[] h)</span> &#123;</span><br><span class="line">     <span class="comment">// å€’ç€éå†ï¼Œä»è€Œä¿è¯ i çš„å·¦å³å­æ ‘ä¸€å®šæ˜¯å †ï¼Œé‚£ä¹ˆ sink(h, i) å°±å¯ä»¥æŠŠå·¦å³å­æ ‘åˆå¹¶æˆä¸€ä¸ªå †</span></span><br><span class="line">     <span class="comment">// ä¸‹æ ‡ &gt;= h.length / 2 çš„å…ƒç´ æ˜¯äºŒå‰æ ‘çš„å¶å­ï¼Œæ— éœ€ä¸‹æ²‰</span></span><br><span class="line">     <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> h.length / <span class="number">2</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">         sink(h, i);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// æŠŠ h[i] ä¸æ–­ä¸‹æ²‰ï¼Œç›´åˆ° i çš„å·¦å³å„¿å­éƒ½ &lt;= h[i]</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sink</span><span class="params">(<span class="type">int</span>[] h, <span class="type">int</span> i)</span> &#123;</span><br><span class="line">     <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> h.length;</span><br><span class="line">     <span class="keyword">while</span> (<span class="number">2</span> * i + <span class="number">1</span> &lt; n) &#123;</span><br><span class="line">         <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">2</span> * i + <span class="number">1</span>; <span class="comment">// i çš„å·¦å„¿å­</span></span><br><span class="line">         <span class="keyword">if</span> (j + <span class="number">1</span> &lt; n &amp;&amp; h[j + <span class="number">1</span>] &gt; h[j]) &#123; <span class="comment">// i çš„å³å„¿å­æ¯” i çš„å·¦å„¿å­å¤§</span></span><br><span class="line">             j++;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (h[j] &lt;= h[i]) &#123; <span class="comment">// è¯´æ˜ i çš„å·¦å³å„¿å­éƒ½ &lt;= h[i]ï¼Œåœæ­¢ä¸‹æ²‰</span></span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         swap(h, i, j); <span class="comment">// ä¸‹æ²‰</span></span><br><span class="line">         i = j;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// äº¤æ¢ h[i] å’Œ h[j]</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">swap</span><span class="params">(<span class="type">int</span>[] h, <span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line">     <span class="type">int</span> <span class="variable">tmp</span> <span class="operator">=</span> h[i];</span><br><span class="line">     h[i] = h[j];</span><br><span class="line">     h[j] = tmp;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e7e66a86-91ce-4f22-b37a-9e457c4b1f9d-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸåœ°å †åŒ–ï¼ˆæœ€å°å †ï¼‰</span></span><br><span class="line"><span class="comment">// å †åŒ–å¯ä»¥ä¿è¯ h[0] æ˜¯å †é¡¶å…ƒç´ ï¼Œä¸” h[i] &lt;= max(h[2*i+1], h[2*i+2])</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">(<span class="type">int</span>[] h)</span> &#123;</span><br><span class="line">    <span class="comment">// å€’ç€éå†ï¼Œä»è€Œä¿è¯ i çš„å·¦å³å­æ ‘ä¸€å®šæ˜¯å †ï¼Œé‚£ä¹ˆ sink(h, i) å°±å¯ä»¥æŠŠå·¦å³å­æ ‘åˆå¹¶æˆä¸€ä¸ªå †</span></span><br><span class="line">    <span class="comment">// ä¸‹æ ‡ &gt;= h.length / 2 çš„å…ƒç´ æ˜¯äºŒå‰æ ‘çš„å¶å­ï¼Œæ— éœ€ä¸‹æ²‰</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> h.length / <span class="number">2</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        sink(h, i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠŠ h[i] ä¸æ–­ä¸‹æ²‰ï¼Œç›´åˆ° i çš„å·¦å³å„¿å­éƒ½ &gt;= h[i]</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sink</span><span class="params">(<span class="type">int</span>[] h, <span class="type">int</span> i)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> h.length;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">2</span> * i + <span class="number">1</span> &lt; n) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">2</span> * i + <span class="number">1</span>; <span class="comment">// i çš„å·¦å„¿å­</span></span><br><span class="line">        <span class="keyword">if</span> (j + <span class="number">1</span> &lt; n &amp;&amp; h[j + <span class="number">1</span>] &lt; h[j]) &#123; <span class="comment">// i çš„å³å„¿å­æ¯” i çš„å·¦å„¿å­å¤§</span></span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (h[j] &gt;= h[i]) &#123; <span class="comment">// è¯´æ˜ i çš„å·¦å³å„¿å­éƒ½ &lt;= h[i]ï¼Œåœæ­¢ä¸‹æ²‰</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        swap(h, i, j); <span class="comment">// ä¸‹æ²‰</span></span><br><span class="line">        i = j;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// äº¤æ¢ h[i] å’Œ h[j]</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">swap</span><span class="params">(<span class="type">int</span>[] h, <span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">tmp</span> <span class="operator">=</span> h[i];</span><br><span class="line">    h[i] = h[j];</span><br><span class="line">    h[j] = tmp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e7e66a86-91ce-4f22-b37a-9e457c4b1f9d-3"><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å †é¡¶å…ƒç´  -&gt; h<span class="selector-attr">[0]</span></span><br><span class="line">æ›´æ”¹å <span class="built_in">sink</span>(h, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h2 id="çº¿æ®µæ ‘"><a href="#çº¿æ®µæ ‘" class="headerlink" title="çº¿æ®µæ ‘"></a>çº¿æ®µæ ‘</h2><p><a href="https://leetcode.cn/circle/discuss/H4aMOn/">https://leetcode.cn/circle/discuss/H4aMOn/</a></p><div class="tabs" id="9c7b8dd6-e778-4726-b122-cb09a92c4e26"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#9c7b8dd6-e778-4726-b122-cb09a92c4e26-1"><i class="fas fa-atom"></i>å•ç‚¹è¦†ç›–+åŒºé—´æ±‚å’Œ+åŒºé—´æ±‚æœ€å€¼</button></li><li class="tab"><button type="button" data-href="#9c7b8dd6-e778-4726-b122-cb09a92c4e26-2"><i class="far fa-sun"></i>åŒºé—´åŠ å€¼+åŒºé—´æ±‚å’Œ</button></li><li class="tab"><button type="button" data-href="#9c7b8dd6-e778-4726-b122-cb09a92c4e26-3"><i class="fas fa-wind"></i>åŒºé—´è¦†ç›–+åŒºé—´æ±‚æœ€å€¼</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="9c7b8dd6-e778-4726-b122-cb09a92c4e26-1"><p>å•ç‚¹ä¿®æ”¹æˆ–è¦†ç›–å‹æ²¡å¿…è¦ç”¨ä¸Šlazyæ ‡è®°ï¼Œå› ä¸ºè¿™æ˜¯ç›´æ¥ä½œç”¨äºæŸä¸ªç‚¹ï¼Œæ²¡æœ‰èŒƒå›´å¯è¨€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">BinaryFunction</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">apply</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SegmentTree</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŸæ•°ç»„  ä¸‹æ ‡ä» 0 å¼€å§‹</span></span><br><span class="line">    <span class="type">int</span>[] data;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[] segTree;</span><br><span class="line"></span><br><span class="line">    BinaryFunction merger;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> unit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SegmentTree</span><span class="params">(<span class="type">int</span>[] data, BinaryFunction merger, <span class="type">int</span> unit)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">        <span class="built_in">this</span>.merger = merger;</span><br><span class="line">        <span class="built_in">this</span>.unit = unit;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> data.length;</span><br><span class="line">        segTree = <span class="keyword">new</span> <span class="title class_">int</span>[n &lt;&lt; <span class="number">2</span>];</span><br><span class="line">        Arrays.fill(segTree, unit);</span><br><span class="line">        build(<span class="number">1</span>, <span class="number">1</span>, n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸‹æ–¹æ–¹æ³•è°ƒç”¨ä¸­ root 1  left 1 right n</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">build</span><span class="params">(<span class="type">int</span> root, <span class="type">int</span> left, <span class="type">int</span> right)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (left == right) &#123;</span><br><span class="line">            segTree[root] = data[left - <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> left + (right - left) / <span class="number">2</span>;</span><br><span class="line">        build(root &lt;&lt; <span class="number">1</span>, left, mid);</span><br><span class="line">        build(root &lt;&lt; <span class="number">1</span> | <span class="number">1</span>, mid + <span class="number">1</span>, right);</span><br><span class="line">        pushUp(root);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">pushUp</span><span class="params">(<span class="type">int</span> root)</span> &#123;</span><br><span class="line">        segTree[root] = merger.apply(segTree[root &lt;&lt; <span class="number">1</span>], segTree[root &lt;&lt; <span class="number">1</span> | <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†curä½ç½®å€¼ä¿®æ”¹ä¸ºval</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(<span class="type">int</span> root, <span class="type">int</span> left, <span class="type">int</span> right, <span class="type">int</span> cur, <span class="type">int</span> val)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (left == right) &#123;</span><br><span class="line">            segTree[root] = val;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> (right - left) / <span class="number">2</span> + left;</span><br><span class="line">        <span class="keyword">if</span> (cur &lt;= mid) &#123;</span><br><span class="line">            update(root &lt;&lt; <span class="number">1</span>, left, mid, cur, val);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            update(root &lt;&lt; <span class="number">1</span> | <span class="number">1</span>, mid + <span class="number">1</span>, right, cur, val);</span><br><span class="line">        &#125;</span><br><span class="line">        pushUp(root);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">query</span><span class="params">(<span class="type">int</span> root, <span class="type">int</span> left, <span class="type">int</span> right, <span class="type">int</span> from, <span class="type">int</span> to)</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸¤ä¸ªåŒºé—´æ— é‡åˆ</span></span><br><span class="line">        <span class="keyword">if</span> (from &gt; right || to &lt; left) &#123;</span><br><span class="line">            <span class="keyword">return</span> unit;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å®Œå…¨åŒ…å«</span></span><br><span class="line">        <span class="keyword">if</span> (from &lt;= left &amp;&amp; to &gt;= right) &#123;</span><br><span class="line">            <span class="keyword">return</span> segTree[root];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> (right - left) / <span class="number">2</span> + left;</span><br><span class="line">        <span class="type">int</span> <span class="variable">l_res</span> <span class="operator">=</span> query(root &lt;&lt; <span class="number">1</span>, left, mid, from, to);</span><br><span class="line">        <span class="type">int</span> <span class="variable">r_res</span> <span class="operator">=</span> query(root &lt;&lt; <span class="number">1</span> | <span class="number">1</span>, mid + <span class="number">1</span>, right, from, to);</span><br><span class="line">        <span class="keyword">return</span> merger.apply(l_res, r_res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9c7b8dd6-e778-4726-b122-cb09a92c4e26-2"><p>å¯¹çœŸæ­£çš„åŒºé—´æ“ä½œå°±éœ€è¦ç”¨åˆ°æ‡’æƒ°æ ‡è®°äº†ï¼Œæ‡’æƒ°æ ‡è®°çš„ä½œç”¨åœ¨äºå¤šæ¬¡æ›´æ–°ï¼Œå°‘é‡æŸ¥è¯¢ï¼Œå°±æ˜¯åœ¨update()çš„æ—¶å€™å…ˆæš‚ç¼“çš„è®°ä¸‹æ¥ï¼Œæœ€åqueryçš„æ—¶å€™ä¸€å£æ°”ä½œç”¨å‡ºæ¥ã€‚</p><p>å®ç°æ€è·¯ï¼š</p><p>æ ¸å¿ƒåœ¨ä¸å¦‚ä½•æŠŠå•ä¸ªvalåŠ å…¥åˆ°ä¸€ä¸ªåŒºé—´çš„æ¯ä¸ªæ•°å­—ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ä¸€ä¸ªrootä»£è¡¨ä¸€ä¸ªåŒºé—´ï¼ŒåŒºé—´å°±æœ‰é•¿åº¦ï¼›é‚£åªéœ€æŠŠval * length(rootçš„åŒºé—´) å³å¯ï¼›</p><p>å¯ä»¥ç†è§£ä¸ºæ”¹åŒºé—´é‡Œçš„æ¯ä¸ªç‚¹éƒ½æœ‰ä¸€ä¸ªè´¡çŒ®çš„valï¼Œnä¸ªvalç›¸åŠ ï¼Œé‚£å°±æ˜¯n*valã€‚åŒç†ï¼Œåœ¨pushDown()çš„æ—¶å€™ä¹Ÿè¦è®¡ç®—è¯¥çˆ¶èŠ‚ç‚¹å¯¹åº”å·¦å³å­©å­çš„é•¿åº¦ï¼›å› æ­¤ï¼Œè¿™é‡Œçš„pushDown()è¿˜éœ€è¦ä¼ å…¥å·¦å³ç‚¹çš„ä½ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SegmentTree</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[] data;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[] segTree;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[] lazy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SegmentTree</span><span class="params">(<span class="type">int</span>[] data)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> data.length;</span><br><span class="line">        segTree = <span class="keyword">new</span> <span class="title class_">int</span>[n &lt;&lt; <span class="number">2</span>];</span><br><span class="line">        lazy = <span class="keyword">new</span> <span class="title class_">int</span>[n &lt;&lt; <span class="number">2</span>];</span><br><span class="line">        build(<span class="number">1</span>, <span class="number">1</span>, n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">build</span><span class="params">(<span class="type">int</span> root, <span class="type">int</span> left, <span class="type">int</span> right)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (left == right) &#123;</span><br><span class="line">            segTree[root] = data[left - <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> left + (right - left) / <span class="number">2</span>;</span><br><span class="line">        build(root &lt;&lt; <span class="number">1</span>, left, mid);</span><br><span class="line">        build(root &lt;&lt; <span class="number">1</span> | <span class="number">1</span>, mid + <span class="number">1</span>, right);</span><br><span class="line">        pushUp(root);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">pushUp</span><span class="params">(<span class="type">int</span> root)</span> &#123;</span><br><span class="line">        segTree[root] = (segTree[root &lt;&lt; <span class="number">1</span>] + segTree[root &lt;&lt; <span class="number">1</span> | <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">pushDown</span><span class="params">(<span class="type">int</span> root, <span class="type">int</span> left, <span class="type">int</span> right)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> left + (right - left) / <span class="number">2</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">leftLen</span> <span class="operator">=</span> mid - left + <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">rightLen</span> <span class="operator">=</span> right - mid;</span><br><span class="line">        <span class="keyword">if</span> (lazy[root] != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// val ç´¯è®¡lazy*len</span></span><br><span class="line">            segTree[root &lt;&lt; <span class="number">1</span>] = (segTree[root &lt;&lt; <span class="number">1</span>] + lazy[root] * leftLen);</span><br><span class="line">            segTree[root &lt;&lt; <span class="number">1</span> | <span class="number">1</span>] = (segTree[root &lt;&lt; <span class="number">1</span> | <span class="number">1</span>] + lazy[root] * rightLen);</span><br><span class="line">            <span class="comment">// lazy ç›´æ¥ç´¯è®¡</span></span><br><span class="line">            lazy[root &lt;&lt; <span class="number">1</span>] = (lazy[root &lt;&lt; <span class="number">1</span>] + lazy[root]);</span><br><span class="line">            lazy[root &lt;&lt; <span class="number">1</span> | <span class="number">1</span>] = (lazy[root &lt;&lt; <span class="number">1</span> | <span class="number">1</span>] + lazy[root]);</span><br><span class="line"></span><br><span class="line">            lazy[root] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(<span class="type">int</span> root, <span class="type">int</span> left, <span class="type">int</span> right, <span class="type">int</span> from, <span class="type">int</span> to, <span class="type">int</span> val)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (from &gt; right || to &lt; left) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (from &lt;= left &amp;&amp; right &lt;= to) &#123;</span><br><span class="line">            segTree[root] =</span><br><span class="line">                    (segTree[root] + val * (right - left + <span class="number">1</span>));</span><br><span class="line">            lazy[root] = (lazy[root] + val);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pushDown(root, left, right);</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> left + (right - left) / <span class="number">2</span>;</span><br><span class="line">        update(root &lt;&lt; <span class="number">1</span>, left, mid, from, to, val);</span><br><span class="line">        update(root &lt;&lt; <span class="number">1</span> | <span class="number">1</span>, mid + <span class="number">1</span>, right, from, to, val);</span><br><span class="line">        pushUp(root);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">query</span><span class="params">(<span class="type">int</span> root, <span class="type">int</span> left, <span class="type">int</span> right, <span class="type">int</span> from, <span class="type">int</span> to)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (from &gt; right || to &lt; left) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (from &lt;= left &amp;&amp; right &lt;= to) &#123;</span><br><span class="line">            <span class="keyword">return</span> segTree[root];</span><br><span class="line">        &#125;</span><br><span class="line">        pushDown(root, left, right);</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> left + (right - left) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">return</span> (query(root &lt;&lt; <span class="number">1</span>, left, mid, from, to) +</span><br><span class="line">                query(root &lt;&lt; <span class="number">1</span> | <span class="number">1</span>, mid + <span class="number">1</span>, right, from, to));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9c7b8dd6-e778-4726-b122-cb09a92c4e26-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SegmentTree</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[] data;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[] segTree;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[] lazy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SegmentTree</span><span class="params">(<span class="type">int</span>[] data)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> data.length;</span><br><span class="line">        segTree = <span class="keyword">new</span> <span class="title class_">int</span>[n &lt;&lt; <span class="number">2</span>];</span><br><span class="line">        lazy = <span class="keyword">new</span> <span class="title class_">int</span>[n &lt;&lt; <span class="number">2</span>];</span><br><span class="line">        build(<span class="number">1</span>, <span class="number">1</span>, n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">build</span><span class="params">(<span class="type">int</span> root, <span class="type">int</span> left, <span class="type">int</span> right)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (left == right) &#123;</span><br><span class="line">            segTree[root] = data[left - <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> left + (right - left) / <span class="number">2</span>;</span><br><span class="line">        build(root &lt;&lt; <span class="number">1</span>, left, mid);</span><br><span class="line">        build(root &lt;&lt; <span class="number">1</span> | <span class="number">1</span>, mid + <span class="number">1</span>, right);</span><br><span class="line">        pushUp(root);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">pushUp</span><span class="params">(<span class="type">int</span> root)</span> &#123;</span><br><span class="line">        segTree[root] = Math.max(segTree[root &lt;&lt; <span class="number">1</span>], segTree[root &lt;&lt; <span class="number">1</span> | <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">pushDown</span><span class="params">(<span class="type">int</span> root)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lazy[root] != <span class="number">0</span>) &#123;</span><br><span class="line">            segTree[root &lt;&lt; <span class="number">1</span>] = segTree[root];</span><br><span class="line">            segTree[root &lt;&lt; <span class="number">1</span> | <span class="number">1</span>] = segTree[root];</span><br><span class="line">            lazy[root &lt;&lt; <span class="number">1</span>] = lazy[root];</span><br><span class="line">            lazy[root &lt;&lt; <span class="number">1</span> | <span class="number">1</span>] = lazy[root];</span><br><span class="line">            lazy[root] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(<span class="type">int</span> root, <span class="type">int</span> left, <span class="type">int</span> right, <span class="type">int</span> from, <span class="type">int</span> to, <span class="type">int</span> val)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (from &gt; right || to &lt; left) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (from &lt;= left &amp;&amp; right &lt;= to) &#123;</span><br><span class="line">            segTree[root] = val;</span><br><span class="line">            lazy[root] = val;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pushDown(root);</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> left + (right - left) / <span class="number">2</span>;</span><br><span class="line">        update(root &lt;&lt; <span class="number">1</span>, left, mid, from, to, val);</span><br><span class="line">        update(root &lt;&lt; <span class="number">1</span> | <span class="number">1</span>, mid + <span class="number">1</span>, right, from, to, val);</span><br><span class="line">        pushUp(root);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">query</span><span class="params">(<span class="type">int</span> root, <span class="type">int</span> left, <span class="type">int</span> right, <span class="type">int</span> from, <span class="type">int</span> to)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (from &gt; right || to &lt; left) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (from &lt;= left &amp;&amp; right &lt;= to) &#123;</span><br><span class="line">            <span class="keyword">return</span> segTree[root];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pushDown(root);</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> left + (right - left) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">return</span> Math.max(query(root &lt;&lt; <span class="number">1</span>, left, mid, from, to), query(root &lt;&lt; <span class="number">1</span> | <span class="number">1</span>, mid + <span class="number">1</span>, right, from, to));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <hr><h2 id="æ ‘çŠ¶æ•°ç»„"><a href="#æ ‘çŠ¶æ•°ç»„" class="headerlink" title="æ ‘çŠ¶æ•°ç»„"></a>æ ‘çŠ¶æ•°ç»„</h2><p>é«˜æ•ˆå¤„ç†ã€Œå‰ç¼€ã€æŸ¥è¯¢ï¼Œå•ç‚¹ä¿®æ”¹</p><p>é€šå¸¸ä½¿ç”¨æ ‘çŠ¶æ•°ç»„æ˜¯ä¸ºäº†ç»´æŠ¤ä¸€äº›å‰ç¼€ï¼Œå¦‚å‰ç¼€å’Œã€å‰ç¼€æœ€å°å€¼ã€å‰ç¼€æœ€å¤§å€¼ã€‚</p><p>ä½†ç”±äºæœ€å°å€¼å’Œæœ€å¤§å€¼ä¸å¯é€†ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯ç»´æŠ¤ä¸äº†åŒºé—´æœ€å°å€¼å’Œæœ€å¤§å€¼çš„ã€‚</p><p><img src="https://pic.leetcode-cn.com/257e6c5742751f7cfdfd0704e7380ceccbd123335347a589165d74fa7ad11d40.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 33%;" /></p><div class="table-container"><table><thead><tr><th style="text-align:center">æ•°ç»„ <code>C</code> çš„å€¼ç”±æ•°ç»„ <code>A</code> çš„å“ªäº›å…ƒç´ è€Œæ¥</th><th style="text-align:center">æ•°ç»„ <code>A</code> çš„å…ƒç´ ä¸ªæ•°</th></tr></thead><tbody><tr><td style="text-align:center">C[1] = A[1]</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">C[2] = A[1] + A[2]</td><td style="text-align:center">2</td></tr><tr><td style="text-align:center">C[3] = A[3]</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">C[4] = A[1] + A[2] + A[3] + A[4]</td><td style="text-align:center">4</td></tr><tr><td style="text-align:center">C[5] = A[5]</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">C[6] = A[5] + A[6]</td><td style="text-align:center">2</td></tr><tr><td style="text-align:center">C[7] = A[7]</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">C[8] = A[1] + A[2] + A[3] + A[4] + A[5] + A[6] + A[7] + A[8]</td><td style="text-align:center">8</td></tr></tbody></table></div><p>é€šè¿‡å›¾ä¸­ä¸éš¾çœ‹å‡ºï¼Œsum[7]=c[7]+c[6]+c[4] ,æˆ‘ä»¬è¿›ä¸€æ­¥å‘ç°,6=7-lowbit(7),4=6-lowbit(6)ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸æ–­çš„-lowbitæ“ä½œæ¥å®ç°æ±‚å’Œ</p><p>åœ¨æ•°æ®èŒƒå›´æ¯”è¾ƒåˆ†æ•£æ—¶ï¼Œå¯ä»¥ç¦»æ•£åŒ–æ•°æ®ã€‚</p><p>åŸæ•°ç»„ä¸‹æ ‡ä¹Ÿä»1å¼€å§‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">BIT</span> &#123;</span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line">    <span class="type">int</span>[] data;</span><br><span class="line"></span><br><span class="line">    BIT(<span class="type">int</span> n) &#123;</span><br><span class="line">        <span class="built_in">this</span>.n = n;</span><br><span class="line">        data = <span class="keyword">new</span> <span class="title class_">int</span>[n + <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">lowBit</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> i &amp; -i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> idx, <span class="type">int</span> val)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (idx &lt;= n) &#123;</span><br><span class="line">            data[idx] += val;</span><br><span class="line">            idx += lowBit(idx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">query</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (x != <span class="number">0</span>) &#123;</span><br><span class="line">            sum += data[x];</span><br><span class="line">            x -= lowBit(x);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="åŸºç¯æ ‘"><a href="#åŸºç¯æ ‘" class="headerlink" title="åŸºç¯æ ‘"></a>åŸºç¯æ ‘</h2><p>å®ƒçš„æ ‡å‡†å®šä¹‰æ˜¯ï¼šå…·æœ‰Nä¸ªç‚¹Næ¡è¾¹çš„è¿é€šå›¾ã€‚å¦‚æœä¸ä¿è¯è”é€šï¼Œå®ƒå°±ä¼šæˆä¸ºåŸºç¯æ ‘æ£®æ—ã€‚</p><p>å†…å‘åŸºç¯æ ‘çš„å®šä¹‰æ˜¯æ¯ä¸ªç‚¹æœ‰ä¸”åªæœ‰ä¸€æ¡å‡ºè¾¹ã€‚</p><p>å¤–å‘åŸºç¯æ ‘çš„å®šä¹‰æ˜¯æ¯ä¸ªç‚¹æœ‰ä¸”åªæœ‰ä¸€æ¡å…¥è¾¹ã€‚</p><p>ä» i å‘ to[i] è¿è¾¹ï¼Œå¯ä»¥å¾—åˆ°ä¸€å¼ æœ‰å‘å›¾ã€‚ç”±äºæ¯ä¸ªå¤§å°ä¸º k çš„è¿é€šå—éƒ½æœ‰ k ä¸ªç‚¹å’Œ k æ¡è¾¹ï¼Œæ‰€ä»¥<span class='p green'>æ¯ä¸ªè¿é€šå—å¿…å®šæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªç¯</span>ï¼Œä¸”ç”±äºæ¯ä¸ªç‚¹çš„å‡ºåº¦å‡ä¸º 1ï¼Œè¿™æ ·çš„æœ‰å‘å›¾åˆå«åšå†…å‘åŸºç¯æ ‘ (pseudotree)ï¼Œç”±åŸºç¯æ ‘ç»„æˆçš„æ£®æ—å«åŸºç¯æ ‘æ£®æ— (pseudoforest)ã€‚</p><p>æ¯ä¸€ä¸ªå†…å‘åŸºç¯æ ‘ï¼ˆè¿é€šå—ï¼‰éƒ½ç”±ä¸€ä¸ªåŸºç¯å’Œå…¶ä½™æŒ‡å‘åŸºç¯çš„æ ‘æç»„æˆã€‚ä¾‹å¦‚ ä»¥ä¸‹ç¤ºä¾‹ <code>to = [3,0,1,4,1]</code>  å¯ä»¥å¾—åˆ°å¦‚ä¸‹å†…å‘åŸºç¯æ ‘ï¼Œå…¶åŸºç¯ç”±èŠ‚ç‚¹ 0ã€1ã€3 å’Œ 4 ç»„æˆï¼ŒèŠ‚ç‚¹ 2 ä¸ºå…¶æ ‘æï¼š</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1641096462-IsWZUX-1-20231101095643697.png" alt="1.png" style="zoom: 67%;" /></p><p>å¸¸è§çš„å¤„ç†æ–¹å¼ï¼šæ‹“æ‰‘æ’åºå»æ‰æ ‘æ</p><p><a href="https://leetcode.cn/problems/maximum-employees-to-be-invited-to-a-meeting/">å‚åŠ ä¼šè®®çš„æœ€å¤šå‘˜å·¥æ•°</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">maximumInvitations</span><span class="params">(<span class="type">int</span>[] favorite)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> favorite.length;</span><br><span class="line">        <span class="type">int</span>[] deg = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> f : favorite) &#123;</span><br><span class="line">            deg[f]++; <span class="comment">// ç»Ÿè®¡åŸºç¯æ ‘æ¯ä¸ªèŠ‚ç‚¹çš„å…¥åº¦</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;Integer&gt;[] rg = <span class="keyword">new</span> <span class="title class_">List</span>[n]; <span class="comment">// åå›¾</span></span><br><span class="line">        Arrays.setAll(rg, e -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        Deque&lt;Integer&gt; q = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (deg[i] == <span class="number">0</span>) &#123;</span><br><span class="line">                q.add(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (!q.isEmpty()) &#123; <span class="comment">// æ‹“æ‰‘æ’åºï¼Œå‰ªæ‰å›¾ä¸Šæ‰€æœ‰æ ‘æ</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> q.poll();</span><br><span class="line">            <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> favorite[x]; <span class="comment">// x åªæœ‰ä¸€æ¡å‡ºè¾¹</span></span><br><span class="line">            rg[y].add(x);</span><br><span class="line">            <span class="keyword">if</span> (--deg[y] == <span class="number">0</span>) &#123;</span><br><span class="line">                q.add(y);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">maxRingSize</span> <span class="operator">=</span> <span class="number">0</span>, sumChainSize = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (deg[i] == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// éå†åŸºç¯ä¸Šçš„ç‚¹</span></span><br><span class="line">            deg[i] = <span class="number">0</span>; <span class="comment">// å°†åŸºç¯ä¸Šçš„ç‚¹çš„å…¥åº¦æ ‡è®°ä¸º 0ï¼Œé¿å…é‡å¤è®¿é—®</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">ringSize</span> <span class="operator">=</span> <span class="number">1</span>; <span class="comment">// åŸºç¯é•¿åº¦</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> favorite[i]; x != i; x = favorite[x]) &#123;</span><br><span class="line">                deg[x] = <span class="number">0</span>; <span class="comment">// å°†åŸºç¯ä¸Šçš„ç‚¹çš„å…¥åº¦æ ‡è®°ä¸º 0ï¼Œé¿å…é‡å¤è®¿é—®</span></span><br><span class="line">                ringSize++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ringSize == <span class="number">2</span>) &#123; <span class="comment">// åŸºç¯é•¿åº¦ä¸º 2</span></span><br><span class="line">                sumChainSize += rdfs(i, rg) + rdfs(favorite[i], rg); <span class="comment">// ç´¯åŠ ä¸¤æ¡æœ€é•¿é“¾çš„é•¿åº¦</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                maxRingSize = Math.max(maxRingSize, ringSize); <span class="comment">// å–æ‰€æœ‰åŸºç¯é•¿åº¦çš„æœ€å¤§å€¼</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Math.max(maxRingSize, sumChainSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡åå›¾ rg å¯»æ‰¾æ ‘æä¸Šæœ€æ·±çš„é“¾</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">rdfs</span><span class="params">(<span class="type">int</span> x, List&lt;Integer&gt;[] rg)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">maxDepth</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> son : rg[x]) &#123;</span><br><span class="line">            maxDepth = Math.max(maxDepth, rdfs(son, rg) + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> maxDepth;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="å­—å…¸æ ‘-amp-äºŒè¿›åˆ¶å­—å…¸æ ‘"><a href="#å­—å…¸æ ‘-amp-äºŒè¿›åˆ¶å­—å…¸æ ‘" class="headerlink" title="å­—å…¸æ ‘&amp;äºŒè¿›åˆ¶å­—å…¸æ ‘"></a>å­—å…¸æ ‘&amp;äºŒè¿›åˆ¶å­—å…¸æ ‘</h2><div class="tabs" id="0832b00f-ca2f-43ba-a0f6-65d4ce426d75"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#0832b00f-ca2f-43ba-a0f6-65d4ce426d75-1"><i class="fas fa-bug"></i>å­—å…¸æ ‘</button></li><li class="tab"><button type="button" data-href="#0832b00f-ca2f-43ba-a0f6-65d4ce426d75-2"><i class="fas fa-cannabis"></i>äºŒè¿›åˆ¶å­—å…¸æ ‘</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="0832b00f-ca2f-43ba-a0f6-65d4ce426d75-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Trie</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> TireNode root;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Trie</span><span class="params">()</span> &#123;</span><br><span class="line">        root = <span class="keyword">new</span> <span class="title class_">TireNode</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(String word)</span> &#123;</span><br><span class="line">        <span class="type">TireNode</span> <span class="variable">node</span> <span class="operator">=</span> root;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">char</span> c : word.toCharArray()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (node.next[c - <span class="string">&#x27;a&#x27;</span>] == <span class="literal">null</span>) &#123;</span><br><span class="line">                node.next[c - <span class="string">&#x27;a&#x27;</span>] = <span class="keyword">new</span> <span class="title class_">TireNode</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            node = node.next[c - <span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        node.isEnd = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">search</span><span class="params">(String word)</span> &#123;</span><br><span class="line">        <span class="type">TireNode</span> <span class="variable">node</span> <span class="operator">=</span> root;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">char</span> c : word.toCharArray()) &#123;</span><br><span class="line">            node = node.next[c - <span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">            <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> node.isEnd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">startsWith</span><span class="params">(String prefix)</span> &#123;</span><br><span class="line">        <span class="type">TireNode</span> <span class="variable">node</span> <span class="operator">=</span> root;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">char</span> c : prefix.toCharArray()) &#123;</span><br><span class="line">            node = node.next[c - <span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">            <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TireNode</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> isEnd;</span><br><span class="line">    <span class="keyword">public</span> TireNode[] next;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TireNode</span><span class="params">()</span> &#123;</span><br><span class="line">        isEnd = <span class="literal">false</span>;</span><br><span class="line">        next = <span class="keyword">new</span> <span class="title class_">TireNode</span>[<span class="number">26</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="0832b00f-ca2f-43ba-a0f6-65d4ce426d75-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Trie01</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_BIT</span> <span class="operator">=</span> <span class="number">31</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> TireNode root;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Trie01</span><span class="params">()</span> &#123;</span><br><span class="line">        root = <span class="keyword">new</span> <span class="title class_">TireNode</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">        <span class="type">TireNode</span> <span class="variable">node</span> <span class="operator">=</span> root;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> MAX_BIT; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">bit</span> <span class="operator">=</span> (x &gt;&gt; i) &amp; <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (node.next[bit] == <span class="literal">null</span>) &#123;</span><br><span class="line">                node.next[bit] = <span class="keyword">new</span> <span class="title class_">TireNode</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            node.next[bit].cnt++;</span><br><span class="line">            node = node.next[bit];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">del</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">        <span class="type">TireNode</span> <span class="variable">node</span> <span class="operator">=</span> root;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> MAX_BIT; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">bit</span> <span class="operator">=</span> (x &gt;&gt; i) &amp; <span class="number">1</span>;</span><br><span class="line">            node.next[bit].cnt--;</span><br><span class="line">            node = node.next[bit];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TireNode</span> &#123;</span><br><span class="line">    TireNode[] next;</span><br><span class="line">  <span class="type">int</span> cnt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TireNode</span><span class="params">()</span> &#123;</span><br><span class="line">        next = <span class="keyword">new</span> <span class="title class_">TireNode</span>[<span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h2 id="å­—ç¬¦ä¸²å“ˆå¸Œ"><a href="#å­—ç¬¦ä¸²å“ˆå¸Œ" class="headerlink" title="å­—ç¬¦ä¸²å“ˆå¸Œ"></a>å­—ç¬¦ä¸²å“ˆå¸Œ</h2><mark class="hl-label blue">BKDR-HASH</mark> <p>æŠŠ <code>String</code> å½“æˆä¸€ä¸ª <code>X</code> è¿›åˆ¶çš„æ•°</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;123&quot;</span> -&gt; <span class="number">123</span>(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;abz&quot;</span> -&gt; <span class="number">0</span> <span class="number">1</span> <span class="number">26</span>(<span class="number">26</span>)</span><br></pre></td></tr></table></figure><div class="tabs" id="62813119-1ef5-4a50-a4d6-d2ccbf7883b0"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#62813119-1ef5-4a50-a4d6-d2ccbf7883b0-1"><i class="fas fa-seedling"></i>æ±‚æ•´ä¸ªå­—ç¬¦ä¸²å“ˆå¸Œ</button></li><li class="tab"><button type="button" data-href="#62813119-1ef5-4a50-a4d6-d2ccbf7883b0-2"><i class="fas fa-leaf"></i>å‰ç¼€å’Œæ€æƒ³æ±‚æ¯ä¸ªå­ä¸²å“ˆå¸Œ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="62813119-1ef5-4a50-a4d6-d2ccbf7883b0-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span>[] cs = <span class="string">&quot;abc&quot;</span>.toCharArray();</span><br><span class="line"><span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">13331</span>;</span><br><span class="line"><span class="type">long</span> <span class="variable">hash_code</span> <span class="operator">=</span> cs[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; cs.length; i++) &#123;</span><br><span class="line">    hash_code = hash_code * x + cs[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="62813119-1ef5-4a50-a4d6-d2ccbf7883b0-2"><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">12345</span><br><span class="line">h<span class="comment">[0]</span> = 1h<span class="comment">[1]</span> = 12h<span class="comment">[2]</span> = 123h<span class="comment">[3]</span> = 1234h<span class="comment">[4]</span> = 12345</span><br><span class="line"></span><br><span class="line">å¦‚ä½•å¾—åˆ°234çš„hash å³ 234</span><br><span class="line">h<span class="comment">[3]</span> - h<span class="comment">[0]</span> ???</span><br><span class="line">h<span class="comment">[3]</span> - h<span class="comment">[0]</span> * 10^3</span><br></pre></td></tr></table></figure><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">char[] cs = <span class="string">&quot;abcdefe&quot;</span>.toCharArray();</span><br><span class="line">int len = cs.length;</span><br><span class="line">long[] h = new long[len];</span><br><span class="line">long[] x = new long[len];</span><br><span class="line">int <span class="symbol">X</span> = <span class="number">13331</span>;</span><br><span class="line">h[<span class="number">0</span>] = cs[<span class="number">0</span>];</span><br><span class="line">x[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">for (int i = <span class="number">1</span>; i &lt; cs.length; i++) &#123;</span><br><span class="line">    h[i] = h[i - <span class="number">1</span>] * <span class="symbol">X</span> + cs[i];</span><br><span class="line">    x[i] = x[i - <span class="number">1</span>] * <span class="symbol">X</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è®¡ç®—å­å­—ç¬¦ä¸²hash [<span class="symbol">L</span>,<span class="symbol">R</span>]</span><br><span class="line">int <span class="symbol">L</span>, <span class="symbol">R</span>;</span><br><span class="line">long hash = <span class="symbol">L</span> == <span class="number">0</span> ? h[<span class="symbol">R</span>] : h[<span class="symbol">R</span>] - h[<span class="symbol">L</span> - <span class="number">1</span>] * x[<span class="symbol">R</span> - <span class="symbol">L</span> + <span class="number">1</span>];</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h2 id="å¤§å°å†™è½¬æ¢"><a href="#å¤§å°å†™è½¬æ¢" class="headerlink" title="å¤§å°å†™è½¬æ¢"></a>å¤§å°å†™è½¬æ¢</h2><ol><li>å…¨è½¬å°å†™ï¼šch|=32</li><li>å…¨è½¬å¤§å†™ï¼šch&amp;=-33 (åŸç†æ˜¯32çš„è¡¥ç ï¼ˆåŸç å–å+1ï¼‰å†-1)</li><li>å¤§å°å†™å¯¹æ¢ï¼ˆå¤§å†™å˜å°å†™ï¼Œå°å†™å˜å¤§ï¼‰ch^=32</li></ol><hr><h2 id="éš”æ¿æ³•"><a href="#éš”æ¿æ³•" class="headerlink" title="éš”æ¿æ³•"></a>éš”æ¿æ³•</h2><p><strong>éš”æ¿æ³•</strong> å°±æ˜¯åœ¨nä¸ªå…ƒç´ é—´çš„ï¼ˆn-1ï¼‰ä¸ªç©ºä¸­æ’å…¥kä¸ªæ¿ï¼Œå¯ä»¥æŠŠnä¸ªå…ƒç´ åˆ†æˆk+1ç»„çš„æ–¹æ³•</p><div class="tabs" id="adcb06f7-b745-4b55-b30a-26b14d08e162"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#adcb06f7-b745-4b55-b30a-26b14d08e162-1"><i class="fas fa-seedling"></i>1</button></li><li class="tab"><button type="button" data-href="#adcb06f7-b745-4b55-b30a-26b14d08e162-2"><i class="fas fa-leaf"></i>2</button></li><li class="tab"><button type="button" data-href="#adcb06f7-b745-4b55-b30a-26b14d08e162-3"><i class="fab fa-apple"></i>3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="adcb06f7-b745-4b55-b30a-26b14d08e162-1"><p>ä¾‹1. æ±‚æ–¹ç¨‹ x+y+z=10çš„æ­£æ•´æ•°è§£çš„ä¸ªæ•°ã€‚<br>åˆ†æï¼šå°†10ä¸ªçƒæ’æˆä¸€æ’ï¼Œçƒä¸çƒä¹‹é—´å½¢æˆ9ä¸ªç©ºéš™ï¼Œå°†ä¸¤ä¸ªéš”æ¿æ’å…¥è¿™äº›ç©ºéš™ä¸­ï¼ˆæ¯ç©ºè‡³å¤šæ’ä¸€å—éš”æ¿ï¼‰ï¼Œè§„å®šç”±éš”æ¿åˆ†æˆçš„å·¦ã€ä¸­ã€å³ä¸‰éƒ¨åˆ†çš„çƒæ•°åˆ†åˆ«ä¸ºxã€yã€zä¹‹å€¼ï¼ˆå¦‚ä¸‹å›¾ï¼‰ã€‚åˆ™éš”æ³•ä¸è§£çš„ä¸ªæ•°ä¹‹é—´å»ºç«‹äº†ä¸€ä¸€å¯¹ç«‹å…³ç³»ï¼Œæ•…è§£çš„ä¸ªæ•°ä¸ºCï¼ˆ9ï¼Œ2ï¼‰=36ï¼ˆä¸ªï¼‰ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="adcb06f7-b745-4b55-b30a-26b14d08e162-2"><p>ä¾‹2. æ±‚æ–¹ç¨‹ x+y+z=10çš„éè´Ÿæ•´æ•°è§£çš„ä¸ªæ•°ã€‚ ï¼ˆæ·»åŠ çƒæ•°ç”¨éš”æ¿æ³•ï¼‰<br>åˆ†æï¼šæ³¨æ„åˆ°xã€yã€zå¯ä»¥ä¸ºé›¶ï¼Œæ•…ä¾‹1è§£æ³•ä¸­çš„é™å®šâ€œæ¯ç©ºè‡³å¤šæ’ä¸€å—éš”æ¿â€å°±ä¸æˆç«‹äº†ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿåªè¦æ·»åŠ ä¸‰ä¸ªçƒï¼Œç»™xã€yã€zå„æ·»åŠ ä¸€ä¸ªçƒï¼Œè¿™æ ·åŸé—®é¢˜å°±è½¬åŒ–ä¸ºæ±‚ x+y+z=13çš„æ­£æ•´æ•°è§£çš„ä¸ªæ•°äº†ï¼Œæ˜“å¾—è§£çš„ä¸ªæ•°ä¸ºCï¼ˆ12ï¼Œ2ï¼‰=66ï¼ˆä¸ªï¼‰ã€‚</p><p>ä»¤x1 = x + 1 , y1 = y + 1 , z1 = z + 1 ,åˆ™x1 ï¼Œ y1 , z1 &gt;=1 </p><p>åˆ™ x1 + y1 + z1 = n + k </p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="adcb06f7-b745-4b55-b30a-26b14d08e162-3"><p>ä¾‹3. å°†20ä¸ªç›¸åŒçš„å°çƒæ”¾å…¥ç¼–å·åˆ†åˆ«ä¸º1ï¼Œ2ï¼Œ3ï¼Œ4çš„å››ä¸ªç›’å­ä¸­ï¼Œè¦æ±‚æ¯ä¸ªç›’å­ä¸­çš„çƒæ•°ä¸å°‘äºå®ƒçš„ç¼–å·æ•°ï¼Œæ±‚æ”¾æ³•æ€»æ•°ã€‚ï¼ˆå‡å°‘çƒæ•°ç”¨éš”æ¿æ³•ï¼‰<br>åˆ†æï¼šå…ˆåœ¨ç¼–å·1ï¼Œ2ï¼Œ3ï¼Œ4çš„å››ä¸ªç›’å­å†…åˆ†åˆ«æ”¾0ï¼Œ1ï¼Œ2ï¼Œ3ä¸ªçƒï¼Œå‰©ä¸‹14ä¸ªçƒï¼Œæœ‰1ç§æ–¹æ³•ï¼›å†æŠŠå‰©ä¸‹çš„çƒåˆ†æˆ4ç»„ï¼Œæ¯ç»„è‡³å°‘1ä¸ªï¼Œç”±ä¾‹1çŸ¥æ–¹æ³•æœ‰Cï¼ˆ13ï¼Œ3ï¼‰=286ï¼ˆç§ï¼‰ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h2 id="å¿«é€Ÿæ’åº"><a href="#å¿«é€Ÿæ’åº" class="headerlink" title="å¿«é€Ÿæ’åº"></a>å¿«é€Ÿæ’åº</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span>[] sortArray(<span class="type">int</span>[] nums) &#123;</span><br><span class="line">        quickSort2(nums , <span class="number">0</span> , nums.length - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> nums;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€‰å–ç¬¬ä¸€ä¸ªå…ƒç´ å½“åšåŸºå‡†å…ƒç´ </span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">quickSort1</span><span class="params">(<span class="type">int</span>[] arr , <span class="type">int</span> l , <span class="type">int</span> r)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(l &lt; r)&#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> l , j = r , x = arr[i];</span><br><span class="line">            <span class="keyword">while</span>(i &lt; j)&#123;</span><br><span class="line">                <span class="comment">// ä»å³å¾€å·¦æ‰¾  &lt; x</span></span><br><span class="line">                <span class="keyword">while</span>(i &lt; j &amp;&amp; arr[j] &gt; x) j--;</span><br><span class="line">                <span class="keyword">if</span>(i &lt; j) arr[i++] = arr[j];</span><br><span class="line">                <span class="comment">// ä»å·¦å¾€å³æ‰¾ &gt; x</span></span><br><span class="line">                <span class="keyword">while</span>(i &lt; j &amp;&amp; arr[i] &lt; x) i++;</span><br><span class="line">                <span class="keyword">if</span>(i &lt; j) arr[j--] = arr[i];</span><br><span class="line">            &#125;</span><br><span class="line">            arr[i] = x;</span><br><span class="line">            quickSort1(arr , l , i - <span class="number">1</span>);</span><br><span class="line">            quickSort1(arr , i + <span class="number">1</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// éšæœºé€‰æ‹©å…ƒç´ å½“åšåŸºå‡†å…ƒç´ </span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">quickSort2</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> l , <span class="type">int</span> r)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(l &lt; r)&#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">randomIndex</span> <span class="operator">=</span> random.nextInt(l , r + <span class="number">1</span>);</span><br><span class="line">            swap(arr, l , randomIndex);</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> l , j = r , x = arr[i];</span><br><span class="line">            <span class="keyword">while</span>(i &lt; j)&#123;</span><br><span class="line">                <span class="comment">// ä»å³å¾€å·¦æ‰¾  &lt; x</span></span><br><span class="line">                <span class="keyword">while</span>(i &lt; j &amp;&amp; arr[j] &gt; x) j--;</span><br><span class="line">                <span class="keyword">if</span>(i &lt; j) arr[i++] = arr[j];</span><br><span class="line">                <span class="comment">// ä»å·¦å¾€å³æ‰¾ &gt; x</span></span><br><span class="line">                <span class="keyword">while</span>(i &lt; j &amp;&amp; arr[i] &lt; x) i++;</span><br><span class="line">                <span class="keyword">if</span>(i &lt; j) arr[j--] = arr[i];</span><br><span class="line">            &#125;</span><br><span class="line">            arr[i] = x;</span><br><span class="line">            quickSort2(arr , l , i - <span class="number">1</span>);</span><br><span class="line">            quickSort2(arr , i + <span class="number">1</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº¤æ¢æ•°ç»„ä¸­çš„ä¸¤ä¸ªå…ƒç´ </span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">swap</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> arr[i];</span><br><span class="line">        arr[i] = arr[j];</span><br><span class="line">        arr[j] = temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æœ€çŸ­è·¯ç®—æ³•"><a href="#æœ€çŸ­è·¯ç®—æ³•" class="headerlink" title="æœ€çŸ­è·¯ç®—æ³•"></a>æœ€çŸ­è·¯ç®—æ³•</h2><mark class="hl-label blue">é‚»æ¥çŸ©é˜µæœ´ç´ Dijkstraç®—æ³•</mark> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">networkDelayTime</span><span class="params">(<span class="type">int</span>[][] times, <span class="type">int</span> n, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">        <span class="comment">// å­˜å›¾</span></span><br><span class="line">        <span class="type">int</span>[][] g = <span class="keyword">new</span> <span class="title class_">int</span>[n + <span class="number">1</span>][n + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">INF</span> <span class="operator">=</span> <span class="number">0x3f3f3f3f</span>;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–é‚»æ¥çŸ©é˜µ</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= n; j++) &#123;</span><br><span class="line">                g[i][j] = g[j][i] = i == j ? <span class="number">0</span> : INF;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span>[] conn : times) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">from</span> <span class="operator">=</span> conn[<span class="number">0</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">to</span> <span class="operator">=</span> conn[<span class="number">1</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">weight</span> <span class="operator">=</span> conn[<span class="number">2</span>];</span><br><span class="line">            g[from][to] = weight;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// dist[x] = y ä»£è¡¨ä»ã€Œæºç‚¹/èµ·ç‚¹ã€åˆ° x çš„æœ€çŸ­è·ç¦»ä¸º y</span></span><br><span class="line">        <span class="type">int</span>[] dist = <span class="keyword">new</span> <span class="title class_">int</span>[n + <span class="number">1</span>];</span><br><span class="line">        <span class="comment">// è®°å½•å“ªäº›ç‚¹å·²ç»è¢«æ›´æ–°è¿‡</span></span><br><span class="line">        <span class="type">boolean</span>[] vis = <span class="keyword">new</span> <span class="title class_">boolean</span>[n + <span class="number">1</span>];</span><br><span class="line">        Arrays.fill(dist, INF);</span><br><span class="line">        dist[k] = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// è¿­ä»£næ¬¡</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">p</span> <span class="operator">=</span> <span class="number">1</span>; p &lt;= n; p++) &#123;</span><br><span class="line">            <span class="comment">// æ¯æ¬¡æ‰¾åˆ°ã€Œæœ€çŸ­è·ç¦»æœ€å°ã€ä¸”ã€Œæœªè¢«æ›´æ–°ã€çš„ç‚¹ t</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">t</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!vis[i] &amp;&amp; (t == -<span class="number">1</span> || dist[i] &lt; dist[t])) t = i;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ ‡è®°ç‚¹ t ä¸ºå·²æ›´æ–°</span></span><br><span class="line">            vis[t] = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// ç”¨ç‚¹ t çš„ã€Œæœ€å°è·ç¦»ã€æ›´æ–°å…¶ä»–ç‚¹</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">                dist[i] = Math.min(dist[i], dist[t] + g[t][i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            ans = Math.max(ans, dist[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans &gt; INF / <span class="number">2</span> ? -<span class="number">1</span> : ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>é‚»æ¥è¡¨å †ä¼˜åŒ–Dijkstraç®—æ³•</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">networkDelayTime</span><span class="params">(<span class="type">int</span>[][] times, <span class="type">int</span> n, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] dist = <span class="keyword">new</span> <span class="title class_">int</span>[n + <span class="number">1</span>];</span><br><span class="line">        Arrays.fill(dist, Integer.MAX_VALUE);</span><br><span class="line">        dist[k] = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// å»ºå›¾</span></span><br><span class="line">        ArrayList&lt;<span class="type">int</span>[]&gt;[] g = <span class="keyword">new</span> <span class="title class_">ArrayList</span>[n + <span class="number">1</span>];</span><br><span class="line">        Arrays.setAll(g, e -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        <span class="comment">// å»ºå›¾</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span>[] edges : times) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">u</span> <span class="operator">=</span> edges[<span class="number">0</span>], v = edges[<span class="number">1</span>], w = edges[<span class="number">2</span>];</span><br><span class="line">            g[u].add(<span class="keyword">new</span> <span class="title class_">int</span>[]&#123;v, w&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        PriorityQueue&lt;<span class="type">int</span>[]&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;((o1, o2) -&gt; o1[<span class="number">1</span>] - o2[<span class="number">1</span>]);</span><br><span class="line">        queue.offer(<span class="keyword">new</span> <span class="title class_">int</span>[]&#123;k, <span class="number">0</span>&#125;);</span><br><span class="line">        <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">            <span class="type">int</span>[] p = queue.poll();</span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> p[<span class="number">0</span>], d = p[<span class="number">1</span>];</span><br><span class="line">          <span class="comment">// x ä¹‹å‰å‡ºå †è¿‡</span></span><br><span class="line">            <span class="keyword">if</span> (d &gt; dist[x]) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span>[] e : g[x]) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> e[<span class="number">0</span>], c = e[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">if</span> (c + d &lt; dist[y]) &#123;</span><br><span class="line">                    dist[y] = c + d;</span><br><span class="line">                    queue.offer(<span class="keyword">new</span> <span class="title class_">int</span>[]&#123;y, dist[y]&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> Arrays.stream(dist).skip(<span class="number">1</span>).max().getAsInt();</span><br><span class="line">        <span class="keyword">return</span> res == Integer.MAX_VALUE ? -<span class="number">1</span> : res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><mark class="hl-label red">Floydç®—æ³•</mark> <p>åˆå§‹åŒ–dpçŸ©é˜µå…¨ä¸ºINF</p><p>è‡ªå·±åˆ°è‡ªå·±çš„è·ç¦»ä¸º0</p><p>ç»™å®šçš„åˆå§‹åŒ–è·ç¦»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; n; k++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">            dp[i][j] = Math.min(dp[i][j], dp[i][k] + dp[k][j]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ä¸€äº›å¸¸ç”¨çš„ç®—æ³•æ¨¡ç‰ˆ</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>å‘¨èµ›å¤ç›˜</title>
    <link href="https://wuwawawa.github.io/posts/e7135cd3.html"/>
    <id>https://wuwawawa.github.io/posts/e7135cd3.html</id>
    <published>2023-10-01T06:13:22.000Z</published>
    <updated>2023-11-12T09:11:35.760Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰ç¼€æœ€å¤§å€¼-åç¼€æœ€å¤§å€¼"><a href="#å‰ç¼€æœ€å¤§å€¼-åç¼€æœ€å¤§å€¼" class="headerlink" title="å‰ç¼€æœ€å¤§å€¼+åç¼€æœ€å¤§å€¼"></a>å‰ç¼€æœ€å¤§å€¼+åç¼€æœ€å¤§å€¼</h2><p><a href="https://leetcode.cn/problems/maximum-value-of-an-ordered-triplet-ii/">æœ‰åºä¸‰å…ƒç»„ä¸­çš„æœ€å¤§å€¼</a></p><p>ç»™ä½ ä¸€ä¸ªä¸‹æ ‡ä» <strong>0</strong> å¼€å§‹çš„æ•´æ•°æ•°ç»„ <code>nums</code> ã€‚</p><p>è¯·ä½ ä»æ‰€æœ‰æ»¡è¶³ <code>i &lt; j &lt; k</code> çš„ä¸‹æ ‡ä¸‰å…ƒç»„ <code>(i, j, k)</code> ä¸­ï¼Œæ‰¾å‡ºå¹¶è¿”å›ä¸‹æ ‡ä¸‰å…ƒç»„çš„æœ€å¤§å€¼ã€‚å¦‚æœæ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„ä¸‰å…ƒç»„çš„å€¼éƒ½æ˜¯è´Ÿæ•°ï¼Œåˆ™è¿”å› <code>0</code> ã€‚</p><p><strong>ä¸‹æ ‡ä¸‰å…ƒç»„</strong> <code>(i, j, k)</code> çš„å€¼ç­‰äº <code>(nums[i] - nums[j]) * nums[k]</code> ã€‚</p><div class="tabs" id="e9e2c01f-875d-4e1c-9742-03b1bc516d2b"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e9e2c01f-875d-4e1c-9742-03b1bc516d2b-1"><i class="fas fa-seedling"></i>ç¤ºä¾‹1</button></li><li class="tab"><button type="button" data-href="#e9e2c01f-875d-4e1c-9742-03b1bc516d2b-2"><i class="fas fa-leaf"></i>ç¤ºä¾‹2</button></li><li class="tab"><button type="button" data-href="#e9e2c01f-875d-4e1c-9742-03b1bc516d2b-3"><i class="fab fa-apple"></i>ç¤ºä¾‹3</button></li><li class="tab"><button type="button" data-href="#e9e2c01f-875d-4e1c-9742-03b1bc516d2b-4"><i class="fas fa-tree"></i>æ•°æ®èŒƒå›´</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e9e2c01f-875d-4e1c-9742-03b1bc516d2b-1"><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnums = <span class="comment">[12,6,1,2,7]</span></span><br><span class="line">è¾“å‡ºï¼š77</span><br><span class="line">è§£é‡Šï¼šä¸‹æ ‡ä¸‰å…ƒç»„ (0, 2, 4) çš„å€¼æ˜¯ (nums<span class="comment">[0]</span> - nums<span class="comment">[2]</span>) * nums<span class="comment">[4]</span> = 77 ã€‚</span><br><span class="line">å¯ä»¥è¯æ˜ä¸å­˜åœ¨å€¼å¤§äº 77 çš„æœ‰åºä¸‹æ ‡ä¸‰å…ƒç»„ã€‚</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e9e2c01f-875d-4e1c-9742-03b1bc516d2b-2"><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnums = <span class="comment">[1,10,3,4,19]</span></span><br><span class="line">è¾“å‡ºï¼š133</span><br><span class="line">è§£é‡Šï¼šä¸‹æ ‡ä¸‰å…ƒç»„ (1, 2, 4) çš„å€¼æ˜¯ (nums<span class="comment">[1]</span> - nums<span class="comment">[2]</span>) * nums<span class="comment">[4]</span> = 133 ã€‚</span><br><span class="line">å¯ä»¥è¯æ˜ä¸å­˜åœ¨å€¼å¤§äº 133 çš„æœ‰åºä¸‹æ ‡ä¸‰å…ƒç»„ã€‚</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e9e2c01f-875d-4e1c-9742-03b1bc516d2b-3"><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnums = <span class="comment">[1,2,3]</span></span><br><span class="line">è¾“å‡ºï¼š0</span><br><span class="line">è§£é‡Šï¼šå”¯ä¸€çš„ä¸‹æ ‡ä¸‰å…ƒç»„ (0, 1, 2) çš„å€¼æ˜¯ä¸€ä¸ªè´Ÿæ•°ï¼Œ(nums<span class="comment">[0]</span> - nums<span class="comment">[1]</span>) * nums<span class="comment">[2]</span> = -3 ã€‚å› æ­¤ï¼Œç­”æ¡ˆæ˜¯ 0 ã€‚</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e9e2c01f-875d-4e1c-9742-03b1bc516d2b-4"><p>ä¸¤é¢˜çš„æ•°æ®åªæ˜¯æ•°æ®èŒƒå›´å­˜åœ¨ä¸åŒ</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="æšä¸¾J"><a href="#æšä¸¾J" class="headerlink" title="æšä¸¾J"></a>æšä¸¾J</h3><p>åœ¨æšä¸¾Jçš„æƒ…å†µä¸‹ï¼Œæƒ³è¦<code>(nums[i] - nums[j]) * nums[k]</code>å°½é‡å¤§ï¼Œå°±æ˜¯è¦è®©ä¸¤ä¸ªæ•°éƒ½å°½é‡å¤§ã€‚</p><p>å¯¹äº <code>nums[j]</code> æ¥è¯´ï¼Œå¦‚æœå›ºå®šäº† <code>j</code> çš„ä½ç½®ï¼Œé‚£æˆ‘ä»¬éœ€è¦çŸ¥é“</p><ul><li><code>nums[j + 1] ~ nums[n - 1]</code> çš„æœ€å¤§å€¼ å³åç¼€æœ€å¤§å€¼</li><li><code>nums[0] ~ nums[j - 1]</code> çš„æœ€å¤§å€¼ å³å‰ç¼€æœ€å¤§å€¼</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">maximumTripletValue</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> nums.length;</span><br><span class="line">    <span class="comment">// åç¼€æœ€å¤§å€¼</span></span><br><span class="line">    <span class="type">int</span>[] suf_max = <span class="keyword">new</span> <span class="title class_">int</span>[n + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> n - <span class="number">1</span>;i &gt;= <span class="number">0</span>;i--)&#123;</span><br><span class="line">        suf_max[i] = Math.max(suf_max[i + <span class="number">1</span>] , nums[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å‰ç¼€æœ€å¤§å€¼</span></span><br><span class="line">    <span class="type">int</span>[] pre_max = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">    pre_max[<span class="number">0</span>] = nums[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>;i &lt; n;i++)&#123;</span><br><span class="line">        pre_max[i] = Math.max(pre_max[i - <span class="number">1</span>] , nums[i]);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="type">long</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//æšä¸¾j</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>;j &lt; n - <span class="number">1</span>;j++)&#123;</span><br><span class="line">        ans = Math.max(ans,(<span class="type">long</span>)(pre_max[j - <span class="number">1</span>] - nums[j]) * suf_max[j + <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="æšä¸¾k"><a href="#æšä¸¾k" class="headerlink" title="æšä¸¾k"></a>æšä¸¾k</h3><p>ä¸€æ¬¡éå†ï¼Œä»å·¦åˆ°å³éå†æ‰€æœ‰çš„ <code>nums[k]</code> </p><ul><li>é‚£ä¹ˆå°±éœ€è¦ç»´æŠ¤ <code>nums[i] - nums[j]</code>çš„æœ€å¤§å€¼ max_diff</li><li>åŒæ—¶æˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“å·¦ä¾§çš„æœ€å¤§å€¼pre_max</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">maximumTripletValue</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> <span class="variable">max_diff</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> <span class="variable">pre_max</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> x : nums)&#123;</span><br><span class="line">        <span class="comment">// å…ˆæŠŠ x å½“åš nums[k]</span></span><br><span class="line">        ans = Math.max(ans , max_diff * x);</span><br><span class="line">        <span class="comment">// å†æŠŠ x å½“åš nums[j]</span></span><br><span class="line">        max_diff = Math.max(max_diff , pre_max - x);</span><br><span class="line">        <span class="comment">// å†æŠŠ x å½“åš nums[i]</span></span><br><span class="line">        pre_max = Math.max(pre_max , x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸‰å¥è¯çš„é¡ºåºä¸èƒ½æ”¹å˜ï¼Œå› ä¸ºé¢˜ç›®ä¸¥æ ¼è¦æ±‚<code>i &lt; j &lt; k</code></p><hr><h2 id="æ»‘åŠ¨çª—å£"><a href="#æ»‘åŠ¨çª—å£" class="headerlink" title="æ»‘åŠ¨çª—å£"></a>æ»‘åŠ¨çª—å£</h2><p><a href="https://leetcode.cn/problems/minimum-size-subarray-in-infinite-array/">æ— é™æ•°ç»„çš„æœ€çŸ­å­æ•°ç»„</a></p><p>ç»™ä½ ä¸€ä¸ªä¸‹æ ‡ä» <strong>0</strong> å¼€å§‹çš„æ•°ç»„ <code>nums</code> å’Œä¸€ä¸ªæ•´æ•° <code>target</code> ã€‚</p><p>ä¸‹æ ‡ä» <strong>0</strong> å¼€å§‹çš„æ•°ç»„ <code>infinite_nums</code> æ˜¯é€šè¿‡æ— é™åœ°å°† nums çš„å…ƒç´ è¿½åŠ åˆ°è‡ªå·±ä¹‹åç”Ÿæˆçš„ã€‚</p><p>è¯·ä½ ä» <code>infinite_nums</code> ä¸­æ‰¾å‡ºæ»¡è¶³ <strong>å…ƒç´ å’Œ</strong> ç­‰äº <code>target</code> çš„ <strong>æœ€çŸ­</strong>å­æ•°ç»„ï¼Œå¹¶è¿”å›è¯¥å­æ•°ç»„çš„é•¿åº¦ã€‚å¦‚æœä¸å­˜åœ¨æ»¡è¶³æ¡ä»¶çš„å­æ•°ç»„ï¼Œè¿”å› <code>-1</code> ã€‚</p><div class="tabs" id="3c20ef88-8338-403a-abf5-62b17d741a18"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#3c20ef88-8338-403a-abf5-62b17d741a18-1"><i class="fas fa-seedling"></i>ç¤ºä¾‹1</button></li><li class="tab"><button type="button" data-href="#3c20ef88-8338-403a-abf5-62b17d741a18-2"><i class="fas fa-leaf"></i>ç¤ºä¾‹2</button></li><li class="tab"><button type="button" data-href="#3c20ef88-8338-403a-abf5-62b17d741a18-3"><i class="fab fa-apple"></i>ç¤ºä¾‹3</button></li><li class="tab"><button type="button" data-href="#3c20ef88-8338-403a-abf5-62b17d741a18-4"><i class="fas fa-tree"></i>æ•°æ®èŒƒå›´</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="3c20ef88-8338-403a-abf5-62b17d741a18-1"><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnums = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>], <span class="keyword">target</span> = <span class="number">5</span></span><br><span class="line">è¾“å‡ºï¼š<span class="number">2</span></span><br><span class="line">è§£é‡Šï¼šåœ¨è¿™ä¸ªä¾‹å­ä¸­ infinite_nums = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>,...] ã€‚</span><br><span class="line">åŒºé—´ [<span class="number">1</span>,<span class="number">2</span>] å†…çš„å­æ•°ç»„çš„å…ƒç´ å’Œç­‰äº <span class="keyword">target</span> = <span class="number">5</span> ï¼Œä¸”é•¿åº¦ length = <span class="number">2</span> ã€‚</span><br><span class="line">å¯ä»¥è¯æ˜ï¼Œå½“å…ƒç´ å’Œç­‰äºç›®æ ‡å€¼ <span class="keyword">target</span> = <span class="number">5</span> æ—¶ï¼Œ<span class="number">2</span> æ˜¯å­æ•°ç»„çš„æœ€çŸ­é•¿åº¦ã€‚</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="3c20ef88-8338-403a-abf5-62b17d741a18-2"><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnums = [<span class="number">1,1,1,2</span>,<span class="number">3</span>], target = <span class="number">4</span></span><br><span class="line">è¾“å‡ºï¼š<span class="number">2</span></span><br><span class="line">è§£é‡Šï¼šåœ¨è¿™ä¸ªä¾‹å­ä¸­ infinite_nums = [<span class="number">1,1,1,2</span>,<span class="number">3,1,1,1</span>,<span class="number">2,3,1,1</span>,...].</span><br><span class="line">åŒºé—´ [<span class="number">4</span>,<span class="number">5</span>] å†…çš„å­æ•°ç»„çš„å…ƒç´ å’Œç­‰äº target = <span class="number">4</span> ï¼Œä¸”é•¿åº¦ length = <span class="number">2</span> ã€‚</span><br><span class="line">å¯ä»¥è¯æ˜ï¼Œå½“å…ƒç´ å’Œç­‰äºç›®æ ‡å€¼ target = <span class="number">4</span> æ—¶ï¼Œ<span class="number">2</span> æ˜¯å­æ•°ç»„çš„æœ€çŸ­é•¿åº¦ã€‚</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="3c20ef88-8338-403a-abf5-62b17d741a18-3"><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnums = [<span class="number">2,4,6,8</span>], target = <span class="number">3</span></span><br><span class="line">è¾“å‡ºï¼š-<span class="number">1</span></span><br><span class="line">è§£é‡Šï¼šåœ¨è¿™ä¸ªä¾‹å­ä¸­ infinite_nums = [<span class="number">2,4,6,8</span>,<span class="number">2,4,6,8</span>,...] ã€‚</span><br><span class="line">å¯ä»¥è¯æ˜ï¼Œä¸å­˜åœ¨å…ƒç´ å’Œç­‰äºç›®æ ‡å€¼ target = <span class="number">3</span> çš„å­æ•°ç»„ã€‚</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="3c20ef88-8338-403a-abf5-62b17d741a18-4"><ul><li><code>1 &lt;= nums.length &lt;= 105</code></li><li><code>1 &lt;= nums[i] &lt;= 105</code></li><li><code>1 &lt;= target &lt;= 109</code></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/1696131371-UYYmoV-w365c-c.png" alt="img" style="zoom: 33%;" /></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">minSizeSubarray</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> x : nums) total += x;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> nums.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> Integer.MAX_VALUE;</span><br><span class="line">    <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> <span class="number">0</span> , right = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(right &lt; <span class="number">2</span>*n)&#123;</span><br><span class="line">        sum += nums[right % n];</span><br><span class="line">        <span class="keyword">while</span>(sum &gt; target % total)&#123;</span><br><span class="line">            sum -= nums[left % n];</span><br><span class="line">            left++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ›´æ–°ç­”æ¡ˆ</span></span><br><span class="line">        <span class="keyword">if</span>(sum == target % total)&#123;</span><br><span class="line">            ans = Math.min(ans, right - left + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        right++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans == Integer.MAX_VALUE ? -<span class="number">1</span> : ans + (<span class="type">int</span>)(target / total) * n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="ä½è¿ç®—"><a href="#ä½è¿ç®—" class="headerlink" title="ä½è¿ç®—"></a>ä½è¿ç®—</h2><p><a href="https://leetcode.cn/problems/minimum-operations-to-collect-elements/">æ”¶é›†å…ƒç´ çš„æœ€å°‘æ“ä½œæ¬¡æ•°</a></p><p>ç»™ä½ ä¸€ä¸ªæ­£æ•´æ•°æ•°ç»„ <code>nums</code> å’Œä¸€ä¸ªæ•´æ•° <code>k</code> ã€‚</p><p>ä¸€æ¬¡æ“ä½œä¸­ï¼Œä½ å¯ä»¥å°†æ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ åˆ é™¤ï¼Œå°†è¯¥å…ƒç´ æ·»åŠ åˆ°ä¸€ä¸ªé›†åˆä¸­ã€‚</p><p>è¯·ä½ è¿”å›æ”¶é›†å…ƒç´  <code>1, 2, ..., k</code> éœ€è¦çš„ <strong>æœ€å°‘æ“ä½œæ¬¡æ•°</strong> ã€‚</p><div class="tabs" id="6a55aa92-f333-4d58-8119-bccb9431f404"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6a55aa92-f333-4d58-8119-bccb9431f404-1"><i class="fas fa-seedling"></i>ç¤ºä¾‹1</button></li><li class="tab"><button type="button" data-href="#6a55aa92-f333-4d58-8119-bccb9431f404-2"><i class="fas fa-leaf"></i>ç¤ºä¾‹2</button></li><li class="tab"><button type="button" data-href="#6a55aa92-f333-4d58-8119-bccb9431f404-3"><i class="fab fa-apple"></i>ç¤ºä¾‹3</button></li><li class="tab"><button type="button" data-href="#6a55aa92-f333-4d58-8119-bccb9431f404-4"><i class="fas fa-tree"></i>æ•°æ®èŒƒå›´</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6a55aa92-f333-4d58-8119-bccb9431f404-1"><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnums = [3,1,5,4,2], k = 2</span><br><span class="line">è¾“å‡ºï¼š4</span><br><span class="line">è§£é‡Šï¼š4 æ¬¡æ“ä½œåï¼Œé›†åˆä¸­çš„å…ƒç´ ä¾æ¬¡æ·»åŠ äº†<span class="number"> 2 </span>ï¼Œ4 ï¼Œ5 å’Œ<span class="number"> 1 </span>ã€‚æ­¤æ—¶é›†åˆä¸­åŒ…å«å…ƒç´ <span class="number"> 1 </span>å’Œ<span class="number"> 2 </span>ï¼Œæ‰€ä»¥ç­”æ¡ˆä¸º<span class="number"> 4 </span>ã€‚</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6a55aa92-f333-4d58-8119-bccb9431f404-2"><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnums = [3,1,5,4,2], k = 5</span><br><span class="line">è¾“å‡ºï¼š5</span><br><span class="line">è§£é‡Šï¼š5 æ¬¡æ“ä½œåï¼Œé›†åˆä¸­çš„å…ƒç´ ä¾æ¬¡æ·»åŠ äº†<span class="number"> 2 </span>ï¼Œ4 ï¼Œ5 ï¼Œ1 å’Œ<span class="number"> 3 </span>ã€‚æ­¤æ—¶é›†åˆä¸­åŒ…å«å…ƒç´ <span class="number"> 1 </span>åˆ°<span class="number"> 5 </span>ï¼Œæ‰€ä»¥ç­”æ¡ˆä¸º<span class="number"> 5 </span>ã€‚</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6a55aa92-f333-4d58-8119-bccb9431f404-3"><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnums = [3,2,5,3,1], k = 3</span><br><span class="line">è¾“å‡ºï¼š4</span><br><span class="line">è§£é‡Šï¼š4 æ¬¡æ“ä½œåï¼Œé›†åˆä¸­çš„å…ƒç´ ä¾æ¬¡æ·»åŠ äº†<span class="number"> 1 </span>ï¼Œ3 ï¼Œ5 å’Œ<span class="number"> 2 </span>ã€‚æ­¤æ—¶é›†åˆä¸­åŒ…å«å…ƒç´ <span class="number"> 1 </span>åˆ°<span class="number"> 3 </span> ï¼Œæ‰€ä»¥ç­”æ¡ˆä¸º<span class="number"> 4 </span>ã€‚</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6a55aa92-f333-4d58-8119-bccb9431f404-4"><ul><li><code>1 &lt;= nums.length &lt;= 50</code></li><li><code>1 &lt;= nums[i] &lt;= nums.length</code></li><li><code>1 &lt;= k &lt;= nums.length</code></li><li>è¾“å…¥ä¿è¯ä½ å¯ä»¥æ”¶é›†åˆ°å…ƒç´  <code>1, 2, ..., k</code> ã€‚</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>ç”±äºå…ƒç´ èŒƒå›´åœ¨[1,50]ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª 64 ä½æ•´æ•°è¡¨ç¤ºé›†åˆï¼Œåªè¦é›†åˆä¸­æœ‰ 1 åˆ° k å°±ç«‹åˆ»è¿”å›ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½è¿ç®—</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">minOperations</span><span class="params">(List&lt;Integer&gt; nums, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> nums.size();</span><br><span class="line">    <span class="type">long</span> <span class="variable">mask</span> <span class="operator">=</span> (<span class="number">1L</span> &lt;&lt; (k + <span class="number">1</span>)) - <span class="number">2</span>;</span><br><span class="line">    <span class="type">long</span> <span class="variable">status</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ç»“æŸçŠ¶æ€ mask æ˜¯ statsu çš„å­é›†</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> n - <span class="number">1</span>;i &gt;= <span class="number">0</span>;i--)&#123;</span><br><span class="line">        <span class="comment">// æ›´æ–°status</span></span><br><span class="line">        status |= <span class="number">1L</span> &lt;&lt; nums.get(i);</span><br><span class="line">        <span class="keyword">if</span>((mask &amp; status) == mask)&#123;</span><br><span class="line">            <span class="keyword">return</span> n - i;   </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åŒæŒ‡é’ˆ"><a href="#åŒæŒ‡é’ˆ" class="headerlink" title="åŒæŒ‡é’ˆ"></a>åŒæŒ‡é’ˆ</h2><p><a href="https://leetcode.cn/problems/find-indices-with-index-and-value-difference-ii/">æ‰¾å‡ºæ»¡è¶³å·®å€¼æ¡ä»¶çš„ä¸‹æ ‡ II</a></p><p>ç»™ä½ ä¸€ä¸ªä¸‹æ ‡ä» <strong>0</strong> å¼€å§‹ã€é•¿åº¦ä¸º <code>n</code> çš„æ•´æ•°æ•°ç»„ <code>nums</code> ï¼Œä»¥åŠæ•´æ•° <code>indexDifference</code> å’Œæ•´æ•° <code>valueDifference</code> ã€‚</p><p>ä½ çš„ä»»åŠ¡æ˜¯ä»èŒƒå›´ <code>[0, n - 1]</code> å†…æ‰¾å‡º <strong>2</strong> ä¸ªæ»¡è¶³ä¸‹è¿°æ‰€æœ‰æ¡ä»¶çš„ä¸‹æ ‡ <code>i</code> å’Œ <code>j</code> ï¼š</p><ul><li><code>abs(i - j) &gt;= indexDifference</code> ä¸”</li><li><code>abs(nums[i] - nums[j]) &gt;= valueDifference</code></li></ul><p>è¿”å›æ•´æ•°æ•°ç»„ <code>answer</code>ã€‚å¦‚æœå­˜åœ¨æ»¡è¶³é¢˜ç›®è¦æ±‚çš„ä¸¤ä¸ªä¸‹æ ‡ï¼Œåˆ™ <code>answer = [i, j]</code> ï¼›å¦åˆ™ï¼Œ<code>answer = [-1, -1]</code> ã€‚å¦‚æœå­˜åœ¨å¤šç»„å¯ä¾›é€‰æ‹©çš„ä¸‹æ ‡å¯¹ï¼Œåªéœ€è¦è¿”å›å…¶ä¸­ä»»æ„ä¸€ç»„å³å¯ã€‚</p><p><strong>æ³¨æ„ï¼š</strong><code>i</code> å’Œ <code>j</code> å¯èƒ½ <strong>ç›¸ç­‰</strong> ã€‚</p><div class="tabs" id="a01cbf90-6b71-4b34-aac8-ad28ebabb777"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#a01cbf90-6b71-4b34-aac8-ad28ebabb777-1"><i class="fas fa-seedling"></i>æ€è·¯</button></li><li class="tab"><button type="button" data-href="#a01cbf90-6b71-4b34-aac8-ad28ebabb777-2"><i class="fas fa-leaf"></i>ä»£ç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="a01cbf90-6b71-4b34-aac8-ad28ebabb777-1"><p>æ‹†ç»å¯¹å€¼</p><ul><li>j - i &gt;= id</li><li>| ai - aj | &gt;= vd</li></ul><p>ä¸€è¾¹æšä¸¾j ï¼Œä¸€è¾¹ç»´æŠ¤j - id ä¹‹å‰çš„æœ€å¤§å’Œæœ€ä¸‹å€¼</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a01cbf90-6b71-4b34-aac8-ad28ebabb777-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span>[] findIndices(<span class="type">int</span>[] nums, <span class="type">int</span> indexDifference, <span class="type">int</span> valueDifference) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">maxIdx</span> <span class="operator">=</span> <span class="number">0</span>, minIdx = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> indexDifference; j &lt; nums.length; j++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> j - indexDifference;</span><br><span class="line">            <span class="keyword">if</span> (nums[i] &gt; nums[maxIdx]) &#123;</span><br><span class="line">                maxIdx = i;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nums[i] &lt; nums[minIdx]) &#123;</span><br><span class="line">                minIdx = i;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (nums[maxIdx] - nums[j] &gt;= valueDifference) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;maxIdx, j&#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (nums[j] - nums[minIdx] &gt;= valueDifference) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;minIdx, j&#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;-<span class="number">1</span>, -<span class="number">1</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>åˆ¤æ–­äºŒæ¬¡å¹‚ + lowBitæ“ä½œ</p><p>~x + 1 ç›¸å½“äº-x</p><p><a href="https://leetcode.cn/problems/minimum-impossible-or/">æœ€å°æ— æ³•å¾—åˆ°çš„æˆ–å€¼</a></p><h2 id="æ ‘å½¢DP"><a href="#æ ‘å½¢DP" class="headerlink" title="æ ‘å½¢DP"></a>æ ‘å½¢DP</h2><p>å¯è‡ªé¡¶å‘ä¸‹æ€è€ƒ -&gt; è®°å¿†åŒ–æœç´¢</p><p>å¯è‡ªé€’å‘ä¸Šæ€è€ƒ -&gt; æ ‘å½¢DP</p><p><a href="https://leetcode.cn/problems/maximum-points-after-collecting-coins-from-all-nodes/">æ”¶é›†æ‰€æœ‰é‡‘å¸å¯è·å¾—çš„æœ€å¤§ç§¯åˆ†</a></p><h2 id="å­åºåˆ—DP"><a href="#å­åºåˆ—DP" class="headerlink" title="å­åºåˆ—DP"></a>å­åºåˆ—DP</h2><p><a href="https://leetcode.cn/problems/longest-unequal-adjacent-groups-subsequence-ii/">æœ€é•¿ç›¸é‚»ä¸ç›¸ç­‰å­åºåˆ— II</a></p><mark class="hl-label DP">å­åºåˆ—</mark> <ul><li>å­åºåˆ— + ä¸è€ƒè™‘ç›¸é‚»å…ƒç´ ï¼šé€‰æˆ–ä¸é€‰ã€‚ä»£è¡¨é¢˜ç›®ï¼š<a href="https://leetcode.cn/problems/target-sum/">494. ç›®æ ‡å’Œï¼ˆ0-1 èƒŒåŒ…ï¼‰</a>ã€‚</li><li>å­åºåˆ— + è€ƒè™‘ç›¸é‚»å…ƒç´ ï¼šæšä¸¾é€‰å“ªä¸ªã€‚ä»£è¡¨é¢˜ç›®ï¼š<a href="https://leetcode.cn/problems/longest-increasing-subsequence/">300. æœ€é•¿é€’å¢å­åºåˆ—</a>ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getWordsInLongestSubsequence</span><span class="params">(<span class="type">int</span> n, String[] words, <span class="type">int</span>[] groups)</span> &#123;</span><br><span class="line">        List&lt;String&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span>(n == <span class="number">1</span>)&#123;</span><br><span class="line">            res.add(words[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span>[] dp = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">        <span class="type">int</span>[] from = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">        dp[n -<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">        from[n - <span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">maxId</span> <span class="operator">=</span> n - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> n - <span class="number">2</span>;i &gt;=<span class="number">0</span>;i--)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i + <span class="number">1</span>;j &lt; n;j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(dp[j] &gt; dp[i] &amp;&amp; groups[i] != groups[j] &amp;&amp; isDOne(words[i],words[j]))&#123;</span><br><span class="line">                    dp[i] = dp[j];</span><br><span class="line">                    from[i] = j;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            dp[i]++;</span><br><span class="line">            <span class="keyword">if</span>(dp[i] &gt; dp[maxId])&#123;</span><br><span class="line">                maxId = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> dp[maxId];</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;i &lt; size;i++)&#123;</span><br><span class="line">            res.add(words[maxId]);</span><br><span class="line">            maxId = from[maxId];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isDOne</span><span class="params">(String s, String t)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (s.length() != t.length()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">var</span> <span class="variable">diff</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; s.length(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s.charAt(i) != t.charAt(i)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (diff) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                diff = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> diff;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>0-1èƒŒåŒ…</p><p><a href="https://leetcode.cn/problems/length-of-the-longest-subsequence-that-sums-to-target/">å’Œä¸ºç›®æ ‡å€¼çš„æœ€é•¿å­åºåˆ—çš„é•¿åº¦</a></p><p>å­åºåˆ—DP é€‰æˆ–ä¸é€‰ + çŠ¶æ€æœºDP</p><p><a href="https://leetcode.cn/problems/minimum-increment-operations-to-make-array-beautiful/">ä½¿æ•°ç»„å˜ç¾çš„æœ€å°å¢é‡è¿ç®—æ•°</a></p><p>å•è°ƒé˜Ÿåˆ—ä¼˜åŒ–DP</p><p><a href="https://leetcode.cn/problems/constrained-subsequence-sum/">1425. å¸¦é™åˆ¶çš„å­åºåˆ—å’Œ</a></p><h2 id="å®Œå…¨èƒŒåŒ…"><a href="#å®Œå…¨èƒŒåŒ…" class="headerlink" title="å®Œå…¨èƒŒåŒ…"></a>å®Œå…¨èƒŒåŒ…</h2><p><a href="https://leetcode.cn/problems/count-of-sub-multisets-with-bounded-sum/">å’Œå¸¦é™åˆ¶çš„å­å¤šé‡é›†åˆçš„æ•°ç›®</a></p><p>æ–œç‡ä¼˜åŒ– + æ»šåŠ¨æ•°ç»„ + æ•°æ®èŒƒå›´ä¼˜åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="comment">// å¤šé‡èƒŒåŒ…</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">MOD</span> <span class="operator">=</span> (<span class="type">int</span>) <span class="number">1e9</span> + <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">countSubMultisets</span><span class="params">(List&lt;Integer&gt; nums, <span class="type">int</span> l, <span class="type">int</span> r)</span> &#123;</span><br><span class="line">        HashMap&lt;Integer, Integer&gt; cnt = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> x : nums) &#123;</span><br><span class="line">            cnt.merge(x, <span class="number">1</span>, Integer::sum);</span><br><span class="line">            sum += x;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sum &lt; l) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r = Math.min(r, sum);</span><br><span class="line">        <span class="type">int</span>[] dp = <span class="keyword">new</span> <span class="title class_">int</span>[r + <span class="number">1</span>];</span><br><span class="line">        dp[<span class="number">0</span>] = cnt.getOrDefault(<span class="number">0</span>, <span class="number">0</span>) + <span class="number">1</span>;</span><br><span class="line">        cnt.remove(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">curMax</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Integer, Integer&gt; e : cnt.entrySet()) &#123;</span><br><span class="line">            <span class="comment">// æ•°å­—</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> e.getKey();</span><br><span class="line">            <span class="comment">// æ¬¡æ•°</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> e.getValue();</span><br><span class="line">            curMax = Math.min(curMax + x * c, r);</span><br><span class="line">            <span class="type">int</span>[] newDp = dp.clone();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> x; i &lt;= curMax; i++) &#123;</span><br><span class="line">                newDp[i] = (newDp[i] + newDp[i - x]) % MOD;</span><br><span class="line">                <span class="keyword">if</span> (i - (c + <span class="number">1</span>) * x &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    newDp[i] = (newDp[i] - dp[i - (c + <span class="number">1</span>) * x] + MOD) % MOD;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            dp = newDp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> l; i &lt;= r; ++i) &#123;</span><br><span class="line">            ans = (ans + dp[i]) % MOD;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ‹“å±•æ¬§å‡ é‡Œå¾—exgcd"><a href="#æ‹“å±•æ¬§å‡ é‡Œå¾—exgcd" class="headerlink" title="æ‹“å±•æ¬§å‡ é‡Œå¾—exgcd"></a>æ‹“å±•æ¬§å‡ é‡Œå¾—exgcd</h2><p>æ±‚è§£ä¸å®šæ–¹ç¨‹ ax + by = c</p><p><a href="https://leetcode.cn/problems/minimum-number-of-groups-to-create-a-valid-assignment/">åˆæ³•åˆ†ç»„çš„æœ€å°‘ç»„æ•°</a></p><h2 id="ç»Ÿè®¡æ‰€æœ‰å­æ•°ç»„"><a href="#ç»Ÿè®¡æ‰€æœ‰å­æ•°ç»„" class="headerlink" title="ç»Ÿè®¡æ‰€æœ‰å­æ•°ç»„"></a>ç»Ÿè®¡æ‰€æœ‰å­æ•°ç»„</h2><p><a href="https://leetcode.cn/problems/total-appeal-of-a-string/">å­—ç¬¦ä¸²çš„æ€»å¼•åŠ›</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">    ä½¿ç”¨å˜åŒ–é‡æ¥æ€è€ƒ</span></span><br><span class="line"><span class="comment">    ç¤ºä¾‹ï¼š</span></span><br><span class="line"><span class="comment">    C   A   B   A   D   A</span></span><br><span class="line"><span class="comment">    1</span></span><br><span class="line"><span class="comment">    2   1</span></span><br><span class="line"><span class="comment">    3   2   1</span></span><br><span class="line"><span class="comment">    2   1   2   1</span></span><br><span class="line"><span class="comment">    3   2   3   2   1</span></span><br><span class="line"><span class="comment">    3   2   2   1   2   1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p><a href="https://leetcode.cn/problems/count-unique-characters-of-all-substrings-of-a-given-string/">ç»Ÿè®¡å­ä¸²ä¸­çš„å”¯ä¸€å­—ç¬¦</a></p><hr><h2 id="01å­—å…¸æ ‘"><a href="#01å­—å…¸æ ‘" class="headerlink" title="01å­—å…¸æ ‘"></a>01å­—å…¸æ ‘</h2><p><a href="https://leetcode.cn/problems/maximum-strong-pair-xor-ii/">æ‰¾å‡ºå¼ºæ•°å¯¹çš„æœ€å¤§å¼‚æˆ–å€¼ II</a></p><p>é‡åˆ°ç»å¯¹å€¼è¦æƒ³åˆ°æ’åºæ‹†ç»å¯¹å€¼ </p><p>æ»‘åŠ¨çª—å£ + ä»å­—å…¸æ ‘ä¸­åˆ é™¤ + å­æ•°ç»„æœ€å¤§å¼‚æˆ–<a href="https://leetcode.cn/problems/maximum-xor-of-two-numbers-in-an-array/">421. æ•°ç»„ä¸­ä¸¤ä¸ªæ•°çš„æœ€å¤§å¼‚æˆ–å€¼</a></p><hr><h2 id="å®¹æ–¥å®šç†"><a href="#å®¹æ–¥å®šç†" class="headerlink" title="å®¹æ–¥å®šç†"></a>å®¹æ–¥å®šç†</h2><p><a href="https://leetcode.cn/problems/distribute-candies-among-children-ii/">ç»™å°æœ‹å‹ä»¬åˆ†ç³–æœ II</a></p><p><a href="https://leetcode.cn/problems/number-of-strings-which-can-be-rearranged-to-contain-substring/">é‡æ–°æ’åˆ—ååŒ…å«æŒ‡å®šå­å­—ç¬¦ä¸²çš„å­—ç¬¦ä¸²æ•°ç›®</a></p>]]></content>
    
    
    <summary type="html">LeetCodeå‘¨èµ›</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>æœ€çŸ­è·¯ç®—æ³•</title>
    <link href="https://wuwawawa.github.io/posts/5697d1d5.html"/>
    <id>https://wuwawawa.github.io/posts/5697d1d5.html</id>
    <published>2023-09-26T06:13:22.000Z</published>
    <updated>2023-10-01T09:00:02.859Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230926155902091.png" alt="image-20230926155902091"></p><h2 id="Dijkstraç®—æ³•"><a href="#Dijkstraç®—æ³•" class="headerlink" title="Dijkstraç®—æ³•"></a>Dijkstraç®—æ³•</h2><p>Dijkstraæœ¬è´¨ä¸Šæ˜¯ä¸€ç§è´ªå¿ƒç®—æ³•ï¼Œé€šè¿‡ä¸æ–­è°ƒæ•´æ¯ä¸ªç‚¹çš„â€œå½“å‰è·ç¦»â€æœ€ç»ˆå¾—åˆ°æœ€ä¼˜ç»“æœã€‚</p><p>å‡è®¾ç°åœ¨è¦æ±‚å‡ºä»æŸä¸€ç‚¹såˆ°å…¶ä»–æ‰€æœ‰ç‚¹çš„æœ€çŸ­è·ç¦»ï¼Œå¯¹äºæ¯ä¸ªç‚¹vå‡ç»´æŠ¤ä¸€ä¸ªâ€œå½“å‰è·ç¦»â€ï¼ˆdist[v]ï¼‰å’Œâ€œæ˜¯å¦è®¿é—®è¿‡â€(visited[v])ã€‚é¦–å…ˆå°†dist[s]åˆå§‹åŒ–ä¸º0ï¼Œå°†å…¶ä»–ç‚¹çš„è·ç¦»åˆå§‹åŒ–ä¸ºæ— ç©·ï¼Œå¹¶å°†æ‰€æœ‰ç‚¹åˆå§‹åŒ–ä¸ºæœªè®¿é—®çš„ã€‚è®°u-&gt;vçš„è¾¹æƒä¸ºweight[u-&gt;v]ã€‚ç„¶åè¿›è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p><ol><li>ä»æ‰€æœ‰æœªè®¿é—®çš„ç‚¹ä¸­ï¼Œæ‰¾å‡ºå½“å‰è·ç¦»æœ€å°çš„ï¼Œè®¾ä¸ºuï¼Œå¹¶å°†å…¶æ ‡è®°ä¸ºå·²è®¿é—®çš„ã€‚</li><li>è°ƒæ•´uçš„æ‰€æœ‰è¾¹ï¼ˆè‹¥æ˜¯æœ‰å‘å›¾åˆ™ä¸ºå‡ºè¾¹ï¼‰è¿æ¥çš„å¹¶ä¸”<strong>æœªè¢«è®¿é—®è¿‡çš„</strong>ç‚¹ï¼šè‹¥weight[u-&gt;v] + dist[u] &lt; dist[v], åˆ™å°†dist[v]æ›´æ–°ä¸ºdist[u]+weight[u-&gt;v]ã€‚</li><li>é‡å¤1å’Œ2æ­¥éª¤ï¼Œç›´åˆ°æ‰€æœ‰ç‚¹éƒ½è¢«æ ‡è®°ä¸ºå·²è®¿é—®çš„ï¼Œåˆ™dist[i]å³såˆ°içš„æœ€çŸ­è·ç¦»ã€‚å¦‚æœåªæƒ³æ±‚ä»såˆ°æŸä¸€ç‚¹çš„æœ€çŸ­è·ç¦»ï¼Œé‚£ä¹ˆå½“è¯¥ç‚¹è¢«æ ‡è®°ä¸ºè®¿é—®è¿‡ä¹‹åå¯ç›´æ¥é€€å‡ºã€‚</li><li>è¡¥å……ï¼šå¦‚æœé™¤äº†æœ€çŸ­è·ç¦»ä¹‹å¤–è¿˜æƒ³æ±‚å‡ºå…·ä½“çš„è·¯å¾„ï¼Œåªéœ€å»ºç«‹ä¸€ä¸ªpreæ•°ç»„ï¼Œåœ¨æ­¥éª¤2åæ·»åŠ æ“ä½œï¼špre[v] = uï¼ˆå‰ææ˜¯dist[v]è¢«æ›´æ–°ï¼‰ã€‚</li></ol><div class="tabs" id="e1220ca0-3a93-4dc3-aaa1-66a274d0966f"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e1220ca0-3a93-4dc3-aaa1-66a274d0966f-1"><i class="fas fa-seedling"></i>é‚»æ¥çŸ©é˜µ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e1220ca0-3a93-4dc3-aaa1-66a274d0966f-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> <span class="number">110</span>, M = <span class="number">6010</span>;</span><br><span class="line">    <span class="comment">// é‚»æ¥çŸ©é˜µæ•°ç»„ï¼šw[a][b] = c ä»£è¡¨ä» a åˆ° b æœ‰æƒé‡ä¸º c çš„è¾¹</span></span><br><span class="line">    <span class="type">int</span>[][] w = <span class="keyword">new</span> <span class="title class_">int</span>[N][N];</span><br><span class="line">    <span class="comment">// dist[x] = y ä»£è¡¨ä»ã€Œæºç‚¹/èµ·ç‚¹ã€åˆ° x çš„æœ€çŸ­è·ç¦»ä¸º y</span></span><br><span class="line">    <span class="type">int</span>[] dist = <span class="keyword">new</span> <span class="title class_">int</span>[N];</span><br><span class="line">    <span class="comment">// è®°å½•å“ªäº›ç‚¹å·²ç»è¢«æ›´æ–°è¿‡</span></span><br><span class="line">    <span class="type">boolean</span>[] vis = <span class="keyword">new</span> <span class="title class_">boolean</span>[N];</span><br><span class="line">    <span class="type">int</span> <span class="variable">INF</span> <span class="operator">=</span> <span class="number">0x3f3f3f3f</span>;</span><br><span class="line">    <span class="type">int</span> n, src;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(<span class="type">int</span>[][] conn)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–é‚»æ¥çŸ©é˜µ</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= n; j++) &#123;</span><br><span class="line">                w[i][j] = w[j][i] = i == j ? <span class="number">0</span> : INF;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å­˜å›¾</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span>[] t : conn) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">u</span> <span class="operator">=</span> t[<span class="number">0</span>], v = t[<span class="number">1</span>], c = t[<span class="number">2</span>];</span><br><span class="line">            w[u][v] = c;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æœ€çŸ­è·¯</span></span><br><span class="line">        dijkstra();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">dijkstra</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// èµ·å§‹å…ˆå°†æ‰€æœ‰çš„ç‚¹æ ‡è®°ä¸ºã€Œæœªæ›´æ–°ã€å’Œã€Œè·ç¦»ä¸ºæ­£æ— ç©·ã€</span></span><br><span class="line">        Arrays.fill(vis, <span class="literal">false</span>);</span><br><span class="line">        Arrays.fill(dist, INF);</span><br><span class="line">        <span class="comment">// åªæœ‰èµ·ç‚¹æœ€çŸ­è·ç¦»ä¸º 0</span></span><br><span class="line">        dist[k] = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// è¿­ä»£ n æ¬¡</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">p</span> <span class="operator">=</span> <span class="number">1</span>; p &lt;= n; p++) &#123;</span><br><span class="line">            <span class="comment">// æ¯æ¬¡æ‰¾åˆ°ã€Œæœ€çŸ­è·ç¦»æœ€å°ã€ä¸”ã€Œæœªè¢«æ›´æ–°ã€çš„ç‚¹ t</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">t</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!vis[i] &amp;&amp; (t == -<span class="number">1</span> || dist[i] &lt; dist[t])) t = i;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ ‡è®°ç‚¹ t ä¸ºå·²æ›´æ–°</span></span><br><span class="line">            vis[t] = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// ç”¨ç‚¹ t çš„ã€Œæœ€å°è·ç¦»ã€æ›´æ–°å…¶ä»–ç‚¹</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">                dist[i] = Math.min(dist[i], dist[t] + w[t][i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="Floydç®—æ³•"><a href="#Floydç®—æ³•" class="headerlink" title="Floydç®—æ³•"></a>Floydç®—æ³•</h2><p>åŠ¨æ€è§„åˆ’</p><p><code>dp[i][j]</code> è¡¨ç¤º <code>i-&gt;j</code> çš„æœ€çŸ­è·ç¦»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; n; k++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">            dp[i][j] = Math.min(dp[i][j], dp[i][k] + dp[k][j]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å€Ÿç”¨åˆ«çš„ç‚¹æ±‚è§£</p>]]></content>
    
    
    <summary type="html">Dijkstra + SPFA + Bellman-Ford + Floyd</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>å·®åˆ†æ•°ç»„</title>
    <link href="https://wuwawawa.github.io/posts/f4bb8efc.html"/>
    <id>https://wuwawawa.github.io/posts/f4bb8efc.html</id>
    <published>2023-09-25T06:45:09.000Z</published>
    <updated>2023-09-25T09:37:30.614Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h2><p>åœ¨ä»‹ç»å·®åˆ†æ•°ç»„ä¹‹å‰ï¼Œå…ˆå›é¡¾ä¸€ä¸‹ã€Œå‰ç¼€å’Œæ•°ç»„ã€</p><p>å‰ç¼€å’Œä¸»è¦é€‚ç”¨çš„åœºæ™¯æ˜¯åŸå§‹æ•°ç»„ä¸ä¼šè¢«ä¿®æ”¹çš„æƒ…å†µä¸‹ï¼Œé¢‘ç¹æŸ¥è¯¢æŸä¸ªåŒºé—´çš„ç´¯åŠ å’Œ</p><p>å·®åˆ†æ•°ç»„çš„ä¸»è¦é€‚ç”¨åœºæ™¯æ˜¯é¢‘ç¹å¯¹åŸå§‹æ•°ç»„çš„æŸä¸ªåŒºé—´çš„å…ƒç´ è¿›è¡Œå¢å‡</p><p>ä½¿ç”¨åœºæ™¯ï¼šå¯¹äºä¸€ä¸ªæ•°ç»„ <code>nums[]</code></p><ul><li>è¦æ±‚ä¸€ï¼šå¯¹ <code>num[2...4]</code> å…¨éƒ¨ + 1</li><li>è¦æ±‚äºŒï¼šå¯¹ <code>num[1...3]</code> å…¨éƒ¨ - 3</li><li>è¦æ±‚ä¸‰ï¼šå¯¹ <code>num[0...4]</code> å…¨éƒ¨ + 9</li></ul><p>çœ‹åˆ°ä¸Šè¿°æƒ…æ™¯ï¼Œé¦–å…ˆæƒ³åˆ°çš„è‚¯å®šæ˜¯éå†ï¼ˆbao liï¼‰ã€‚ç›´æ¥å¯¹æ•°ç»„å¾ªç¯ 3 éï¼Œæ¯æ¬¡åœ¨è§„å®šçš„åŒºé—´ä¸ŠæŒ‰è¦æ±‚è¿›è¡Œæ“ä½œï¼Œæ­¤æ—¶æ—¶é—´å¤æ‚åº¦O(3n)</p><p>ä½†æ˜¯å½“è¿™æ ·çš„æ“ä½œå˜å¾—é¢‘ç¹åï¼Œæ—¶é—´å¤æ‚åº¦ä¹Ÿå‘ˆçº¿æ€§é€’å¢</p><p>æ‰€ä»¥é’ˆå¯¹è¿™ç§åœºæ™¯ï¼Œæå‡ºäº†ã€Œå·®åˆ†æ•°ç»„ã€çš„æ¦‚å¿µï¼Œä¸¾ä¸ªç®€å•çš„ä¾‹å­</p><p><img src="https://pic.leetcode-cn.com/1649302054-sjfBPU-1036101649298970IqiB0Himage-20220407103610070.png" alt="1036101649298970IqiB0Himage-20220407103610070.png"></p><p><code>diff[]</code> å’Œ <code>nums[]</code> çš„å…³ç³»ï¼š<code>diff[i] = nums[i] - nums[i - 1]</code>ï¼Œ<code>diff[0]</code> é™¤å¤–</p><hr><h2 id="ä½¿ç”¨å¥½å¤„"><a href="#ä½¿ç”¨å¥½å¤„" class="headerlink" title="ä½¿ç”¨å¥½å¤„"></a>ä½¿ç”¨å¥½å¤„</h2><p>å½“æˆ‘ä»¬éœ€è¦å¯¹ <code>nums[]</code> è¿›è¡Œä¸Šè¿°ä¸‰ä¸ªè¦æ±‚æ—¶ï¼Œä¸éœ€è¦ä¸€æ¬¡ä¸€æ¬¡çš„éå†æ•´ä¸ªæ•°ç»„äº†ï¼Œè€Œåªéœ€è¦å¯¹ <code>diff[]</code> è¿›è¡Œä¸€æ¬¡ <code>O(1)</code> çš„æ“ä½œå³å¯</p><ul><li>è¦æ±‚ä¸€ï¼šå¯¹ <code>num[2...4]</code> å…¨éƒ¨ + 1  -&gt; <code>diff[2] += 1</code></li><li>è¦æ±‚äºŒï¼šå¯¹ <code>num[1...3]</code> å…¨éƒ¨ - 3  -&gt; <code>diff[1] += (-3); diff[3 + 1] -= (-3)</code> </li><li>è¦æ±‚ä¸‰ï¼šå¯¹ <code>num[0...4]</code> å…¨éƒ¨ + 9  -&gt; <code>diff[0] += 9</code></li></ul><p>æ€»ç»“ï¼šå¯¹äºæ”¹å˜åŒºé—´ <code>[i, j]</code> çš„å€¼ï¼Œåªéœ€è¦è¿›è¡Œå¦‚ä¸‹æ“ä½œ <code>diff[i] += val; diff[j + 1] -= val</code></p><p><strong>æ³¨</strong>ï¼šå½“ <code>j + 1 &gt;= diff.length</code> æ—¶ï¼Œä¸éœ€è¦è¿›è¡Œ <code>diff[j + 1] -= val</code> æ“ä½œ</p><hr><h2 id="è¿˜åŸæ•°æ®"><a href="#è¿˜åŸæ•°æ®" class="headerlink" title="è¿˜åŸæ•°æ®"></a>è¿˜åŸæ•°æ®</h2><p>æ€ä¹ˆé€šè¿‡ <code>diff[]</code> å¾—åˆ°æ›´æ–°åçš„æ•°ç»„å‘¢ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤åŸæ“ä½œ</span></span><br><span class="line"><span class="type">int</span>[] res = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line"><span class="comment">// ä¸‹æ ‡ä¸º 0 çš„å…ƒç´ ç›¸ç­‰</span></span><br><span class="line">res[<span class="number">0</span>] = diff[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">    res[i] = diff[i] + res[i - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="diff-åŸç†"><a href="#diff-åŸç†" class="headerlink" title="diff[] åŸç†"></a>diff[] åŸç†</h2><p>è¿˜åŸæ•°æ®å°±ç›¸å½“äºå¯¹diffæ•°ç»„æ±‚ä¸€ä¸ªå‰ç¼€å’Œã€‚</p><p>å½“æˆ‘ä»¬éœ€è¦å¯¹åŒºé—´ <code>[i, j]</code> è¿›è¡Œ <code>+ val</code> æ“ä½œæ—¶ï¼Œæˆ‘ä»¬å¯¹ <code>diff[i] += val; diff[j + 1] -= val;</code></p><p>åœ¨å¤åŸæ“ä½œæ—¶ï¼Œå½“æˆ‘ä»¬æ±‚ <code>res[i]</code> æ—¶ï¼Œ<code>res[i - 1]</code> æ²¡æœ‰å˜ï¼Œè€Œ <code>diff[i]</code> å¢åŠ äº† 3ï¼Œæ‰€ä»¥ <code>res[i]</code> å¢åŠ  3</p><p>å½“æˆ‘ä»¬æ±‚ <code>res[i + 1]</code> æ—¶ï¼Œ<code>res[i]</code> å¢åŠ äº† 3ï¼Œè€Œ <code>diff[i + 1]</code> æ²¡æœ‰å˜ï¼Œæ•… <code>res[i + 1] = diff[i + 1] + res[i]</code> å¢åŠ  3ã€‚å³ï¼šè™½ç„¶ <code>diff[i + 1]</code> æ²¡æœ‰å˜ï¼Œä½†æ˜¯ <code>res[i]</code> å¯¹åé¢çš„ <code>res[i + 1]</code> æœ‰ä¸€ä¸ªç´¯ç§¯ä½œç”¨</p><p>å½“æˆ‘ä»¬æ±‚ <code>res[j + 1]</code> æ—¶ï¼Œ<code>res[j]</code> å¢åŠ äº† 3ï¼Œè€Œ <code>diff[j + 1]</code> å‡å°‘äº† 3ï¼Œæ•… <code>res[j + 1] = diff[j + 1] + res[j]</code> å¢åŠ æ²¡æœ‰å˜ã€‚å³ï¼šæˆ‘ä»¬åœ¨ j + 1 çš„æ—¶å€™ï¼ŒæŠŠä¸Šè¿°çš„ç´¯ç§¯ä½œç”¨å»é™¤äº†ï¼Œæ‰€ä»¥ j + 1 åé¢çš„å…ƒç´ ä¸å—å½±å“</p><hr><h2 id="å®Œæ•´æ¨¡ç‰ˆ"><a href="#å®Œæ•´æ¨¡ç‰ˆ" class="headerlink" title="å®Œæ•´æ¨¡ç‰ˆ"></a>å®Œæ•´æ¨¡ç‰ˆ</h2><p>å·®åˆ†æ•°ç»„ä¹Ÿå¯ä»¥ä¸ç”¨åŸæ•°ç»„è¿›è¡Œåˆå§‹åŒ–ï¼Œä½¿ç”¨å…¨ä¸º0çš„å…ƒç´ è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™æ ·å¾—åˆ°çš„ç»“æœæ•°ç»„å°±æ˜¯åç§»æ•°ç»„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Difference</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å·®åˆ†æ•°ç»„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span>[] diff;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–å·®åˆ†æ•°ç»„</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nums nums</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Difference</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span> nums.length &gt; <span class="number">0</span>;</span><br><span class="line">        diff = <span class="keyword">new</span> <span class="title class_">int</span>[nums.length];</span><br><span class="line">        diff[<span class="number">0</span>] = nums[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">            diff[i] = nums[i] - nums[i - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¯¹åŒºé—´ [i, j] å¢åŠ  valï¼ˆval å¯ä¸ºè´Ÿæ•°ï¼‰</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> i i</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> j j</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> val val</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j, <span class="type">int</span> val)</span> &#123;</span><br><span class="line">        diff[i] += val;</span><br><span class="line">        <span class="keyword">if</span> (j + <span class="number">1</span> &lt; diff.length) &#123;</span><br><span class="line">            diff[j + <span class="number">1</span>] -= val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤åŸæ“ä½œ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> res</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span>[] result() &#123;</span><br><span class="line">        <span class="type">int</span>[] res = <span class="keyword">new</span> <span class="title class_">int</span>[diff.length];</span><br><span class="line">        res[<span class="number">0</span>] = diff[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; diff.length; i++) &#123;</span><br><span class="line">            res[i] = res[i - <span class="number">1</span>] + diff[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">å·®åˆ†æ•°ç»„</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>ç­›è´¨æ•°</title>
    <link href="https://wuwawawa.github.io/posts/996e4f07.html"/>
    <id>https://wuwawawa.github.io/posts/996e4f07.html</id>
    <published>2023-09-19T00:51:18.000Z</published>
    <updated>2023-12-09T12:25:39.835Z</updated>
    
    <content type="html"><![CDATA[<p>ç»Ÿè®¡ [2,n] ä¸­è´¨æ•°çš„æ•°é‡æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„é¢˜ç›®ï¼Œä¹Ÿæœ‰å¾ˆå¤šå·§å¦™é«˜æ•ˆçš„åšæ³•ï¼Œæ¥ä¸‹æ¥çš„éƒ¨åˆ†åªä¼šè®²è¿°ä¸€äº›å¸¸è§çš„åšæ³•ã€‚</p><h2 id="æšä¸¾"><a href="#æšä¸¾" class="headerlink" title="æšä¸¾"></a>æšä¸¾</h2><p>å¾ˆç›´è§‚çš„æ€è·¯æ˜¯æˆ‘ä»¬æšä¸¾æ¯ä¸ªæ•°åˆ¤æ–­å…¶æ˜¯ä¸æ˜¯è´¨æ•°ã€‚</p><p>è€ƒè™‘è´¨æ•°çš„å®šä¹‰ï¼šåœ¨å¤§äº 1 çš„è‡ªç„¶æ•°ä¸­ï¼Œé™¤äº† 1 å’Œå®ƒæœ¬èº«ä»¥å¤–ä¸å†æœ‰å…¶ä»–å› æ•°çš„è‡ªç„¶æ•°ã€‚å› æ­¤å¯¹äºæ¯ä¸ªæ•° xï¼Œæˆ‘ä»¬å¯ä»¥ä»å°åˆ°å¤§æšä¸¾ [2,x-1] ä¸­çš„æ¯ä¸ªæ•° yï¼Œåˆ¤æ–­ y æ˜¯å¦ä¸º x çš„å› æ•°ã€‚ä½†è¿™æ ·åˆ¤æ–­ä¸€ä¸ªæ•°æ˜¯å¦ä¸ºè´¨æ•°çš„æ—¶é—´å¤æ‚åº¦æœ€å·®æƒ…å†µä¸‹ä¼šåˆ° O(n)ï¼Œæ— æ³•é€šè¿‡æ‰€æœ‰æµ‹è¯•æ•°æ®ã€‚</p><p>è€ƒè™‘åˆ°å¦‚æœ y æ˜¯ x çš„å› æ•°ï¼Œé‚£ä¹ˆ x/y ä¹Ÿå¿…ç„¶æ˜¯x çš„å› æ•°ï¼Œå› æ­¤æˆ‘ä»¬åªè¦æ ¡éªŒ y æˆ–è€… x/y ã€‚ä¸éš¾å‘ç°æˆ‘ä»¬åªéœ€è¦æšä¸¾ [2,$\sqrt{x}$]å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">countPrimes</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        ans += isPrime(i) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isPrime</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>; i * i &lt;= x; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (x % i == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤æ‚åº¦åˆ†æï¼š</p><ul><li><p>æ—¶é—´å¤æ‚åº¦O(n$\sqrt{n}$)ã€‚å•ä¸ªæ•°æ£€æŸ¥çš„æ—¶é—´å¤æ‚åº¦ä¸ºO($\sqrt{n}$)ï¼Œä¸€å…±è¦æ£€æŸ¥nä¸ªæ•°ã€‚</p></li><li><p>ç©ºé—´å¤æ‚åº¦O(1)</p></li></ul><hr><hr><h2 id="åŸƒæ°ç­›"><a href="#åŸƒæ°ç­›" class="headerlink" title="åŸƒæ°ç­›"></a>åŸƒæ°ç­›</h2><p>æšä¸¾æ²¡æœ‰è€ƒè™‘åˆ°æ•°ä¸æ•°çš„å…³è”æ€§ï¼Œå› æ­¤éš¾ä»¥å†ç»§ç»­ä¼˜åŒ–æ—¶é—´å¤æ‚åº¦ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç»ä¸€ä¸ªå¸¸è§çš„ç®—æ³•ï¼Œè¯¥ç®—æ³•ç”±å¸Œè…Šæ•°å­¦å®¶å„æ‹‰å¤šå¡æå‡ºï¼Œç§°ä¸ºå„æ‹‰å¤šå¡ç­›æ³•ï¼Œç®€ç§°åŸƒæ°ç­›ã€‚</p><p>æˆ‘ä»¬è€ƒè™‘è¿™æ ·ä¸€ä¸ªäº‹å®ï¼šå¦‚æœ x æ˜¯è´¨æ•°ï¼Œé‚£ä¹ˆå¤§äº x çš„ x çš„å€æ•° 2x,3x,â€¦â€¦ ä¸€å®šä¸æ˜¯è´¨æ•°ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä»è¿™é‡Œå…¥æ‰‹ã€‚</p><p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ•°ç»„ isPrime[n] , å…¶ä¸­ isPrime[i] è¡¨ç¤ºæ•° i æ˜¯ä¸æ˜¯è´¨æ•°ã€‚å¦‚æœæ˜¯è´¨æ•°åˆ™ä¸º 0 ï¼Œå¦åˆ™ä¸º 1 ã€‚</p><p>ä»å°åˆ°å¤§éå†æ¯ä¸ªæ•°ï¼Œå¦‚æœè¿™ä¸ªæ•°ä¸ºè´¨æ•°ï¼Œåˆ™å°†å…¶æ‰€æœ‰å€æ•°éƒ½æ ‡è®°ä¸ºåˆæ•°ï¼ˆé™¤äº†è¯¥è´¨æ•°æœ¬èº«ï¼‰ï¼Œè¿™æ ·åœ¨è¿è¡Œç»“æŸçš„æ—¶å€™æˆ‘ä»¬å°±èƒ½çŸ¥é“è´¨æ•°çš„ä¸ªæ•°ã€‚</p><p>å½“ç„¶è¿™é‡Œè¿˜å¯ä»¥ç»§ç»­ä¼˜åŒ–ï¼Œå¯¹äºä¸€ä¸ªè´¨æ•° xï¼Œå¦‚æœæŒ‰ä¸Šæ–‡è¯´çš„æˆ‘ä»¬ä» 2x å¼€å§‹æ ‡è®°å…¶å®æ˜¯å†—ä½™çš„ï¼Œåº”è¯¥ç›´æ¥ä» xâ‹…x å¼€å§‹æ ‡è®°ï¼Œå› ä¸º 2x,3x,â€¦è¿™äº›æ•°ä¸€å®šåœ¨ x ä¹‹å‰å°±è¢«å…¶ä»–æ•°çš„å€æ•°æ ‡è®°è¿‡äº†ï¼Œä¾‹å¦‚ 2 çš„æ‰€æœ‰å€æ•°ï¼Œ3 çš„æ‰€æœ‰å€æ•°ç­‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">countPrimes</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="type">int</span>[] isPrime = <span class="keyword">new</span> <span class="title class_">int</span>[n + <span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isPrime[i] == <span class="number">0</span>) &#123;</span><br><span class="line">            ans += <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> ((<span class="type">long</span>) i * i &lt;= n) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i * i; j &lt;= n; j += i) &#123;</span><br><span class="line">                    isPrime[j] = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤æ‚åº¦åˆ†æï¼š</p><ul><li>æ—¶é—´å¤æ‚åº¦O(nloglog n)ã€‚</li><li>ç©ºé—´å¤æ‚åº¦O(n)</li></ul><hr><hr><h2 id="çº¿æ€§ç­›"><a href="#çº¿æ€§ç­›" class="headerlink" title="çº¿æ€§ç­›"></a>çº¿æ€§ç­›</h2><p>åŸƒæ°ç­›å…¶å®è¿˜æ˜¯å­˜åœ¨å†—ä½™çš„æ ‡è®°æ“ä½œï¼Œæ¯”å¦‚å¯¹äº 45 è¿™ä¸ªæ•°ï¼Œå®ƒä¼šåŒæ—¶è¢« 3,5 ä¸¤ä¸ªæ•°æ ‡è®°ä¸ºåˆæ•°ï¼Œå› æ­¤æˆ‘ä»¬ä¼˜åŒ–çš„ç›®æ ‡æ˜¯è®©æ¯ä¸ªåˆæ•°åªè¢«æ ‡è®°ä¸€æ¬¡ï¼Œè¿™æ ·æ—¶é—´å¤æ‚åº¦å³èƒ½ä¿è¯ä¸º O(n)ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦ä»‹ç»çš„çº¿æ€§ç­›ã€‚</p><p>ç›¸è¾ƒäºåŸƒæ°ç­›ï¼Œæˆ‘ä»¬å¤šç»´æŠ¤ä¸€ä¸ª primes æ•°ç»„è¡¨ç¤ºå½“å‰å¾—åˆ°çš„è´¨æ•°é›†åˆã€‚æˆ‘ä»¬ä»å°åˆ°å¤§éå†ï¼Œå¦‚æœå½“å‰çš„æ•° x æ˜¯è´¨æ•°ï¼Œå°±å°†å…¶åŠ å…¥ primes æ•°ç»„ã€‚</p><p>å¦ä¸€ç‚¹ä¸åŸƒæ°ç­›ä¸åŒçš„æ˜¯ï¼Œã€Œæ ‡è®°è¿‡ç¨‹ã€ä¸å†ä»…å½“ x ä¸ºè´¨æ•°æ—¶æ‰è¿›è¡Œï¼Œè€Œæ˜¯å¯¹æ¯ä¸ªæ•´æ•° x éƒ½è¿›è¡Œã€‚å¯¹äºæ•´æ•° xï¼Œæˆ‘ä»¬ä¸å†æ ‡è®°å…¶æ‰€æœ‰çš„å€æ•° xâ‹…x,xâ‹…(x+1),â€¦ï¼Œè€Œæ˜¯åªæ ‡è®°è´¨æ•°é›†åˆä¸­çš„æ•°ä¸ x ç›¸ä¹˜çš„æ•°ï¼Œå³ xâ‹…primes[0], xâ‹…primes[1] â€¦.. ï¼Œä¸”åœ¨å‘ç° x mod primes[i] = 0 çš„æ—¶å€™ç»“æŸå½“å‰æ ‡è®°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">countPrimes</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    List&lt;Integer&gt; primes = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">int</span>[] isPrime = <span class="keyword">new</span> <span class="title class_">int</span>[n + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isPrime[i] == <span class="number">0</span>) &#123;</span><br><span class="line">            primes.add(i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> prime : primes) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i * prime &gt; n) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            isPrime[i * prime] = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (i % prime == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> primes.size();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="é¢„å¤„ç†è´¨æ•°"><a href="#é¢„å¤„ç†è´¨æ•°" class="headerlink" title="é¢„å¤„ç†è´¨æ•°"></a>é¢„å¤„ç†è´¨æ•°</h2><p>åœ¨æœ‰äº›é¢˜ç›®ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é¢„å¤„ç†è´¨æ•°ï¼Œçœå»ä¸€äº›é‡å¤è®¡ç®—ã€‚</p><div class="tabs" id="c23a3bbc-d05e-4e05-abcf-62948c072c4e"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c23a3bbc-d05e-4e05-abcf-62948c072c4e-1"><i class="fas fa-cat"></i>åŸƒæ°ç­›é¢„å¤„ç†</button></li><li class="tab"><button type="button" data-href="#c23a3bbc-d05e-4e05-abcf-62948c072c4e-2"><i class="fas fa-horse"></i>çº¿æ€§ç­›é¢„å¤„ç†</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c23a3bbc-d05e-4e05-abcf-62948c072c4e-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MX</span> <span class="operator">=</span> (<span class="type">int</span>) <span class="number">1e6</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> ArrayList&lt;Integer&gt; primes = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="comment">// 0 è¡¨ç¤ºæ˜¯è´¨æ•° 1 è¡¨ç¤ºæ˜¯åˆæ•°</span></span><br><span class="line">    <span class="type">int</span>[] isPrime = <span class="keyword">new</span> <span class="title class_">int</span>[MX + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>; i &lt;= MX; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isPrime[i] == <span class="number">0</span>) &#123;</span><br><span class="line">            primes.add(i);</span><br><span class="line">            <span class="keyword">if</span> ((<span class="type">long</span>) i * i &lt;= MX) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i * i; j &lt;= MX; j += i) &#123;</span><br><span class="line">                    isPrime[j] = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c23a3bbc-d05e-4e05-abcf-62948c072c4e-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MX</span> <span class="operator">=</span> (<span class="type">int</span>) <span class="number">1e6</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> ArrayList&lt;Integer&gt; primes = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="comment">// 0 è¡¨ç¤ºæ˜¯è´¨æ•° 1 è¡¨ç¤ºæ˜¯åˆæ•°</span></span><br><span class="line">    <span class="type">int</span>[] isPrime = <span class="keyword">new</span> <span class="title class_">int</span>[MX + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>; i &lt;= MX; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isPrime[i] == <span class="number">0</span>) &#123;</span><br><span class="line">            primes.add(i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> prime : primes) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i * prime &gt; MX) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            isPrime[i * prime] = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (i % prime == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>]]></content>
    
    
    <summary type="html">æšä¸¾ã€åŸƒæ°ç­›ã€çº¿æ€§ç­›</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>å¹¶æŸ¥é›†</title>
    <link href="https://wuwawawa.github.io/posts/c517589e.html"/>
    <id>https://wuwawawa.github.io/posts/c517589e.html</id>
    <published>2023-09-14T01:33:46.000Z</published>
    <updated>2023-10-02T07:45:43.813Z</updated>
    
    <content type="html"><![CDATA[<h2 id="åŸºæœ¬åŸç†"><a href="#åŸºæœ¬åŸç†" class="headerlink" title="åŸºæœ¬åŸç†"></a>åŸºæœ¬åŸç†</h2><p>å¹¶æŸ¥é›†æ˜¯ä¸€ç§ç”¨äºç®¡ç†å…ƒç´ æ‰€å±é›†åˆçš„æ•°æ®ç»“æ„ï¼Œå®ç°ä¸ºä¸€ä¸ªæ£®æ—ï¼Œå…¶ä¸­æ¯æ£µæ ‘è¡¨ç¤ºä¸€ä¸ªé›†åˆï¼Œæ ‘ä¸­çš„èŠ‚ç‚¹è¡¨ç¤ºå¯¹åº”é›†åˆä¸­çš„å…ƒç´ ã€‚</p><p>é¡¾åæ€ä¹‰ï¼Œå¹¶æŸ¥é›†æ”¯æŒä¸¤ç§æ“ä½œï¼š</p><ul><li>åˆå¹¶(Union)ï¼šåˆå¹¶ä¸¤ä¸ªå…ƒç´ æ‰€å±é›†åˆï¼ˆåˆå¹¶å¯¹åº”çš„æ ‘ï¼‰</li><li>æŸ¥è¯¢(Find)ï¼šæŸ¥è¯¢æŸä¸ªå…ƒç´ æ‰€å±é›†åˆï¼ˆæŸ¥è¯¢å¯¹åº”çš„æ ‘çš„æ ¹èŠ‚ç‚¹ï¼‰ï¼Œè¿™å¯ä»¥ç”¨äºåˆ¤æ–­ä¸¤ä¸ªå…ƒç´ æ˜¯å¦å±äºåŒä¸€é›†åˆ</li></ul><hr><hr><h2 id="å‡½æ•°æ¨¡ç‰ˆ"><a href="#å‡½æ•°æ¨¡ç‰ˆ" class="headerlink" title="å‡½æ•°æ¨¡ç‰ˆ"></a>å‡½æ•°æ¨¡ç‰ˆ</h2><p>è¿ç”¨ä»¥ä¸‹è¿™ä¸‰ä¸ªå‡½æ•°å¯ä»¥æ„å»ºå¹¶æŸ¥é›†ç®—æ³•çš„åŸºæœ¬æ¡†æ¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnionFind</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[] parent;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[] cnt;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> N;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å¹¶æŸ¥é›†çš„çˆ¶èŠ‚ç‚¹æ•°ç»„ï¼Œå°†æ¯ä¸ªå…ƒç´ çš„çˆ¶èŠ‚ç‚¹éƒ½åˆå§‹åŒ–ä¸ºè‡ªå·±</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UnionFind</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        N = n;</span><br><span class="line">        parent = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">        cnt = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            parent[i] = i;</span><br><span class="line">            cnt[i] = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†å…ƒç´ xå’Œå…ƒç´ yæ‰€åœ¨çš„é›†åˆåˆå¹¶æˆä¸€ä¸ªé›†åˆã€‚</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">union</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">pra</span> <span class="operator">=</span> find(a);</span><br><span class="line">        <span class="type">int</span> <span class="variable">prb</span> <span class="operator">=</span> find(b);</span><br><span class="line">        <span class="keyword">if</span> (pra != prb) &#123;</span><br><span class="line">            parent[prb] = pra;</span><br><span class="line">            cnt[pra] += cnt[prb];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾å…ƒç´ xçš„çˆ¶èŠ‚ç‚¹ï¼Œåˆ¤æ–­å…ƒç´ xå±äºå“ªä¸ªé›†åˆ</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">find</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (parent[x] != x) &#123;</span><br><span class="line">            x = parent[x];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å– è¿é€šå—ä¸ªæ•°</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">getBlockNum</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == find(i)) &#123;</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">å¹¶æŸ¥é›†</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>å¤§æ•°è¿ç®—</title>
    <link href="https://wuwawawa.github.io/posts/8878d18a.html"/>
    <id>https://wuwawawa.github.io/posts/8878d18a.html</id>
    <published>2023-09-09T05:44:29.000Z</published>
    <updated>2023-09-14T01:35:39.055Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¤§æ•°ç›¸åŠ "><a href="#å¤§æ•°ç›¸åŠ " class="headerlink" title="å¤§æ•°ç›¸åŠ "></a>å¤§æ•°ç›¸åŠ </h2><p>ç®—æ³•æµç¨‹ï¼š è®¾å®š iï¼Œj ä¸¤æŒ‡é’ˆåˆ†åˆ«æŒ‡å‘ num1ï¼Œnum2 å°¾éƒ¨ï¼Œæ¨¡æ‹Ÿäººå·¥åŠ æ³•ï¼›</p><p>è®¡ç®—è¿›ä½ï¼š è®¡ç®— carry = tmp // 10ï¼Œä»£è¡¨å½“å‰ä½ç›¸åŠ æ˜¯å¦äº§ç”Ÿè¿›ä½ï¼›</p><p>æ·»åŠ å½“å‰ä½ï¼š è®¡ç®— tmp = n1 + n2 + carryï¼Œå¹¶å°†å½“å‰ä½ tmp % 10 æ·»åŠ è‡³ res å¤´éƒ¨ï¼›</p><p>ç´¢å¼•æº¢å‡ºå¤„ç†ï¼š å½“æŒ‡é’ˆ iæˆ–j èµ°è¿‡æ•°å­—é¦–éƒ¨åï¼Œç»™ n1ï¼Œn2 èµ‹å€¼ä¸º 0ï¼Œç›¸å½“äºç»™ num1ï¼Œnum2 ä¸­é•¿åº¦è¾ƒçŸ­çš„æ•°å­—å‰é¢å¡« 0ï¼Œä»¥ä¾¿åç»­è®¡ç®—ã€‚</p><p>å½“éå†å®Œ num1ï¼Œnum2 åè·³å‡ºå¾ªç¯ï¼Œå¹¶æ ¹æ® carry å€¼å†³å®šæ˜¯å¦åœ¨å¤´éƒ¨æ·»åŠ è¿›ä½ 1ï¼Œæœ€ç»ˆè¿”å› res å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">addStrings</span><span class="params">(String num1, String num2)</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> num1.length() - <span class="number">1</span>, j = num2.length() - <span class="number">1</span>, carry = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &gt;= <span class="number">0</span> || j &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n1</span> <span class="operator">=</span> i &gt;= <span class="number">0</span> ? num1.charAt(i) - <span class="string">&#x27;0&#x27;</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n2</span> <span class="operator">=</span> j &gt;= <span class="number">0</span> ? num2.charAt(j) - <span class="string">&#x27;0&#x27;</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">tmp</span> <span class="operator">=</span> n1 + n2 + carry;</span><br><span class="line">        res.append(tmp % <span class="number">10</span>);</span><br><span class="line">        carry = tmp / <span class="number">10</span>;</span><br><span class="line">        i--;</span><br><span class="line">        j--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (carry == <span class="number">1</span>) &#123;</span><br><span class="line">        res.append(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.reverse().toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="å¤§æ•°ç›¸ä¹˜"><a href="#å¤§æ•°ç›¸ä¹˜" class="headerlink" title="å¤§æ•°ç›¸ä¹˜"></a>å¤§æ•°ç›¸ä¹˜</h2><p>å¦‚æœ <code>num1</code> å’Œ <code>num2</code> ä¹‹ä¸€æ˜¯0 ï¼Œåˆ™ç›´æ¥å°†0ä½œä¸ºç»“æœè¿”å›å³å¯ã€‚</p><p>å¦‚æœ <code>num1</code> å’Œ <code>num2</code> éƒ½ä¸æ˜¯0ï¼Œåˆ™å¯ä»¥ç”¨è¿‡æ¨¡æ‹Ÿã€Œç«–å¼ä¹˜æ³•ã€çš„æ–¹æ³•è®¡ç®—ä¹˜ç§¯ã€‚ä»å³å¾€å·¦éå†ä¹˜æ•°ï¼Œå°†ä¹˜æ•°çš„æ¯ä¸€ä½ä¸è¢«ä¹˜æ•°ç›¸ä¹˜å¾—åˆ°å¯¹åº”çš„ç»“æœï¼Œå†å°†æ¯æ¬¡å¾—åˆ°çš„ç»“æœè¿›è¡Œç´¯åŠ ã€‚</p><p>è¿™é“é¢˜ä¸­ï¼Œè¢«ä¹˜æ•°æ˜¯ <code>nums1</code> ,ä¹˜æ•°æ˜¯ <code>num2</code>ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>num2</code> é™¤äº†æœ€ä½ä½ä»¥å¤–ï¼Œå…¶ä½™çš„æ¯ä¸€ä½çš„è¿ç®—ç»“æœéƒ½éœ€è¦è¡¥ 0ã€‚ </p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/sol1.png" alt="fig1" style="zoom:48%;" /></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">multiply</span><span class="params">(String num1, String num2)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (num1.equals(<span class="string">&quot;0&quot;</span>) || num2.equals(<span class="string">&quot;0&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len1</span> <span class="operator">=</span> num1.length(), len2 = num2.length();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> len2 - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">curProduct</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¡¥0</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> len2 - <span class="number">1</span>; j &gt; i; j--) &#123;</span><br><span class="line">            curProduct.append(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">curNum2</span> <span class="operator">=</span> num2.charAt(i) - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">carry</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç”¨ curNum å»ä¹˜ num1</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> len1 - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">curNum1</span> <span class="operator">=</span> num1.charAt(j) - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">product</span> <span class="operator">=</span> curNum1 * curNum2 + carry;</span><br><span class="line"></span><br><span class="line">            curProduct.append(product % <span class="number">10</span>);</span><br><span class="line">            carry /= <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ans = addStrings(ans,curProduct.reverse().toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">addStrings</span><span class="params">(String num1, String num2)</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> num1.length() - <span class="number">1</span>, j = num2.length() - <span class="number">1</span>, carry = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &gt;= <span class="number">0</span> || j &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n1</span> <span class="operator">=</span> i &gt;= <span class="number">0</span> ? num1.charAt(i) - <span class="string">&#x27;0&#x27;</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n2</span> <span class="operator">=</span> j &gt;= <span class="number">0</span> ? num2.charAt(j) - <span class="string">&#x27;0&#x27;</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">tmp</span> <span class="operator">=</span> n1 + n2 + carry;</span><br><span class="line">        res.append(tmp % <span class="number">10</span>);</span><br><span class="line">        carry = tmp / <span class="number">10</span>;</span><br><span class="line">        i--;</span><br><span class="line">        j--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (carry == <span class="number">1</span>) &#123;</span><br><span class="line">        res.append(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.reverse().toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="å¤§æ•°ç›¸å‡"><a href="#å¤§æ•°ç›¸å‡" class="headerlink" title="å¤§æ•°ç›¸å‡"></a>å¤§æ•°ç›¸å‡</h2><p>1ã€æ‰§è¡Œè®¡ç®—å‰é¦–å…ˆæ¯”è¾ƒå‡æ•°(num1)å’Œè¢«å‡æ•°(num2)çš„å¤§å°ï¼Œå¦‚æœnum1&gt;num2,é‚£ä¹ˆå°±æ¨¡æ‹Ÿnum1-num2çš„è¿‡ç¨‹ï¼Œå¦‚æœnum1&lt;num2ï¼Œé‚£ä¹ˆç»“æœå°±ä¸º-(num2-num1) ã€‚å½“ç„¶å¯ä»¥ä¸ºäº†ç¨³å®šæ¨¡æ‹Ÿæ—¶å€™ä¸€ä¸ªå¤§ä¸€ä¸ªå°ï¼Œå¯å°†num1å§‹ç»ˆæŒ‡å‘è¾ƒå¤§çš„é‚£ä¸ªæ•°ï¼Œå°‘å†™ä¸€ä¸ªif/else.</p><p>2ã€åœ¨æ¯”è¾ƒä¸¤ä¸ªæ•°å­—å¤§å°çš„æ—¶å€™ï¼Œå› ä¸ºæ˜¯å­—ç¬¦å½¢å¼ï¼Œé¦–å…ˆæ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œé•¿çš„é‚£ä¸ªæ›´å¤§çŸ­çš„é‚£ä¸ªæ›´å°ï¼Œå¦‚æœä¸¤ä¸ªå­—ç¬¦ä¸²ç­‰å¤§ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡å­—å…¸åºä»å‰å¾€åè¿›è¡Œæ¯”è¾ƒ(Javaå¯ç›´æ¥ä½¿ç”¨compareToæ–¹æ³•)ã€‚</p><p>3ã€å’ŒåŠ æ³•ä¸åŒçš„æ˜¯ï¼Œå‡æ³•å‰é¢å¯èƒ½äº§ç”Ÿè‹¥å¹²å‰ç¼€0ï¼Œè¿™äº›0æ˜¯éœ€è¦ä½ å»æ‰çš„ï¼Œä¾‹å¦‚â€1100â€-â€œ1000â€è®¡ç®—å¾—åˆ°çš„ç»“æœä¸ºâ€0100â€,ä½ å°±è¦æŠŠå‰é¢çš„0å»æ‰è¿”å›â€100â€ã€‚</p><p>4ã€å…·ä½“å®ç°çš„æ—¶å€™å’ŒåŠ æ³•ç›¸ä¼¼ï¼Œå¦‚æœä½¿ç”¨StringBuilderå­˜å‚¨ï¼Œéœ€è¦é€†ç½®é¡ºåºï¼Œå¦‚æœæ˜¯ä¸ªè´Ÿæ•°ï¼Œå‰é¢è¿˜è¦åŠ ä¸Šâ€™-â€˜.</p><p>5ã€æ¯ä¸ªä½ç½®æ­£å¸¸è¿›è¡Œå‡æ³•è¿ç®—ï¼Œå¦‚æœå€¼å°äº0ï¼Œé‚£ä¹ˆå°±éœ€è¦å‘ä¸Šå€Ÿä½(+10),é‚£ä¹ˆå¤„ç†ä¸Šä¸€ä½è¿›è¡Œå‡æ³•æ—¶å€™è¿˜è¦å°†å€Ÿä½çš„å¤„ç†ä¸€ä¸‹ã€‚</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-4372098/mlwn6ygdwd.png" alt="img" style="zoom: 67%;" /></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">compare</span><span class="params">(String num1, String num2)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (num1.length() &lt; num2.length())</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (num1.length() &gt; num2.length())</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> num1.compareTo(num2) &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">subtractString</span><span class="params">(String num1, String num2)</span> &#123;</span><br><span class="line">    <span class="type">char</span> <span class="variable">sign</span> <span class="operator">=</span> <span class="string">&#x27;+&#x27;</span>;<span class="comment">//æ­£è´Ÿå·</span></span><br><span class="line">    <span class="comment">//è®©num1&gt;num2 å¦‚æœnum1&lt;num2 é‚£ä¹ˆç»“æœå°±æ˜¯â€”(num2-num1)</span></span><br><span class="line">    <span class="comment">//å¯ä»¥å…ˆå°†num1å’Œnum2äº¤æ¢å’Œå‰é¢æƒ…å†µç»Ÿä¸€</span></span><br><span class="line">    <span class="keyword">if</span> (!compare(num1, num2)) &#123;</span><br><span class="line">        sign = <span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">team</span> <span class="operator">=</span> num2;</span><br><span class="line">        num2 = num1;</span><br><span class="line">        num1 = team;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> num1.length() - <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> num2.length() - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">borrow</span> <span class="operator">=</span> <span class="number">0</span>;<span class="comment">//å€Ÿä½</span></span><br><span class="line">    <span class="keyword">while</span> (i &gt;= <span class="number">0</span> || j &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n1</span> <span class="operator">=</span> i &gt;= <span class="number">0</span> ? (num1.charAt(i) - <span class="string">&#x27;0&#x27;</span>) : <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n2</span> <span class="operator">=</span> j &gt;= <span class="number">0</span> ? (num2.charAt(j) - <span class="string">&#x27;0&#x27;</span>) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> n1 - n2 - borrow;</span><br><span class="line">        borrow = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (num &lt; <span class="number">0</span>)<span class="comment">//éœ€è¦å‘å‰å€Ÿä½</span></span><br><span class="line">        &#123;</span><br><span class="line">            borrow = <span class="number">1</span>;</span><br><span class="line">            num += <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        i--;</span><br><span class="line">        j--;</span><br><span class="line">        sb.append(num);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sb = sb.reverse();<span class="comment">//éœ€è¦å…ˆç¿»è½¬</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;<span class="comment">//å»æ‰å‰é¢æ²¡ç”¨çš„â€™0â€˜</span></span><br><span class="line">    <span class="keyword">while</span> (index &lt; sb.length() &amp;&amp; sb.charAt(index) == <span class="string">&#x27;0&#x27;</span>) &#123;</span><br><span class="line">        index++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœä¸¤ä¸ªæ•°ç›¸åŒ ç›´æ¥è¿”å›&quot;0&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (index == sb.length())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (sign == <span class="string">&#x27;+&#x27;</span>)<span class="comment">//å¦‚æœæ­£æ•°</span></span><br><span class="line">        <span class="keyword">return</span> sb.substring(index);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> sign + sb.substring(index);<span class="comment">//è´Ÿæ•°éœ€è¦è¿”å›</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><hr><h2 id="å¤§æ•°ç›¸é™¤"><a href="#å¤§æ•°ç›¸é™¤" class="headerlink" title="å¤§æ•°ç›¸é™¤"></a>å¤§æ•°ç›¸é™¤</h2><p>å¯¹äºå¤§æ•°a/bï¼Œä¸€èˆ¬æœ€å¤šè¦æ±‚æ±‚åˆ°å…¶æ•´æ•°è§£æˆ–è€…ä½™æ•°ï¼Œå³a/b=câ€¦â€¦dï¼ˆa,b,c,då‡ä¸ºæ•´ï¼‰;ä¹Ÿå°±æ˜¯<strong>aé‡Œé¢æœ‰cä¸ªb</strong>ï¼Œå¹¶ä¸”è¿˜å‰©ä¸‹dã€‚æ ¸å¿ƒæ˜¯å…ˆæ±‚cæ˜¯å¤šå°‘ï¼Œå¯¹äºç¨‹åºæ¥è¯´ï¼Œå¯ä»¥é€šè¿‡æšä¸¾å•Šï¼Œå°†é™¤æ³•å˜æˆå‡æ³•ï¼Œä»aä¸­ä¸æ–­å‡dï¼Œä¸€ç›´åˆ°ä¸èƒ½å‡ä¸ºæ­¢ã€‚</p><p>ä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœè¢«é™¤æ•°aå¾ˆå¤§å¾ˆå¤§ï¼Œå¯èƒ½æœ‰å±…å¤šä¸ªbï¼Œé‚£ä¹ˆè¿™æ ·æ—¶é—´å¤æ‚åº¦å¤ªé«˜äº†ï¼Œä¸å¯èƒ½æ‰§è¡Œé‚£ä¹ˆå¤šæ¬¡ï¼Œé‚£ä¹ˆéœ€è¦æ€ä¹ˆæ ·å»ä¼˜åŒ–è¿™ä¸ªæ–¹æ³•å‘¢ï¼Ÿ</p><p>é‚£å°±è¦åŠ é€Ÿå¯»æ‰¾æ¬¡æ•°ï¼Œå‡å°‘è¿™ä¸ªå‡æ³•çš„æ¬¡æ•°äº†ï¼Œå‡æ³•æ¬¡æ•°å‡å°çš„ä¸€ä¸ªæœ€å¥½æ–¹æ¡ˆå°±æ˜¯èƒ½ä¸èƒ½<strong>æ‰©å¤§é™¤æ•°b</strong>ã€‚å¦‚æœbåé¢åŠ ä¸ª<code>&#39;0&#39;</code>ï¼Œé‚£ä¹ˆç®—å‡ºæ¥çš„ç»“æœå°±ä¹˜ä»¥10ï¼Œå‡æ³•çš„æ¬¡æ•°å˜æˆåŸæ¥ååˆ†ä¹‹ä¸€ã€‚æ ¹æ®è¿™ä¸ªæ€æƒ³æˆ‘ä»¬å¯ä»¥ä¸€ç›´æ¯æ¬¡æ‰¾åˆ°bçš„æœ€å¤§10çš„å€æ•°(å°äºa)è®¡ç®—å‡çš„æ¬¡æ•°å†æ¢ç®—æˆå‡bçš„æ€»è¯æ•°ï¼Œå°†ç»“æœè¦ä»¥å­—ç¬¦ä¸²æ–¹å¼ä¿ç•™ï¼Œåé¢ä¸€ç›´è¿­ä»£åˆ°æœ€åä¸ºæ­¢,è¿™è™½ç„¶æ˜¯ä¸€é“é™¤æ³•è¿ç®—çš„é¢˜ï¼Œä½†æ˜¯ä¹Ÿè•´å«å‡æ³•å’ŒåŠ æ³•(æ¬¡æ•°å åŠ åˆ°ç»“æœä¸­)ã€‚</p>]]></content>
    
    
    <summary type="html">å¤§æ•°ç›¸åŠ ã€å¤§æ•°ç›¸å‡ã€å¤§æ•°ç›¸ä¹˜ã€</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>é™æµç®—æ³•</title>
    <link href="https://wuwawawa.github.io/posts/32609cb8.html"/>
    <id>https://wuwawawa.github.io/posts/32609cb8.html</id>
    <published>2023-09-02T05:04:36.000Z</published>
    <updated>2023-09-02T07:37:52.667Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å›ºå®šçª—å£ç®—æ³•"><a href="#å›ºå®šçª—å£ç®—æ³•" class="headerlink" title="å›ºå®šçª—å£ç®—æ³•"></a>å›ºå®šçª—å£ç®—æ³•</h2><h3 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h3><p>å›ºå®šçª—å£é™æµç®—æ³•ï¼Œä¹Ÿå«<span class='p green'>è®¡æ•°å™¨é™æµç®—æ³•</span>ï¼Œæ˜¯æœ€ç®€å•çš„ä¸€ç§é™æµç®—æ³•ã€‚</p><p><strong>å®ç°åŸç†æ˜¯ï¼š</strong> åœ¨ä¸€ä¸ªå›ºå®šé•¿åº¦çš„æ—¶é—´çª—å£å†…é™åˆ¶è¯·æ±‚æ•°é‡ï¼Œæ¯æ¥ä¸€ä¸ªè¯·æ±‚ï¼Œè¯·æ±‚æ¬¡æ•°åŠ ä¸€ï¼Œå¦‚æœè¯·æ±‚æ•°é‡è¶…è¿‡æœ€å¤§é™åˆ¶ï¼Œå°±æ‹’ç»è¯¥è¯·æ±‚ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230902132700830.png" alt="image-20230902132700830" style="zoom: 50%;" /></p><hr><h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å›ºå®šçª—å£é™æµ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FixWindowLimiter</span> <span class="keyword">implements</span> <span class="title class_">Limiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">threshold</span> <span class="operator">=</span> <span class="number">10L</span>; <span class="comment">// æ¯ä¸ªçª—å£çš„æœ€å¤§è¯·æ±‚æ•°é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">windowUnit</span> <span class="operator">=</span> <span class="number">1000L</span>; <span class="comment">// çª—å£å¤§å°ï¼Œå•ä½ms</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">reqCount</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// çª—å£å†…çš„å½“å‰è¯·æ±‚æ•°é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">lastTime</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// çª—å£å¼€å§‹æ—¶é—´</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é™æµæ–¹æ³•ï¼Œè¿”å›trueè¡¨ç¤ºé™æµ</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> Boolean <span class="title function_">limit</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰æ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦åœ¨å½“å‰æ—¶é—´çª—å£å†…ï¼Œå¦‚æœä¸åœ¨å°±å¼€å¯ä¸€ä¸ªæ–°çš„æ—¶é—´çª—å£</span></span><br><span class="line">        <span class="keyword">if</span> (currentTime - lastTime &gt; windowUnit) &#123;</span><br><span class="line">            <span class="comment">// é‡ç½®è®¡æ•°å™¨</span></span><br><span class="line">            reqCount = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// å¼€å¯æ–°çª—å£</span></span><br><span class="line">            lastTime = currentTime;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// // åˆ¤æ–­æ˜¯å¦è¶…è¿‡æœ€å¤§è¯·æ±‚é‡</span></span><br><span class="line">        <span class="keyword">if</span> (reqCount &lt; threshold) &#123;</span><br><span class="line">            reqCount++;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="ä¼˜ç¼ºç‚¹"><a href="#ä¼˜ç¼ºç‚¹" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h3><p><strong>ä¼˜ç‚¹ï¼š</strong> å®ç°ç®€å•ï¼Œå®¹æ˜“ç†è§£ã€‚</p><p><strong>ç¼ºç‚¹ï¼š</strong></p><ol><li>é™æµä¸å¤Ÿå¹³æ»‘ã€‚ä¾‹å¦‚ï¼šé™æµæ˜¯æ¯ç§’3ä¸ªï¼Œåœ¨ç¬¬ä¸€æ¯«ç§’å‘é€äº†3ä¸ªè¯·æ±‚ï¼Œè¾¾åˆ°é™æµï¼Œçª—å£å‰©ä½™æ—¶é—´çš„è¯·æ±‚éƒ½å°†ä¼šè¢«æ‹’ç»ï¼Œä½“éªŒä¸å¥½ã€‚</li><li>æ— æ³•å¤„ç†çª—å£è¾¹ç•Œé—®é¢˜ã€‚å› ä¸ºæ˜¯åœ¨æŸä¸ªæ—¶é—´çª—å£å†…è¿›è¡Œæµé‡æ§åˆ¶ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå‡ºç°çª—å£è¾¹ç•Œæ•ˆåº”ï¼Œå³åœ¨æ—¶é—´çª—å£çš„è¾¹ç•Œå¤„å¯èƒ½ä¼šæœ‰å¤§é‡çš„è¯·æ±‚è¢«å…è®¸é€šè¿‡ï¼Œä»è€Œå¯¼è‡´çªå‘æµé‡ã€‚</li></ol><p>ä¾‹å¦‚ï¼šé™æµæ˜¯æ¯ç§’3ä¸ªï¼Œåœ¨ç¬¬ä¸€ç§’çš„æœ€åä¸€æ¯«ç§’å‘é€äº†3ä¸ªè¯·æ±‚ï¼Œåœ¨ç¬¬äºŒç§’çš„ç¬¬ä¸€æ¯«ç§’åˆå‘é€äº†3ä¸ªè¯·æ±‚ã€‚åœ¨è¿™ä¸¤æ¯«ç±³å†…å¤„ç†äº†6ä¸ªè¯·æ±‚ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è§¦å‘é™æµã€‚å¦‚æœå‡ºç°çªå‘æµé‡ï¼Œå¯èƒ½ä¼šå‹å®æœåŠ¡å™¨ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230902134743416.png" alt="image-20230902134743416" style="zoom: 50%;" /></p><hr><hr><h2 id="æ»‘åŠ¨çª—å£ç®—æ³•"><a href="#æ»‘åŠ¨çª—å£ç®—æ³•" class="headerlink" title="æ»‘åŠ¨çª—å£ç®—æ³•"></a>æ»‘åŠ¨çª—å£ç®—æ³•</h2><h3 id="å®ç°åŸç†-1"><a href="#å®ç°åŸç†-1" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h3><p>ä¸ºäº†è§£å†³å›ºå®šçª—å£ç®—æ³•ç»Ÿè®¡ç²¾åº¦å¤ªä½çš„é—®é¢˜ï¼Œå¼•å…¥äº†æ»‘åŠ¨çª—å£ç®—æ³•ã€‚åœ¨æ»‘åŠ¨çª—å£ç®—æ³•ä¸­ï¼Œçª—å£çš„èµ·æ­¢æ—¶é—´æ˜¯åŠ¨æ€çš„ï¼Œçª—å£çš„å¤§å°å›ºå®šã€‚è¿™ç§ç®—æ³•èƒ½å¤Ÿè¾ƒå¥½åœ°å¤„ç†çª—å£è¾¹ç•Œé—®é¢˜ï¼Œä½†æ˜¯å®ç°ç›¸å¯¹å¤æ‚ï¼Œéœ€è¦è®°å½•æ¯ä¸ªè¯·æ±‚çš„æ—¶é—´æˆ³ã€‚</p><p><strong>å®ç°åŸç†æ˜¯ï¼š</strong> æ¯æ¥ä¸€ä¸ªè¯·æ±‚ï¼Œå°±å‘åæ¨ä¸€ä¸ªæ—¶é—´çª—å£ï¼Œè®¡ç®—è¿™ä¸ªçª—å£å†…çš„è¯·æ±‚æ•°é‡ã€‚å¦‚æœè¯·æ±‚æ•°é‡è¶…è¿‡é™åˆ¶å°±æ‹’ç»è¯·æ±‚ï¼Œå¦åˆ™å°±å¤„ç†è¯·æ±‚ï¼Œå¹¶è®°å½•è¯·æ±‚çš„æ—¶é—´æˆ³ã€‚å¦å¤–è¿˜éœ€è¦ä¸€ä¸ªä»»åŠ¡æ¸…ç†è¿‡æœŸçš„æ—¶é—´æˆ³ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230902135306151.png" alt="image-20230902135306151" style="zoom:50%;" /></p><hr><h3 id="ä»£ç å®ç°-1"><a href="#ä»£ç å®ç°-1" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SlidingWindowLimiter</span> <span class="keyword">implements</span> <span class="title class_">Limiter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">threshold</span> <span class="operator">=</span> <span class="number">10</span>; <span class="comment">// æ¯ä¸ªçª—å£çš„æœ€å¤§è¯·æ±‚æ•°é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">windowUnit</span> <span class="operator">=</span> <span class="number">1000</span>; <span class="comment">// çª—å£å¤§å°ï¼Œ1000ms</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Long&gt; requestList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(); <span class="comment">//  è¯·æ±‚é›†åˆï¼Œç”¨æ¥å­˜å‚¨çª—å£å†…çš„è¯·æ±‚æ•°é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é™æµæ–¹æ³•ï¼Œè¿”å›trueè¡¨ç¤ºæ‹¦æˆª</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">limit</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–ç³»ç»Ÿå½“å‰æ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// ç»Ÿè®¡å½“å‰çª—å£å†…ï¼Œæœ‰æ•ˆçš„è¯·æ±‚æ•°é‡</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">sizeOfValid</span> <span class="operator">=</span> <span class="built_in">this</span>.sizeOfValid(currentTime);</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦è¶…è¿‡æœ€å¤§è¯·æ±‚æ•°é‡</span></span><br><span class="line">        <span class="keyword">if</span> (sizeOfValid &lt; threshold) &#123;</span><br><span class="line">            <span class="comment">// æŠŠå½“å‰è¯·æ±‚æ·»åŠ åˆ°è¯·æ±‚é›†åˆé‡Œ</span></span><br><span class="line">            requestList.add(currentTime);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç»Ÿè®¡å½“å‰çª—å£å†…ï¼Œæœ‰æ•ˆçš„è¯·æ±‚æ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">sizeOfValid</span><span class="params">(<span class="type">long</span> currentTime)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sizeOfValid</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Long requestTime : requestList) &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯å¦åœ¨å½“å‰æ—¶é—´çª—å£å†…</span></span><br><span class="line">            <span class="keyword">if</span> (currentTime - requestTime &lt;= windowUnit) &#123;</span><br><span class="line">                sizeOfValid++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sizeOfValid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¸…ç†è¿‡æœŸçš„è¯·æ±‚ï¼ˆå•ç‹¬å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å¤„ç†ï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">clean</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦è¶…å‡ºå½“å‰æ—¶é—´çª—å£å†…</span></span><br><span class="line">        requestList.removeIf(requestTime -&gt; System.currentTimeMillis() - requestTime &gt; windowUnit);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="ä¼˜ç¼ºç‚¹-1"><a href="#ä¼˜ç¼ºç‚¹-1" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h3><p><strong>ä¼˜ç‚¹ï¼š</strong> è§£å†³äº†å›ºå®šçª—å£ç®—æ³•çš„çª—å£è¾¹ç•Œé—®é¢˜ï¼Œé¿å…çªå‘æµé‡å‹å®æœåŠ¡å™¨ã€‚</p><p><strong>ç¼ºç‚¹ï¼š</strong> è¿˜æ˜¯å­˜åœ¨é™æµä¸å¤Ÿå¹³æ»‘çš„é—®é¢˜ã€‚ä¾‹å¦‚ï¼šé™æµæ˜¯æ¯ç§’3ä¸ªï¼Œåœ¨ç¬¬ä¸€æ¯«ç§’å‘é€äº†3ä¸ªè¯·æ±‚ï¼Œè¾¾åˆ°é™æµï¼Œå‰©ä½™çª—å£æ—¶é—´çš„è¯·æ±‚éƒ½å°†ä¼šè¢«æ‹’ç»ï¼Œä½“éªŒä¸å¥½ã€‚</p><hr><hr><h2 id="æ¼æ¡¶ç®—æ³•"><a href="#æ¼æ¡¶ç®—æ³•" class="headerlink" title="æ¼æ¡¶ç®—æ³•"></a>æ¼æ¡¶ç®—æ³•</h2><h3 id="å®ç°åŸç†-2"><a href="#å®ç°åŸç†-2" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h3><p>æ¼æ¡¶é™æµç®—æ³•æ˜¯ä¸€ç§å¸¸ç”¨çš„æµé‡æ•´å½¢ï¼ˆTraffic Shapingï¼‰å’Œæµé‡æ§åˆ¶ï¼ˆTraffic Policingï¼‰çš„ç®—æ³•ï¼Œå®ƒå¯ä»¥æœ‰æ•ˆåœ°æ§åˆ¶æ•°æ®çš„ä¼ è¾“é€Ÿç‡ä»¥åŠé˜²æ­¢ç½‘ç»œæ‹¥å¡ã€‚</p><p>å®ç°åŸç†æ˜¯ï¼š</p><ol><li>ä¸€ä¸ªå›ºå®šå®¹é‡çš„æ¼æ¡¶ï¼ŒæŒ‰ç…§å›ºå®šé€Ÿç‡å‡ºæ°´ï¼ˆå¤„ç†è¯·æ±‚ï¼‰ï¼›</li><li>å½“æµå…¥æ°´ï¼ˆè¯·æ±‚æ•°é‡ï¼‰çš„é€Ÿåº¦è¿‡å¤§ä¼šç›´æ¥æº¢å‡ºï¼ˆè¯·æ±‚æ•°é‡è¶…è¿‡é™åˆ¶åˆ™ç›´æ¥æ‹’ç»ï¼‰ã€‚</li><li>æ¡¶é‡Œçš„æ°´ï¼ˆè¯·æ±‚ï¼‰ä¸å¤Ÿåˆ™æ— æ³•å‡ºæ°´ï¼ˆæ¡¶å†…æ²¡æœ‰è¯·æ±‚åˆ™ä¸å¤„ç†ï¼‰ã€‚</li></ol><p>å½“è¯·æ±‚æµé‡æ­£å¸¸æˆ–è€…è¾ƒå°çš„æ—¶å€™ï¼Œè¯·æ±‚èƒ½å¤Ÿå¾—åˆ°æ­£å¸¸çš„å¤„ç†ã€‚å½“è¯·æ±‚æµé‡è¿‡å¤§æ—¶ï¼Œæ¼æ¡¶é™æµç®—æ³•å¯ä»¥é€šè¿‡ä¸¢å¼ƒéƒ¨åˆ†è¯·æ±‚æ¥é˜²æ­¢ç³»ç»Ÿè¿‡è½½ã€‚</p><p>è¿™ç§ç®—æ³•çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§æ˜¯ï¼Œè¾“å‡ºæ•°æ®çš„é€Ÿç‡å§‹ç»ˆæ˜¯ç¨³å®šçš„ï¼Œæ— è®ºè¾“å…¥çš„æ•°æ®æµé‡å¦‚ä½•å˜åŒ–ã€‚è¿™å°±ç¡®ä¿äº†ç³»ç»Ÿçš„è´Ÿè½½ä¸ä¼šè¶…è¿‡é¢„è®¾çš„é˜ˆå€¼ã€‚ä½†æ˜¯ï¼Œç”±äºæ¼æ¡¶çš„å‡ºå£é€Ÿåº¦æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥æ— æ³•å¤„ç†çªå‘æµé‡ã€‚æ­¤å¤–ï¼Œå¦‚æœå…¥å£æµé‡è¿‡å¤§ï¼Œæ¼æ¡¶å¯èƒ½ä¼šæº¢å‡ºï¼Œå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230902144242297.png" alt="image-20230902144242297" style="zoom:50%;" /></p><hr><h3 id="ç®—æ³•å®ç°"><a href="#ç®—æ³•å®ç°" class="headerlink" title="ç®—æ³•å®ç°"></a>ç®—æ³•å®ç°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeakyBucketLimiter</span> <span class="keyword">implements</span> <span class="title class_">Limiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">threshold</span> <span class="operator">=</span> <span class="number">100</span>; <span class="comment">// æ¡¶çš„æœ€å¤§å®¹é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">20</span>; <span class="comment">// æ¡¶å†…å½“å‰æ°´é‡(å½“å‰ç´¯è®¡çš„è¯·æ±‚æ•°)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">leakRate</span> <span class="operator">=</span> <span class="number">5</span>; <span class="comment">// æ¼æ°´é€Ÿç‡(æ¯ç§’ç³»ç»Ÿèƒ½å¤„ç†çš„è¯·æ±‚æ•°)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">lastLeakTime</span> <span class="operator">=</span> System.currentTimeMillis(); <span class="comment">// ä¸Šæ¬¡æ¼æ°´æ—¶é—´</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›trueï¼Œè¡¨ç¤ºé™æµ</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">limit</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨æ¼æ°´æ–¹æ³•</span></span><br><span class="line">        <span class="built_in">this</span>.leak();</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦è¶…è¿‡æœ€å¤§è¯·æ±‚æ•°é‡</span></span><br><span class="line">        <span class="keyword">if</span> (count &lt; threshold) &#123;</span><br><span class="line">            count++;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¼æ°´æ–¹æ³•ï¼Œè®¡ç®—å¹¶æ›´æ–°è¿™æ®µæ—¶é—´å†…æ¼æ°´é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">leak</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–ç³»ç»Ÿå½“å‰æ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// è®¡ç®—è¿™æ®µæ—¶é—´å†…ï¼Œéœ€è¦æµå‡ºçš„æ°´é‡</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">leakWater</span> <span class="operator">=</span> (currentTime - lastLeakTime) * leakRate / <span class="number">1000</span>;</span><br><span class="line">        count = Math.max(count - leakWater, <span class="number">0</span>);</span><br><span class="line">        lastLeakTime = currentTime;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="ä¼˜ç¼ºç‚¹-2"><a href="#ä¼˜ç¼ºç‚¹-2" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h3><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ol><li><strong>å¹³æ»‘æµé‡ã€‚</strong>ç”±äºæ¼æ¡¶ç®—æ³•ä»¥å›ºå®šçš„é€Ÿç‡å¤„ç†è¯·æ±‚ï¼Œå¯ä»¥æœ‰æ•ˆåœ°å¹³æ»‘å’Œæ•´å½¢æµé‡ï¼Œé¿å…æµé‡çš„çªå‘å’Œæ³¢åŠ¨ï¼ˆç±»ä¼¼äºæ¶ˆæ¯é˜Ÿåˆ—çš„å‰Šå³°å¡«è°·çš„ä½œç”¨ï¼‰ã€‚</li><li><strong>é˜²æ­¢è¿‡è½½ã€‚</strong>å½“æµå…¥çš„è¯·æ±‚è¶…è¿‡æ¡¶çš„å®¹é‡æ—¶ï¼Œå¯ä»¥ç›´æ¥ä¸¢å¼ƒè¯·æ±‚ï¼Œé˜²æ­¢ç³»ç»Ÿè¿‡è½½ã€‚</li></ol><p><strong>ç¼ºç‚¹ï¼š</strong></p><ol><li><strong>æ— æ³•å¤„ç†çªå‘æµé‡</strong>ï¼šç”±äºæ¼æ¡¶çš„å‡ºå£é€Ÿåº¦æ˜¯å›ºå®šçš„ï¼Œæ— æ³•å¤„ç†çªå‘æµé‡ã€‚é¢å¯¹çªå‘æµé‡çš„æ—¶å€™ï¼Œæ¼æ¡¶ç®—æ³•è¿˜æ˜¯å¾ªè§„è¹ˆçŸ©åœ°å¤„ç†è¯·æ±‚ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³çœ‹åˆ°çš„ã€‚æµé‡å˜çªå‘æ—¶ï¼Œæˆ‘ä»¬è‚¯å®šå¸Œæœ›ç³»ç»Ÿå°½é‡å¿«ç‚¹å¤„ç†è¯·æ±‚ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚</li><li><strong>å¯èƒ½ä¼šä¸¢å¤±æ•°æ®</strong>ï¼šå¦‚æœå…¥å£æµé‡è¿‡å¤§ï¼Œè¶…è¿‡äº†æ¡¶çš„å®¹é‡ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸¢å¼ƒéƒ¨åˆ†è¯·æ±‚ã€‚åœ¨ä¸€äº›ä¸èƒ½æ¥å—ä¸¢å¤±è¯·æ±‚çš„åœºæ™¯ä¸­ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚</li><li><strong>ä¸é€‚åˆé€Ÿç‡å˜åŒ–å¤§çš„åœºæ™¯</strong>ï¼šå¦‚æœé€Ÿç‡å˜åŒ–å¤§ï¼Œæˆ–è€…éœ€è¦åŠ¨æ€è°ƒæ•´é€Ÿç‡ï¼Œé‚£ä¹ˆæ¼æ¡¶ç®—æ³•å°±æ— æ³•æ»¡è¶³éœ€æ±‚ã€‚</li></ol><hr><hr><h2 id="ä»¤ç‰Œæ¡¶ç®—æ³•"><a href="#ä»¤ç‰Œæ¡¶ç®—æ³•" class="headerlink" title="ä»¤ç‰Œæ¡¶ç®—æ³•"></a>ä»¤ç‰Œæ¡¶ç®—æ³•</h2><h3 id="å®ç°åŸç†-3"><a href="#å®ç°åŸç†-3" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h3><p>ä»¤ç‰Œæ¡¶é™æµç®—æ³•æ˜¯ä¸€ç§å¸¸ç”¨çš„æµé‡æ•´å½¢å’Œé€Ÿç‡é™åˆ¶ç®—æ³•ã€‚ä¸æ¼æ¡¶ç®—æ³•ä¸€æ ·ï¼Œä»¤ç‰Œæ¡¶ç®—æ³•ä¹Ÿæ˜¯ç”¨æ¥æ§åˆ¶å‘é€åˆ°ç½‘ç»œä¸Šçš„æ•°æ®çš„æ•°é‡ã€‚</p><p>å®ç°åŸç†ï¼š</p><ol><li>ç³»ç»Ÿä»¥å›ºå®šçš„é€Ÿç‡å‘æ¡¶ä¸­æ·»åŠ ä»¤ç‰Œï¼›</li><li>å½“æœ‰è¯·æ±‚åˆ°æ¥æ—¶ï¼Œä¼šå°è¯•ä»æ¡¶ä¸­ç§»é™¤ä¸€ä¸ªä»¤ç‰Œï¼Œå¦‚æœæ¡¶ä¸­æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œï¼Œåˆ™è¯·æ±‚å¯ä»¥è¢«å¤„ç†æˆ–æ•°æ®åŒ…å¯ä»¥è¢«å‘é€ï¼›</li><li>å¦‚æœæ¡¶ä¸­æ²¡æœ‰ä»¤ç‰Œï¼Œé‚£ä¹ˆè¯·æ±‚å°†è¢«æ‹’ç»ï¼›</li><li>æ¡¶ä¸­çš„ä»¤ç‰Œæ•°ä¸èƒ½è¶…è¿‡æ¡¶çš„å®¹é‡ï¼Œå¦‚æœæ–°ç”Ÿæˆçš„ä»¤ç‰Œè¶…è¿‡äº†æ¡¶çš„å®¹é‡ï¼Œé‚£ä¹ˆæ–°çš„ä»¤ç‰Œä¼šè¢«ä¸¢å¼ƒã€‚</li></ol><p>ä»¤ç‰Œæ¡¶ç®—æ³•çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§æ˜¯ï¼Œå®ƒèƒ½å¤Ÿåº”å¯¹çªå‘æµé‡ã€‚å½“æ¡¶ä¸­æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œæ—¶ï¼Œå¯ä»¥ä¸€æ¬¡æ€§å¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œè¿™å¯¹äºéœ€è¦å¤„ç†çªå‘æµé‡çš„åº”ç”¨åœºæ™¯éå¸¸æœ‰ç”¨ã€‚ä½†æ˜¯åˆä¸ä¼šæ— é™åˆ¶çš„å¢åŠ å¤„ç†é€Ÿç‡å¯¼è‡´å‹å®æœåŠ¡å™¨ï¼Œå› ä¸ºæ¡¶å†…ä»¤ç‰Œæ•°é‡æ˜¯æœ‰é™åˆ¶çš„ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230902150018034.png" alt="image-20230902150018034" style="zoom:50%;" /></p><hr><h3 id="ä»£ç å®ç°-2"><a href="#ä»£ç å®ç°-2" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenBucketLimiter</span> <span class="keyword">implements</span> <span class="title class_">Limiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">threshold</span> <span class="operator">=</span> <span class="number">100</span>; <span class="comment">// æ¡¶çš„æœ€å¤§å®¹é‡</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// æ¡¶å†…å½“å‰çš„ä»¤ç‰Œæ•°é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">tokenRate</span> <span class="operator">=</span> <span class="number">10</span>; <span class="comment">// ä»¤ç‰Œç”Ÿæˆé€Ÿç‡ï¼ˆæ¯ç§’5æ¬¡ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">lastRefillTime</span> <span class="operator">=</span> System.currentTimeMillis(); <span class="comment">// ä¸Šæ¬¡ç”Ÿæˆä»¤ç‰Œçš„æ—¶é—´</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›trueè¡¨ç¤ºé™æµ</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">limit</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ç”Ÿæˆä»¤ç‰Œæ–¹æ³•</span></span><br><span class="line">        <span class="built_in">this</span>.refillTokens();</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ¡¶å†…æ˜¯å¦è¿˜æœ‰ä»¤ç‰Œ</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            count--;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”Ÿæˆä»¤ç‰Œæ–¹æ³•ï¼Œè®¡ç®—å¹¶æ›´æ–°è¿™æ®µæ—¶é—´å†…ç”Ÿæˆçš„ä»¤ç‰Œæ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refillTokens</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// è®¡ç®—è¿™æ®µæ—¶é—´å†…ï¼Œéœ€è¦ç”Ÿæˆçš„ä»¤ç‰Œæ•°é‡</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">refillTokens</span> <span class="operator">=</span> (currentTime - lastRefillTime) * tokenRate / <span class="number">1000</span>;</span><br><span class="line">        count = Math.min(count + refillTokens, threshold);</span><br><span class="line">        lastRefillTime = currentTime;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="ä¼˜ç¼ºç‚¹-3"><a href="#ä¼˜ç¼ºç‚¹-3" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h3><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ol><li><strong>å¯ä»¥å¤„ç†çªå‘æµé‡</strong>ï¼šä»¤ç‰Œæ¡¶ç®—æ³•å¯ä»¥å¤„ç†çªå‘æµé‡ã€‚å½“æ¡¶æ»¡æ—¶ï¼Œèƒ½å¤Ÿä»¥æœ€å¤§é€Ÿåº¦å¤„ç†è¯·æ±‚ã€‚è¿™å¯¹äºéœ€è¦å¤„ç†çªå‘æµé‡çš„åº”ç”¨åœºæ™¯éå¸¸æœ‰ç”¨ã€‚</li><li><strong>é™åˆ¶å¹³å‡é€Ÿç‡</strong>ï¼šåœ¨é•¿æœŸè¿è¡Œä¸­ï¼Œæ•°æ®çš„ä¼ è¾“ç‡ä¼šè¢«é™åˆ¶åœ¨é¢„å®šä¹‰çš„å¹³å‡é€Ÿç‡ï¼ˆå³ç”Ÿæˆä»¤ç‰Œçš„é€Ÿç‡ï¼‰ã€‚</li><li><strong>çµæ´»æ€§</strong>ï¼šä¸æ¼æ¡¶ç®—æ³•ç›¸æ¯”ï¼Œä»¤ç‰Œæ¡¶ç®—æ³•æä¾›äº†æ›´å¤§çš„çµæ´»æ€§ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥åŠ¨æ€åœ°è°ƒæ•´ç”Ÿæˆä»¤ç‰Œçš„é€Ÿç‡ã€‚</li></ol><p><strong>ç¼ºç‚¹ï¼š</strong></p><ol><li><strong>å¯èƒ½å¯¼è‡´è¿‡è½½</strong>ï¼šå¦‚æœä»¤ç‰Œäº§ç”Ÿçš„é€Ÿåº¦è¿‡å¿«ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¤§é‡çš„çªå‘æµé‡ï¼Œè¿™å¯èƒ½ä¼šä½¿ç½‘ç»œæˆ–æœåŠ¡è¿‡è½½ã€‚</li><li><strong>éœ€è¦å­˜å‚¨ç©ºé—´</strong>ï¼šä»¤ç‰Œæ¡¶éœ€è¦ä¸€å®šçš„å­˜å‚¨ç©ºé—´æ¥ä¿å­˜ä»¤ç‰Œï¼Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜èµ„æºçš„æµªè´¹ã€‚</li><li><strong>å®ç°ç¨å¤æ‚</strong>ï¼šç›¸æ¯”äºè®¡æ•°å™¨ç®—æ³•ï¼Œä»¤ç‰Œæ¡¶ç®—æ³•çš„å®ç°ç¨å¾®å¤æ‚ä¸€äº›ã€‚</li></ol><hr><hr><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><strong>å›ºå®šçª—å£ç®—æ³•</strong>å®ç°ç®€å•ï¼Œä½†æ˜¯é™æµä¸å¤Ÿå¹³æ»‘ï¼Œå­˜åœ¨çª—å£è¾¹ç•Œé—®é¢˜ï¼Œé€‚ç”¨äºéœ€è¦ç®€å•å®ç°é™æµçš„åœºæ™¯ã€‚</p><p><strong>æ»‘åŠ¨çª—å£ç®—æ³•</strong>è§£å†³äº†çª—å£è¾¹ç•Œé—®é¢˜ï¼Œä½†æ˜¯è¿˜æ˜¯å­˜åœ¨é™æµä¸å¤Ÿå¹³æ»‘çš„é—®é¢˜ï¼Œé€‚ç”¨äºéœ€è¦æ§åˆ¶å¹³å‡è¯·æ±‚é€Ÿç‡çš„åœºæ™¯ã€‚</p><p><strong>æ¼æ¡¶ç®—æ³•</strong>çš„ä¼˜ç‚¹æ˜¯æµé‡å¤„ç†æ›´å¹³æ»‘ï¼Œä½†æ˜¯æ— æ³•åº”å¯¹çªå‘æµé‡ï¼Œé€‚ç”¨äºéœ€è¦å¹³æ»‘æµé‡çš„åœºæ™¯ã€‚</p><p><strong>ä»¤ç‰Œæ¡¶ç®—æ³•</strong>æ—¢èƒ½å¹³æ»‘æµé‡ï¼Œåˆèƒ½å¤„ç†çªå‘æµé‡ï¼Œé€‚ç”¨äºéœ€è¦å¤„ç†çªå‘æµé‡çš„åœºæ™¯ã€‚</p>]]></content>
    
    
    <summary type="html">å›ºå®šçª—å£ã€æ»‘åŠ¨çª—å£ã€æ¼æ¡¶å’Œä»¤ç‰Œæ¡¶é™æµ</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="é™æµç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>äºŒåˆ†æŸ¥æ‰¾-çº¢è“è¾¹ç•Œæ³•</title>
    <link href="https://wuwawawa.github.io/posts/c1110203.html"/>
    <id>https://wuwawawa.github.io/posts/c1110203.html</id>
    <published>2023-08-11T06:49:12.000Z</published>
    <updated>2023-09-14T13:32:08.638Z</updated>
    
    <content type="html"><![CDATA[<p>äºŒåˆ†æŸ¥æ‰¾æ˜¯ä¸€ç§åœ¨æœ‰åºæ•°ç»„ä¸­æŸ¥æ‰¾æŸä¸€ç‰¹å®šå…ƒç´ çš„æœç´¢ç®—æ³•ã€‚åœ¨å¾ˆå¤šäººçš„å°è±¡é‡Œï¼ŒäºŒåˆ†æŸ¥æ‰¾æ˜¯ä¸€ç§æ¯”è¾ƒç®€å•çš„ç®—æ³•ã€‚ç„¶è€Œåœ¨å®é™…ä¸­ï¼ŒäºŒåˆ†æŸ¥æ‰¾ç»å¸¸å®¹æ˜“å†™é”™ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†è¾¹ç•Œæ¡ä»¶çš„æ—¶å€™ã€‚ç®—æ³•å¤§ç¥é«˜å¾·çº³æ›¾ç»è¯´è¿‡ï¼Œâ€œè™½ç„¶äºŒåˆ†æŸ¥æ‰¾çš„åŸºæœ¬æ€æƒ³ç›¸å¯¹ç®€å•ç›´ç™½ï¼Œä½†æ˜¯ç»†èŠ‚ä¸Šå´æƒŠäººçš„trickyâ€ã€‚</p><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>ç»™å®šæœ‰åºæ•°ç»„<code>1 2 3 5 5 5 8 9</code>ï¼Œæœ‰4ä¸ªå°é—®é¢˜åˆ†åˆ«æ˜¯ï¼š</p><p>1) æ‰¾åˆ°ç¬¬ä¸€ä¸ª<code>&gt;=5</code>çš„å…ƒç´ </p><p>2) æ‰¾åˆ°æœ€åä¸€ä¸ª<code>&lt;5</code>çš„å…ƒç´ </p><p>3) æ‰¾åˆ°ç¬¬ä¸€ä¸ª<code>&gt;5</code>çš„å…ƒç´ </p><p>4) æ‰¾åˆ°æœ€åä¸€ä¸ª<code>&lt;=5</code>çš„å…ƒç´ </p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230715195248912.png" alt="image-20230715195248912" style="zoom: 50%;" /></p><p>å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºè¿™å››ä¸ªé—®é¢˜æ¥è¯´ï¼Œå®ƒä»¬è¡¨é¢ä¸Šæ˜¯æ¯”è¾ƒç›¸ä¼¼çš„ï¼Œä½†æ˜¯ç»†èŠ‚ä¸Šå´æœ‰äº›å¾®çš„ä¸åŒï¼Œå®ƒä»¬çš„ç­”æ¡ˆä¹Ÿæ˜¯å®Œå…¨ä¸åŒçš„ã€‚</p><p>å¯æƒ³è€ŒçŸ¥ï¼Œå¦‚æœæˆ‘ä»¬ç”¨äºŒåˆ†æŸ¥æ‰¾æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç»†èŠ‚å¤„ç†å¹¶ä¸å®¹æ˜“ï¼Œä¸€ä¸å°å¿ƒå¯èƒ½å°±ä¼šå‡ºé”™ã€‚</p><hr><hr><h2 id="æ–°çš„è§’åº¦"><a href="#æ–°çš„è§’åº¦" class="headerlink" title="æ–°çš„è§’åº¦"></a>æ–°çš„è§’åº¦</h2><p>è®©æˆ‘ä»¬æš‚æ—¶å¿˜æ‰åˆšæ‰çš„é—®é¢˜ï¼Œä»ä¸€ä¸ªå…¨æ–°çš„è§’åº¦æ¥å®¡è§†äºŒåˆ†æŸ¥æ‰¾ã€‚</p><p>å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢ä¸€å…±æœ‰Nä¸ªå…ƒç´ ï¼Œè¿™äº›å…ƒç´ çš„ç¼–å·æ˜¯0åˆ°N-1ã€‚åœ¨è¿™Nä¸ªå…ƒç´ é‡Œé¢ï¼Œå‰Kä¸ªå…ƒç´ é¢œè‰²æ˜¯è“è‰²ï¼Œåé¢çš„å…ƒç´ æ˜¯çº¢è‰²ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716093005464.png" alt="image-20230716093005464" style="zoom:80%;" /></p><p>ç„¶è€Œï¼Œåœ¨è¿™ä¸ªé—®é¢˜ä¸­ï¼Œè“çº¢è¾¹ç•Œçš„ä½ç½®æ˜¯æœªçŸ¥çš„ï¼Œå³Kæ˜¯æœªçŸ¥çš„ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨æˆ‘ä»¬ä¸€å¼€å§‹æ‹¿åˆ°æ•°ç»„çš„æ—¶å€™ï¼Œæ•´ä¸ªæ•°ç»„éƒ½æ˜¯ç°è‰²çš„ã€‚è¿™ä¸ªé—®é¢˜çš„æœ€ç»ˆç›®æ ‡ï¼Œæ˜¯æŠŠè“çº¢è¾¹ç•Œæ‰¾å‡ºæ¥ï¼Œå³æ±‚å‡ºæœªçŸ¥æ•°Kã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716093139742.png" alt="image-20230716093139742" style="zoom:80%;" /></p><hr><h2 id="æœ´ç´ ç®—æ³•"><a href="#æœ´ç´ ç®—æ³•" class="headerlink" title="æœ´ç´ ç®—æ³•"></a>æœ´ç´ ç®—æ³•</h2><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å‡è®¾ä¸€å…±æœ‰9ä¸ªå…ƒç´ ï¼Œå‰é¢5ä¸ªå…ƒç´ æ˜¯è“è‰²ï¼Œåé¢4ä¸ªå…ƒç´ æ˜¯çº¢è‰²</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716093644294.png" alt="image-20230716093644294"></p><p>åœ¨æˆ‘ä»¬ä¸€å¼€å§‹æ‹¿åˆ°æ•°ç»„çš„æ—¶å€™ï¼Œæ•´ä¸ªæ•°ç»„éƒ½æ˜¯ç°è‰²çš„ã€‚</p><p>æˆ‘ä»¬å¯ä»¥è®¾è®¡ä¸€ä¸ªè“è‰²æŒ‡é’ˆï¼Œä¸€å¼€å§‹æŒ‡å‘æœ€å·¦é¢ï¼Œéšåä¸æ–­å‘å³ç§»åŠ¨ï¼Œç›´åˆ°ç§»åŠ¨åˆ°è“çº¢è¾¹ç•Œã€‚æˆ–è€…è®¾è®¡ä¸€ä¸ªçº¢è‰²æŒ‡é’ˆï¼Œä¸€å¼€å§‹æŒ‡å‘æœ€å³é¢ï¼Œç„¶åä¸æ–­å‘å·¦ç§»åŠ¨ï¼Œç›´åˆ°ç§»åŠ¨åˆ°è“çº¢è¾¹ç•Œã€‚</p><p>è¿™æ ·å°±æ±‚å¾—äº†è“çº¢è¾¹ç•Œæ‰€åœ¨çš„ä½ç½®ã€‚</p><p>å½“ç„¶ï¼Œè¿™ç§ç®—æ³•æ˜¯éå¸¸ä½æ•ˆçš„ï¼Œå®ƒçš„ç®—æ³•å¤æ‚åº¦æ˜¯O(nï¼‰</p><hr><h2 id="äºŒåˆ†æŸ¥æ‰¾"><a href="#äºŒåˆ†æŸ¥æ‰¾" class="headerlink" title="äºŒåˆ†æŸ¥æ‰¾"></a>äºŒåˆ†æŸ¥æ‰¾</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä½•é€šè¿‡äºŒåˆ†æŸ¥æ‰¾é«˜æ•ˆçš„å¯»æ‰¾åˆ°è“çº¢è¾¹ç•Œï¼Œåœ¨åˆšæ‰çš„æœ´ç´ ç®—æ³•ä¸­ï¼Œæˆ‘ä»¬æŒç»­ä¸æ–­çš„å°†è“è‰²æŒ‡é’ˆå‘å³ç§»åŠ¨ã€‚å¯¹äºè¿™ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒç†è§£ä¸ºè“è‰²åŒºåŸŸä¸æ–­è¢«æ‹“å±•ã€‚åŒç†ï¼Œçº¢è‰²æŒ‡é’ˆä¸æ–­å‘å·¦ç§»åŠ¨ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªè¿‡ç¨‹ç†è§£ä¸ºçº¢è‰²åŒºåŸŸä¸æ–­è¢«æ‹“å±•ã€‚</p><p>æœ´ç´ ç®—æ³•ä¹‹æ‰€ä»¥æ•ˆç‡ä½ä¸‹ï¼Œæ˜¯å› ä¸ºè“è‰²åŒºåŸŸå’Œçº¢è‰²åŒºåŸŸçš„æ‹“å±•æ˜¯ç¼“æ…¢è¿›è¡Œçš„ï¼Œæ¯æ¬¡åªèƒ½æ‹“å±•ä¸€ä¸ªå…ƒç´ ã€‚</p><hr><h3 id="åŸºæœ¬æ­¥éª¤"><a href="#åŸºæœ¬æ­¥éª¤" class="headerlink" title="åŸºæœ¬æ­¥éª¤"></a>åŸºæœ¬æ­¥éª¤</h3><blockquote><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•æ¥åŠ é€Ÿä¸¤ä¸ªåŒºåŸŸçš„æ‹“å±•è¿‡ç¨‹å‘¢ï¼Ÿ</p></blockquote><div class="tabs" id="c747378e-3702-44cf-8e98-a9f5063d2056"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c747378e-3702-44cf-8e98-a9f5063d2056-1"><i class="fas fa-seedling"></i>å¾ªç¯æ¬¡æ•°1</button></li><li class="tab"><button type="button" data-href="#c747378e-3702-44cf-8e98-a9f5063d2056-2"><i class="fas fa-leaf"></i>å¾ªç¯æ¬¡æ•°2</button></li><li class="tab"><button type="button" data-href="#c747378e-3702-44cf-8e98-a9f5063d2056-3"><i class="fab fa-apple"></i>å¾ªç¯æ¬¡æ•°3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c747378e-3702-44cf-8e98-a9f5063d2056-1"><p>æˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥çœ‹ä¸€ä¸‹ç°è‰²åŒºåŸŸæœ€ä¸­é—´çš„é‚£ä¸ªå…ƒç´ é¢œè‰²ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716094245363.png" alt="image-20230716094245363"></p><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å‘ç°è¿™ä¸ªå…ƒç´ é¢œè‰²ä¸ºè“è‰²ã€‚å®ƒå°±æ„å‘³ç€ï¼Œè¿™ä¸ªå…ƒç´ ï¼Œä»¥åŠè¿™ä¸ªå…ƒç´ ä¹‹å‰æ‰€æœ‰çš„å…ƒç´ éƒ½æ˜¯è“è‰²ã€‚è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥ç›´æ´å°†è“è‰²åŒºåŸŸæ‹“å±•åˆ°è¿™ä¸ªå…ƒç´ æ‰€åœ¨ä½ç½®ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716094329526.png" alt="image-20230716094329526"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c747378e-3702-44cf-8e98-a9f5063d2056-2"><p>è®©æˆ‘ä»¬ç»§ç»­è¿™æ ·çš„æ“ä½œã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716094455062.png" alt="image-20230716094455062"></p><p>è§‚å¯Ÿç°è‰²åŒºåŸŸä¸­æœ€ä¸­é—´çš„é‚£ä¸ªå…ƒç´ é¢œè‰²ï¼Œæˆ‘ä»¬å‘ç°å®ƒæ˜¯çº¢è‰²ï¼Œè¿™ä¹Ÿå°±è¯´æ˜äº†ï¼Œè¿™ä¸ªå…ƒç´ ä»¥åŠè¿™ä¸ªå…ƒç´ åé¢çš„å…ƒç´ éƒ½æ˜¯çº¢è‰²ã€‚è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥ç›´æ¥å°†çº¢è‰²åŒºåŸŸæ‹“å±•åˆ°è¿™ä¸ªå…ƒç´ æ‰€åœ¨çš„ä½ç½®ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716094652765.png" alt="image-20230716094652765"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c747378e-3702-44cf-8e98-a9f5063d2056-3"><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸æ–­çš„é‡å¤è¿™ç§æ“ä½œ</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716094835833.png" alt="image-20230716094835833"></p><p>ç›´åˆ°æœ€åï¼Œæˆ‘ä»¬ä¾¿æ‰¾åˆ°äº†è“çº¢è¾¹ç•Œ</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716094859442.png" alt="image-20230716094859442"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="ä¼ªä»£ç å®ç°"><a href="#ä¼ªä»£ç å®ç°" class="headerlink" title="ä¼ªä»£ç å®ç°"></a>ä¼ªä»£ç å®ç°</h3><div class="tabs" id="33539071-8bba-4bca-a801-0931002f5bff"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#33539071-8bba-4bca-a801-0931002f5bff-1"><i class="fas fa-seedling"></i>1</button></li><li class="tab"><button type="button" data-href="#33539071-8bba-4bca-a801-0931002f5bff-2"><i class="fas fa-leaf"></i>2</button></li><li class="tab"><button type="button" data-href="#33539071-8bba-4bca-a801-0931002f5bff-3"><i class="fab fa-apple"></i>3</button></li><li class="tab"><button type="button" data-href="#33539071-8bba-4bca-a801-0931002f5bff-4"><i class="fas fa-tree"></i>4</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="33539071-8bba-4bca-a801-0931002f5bff-1"><p>ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬è®¾è®¡Lï¼ŒRä¸¤ä¸ªæŒ‡é’ˆï¼ŒLæŒ‡å‘-1,RæŒ‡å‘N</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716095333538.png" alt="image-20230716095333538"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="33539071-8bba-4bca-a801-0931002f5bff-2"><p>å½“L+1ï¼=Rçš„æ—¶å€™ï¼Œå°±ä¼šè¿›å…¥å¾ªç¯ä½“ã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬æ±‚å¾—ç°è‰²åŒºåŸŸä¸­é—´çš„é‚£ä¸ªå…ƒç´ ä½ç½®Mï¼ŒM=(L+R) /2å¹¶ä¸”å‘ä¸‹å–æ•´ã€‚å¦‚æœMçš„é¢œè‰²æ˜¯è“è‰²ï¼Œæˆ‘ä»¬å°±å°†Lèµ‹å€¼ä¸ºMï¼Œä¹Ÿå°±æ˜¯å°†è“è‰²åŒºåŸŸæ‹“å±•åˆ°Mã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716095536554.png" alt="image-20230716095536554"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="33539071-8bba-4bca-a801-0931002f5bff-3"><p>å¦‚æœMçš„é¢œè‰²æ˜¯çº¢è‰²ï¼Œæˆ‘ä»¬ä¾¿å°†Rèµ‹å€¼ä¸ºMï¼Œä¹Ÿå°±æ˜¯å°†çº¢è‰²åŒºåŸŸæ‹“å±•åˆ°M</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716095650860.png" alt="image-20230716095650860"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="33539071-8bba-4bca-a801-0931002f5bff-4"><p>æˆ‘ä»¬æŒç»­ä¸æ–­çš„é‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œç›´åˆ°è¾¾æˆL+1=Rè¿™ä¸ªæ¡ä»¶ï¼Œä¾¿é€€å‡ºå¾ªç¯ã€‚</p><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼ŒLå’ŒRåˆšåˆšå¥½æŒ‡å‘è“çº¢è¾¹ç•Œï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å®é™…æƒ…å†µæ¥å†³å®šè¿”å›Lè¿˜æ˜¯Rã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716095837237.png" alt="image-20230716095837237"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><h3 id="ç»†èŠ‚é—®é¢˜"><a href="#ç»†èŠ‚é—®é¢˜" class="headerlink" title="ç»†èŠ‚é—®é¢˜"></a>ç»†èŠ‚é—®é¢˜</h3><p>åˆšåˆšæˆ‘ç»çš„äºŒåˆ†æŸ¥æ‰¾ä¼ªä»£ç ï¼Œå¯èƒ½å’Œå¤§å®¶åœ¨å…¶ä»–åœ°æ–¹æ‰€çœ‹åˆ°çš„ç‰ˆæœ¬æœ‰æ‰€ä¸åŒã€‚ä¸ºäº†è¿›ä¸€æ­¥è¯æ˜ç®—æ³•çš„æ­£ç¡®æ€§ï¼Œè®©æˆ‘ä»¬çœ‹å‡ ä¸ªç»†èŠ‚é—®é¢˜ã€‚</p><blockquote><p>ä¸ºä»€ä¹ˆ<span class='p blue'>L</span>çš„åˆå§‹å€¼ä¸º-1ï¼Œ<span class='p red'>R</span>çš„åˆå§‹å€¼ä¸ºN?</p></blockquote><p>éš¾é“æˆ‘ä»¬ä¸èƒ½å°†Låˆå§‹åŒ–ä¸º0ï¼Œæˆ–è€…è®©Råˆå§‹åŒ–ä¸ºN-1ä¹ˆ?</p><p>ç­”æ¡ˆæ˜¯ä¸å¯ä»¥</p><p>è¯•æƒ³ä¸€ä¸‹ï¼Œå‡å¦‚æ•´ä¸ªæ•°ç»„éƒ½æ˜¯çº¢è‰²,é‚£ä¹ˆå¦‚æœè®©Låˆå§‹åŒ–ä¸º0ï¼ŒLä¸€å¼€å§‹ä¾¿å¤„äºçº¢è‰²åŒºåŸŸå†…ï¼Œè¿™ä¹Ÿä¾¿ä¼šé€ æˆé”™è¯¯ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716100233717.png" alt="image-20230716100233717"></p><p>åŒç†ï¼Œå¦‚æœæ•´ä¸ªæ•°ç»„éƒ½æ˜¯è“è‰²ï¼Œé‚£ä¹ˆå¦‚æœè®©Råˆå§‹åŒ–ä¸ºN-1ï¼ŒRä¸€å¼€å§‹ä¾¿å¤„äºè“è‰²åŒºåŸŸï¼Œä¹Ÿå°±é€ æˆäº†é”™è¯¯ã€‚</p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716100344067.png" alt="image-20230716100344067"></p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦è®©Låˆå§‹åŒ–ä¸º-1ï¼ŒRåˆå§‹åŒ–ä¸ºNã€‚</p><hr><blockquote><p>æ›´æ–°æŒ‡é’ˆæ—¶ï¼Œèƒ½ä¸èƒ½å†™æˆL=m+1ï¼Œæˆ–è€…R=m-1?</p></blockquote><p>æ¯”å¦‚è¯´ï¼Œå¯¹äºè¿™æ ·ä¸€ç§æƒ…å†µï¼Œåœ¨æŸæ¬¡å¾ªç¯ä¸­ï¼ŒMåˆšåˆšå¥½æŒ‡å‘è“è‰²åŒºåŸŸçš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬è®©Lå˜æˆM+1ï¼Œå°±ä¼šè®©LæŒ‡å‘çº¢è‰²åŒºåŸŸï¼Œè¿™æ ·å°±é€ æˆäº†é”™è¯¯ã€‚ </p><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716100809314.png" alt="image-20230716100809314"></p><hr><h2 id="é—®é¢˜ç­”æ¡ˆ"><a href="#é—®é¢˜ç­”æ¡ˆ" class="headerlink" title="é—®é¢˜ç­”æ¡ˆ"></a>é—®é¢˜ç­”æ¡ˆ</h2><p><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230716100920458.png" alt="image-20230716100920458"></p><hr><h2 id="ä¸€èˆ¬æµç¨‹"><a href="#ä¸€èˆ¬æµç¨‹" class="headerlink" title="ä¸€èˆ¬æµç¨‹"></a>ä¸€èˆ¬æµç¨‹</h2><ul><li>å»ºæ¨¡ï¼šåˆ’åˆ†<span class='p blue'>è“</span><span class='p red'>çº¢</span>åŒºåŸŸï¼Œç¡®å®š<code>isBlue()</code>å‡½æ•°</li><li>ç¡®å®šè¿”å›<span class='p blue'>L</span>è¿˜æ˜¯<span class='p red'>R</span></li><li>å¥—ç”¨ç®—æ³•æ¨¡ç‰ˆ</li><li>åå¤„ç†é€»è¾‘</li></ul>]]></content>
    
    
    <summary type="html">äºŒåˆ†æŸ¥æ‰¾</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>äºŒåˆ†æŸ¥æ‰¾</title>
    <link href="https://wuwawawa.github.io/posts/e8eb0480.html"/>
    <id>https://wuwawawa.github.io/posts/e8eb0480.html</id>
    <published>2023-08-10T02:28:21.000Z</published>
    <updated>2023-09-14T13:32:14.856Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¯»æ‰¾ä¸€ä¸ªæ•°-åŸºæœ¬çš„äºŒåˆ†æŸ¥æ‰¾"><a href="#å¯»æ‰¾ä¸€ä¸ªæ•°-åŸºæœ¬çš„äºŒåˆ†æŸ¥æ‰¾" class="headerlink" title="å¯»æ‰¾ä¸€ä¸ªæ•°(åŸºæœ¬çš„äºŒåˆ†æŸ¥æ‰¾)"></a>å¯»æ‰¾ä¸€ä¸ªæ•°(åŸºæœ¬çš„äºŒåˆ†æŸ¥æ‰¾)</h2><p>è¿™ä¸ªåœºæ™¯æ˜¯æœ€ç®€å•çš„ï¼Œè‚¯èƒ½ä¹Ÿæ˜¯å¤§å®¶æœ€ç†Ÿæ‚‰çš„ï¼Œå³æœç´¢ä¸€ä¸ªæ•°ï¼Œå¦‚æœå­˜åœ¨ï¼Œè¿”å›å…¶ç´¢å¼•ï¼Œå¦åˆ™è¿”å› -1ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">binarySearch</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> nums.length - <span class="number">1</span>; <span class="comment">// æ³¨æ„</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(left &lt;= right) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> left + (right - left) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span>(nums[mid] == target)</span><br><span class="line">            <span class="keyword">return</span> mid;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nums[mid] &lt; target)</span><br><span class="line">            left = mid + <span class="number">1</span>; <span class="comment">// æ³¨æ„</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nums[mid] &gt; target)</span><br><span class="line">            right = mid - <span class="number">1</span>; <span class="comment">// æ³¨æ„</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ç‚¹åˆ†æ</p></blockquote><div class="tabs" id="5c9537ee-7214-4745-8b2a-37749be89f75"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#5c9537ee-7214-4745-8b2a-37749be89f75-1"><i class="fas fa-seedling"></i>whileå¾ªç¯é€€å‡ºæ¡ä»¶</button></li><li class="tab"><button type="button" data-href="#5c9537ee-7214-4745-8b2a-37749be89f75-2"><i class="fas fa-leaf"></i>lå’Œræ›´æ–°</button></li><li class="tab"><button type="button" data-href="#5c9537ee-7214-4745-8b2a-37749be89f75-3"><i class="fab fa-apple"></i>ç¼ºé™·</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="5c9537ee-7214-4745-8b2a-37749be89f75-1"><p><mark class="hl-label blue">ä¸ºä»€ä¹ˆwhileå¾ªç¯çš„æ¡ä»¶ä¸­æ˜¯&lt;=è€Œä¸æ˜¯&lt;</mark> </p><p>å› ä¸ºåˆå§‹åŒ– <code>right</code> çš„èµ‹å€¼æ˜¯ <code>nums.length - 1</code>ï¼Œå³æœ€åä¸€ä¸ªå…ƒç´ çš„ç´¢å¼•ï¼Œè€Œä¸æ˜¯ <code>nums.length</code></p><p>è¿™äºŒè€…å¯èƒ½å‡ºç°åœ¨ä¸åŒåŠŸèƒ½çš„äºŒåˆ†æŸ¥æ‰¾ä¸­ï¼ŒåŒºåˆ«æ˜¯ï¼šå‰è€…ç›¸å½“äºä¸¤ç«¯éƒ½é—­åŒºé—´ <code>[left, right]</code>ï¼Œåè€…ç›¸å½“äºå·¦é—­å³å¼€åŒºé—´ <code>[left, right)</code>ï¼Œå› ä¸ºç´¢å¼•å¤§å°ä¸º <code>nums.length</code> æ˜¯è¶Šç•Œçš„ã€‚</p><p>æˆ‘ä»¬è¿™ä¸ªç®—æ³•ä¸­ä½¿ç”¨çš„æ˜¯å‰è€… <code>[left, right]</code> ä¸¤ç«¯éƒ½é—­çš„åŒºé—´ã€‚</p><p><code>while(left &lt;= right)</code> çš„ç»ˆæ­¢æ¡ä»¶æ˜¯ <code>left == right + 1</code>ï¼Œå†™æˆåŒºé—´çš„å½¢å¼å°±æ˜¯ <code>[right + 1, right]</code>ï¼Œæˆ–è€…å¸¦ä¸ªå…·ä½“çš„æ•°å­—è¿›å» <code>[3, 2]</code>ï¼Œå¯è§<strong>è¿™æ—¶å€™åŒºé—´ä¸ºç©º</strong>ï¼Œå› ä¸ºæ²¡æœ‰ç´¢å¼•æ—¢å¤§äºç­‰äº 3 åˆå°äºç­‰äº 2 çš„å§ã€‚æ‰€ä»¥è¿™æ—¶å€™ while å¾ªç¯ç»ˆæ­¢æ˜¯æ­£ç¡®çš„ï¼Œç›´æ¥è¿”å› -1 å³å¯ã€‚</p><p><code>while(left &lt; right)</code> çš„ç»ˆæ­¢æ¡ä»¶æ˜¯ <code>left == right</code>ï¼Œå†™æˆåŒºé—´çš„å½¢å¼å°±æ˜¯ <code>[left, right]</code>ï¼Œæˆ–è€…å¸¦ä¸ªå…·ä½“çš„æ•°å­—è¿›å» <code>[2, 2]</code>ï¼Œ<strong>è¿™æ—¶å€™åŒºé—´éç©º</strong>ï¼Œè¿˜æœ‰ä¸€ä¸ªæ•° 2ï¼Œä½†æ­¤æ—¶ while å¾ªç¯ç»ˆæ­¢äº†ã€‚ä¹Ÿå°±æ˜¯è¯´è¿™åŒºé—´ <code>[2, 2]</code> è¢«æ¼æ‰äº†ï¼Œç´¢å¼• 2 æ²¡æœ‰è¢«æœç´¢ï¼Œå¦‚æœè¿™æ—¶å€™ç›´æ¥è¿”å› -1 å°±æ˜¯é”™è¯¯çš„ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5c9537ee-7214-4745-8b2a-37749be89f75-2"><p>ä»€ä¹ˆ <code>left = mid + 1</code>ï¼Œ<code>right = mid - 1</code>ï¼Ÿæˆ‘çœ‹æœ‰çš„ä»£ç æ˜¯ <code>right = mid</code> æˆ–è€… <code>left = mid</code>ï¼Œæ²¡æœ‰è¿™äº›åŠ åŠ å‡å‡ï¼Œåˆ°åº•æ€ä¹ˆå›äº‹ï¼Œæ€ä¹ˆåˆ¤æ–­ï¼Ÿ</p><p>åˆšæ‰æ˜ç¡®äº†ã€Œæœç´¢åŒºé—´ã€è¿™ä¸ªæ¦‚å¿µï¼Œè€Œä¸”æœ¬ç®—æ³•çš„æœç´¢åŒºé—´æ˜¯ä¸¤ç«¯éƒ½é—­çš„ï¼Œå³ <code>[left, right]</code>ã€‚é‚£ä¹ˆå½“æˆ‘ä»¬å‘ç°ç´¢å¼• <code>mid</code> ä¸æ˜¯è¦æ‰¾çš„ <code>target</code> æ—¶ï¼Œä¸‹ä¸€æ­¥åº”è¯¥å»æœç´¢å“ªé‡Œå‘¢ï¼Ÿ</p><p>å½“ç„¶æ˜¯å»æœç´¢ <code>[left, mid-1]</code> æˆ–è€… <code>[mid+1, right]</code> å¯¹ä¸å¯¹ï¼Ÿå› ä¸º <code>mid</code> å·²ç»æœç´¢è¿‡ï¼Œåº”è¯¥ä»æœç´¢åŒºé—´ä¸­å»é™¤ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5c9537ee-7214-4745-8b2a-37749be89f75-3"><p>æ¯”å¦‚è¯´ç»™ä½ æœ‰åºæ•°ç»„ <code>nums = [1,2,2,2,3]</code>ï¼Œ<code>target</code> ä¸º 2ï¼Œæ­¤ç®—æ³•è¿”å›çš„ç´¢å¼•æ˜¯ 2ï¼Œæ²¡é”™ã€‚ä½†æ˜¯å¦‚æœæˆ‘æƒ³å¾—åˆ° <code>target</code> çš„å·¦ä¾§è¾¹ç•Œï¼Œå³ç´¢å¼• 1ï¼Œæˆ–è€…æˆ‘æƒ³å¾—åˆ° <code>target</code> çš„å³ä¾§è¾¹ç•Œï¼Œå³ç´¢å¼• 3ï¼Œè¿™æ ·çš„è¯æ­¤ç®—æ³•æ˜¯æ— æ³•å¤„ç†çš„ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><hr><hr><h2 id="å¯»æ‰¾ç¬¬ä¸€ä¸ªæ»¡è¶³è¯¥æ¡ä»¶çš„å€¼"><a href="#å¯»æ‰¾ç¬¬ä¸€ä¸ªæ»¡è¶³è¯¥æ¡ä»¶çš„å€¼" class="headerlink" title="å¯»æ‰¾ç¬¬ä¸€ä¸ªæ»¡è¶³è¯¥æ¡ä»¶çš„å€¼"></a>å¯»æ‰¾ç¬¬ä¸€ä¸ªæ»¡è¶³è¯¥æ¡ä»¶çš„å€¼</h2><p>å½“ check(mid) == true è°ƒæ•´çš„æ˜¯ r æ—¶ï¼šè®¡ç®— mid çš„æ–¹å¼åº”è¯¥ä¸º mid = l + r &gt;&gt; 1</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">   <span class="built_in">int</span> l = <span class="number">0</span>, r = <span class="built_in">n</span> - <span class="number">1</span>;</span><br><span class="line">while (l &lt; r) &#123;</span><br><span class="line">       <span class="built_in">int</span> <span class="built_in">mid</span> = l + r &gt;&gt; <span class="number">1</span>; //æ¨èå†™æ³• <span class="built_in">int</span> <span class="built_in">mid</span> = l +( r - l) / <span class="number">2</span>;</span><br><span class="line">       <span class="built_in">if</span> (check(<span class="built_in">mid</span>)) &#123;</span><br><span class="line">           //åç§»r, æ±‚ç¬¬ä¸€ä¸ªæ»¡è¶³è¯¥æ¡ä»¶çš„å€¼</span><br><span class="line">           r = <span class="built_in">mid</span>;</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           l = <span class="built_in">mid</span> + <span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2 id="å¯»æ‰¾æœ€åä¸€ä¸ªæ»¡è¶³è¯¥æ¡ä»¶çš„å€¼"><a href="#å¯»æ‰¾æœ€åä¸€ä¸ªæ»¡è¶³è¯¥æ¡ä»¶çš„å€¼" class="headerlink" title="å¯»æ‰¾æœ€åä¸€ä¸ªæ»¡è¶³è¯¥æ¡ä»¶çš„å€¼"></a>å¯»æ‰¾æœ€åä¸€ä¸ªæ»¡è¶³è¯¥æ¡ä»¶çš„å€¼</h2><p>å½“ check(mid) == true è°ƒæ•´çš„æ˜¯ l æ—¶ï¼šè®¡ç®— mid çš„æ–¹å¼åº”è¯¥ä¸º mid = l + r + 1 &gt;&gt; 1</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="type">int</span> <span class="variable">l</span> <span class="operator">=</span> <span class="number">0</span>, r = n - <span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span> (l &lt; r) &#123;</span><br><span class="line">       <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> l + r + <span class="number">1</span> &gt;&gt; <span class="number">1</span>;<span class="comment">//å‘ä¸Šå–æ•´ï¼Œ +1 æ“ä½œä¸»è¦æ˜¯ä¸ºäº†é¿å…å‘ç”Ÿã€Œæ­»å¾ªç¯ã€</span></span><br><span class="line">       <span class="keyword">if</span> (check(mid)) &#123;</span><br><span class="line">           <span class="comment">//åç§»l, æ±‚æœ€åä¸€ä¸ªæ»¡è¶³è¯¥æ¡ä»¶çš„å€¼</span></span><br><span class="line">           l = mid;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           r = mid - <span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">äºŒåˆ†æŸ¥æ‰¾</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>å›æº¯</title>
    <link href="https://wuwawawa.github.io/posts/f92eff5d.html"/>
    <id>https://wuwawawa.github.io/posts/f92eff5d.html</id>
    <published>2023-08-02T04:06:11.000Z</published>
    <updated>2023-09-14T01:35:44.175Z</updated>
    
    <content type="html"><![CDATA[<h2 id="åˆ’åˆ†kä¸ªç›¸ç­‰çš„å­é›†"><a href="#åˆ’åˆ†kä¸ªç›¸ç­‰çš„å­é›†" class="headerlink" title="åˆ’åˆ†kä¸ªç›¸ç­‰çš„å­é›†"></a>åˆ’åˆ†kä¸ªç›¸ç­‰çš„å­é›†</h2><div class="tabs" id="a5be2cec-b383-4537-9ec2-3406ea64a6ae"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#a5be2cec-b383-4537-9ec2-3406ea64a6ae-1"><i class="fas fa-seedling"></i>ç«æŸ´æ‹¼æ­£æ–¹å½¢</button></li><li class="tab"><button type="button" data-href="#a5be2cec-b383-4537-9ec2-3406ea64a6ae-2"><i class="fas fa-leaf"></i>åˆ’åˆ†ä¸ºkä¸ªç›¸ç­‰çš„å­é›†</button></li><li class="tab"><button type="button" data-href="#a5be2cec-b383-4537-9ec2-3406ea64a6ae-3"><i class="fab fa-apple"></i>3</button></li><li class="tab"><button type="button" data-href="#a5be2cec-b383-4537-9ec2-3406ea64a6ae-4"><i class="fas fa-tree"></i>4</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="a5be2cec-b383-4537-9ec2-3406ea64a6ae-1"><div class="tag link"><a class="link-card" title="473. ç«æŸ´æ‹¼æ­£æ–¹å½¢" href="https://leetcode.cn/problems/matchsticks-to-square/"><div class="left"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/leetcode.jpg"/></div><div class="right"><p class="text">473. ç«æŸ´æ‹¼æ­£æ–¹å½¢</p><p class="url">https://leetcode.cn/problems/matchsticks-to-square/</p></div></a></div><p>ä½ å°†å¾—åˆ°ä¸€ä¸ªæ•´æ•°æ•°ç»„ matchsticks ï¼Œå…¶ä¸­ matchsticks[i] æ˜¯ç¬¬ i ä¸ªç«æŸ´æ£’çš„é•¿åº¦ã€‚ä½ è¦ç”¨ æ‰€æœ‰çš„ç«æŸ´æ£ æ‹¼æˆä¸€ä¸ªæ­£æ–¹å½¢ã€‚ä½  ä¸èƒ½æŠ˜æ–­ ä»»ä½•ä¸€æ ¹ç«æŸ´æ£’ï¼Œä½†ä½ å¯ä»¥æŠŠå®ƒä»¬è¿åœ¨ä¸€èµ·ï¼Œè€Œä¸”æ¯æ ¹ç«æŸ´æ£’å¿…é¡» ä½¿ç”¨ä¸€æ¬¡ ã€‚</p><p>å¦‚æœä½ èƒ½ä½¿è¿™ä¸ªæ­£æ–¹å½¢ï¼Œåˆ™è¿”å› true ï¼Œå¦åˆ™è¿”å› false ã€‚</p><div class="tabs" id="10b05bf4-7acc-4492-a4d8-1a859f0abe58"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#10b05bf4-7acc-4492-a4d8-1a859f0abe58-1"><i class="fas fa-cat"></i>è§£æ³•ä¸€</button></li><li class="tab"><button type="button" data-href="#10b05bf4-7acc-4492-a4d8-1a859f0abe58-2"><i class="fas fa-horse"></i>è§£æ³•äºŒ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="10b05bf4-7acc-4492-a4d8-1a859f0abe58-1"><p>è¾¹ç•Œæ¡ä»¶æ—¶ä¸éœ€è¦å¯¹æ¯ä¸ªæ¡¶æ˜¯å¦éƒ½è¾¾åˆ°targetè¿›è¡Œåˆ¤æ–­ã€‚</p><p>è‹¥æŸä¸ªæ¡¶çš„é•¿åº¦å°äºtargetï¼Œé‚£è¾¾åˆ°æœ«å°¾æ—¶ï¼Œå°±å¿…ç„¶ä¼šæœ‰æ¡¶é•¿åº¦å¤§äºtargetã€‚è€Œè¿™ç§æƒ…å†µä¸ä¼šè¿›å…¥ä¸‹ä¸€æ¬¡é€’å½’çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] matchsticks;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> target;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">makesquare</span><span class="params">(<span class="type">int</span>[] _matchsticks)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> Arrays.stream(_matchsticks).sum();</span><br><span class="line">    <span class="keyword">if</span>(sum % <span class="number">4</span> != <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    target = sum/<span class="number">4</span>;</span><br><span class="line">    <span class="comment">// æ’åº</span></span><br><span class="line">    matchsticks = Arrays.stream(_matchsticks).boxed().sorted(Comparator.reverseOrder()).mapToInt(Integer::intValue).toArray();</span><br><span class="line">    <span class="keyword">return</span> dfs(<span class="number">0</span> , <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">4</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">dfs</span><span class="params">(<span class="type">int</span> idx ,<span class="type">int</span>[] edges)</span>&#123;</span><br><span class="line">    <span class="comment">// è¾¹ç•Œæ¡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span>(idx == matchsticks.length) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†å½“å‰çš„æœ¨æ£æ”¾ç½®åˆ°4ä¸ªæ¡¶ä¸­</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;i &lt; <span class="number">4</span>;i++)&#123;</span><br><span class="line">        edges[i] += matchsticks[idx];</span><br><span class="line">        <span class="keyword">if</span>(edges[i] &lt;= target &amp;&amp; dfs(idx + <span class="number">1</span>,edges))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        edges[i] -= matchsticks[idx];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="10b05bf4-7acc-4492-a4d8-1a859f0abe58-2"><p>çŠ¶æ€å‹ç¼©+è®°å¿†åŒ–</p><p>ä½¿ç”¨<code>curSum + matchsticks[i] &lt;= side</code>å’Œ<code>int newSum = (curSum + matchsticks[i]) % side;</code></p><p>ä¸¤ç§æ–¹å¼å·§å¦™å®ç°å•è¾¹çš„å¢é•¿ä»¥åŠå½“è¾¾åˆ°sideæ—¶è¿›è¡Œä¸‹ä¸€æ¡è¾¹çš„é€‰æ‹©ã€‚</p><p>å½“sum&lt;sideæ—¶ï¼Œsumä¼šä¸€ç›´ç´¯ç§¯ã€‚å½“åˆšå¥½è¾¾åˆ°sideæ—¶ï¼Œæ¸…0ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> side; <span class="comment">// è¾¹é•¿</span></span><br><span class="line"><span class="type">int</span>[] cache;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span>[] matchsticks;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">makesquare</span><span class="params">(<span class="type">int</span>[] _matchsticks)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> Arrays.stream(_matchsticks).sum();</span><br><span class="line">    <span class="keyword">if</span> (sum % <span class="number">4</span> != <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    side = sum / <span class="number">4</span>;</span><br><span class="line">    <span class="comment">// æ’åº</span></span><br><span class="line">    matchsticks = Arrays.stream(_matchsticks).boxed().sorted(Comparator.reverseOrder()).mapToInt(Integer::intValue).toArray();</span><br><span class="line">    n = _matchsticks.length;</span><br><span class="line"></span><br><span class="line">    cache = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">1</span> &lt;&lt; n];</span><br><span class="line">    cache[(<span class="number">1</span> &lt;&lt; n) - <span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> dfs(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">dfs</span><span class="params">(<span class="type">int</span> state, <span class="type">int</span> curSum)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache[state] != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> cache[state] == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (((state &gt;&gt; i) &amp; <span class="number">1</span>) == <span class="number">0</span> &amp;&amp; curSum + matchsticks[i] &lt;= side) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">newSum</span> <span class="operator">=</span> (curSum + matchsticks[i]) % side;</span><br><span class="line">            <span class="keyword">if</span> (dfs(state | (<span class="number">1</span> &lt;&lt; i), newSum)) &#123;</span><br><span class="line">                ans = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cache[state] = ans ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a5be2cec-b383-4537-9ec2-3406ea64a6ae-2"><p><div class="tag link"><a class="link-card" title="698. ç«æŸ´æ‹¼æ­£æ–¹å½¢" href="https://leetcode.cn/problems/partition-to-k-equal-sum-subsets/"><div class="left"><img src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/leetcode.jpg"/></div><div class="right"><p class="text">698. ç«æŸ´æ‹¼æ­£æ–¹å½¢</p><p class="url">https://leetcode.cn/problems/partition-to-k-equal-sum-subsets/</p></div>&lt;/a&gt;&lt;/div&gt;</p><p>ç»™å®šä¸€ä¸ªæ•´æ•°æ•°ç»„ <code>nums</code> å’Œä¸€ä¸ªæ­£æ•´æ•° <code>k</code>ï¼Œæ‰¾å‡ºæ˜¯å¦æœ‰å¯èƒ½æŠŠè¿™ä¸ªæ•°ç»„åˆ†æˆ <code>k</code> ä¸ªéç©ºå­é›†ï¼Œå…¶æ€»å’Œéƒ½ç›¸ç­‰ã€‚</p><p>åŒä¸Šä¸€é¢˜å†™æ³•</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a5be2cec-b383-4537-9ec2-3406ea64a6ae-3"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a5be2cec-b383-4537-9ec2-3406ea64a6ae-4"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>]]></content>
    
    
    <summary type="html">å›æº¯</summary>
    
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="https://wuwawawa.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
</feed>
