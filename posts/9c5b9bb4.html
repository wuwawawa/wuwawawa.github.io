<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>7.1å…±äº«æ¨¡å‹ä¹‹å·¥å…· | LuckyBoyğŸ¥</title><meta name="keywords" content="JUC"><meta name="author" content="LuckyBoyğŸ¥"><meta name="copyright" content="LuckyBoyğŸ¥"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="çº¿ç¨‹æ± ã€AQSã€ReentrantLockã€Semaphoreç­‰é”çš„åŸç†"><meta property="og:type" content="article"><meta property="og:title" content="7.1å…±äº«æ¨¡å‹ä¹‹å·¥å…·"><meta property="og:url" content="https://luckylittleboy.gitee.io/posts/9c5b9bb4.html"><meta property="og:site_name" content="LuckyBoyğŸ¥"><meta property="og:description" content="çº¿ç¨‹æ± ã€AQSã€ReentrantLockã€Semaphoreç­‰é”çš„åŸç†"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/default_cover_8.webp"><meta property="article:published_time" content="2023-04-03T01:39:40.000Z"><meta property="article:modified_time" content="2023-04-07T14:47:38.175Z"><meta property="article:author" content="LuckyBoyğŸ¥"><meta property="article:tag" content="JUC"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/default_cover_8.webp"><link rel="shortcut icon" href="/"><link rel="canonical" href="https://luckylittleboy.gitee.io/posts/9c5b9bb4"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!0,languages:{hits_empty:"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},translate:void 0,noticeOutdate:{limitDay:365,position:"top",messagePrev:"It has been",messageNext:"days since the last update, the content of the article may be outdated."},highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:360},copy:{success:"å¤åˆ¶æˆåŠŸ",error:"å¤åˆ¶é”™è¯¯",noSupport:"æµè§ˆå™¨ä¸æ”¯æŒ"},relativeDate:{homepage:!0,post:!0},runtime:"",date_suffix:{just:"åˆšåˆš",min:"åˆ†é’Ÿå‰",hour:"å°æ—¶å‰",day:"å¤©å‰",month:"ä¸ªæœˆå‰"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js",css:"https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"7.1å…±äº«æ¨¡å‹ä¹‹å·¥å…·",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-04-07 22:47:38"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const a=864e5*o,n={value:t,expiry:(new Date).getTime()+a};localStorage.setItem(e,JSON.stringify(n))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise(((t,o)=>{const a=document.createElement("script");a.src=e,a.async=!0,a.onerror=o,a.onload=a.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)})),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","ffffff")};const t=saveToLocal.get("theme"),o=(new Date).getHours();void 0===t?o<=6||o>=18?activateDarkMode():activateLightMode():"light"===t?activateLightMode():activateDarkMode();const a=saveToLocal.get("aside-status");void 0!==a&&("hide"===a?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><svg aria-hidden="true" style="position:absolute;overflow:hidden;width:0;height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248 626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload='this.media="screen"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload='this.media="all"'><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="LuckyBoyğŸ¥" type="application/atom+xml"></head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.webp" onerror='onerror=null,src="/assets/r1.jpg"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">4</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-home"></use></svg> <span class="menu_word" style="font-size:17px">é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon--article"></use></svg> <span class="menu_word" style="font-size:17px">æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-guidang1"></use></svg> <span class="menu_word" style="font-size:17px">å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-sekuaibiaoqian"></use></svg> <span class="menu_word" style="font-size:17px">æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-fenlei"></use></svg> <span class="menu_word" style="font-size:17px">åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-pinweishenghuo"></use></svg> <span class="menu_word" style="font-size:17px">ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-yinle"></use></svg> <span class="menu_word" style="font-size:17px">å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-dianying1"></use></svg> <span class="menu_word" style="font-size:17px">å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-youxishoubing"></use></svg> <span class="menu_word" style="font-size:17px">æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-xiangzi"></use></svg> <span class="menu_word" style="font-size:17px">å…«å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-tubiaozhizuomoban"></use></svg> <span class="menu_word" style="font-size:17px">ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-nvwumao"></use></svg> <span class="menu_word" style="font-size:17px">åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-zhifengche"></use></svg> <span class="menu_word" style="font-size:17px">ç½‘å€å¯¼èˆª</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-shejiaoxinxi"></use></svg> <span class="menu_word" style="font-size:17px">ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-pengyouquan"></use></svg> <span class="menu_word" style="font-size:17px">æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-liuyan"></use></svg> <span class="menu_word" style="font-size:17px">ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-lianjie"></use></svg> <span class="menu_word" style="font-size:17px">å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-wangye"></use></svg> <span class="menu_word" style="font-size:17px">ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon--tongjibiao"></use></svg> <span class="menu_word" style="font-size:17px">ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-shujutongji1"></use></svg> <span class="menu_word" style="font-size:17px">æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-xianxingshalou"></use></svg> <span class="menu_word" style="font-size:17px">æ—§æ—¶å…‰</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-maoliang"></use></svg> <span class="menu_word" style="font-size:17px">ä¸ªäºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/bb/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-qunliaotian"></use></svg> <span class="menu_word" style="font-size:17px">å” å¨</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/love/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-love-sign"></use></svg> <span class="menu_word" style="font-size:17px">æ‹çˆ±å°å±‹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-paperplane"></use></svg> <span class="menu_word" style="font-size:17px">å…³äº</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">LuckyBoyğŸ¥</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-home"></use></svg> <span class="menu_word" style="font-size:17px">é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon--article"></use></svg> <span class="menu_word" style="font-size:17px">æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-guidang1"></use></svg> <span class="menu_word" style="font-size:17px">å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-sekuaibiaoqian"></use></svg> <span class="menu_word" style="font-size:17px">æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-fenlei"></use></svg> <span class="menu_word" style="font-size:17px">åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-pinweishenghuo"></use></svg> <span class="menu_word" style="font-size:17px">ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-yinle"></use></svg> <span class="menu_word" style="font-size:17px">å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-dianying1"></use></svg> <span class="menu_word" style="font-size:17px">å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-youxishoubing"></use></svg> <span class="menu_word" style="font-size:17px">æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-xiangzi"></use></svg> <span class="menu_word" style="font-size:17px">å…«å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-tubiaozhizuomoban"></use></svg> <span class="menu_word" style="font-size:17px">ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-nvwumao"></use></svg> <span class="menu_word" style="font-size:17px">åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-zhifengche"></use></svg> <span class="menu_word" style="font-size:17px">ç½‘å€å¯¼èˆª</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-shejiaoxinxi"></use></svg> <span class="menu_word" style="font-size:17px">ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-pengyouquan"></use></svg> <span class="menu_word" style="font-size:17px">æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-liuyan"></use></svg> <span class="menu_word" style="font-size:17px">ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-lianjie"></use></svg> <span class="menu_word" style="font-size:17px">å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-wangye"></use></svg> <span class="menu_word" style="font-size:17px">ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon--tongjibiao"></use></svg> <span class="menu_word" style="font-size:17px">ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-shujutongji1"></use></svg> <span class="menu_word" style="font-size:17px">æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-xianxingshalou"></use></svg> <span class="menu_word" style="font-size:17px">æ—§æ—¶å…‰</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-maoliang"></use></svg> <span class="menu_word" style="font-size:17px">ä¸ªäºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/bb/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-qunliaotian"></use></svg> <span class="menu_word" style="font-size:17px">å” å¨</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/love/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-love-sign"></use></svg> <span class="menu_word" style="font-size:17px">æ‹çˆ±å°å±‹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.3em;height:1.3em;vertical-align:-.15em;fill:currentColor;overflow:hidden"><use xlink:href="#icon-paperplane"></use></svg> <span class="menu_word" style="font-size:17px">å…³äº</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="æ£€ç´¢ç«™å†…ä»»ä½•ä½ æƒ³è¦çš„ä¿¡æ¯"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-valentine_-search-love-find-heart"></use></svg> <span>æœç´¢</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="ç¾åŒ–è®¾ç½®-è‡ªå®šä¹‰ä½ çš„é£æ ¼" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">7.1å…±äº«æ¨¡å‹ä¹‹å·¥å…·</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">å‘è¡¨äº</span> <time class="post-meta-date-created" datetime="2023-04-03T01:39:40.000Z" title="å‘è¡¨äº 2023-04-03 09:39:40">2023-04-03</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-04-07T14:47:38.175Z" title="æ›´æ–°äº 2023-04-07 22:47:38">2023-04-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-biaoqian"></use></svg><a class="post-meta-categories" href="/categories/Java/">Java</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">2.1w</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>91åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="7.1å…±äº«æ¨¡å‹ä¹‹å·¥å…·"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s58 18 88 18 58-18 88-18 58 18 88 18v44h-352Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="1-è‡ªå®šä¹‰çº¿ç¨‹æ± ">1. è‡ªå®šä¹‰çº¿ç¨‹æ± </h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220311170716250.png" alt="image-20220311170716250"></p><div class="tabs" id="fec406e4-a43c-4c0d-b1cd-8434dbb940a8"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#fec406e4-a43c-4c0d-b1cd-8434dbb940a8-1"><i class="fas fa-seedling"></i>æ­¥éª¤1</button></li><li class="tab"><button type="button" data-href="#fec406e4-a43c-4c0d-b1cd-8434dbb940a8-2"><i class="fas fa-leaf"></i>æ­¥éª¤2</button></li><li class="tab"><button type="button" data-href="#fec406e4-a43c-4c0d-b1cd-8434dbb940a8-3"><i class="fab fa-apple"></i>æ­¥éª¤3</button></li><li class="tab"><button type="button" data-href="#fec406e4-a43c-4c0d-b1cd-8434dbb940a8-4"><i class="fas fa-tree"></i>æ­¥éª¤4</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="fec406e4-a43c-4c0d-b1cd-8434dbb940a8-1"><p>è‡ªå®šä¹‰æ‹’ç»ç­–ç•¥æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span> <span class="comment">//æ‹’ç»ç­–ç•¥</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">RejectPolicy</span>&lt;T&gt;&#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">reject</span><span class="params">(BlockingQueue&lt;T&gt; queue,T task)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="fec406e4-a43c-4c0d-b1cd-8434dbb940a8-2"><p>è‡ªå®šä¹‰ä»»åŠ¡é˜Ÿåˆ—</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BlockingQueue</span>&lt;T&gt;&#123;</span><br><span class="line">    <span class="comment">//é˜»å¡é˜Ÿåˆ—ï¼Œå­˜æ”¾ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">private</span> Deque&lt;T&gt; queue = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//é˜Ÿåˆ—çš„æœ€å¤§å®¹é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> capacity;</span><br><span class="line">    <span class="comment">//é”</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="comment">//ç”Ÿäº§è€…æ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">fullWaitSet</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="comment">//æ¶ˆè´¹è€…æ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">emptyWaitSet</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="comment">//æ„é€ æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BlockingQueue</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¶…æ—¶é˜»å¡è·å–</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">poll</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="comment">//å°†æ—¶é—´è½¬æ¢ä¸ºçº³ç§’</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">nanoTime</span> <span class="operator">=</span> unit.toNanos(timeout);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(queue.size() == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//ç­‰å¾…è¶…æ—¶ä¾æ—§æ²¡æœ‰è·å–ï¼Œè¿”å›null</span></span><br><span class="line">                    <span class="keyword">if</span>(nanoTime &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//è¯¥æ–¹æ³•è¿”å›çš„æ˜¯å‰©ä½™æ—¶é—´</span></span><br><span class="line">                    nanoTime = emptyWaitSet.awaitNanos(nanoTime);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> queue.pollFirst();</span><br><span class="line">            fullWaitSet.signal();</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//é˜»å¡è·å–</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">take</span><span class="params">()</span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(queue.size() == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    emptyWaitSet.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> queue.pollFirst();</span><br><span class="line">            fullWaitSet.signal();</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//é˜»å¡æ·»åŠ </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(T t)</span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (queue.size() == capacity)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().toString() + <span class="string">&quot;ç­‰å¾…åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—:&quot;</span> + t.toString());</span><br><span class="line">                    fullWaitSet.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().toString() + <span class="string">&quot;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—:&quot;</span> + t.toString());</span><br><span class="line">            queue.addLast(t);</span><br><span class="line">            emptyWaitSet.signal();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¶…æ—¶é˜»å¡æ·»åŠ </span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(T t,<span class="type">long</span> timeout,TimeUnit timeUnit)</span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">nanoTime</span> <span class="operator">=</span> timeUnit.toNanos(timeout);</span><br><span class="line">            <span class="keyword">while</span> (queue.size() == capacity)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span>(nanoTime &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;ç­‰å¾…è¶…æ—¶ï¼ŒåŠ å…¥å¤±è´¥ï¼š&quot;</span> + t);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(Thread.currentThread().toString() + <span class="string">&quot;ç­‰å¾…åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—:&quot;</span> + t.toString());</span><br><span class="line">                    nanoTime = fullWaitSet.awaitNanos(nanoTime);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().toString() + <span class="string">&quot;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—:&quot;</span> + t.toString());</span><br><span class="line">            queue.addLast(t);</span><br><span class="line">            emptyWaitSet.signal();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> queue.size();</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä»å½¢å‚æ¥æ”¶æ‹’ç»ç­–ç•¥çš„putæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tryPut</span><span class="params">(RejectPolicy&lt;T&gt; rejectPolicy,T task)</span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(queue.size() == capacity)&#123;</span><br><span class="line">                rejectPolicy.reject(<span class="built_in">this</span>,task);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼š&quot;</span> + task);</span><br><span class="line">                queue.addLast(task);</span><br><span class="line">                emptyWaitSet.signal();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="fec406e4-a43c-4c0d-b1cd-8434dbb940a8-3"><p>è‡ªå®šä¹‰çº¿ç¨‹æ± </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadPool</span>&#123;</span><br><span class="line">    <span class="comment">//é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    BlockingQueue&lt;Runnable&gt; taskQue;</span><br><span class="line">    <span class="comment">//çº¿ç¨‹é›†åˆ</span></span><br><span class="line">    HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//æ‹’ç»ç­–ç•¥</span></span><br><span class="line">    <span class="keyword">private</span> RejectPolicy&lt;Runnable&gt; rejectPolicy;</span><br><span class="line">    <span class="comment">//æ„é€ æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ThreadPool</span><span class="params">(<span class="type">int</span> coreSize,<span class="type">long</span> timeout,TimeUnit timeUnit,<span class="type">int</span> queueCapacity,RejectPolicy&lt;Runnable&gt; rejectPolicy)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.coreSize = coreSize;</span><br><span class="line">        <span class="built_in">this</span>.timeout = timeout;</span><br><span class="line">        <span class="built_in">this</span>.timeUnit = timeUnit;</span><br><span class="line">        <span class="built_in">this</span>.rejectPolicy = rejectPolicy;</span><br><span class="line">        taskQue = <span class="keyword">new</span> <span class="title class_">BlockingQueue</span>&lt;Runnable&gt;(queueCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//çº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> coreSize;</span><br><span class="line">    <span class="comment">//ä»»åŠ¡è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> timeout;</span><br><span class="line">    <span class="comment">//æ—¶é—´å•å…ƒ</span></span><br><span class="line">    <span class="keyword">private</span> TimeUnit timeUnit;</span><br><span class="line">    <span class="comment">//çº¿ç¨‹æ± çš„æ‰§è¡Œæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable task)</span>&#123;</span><br><span class="line">        <span class="comment">//å½“çº¿ç¨‹æ•°å¤§äºç­‰äºcoreSizeçš„æ—¶å€™ï¼Œå°†ä»»åŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">//å½“çº¿ç¨‹æ•°å°äºcoreSizeçš„æ—¶å€™ï¼Œæ–°å»ºä¸€ä¸ªWorkeræ”¾å…¥workers</span></span><br><span class="line">        <span class="comment">//æ³¨æ„workersç±»ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œ éœ€è¦åŠ é”</span></span><br><span class="line">        <span class="keyword">synchronized</span> (workers)&#123;</span><br><span class="line">            <span class="keyword">if</span>(workers.size() &gt;= coreSize)&#123;</span><br><span class="line"><span class="comment">//                taskQue.put(task);</span></span><br><span class="line">                <span class="comment">//æ­»ç­‰</span></span><br><span class="line">                <span class="comment">//å¸¦è¶…æ—¶ç­‰å¾…</span></span><br><span class="line">                <span class="comment">//è®©è°ƒç”¨è€…æ”¾å¼ƒæ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">                <span class="comment">//è®©è°ƒç”¨è€…æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">                <span class="comment">//è®©è°ƒç”¨è€…è‡ªå·±æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">                taskQue.tryPut(rejectPolicy,task);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">Worker</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Worker</span>(task);</span><br><span class="line">                System.out.println(Thread.currentThread().toString() + <span class="string">&quot;æ–°å¢worker:&quot;</span> + worker + <span class="string">&quot;,task:&quot;</span> + task);</span><br><span class="line">                workers.add(worker);</span><br><span class="line">                worker.start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å·¥ä½œç±»</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Runnable task;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Worker</span><span class="params">(Runnable task)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.task = task;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">//å·§å¦™çš„åˆ¤æ–­</span></span><br><span class="line">            <span class="keyword">while</span>(task != <span class="literal">null</span> || (task = taskQue.poll(timeout,timeUnit)) != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().toString() + <span class="string">&quot;æ­£åœ¨æ‰§è¡Œ:&quot;</span> + task);</span><br><span class="line">                    task.run();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">                &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                    task = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">synchronized</span> (workers)&#123;</span><br><span class="line">                System.out.println(Thread.currentThread().toString() + <span class="string">&quot;workerè¢«ç§»é™¤:&quot;</span> + <span class="built_in">this</span>.toString());</span><br><span class="line">                workers.remove(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="fec406e4-a43c-4c0d-b1cd-8434dbb940a8-4"><p>ç¼–å†™æµ‹è¯•ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestPool</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ThreadPool</span> <span class="variable">threadPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPool</span>(<span class="number">1</span>,</span><br><span class="line">                <span class="number">1000</span>, TimeUnit.MILLISECONDS, <span class="number">1</span>, (queue, task)-&gt;&#123;</span><br><span class="line">            <span class="comment">// 1. æ­»ç­‰</span></span><br><span class="line"><span class="comment">//            queue.put(task);</span></span><br><span class="line">            <span class="comment">// 2) å¸¦è¶…æ—¶ç­‰å¾…</span></span><br><span class="line"><span class="comment">//            queue.offer(task, 1500, TimeUnit.MILLISECONDS);</span></span><br><span class="line">            <span class="comment">// 3) è®©è°ƒç”¨è€…æ”¾å¼ƒä»»åŠ¡æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">//            log.debug(&quot;æ”¾å¼ƒ&#123;&#125;&quot;, task);</span></span><br><span class="line">            <span class="comment">// 4) è®©è°ƒç”¨è€…æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="comment">//            throw new RuntimeException(&quot;ä»»åŠ¡æ‰§è¡Œå¤±è´¥ &quot; + task);</span></span><br><span class="line">            <span class="comment">// 5) è®©è°ƒç”¨è€…è‡ªå·±æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">            task.run();</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i;</span><br><span class="line">            threadPool.execute(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, j);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-ThreadPoolExecutor">2. ThreadPoolExecutor</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220311171237519.png" alt="image-20220311171237519"></p><p>è¯´æ˜ï¼š</p><ul><li>ScheduledThreadPoolExecutoræ˜¯å¸¦è°ƒåº¦çš„çº¿ç¨‹æ± </li><li>ThreadPoolExecutoræ˜¯ä¸å¸¦è°ƒåº¦çš„çº¿ç¨‹æ± </li></ul><h3 id="2-1-çº¿ç¨‹æ± çŠ¶æ€">2.1 çº¿ç¨‹æ± çŠ¶æ€</h3><p>ThreadPoolExecutor ä½¿ç”¨ int çš„é«˜ 3 ä½æ¥è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼Œä½ 29 ä½è¡¨ç¤ºçº¿ç¨‹æ•°é‡</p><p><code>private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));</code></p><table><thead><tr><th style="text-align:center">çŠ¶æ€å</th><th style="text-align:center">é«˜3ä½</th><th style="text-align:center">æ¥æ”¶æ–°ä»»åŠ¡</th><th style="text-align:center">å¤„ç†é˜»å¡é˜Ÿåˆ—ä»»åŠ¡</th><th style="text-align:center">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center">RUNNING</td><td style="text-align:center">111</td><td style="text-align:center">Y</td><td style="text-align:center">Y</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">SHUTDOWN</td><td style="text-align:center">000</td><td style="text-align:center">N</td><td style="text-align:center">Y</td><td style="text-align:center">ä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†ä¼šå¤„ç†é˜»å¡é˜Ÿåˆ—å‰©ä½™ ä»»åŠ¡</td></tr><tr><td style="text-align:center">STOP</td><td style="text-align:center">001</td><td style="text-align:center">N</td><td style="text-align:center">N</td><td style="text-align:center">ä¼šä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶æŠ›å¼ƒé˜»å¡é˜Ÿåˆ— ä»»åŠ¡</td></tr><tr><td style="text-align:center">TIDYING</td><td style="text-align:center">010</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">ä»»åŠ¡å…¨æ‰§è¡Œå®Œæ¯•ï¼Œæ´»åŠ¨çº¿ç¨‹ä¸º 0 å³å°†è¿›å…¥ ç»ˆç»“</td></tr><tr><td style="text-align:center">TERMINATED</td><td style="text-align:center">011</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">ç»ˆç»“çŠ¶æ€</td></tr></tbody></table><p>ä»æ•°å­—ä¸Šæ¯”è¾ƒï¼ŒTERMINATED &gt; TIDYING &gt; STOP &gt; SHUTDOWN &gt; RUNNING</p><p>è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªåŸå­å˜é‡ ctl ä¸­ï¼Œç›®çš„æ˜¯å°†çº¿ç¨‹æ± çŠ¶æ€ä¸çº¿ç¨‹ä¸ªæ•°åˆäºŒä¸ºä¸€ï¼Œè¿™æ ·å°±å¯ä»¥ç”¨ä¸€æ¬¡ cas åŸå­æ“ä½œ è¿›è¡Œèµ‹å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Packing and unpacking ctl</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">runStateOf</span><span class="params">(<span class="type">int</span> c)</span>     &#123; <span class="keyword">return</span> c &amp; ~CAPACITY; &#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">workerCountOf</span><span class="params">(<span class="type">int</span> c)</span>  &#123; <span class="keyword">return</span> c &amp; CAPACITY; &#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">ctlOf</span><span class="params">(<span class="type">int</span> rs, <span class="type">int</span> wc)</span> &#123; <span class="keyword">return</span> rs | wc; &#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-å·¥ä½œæ–¹å¼">2.2 å·¥ä½œæ–¹å¼</h3><p>åœ¨JDKä¸­çš„çº¿ç¨‹æ± ä¸­ï¼Œçº¿ç¨‹åˆ†ä¸ºä¸¤ç§ã€‚ä¸€ç§å«åšæ ¸å¿ƒçº¿ç¨‹ï¼Œä¸€ç§å«åšæ•‘æ€¥çº¿ç¨‹ã€‚ä¸€å¼€å§‹éƒ½æ˜¯æ²¡æœ‰åˆ›å»ºçš„ï¼Œéƒ½ä¸ºæ‡’æƒ°åˆ›å»ºã€‚</p><p>æ ¸å¿ƒçº¿ç¨‹æ•°+æ•‘æ€¥çº¿ç¨‹æ•°=æœ€å¤§çº¿ç¨‹æ•°</p><div class="tabs" id="6532fcb2-28ca-4ddf-bdb2-e36bd19febe0"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-1"><i class="fas fa-atom"></i>åˆå§‹çŠ¶æ€</button></li><li class="tab"><button type="button" data-href="#6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-2"><i class="far fa-sun"></i>2</button></li><li class="tab"><button type="button" data-href="#6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-3"><i class="fas fa-wind"></i>3</button></li><li class="tab"><button type="button" data-href="#6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-4"><i class="fas fa-fire-alt"></i>4</button></li><li class="tab"><button type="button" data-href="#6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-5"><i class="fas fa-horse"></i>5</button></li><li class="tab"><button type="button" data-href="#6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-6"><i class="fas fa-cat"></i>6</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-1"><p>åˆå§‹çŠ¶æ€ è™šçº¿ è¡¨ç¤ºè¿˜æœªåˆ›å»º</p><p>cï¼šcorePoolSize æ ¸å¿ƒçº¿ç¨‹æ•°ç›® 2 mï¼šmaximumPoolSiz æœ€å¤§çº¿ç¨‹çº¿ç¨‹æ•°ç›® 3</p><p>çº¿ç¨‹æ± ä¸­åˆšå¼€å§‹æ²¡æœ‰çº¿ç¨‹ã€‚</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230403133115379.png" alt="image-20230403133115379" style="zoom:67%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-2"><p>å®çº¿è¡¨ç¤ºå·²åˆ›å»ºçº¿ç¨‹</p><p>å½“ä¸€ä¸ªä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± åï¼Œçº¿ç¨‹æ± ä¼šåˆ›å»ºä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230403120601163.png" alt="image-20230403120601163" style="zoom:50%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-3"><p>å‡è®¾é˜»å¡é˜Ÿåˆ—é•¿åº¦ä¸º2ã€‚</p><p>å½“çº¿ç¨‹æ•°è¾¾åˆ° corePoolSize å¹¶æ²¡æœ‰çº¿ç¨‹ç©ºé—²ï¼Œè¿™æ—¶å†åŠ å…¥ä»»åŠ¡ï¼Œæ–°åŠ çš„ä»»åŠ¡ä¼šè¢«åŠ å…¥workQueue é˜Ÿåˆ—æ’é˜Ÿï¼Œç›´åˆ°æœ‰ç©ºé—²çš„çº¿ç¨‹ã€‚</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230403120618728.png" alt="image-20230403120618728" style="zoom:50%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-4"><p>å¦‚æœé˜Ÿåˆ—é€‰æ‹©äº†æœ‰ç•Œé˜Ÿåˆ—ï¼Œé‚£ä¹ˆä»»åŠ¡è¶…è¿‡äº†é˜Ÿåˆ—å¤§å°æ—¶ï¼Œä¼šåˆ›å»º maximumPoolSize - corePoolSize æ•°ç›®çš„çº¿ç¨‹æ¥æ•‘æ€¥ã€‚</p><p>å¦‚æœçº¿ç¨‹åˆ°è¾¾ maximumPoolSize ä»ç„¶æœ‰æ–°ä»»åŠ¡è¿™æ—¶ä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚æ‹’ç»ç­–ç•¥ jdk æä¾›äº† 4 ç§å®ç°ï¼Œå…¶å®ƒè‘—åæ¡†æ¶ä¹Ÿæä¾›äº†å®ç°</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230403134809613.png" alt="image-20230403134809613"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-5"><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220311174119508.png" alt="image-20220311174119508"></p><ul><li>AbortPolicy è®©è°ƒç”¨è€…æŠ›å‡º RejectedExecutionException å¼‚å¸¸ï¼Œè¿™æ˜¯é»˜è®¤ç­–ç•¥</li><li>CallerRunsPolicy è®©è°ƒç”¨è€…è¿è¡Œä»»åŠ¡</li><li>DiscardPolicy æ”¾å¼ƒæœ¬æ¬¡ä»»åŠ¡</li><li>DiscardOldestPolicy æ”¾å¼ƒé˜Ÿåˆ—ä¸­æœ€æ—©çš„ä»»åŠ¡ï¼Œæœ¬ä»»åŠ¡å–è€Œä»£ä¹‹</li><li>Dubbo çš„å®ç°ï¼Œåœ¨æŠ›å‡º RejectedExecutionException å¼‚å¸¸ä¹‹å‰ä¼šè®°å½•æ—¥å¿—ï¼Œå¹¶ dump çº¿ç¨‹æ ˆä¿¡æ¯ï¼Œæ–¹ä¾¿å®šä½é—®é¢˜</li><li>Netty çš„å®ç°ï¼Œæ˜¯åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡</li><li>ActiveMQ çš„å®ç°ï¼Œå¸¦è¶…æ—¶ç­‰å¾…ï¼ˆ60sï¼‰å°è¯•æ”¾å…¥é˜Ÿåˆ—ï¼Œç±»ä¼¼æˆ‘ä»¬ä¹‹å‰è‡ªå®šä¹‰çš„æ‹’ç»ç­–ç•¥</li><li>PinPoint çš„å®ç°ï¼Œå®ƒä½¿ç”¨äº†ä¸€ä¸ªæ‹’ç»ç­–ç•¥é“¾ï¼Œä¼šé€ä¸€å°è¯•ç­–ç•¥é“¾ä¸­æ¯ç§æ‹’ç»ç­–ç•¥</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6532fcb2-28ca-4ddf-bdb2-e36bd19febe0-6"><p>å½“é«˜å³°è¿‡å»åï¼Œè¶…è¿‡corePoolSize çš„æ•‘æ€¥çº¿ç¨‹å¦‚æœä¸€æ®µæ—¶é—´æ²¡æœ‰ä»»åŠ¡åšï¼Œéœ€è¦ç»“æŸèŠ‚çœèµ„æºï¼Œè¿™ä¸ªæ—¶é—´ç”± keepAliveTime å’Œ unit æ¥æ§åˆ¶ï¼Œä¸‹æ¬¡é«˜å³°æœŸæ¥äº†æ‰ä¼šè¢«å†æ¬¡åˆ›å»ºã€‚</p><p>è€Œæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡åï¼Œä¼šè¢«ä¿ç•™åœ¨çº¿ç¨‹æ± ä¸­ï¼Œä¸ä¼šè¢«é”€æ¯ã€‚</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230403135635202.png" alt="image-20230403135635202" style="zoom:50%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-3-æ„é€ æ–¹æ³•">2.3 æ„é€ æ–¹æ³•</h3><p>å‚æ•°åˆ—è¡¨</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>corePoolSize</td><td>æ ¸å¿ƒçº¿ç¨‹æ•°ç›®</td></tr><tr><td>maximumPoolSize</td><td>æœ€å¤§çº¿ç¨‹æ•°ç›®</td></tr><tr><td>keepAliveTime</td><td>ç”Ÿå­˜æ—¶é—´ - é’ˆå¯¹æ•‘æ€¥çº¿ç¨‹</td></tr><tr><td>unit</td><td>æ—¶é—´å•ä½ - é’ˆå¯¹æ•‘æ€¥çº¿ç¨‹</td></tr><tr><td>workQueue</td><td>é˜»å¡é˜Ÿåˆ—</td></tr><tr><td>threadFactory</td><td>çº¿ç¨‹å·¥å‚ - å¯ä»¥ä¸ºçº¿ç¨‹åˆ›å»ºæ—¶èµ·ä¸ªå¥½åå­—</td></tr><tr><td>handler</td><td>æ‹’ç»ç­–ç•¥</td></tr></tbody></table><div class="tabs" id="c7c54ee0-9eda-42fe-9d85-de5641ea0eda"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c7c54ee0-9eda-42fe-9d85-de5641ea0eda-1"><i class="fas fa-cat"></i>newFixedThreadPool</button></li><li class="tab"><button type="button" data-href="#c7c54ee0-9eda-42fe-9d85-de5641ea0eda-2"><i class="fas fa-horse"></i>newCachedThreadPool</button></li><li class="tab"><button type="button" data-href="#c7c54ee0-9eda-42fe-9d85-de5641ea0eda-3"><i class="fas fa-dove"></i>newSingleThreadExecutor</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c7c54ee0-9eda-42fe-9d85-de5641ea0eda-1"><p>å›ºå®šå¤§å°çº¿ç¨‹æ± </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads, nThreads, <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç‰¹ç‚¹</p><ul><li>æ ¸å¿ƒçº¿ç¨‹æ•° == æœ€å¤§çº¿ç¨‹æ•°ï¼ˆæ²¡æœ‰æ•‘æ€¥çº¿ç¨‹è¢«åˆ›å»ºï¼‰ï¼Œå› æ­¤ä¹Ÿæ— éœ€è¶…æ—¶æ—¶é—´</li><li>é˜»å¡é˜Ÿåˆ—æ˜¯æ— ç•Œçš„ï¼Œå¯ä»¥æ”¾ä»»æ„æ•°é‡çš„ä»»åŠ¡</li></ul><blockquote><p>è¯„ä»· é€‚ç”¨äºä»»åŠ¡é‡å·²çŸ¥ï¼Œç›¸å¯¹è€—æ—¶çš„ä»»åŠ¡</p></blockquote><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c7c54ee0-9eda-42fe-9d85-de5641ea0eda-2"><p>å¸¦ç¼“å†²çº¿ç¨‹æ± </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newCachedThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">0</span>, Integer.MAX_VALUE, <span class="number">60L</span>, </span><br><span class="line">            TimeUnit.SECONDS, <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç‰¹ç‚¹</p><ul><li>æ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯ 0ï¼Œ æœ€å¤§çº¿ç¨‹æ•°æ˜¯ Integer.MAX_VALUEï¼Œæ•‘æ€¥çº¿ç¨‹çš„ç©ºé—²ç”Ÿå­˜æ—¶é—´æ˜¯ 60sï¼Œ<ul><li>æ„å‘³ç€å…¨éƒ¨éƒ½æ˜¯æ•‘æ€¥çº¿ç¨‹ï¼ˆ60s åå¯ä»¥å›æ”¶ï¼‰</li><li>æ•‘æ€¥çº¿ç¨‹å¯ä»¥æ— é™åˆ›å»º</li></ul></li><li>é˜Ÿåˆ—é‡‡ç”¨äº† SynchronousQueue å®ç°ç‰¹ç‚¹æ˜¯ï¼Œå®ƒæ²¡æœ‰å®¹é‡ï¼Œæ²¡æœ‰çº¿ç¨‹æ¥å–æ˜¯æ”¾ä¸è¿›å»çš„ï¼ˆä¸€æ‰‹äº¤é’±ã€ä¸€æ‰‹äº¤è´§ï¼‰</li></ul><blockquote><p><strong>è¯„ä»·</strong> æ•´ä¸ªçº¿ç¨‹æ± è¡¨ç°ä¸ºçº¿ç¨‹æ•°ä¼šæ ¹æ®ä»»åŠ¡é‡ä¸æ–­å¢é•¿ï¼Œæ²¡æœ‰ä¸Šé™ï¼Œå½“ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œç©ºé—² 1åˆ†é’Ÿåé‡Šæ”¾çº¿ ç¨‹ã€‚ é€‚åˆä»»åŠ¡æ•°æ¯”è¾ƒå¯†é›†ï¼Œä½†æ¯ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´è¾ƒçŸ­çš„æƒ…å†µ</p></blockquote><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c7c54ee0-9eda-42fe-9d85-de5641ea0eda-3"><p>å•çº¿ç¨‹çº¿ç¨‹æ± </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newSingleThreadExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FinalizableDelegatedExecutorService</span></span><br><span class="line">            (<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0L</span>,</span><br><span class="line">                    TimeUnit.MILLISECONDS, <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨åœºæ™¯ï¼š</p><p>å¸Œæœ›å¤šä¸ªä»»åŠ¡æ’é˜Ÿæ‰§è¡Œã€‚çº¿ç¨‹æ•°å›ºå®šä¸º 1ï¼Œä»»åŠ¡æ•°å¤šäº 1 æ—¶ï¼Œä¼šæ”¾å…¥æ— ç•Œé˜Ÿåˆ—æ’é˜Ÿã€‚ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè¿™å”¯ä¸€çš„çº¿ç¨‹ ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾ã€‚</p><p>åŒºåˆ«ï¼š</p><ul><li>è‡ªå·±åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœä»»åŠ¡æ‰§è¡Œå¤±è´¥è€Œç»ˆæ­¢é‚£ä¹ˆæ²¡æœ‰ä»»ä½•è¡¥æ•‘æªæ–½ï¼Œè€Œçº¿ç¨‹æ± è¿˜ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¿è¯æ± çš„æ­£å¸¸å·¥ä½œ</li><li>Executors.newSingleThreadExecutor() çº¿ç¨‹ä¸ªæ•°å§‹ç»ˆä¸º1ï¼Œä¸èƒ½ä¿®æ”¹<ul><li>FinalizableDelegatedExecutorService åº”ç”¨çš„æ˜¯è£…é¥°å™¨æ¨¡å¼ï¼Œåœ¨è°ƒç”¨æ„é€ æ–¹æ³•æ—¶å°†ThreadPoolExecutorå¯¹è±¡ä¼ ç»™äº†å†…éƒ¨çš„ExecutorServiceæ¥å£ã€‚åªå¯¹å¤–æš´éœ²äº† ExecutorService æ¥å£ï¼Œå› æ­¤ä¸èƒ½è°ƒç”¨ ThreadPoolExecutor ä¸­ç‰¹æœ‰çš„æ–¹æ³•ï¼Œä¹Ÿä¸èƒ½é‡æ–°è®¾ç½®çº¿ç¨‹æ± çš„å¤§å°ã€‚</li></ul></li><li>Executors.newFixedThreadPool(1) åˆå§‹æ—¶ä¸º1ï¼Œä»¥åè¿˜å¯ä»¥ä¿®æ”¹<ul><li>å¯¹å¤–æš´éœ²çš„æ˜¯ ThreadPoolExecutor å¯¹è±¡ï¼Œå¯ä»¥å¼ºè½¬åè°ƒç”¨ setCorePoolSize ç­‰æ–¹æ³•è¿›è¡Œä¿®æ”¹</li></ul></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-4-æäº¤ä»»åŠ¡">2.4 æäº¤ä»»åŠ¡</h3><div class="tabs" id="e70e018e-6f3d-4523-837f-b5e47b1bd059"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#e70e018e-6f3d-4523-837f-b5e47b1bd059-1"><i class="fas fa-award"></i>execute</button></li><li class="tab"><button type="button" data-href="#e70e018e-6f3d-4523-837f-b5e47b1bd059-2"><i class="fas fa-baseball-ball"></i>submit</button></li><li class="tab"><button type="button" data-href="#e70e018e-6f3d-4523-837f-b5e47b1bd059-3"><i class="fas fa-bone"></i>invokeAll</button></li><li class="tab"><button type="button" data-href="#e70e018e-6f3d-4523-837f-b5e47b1bd059-4"><i class="fas fa-anchor"></i>invokeAny</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="e70e018e-6f3d-4523-837f-b5e47b1bd059-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e70e018e-6f3d-4523-837f-b5e47b1bd059-2"><p>submitä¸executeåŒºåˆ«åœ¨äº submitæ¥æ”¶å‚æ•°æ˜¯ä¸€ä¸ªCallableç±»å‹çš„ä»»åŠ¡ï¼ŒCallableä¸Runableç›¸æ¯”å°±æ˜¯å¤šäº†ä¸€ä¸ªè¿”å›çš„ç»“æœï¼ŒRunnableæ— è¿”å›ç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æäº¤ä»»åŠ¡ taskï¼Œç”¨è¿”å›å€¼ Future è·å¾—ä»»åŠ¡æ‰§è¡Œç»“æœ</span></span><br><span class="line">&lt;T&gt; Future&lt;T&gt; <span class="title function_">submit</span><span class="params">(Callable&lt;T&gt; task)</span>;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•submit</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">(ExecutorService pool)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException &#123;</span><br><span class="line">    Future&lt;String&gt; future = pool.submit(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;running&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//getæ–¹æ³•å¦‚æœçº¿ç¨‹æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¸»çº¿ç¨‹ä¼šé˜»å¡</span></span><br><span class="line">    log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, future.get());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">    method1(pool);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç»“æœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">18:36:58.033 c.TestSubmit [pool-1-thread-1] - running</span><br><span class="line">18:36:59.034 c.TestSubmit [main] - ok</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e70e018e-6f3d-4523-837f-b5e47b1bd059-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡</span></span><br><span class="line">&lt;T&gt; List&lt;Future&lt;T&gt;&gt; <span class="title function_">invokeAll</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"><span class="comment">// æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå¸¦è¶…æ—¶æ—¶é—´ï¼Œæ—¶é—´è¶…æ—¶åï¼Œä¼šæ”¾å¼ƒæ‰§è¡Œåé¢çš„ä»»åŠ¡</span></span><br><span class="line">&lt;T&gt; List&lt;Future&lt;T&gt;&gt; <span class="title function_">invokeAll</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,<span class="type">long</span> timeout, TimeUnit unit)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•invokeAll</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">(ExecutorService pool)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    List&lt;Future&lt;String&gt;&gt; futures = pool.invokeAll(Arrays.asList(</span><br><span class="line">        () -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;begin&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        () -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;begin&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;2&quot;</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        () -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;begin&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;3&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    ));</span><br><span class="line"></span><br><span class="line">    futures.forEach( f -&gt;  &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, f.get());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">    method2(pool);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">13</span>:<span class="number">31.187</span> c.TestSubmit [pool-<span class="number">1</span>-thread-<span class="number">2</span>] - begin</span><br><span class="line"><span class="number">16</span>:<span class="number">13</span>:<span class="number">31.187</span> c.TestSubmit [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - begin</span><br><span class="line"><span class="number">16</span>:<span class="number">13</span>:<span class="number">31.690</span> c.TestSubmit [pool-<span class="number">1</span>-thread-<span class="number">2</span>] - begin</span><br><span class="line"><span class="number">16</span>:<span class="number">13</span>:<span class="number">33.704</span> c.TestSubmit [main] - <span class="number">1</span></span><br><span class="line"><span class="number">16</span>:<span class="number">13</span>:<span class="number">33.726</span> c.TestSubmit [main] - <span class="number">2</span></span><br><span class="line"><span class="number">16</span>:<span class="number">13</span>:<span class="number">33.726</span> c.TestSubmit [main] - <span class="number">3</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="e70e018e-6f3d-4523-837f-b5e47b1bd059-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå“ªä¸ªä»»åŠ¡å…ˆæˆåŠŸæ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›æ­¤ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œå…¶å®ƒä»»åŠ¡å–æ¶ˆ</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">invokeAny</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException, ExecutionException;</span><br><span class="line"><span class="comment">// æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå“ªä¸ªä»»åŠ¡å…ˆæˆåŠŸæ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›æ­¤ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œå…¶å®ƒä»»åŠ¡å–æ¶ˆï¼Œå¸¦è¶…æ—¶æ—¶é—´</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">invokeAny</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,<span class="type">long</span> timeout, TimeUnit unit)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•invokeAny</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method3</span><span class="params">(ExecutorService pool)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> pool.invokeAny(Arrays.asList(</span><br><span class="line">        () -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;begin 1&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;end 1&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        () -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;begin 2&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;end 2&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;2&quot;</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        () -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;begin 3&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;end 3&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;3&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    ));</span><br><span class="line">    log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, result);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">//ExecutorService pool = Executors.newFixedThreadPool(1);</span></span><br><span class="line">    method3(pool);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç»“æœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">19:44:46.314 c.TestSubmit [pool-1-thread-1] - begin 1</span><br><span class="line">19:44:46.314 c.TestSubmit [pool-1-thread-3] - begin 3</span><br><span class="line">19:44:46.314 c.TestSubmit [pool-1-thread-2] - begin 2</span><br><span class="line">19:44:46.817 c.TestSubmit [pool-1-thread-2] - end 2</span><br><span class="line">19:44:46.817 c.TestSubmit [main] - 2</span><br><span class="line">//è‹¥è®¾ç½®çº¿ç¨‹æ•°ç›®ä¸º1 åˆ™ä¸ºä¸‹é¢ç»“æœ</span><br><span class="line">19:47:16.063 c.TestSubmit [pool-1-thread-1] - begin 1</span><br><span class="line">19:47:17.063 c.TestSubmit [pool-1-thread-1] - end 1</span><br><span class="line">19:47:17.063 c.TestSubmit [pool-1-thread-1] - begin 2</span><br><span class="line">19:47:17.063 c.TestSubmit [main] - 1</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-5-å…³é—­çº¿ç¨‹æ± ">2.5 å…³é—­çº¿ç¨‹æ± </h3><div class="tabs" id="fc1e405d-0438-41c8-9941-d7f538926b70"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#fc1e405d-0438-41c8-9941-d7f538926b70-1"><i class="fas fa-bug"></i>shutdown</button></li><li class="tab"><button type="button" data-href="#fc1e405d-0438-41c8-9941-d7f538926b70-2"><i class="fas fa-cannabis"></i>shutdownNow</button></li><li class="tab"><button type="button" data-href="#fc1e405d-0438-41c8-9941-d7f538926b70-3"><i class="fas fa-candy-cane"></i>å…¶ä»–æ–¹æ³•</button></li><li class="tab"><button type="button" data-href="#fc1e405d-0438-41c8-9941-d7f538926b70-4"><i class="fas fa-child"></i>æµ‹è¯•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="fc1e405d-0438-41c8-9941-d7f538926b70-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">çº¿ç¨‹æ± çŠ¶æ€å˜ä¸º SHUTDOWN</span></span><br><span class="line"><span class="comment">- ä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡</span></span><br><span class="line"><span class="comment">- ä½†å·²æäº¤ä»»åŠ¡ä¼šæ‰§è¡Œå®Œ</span></span><br><span class="line"><span class="comment">- æ­¤æ–¹æ³•ä¸ä¼šé˜»å¡è°ƒç”¨çº¿ç¨‹çš„æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        <span class="comment">// ä¿®æ”¹çº¿ç¨‹æ± çŠ¶æ€</span></span><br><span class="line">        advanceRunState(SHUTDOWN);</span><br><span class="line">        <span class="comment">// ä»…ä¼šæ‰“æ–­ç©ºé—²çº¿ç¨‹</span></span><br><span class="line">        interruptIdleWorkers();</span><br><span class="line">        onShutdown(); <span class="comment">// æ‰©å±•ç‚¹ ScheduledThreadPoolExecutor</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°è¯•ç»ˆç»“(æ²¡æœ‰è¿è¡Œçš„çº¿ç¨‹å¯ä»¥ç«‹åˆ»ç»ˆç»“ï¼Œå¦‚æœè¿˜æœ‰è¿è¡Œçš„çº¿ç¨‹ä¹Ÿä¸ä¼šç­‰)</span></span><br><span class="line">    tryTerminate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="fc1e405d-0438-41c8-9941-d7f538926b70-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">çº¿ç¨‹æ± çŠ¶æ€å˜ä¸º STOP</span></span><br><span class="line"><span class="comment">- ä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡</span></span><br><span class="line"><span class="comment">- ä¼šå°†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡è¿”å›</span></span><br><span class="line"><span class="comment">- å¹¶ç”¨ interrupt çš„æ–¹å¼ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">List&lt;Runnable&gt; <span class="title function_">shutdownNow</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Runnable&gt; <span class="title function_">shutdownNow</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Runnable&gt; tasks;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        <span class="comment">// ä¿®æ”¹çº¿ç¨‹æ± çŠ¶æ€</span></span><br><span class="line">        advanceRunState(STOP);</span><br><span class="line">        <span class="comment">// æ‰“æ–­æ‰€æœ‰çº¿ç¨‹</span></span><br><span class="line">        interruptWorkers();</span><br><span class="line">        <span class="comment">// è·å–é˜Ÿåˆ—ä¸­å‰©ä½™ä»»åŠ¡</span></span><br><span class="line">        tasks = drainQueue();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°è¯•ç»ˆç»“</span></span><br><span class="line">    tryTerminate();</span><br><span class="line">    <span class="keyword">return</span> tasks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="fc1e405d-0438-41c8-9941-d7f538926b70-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸åœ¨ RUNNING çŠ¶æ€çš„çº¿ç¨‹æ± ï¼Œæ­¤æ–¹æ³•å°±è¿”å› true</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isShutdown</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">// çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦æ˜¯ TERMINATED</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isTerminated</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">// è°ƒç”¨ shutdown åï¼Œç”±äºè°ƒç”¨çº¿ç¨‹å¹¶ä¸ä¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡è¿è¡Œç»“æŸï¼Œå› æ­¤å¦‚æœå®ƒæƒ³åœ¨çº¿ç¨‹æ±  TERMINATED ååšäº›äº‹æƒ…ï¼Œå¯ä»¥åˆ©ç”¨æ­¤æ–¹æ³•ç­‰å¾…</span></span><br><span class="line"><span class="comment">// ä¸€èˆ¬taskæ˜¯Callableç±»å‹çš„æ—¶å€™ä¸ç”¨æ­¤æ–¹æ³•ï¼Œå› ä¸ºfutureTask.getæ–¹æ³•è‡ªå¸¦ç­‰å¾…åŠŸèƒ½ã€‚</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">awaitTermination</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="fc1e405d-0438-41c8-9941-d7f538926b70-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestShutDown&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestShutDown</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        Future&lt;Integer&gt; result1 = pool.submit(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task 1 running...&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;task 1 finish...&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Future&lt;Integer&gt; result2 = pool.submit(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task 2 running...&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;task 2 finish...&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Future&lt;Integer&gt; result3 = pool.submit(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task 3 running...&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;task 3 finish...&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;shutdown&quot;</span>);</span><br><span class="line">        pool.shutdown();</span><br><span class="line">        <span class="comment">//        pool.awaitTermination(3, TimeUnit.SECONDS);</span></span><br><span class="line">        <span class="comment">//        List&lt;Runnable&gt; runnables = pool.shutdownNow();</span></span><br><span class="line">        <span class="comment">//        log.debug(&quot;other.... &#123;&#125;&quot; , runnables);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç»“æœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#shutdownä¾æ—§ä¼šæ‰§è¡Œå‰©ä¸‹çš„ä»»åŠ¡</span></span><br><span class="line">20:09:13.285 c.TestShutDown [main] - shutdown</span><br><span class="line">20:09:13.285 c.TestShutDown [pool-1-thread-1] - task 1 running...</span><br><span class="line">20:09:13.285 c.TestShutDown [pool-1-thread-2] - task 2 running...</span><br><span class="line">20:09:14.293 c.TestShutDown [pool-1-thread-2] - task 2 finish...</span><br><span class="line">20:09:14.293 c.TestShutDown [pool-1-thread-1] - task 1 finish...</span><br><span class="line">20:09:14.293 c.TestShutDown [pool-1-thread-2] - task 3 running...</span><br><span class="line">20:09:15.303 c.TestShutDown [pool-1-thread-2] - task 3 finish...</span><br><span class="line"><span class="comment">#shutdownNowç«‹åˆ»åœæ­¢æ‰€æœ‰ä»»åŠ¡</span></span><br><span class="line">20:11:11.750 c.TestShutDown [main] - shutdown</span><br><span class="line">20:11:11.750 c.TestShutDown [pool-1-thread-1] - task 1 running...</span><br><span class="line">20:11:11.750 c.TestShutDown [pool-1-thread-2] - task 2 running...</span><br><span class="line">20:11:11.750 c.TestShutDown [main] - other.... [java.util.concurrent.FutureTask@66d33a]</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-6-æ¨¡å¼ä¹‹-Worker-Thread">2.6 æ¨¡å¼ä¹‹ Worker Thread</h3><h4 id="2-6-1-å®šä¹‰">2.6.1 å®šä¹‰</h4><p>è®©æœ‰é™çš„å·¥ä½œçº¿ç¨‹ï¼ˆWorker Threadï¼‰æ¥è½®æµå¼‚æ­¥å¤„ç†æ— é™å¤šçš„ä»»åŠ¡ã€‚ä¹Ÿå¯ä»¥å°†å…¶å½’ç±»ä¸ºåˆ†å·¥æ¨¡å¼ï¼Œå®ƒçš„å…¸å‹å®ç° å°±æ˜¯çº¿ç¨‹æ± ï¼Œä¹Ÿä½“ç°äº†ç»å…¸è®¾è®¡æ¨¡å¼ä¸­çš„äº«å…ƒæ¨¡å¼ã€‚</p><p>ä¾‹å¦‚ï¼Œæµ·åº•æçš„æœåŠ¡å‘˜ï¼ˆçº¿ç¨‹ï¼‰ï¼Œè½®æµå¤„ç†æ¯ä½å®¢äººçš„ç‚¹é¤ï¼ˆä»»åŠ¡ï¼‰ï¼Œå¦‚æœä¸ºæ¯ä½å®¢äººéƒ½é…ä¸€åä¸“å±çš„æœåŠ¡å‘˜ï¼Œé‚£ ä¹ˆæˆæœ¬å°±å¤ªé«˜äº†ï¼ˆå¯¹æ¯”å¦ä¸€ç§å¤šçº¿ç¨‹è®¾è®¡æ¨¡å¼ï¼šThread-Per-Messageï¼‰</p><p>æ³¨æ„ï¼Œä¸åŒä»»åŠ¡ç±»å‹åº”è¯¥ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ± ï¼Œè¿™æ ·èƒ½å¤Ÿé¿å…é¥¥é¥¿ï¼Œå¹¶èƒ½æå‡æ•ˆç‡</p><p>ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªé¤é¦†çš„å·¥äººæ—¢è¦æ‹›å‘¼å®¢äººï¼ˆä»»åŠ¡ç±»å‹Aï¼‰ï¼Œåˆè¦åˆ°åå¨åšèœï¼ˆä»»åŠ¡ç±»å‹Bï¼‰æ˜¾ç„¶æ•ˆç‡ä¸å’‹åœ°ï¼Œåˆ†æˆ æœåŠ¡å‘˜ï¼ˆçº¿ç¨‹æ± Aï¼‰ä¸å¨å¸ˆï¼ˆçº¿ç¨‹æ± Bï¼‰æ›´ä¸ºåˆç†ï¼Œå½“ç„¶ä½ èƒ½æƒ³åˆ°æ›´ç»†è‡´çš„åˆ†å·¥</p><h4 id="2-6-2-é¥¥é¥¿">2.6.2 é¥¥é¥¿</h4><p>å›ºå®šå¤§å°çº¿ç¨‹æ± ä¼šæœ‰é¥¥é¥¿ç°è±¡</p><ul><li>ä¸¤ä¸ªå·¥äººæ˜¯åŒä¸€ä¸ªçº¿ç¨‹æ± ä¸­çš„ä¸¤ä¸ªçº¿ç¨‹</li><li>ä»–ä»¬è¦åšçš„äº‹æƒ…æ˜¯ï¼šä¸ºå®¢äººç‚¹é¤å’Œåˆ°åå¨åšèœï¼Œè¿™æ˜¯ä¸¤ä¸ªé˜¶æ®µçš„å·¥ä½œ<ul><li>å®¢äººç‚¹é¤ï¼šå¿…é¡»å…ˆç‚¹å®Œé¤ï¼Œç­‰èœåšå¥½ï¼Œä¸Šèœï¼Œåœ¨æ­¤æœŸé—´å¤„ç†ç‚¹é¤çš„å·¥äººå¿…é¡»ç­‰å¾…</li><li>åå¨åšèœï¼šæ²¡å•¥è¯´çš„ï¼Œåšå°±æ˜¯äº†</li></ul></li></ul><div class="tabs" id="72098094-2c84-45c0-9581-3fc5aedc6f83"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#72098094-2c84-45c0-9581-3fc5aedc6f83-1"><i class="fas fa-seedling"></i>æ­£å¸¸æƒ…å†µ</button></li><li class="tab"><button type="button" data-href="#72098094-2c84-45c0-9581-3fc5aedc6f83-2"><i class="fas fa-leaf"></i>é¥¥é¥¿æƒ…å†µ</button></li><li class="tab"><button type="button" data-href="#72098094-2c84-45c0-9581-3fc5aedc6f83-3"><i class="fab fa-apple"></i>è§£å†³æ–¹æ³•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="72098094-2c84-45c0-9581-3fc5aedc6f83-1"><p>æ¯”å¦‚å·¥äººA å¤„ç†äº†ç‚¹é¤ä»»åŠ¡ï¼Œæ¥ä¸‹æ¥å®ƒè¦ç­‰ç€ å·¥äººB æŠŠèœåšå¥½ï¼Œç„¶åä¸Šèœï¼Œä»–ä¿©ä¹Ÿé…åˆçš„è›®å¥½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestDeadLock&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestStarvation</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; MENU = Arrays.asList(<span class="string">&quot;åœ°ä¸‰é²œ&quot;</span>, <span class="string">&quot;å®«ä¿é¸¡ä¸&quot;</span>, <span class="string">&quot;è¾£å­é¸¡ä¸&quot;</span>, <span class="string">&quot;çƒ¤é¸¡ç¿…&quot;</span>);</span><br><span class="line">    <span class="keyword">static</span> <span class="type">Random</span> <span class="variable">RANDOM</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    <span class="keyword">static</span> String <span class="title function_">cooking</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> MENU.get(RANDOM.nextInt(MENU.size()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//ä¸¤ä¸ªå·¥äºº</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">Pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">      	<span class="comment">//å®¢äººä¸€</span></span><br><span class="line">        Pool.execute(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å¤„ç†ç‚¹é¤...&quot;</span>);</span><br><span class="line">            <span class="comment">//æ‰¾ä¸€ä¸ªå·¥äººåšèœ</span></span><br><span class="line">            Future&lt;String&gt; f = Pool.submit(() -&gt; &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;åšèœ&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> cooking();</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//ç­‰å¾…åšèœç»“æœ</span></span><br><span class="line">                log.debug(<span class="string">&quot;ä¸Šèœ: &#123;&#125;&quot;</span>, f.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">18</span>:<span class="number">07</span>:<span class="number">14.374</span> c.TestDeadLock [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - å¤„ç†ç‚¹é¤...</span><br><span class="line"><span class="number">18</span>:<span class="number">07</span>:<span class="number">14.379</span> c.TestDeadLock [pool-<span class="number">1</span>-thread-<span class="number">2</span>] - åšèœ</span><br><span class="line"><span class="number">18</span>:<span class="number">07</span>:<span class="number">14.380</span> c.TestDeadLock [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - ä¸Šèœ: å®«ä¿é¸¡ä¸</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="72098094-2c84-45c0-9581-3fc5aedc6f83-2"><p>ä½†ç°åœ¨åŒæ—¶æ¥äº†ä¸¤ä¸ªå®¢äººï¼Œè¿™ä¸ªæ—¶å€™å·¥äººA å’Œå·¥äººB éƒ½å»å¤„ç†ç‚¹é¤äº†ï¼Œè¿™æ—¶æ²¡äººåšé¥­äº†ï¼Œé¥¥é¥¿</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestDeadLock&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestStarvation</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; MENU = Arrays.asList(<span class="string">&quot;åœ°ä¸‰é²œ&quot;</span>, <span class="string">&quot;å®«ä¿é¸¡ä¸&quot;</span>, <span class="string">&quot;è¾£å­é¸¡ä¸&quot;</span>, <span class="string">&quot;çƒ¤é¸¡ç¿…&quot;</span>);</span><br><span class="line">    <span class="keyword">static</span> <span class="type">Random</span> <span class="variable">RANDOM</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    <span class="keyword">static</span> String <span class="title function_">cooking</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> MENU.get(RANDOM.nextInt(MENU.size()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//ä¸¤ä¸ªå·¥äºº</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">Pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">      	<span class="comment">//å®¢äººä¸€</span></span><br><span class="line">        Pool.execute(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å¤„ç†ç‚¹é¤...&quot;</span>);</span><br><span class="line">            <span class="comment">//æ‰¾ä¸€ä¸ªå·¥äººåšèœ</span></span><br><span class="line">            Future&lt;String&gt; f = Pool.submit(() -&gt; &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;åšèœ&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> cooking();</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//ç­‰å¾…åšèœç»“æœ</span></span><br><span class="line">                log.debug(<span class="string">&quot;ä¸Šèœ: &#123;&#125;&quot;</span>, f.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">       <span class="comment">//å®¢äººäºŒ</span></span><br><span class="line">       Pool.execute(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å¤„ç†ç‚¹é¤...&quot;</span>);</span><br><span class="line">            <span class="comment">//æ‰¾ä¸€ä¸ªå·¥äººåšèœ</span></span><br><span class="line">            Future&lt;String&gt; f = Pool.submit(() -&gt; &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;åšèœ&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> cooking();</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//ç­‰å¾…åšèœç»“æœ</span></span><br><span class="line">                log.debug(<span class="string">&quot;ä¸Šèœ: &#123;&#125;&quot;</span>, f.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">18</span>:09:<span class="number">35.527</span> c.TestDeadLock [pool-<span class="number">1</span>-thread-<span class="number">2</span>] - å¤„ç†ç‚¹é¤...</span><br><span class="line"><span class="number">18</span>:09:<span class="number">35.527</span> c.TestDeadLock [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - å¤„ç†ç‚¹é¤...</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="72098094-2c84-45c0-9581-3fc5aedc6f83-3"><p>è§£å†³æ–¹æ³•å¯ä»¥å¢åŠ çº¿ç¨‹æ± çš„å¤§å°ï¼Œä¸è¿‡ä¸æ˜¯æ ¹æœ¬è§£å†³æ–¹æ¡ˆï¼Œè¿˜æ˜¯å‰é¢æåˆ°çš„ï¼Œ<code>ä¸åŒçš„ä»»åŠ¡ç±»å‹ï¼Œé‡‡ç”¨ä¸åŒçš„çº¿ç¨‹æ± </code>ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestStarvation</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; MENU = Arrays.asList(<span class="string">&quot;åœ°ä¸‰é²œ&quot;</span>, <span class="string">&quot;å®«ä¿é¸¡ä¸&quot;</span>, <span class="string">&quot;è¾£å­é¸¡ä¸&quot;</span>, <span class="string">&quot;çƒ¤é¸¡ç¿…&quot;</span>);</span><br><span class="line">    <span class="keyword">static</span> <span class="type">Random</span> <span class="variable">RANDOM</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    <span class="keyword">static</span> String <span class="title function_">cooking</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> MENU.get(RANDOM.nextInt(MENU.size()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//æœåŠ¡å‘˜</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">waiterPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//å¨å­</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">cookPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">        waiterPool.execute(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å¤„ç†ç‚¹é¤...&quot;</span>);</span><br><span class="line">            Future&lt;String&gt; f = cookPool.submit(() -&gt; &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;åšèœ&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> cooking();</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;ä¸Šèœ: &#123;&#125;&quot;</span>, f.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        waiterPool.execute(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å¤„ç†ç‚¹é¤...&quot;</span>);</span><br><span class="line">            Future&lt;String&gt; f = cookPool.submit(() -&gt; &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;åšèœ&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> cooking();</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;ä¸Šèœ: &#123;&#125;&quot;</span>, f.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">17:25:14.626 c.TestDeadLock [pool-1-thread-1] - å¤„ç†ç‚¹é¤... </span><br><span class="line">17:25:14.630 c.TestDeadLock [pool-2-thread-1] - åšèœ</span><br><span class="line">17:25:14.631 c.TestDeadLock [pool-1-thread-1] - ä¸Šèœ: åœ°ä¸‰é²œ</span><br><span class="line">17:25:14.632 c.TestDeadLock [pool-1-thread-1] - å¤„ç†ç‚¹é¤... </span><br><span class="line">17:25:14.632 c.TestDeadLock [pool-2-thread-1] - åšèœ</span><br><span class="line">17:25:14.632 c.TestDeadLock [pool-1-thread-1] - ä¸Šèœ: è¾£å­é¸¡ä¸</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h4 id="2-6-3-åˆ›å»ºå¤šå°‘çº¿ç¨‹æ± åˆé€‚">2.6.3 åˆ›å»ºå¤šå°‘çº¿ç¨‹æ± åˆé€‚</h4><ul><li>è¿‡å°ä¼šå¯¼è‡´ç¨‹åºä¸èƒ½å……åˆ†åœ°åˆ©ç”¨ç³»ç»Ÿèµ„æºã€å®¹æ˜“å¯¼è‡´é¥¥é¥¿</li><li>è¿‡å¤§ä¼šå¯¼è‡´æ›´å¤šçš„çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå ç”¨æ›´å¤šå†…å­˜</li></ul><p><strong>CPU å¯†é›†å‹è¿ç®—</strong></p><p>é€šå¸¸é‡‡ç”¨ <code>cpu æ ¸æ•° + 1</code> èƒ½å¤Ÿå®ç°æœ€ä¼˜çš„ CPU åˆ©ç”¨ç‡ï¼Œ+1 æ˜¯ä¿è¯å½“çº¿ç¨‹ç”±äºé¡µç¼ºå¤±æ•…éšœï¼ˆæ“ä½œç³»ç»Ÿï¼‰æˆ–å…¶å®ƒåŸå›  å¯¼è‡´æš‚åœæ—¶ï¼Œé¢å¤–çš„è¿™ä¸ªçº¿ç¨‹å°±èƒ½é¡¶ä¸Šå»ï¼Œä¿è¯ CPU æ—¶é’Ÿå‘¨æœŸä¸è¢«æµªè´¹</p><p><strong>I/O å¯†é›†å‹è¿ç®—</strong></p><p>CPU ä¸æ€»æ˜¯å¤„äºç¹å¿™çŠ¶æ€ï¼Œä¾‹å¦‚ï¼Œå½“ä½ æ‰§è¡Œä¸šåŠ¡è®¡ç®—æ—¶ï¼Œè¿™æ—¶å€™ä¼šä½¿ç”¨ CPU èµ„æºï¼Œä½†å½“ä½ æ‰§è¡Œ I/O æ“ä½œæ—¶ã€è¿œç¨‹ RPC è°ƒç”¨æ—¶ï¼ŒåŒ…æ‹¬è¿›è¡Œæ•°æ®åº“æ“ä½œæ—¶ï¼Œè¿™æ—¶å€™ CPU å°±é—²ä¸‹æ¥äº†ï¼Œä½ å¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æé«˜å®ƒçš„åˆ©ç”¨ç‡ã€‚</p><p>ç»éªŒå…¬å¼å¦‚ä¸‹</p><p><code>çº¿ç¨‹æ•° = æ ¸æ•° * æœŸæœ› CPU åˆ©ç”¨ç‡ * æ€»æ—¶é—´(CPUè®¡ç®—æ—¶é—´+ç­‰å¾…æ—¶é—´) / CPU è®¡ç®—æ—¶é—´</code></p><p>ä¾‹å¦‚ 4 æ ¸ CPU è®¡ç®—æ—¶é—´æ˜¯ 50% ï¼Œå…¶å®ƒç­‰å¾…æ—¶é—´æ˜¯ 50%ï¼ŒæœŸæœ› cpu è¢« 100% åˆ©ç”¨ï¼Œå¥—ç”¨å…¬å¼</p><p><code>4 * 100% * 100% / 50% = 8</code></p><p>ä¾‹å¦‚ 4 æ ¸ CPU è®¡ç®—æ—¶é—´æ˜¯ 10% ï¼Œå…¶å®ƒç­‰å¾…æ—¶é—´æ˜¯ 90%ï¼ŒæœŸæœ› cpu è¢« 100% åˆ©ç”¨ï¼Œå¥—ç”¨å…¬å¼</p><p><code>4 * 100% * 100% / 10% = 40</code></p><h3 id="2-7-ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± ">2.7 ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± </h3><p>æœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›ä»»åŠ¡å»¶æ—¶æ‰§è¡Œï¼Œæˆ–è€…ä»»åŠ¡åå¤è¢«æ‰§è¡Œæ¯éš”å‡ ç§’å°±æ‰§è¡Œä¸€æ¬¡ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± ã€‚</p><div class="tabs" id="48895836-bcf8-493d-93c7-10ef0f0adbf7"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#48895836-bcf8-493d-93c7-10ef0f0adbf7-1"><i class="fas fa-cat"></i>Timerå®ç°</button></li><li class="tab"><button type="button" data-href="#48895836-bcf8-493d-93c7-10ef0f0adbf7-2"><i class="fas fa-horse"></i>ScheduledExecutorServiceå®ç°</button></li><li class="tab"><button type="button" data-href="#48895836-bcf8-493d-93c7-10ef0f0adbf7-3"><i class="fas fa-dove"></i>çº¿ç¨‹æ•°å°‘æ—¶</button></li><li class="tab"><button type="button" data-href="#48895836-bcf8-493d-93c7-10ef0f0adbf7-4"><i class="fas fa-dragon"></i>å‡ºç°å¼‚å¸¸æ—¶</button></li><li class="tab"><button type="button" data-href="#48895836-bcf8-493d-93c7-10ef0f0adbf7-5"><i class="fas fa-atom"></i>å®šæ—¶æ‰§è¡Œ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="48895836-bcf8-493d-93c7-10ef0f0adbf7-1"><p>åœ¨ã€ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± ã€åŠŸèƒ½åŠ å…¥ä¹‹å‰(JDK1.3)ï¼Œå¯ä»¥ä½¿ç”¨ java.util.Timer æ¥å®ç°å®šæ—¶åŠŸèƒ½ï¼ŒTimer çš„ä¼˜ç‚¹åœ¨äºç®€å•æ˜“ç”¨ï¼Œä½†ç”±äºæ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹æ¥è°ƒåº¦ï¼Œå› æ­¤æ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œï¼Œå‰ä¸€ä¸ª ä»»åŠ¡çš„å»¶è¿Ÿæˆ–å¼‚å¸¸éƒ½å°†ä¼šå½±å“åˆ°ä¹‹åçš„ä»»åŠ¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Timer</span> <span class="variable">timer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Timer</span>();</span><br><span class="line">    <span class="type">TimerTask</span> <span class="variable">task1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task 1&quot;</span>);</span><br><span class="line">            sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">TimerTask</span> <span class="variable">task2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task 2&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ timer æ·»åŠ ä¸¤ä¸ªä»»åŠ¡ï¼Œå¸Œæœ›å®ƒä»¬éƒ½åœ¨ 1s åæ‰§è¡Œ</span></span><br><span class="line">    <span class="comment">// ä½†ç”±äº timer å†…åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥é¡ºåºæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œå› æ­¤ã€ä»»åŠ¡1ã€çš„å»¶æ—¶ï¼Œå½±å“äº†ã€ä»»åŠ¡2ã€çš„æ‰§è¡Œ</span></span><br><span class="line">    log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">    timer.schedule(task1, <span class="number">1000</span>);</span><br><span class="line">    timer.schedule(task2, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">20:46:09.444 c.TestTimer [main] - start... </span><br><span class="line">20:46:10.447 c.TestTimer [Timer-0] - task 1 </span><br><span class="line">20:46:12.448 c.TestTimer [Timer-0] - task 2 </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="48895836-bcf8-493d-93c7-10ef0f0adbf7-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ScheduledExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line"><span class="comment">// æ·»åŠ ä¸¤ä¸ªä»»åŠ¡ï¼Œå¸Œæœ›å®ƒä»¬éƒ½åœ¨ 1s åæ‰§è¡Œ</span></span><br><span class="line"><span class="comment">//ä»»åŠ¡ä¸€</span></span><br><span class="line">executor.schedule(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»»åŠ¡1ï¼Œæ‰§è¡Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">2000</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; &#125;</span><br><span class="line">&#125;, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»»åŠ¡äºŒ</span></span><br><span class="line">executor.schedule(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»»åŠ¡2ï¼Œæ‰§è¡Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">&#125;, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä»»åŠ¡1ï¼Œæ‰§è¡Œæ—¶é—´ï¼šThu Jan 03 12:45:17 CST 2019 </span><br><span class="line">ä»»åŠ¡2ï¼Œæ‰§è¡Œæ—¶é—´ï¼šThu Jan 03 12:45:17 CST 2019 </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="48895836-bcf8-493d-93c7-10ef0f0adbf7-3"><p>ä¸²è¡Œæ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ScheduledExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line"><span class="comment">// æ·»åŠ ä¸¤ä¸ªä»»åŠ¡ï¼Œå¸Œæœ›å®ƒä»¬éƒ½åœ¨ 1s åæ‰§è¡Œ</span></span><br><span class="line"><span class="comment">//ä»»åŠ¡ä¸€</span></span><br><span class="line">executor.schedule(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»»åŠ¡1ï¼Œæ‰§è¡Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">2000</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; &#125;</span><br><span class="line">&#125;, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»»åŠ¡äºŒ</span></span><br><span class="line">executor.schedule(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»»åŠ¡2ï¼Œæ‰§è¡Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">&#125;, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä»»åŠ¡<span class="number">1</span>ï¼Œæ‰§è¡Œæ—¶é—´ï¼šMon Apr <span class="number">03</span> <span class="number">18</span>:<span class="number">48</span>:<span class="number">24</span> CST <span class="number">2023</span></span><br><span class="line">ä»»åŠ¡<span class="number">2</span>ï¼Œæ‰§è¡Œæ—¶é—´ï¼šMon Apr <span class="number">03</span> <span class="number">18</span>:<span class="number">48</span>:<span class="number">26</span> CST <span class="number">2023</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="48895836-bcf8-493d-93c7-10ef0f0adbf7-4"><p>ä»»åŠ¡ä¸€ä¸­ é™¤é›¶å¼‚å¸¸</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ScheduledExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// æ·»åŠ ä¸¤ä¸ªä»»åŠ¡ï¼Œå¸Œæœ›å®ƒä»¬éƒ½åœ¨ 1s åæ‰§è¡Œ</span></span><br><span class="line"><span class="comment">//ä»»åŠ¡ä¸€</span></span><br><span class="line">executor.schedule(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»»åŠ¡1ï¼Œæ‰§è¡Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="type">int</span> i=<span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">2000</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; &#125;</span><br><span class="line">&#125;, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»»åŠ¡äºŒ</span></span><br><span class="line">executor.schedule(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»»åŠ¡2ï¼Œæ‰§è¡Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">&#125;, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä»»åŠ¡<span class="number">1</span>ï¼Œæ‰§è¡Œæ—¶é—´ï¼šMon Apr <span class="number">03</span> <span class="number">18</span>:<span class="number">50</span>:<span class="number">35</span> CST <span class="number">2023</span></span><br><span class="line">ä»»åŠ¡<span class="number">2</span>ï¼Œæ‰§è¡Œæ—¶é—´ï¼šMon Apr <span class="number">03</span> <span class="number">18</span>:<span class="number">50</span>:<span class="number">35</span> CST <span class="number">2023</span></span><br></pre></td></tr></table></figure><p>éƒ½æ‰§è¡Œï¼Œå¹¶æœªçœ‹åˆ°å¼‚å¸¸ä¿¡æ¯</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="48895836-bcf8-493d-93c7-10ef0f0adbf7-5"><p>scheduleAtFixedRateï¼šçœŸæ­£çš„é—´éš”æ—¶é—´ï¼Œæ˜¯ç”±ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å’Œè®¾ç½®çš„é—´éš”æ—¶é—´é•¿çŸ­æ¥å†³å®šçš„ï¼Œè°é•¿å–è°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»¥ä¸Šä¸€ä¸ªä»»åŠ¡å¼€å§‹çš„æ—¶é—´è®¡æ—¶ï¼Œperiodæ—¶é—´è¿‡å»åï¼Œæ£€æµ‹ä¸Šä¸€ä¸ªä»»åŠ¡æ˜¯å¦æ‰§è¡Œå®Œæ¯•ï¼Œå¦‚æœä¸Šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™å½“å‰ä»»åŠ¡ç«‹å³æ‰§è¡Œï¼Œå¦‚æœä¸Šä¸€ä¸ªä»»åŠ¡æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™éœ€è¦ç­‰ä¸Šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åç«‹å³æ‰§è¡Œã€‚<br>scheduleWithFixedDelayï¼šçœŸæ­£çš„é—´éš”æ—¶é—´ï¼Œæ˜¯ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´åŠ ä¸Šè®¾ç½®çš„é—´éš”æ—¶é—´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ˜¯ä»¥ä¸Šä¸€ä¸ªä»»åŠ¡ç»“æŸæ—¶å¼€å§‹è®¡æ—¶ï¼Œperiodæ—¶é—´è¿‡å»åï¼Œç«‹å³æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ScheduledExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line">log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">pool.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;running...&quot;</span>);</span><br><span class="line">&#125;, <span class="number">1</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">37.231</span> c.TestTimer [main] - start...</span><br><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">38.333</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running...</span><br><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">39.332</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running...</span><br><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">40.332</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running...</span><br><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">41.332</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running...</span><br><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">42.332</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running...</span><br><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">43.332</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running...</span><br><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">44.329</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running...</span><br><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">45.332</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running...</span><br><span class="line"><span class="number">18</span>:<span class="number">56</span>:<span class="number">46.332</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running...</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ScheduledExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line">log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">pool.scheduleWithFixedDelay(()-&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;running...&quot;</span>);</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">&#125;, <span class="number">1</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">40</span>:<span class="number">55.078</span> c.TestTimer [main] - start... </span><br><span class="line"><span class="number">21</span>:<span class="number">40</span>:<span class="number">56.140</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running... </span><br><span class="line"><span class="number">21</span>:<span class="number">40</span>:<span class="number">59.143</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running... </span><br><span class="line"><span class="number">21</span>:<span class="number">41</span>:<span class="number">02.145</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running... </span><br><span class="line"><span class="number">21</span>:<span class="number">41</span>:<span class="number">05.147</span> c.TestTimer [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - running... </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-8-æ­£ç¡®å¤„ç†æ‰§è¡Œä»»åŠ¡å¼‚å¸¸">2.8 æ­£ç¡®å¤„ç†æ‰§è¡Œä»»åŠ¡å¼‚å¸¸</h3><p>ä¸è®ºæ˜¯å“ªä¸ªçº¿ç¨‹æ± ï¼Œåœ¨çº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡å‘ç”Ÿå¼‚å¸¸åæ—¢ä¸ä¼šæŠ›å‡ºï¼Œä¹Ÿä¸ä¼šæ•è·ï¼Œè¿™æ—¶å°±éœ€è¦æˆ‘ä»¬åšä¸€å®šçš„å¤„ç†ã€‚</p><div class="tabs" id="1cbd0048-f807-4045-8580-23803459291a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#1cbd0048-f807-4045-8580-23803459291a-1"><i class="fas fa-award"></i>æ–¹æ³•1ï¼šä¸»åŠ¨æ‰å¼‚å¸¸</button></li><li class="tab"><button type="button" data-href="#1cbd0048-f807-4045-8580-23803459291a-2"><i class="fas fa-baseball-ball"></i>æ–¹æ³•2ï¼šä½¿ç”¨ Future</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="1cbd0048-f807-4045-8580-23803459291a-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">pool.submit(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;task1&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;error:&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">21:59:04.558 c.TestTimer [pool-1-thread-1] - task1 </span><br><span class="line">21:59:04.562 c.TestTimer [pool-1-thread-1] - error: </span><br><span class="line">java.lang.ArithmeticException: / by zero </span><br><span class="line"> at cn.itcast.n8.TestTimer.lambda$main<span class="variable">$0</span>(TestTimer.java:28) </span><br><span class="line"> at java.util.concurrent.Executors<span class="variable">$RunnableAdapter</span>.call(Executors.java:511) </span><br><span class="line"> at java.util.concurrent.FutureTask.run(FutureTask.java:266) </span><br><span class="line"> at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) </span><br><span class="line"> at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:624) </span><br><span class="line"> at java.lang.Thread.run(Thread.java:748) </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="1cbd0048-f807-4045-8580-23803459291a-2"><p>è¯´æ˜ï¼š</p><ul><li>lambdaè¡¨è¾¾å¼å†…è¦æœ‰è¿”å›å€¼ï¼Œç¼–è¯‘å™¨æ‰èƒ½å°†å…¶è¯†åˆ«ä¸ºCallableï¼Œå¦åˆ™å°†è¯†åˆ«ä¸ºRunnableï¼Œä¹Ÿå°±ä¸èƒ½ç”¨FutureTask</li><li>æ–¹æ³•ä¸­å¦‚æœå‡ºå¼‚å¸¸ï¼Œ<code>futuretask.get</code>ä¼šè¿”å›è¿™ä¸ªå¼‚å¸¸ï¼Œå¦è€…æ­£å¸¸è¿”å›ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">Future&lt;Boolean&gt; f = pool.submit(() -&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;task1&quot;</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br><span class="line">log.debug(<span class="string">&quot;result:&#123;&#125;&quot;</span>, f.get());</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">21:54:58.208 c.TestTimer [pool-1-thread-1] - task1 </span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;main&quot;</span> java.util.concurrent.ExecutionException: </span><br><span class="line">java.lang.ArithmeticException: / by zero </span><br><span class="line"> at java.util.concurrent.FutureTask.report(FutureTask.java:122) </span><br><span class="line"> at java.util.concurrent.FutureTask.get(FutureTask.java:192) </span><br><span class="line"> at cn.itcast.n8.TestTimer.main(TestTimer.java:31) </span><br><span class="line">Caused by: java.lang.ArithmeticException: / by zero </span><br><span class="line"> at cn.itcast.n8.TestTimer.lambda$main<span class="variable">$0</span>(TestTimer.java:28) </span><br><span class="line"> at java.util.concurrent.FutureTask.run(FutureTask.java:266) </span><br><span class="line"> at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) </span><br><span class="line"> at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:624) </span><br><span class="line"> at java.lang.Thread.run(Thread.java:748) </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="2-9-åº”ç”¨ä¹‹å®šæ—¶ä»»åŠ¡">2.9 åº”ç”¨ä¹‹å®šæ—¶ä»»åŠ¡</h3><p>å¦‚ä½•è®©æ¯å‘¨å›› 18:00:00 å®šæ—¶æ‰§è¡Œä»»åŠ¡ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å¾—å½“å‰æ—¶é—´</span></span><br><span class="line"><span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line"><span class="comment">// è·å–æœ¬å‘¨å›› 18:00:00.000</span></span><br><span class="line"><span class="type">LocalDateTime</span> <span class="variable">thursday</span> <span class="operator">=</span> </span><br><span class="line">    now.with(DayOfWeek.THURSDAY).withHour(<span class="number">18</span>).withMinute(<span class="number">0</span>).withSecond(<span class="number">0</span>).withNano(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// å¦‚æœå½“å‰æ—¶é—´å·²ç»è¶…è¿‡ æœ¬å‘¨å›› 18:00:00.000ï¼Œ é‚£ä¹ˆæ‰¾ä¸‹å‘¨å›› 18:00:00.000</span></span><br><span class="line"><span class="keyword">if</span>(now.compareTo(thursday) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    thursday = thursday.plusWeeks(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è®¡ç®—æ—¶é—´å·®ï¼Œå³å»¶æ—¶æ‰§è¡Œæ—¶é—´</span></span><br><span class="line"><span class="type">long</span> <span class="variable">initialDelay</span> <span class="operator">=</span> Duration.between(now, thursday).toMillis();</span><br><span class="line"><span class="comment">// è®¡ç®—é—´éš”æ—¶é—´ï¼Œå³ 1 å‘¨çš„æ¯«ç§’å€¼</span></span><br><span class="line"><span class="type">long</span> <span class="variable">oneWeek</span> <span class="operator">=</span> <span class="number">7</span> * <span class="number">24</span> * <span class="number">3600</span> * <span class="number">1000</span>;</span><br><span class="line"><span class="type">ScheduledExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;å¼€å§‹æ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">executor.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;æ‰§è¡Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">&#125;, initialDelay, oneWeek, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure><h3 id="2-10-Tomcat-çº¿ç¨‹æ± ">2.10 Tomcat çº¿ç¨‹æ± </h3><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230403193219700.png" alt="image-20230403193219700" style="zoom:33%"><ul><li>LimitLatch ç”¨æ¥é™æµï¼Œå¯ä»¥æ§åˆ¶æœ€å¤§è¿æ¥ä¸ªæ•°ï¼Œç±»ä¼¼ J.U.C ä¸­çš„ Semaphore åé¢å†è®²</li><li>Acceptor åªè´Ÿè´£ã€æ¥æ”¶æ–°çš„ socket è¿æ¥ã€‘</li><li>Poller åªè´Ÿè´£ç›‘å¬ socket channel æ˜¯å¦æœ‰ã€å¯è¯»çš„ I/O äº‹ä»¶ã€‘</li><li>ä¸€æ—¦å¯è¯»ï¼Œå°è£…ä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼ˆsocketProcessorï¼‰ï¼Œæäº¤ç»™ Executor çº¿ç¨‹æ± å¤„ç†</li><li>Executor çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹æœ€ç»ˆè´Ÿè´£ã€å¤„ç†è¯·æ±‚ã€‘</li></ul><blockquote><p>åˆç†çš„åˆ†å·¥æ˜¯å®ç°é«˜å¹¶å‘çš„ä¿éšœã€‚å›¾ä¸­Acceptorå’Œã€Pollerå’ŒExecutorä¸­çš„çº¿ç¨‹éƒ½æ˜¯çº¿ç¨‹ã€‚é‚£ä¸ºä»€ä¹ˆæŠŠå®ƒä»¬åˆ†æˆä¸‰å—å‘¢ï¼Ÿå®ƒä»¬æ¯ä¸€å—å¤„ç†çš„ä»»åŠ¡æ—¶ä¸ä¸€æ ·çš„ã€‚</p></blockquote><p>Tomcat çº¿ç¨‹æ± æ‰©å±•äº† ThreadPoolExecutorï¼Œè¡Œä¸ºç¨æœ‰ä¸åŒ</p><ul><li>å¦‚æœæ€»çº¿ç¨‹æ•°è¾¾åˆ° maximumPoolSize<ul><li>è¿™æ—¶ä¸ä¼šç«‹åˆ»æŠ› RejectedExecutionException å¼‚å¸¸</li><li>è€Œæ˜¯å†æ¬¡å°è¯•å°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ï¼Œå¦‚æœè¿˜å¤±è´¥ï¼Œæ‰æŠ›å‡º RejectedExecutionException å¼‚å¸¸</li></ul></li></ul><div class="tabs" id="08eb1b2a-94d2-4d0c-92b5-acf34fc46e28"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#08eb1b2a-94d2-4d0c-92b5-acf34fc46e28-1"><i class="fas fa-seedling"></i>æºç  tomcat-7.0.42</button></li><li class="tab"><button type="button" data-href="#08eb1b2a-94d2-4d0c-92b5-acf34fc46e28-2"><i class="fas fa-leaf"></i>TaskQueue.java</button></li><li class="tab"><button type="button" data-href="#08eb1b2a-94d2-4d0c-92b5-acf34fc46e28-3"><i class="fab fa-apple"></i>Connector é…ç½®</button></li><li class="tab"><button type="button" data-href="#08eb1b2a-94d2-4d0c-92b5-acf34fc46e28-4"><i class="fas fa-tree"></i>Executor çº¿ç¨‹é…ç½®</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="08eb1b2a-94d2-4d0c-92b5-acf34fc46e28-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command, <span class="type">long</span> timeout, TimeUnit unit)</span> &#123;</span><br><span class="line">    submittedCount.incrementAndGet();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.execute(command);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RejectedExecutionException rx) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">super</span>.getQueue() <span class="keyword">instanceof</span> TaskQueue) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">TaskQueue</span> <span class="variable">queue</span> <span class="operator">=</span> (TaskQueue)<span class="built_in">super</span>.getQueue();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!queue.force(command, timeout, unit)) &#123;</span><br><span class="line">                    submittedCount.decrementAndGet();</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionException</span>(<span class="string">&quot;Queue capacity is full.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException x) &#123;</span><br><span class="line">                submittedCount.decrementAndGet();</span><br><span class="line">                Thread.interrupted();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionException</span>(x);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            submittedCount.decrementAndGet();</span><br><span class="line">            <span class="keyword">throw</span> rx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="08eb1b2a-94d2-4d0c-92b5-acf34fc46e28-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">force</span><span class="params">(Runnable o, <span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">if</span> ( parent.isShutdown() ) </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionException</span>(</span><br><span class="line">        <span class="string">&quot;Executor not running, can&#x27;t force a command into the queue&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.offer(o,timeout,unit); <span class="comment">//forces the item onto the queue, to be used if the task </span></span><br><span class="line">    is rejected</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="08eb1b2a-94d2-4d0c-92b5-acf34fc46e28-3"><table><thead><tr><th style="text-align:center">é…ç½®é¡¹</th><th style="text-align:center">é»˜è®¤å€¼</th><th style="text-align:center">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center"><code>acceptorThreadCount</code></td><td style="text-align:center">1</td><td style="text-align:center">acceptor çº¿ç¨‹æ•°é‡</td></tr><tr><td style="text-align:center"><code>pollerThreadCount</code></td><td style="text-align:center">1</td><td style="text-align:center">poller çº¿ç¨‹æ•°é‡</td></tr><tr><td style="text-align:center"><code>minSpareThreads</code></td><td style="text-align:center">10</td><td style="text-align:center">æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå³ corePoolSize</td></tr><tr><td style="text-align:center"><code>maxThreads</code></td><td style="text-align:center">200</td><td style="text-align:center">æœ€å¤§çº¿ç¨‹æ•°ï¼Œå³ maximumPoolSize</td></tr><tr><td style="text-align:center"><code>executor</code></td><td style="text-align:center">-</td><td style="text-align:center"></td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="08eb1b2a-94d2-4d0c-92b5-acf34fc46e28-4"><table><thead><tr><th style="text-align:center">é…ç½®é¡¹</th><th style="text-align:center">é»˜è®¤å€¼</th><th style="text-align:center">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center"><code>threadPriority</code></td><td style="text-align:center">5</td><td style="text-align:center">çº¿ç¨‹ä¼˜å…ˆçº§</td></tr><tr><td style="text-align:center"><code>daemon</code></td><td style="text-align:center">true</td><td style="text-align:center">æ˜¯å¦å®ˆæŠ¤çº¿ç¨‹</td></tr><tr><td style="text-align:center"><code>minSpareThreads</code></td><td style="text-align:center">25</td><td style="text-align:center">æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå³corePoolSize</td></tr><tr><td style="text-align:center"><code>maxThreads</code></td><td style="text-align:center">200</td><td style="text-align:center">æœ€å¤§çº¿ç¨‹æ•°ï¼Œå³ maximumPoolSize</td></tr><tr><td style="text-align:center"><code>maxIdleTime</code></td><td style="text-align:center">60000</td><td style="text-align:center">çº¿ç¨‹ç”Ÿå­˜æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œé»˜è®¤å€¼å³ 1 åˆ†é’Ÿ</td></tr><tr><td style="text-align:center"><code>maxQueueSize</code></td><td style="text-align:center">Integer.MAX_VALUE</td><td style="text-align:center">é˜Ÿåˆ—é•¿åº¦</td></tr><tr><td style="text-align:center"><code>prestartminSpareThreads</code></td><td style="text-align:center">false</td><td style="text-align:center">æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶å¯åŠ¨</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220312104017979.png" alt="image-20220312104017979"></p><h3 id="2-11-Fork-Join">2.11 Fork/Join</h3><p>Fork/Join æ˜¯ JDK 1.7 åŠ å…¥çš„æ–°çš„çº¿ç¨‹æ± å®ç°ï¼Œå®ƒä½“ç°çš„æ˜¯ä¸€ç§åˆ†æ²»æ€æƒ³ï¼Œé€‚ç”¨äºèƒ½å¤Ÿè¿›è¡Œä»»åŠ¡æ‹†åˆ†çš„ cpu å¯†é›†å‹ è¿ç®—</p><p>æ‰€è°“çš„ä»»åŠ¡æ‹†åˆ†ï¼Œæ˜¯å°†ä¸€ä¸ªå¤§ä»»åŠ¡æ‹†åˆ†ä¸ºç®—æ³•ä¸Šç›¸åŒçš„å°ä»»åŠ¡ï¼Œç›´è‡³ä¸èƒ½æ‹†åˆ†å¯ä»¥ç›´æ¥æ±‚è§£ã€‚è·Ÿé€’å½’ç›¸å…³çš„ä¸€äº›è®¡ç®—ï¼Œå¦‚å½’å¹¶æ’åºã€æ–æ³¢é‚£å¥‘æ•°åˆ—ã€éƒ½å¯ä»¥ç”¨åˆ†æ²»æ€æƒ³è¿›è¡Œæ±‚è§£</p><p>Fork/Join åœ¨åˆ†æ²»çš„åŸºç¡€ä¸ŠåŠ å…¥äº†å¤šçº¿ç¨‹ï¼Œå¯ä»¥æŠŠæ¯ä¸ªä»»åŠ¡çš„åˆ†è§£å’Œåˆå¹¶äº¤ç»™ä¸åŒçš„çº¿ç¨‹æ¥å®Œæˆï¼Œè¿›ä¸€æ­¥æå‡äº†è¿ ç®—æ•ˆç‡</p><p>Fork/Join é»˜è®¤ä¼šåˆ›å»ºä¸ cpu æ ¸å¿ƒæ•°å¤§å°ç›¸åŒçš„çº¿ç¨‹æ± </p><p>æäº¤ç»™ Fork/Join çº¿ç¨‹æ± çš„ä»»åŠ¡éœ€è¦ç»§æ‰¿ RecursiveTaskï¼ˆæœ‰è¿”å›å€¼ï¼‰æˆ– RecursiveActionï¼ˆæ²¡æœ‰è¿”å›å€¼ï¼‰ï¼Œä¾‹å¦‚ä¸‹é¢å®šä¹‰äº†ä¸€ä¸ªå¯¹ 1~n ä¹‹é—´çš„æ•´æ•°æ±‚å’Œçš„ä»»åŠ¡</p><h2 id="3-AQS-åŸç†">3. AQS åŸç†</h2><h3 id="3-1-æ¦‚è¿°">3.1 æ¦‚è¿°</h3><p>å…¨ç§°æ˜¯ AbstractQueuedSynchronizerï¼Œæ˜¯<code>é˜»å¡å¼é”å’Œç›¸å…³çš„åŒæ­¥å™¨å·¥å…·</code>çš„æ¡†æ¶ (å…¶å®ƒçš„åŒæ­¥å™¨éƒ½æ˜¯å®ƒçš„å­ç±»)</p><p>æ˜¯ç”¨æ¥å®ç°é”æˆ–è€…å…¶å®ƒåŒæ­¥å™¨ç»„ä»¶çš„å…¬å…±åŸºç¡€éƒ¨åˆ†çš„æŠ½è±¡å®ç°ï¼Œ <span class="p red">æ˜¯é‡é‡çº§åŸºç¡€æ¡†æ¶åŠæ•´ä¸ªJUCä½“ç³»çš„åŸºçŸ³ï¼Œä¸»è¦ç”¨äºè§£å†³é”åˆ†é…ç»™"è°"çš„é—®é¢˜</span>ã€‚</p><p>æ•´ä½“å°±æ˜¯ä¸€ä¸ªæŠ½è±¡çš„<span class="p green">FIFOé˜Ÿåˆ—</span>æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œï¼Œå¹¶é€šè¿‡ä¸€ä¸ªintç±»å˜é‡è¡¨ç¤ºæŒæœ‰é”çš„çŠ¶æ€ã€‚</p><p>æ—¢ç„¶è¯´åˆ°äº†æ’é˜Ÿç­‰å€™æœºåˆ¶ï¼Œé‚£ä¹ˆå°±ä¸€å®šä¼šæœ‰æŸç§é˜Ÿåˆ—å½¢æˆï¼Œè¿™æ ·çš„é˜Ÿåˆ—æ˜¯ä»€ä¹ˆæ•°æ®ç»“æ„å‘¢ï¼Ÿ</p><p>å¦‚æœå…±äº«èµ„æºè¢«å ç”¨ï¼Œ<span class="p blue">å°±éœ€è¦ä¸€å®šçš„é˜»å¡ç­‰å¾…å”¤é†’æœºåˆ¶æ¥ä¿è¯é”åˆ†é…</span>ã€‚è¿™ä¸ªæœºåˆ¶ä¸»è¦ç”¨çš„æ˜¯CLHé˜Ÿåˆ—çš„å˜ä½“å®ç°çš„ï¼Œå°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªé˜Ÿåˆ—å°±æ˜¯AQSåŒæ­¥é˜Ÿåˆ—çš„æŠ½è±¡è¡¨ç°ã€‚å®ƒå°†è¦è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹åŠè‡ªèº«çš„ç­‰å¾…çŠ¶æ€å°è£…æˆé˜Ÿåˆ—çš„ç»“ç‚¹å¯¹è±¡ï¼ˆNodeï¼‰ï¼Œé€šè¿‡ CASã€è‡ªæ—‹ä»¥åŠLockSupport.park()çš„æ–¹å¼ï¼Œç»´æŠ¤state å˜é‡çš„çŠ¶æ€ï¼Œä½¿å¹¶å‘è¾¾åˆ°åŒæ­¥çš„æ•ˆæœã€‚</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230406141436231.png" alt="image-20230406141436231" style="zoom:80%"><p>ç‰¹ç‚¹ï¼š</p><ul><li>ç”¨ state å±æ€§æ¥è¡¨ç¤ºèµ„æºçš„çŠ¶æ€ï¼ˆåˆ†ç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼ï¼‰ï¼Œå­ç±»éœ€è¦å®šä¹‰å¦‚ä½•ç»´æŠ¤è¿™ä¸ªçŠ¶æ€ï¼Œæ§åˆ¶å¦‚ä½•è·å– é”å’Œé‡Šæ”¾é”<ul><li>getState - è·å– state çŠ¶æ€</li><li>setState - è®¾ç½® state çŠ¶æ€</li><li>compareAndSetState - cas æœºåˆ¶è®¾ç½® state çŠ¶æ€</li><li>ç‹¬å æ¨¡å¼æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®èµ„æºï¼Œè€Œå…±äº«æ¨¡å¼å¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹è®¿é—®èµ„æº</li></ul></li><li>æä¾›äº†åŸºäº FIFO çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œç±»ä¼¼äº Monitor çš„ EntryList</li><li>æ¡ä»¶å˜é‡æ¥å®ç°ç­‰å¾…ã€å”¤é†’æœºåˆ¶ï¼Œæ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡ï¼Œç±»ä¼¼äº Monitor çš„ WaitSet</li></ul><p>å­ç±»ä¸»è¦å®ç°è¿™æ ·ä¸€äº›æ–¹æ³•ï¼ˆé»˜è®¤æŠ›å‡º UnsupportedOperationExceptionï¼‰</p><ul><li>tryAcquire</li><li>tryRelease</li><li>tryAcquireShared</li><li>tryReleaseShared</li><li>isHeldExclusively</li></ul><div class="tabs" id="c3d3b843-622d-48b5-bc37-a885e1227037"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c3d3b843-622d-48b5-bc37-a885e1227037-1"><i class="fas fa-cat"></i>è·å–é”çš„å§¿åŠ¿</button></li><li class="tab"><button type="button" data-href="#c3d3b843-622d-48b5-bc37-a885e1227037-2"><i class="fas fa-horse"></i>é‡Šæ”¾é”çš„å§¿åŠ¿</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c3d3b843-622d-48b5-bc37-a885e1227037-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœè·å–é”å¤±è´¥</span></span><br><span class="line"><span class="keyword">if</span> (!tryAcquire(arg)) &#123;</span><br><span class="line">    <span class="comment">// å…¥é˜Ÿ, å¯ä»¥é€‰æ‹©é˜»å¡å½“å‰çº¿ç¨‹ park unpark</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c3d3b843-622d-48b5-bc37-a885e1227037-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœé‡Šæ”¾é”æˆåŠŸ</span></span><br><span class="line"><span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">    <span class="comment">// è®©é˜»å¡çº¿ç¨‹æ¢å¤è¿è¡Œ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="3-2-AQSå†…éƒ¨ä½“ç³»æ¶æ„">3.2 AQSå†…éƒ¨ä½“ç³»æ¶æ„</h3><div class="tabs" id="aaa44ce3-b491-4ef6-bbda-652098c94817"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#aaa44ce3-b491-4ef6-bbda-652098c94817-1"><i class="fas fa-bug"></i>AQSæ¶æ„</button></li><li class="tab"><button type="button" data-href="#aaa44ce3-b491-4ef6-bbda-652098c94817-2"><i class="fas fa-cannabis"></i>AQSçš„stateå˜é‡</button></li><li class="tab"><button type="button" data-href="#aaa44ce3-b491-4ef6-bbda-652098c94817-3"><i class="fas fa-candy-cane"></i>AQSçš„CLHé˜Ÿåˆ—</button></li><li class="tab"><button type="button" data-href="#aaa44ce3-b491-4ef6-bbda-652098c94817-4"><i class="fas fa-child"></i>AQSçš„å†…éƒ¨ç±»Node</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="aaa44ce3-b491-4ef6-bbda-652098c94817-1"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230406133051207.png" alt="image-20230406133051207" style="zoom:50%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="aaa44ce3-b491-4ef6-bbda-652098c94817-2"><p>ç±»ä¼¼äºé“¶è¡ŒåŠç†ä¸šåŠ¡çš„å—ç†çª—å£çŠ¶æ€ï¼Œé›¶å°±æ˜¯æ²¡äººï¼Œè‡ªç”±çŠ¶æ€å¯ä»¥åŠç†ï¼Œå¤§äºç­‰äº1ï¼Œæœ‰äººå ç”¨çª—å£ï¼Œç­‰ç€å»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The synchronization state.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> state;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getState</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setState</span><span class="params">(<span class="type">int</span> newState)</span> &#123;</span><br><span class="line">    state = newState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="aaa44ce3-b491-4ef6-bbda-652098c94817-3"><p>CLHé˜Ÿåˆ—(ä¸‰ä¸ªå¤§ç‰›çš„åå­—ç»„æˆ),ä¸ºä¸€ä¸ªåŒå‘é˜Ÿåˆ—</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230406140012073.png" alt="image-20230406140012073" style="zoom:50%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="aaa44ce3-b491-4ef6-bbda-652098c94817-4"><p>è¯´äººè¯,é˜Ÿåˆ—ä¸­æ¯ä¸ªæ’é˜Ÿçš„ä¸ªä½“(çº¿ç¨‹)å°±æ˜¯ä¸€ä¸ªNodeã€‚Nodeçš„ç­‰å¾…çŠ¶æ€waitStatuså°±å¥½æ¯”ç­‰å€™åŒºå…¶å®ƒé¡¾å®¢(å…¶å®ƒçº¿ç¨‹)çš„ç­‰å¾…çŠ¶æ€ã€‚</p><div class="fj-gallery"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230406141040766.png" alt="image-20230406141040766" style="zoom:50%"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20230406141135307.png" alt="image-20230406141135307" style="zoom:50%"></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="3-3-å®ç°ä¸å¯é‡å…¥é”">3.3 å®ç°ä¸å¯é‡å…¥é”</h3><div class="tabs" id="a97c740e-6af2-4303-9a7c-bbf6a3a48fce"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#a97c740e-6af2-4303-9a7c-bbf6a3a48fce-1"><i class="fas fa-atom"></i>è‡ªå®šä¹‰åŒæ­¥å™¨</button></li><li class="tab"><button type="button" data-href="#a97c740e-6af2-4303-9a7c-bbf6a3a48fce-2"><i class="far fa-sun"></i>å®šä¹‰é”</button></li><li class="tab"><button type="button" data-href="#a97c740e-6af2-4303-9a7c-bbf6a3a48fce-3"><i class="fas fa-wind"></i>æµ‹è¯•</button></li><li class="tab"><button type="button" data-href="#a97c740e-6af2-4303-9a7c-bbf6a3a48fce-4"><i class="fas fa-fire-alt"></i>è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="a97c740e-6af2-4303-9a7c-bbf6a3a48fce-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç‹¬å é”  åŒæ­¥å™¨ç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MySync</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="comment">// åŠ ä¸Šäº†é”ï¼Œå¹¶è®¾ç½® owner ä¸ºå½“å‰çº¿ç¨‹</span></span><br><span class="line">            setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">        setState(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// æ˜¯å¦æŒæœ‰ç‹¬å é”</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isHeldExclusively</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getExclusiveOwnerThread() == Thread.currentThread();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Condition <span class="title function_">newCondition</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConditionObject</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a97c740e-6af2-4303-9a7c-bbf6a3a48fce-2"><p>æœ‰äº†è‡ªå®šä¹‰åŒæ­¥å™¨ï¼Œå¾ˆå®¹æ˜“å¤ç”¨ AQS ï¼Œå®ç°ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„è‡ªå®šä¹‰é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyLock</span> <span class="keyword">implements</span> <span class="title class_">Lock</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">MySync</span> <span class="variable">sync</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MySync</span>();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// å°è¯•ï¼Œä¸æˆåŠŸï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// å°è¯•ï¼Œä¸æˆåŠŸï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œå¯æ‰“æ–­</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        sync.acquireInterruptibly(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// å°è¯•ä¸€æ¬¡ï¼Œä¸æˆåŠŸè¿”å›ï¼Œä¸è¿›å…¥é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.tryAcquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// å°è¯•ï¼Œä¸æˆåŠŸï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œæœ‰æ—¶é™</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.tryAcquireNanos(<span class="number">1</span>, unit.toNanos(time));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.release(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// ç”Ÿæˆæ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="keyword">public</span> Condition <span class="title function_">newCondition</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.newCondition();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a97c740e-6af2-4303-9a7c-bbf6a3a48fce-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MyLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyLock</span>();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;locking...&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;unlocking...&quot;</span>);</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;locking...&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;unlocking...&quot;</span>);</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="a97c740e-6af2-4303-9a7c-bbf6a3a48fce-4"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">22:29:28.727 c.TestAqs [t1] - locking... </span><br><span class="line">22:29:29.732 c.TestAqs [t1] - unlocking... </span><br><span class="line">22:29:29.732 c.TestAqs [t2] - locking... </span><br><span class="line">22:29:29.732 c.TestAqs [t2] - unlocking... </span><br></pre></td></tr></table></figure><p>ä¸å¯é‡å…¥æµ‹è¯•</p><p>å¦‚æœæ”¹ä¸ºä¸‹é¢ä»£ç ï¼Œä¼šå‘ç°è‡ªå·±ä¹Ÿä¼šè¢«æŒ¡ä½ï¼ˆåªä¼šæ‰“å°ä¸€æ¬¡ lockingï¼‰</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lock.lock();</span><br><span class="line">log.debug(<span class="string">&quot;locking...&quot;</span>);</span><br><span class="line">lock.lock();</span><br><span class="line">log.debug(<span class="string">&quot;locking...&quot;</span>);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">09:<span class="number">43</span>:<span class="number">50.394</span> c.TestAqs [t1] - locking...</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="3-4-å¿ƒå¾—">3.4 å¿ƒå¾—</h3><div class="tabs" id="cea555e2-cdb8-4c02-b789-d424b82b74d8"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#cea555e2-cdb8-4c02-b789-d424b82b74d8-1"><i class="fas fa-award"></i>èµ·æº</button></li><li class="tab"><button type="button" data-href="#cea555e2-cdb8-4c02-b789-d424b82b74d8-2"><i class="fas fa-baseball-ball"></i>ç›®æ ‡</button></li><li class="tab"><button type="button" data-href="#cea555e2-cdb8-4c02-b789-d424b82b74d8-3"><i class="fas fa-bone"></i>è®¾è®¡</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="cea555e2-cdb8-4c02-b789-d424b82b74d8-1"><p>æ—©æœŸç¨‹åºå‘˜ä¼šè‡ªå·±é€šè¿‡ä¸€ç§åŒæ­¥å™¨å»å®ç°å¦ä¸€ç§ç›¸è¿‘çš„åŒæ­¥å™¨ï¼Œä¾‹å¦‚ç”¨å¯é‡å…¥é”å»å®ç°ä¿¡å·é‡ï¼Œæˆ–åä¹‹ã€‚è¿™æ˜¾ç„¶ä¸ å¤Ÿä¼˜é›…ï¼Œäºæ˜¯åœ¨ JSR166ï¼ˆjava è§„èŒƒææ¡ˆï¼‰ä¸­åˆ›å»ºäº† AQSï¼Œæä¾›äº†è¿™ç§é€šç”¨çš„åŒæ­¥å™¨æœºåˆ¶ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cea555e2-cdb8-4c02-b789-d424b82b74d8-2"><p>AQS è¦å®ç°çš„åŠŸèƒ½ç›®æ ‡</p><ul><li>é˜»å¡ç‰ˆæœ¬è·å–é” acquire å’Œéé˜»å¡çš„ç‰ˆæœ¬å°è¯•è·å–é” tryAcquire</li><li>è·å–é”è¶…æ—¶æœºåˆ¶</li><li>é€šè¿‡æ‰“æ–­å–æ¶ˆæœºåˆ¶</li><li>ç‹¬å æœºåˆ¶åŠå…±äº«æœºåˆ¶</li><li>æ¡ä»¶ä¸æ»¡è¶³æ—¶çš„ç­‰å¾…æœºåˆ¶</li></ul><p>è¦å®ç°çš„æ€§èƒ½ç›®æ ‡</p><blockquote><p>Instead, the primary performance goal here is scalability: to predictably maintain efficiency even, or especially, when synchronizers are contended.</p></blockquote><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cea555e2-cdb8-4c02-b789-d424b82b74d8-3"><p>AQS çš„åŸºæœ¬æ€æƒ³å…¶å®å¾ˆç®€å•</p><p>è·å–é”çš„é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(state çŠ¶æ€ä¸å…è®¸è·å–) &#123;</span><br><span class="line">    <span class="keyword">if</span>(é˜Ÿåˆ—ä¸­è¿˜æ²¡æœ‰æ­¤çº¿ç¨‹) &#123;</span><br><span class="line">        å…¥é˜Ÿå¹¶é˜»å¡</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">å½“å‰çº¿ç¨‹å‡ºé˜Ÿ</span><br></pre></td></tr></table></figure><p>é‡Šæ”¾é”çš„é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(state çŠ¶æ€å…è®¸äº†) &#123;</span><br><span class="line">    æ¢å¤é˜»å¡çš„çº¿ç¨‹(s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¦ç‚¹</p><ul><li>åŸå­ç»´æŠ¤ state çŠ¶æ€</li><li>é˜»å¡åŠæ¢å¤çº¿ç¨‹</li><li>ç»´æŠ¤é˜Ÿåˆ—</li></ul><ol><li>state è®¾è®¡<ul><li>state ä½¿ç”¨ volatile é…åˆ cas ä¿è¯å…¶ä¿®æ”¹æ—¶çš„åŸå­æ€§</li><li>state ä½¿ç”¨äº† 32bit int æ¥ç»´æŠ¤åŒæ­¥çŠ¶æ€ï¼Œå› ä¸ºå½“æ—¶ä½¿ç”¨ long åœ¨å¾ˆå¤šå¹³å°ä¸‹æµ‹è¯•çš„ç»“æœå¹¶ä¸ç†æƒ³</li></ul></li></ol><ol start="2"><li>é˜»å¡æ¢å¤è®¾è®¡<ul><li>æ—©æœŸçš„æ§åˆ¶çº¿ç¨‹æš‚åœå’Œæ¢å¤çš„ api æœ‰ suspend å’Œ resumeï¼Œä½†å®ƒä»¬æ˜¯ä¸å¯ç”¨çš„ï¼Œå› ä¸ºå¦‚æœå…ˆè°ƒç”¨çš„ resume é‚£ä¹ˆ suspend å°†æ„ŸçŸ¥ä¸åˆ°</li><li>è§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨ park &amp; unpark æ¥å®ç°çº¿ç¨‹çš„æš‚åœå’Œæ¢å¤ï¼Œå…·ä½“åŸç†åœ¨ä¹‹å‰è®²è¿‡äº†ï¼Œå…ˆ unpark å† park ä¹Ÿæ²¡ é—®é¢˜</li><li>park &amp; unpark æ˜¯é’ˆå¯¹çº¿ç¨‹çš„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹åŒæ­¥å™¨çš„ï¼Œå› æ­¤æ§åˆ¶ç²’åº¦æ›´ä¸ºç²¾ç»†</li><li>park çº¿ç¨‹è¿˜å¯ä»¥é€šè¿‡ interrupt æ‰“æ–­</li></ul></li><li>é˜Ÿåˆ—è®¾è®¡<ul><li>ä½¿ç”¨äº† FIFO å…ˆå…¥å…ˆå‡ºé˜Ÿåˆ—ï¼Œå¹¶ä¸æ”¯æŒä¼˜å…ˆçº§é˜Ÿåˆ—</li><li>è®¾è®¡æ—¶å€Ÿé‰´äº† CLH é˜Ÿåˆ—ï¼Œå®ƒæ˜¯ä¸€ç§å•å‘æ— é”é˜Ÿåˆ—</li></ul></li></ol><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220312234238685.png" alt="image-20220312234238685"></p><p>é˜Ÿåˆ—ä¸­æœ‰ head å’Œ tail ä¸¤ä¸ªæŒ‡é’ˆèŠ‚ç‚¹ï¼Œéƒ½ç”¨ volatile ä¿®é¥°é…åˆ cas ä½¿ç”¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹æœ‰ state ç»´æŠ¤èŠ‚ç‚¹çŠ¶æ€ å…¥é˜Ÿä¼ªä»£ç ï¼Œåªéœ€è¦è€ƒè™‘ tail èµ‹å€¼çš„åŸå­æ€§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment">// åŸæ¥çš„ tail</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">prev</span> <span class="operator">=</span> tail;</span><br><span class="line">    <span class="comment">// ç”¨ cas åœ¨åŸæ¥ tail çš„åŸºç¡€ä¸Šæ”¹ä¸º node</span></span><br><span class="line">&#125; <span class="keyword">while</span>(tail.compareAndSet(prev, node))</span><br></pre></td></tr></table></figure><p>å‡ºé˜Ÿä¼ªä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// prev æ˜¯ä¸Šä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">while</span>((Node prev=node.prev).state != å”¤é†’çŠ¶æ€) &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è®¾ç½®å¤´èŠ‚ç‚¹</span></span><br><span class="line">head = node;</span><br></pre></td></tr></table></figure><p>CLH å¥½å¤„ï¼š</p><ul><li>æ— é”ï¼Œä½¿ç”¨è‡ªæ—‹</li><li>å¿«é€Ÿï¼Œæ— é˜»å¡</li></ul><p>AQS åœ¨ä¸€äº›æ–¹é¢æ”¹è¿›äº† CLH</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Node <span class="title function_">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="comment">// é˜Ÿåˆ—ä¸­è¿˜æ²¡æœ‰å…ƒç´  tail ä¸º null</span></span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å°† head ä» null -&gt; dummy</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> <span class="title class_">Node</span>()))</span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å°† node çš„ prev è®¾ç½®ä¸ºåŸæ¥çš„ tail</span></span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="comment">// å°† tail ä»åŸæ¥çš„ tail è®¾ç½®ä¸º node</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                <span class="comment">// åŸæ¥ tail çš„ next è®¾ç½®ä¸º node</span></span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>ä¸»è¦ç”¨åˆ° AQS çš„å¹¶å‘å·¥å…·ç±»</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220312235232687.png" alt="image-20220312235232687"></p><h2 id="4-ReentrantLock-åŸç†">4. ReentrantLock åŸç†</h2><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220312235320716.png" alt="image-20220312235320716" style="zoom:50%"><h3 id="4-1-éå…¬å¹³é”å®ç°åŸç†">4.1 éå…¬å¹³é”å®ç°åŸç†</h3><p><strong>åŠ é”è§£é”æµç¨‹</strong></p><div class="tabs" id="ab54601b-f609-4d3b-9625-e89aec82e01c"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ab54601b-f609-4d3b-9625-e89aec82e01c-1"><i class="fas fa-bug"></i>åŠ é”æˆåŠŸ</button></li><li class="tab"><button type="button" data-href="#ab54601b-f609-4d3b-9625-e89aec82e01c-2"><i class="fas fa-cannabis"></i>åŠ é”å¤±è´¥1</button></li><li class="tab"><button type="button" data-href="#ab54601b-f609-4d3b-9625-e89aec82e01c-3"><i class="fas fa-candy-cane"></i>åŠ é”å¤±è´¥2</button></li><li class="tab"><button type="button" data-href="#ab54601b-f609-4d3b-9625-e89aec82e01c-4"><i class="fas fa-child"></i>è§£é”ç«äº‰æˆåŠŸ</button></li><li class="tab"><button type="button" data-href="#ab54601b-f609-4d3b-9625-e89aec82e01c-5"><i class="fas fa-seedling"></i>è§£é”ç«äº‰å¤±è´¥</button></li><li class="tab"><button type="button" data-href="#ab54601b-f609-4d3b-9625-e89aec82e01c-6"><i class="fas fa-leaf"></i>åŠ é”æºç </button></li><li class="tab"><button type="button" data-href="#ab54601b-f609-4d3b-9625-e89aec82e01c-7"><i class="fab fa-apple"></i>è§£é”æºç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ab54601b-f609-4d3b-9625-e89aec82e01c-1"><p>å…ˆä»æ„é€ å™¨å¼€å§‹çœ‹ï¼Œé»˜è®¤ä¸ºéå…¬å¹³é”å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantLock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync = <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NonfairSync ç»§æ‰¿è‡ª AQS</p><p>æ²¡æœ‰ç«äº‰æ—¶</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314153311208.png" alt="image-20220314153311208" style="zoom:67%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ab54601b-f609-4d3b-9625-e89aec82e01c-2"><p>ç¬¬ä¸€ä¸ªç«äº‰å‡ºç°æ—¶</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314153333551.png" alt="image-20220314153333551" style="zoom:67%"><p>Thread-1 æ‰§è¡Œäº†</p><ol><li>CAS å°è¯•å°† state ç”± 0 æ”¹ä¸º 1ï¼Œç»“æœå¤±è´¥</li><li>è¿›å…¥ tryAcquire é€»è¾‘ï¼Œå†å°è¯•åŠ é”ï¼Œè¿™æ—¶ state å·²ç»æ˜¯1ï¼Œç»“æœä»ç„¶å¤±è´¥</li><li>æ¥ä¸‹æ¥è¿›å…¥ addWaiter é€»è¾‘ï¼Œæ„é€  Node é˜Ÿåˆ—<ul><li>å›¾ä¸­é»„è‰²ä¸‰è§’è¡¨ç¤ºè¯¥ Node çš„ waitStatus çŠ¶æ€ï¼Œå…¶ä¸­ 0 ä¸ºé»˜è®¤æ­£å¸¸çŠ¶æ€</li><li>Node çš„åˆ›å»ºæ˜¯æ‡’æƒ°çš„</li><li>å…¶ä¸­ç¬¬ä¸€ä¸ª Node ç§°ä¸º Dummyï¼ˆå“‘å…ƒï¼‰æˆ–å“¨å…µï¼Œç”¨æ¥å ä½ï¼Œå¹¶ä¸å…³è”çº¿ç¨‹</li></ul></li></ol><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314153434087.png" alt="image-20220314153434087" style="zoom:67%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ab54601b-f609-4d3b-9625-e89aec82e01c-3"><p>å½“å‰çº¿ç¨‹è¿›å…¥ acquireQueued é€»è¾‘</p><ol><li>acquireQueued ä¼šåœ¨ä¸€ä¸ªæ­»å¾ªç¯ä¸­ä¸æ–­å°è¯•è·å¾—é”ï¼Œå¤±è´¥åè¿›å…¥ park é˜»å¡</li><li>å¦‚æœè‡ªå·±æ˜¯ç´§é‚»ç€ headï¼ˆæ’ç¬¬äºŒä½ï¼‰ï¼Œé‚£ä¹ˆå†æ¬¡ tryAcquire å°è¯•è·å–é”ï¼Œå½“ç„¶è¿™æ—¶ state ä»ä¸º 1ï¼Œå¤±è´¥</li><li>è¿›å…¥ shouldParkAfterFailedAcquire é€»è¾‘ï¼Œå°†å‰é©± nodeï¼Œå³ head çš„ waitStatus æ”¹ä¸º -1(-1è¡¨ç¤ºä½ æœ‰è´£ä»»å”¤é†’åç»§èŠ‚ç‚¹)ï¼Œè¿™æ¬¡è¿”å› false<img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314153526384.png" alt="image-20220314153526384" style="zoom:67%"></li><li>shouldParkAfterFailedAcquire æ‰§è¡Œå®Œæ¯•å›åˆ° acquireQueued ï¼Œå†æ¬¡ tryAcquire å°è¯•è·å–é”ï¼Œå½“ç„¶è¿™æ—¶ state ä»ä¸º 1ï¼Œå¤±è´¥</li><li>å½“å†æ¬¡è¿›å…¥ shouldParkAfterFailedAcquire æ—¶ï¼Œè¿™æ—¶å› ä¸ºå…¶å‰é©± node çš„ waitStatus å·²ç»æ˜¯ -1ï¼Œè¿™æ¬¡è¿”å› true</li><li>è¿›å…¥ parkAndCheckInterruptï¼Œ Thread-1 parkï¼ˆç°è‰²è¡¨ç¤ºï¼‰</li></ol><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314153708216.png" alt="image-20220314153708216" style="zoom:67%"><p>å†æ¬¡æœ‰å¤šä¸ªçº¿ç¨‹ç»å†ä¸Šè¿°è¿‡ç¨‹ç«äº‰å¤±è´¥ï¼Œå˜æˆè¿™ä¸ªæ ·å­</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314154029099.png" alt="image-20220314154029099" style="zoom:67%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ab54601b-f609-4d3b-9625-e89aec82e01c-4"><p>Thread-0 é‡Šæ”¾é”ï¼Œè¿›å…¥ tryRelease æµç¨‹ï¼Œå¦‚æœæˆåŠŸ</p><ul><li>è®¾ç½® exclusiveOwnerThread ä¸º null</li><li>state = 0</li></ul><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314153831407.png" alt="image-20220314153831407" style="zoom:67%"><p>å½“å‰é˜Ÿåˆ—ä¸ä¸º nullï¼Œå¹¶ä¸” head çš„ waitStatus = -1ï¼Œè¿›å…¥ unparkSuccessor æµç¨‹</p><p>æ‰¾åˆ°é˜Ÿåˆ—ä¸­ç¦» head æœ€è¿‘çš„ä¸€ä¸ª Nodeï¼ˆæ²¡å–æ¶ˆçš„ï¼‰ï¼Œunpark æ¢å¤å…¶è¿è¡Œï¼Œæœ¬ä¾‹ä¸­å³ä¸º Thread-1</p><p>å›åˆ° Thread-1 çš„ acquireQueued æµç¨‹</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314153919958.png" alt="image-20220314153919958" style="zoom:67%"><p>å¦‚æœåŠ é”æˆåŠŸï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œä¼šè®¾ç½®</p><ul><li>exclusiveOwnerThread ä¸º Thread-1ï¼Œstate = 1</li><li>head æŒ‡å‘åˆšåˆš Thread-1 æ‰€åœ¨çš„ Nodeï¼Œè¯¥ Node æ¸…ç©º Thread</li><li>åŸæœ¬çš„ head å› ä¸ºä»é“¾è¡¨æ–­å¼€ï¼Œè€Œå¯è¢«åƒåœ¾å›æ”¶</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ab54601b-f609-4d3b-9625-e89aec82e01c-5"><p>å¦‚æœè¿™æ—¶å€™æœ‰å…¶å®ƒçº¿ç¨‹æ¥ç«äº‰ï¼ˆéå…¬å¹³çš„ä½“ç°ï¼‰ï¼Œä¾‹å¦‚è¿™æ—¶æœ‰ Thread-4 æ¥äº†</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314154048958.png" alt="image-20220314154048958" style="zoom:67%"><p>å¦‚æœä¸å·§åˆè¢« Thread-4 å äº†å…ˆ</p><ul><li>Thread-4 è¢«è®¾ç½®ä¸º exclusiveOwnerThreadï¼Œstate = 1</li><li>Thread-1 å†æ¬¡è¿›å…¥ acquireQueued æµç¨‹ï¼Œè·å–é”å¤±è´¥ï¼Œé‡æ–°è¿›å…¥ park é˜»å¡</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ab54601b-f609-4d3b-9625-e89aec82e01c-6"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sync ç»§æ‰¿è‡ª AQS</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">7316153563782823691L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ é”å®ç°</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// é¦–å…ˆç”¨ cas å°è¯•ï¼ˆä»…å°è¯•ä¸€æ¬¡ï¼‰å°† state ä» 0 æ”¹ä¸º 1, å¦‚æœæˆåŠŸè¡¨ç¤ºè·å¾—äº†ç‹¬å é”</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">            setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// å¦‚æœå°è¯•å¤±è´¥ï¼Œè¿›å…¥ ãˆ </span></span><br><span class="line">            acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ  AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="comment">// ãˆ¡ tryAcquire </span></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            !tryAcquire(arg) &amp;&amp;</span><br><span class="line">            <span class="comment">// å½“ tryAcquire è¿”å›ä¸º false æ—¶, å…ˆè°ƒç”¨ addWaiter ãˆ£, æ¥ç€ acquireQueued ãˆ¤</span></span><br><span class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</span><br><span class="line">        ) &#123;</span><br><span class="line">            selfInterrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¡ è¿›å…¥ ãˆ¢</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nonfairTryAcquire(acquires);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¢ Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">nonfairTryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="comment">// å¦‚æœè¿˜æ²¡æœ‰è·å¾—é”</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å°è¯•ç”¨ cas è·å¾—, è¿™é‡Œä½“ç°äº†éå…¬å¹³æ€§: ä¸å»æ£€æŸ¥ AQS é˜Ÿåˆ—</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœå·²ç»è·å¾—äº†é”, çº¿ç¨‹è¿˜æ˜¯å½“å‰çº¿ç¨‹, è¡¨ç¤ºå‘ç”Ÿäº†é”é‡å…¥</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="comment">// state++</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è·å–å¤±è´¥, å›åˆ°è°ƒç”¨å¤„</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ£ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">//å°†å½“å‰nodeåŠ å…¥ç­‰å¾…é˜Ÿåˆ—æœ«å°¾ç­‰å¾…ï¼Œå¹¶è¿”å›å½“å‰node</span></span><br><span class="line">    <span class="keyword">private</span> Node <span class="title function_">addWaiter</span><span class="params">(Node mode)</span> &#123;</span><br><span class="line">        <span class="comment">// å°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºç‹¬å æ¨¡å¼</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), mode);</span><br><span class="line">        <span class="comment">//éå…¬å¹³åŒæ­¥å™¨ä¸­æœ‰headå’Œtailä¸¤ä¸ªå¼•ç”¨åˆ†åˆ«æŒ‡å‘äº†ç­‰å¾…é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">//predæŒ‡çš„æ˜¯nodeçš„å‰é©±ï¼Œä»é˜Ÿå°¾æ’å…¥ï¼Œæ‰€ä»¥predä¸ºtail</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">pred</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="comment">// å¦‚æœ tail ä¸ä¸º null, è¯´æ˜å·²ç»æœ‰äº†ç­‰å¾…é˜Ÿåˆ—äº†ï¼Œcas å°è¯•å°† Node å¯¹è±¡åŠ å…¥ AQS é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">        <span class="keyword">if</span> (pred != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//å°†nodeçš„å‰é©±èŠ‚ç‚¹è®¾ç½®ä¸ºpred</span></span><br><span class="line">            node.prev = pred;</span><br><span class="line">            <span class="comment">//å°è¯•å°†é˜Ÿåˆ—çš„tialä»å½“å‰çš„predä¿®æ”¹ä¸ºnode</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">                <span class="comment">// åŒå‘é“¾è¡¨</span></span><br><span class="line">                pred.next = node;</span><br><span class="line">                <span class="keyword">return</span> node;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœpredä¸ºnullï¼Œè¯´æ˜ç­‰å¾…é˜Ÿåˆ—è¿˜æœªåˆ›å»ºï¼Œè°ƒç”¨enqæ–¹æ³•åˆ›å»ºé˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">// å°è¯•å°† Node åŠ å…¥ AQS, è¿›å…¥ ãˆ¥</span></span><br><span class="line">        enq(node);</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¥ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">//è¯¥æ–¹æ³•å°±æ˜¯åˆ›å»ºç­‰å¾…é˜Ÿåˆ—ï¼Œå¹¶å°†nodeæ’å…¥é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚</span></span><br><span class="line">    <span class="keyword">private</span> Node <span class="title function_">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">            <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// è¿˜æ²¡æœ‰, è®¾ç½® head ä¸ºå“¨å…µèŠ‚ç‚¹ï¼ˆä¸å¯¹åº”çº¿ç¨‹ï¼ŒçŠ¶æ€ä¸º 0ï¼‰</span></span><br><span class="line">                <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> <span class="title class_">Node</span>())) &#123;</span><br><span class="line">                    <span class="comment">//å°†headèµ‹å€¼ç»™tailï¼Œheadå’ŒtailåŒæ—¶æŒ‡å‘å“¨å…µèŠ‚ç‚¹</span></span><br><span class="line">                    tail = head;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// cas å°è¯•å°† Node å¯¹è±¡åŠ å…¥ AQS é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">                <span class="comment">//è®¾ç½®nodeçš„å‰é©±èŠ‚ç‚¹ä¸ºé˜Ÿåˆ—çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                node.prev = t;</span><br><span class="line">                <span class="comment">//å°è¯•å°†é˜Ÿåˆ—çš„å°¾éƒ¨ä»å½“å‰çš„tailè®¾ç½®ä¸ºnode</span></span><br><span class="line">                <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                    <span class="comment">//å°†nodeè®¾ä¸ºä¸Šä¸€ä¸ªtailçš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">                    t.next = node;</span><br><span class="line">                    <span class="keyword">return</span> t;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¤ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">//åœ¨é˜Ÿåˆ—ä¸­å¾ªç¯ç­‰å¾…ï¼Œåªæœ‰å½“æ’é˜Ÿæ’åˆ°ç¬¬ä¸€åå¹¶ä¸”è·å¾—äº†é”æ‰èƒ½å‡ºé˜Ÿå¹¶ä»æ–¹æ³•ä¸­é€€å‡ºã€‚</span></span><br><span class="line">    <span class="comment">//è¿”å›æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="comment">//æ‰¾åˆ°å½“å‰nodeçš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">                <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯ head, è¡¨ç¤ºè½®åˆ°è‡ªå·±ï¼ˆå½“å‰çº¿ç¨‹å¯¹åº”çš„ nodeï¼‰äº†, å°è¯•è·å–</span></span><br><span class="line">                <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                    <span class="comment">// è·å–æˆåŠŸ, è®¾ç½®è‡ªå·±ï¼ˆå½“å‰çº¿ç¨‹å¯¹åº”çš„ nodeï¼‰ä¸º head</span></span><br><span class="line">                    setHead(node);</span><br><span class="line">                    <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹ help GC</span></span><br><span class="line">                    p.next = <span class="literal">null</span>;</span><br><span class="line">                    failed = <span class="literal">false</span>;</span><br><span class="line">                    <span class="comment">// è¿”å›ä¸­æ–­æ ‡è®° false</span></span><br><span class="line">                    <span class="keyword">return</span> interrupted;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                    <span class="comment">// åˆ¤æ–­æ˜¯å¦åº”å½“ park, è¿›å…¥ ãˆ¦</span></span><br><span class="line">                    shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    <span class="comment">// park ç­‰å¾…, æ­¤æ—¶ Node çš„çŠ¶æ€è¢«ç½®ä¸º Node.SIGNAL ãˆ§</span></span><br><span class="line">                    parkAndCheckInterrupt()</span><br><span class="line">                ) &#123;</span><br><span class="line">                    interrupted = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                cancelAcquire(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¦ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">//åˆ¤æ–­acquireå¤±è´¥ä»¥åæ˜¯å¦åº”è¯¥é˜»å¡ç­‰å¾…ã€‚ä»è§„åˆ™ä¸Šæ¥è®²ï¼š</span></span><br><span class="line">    <span class="comment">//1.å¦‚æœå‰é©±èŠ‚ç‚¹éƒ½é˜»å¡äº†ï¼Œé‚£ä¹ˆå½“å‰èŠ‚ç‚¹ä¹Ÿåº”è¯¥é˜»å¡</span></span><br><span class="line">    <span class="comment">//2.å¦‚æœå‰é©±èŠ‚ç‚¹å–æ¶ˆï¼Œé‚£ä¹ˆåº”è¯¥å°†å‰é©±èŠ‚ç‚¹å‰ç§»ï¼Œç›´åˆ°å…¶çŠ¶æ€ä¸ä¸ºå–æ¶ˆä¸ºæ­¢ã€‚</span></span><br><span class="line">    <span class="comment">//3.å¦‚æœå‰ä¸¤ç§æƒ…å†µéƒ½ä¸æ˜¯ï¼Œå°è¯•å°†å‰é©±èŠ‚ç‚¹çŠ¶æ€è®¾ä¸ºSIGNALï¼Œè¿”å›falseï¼ˆä¸ç”¨é˜»å¡ï¼Œç­‰åˆ°ä¸‹æ¬¡åœ¨é˜»å¡ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> pred.waitStatus;</span><br><span class="line">        <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">            <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹éƒ½åœ¨é˜»å¡, é‚£ä¹ˆè‡ªå·±ä¹Ÿé˜»å¡å¥½äº†</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// &gt; 0 è¡¨ç¤ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹å–æ¶ˆ, é‚£ä¹ˆé‡æ„åˆ é™¤å‰é¢æ‰€æœ‰å–æ¶ˆçš„èŠ‚ç‚¹, è¿”å›åˆ°å¤–å±‚å¾ªç¯é‡è¯•</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                node.prev = pred = pred.prev;</span><br><span class="line">            &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">            pred.next = node;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è¿™æ¬¡è¿˜æ²¡æœ‰é˜»å¡</span></span><br><span class="line">            <span class="comment">// ä½†ä¸‹æ¬¡å¦‚æœé‡è¯•ä¸æˆåŠŸ, åˆ™éœ€è¦é˜»å¡ï¼Œè¿™æ—¶éœ€è¦è®¾ç½®ä¸Šä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€ä¸º Node.SIGNAL</span></span><br><span class="line">            compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ§ é˜»å¡å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">parkAndCheckInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">        LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>æ³¨æ„</strong></p><p>æ˜¯å¦éœ€è¦ unpark æ˜¯ç”±å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„ waitStatus == Node.SIGNAL æ¥å†³å®šï¼Œè€Œä¸æ˜¯æœ¬èŠ‚ç‚¹çš„ waitStatus å†³å®š</p></blockquote><p>æ€»ç»“ï¼š</p><ul><li>è°ƒç”¨<code>lock</code>ï¼Œå°è¯•å°†stateä»0ä¿®æ”¹ä¸º1<ul><li>æˆåŠŸï¼šå°†ownerè®¾ä¸ºå½“å‰çº¿ç¨‹</li><li>å¤±è´¥ï¼šè°ƒç”¨<code>acquire</code>-&gt;<code>tryAcquire</code>-&gt;<code>nonfairTryAcquire</code>ï¼Œåˆ¤æ–­state=0åˆ™è·å¾—é”ï¼Œæˆ–è€…stateä¸ä¸º0ä½†å½“å‰çº¿ç¨‹æŒæœ‰é”åˆ™é‡å…¥é”ï¼Œä»¥ä¸Šä¸¤ç§æƒ…å†µ<code>tryAcquire</code>è¿”å›trueï¼Œå‰©ä½™æƒ…å†µè¿”å›falseã€‚<ul><li>trueï¼šè·å¾—é”</li><li>falseï¼šè°ƒç”¨<code>acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</code>,å…¶ä¸­<code>addwiter</code>å°†å…³è”çº¿ç¨‹çš„èŠ‚ç‚¹æ’å…¥AQSé˜Ÿåˆ—å°¾éƒ¨ï¼Œè¿›å…¥<code>acquireQueued</code>ä¸­çš„forå¾ªç¯:<ul><li>å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œå¹¶å°è¯•è·å¾—é”æˆåŠŸï¼Œå°†å½“å‰èŠ‚ç‚¹è®¾ä¸ºå¤´èŠ‚ç‚¹ï¼Œæ¸…é™¤æ­¤èŠ‚ç‚¹ä¿¡æ¯ï¼Œè¿”å›æ‰“æ–­æ ‡è®°ã€‚</li><li>è°ƒç”¨<code>shoudParkAfterFailure</code>,ç¬¬ä¸€æ¬¡è°ƒç”¨è¿”å›falseï¼Œå¹¶å°†å‰é©±èŠ‚ç‚¹æ”¹ä¸º-1ï¼Œç¬¬äºŒæ¬¡å¾ªç¯å¦‚æœå†è¿›å…¥æ­¤æ–¹æ³•ï¼Œä¼šè¿›å…¥é˜»å¡å¹¶æ£€æŸ¥æ‰“æ–­çš„æ–¹æ³•ã€‚</li></ul></li></ul></li></ul></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ab54601b-f609-4d3b-9625-e89aec82e01c-7"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sync ç»§æ‰¿è‡ª AQS</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="comment">// è§£é”å®ç°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.release(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="comment">// å°è¯•é‡Šæ”¾é”, è¿›å…¥ ãˆ </span></span><br><span class="line">        <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">            <span class="comment">// é˜Ÿåˆ—å¤´èŠ‚ç‚¹ unpark</span></span><br><span class="line">            <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head; </span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">                <span class="comment">// é˜Ÿåˆ—ä¸ä¸º null</span></span><br><span class="line">                h != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                <span class="comment">// waitStatus == Node.SIGNAL æ‰éœ€è¦ unpark</span></span><br><span class="line">                h.waitStatus != <span class="number">0</span></span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="comment">// unpark AQS ä¸­ç­‰å¾…çš„çº¿ç¨‹, è¿›å…¥ ãˆ¡</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ  Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">        <span class="comment">// state--</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">        <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// æ”¯æŒé”é‡å…¥, åªæœ‰ state å‡ä¸º 0, æ‰é‡Šæ”¾æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            free = <span class="literal">true</span>;</span><br><span class="line">            setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        setState(c);</span><br><span class="line">        <span class="keyword">return</span> free;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¡ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unparkSuccessor</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœçŠ¶æ€ä¸º Node.SIGNAL å°è¯•é‡ç½®çŠ¶æ€ä¸º 0</span></span><br><span class="line">        <span class="comment">// ä¸æˆåŠŸä¹Ÿå¯ä»¥</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> node.waitStatus;</span><br><span class="line">        <span class="keyword">if</span> (ws &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ‰¾åˆ°éœ€è¦ unpark çš„èŠ‚ç‚¹, ä½†æœ¬èŠ‚ç‚¹ä» AQS é˜Ÿåˆ—ä¸­è„±ç¦», æ˜¯ç”±å”¤é†’èŠ‚ç‚¹å®Œæˆçš„</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">        <span class="comment">// ä¸è€ƒè™‘å·²å–æ¶ˆçš„èŠ‚ç‚¹, ä» AQS é˜Ÿåˆ—ä»åè‡³å‰æ‰¾åˆ°é˜Ÿåˆ—æœ€å‰é¢éœ€è¦ unpark çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            s = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail; t != <span class="literal">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">                <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                    s = t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (s != <span class="literal">null</span>)</span><br><span class="line">            LockSupport.unpark(s.thread);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ï¼š</p><ul><li><code>unlock</code>-&gt;<code>syn.release</code>(1)-&gt;<code>tryRelease</code>(1),å¦‚æœå½“å‰çº¿ç¨‹å¹¶ä¸æŒæœ‰é”ï¼ŒæŠ›å¼‚å¸¸ã€‚stateå‡å»1,å¦‚æœä¹‹åstateä¸º0ï¼Œè§£é”æˆåŠŸï¼Œè¿”å›trueï¼›å¦‚æœä»å¤§äº0ï¼Œè¡¨ç¤ºè§£é”ä¸å®Œå…¨ï¼Œå½“å‰çº¿ç¨‹ä¾æ—§æŒæœ‰é”ï¼Œè¿”å›falseã€‚</li><li>è¿”å›trueï¼šæ£€æŸ¥AQSé˜Ÿåˆ—ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€å›¾æ˜¯å¦ä¸º<code>SIGNAL</code>(æ„å‘³ç€æœ‰è´£ä»»å”¤é†’å…¶åè®°èŠ‚ç‚¹)ï¼Œå¦‚æœæœ‰ï¼Œè°ƒç”¨<code>unparkSuccessor</code>ã€‚<ul><li>å†<code>unparkSuccessor</code>ä¸­ï¼Œä¸è€ƒè™‘å·²å–æ¶ˆçš„èŠ‚ç‚¹, ä» AQS é˜Ÿåˆ—ä»åè‡³å‰æ‰¾åˆ°é˜Ÿåˆ—æœ€å‰é¢éœ€è¦ unpark çš„èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰ï¼Œå°†å…¶å”¤é†’ã€‚</li></ul></li><li>è¿”å›falseï¼š</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="4-2-å¯é‡å…¥åŸç†">4.2 å¯é‡å…¥åŸç†</h3><p>å½“æŒæœ‰é”çš„çº¿ç¨‹å†æ¬¡å°è¯•è·å–é”æ—¶ï¼Œä¼šå°†stateçš„å€¼åŠ 1ï¼Œstateè¡¨ç¤ºé”çš„é‡å…¥é‡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">nonfairTryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœå·²ç»è·å¾—äº†é”, çº¿ç¨‹è¿˜æ˜¯å½“å‰çº¿ç¨‹, è¡¨ç¤ºå‘ç”Ÿäº†é”é‡å…¥</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="comment">// state++</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">        <span class="comment">// state-- </span></span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">        <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// æ”¯æŒé”é‡å…¥, åªæœ‰ state å‡ä¸º 0, æ‰é‡Šæ”¾æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            free = <span class="literal">true</span>;</span><br><span class="line">            setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        setState(c);</span><br><span class="line">        <span class="keyword">return</span> free;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-3-å¯æ‰“æ–­åŸç†">4.3 å¯æ‰“æ–­åŸç†</h3><div class="tabs" id="ae13c790-a91c-4377-b4a7-12544253fdda"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ae13c790-a91c-4377-b4a7-12544253fdda-1"><i class="fas fa-cat"></i>ä¸å¯æ‰“æ–­æ¨¡å¼</button></li><li class="tab"><button type="button" data-href="#ae13c790-a91c-4377-b4a7-12544253fdda-2"><i class="fas fa-horse"></i>å¯æ‰“æ–­æ¨¡å¼</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ae13c790-a91c-4377-b4a7-12544253fdda-1"><p>åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œå³ä½¿å®ƒè¢«æ‰“æ–­ï¼Œä»ä¼šé©»ç•™åœ¨ AQS é˜Ÿåˆ—ä¸­ï¼Œå¹¶å°†æ‰“æ–­ä¿¡å·å­˜å‚¨åœ¨ä¸€ä¸ªinterruptå˜é‡ä¸­ã€‚ä¸€ç›´è¦ç­‰åˆ°è·å¾—é”åæ–¹èƒ½å¾—çŸ¥è‡ªå·±è¢«æ‰“æ–­äº†,å¹¶ä¸”è°ƒç”¨<code>selfInterrupt</code>æ–¹æ³•æ‰“æ–­è‡ªå·±ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sync ç»§æ‰¿è‡ª AQS</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">parkAndCheckInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯ true, åˆ™ park ä¼šå¤±æ•ˆ</span></span><br><span class="line">        LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">// interrupted ä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°</span></span><br><span class="line">        <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">                <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                    setHead(node);</span><br><span class="line">                    p.next = <span class="literal">null</span>;</span><br><span class="line">                    failed = <span class="literal">false</span>;</span><br><span class="line">                    <span class="comment">// è¿˜æ˜¯éœ€è¦è·å¾—é”å, æ‰èƒ½è¿”å›æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">                    <span class="keyword">return</span> interrupted;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                    shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    parkAndCheckInterrupt()</span><br><span class="line">                ) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœæ˜¯å› ä¸º interrupt è¢«å”¤é†’, è¿”å›æ‰“æ–­çŠ¶æ€ä¸º true</span></span><br><span class="line">                    interrupted = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                cancelAcquire(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            !tryAcquire(arg) &amp;&amp;</span><br><span class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ‰“æ–­çŠ¶æ€ä¸º true</span></span><br><span class="line">            selfInterrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//å“åº”æ‰“æ–­æ ‡è®°ï¼Œæ‰“æ–­è‡ªå·±</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">selfInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// é‡æ–°äº§ç”Ÿä¸€æ¬¡ä¸­æ–­</span></span><br><span class="line">        Thread.currentThread().interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ae13c790-a91c-4377-b4a7-12544253fdda-2"><p>æ­¤æ¨¡å¼ä¸‹å³ä½¿çº¿ç¨‹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œä¸€æ—¦è¢«æ‰“æ–­ï¼Œå°±ä¼šç«‹åˆ»æŠ›å‡ºæ‰“æ–­å¼‚å¸¸ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰è·å¾—åˆ°é”, è¿›å…¥ ãˆ </span></span><br><span class="line">        <span class="keyword">if</span> (!tryAcquire(arg))</span><br><span class="line">            doAcquireInterruptibly(arg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ  å¯æ‰“æ–­çš„è·å–é”æµç¨‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.EXCLUSIVE);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">                <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                    setHead(node);</span><br><span class="line">                    p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    failed = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    parkAndCheckInterrupt()) &#123;</span><br><span class="line">                    <span class="comment">// åœ¨ park è¿‡ç¨‹ä¸­å¦‚æœè¢« interrupt ä¼šè¿›å…¥æ­¤</span></span><br><span class="line">                    <span class="comment">// è¿™æ—¶å€™æŠ›å‡ºå¼‚å¸¸, è€Œä¸ä¼šå†æ¬¡è¿›å…¥ for (;;)</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                cancelAcquire(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="4-4-å…¬å¹³é”å®ç°åŸç†">4.4 å…¬å¹³é”å®ç°åŸç†</h3><p>ç®€è€Œè¨€ä¹‹ï¼Œå…¬å¹³ä¸éå…¬å¹³çš„åŒºåˆ«åœ¨äºï¼Œå…¬å¹³é”ä¸­çš„tryAcquireæ–¹æ³•è¢«é‡å†™äº†ï¼Œæ–°æ¥çš„çº¿ç¨‹å³ä¾¿å¾—çŸ¥äº†é”çš„stateä¸º0ï¼Œä¹Ÿè¦å…ˆåˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—ä¸­æ˜¯å¦è¿˜æœ‰çº¿ç¨‹ç­‰å¾…ï¼Œåªæœ‰å½“é˜Ÿåˆ—æ²¡æœ‰çº¿ç¨‹ç­‰å¾…å¼ï¼Œæ‰è·å¾—é”ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">3000897897090466540L</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            !tryAcquire(arg) &amp;&amp;</span><br><span class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</span><br><span class="line">        ) &#123;</span><br><span class="line">            selfInterrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸éå…¬å¹³é”ä¸»è¦åŒºåˆ«åœ¨äº tryAcquire æ–¹æ³•çš„å®ç°</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å…ˆæ£€æŸ¥ AQS é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹, æ²¡æœ‰æ‰å»ç«äº‰</span></span><br><span class="line">            <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">                compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ  AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">//å­˜ç–‘</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">hasQueuedPredecessors</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        Node s;</span><br><span class="line">        <span class="comment">// h != t æ—¶è¡¨ç¤ºé˜Ÿåˆ—ä¸­æœ‰ Node</span></span><br><span class="line">        <span class="keyword">return</span> h != t &amp;&amp;</span><br><span class="line">            (</span><br><span class="line">            <span class="comment">// (s = h.next) == null è¡¨ç¤ºé˜Ÿåˆ—ä¸­è¿˜æœ‰æ²¡æœ‰è€äºŒ</span></span><br><span class="line">            (s = h.next) == <span class="literal">null</span> ||</span><br><span class="line">            <span class="comment">// æˆ–è€…é˜Ÿåˆ—ä¸­è€äºŒçº¿ç¨‹ä¸æ˜¯æ­¤çº¿ç¨‹</span></span><br><span class="line">            s.thread != Thread.currentThread()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-5-æ¡ä»¶å˜é‡å®ç°åŸç†">4.5 æ¡ä»¶å˜é‡å®ç°åŸç†</h3><p>æ¯ä¸ªæ¡ä»¶å˜é‡å…¶å®å°±å¯¹åº”ç€ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œå…¶å®ç°ç±»æ˜¯ ConditionObject</p><p><strong>awaitæµç¨‹</strong></p><div class="tabs" id="4b85b845-bd90-4107-aac7-bcd4f7b1d25a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#4b85b845-bd90-4107-aac7-bcd4f7b1d25a-1"><i class="fas fa-atom"></i>1</button></li><li class="tab"><button type="button" data-href="#4b85b845-bd90-4107-aac7-bcd4f7b1d25a-2"><i class="far fa-sun"></i>2</button></li><li class="tab"><button type="button" data-href="#4b85b845-bd90-4107-aac7-bcd4f7b1d25a-3"><i class="fas fa-wind"></i>3</button></li><li class="tab"><button type="button" data-href="#4b85b845-bd90-4107-aac7-bcd4f7b1d25a-4"><i class="fas fa-fire-alt"></i>4</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="4b85b845-bd90-4107-aac7-bcd4f7b1d25a-1"><p>å¼€å§‹ Thread-0 æŒæœ‰é”ï¼Œè°ƒç”¨ awaitï¼Œè¿›å…¥ ConditionObject çš„ addConditionWaiter æµç¨‹</p><p>åˆ›å»ºæ–°çš„ Node çŠ¶æ€ä¸º -2ï¼ˆNode.CONDITIONï¼‰ï¼Œå…³è” Thread-0ï¼ŒåŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314171543622.png" alt="image-20220314171543622" style="zoom:67%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4b85b845-bd90-4107-aac7-bcd4f7b1d25a-2"><p>æ¥ä¸‹æ¥è¿›å…¥ AQS çš„ fullyRelease æµç¨‹ï¼Œé‡Šæ”¾åŒæ­¥å™¨ä¸Šçš„é”</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314171600661.png" alt="image-20220314171600661" style="zoom:67%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4b85b845-bd90-4107-aac7-bcd4f7b1d25a-3"><p>unpark AQS é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç«äº‰é”ï¼Œå‡è®¾æ²¡æœ‰å…¶ä»–ç«äº‰çº¿ç¨‹ï¼Œé‚£ä¹ˆ Thread-1 ç«äº‰æˆåŠŸ</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314171619415.png" alt="image-20220314171619415" style="zoom:67%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="4b85b845-bd90-4107-aac7-bcd4f7b1d25a-4"><p>park é˜»å¡ Thread-0</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314171637949.png" alt="image-20220314171637949" style="zoom:67%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>æ€»ç»“ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œå…³è”å½“å‰çº¿ç¨‹ï¼Œå¹¶æ’å…¥åˆ°å½“å‰Conditioné˜Ÿåˆ—çš„å°¾éƒ¨</li><li>è°ƒç”¨<code>fullRelease</code>ï¼Œå®Œå…¨é‡Šæ”¾åŒæ­¥å™¨ä¸­çš„é”ï¼Œå¹¶è®°å½•å½“å‰çº¿ç¨‹çš„é”é‡å…¥æ•°</li><li>å”¤é†’(park)AQSé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹</li><li>è°ƒç”¨parkæ–¹æ³•ï¼Œé˜»å¡å½“å‰çº¿ç¨‹ã€‚</li></ul><p><strong>signal æµç¨‹</strong></p><div class="tabs" id="32f53e83-10f0-4e18-bb38-c3ee28eb6cb2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#32f53e83-10f0-4e18-bb38-c3ee28eb6cb2-1"><i class="fas fa-award"></i>1</button></li><li class="tab"><button type="button" data-href="#32f53e83-10f0-4e18-bb38-c3ee28eb6cb2-2"><i class="fas fa-baseball-ball"></i>2</button></li><li class="tab"><button type="button" data-href="#32f53e83-10f0-4e18-bb38-c3ee28eb6cb2-3"><i class="fas fa-bone"></i>3</button></li><li class="tab"><button type="button" data-href="#32f53e83-10f0-4e18-bb38-c3ee28eb6cb2-4"><i class="fas fa-anchor"></i>æºç </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="32f53e83-10f0-4e18-bb38-c3ee28eb6cb2-1"><p>å‡è®¾ Thread-1 è¦æ¥å”¤é†’ Thread-0</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314171703144.png" alt="image-20220314171703144" style="zoom:67%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="32f53e83-10f0-4e18-bb38-c3ee28eb6cb2-2"><p>è¿›å…¥ ConditionObject çš„ doSignal æµç¨‹ï¼Œå–å¾—ç­‰å¾…é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ª Nodeï¼Œå³ Thread-0 æ‰€åœ¨ Node</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314171727397.png" alt="image-20220314171727397" style="zoom:67%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="32f53e83-10f0-4e18-bb38-c3ee28eb6cb2-3"><p>æ‰§è¡Œ transferForSignal æµç¨‹ï¼Œå°†è¯¥ Node åŠ å…¥ AQS é˜Ÿåˆ—å°¾éƒ¨ï¼Œå°† Thread-0 çš„ waitStatus æ”¹ä¸º 0ï¼ŒThread-3 çš„ waitStatus æ”¹ä¸º -1</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314171749467.png" alt="image-20220314171749467" style="zoom:67%"><p>Thread-1 é‡Šæ”¾é”ï¼Œè¿›å…¥ unlock æµç¨‹ï¼Œç•¥</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="32f53e83-10f0-4e18-bb38-c3ee28eb6cb2-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConditionObject</span> <span class="keyword">implements</span> <span class="title class_">Condition</span>, java.io.Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1173984872572414699L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¬¬ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node firstWaiter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€åä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node lastWaiter;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConditionObject</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="comment">// ãˆ  æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> Node <span class="title function_">addConditionWaiter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> lastWaiter;</span><br><span class="line">        <span class="comment">// æ‰€æœ‰å·²å–æ¶ˆçš„ Node ä»é˜Ÿåˆ—é“¾è¡¨åˆ é™¤, è§ ãˆ¡</span></span><br><span class="line">        <span class="keyword">if</span> (t != <span class="literal">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">            unlinkCancelledWaiters();</span><br><span class="line">            t = lastWaiter;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªå…³è”å½“å‰çº¿ç¨‹çš„æ–° Node, æ·»åŠ è‡³é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), Node.CONDITION);</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>)</span><br><span class="line">            firstWaiter = node;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            t.nextWaiter = node;</span><br><span class="line">        lastWaiter = node;</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å”¤é†’ - å°†æ²¡å–æ¶ˆçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è½¬ç§»è‡³ AQS é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doSignal</span><span class="params">(Node first)</span> &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// å·²ç»æ˜¯å°¾èŠ‚ç‚¹äº†</span></span><br><span class="line">            <span class="keyword">if</span> ( (firstWaiter = first.nextWaiter) == <span class="literal">null</span>) &#123;</span><br><span class="line">                lastWaiter = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            first.nextWaiter = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span> (</span><br><span class="line">            <span class="comment">// å°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ Node è½¬ç§»è‡³ AQS é˜Ÿåˆ—, ä¸æˆåŠŸä¸”è¿˜æœ‰èŠ‚ç‚¹åˆ™ç»§ç»­å¾ªç¯ ãˆ¢</span></span><br><span class="line">            !transferForSignal(first) &amp;&amp;</span><br><span class="line">            <span class="comment">// é˜Ÿåˆ—è¿˜æœ‰èŠ‚ç‚¹</span></span><br><span class="line">            (first = firstWaiter) != <span class="literal">null</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤–éƒ¨ç±»æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">// ãˆ¢ å¦‚æœèŠ‚ç‚¹çŠ¶æ€æ˜¯å–æ¶ˆ, è¿”å› false è¡¨ç¤ºè½¬ç§»å¤±è´¥, å¦åˆ™è½¬ç§»æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">transferForSignal</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœçŠ¶æ€å·²ç»ä¸æ˜¯ Node.CONDITION, è¯´æ˜è¢«å–æ¶ˆäº†</span></span><br><span class="line">        <span class="keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// åŠ å…¥ AQS é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> enq(node);</span><br><span class="line">        <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> p.waitStatus;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹è¢«å–æ¶ˆ</span></span><br><span class="line">            ws &gt; <span class="number">0</span> ||</span><br><span class="line">            <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹ä¸èƒ½è®¾ç½®çŠ¶æ€ä¸º Node.SIGNAL</span></span><br><span class="line">            !compareAndSetWaitStatus(p, ws, Node.SIGNAL) </span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// unpark å–æ¶ˆé˜»å¡, è®©çº¿ç¨‹é‡æ–°åŒæ­¥çŠ¶æ€</span></span><br><span class="line">            LockSupport.unpark(node.thread);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…¨éƒ¨å”¤é†’ - ç­‰å¾…é˜Ÿåˆ—çš„æ‰€æœ‰èŠ‚ç‚¹è½¬ç§»è‡³ AQS é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doSignalAll</span><span class="params">(Node first)</span> &#123;</span><br><span class="line">        lastWaiter = firstWaiter = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">next</span> <span class="operator">=</span> first.nextWaiter;</span><br><span class="line">            first.nextWaiter = <span class="literal">null</span>;</span><br><span class="line">            transferForSignal(first);</span><br><span class="line">            first = next;</span><br><span class="line">        &#125; <span class="keyword">while</span> (first != <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlinkCancelledWaiters</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å”¤é†’ - å¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignal å†…æ— éœ€è€ƒè™‘åŠ é”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">signal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        <span class="type">Node</span> <span class="variable">first</span> <span class="operator">=</span> firstWaiter;</span><br><span class="line">        <span class="keyword">if</span> (first != <span class="literal">null</span>)</span><br><span class="line">            doSignal(first);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…¨éƒ¨å”¤é†’ - å¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignalAll å†…æ— éœ€è€ƒè™‘åŠ é”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">signalAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        <span class="type">Node</span> <span class="variable">first</span> <span class="operator">=</span> firstWaiter;</span><br><span class="line">        <span class="keyword">if</span> (first != <span class="literal">null</span>)</span><br><span class="line">            doSignalAll(first);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸å¯æ‰“æ–­ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">awaitUninterruptibly</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—, è§ ãˆ </span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addConditionWaiter();</span><br><span class="line">        <span class="comment">// é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”, è§ ãˆ£</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> fullyRelease(node);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜Ÿåˆ—, é˜»å¡</span></span><br><span class="line">        <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">            <span class="comment">// park é˜»å¡</span></span><br><span class="line">            LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">            <span class="comment">// å¦‚æœè¢«æ‰“æ–­, ä»…è®¾ç½®æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">            <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å”¤é†’å, å°è¯•ç«äº‰é”, å¦‚æœå¤±è´¥è¿›å…¥ AQS é˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">if</span> (acquireQueued(node, savedState) || interrupted)</span><br><span class="line">            selfInterrupt();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doSignalAll</span><span class="params">(Node first)</span> &#123;</span><br><span class="line">        lastWaiter = firstWaiter = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">next</span> <span class="operator">=</span> first.nextWaiter;</span><br><span class="line">            first.nextWaiter = <span class="literal">null</span>;</span><br><span class="line">            transferForSignal(first);</span><br><span class="line">            first = next;</span><br><span class="line">        &#125; <span class="keyword">while</span> (first != <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlinkCancelledWaiters</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å”¤é†’ - å¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignal å†…æ— éœ€è€ƒè™‘åŠ é”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">signal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        <span class="type">Node</span> <span class="variable">first</span> <span class="operator">=</span> firstWaiter;</span><br><span class="line">        <span class="keyword">if</span> (first != <span class="literal">null</span>)</span><br><span class="line">            doSignal(first);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…¨éƒ¨å”¤é†’ - å¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignalAll å†…æ— éœ€è€ƒè™‘åŠ é”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">signalAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        <span class="type">Node</span> <span class="variable">first</span> <span class="operator">=</span> firstWaiter;</span><br><span class="line">        <span class="keyword">if</span> (first != <span class="literal">null</span>)</span><br><span class="line">            doSignalAll(first);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸å¯æ‰“æ–­ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">awaitUninterruptibly</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—, è§ ãˆ </span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addConditionWaiter();</span><br><span class="line">        <span class="comment">// é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”, è§ ãˆ£</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> fullyRelease(node);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜Ÿåˆ—, é˜»å¡</span></span><br><span class="line">        <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">            <span class="comment">// park é˜»å¡</span></span><br><span class="line">            LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">            <span class="comment">// å¦‚æœè¢«æ‰“æ–­, ä»…è®¾ç½®æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">            <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å”¤é†’å, å°è¯•ç«äº‰é”, å¦‚æœå¤±è´¥è¿›å…¥ AQS é˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">if</span> (acquireQueued(node, savedState) || interrupted)</span><br><span class="line">            selfInterrupt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤–éƒ¨ç±»æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">// ãˆ£ å› ä¸ºæŸçº¿ç¨‹å¯èƒ½é‡å…¥ï¼Œéœ€è¦å°† state å…¨éƒ¨é‡Šæ”¾</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">fullyRelease</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> getState();</span><br><span class="line">            <span class="keyword">if</span> (release(savedState)) &#123;</span><br><span class="line">                failed = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">return</span> savedState;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                node.waitStatus = Node.CANCELLED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ‰“æ–­æ¨¡å¼ - åœ¨é€€å‡ºç­‰å¾…æ—¶é‡æ–°è®¾ç½®æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REINTERRUPT</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// æ‰“æ–­æ¨¡å¼ - åœ¨é€€å‡ºç­‰å¾…æ—¶æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THROW_IE</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ‰“æ–­æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">checkInterruptWhileWaiting</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Thread.interrupted() ?</span><br><span class="line">            (transferAfterCancelledWait(node) ? THROW_IE : REINTERRUPT) :</span><br><span class="line">        <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ãˆ¤ åº”ç”¨æ‰“æ–­æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reportInterruptAfterWait</span><span class="params">(<span class="type">int</span> interruptMode)</span></span><br><span class="line">        <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (interruptMode == THROW_IE)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (interruptMode == REINTERRUPT)</span><br><span class="line">            selfInterrupt();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—, è§ ãˆ </span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addConditionWaiter();</span><br><span class="line">        <span class="comment">// é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> fullyRelease(node);</span><br><span class="line">        <span class="type">int</span> <span class="variable">interruptMode</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜Ÿåˆ—, é˜»å¡</span></span><br><span class="line">        <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">            <span class="comment">// park é˜»å¡</span></span><br><span class="line">            LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">            <span class="comment">// å¦‚æœè¢«æ‰“æ–­, é€€å‡ºç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">            <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é€€å‡ºç­‰å¾…é˜Ÿåˆ—å, è¿˜éœ€è¦è·å¾— AQS é˜Ÿåˆ—çš„é”</span></span><br><span class="line">        <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">            interruptMode = REINTERRUPT;</span><br><span class="line">        <span class="comment">// æ‰€æœ‰å·²å–æ¶ˆçš„ Node ä»é˜Ÿåˆ—é“¾è¡¨åˆ é™¤, è§ ãˆ¡</span></span><br><span class="line">        <span class="keyword">if</span> (node.nextWaiter != <span class="literal">null</span>) </span><br><span class="line">            unlinkCancelledWaiters();</span><br><span class="line">        <span class="comment">// åº”ç”¨æ‰“æ–­æ¨¡å¼, è§ ãˆ¤</span></span><br><span class="line">        <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">            reportInterruptAfterWait(interruptMode);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å‘Conditionä¸­çš„ç­‰å¾…é˜Ÿåˆ—ä¸­æ–°å¢èŠ‚ç‚¹ï¼Œå¹¶å°†æ­¤èŠ‚ç‚¹è¿”å›</span></span><br><span class="line">    <span class="keyword">private</span> Node <span class="title function_">addConditionWaiter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> lastWaiter;</span><br><span class="line">        <span class="comment">// If lastWaiter is cancelled, clean out.</span></span><br><span class="line">        <span class="keyword">if</span> (t != <span class="literal">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">            unlinkCancelledWaiters();</span><br><span class="line">            t = lastWaiter;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), Node.CONDITION);</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>)</span><br><span class="line">            firstWaiter = node;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            t.nextWaiter = node;</span><br><span class="line">        lastWaiter = node;</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦åœ¨åŒæ­¥å™¨ä¸­çš„é˜Ÿåˆ—ä¸­ç­‰å¾…é”</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isOnSyncQueue</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (node.waitStatus == Node.CONDITION || node.prev == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (node.next != <span class="literal">null</span>) <span class="comment">// If has successor, it must be on queue</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * node.prev can be non-null, but not yet on queue because</span></span><br><span class="line"><span class="comment">         * the CAS to place it on queue can fail. So we have to</span></span><br><span class="line"><span class="comment">         * traverse from tail to make sure it actually made it.  It</span></span><br><span class="line"><span class="comment">         * will always be near the tail in calls to this method, and</span></span><br><span class="line"><span class="comment">         * unless the CAS failed (which is unlikely), it will be</span></span><br><span class="line"><span class="comment">         * there, so we hardly ever traverse much.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> findNodeFromTail(node);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­æˆ–è¶…æ—¶</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">long</span> <span class="title function_">awaitNanos</span><span class="params">(<span class="type">long</span> nanosTimeout)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—, è§ ãˆ </span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addConditionWaiter();</span><br><span class="line">        <span class="comment">// é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> fullyRelease(node);</span><br><span class="line">        <span class="comment">// è·å¾—æœ€åæœŸé™</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">deadline</span> <span class="operator">=</span> System.nanoTime() + nanosTimeout;</span><br><span class="line">        <span class="type">int</span> <span class="variable">interruptMode</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜Ÿåˆ—, é˜»å¡</span></span><br><span class="line">        <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">            <span class="comment">// å·²è¶…æ—¶, é€€å‡ºç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">            <span class="keyword">if</span> (nanosTimeout &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                transferAfterCancelledWait(node);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// park é˜»å¡ä¸€å®šæ—¶é—´, spinForTimeoutThreshold ä¸º 1000 ns</span></span><br><span class="line">            <span class="keyword">if</span> (nanosTimeout &gt;= spinForTimeoutThreshold)</span><br><span class="line">                LockSupport.parkNanos(<span class="built_in">this</span>, nanosTimeout);</span><br><span class="line">            <span class="comment">// å¦‚æœè¢«æ‰“æ–­, é€€å‡ºç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">            <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            nanosTimeout = deadline - System.nanoTime();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é€€å‡ºç­‰å¾…é˜Ÿåˆ—å, è¿˜éœ€è¦è·å¾— AQS é˜Ÿåˆ—çš„é”</span></span><br><span class="line">        <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">            interruptMode = REINTERRUPT;</span><br><span class="line">        <span class="comment">// æ‰€æœ‰å·²å–æ¶ˆçš„ Node ä»é˜Ÿåˆ—é“¾è¡¨åˆ é™¤, è§ ãˆ¡</span></span><br><span class="line">        <span class="keyword">if</span> (node.nextWaiter != <span class="literal">null</span>)</span><br><span class="line">            unlinkCancelledWaiters();</span><br><span class="line">        <span class="comment">// åº”ç”¨æ‰“æ–­æ¨¡å¼, è§ ãˆ¤</span></span><br><span class="line">        <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">            reportInterruptAfterWait(interruptMode);</span><br><span class="line">        <span class="keyword">return</span> deadline - System.nanoTime();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­æˆ–è¶…æ—¶, é€»è¾‘ç±»ä¼¼äº awaitNanos</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">awaitUntil</span><span class="params">(Date deadline)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­æˆ–è¶…æ—¶, é€»è¾‘ç±»ä¼¼äº awaitNanos</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">await</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å·¥å…·æ–¹æ³• çœç•¥ ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>æ€»ç»“ï¼š</p><ul><li>å½“å‰æŒæœ‰é”çš„çº¿ç¨‹å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ï¼Œè°ƒç”¨doSignalæˆ–doSignalAllæ–¹æ³•ï¼Œå°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªï¼ˆæˆ–å…¨éƒ¨ï¼‰èŠ‚ç‚¹æ’å…¥åˆ°AQSé˜Ÿåˆ—ä¸­çš„å°¾éƒ¨ã€‚</li><li>å°†æ’å…¥çš„èŠ‚ç‚¹çš„çŠ¶æ€ä»Conditionè®¾ç½®ä¸º0ï¼Œå°†æ’å…¥èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®ä¸º-1ï¼ˆæ„å‘³ç€è¦æ‰¿æ‹…å”¤é†’åä¸€ä¸ªèŠ‚ç‚¹çš„è´£ä»»ï¼‰</li><li>å½“å‰çº¿ç¨‹é‡Šæ”¾é”ï¼ŒparkAQSé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çº¿ç¨‹ã€‚</li></ul><h2 id="5-è¯»å†™é”">5. è¯»å†™é”</h2><h3 id="5-1-ReentrantReadWriteLock">5.1 ReentrantReadWriteLock</h3><p>å½“è¯»æ“ä½œè¿œè¿œé«˜äºå†™æ“ä½œæ—¶ï¼Œè¿™æ—¶å€™ä½¿ç”¨<code>è¯»å†™é”</code>è®©<code>è¯»-è¯»</code>å¯ä»¥å¹¶å‘ï¼Œæé«˜æ€§èƒ½ã€‚</p><p>ç±»ä¼¼äºæ•°æ®åº“ä¸­çš„<code>select ... from ... lock in share mode</code></p><blockquote><p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯è¯»é”å¯ä»¥å…±äº«ï¼Œä½†æ˜¯å†™é”å¿…é¡»ç‹¬å </p></blockquote><p>ç¤ºä¾‹ï¼šæä¾›ä¸€ä¸ª<code>æ•°æ®å®¹å™¨ç±»</code>å†…éƒ¨åˆ†åˆ«ä½¿ç”¨<code>è¯»é”</code>ä¿æŠ¤æ•°æ®çš„ read() æ–¹æ³•ï¼Œ<code>å†™é”</code>ä¿æŠ¤æ•°æ®çš„ write() æ–¹æ³•</p><div class="tabs" id="f35d3c3d-bc69-4924-92b2-8243c2220566"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#f35d3c3d-bc69-4924-92b2-8243c2220566-1"><i class="fas fa-bug"></i>ä»£ç </button></li><li class="tab"><button type="button" data-href="#f35d3c3d-bc69-4924-92b2-8243c2220566-2"><i class="fas fa-cannabis"></i>æµ‹è¯•è¯»é”-è¯»é”å¯ä»¥å¹¶å‘</button></li><li class="tab"><button type="button" data-href="#f35d3c3d-bc69-4924-92b2-8243c2220566-3"><i class="fas fa-candy-cane"></i>æµ‹è¯•è¯»é”-å†™é”ç›¸äº’é˜»å¡</button></li><li class="tab"><button type="button" data-href="#f35d3c3d-bc69-4924-92b2-8243c2220566-4"><i class="fas fa-child"></i>æµ‹è¯•å†™é”-å†™é”ç›¸äº’é˜»å¡</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="f35d3c3d-bc69-4924-92b2-8243c2220566-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DataContainer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">ReentrantReadWriteLock</span> <span class="variable">rw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();</span><br><span class="line">    <span class="keyword">private</span> ReentrantReadWriteLock.<span class="type">ReadLock</span> <span class="variable">r</span> <span class="operator">=</span> rw.readLock();</span><br><span class="line">    <span class="keyword">private</span> ReentrantReadWriteLock.<span class="type">WriteLock</span> <span class="variable">w</span> <span class="operator">=</span> rw.writeLock();</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">read</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;è·å–è¯»é”...&quot;</span>);</span><br><span class="line">        r.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;è¯»å–&quot;</span>);</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;é‡Šæ”¾è¯»é”...&quot;</span>);</span><br><span class="line">            r.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;è·å–å†™é”...&quot;</span>);</span><br><span class="line">        w.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å†™å…¥&quot;</span>);</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;é‡Šæ”¾å†™é”...&quot;</span>);</span><br><span class="line">            w.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f35d3c3d-bc69-4924-92b2-8243c2220566-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DataContainer</span> <span class="variable">dataContainer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataContainer</span>();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    dataContainer.read();</span><br><span class="line">&#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    dataContainer.read();</span><br><span class="line">&#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼Œä»è¿™é‡Œå¯ä»¥çœ‹åˆ° Thread-0 é”å®šæœŸé—´ï¼ŒThread-1 çš„è¯»æ“ä½œä¸å—å½±å“</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">14:05:14.341 c.DataContainer [t2] - è·å–è¯»é”... </span><br><span class="line">14:05:14.341 c.DataContainer [t1] - è·å–è¯»é”... </span><br><span class="line">14:05:14.345 c.DataContainer [t1] - è¯»å–</span><br><span class="line">14:05:14.345 c.DataContainer [t2] - è¯»å–</span><br><span class="line">14:05:15.365 c.DataContainer [t2] - é‡Šæ”¾è¯»é”... </span><br><span class="line">14:05:15.386 c.DataContainer [t1] - é‡Šæ”¾è¯»é”... </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f35d3c3d-bc69-4924-92b2-8243c2220566-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DataContainer</span> <span class="variable">dataContainer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataContainer</span>();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    dataContainer.read();</span><br><span class="line">&#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">Thread.sleep(<span class="number">100</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    dataContainer.write();</span><br><span class="line">&#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">21.838</span> c.DataContainer [t1] - è·å–è¯»é”... </span><br><span class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">21.838</span> c.DataContainer [t2] - è·å–å†™é”... </span><br><span class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">21.841</span> c.DataContainer [t2] - å†™å…¥</span><br><span class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">22.843</span> c.DataContainer [t2] - é‡Šæ”¾å†™é”... </span><br><span class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">22.843</span> c.DataContainer [t1] - è¯»å–</span><br><span class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">23.843</span> c.DataContainer [t1] - é‡Šæ”¾è¯»é”... </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="f35d3c3d-bc69-4924-92b2-8243c2220566-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DataContainer</span> <span class="variable">dataContainer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataContainer</span>();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    dataContainer.write();</span><br><span class="line">&#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">Thread.sleep(<span class="number">100</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    dataContainer.write();</span><br><span class="line">&#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>:<span class="number">33</span>:<span class="number">52.665</span> c.DataContainer [t1] - è·å–å†™é”...</span><br><span class="line"><span class="number">11</span>:<span class="number">33</span>:<span class="number">52.665</span> c.DataContainer [t2] - è·å–å†™é”...</span><br><span class="line"><span class="number">11</span>:<span class="number">33</span>:<span class="number">52.667</span> c.DataContainer [t2] - å†™å…¥</span><br><span class="line"><span class="number">11</span>:<span class="number">33</span>:<span class="number">53.673</span> c.DataContainer [t2] - é‡Šæ”¾å†™é”...</span><br><span class="line"><span class="number">11</span>:<span class="number">33</span>:<span class="number">53.674</span> c.DataContainer [t1] - å†™å…¥</span><br><span class="line"><span class="number">11</span>:<span class="number">33</span>:<span class="number">54.679</span> c.DataContainer [t1] - é‡Šæ”¾å†™é”...</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p></p><p><strong>æ³¨æ„äº‹é¡¹</strong></p><div class="tabs" id="9055eaa3-a964-4954-a6d8-3159462eb4fd"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#9055eaa3-a964-4954-a6d8-3159462eb4fd-1"><i class="fas fa-seedling"></i>1</button></li><li class="tab"><button type="button" data-href="#9055eaa3-a964-4954-a6d8-3159462eb4fd-2"><i class="fas fa-leaf"></i>2</button></li><li class="tab"><button type="button" data-href="#9055eaa3-a964-4954-a6d8-3159462eb4fd-3"><i class="fab fa-apple"></i>3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="9055eaa3-a964-4954-a6d8-3159462eb4fd-1"><p>è¯»é”ä¸æ”¯æŒæ¡ä»¶å˜é‡</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9055eaa3-a964-4954-a6d8-3159462eb4fd-2"><p>é‡å…¥æ—¶å‡çº§ä¸æ”¯æŒï¼šå³æŒæœ‰è¯»é”çš„æƒ…å†µä¸‹å»è·å–å†™é”ï¼Œä¼šå¯¼è‡´è·å–å†™é”æ°¸ä¹…ç­‰å¾…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">r.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    w.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">        w.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">    r.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="9055eaa3-a964-4954-a6d8-3159462eb4fd-3"><p>é‡å…¥æ—¶é™çº§æ”¯æŒï¼šå³æŒæœ‰å†™é”çš„æƒ…å†µä¸‹å»è·å–è¯»é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CachedData</span> &#123;</span><br><span class="line">    Object data;</span><br><span class="line">    <span class="comment">// æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœå¤±æ•ˆï¼Œéœ€è¦é‡æ–°è®¡ç®— data</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">boolean</span> cacheValid;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantReadWriteLock</span> <span class="variable">rwl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">processCachedData</span><span class="params">()</span> &#123;</span><br><span class="line">        rwl.readLock().lock();</span><br><span class="line">        <span class="keyword">if</span> (!cacheValid) &#123;</span><br><span class="line">            <span class="comment">// è·å–å†™é”å‰å¿…é¡»é‡Šæ”¾è¯»é”</span></span><br><span class="line">            rwl.readLock().unlock();</span><br><span class="line">            rwl.writeLock().lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// åˆ¤æ–­æ˜¯å¦æœ‰å…¶å®ƒçº¿ç¨‹å·²ç»è·å–äº†å†™é”ã€æ›´æ–°äº†ç¼“å­˜, é¿å…é‡å¤æ›´æ–°</span></span><br><span class="line">                <span class="keyword">if</span> (!cacheValid) &#123;</span><br><span class="line">                    data = ...</span><br><span class="line">                        cacheValid = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// é™çº§ä¸ºè¯»é”, é‡Šæ”¾å†™é”, è¿™æ ·èƒ½å¤Ÿè®©å…¶å®ƒçº¿ç¨‹è¯»å–ç¼“å­˜</span></span><br><span class="line">                rwl.readLock().lock();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                rwl.writeLock().unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è‡ªå·±ç”¨å®Œæ•°æ®, é‡Šæ”¾è¯»é” </span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            use(data);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            rwl.readLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="5-2-è¯»å†™é”åŸç†">5.2 è¯»å†™é”åŸç†</h3><p>å›¾è§£æµç¨‹</p><div class="tabs" id="1a9249ba-6a46-4d14-b45f-183ba5c9fcba"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#1a9249ba-6a46-4d14-b45f-183ba5c9fcba-1"><i class="fas fa-cat"></i>t1 w.lockï¼Œt2 r.lock</button></li><li class="tab"><button type="button" data-href="#1a9249ba-6a46-4d14-b45f-183ba5c9fcba-2"><i class="fas fa-horse"></i>t3 r.lockï¼Œt4 w.lock</button></li><li class="tab"><button type="button" data-href="#1a9249ba-6a46-4d14-b45f-183ba5c9fcba-3"><i class="fas fa-dove"></i>t1 w.unlock</button></li><li class="tab"><button type="button" data-href="#1a9249ba-6a46-4d14-b45f-183ba5c9fcba-4"><i class="fas fa-dragon"></i>t2 r.unlockï¼Œt3 r.unlock</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="1a9249ba-6a46-4d14-b45f-183ba5c9fcba-1"><p>1ï¼‰ t1 æˆåŠŸä¸Šé”ï¼Œæµç¨‹ä¸ ReentrantLock åŠ é”ç›¸æ¯”æ²¡æœ‰ç‰¹æ®Šä¹‹å¤„ï¼Œä¸åŒæ˜¯å†™é”çŠ¶æ€å äº† state çš„ä½ 16 ä½ï¼Œè€Œè¯»é” ä½¿ç”¨çš„æ˜¯ state çš„é«˜ 16 ä½</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314191716969.png" alt="image-20220314191716969" style="zoom:67%"><p>2ï¼‰t2 æ‰§è¡Œ r.lockï¼Œè¿™æ—¶è¿›å…¥è¯»é”çš„ sync.acquireShared(1) æµç¨‹ï¼Œé¦–å…ˆä¼šè¿›å…¥ tryAcquireShared æµç¨‹ã€‚å¦‚æœæœ‰å†™ é”å æ®ï¼Œé‚£ä¹ˆ tryAcquireShared è¿”å› -1 è¡¨ç¤ºå¤±è´¥</p><blockquote><p>tryAcquireShared è¿”å›å€¼è¡¨ç¤º</p><ul><li>-1 è¡¨ç¤ºå¤±è´¥</li><li>0 è¡¨ç¤ºæˆåŠŸï¼Œä½†åç»§èŠ‚ç‚¹ä¸ä¼šç»§ç»­å”¤é†’</li><li>æ­£æ•°è¡¨ç¤ºæˆåŠŸï¼Œè€Œä¸”æ•°å€¼æ˜¯è¿˜æœ‰å‡ ä¸ªåç»§èŠ‚ç‚¹éœ€è¦å”¤é†’ï¼Œè¯»å†™é”è¿”å› 1</li></ul></blockquote><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314191820931.png" alt="image-20220314191820931" style="zoom:67%"><p>3ï¼‰è¿™æ—¶ä¼šè¿›å…¥ sync.doAcquireShared(1) æµç¨‹ï¼Œé¦–å…ˆä¹Ÿæ˜¯è°ƒç”¨ addWaiter æ·»åŠ èŠ‚ç‚¹ï¼Œä¸åŒä¹‹å¤„åœ¨äºèŠ‚ç‚¹è¢«è®¾ç½®ä¸º<code>Node.SHARED</code>æ¨¡å¼è€Œé <code>Node.EXCLUSIVE</code> æ¨¡å¼ï¼Œæ³¨æ„æ­¤æ—¶ t2 ä»å¤„äºæ´»è·ƒçŠ¶æ€</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314191835250.png" alt="image-20220314191835250" style="zoom:67%"><p>4ï¼‰t2 ä¼šçœ‹çœ‹è‡ªå·±çš„èŠ‚ç‚¹æ˜¯ä¸æ˜¯è€äºŒï¼Œå¦‚æœæ˜¯ï¼Œè¿˜ä¼šå†æ¬¡è°ƒç”¨ tryAcquireShared(1) æ¥å°è¯•è·å–é”</p><p>5ï¼‰å¦‚æœæ²¡æœ‰æˆåŠŸï¼Œåœ¨ doAcquireShared å†… for (;;) å¾ªç¯ä¸€æ¬¡ï¼ŒæŠŠå‰é©±èŠ‚ç‚¹çš„ waitStatus æ”¹ä¸º -1ï¼Œå† for (;;) å¾ªç¯ä¸€ æ¬¡å°è¯• tryAcquireShared(1) å¦‚æœè¿˜ä¸æˆåŠŸï¼Œé‚£ä¹ˆåœ¨ parkAndCheckInterrupt() å¤„ park</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314191859644.png" alt="image-20220314191859644" style="zoom:67%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="1a9249ba-6a46-4d14-b45f-183ba5c9fcba-2"><p>è¿™ç§çŠ¶æ€ä¸‹ï¼Œå‡è®¾åˆæœ‰ t3 åŠ è¯»é”å’Œ t4 åŠ å†™é”ï¼Œè¿™æœŸé—´ t1 ä»ç„¶æŒæœ‰é”ï¼Œå°±å˜æˆäº†ä¸‹é¢çš„æ ·å­</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314191927467.png" alt="image-20220314191927467" style="zoom:67%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="1a9249ba-6a46-4d14-b45f-183ba5c9fcba-3"><p>è¿™æ—¶ä¼šèµ°åˆ°å†™é”çš„ sync.release(1) æµç¨‹ï¼Œè°ƒç”¨ sync.tryRelease(1) æˆåŠŸï¼Œå˜æˆä¸‹é¢çš„æ ·å­</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314191953466.png" alt="image-20220314191953466" style="zoom:67%"><p>æ¥ä¸‹æ¥æ‰§è¡Œå”¤é†’æµç¨‹ sync.unparkSuccessorï¼Œå³è®©è€äºŒæ¢å¤è¿è¡Œï¼Œè¿™æ—¶ t2 åœ¨ doAcquireShared å†… parkAndCheckInterrupt() å¤„æ¢å¤è¿è¡Œ</p><p>è¿™å›å†æ¥ä¸€æ¬¡ for (;;) æ‰§è¡Œ tryAcquireShared æˆåŠŸåˆ™è®©è¯»é”è®¡æ•°åŠ ä¸€</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314192033493.png" alt="image-20220314192033493" style="zoom:67%"><p>è¿™æ—¶ t2 å·²ç»æ¢å¤è¿è¡Œï¼Œæ¥ä¸‹æ¥ t2 è°ƒç”¨ setHeadAndPropagate(node, 1)ï¼Œå®ƒåŸæœ¬æ‰€åœ¨èŠ‚ç‚¹è¢«ç½®ä¸ºå¤´èŠ‚ç‚¹</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314192048242.png" alt="image-20220314192048242" style="zoom:67%"><p>äº‹æƒ…è¿˜æ²¡å®Œï¼Œåœ¨ setHeadAndPropagate æ–¹æ³•å†…è¿˜ä¼šæ£€æŸ¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯ sharedï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨ doReleaseShared() å°† head çš„çŠ¶æ€ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’è€äºŒï¼Œè¿™æ—¶ t3 åœ¨ doAcquireShared å†… parkAndCheckInterrupt() å¤„æ¢å¤è¿è¡Œ</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314192104962.png" alt="image-20220314192104962" style="zoom:67%"><p>è¿™å›å†æ¥ä¸€æ¬¡ for (;;) æ‰§è¡Œ tryAcquireShared æˆåŠŸåˆ™è®©è¯»é”è®¡æ•°åŠ ä¸€</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314192123102.png" alt="image-20220314192123102" style="zoom:67%"><p>è¿™æ—¶ t3 å·²ç»æ¢å¤è¿è¡Œï¼Œæ¥ä¸‹æ¥ t3 è°ƒç”¨ setHeadAndPropagate(node, 1)ï¼Œå®ƒåŸæœ¬æ‰€åœ¨èŠ‚ç‚¹è¢«ç½®ä¸ºå¤´èŠ‚ç‚¹</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314192145552.png" alt="image-20220314192145552" style="zoom:67%"><p>ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸æ˜¯ shared äº†ï¼Œå› æ­¤ä¸ä¼šç»§ç»­å”¤é†’ t4 æ‰€åœ¨èŠ‚ç‚¹</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="1a9249ba-6a46-4d14-b45f-183ba5c9fcba-4"><p>t2 è¿›å…¥ sync.releaseShared(1) ä¸­ï¼Œè°ƒç”¨ tryReleaseShared(1) è®©è®¡æ•°å‡ä¸€ï¼Œä½†ç”±äºè®¡æ•°è¿˜ä¸ä¸ºé›¶</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314192222303.png" alt="image-20220314192222303" style="zoom:67%"><p>t3 è¿›å…¥ sync.releaseShared(1) ä¸­ï¼Œè°ƒç”¨ tryReleaseShared(1) è®©è®¡æ•°å‡ä¸€ï¼Œè¿™å›è®¡æ•°ä¸ºé›¶äº†ï¼Œè¿›å…¥ doReleaseShared() å°†å¤´èŠ‚ç‚¹ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’è€äºŒï¼Œå³</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314192239120.png" alt="image-20220314192239120" style="zoom:67%"><p>ä¹‹å t4 åœ¨ acquireQueued ä¸­ parkAndCheckInterrupt å¤„æ¢å¤è¿è¡Œï¼Œå†æ¬¡ for (;;) è¿™æ¬¡è‡ªå·±æ˜¯è€äºŒï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»– ç«äº‰ï¼ŒtryAcquire(1) æˆåŠŸï¼Œä¿®æ”¹å¤´ç»“ç‚¹ï¼Œæµç¨‹ç»“æŸ</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220314192254698.png" alt="image-20220314192254698" style="zoom:67%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="5-3-StampedLock">5.3 StampedLock</h3><p>è¯¥ç±»è‡ª JDK 8 åŠ å…¥ï¼Œæ˜¯ä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–è¯»æ€§èƒ½ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯åœ¨ä½¿ç”¨è¯»é”ã€å†™é”æ—¶éƒ½å¿…é¡»é…åˆã€æˆ³ã€‘ä½¿ç”¨ åŠ è§£è¯»é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.readLock();</span><br><span class="line">lock.unlockRead(stamp);</span><br></pre></td></tr></table></figure><p>åŠ è§£å†™é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.writeLock();</span><br><span class="line">lock.unlockWrite(stamp);</span><br></pre></td></tr></table></figure><p>ä¹è§‚è¯»ï¼ŒStampedLock æ”¯æŒ tryOptimisticRead() æ–¹æ³•ï¼ˆä¹è§‚è¯»ï¼‰ï¼Œè¯»å–å®Œæ¯•åéœ€è¦åšä¸€æ¬¡ æˆ³æ ¡éªŒ å¦‚æœæ ¡éªŒé€š è¿‡ï¼Œè¡¨ç¤ºè¿™æœŸé—´ç¡®å®æ²¡æœ‰å†™æ“ä½œï¼Œæ•°æ®å¯ä»¥å®‰å…¨ä½¿ç”¨ï¼Œå¦‚æœæ ¡éªŒæ²¡é€šè¿‡ï¼Œéœ€è¦é‡æ–°è·å–è¯»é”ï¼Œä¿è¯æ•°æ®å®‰å…¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.tryOptimisticRead();</span><br><span class="line"><span class="comment">// éªŒæˆ³</span></span><br><span class="line"><span class="keyword">if</span>(!lock.validate(stamp))&#123;</span><br><span class="line">    <span class="comment">// é”å‡çº§</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="tabs" id="5f17da48-39fe-4fb3-adb1-6b96a51c0809"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#5f17da48-39fe-4fb3-adb1-6b96a51c0809-1"><i class="fas fa-award"></i>æ•°æ®å®¹å™¨ç±»</button></li><li class="tab"><button type="button" data-href="#5f17da48-39fe-4fb3-adb1-6b96a51c0809-2"><i class="fas fa-baseball-ball"></i>æµ‹è¯•è¯»-è¯»</button></li><li class="tab"><button type="button" data-href="#5f17da48-39fe-4fb3-adb1-6b96a51c0809-3"><i class="fas fa-bone"></i>æµ‹è¯•è¯»-å†™</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="5f17da48-39fe-4fb3-adb1-6b96a51c0809-1"><p>æä¾›ä¸€ä¸ª<code>æ•°æ®å®¹å™¨ç±»</code>å†…éƒ¨åˆ†åˆ«ä½¿ç”¨è¯»é”ä¿æŠ¤æ•°æ®çš„<code>read()</code>æ–¹æ³•ï¼Œå†™é”ä¿æŠ¤æ•°æ®çš„<code>write()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DataContainerStamped</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> data;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">StampedLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StampedLock</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DataContainerStamped</span><span class="params">(<span class="type">int</span> data)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">read</span><span class="params">(<span class="type">int</span> readTime)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–æˆ³</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.tryOptimisticRead();</span><br><span class="line">        log.debug(<span class="string">&quot;optimistic read locking...&#123;&#125;&quot;</span>, stamp);</span><br><span class="line">        <span class="comment">//è¯»å–æ•°æ®</span></span><br><span class="line">        sleep(readTime);</span><br><span class="line">        <span class="comment">//è¯»å–æ•°æ®ä¹‹åå†éªŒæˆ³</span></span><br><span class="line">        <span class="keyword">if</span> (lock.validate(stamp)) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;read finish...&#123;&#125;, data:&#123;&#125;&quot;</span>, stamp, data);</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœéªŒæˆ³å¤±è´¥ï¼Œè¯´æ˜å·²ç»æ•°æ®å·²ç»è¢«ä¿®æ”¹ï¼Œéœ€è¦å‡çº§é”é‡æ–°è¯»ã€‚</span></span><br><span class="line">        <span class="comment">// é”å‡çº§ - è¯»é”</span></span><br><span class="line">        log.debug(<span class="string">&quot;updating to read lock... &#123;&#125;&quot;</span>, stamp);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stamp = lock.readLock();</span><br><span class="line">            log.debug(<span class="string">&quot;read lock &#123;&#125;&quot;</span>, stamp);</span><br><span class="line">            sleep(readTime);</span><br><span class="line">            log.debug(<span class="string">&quot;read finish...&#123;&#125;, data:&#123;&#125;&quot;</span>, stamp, data);</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;read unlock &#123;&#125;&quot;</span>, stamp);</span><br><span class="line">            lock.unlockRead(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span> newData)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.writeLock();</span><br><span class="line">        log.debug(<span class="string">&quot;write lock &#123;&#125;&quot;</span>, stamp);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sleep(<span class="number">2</span>);</span><br><span class="line">            <span class="built_in">this</span>.data = newData;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;write unlock &#123;&#125;&quot;</span>, stamp);</span><br><span class="line">            lock.unlockWrite(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5f17da48-39fe-4fb3-adb1-6b96a51c0809-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">DataContainerStamped</span> <span class="variable">dataContainer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataContainerStamped</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        dataContainer.read(<span class="number">1</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    sleep(<span class="number">0.5</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        dataContainer.read(<span class="number">0</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼Œå¯ä»¥çœ‹åˆ°å®é™…æ²¡æœ‰åŠ è¯»é”</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">15:58:50.217 c.DataContainerStamped [t1] - optimistic <span class="built_in">read</span> locking...256 </span><br><span class="line">15:58:50.717 c.DataContainerStamped [t2] - optimistic <span class="built_in">read</span> locking...256 </span><br><span class="line">15:58:50.717 c.DataContainerStamped [t2] - <span class="built_in">read</span> finish...256, data:1 </span><br><span class="line">15:58:51.220 c.DataContainerStamped [t1] - <span class="built_in">read</span> finish...256, data:1 </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="5f17da48-39fe-4fb3-adb1-6b96a51c0809-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">DataContainerStamped</span> <span class="variable">dataContainer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataContainerStamped</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        dataContainer.read(<span class="number">1</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    sleep(<span class="number">0.5</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        dataContainer.write(<span class="number">100</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">15:57:00.219 c.DataContainerStamped [t1] - optimistic <span class="built_in">read</span> locking...256 </span><br><span class="line">15:57:00.717 c.DataContainerStamped [t2] - write lock 384 </span><br><span class="line">15:57:01.225 c.DataContainerStamped [t1] - updating to <span class="built_in">read</span> lock... 256 </span><br><span class="line">15:57:02.719 c.DataContainerStamped [t2] - write unlock 384 </span><br><span class="line">15:57:02.719 c.DataContainerStamped [t1] - <span class="built_in">read</span> lock 513 </span><br><span class="line">15:57:03.719 c.DataContainerStamped [t1] - <span class="built_in">read</span> finish...513, data:1000 </span><br><span class="line">15:57:03.719 c.DataContainerStamped [t1] - <span class="built_in">read</span> unlock 513 </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><blockquote><p><strong>æ³¨æ„</strong></p><ul><li>StampedLock ä¸æ”¯æŒæ¡ä»¶å˜é‡</li><li>StampedLock ä¸æ”¯æŒå¯é‡å…¥</li></ul></blockquote><h2 id="6-Semaphore">6. Semaphore</h2><h3 id="6-1-åŸºæœ¬ä½¿ç”¨">6.1 åŸºæœ¬ä½¿ç”¨</h3><p>ä¿¡å·é‡ï¼Œç”¨æ¥é™åˆ¶èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹ä¸Šé™ã€‚</p><div class="tabs" id="be1198a9-b921-40a1-b900-cc9c2f9126a0"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#be1198a9-b921-40a1-b900-cc9c2f9126a0-1"><i class="fas fa-bug"></i>ä»£ç </button></li><li class="tab"><button type="button" data-href="#be1198a9-b921-40a1-b900-cc9c2f9126a0-2"><i class="fas fa-cannabis"></i>è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="be1198a9-b921-40a1-b900-cc9c2f9126a0-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. åˆ›å»º semaphore å¯¹è±¡</span></span><br><span class="line">    <span class="type">Semaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">// 2. 10ä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œ</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// 3. è·å–è®¸å¯</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                semaphore.acquire();</span><br><span class="line">            <span class="comment">//å¯¹äºéæ‰“æ–­å¼è·å–ï¼Œå¦‚æœæ­¤è¿‡ç¨‹ä¸­è¢«æ‰“æ–­ï¼Œçº¿ç¨‹ä¾æ—§ä¼šç­‰åˆ°è·å–äº†ä¿¡å·é‡ä¹‹åæ‰è¿›å…¥catchå—ã€‚</span></span><br><span class="line">            <span class="comment">//catchå—ä¸­çš„çº¿ç¨‹ä¾æ—§æŒæœ‰ä¿¡å·é‡ï¼Œæ•è·è¯¥å¼‚å¸¸åcatchå—å¯ä»¥ä¸åšä»»ä½•å¤„ç†ã€‚</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;running...&quot;</span>);</span><br><span class="line">                sleep(<span class="number">1</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;end...&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 4. é‡Šæ”¾è®¸å¯</span></span><br><span class="line">                semaphore.release();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="be1198a9-b921-40a1-b900-cc9c2f9126a0-2"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">07:35:15.485 c.TestSemaphore [Thread-2] - running... </span><br><span class="line">07:35:15.485 c.TestSemaphore [Thread-1] - running... </span><br><span class="line">07:35:15.485 c.TestSemaphore [Thread-0] - running... </span><br><span class="line">07:35:16.490 c.TestSemaphore [Thread-2] - end... </span><br><span class="line">07:35:16.490 c.TestSemaphore [Thread-0] - end... </span><br><span class="line">07:35:16.490 c.TestSemaphore [Thread-1] - end... </span><br><span class="line">07:35:16.490 c.TestSemaphore [Thread-3] - running... </span><br><span class="line">07:35:16.490 c.TestSemaphore [Thread-5] - running... </span><br><span class="line">07:35:16.490 c.TestSemaphore [Thread-4] - running... </span><br><span class="line">07:35:17.490 c.TestSemaphore [Thread-5] - end... </span><br><span class="line">07:35:17.490 c.TestSemaphore [Thread-4] - end... </span><br><span class="line">07:35:17.490 c.TestSemaphore [Thread-3] - end... </span><br><span class="line">07:35:17.490 c.TestSemaphore [Thread-6] - running... </span><br><span class="line">07:35:17.490 c.TestSemaphore [Thread-7] - running... </span><br><span class="line">07:35:17.490 c.TestSemaphore [Thread-9] - running... </span><br><span class="line">07:35:18.491 c.TestSemaphore [Thread-6] - end... </span><br><span class="line">07:35:18.491 c.TestSemaphore [Thread-7] - end... </span><br><span class="line">07:35:18.491 c.TestSemaphore [Thread-9] - end... </span><br><span class="line">07:35:18.491 c.TestSemaphore [Thread-8] - running... </span><br><span class="line">07:35:19.492 c.TestSemaphore [Thread-8] - end... </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>è¯´æ˜ï¼š</p><ul><li>Semaphoreæœ‰ä¸¤ä¸ªæ„é€ å™¨ï¼š<code>Semaphore(int permits)</code>å’Œ<code>Semaphore(int permits,boolean fair)</code></li><li>permitsè¡¨ç¤ºå…è®¸åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹æ•°ã€‚</li><li>fairè¡¨ç¤ºå…¬å¹³ä¸å¦ï¼Œä¸ä¹‹å‰çš„ReentrantLockä¸€æ ·ã€‚</li></ul><h3 id="6-2-Semaphore-åº”ç”¨">6.2 Semaphore åº”ç”¨</h3><p>semaphore é™åˆ¶å¯¹å…±äº«èµ„æºçš„ä½¿ç”¨</p><ul><li>ä½¿ç”¨ Semaphore é™æµï¼Œåœ¨è®¿é—®é«˜å³°æœŸæ—¶ï¼Œè®©è¯·æ±‚çº¿ç¨‹é˜»å¡ï¼Œé«˜å³°æœŸè¿‡å»å†é‡Šæ”¾è®¸å¯ï¼Œå½“ç„¶å®ƒåªé€‚åˆé™åˆ¶å•æœº çº¿ç¨‹æ•°é‡ï¼Œå¹¶ä¸”ä»…æ˜¯é™åˆ¶çº¿ç¨‹æ•°ï¼Œè€Œä¸æ˜¯é™åˆ¶èµ„æºæ•°ï¼ˆä¾‹å¦‚è¿æ¥æ•°ï¼Œè¯·å¯¹æ¯” Tomcat LimitLatch çš„å®ç°ï¼‰</li><li>ç”¨ Semaphore å®ç°ç®€å•è¿æ¥æ± ï¼Œå¯¹æ¯”ã€äº«å…ƒæ¨¡å¼ã€ä¸‹çš„å®ç°ï¼ˆç”¨wait notifyï¼‰ï¼Œæ€§èƒ½å’Œå¯è¯»æ€§æ˜¾ç„¶æ›´å¥½ï¼Œ æ³¨æ„ä¸‹é¢çš„å®ç°ä¸­çº¿ç¨‹æ•°å’Œæ•°æ®åº“è¿æ¥æ•°æ˜¯ç›¸ç­‰çš„</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Pool&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pool</span> &#123;</span><br><span class="line">    <span class="comment">// 1. è¿æ¥æ± å¤§å°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> poolSize;</span><br><span class="line">    <span class="comment">// 2. è¿æ¥å¯¹è±¡æ•°ç»„</span></span><br><span class="line">    <span class="keyword">private</span> Connection[] connections;</span><br><span class="line">    <span class="comment">// 3. è¿æ¥çŠ¶æ€æ•°ç»„ 0 è¡¨ç¤ºç©ºé—²ï¼Œ 1 è¡¨ç¤ºç¹å¿™</span></span><br><span class="line">    <span class="keyword">private</span> AtomicIntegerArray states;</span><br><span class="line">    <span class="keyword">private</span> Semaphore semaphore;</span><br><span class="line">    <span class="comment">// 4. æ„é€ æ–¹æ³•åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Pool</span><span class="params">(<span class="type">int</span> poolSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.poolSize = poolSize;</span><br><span class="line">        <span class="comment">// è®©è®¸å¯æ•°ä¸èµ„æºæ•°ä¸€è‡´</span></span><br><span class="line">        <span class="built_in">this</span>.semaphore = <span class="keyword">new</span> <span class="title class_">Semaphore</span>(poolSize);</span><br><span class="line">        <span class="built_in">this</span>.connections = <span class="keyword">new</span> <span class="title class_">Connection</span>[poolSize];</span><br><span class="line">        <span class="built_in">this</span>.states = <span class="keyword">new</span> <span class="title class_">AtomicIntegerArray</span>(<span class="keyword">new</span> <span class="title class_">int</span>[poolSize]);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            connections[i] = <span class="keyword">new</span> <span class="title class_">MockConnection</span>(<span class="string">&quot;è¿æ¥&quot;</span> + (i+<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5. å€Ÿè¿æ¥</span></span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">borrow</span><span class="params">()</span> &#123;<span class="comment">// t1, t2, t3</span></span><br><span class="line">        <span class="comment">// è·å–è®¸å¯</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            semaphore.acquire(); <span class="comment">// æ²¡æœ‰è®¸å¯çš„çº¿ç¨‹ï¼Œåœ¨æ­¤ç­‰å¾…</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            <span class="comment">// è·å–ç©ºé—²è¿æ¥</span></span><br><span class="line">            <span class="keyword">if</span>(states.get(i) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (states.compareAndSet(i, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;borrow &#123;&#125;&quot;</span>, connections[i]);</span><br><span class="line">                    <span class="keyword">return</span> connections[i];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6. å½’è¿˜è¿æ¥</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">free</span><span class="params">(Connection conn)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (connections[i] == conn) &#123;</span><br><span class="line">                states.set(i, <span class="number">0</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;free &#123;&#125;&quot;</span>, conn);</span><br><span class="line">                semaphore.release();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-3-Semaphore-åŸç†">6.3 Semaphore åŸç†</h3><p><strong>åŠ é”è§£é”æµç¨‹</strong></p><div class="tabs" id="391f4b61-142c-44aa-99c6-3134e7ac1fe6"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#391f4b61-142c-44aa-99c6-3134e7ac1fe6-1"><i class="fas fa-candy-cane"></i>1</button></li><li class="tab"><button type="button" data-href="#391f4b61-142c-44aa-99c6-3134e7ac1fe6-2"><i class="fas fa-child"></i>2</button></li><li class="tab"><button type="button" data-href="#391f4b61-142c-44aa-99c6-3134e7ac1fe6-3"><i class="fab fa-apple"></i>3</button></li><li class="tab"><button type="button" data-href="#391f4b61-142c-44aa-99c6-3134e7ac1fe6-4"><i class="fas fa-tree"></i>4</button></li><li class="tab"><button type="button" data-href="#391f4b61-142c-44aa-99c6-3134e7ac1fe6-5"><i class="fas fa-leaf"></i>æºç åˆ†æ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="391f4b61-142c-44aa-99c6-3134e7ac1fe6-1"><p>Semaphoreæœ‰ç‚¹åƒä¸€ä¸ªåœè½¦åœºï¼Œpermitså°±å¥½åƒåœè½¦ä½æ•°é‡ï¼Œå½“çº¿ç¨‹è·å¾—äº†permitså°±åƒæ˜¯è·å¾—äº†åœè½¦ä½ï¼Œç„¶ååœè½¦åœºæ˜¾ç¤ºç©ºä½™è½¦ä½å‡ä¸€ã€‚</p><p>åˆšå¼€å§‹ï¼Œpermitsï¼ˆstateï¼‰ä¸º 3ï¼Œè¿™æ—¶ 5 ä¸ªçº¿ç¨‹æ¥è·å–èµ„æº</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220315211610470.png" alt="image-20220315211610470" style="zoom:67%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="391f4b61-142c-44aa-99c6-3134e7ac1fe6-2"><p>å‡è®¾å…¶ä¸­ Thread-1ï¼ŒThread-2ï¼ŒThread-4 cas ç«äº‰æˆåŠŸï¼Œè€Œ Thread-0 å’Œ Thread-3 ç«äº‰å¤±è´¥ï¼Œè¿›å…¥ AQS é˜Ÿåˆ— park é˜»å¡</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220315211646132.png" alt="image-20220315211646132" style="zoom:67%"><p>åŠ é”æµç¨‹æ€»ç»“ï¼š</p><ul><li><code>acquire</code>-&gt;<code>acquireSharedInterruptibly(1)</code>-&gt;<code>tryAcquireShared(1)</code>-&gt;<code>nonfairTryAcquireShared(1)</code>,å¦‚æœèµ„æºç”¨å®Œäº†ï¼Œè¿”å›è´Ÿæ•°ï¼Œ<code>tryAcquireShared</code>è¿”å›è´Ÿæ•°ï¼Œè¡¨ç¤ºå¤±è´¥ã€‚å¦åˆ™è¿”å›æ­£æ•°ï¼Œ<code>tryAcquireShared</code>è¿”å›æ­£æ•°,è¡¨ç¤ºæˆåŠŸã€‚<ul><li>å¦‚æœæˆåŠŸï¼Œè·å–ä¿¡å·é‡æˆåŠŸã€‚</li><li>å¦‚æœå¤±è´¥ï¼Œè°ƒç”¨<code>doAcquireSharedInterruptibly</code>,è¿›å…¥forå¾ªç¯ï¼š<ul><li>å¦‚æœå½“å‰é©±èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹ï¼Œè°ƒç”¨<code>tryAcquireShared</code>å°è¯•è·å–é”<ul><li>å¦‚æœç»“æœå¤§äºç­‰äº0ï¼Œè¡¨æ˜è·å–é”æˆåŠŸï¼Œè°ƒç”¨<code>setHeadAndPropagate</code>ï¼Œå°†å½“å‰èŠ‚ç‚¹è®¾ä¸ºå¤´èŠ‚ç‚¹ï¼Œä¹‹ååˆè°ƒç”¨<code>doReleaseShared</code>ï¼Œå”¤é†’åç»§èŠ‚ç‚¹ã€‚</li></ul></li><li>è°ƒç”¨<code>shoudParkAfterFailure</code>,ç¬¬ä¸€æ¬¡è°ƒç”¨è¿”å›falseï¼Œå¹¶å°†å‰é©±èŠ‚ç‚¹æ”¹ä¸º-1ï¼Œç¬¬äºŒæ¬¡å¾ªç¯å¦‚æœå†è¿›å…¥æ­¤æ–¹æ³•ï¼Œä¼šè¿›å…¥é˜»å¡å¹¶æ£€æŸ¥æ‰“æ–­çš„æ–¹æ³•ã€‚</li></ul></li></ul></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="391f4b61-142c-44aa-99c6-3134e7ac1fe6-3"><p>è¿™æ—¶ Thread-4 é‡Šæ”¾äº† permitsï¼ŒçŠ¶æ€å¦‚ä¸‹</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220315211712384.png" alt="image-20220315211712384" style="zoom:67%"><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="391f4b61-142c-44aa-99c6-3134e7ac1fe6-4"><p>æ¥ä¸‹æ¥ Thread-0 ç«äº‰æˆåŠŸï¼Œpermits å†æ¬¡è®¾ç½®ä¸º 0ï¼Œè®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹ï¼Œæ–­å¼€åŸæ¥çš„ head èŠ‚ç‚¹ï¼Œunpark æ¥ ä¸‹æ¥çš„ Thread-3 èŠ‚ç‚¹ï¼Œä½†ç”±äº permits æ˜¯ 0ï¼Œå› æ­¤ Thread-3 åœ¨å°è¯•ä¸æˆåŠŸåå†æ¬¡è¿›å…¥ park çŠ¶æ€</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/image-20220315211741166.png" alt="image-20220315211741166" style="zoom:67%"><p>è§£é”æµç¨‹æ€»ç»“ï¼š</p><ul><li><code>release</code>-&gt;<code>sync.releaseShared(1)</code>-&gt;<code>tryReleaseShared(1)</code>,åªè¦ä¸å‘ç”Ÿæ•´æ•°æº¢å‡ºï¼Œå°±è¿”å›true<ul><li>å¦‚æœè¿”å›trueï¼Œè°ƒç”¨<code>doReleaseShared</code>ï¼Œå”¤é†’åç»§èŠ‚ç‚¹ã€‚</li><li>å¦‚æœè¿”å›falseï¼Œè§£é”å¤±è´¥ã€‚</li></ul></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="391f4b61-142c-44aa-99c6-3134e7ac1fe6-5"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">2694183684443567898L</span>;</span><br><span class="line">    NonfairSync(<span class="type">int</span> <span class="keyword">permits</span>) &#123;</span><br><span class="line">        <span class="comment">// permits å³ state</span></span><br><span class="line">        <span class="built_in">super</span>(<span class="keyword">permits</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Semaphore æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        sync.acquireSharedInterruptibly(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireSharedInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span></span><br><span class="line">        <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">            doAcquireSharedInterruptibly(arg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°è¯•è·å¾—å…±äº«é”</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">tryAcquireShared</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nonfairTryAcquireShared(acquires);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">nonfairTryAcquireShared</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">available</span> <span class="operator">=</span> getState();</span><br><span class="line">            <span class="type">int</span> <span class="variable">remaining</span> <span class="operator">=</span> available - acquires; </span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">                <span class="comment">// å¦‚æœè®¸å¯å·²ç»ç”¨å®Œ, è¿”å›è´Ÿæ•°, è¡¨ç¤ºè·å–å¤±è´¥, è¿›å…¥ doAcquireSharedInterruptibly</span></span><br><span class="line">                remaining &lt; <span class="number">0</span> ||</span><br><span class="line">                <span class="comment">// å¦‚æœ cas é‡è¯•æˆåŠŸ, è¿”å›æ­£æ•°, è¡¨ç¤ºè·å–æˆåŠŸ</span></span><br><span class="line">                compareAndSetState(available, remaining)</span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="keyword">return</span> remaining;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireSharedInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.SHARED);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">                <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">                    <span class="comment">// å†æ¬¡å°è¯•è·å–è®¸å¯</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> tryAcquireShared(arg);</span><br><span class="line">                    <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// æˆåŠŸåæœ¬çº¿ç¨‹å‡ºé˜Ÿï¼ˆAQSï¼‰, æ‰€åœ¨ Nodeè®¾ç½®ä¸º head</span></span><br><span class="line">                        <span class="comment">// å¦‚æœ head.waitStatus == Node.SIGNAL ==&gt; 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark</span></span><br><span class="line">                        <span class="comment">// å¦‚æœ head.waitStatus == 0 ==&gt; Node.PROPAGATE </span></span><br><span class="line">                        <span class="comment">// r è¡¨ç¤ºå¯ç”¨èµ„æºæ•°, ä¸º 0 åˆ™ä¸ä¼šç»§ç»­ä¼ æ’­</span></span><br><span class="line">                        setHeadAndPropagate(node, r);</span><br><span class="line">                        p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                        failed = <span class="literal">false</span>;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// ä¸æˆåŠŸ, è®¾ç½®ä¸Šä¸€ä¸ªèŠ‚ç‚¹ waitStatus = Node.SIGNAL, ä¸‹è½®è¿›å…¥ park é˜»å¡</span></span><br><span class="line">                <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    parkAndCheckInterrupt())</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                cancelAcquire(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Semaphore æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.releaseShared(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">releaseShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">            doReleaseShared();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryReleaseShared</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> getState();</span><br><span class="line">            <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> current + releases;</span><br><span class="line">            <span class="keyword">if</span> (next &lt; current) <span class="comment">// overflow</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum permit count exceeded&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(current, next))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setHeadAndPropagate</span><span class="params">(Node node, <span class="type">int</span> propagate)</span> &#123;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head; <span class="comment">// Record old head for check below</span></span><br><span class="line">    <span class="comment">// è®¾ç½®è‡ªå·±ä¸º head</span></span><br><span class="line">    setHead(node);</span><br><span class="line">    <span class="comment">// propagate è¡¨ç¤ºæœ‰å…±äº«èµ„æºï¼ˆä¾‹å¦‚å…±äº«è¯»é”æˆ–ä¿¡å·é‡ï¼‰</span></span><br><span class="line">    <span class="comment">// åŸ head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATE</span></span><br><span class="line">    <span class="comment">// ç°åœ¨ head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATE</span></span><br><span class="line">    <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> || h == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span> ||</span><br><span class="line">        (h = head) == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…æ˜¯ç­‰å¾…å…±äº«è¯»é”çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span> || s.isShared()) &#123;</span><br><span class="line">            doReleaseShared();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doReleaseShared</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> h.waitStatus;</span><br><span class="line">            <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">                    <span class="keyword">continue</span>;            <span class="comment">// loop to recheck cases</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                     !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">                <span class="keyword">continue</span>;                <span class="comment">// loop on failed CAS</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (h == head)                   <span class="comment">// loop if head changed</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="7-CountdownLatch">7. CountdownLatch</h2><p>å€’è®¡æ—¶é”</p><p>ç”¨æ¥è¿›è¡Œçº¿ç¨‹åŒæ­¥åä½œï¼Œç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆå€’è®¡æ—¶ã€‚</p><p>CountDownLatchçš„ä½œç”¨å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªæˆ–è€…ä¸€ç»„çº¿ç¨‹åœ¨å¼€å§‹æ‰§è¡Œæ“ä½œä¹‹å‰ï¼Œå¿…é¡»è¦ç­‰åˆ°å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œæ‰å¯ä»¥ã€‚æˆ‘ä»¬ä¸¾ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ï¼Œåœ¨è€ƒè¯•çš„æ—¶å€™ï¼Œè€å¸ˆå¿…é¡»è¦ç­‰åˆ°æ‰€æœ‰äººäº¤äº†è¯•å·æ‰å¯ä»¥èµ°ã€‚æ­¤æ—¶è€å¸ˆå°±ç›¸å½“äºç­‰å¾…çº¿ç¨‹ï¼Œè€Œå­¦ç”Ÿå°±å¥½æ¯”æ˜¯æ‰§è¡Œçš„çº¿ç¨‹ã€‚</p><p>å…¶ä¸­æ„é€ å‚æ•°ç”¨æ¥åˆå§‹åŒ–ç­‰å¾…è®¡æ•°å€¼ï¼Œawait() ç”¨æ¥ç­‰å¾…è®¡æ•°å½’é›¶ï¼ŒcountDown() ç”¨æ¥è®©è®¡æ•°å‡ä¸€</p><div class="tabs" id="7693d943-0807-4763-9f97-316e9fc10617"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#7693d943-0807-4763-9f97-316e9fc10617-1"><i class="fas fa-cat"></i>ç¤ºä¾‹</button></li><li class="tab"><button type="button" data-href="#7693d943-0807-4763-9f97-316e9fc10617-2"><i class="fas fa-horse"></i>è¾“å‡º</button></li><li class="tab"><button type="button" data-href="#7693d943-0807-4763-9f97-316e9fc10617-3"><i class="fas fa-dove"></i>æ¯”è¾ƒ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="7693d943-0807-4763-9f97-316e9fc10617-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;begin...&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        latch.countDown();</span><br><span class="line">        log.debug(<span class="string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());</span><br><span class="line">    &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;begin...&quot;</span>);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        latch.countDown();</span><br><span class="line">        log.debug(<span class="string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());</span><br><span class="line">    &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;begin...&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1.5</span>);</span><br><span class="line">        latch.countDown();</span><br><span class="line">        log.debug(<span class="string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());</span><br><span class="line">    &#125;).start();</span><br><span class="line">    log.debug(<span class="string">&quot;waiting...&quot;</span>);</span><br><span class="line">    latch.await();</span><br><span class="line">    log.debug(<span class="string">&quot;wait end...&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="7693d943-0807-4763-9f97-316e9fc10617-2"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">18:44:00.778 c.TestCountDownLatch [main] - waiting... </span><br><span class="line">18:44:00.778 c.TestCountDownLatch [Thread-2] - begin... </span><br><span class="line">18:44:00.778 c.TestCountDownLatch [Thread-0] - begin... </span><br><span class="line">18:44:00.778 c.TestCountDownLatch [Thread-1] - begin... </span><br><span class="line">18:44:01.782 c.TestCountDownLatch [Thread-0] - end...2 </span><br><span class="line">18:44:02.283 c.TestCountDownLatch [Thread-2] - end...1 </span><br><span class="line">18:44:02.782 c.TestCountDownLatch [Thread-1] - end...0 </span><br><span class="line">18:44:02.782 c.TestCountDownLatch [main] - <span class="built_in">wait</span> end... </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="7693d943-0807-4763-9f97-316e9fc10617-3"><p>Joinå±äºæ¯”è¾ƒåº•å±‚çš„APIï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬ä¸ä¼šè‡ªå·±åˆ›å»ºçº¿ç¨‹ï¼Œè€Œæ˜¯ç”±çº¿ç¨‹æ± åˆ›å»ºã€‚</p><p>ç›¸æ¯”äºjoinï¼ŒCountDownLatchèƒ½é…åˆçº¿ç¨‹æ± ä½¿ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">3</span>);</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">4</span>);</span><br><span class="line">    service.submit(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;begin...&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        latch.countDown();</span><br><span class="line">        log.debug(<span class="string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());</span><br><span class="line">    &#125;);</span><br><span class="line">    service.submit(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;begin...&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1.5</span>);</span><br><span class="line">        latch.countDown();</span><br><span class="line">        log.debug(<span class="string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());</span><br><span class="line">    &#125;);</span><br><span class="line">    service.submit(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;begin...&quot;</span>);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        latch.countDown();</span><br><span class="line">        log.debug(<span class="string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());</span><br><span class="line">    &#125;);</span><br><span class="line">    service.submit(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;waiting...&quot;</span>);</span><br><span class="line">            latch.await();</span><br><span class="line">            log.debug(<span class="string">&quot;wait end...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="7-1-åŒæ­¥ç­‰å¾…å¤šçº¿ç¨‹å‡†å¤‡å®Œæ¯•">7.1 åŒæ­¥ç­‰å¾…å¤šçº¿ç¨‹å‡†å¤‡å®Œæ¯•</h3><p>åœ¨æ‰“ç‹è€…çš„æ—¶å€™ï¼Œåœ¨å¼€å±€å‰æ‰€æœ‰äººéƒ½å¿…é¡»è¦åŠ è½½åˆ°100%æ‰å¯ä»¥è¿›å…¥ã€‚å¦åˆ™æ‰€æœ‰ç©å®¶éƒ½ç›¸äº’ç­‰å¾…ã€‚</p><div class="tabs" id="ebba993d-4410-4763-840b-9e15257709d2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ebba993d-4410-4763-840b-9e15257709d2-1"><i class="fas fa-atom"></i>ä»£ç </button></li><li class="tab"><button type="button" data-href="#ebba993d-4410-4763-840b-9e15257709d2-2"><i class="far fa-sun"></i>è¾“å‡º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ebba993d-4410-4763-840b-9e15257709d2-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AtomicInteger</span> <span class="variable">num</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>, (r) -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r, <span class="string">&quot;t&quot;</span> + num.getAndIncrement());</span><br><span class="line">&#125;);</span><br><span class="line"><span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">10</span>);</span><br><span class="line">String[] all = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">10</span>];</span><br><span class="line"><span class="type">Random</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">10</span>; j++) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> j;</span><br><span class="line">    service.submit(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//éšæœºä¼‘çœ ï¼Œæ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ</span></span><br><span class="line">                Thread.sleep(r.nextInt(<span class="number">100</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            all[x] = Thread.currentThread().getName() + <span class="string">&quot;(&quot;</span> + (i + <span class="string">&quot;%&quot;</span>) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">            <span class="comment">//\rå¯ä»¥è®©å½“å‰è¾“å‡ºè¦†ç›–ä¸Šä¸€æ¬¡çš„è¾“å‡ºã€‚</span></span><br><span class="line">            System.out.print(<span class="string">&quot;\r&quot;</span> + Arrays.toString(all));</span><br><span class="line">        &#125;</span><br><span class="line">        latch.countDown();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">latch.await();</span><br><span class="line">System.out.println(<span class="string">&quot;\næ¸¸æˆå¼€å§‹...&quot;</span>);</span><br><span class="line">service.shutdown();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ebba993d-4410-4763-840b-9e15257709d2-2"><p>ä¸­é—´è¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[t0(52%), t1(47%), t2(51%), t3(40%), t4(49%), t5(44%), t6(49%), t7(52%), t8(46%), t9(46%)] </span><br></pre></td></tr></table></figure><p>æœ€åè¾“å‡º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[t0(100%), t1(100%), t2(100%), t3(100%), t4(100%), t5(100%), t6(100%), t7(100%), t8(100%), </span><br><span class="line">t9(100%)] </span><br><span class="line">æ¸¸æˆå¼€å§‹... </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="7-2-åŒæ­¥ç­‰å¾…å¤šä¸ªè¿œç¨‹è°ƒç”¨ç»“æŸ">7.2 åŒæ­¥ç­‰å¾…å¤šä¸ªè¿œç¨‹è°ƒç”¨ç»“æŸ</h3><div class="tabs" id="6296e3e4-7d8c-4fca-b83c-11b30da560ec"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#6296e3e4-7d8c-4fca-b83c-11b30da560ec-1"><i class="fas fa-wind"></i>ä»£ç </button></li><li class="tab"><button type="button" data-href="#6296e3e4-7d8c-4fca-b83c-11b30da560ec-2"><i class="fas fa-fire-alt"></i>restè¿œç¨‹è°ƒç”¨</button></li><li class="tab"><button type="button" data-href="#6296e3e4-7d8c-4fca-b83c-11b30da560ec-3"><i class="fas fa-seedling"></i>æ‰§è¡Œç»“æœ</button></li><li class="tab"><button type="button" data-href="#6296e3e4-7d8c-4fca-b83c-11b30da560ec-4"><i class="fas fa-leaf"></i>futureæ”¹è¿›</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="6296e3e4-7d8c-4fca-b83c-11b30da560ec-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCountDownlatchController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/order/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">order</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> id)</span> &#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;id&quot;</span>, id);</span><br><span class="line">        map.put(<span class="string">&quot;total&quot;</span>, <span class="string">&quot;2300.00&quot;</span>);</span><br><span class="line">        sleep(<span class="number">2000</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/product/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">product</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> id)</span> &#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (id == <span class="number">1</span>) &#123;</span><br><span class="line">            map.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;å°çˆ±éŸ³ç®±&quot;</span>);</span><br><span class="line">            map.put(<span class="string">&quot;price&quot;</span>, <span class="number">300</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (id == <span class="number">2</span>) &#123;</span><br><span class="line">            map.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;å°ç±³æ‰‹æœº&quot;</span>);</span><br><span class="line">            map.put(<span class="string">&quot;price&quot;</span>, <span class="number">2000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        map.put(<span class="string">&quot;id&quot;</span>, id);</span><br><span class="line">        sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/logistics/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">logistics</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> id)</span> &#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;id&quot;</span>, id);</span><br><span class="line">        map.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;ä¸­é€šå¿«é€’&quot;</span>);</span><br><span class="line">        sleep(<span class="number">2500</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> millis)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(millis);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6296e3e4-7d8c-4fca-b83c-11b30da560ec-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">log.debug(<span class="string">&quot;begin&quot;</span>);</span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line"><span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">4</span>);</span><br><span class="line">Future&lt;Map&lt;String,Object&gt;&gt; f1 = service.submit(() -&gt; &#123;</span><br><span class="line">    Map&lt;String, Object&gt; r =</span><br><span class="line">        restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/order/&#123;1&#125;&quot;</span>, Map.class, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;);</span><br><span class="line">Future&lt;Map&lt;String, Object&gt;&gt; f2 = service.submit(() -&gt; &#123;</span><br><span class="line">    Map&lt;String, Object&gt; r =</span><br><span class="line">        restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/product/&#123;1&#125;&quot;</span>, Map.class, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;);</span><br><span class="line">Future&lt;Map&lt;String, Object&gt;&gt; f3 = service.submit(() -&gt; &#123;</span><br><span class="line">    Map&lt;String, Object&gt; r =</span><br><span class="line">        restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/product/&#123;1&#125;&quot;</span>, Map.class, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;);</span><br><span class="line">Future&lt;Map&lt;String, Object&gt;&gt; f4 = service.submit(() -&gt; &#123;</span><br><span class="line">    Map&lt;String, Object&gt; r =</span><br><span class="line">        restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/logistics/&#123;1&#125;&quot;</span>, Map.class, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;);</span><br><span class="line">System.out.println(f1.get());</span><br><span class="line">System.out.println(f2.get());</span><br><span class="line">System.out.println(f3.get());</span><br><span class="line">System.out.println(f4.get());</span><br><span class="line">log.debug(<span class="string">&quot;æ‰§è¡Œå®Œæ¯•&quot;</span>);</span><br><span class="line">service.shutdown();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6296e3e4-7d8c-4fca-b83c-11b30da560ec-3"><p>æ‰§è¡Œç»“æœ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">19:51:39.711 c.TestCountDownLatch [main] - begin </span><br><span class="line">&#123;total=2300.00, <span class="built_in">id</span>=1&#125; </span><br><span class="line">&#123;price=300, name=å°çˆ±éŸ³ç®±, <span class="built_in">id</span>=1&#125; </span><br><span class="line">&#123;price=2000, name=å°ç±³æ‰‹æœº, <span class="built_in">id</span>=2&#125; </span><br><span class="line">&#123;name=ä¸­é€šå¿«é€’, <span class="built_in">id</span>=1&#125; </span><br><span class="line">19:51:42.407 c.TestCountDownLatch [main] - æ‰§è¡Œå®Œæ¯•</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="6296e3e4-7d8c-4fca-b83c-11b30da560ec-4"><p>è¿™ç§ç­‰å¾…å¤šä¸ªå¸¦æœ‰è¿”å›å€¼çš„ä»»åŠ¡çš„åœºæ™¯ï¼Œè¿˜æ˜¯ç”¨futureæ¯”è¾ƒåˆé€‚ï¼ŒCountdownLatché€‚åˆä»»åŠ¡æ²¡æœ‰è¿”å›å€¼çš„åœºæ™¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">log.debug(<span class="string">&quot;begin&quot;</span>);</span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line"><span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">4</span>);</span><br><span class="line">Future&lt;Map&lt;String,Object&gt;&gt; f1 = service.submit(() -&gt; &#123;</span><br><span class="line">    Map&lt;String, Object&gt; response = restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/order/&#123;1&#125;&quot;</span>, Map.class, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;);</span><br><span class="line">Future&lt;Map&lt;String, Object&gt;&gt; f2 = service.submit(() -&gt; &#123;</span><br><span class="line">    Map&lt;String, Object&gt; response1 = restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/product/&#123;1&#125;&quot;</span>, Map.class, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> response1;</span><br><span class="line">&#125;);</span><br><span class="line">Future&lt;Map&lt;String, Object&gt;&gt; f3 = service.submit(() -&gt; &#123;</span><br><span class="line">    Map&lt;String, Object&gt; response1 = restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/product/&#123;1&#125;&quot;</span>, Map.class, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> response1;</span><br><span class="line">&#125;);</span><br><span class="line">Future&lt;Map&lt;String, Object&gt;&gt; f4 = service.submit(() -&gt; &#123;</span><br><span class="line">    Map&lt;String, Object&gt; response3 = restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/logistics/&#123;1&#125;&quot;</span>, Map.class, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> response3;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">System.out.println(f1.get());</span><br><span class="line">System.out.println(f2.get());</span><br><span class="line">System.out.println(f3.get());</span><br><span class="line">System.out.println(f4.get());</span><br><span class="line">log.debug(<span class="string">&quot;æ‰§è¡Œå®Œæ¯•&quot;</span>);</span><br><span class="line">service.shutdown();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="8-CyclicBarrier">8. CyclicBarrier</h2><div class="tabs" id="c8262116-9df2-473d-ab68-c09ee454370a"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#c8262116-9df2-473d-ab68-c09ee454370a-1"><i class="fas fa-award"></i>CountdownLatchç¼ºç‚¹</button></li><li class="tab"><button type="button" data-href="#c8262116-9df2-473d-ab68-c09ee454370a-2"><i class="fas fa-baseball-ball"></i>CyclicBarrieræ”¹è¿›</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="c8262116-9df2-473d-ab68-c09ee454370a-1"><p>CountdownLatchçš„ç¼ºç‚¹åœ¨äºä¸èƒ½é‡ç”¨ï¼Œæƒ³è¦é‡å¤ä½¿ç”¨CountdownLatchè¿›è¡ŒåŒæ­¥ï¼Œå¿…é¡»åˆ›å»ºå¤šä¸ªCountDownLatchå¯¹è±¡ï¼Œè§ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">2</span>);</span><br><span class="line">        service.submit(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task1 start...&quot;</span>);</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">            latch.countDown();</span><br><span class="line">        &#125;);</span><br><span class="line">        service.submit(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task2 start...&quot;</span>);</span><br><span class="line">            sleep(<span class="number">2</span>);</span><br><span class="line">            latch.countDown();</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            latch.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;task1 task2 finish...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    service.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="c8262116-9df2-473d-ab68-c09ee454370a-2"><p>å¾ªç¯æ …æ ï¼Œç”¨æ¥è¿›è¡Œçº¿ç¨‹åä½œï¼Œç­‰å¾…çº¿ç¨‹æ»¡è¶³æŸä¸ªè®¡æ•°ã€‚æ„é€ æ—¶è®¾ç½®ã€è®¡æ•°ä¸ªæ•°ã€ï¼Œæ¯ä¸ªçº¿ç¨‹æ‰§ è¡Œåˆ°æŸä¸ªéœ€è¦â€œåŒæ­¥â€çš„æ—¶åˆ»è°ƒç”¨ await() æ–¹æ³•è¿›è¡Œç­‰å¾…ï¼Œå½“ç­‰å¾…çš„çº¿ç¨‹æ•°æ»¡è¶³ã€è®¡æ•°ä¸ªæ•°ã€æ—¶ï¼Œç»§ç»­æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line"><span class="type">CyclicBarrier</span> <span class="variable">barrier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CyclicBarrier</span>(<span class="number">2</span>, ()-&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;task1, task2 finish...&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123; <span class="comment">// task1  task2  task1</span></span><br><span class="line">    service.submit(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;task1 begin...&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            barrier.await(); <span class="comment">// 2-1=1</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    service.submit(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;task2 begin...&quot;</span>);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            barrier.await(); <span class="comment">// 1-1=0</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">service.shutdown();</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼šçº¿ç¨‹ä¸ªæ•°åº”è¯¥ä¸å€’è®¡æ—¶ä¸ªæ•°ç›¸åŒï¼Œå¦‚æœçº¿ç¨‹æ± çº¿ç¨‹ä¸ªæ•°ä¸º3ï¼Œå¯èƒ½task1 task2 task1éƒ½æ‰§è¡Œï¼Œå¯èƒ½ä¸ºä¸¤ä¸ªtask1 å®Œæˆäº†å€’è®¡æ—¶</p></blockquote><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><blockquote><p><strong>æ³¨æ„</strong></p><ul><li>CyclicBarrier ä¸ CountDownLatch çš„ä¸»è¦åŒºåˆ«åœ¨äº CyclicBarrier æ˜¯å¯ä»¥é‡ç”¨çš„ CyclicBarrier å¯ä»¥è¢«æ¯” å–»ä¸ºã€äººæ»¡å‘è½¦ã€</li><li>CountDownLatchçš„è®¡æ•°å’Œé˜»å¡æ–¹æ³•æ˜¯åˆ†å¼€çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œè€ŒCyclicBarrieræ˜¯ä¸€ä¸ªæ–¹æ³•ã€‚</li><li>CyclicBarrierçš„æ„é€ å™¨è¿˜æœ‰ä¸€ä¸ªRunnableç±»å‹çš„å‚æ•°ï¼Œåœ¨è®¡æ•°ä¸º0æ—¶ä¼šæ‰§è¡Œå…¶ä¸­çš„runæ–¹æ³•ã€‚</li></ul></blockquote></article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>7.1å…±äº«æ¨¡å‹ä¹‹å·¥å…·</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://luckylittleboy.gitee.io/posts/9c5b9bb4.html">https://luckylittleboy.gitee.io/posts/9c5b9bb4.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>ä½œè€…</h><div class="post-copyright-cc-info"><h>LuckyBoyğŸ¥</h></div></div><div class="post-copyright-c"><h>å‘å¸ƒäº</h><div class="post-copyright-cc-info"><h>2023-04-03</h></div></div><div class="post-copyright-u"><h>æ›´æ–°äº</h><div class="post-copyright-cc-info"><h>2023-04-07</h></div></div><div class="post-copyright-c"><h>è®¸å¯åè®®</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/JUC/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>JUC</a></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/b7fbfe85.html"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/default_cover_11.webp" onerror='onerror=null,src="/assets/r2.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">7.2 çº¿ç¨‹å®‰å…¨é›†åˆç±»</div></div></a></div><div class="next-post pull-right"><a href="/posts/b4f56904.html"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/default_cover_7.webp" onerror='onerror=null,src="/assets/r2.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">6.å…±äº«æ¨¡å‹ä¹‹ä¸å¯å˜</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/792b4657.html" title="1.è¿›ç¨‹ä¸çº¿ç¨‹"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/default_cover_1.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-04-04</div><div class="title">1.è¿›ç¨‹ä¸çº¿ç¨‹</div></div></a></div><div><a href="/posts/b4f56904.html" title="6.å…±äº«æ¨¡å‹ä¹‹ä¸å¯å˜"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/default_cover_7.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-04-02</div><div class="title">6.å…±äº«æ¨¡å‹ä¹‹ä¸å¯å˜</div></div></a></div><div><a href="/posts/5ce1.html" title="9.ThreadLocal"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/default_cover_10.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-04-05</div><div class="title">9.ThreadLocal</div></div></a></div><div><a href="/posts/766dd8c2.html" title="2.Javaçº¿ç¨‹"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/default_cover_3.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-04-05</div><div class="title">2.Javaçº¿ç¨‹</div></div></a></div><div><a href="/posts/20410f72.html" title="4.å…±äº«æ¨¡å‹ä¹‹å†…å­˜"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/default_cover_5.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-04-01</div><div class="title">4.å…±äº«æ¨¡å‹ä¹‹å†…å­˜</div></div></a></div><div><a href="/posts/943faa28.html" title="5.å…±äº«æ¨¡å‹ä¹‹æ— é”"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/default_cover_6.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-04-02</div><div class="title">5.å…±äº«æ¨¡å‹ä¹‹æ— é”</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:700">ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-text">1. è‡ªå®šä¹‰çº¿ç¨‹æ± </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-ThreadPoolExecutor"><span class="toc-text">2. ThreadPoolExecutor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%8A%B6%E6%80%81"><span class="toc-text">2.1 çº¿ç¨‹æ± çŠ¶æ€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F"><span class="toc-text">2.2 å·¥ä½œæ–¹å¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-text">2.3 æ„é€ æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E6%8F%90%E4%BA%A4%E4%BB%BB%E5%8A%A1"><span class="toc-text">2.4 æäº¤ä»»åŠ¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E5%85%B3%E9%97%AD%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-text">2.5 å…³é—­çº¿ç¨‹æ± </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-%E6%A8%A1%E5%BC%8F%E4%B9%8B-Worker-Thread"><span class="toc-text">2.6 æ¨¡å¼ä¹‹ Worker Thread</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-1-%E5%AE%9A%E4%B9%89"><span class="toc-text">2.6.1 å®šä¹‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-2-%E9%A5%A5%E9%A5%BF"><span class="toc-text">2.6.2 é¥¥é¥¿</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-3-%E5%88%9B%E5%BB%BA%E5%A4%9A%E5%B0%91%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%90%88%E9%80%82"><span class="toc-text">2.6.3 åˆ›å»ºå¤šå°‘çº¿ç¨‹æ± åˆé€‚</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-text">2.7 ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-%E6%AD%A3%E7%A1%AE%E5%A4%84%E7%90%86%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1%E5%BC%82%E5%B8%B8"><span class="toc-text">2.8 æ­£ç¡®å¤„ç†æ‰§è¡Œä»»åŠ¡å¼‚å¸¸</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-%E5%BA%94%E7%94%A8%E4%B9%8B%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-text">2.9 åº”ç”¨ä¹‹å®šæ—¶ä»»åŠ¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-10-Tomcat-%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-text">2.10 Tomcat çº¿ç¨‹æ± </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-11-Fork-Join"><span class="toc-text">2.11 Fork&#x2F;Join</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-AQS-%E5%8E%9F%E7%90%86"><span class="toc-text">3. AQS åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%A6%82%E8%BF%B0"><span class="toc-text">3.1 æ¦‚è¿°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-AQS%E5%86%85%E9%83%A8%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84"><span class="toc-text">3.2 AQSå†…éƒ¨ä½“ç³»æ¶æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%AE%9E%E7%8E%B0%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81"><span class="toc-text">3.3 å®ç°ä¸å¯é‡å…¥é”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E5%BF%83%E5%BE%97"><span class="toc-text">3.4 å¿ƒå¾—</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-ReentrantLock-%E5%8E%9F%E7%90%86"><span class="toc-text">4. ReentrantLock åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">4.1 éå…¬å¹³é”å®ç°åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%8F%AF%E9%87%8D%E5%85%A5%E5%8E%9F%E7%90%86"><span class="toc-text">4.2 å¯é‡å…¥åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E5%8F%AF%E6%89%93%E6%96%AD%E5%8E%9F%E7%90%86"><span class="toc-text">4.3 å¯æ‰“æ–­åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E5%85%AC%E5%B9%B3%E9%94%81%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">4.4 å…¬å¹³é”å®ç°åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">4.5 æ¡ä»¶å˜é‡å®ç°åŸç†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E8%AF%BB%E5%86%99%E9%94%81"><span class="toc-text">5. è¯»å†™é”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-ReentrantReadWriteLock"><span class="toc-text">5.1 ReentrantReadWriteLock</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E8%AF%BB%E5%86%99%E9%94%81%E5%8E%9F%E7%90%86"><span class="toc-text">5.2 è¯»å†™é”åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-StampedLock"><span class="toc-text">5.3 StampedLock</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Semaphore"><span class="toc-text">6. Semaphore</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">6.1 åŸºæœ¬ä½¿ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-Semaphore-%E5%BA%94%E7%94%A8"><span class="toc-text">6.2 Semaphore åº”ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-Semaphore-%E5%8E%9F%E7%90%86"><span class="toc-text">6.3 Semaphore åŸç†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-CountdownLatch"><span class="toc-text">7. CountdownLatch</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E5%90%8C%E6%AD%A5%E7%AD%89%E5%BE%85%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%87%86%E5%A4%87%E5%AE%8C%E6%AF%95"><span class="toc-text">7.1 åŒæ­¥ç­‰å¾…å¤šçº¿ç¨‹å‡†å¤‡å®Œæ¯•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E5%90%8C%E6%AD%A5%E7%AD%89%E5%BE%85%E5%A4%9A%E4%B8%AA%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E7%BB%93%E6%9D%9F"><span class="toc-text">7.2 åŒæ­¥ç­‰å¾…å¤šä¸ªè¿œç¨‹è°ƒç”¨ç»“æŸ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-CyclicBarrier"><span class="toc-text">8. CyclicBarrier</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-color:transparent"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">æ ¼è¨€ğŸ§¬</p><div class="bg-ad"><div>å†çœ‹çœ‹é‚£ä¸ªå…‰ç‚¹ï¼Œå®ƒå°±åœ¨è¿™é‡Œï¼Œè¿™æ˜¯å®¶å›­ï¼Œè¿™æ˜¯æˆ‘ä»¬ â€”â€” ä½ æ‰€çˆ±çš„æ¯ä¸€ä¸ªäººï¼Œä½ è®¤è¯†çš„ä¸€ä¸ªäººï¼Œä½ å¬è¯´è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œæ›¾ç»æœ‰è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œéƒ½åœ¨å®ƒä¸Šé¢åº¦è¿‡ä»–ä»¬çš„ä¸€ç”Ÿâœ¨</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://stellarium.org/">ç‚¹å‡»å¼€å¯æ˜Ÿè¾°ä¹‹æ—…</a></div></div></div><div class="t-t-r"><p class="ft-t t-l-t">çŒœä½ æƒ³çœ‹ğŸ’¡</p><ul class="ft-links"><li><a href="/posts/eec9786.html">é­”æ”¹æŒ‡å—</a><a href="/box/nav/">ç½‘å€å¯¼èˆª</a></li><li><a href="/social/link/">æˆ‘çš„æœ‹å‹</a><a href="/comments/">ç•™ç‚¹ä»€ä¹ˆ</a></li><li><a href="/personal/about/">å…³äºä½œè€…</a><a href="/archives/">æ–‡ç« å½’æ¡£</a></li><li><a href="/categories/">æ–‡ç« åˆ†ç±»</a><a href="/tags/">æ–‡ç« æ ‡ç­¾</a></li><li><a href="/box/Gallery/">æˆ‘çš„ç”»å»Š</a><a href="/personal/bb/">æˆ‘çš„å” å¨</a></li><li><a href="/site/time/">å»ºè®¾è¿›ç¨‹</a><a href="/site/census/">ç½‘ç«™ç»Ÿè®¡</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">æ¨èå‹é“¾âŒ›</p><div class="ft-img-group"><div class="img-group-item"><a target="_blank" rel="noopener" href="https://www.fomal.cc/" title="FomalhautğŸ¥"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/60e5d4e39da7c077.webp" alt=""></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""></a></div></div></div></div><div class="copyright"><span><b>&copy;2022-2023</b></span><span><b>&nbsp;&nbsp;By LuckyBoyğŸ¥</b></span></div><div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="åšå®¢æ¡†æ¶ä¸ºHexo_v6.3.0"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Frame-Hexo-blue.svg" alt=""></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="ä¸»é¢˜ç‰ˆæœ¬Butterfly_v4.3.1"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Theme-Butterfly-6513df.svg" alt=""></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" title="æœ¬ç«™é‡‡ç”¨å¤šçº¿éƒ¨ç½²ï¼Œä¸»çº¿è·¯æ‰˜ç®¡äºVercel"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Hosted-Vercel-brightgreen.svg" alt=""></a><a class="github-badge" target="_blank" href="https://user.51.la/" style="margin-inline:5px" title="æœ¬ç«™æ•°æ®åˆ†æå¾—ç›Šäº51laæŠ€æœ¯æ”¯æŒ"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Analytics-51la-3db1eb.svg" alt=""></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20226665" style="margin-inline:5px" title="æœ¬ç«™å·²åŠ å…¥èŒICPè±ªåå¥—é¤ï¼ŒèŒICPå¤‡20226665å·"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/èŒICPå¤‡-20226665-fe1384.svg" alt=""></a><a class="github-badge" target="_blank" href="https://bitiful.dogecast.com/buckets" style="margin-inline:5px" title="æœ¬ç½‘ç«™ç»Service Workeråˆ†æµè‡³ç¼¤çº·äº‘å¯¹è±¡å­˜å‚¨"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://sourcebucket.s3.ladydaily.com/badge/Bucket-ç¼¤çº·äº‘-9c62da.svg" alt=""></a><a class="github-badge" target="_blank" href="https://www.netdun.net/" style="margin-inline:5px" title="æœ¬ç«™ä½¿ç”¨ç½‘ç›¾æ˜Ÿçƒæä¾›CDNåŠ é€Ÿä¸é˜²æŠ¤"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/CDN-ç½‘ç›¾æ˜Ÿçƒ-fff2cc.svg" alt=""></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="æœ¬ç½‘ç«™æºç ç”±Githubæä¾›å­˜å‚¨ä»“åº“"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://sourcebucket.s3.ladydaily.com/badge/Source-Github-d021d6.svg" alt=""></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="å³é”®æ¨¡å¼" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button class="share" type="button" title="åˆ†äº«é“¾æ¥" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="ç›´è¾¾åº•éƒ¨" onclick="btf.scrollToDest(document.body.scrollHeight,500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i> <span>æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>å¤åˆ¶</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>ç™¾åº¦æœç´¢</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>ç²˜è´´</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>ç©ºé™è¯„è®º</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>å¤åˆ¶æœ¬æ–‡åœ°å€</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>ä¿å­˜å›¾ç‰‡</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>åœ¨æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶å›¾ç‰‡é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>éšä¾¿é€›é€›</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>æ˜¼å¤œåˆ‡æ¢</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>å…³äºåšå®¢</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>ç¾åŒ–è®¾ç½®</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>åˆ‡æ¢å…¨å±</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>æ‰“å°é¡µé¢</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><script async>var preloader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",preloader.endLoading()),setTimeout((function(){preloader.endLoading()}),5e3),document.getElementById("loading-box").addEventListener("click",(()=>{preloader.endLoading()}))</script><div class="js-pjax"><script>(()=>{const t=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"",region:"",onCommentLoaded:function(){btf.loadLightbox(document.querySelectorAll("#twikoo .tk-content img:not(.tk-owo-emotion)"))}},null))},o=()=>{"object"!=typeof twikoo?getScript("https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js").then(t):setTimeout(t,0)};btf.loadComment(document.getElementById("twikoo-wrap"),o)})()</script></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_3612150_kfv55xn3u2g.js"></script><script async src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script defer src="/js/fomal.js"></script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors=["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax","#bibi","body > title","#app","#tag-echarts","#posts-echart","#categories-echarts"];var pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(window.tocScrollFn&&window.removeEventListener("scroll",window.tocScrollFn),window.scrollCollect&&window.removeEventListener("scroll",scrollCollect),"object"==typeof preloader&&preloader.initLoading(),document.getElementById("rightside").style.cssText="opacity: ''; transform: ''",window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode"),"object"==typeof disqusjs&&disqusjs.destroy()})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach((e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach((e=>t.setAttribute(e.name,e.value))),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)})),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof chatBtnFn&&chatBtnFn(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll(),"object"==typeof preloader&&preloader.endLoading()})),document.addEventListener("pjax:error",(e=>{404===e.request.status&&pjax.loadUrl("/404.html")}))</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script data-pjax>if(document.getElementById("recent-posts")&&"/"===location.pathname){var parent=document.getElementById("recent-posts"),child='<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://luckylittleboy.gitee.io/categories/ç®—æ³•/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¡ ç®—æ³•å­¦ä¹ ç¬”è®° (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://luckylittleboy.gitee.io/categories/Java/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸŸ Javaç¬”è®° (11)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://luckylittleboy.gitee.io/categories/æ•°æ®åº“/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¨ æ•°æ®åº“ç¬”è®° (11)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://luckylittleboy.gitee.io/categories/æ¼”ç¤º/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¥ æ¡ˆä¾‹æ¼”ç¤ºç¬”è®° (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="https://luckylittleboy.gitee.io/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">æŸ¥çœ‹æ›´å¤š...</a></div></div>';console.log("å·²æŒ‚è½½magnet"),parent.insertAdjacentHTML("afterbegin",child)}</script><style>#catalog_magnet{flex-wrap:wrap;display:flex;width:100%;justify-content:space-between;padding:10px 10px 0 10px;align-content:flex-start}.magnet_item{flex-basis:calc(33.333333333333336% - 5px);background:#e9e9e9;margin-bottom:10px;border-radius:8px;transition:all .2s ease-in-out}.magnet_item:hover{background:var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:#000}.magnet_link:hover{color:#fff}@media screen and (max-width:600px){.magnet_item{flex-basis:100%}}.magnet_link_context{display:flex;padding:10px;font-size:16px;transition:all .2s ease-in-out}.magnet_link_context:hover{padding:10px 20px}</style><style></style><script data-pjax>function butterfly_swiper_injector_config(){var a=document.getElementById("recent-posts");console.log("å·²æŒ‚è½½butterfly_swiper"),a.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/3f9c0b8e.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/default_cover_4.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-29</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/3f9c0b8e.html&quot;);" href="javascript:void(0);" alt="">3.å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹</a><div class="blog-slider__text">å…±äº«é—®é¢˜ã€synchronizedã€çº¿ç¨‹å®‰å…¨åˆ†æã€Monitorã€wait/notifyã€çº¿ç¨‹çŠ¶æ€è½¬æ¢ã€æ´»è·ƒæ€§ã€Lock</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/3f9c0b8e.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/9c5b9bb4.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/blog/default_cover_8.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-04-03</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/9c5b9bb4.html&quot;);" href="javascript:void(0);" alt="">7.1å…±äº«æ¨¡å‹ä¹‹å·¥å…·</a><div class="blog-slider__text">çº¿ç¨‹æ± ã€AQSã€ReentrantLockã€Semaphoreç­‰é”çš„åŸç†</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/9c5b9bb4.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/f9285b5c.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/cover_9.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-10</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/f9285b5c.html&quot;);" href="javascript:void(0);" alt="">å…³äºå­—ç¬¦ä¸²å­—é¢é‡è¿›å…¥åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± çš„æ—¶æœº</a><div class="blog-slider__text">å­—ç¬¦ä¸²å¸¸é‡æ± çš„ä¸€äº›é—®é¢˜</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/f9285b5c.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lmy-picbed.oss-cn-hangzhou.aliyuncs.com/img/cover_1.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-08-09</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">Markdownè¯­æ³•ä¸å¤–æŒ‚æ ‡ç­¾å†™æ³•æ±‡æ€»</a><div class="blog-slider__text">ğŸ¥§æœ¬æ–‡æ±‡æ€»Markdownæ ¼å¼ä»¥åŠå¤–æŒ‚æ ‡ç­¾åœ¨ç½‘é¡µç«¯çš„æ¸²æŸ“æ•ˆæœï¼Œå¯ä½œä¸ºæ–‡æ¡£è¿›è¡ŒæŸ¥è¯¢</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>')}for(var elist="undefined".split(","),cpage=location.pathname,epage="/",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_swiper_injector_config()</script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><div class="js-pjax"><script async>for(var arr=document.getElementsByClassName("recent-post-item"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__zoomIn"),arr[i].setAttribute("data-wow-duration","2s"),arr[i].setAttribute("data-wow-delay","200ms"),arr[i].setAttribute("data-wow-offset","30"),arr[i].setAttribute("data-wow-iteration","1")</script><script async>for(var arr=document.getElementsByClassName("card-widget"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__zoomIn"),arr[i].setAttribute("data-wow-duration","2s"),arr[i].setAttribute("data-wow-delay","200ms"),arr[i].setAttribute("data-wow-offset","30"),arr[i].setAttribute("data-wow-iteration","1")</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>function gitcalendar_injector_config(){document.getElementById("gitZone").insertAdjacentHTML("afterbegin",'<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 320px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>'),console.log("å·²æŒ‚è½½gitcalendar")}document.getElementById("gitZone")&&"/site/census/"===location.pathname&&(gitcalendar_injector_config(),GitCalendarInit("/api?null",["#d9e0df","#c6e0dc","#a8dcd4","#9adcd2","#89ded1","#77e0d0","#5fdecb","#47dcc6","#39dcc3","#1fdabe","#00dab9"],"null"))</script></body></html>